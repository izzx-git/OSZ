# file opened: radio.asm
   1  0000              ;Radio - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000                  ; macro OS_
 111+ 0000                  ; ld c,#0a
 112+ 0000                  ; rst #20
 113+ 0000                  ; endm
 114+ 0000
 115+ 0000                  ; macro OS_
 116+ 0000                  ; ld c,#0b
 117+ 0000                  ; rst #20
 118+ 0000                  ; endm
 119+ 0000
 120+ 0000              ;закрыть соединение ESP
 121+ 0000              ;вх:
 122+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 123+ 0000                  macro OS_ESP_CLOSE
 124+ 0000 ~                ld c,#0c
 125+ 0000 ~                rst #20
 126+ 0000                  endm
 127+ 0000
 128+ 0000              ;установить соединение ESP (CIPSTART);
 129+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; hl - строка адрес, de - строка порт
 130+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 131+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 132+ 0000                  macro OS_ESP_OPEN
 133+ 0000 ~                ld c,#0d
 134+ 0000 ~                rst #20
 135+ 0000                  endm
 136+ 0000
 137+ 0000              ;послать запрос ESP (CIPSEND);
 138+ 0000              ;вх: hl - адрес данных, de - длина данных
 139+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 140+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 141+ 0000                  macro OS_ESP_SEND
 142+ 0000 ~                ld c,#0e
 143+ 0000 ~                rst #20
 144+ 0000                  endm
 145+ 0000
 146+ 0000              ;получить пакет ESP (+IPD);
 147+ 0000              ;вх: hl - адрес для данных
 148+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 149+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 150+ 0000                  macro OS_ESP_GET
 151+ 0000 ~                ld c,#0f
 152+ 0000 ~                rst #20
 153+ 0000                  endm
 154+ 0000
 155+ 0000              ;ввод с консоли ----------------------
 156+ 0000
 157+ 0000              ;получить код нажатой клавиши
 158+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 159+ 0000 ~                ld c,#10
 160+ 0000 ~                rst #20
 161+ 0000                  endm
 162+ 0000
 163+ 0000
 164+ 0000              ;процессы ----------------------------
 165+ 0000
 166+ 0000              ;запустить процесс
 167+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 168+ 0000                  macro OS_PROC_RUN ;
 169+ 0000 ~                ld c,#11
 170+ 0000 ~                rst #20
 171+ 0000                  endm
 172+ 0000
 173+ 0000              ;установить фокус
 174+ 0000              ;вх: a - id процесса
 175+ 0000                  macro OS_PROC_SET_FOCUS ;
 176+ 0000 ~                ld c,#12
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;закрыть процесс
 181+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 182+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 183+ 0000                  macro OS_PROC_CLOSE ;
 184+ 0000 ~                ld c,#13
 185+ 0000 ~                rst #20
 186+ 0000                  endm
 187+ 0000
 188+ 0000
 189+ 0000              ;прерывания --------------------------
 190+ 0000
 191+ 0000              ;установка адреса обработчика прерываний процесса;
 192+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 193+ 0000                  ; ld c,#14
 194+ 0000                  ; rst #20
 195+ 0000                  ; endm
 196+ 0000
 197+ 0000
 198+ 0000              ;плеер AY ----------------------------
 199+ 0000
 200+ 0000              ;инициализация плеера AY;
 201+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 202+ 0000 ~                ld c,#15
 203+ 0000 ~                rst #20
 204+ 0000                  endm
 205+ 0000
 206+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 207+ 0000                  macro OS_VTPL_PLAY ;()
 208+ 0000 ~                ld c,#16
 209+ 0000 ~                rst #20
 210+ 0000                  endm
 211+ 0000
 212+ 0000              ;заглушить плеер AY;
 213+ 0000                  macro OS_VTPL_MUTE ;()
 214+ 0000 ~                ld c,#17
 215+ 0000 ~                rst #20
 216+ 0000                  endm
 217+ 0000
 218+ 0000              ;получить значение переменной плеера;
 219+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 220+ 0000 ~                ld c,#18
 221+ 0000 ~                rst #20
 222+ 0000                  endm
 223+ 0000
 224+ 0000
 225+ 0000              ;прочие ------------------------------
 226+ 0000
 227+ 0000
 228+ 0000              ;скопировать данные из страницы в страницу
 229+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 230+ 0000                  macro OS_RAM_COPY
 231+ 0000 ~                ld c,#19
 232+ 0000 ~                rst #20
 233+ 0000                  endm
 234+ 0000
 235+ 0000              ;получить дополнительную страницу памяти;
 236+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 237+ 0000 ~                ld c,#1a
 238+ 0000 ~                rst #20
 239+ 0000                  endm
 240+ 0000
 241+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 242+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 243+ 0000 ~                ld c,#1b
 244+ 0000 ~                rst #20
 245+ 0000                  endm
 246+ 0000
 247+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 248+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 249+ 0000 ~                ld c,#1c
 250+ 0000 ~                rst #20
 251+ 0000                  endm
 252+ 0000
 253+ 0000              ;включить экран N;
 254+ 0000                  macro OS_SET_SCREEN ;(A - number screen 5, 7, 39, 3a)
 255+ 0000 ~                ld c,#1d
 256+ 0000 ~                rst #20
 257+ 0000                  endm
 258+ 0000
 259+ 0000
 260+ 0000              ;получить номера страниц процесса;
 261+ 0000              ;вх:
 262+ 0000              ;вых: b, c - страницы в слотах 2, 3
 263+ 0000                  macro OS_GET_MAIN_PAGES ;
 264+ 0000 ~                ld c,#1e
 265+ 0000 ~                rst #20
 266+ 0000                  endm
 267+ 0000
 268+ 0000              ;получить значение системного таймера
 269+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 270+ 0000 ~                ld c,#1F
 271+ 0000 ~                rst #20
 272+ 0000                  endm
 273+ 0000
 274+ 0000
 275+ 0000
 276+ 0000                  ; macro OS_ ;
 277+ 0000                  ; ld c,#20
 278+ 0000                  ; rst #20
 279+ 0000                  ; endm
 280+ 0000
 281+ 0000
 282+ 0000              ;дисковые операции -------------------
 283+ 0000
 284+ 0000              ;открыть файл для чтения или записи
 285+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size)
 286+ 0000 ~                ld c,#21
 287+ 0000 ~                rst #20
 288+ 0000                  endm
 289+ 0000
 290+ 0000              ;создать файл
 291+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file)
 292+ 0000 ~                ld c,#22
 293+ 0000 ~                rst #20
 294+ 0000                  endm
 295+ 0000
 296+ 0000              ;прочитать из файла
 297+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
 298+ 0000 ~                ld c,#23
 299+ 0000 ~                rst #20
 300+ 0000                  endm
 301+ 0000
 302+ 0000              ;записать в файл
 303+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 304+ 0000 ~                ld c,#24
 305+ 0000 ~                rst #20
 306+ 0000                  endm
 307+ 0000
 308+ 0000              ;закрыть файл
 309+ 0000                  macro OS_FILE_CLOSE ;A - id file
 310+ 0000 ~                ld c,#25
 311+ 0000 ~                rst #20
 312+ 0000                  endm
 313+ 0000
 314+ 0000              ;чтение секторов текущего каталога
 315+ 0000              ; вх:
 316+ 0000                   ; hl - буфер для чтения
 317+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 318+ 0000                   ; b - максимальное количество секторов для чтения
 319+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 320+ 0000                     ; a=errRWnum
 321+ 0000                     ; a=errInvalidPart
 322+ 0000                     ; a=errFileEmpty
 323+ 0000                   ; cy=0, a=errEoF - каталог закончился
 324+ 0000                     ; hl - следующий адрес в буфере
 325+ 0000                     ; de - номер первого непрочитанного сектора
 326+ 0000                     ; b - не прочитано секторов
 327+ 0000                   ; cy=0 - считано успешно
 328+ 0000                     ; hl - следующий адрес в буфере
 329+ 0000                     ; de - номер первого непрочитанного сектора
 330+ 0000                     ; b=#00
 331+ 0000                  macro OS_READ_DIR ;
 332+ 0000 ~                ld c,#26
 333+ 0000 ~                rst #20
 334+ 0000                  endm
 335+ 0000
 336+ 0000              ;вход в каталог/выход в родительский каталог
 337+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 338+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 339+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 340+ 0000              	; переход в родительский, последнее имя в пути удалится).
 341+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 342+ 0000              	; добавится имя файла
 343+ 0000              ; вх:
 344+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 345+ 0000                   ; de - адрес дескриптора директории/файла
 346+ 0000              ; вых: a - если путь был указан, новая длина пути
 347+ 0000                  macro OS_OPEN_DIR ;
 348+ 0000 ~                ld c,#27
 349+ 0000 ~                rst #20
 350+ 0000                  endm
 351+ 0000
 352+ 0000
 353+ 0000                  ; macro OS_ ;
 354+ 0000                  ; ld c,#28
 355+ 0000                  ; rst #20
 356+ 0000                  ; endm
 357+ 0000
 358+ 0000                  ; macro OS_ ;
 359+ 0000                  ; ld c,#29
 360+ 0000                  ; rst #20
 361+ 0000                  ; endm
 362+ 0000
 363+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROGSTART
   5  8000
   6  8000              ;порядок работы:
   7  8000              ;открытие соединения
   8  8000              ;проверка результата
   9  8000              ;отправка запроса
  10  8000              ;проверка результата
  11  8000              ;принять ответ
  12  8000              ;проверка результата
  13  8000              ;принять ещё пакеты, если есть, до закрытия соединения, или до получения ожидаемой длины
  14  8000              ;закрыть соединение
  15  8000              ;при каждой возможности (в паузах) закрывать соединение, чтобы уступить очередь другим приложениям.
  16  8000
  17  8000              start_radio
  18  8000              	; ld a,13 ;новая строка
  19  8000              	; OS_PRINT_CHARF
  20  8000 21 6C 88     	ld hl,msg_title_radio ;имя приложения
  21  8003              	OS_PRINTZ ;печать
  21  8003 0E 09       >    ld c,#09
  21  8005 E7          >    rst #20
  22  8006
  23  8006
  24  8006              ; radio_get_link
  25  8006              	; ld hl,msg_get_link_id
  26  8006              	; OS_PRINTZ ;печать
  27  8006
  28  8006              	; xor a ;CY=0
  29  8006              	; OS_ESP_LINK_ID ;получить номер соединения
  30  8006              	; jr nc,radio_get_link_ok
  31  8006
  32  8006              	; call radio_main_error
  33  8006              	; jr radio_get_link
  34  8006
  35  8006              ; radio_get_link_ok ;ID получили
  36  8006              	; ld (link_id),a
  37  8006
  38  8006              start_radio_warm
  39  8006 21 64 86     	ld hl,start_request ;очистить номер первого трека
  40  8009 11 65 86     	ld de,start_request+1
  41  800C 01 04 00     	ld bc,5-1
  42  800F 36 30        	ld (hl),"0"
  43  8011 ED B0        	ldir
  44  8013
  45  8013 21 28 86     	ld hl,format_pt3 ;формат
  46  8016 11 7F 86     	ld de,request_format
  47  8019 01 03 00     	ld bc,3
  48  801C ED B0        	ldir
  49  801E
  50  801E              	;настроить плеер
  51  801E 3E 21        	ld a,%00100001 ;pt3 auto
  52  8020 32 34 86     	ld (player_setup),a
  53  8023
  54  8023 ED 5F        	ld a,r
  55  8025 32 5B 84     	ld (seed+1),a ;элемент случайности
  56  8028
  57  8028              radio_main
  58  8028              ;основной цикл
  59  8028              	; OS_GET_CHAR
  60  8028              	; cp "r"
  61  8028              	; jp z,start_radio ;всё сначала
  62  8028              	; cp "R"
  63  8028              	; jp z,start_radio ;всё сначала
  64  8028
  65  8028              	; call radio_open_site ;открыть сайт
  66  8028
  67  8028              	; jr nc,radio_main_open_ok
  68  8028              	; call radio_main_error
  69  8028              	; jr radio_main
  70  8028
  71  8028              radio_main_open_ok
  72  8028              ;открыли нормально
  73  8028              	OS_GET_CHAR
  73  8028 0E 10       >    ld c,#10
  73  802A E7          >    rst #20
  74  802B FE 72        	cp "r"
  75  802D CA 00 80     	jp z,start_radio ;всё сначала
  76  8030 FE 52        	cp "R"
  77  8032 CA 00 80     	jp z,start_radio ;всё сначала
  78  8035 FE 18        	cp 24 ;break
  79  8037 CA 01 81     	jp z,exit
  80  803A
  81  803A
  82  803A CD A5 81     	call radio_request_info ;запрос информации
  83  803D
  84  803D 30 05        	jr nc,radio_request_info_ok
  85  803F CD 62 81     	call radio_main_error
  86  8042 18 E4        	jr radio_main_open_ok
  87  8044
  88  8044
  89  8044
  90  8044
  91  8044              radio_request_info_ok
  92  8044              ;запрос прошёл
  93  8044              	OS_GET_CHAR
  93  8044 0E 10       >    ld c,#10
  93  8046 E7          >    rst #20
  94  8047 FE 72        	cp "r"
  95  8049 CA 00 80     	jp z,start_radio ;всё сначала
  96  804C FE 52        	cp "R"
  97  804E CA 00 80     	jp z,start_radio ;всё сначала
  98  8051 FE 18        	cp 24 ;break
  99  8053 CA 01 81     	jp z,exit
 100  8056
 101  8056 CD CB 81     	call radio_download_info ;загрузка информации
 102  8059
 103  8059 30 05        	jr nc,radio_download_info_ok
 104  805B CD 62 81     	call radio_main_error
 105  805E 18 C8        	jr radio_main_open_ok
 106  8060
 107  8060
 108  8060
 109  8060
 110  8060              radio_download_info_ok
 111  8060              ;загрузка инфы прошла
 112  8060
 113  8060
 114  8060
 115  8060              ;теперь выбранный трек
 116  8060
 117  8060              	OS_GET_CHAR
 117  8060 0E 10       >    ld c,#10
 117  8062 E7          >    rst #20
 118  8063 FE 72        	cp "r"
 119  8065 CA 00 80     	jp z,start_radio ;всё сначала
 120  8068 FE 52        	cp "R"
 121  806A CA 00 80     	jp z,start_radio ;всё сначала
 122  806D FE 18        	cp 24 ;break
 123  806F CA 01 81     	jp z,exit
 124  8072
 125  8072 CD 87 82     	call radio_request_track ;запрос трека
 126  8075
 127  8075 30 05        	jr nc,radio_request_track_ok
 128  8077 CD 62 81     	call radio_main_error
 129  807A 18 E4        	jr radio_download_info_ok
 130  807C
 131  807C              radio_request_track_ok
 132  807C              ;загрузка инфы о треке прошла
 133  807C              	OS_GET_CHAR
 133  807C 0E 10       >    ld c,#10
 133  807E E7          >    rst #20
 134  807F FE 72        	cp "r"
 135  8081 CA 00 80     	jp z,start_radio ;всё сначала
 136  8084 FE 52        	cp "R"
 137  8086 CA 00 80     	jp z,start_radio ;всё сначала
 138  8089 FE 18        	cp 24 ;break
 139  808B CA 01 81     	jp z,exit
 140  808E
 141  808E CD AD 82     	call radio_download_track ;загрузка трека
 142  8091
 143  8091 30 05        	jr nc,radio_download_track_ok
 144  8093 CD 62 81     	call radio_main_error
 145  8096 18 C8        	jr radio_download_info_ok
 146  8098
 147  8098              radio_download_track_ok
 148  8098
 149  8098
 150  8098              	;начать игру
 151  8098 22 22 86     	ld (start_track),hl
 152  809B              	;ld hl, outputBuffer  :
 153  809B              	OS_GET_VTPL_SETUP
 153  809B 0E 18       >    ld c,#18
 153  809D E7          >    rst #20
 154  809E 3A 34 86     	ld a,(player_setup)
 155  80A1 77           	ld (hl),a ;настройки
 156  80A2
 157  80A2 2A 22 86     	ld hl,(start_track)
 158  80A5              	OS_VTPL_INIT
 158  80A5 0E 15       >    ld c,#15
 158  80A7 E7          >    rst #20
 159  80A8              	OS_VTPL_PLAY
 159  80A8 0E 16       >    ld c,#16
 159  80AA E7          >    rst #20
 160  80AB
 161  80AB 21 B7 85     	ld hl,msg_play_track
 162  80AE              	OS_PRINTZ
 162  80AE 0E 09       >    ld c,#09
 162  80B0 E7          >    rst #20
 163  80B1 CD 3F 83     	call print_sys_info ;печать менюшки
 164  80B4
 165  80B4
 166  80B4              loop_radio
 167  80B4              	OS_WAIT
 167  80B4 DF          >	rst #18
 168  80B5              	OS_GET_CHAR
 168  80B5 0E 10       >    ld c,#10
 168  80B7 E7          >    rst #20
 169  80B8 FE 72        	cp "r"
 170  80BA CA F5 80     	jp z,restart ;всё сначала
 171  80BD FE 52        	cp "R"
 172  80BF CA F5 80     	jp z,restart ;всё сначала
 173  80C2 FE 73        	cp "s" ;останов
 174  80C4 CA EA 80     	jp z, .stopKey
 175  80C7 FE 53        	cp "S" ;останов
 176  80C9 CA EA 80     	jp z, .stopKey
 177  80CC              	; cp "n" ;следующий случайный
 178  80CC              	; jp z, next_track_rnd
 179  80CC FE 20        	cp " " ;слудующий случайный
 180  80CE CA 05 81     	jp z, next_track_rnd
 181  80D1 FE 31        	cp "1" ;формат
 182  80D3 CA 1F 81     	jp z, select_pt2
 183  80D6 FE 32        	cp "2" ;формат
 184  80D8 CA 38 81     	jp z, select_pt3
 185  80DB              	; cp "3" ;формат
 186  80DB              	; jp z, select_ts
 187  80DB              	; cp "4" ;формат
 188  80DB              	; jp z, select_tfc
 189  80DB FE 18        	cp 24 ;break
 190  80DD CA 01 81     	jp z,exit
 191  80E0              	OS_GET_VTPL_SETUP
 191  80E0 0E 18       >    ld c,#18
 191  80E2 E7          >    rst #20
 192  80E3 7E               ld a, (hl)
 192  80E4
 193  80E4 17           	rla
 193  80E5 30 CD          jr nc, loop_radio
 194  80E7 C3 05 81     	jp next_track_rnd
 195  80EA              .stopKey
 196  80EA              	OS_VTPL_MUTE
 196  80EA 0E 17       >    ld c,#17
 196  80EC E7          >    rst #20
 197  80ED 21 C6 85     	ld hl,msg_stop
 198  80F0              	OS_PRINTZ
 198  80F0 0E 09       >    ld c,#09
 198  80F2 E7          >    rst #20
 199  80F3 18 BF        	jr loop_radio
 200  80F5              ; loop_radio2
 201  80F5              	; jr loop_radio2
 202  80F5
 203  80F5              restart
 204  80F5              	OS_VTPL_MUTE
 204  80F5 0E 17       >    ld c,#17
 204  80F7 E7          >    rst #20
 205  80F8 21 CC 85     	ld hl,msg_restart
 206  80FB              	OS_PRINTZ
 206  80FB 0E 09       >    ld c,#09
 206  80FD E7          >    rst #20
 207  80FE C3 06 80     	jp start_radio_warm
 208  8101
 209  8101              exit ;выход в ДОС
 210  8101 AF           	xor a
 211  8102              	OS_PROC_CLOSE
 211  8102 0E 13       >    ld c,#13
 211  8104 E7          >    rst #20
 212  8105
 213  8105
 214  8105              ;следующий трек
 215  8105              next_track_rnd
 216  8105              	;получить случайный номер трека
 217  8105              	; nop
 218  8105              	; nop
 219  8105              	OS_VTPL_MUTE
 219  8105 0E 17       >    ld c,#17
 219  8107 E7          >    rst #20
 220  8108 2A 20 86     	ld hl,(total_track)
 221  810B CD 2D 84     	call rnd
 222  810E              	;подставить номер
 223  810E CD 7E 84     	call toDecimal
 224  8111              	;ld (start_track),hl
 225  8111 21 D4 84     	ld hl,decimalS
 226  8114 11 64 86     	ld de,start_request
 227  8117 01 05 00     	ld bc,5
 228  811A ED B0        	ldir
 229  811C C3 28 80     	jp radio_main ;на загрузку нового трека
 230  811F
 231  811F              select_pt2 ;выбор типа
 232  811F              	OS_VTPL_MUTE
 232  811F 0E 17       >    ld c,#17
 232  8121 E7          >    rst #20
 233  8122 21 24 86     	ld hl,format_pt2
 234  8125 CD 51 81     	call select_format_print
 235  8128 11 7F 86     	ld de,request_format
 236  812B 01 03 00     	ld bc,3
 237  812E ED B0        	ldir
 238  8130              	;настроить плеер
 239  8130 3E 03        	ld a,%00000011 ;pt2
 240  8132 32 34 86     	ld (player_setup),a
 241  8135 C3 B4 80     	jp loop_radio
 242  8138
 243  8138              select_pt3 ;выбор типа
 244  8138              	OS_VTPL_MUTE
 244  8138 0E 17       >    ld c,#17
 244  813A E7          >    rst #20
 245  813B 21 28 86     	ld hl,format_pt3
 246  813E CD 51 81     	call select_format_print
 247  8141 11 7F 86     	ld de,request_format
 248  8144 01 03 00     	ld bc,3
 249  8147 ED B0        	ldir
 250  8149              	;настроить плеер
 251  8149 3E 21        	ld a,%00100001 ;pt3
 252  814B 32 34 86     	ld (player_setup),a
 253  814E C3 B4 80     	jp loop_radio
 254  8151
 255  8151              ; select_ts ;выбор типа
 256  8151              	; OS_VTPL_MUTE
 257  8151              	; ld hl,format_ts
 258  8151              	; call select_format_print
 259  8151              	; ld de,request_format
 260  8151              	; ld bc,3
 261  8151              	; ldir
 262  8151              	; OS_GET_VTPL_SETUP ;настроить плеер
 263  8151              	; ld a,%00100001 ;%00010001 ;2xPT3
 264  8151              	; ld (hl),a
 265  8151              	; jp loop_radio
 266  8151
 267  8151              ; select_tfc ;выбор типа
 268  8151              	; OS_VTPL_MUTE
 269  8151              	; ld hl,format_tfc
 270  8151              	; call select_format_print
 271  8151              	; ld de,request_format
 272  8151              	; ld bc,3
 273  8151              	; ldir
 274  8151              	; jp loop_radio
 275  8151
 276  8151              select_format_print
 277  8151 E5           	push hl
 278  8152 21 66 85     	ld hl,msg_format
 279  8155              	OS_PRINTZ
 279  8155 0E 09       >    ld c,#09
 279  8157 E7          >    rst #20
 280  8158 E1           	pop hl
 281  8159 E5           	push hl
 282  815A              	OS_PRINTZ
 282  815A 0E 09       >    ld c,#09
 282  815C E7          >    rst #20
 283  815D 3E 0D        	ld a,13
 284  815F              	OS_PRINT_CHARF
 284  815F D7          >	rst #10
 285  8160 E1           	pop hl
 286  8161 C9           	ret
 287  8162
 288  8162
 289  8162              radio_main_error ;печать ошибка
 290  8162              	;какая-то ошибка
 291  8162 3E 02        	ld a,2 ;цвет
 292  8164 06 0C        	ld b,#c
 293  8166              	OS_SET_COLOR
 293  8166 0E 06       >    ld c,#06
 293  8168 E7          >    rst #20
 294  8169 21 5F 85     	ld hl,msg_error
 295  816C              	OS_PRINTZ
 295  816C 0E 09       >    ld c,#09
 295  816E E7          >    rst #20
 296  816F 3E 07        	ld a,7 ;цвет
 297  8171 06 0C        	ld b,#c
 298  8173              	OS_SET_COLOR
 298  8173 0E 06       >    ld c,#06
 298  8175 E7          >    rst #20
 299  8176 CD BF 83     	call delay ;задержка
 300  8179 C9           	ret
 301  817A
 302  817A              radio_open_site ;открыть сайт
 303  817A              	OS_ESP_CLOSE ;на всякий случай сначала закрыть
 303  817A 0E 0C       >    ld c,#0c
 303  817C E7          >    rst #20
 304  817D 21 58 85     	ld hl,msg_open ;печать инфы
 305  8180              	OS_PRINTZ
 305  8180 0E 09       >    ld c,#09
 305  8182 E7          >    rst #20
 306  8183 21 E7 84     	ld hl,site_name
 307  8186              	OS_PRINTZ
 307  8186 0E 09       >    ld c,#09
 307  8188 E7          >    rst #20
 308  8189 3E 0D        	ld a,13 ;новая строка
 309  818B              	OS_PRINT_CHARF
 309  818B D7          >	rst #10
 310  818C 21 E7 84     	ld hl,site_name ;сайт
 311  818F 11 F0 84     	ld de,port_number
 312  8192              	;call Wifi.openTCP ;открыть сайт
 313  8192 AF           	xor a ;открыть TCP
 314  8193              	OS_ESP_OPEN
 314  8193 0E 0D       >    ld c,#0d
 314  8195 E7          >    rst #20
 315  8196 D8           	ret c ;сразу не удалось (может, очередь)
 316  8197              	;или подождём открытия
 317  8197 06 64        	ld b,wait_count ;
 318  8199              radio_open_site_wait
 319  8199              	OS_WAIT
 319  8199 DF          >	rst #18
 320  819A DD 7E 02     	ld a,(ix+2) ;флаг
 321  819D 07           	rlca
 322  819E D8           	ret c ;если ошибка (=255)
 323  819F B7           	or a ;если флаг !=0
 324  81A0 C0           	ret nz
 325  81A1 10 F6        	djnz radio_open_site_wait
 326  81A3 37           	scf ;ощибка
 327  81A4 C9           	ret
 328  81A5
 329  81A5
 330  81A5
 331  81A5
 332  81A5
 333  81A5              radio_request_info ;запрос инфы
 334  81A5 CD 7A 81     	call radio_open_site ;открыть сайт
 335  81A8 D8           	ret c
 336  81A9
 337  81A9 21 81 85     	ld hl,msg_request_info ;
 338  81AC              	OS_PRINTZ
 338  81AC 0E 09       >    ld c,#09
 338  81AE E7          >    rst #20
 339  81AF 11 3E 86     	ld de,requestbuffer
 340  81B2 CD E2 83     	call strLen ;узнать длину
 341  81B5 EB           	ex de,hl
 342  81B6 21 3E 86     	ld hl,requestbuffer
 343  81B9              	;call Wifi.tcpSendZ ;послать запрос
 344  81B9              	OS_ESP_SEND
 344  81B9 0E 0E       >    ld c,#0e
 344  81BB E7          >    rst #20
 345  81BC D8           	ret c;сразу не удалось (может, очередь)
 346  81BD              	;ждём когда запрос пройдёт
 347  81BD 06 64        	ld b,wait_count ;
 348  81BF              radio_request_info_wait2
 349  81BF              	OS_WAIT
 349  81BF DF          >	rst #18
 350  81C0 DD 7E 04     	ld a,(ix+4) ;флаг
 351  81C3 07           	rlca
 352  81C4 D8           	ret c ;если ошибка (=255)
 353  81C5 B7           	or a
 354  81C6 C0           	ret nz
 355  81C7 10 F6        	djnz radio_request_info_wait2
 356  81C9 37           	scf ;ощибка
 357  81CA C9           	ret
 358  81CB
 359  81CB
 360  81CB              radio_download_info ;загрузить инфо
 361  81CB
 362  81CB 21 6F 85     	ld hl,msg_download_info ;
 363  81CE              	OS_PRINTZ
 363  81CE 0E 09       >    ld c,#09
 363  81D0 E7          >    rst #20
 364  81D1
 365  81D1 CD 1F 84     	call clear_outputBuffer ;очистить
 366  81D4
 367  81D4 21 8D 88     	ld hl,outputBuffer ;буфер для загрузки
 368  81D7 22 E0 84     	ld (buffer_pointer),hl
 369  81DA              	;call Wifi.getPacket ;получить ответ
 370  81DA              	OS_ESP_GET
 370  81DA 0E 0F       >    ld c,#0f
 370  81DC E7          >    rst #20
 371  81DD D8           	ret c ;сразу не удалось (может, очередь)
 372  81DE 06 64        	ld b,wait_count ;
 373  81E0              radio_download_info_wait1
 374  81E0              	OS_WAIT
 374  81E0 DF          >	rst #18
 375  81E1 DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 376  81E4 07           	rlca
 377  81E5 D8           	ret c ;если ошибка (=255)
 378  81E6 B7           	or a
 379  81E7 20 04        	jr nz,radio_download_info_wait1_skip
 380  81E9 10 F5        	djnz radio_download_info_wait1
 381  81EB 37           	scf ;ощибка
 382  81EC C9           	ret
 383  81ED
 384  81ED              radio_download_info_wait1_skip
 385  81ED              	;подготовка к приёму дальше
 386  81ED 2A E0 84     	ld hl,(buffer_pointer)
 387  81F0 DD 4E 09     	ld c,(ix+9) ; длина принятого
 388  81F3 DD 46 0A     	ld b,(ix+10)
 389  81F6 09           	add hl,bc
 390  81F7 22 E0 84     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 391  81FA
 392  81FA              	;попробуем найти начало данных
 393  81FA 11 F3 84     	ld de,Content_Length ;найти запись о длине данных
 394  81FD CD 05 84     	call search_str
 395  8200 D8           	ret c
 396  8201
 397  8201 EB           	ex de,hl
 398  8202 CD EC 83     	call text_to_digit ;преобразовать в число
 399  8205 22 DE 84     	ld (data_length),hl ;длина данных
 400  8208
 401  8208 11 E2 84     	ld de,rnrn ;найти конец заголовка
 402  820B CD 05 84     	call search_str
 403  820E D8           	ret c
 404  820F 22 DA 84     	ld (data_start),hl ;начало данных
 405  8212
 406  8212 ED 5B DE 84  	ld de,(data_length)
 407  8216 19           	add hl,de ;узнали ожидаемый конец данных
 408  8217 22 DC 84     	ld (data_end),hl
 409  821A
 410  821A              ;загрузка остальных частей, если есть
 411  821A              radio_download_info1
 412  821A DD 7E 02     	ld a,(ix+2) ;!!! closed
 413  821D B7           	or a
 414  821E 28 35        	jr z,radio_download_info1_skip ;если закрыто, больше не грузим
 415  8220
 416  8220 2A E0 84     	ld hl,(buffer_pointer)
 417  8223 ED 5B DC 84  	ld de,(data_end)
 418  8227 A7           	and a
 419  8228 ED 52        	sbc hl,de
 420  822A 28 29        	jr z,radio_download_info1_skip ;если уже всё загружено
 421  822C
 422  822C
 423  822C              	;ещё не всё
 424  822C 2A E0 84     	ld hl,(buffer_pointer)
 425  822F 7C           	ld a,h
 426  8230 FE FA        	cp buffer_top ;ограничение
 427  8232 30 21        	jr nc,radio_download_info1_skip
 428  8234
 429  8234              	;call Wifi.getPacket
 430  8234              	OS_ESP_GET
 430  8234 0E 0F       >    ld c,#0f
 430  8236 E7          >    rst #20
 431  8237 06 64        	ld b,wait_count ;
 432  8239              radio_download_info_wait2
 433  8239              	OS_WAIT
 433  8239 DF          >	rst #18
 434  823A DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 435  823D 07           	rlca
 436  823E D8           	ret c ;если ошибка (=255)
 437  823F B7           	or a
 438  8240 20 04        	jr nz,radio_download_info_wait2_skip
 439  8242 10 F5        	djnz radio_download_info_wait2
 440  8244 37           	scf
 441  8245 C9           	ret
 442  8246
 443  8246              radio_download_info_wait2_skip
 444  8246 2A E0 84     	ld hl,(buffer_pointer)
 445  8249 DD 4E 09     	ld c,(ix+9) ; длина принятого
 446  824C DD 46 0A     	ld b,(ix+10)
 447  824F 09           	add hl,bc
 448  8250 22 E0 84     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 449  8253
 450  8253 18 C5        	jr radio_download_info1 ;получить ещё части до конца
 451  8255
 452  8255              radio_download_info1_skip
 453  8255
 454  8255              	OS_ESP_CLOSE ;закрыть соединение!
 454  8255 0E 0C       >    ld c,#0c
 454  8257 E7          >    rst #20
 455  8258
 456  8258
 457  8258 11 04 85     	ld de,Content_Sucesfully ;найти запись об успешном запросе
 458  825B CD 05 84     	call search_str
 459  825E D8           	ret c
 460  825F
 461  825F              	; ld de,Content_Length ;найти запись о длине
 462  825F              	; call search_str
 463  825F              	; ret c
 464  825F
 465  825F              	; ex de,hl
 466  825F              	; call text_to_digit ;преобразовать в число
 467  825F
 468  825F              	; ex de,hl
 469  825F              	; ld hl,(buffer_pointer) ;
 470  825F              	; and a
 471  825F              	; sbc hl,de
 472  825F              	; ;узнали начало пакета
 473  825F
 474  825F 2A DA 84     	ld hl,(data_start)
 475  8262
 476  8262 11 4A 85     	ld de,Content_ID ;найти запись об ID файла
 477  8265 CD 05 84     	call search_str
 478  8268 D8           	ret c
 479  8269
 480  8269
 481  8269              	;инфа получена
 482  8269
 483  8269 E5           	push hl
 484  826A CD 54 83     	call print_info_track ;инфо
 485  826D 3E 0D        	ld a,13
 486  826F              	OS_PRINT_CHARF
 486  826F D7          >	rst #10
 487  8270 E1           	pop hl
 488  8271 11 0A 87     	ld de,requestbuffer2_file_id
 489  8274
 490  8274              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 491  8274
 492  8274 CD C5 83     	call id_copy ;скопировать в запрос id трека
 493  8277
 494  8277              	;запомнить сколько всего
 495  8277 11 0B 85     	ld de,Content_Total_Amount ;всего таких треков
 496  827A CD 05 84     	call search_str
 497  827D D8           	ret c
 498  827E EB           	ex de,hl
 499  827F CD EC 83     	call text_to_digit
 500  8282 22 20 86     	ld (total_track),hl
 501  8285 B7           	or a
 502  8286 C9           	ret
 503  8287
 504  8287
 505  8287
 506  8287
 507  8287
 508  8287
 509  8287              radio_request_track	;запрос трека
 510  8287 CD 7A 81     	call radio_open_site ;открыть сайт
 511  828A D8           	ret c
 512  828B
 513  828B 21 92 85     	ld hl,msg_request_track
 514  828E              	OS_PRINTZ
 514  828E 0E 09       >    ld c,#09
 514  8290 E7          >    rst #20
 515  8291
 516  8291              	;ld hl,requestbuffer2_title
 517  8291              	;OS_PRINTZ
 518  8291 11 FD 86     	ld de,requestbuffer2
 519  8294 CD E2 83     	call strLen ;узнать длину
 520  8297 EB           	ex de,hl
 521  8298 21 FD 86     	ld hl,requestbuffer2
 522  829B              	OS_ESP_SEND
 522  829B 0E 0E       >    ld c,#0e
 522  829D E7          >    rst #20
 523  829E D8           	ret c ;сразу не удалось (может, очередь)
 524  829F              	;ждём когда запрос пройдёт
 525  829F 06 64        	ld b,wait_count ;
 526  82A1              radio_request_track_wait2
 527  82A1              	OS_WAIT
 527  82A1 DF          >	rst #18
 528  82A2 DD 7E 04     	ld a,(ix+4) ;флаг
 529  82A5 07           	rlca
 530  82A6 D8           	ret c ;если ошибка (=255)
 531  82A7 B7           	or a
 532  82A8 C0           	ret nz
 533  82A9 10 F6        	djnz radio_request_track_wait2
 534  82AB 37           	scf
 535  82AC C9           	ret
 536  82AD
 537  82AD
 538  82AD
 539  82AD
 540  82AD              radio_download_track ;загрузить трек
 541  82AD 21 A4 85     	ld hl,msg_download_track
 542  82B0              	OS_PRINTZ
 542  82B0 0E 09       >    ld c,#09
 542  82B2 E7          >    rst #20
 543  82B3
 544  82B3 CD 1F 84     	call clear_outputBuffer ;очистить
 545  82B6
 546  82B6 21 8D 88     	ld hl,outputBuffer ;буфер для загрузки
 547  82B9 22 E0 84     	ld (buffer_pointer),hl
 548  82BC              	;call Wifi.getPacket ;получить ответ
 549  82BC              	OS_ESP_GET
 549  82BC 0E 0F       >    ld c,#0f
 549  82BE E7          >    rst #20
 550  82BF D8           	ret c ;сразу не удалось (может, очередь)
 551  82C0 06 64        	ld b,wait_count ;
 552  82C2              radio_download_track_wait1
 553  82C2              	OS_WAIT
 553  82C2 DF          >	rst #18
 554  82C3 DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 555  82C6 07           	rlca
 556  82C7 D8           	ret c ;если ошибка (=255)
 557  82C8 B7           	or a
 558  82C9 20 04        	jr nz,radio_download_track_wait1_skip
 559  82CB 10 F5        	djnz radio_download_track_wait1
 560  82CD 37           	scf
 561  82CE C9           	ret
 562  82CF
 563  82CF              radio_download_track_wait1_skip
 564  82CF              	;подготовка к приёму дальше
 565  82CF 2A E0 84     	ld hl,(buffer_pointer)
 566  82D2 DD 4E 09     	ld c,(ix+9) ; длина принятого
 567  82D5 DD 46 0A     	ld b,(ix+10)
 568  82D8 09           	add hl,bc
 569  82D9 22 E0 84     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 570  82DC
 571  82DC              	;попробуем найти начало данных
 572  82DC 11 F3 84     	ld de,Content_Length ;найти запись о длине данных
 573  82DF CD 05 84     	call search_str
 574  82E2 D8           	ret c
 575  82E3
 576  82E3 EB           	ex de,hl
 577  82E4 CD EC 83     	call text_to_digit ;преобразовать в число
 578  82E7 22 DE 84     	ld (data_length),hl ;длина данных
 579  82EA
 580  82EA 11 E2 84     	ld de,rnrn ;найти конец заголовка
 581  82ED CD 05 84     	call search_str
 582  82F0 D8           	ret c
 583  82F1 22 DA 84     	ld (data_start),hl ;начало данных
 584  82F4
 585  82F4 ED 5B DE 84  	ld de,(data_length)
 586  82F8 19           	add hl,de ;узнали ожидаемый конец данных
 587  82F9 22 DC 84     	ld (data_end),hl
 588  82FC
 589  82FC              	;загрузка остатка
 590  82FC              radio_download_track1
 591  82FC
 592  82FC DD 7E 02     	ld a,(ix+2) ;!!! closed
 593  82FF B7           	or a
 594  8300 28 35        	jr z,radio_download_track1_skip ;если закрыто, больше не грузим
 595  8302
 596  8302 2A E0 84     	ld hl,(buffer_pointer)
 597  8305 ED 5B DC 84  	ld de,(data_end)
 598  8309 A7           	and a
 599  830A ED 52        	sbc hl,de
 600  830C 28 29        	jr z,radio_download_track1_skip ;если уже всё загружено
 601  830E
 602  830E
 603  830E              	;ещё не всё
 604  830E 2A E0 84     	ld hl,(buffer_pointer)
 605  8311 7C           	ld a,h
 606  8312 FE FA        	cp buffer_top ;ограничение
 607  8314 30 21        	jr nc,radio_download_track1_skip
 608  8316
 609  8316              	;call Wifi.getPacket
 610  8316              	OS_ESP_GET
 610  8316 0E 0F       >    ld c,#0f
 610  8318 E7          >    rst #20
 611  8319 06 64        	ld b,wait_count ;
 612  831B              radio_download_track_wait2
 613  831B              	OS_WAIT
 613  831B DF          >	rst #18
 614  831C DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 615  831F 07           	rlca
 616  8320 D8           	ret c ;если ошибка (=255)
 617  8321 B7           	or a
 618  8322 20 04        	jr nz,radio_download_track_wait2_skip
 619  8324 10 F5        	djnz radio_download_track_wait2
 620  8326 37           	scf
 621  8327 C9           	ret
 622  8328
 623  8328              radio_download_track_wait2_skip
 624  8328 2A E0 84     	ld hl,(buffer_pointer)
 625  832B DD 4E 09     	ld c,(ix+9) ; длина принятого
 626  832E DD 46 0A     	ld b,(ix+10)
 627  8331 09           	add hl,bc
 628  8332 22 E0 84     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 629  8335
 630  8335 18 C5        	jr radio_download_track1 ;получить ещё части до конца
 631  8337
 632  8337              radio_download_track1_skip
 633  8337              	OS_ESP_CLOSE ;закрыть!
 633  8337 0E 0C       >    ld c,#0c
 633  8339 E7          >    rst #20
 634  833A
 635  833A
 636  833A              	; ;определить длину
 637  833A              	; ld de,Content_Length ;найти запись о длине
 638  833A              	; call search_str
 639  833A              	; ret c
 640  833A              	; ex de,hl
 641  833A              	; call text_to_digit ;преобразовать в число
 642  833A
 643  833A              	; ex de,hl
 644  833A              	; ld hl,(buffer_pointer) ;
 645  833A              	; and a
 646  833A              	; sbc hl,de
 647  833A              	; ;узнали начало пакета
 648  833A
 649  833A 2A DA 84     	ld hl,(data_start) ;начало данных
 650  833D B7           	or a
 651  833E C9           	ret
 652  833F
 653  833F
 654  833F
 655  833F
 656  833F
 657  833F
 658  833F              print_sys_info ;печать меню управления
 659  833F 3E 47        	ld a,7+64 ;цвет
 660  8341 06 0C        	ld b,#c
 661  8343              	OS_SET_COLOR
 661  8343 0E 06       >    ld c,#06
 661  8345 E7          >    rst #20
 662  8346 21 D8 85     	ld hl,msg_sys_info
 663  8349              	OS_PRINTZ
 663  8349 0E 09       >    ld c,#09
 663  834B E7          >    rst #20
 664  834C 3E 07        	ld a,7 ;цвет
 665  834E 06 0C        	ld b,#c
 666  8350              	OS_SET_COLOR
 666  8350 0E 06       >    ld c,#06
 666  8352 E7          >    rst #20
 667  8353 C9           	ret
 668  8354
 669  8354
 670  8354              print_info_track ;печать инфо о треке
 671  8354 21 0B 85     	ld hl,Content_Total_Amount ;всего таких треков
 672  8357 CD A0 83     	call print_info_track_one
 673  835A D8           	ret c
 674  835B
 675  835B 21 4A 85     	ld hl,Content_ID ;id трека
 676  835E CD A0 83     	call print_info_track_one
 677  8361 D8           	ret c
 678  8362
 679  8362 21 50 85     	ld hl,Content_Type ;формат трека
 680  8365 CD A0 83     	call print_info_track_one
 681  8368 D8           	ret c
 682  8369
 683  8369 3E 04        	ld a,4 ;цвет
 684  836B 06 0C        	ld b,#c
 685  836D              	OS_SET_COLOR
 685  836D 0E 06       >    ld c,#06
 685  836F E7          >    rst #20
 686  8370 21 1A 85     	ld hl,Content_Title ;название трека
 687  8373 CD A0 83     	call print_info_track_one
 688  8376 F5           	push af
 689  8377 3E 07        	ld a,7 ;цвет
 690  8379 06 0C        	ld b,#c
 691  837B              	OS_SET_COLOR
 691  837B 0E 06       >    ld c,#06
 691  837D E7          >    rst #20
 692  837E F1           	pop af
 693  837F D8           	ret c
 694  8380
 695  8380 21 3A 85     	ld hl,Content_Year ;год трека
 696  8383 CD A0 83     	call print_info_track_one
 697  8386 D8           	ret c
 698  8387
 699  8387 21 42 85     	ld hl,Content_Time ;длина трека
 700  838A CD A0 83     	call print_info_track_one
 701  838D D8           	ret c
 702  838E
 703  838E 21 30 85     	ld hl,Content_Rating ;рейтинг трека
 704  8391 CD A0 83     	call print_info_track_one
 705  8394 D8           	ret c
 706  8395
 707  8395 21 23 85     	ld hl,Content_AuthorIDs ;id автора трека
 708  8398 CD A0 83     	call print_info_track_one
 709  839B D8           	ret c
 710  839C
 711  839C 3E 0D        	ld a,13
 712  839E              	OS_PRINT_CHARF
 712  839E D7          >	rst #10
 713  839F C9           	ret
 714  83A0
 715  83A0
 716  83A0              print_info_track_one
 717  83A0 E5           	push hl
 718  83A1 3E 0D        	ld a,13
 719  83A3              	OS_PRINT_CHARF
 719  83A3 D7          >	rst #10
 720  83A4 E1           	pop hl
 721  83A5 E5           	push hl
 722  83A6              	OS_PRINTZ
 722  83A6 0E 09       >    ld c,#09
 722  83A8 E7          >    rst #20
 723  83A9 D1           	pop de
 724  83AA CD 05 84     	call search_str
 725  83AD D8           	ret c
 726  83AE CD B3 83     	call print_to_sym ;печать значения
 727  83B1 B7           	or a
 728  83B2 C9           	ret
 729  83B3
 730  83B3              print_to_sym ;печать до символа "," или 0
 731  83B3 7E           	ld a,(hl)
 732  83B4 FE 2C        	cp ","
 733  83B6 C8           	ret z
 734  83B7 B7           	or a
 735  83B8 C8           	ret z
 736  83B9 E5           	push hl
 737  83BA              	OS_PRINT_CHARF
 737  83BA D7          >	rst #10
 738  83BB E1           	pop hl
 739  83BC 23           	inc hl
 740  83BD 18 F4        	jr print_to_sym
 741  83BF
 742  83BF
 743  83BF              delay ;задержка между запросами
 744  83BF 06 32        	ld b,50*1 ;
 745  83C1              delay1
 746  83C1              	OS_WAIT
 746  83C1 DF          >	rst #18
 747  83C2 10 FD        	djnz delay1
 748  83C4 C9           	ret
 749  83C5
 750  83C5              ;hl - from
 751  83C5              ;de - to
 752  83C5              id_copy ;скопировать текст id
 753  83C5 7E           	ld a,(hl)
 754  83C6 FE 30        	cp "0"
 755  83C8 38 09        	jr c,id_copy2
 756  83CA FE 3A        	cp "9"+1
 757  83CC 30 05        	jr nc,id_copy2
 758  83CE 12           	ld (de),a
 759  83CF 13           	inc de
 760  83D0 23           	inc hl
 761  83D1 18 F2        	jr id_copy
 762  83D3
 763  83D3              id_copy2
 764  83D3              	;скопировать остаток строки запроса
 765  83D3 21 0A 88     	ld hl,requestbuffer2_end
 766  83D6              id_copy3
 767  83D6 7E           	ld a,(hl)
 768  83D7 B7           	or a
 769  83D8 28 05        	jr z,id_copy_ex
 770  83DA 12           	ld (de),a
 771  83DB 13           	inc de
 772  83DC 23           	inc hl
 773  83DD 18 F7        	jr id_copy3
 774  83DF              id_copy_ex
 775  83DF AF           	xor a
 776  83E0 12           	ld (de),a  ;в конце 0
 777  83E1 C9           	ret
 778  83E2
 779  83E2              strLen: ;посчитать длину строки до 0
 780  83E2 21 00 00         ld hl, 0
 781  83E5              .loop
 782  83E5 1A               ld a, (de)
 782  83E6 A7             and a
 782  83E7 C8             ret z
 783  83E8 13 23            inc de, hl
 784  83EA 18 F9            jr .loop
 785  83EC
 786  83EC              text_to_digit ;тест в цифру
 787  83EC              ;de - текст
 788  83EC              ;вых: hl - цифра
 789  83EC 21 00 00     		ld hl,0			; count lenght
 790  83EF 1A           .cil1	ld a,(de)
 791  83F0 13           		inc de
 792  83F1 FE 30        		cp "0"
 792  83F3 D8             ret c
 793  83F4 FE 3A        		cp "9"+1
 793  83F6 D0             ret nc
 794  83F7 D6 30        		sub 0x30
 794  83F9 4D             ld c,l
 794  83FA 44             ld b,h
 794  83FB 29             add hl,hl
 794  83FC 29             add hl,hl
 794  83FD 09             add hl,bc
 794  83FE 29             add hl,hl
 794  83FF 4F             ld c,a
 794  8400 06 00          ld b,0
 794  8402 09             add hl,bc
 795  8403 18 EA        		jr .cil1
 796  8405
 797  8405              ;поиск строки
 798  8405              ;de - образец, в конце 0
 799  8405              ;вых: hl - адрес после найденного
 800  8405              search_str
 801  8405 21 8D 88     	ld hl,outputBuffer
 802  8408 42           	ld b,d
 803  8409 4B           	ld c,e
 804  840A              search_str2
 805  840A 1A           	ld a,(de)
 806  840B BE           	cp (hl)
 807  840C 20 0A        	jr nz,search_str1
 808  840E              	;нашли одну букву
 809  840E              search_str3
 810  840E 23           	inc hl
 811  840F 13           	inc de
 812  8410 1A           	ld a,(de)
 813  8411 B7           	or a
 814  8412 C8           	ret z ;нашли всю строку
 815  8413 BE           	cp (hl)
 816  8414 28 F8        	jr z,search_str3
 817  8416              	;не вся строка совпала
 818  8416 50           	ld d,b ;в начало образца
 819  8417 59           	ld e,c
 820  8418              search_str1
 821  8418 23           	inc hl ;дальше
 822  8419 24           	inc h
 823  841A 25           	dec h
 824  841B 20 ED        	jr nz,search_str2
 825  841D 37           	scf ;не нашли
 826  841E C9           	ret
 827  841F
 828  841F
 829  841F              clear_outputBuffer ;почистить буфер приёма
 830  841F 21 8D 88     	ld hl,outputBuffer
 831  8422 11 8E 88     	ld de,outputBuffer+1
 832  8425 01 71 77     	ld bc,#ffff-outputBuffer-1
 833  8428 36 00        	ld (hl),0
 834  842A ED B0        	ldir
 835  842C C9           	ret
 836  842D
 837  842D
 838  842D              ;вх: HL - диапазон
 839  842D              ;вых: HL - результат
 840  842D              rnd ;генератор случайного числа в заданном диапазоне
 841  842D 7C           	ld a,h
 842  842E B5           	or l
 843  842F C8           	ret z
 844  8430 AF           	xor a ;очистить переменную
 845  8431 32 57 84     	ld (rnd_out),a
 846  8434 32 58 84     	ld (rnd_out+1),a
 847  8437 E5           	push hl
 848  8438 CD 59 84     	call random ;получить случайное
 849  843B              	;умножить диапазон на случайное число и взять старшие два байта
 850  843B C1           	pop bc ;счётчик
 851  843C EB           	ex de,hl
 852  843D 21 00 00     	ld hl,0
 853  8440              rnd_cl
 854  8440 19           	add hl,de
 855  8441 30 0B        	jr nc,rnd_cl1 ;если нет переполения
 856  8443 D9           	exx
 857  8444 ED 5B 57 84  	ld de,(rnd_out) ;увеличить старшие байты
 858  8448 13           	inc de
 859  8449 ED 53 57 84  	ld (rnd_out),de
 860  844D D9           	exx
 861  844E              rnd_cl1
 862  844E 0B           	dec bc
 863  844F 78           	ld a,b
 864  8450 B1           	or c
 865  8451 20 ED        	jr nz,rnd_cl
 866  8453 2A 57 84     	ld hl,(rnd_out)
 867  8456 C9           	ret
 868  8457 00 00        rnd_out dw 0 ;ответ случайное число
 869  8459
 870  8459
 871  8459              random ;Переписанный генератор из ПЗУ бейсика
 872  8459 11 00 00     	ld	de,0
 873  845C              seed	equ	$-2
 874  845C AF           	xor	a
 875  845D 67 6F 47     	ld	h,a,l,a,b,a
 876  8460 19           	add	hl,de
 877  8461 88           	adc	a,b
 878  8462 29           	add	hl,hl
 879  8463 8F           	adc	a,a
 880  8464 29           	add	hl,hl
 881  8465 8F           	adc	a,a
 882  8466 29           	add	hl,hl
 883  8467 8F           	adc	a,a
 884  8468 19           	add	hl,de
 885  8469 88           	adc	a,b
 886  846A 29           	add	hl,hl
 887  846B 8F           	adc	a,a
 888  846C 29           	add	hl,hl
 889  846D 8F           	adc	a,a
 890  846E 19           	add	hl,de
 891  846F 88           	adc	a,b
 892  8470 29           	add	hl,hl
 893  8471 8F           	adc	a,a
 894  8472 19           	add	hl,de
 895  8473 88           	adc	a,b
 896  8474 D6 4A        	sub	#4a
 897  8476 ED 44        	neg
 898  8478 4F           	ld	c,a
 899  8479 09           	add	hl,bc
 900  847A 22 5A 84     	ld	(seed),hl
 901  847D C9           	ret
 902  847E
 903  847E              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 904  847E              				;на входе в HL число
 905  847E 11 10 27     			ld de,10000 ;десятки тысяч
 906  8481 3E FF        			ld a,255
 907  8483              toDecimal10k
 908  8483 A7           			and a
 909  8484 ED 52        			sbc hl,de
 910  8486 3C           			inc a
 911  8487 30 FA        			jr nc,toDecimal10k
 912  8489 19           			add hl,de
 913  848A C6 30        			add a,48
 914  848C 32 D4 84     			ld (decimalS),a
 915  848F 11 E8 03     			ld de,1000 ;тысячи
 916  8492 3E FF        			ld a,255
 917  8494              toDecimal1k
 918  8494 A7           			and a
 919  8495 ED 52        			sbc hl,de
 920  8497 3C           			inc a
 921  8498 30 FA        			jr nc,toDecimal1k
 922  849A 19           			add hl,de
 923  849B C6 30        			add a,48
 924  849D 32 D5 84     			ld (decimalS+1),a
 925  84A0 11 64 00     			ld de,100 ;сотни
 926  84A3 3E FF        			ld a,255
 927  84A5              toDecimal01k
 928  84A5 A7           			and a
 929  84A6 ED 52        			sbc hl,de
 930  84A8 3C           			inc a
 931  84A9 30 FA        			jr nc,toDecimal01k
 932  84AB 19           			add hl,de
 933  84AC C6 30        			add a,48
 934  84AE 32 D6 84     			ld (decimalS+2),a
 935  84B1 11 0A 00     			ld de,10 ;десятки
 936  84B4 3E FF        			ld a,255
 937  84B6              toDecimal001k
 938  84B6 A7           			and a
 939  84B7 ED 52        			sbc hl,de
 940  84B9 3C           			inc a
 941  84BA 30 FA        			jr nc,toDecimal001k
 942  84BC 19           			add hl,de
 943  84BD C6 30        			add a,48
 944  84BF 32 D7 84     			ld (decimalS+3),a
 945  84C2 11 01 00     			ld de,1 ;единицы
 946  84C5 3E FF        			ld a,255
 947  84C7              toDecimal0001k
 948  84C7 A7           			and a
 949  84C8 ED 52        			sbc hl,de
 950  84CA 3C           			inc a
 951  84CB 30 FA        			jr nc,toDecimal0001k
 952  84CD 19           			add hl,de
 953  84CE C6 30        			add a,48
 954  84D0 32 D8 84     			ld (decimalS+4),a
 955  84D3
 956  84D3 C9           			ret
 957  84D4
 958  84D4 00 00 00...  decimalS	ds 6 ;десятичные цифры
 959  84DA
 960  84DA
 961  84DA                  ; include "drivers/utils.asm"
 962  84DA                  ; include "drivers/wifi.asm"
 963  84DA              	; include "drivers/zx-wifi.asm"
 964  84DA
 965  84DA
 966  84DA              id_lenght equ 6 ;длина кода файла
 967  84DA              wait_count equ 2*50 ;задержка в кадрах
 968  84DA              buffer_top equ #fa;ограничение буфера сверху #ffff - 1500
 969  84DA
 970  84DA              ; ;ответы ESP
 971  84DA              ; sendOk[] = "SEND OK";
 972  84DA              ; const unsigned char gotWiFi[] = "WIFI GOT IP";
 973  84DA              ; "CONNECT"
 974  84DA
 975  84DA              ; ;команды
 976  84DA              ; ;<link ID> – ID соединения (0–4), используется при нескольких соединениях;
 977  84DA              ; at_cipmux db "AT+CIPMUX=1",0 ;несколько соединений
 978  84DA              ;at_cipstart db "AT+CIPSTART=1,\"TCP\",\"zxart.ee\",80",0
 979  84DA              ; "AT+CIPSEND="
 980  84DA              ; "AT+CIPCLOSE"
 981  84DA              ;link_id db 0; номер соединения
 982  84DA 00 00        data_start dw 0 ;начало данных
 983  84DC 00 00        data_end dw 0 ;конец данных
 984  84DE 00 00        data_length dw 0 ;конец данных
 985  84E0 00 00        buffer_pointer dw 0 ;указатель на буфер
 986  84E2 0D 0A 0D 0A  rnrn db 13,10,13,10,0 ;окончание заголовка
 986  84E6 00
 987  84E7 7A 78 61 72  site_name db "zxart.ee",0 ;имя сайта
 987  84EB 74 2E 65 65
 987  84EF 00
 988  84F0 38 30 00     port_number db "80" ,0;
 989  84F3 43 6F 6E 74  Content_Length db "Content-Length: ",0
 989  84F7 65 6E 74 2D
 989  84FB 4C 65 6E 67
 989  84FF 74 68 3A 20
 989  8503 00
 990  8504 73 75 63 63  Content_Sucesfully db "succes",0
 990  8508 65 73 00
 991  850B 22 74 6F 74  Content_Total_Amount db "\"totalAmount\":",0
 991  850F 61 6C 41 6D
 991  8513 6F 75 6E 74
 991  8517 22 3A 00
 992  851A 22 74 69 74  Content_Title db "\"title\":",0
 992  851E 6C 65 22 3A
 992  8522 00
 993  8523 22 61 75 74  Content_AuthorIDs db "\"authorIds\":",0
 993  8527 68 6F 72 49
 993  852B 64 73 22 3A
 993  852F 00
 994  8530 22 72 61 74  Content_Rating db "\"rating\":",0
 994  8534 69 6E 67 22
 994  8538 3A 00
 995  853A 22 79 65 61  Content_Year db "\"year\":",0
 995  853E 72 22 3A 00
 996  8542 22 74 69 6D  Content_Time db "\"time\":",0
 996  8546 65 22 3A 00
 997  854A 22 69 64 22  Content_ID db "\"id\":",0
 997  854E 3A 00
 998  8550 22 74 79 70  Content_Type db "\"type\":",0
 998  8554 65 22 3A 00
 999  8558              ;file_id db "000000",0 ;id файла
1000  8558 4F 70 65 6E  msg_open db "Open: ",0
1000  855C 3A 20 00
1001  855F 45 72 72 6F  msg_error db "Error",13,0
1001  8563 72 0D 00
1002  8566 46 6F 72 6D  msg_format db "Format: ",0
1002  856A 61 74 3A 20
1002  856E 00
1003  856F 44 6F 77 6E  msg_download_info db "Download info...",13,0
1003  8573 6C 6F 61 64
1003  8577 20 69 6E 66
1003  857B 6F 2E 2E 2E
1003  857F 0D 00
1004  8581 52 65 71 75  msg_request_info db "Request info...",13,0
1004  8585 65 73 74 20
1004  8589 69 6E 66 6F
1004  858D 2E 2E 2E 0D
1004  8591 00
1005  8592 52 65 71 75  msg_request_track db "Request track...",13,0
1005  8596 65 73 74 20
1005  859A 74 72 61 63
1005  859E 6B 2E 2E 2E
1005  85A2 0D 00
1006  85A4 44 6F 77 6E  msg_download_track db "Download track...",13,0
1006  85A8 6C 6F 61 64
1006  85AC 20 74 72 61
1006  85B0 63 6B 2E 2E
1006  85B4 2E 0D 00
1007  85B7 50 6C 61 79  msg_play_track db "Play track...",13,0
1007  85BB 20 74 72 61
1007  85BF 63 6B 2E 2E
1007  85C3 2E 0D 00
1008  85C6 53 74 6F 70  msg_stop db "Stop",13,0
1008  85CA 0D 00
1009  85CC 52 65 73 74  msg_restart db "Restart...",13,0
1009  85D0 61 72 74 2E
1009  85D4 2E 2E 0D 00
1010  85D8              ;msg_get_link_id db "Get link ID...",13,0
1011  85D8 53 20 2D 20  msg_sys_info db "S - stop, R - restart, 1-2 - Format (pt2, pt3)",13
1011  85DC 73 74 6F 70
1011  85E0 2C 20 52 20
1011  85E4 2D 20 72 65
1011  85E8 73 74 61 72
1011  85EC 74 2C 20 31
1011  85F0 2D 32 20 2D
1011  85F4 20 46 6F 72
1011  85F8 6D 61 74 20
1011  85FC 28 70 74 32
1011  8600 2C 20 70 74
1011  8604 33 29 0D
1012  8607 53 70 20 2D  	db "Sp - Next, Break - exit",13,0
1012  860B 20 4E 65 78
1012  860F 74 2C 20 42
1012  8613 72 65 61 6B
1012  8617 20 2D 20 65
1012  861B 78 69 74 0D
1012  861F 00
1013  8620
1014  8620 00 00        total_track dw 0;
1015  8622 00 00        start_track dw 0;
1016  8624 70 74 32 00  format_pt2 db "pt2",0
1017  8628 70 74 33 00  format_pt3 db "pt3",0
1018  862C 20 74 73 00  format_ts db " ts",0
1019  8630 74 66 63 00  format_tfc db "tfc",0
1020  8634
1021  8634 00           player_setup db 0;настройки плеера
1022  8635
1023  8635              ;запрос списка
1024  8635 52 65 71 75  requestbuffer_title db "Request:",13
1024  8639 65 73 74 3A
1024  863D 0D
1025  863E              requestbuffer ;
1026  863E 47 45 54 20  	db "GET /api/export:zxMusic/limit:1/start:"
1026  8642 2F 61 70 69
1026  8646 2F 65 78 70
1026  864A 6F 72 74 3A
1026  864E 7A 78 4D 75
1026  8652 73 69 63 2F
1026  8656 6C 69 6D 69
1026  865A 74 3A 31 2F
1026  865E 73 74 61 72
1026  8662 74 3A
1027  8664              start_request ;тут подстановка порядкового номера трека
1028  8664 30 30 30 30  	db "00000/filter:zxMusicFormat="
1028  8668 30 2F 66 69
1028  866C 6C 74 65 72
1028  8670 3A 7A 78 4D
1028  8674 75 73 69 63
1028  8678 46 6F 72 6D
1028  867C 61 74 3D
1029  867F              request_format
1030  867F 70 74 33 2F  	db "pt3/order:date,desc HTTP/1.1\r\n"
1030  8683 6F 72 64 65
1030  8687 72 3A 64 61
1030  868B 74 65 2C 64
1030  868F 65 73 63 20
1030  8693 48 54 54 50
1030  8697 2F 31 2E 31
1030  869B 0D 0A
1031  869D              ;request_agent
1032  869D 48 6F 73 74  	db "Host: zxart.ee\r\n"
1032  86A1 3A 20 7A 78
1032  86A5 61 72 74 2E
1032  86A9 65 65 0D 0A
1033  86AD 55 73 65 72  	db "User-Agent: User-Agent: Mozilla/4.0 (compatible; MSIE5.01; GMX OS)\r\n\r\n",0
1033  86B1 2D 41 67 65
1033  86B5 6E 74 3A 20
1033  86B9 55 73 65 72
1033  86BD 2D 41 67 65
1033  86C1 6E 74 3A 20
1033  86C5 4D 6F 7A 69
1033  86C9 6C 6C 61 2F
1033  86CD 34 2E 30 20
1033  86D1 28 63 6F 6D
1033  86D5 70 61 74 69
1033  86D9 62 6C 65 3B
1033  86DD 20 4D 53 49
1033  86E1 45 35 2E 30
1033  86E5 31 3B 20 47
1033  86E9 4D 58 20 4F
1033  86ED 53 29 0D 0A
1033  86F1 0D 0A 00
1034  86F4
1035  86F4              ;запрос закачки
1036  86F4 52 65 71 75  requestbuffer2_title db "Request:",13
1036  86F8 65 73 74 3A
1036  86FC 0D
1037  86FD              requestbuffer2 ;
1038  86FD 47 45 54 20  	db "GET /file/id:"
1038  8701 2F 66 69 6C
1038  8705 65 2F 69 64
1038  8709 3A
1039  870A              requestbuffer2_file_id ;тут подстановка id трека
1040  870A              	;db "539319"
1041  870A 00 00 00...  	ds #100 ;буфер для отправки
1042  880A              requestbuffer2_end ;окончание строки запроса
1043  880A 20 48 54 54  	db " HTTP/1.1\r\n"
1043  880E 50 2F 31 2E
1043  8812 31 0D 0A
1044  8815              ;request_agent
1045  8815 48 6F 73 74  	db "Host: zxart.ee\r\n"
1045  8819 3A 20 7A 78
1045  881D 61 72 74 2E
1045  8821 65 65 0D 0A
1046  8825 55 73 65 72  	db "User-Agent: User-Agent: Mozilla/4.0 (compatible; MSIE5.01; GMX OS)\r\n\r\n",0
1046  8829 2D 41 67 65
1046  882D 6E 74 3A 20
1046  8831 55 73 65 72
1046  8835 2D 41 67 65
1046  8839 6E 74 3A 20
1046  883D 4D 6F 7A 69
1046  8841 6C 6C 61 2F
1046  8845 34 2E 30 20
1046  8849 28 63 6F 6D
1046  884D 70 61 74 69
1046  8851 62 6C 65 3B
1046  8855 20 4D 53 49
1046  8859 45 35 2E 30
1046  885D 31 3B 20 47
1046  8861 4D 58 20 4F
1046  8865 53 29 0D 0A
1046  8869 0D 0A 00
1047  886C
1048  886C
1049  886C              ;примеры (может не правильные)
1050  886C              	;db "http://zxart.ee/api/types:zxMusic/export:zxMusic/language:eng/start:0/limit:2/order:date,desc/filter:zxMusicAll=1;"
1051  886C              	;https://zxart.ee/api/types:zxMusic/export:zxMusic/language:eng/start:0/limit:2/order:date,desc/filter:zxMusicAll=1;
1052  886C
1053  886C              	;db "GET /file/id:44816",0
1054  886C              	;db "GET /api/export:zxMusic/limit:2/start:0/filter:zxMusicFormat=pt3/order:date,desc",0
1055  886C
1056  886C
1057  886C              ;requestbuffer_end
1058  886C
1059  886C              msg_title_radio
1060  886C 52 61 64 69  	db "Radio ver 2025.01.16",10,13,0
1060  8870 6F 20 76 65
1060  8874 72 20 32 30
1060  8878 32 35 2E 30
1060  887C 31 2E 31 36
1060  8880 0A 0D 00
1061  8883
1062  8883 52 65 73 70  outputBuffer_title db "Response:",13
1062  8887 6F 6E 73 65
1062  888B 3A 0D
1063  888D              outputBuffer equ $  ;буфер для загрузки
1064  888D
1065  888D              end_radio
1066  888D              	;SAVETRD "OS.TRD",|"radio.C",start_radio,$-start_radio
1067  888D              	savebin "radio.apg",start_radio,$-start_radio
# file closed: radio.asm
