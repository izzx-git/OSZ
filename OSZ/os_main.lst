# file opened: os_main.asm
   1  0000              ;OS GMX (izzx, 2024-2025)
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "os_defs.asm"
# file opened: os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 200+ 0000                  ; ld c,#14
 201+ 0000                  ; rst #20
 202+ 0000                  ; endm
 203+ 0000
 204+ 0000
 205+ 0000              ;плеер AY ----------------------------
 206+ 0000
 207+ 0000              ;инициализация плеера AY;
 208+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 209+ 0000 ~                ld c,#15
 210+ 0000 ~                rst #20
 211+ 0000                  endm
 212+ 0000
 213+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 214+ 0000                  macro OS_VTPL_PLAY ;()
 215+ 0000 ~                ld c,#16
 216+ 0000 ~                rst #20
 217+ 0000                  endm
 218+ 0000
 219+ 0000              ;заглушить плеер AY;
 220+ 0000                  macro OS_VTPL_MUTE ;()
 221+ 0000 ~                ld c,#17
 222+ 0000 ~                rst #20
 223+ 0000                  endm
 224+ 0000
 225+ 0000              ;получить значение переменной плеера;
 226+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 227+ 0000 ~                ld c,#18
 228+ 0000 ~                rst #20
 229+ 0000                  endm
 230+ 0000
 231+ 0000
 232+ 0000              ;прочие ------------------------------
 233+ 0000
 234+ 0000
 235+ 0000              ;скопировать данные из страницы в страницу
 236+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 237+ 0000                  macro OS_RAM_COPY
 238+ 0000 ~                ld c,#19
 239+ 0000 ~                rst #20
 240+ 0000                  endm
 241+ 0000
 242+ 0000              ;получить дополнительную страницу памяти;
 243+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 244+ 0000 ~                ld c,#1a
 245+ 0000 ~                rst #20
 246+ 0000                  endm
 247+ 0000
 248+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 249+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 250+ 0000 ~                ld c,#1b
 251+ 0000 ~                rst #20
 252+ 0000                  endm
 253+ 0000
 254+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 255+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 256+ 0000 ~                ld c,#1c
 257+ 0000 ~                rst #20
 258+ 0000                  endm
 259+ 0000
 260+ 0000              ;включить экран N;
 261+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 262+ 0000              ;переключать может только приложение в фокусе
 263+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 264+ 0000              ;при переключении процессов сохраняется только экран #39
 265+ 0000                  macro OS_SET_SCREEN ;
 266+ 0000 ~                ld c,#1d
 267+ 0000 ~                rst #20
 268+ 0000                  endm
 269+ 0000
 270+ 0000
 271+ 0000              ;получить номера страниц процесса;
 272+ 0000              ;вх:
 273+ 0000              ;вых: b, c - страницы в слотах 2, 3
 274+ 0000                  macro OS_GET_MAIN_PAGES ;
 275+ 0000 ~                ld c,#1e
 276+ 0000 ~                rst #20
 277+ 0000                  endm
 278+ 0000
 279+ 0000              ;получить значение системного таймера
 280+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 281+ 0000 ~                ld c,#1F
 282+ 0000 ~                rst #20
 283+ 0000                  endm
 284+ 0000
 285+ 0000
 286+ 0000
 287+ 0000                  ; macro OS_ ;
 288+ 0000                  ; ld c,#20
 289+ 0000                  ; rst #20
 290+ 0000                  ; endm
 291+ 0000
 292+ 0000
 293+ 0000              ;дисковые операции -------------------
 294+ 0000
 295+ 0000              ;открыть файл для чтения или записи
 296+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size)
 297+ 0000 ~                ld c,#21
 298+ 0000 ~                rst #20
 299+ 0000                  endm
 300+ 0000
 301+ 0000              ;создать файл
 302+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file)
 303+ 0000 ~                ld c,#22
 304+ 0000 ~                rst #20
 305+ 0000                  endm
 306+ 0000
 307+ 0000              ;прочитать из файла
 308+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
 309+ 0000 ~                ld c,#23
 310+ 0000 ~                rst #20
 311+ 0000                  endm
 312+ 0000
 313+ 0000              ;записать в файл
 314+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 315+ 0000 ~                ld c,#24
 316+ 0000 ~                rst #20
 317+ 0000                  endm
 318+ 0000
 319+ 0000              ;закрыть файл
 320+ 0000                  macro OS_FILE_CLOSE ;A - id file
 321+ 0000 ~                ld c,#25
 322+ 0000 ~                rst #20
 323+ 0000                  endm
 324+ 0000
 325+ 0000              ;чтение секторов текущего каталога
 326+ 0000              ; вх:
 327+ 0000                   ; hl - буфер для чтения
 328+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 329+ 0000                   ; b - максимальное количество секторов для чтения
 330+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 331+ 0000                     ; a=errRWnum
 332+ 0000                     ; a=errInvalidPart
 333+ 0000                     ; a=errFileEmpty
 334+ 0000                   ; cy=0, a=errEoF - каталог закончился
 335+ 0000                     ; hl - следующий адрес в буфере
 336+ 0000                     ; de - номер первого непрочитанного сектора
 337+ 0000                     ; b - не прочитано секторов
 338+ 0000                   ; cy=0 - считано успешно
 339+ 0000                     ; hl - следующий адрес в буфере
 340+ 0000                     ; de - номер первого непрочитанного сектора
 341+ 0000                     ; b=#00
 342+ 0000                  macro OS_READ_DIR ;
 343+ 0000 ~                ld c,#26
 344+ 0000 ~                rst #20
 345+ 0000                  endm
 346+ 0000
 347+ 0000              ;вход в каталог/выход в родительский каталог
 348+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 349+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 350+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 351+ 0000              	; переход в родительский, последнее имя в пути удалится).
 352+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 353+ 0000              	; добавится имя файла
 354+ 0000              ; вх:
 355+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 356+ 0000                   ; de - адрес дескриптора директории/файла
 357+ 0000              ; вых: a - если путь был указан, новая длина пути
 358+ 0000                  macro OS_OPEN_DIR ;
 359+ 0000 ~                ld c,#27
 360+ 0000 ~                rst #20
 361+ 0000                  endm
 362+ 0000
 363+ 0000
 364+ 0000                  ; macro OS_ ;
 365+ 0000                  ; ld c,#28
 366+ 0000                  ; rst #20
 367+ 0000                  ; endm
 368+ 0000
 369+ 0000                  ; macro OS_ ;
 370+ 0000                  ; ld c,#29
 371+ 0000                  ; rst #20
 372+ 0000                  ; endm
 373+ 0000
 374+ 0000
# file closed: os_defs.asm
   4  0000
   5  0000              ;sys - системный процесс для OS
   6  0000              	org PROGSTART
   7  8000              	;bank 1
   8  8000              start_sys
   9  8000 FB           	ei
  10  8001              	;halt ;ожидание старта после прерывания
  11  8001              	;halt
  12  8001 AF           	xor a
  13  8002 D3 FE        	out (254),a
  14  8004 21 19 35     	ld hl,msg_ver_os
  15  8007              	;печать приветствия
  16  8007 CD B1 09     	call drvgmx.printZ
  17  800A
  18  800A 11 00 18     	ld de,#1800 ;координаты yx
  19  800D              	OS_SET_XY
  19  800D 0E 01       >    ld c,#01
  19  800F E7          >    rst #20
  20  8010 21 B0 82     	ld hl,msg_press_num_to_close
  21  8013              	OS_PRINTZ
  21  8013 0E 09       >    ld c,#09
  21  8015 E7          >    rst #20
  22  8016
  23  8016              	;автозапуск приложений
  24  8016 11 00 17     	ld de,#1700 ;координаты yx
  25  8019              	OS_SET_XY
  25  8019 0E 01       >    ld c,#01
  25  801B E7          >    rst #20
  26  801C 21 03 83     	ld hl,sys_file_autorun_name ;имя списка
  27  801F CD 21 0C     	call Dos.fopen_r ;откроем файл для чтения
  28  8022 DC 96 0D     	call c,Dos.file_error_print_file_open_error
  29  8025 DA A4 80     	jp c,sys_loop
  30  8028 32 02 83     	ld (sys_file_autorun_id_tmp),a ;запомнить id
  31  802B
  32  802B              	;проверка длины файла не больше #4000
  33  802B 7A           	ld	a,d ;самые старшие байты длины
  34  802C B3           	or e
  35  802D 28 09        	jr z,sys_file_size_ok ;если не слищком большой
  36  802F              sys_file_too_big
  37  802F 21 65 0F     	ld hl,Dos.msg_file_too_big
  38  8032 CD B1 09     	call drvgmx.printZ
  39  8035 C3 A4 80     	jp sys_loop
  40  8038
  41  8038
  42  8038              sys_file_size_ok
  43  8038 78           	ld	a,b ;младший старший байт длины
  44  8039 FE 41        	cp #40+1
  45  803B 30 F2        	jr nc,sys_file_too_big
  46  803D              	;размер нормальный, прочитаем
  47  803D ED 43 0F 83  	ld (sys_file_autorun_lenght),bc
  48  8041 21 00 C0     	ld hl,#c000
  49  8044 3A 02 83     	ld a,(sys_file_autorun_id_tmp)
  50  8047 50           	ld d,b ;размер
  51  8048 59           	ld e,c
  52  8049 CD E0 0D     	call Dos.fread
  53  804C 30 0B        	jr nc,sys_file_size_ok2
  54  804E              	;если ошибка
  55  804E CD 9E 0D     	call Dos.file_error_print_file_read_error
  56  8051 3A 02 83     	ld a,(sys_file_autorun_id_tmp)
  57  8054 CD A6 0D     	call Dos.fclose ;закрыть файл
  58  8057 18 4B        	jr sys_loop
  59  8059              sys_file_size_ok2
  60  8059 3A 02 83     	ld a,(sys_file_autorun_id_tmp)
  61  805C CD A6 0D     	call Dos.fclose ;закрыть файл
  62  805F
  63  805F
  64  805F              	;анализ файла
  65  805F 21 00 C0     	ld hl,#c000
  66  8062 ED 4B 0F 83  	ld bc,(sys_file_autorun_lenght) ;цикл
  67  8066              sys_file_autorun_cl
  68  8066 C5           	push bc
  69  8067 7E           	ld a,(hl)
  70  8068 FE 20        	cp " "
  71  806A 38 2C        	jr c,sys_file_autorun_next
  72  806C
  73  806C              	;тут нашли первое имя
  74  806C E5           	push hl
  75  806D 21 12 83     	ld hl,sys_file_autorun_name_tmp ;почистить буфер
  76  8070 11 13 83     	ld de,sys_file_autorun_name_tmp+1
  77  8073 01 FF 00     	ld bc,256-1
  78  8076 36 00        	ld (hl),0
  79  8078 ED B0        	ldir
  80  807A
  81  807A E1           	pop hl
  82  807B 11 12 83     	ld de,sys_file_autorun_name_tmp ;куда
  83  807E 01 00 00     	ld bc,#0000 ;макс длина 255
  84  8081              	;ld ixl,0 ;счётчик
  85  8081              sys_file_autorun_cl2
  86  8081 7E           	ld a,(hl)
  87  8082 FE 20        	cp " "
  88  8084 38 04        	jr c,sys_file_autorun_cl2_ex
  89  8086 ED A0        	ldi
  90  8088 10 F7        	djnz sys_file_autorun_cl2
  91  808A
  92  808A              sys_file_autorun_cl2_ex
  93  808A              	;запустим
  94  808A E5           	push hl
  95  808B 21 12 83     	ld hl,sys_file_autorun_name_tmp		;строка с именем
  96  808E CD D8 02     	call proc_run
  97  8091 DD 7E 00     	ld a,(ix)
  98  8094 32 11 83     	ld (sys_file_autorun_focus),a ;запомнить последний
  99  8097 E1           	pop hl
 100  8098              	;тут надо бы уменьщить счётчик bc на длину имени
 101  8098              sys_file_autorun_next
 102  8098 23           	inc hl
 103  8099 C1           	pop bc
 104  809A 0B           	dec bc
 105  809B 78           	ld a,b
 106  809C B1           	or c
 107  809D 20 C7        	jr nz, sys_file_autorun_cl
 108  809F
 109  809F 3E 01        	ld a,1
 110  80A1              	;ld a,(sys_file_autorun_focus)
 111  80A1 CD 37 02     	call proc_set_focus ;на передний план
 112  80A4
 113  80A4
 114  80A4              	;jr file_load_ok
 115  80A4              	;call proc_run_cmd ;запустить консоль
 116  80A4              	;call proc_run_cmd ;запустить консоль
 117  80A4              	; call proc_run_cmd ;запустить консоль
 118  80A4              	; call proc_run_cmd ;запустить консоль
 119  80A4              	; call proc_run_cmd ;запустить консоль
 120  80A4              	;call proc_run_cmd ;запустить консоль
 121  80A4              	;call proc_run_cmd ;запустить консоль
 122  80A4
 123  80A4              	; ld hl,proc_name_net		;строка с именем
 124  80A4              	; call proc_run ;запуск
 125  80A4
 126  80A4              	; ld hl,proc_name_01		;строка с именем
 127  80A4              	; call proc_run
 128  80A4
 129  80A4              	; ld hl,proc_name_02		;строка с именем
 130  80A4              	; call proc_run
 131  80A4
 132  80A4              	; ld hl,proc_name_03		;строка с именем
 133  80A4              	; call proc_run
 134  80A4              	; ld a,(ix)
 135  80A4              	; call proc_set_focus ;на передний план
 136  80A4
 137  80A4              sys_loop
 138  80A4              	;OS_WAIT ;для системного процесса не рекомендуется
 139  80A4 76           	halt
 140  80A5 CD 62 82     	call print_active ;индикатор
 141  80A8
 142  80A8              	OS_GET_CHAR
 142  80A8 0E 10       >    ld c,#10
 142  80AA E7          >    rst #20
 143  80AB
 144  80AB              	;печать кода нажатой клавиши
 145  80AB              	;ld a,(key_cur)
 146  80AB FE FF        	cp 255
 147  80AD 28 14        	jr z,sys_loop_skip_print_char
 148  80AF F5           	push af
 149  80B0 6F           	ld l,a
 150  80B1 26 00        	ld h,0
 151  80B3 CD D0 05     	call toDecimal
 152  80B6 11 4C 18     	ld de,#184c ;координаты yx
 153  80B9              	OS_SET_XY
 153  80B9 0E 01       >    ld c,#01
 153  80BB E7          >    rst #20
 154  80BC 21 28 06     	ld hl,decimalS+2
 155  80BF CD B1 09     	call drvgmx.printZ
 156  80C2 F1           	pop af
 157  80C3              	;-------
 158  80C3              sys_loop_skip_print_char
 159  80C3 FE 16        	cp 22 ;кнопка выхода в монитор
 160  80C5 CA 6C 81     	jp z,call_monitor
 161  80C8 FE 13        	cp 19 ;кнопка запуска NC
 162  80CA CA 5A 81     	jp z,run_nc
 163  80CD FE 32        	cp "2" ;кнопки от 2 до 9
 164  80CF 38 0C        	jr c,sys_loop_skip
 165  80D1 FE 39        	cp "9"
 166  80D3 30 08        	jr nc,sys_loop_skip
 167  80D5              	;здесь надо закрыть процесс
 168  80D5 D6 30        	sub "0"
 169  80D7 CD 56 06     	call proc_close_skip
 170  80DA
 171  80DA              sys_loop_skip2
 172  80DA CD 50 81     	call release_key
 173  80DD
 174  80DD
 175  80DD              sys_loop_skip
 176  80DD 3A 10 2B     	ld a,(key_proc_switch_flag) ;если нажали переключение фокуса
 177  80E0 B7           	or a
 178  80E1 28 0C        	jr z,sys_loop_skip_key_focus
 179  80E3 CD 26 02     	call proc_focus_next
 180  80E6 CD 50 81     	call release_key
 181  80E9 AF           	xor a
 182  80EA 32 10 2B     	ld (key_proc_switch_flag),a
 183  80ED 18 56        	jr sys_loop_skip_key
 184  80EF
 185  80EF              sys_loop_skip_key_focus
 186  80EF 3A 12 2B     	ld a,(key_caps_lock_switch_flag) ;если нажали caps_lock
 187  80F2 B7           	or a
 188  80F3 28 10        	jr z,sys_loop_skip_key_caps_lock
 189  80F5 2A 15 2B     	ld hl,(FlgScanKeys_addr)
 190  80F8 3E 02        	ld a,%00000010	;?1,=1/0 CapsLock on/off
 191  80FA AE           	xor (hl)
 192  80FB 77           	ld (hl),a
 193  80FC CD 50 81     	call release_key
 194  80FF AF           	xor a
 195  8100 32 12 2B     	ld (key_caps_lock_switch_flag),a
 196  8103 18 40        	jr sys_loop_skip_key
 197  8105
 198  8105              sys_loop_skip_key_caps_lock
 199  8105 3A 11 2B     	ld a,(key_lang_flag) ;если нажали rus_lat
 200  8108 B7           	or a
 201  8109 28 10        	jr z,sys_loop_skip_key_rus_lat
 202  810B 2A 15 2B     	ld hl,(FlgScanKeys_addr)
 203  810E 3E 08        	ld a,%00001000	;3,=1/0 Rus/Lat
 204  8110 AE           	xor (hl) ;флаг FlgScanKeys
 205  8111 77           	ld (hl),a
 206  8112 CD 50 81     	call release_key
 207  8115 AF           	xor a
 208  8116 32 11 2B     	ld (key_lang_flag),a
 209  8119 18 2A        	jr sys_loop_skip_key
 210  811B
 211  811B              sys_loop_skip_key_rus_lat
 212  811B 3A 13 2B     	ld a,(key_graph_flag) ;если нажали graph
 213  811E B7           	or a
 214  811F 28 10        	jr z,sys_loop_skip_key_graph
 215  8121 2A 15 2B     	ld hl,(FlgScanKeys_addr)
 216  8124 3E 04        	ld a,%00000100	;2,=1/0 Grf on/off
 217  8126 AE           	xor (hl)
 218  8127 77           	ld (hl),a
 219  8128 CD 50 81     	call release_key
 220  812B AF           	xor a
 221  812C 32 13 2B     	ld (key_graph_flag),a
 222  812F 18 14        	jr sys_loop_skip_key
 223  8131
 224  8131              sys_loop_skip_key_graph
 225  8131 3A 14 2B     	ld a,(key_sys_focus) ;если нажали EXT+1
 226  8134 B7           	or a
 227  8135 28 0E        	jr z,sys_loop_skip_key_sys_focus
 228  8137              	;фокус на системный процесс
 229  8137 3E 01        	ld a,1
 230  8139 CD 37 02     	call proc_set_focus
 231  813C CD 50 81     	call release_key
 232  813F AF           	xor a
 233  8140 32 14 2B     	ld (key_sys_focus),a
 234  8143 18 00        	jr sys_loop_skip_key
 235  8145
 236  8145
 237  8145              sys_loop_skip_key_sys_focus
 238  8145
 239  8145              sys_loop_skip_key
 240  8145
 241  8145
 242  8145 3A 21 2B     	ld a,(sys_timer) ;иногда печатаем системную информацию
 243  8148 E6 0F        	and %00001111
 244  814A CC 87 81     	call z,sys_print_info
 245  814D              	; OS_GETCHAR ;получить нажатую клавишу
 246  814D              	; cp 255
 247  814D              	; jr z,sys_loop
 248  814D              	; OS_PRINT_CHARF ;печать символа
 249  814D
 250  814D
 251  814D
 252  814D C3 A4 80     	jp sys_loop
 253  8150
 254  8150
 255  8150
 256  8150
 257  8150              release_key ;ждать отпускания клавиши
 258  8150              	;OS_WAIT ;для системного процесса не рекомендуется
 259  8150 76           	halt
 260  8151              	;ld hl,(FlgScanKeys_addr)
 261  8151              	;ждать пока отпустят все клавиши
 262  8151 AF           WAITKEY	XOR A
 262  8152 DB FE         IN A,(#FE)
 262  8154 2F            CPL
 262  8155 E6 1F         AND #1F
 262  8157 20 F8         JR nz,WAITKEY
 263  8159              	;bit 6,(hl)
 264  8159              	;jr z,release_key
 265  8159 C9           	ret
 266  815A
 267  815A              run_nc
 268  815A 21 84 82     	ld hl,proc_name_nc		;строка с именем
 269  815D CD D8 02     	call proc_run
 270  8160 DA DA 80     	jp c,sys_loop_skip2
 271  8163 DD 7E 00     	ld a,(ix)
 272  8166 CD 37 02     	call proc_set_focus ;на передний план
 273  8169 C3 DA 80     	jp sys_loop_skip2
 274  816C
 275  816C              call_monitor	;вызов теневого монитора
 276  816C F3           	di
 277  816D ED 73 85 81  	ld (call_monitor_tmp_sp),sp
 278  8171 31 00 60     	ld sp,#6000 ;временный стек
 279  8174 CD 66 00     	call #66
 280  8177 ED 7B 85 81  	ld sp,(call_monitor_tmp_sp)
 281  817B
 282  817B 3A 16 0F     	ld a,(Dos.fs_fat_part_code_cur)
 283  817E CD 4E 0D     	call Dos.init_fs_fat_warm ;переинициализация FAT
 284  8181 FB           	ei
 285  8182 C3 DA 80     	jp sys_loop_skip2
 286  8185
 287  8185 00 00        call_monitor_tmp_sp dw 0 ;временно
 288  8187
 289  8187              ;печать информации
 290  8187              sys_print_info
 291  8187              	;инфо об открытых файлах
 292  8187              sys_print_info_files
 293  8187 21 05 11     	ld hl,Dos.fcb_fat_table
 294  818A 06 08        	ld b,Dos.files_fat_max
 295  818C 0E 00        	ld c,0 ;счётчик
 296  818E              sys_print_info_files_cl
 297  818E 7E           	ld a,(hl)
 298  818F B7           	or a
 299  8190 28 01        	jr z,sys_print_info_files_skip
 300  8192 0C           	inc c
 301  8193              sys_print_info_files_skip
 302  8193 10 F9        	djnz sys_print_info_files_cl
 303  8195
 304  8195 69           	ld l,c
 305  8196 26 00        	ld h,0
 306  8198 CD D0 05     	call toDecimal
 307  819B 11 00 0B     	ld de,#0b00 ;координаты yx
 308  819E              	OS_SET_XY
 308  819E 0E 01       >    ld c,#01
 308  81A0 E7          >    rst #20
 309  81A1 21 8B 82     	ld hl,msg_files
 310  81A4 CD B1 09     	call drvgmx.printZ
 311  81A7 21 29 06     	ld hl,decimalS+3
 312  81AA CD B1 09     	call drvgmx.printZ
 313  81AD
 314  81AD              	;печать информации о памяти и процессах
 315  81AD CD E4 81     	call get_proc_total ;печать и подсчёт процессов
 316  81B0 6F           	ld l,a
 317  81B1 26 00        	ld h,0
 318  81B3 CD D0 05     	call toDecimal
 319  81B6 11 00 0D     	ld de,#0d00 ;координаты yx
 320  81B9              	OS_SET_XY
 320  81B9 0E 01       >    ld c,#01
 320  81BB E7          >    rst #20
 321  81BC 21 93 82     	ld hl,msg_processes
 322  81BF CD B1 09     	call drvgmx.printZ
 323  81C2 21 29 06     	ld hl,decimalS+3
 324  81C5 CD B1 09     	call drvgmx.printZ
 325  81C8
 326  81C8 11 00 0C     	ld de,#0c00 ;координаты yx
 327  81CB              	OS_SET_XY
 327  81CB 0E 01       >    ld c,#01
 327  81CD E7          >    rst #20
 328  81CE 21 9F 82     	ld hl,msg_free_ram
 329  81D1 CD B1 09     	call drvgmx.printZ
 330  81D4 CD 51 82     	call get_free_ram ;памяти
 331  81D7 6F           	ld l,a
 332  81D8 26 00        	ld h,0
 333  81DA CD D0 05     	call toDecimal
 334  81DD 21 28 06     	ld hl,decimalS+2
 335  81E0 CD B1 09     	call drvgmx.printZ
 336  81E3 C9           	ret
 337  81E4
 338  81E4
 339  81E4
 340  81E4
 341  81E4              get_proc_total
 342  81E4              	;поиск и печать количества запущеных процессов
 343  81E4              	;вых: a - количество активных
 344  81E4 11 00 0E     	ld de,#0e00 ;координаты yx
 345  81E7              	OS_SET_XY
 345  81E7 0E 01       >    ld c,#01
 345  81E9 E7          >    rst #20
 346  81EA DD 21 00 2C  	ld ix,proc_table
 347  81EE 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 348  81F0 0E 00        	ld c,0 ;счётчик
 349  81F2              get_proc_total_cl
 350  81F2 DD 7E 00     	ld a,(ix)
 351  81F5 B7           	or a ;свободен?
 352  81F6 28 1F        	jr z,get_proc_total_cl1
 353  81F8
 354  81F8 C5           	push bc
 355  81F9 C6 30        	add '0' ;печать id
 356  81FB              	OS_PRINT_CHARF
 356  81FB D7          >	rst #10
 357  81FC 3E 20        	ld a," "
 358  81FE              	OS_PRINT_CHARF
 358  81FE D7          >	rst #10
 359  81FF DD 7E 01     	ld a,(ix+1)
 360  8202 C6 30        	add '0' ;печать id родительского
 361  8204              	OS_PRINT_CHARF
 361  8204 D7          >	rst #10
 362  8205 3E 20        	ld a," "
 363  8207              	OS_PRINT_CHARF
 363  8207 D7          >	rst #10
 364  8208
 365  8208 DD E5        	push ix
 366  820A E1           	pop hl
 367  820B 01 10 00     	ld bc,16
 368  820E 09           	add hl,bc
 369  820F              	OS_PRINTZ ;печать имени
 369  820F 0E 09       >    ld c,#09
 369  8211 E7          >    rst #20
 370  8212
 371  8212 3E 0D        	ld a,13
 372  8214              	OS_PRINT_CHARF
 372  8214 D7          >	rst #10
 373  8215
 374  8215 C1           	pop bc
 375  8216
 376  8216 0C           	inc c ;прибавить
 377  8217              get_proc_total_cl1
 378  8217 DD 24        	inc ixh
 379  8219 10 D7        	djnz get_proc_total_cl
 380  821B 79           	ld a,c
 381  821C 32 3F 82     	ld (get_proc_total_count),a
 382  821F
 383  821F              	;почистить пустые строки (надо оптимизировать по времени)
 384  821F 3E 08        	ld a,proc_max
 385  8221 91           	sub c ;сколько пустых стрк должно быть
 386  8222 28 17        	jr z,get_proc_total_ex
 387  8224 47           	ld b,a ;цикл
 388  8225 11 00 0E     	ld de,#0e00 ;координаты yx
 389  8228 79           	ld a,c
 390  8229 82           	add d
 391  822A 57           	ld d,a
 392  822B              get_proc_total_cl2
 393  822B D5           	push de
 394  822C C5           	push bc
 395  822D              	OS_SET_XY
 395  822D 0E 01       >    ld c,#01
 395  822F E7          >    rst #20
 396  8230 21 40 82     	ld hl,get_proc_total_clear
 397  8233              	OS_PRINTZ ;очистить
 397  8233 0E 09       >    ld c,#09
 397  8235 E7          >    rst #20
 398  8236 C1           	pop bc
 399  8237 D1           	pop de
 400  8238 14           	inc d
 401  8239 10 F0        	djnz get_proc_total_cl2
 402  823B
 403  823B              get_proc_total_ex
 404  823B 3A 3F 82     	ld a,(get_proc_total_count)
 405  823E C9           	ret
 406  823F 00           get_proc_total_count db 0 ;временно
 407  8240 20 20 20 20  get_proc_total_clear db "                ",0
 407  8244 20 20 20 20
 407  8248 20 20 20 20
 407  824C 20 20 20 20
 407  8250 00
 408  8251
 409  8251
 410  8251              get_free_ram
 411  8251              	;поиск количества свободных страниц памяти
 412  8251              	;вых: a - количество свободных
 413  8251 21 00 34     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 414  8254 06 6D        	ld b,page_max ;всего страниц
 415  8256 0E 00        	ld c,0 ;счётчик
 416  8258              get_free_ram_cl
 417  8258 7E           	ld a,(hl)
 418  8259 B7           	or a ;свободен?
 419  825A 20 01        	jr nz,get_free_ram_cl1
 420  825C 0C           	inc c ;прибавить
 421  825D              get_free_ram_cl1
 422  825D 23           	inc hl
 423  825E 10 F8        	djnz get_free_ram_cl
 424  8260 79           	ld a,c
 425  8261 C9           	ret
 426  8262
 427  8262
 428  8262
 429  8262              print_active ;значёк активности
 430  8262 11 00 0A     	ld de,#0a00 ;координаты yx
 431  8265              	OS_SET_XY
 431  8265 0E 01       >    ld c,#01
 431  8267 E7          >    rst #20
 432  8268 21 F4 82     	ld hl,msg_active
 433  826B              	OS_PRINTZ
 433  826B 0E 09       >    ld c,#09
 433  826D E7          >    rst #20
 434  826E 3A 01 83     	ld a,(msg_active_cur)
 435  8271 3C           	inc a
 436  8272 FE 04        	cp 4
 437  8274 38 01        	jr c,print_active1
 438  8276 AF           	xor a
 439  8277              print_active1
 440  8277 32 01 83     	ld (msg_active_cur),a
 441  827A 4F           	ld c,a
 442  827B 06 00        	ld b,0
 443  827D 21 FC 82     	ld hl,msg_active1
 444  8280 09           	add hl,bc
 445  8281 7E           	ld a,(hl)
 446  8282              	OS_PRINT_CHARF
 446  8282 D7          >	rst #10
 447  8283 C9           	ret
 448  8284
 449  8284
 450  8284
 451  8284
 452  8284
 453  8284
 454  8284 6E 63 2E 61  proc_name_nc db "nc.apg",0
 454  8288 70 67 00
 455  828B
 456  828B              msg_files
 457  828B 46 69 6C 65  	db "Files: ",0
 457  828F 73 3A 20 00
 458  8293              msg_processes
 459  8293 50 72 6F 63  	db "Processes: ",0
 459  8297 65 73 73 65
 459  829B 73 3A 20 00
 460  829F              msg_free_ram
 461  829F 46 72 65 65  	db "Free pages RAM: ",0
 461  82A3 20 70 61 67
 461  82A7 65 73 20 52
 461  82AB 41 4D 3A 20
 461  82AF 00
 462  82B0              msg_press_num_to_close
 463  82B0 53 53 2B 45  	db "SS+Enter - switch. 2-8 - close process. Ext+0 - Monitor. Ext+9 - NC",0
 463  82B4 6E 74 65 72
 463  82B8 20 2D 20 73
 463  82BC 77 69 74 63
 463  82C0 68 2E 20 32
 463  82C4 2D 38 20 2D
 463  82C8 20 63 6C 6F
 463  82CC 73 65 20 70
 463  82D0 72 6F 63 65
 463  82D4 73 73 2E 20
 463  82D8 45 78 74 2B
 463  82DC 30 20 2D 20
 463  82E0 4D 6F 6E 69
 463  82E4 74 6F 72 2E
 463  82E8 20 45 78 74
 463  82EC 2B 39 20 2D
 463  82F0 20 4E 43 00
 464  82F4 41 63 74 69  msg_active db "Active ",0
 464  82F8 76 65 20 00
 465  82FC 7C 2F 2D 5C  msg_active1 db "|/-\\",0
 465  8300 00
 466  8301 00           msg_active_cur db 0 ;текущий значёк активности
 467  8302
 468  8302 00           sys_file_autorun_id_tmp db 0 ;временно
 469  8303 61 75 74 6F  sys_file_autorun_name	db "autorun.txt",0
 469  8307 72 75 6E 2E
 469  830B 74 78 74 00
 470  830F 00 00        sys_file_autorun_lenght dw 0 ;временно
 471  8311 00           sys_file_autorun_focus db 0 ;временно
 472  8312 00 00 00...  sys_file_autorun_name_tmp ds 256
 473  8412
 474  8412
 475  8412              end_sys
 476  8412              	savebin "sys.osg",start_sys,$-start_sys
 477  8412              ;------------------------------------------------------------------------
 478  8412
 479  8412
 480  8412
 481  8412
 482  8412
 483  8412
 484  8412
 485  8412
 486  8412
 487  8412
 488  8412
 489  8412
 490  8412
 491  8412
 492  8412
 493  8412
 494  8412
 495  8412
 496  8412
 497  8412
 498  8412
 499  8412
 500  8412
 501  8412
 502  8412
 503  8412              ;sys - сетевой процесс для OS
 504  8412              	org PROGSTART
 505  8000              start_net
 506  8000
 507  8000 21 1B 85     	ld hl,msg_ver_net
 508  8003              	;печать приветствия
 509  8003 CD B1 09     	call drvgmx.printZ
 510  8006
 511  8006              ;uart #EF (wifi)
 512  8006 AF           	xor a
 513  8007 32 02 2B     	ld (uart_enable),a ;флаг порт отсутствует
 514  800A              	; ld a,1
 515  800A              	; ld (esp_link_id_table),a ;временно занять порт
 516  800A CD CA 81     	call Uart.check
 517  800D FE FF        	cp 255
 518  800F              	;jr z,init_uart_no ;отключить проверку можно тут
 519  800F              	;нашли uart
 520  800F 3E 01        	ld a,1
 521  8011 32 02 2B     	ld (uart_enable),a ;порт есть
 522  8014 21 C8 34     	ld hl,msg_init_uart_found
 523  8017 CD B1 09     	call drvgmx.printZ
 524  801A CD 3B 82     	call Wifi.init
 525  801D 18 06        	jr init_uart_yes
 526  801F              init_uart_no
 527  801F              	;печать
 528  801F 21 D9 34     	ld hl,msg_init_uart_not_found
 529  8022 CD B1 09     	call drvgmx.printZ
 530  8025              init_uart_yes
 531  8025
 532  8025
 533  8025              net_loop
 534  8025              	OS_WAIT
 534  8025 DF          >	rst #18
 535  8026 CD 9A 81     	call print_active_net ;индикатор
 536  8029 CD 3C 80     	call esp_check_open ;проверить соединения
 537  802C CD A2 80     	call esp_check_send ;проверить пакеты на отправку
 538  802F CD C5 80     	call esp_check_get ;проверить пакеты на приём
 539  8032 3A 21 2B     	ld a,(sys_timer) ;иногда печатаем сетевую информацию
 540  8035 E6 0E        	and %00001110
 541  8037 CC 1C 81     	call z,print_esp_link
 542  803A
 543  803A 18 E9        	jr net_loop
 544  803C
 545  803C
 546  803C              esp_check_open ;проверка очереди соединений ESP
 547  803C DD 21 80 34  	ld ix,esp_link_id_table ;
 548  8040              	;push bc
 549  8040 DD 7E 01     	ld a,(ix+1)
 550  8043 B7           	or a ;запрос есть?
 551  8044 C8           	ret z
 552  8045              	;есть запрос
 553  8045
 554  8045 DD 7E 0E     	ld a,(ix+14) ;подставить тип соединения
 555  8048 B7           	or a
 556  8049 20 11        	jr nz,esp_check_open_type1
 557  804B 3E 54        	ld a,'T'
 558  804D 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 559  8050 3E 43        	ld a,'C'
 560  8052 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 561  8055 3E 50        	ld a,'P'
 562  8057 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 563  805A 18 2A        	jr esp_check_open_type_skip
 564  805C              esp_check_open_type1
 565  805C FE 01        	cp 1
 566  805E 20 11        	jr nz,esp_check_open_type2
 567  8060 3E 55        	ld a,'U'
 568  8062 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 569  8065 3E 44        	ld a,'D'
 570  8067 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 571  806A 3E 50        	ld a,'P'
 572  806C 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 573  806F 18 15        	jr esp_check_open_type_skip
 574  8071              esp_check_open_type2
 575  8071 FE 02        	cp 2
 576  8073 20 11        	jr nz,esp_check_open_type_skip
 577  8075 3E 53        	ld a,'S'
 578  8077 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 579  807A 3E 53        	ld a,'S'
 580  807C 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 581  807F 3E 4C        	ld a,'L'
 582  8081 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 583  8084 18 00        	jr esp_check_open_type_skip
 584  8086
 585  8086              esp_check_open_type_skip
 586  8086 11 BB 34     	ld de,esp_link_id_table+59 ;номер порта
 587  8089 21 8F 34     	ld hl,esp_link_id_table+15 ;;адрес сервера
 588  808C CD DD 82     	call Wifi.openTCP
 589  808F 30 04        	jr nc,esp_check_open_res
 590  8091 3E FF        	ld a,255 ;ошибка
 591  8093 18 05        	jr esp_check_open_err
 592  8095              esp_check_open_res
 593  8095              	;результат запишем
 594  8095 3A 3A 82     	ld a,(Wifi.closed)
 595  8098 EE 01        	xor 1
 596  809A              esp_check_open_err
 597  809A DD 77 02     	ld (ix+2),a ;поставить флаг результата открытия
 598  809D DD 36 01 00  	ld (ix+1),0 ;сбросить флаг запроса
 599  80A1 C9           	ret
 600  80A2
 601  80A2
 602  80A2
 603  80A2
 604  80A2
 605  80A2              esp_check_send ;проверить пакеты на отправку
 606  80A2 DD 21 80 34  	ld ix,esp_link_id_table ;
 607  80A6 DD 7E 03     	ld a,(ix+3)
 608  80A9 B7           	or a ;запрос есть?
 609  80AA C8           	ret z
 610  80AB              	;есть запрос
 611  80AB DD 5E 09     	ld e,(ix+9) ;длина данных
 612  80AE DD 56 0A     	ld d,(ix+10)
 613  80B1 21 2D 35     	ld hl,esp_buffer ;адрес
 614  80B4 CD 9E 83     	call Wifi.tcpSend
 615  80B7 3E 01        	ld a,1 ;успех
 616  80B9 30 02        	jr nc,esp_check_send_res
 617  80BB 3E FF        	ld a,255 ;ошибка
 618  80BD              esp_check_send_res
 619  80BD DD 77 04     	ld (ix+4),a ;поставить флаг результата отправки
 620  80C0 DD 36 03 00  	ld (ix+3),0 ;сбросить флаг запроса
 621  80C4 C9           	ret
 622  80C5
 623  80C5
 624  80C5
 625  80C5
 626  80C5
 627  80C5              esp_check_get ;проверить пакеты на приём
 628  80C5 DD 21 80 34  	ld ix,esp_link_id_table ;
 629  80C9 DD 7E 05     	ld a,(ix+5)
 630  80CC B7           	or a ;запрос есть?
 631  80CD C8           	ret z
 632  80CE              	;есть запрос
 633  80CE 21 00 00     	ld hl,0
 634  80D1 22 36 82     	ld (Wifi.bytes_avail), hl ;длину сбросим
 635  80D4 21 2D 35     	ld hl,esp_buffer ;адрес
 636  80D7 22 38 82     	ld (Wifi.buffer_pointer),hl ;
 637  80DA CD E0 83     	call Wifi.getPacket
 638  80DD 30 0A        	jr nc,esp_check_get_res
 639  80DF 3E FF        	ld a,255 ;ошибка
 640  80E1 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 641  80E4 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 642  80E8 C9           	ret
 643  80E9              esp_check_get_res
 644  80E9              	;если что-то принято
 645  80E9 ED 4B 36 82  	ld bc,(Wifi.bytes_avail) ;длина
 646  80ED DD 71 09     	ld (ix+9),c ;длина принятых
 647  80F0 DD 70 0A     	ld (ix+10),b
 648  80F3
 649  80F3 78           	ld a,b
 650  80F4 B1           	or c
 651  80F5 28 0F        	jr z,esp_check_get_skip_copy2 ;защита от нулевой длины
 652  80F7
 653  80F7 DD 5E 07     	ld e,(ix+7) ;адрес назначения
 654  80FA DD 56 08     	ld d,(ix+8)
 655  80FD DD 7E 00     	ld a,(ix) ;id назначения
 656  8100 21 2D 35     	ld hl,esp_buffer ;откуда
 657  8103 CD A6 05     	call esp_buffer_copy ;перекинем данные силами ядра
 658  8106
 659  8106              esp_check_get_skip_copy2
 660  8106 DD 21 80 34  	ld ix,esp_link_id_table ;
 661  810A 3A 3A 82     	ld a,(Wifi.closed)
 662  810D EE 01        	xor 1
 663  810F DD 77 02     	ld (ix+2),a ;поставить текущий флаг открытия
 664  8112 3E 01        	ld a,1 ;успех
 665  8114 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 666  8117 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 667  811B C9           	ret
 668  811C
 669  811C
 670  811C              print_esp_link
 671  811C 26 0B        	ld h,#0b
 672  811E 3E 20        	ld a," "
 673  8120              	OS_FILL_LINE ;почистить строку
 673  8120 0E 03       >    ld c,#03
 673  8122 E7          >    rst #20
 674  8123 DD 21 80 34  	ld ix,esp_link_id_table
 675  8127
 676  8127 11 00 0B     	ld de,#0b00 ;координаты yx
 677  812A              	OS_SET_XY
 677  812A 0E 01       >    ld c,#01
 677  812C E7          >    rst #20
 678  812D 21 00 85     	ld hl,msg_esp_link
 679  8130              	OS_PRINTZ
 679  8130 0E 09       >    ld c,#09
 679  8132 E7          >    rst #20
 680  8133 DD 7E 00     	ld a,(ix)
 681  8136 C6 30        	add '0'
 682  8138              	OS_PRINT_CHARF ;id
 682  8138 D7          >	rst #10
 683  8139 3E 20        	ld a," "
 684  813B              	OS_PRINT_CHARF
 684  813B D7          >	rst #10
 685  813C
 686  813C DD 7E 00     	ld a,(ix)
 687  813F B7           	or a
 688  8140 C8           	ret z ;если нет соединений
 689  8141
 690  8141 21 09 85     	ld hl,msg_esp_transmit
 691  8144              	OS_PRINTZ
 691  8144 0E 09       >    ld c,#09
 691  8146 E7          >    rst #20
 692  8147 DD 7E 04     	ld a,(ix+4)
 693  814A B7           	or a
 694  814B 28 1C        	jr z,print_esp_link2
 695  814D DD 7E 05     	ld a,(ix+5) ;при этом не начался приём
 696  8150 4F           	ld c,a
 697  8151 DD 7E 06     	ld a,(ix+6)
 698  8154 B1           	or c
 699  8155 20 12        	jr nz,print_esp_link2
 700  8157 DD 6E 09     	ld l,(ix+9)
 701  815A DD 66 0A     	ld h,(ix+10)
 702  815D CD D0 05     	call toDecimal
 703  8160 21 26 06     	ld hl,decimalS
 704  8163              	OS_PRINTZ	;отправлено
 704  8163 0E 09       >    ld c,#09
 704  8165 E7          >    rst #20
 705  8166 3E 20        	ld a," "
 706  8168              	OS_PRINT_CHARF
 706  8168 D7          >	rst #10
 707  8169              print_esp_link2
 708  8169
 709  8169 21 0F 85     	ld hl,msg_esp_receive
 710  816C              	OS_PRINTZ
 710  816C 0E 09       >    ld c,#09
 710  816E E7          >    rst #20
 711  816F DD 7E 06     	ld a,(ix+6)
 712  8172 B7           	or a
 713  8173 28 12        	jr z,print_esp_link3
 714  8175 DD 6E 09     	ld l,(ix+9)
 715  8178 DD 66 0A     	ld h,(ix+10)
 716  817B CD D0 05     	call toDecimal
 717  817E 21 26 06     	ld hl,decimalS
 718  8181              	OS_PRINTZ	;принято
 718  8181 0E 09       >    ld c,#09
 718  8183 E7          >    rst #20
 719  8184 3E 20        	ld a," "
 720  8186              	OS_PRINT_CHARF
 720  8186 D7          >	rst #10
 721  8187              print_esp_link3
 722  8187
 723  8187 21 15 85     	ld hl,msg_esp_address
 724  818A              	OS_PRINTZ
 724  818A 0E 09       >    ld c,#09
 724  818C E7          >    rst #20
 725  818D DD 7E 02     	ld a,(ix+2) ;соединение установлено
 726  8190 B7           	or a
 727  8191 28 06        	jr z,print_esp_link4
 728  8193 21 8F 34     	ld hl,esp_link_id_table+15 ;сервер
 729  8196              	OS_PRINTZ
 729  8196 0E 09       >    ld c,#09
 729  8198 E7          >    rst #20
 730  8199              print_esp_link4
 731  8199 C9           	ret
 732  819A
 733  819A
 734  819A
 735  819A
 736  819A              print_active_net ;значёк активности
 737  819A 11 00 0A     	ld de,#0a00 ;координаты yx
 738  819D              	OS_SET_XY
 738  819D 0E 01       >    ld c,#01
 738  819F E7          >    rst #20
 739  81A0 21 BC 81     	ld hl,msg_active_net
 740  81A3              	OS_PRINTZ
 740  81A3 0E 09       >    ld c,#09
 740  81A5 E7          >    rst #20
 741  81A6 3A C9 81     	ld a,(msg_active_net_cur)
 742  81A9 3C           	inc a
 743  81AA FE 04        	cp 4
 744  81AC 38 01        	jr c,print_active_net1
 745  81AE AF           	xor a
 746  81AF              print_active_net1
 747  81AF 32 C9 81     	ld (msg_active_net_cur),a
 748  81B2 4F           	ld c,a
 749  81B3 06 00        	ld b,0
 750  81B5 21 C4 81     	ld hl,msg_active_net1
 751  81B8 09           	add hl,bc
 752  81B9 7E           	ld a,(hl)
 753  81BA              	OS_PRINT_CHARF
 753  81BA D7          >	rst #10
 754  81BB C9           	ret
 755  81BC
 756  81BC
 757  81BC
 758  81BC
 759  81BC
 760  81BC
 761  81BC 41 63 74 69  msg_active_net db "Active ",0
 761  81C0 76 65 20 00
 762  81C4 7C 2F 2D 5C  msg_active_net1 db "|/-\\",0
 762  81C8 00
 763  81C9 00           msg_active_net_cur db 0 ;текущий значёк активности
 764  81CA
 765  81CA              	include Drv/zx-wifi.asm ;драйвер сетевой карты ESP
# file opened: Drv/zx-wifi.asm
   1+ 81CA              ; This driver works with 16c550 uart that's support AFE
   2+ 81CA                  module Uart
   3+ 81CA              ; Make init shorter and readable:-)
   4+ 81CA                  macro outp port, value
   5+ 81CA ~            	ld b, port
   6+ 81CA ~            	ld c, #EF
   7+ 81CA ~                ld a, value
   8+ 81CA ~                out (c), a
   9+ 81CA                  endm
  10+ 81CA
  11+ 81CA              ; Internal port constants
  12+ 81CA              RBR_THR = #F8
  13+ 81CA              IER     = RBR_THR + 1
  14+ 81CA              IIR_FCR = RBR_THR + 2
  15+ 81CA              LCR     = RBR_THR + 3
  16+ 81CA              MCR     = RBR_THR + 4
  17+ 81CA              LSR     = RBR_THR + 5
  18+ 81CA              MSR     = RBR_THR + 6
  19+ 81CA              SR      = RBR_THR + 7
  20+ 81CA
  21+ 81CA
  22+ 81CA              ;out: a=255 - no UART
  23+ 81CA              check: ;проверка есть ли карта
  24+ 81CA 3E F8        	ld a, RBR_THR
  25+ 81CC DB FE            in a, (#fe)
  26+ 81CE FE FF        	cp #ff
  27+ 81D0 C0           	ret nz ;если читает 255, то нет карты
  28+ 81D1 3E F8        	ld a, RBR_THR
  29+ 81D3 DB FE            in a, (#fe) ;второй раз для надёжности
  30+ 81D5 FE FF        	cp #ff
  31+ 81D7 C9           	ret
  32+ 81D8
  33+ 81D8
  34+ 81D8              init:
  35+ 81D8                  outp MCR,     #0d  // Assert RTS
  35+ 81D8 06 FC       >	ld b, MCR
  35+ 81DA 0E EF       >	ld c, #EF
  35+ 81DC 3E 0D       >    ld a, #0d
  35+ 81DE ED 79       >    out (c), a
  36+ 81E0                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  36+ 81E0 06 FA       >	ld b, IIR_FCR
  36+ 81E2 0E EF       >	ld c, #EF
  36+ 81E4 3E 87       >    ld a, #87
  36+ 81E6 ED 79       >    out (c), a
  37+ 81E8                  outp LCR,     #83  // 8n1, DLAB=1
  37+ 81E8 06 FB       >	ld b, LCR
  37+ 81EA 0E EF       >	ld c, #EF
  37+ 81EC 3E 83       >    ld a, #83
  37+ 81EE ED 79       >    out (c), a
  38+ 81F0                  outp RBR_THR, #01  // 115200 (divider 1)
  38+ 81F0 06 F8       >	ld b, RBR_THR
  38+ 81F2 0E EF       >	ld c, #EF
  38+ 81F4 3E 01       >    ld a, #01
  38+ 81F6 ED 79       >    out (c), a
  39+ 81F8                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  39+ 81F8 06 F9       >	ld b, IER
  39+ 81FA 0E EF       >	ld c, #EF
  39+ 81FC 3E 00       >    ld a, #00
  39+ 81FE ED 79       >    out (c), a
  40+ 8200
  41+ 8200                  outp LCR,     #03 // 8n1, DLAB=0
  41+ 8200 06 FB       >	ld b, LCR
  41+ 8202 0E EF       >	ld c, #EF
  41+ 8204 3E 03       >    ld a, #03
  41+ 8206 ED 79       >    out (c), a
  42+ 8208                  outp IER,     #00 // Disable int
  42+ 8208 06 F9       >	ld b, IER
  42+ 820A 0E EF       >	ld c, #EF
  42+ 820C 3E 00       >    ld a, #00
  42+ 820E ED 79       >    out (c), a
  43+ 8210                  outp MCR,     #2f // Enable AFE
  43+ 8210 06 FC       >	ld b, MCR
  43+ 8212 0E EF       >	ld c, #EF
  43+ 8214 3E 2F       >    ld a, #2f
  43+ 8216 ED 79       >    out (c), a
  44+ 8218 C9               ret
  45+ 8219
  46+ 8219              ;retry_rec_count_max equ %00011111 ;ждать столько прерываний
  47+ 8219
  48+ 8219              ; Flag C <- Data available
  49+ 8219              ; isAvailable:
  50+ 8219                  ; ld a, LSR
  51+ 8219                  ; in a, (#EF)
  52+ 8219                  ; rrca
  53+ 8219                  ; ret
  54+ 8219
  55+ 8219              ; Non-blocking read
  56+ 8219              ; Flag C <- is byte was readen
  57+ 8219              ; A <- byte
  58+ 8219              ; read1:
  59+ 8219                  ; ld a, LSR
  60+ 8219                  ; in a, (#EF)
  61+ 8219                  ; rrca
  62+ 8219                  ; ret nc
  63+ 8219                  ; ld a, RBR_THR
  64+ 8219                  ; in a, (#EF)
  65+ 8219                  ; scf
  66+ 8219                  ; ret
  67+ 8219
  68+ 8219              ; Tries read byte with timeout
  69+ 8219              ; Flag C <- is byte read
  70+ 8219              ; A <- byte
  71+ 8219              read:
  72+ 8219              	;xor a ;4
  73+ 8219              	;ld (#5C78),a ;обнулить счётчик ожидания ;13
  74+ 8219              .wait
  75+ 8219 3E FD            ld a, LSR
  76+ 821B DB EF            in a, (#EF)
  77+ 821D 0F               rrca
  78+ 821E 30 F9        	jr nc, .wait
  79+ 8220 3E F8            ld a, RBR_THR
  80+ 8222 DB EF            in a, (#EF)
  81+ 8224 C9           	ret
  82+ 8225              ; .readW
  83+ 8225              	; OS_GETTIMER
  84+ 8225              	; ld a,e
  85+ 8225              	; and retry_rec_count_max
  86+ 8225              	; ;ld a,(#5C78)
  87+ 8225              	; ;cp retry_rec_count_max
  88+ 8225              	; jr nz, .wait ;ещё попытка
  89+ 8225              	; xor a ;выключим флаг переноса если время вышло
  90+ 8225              	; ret
  91+ 8225
  92+ 8225
  93+ 8225
  94+ 8225
  95+ 8225              ; Blocking read
  96+ 8225              ; A <- Byte
  97+ 8225              ; readB:
  98+ 8225                  ; ld a, LSR
  99+ 8225                  ; in a, (#EF)
 100+ 8225                  ; rrca
 101+ 8225                  ; jr nc, readB
 102+ 8225              	; ld a, RBR_THR
 103+ 8225                  ; in a, (#EF)
 104+ 8225                  ; ret
 105+ 8225
 106+ 8225              ; A -> byte to send
 107+ 8225              write:
 108+ 8225 F5               push af
 109+ 8226              .wait
 110+ 8226 3E FD        	ld a, LSR
 111+ 8228 DB EF            in a, (#EF)
 112+ 822A E6 20            and #20
 113+ 822C 28 F8            jr z, .wait
 114+ 822E F1               pop af
 115+ 822F 06 F8        	ld b, RBR_THR
 116+ 8231 0E EF        	ld c, #EF
 117+ 8233 ED 79            out (c), a
 118+ 8235 C9               ret
 119+ 8236
 120+ 8236                  endmodule
# file closed: Drv/zx-wifi.asm
 766  8236              	include Drv/wifi.asm ;работа с ESP
# file opened: Drv/wifi.asm
   1+ 8236                  MODULE Wifi
   2+ 8236 00 00        bytes_avail dw 0 ;байт для приёма
   3+ 8238 00 00        buffer_pointer dw 0 ;указатель на адрес буфера
   4+ 823A 01           closed db 1 ;флаг "соединение закрыто"
   5+ 823B              ;link_id db 0 ;текущий id соединения
   6+ 823B              buffer_end equ #40 ;ограничение буфера адрес #4000
   7+ 823B
   8+ 823B              ; Initialize Wifi chip to work
   9+ 823B              init:
  10+ 823B 21 B4 82         ld hl, .uartIniting
  10+ 823E CD B1 09       call drvgmx.printZ
  11+ 8241 CD D8 81         call Uart.init ;
  12+ 8244 21 C5 82         ld hl, .chipIniting
  12+ 8247 CD B1 09       call drvgmx.printZ
  13+ 824A                  ;EspCmdOkErr "ATE0"
  14+ 824A 21 94 84     	ld hl,cmd_ATE0
  15+ 824D CD 83 83     	call espSendZ
  16+ 8250 CD 1C 83     	call checkOkErr
  17+ 8253 38 3F            jr c, .initError
  18+ 8255
  19+ 8255                  ;EspCmdOkErr "AT+CIPSERVER=0"
  20+ 8255 21 9B 84     	ld hl,cmd_CIPSERVER
  21+ 8258 CD 83 83     	call espSendZ
  22+ 825B CD 1C 83     	call checkOkErr
  23+ 825E                  ;jr c, .initError ;не проверяем ошибку
  24+ 825E                  ;EspCmdOkErr "AT+CIPCLOSE" ;  Close if there some connection was. Don't care about result
  25+ 825E 21 CC 84     	ld hl,cmd_CIPCLOSE
  26+ 8261 CD 83 83     	call espSendZ
  27+ 8264 3E 35        	ld a,'5' ;закрыть все соединения
  28+ 8266 CD 25 82     	call Uart.write
  29+ 8269 3E 0D            ld a, 13
  29+ 826B CD 25 82       call Uart.write
  30+ 826E 3E 0A            ld a, 10
  30+ 8270 CD 25 82       call Uart.write
  31+ 8273 CD 1C 83     	call checkOkErr
  32+ 8276                  ;jr c, .initError ;не проверяем ошибку
  33+ 8276                  ;EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  34+ 8276 21 D8 84     	ld hl,cmd_CIPMUX
  35+ 8279 CD 83 83     	call espSendZ
  36+ 827C CD 1C 83     	call checkOkErr
  37+ 827F 38 13            jr c, .initError
  38+ 8281
  39+ 8281                  ;EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  40+ 8281 21 E6 84     	ld hl,cmd_CIPDINFO
  41+ 8284 CD 83 83     	call espSendZ
  42+ 8287 CD 1C 83     	call checkOkErr
  43+ 828A 38 08            jr c, .initError
  44+ 828C
  45+ 828C 21 D6 82         ld hl, .doneInit
  45+ 828F CD B1 09       call drvgmx.printZ
  46+ 8292
  47+ 8292 B7               or a
  48+ 8293 C9               ret
  49+ 8294              .initError
  50+ 8294 21 9C 82         ld hl, .errMsg
  50+ 8297 CD B1 09       call drvgmx.printZ
  51+ 829A 37               scf
  52+ 829B C9               ret
  53+ 829C 57 69 46 69  .errMsg db "WiFi chip init failed!",13,0
  53+ 82A0 20 63 68 69
  53+ 82A4 70 20 69 6E
  53+ 82A8 69 74 20 66
  53+ 82AC 61 69 6C 65
  53+ 82B0 64 21 0D 00
  54+ 82B4 55 61 72 74  .uartIniting db "Uart initing...",13,0
  54+ 82B8 20 69 6E 69
  54+ 82BC 74 69 6E 67
  54+ 82C0 2E 2E 2E 0D
  54+ 82C4 00
  55+ 82C5 43 68 69 70  .chipIniting db "Chip initing...",13,0
  55+ 82C9 20 69 6E 69
  55+ 82CD 74 69 6E 67
  55+ 82D1 2E 2E 2E 0D
  55+ 82D5 00
  56+ 82D6 44 6F 6E 65  .doneInit    db "Done!",13,0
  56+ 82DA 21 0D 00
  57+ 82DD                  IFNDEF PROXY
  58+ 82DD              ; HL - host pointer in gopher row
  59+ 82DD              ; DE - port pointer in gopher row
  60+ 82DD              openTCP:
  61+ 82DD D5               push de
  62+ 82DE E5               push hl
  63+ 82DF                  ;EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  64+ 82DF 21 CC 84     	ld hl,cmd_CIPCLOSE
  65+ 82E2 CD 83 83     	call espSendZ
  66+ 82E5              	; ld a,(link_id)
  67+ 82E5              	; call Uart.write
  68+ 82E5 3E 0D            ld a, 13
  68+ 82E7 CD 25 82       call Uart.write
  69+ 82EA 3E 0A            ld a, 10
  69+ 82EC CD 25 82       call Uart.write
  70+ 82EF CD 1C 83     	call checkOkErr
  71+ 82F2
  72+ 82F2                  ;EspSend 'AT+CIPSTART,"TCP","' ;
  73+ 82F2 21 AC 84     	ld hl,cmd_CIPSTART
  74+ 82F5 CD 83 83     	call espSendZ
  75+ 82F8              	; ld a,(link_id)
  76+ 82F8              	; call Uart.write
  77+ 82F8              	; ld hl,cmd_CIPSTART2
  78+ 82F8              	; call espSendZ
  79+ 82F8
  80+ 82F8
  81+ 82F8 E1               pop hl
  82+ 82F9 CD 8C 83         call espSendT
  83+ 82FC                  ;EspSend '",'
  84+ 82FC 3E 22            ld a, '"'
  84+ 82FE CD 25 82       call Uart.write
  85+ 8301 3E 2C            ld a, ','
  85+ 8303 CD 25 82       call Uart.write
  86+ 8306 E1               pop hl
  87+ 8307 CD 8C 83         call espSendT
  88+ 830A 3E 0D            ld a, 13
  88+ 830C CD 25 82       call Uart.write
  89+ 830F 3E 0A            ld a, 10
  89+ 8311 CD 25 82       call Uart.write
  90+ 8314 AF               xor a
  90+ 8315 32 3A 82       ld (closed), a
  91+ 8318 C3 1C 83         jp checkOkErr
  92+ 831B
  93+ 831B              continue:
  94+ 831B C9               ret
  95+ 831C                  ENDIF
  96+ 831C
  97+ 831C
  98+ 831C
  99+ 831C              checkOkErr:
 100+ 831C CD 19 82         call Uart.read
 101+ 831F FE 4F            cp 'O'
 101+ 8321 28 0A          jr z, .okStart ; OK
 102+ 8323 FE 45            cp 'E'
 102+ 8325 28 19          jr z, .errStart ; ERROR
 103+ 8327 FE 46            cp 'F'
 103+ 8329 28 36          jr z, .failStart ; FAIL
 104+ 832B 18 EF            jr checkOkErr
 105+ 832D              .okStart
 106+ 832D CD 19 82         call Uart.read
 106+ 8330 FE 4B          cp 'K'
 106+ 8332 20 E8          jr nz, checkOkErr
 107+ 8334 CD 19 82         call Uart.read
 107+ 8337 FE 0D          cp 13
 107+ 8339 20 E1          jr nz, checkOkErr
 108+ 833B CD 7B 83         call .flushToLF
 109+ 833E B7               or a
 110+ 833F C9               ret
 111+ 8340              .errStart
 112+ 8340 CD 19 82         call Uart.read
 112+ 8343 FE 52          cp 'R'
 112+ 8345 20 D5          jr nz, checkOkErr
 113+ 8347 CD 19 82         call Uart.read
 113+ 834A FE 52          cp 'R'
 113+ 834C 20 CE          jr nz, checkOkErr
 114+ 834E CD 19 82         call Uart.read
 114+ 8351 FE 4F          cp 'O'
 114+ 8353 20 C7          jr nz, checkOkErr
 115+ 8355 CD 19 82         call Uart.read
 115+ 8358 FE 52          cp 'R'
 115+ 835A 20 C0          jr nz, checkOkErr
 116+ 835C CD 7B 83         call .flushToLF
 117+ 835F 37               scf
 118+ 8360 C9               ret
 119+ 8361              .failStart
 120+ 8361 CD 19 82         call Uart.read
 120+ 8364 FE 41          cp 'A'
 120+ 8366 20 B4          jr nz, checkOkErr
 121+ 8368 CD 19 82         call Uart.read
 121+ 836B FE 49          cp 'I'
 121+ 836D 20 AD          jr nz, checkOkErr
 122+ 836F CD 19 82         call Uart.read
 122+ 8372 FE 4C          cp 'L'
 122+ 8374 20 A6          jr nz, checkOkErr
 123+ 8376 CD 7B 83         call .flushToLF
 124+ 8379 37               scf
 125+ 837A C9               ret
 126+ 837B              .flushToLF
 127+ 837B CD 19 82         call Uart.read
 128+ 837E FE 0A            cp 10
 128+ 8380 20 F9          jr nz, .flushToLF
 129+ 8382 C9               ret
 130+ 8383
 131+ 8383              ; Send buffer to UART
 132+ 8383              ; HL - buff
 133+ 8383              ; E - count
 134+ 8383              ; espSend:
 135+ 8383                  ; ld a, (hl) : call Uart.write
 136+ 8383                  ; inc hl
 137+ 8383                  ; dec e
 138+ 8383                  ; jr nz, espSend
 139+ 8383                  ; ret
 140+ 8383
 141+ 8383              ; Send buffer to UART
 142+ 8383              ; HL - buff (0 - end!)
 143+ 8383              espSendZ:
 144+ 8383 7E               ld a, (hl)
 145+ 8384 B7           	or a
 146+ 8385 C8           	ret z
 147+ 8386 CD 25 82     	call Uart.write
 148+ 8389 23               inc hl
 149+ 838A 18 F7            jr espSendZ
 150+ 838C
 151+ 838C
 152+ 838C              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 153+ 838C              espSendT:
 154+ 838C 7E               ld a, (hl)
 155+ 838D
 156+ 838D A7               and a
 156+ 838E C8             ret z
 157+ 838F FE 09            cp 9
 157+ 8391 C8             ret z
 158+ 8392 FE 0D            cp 13
 158+ 8394 C8             ret z
 159+ 8395 FE 0A            cp 10
 159+ 8397 C8             ret z
 160+ 8398
 161+ 8398 CD 25 82         call Uart.write
 162+ 839B 23               inc hl
 163+ 839C 18 EE            jr espSendT
 164+ 839E
 165+ 839E              ; HL - stringZ to send
 166+ 839E              ; Adds CR LF
 167+ 839E              ; tcpSendZ:
 168+ 839E                  ; push hl
 169+ 839E                  ; ;EspSend "AT+CIPSEND=" ;
 170+ 839E              	; ld hl,cmd_CIPSEND
 171+ 839E              	; call espSendZ
 172+ 839E              	; ; ld a,(link_id)
 173+ 839E              	; ; call Uart.write
 174+ 839E                  ; ;ld a, ',' : call Uart.write
 175+ 839E
 176+ 839E                  ; pop de : push de
 177+ 839E                  ; call strLen
 178+ 839E                  ; inc hl : inc hl ; +CRLF
 179+ 839E                  ; call hlToNumEsp
 180+ 839E                  ; ld a, 13 : call Uart.write
 181+ 839E                  ; ld a, 10 : call Uart.write
 182+ 839E                  ; call checkOkErr : jr c,.exit_err
 183+ 839E              ; .wait
 184+ 839E                  ; call Uart.read : cp '>' : jr nz, .wait
 185+ 839E                  ; pop hl
 186+ 839E              ; .loop
 187+ 839E                  ; ld a, (hl) : and a : jr z, .exit
 188+ 839E                  ; call Uart.write
 189+ 839E                  ; inc hl
 190+ 839E                  ; jp .loop
 191+ 839E              ; .exit
 192+ 839E                  ; ld a, 13 : call Uart.write
 193+ 839E                  ; ld a, 10 : call Uart.write
 194+ 839E                  ; jp checkOkErr
 195+ 839E              ; .exit_err
 196+ 839E              	; pop hl
 197+ 839E              	; ret
 198+ 839E
 199+ 839E
 200+ 839E
 201+ 839E              ; HL - string to send
 202+ 839E              ; DE - lenght
 203+ 839E              ; Adds CR LF
 204+ 839E              tcpSend:
 205+ 839E E5               push hl
 206+ 839F D5           	push de ;
 207+ 83A0                  ;EspSend "AT+CIPSEND=" ;
 208+ 83A0 21 C0 84     	ld hl,cmd_CIPSEND
 209+ 83A3 CD 83 83     	call espSendZ
 210+ 83A6              	; ld a,(link_id)
 211+ 83A6              	; call Uart.write
 212+ 83A6                  ;ld a, ',' : call Uart.write
 213+ 83A6
 214+ 83A6 E1               pop hl
 214+ 83A7 E5             push hl ;длина
 215+ 83A8                  ;call strLen
 216+ 83A8 23               inc hl
 216+ 83A9 23             inc hl ; +CRLF
 217+ 83AA CD 6D 84         call hlToNumEsp
 218+ 83AD 3E 0D            ld a, 13
 218+ 83AF CD 25 82       call Uart.write
 219+ 83B2 3E 0A            ld a, 10
 219+ 83B4 CD 25 82       call Uart.write
 220+ 83B7 CD 1C 83         call checkOkErr
 220+ 83BA 38 21          jr c,.exit_err2
 221+ 83BC              .wait2
 222+ 83BC CD 19 82         call Uart.read
 222+ 83BF FE 3E          cp '>'
 222+ 83C1 20 F9          jr nz, .wait2
 223+ 83C3 D1           	pop de ;длина
 224+ 83C4 E1               pop hl
 225+ 83C5              .loop2
 226+ 83C5 7E               ld a, (hl)
 227+ 83C6 CD 25 82         call Uart.write
 228+ 83C9 23               inc hl
 229+ 83CA 1B           	dec de
 230+ 83CB 7A           	ld a,d
 231+ 83CC B3           	or e
 232+ 83CD C2 C5 83         jp nz, .loop2
 233+ 83D0              .exit2
 234+ 83D0 3E 0D            ld a, 13
 234+ 83D2 CD 25 82       call Uart.write
 235+ 83D5 3E 0A            ld a, 10
 235+ 83D7 CD 25 82       call Uart.write
 236+ 83DA C3 1C 83         jp checkOkErr
 237+ 83DD              .exit_err2
 238+ 83DD D1           	pop de
 239+ 83DE E1           	pop hl
 240+ 83DF C9           	ret
 241+ 83E0
 242+ 83E0
 243+ 83E0
 244+ 83E0
 245+ 83E0              getPacket:
 246+ 83E0 CD 19 82         call Uart.read
 247+ 83E3 FE 2B            cp '+'
 247+ 83E5 28 28          jr z, .ipdBegun    ; "+IPD," packet
 248+ 83E7 FE 4F            cp 'O'
 248+ 83E9 28 02          jr z, .closedBegun ; It enough to check "OSED\n" :-)
 249+ 83EB 18 F3            jr getPacket
 250+ 83ED              .closedBegun
 251+ 83ED CD 19 82         call Uart.read
 251+ 83F0 FE 53          cp 'S'
 251+ 83F2 20 EC          jr nz, getPacket
 252+ 83F4 CD 19 82         call Uart.read
 252+ 83F7 FE 45          cp 'E'
 252+ 83F9 20 E5          jr nz, getPacket
 253+ 83FB CD 19 82         call Uart.read
 253+ 83FE FE 44          cp 'D'
 253+ 8400 20 DE          jr nz, getPacket
 254+ 8402 CD 19 82         call Uart.read
 254+ 8405 FE 0D          cp 13
 254+ 8407 20 D7          jr nz, getPacket
 255+ 8409 3E 01 32 3A      ld a, 1, (closed), a
 255+ 840D 82
 256+ 840E C9               ret
 257+ 840F              .ipdBegun
 258+ 840F CD 19 82         call Uart.read
 258+ 8412 FE 49          cp 'I'
 258+ 8414 20 CA          jr nz, getPacket
 259+ 8416 CD 19 82         call Uart.read
 259+ 8419 FE 50          cp 'P'
 259+ 841B 20 C3          jr nz, getPacket
 260+ 841D CD 19 82         call Uart.read
 260+ 8420 FE 44          cp 'D'
 260+ 8422 20 BC          jr nz, getPacket
 261+ 8424 CD 19 82         call Uart.read ; Comma
 262+ 8427              	; call Uart.read ; link ID
 263+ 8427              	; ld (link_id),a ;запомнить
 264+ 8427              	;call Uart.read ; Comma
 265+ 8427 CD 54 84         call .count_ipd_lenght
 265+ 842A 22 36 82       ld (bytes_avail), hl
 266+ 842D 44 4D            ld bc, hl
 267+ 842F 2A 38 82         ld hl, (buffer_pointer)
 268+ 8432              .readp
 269+ 8432 7C               ld a, h
 269+ 8433 FE 40          cp buffer_end
 269+ 8435 30 12          jr nc, .skipbuff ;
 270+ 8437 C5 E5            push bc, hl
 271+ 8439 CD 19 82         call Uart.read
 272+ 843C E1 C1            pop hl, bc
 273+ 843E 77               ld (hl), a
 274+ 843F 0B               dec bc
 274+ 8440 23             inc hl
 275+ 8441 78               ld a, b
 275+ 8442 B1             or c
 275+ 8443 20 ED          jr nz, .readp
 276+ 8445 22 38 82         ld (buffer_pointer), hl
 277+ 8448 C9               ret
 278+ 8449              .skipbuff
 279+ 8449 C5               push bc
 280+ 844A CD 19 82         call Uart.read
 281+ 844D C1               pop bc
 282+ 844E 0B               dec bc
 282+ 844F 78             ld a, b
 282+ 8450 B1             or c
 282+ 8451 20 F6          jr nz, .skipbuff
 283+ 8453 C9               ret
 284+ 8454              .count_ipd_lenght
 285+ 8454 21 00 00     		ld hl,0			; count lenght
 286+ 8457 E5           .cil1	push  hl
 287+ 8458 CD 19 82             call Uart.read
 288+ 845B E1                   pop hl
 289+ 845C FE 3A        		cp ':'
 289+ 845E C8             ret z
 290+ 845F D6 30        		sub 0x30
 290+ 8461 4D             ld c,l
 290+ 8462 44             ld b,h
 290+ 8463 29             add hl,hl
 290+ 8464 29             add hl,hl
 290+ 8465 09             add hl,bc
 290+ 8466 29             add hl,hl
 290+ 8467 4F             ld c,a
 290+ 8468 06 00          ld b,0
 290+ 846A 09             add hl,bc
 291+ 846B 18 EA        		jr .cil1
 292+ 846D
 293+ 846D              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 294+ 846D              ; HL - number
 295+ 846D              ; It will be written to UART
 296+ 846D              hlToNumEsp:
 297+ 846D 01 F0 D8     	ld	bc,-10000
 298+ 8470 CD 86 84     	call	.n1
 299+ 8473 01 18 FC     	ld	bc,-1000
 300+ 8476 CD 86 84     	call	.n1
 301+ 8479 01 9C FF     	ld	bc,-100
 302+ 847C CD 86 84     	call	.n1
 303+ 847F 0E F6        	ld	c,-10
 304+ 8481 CD 86 84     	call	.n1
 305+ 8484 0E FF        	ld	c,-1
 306+ 8486 3E 2F        .n1	ld	a,'0'-1
 307+ 8488 3C           .n2	inc	a
 308+ 8489 09           	add	hl,bc
 309+ 848A 38 FC        	jr	c, .n2
 310+ 848C ED 42        	sbc	hl,bc
 311+ 848E C5               push bc
 312+ 848F CD 25 82     	call Uart.write
 313+ 8492 C1               pop bc
 314+ 8493 C9               ret
 315+ 8494
 316+ 8494
 317+ 8494              ;команды
 318+ 8494 41 54 45 30  cmd_ATE0 db "ATE0",13,10,0 ;эхо?
 318+ 8498 0D 0A 00
 319+ 849B 41 54 2B 43  cmd_CIPSERVER db "AT+CIPSERVER=0",13,10,0 ;удалить сервер
 319+ 849F 49 50 53 45
 319+ 84A3 52 56 45 52
 319+ 84A7 3D 30 0D 0A
 319+ 84AB 00
 320+ 84AC 41 54 2B 43  cmd_CIPSTART db 'AT+CIPSTART="' ;продолжение
 320+ 84B0 49 50 53 54
 320+ 84B4 41 52 54 3D
 320+ 84B8 22
 321+ 84B9              	;тут тип
 322+ 84B9 54 43 50 22  cmd_CIPSTART2 db 'TCP","',0 ;продолжение
 322+ 84BD 2C 22 00
 323+ 84C0 41 54 2B 43  cmd_CIPSEND db "AT+CIPSEND=",0 ;отправить данные
 323+ 84C4 49 50 53 45
 323+ 84C8 4E 44 3D 00
 324+ 84CC              	;тут ID
 325+ 84CC 41 54 2B 43  cmd_CIPCLOSE db "AT+CIPCLOSE",0 ;закрыть соединение
 325+ 84D0 49 50 43 4C
 325+ 84D4 4F 53 45 00
 326+ 84D8              	;тут ID
 327+ 84D8 41 54 2B 43  cmd_CIPMUX db "AT+CIPMUX=0",13,10,0 ; Single connection mode
 327+ 84DC 49 50 4D 55
 327+ 84E0 58 3D 30 0D
 327+ 84E4 0A 00
 328+ 84E6 41 54 2B 43  cmd_CIPDINFO db "AT+CIPDINFO=0",13,10,0 ; Disable additional info
 328+ 84EA 49 50 44 49
 328+ 84EE 4E 46 4F 3D
 328+ 84F2 30 0D 0A 00
 329+ 84F6
 330+ 84F6                  ENDMODULE
# file closed: Drv/wifi.asm
 767  84F6              	include Drv/utils.asm ;работа с ESP
# file opened: Drv/utils.asm
   1+ 84F6              ;;; Macroses!!!!
   2+ 84F6                  ; MACRO EspSend Text
   3+ 84F6                  ; ld hl, .txtB
   4+ 84F6                  ; ld e, (.txtE - .txtB)
   5+ 84F6                  ; call espSend
   6+ 84F6                  ; jr .txtE
   7+ 84F6              ; .txtB
   8+ 84F6                  ; db Text
   9+ 84F6              ; .txtE
  10+ 84F6                  ; ENDM
  11+ 84F6
  12+ 84F6                  ; MACRO EspCmd Text
  13+ 84F6                  ; ld hl, .txtB
  14+ 84F6                  ; ld e, (.txtE - .txtB)
  15+ 84F6                  ; call espSend
  16+ 84F6                  ; jr .txtE
  17+ 84F6              ; .txtB
  18+ 84F6                  ; db Text
  19+ 84F6                  ; db 13, 10
  20+ 84F6              ; .txtE
  21+ 84F6                  ; ENDM
  22+ 84F6
  23+ 84F6                  ; MACRO EspCmdOkErr text
  24+ 84F6                  ; EspCmd text
  25+ 84F6                  ; call checkOkErr
  26+ 84F6                  ; ENDM
  27+ 84F6
  28+ 84F6              ; IN DE - string pointer
  29+ 84F6              ; OUT HL - string len
  30+ 84F6              strLen:
  31+ 84F6 21 00 00         ld hl, 0
  32+ 84F9              .loop
  33+ 84F9 1A               ld a, (de)
  33+ 84FA A7             and a
  33+ 84FB C8             ret z
  34+ 84FC 13 23            inc de, hl
  35+ 84FE 18 F9            jr .loop
# file closed: Drv/utils.asm
 768  8500
 769  8500              msg_esp_link
 770  8500 45 53 50 20  	db "ESP id: ",0
 770  8504 69 64 3A 20
 770  8508 00
 771  8509              msg_esp_transmit
 772  8509 54 72 6E 3A  	db "Trn: ",0
 772  850D 20 00
 773  850F              msg_esp_receive
 774  850F 52 63 76 3A  	db "Rcv: ",0
 774  8513 20 00
 775  8515              msg_esp_address
 776  8515 41 64 72 3A  	db "Adr: ",0
 776  8519 20 00
 777  851B
 778  851B              msg_ver_net
 779  851B 4E 45 54 20  	db "NET ver 2025.01.14",13,10,0
 779  851F 76 65 72 20
 779  8523 32 30 32 35
 779  8527 2E 30 31 2E
 779  852B 31 34 0D 0A
 779  852F 00
 780  8530
 781  8530              end_net
 782  8530              	savebin "net.apg",start_net,$-start_net
 783  8530
 784  8530              ;------------------------------------------------------------------------
 785  8530
 786  8530
 787  8530
 788  8530
 789  8530
 790  8530
 791  8530
 792  8530
 793  8530
 794  8530
 795  8530
 796  8530
 797  8530
 798  8530
 799  8530
 800  8530
 801  8530
 802  8530
 803  8530
 804  8530              ;ядро системы
 805  8530              	org #0000
 806  0000              	;bank 0
 807  0000              start_os_main
 808  0000
 809  0000 C3 01 C1     x0000	jp	InitProgramm + #c000	;RST #00	;+#C000 после запуска меняется
 810  0003 00 00 00...  	ds	#08-3
 811  0008
 812  0008 18 31        x0008	jr	x003B			;обработка RST #08
 813  000A 00           	nop
 814  000B 00           x000B	nop
 815  000C 00           	nop
 816  000D 18 75        x000D	jr	ExitMon
 817  000F 00           	ds	#01
 818  0010
 819  0010 C3 BC 09     x0010	jp	drvgmx.putC  ;RST #10		;печать одного символа
 820  0013
 821  0013 ED 79        x0013	out	(c),a
 822  0015 00           	nop
 823  0016 00 00        	ds	#02
 824  0018
 825  0018 C3 2C 06     x0018	jp os_wait ;передача управления ОС ;RST #18
 826  001B 00 00 00...  		ds #05 ;ds	#08
 827  0020
 828  0020 C3 B7 06     x0020	jp function  ;RST #20
 829  0023 00 00 00...  		ds	#05 ;#08
 830  0028
 831  0028 00 00 00...  x0028	ds	#08 ;RST #28
 832  0030
 833  0030 00 00 00     x0030	ds	#03 ;RST #30
 834  0033
 835  0033 ED 79        x0033	out	(c),a
 836  0035 00           	nop
 837  0036
 838  0036 00 23        x0036	dw	font
 839  0038
 840  0038              ;обработчик прерываний
 841  0038 C3 30 07     x0038	jp	Interrupts ;#RST 38
 842  003B
 843  003B              ;обработка RST 8
 844  003B F5           x003B	push	af
 845  003C ED 5F        	ld	a,r
 846  003E EA 43 00     	jp	pe,x0043
 847  0041 ED 5F        	ld	a,r
 848  0043 F5           x0043	push	af
 849  0044 3E 10        	ld	a,#10			;вход из ram 0
 850  0046 F5           	push	af
 851  0047 33           	inc	sp
 852  0048 C5           	push	bc
 853  0049 E5           	push	hl
 854  004A 01 00 00     	ld	bc,#0000
 855  004D 3E 02        	ld	a,#02
 856  004F ED 79        	out	(c),a
 857  0051 01 FD 7E     	ld	bc,#7EFD
 858  0054 ED 60        	in	h,(c)			;h=in #7EFD
 859  0056 06 7A        	ld	b,#7A
 860  0058 ED 68        	in	l,(c)			;l=in #7AFD
 861  005A 06 1F        	ld	b,#1F
 862  005C 3E 12        	ld	a,#12
 863  005E 18 B3        	jr	x0013
 864  0060 00 00 00...  	ds	#06			;=#0060
 865  0066
 866  0066              ;обработка NMI
 867  0066              ;
 868  0066 F5           x0066   push  af
 869  0067 ED 5F           ld  a,r
 870  0069 F3              di
 871  006A F5              push  af
 872  006B 3E 20           ld  a,#20
 873  006D F5              push  af
 874  006E 33              inc  sp
 875  006F C5              push  bc
 876  0070 E5              push  hl
 877  0071 01 FD 7E        ld  bc,#7EFD
 878  0074 ED 60           in  h,(c)    ;h=in #7EFD
 879  0076 06 7A           ld  b,#7A
 880  0078 ED 68           in  l,(c)    ;l=in #7AFD
 881  007A 06 1F           ld  b,#1F    ;18 байт
 882  007C 3E 12           ld  a,#12
 883  007E C3 33 00        jp  x0033
 884  0081
 885  0081 00           	nop
 886  0082 00           	nop
 887  0083 00           	nop
 888  0084              x0084
 889  0084              ;возврат из монитора =#0084
 890  0084 ED 51        ExitMon	out	(c),d			;#1FFD
 891  0086 06 7F        	ld	b,#7F
 892  0088 ED 59        	out	(c),e			;#7FFD
 893  008A 01 00 00     	ld	bc,#0000
 894  008D ED 79        	out	(c),a
 895  008F D1           	pop	de
 896  0090 C1           	pop	bc
 897  0091 33           	inc	sp
 898  0092 F1           	pop	af
 899  0093 ED 4F        	ld	r,a
 900  0095 E2 9B 00     	jp	po,x009B
 901  0098 F1           	pop	af
 902  0099 FB           	ei
 903  009A C9           	ret
 904  009B F1           x009B	pop	af
 905  009C F3           	di
 906  009D C9           	ret
 907  009E
 908  009E              x009E
 909  009E              ; StartWord
 910  009E              	; ldir
 911  009E              	; call	onPageTXT
 912  009E              	; jp	MainLoopEdit
 913  009E              	; INSERT	"Info/!version.txt"
 914  009E              	; INSERT	"Info/!build.txt"
 915  009E              	; db	"GMX"
 916  009E 00 00 00...  y009E	ds	#00FF-$
 917  00FF
 918  00FF 38 00        x00FF	dw	x0038
 919  0101
 920  0101
 921  0101
 922  0101              ;Первый запуск
 923  0101              InitProgramm
 924  0101 F3           	di
 925  0102 31 00 41     	ld sp,#4100 ;временный адрес стека
 926  0105 3E 01        	ld a, #01 ;включить ОЗУ вместо ПЗУ
 927  0107 01 FD 1F         ld   bc,#1ffd
 928  010A ED 79        	out (c),a
 929  010C 21 15 01     	ld hl,Start_warm ;заменить адрес старта
 930  010F 22 01 00     	ld (#0001),hl
 931  0112 C3 00 00     	jp 0
 932  0115
 933  0115
 934  0115              ; rst #08: db #8F установка/удаление резидента из памяти
 935  0115              ; при "теплой" перезагрузке, если резидент установлен в странице, то эта страница
 936  0115                ; будет впечатана в 3е окно и управление передано по заданному адресу
 937  0115              ; вх:  a - номер страницы для установки резидента
 938  0115                      ; =#08 - удаление резидента
 939  0115                      ; 7,a =1 однократный вызов
 940  0115                   ; hl - адрес старта в странице
 941  0115              ; вых: cy=1 резидент не установлен
 942  0115              ; сначала копируем в эту страницу то что надо
 943  0115              ; и только потом вызываем функцию
 944  0115              ; для гмх страницу 8 и #78 задавать нельзя
 945  0115              ; перед повторной установкой резидента, вызывать функцию удаления не нужно
 946  0115
 947  0115              ;Старт системы
 948  0115              Start_warm
 949  0115              	;di
 950  0115 ED 56        	im 1
 951  0117
 952  0117              ;------------------------------------------------------------------------------
 953  0117              ;вызов функции #00(00) (SetRam0) установка работы со страницей ram 0 вместо rom, требуется для
 954  0117              ;корректного выхода из монитора, при ресете отключается
 955  0117              ;вх:  c=#00(00)
 956  0117              ;     cy=1 - установка
 957  0117              ;     cy=0 - отключение
 958  0117              ;вых: регистры не меняются
 959  0117              ;   R8CONF
 960  0117 0E 00        	ld	c,#00
 961  0119 37           	scf
 962  011A CF           	rst	#08
 963  011B 8E           	db	#8E
 964  011C              ;
 965  011C
 966  011C
 967  011C
 968  011C              	;подготовить системный процесс
 969  011C 3E 01        	ld a,proc_id_system ;код системного процесса
 970  011E 32 20 2B     	ld (proc_id_cur),a ;запомнить как текущий
 971  0121 32 07 2B     	ld (proc_id_focus),a ;сразу в фокусе
 972  0124              	;ld (proc_run_prepar_id_tmp),a ;для правильного выделения памяти
 973  0124 AF           	xor a
 974  0125 32 1D 2B     	ld (proc_id_next),a ;для вычисления следующего процесса
 975  0128
 976  0128 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
 977  012A 32 19 2B     	ld (con_scr_cur),a
 978  012D 3E 79        	ld a,con_atr_real ;атрибуты реальные
 979  012F 32 1A 2B     	ld (con_atr_cur),a
 980  0132 3E 39        	ld a,#39 ;видимый экран
 981  0134 32 06 2B     	ld (scr_cur),a
 982  0137 CD 07 09     	call drvgmx.init
 983  013A
 984  013A CD 9C 0C     	call Dos.init_fs_fat ;выбор раздела (буквы диска)
 985  013D
 986  013D 21 C0 34     	ld hl,proc_name_sys		;строка с именем
 987  0140 CD D8 02     	call proc_run ;запуск
 988  0143 DA 77 01     	jp c,loop_idle ;не вышло
 989  0146
 990  0146
 991  0146              	; ;запустить системный процесс
 992  0146              ; ;proc_run_sys
 993  0146              ; ;запуск sys не с диска, а из состава ОС
 994  0146              	; ld hl,proc_sys_name
 995  0146              	; call proc_run_prepar
 996  0146              	; ret c
 997  0146
 998  0146              	;включить страницы
 999  0146              	;;ld ix,(proc_run_prepar_deskr_tmp)
1000  0146 DD 7E 02     	ld a,(ix+2)
1001  0149 32 18 2B     	ld (page_slot2_cur),a ;сделать страницы текущими
1002  014C CD 8E 0B     	call drvgmx.PageSlot2
1003  014F DD 7E 03     	ld a,(ix+3)
1004  0152 32 17 2B     	ld (page_slot3_cur),a
1005  0155 CD AD 0A     	call drvgmx.PageSlot3
1006  0158              	;цвета
1007  0158 3E 07        	ld a,proc_color_def ;цвет
1008  015A 32 CC 0B     	ld (drvgmx.attr_screen),a
1009  015D DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1010  0160              	;
1011  0160 3E 0C        	ld a,proc_color2_def ;цвет 2
1012  0162 32 CD 0B     	ld (drvgmx.attr_screen2),a
1013  0165 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1014  0168              	; ;перенести код
1015  0168              	; ld hl,start_sys_incl
1016  0168              	; ld de,PROGSTART
1017  0168              	; ld bc,end_sys_incl-start_sys_incl
1018  0168              	; ldir
1019  0168              	;подготовить правильный старт
1020  0168 DD 6E 06     	ld l,(ix+6) ;стек нового процесса
1021  016B DD 66 07     	ld h,(ix+7) ;стек
1022  016E F9           	ld sp,hl
1023  016F
1024  016F 3E 01        	ld a,proc_id_system
1025  0171 DD 77 00     	ld (ix),a
1026  0174 C3 00 80     	jp PROGSTART ;старт сначала на заглушку
1027  0177
1028  0177
1029  0177
1030  0177
1031  0177
1032  0177              loop_idle ;заглушка
1033  0177 18 FE        	jr loop_idle ;
1034  0179
1035  0179
1036  0179
1037  0179
1038  0179
1039  0179              ; proc_run_cmd
1040  0179              ; ; запуск cmd не с диска, а из состава ОС
1041  0179              	; ld hl,proc_cmd_name
1042  0179              	; call proc_run_prepar
1043  0179              	; ret c
1044  0179              	; ;включить страницы
1045  0179              	; ;ld ix,(proc_run_prepar_deskr_tmp)
1046  0179              	; ld a,(ix+2)
1047  0179              	; call drvgmx.PageSlot2
1048  0179              	; ld a,(ix+3)
1049  0179              	; call drvgmx.PageSlot3
1050  0179              	; ;перенести код
1051  0179              	; ld hl,start_cmd_incl
1052  0179              	; ld de,PROGSTART
1053  0179              	; ld bc,end_cmd_incl-start_cmd_incl
1054  0179              	; ldir
1055  0179
1056  0179              	; jp file_load_ok ;продолжить стандартно
1057  0179
1058  0179
1059  0179
1060  0179
1061  0179
1062  0179              proc_run_prepar
1063  0179              ;подготовка к запуску процесса
1064  0179              ;выделение памяти и прочее
1065  0179              ;вх: hl - имя процесса (файла) 8+3 символов
1066  0179              ;вых: a - номер процесса, IX - дескриптор
1067  0179
1068  0179 22 F8 01     	ld (proc_run_prepar_name_tmp),hl ;сохранить имя
1069  017C              	;поиск свободного дескриптора
1070  017C 21 00 2C     	ld hl,proc_table
1071  017F 11 00 01     	ld de,proc_descr_size
1072  0182 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
1073  0184 0E 01        	ld c,proc_id_system ;первый номер
1074  0186              proc_run_prepar_cl
1075  0186 7E           	ld a,(hl)
1076  0187 B7           	or a ;свободен?
1077  0188 28 0C        	jr z,proc_run_prepar_ok
1078  018A 19           	add hl,de
1079  018B 0C           	inc c
1080  018C 10 F8        	djnz proc_run_prepar_cl
1081  018E              	;не нашли свободного
1082  018E 21 EE 34     	ld hl,msg_proc_max
1083  0191 CD B1 09     	call drvgmx.printZ ;сообщение
1084  0194 37           	scf
1085  0195 C9           	ret
1086  0196              proc_run_prepar_ok
1087  0196              	;есть свободный
1088  0196 E5           	push hl
1089  0197 DD E1        	pop ix ;дискриптор процесса
1090  0199 22 FC 01     	ld (proc_run_prepar_deskr_tmp),hl
1091  019C 79           	ld a,c ;присвоить номер
1092  019D 32 FA 01     	ld (proc_run_prepar_id_tmp),a
1093  01A0
1094  01A0
1095  01A0 3A 20 2B     	ld a,(proc_id_cur)
1096  01A3 DD 77 01     	ld (ix+1),a ;код родительского
1097  01A6
1098  01A6              	;скопировать имя
1099  01A6 11 10 00     	ld de,16 ;
1100  01A9 19           	add hl,de
1101  01AA EB           	ex de,hl
1102  01AB 2A F8 01     	ld hl,(proc_run_prepar_name_tmp)
1103  01AE 01 0C 00     	ld bc,8+3+1
1104  01B1 ED B0        	ldir
1105  01B3
1106  01B3
1107  01B3              	;выделение памяти стандартное количество окон
1108  01B3 CD FE 01     	call proc_find_ram
1109  01B6 38 1D        	jr c,proc_run_prepar_no_mem
1110  01B8 DD 77 02     	ld (ix+2),a ;страница 8000
1111  01BB CD FE 01     	call proc_find_ram
1112  01BE 38 15        	jr c,proc_run_prepar_no_mem
1113  01C0 DD 77 03     	ld (ix+3),a ;страница c000
1114  01C3 CD FE 01     	call proc_find_ram
1115  01C6 38 0D        	jr c,proc_run_prepar_no_mem
1116  01C8 DD 77 04     	ld (ix+4),a ;страница пиксели
1117  01CB CD FE 01     	call proc_find_ram
1118  01CE 38 05        	jr c,proc_run_prepar_no_mem
1119  01D0 DD 77 05     	ld (ix+5),a ;страница атрибуты
1120  01D3
1121  01D3 18 0E        	jr proc_run_prepar_mem_ok
1122  01D5
1123  01D5              proc_run_prepar_no_mem
1124  01D5 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1125  01D8 CD 17 02     	call proc_clear_ram ;освободить память обратно
1126  01DB
1127  01DB 21 05 35     	ld hl,msg_mem_max
1128  01DE CD B1 09     	call drvgmx.printZ ;сообщение
1129  01E1 37           	scf
1130  01E2 C9           	ret
1131  01E3
1132  01E3              proc_run_prepar_mem_ok ;памяти хватило
1133  01E3
1134  01E3              	;определить адрес стека
1135  01E3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1136  01E6 21 00 2B     	ld hl,proc_table-256
1137  01E9 84           	add h
1138  01EA 67           	ld h,a
1139  01EB 2E 80        	ld l,#80 ;на стек меньше 128 байт
1140  01ED              	; ld hl,proc_stack
1141  01ED              	; or a
1142  01ED              	; jr z,proc_run_prepar_ex
1143  01ED              	; ld b,a
1144  01ED              	; ld de,proc_stack_size
1145  01ED              ; proc_run_prepar_cl2 ;цикл
1146  01ED              	; add hl,de
1147  01ED              	; djnz proc_run_prepar_cl2
1148  01ED              ;proc_run_prepar_ex
1149  01ED DD 75 06     	ld (ix+6),l ;адрес стека
1150  01F0 DD 74 07     	ld (ix+7),h ;адрес стека
1151  01F3              	; ld a,(proc_run_prepar_id_tmp) ;id
1152  01F3              	; ld (ix+0),a
1153  01F3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1154  01F6 B7           	or a
1155  01F7 C9           	ret
1156  01F8
1157  01F8 00 00        proc_run_prepar_name_tmp dw 0 ;временно имя нового процесса
1158  01FA 00           proc_run_prepar_id_tmp db 0 ;временно id нового процесса
1159  01FB 00           proc_run_file_id_tmp db 0 ;временно id файла
1160  01FC 00 00        proc_run_prepar_deskr_tmp dw 0 ;временно дескриптор процесса
1161  01FE
1162  01FE              proc_find_ram	;поиск свободной страницы памяти
1163  01FE              ;вых: a - номер страницы, также записан id процесса в таблицу proc_page_table
1164  01FE 11 0E 0B     	ld de,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
1165  0201 21 00 34     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
1166  0204 06 6D        	ld b,page_max
1167  0206              proc_find_ram_cl
1168  0206 AF           	xor a
1169  0207 B6           	or (hl)
1170  0208 28 06        	jr z,proc_find_ram_ok1 ;нашли
1171  020A              	;ищем дальше
1172  020A 23           	inc hl
1173  020B 13           	inc de
1174  020C 10 F8        	djnz proc_find_ram_cl
1175  020E              	;совсем не нашли
1176  020E 37           	scf
1177  020F C9           	ret
1178  0210              proc_find_ram_ok1
1179  0210 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1180  0213 77           	ld (hl),a ;записать id процесса в таблицу
1181  0214 1A           	ld a,(de) ;вернуть номер страницы
1182  0215 B7           	or a
1183  0216 C9           	ret
1184  0217
1185  0217
1186  0217              proc_clear_ram ;освбождение всех страниц памяти процесса
1187  0217              ;вх: a - номер процесса
1188  0217 21 00 34     	ld hl,proc_page_table
1189  021A 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
1190  021C              proc_clear_ram_cl ;
1191  021C BE           	cp (hl) ;совпадает с номером процесса?
1192  021D 20 02        	jr nz,proc_clear1
1193  021F 36 00        	ld (hl),0 ;освободить
1194  0221              proc_clear1
1195  0221 23           	inc hl
1196  0222 10 F8        	djnz proc_clear_ram_cl
1197  0224 B7           	or a
1198  0225 C9           	ret
1199  0226
1200  0226
1201  0226
1202  0226              proc_focus_next
1203  0226              	;переключение фокуса на следующий процесс
1204  0226 3E 01        	ld a,1
1205  0228 32 0D 2B     	ld (proc_next_find_skip_flag),a ;флаг пропустить лишние проверки
1206  022B 3A 07 2B     	ld a,(proc_id_focus)
1207  022E CD B5 08     	call proc_next_find_skip ;узнать кто следующий
1208  0231 08           	ex af,af'
1209  0232 AF           	xor a
1210  0233 32 0D 2B     	ld (proc_next_find_skip_flag),a ;флаг убрать
1211  0236 08           	ex af,af'
1212  0237              	;ret c ;выернуться если один процесс
1213  0237              	;или сменить фокус, код ниже
1214  0237
1215  0237
1216  0237
1217  0237              ;передать фокус процессу
1218  0237              ;вх: a - id процесса
1219  0237              proc_set_focus
1220  0237 21 07 2B     	ld hl,proc_id_focus
1221  023A BE           	cp (hl)
1222  023B C8           	ret z ;если уже в фокусе, ничего не делаем
1223  023C 32 CA 02     	ld (proc_set_focus_id_tmp),a ;сохранить
1224  023F
1225  023F 21 00 2B     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1226  0242 84           	add h
1227  0243 67           	ld h,a
1228  0244 AF           	xor a
1229  0245 B6           	or (hl)
1230  0246 C8           	ret z
1231  0247
1232  0247
1233  0247              	;сохранить в буфер процесса текущий экран
1234  0247 3A 07 2B     	ld a,(proc_id_focus) ;текущий в фокусе
1235  024A 21 00 2B     	ld hl,proc_table - 256
1236  024D 84           	add h
1237  024E 67           	ld h,a
1238  024F E5           	push hl
1239  0250 DD E1        	pop ix ;дескриптор процесса предыдущего
1240  0252
1241  0252 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1242  0255 CD AD 0A     	call drvgmx.PageSlot3
1243  0258 3E 39        	ld a,con_scr_real ;настоящий экран
1244  025A CD 8E 0B     	call drvgmx.PageSlot2
1245  025D 21 00 80     	ld hl,#8000 ;скопировать
1246  0260 11 00 C0     	ld de,#c000
1247  0263 01 00 40     	ld bc,#4000
1248  0266 ED B0        	ldir
1249  0268
1250  0268 DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1251  026B CD AD 0A     	call drvgmx.PageSlot3
1252  026E 3E 79        	ld a,con_atr_real
1253  0270 CD 8E 0B     	call drvgmx.PageSlot2
1254  0273 21 00 80     	ld hl,#8000 ;скопировать
1255  0276 11 00 C0     	ld de,#c000
1256  0279 01 00 40     	ld bc,#4000
1257  027C ED B0        	ldir
1258  027E
1259  027E              	;сохранить позицию скрола
1260  027E              	;ld hl,(drvgmx.curscrl)
1261  027E              	;ld (ix+#08),hl ;позиция скрола
1262  027E
1263  027E
1264  027E              	;вернуть из буфера экран нужного процесса
1265  027E 3A CA 02     	ld a,(proc_set_focus_id_tmp)
1266  0281 21 00 2B     	ld hl,proc_table - 256
1267  0284 84           	add h
1268  0285 67           	ld h,a
1269  0286 E5           	push hl
1270  0287 DD E1        	pop ix ;дескриптор процесса который будет в фокусе
1271  0289
1272  0289 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1273  028C CD AD 0A     	call drvgmx.PageSlot3
1274  028F 3E 39        	ld a,con_scr_real ;настоящий экран
1275  0291 CD 8E 0B     	call drvgmx.PageSlot2
1276  0294 21 00 C0     	ld hl,#c000 ;скопировать
1277  0297 11 00 80     	ld de,#8000
1278  029A 01 00 40     	ld bc,#4000
1279  029D ED B0        	ldir
1280  029F
1281  029F DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1282  02A2 CD AD 0A     	call drvgmx.PageSlot3
1283  02A5 3E 79        	ld a,con_atr_real
1284  02A7 CD 8E 0B     	call drvgmx.PageSlot2
1285  02AA 21 00 C0     	ld hl,#c000 ;скопировать
1286  02AD 11 00 80     	ld de,#8000
1287  02B0 01 00 40     	ld bc,#4000
1288  02B3 ED B0        	ldir
1289  02B5
1290  02B5 CD CB 02     	call page_cur_return
1291  02B8
1292  02B8
1293  02B8 3A CA 02     	ld a,(proc_set_focus_id_tmp)
1294  02BB              	;запомнить активный процесс
1295  02BB 32 07 2B     	ld (proc_id_focus),a
1296  02BE
1297  02BE              	;ld hl,(ix+#08) ;позиция скрола
1298  02BE              	;ld (drvgmx.curscrl),hl
1299  02BE              	;call drvgmx.gmxscroll ;обновить скролл
1300  02BE DD 7E 1D     	ld a, (ix + #1d) ;активный экран
1301  02C1 B7           	or a
1302  02C2 28 03        	jr z,proc_set_focus_scr
1303  02C4 CD 92 04     	call set_scr_no_txt ;включить
1304  02C7              proc_set_focus_scr
1305  02C7 C3 30 07     	jp Interrupts ;сразу на другой процесс
1306  02CA              	;or a
1307  02CA              	;ret
1308  02CA 00           proc_set_focus_id_tmp db 0 ; временно
1309  02CB
1310  02CB
1311  02CB
1312  02CB              page_cur_return
1313  02CB              ;вернуть текущие страницы
1314  02CB 3A 18 2B     	ld a,(page_slot2_cur)
1315  02CE CD 8E 0B     	call drvgmx.PageSlot2
1316  02D1 3A 17 2B     	ld a,(page_slot3_cur)
1317  02D4 CD AD 0A     	call drvgmx.PageSlot3
1318  02D7 C9           	ret
1319  02D8
1320  02D8
1321  02D8              ;запустить процесс
1322  02D8              ;вх: hl - имя файла (заканчивается на 0)
1323  02D8              proc_run
1324  02D8 CD 79 01     	call proc_run_prepar ;выделить память
1325  02DB D8           	ret c
1326  02DC
1327  02DC 2A F8 01     	ld hl,(proc_run_prepar_name_tmp) ;имя
1328  02DF              	;ld b,Dos.FMODE_READ
1329  02DF CD 21 0C     	call Dos.fopen_r ;откроем файл для чтения
1330  02E2 DC 96 0D     	call c,Dos.file_error_print_file_open_error
1331  02E5 DA BE 03     	jp c,file_load_err
1332  02E8 32 FB 01     	ld (proc_run_file_id_tmp),a ;запомнить id
1333  02EB
1334  02EB              	;проверка длины файла не больше #8000
1335  02EB 7A           	ld	a,d ;самые старшие байты длины
1336  02EC B3           	or e
1337  02ED 28 09        	jr z,file_size_ok ;если не слищком большой
1338  02EF              file_too_big
1339  02EF 21 65 0F     	ld hl,Dos.msg_file_too_big
1340  02F2 CD B1 09     	call drvgmx.printZ
1341  02F5 C3 BE 03     	jp file_load_err
1342  02F8
1343  02F8
1344  02F8              file_size_ok
1345  02F8 78           	ld	a,b ;младший старший байт длины
1346  02F9 FE 81        	cp proc_size_max+1
1347  02FB 30 F2        	jr nc,file_too_big
1348  02FD              	;размер нормальный, прочитаем
1349  02FD
1350  02FD
1351  02FD
1352  02FD              	;включить страницы
1353  02FD DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp)
1354  0301 DD 7E 02     	ld a,(ix+2)
1355  0304 CD 8E 0B     	call drvgmx.PageSlot2
1356  0307 DD 7E 03     	ld a,(ix+3)
1357  030A CD AD 0A     	call drvgmx.PageSlot3
1358  030D
1359  030D 21 00 80     	ld hl,PROGSTART
1360  0310 3A FB 01     	ld a,(proc_run_file_id_tmp)
1361  0313 50           	ld d,b ;размер
1362  0314 59           	ld e,c
1363  0315 CD E0 0D     	call Dos.fread
1364  0318 30 0E        	jr nc,file_size_ok2
1365  031A              	;если ошибка вернуть страницы
1366  031A CD 9E 0D     	call Dos.file_error_print_file_read_error
1367  031D CD CB 02     	call page_cur_return
1368  0320 3A FB 01     	ld a,(proc_run_file_id_tmp)
1369  0323 CD A6 0D     	call Dos.fclose ;закрыть файл
1370  0326 37           	scf
1371  0327 C9           	ret
1372  0328              file_size_ok2
1373  0328 3A FB 01     	ld a,(proc_run_file_id_tmp)
1374  032B CD A6 0D     	call Dos.fclose ;закрыть файл
1375  032E              	;jr file_load_ok
1376  032E
1377  032E              	;скопировать дескриптор системной папки, будет у приложения такая же папка по умолчанию
1378  032E 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;номер будущего процесса
1379  0331 CD 6C 0E     	call Dos.calc_dir_deskr
1380  0334 EB           	ex de,hl
1381  0335 21 D5 0F     	ld hl,Dos.dir_fat_deskr
1382  0338 01 20 00     	ld bc,Dos.fcb_fat_size
1383  033B ED B0        	ldir
1384  033D
1385  033D              file_load_ok ;загрузился нормально
1386  033D DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp) ;вспомнить дескриптор
1387  0341              	;очистить экран
1388  0341              	;сначала запомнить как было
1389  0341 2A CC 0B     	ld hl,(drvgmx.attr_screen)
1390  0344 22 C0 03     	ld (proc_run_attr_screen_tmp),hl
1391  0347              	; запомнить координаты экрана предыдущего
1392  0347 2A CA 0B     	ld hl,(drvgmx.col_screen)
1393  034A 22 C4 03     	ld (proc_run_col_screen_tmp),hl ;координаты
1394  034D              	;страницы буфера
1395  034D 3A 19 2B     	ld a,(con_scr_cur)
1396  0350 32 C2 03     	ld (proc_run_con_scr_cur_tmp),a
1397  0353 3A 1A 2B     	ld a,(con_atr_cur)
1398  0356 32 C3 03     	ld (proc_run_con_atr_cur_tmp),a
1399  0359              	;скрола
1400  0359 2A 9E 0A     	ld hl,(drvgmx.curscrl)
1401  035C 22 C6 03     	ld (proc_run_curscrl_tmp),hl
1402  035F
1403  035F
1404  035F
1405  035F              	;чистить буфер экрана
1406  035F 3E 07        	ld a,proc_color_def ;цвет
1407  0361 32 CC 0B     	ld (drvgmx.attr_screen),a
1408  0364 DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1409  0367              	;
1410  0367 3E 0C        	ld a,proc_color2_def ;цвет 2
1411  0369 32 CD 0B     	ld (drvgmx.attr_screen2),a
1412  036C DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1413  036F              	;
1414  036F DD 7E 04     	ld a,(ix+4)
1415  0372 32 19 2B     	ld (con_scr_cur),a
1416  0375 DD 7E 05     	ld a,(ix+5)
1417  0378 32 1A 2B     	ld (con_atr_cur),a
1418  037B CD 0A 09     	call drvgmx.cls
1419  037E              	;вернуть
1420  037E 2A C0 03     	ld hl,(proc_run_attr_screen_tmp)
1421  0381 22 CC 0B     	ld (drvgmx.attr_screen),hl
1422  0384 2A C4 03     	ld hl,(proc_run_col_screen_tmp) ;координаты
1423  0387 22 CA 0B     	ld (drvgmx.col_screen),hl
1424  038A 3A C2 03     	ld a,(proc_run_con_scr_cur_tmp)
1425  038D 32 19 2B     	ld (con_scr_cur),a
1426  0390 3A C3 03     	ld a,(proc_run_con_atr_cur_tmp)
1427  0393 32 1A 2B     	ld (con_atr_cur),a
1428  0396 2A C6 03     	ld hl,(proc_run_curscrl_tmp)
1429  0399 22 9E 0A     	ld (drvgmx.curscrl),hl
1430  039C
1431  039C
1432  039C
1433  039C
1434  039C              	;подготовить правильный старт
1435  039C DD 6E 06     	ld l,(ix+6) ;адрес стека
1436  039F DD 66 07     	ld h,(ix+7) ;адрес стека
1437  03A2 01 00 80     	ld bc,PROGSTART ;возврат сюда
1438  03A5 2B           	dec hl
1439  03A6 70           	ld (hl),b
1440  03A7 2B           	dec hl
1441  03A8 71           	ld (hl),c
1442  03A9 01 EC FF     	ld bc,-20 ;возврат будет с восстановлением регистров
1443  03AC 09           	add hl,bc
1444  03AD
1445  03AD DD 75 06     	ld (ix+6),l ;адрес стека
1446  03B0 DD 74 07     	ld (ix+7),h ;адрес стека
1447  03B3 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1448  03B6 DD 77 00     	ld (ix),a ;в последнюю очередь код (флаг что процесс работает)
1449  03B9
1450  03B9 CD CB 02     	call page_cur_return
1451  03BC B7           	or a
1452  03BD C9           	ret
1453  03BE
1454  03BE
1455  03BE              file_load_err
1456  03BE 37           	scf
1457  03BF C9           	ret
1458  03C0
1459  03C0 00 00        proc_run_attr_screen_tmp dw 0 ;временно
1460  03C2 00           proc_run_con_scr_cur_tmp db 0 ;временно
1461  03C3 00           proc_run_con_atr_cur_tmp db 0 ;временно
1462  03C4 00 00        proc_run_col_screen_tmp dw 0 ;временно
1463  03C6 00 00        proc_run_curscrl_tmp dw 0 ;временно
1464  03C8
1465  03C8
1466  03C8
1467  03C8
1468  03C8
1469  03C8
1470  03C8
1471  03C8
1472  03C8              get_c ;функция получение кода нажатой клавиши
1473  03C8              	;вых: a - код последней клавиши, 255 - ничего не нажато
1474  03C8 3A 20 2B     	ld a,(proc_id_cur) ;сравнить если процесс в фокусе
1475  03CB 21 07 2B     	ld hl,proc_id_focus
1476  03CE BE           	cp (hl)
1477  03CF 3E FF        	ld a,255 ;ничего не нажато если не в фокусе
1478  03D1 C0           	ret nz
1479  03D2 3A 1B 2B     	ld a,(key_cur) ;или вернуть клавишу
1480  03D5 F5           	push af
1481  03D6 3E FF        	ld a,255
1482  03D8 32 1B 2B     	ld (key_cur),a ;очистить буфер
1483  03DB F1           	pop af
1484  03DC C9           	ret
1485  03DD
1486  03DD              get_timer ;функция получить значение системного таймера
1487  03DD ED 5B 21 2B  	ld de,(sys_timer) ;младшие байты
1488  03E1 2A 23 2B     	ld hl,(sys_timer+2)
1489  03E4 C9           	ret
1490  03E5
1491  03E5
1492  03E5
1493  03E5              page_copy ;скопировать страницу в страницу
1494  03E5              ;скопировать данные из страницы в страницу
1495  03E5              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
1496  03E5 ED 43 1B 04  	ld (page_copy_tmp),bc
1497  03E9 32 1B 04     	ld (page_copy_tmp),a
1498  03EC D9           	exx
1499  03ED CD 1D 04     	call page_check_owner 	;проверка разрешений
1500  03F0 D8           	ret c
1501  03F1 3A 1C 04     	ld a,(page_copy_tmp+1)
1502  03F4 CD 1D 04     	call page_check_owner 	;проверка разрешений
1503  03F7 D8           	ret c
1504  03F8 DD 7C        	ld a,ixh ;не больше размера страницы
1505  03FA FE 41        	cp #41
1506  03FC 30 1B        	jr nc,page_copy_err
1507  03FE DD B5        	or ixl
1508  0400 28 17        	jr z,page_copy_err ;и не 0 длина
1509  0402 3A 1B 04     	ld a,(page_copy_tmp)
1510  0405 CD 8E 0B     	call drvgmx.PageSlot2
1511  0408 3A 1C 04     	ld a,(page_copy_tmp+1)
1512  040B CD AD 0A     	call drvgmx.PageSlot3
1513  040E D9           	exx ;вспомнить регистры
1514  040F              	 ;скопировать
1515  040F DD E5        	push ix
1516  0411 C1           	pop bc ;длина
1517  0412 ED B0        	ldir
1518  0414 CD CB 02     	call page_cur_return ;вернуть страницы
1519  0417 AF           	xor a
1520  0418 C9           	ret
1521  0419              page_copy_err
1522  0419 37           	scf
1523  041A C9           	ret
1524  041B
1525  041B
1526  041B 00 00        page_copy_tmp dw 0 ;временно
1527  041D
1528  041D              page_check_owner ;проверить разрешена ли страница для процесса
1529  041D FE 05        	cp #05 ;видео страница
1530  041F C8           	ret z
1531  0420 FE 07        	cp #07 ;видео страница
1532  0422 C8           	ret z
1533  0423 FE 39        	cp #39 ;видео страница
1534  0425 C8           	ret z
1535  0426 FE 3A        	cp #3a ;видео страница
1536  0428 C8           	ret z
1537  0429 FE 79        	cp #79 ;видео страница
1538  042B C8           	ret z
1539  042C FE 7A        	cp #7a ;видео страница
1540  042E C8           	ret z
1541  042F 32 53 04     	ld (page_check_owner_tmp),a
1542  0432 21 0E 0B     	ld hl,drvgmx.page_table ;таблица памяти
1543  0435 06 6D        	ld b,page_max ;всего страниц
1544  0437 0E 00        	ld c,0 ;индекс
1545  0439              page_check_owner_cl ;найти такую страницу
1546  0439 BE           	cp (hl)
1547  043A 28 06        	jr z,page_check_owner_ex
1548  043C 0C           	inc c
1549  043D 23           	inc hl
1550  043E 10 F9        	djnz page_check_owner_cl
1551  0440 37           	scf ;не нашли в списке страниц
1552  0441 C9           	ret
1553  0442              page_check_owner_ex
1554  0442              	;нашли
1555  0442 06 00        	ld b,0
1556  0444 21 00 34     	ld hl,proc_page_table ;сверить с кодом текущего процесса
1557  0447 09           	add hl,bc
1558  0448 3A 20 2B     	ld a,(proc_id_cur)
1559  044B BE           	cp (hl)
1560  044C 37           	scf ;не совпадает владелец с процессом
1561  044D 3A 53 04     	ld a,(page_check_owner_tmp)
1562  0450 C0           	ret nz
1563  0451 B7           	or a
1564  0452 C9           	ret
1565  0453 00           page_check_owner_tmp db 0 ;временно
1566  0454
1567  0454
1568  0454              set_VTPL_PLAY ;запустить плеер AY. будет играть на прерываниях
1569  0454 3A 18 2B     	ld a,(page_slot2_cur)
1570  0457 32 04 2B     	ld (proc_play_ay_slot2),a ;запомнить страницы с музыкой
1571  045A 3A 17 2B     	ld a,(page_slot3_cur)
1572  045D 32 05 2B     	ld (proc_play_ay_slot3),a
1573  0460 3A 20 2B     	ld a,(proc_id_cur) ;код процесса, который играет музыку
1574  0463 32 03 2B     	ld (proc_play_ay),a
1575  0466 C9           	ret
1576  0467
1577  0467              set_VTPL_MUTE ;остановить плеер AY
1578  0467 AF           	xor a
1579  0468 32 03 2B     	ld (proc_play_ay),a
1580  046B C3 60 16     	jp VTPL.MUTE
1581  046E
1582  046E
1583  046E              get_VTPL_SETUP ;получить адрес переменной плеера
1584  046E 21 3B 16     	ld hl,VTPL.SETUP
1585  0471 C9           	ret
1586  0472
1587  0472
1588  0472              get_proc_page ;получить номера страниц процесса
1589  0472              	;вых: BC - страницы в слоте 2, 3
1590  0472 3A 18 2B     	ld a,(page_slot2_cur)
1591  0475 47           	ld b,a
1592  0476 3A 17 2B     	ld a,(page_slot3_cur)
1593  0479 4F           	ld c,a
1594  047A C9           	ret
1595  047B
1596  047B
1597  047B              set_scr ;установить активный экран
1598  047B              	;проверки
1599  047B 08           	ex af,af'
1600  047C 3A 20 2B     	ld a,(proc_id_cur)
1601  047F 21 07 2B     	ld hl,proc_id_focus
1602  0482 BE           	cp (hl)
1603  0483 20 21        	jr nz,set_scr_err
1604  0485 CD AE 06     	call get_proc_descr
1605  0488 08           	ex af,af'
1606  0489 DD 77 1C     	ld (ix+#1c),a ;запомнить
1607  048C B7           	or a
1608  048D 20 03        	jr nz,set_scr_no_txt
1609  048F              	;включить текстовый
1610  048F C3 F2 0A     	jp drvgmx.set_scr39	;основной экран
1611  0492              set_scr_no_txt
1612  0492 FE 05        	cp #05
1613  0494 CA D6 0A     	jp z,drvgmx.set_scr5
1614  0497 FE 07        	cp #07
1615  0499 CA E4 0A     	jp z,drvgmx.set_scr7
1616  049C FE 39        	cp #39
1617  049E CA F2 0A     	jp z,drvgmx.set_scr39
1618  04A1 FE 3A        	cp #3a
1619  04A3 CA 00 0B     	jp z,drvgmx.set_scr3a
1620  04A6              set_scr_err
1621  04A6 37           	scf
1622  04A7 C9           	ret
1623  04A8
1624  04A8              set_page_slot2	;включить страницу в слот 2 (#8000);
1625  04A8 CD 1D 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1626  04AB D8           	ret c
1627  04AC 08           	ex af,af'
1628  04AD 3A 20 2B     	ld a,(proc_id_cur)
1629  04B0 21 00 2B     	ld hl,proc_table - 256
1630  04B3 84           	add h
1631  04B4 67           	ld h,a
1632  04B5 E5           	push hl
1633  04B6 DD E1        	pop ix ;дескриптор
1634  04B8 08           	ex af,af'
1635  04B9 DD 77 02     	ld (ix+#02),a ;запомнить текущую страницу процесса
1636  04BC C3 8E 0B     	jp drvgmx.PageSlot2 ;включить
1637  04BF
1638  04BF
1639  04BF              set_page_slot3	;включить страницу в слот 2 (#8000);
1640  04BF CD 1D 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1641  04C2 D8           	ret c
1642  04C3 08           	ex af,af'
1643  04C4 3A 20 2B     	ld a,(proc_id_cur)
1644  04C7 21 00 2B     	ld hl,proc_table - 256
1645  04CA 84           	add h
1646  04CB 67           	ld h,a
1647  04CC E5           	push hl
1648  04CD DD E1        	pop ix ;дескриптор
1649  04CF 08           	ex af,af'
1650  04D0 DD 77 03     	ld (ix+#03),a ;запомнить текущую страницу процесса
1651  04D3 C3 AD 0A     	jp drvgmx.PageSlot3
1652  04D6
1653  04D6
1654  04D6
1655  04D6              set_interrupt ;установка адреса обработчика прерываний процесса;
1656  04D6 EB           	ex de,hl
1657  04D7 3A 20 2B     	ld a,(proc_id_cur)
1658  04DA 21 00 2B     	ld hl,proc_table - 256
1659  04DD 84           	add h
1660  04DE 67           	ld h,a
1661  04DF E5           	push hl
1662  04E0 DD E1        	pop ix ;дескриптор
1663  04E2 EB           	ex de,hl
1664  04E3 DD 75 0E     	ld (ix+#0e),l ;адрес
1665  04E6 DD 74 0F     	ld (ix+#0f),h ;адрес
1666  04E9 C9           	ret
1667  04EA
1668  04EA
1669  04EA
1670  04EA
1671  04EA              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; hl - строка адрес, de - строка порт
1672  04EA              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1673  04EA              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто);
1674  04EA              esp_open ;установить соединение ESP (CIPSTART);
1675  04EA 08           	ex af,af'
1676  04EB CD 5D 05     	call esp_check_err
1677  04EE D8           	ret c
1678  04EF 08           	ex af,af'
1679  04F0 FE 03        	cp 3
1680  04F2 28 21        	jr z,esp_open_direct ;для терминала
1681  04F4 DD 77 0E     	ld (ix+14),a ;тип
1682  04F7 D5           	push de ;сохранить порт
1683  04F8 11 8F 34     	ld de,esp_link_id_table+15 ;на имя сервера
1684  04FB CD C4 05     	call copyZ ;скопировать
1685  04FE 11 BB 34     	ld de,esp_link_id_table+59 ;тут адрес порта
1686  0501 E1           	pop hl
1687  0502 CD C4 05     	call copyZ
1688  0505 3A 20 2B     	ld a,(proc_id_cur)
1689  0508 DD 77 00     	ld (ix),a ;флаг занято
1690  050B DD 36 02 00  	ld (ix+2),0 ;флаг результат открытия
1691  050F DD 36 01 01  	ld (ix+1),1 ;флаг запрос на открытие
1692  0513 AF           	xor a
1693  0514 C9           	ret
1694  0515
1695  0515              esp_open_direct ;прямая связь с портом
1696  0515 3A 20 2B     	ld a,(proc_id_cur)
1697  0518 DD 77 00     	ld (ix),a ;флаг занято
1698  051B AF           	xor a
1699  051C C9           	ret
1700  051D
1701  051D              esp_open_err
1702  051D 3E FF        	ld a,255
1703  051F 37           	scf
1704  0520 C9           	ret
1705  0521
1706  0521
1707  0521
1708  0521              ;вх:
1709  0521              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1710  0521              esp_close ;закрыть соединение ESP
1711  0521 CD 5D 05     	call esp_check_err
1712  0524 D8           	ret c
1713  0525 AF           	xor a
1714  0526 DD 77 00     	ld (ix),a ;закрыть
1715  0529 C9           	ret
1716  052A
1717  052A
1718  052A
1719  052A
1720  052A              ;вх: hl - адрес данных, de - длина данных
1721  052A              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1722  052A              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено)
1723  052A              esp_send ;послать запрос ESP (CIPSEND);
1724  052A CD 5D 05     	call esp_check_err
1725  052D D8           	ret c
1726  052E D5           	push de ; длина
1727  052F C1           	pop bc
1728  0530 DD 73 09     	ld (ix+9),e  ;длина
1729  0533 DD 72 0A     	ld (ix+10),d
1730  0536 11 2D 35     	ld de,esp_buffer ;перенести данные в буфер отправки
1731  0539 ED B0        	ldir
1732  053B
1733  053B DD 36 04 00  	ld (ix+4),0 ;флаг результат отправки
1734  053F DD 36 03 01  	ld (ix+3),1 ;флаг запрос отправки
1735  0543 AF           	xor a
1736  0544 C9           	ret
1737  0545
1738  0545              esp_send_err
1739  0545 3E FF        	ld a,255
1740  0547 37           	scf
1741  0548 C9           	ret
1742  0549
1743  0549
1744  0549
1745  0549
1746  0549              ;вх: hl - адрес для данных
1747  0549              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1748  0549              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято)
1749  0549              esp_get ;получить пакет ESP (+IPD);
1750  0549 CD 5D 05     	call esp_check_err
1751  054C D8           	ret c
1752  054D DD 75 07     	ld (ix+7),l ;адрес данных
1753  0550 DD 74 08     	ld (ix+8),h ;адрес данных
1754  0553 DD 36 06 00  	ld (ix+6),0 ;флаг результат приёма
1755  0557 DD 36 05 01  	ld (ix+5),1 ;флаг запрос на приём
1756  055B AF           	xor a
1757  055C C9           	ret
1758  055D
1759  055D              ;проверка есть ли порт и кто владелец в данный момент
1760  055D              esp_check_err
1761  055D DD 21 80 34  	ld ix,esp_link_id_table
1762  0561 3A 02 2B     	ld a,(uart_enable)
1763  0564 B7           	or a
1764  0565 28 0F        	jr z,esp_check_err1 ;нет порта
1765  0567 DD 7E 00     	ld a,(ix)
1766  056A B7           	or a
1767  056B C8           	ret z ;выход без ошибки, если никем не занят
1768  056C 3A 20 2B     	ld a,(proc_id_cur) ;проверить кто владелец соединения
1769  056F DD BE 00     	cp (ix)
1770  0572 20 02        	jr nz,esp_check_err1 ;выйти с ошибкой, если буфер занят другим
1771  0574 AF           	xor a
1772  0575 C9           	ret
1773  0576              esp_check_err1
1774  0576 3E FF        	ld a,255
1775  0578 37           	scf
1776  0579 C9           	ret
1777  057A
1778  057A
1779  057A
1780  057A              ;прочитать байт из порта uart
1781  057A              ;вх:
1782  057A              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
1783  057A              ;вых: A - считанный байт
1784  057A              uart_read ;
1785  057A CD 5D 05     	call esp_check_err
1786  057D D8           	ret c
1787  057E              	;прочитать сразу, не через сетевой процесс
1788  057E 3E FD            ld a, Uart.LSR
1789  0580 DB EF            in a, (uart_port)
1790  0582 0F               rrca
1791  0583 30 06        	jr nc,uart_read_err
1792  0585 3E F8            ld a, Uart.RBR_THR
1793  0587 DB EF            in a, (uart_port)
1794  0589 B7           	or a ;сбросить флаг
1795  058A C9           	ret
1796  058B              uart_read_err
1797  058B AF           	xor a
1798  058C 37           	scf
1799  058D C9           	ret
1800  058E
1801  058E
1802  058E              ;записать байт в порт uart
1803  058E              ;вх: A -байт
1804  058E              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1805  058E              uart_write ;
1806  058E 08           	ex af,af'
1807  058F CD 5D 05     	call esp_check_err
1808  0592 D8           	ret c
1809  0593              	;записать
1810  0593 3E FD        	ld a, Uart.LSR
1811  0595 DB EF            in a, (uart_port)
1812  0597 E6 20            and #20
1813  0599 28 09            jr z,uart_write_err ;порт не готов
1814  059B 08               ex af,af'
1815  059C 06 F8        	ld b, Uart.RBR_THR
1816  059E 0E EF        	ld c, uart_port
1817  05A0 ED 79            out (c), a
1818  05A2 B7           	or a ;сбросить флаг
1819  05A3 C9           	ret
1820  05A4              uart_write_err
1821  05A4 37           	scf
1822  05A5 C9           	ret
1823  05A6
1824  05A6
1825  05A6              ;вх: a - id процесса куда копировать, hl - откуда, de - куда, bc - длина
1826  05A6              esp_buffer_copy ;скопировать принятое из буфера ESP
1827  05A6 D9           	exx
1828  05A7 21 00 2B     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1829  05AA 84           	add h
1830  05AB 67           	ld h,a
1831  05AC AF           	xor a
1832  05AD B6           	or (hl)
1833  05AE C8           	ret z
1834  05AF
1835  05AF E5           	push hl
1836  05B0 DD E1        	pop ix ;дескриптор процесса
1837  05B2              	;включить страницы целевого процесса
1838  05B2 DD 7E 02     	ld a,(ix+2)
1839  05B5 CD 8E 0B     	call drvgmx.PageSlot2
1840  05B8 DD 7E 03     	ld a,(ix+3)
1841  05BB CD AD 0A     	call drvgmx.PageSlot3
1842  05BE D9           	exx
1843  05BF
1844  05BF ED B0        	ldir
1845  05C1
1846  05C1              	;вернуть страницы
1847  05C1 C3 CB 02     	jp page_cur_return
1848  05C4
1849  05C4
1850  05C4
1851  05C4
1852  05C4              ;вх: hl - откуда de - куда
1853  05C4              copyZ ;копировать данные до кода 0
1854  05C4 7E           	ld a,(hl)
1855  05C5 B7           	or a
1856  05C6 28 05        	jr z,copyZ_ex
1857  05C8 12           	ld (de),a
1858  05C9 13           	inc de
1859  05CA 23           	inc hl
1860  05CB 18 F7        	jr copyZ
1861  05CD              copyZ_ex
1862  05CD AF           	xor a
1863  05CE 12           	ld (de),a  ;в конце 0
1864  05CF C9           	ret
1865  05D0
1866  05D0
1867  05D0
1868  05D0              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
1869  05D0              				;на входе в HL число
1870  05D0 11 10 27     			ld de,10000 ;десятки тысяч
1871  05D3 3E FF        			ld a,255
1872  05D5              toDecimal10k
1873  05D5 A7           			and a
1874  05D6 ED 52        			sbc hl,de
1875  05D8 3C           			inc a
1876  05D9 30 FA        			jr nc,toDecimal10k
1877  05DB 19           			add hl,de
1878  05DC C6 30        			add a,48
1879  05DE 32 26 06     			ld (decimalS),a
1880  05E1 11 E8 03     			ld de,1000 ;тысячи
1881  05E4 3E FF        			ld a,255
1882  05E6              toDecimal1k
1883  05E6 A7           			and a
1884  05E7 ED 52        			sbc hl,de
1885  05E9 3C           			inc a
1886  05EA 30 FA        			jr nc,toDecimal1k
1887  05EC 19           			add hl,de
1888  05ED C6 30        			add a,48
1889  05EF 32 27 06     			ld (decimalS+1),a
1890  05F2 11 64 00     			ld de,100 ;сотни
1891  05F5 3E FF        			ld a,255
1892  05F7              toDecimal01k
1893  05F7 A7           			and a
1894  05F8 ED 52        			sbc hl,de
1895  05FA 3C           			inc a
1896  05FB 30 FA        			jr nc,toDecimal01k
1897  05FD 19           			add hl,de
1898  05FE C6 30        			add a,48
1899  0600 32 28 06     			ld (decimalS+2),a
1900  0603 11 0A 00     			ld de,10 ;десятки
1901  0606 3E FF        			ld a,255
1902  0608              toDecimal001k
1903  0608 A7           			and a
1904  0609 ED 52        			sbc hl,de
1905  060B 3C           			inc a
1906  060C 30 FA        			jr nc,toDecimal001k
1907  060E 19           			add hl,de
1908  060F C6 30        			add a,48
1909  0611 32 29 06     			ld (decimalS+3),a
1910  0614 11 01 00     			ld de,1 ;единицы
1911  0617 3E FF        			ld a,255
1912  0619              toDecimal0001k
1913  0619 A7           			and a
1914  061A ED 52        			sbc hl,de
1915  061C 3C           			inc a
1916  061D 30 FA        			jr nc,toDecimal0001k
1917  061F 19           			add hl,de
1918  0620 C6 30        			add a,48
1919  0622 32 2A 06     			ld (decimalS+4),a
1920  0625
1921  0625 C9           			ret
1922  0626 00 00 00...  decimalS ds 6 ;здесь будет цифра
1923  062C
1924  062C
1925  062C
1926  062C
1927  062C              ;передача управления ОС до следующего прерывания;
1928  062C              os_wait ;
1929  062C F5           	push af
1930  062D C5           	push bc
1931  062E D5           	push de
1932  062F E5           	push hl
1933  0630 D9           	exx
1934  0631 08           	ex af,af'
1935  0632 F5           	push af
1936  0633 C5           	push bc
1937  0634 D5           	push de
1938  0635 E5           	push hl
1939  0636 DD E5        	push ix
1940  0638 FD E5        	push iy
1941  063A ED 73 0A 2B  	ld (proc_stack_addr_tmp_wait),sp ;запомнить адрес стека
1942  063E 3E 01        	ld a,1
1943  0640 32 0C 2B     	ld (os_wait_flag),a ;флаг внеочередная смена процесса
1944  0643 3A 20 2B     	ld a,(proc_id_cur)
1945  0646 CD AE 06     	call get_proc_descr
1946  0649 DD 36 1D 01  	ld (ix+#1d),1 ;флаг что процесс запросил os_wait
1947  064D C3 E3 07     	jp proc_next_wait ;на следующий процесс
1948  0650
1949  0650
1950  0650
1951  0650              ;закрыть процесс
1952  0650              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
1953  0650              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
1954  0650              proc_close
1955  0650 B7           	or a
1956  0651 20 03        	jr nz,proc_close_skip
1957  0653 3A 20 2B     	ld a,(proc_id_cur) ;текущий
1958  0656              proc_close_skip
1959  0656 FE 09        	cp proc_max+1 ;защита
1960  0658 D0           	ret nc
1961  0659 32 AD 06     	ld (proc_close_id_tmp),a ;запомнить
1962  065C
1963  065C 21 07 2B     	ld hl,proc_id_focus ;если он был в фокусе
1964  065F BE           	cp (hl)
1965  0660 20 05        	jr nz,proc_close_skip3
1966  0662 3E 01        	ld a,1
1967  0664 CD 37 02     	call proc_set_focus ;сменить фокус на системный процесс
1968  0667
1969  0667              proc_close_skip3
1970  0667              ;очистить таблицу процессов
1971  0667 3A AD 06     	ld a,(proc_close_id_tmp)
1972  066A CD AE 06     	call get_proc_descr
1973  066D 54           	ld d,h
1974  066E 5D           	ld e,l
1975  066F 13           	inc de
1976  0670 36 00        	ld (hl),0
1977  0672 01 FF 00     	ld bc,proc_descr_size-1
1978  0675 ED B0        	ldir
1979  0677
1980  0677              ;очистить таблицу памяти
1981  0677 3A AD 06     	ld a,(proc_close_id_tmp)
1982  067A CD 17 02     	call proc_clear_ram
1983  067D
1984  067D              ;очистить таблицу файлов FAT
1985  067D 3A AD 06     	ld a,(proc_close_id_tmp)
1986  0680 CD C9 0D     	call Dos.fclose_proc_all
1987  0683
1988  0683              ;очистить таблицу соединений ESP
1989  0683 3A AD 06     	ld a,(proc_close_id_tmp)
1990  0686 21 80 34     	ld hl,esp_link_id_table
1991  0689 BE           	cp (hl) ;id процесса совпадает?
1992  068A 20 0A        	jr nz,proc_close_skip2
1993  068C 54           	ld d,h
1994  068D 5D           	ld e,l
1995  068E 13           	inc de
1996  068F 01 3F 00     	ld bc,esp_link_id_table_size_item-1
1997  0692 36 00        	ld (hl),0 ;очистить
1998  0694 ED B0        	ldir
1999  0696              proc_close_skip2
2000  0696
2001  0696              ;остановить плеер
2002  0696 3A AD 06     	ld a,(proc_close_id_tmp)
2003  0699 21 03 2B     	ld hl,proc_play_ay
2004  069C BE           	cp (hl)
2005  069D 20 03        	jr nz,proc_close_skip4
2006  069F CD 67 04     	call set_VTPL_MUTE
2007  06A2
2008  06A2              proc_close_skip4
2009  06A2
2010  06A2              ;выход
2011  06A2 3A AD 06     	ld a,(proc_close_id_tmp)
2012  06A5 21 20 2B     	ld hl,proc_id_cur
2013  06A8 BE           	cp (hl)
2014  06A9 C0           	ret nz ;выйти если вызывал не сам процесс
2015  06AA
2016  06AA C3 2C 06     	jp os_wait ;если вызывал закрытие сам процесс, то сразу переключиться на следующий
2017  06AD 00           proc_close_id_tmp db 0 ;временно
2018  06AE
2019  06AE
2020  06AE
2021  06AE
2022  06AE
2023  06AE              ;получить дескриптор процесса (адрес в таблице процессов)
2024  06AE              ;вх: A - id процесса
2025  06AE              ;вых: HL, IX - дескриптор
2026  06AE              get_proc_descr
2027  06AE 21 00 2B     	ld hl,proc_table - 256
2028  06B1 84           	add h
2029  06B2 67           	ld h,a
2030  06B3 E5           	push hl
2031  06B4 DD E1        	pop ix ;дескриптор
2032  06B6 C9           	ret
2033  06B7
2034  06B7
2035  06B7
2036  06B7              ;выбор функции (вызова)
2037  06B7              function
2038  06B7 08           	ex af,af'
2039  06B8 79           	ld a,c
2040  06B9 FE 2A        	cp function_max ;проверка на общее количество
2041  06BB 38 05        	jr c,function1
2042  06BD              function_no
2043  06BD 08           	ex af,af'
2044  06BE 3E FF        	ld a,255 ;??????
2045  06C0 37           	scf
2046  06C1 C9           	ret
2047  06C2              function1
2048  06C2 D9           	exx
2049  06C3 6F           	ld l,a
2050  06C4 26 00        	ld h,0
2051  06C6 29           	add hl,hl ;*2
2052  06C7 01 D6 06     	ld bc,function_table
2053  06CA 09           	add hl,bc
2054  06CB 5E           	ld e,(hl)
2055  06CC 23           	inc hl
2056  06CD 56           	ld d,(hl)
2057  06CE 7B           	ld a,e ;временно проверка есть ли такая функция
2058  06CF B2           	or d
2059  06D0 28 EB        	jr z,function_no ;-^
2060  06D2 D5           	push de
2061  06D3 D9           	exx
2062  06D4 08           	ex af,af'
2063  06D5 C9           	ret ;перейти по адресу функции
2064  06D6
2065  06D6
2066  06D6              function_table ;таблица функций
2067  06D6 0A 09        	dw drvgmx.cls  ; #00 (0 dec) - очистить консоль;
2068  06D8 46 09        	dw drvgmx.gotoXY ; #01 (1 dec) - установить позицию курсора в консоли
2069  06DA BC 09        	dw drvgmx.putC ; #02 (2 dec) - печать символа в консоль;
2070  06DC 57 09        	dw drvgmx.fillLine ; #03 (3 dec) - заполнение строки одним символом
2071  06DE 71 09        	dw drvgmx.paintLine ; #04 (4 dec) - покрасить строку цветом
2072  06E0 00 00        	dw 0 ;#05 (5 dec) -
2073  06E2 CE 0A        	dw drvgmx.set_color ;#06 (6 dec) - установить цвет текста в консоли
2074  06E4 00 00        	dw 0 ;#07 (7 dec) - ;
2075  06E6 00 00        	dw 0 ;#08 (8 dec) - ;
2076  06E8 B1 09        	dw drvgmx.printZ ; #09 (9 dec) - печать в консоль до кода 0
2077  06EA 7A 05        	dw uart_read ;#0A (10 dec) - прочитать байт из порта uart
2078  06EC 8E 05        	dw uart_write ;#0B (11 dec) - записать байт в порт uart
2079  06EE 21 05        	dw esp_close ;#0C (12 dec) - закрыть соединение ESP
2080  06F0 EA 04        	dw esp_open ;#0D (13 dec) - установить соединение ESP (CIPSTART);
2081  06F2 2A 05        	dw esp_send ;#0E (14 dec) - послать запрос ESP (CIPSEND);
2082  06F4 49 05        	dw esp_get ;#0F (15 dec) - получить пакет ESP (+IPD);
2083  06F6 C8 03        	dw get_c ;#10 (16 dec) - получить код нажатой клавиши;
2084  06F8 D8 02        	dw proc_run ;#11 (17 dec) - запустить процесс;
2085  06FA 37 02        	dw proc_set_focus ;#12 (18 dec) - установить фокус;
2086  06FC 50 06        	dw proc_close ;#13 (19 dec)-закрыть процесс;
2087  06FE D6 04        	dw set_interrupt ;#14 (20 dec) - установка адреса обработчика прерываний процесса;
2088  0700 72 16        	dw VTPL.INIT ;#15 (21 dec) - инициализация плеера AY;
2089  0702 54 04        	dw set_VTPL_PLAY ;#16 (22 dec) - запустить плеер AY;
2090  0704 67 04        	dw set_VTPL_MUTE ;#17 (23 dec) - заглушить плеер AY;
2091  0706 6E 04        	dw get_VTPL_SETUP ;#18 (24 dec) - получить значение переменной плеера;
2092  0708 E5 03        	dw page_copy ;#19 (25 dec) - скопировать данные из страницы в страницу
2093  070A FE 01        	dw proc_find_ram ;#1A (26 dec) - получить дополнительную страницу памяти;
2094  070C A8 04        	dw set_page_slot2 ;#1B (27 dec) - включить страницу в слот 2 (#8000);
2095  070E BF 04        	dw set_page_slot3 ;#1C (28 dec) - включить страницу в слот 3 (#c000);
2096  0710 7B 04        	dw set_scr ;#1D (29 dec) - включить экран N;
2097  0712 72 04        	dw get_proc_page ;#1E (30 dec) - получить номера страниц процесса;
2098  0714 DD 03        	dw get_timer ;#1F (31 dec) - получить значение системного таймера
2099  0716 00 00        	dw 0 ;#20 (32 dec) - ;инициализация?
2100  0718 21 0C        	dw Dos.fopen_r ;#21 (33 dec) - открыть файл для чтения или записи;
2101  071A 47 0C        	dw Dos.fopen_c ;#22 (34 dec) - создать файл;
2102  071C E0 0D        	dw Dos.fread ;#23 (35 dec) - прочитать из файла;
2103  071E FC 0D        	dw Dos.fwrite ;#24 (36 dec) - записать в файл;
2104  0720 A6 0D        	dw Dos.fclose ;#25 (37 dec) - закрыть файл;
2105  0722 42 0E        	dw Dos.read_dir ;#26 (38 dec) - чтение секторов текущего каталога
2106  0724 57 0E        	dw Dos.open_dir ;#27 (39 dec) - вход в каталог/выход в родительский каталог
2107  0726 00 00        	dw 0 ;#28 (40 dec) -
2108  0728 00 00        	dw 0 ;#29 (41 dec) - ;
2109  072A
2110  072A
2111  072A
2112  072A 00 00 00...  	align 16
2113  0730              ;обработчик прерываний
2114  0730              Interrupts
2115  0730 F3           	di
2116  0731 E3           	ex (sp),hl
2117  0732 22 0E 2B     	ld (proc_stack_addr_return_tmp),hl ;запомнить откуда вызвали прерывание
2118  0735 E3           	ex (sp),hl
2119  0736 F5           	push af
2120  0737 C5           	push bc
2121  0738 D5           	push de
2122  0739 E5           	push hl
2123  073A D9           	exx
2124  073B 08           	ex af,af'
2125  073C F5           	push af
2126  073D C5           	push bc
2127  073E D5           	push de
2128  073F E5           	push hl
2129  0740 DD E5        	push ix
2130  0742 FD E5        	push iy
2131  0744 ED 73 08 2B  	ld (proc_stack_addr_tmp),sp ;запомнить адрес стека
2132  0748              	; ld a,1
2133  0748              	; out (254),a
2134  0748
2135  0748 3E 01        	ld a,1
2136  074A 32 01 2B     	ld (Interrupt_new_flag),a ;флаг что было новое прерывание
2137  074D              	;сбросить флаги os_wait, потому что произошло обычное прерывание
2138  074D AF           	xor a
2139  074E 21 1D 2C     	ld hl,proc_table+#1d
2140  0751 77           	ld (hl),a
2141  0752 24           	inc h
2142  0753 77           	ld (hl),a
2143  0754 24           	inc h
2144  0755 77           	ld (hl),a
2145  0756 24           	inc h
2146  0757 77           	ld (hl),a
2147  0758 24           	inc h
2148  0759 77           	ld (hl),a
2149  075A 24           	inc h
2150  075B 77           	ld (hl),a
2151  075C 24           	inc h
2152  075D 77           	ld (hl),a
2153  075E 24           	inc h
2154  075F 77           	ld (hl),a
2155  0760
2156  0760
2157  0760
2158  0760              ;таймер
2159  0760 2A 21 2B     	ld hl,(sys_timer)
2160  0763 23           	inc hl
2161  0764 22 21 2B     	ld (sys_timer),hl
2162  0767 7C           	ld a,h
2163  0768 B5           	or l
2164  0769 20 07        	jr nz,Interrupts_timer
2165  076B 2A 23 2B     	ld hl,(sys_timer+2)
2166  076E 23           	inc hl
2167  076F 22 23 2B     	ld (sys_timer+2),hl
2168  0772              Interrupts_timer
2169  0772
2170  0772
2171  0772              ;опрос клавиатуры
2172  0772 CD 23 13     	call @DriverKeyboard
2173  0775 22 15 2B     	ld (FlgScanKeys_addr),hl ;адрес переменной
2174  0778 CB 76        	bit 6,(hl)
2175  077A 20 03        	jr nz,Interrupts_key1 ;если не нажата ни одна
2176  077C 32 1B 2B     	ld (key_cur),a ;запомнить клавишу
2177  077F              Interrupts_key1
2178  077F
2179  077F FE 1B        	cp proc_switch_key ;если клавиша переключения задач
2180  0781 20 03        	jr nz,Interrupts_key_switch_no
2181  0783 32 10 2B     	ld (key_proc_switch_flag),a ;сохранить нажатие
2182  0786              Interrupts_key_switch_no
2183  0786
2184  0786 FE 07        	cp DrvKey.keyEdit
2185  0788 20 05        	jr nz,Interrupts_key2
2186  078A              	;переключение языка
2187  078A 32 11 2B     	ld (key_lang_flag),a
2188  078D 18 17        	jr Interrupts_key_ex
2189  078F              Interrupts_key2
2190  078F FE 06        	cp DrvKey.keyCaps
2191  0791 20 05        	jr nz,Interrupts_key3
2192  0793              	;переключение заглавных
2193  0793 32 12 2B     	ld (key_caps_lock_switch_flag),a
2194  0796 18 0E        	jr Interrupts_key_ex
2195  0798              Interrupts_key3
2196  0798 FE 0F        	cp DrvKey.keyDelete
2197  079A 20 03        	jr nz,Interrupts_key4
2198  079C              	;графическая
2199  079C 32 13 2B     	ld (key_graph_flag),a
2200  079F
2201  079F              Interrupts_key4
2202  079F FE 12        	cp 18
2203  07A1 20 03        	jr nz,Interrupts_key_ex
2204  07A3              	;sys процесс в фокус
2205  07A3 32 14 2B     	ld (key_sys_focus),a
2206  07A6
2207  07A6
2208  07A6
2209  07A6              Interrupts_key_ex
2210  07A6              	;с клавиатурой всё
2211  07A6
2212  07A6
2213  07A6
2214  07A6
2215  07A6
2216  07A6              ;определить текущие страницы памяти
2217  07A6 01 FD 7A     	ld bc,#7AFD
2218  07A9 ED 78        	in a,(c)
2219  07AB E6 7F        	and %01111111
2220  07AD 32 06 09     	ld (Interrupts_cur_page_slot3),a
2221  07B0 01 FD 78     	ld bc,#78fd
2222  07B3 ED 78        	in a,(c)
2223  07B5 EE 02        	xor %00000010
2224  07B7 32 05 09     	ld (Interrupts_cur_page_slot2),a
2225  07BA
2226  07BA
2227  07BA
2228  07BA
2229  07BA              ;плеер музыки и прочие неотложные процессы
2230  07BA 3A 03 2B     	ld a,(proc_play_ay)
2231  07BD B7           	or a
2232  07BE 28 1B        	jr z,Interrupts_ay_skip
2233  07C0 3A 04 2B     	ld a,(proc_play_ay_slot2) ;страницы с музыкой
2234  07C3 CD 8E 0B     	call drvgmx.PageSlot2
2235  07C6 3A 05 2B     	ld a,(proc_play_ay_slot3) ;страницы с музыкой
2236  07C9 CD AD 0A     	call drvgmx.PageSlot3
2237  07CC CD 95 1E     	call VTPL.PLAY ;играть
2238  07CF
2239  07CF
2240  07CF              ;вернуть страницы
2241  07CF 3A 05 09     	ld a,(Interrupts_cur_page_slot2)
2242  07D2 CD 8E 0B     	call drvgmx.PageSlot2
2243  07D5 3A 06 09     	ld a,(Interrupts_cur_page_slot3)
2244  07D8 CD AD 0A     	call drvgmx.PageSlot3
2245  07DB
2246  07DB
2247  07DB              Interrupts_ay_skip
2248  07DB
2249  07DB
2250  07DB
2251  07DB
2252  07DB
2253  07DB
2254  07DB
2255  07DB
2256  07DB              ;многозадачность тут
2257  07DB 3A 0F 2B     	ld a,(proc_stack_addr_return_tmp+1) ;узнать адрес откуда были прерывания
2258  07DE FE 40        	cp #40 ;если прерывание было в области пзу, значит работала система
2259  07E0 DA 82 08     	jp c,Interrupts_ex ;пропустим переключения на другие задачи
2260  07E3
2261  07E3              proc_next_wait	;сюда приходит после вызова OS_WAIT, мимо обработки прерывания по INT
2262  07E3 CD 98 08     	call proc_next_find
2263  07E6              	;jp c,Interrupts_ex ;если процесс один, то на выход
2264  07E6
2265  07E6              	; push hl ;дескриптор следующего
2266  07E6              	; pop ix
2267  07E6
2268  07E6
2269  07E6              	;запомнить стек предыдущего (текущего) процесса
2270  07E6 3A 20 2B     	ld a,(proc_id_cur)
2271  07E9 21 00 2B     	ld hl,proc_table - 256
2272  07EC 84           	add h
2273  07ED 67           	ld h,a
2274  07EE E5           	push hl
2275  07EF FD E1        	pop iy ;дескриптор предыдущего
2276  07F1
2277  07F1 01 06 00     	ld bc,6
2278  07F4 09           	add hl,bc
2279  07F5 ED 4B 08 2B  	ld bc,(proc_stack_addr_tmp)
2280  07F9 3A 0C 2B     	ld a,(os_wait_flag)
2281  07FC B7           	or a
2282  07FD 28 08        	jr z,proc_next_wait_no
2283  07FF ED 4B 0A 2B  	ld bc,(proc_stack_addr_tmp_wait) ;если в режиме вызова os_wait
2284  0803 AF           	xor a
2285  0804 32 0C 2B     	ld (os_wait_flag),a
2286  0807              proc_next_wait_no
2287  0807 71           	ld (hl),c
2288  0808 23           	inc hl
2289  0809 70           	ld (hl),b
2290  080A
2291  080A              	;запомнить координаты экрана предыдущего
2292  080A 2A CA 0B     	ld hl,(drvgmx.col_screen)
2293  080D FD 75 0A FD  	ld (iy+#0a),hl ;координаты
2293  0811 74 0B
2294  0813
2295  0813 2A CC 0B     	ld hl,(drvgmx.attr_screen)
2296  0816 FD 75 0C FD  	ld (iy+#0c),hl ;атрибуты (цвет текста)
2296  081A 74 0D
2297  081C
2298  081C 2A 9E 0A     	ld hl,(drvgmx.curscrl)
2299  081F FD 75 08 FD  	ld (iy+#08),hl ;позиция скрола
2299  0823 74 09
2300  0825
2301  0825
2302  0825
2303  0825              	;следующий
2304  0825 DD 7E 02     	ld a,(ix+2)
2305  0828 32 18 2B     	ld (page_slot2_cur),a ;сделать страницы текущими
2306  082B CD 8E 0B     	call drvgmx.PageSlot2
2307  082E DD 7E 03     	ld a,(ix+3)
2308  0831 32 17 2B     	ld (page_slot3_cur),a
2309  0834 CD AD 0A     	call drvgmx.PageSlot3
2310  0837
2311  0837
2312  0837              	;параметры экрана (консоли)
2313  0837 DD 6E 0A DD  	ld hl,(ix+#0a) ;координаты
2313  083B 66 0B
2314  083D 22 CA 0B     	ld (drvgmx.col_screen),hl
2315  0840
2316  0840 DD 6E 0C DD  	ld hl,(ix+#0c) ;атрибуты (цвет текста)
2316  0844 66 0D
2317  0846 22 CC 0B     	ld (drvgmx.attr_screen),hl
2318  0849
2319  0849 DD 6E 08 DD  	ld hl,(ix+#08) ;позиция скрола
2319  084D 66 09
2320  084F 22 9E 0A     	ld (drvgmx.curscrl),hl
2321  0852
2322  0852
2323  0852
2324  0852 3A 07 2B     	ld a,(proc_id_focus) ;если это процесс в фокусе
2325  0855 DD BE 00     	cp (ix)
2326  0858 20 0C        	jr nz,proc_next_no_focus
2327  085A 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
2328  085C 32 19 2B     	ld (con_scr_cur),a
2329  085F 3E 79        	ld a,con_atr_real ;атрибуты реальные
2330  0861 32 1A 2B     	ld (con_atr_cur),a
2331  0864 18 0C        	jr proc_next2
2332  0866              proc_next_no_focus
2333  0866              	;если не в фокусе
2334  0866 DD 7E 04     	ld a,(ix+4) ;пиксели
2335  0869 32 19 2B     	ld (con_scr_cur),a
2336  086C DD 7E 05     	ld a,(ix+5) ;атрибуты
2337  086F 32 1A 2B     	ld (con_atr_cur),a
2338  0872              proc_next2
2339  0872 DD 6E 06     	ld l,(ix+6) ;стек
2340  0875 DD 66 07     	ld h,(ix+7) ;стек
2341  0878 F9           	ld sp,hl
2342  0879
2343  0879 3A 1D 2B     	ld a,(proc_id_next)
2344  087C 32 20 2B     	ld (proc_id_cur),a ;сменить текущий
2345  087F
2346  087F CD 95 0A     	call drvgmx.gmxscroll ;обновить скролл
2347  0882
2348  0882              Interrupts_ex
2349  0882 AF           	xor a
2350  0883 D3 FE        	out (254),a
2351  0885 32 01 2B     	ld (Interrupt_new_flag),a ;флаг что было прерывание убрать
2352  0888 FD E1        	pop iy
2353  088A DD E1        	pop ix
2354  088C E1           	pop hl
2355  088D D1           	pop de
2356  088E C1           	pop bc
2357  088F F1           	pop af
2358  0890 D9           	exx
2359  0891 08           	ex af,af
2360  0892 E1           	pop hl
2361  0893 D1           	pop de
2362  0894 C1           	pop bc
2363  0895 F1           	pop af
2364  0896 FB           	ei
2365  0897 C9           	ret
2366  0898
2367  0898
2368  0898              	;поиск следующей задачи
2369  0898              	;вых: hl, ix - дескриптор следующего процесса
2370  0898              proc_next_find
2371  0898 3A 01 2B     	ld a,(Interrupt_new_flag) ;флаг только что было прерывание
2372  089B B7           	or a
2373  089C 28 14        	jr z,proc_next_find_no_interrupt
2374  089E              	;тут попытка первым после прерывания запустить процесс в фокусе
2375  089E 3A 00 2B     	ld a,(proc_next_find_focus_flag)
2376  08A1 B7           	or a
2377  08A2 20 0E        	jr nz,proc_next_find_no_interrupt ;пропустить, если уже запускали недавно, по всем процессам не прошлись
2378  08A4 3A 07 2B     	ld a,(proc_id_focus)
2379  08A7 32 00 2B     	ld (proc_next_find_focus_flag),a ;флаг что процесс в фокусе уже запускали
2380  08AA 32 1D 2B     	ld (proc_id_next),a
2381  08AD CD AE 06     	call get_proc_descr ;получить дескриптор
2382  08B0 B7           	or a
2383  08B1 C9           	ret ;запустить его
2384  08B2
2385  08B2              proc_next_find_no_interrupt
2386  08B2 3A 1D 2B     	ld a,(proc_id_next) ;узнать следующий
2387  08B5              proc_next_find_skip
2388  08B5 3C           	inc a
2389  08B6 FE 09        	cp proc_max+1
2390  08B8 38 02        	jr c,proc_next_find1
2391  08BA 3E 01        	ld a,proc_id_system
2392  08BC              proc_next_find1
2393  08BC 32 1D 2B     	ld (proc_id_next),a
2394  08BF
2395  08BF CD AE 06     	call get_proc_descr ;получить дескриптор
2396  08C2
2397  08C2 DD 7E 00     	ld a,(ix)
2398  08C5 B7           	or a ;нет активного процесса?
2399  08C6 28 D0        	jr z,proc_next_find ;искать дальше
2400  08C8
2401  08C8 3A 07 2B     	ld a,(proc_id_focus)
2402  08CB DD BE 00     	cp (ix)
2403  08CE 20 04        	jr nz,proc_next_find2 ;если не в фокусе
2404  08D0 AF           	xor a ;сбросить флаг, все процессы по кругу прошли
2405  08D1 32 00 2B     	ld (proc_next_find_focus_flag),a
2406  08D4
2407  08D4              proc_next_find2
2408  08D4 DD 7E 00     	ld a,(ix)
2409  08D7 FE 01        	cp 1 ;системный процесс? для него исключение, можно вызывать всегда
2410  08D9 C8           	ret z
2411  08DA
2412  08DA 3A 07 2B     	ld a,(proc_id_focus)
2413  08DD DD BE 00     	cp (ix)	;если в фокусе
2414  08E0 28 B6        	jr z,proc_next_find ;искать дальше. потому что для процесса в фокусе отдельный приоритет
2415  08E2
2416  08E2
2417  08E2              	;дополнительные проверки
2418  08E2 3A 0D 2B     	ld a,(proc_next_find_skip_flag)
2419  08E5 B7           	or a
2420  08E6 20 14        	jr nz,proc_next_find_skip_flag_yep ;пропустить дополнительные
2421  08E8
2422  08E8              	;проверить было ли прерывание, чтобы не вызвать процесс второй раз
2423  08E8 DD 7E 1D     	ld a,(ix+#1d) ;флаг вызова os_wait этого процесса
2424  08EB B7           	or a
2425  08EC 20 AA        	jr nz,proc_next_find ;искать дальше
2426  08EE
2427  08EE
2428  08EE              	;проверить графический режим
2429  08EE DD 7E 1C     	ld a,(ix+#1c) ;режим
2430  08F1 B7           	or a
2431  08F2 28 08        	jr z,proc_next_find_no_graph ;не графический
2432  08F4              	;графический
2433  08F4 3A 07 2B     	ld a,(proc_id_focus)
2434  08F7 DD BE 00     	cp (ix)
2435  08FA 20 9C        	jr nz,proc_next_find ;искать дальше, если он не в фокусе
2436  08FC
2437  08FC              proc_next_find_no_graph
2438  08FC
2439  08FC              proc_next_find_skip_flag_yep
2440  08FC              	;нашли следующий процесс
2441  08FC 3A 20 2B     	ld a,(proc_id_cur)
2442  08FF BE           	cp (hl) ;если это он и был (всего один процесс)
2443  0900 37           	scf
2444  0901 C8           	ret z
2445  0902 7E           	ld a,(hl) ;или вернуть id слудующего
2446  0903 B7           	or a
2447  0904 C9           	ret
2448  0905
2449  0905 00           Interrupts_cur_page_slot2 db 0 ;временно
2450  0906 00           Interrupts_cur_page_slot3 db 0 ;временно
2451  0907
2452  0907
2453  0907
2454  0907
2455  0907
2456  0907              	include Drv/zsgmx.asm ;драйвер экрана и памяти
# file opened: Drv/zsgmx.asm
   1+ 0907              COLOR=1
   2+ 0907              ;; ZS GMX screen driver (izzx)
   3+ 0907              	define LINE_LIMIT 80
   4+ 0907                  module drvgmx
   5+ 0907              hsize   equ 25 ;всего строк
   6+ 0907              scraddr equ #c000 ;адрес экрана
   7+ 0907              scrsize equ 16000  ;размер экрана
   8+ 0907              scrline equ 80*8   ;размер строки в байтах
   9+ 0907
  10+ 0907              init:
  11+ 0907                  ; ld hl, font_file, b, Dos.FMODE_READ
  12+ 0907                  ; call Dos.fopen
  13+ 0907                  ; push af
  14+ 0907                  ; ld bc, 2048, hl, font
  15+ 0907                  ; call Dos.fread
  16+ 0907                  ; pop af
  17+ 0907                  ; call Dos.fclose
  18+ 0907              	; xor a : out (#fe), a
  19+ 0907              	; call cls
  20+ 0907              	; ret
  21+ 0907 CD F2 0A     	call set_scr39 ;включить экран
  22+ 090A              cls:
  23+ 090A 11 00 00         ld de, 0
  23+ 090D
  24+ 090D ED 53 9E 0A  	ld (curscrl),de ;скролл выключить
  25+ 0911 CD 95 0A     	call gmxscroll
  26+ 0914 11 00 00         ld de, 0
  26+ 0917
  27+ 0917 CD 46 09     	call gotoXY
  28+ 091A                  ;ld a, 7 : call Memory.setPage
  29+ 091A 3A 19 2B     	ld a,(con_scr_cur) ;пиксели
  30+ 091D CD AD 0A     	call PageSlot3 ;включить страницу пикселей
  31+ 0920 AF               xor a
  31+ 0921               ; out (#fe), a
  32+ 0921 21 00 C0 11      ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  32+ 0925 01 C0 01 7F
  32+ 0929 3E 77
  32+ 092B ED B0          ldir ;очистить
  33+ 092D 3A 1A 2B     	ld a,(con_atr_cur) ;атрибуты
  34+ 0930 CD AD 0A     	call PageSlot3 ;включить страницу атрибутов
  35+ 0933 AF           	xor a ;ld a,(attr_screen) ;цвет
  36+ 0934 21 00 C0 11  	ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  36+ 0938 01 C0 01 7F
  36+ 093C 3E 77
  36+ 093E ED B0          ldir ;очистить
  37+ 0940              	;call gmxscron ;включить расширенный экран
  38+ 0940 3A 17 2B     	ld a,(page_slot3_cur)
  39+ 0943 C3 AD 0A     	jp PageSlot3 ;вернуть страницу
  40+ 0946                  ;jp Memory.setPage
  41+ 0946
  42+ 0946
  43+ 0946              ; Set console coordinates
  44+ 0946              ; d = row(0..23), e = column (0..79)
  45+ 0946              gotoXY:
  46+ 0946              	;rr e
  47+ 0946              	; ld a, 0
  48+ 0946              	; ld (half_tile_screen), a
  49+ 0946 7A           	ld a,d ;проверка координаты строки
  50+ 0947 FE 19        	cp hsize
  51+ 0949 D0           	ret nc
  52+ 094A 7B           	ld a,e ;проверка координаты столбца
  53+ 094B FE 50        	cp 80
  54+ 094D D0           	ret nc
  55+ 094E ED 53 CA 0B      ld (col_screen), de
  56+ 0952 C9               ret
  57+ 0953
  58+ 0953              disable:
  59+ 0953                  ; Nothing to disable
  60+ 0953 CD 6B 0A     	call gmxscroff ;выключить расширенный экран
  61+ 0956 C9               ret
  62+ 0957
  63+ 0957              ; H - line
  64+ 0957              ; A - char
  65+ 0957              fillLine: ;заполнение строки одним символом
  66+ 0957 F5               push af
  67+ 0958 54 1E 00         ld d, h, e, 0
  67+ 095B CD 46 09       call gotoXY
  68+ 095E F1               pop af
  69+ 095F 21 D0 0B 11      ld hl, fill_buff, de, fill_buff + 1, bc, 80-1, (hl), a
  69+ 0963 D1 0B 01 4F
  69+ 0967 00 77
  69+ 0969 ED B0          ldir
  70+ 096B 21 D0 0B         ld hl, fill_buff
  70+ 096E C3 B1 09       jp printZ
  71+ 0971
  72+ 0971              paintLine: ;на входе в A номер строки, которую надо покрасить, B - цвет
  73+ 0971 C5           	push bc
  74+ 0972 47               ld b, a
  75+ 0973 0E 00            ld c, 0
  76+ 0975 CD 21 0A         call bc_to_attr
  77+ 0978 E5           	push hl
  78+ 0979 3A 1A 2B     	ld a,(con_atr_cur) ;атрибуты
  79+ 097C CD AD 0A     	call PageSlot3
  80+ 097F E1           	pop hl
  81+ 0980 C1           	pop bc
  82+ 0981 78           	ld a,b;цвет
  83+ 0982 77               ld (hl), a
  84+ 0983 54 5D            ld de, hl
  85+ 0985 13               inc de
  86+ 0986 01 7F 02         ld bc, (80*8)-1
  87+ 0989 ED B0            ldir
  88+ 098B 3A 17 2B         ld a,(page_slot3_cur)
  89+ 098E C3 AD 0A     	jp PageSlot3 ;вернуть страницу
  90+ 0991
  91+ 0991
  92+ 0991              mvCR ;каретка вниз (по коду 13)
  93+ 0991 ED 5B CA 0B  	ld de, (col_screen)
  94+ 0995 14           	inc d ;row++
  95+ 0996 7A           	ld a,d
  96+ 0997 FE 19        	cp hsize ;последняя строка
  97+ 0999 38 11        	jr c,mvCR1
  98+ 099B 3A 19 2B     	ld a,(con_scr_cur) ;пиксели
  99+ 099E CD AD 0A     	call PageSlot3 ;включить страницу пикселей
 100+ 09A1 CD 73 0A     	call scroll
 101+ 09A4 3A 17 2B     	ld a,(page_slot3_cur)
 102+ 09A7 CD AD 0A     	call PageSlot3 ;вернуть страницу
 103+ 09AA 16 18        	ld d,hsize-1 ;остаться на последне строке
 104+ 09AC              mvCR1
 105+ 09AC 1E 00        	ld e, 0
 106+ 09AE              	; ld a, 0
 107+ 09AE              	; ld (half_tile_screen), a
 108+ 09AE C3 46 09     	jp gotoXY
 109+ 09B1
 110+ 09B1              ; Print just one symbol
 111+ 09B1              ; A - symbol
 112+ 09B1              ; putC
 113+ 09B1               	; ld hl, single_symbol_print ;single_symbol
 114+ 09B1              	; ld (hl), a
 115+ 09B1              	; ;ld a, 7 : call Memory.setPage
 116+ 09B1              	; ; ld a,(con_scr_cur) ;пиксели
 117+ 09B1              	; ; call PageSlot3
 118+ 09B1                  ; ld hl, single_symbol_print
 119+ 09B1                  ; call printL
 120+ 09B1                  ; ld a,(page_slot3_cur)
 121+ 09B1              	; jp PageSlot3 ;вернуть страницу
 122+ 09B1
 123+ 09B1              ; Put string
 124+ 09B1              ; hl - string pointer that's begins from symbol count
 125+ 09B1              printZ
 126+ 09B1 7E               ld a, (hl)
 126+ 09B2 A7             and a
 126+ 09B3 C8             ret z
 127+ 09B4 E5               push hl
 128+ 09B5 CD BC 09         call putC
 129+ 09B8 E1               pop hl
 130+ 09B9 23               inc hl
 131+ 09BA 18 F5            jr printZ
 132+ 09BC
 133+ 09BC              ; printL
 134+ 09BC                      ; ld	a, (hl)
 135+ 09BC              		; and	a
 136+ 09BC              		; ret	z
 137+ 09BC              putC
 138+ 09BC FE 0D        		cp 13
 138+ 09BE CA 91 09       jp z, mvCR
 139+ 09C1 FE 0A        		cp 10
 139+ 09C3 C8            ret z ;пропустить символ
 140+ 09C4
 141+ 09C4 CD 1D 0A     		call calc_addr_scr
 142+ 09C7 54           		ld d,h ;координаты экрана в DE
 143+ 09C8 5D           		ld e,l
 144+ 09C9 6F           		ld	l,a
 145+ 09CA 26 00        		ld	h,0
 146+ 09CC 29           		add	hl,hl
 147+ 09CD 29           		add	hl,hl
 148+ 09CE 29           		add	hl,hl
 149+ 09CF 01 00 23             ld      bc,font
 150+ 09D2 09                   add     hl,bc ;hl - адрес шрифта буквы
 151+ 09D3
 152+ 09D3                      ;push    de
 153+ 09D3
 154+ 09D3 3A 19 2B     	ld a,(con_scr_cur) ;страница пиксели
 155+ 09D6 D9           	exx
 156+ 09D7 CD AD 0A     	call PageSlot3
 157+ 09DA D9           	exx
 158+ 09DB D5           	push de ;сохранить адрес символа на экране
 159+ 09DC
 160+ 09DC 01 FF 08         ld  bc,#08ff
 161+ 09DF              print80_1
 162+ 09DF ED A0        	ldi ;один байт
 163+ 09E1
 164+ 09E1 E5           	push hl ;на строку пикселей вниз
 165+ 09E2 21 4F 00     	ld hl,80-1
 166+ 09E5 19           	add hl,de
 167+ 09E6 EB           	ex de,hl
 168+ 09E7 E1           	pop hl
 169+ 09E8
 170+ 09E8 10 F5        	djnz    print80_1
 171+ 09EA
 172+ 09EA
 173+ 09EA 3A 1A 2B     	ld a,(con_atr_cur) ;страница атрибуты
 174+ 09ED CD AD 0A     	call PageSlot3
 175+ 09F0
 176+ 09F0 E1           	pop hl ;адрес символа на экране
 177+ 09F1
 178+ 09F1 06 08            ld      b,8
 179+ 09F3 3A CC 0B     	ld a,(attr_screen)
 180+ 09F6 11 50 00     	ld de,80
 181+ 09F9              print80_1_attr ;теперь так же атрибуты
 182+ 09F9
 183+ 09F9 77           	ld (hl),a
 184+ 09FA 19           	add hl,de
 185+ 09FB
 186+ 09FB 10 FC        	djnz    print80_1_attr
 187+ 09FD
 188+ 09FD
 189+ 09FD
 190+ 09FD              ; move cursor на одну позицию вперёд
 191+ 09FD              move_cr80
 192+ 09FD              	;inc	de
 193+ 09FD
 194+ 09FD 21 CA 0B     	ld	hl,col_screen
 195+ 0A00 34           	inc	(hl) ;увеличить столбец
 196+ 0A01 7E           	ld	a,(hl)
 197+ 0A02
 198+ 0A02 FE 50        	cp	80
 199+ 0A04 38 10        	jr	c,move_cr80_01 ;на выход
 200+ 0A06
 201+ 0A06 AF           	xor	a
 202+ 0A07              	;ld	(half_tile_screen),a
 203+ 0A07 77           	ld	(hl),a
 204+ 0A08              	;ld	c,a
 205+ 0A08
 206+ 0A08 23           	inc	hl ;на переменную row
 207+ 0A09 34           	inc	(hl)
 208+ 0A0A 7E           	ld	a,(hl)
 209+ 0A0B              	;ld	b,a
 210+ 0A0B
 211+ 0A0B FE 19        	cp	hsize ;всего строк
 212+ 0A0D DA 16 0A     	jp	c,move_cr80_01
 213+ 0A10
 214+ 0A10 3E 18        	ld	a,hsize-1
 215+ 0A12 77           	ld	(hl),a
 216+ 0A13              	;ld	b,a
 217+ 0A13
 218+ 0A13 CD 73 0A     	call scroll ;сдвиг вверх
 219+ 0A16              	; push	bc
 220+ 0A16              	; call	scroll_up8
 221+ 0A16              	; pop	bc
 222+ 0A16
 223+ 0A16              move_cr80_01
 224+ 0A16              	; call	calc_addr_scr
 225+ 0A16 3A 17 2B     	ld a,(page_slot3_cur)
 226+ 0A19 C3 AD 0A     	jp PageSlot3 ;вернуть страницу
 227+ 0A1C C9           	ret
 228+ 0A1D
 229+ 0A1D              calc_addr_scr	;определение адреса экрана по координатам символа
 230+ 0A1D ED 4B CA 0B  	ld	bc,(col_screen)
 231+ 0A21              bc_to_attr:
 232+ 0A21 26 00        	ld h,0
 233+ 0A23 68           	ld l,b ;строка
 234+ 0A24 29           	add hl,hl ;*2
 235+ 0A25 11 96 0B     	ld de,table_addr_scr
 236+ 0A28 19           	add hl,de
 237+ 0A29 5E           	ld e,(hl)
 238+ 0A2A 23           	inc hl
 239+ 0A2B 56           	ld d,(hl) ;узнали координаты строки
 240+ 0A2C 26 00        	ld h,0
 241+ 0A2E 69           	ld l,c ;колонка
 242+ 0A2F 19           	add hl,de ;узнали адрес символа
 243+ 0A30
 244+ 0A30 ED 5B 9E 0A  	ld de,(curscrl) ;добавить аппаратный скрол
 245+ 0A34 19           	add hl,de
 246+ 0A35 11 80 3E     	ld de,scrsize
 247+ 0A38 A7           	and a		;check over
 248+ 0A39 ED 52        	sbc hl,de
 249+ 0A3B 30 01        	jr nc,calc02
 250+ 0A3D 19           	add hl,de
 251+ 0A3E              calc02:
 252+ 0A3E 11 00 C0     	ld de,scraddr  ;screen
 253+ 0A41 19           	add hl,de
 254+ 0A42
 255+ 0A42              	; ld      a,b
 256+ 0A42              	; ld      d,a
 257+ 0A42              	; rrca
 258+ 0A42              	; rrca
 259+ 0A42              	; rrca
 260+ 0A42              	; and     a,224
 261+ 0A42              	; add     a,c
 262+ 0A42              	; ld      e,a
 263+ 0A42              	; ld      a,d
 264+ 0A42              	; and     24
 265+ 0A42              	; or      #c0
 266+ 0A42              	; ld      d,a
 267+ 0A42 C9           	ret
 268+ 0A43
 269+ 0A43
 270+ 0A43
 271+ 0A43              clear_line ;очистить строку
 272+ 0A43                  ;ld b, hsize-1 ;последняя
 273+ 0A43                  ;ld c, 0
 274+ 0A43 CD 21 0A         call bc_to_attr ;узнать адрес
 275+ 0A46 E5           	push hl
 276+ 0A47 54           	ld d,h
 277+ 0A48 5D           	ld e,l
 278+ 0A49 13           	inc de
 279+ 0A4A 01 7F 02     	ld bc,scrline-1
 280+ 0A4D 36 00        	ld (hl),0
 281+ 0A4F ED B0        	ldir
 282+ 0A51 3A 1A 2B     	ld a,(con_atr_cur) ;теперь страница атрибутов
 283+ 0A54 CD AD 0A     	call PageSlot3 ;
 284+ 0A57 E1           	pop hl
 285+ 0A58 54           	ld d,h
 286+ 0A59 5D           	ld e,l
 287+ 0A5A 13           	inc de
 288+ 0A5B 01 7F 02     	ld bc,scrline-1
 289+ 0A5E              	;ld a,(con_atr_cur) ;атрибуты
 290+ 0A5E 36 00        	ld (hl),0
 291+ 0A60 ED B0        	ldir
 292+ 0A62 C9           	ret
 293+ 0A63
 294+ 0A63              gmxscron
 295+ 0A63 01 FD 7E                 ld      bc,#7efd
 296+ 0A66 3E C8                    ld      a,#c8
 297+ 0A68 ED 79                    out     (c),a
 298+ 0A6A                          ; ld      bc,#7ffd
 299+ 0A6A                          ; ld      a,#10    ;5 screen
 300+ 0A6A                          ; out     (c),a
 301+ 0A6A C9                       ret
 302+ 0A6B
 303+ 0A6B              ; gmxscron2
 304+ 0A6B                          ; ld      bc,#7efd
 305+ 0A6B                          ; ld      a,#c8
 306+ 0A6B                          ; out     (c),a
 307+ 0A6B                          ; ld      bc,#7ffd
 308+ 0A6B                          ; ld      a,#18    ;7 screen
 309+ 0A6B                          ; out     (c),a
 310+ 0A6B                          ; ret
 311+ 0A6B
 312+ 0A6B              gmxscroff
 313+ 0A6B 01 FD 7E                 ld      bc,#7efd
 314+ 0A6E 3E C0                    ld      a,#c0
 315+ 0A70 ED 79                    out     (c),a
 316+ 0A72                          ; ld      bc,#7ffd
 317+ 0A72                          ; ld      a,#10    ;5 screen
 318+ 0A72                          ; out     (c),a
 319+ 0A72 C9                       ret
 320+ 0A73
 321+ 0A73
 322+ 0A73
 323+ 0A73
 324+ 0A73
 325+ 0A73
 326+ 0A73              scroll: ;push hl         ; скpолл экpана на стpоку ввеpх
 327+ 0A73 2A 9E 0A     	ld hl,(curscrl)	;hard scroll
 328+ 0A76 11 80 02     	ld de,scrline
 329+ 0A79 19           	add hl,de	;next line
 330+ 0A7A 11 80 3E     	ld de,scrsize	;chek over 16000
 331+ 0A7D A7           	and a
 332+ 0A7E ED 52        	sbc hl,de
 333+ 0A80 30 03        	jr nc,scrollchek
 334+ 0A82 19           	add hl,de
 335+ 0A83 18 03        	jr scrollchek1
 336+ 0A85              scrollchek:
 337+ 0A85 21 00 00     	ld hl,0
 338+ 0A88              scrollchek1:
 339+ 0A88 22 9E 0A     	ld (curscrl),hl
 340+ 0A8B CD 95 0A     	call gmxscroll
 341+ 0A8E
 342+ 0A8E 06 18            ld b,hsize-1    ;last line
 343+ 0A90 0E 00        	ld c,0
 344+ 0A92                  ;ld a,(attr_screen) ;цвет
 345+ 0A92 C3 43 0A         jp clear_line      ; очистка последней стpоки
 346+ 0A95                  ;ret
 347+ 0A95               ;аппаратный скрол вверх
 348+ 0A95              gmxscroll:
 349+ 0A95              ;set hard scroll
 350+ 0A95              ;in:
 351+ 0A95              ;out:
 352+ 0A95              	;push af
 353+ 0A95              	;push bc
 354+ 0A95              	;push de
 355+ 0A95 21 20 2B     	ld hl,proc_id_cur
 356+ 0A98 3A 07 2B     	ld a,(proc_id_focus)
 357+ 0A9B BE           	cp (hl)
 358+ 0A9C C0           	ret nz ;скрол меняем только когда в фокусе
 359+ 0A9D
 360+ 0A9D 11 00 00     	ld de,0
 361+ 0AA0              curscrl equ $-2 ;current hard scroll (0-15999)
 362+ 0AA0 01 FD 7A     	ld bc,07AFDh
 363+ 0AA3 7B           	ld a,e
 364+ 0AA4 ED 79        	out (c),a
 365+ 0AA6 01 FD 7C     	ld bc,07CFDh
 366+ 0AA9 7A           	ld a,d
 367+ 0AAA ED 79        	out (c),a
 368+ 0AAC              	;pop de
 369+ 0AAC              	;pop bc
 370+ 0AAC              	;pop af
 371+ 0AAC C9           	ret
 372+ 0AAD
 373+ 0AAD
 374+ 0AAD
 375+ 0AAD
 376+ 0AAD
 377+ 0AAD              PageSlot3
 378+ 0AAD              ; драйвер памяти Scorpion GMX 2Mb
 379+ 0AAD
 380+ 0AAD                       ;push hl
 381+ 0AAD                       ; ld   hl,page_table
 382+ 0AAD                       ; add  a,l
 383+ 0AAD                       ; jr   nc,PageSlot3_1
 384+ 0AAD                       ; inc  h          ;коррекция
 385+ 0AAD              ; PageSlot3_1  ld   l,a
 386+ 0AAD                       ; ld   a,(hl)
 387+ 0AAD                       ;pop  hl
 388+ 0AAD                       ;cp   #ff
 389+ 0AAD                       ;scf
 390+ 0AAD                       ;ret  z
 391+ 0AAD                       ;push bc
 392+ 0AAD F5                    push af
 393+ 0AAE 07                    rlca
 394+ 0AAF E6 10        		 and #10
 395+ 0AB1 F6 01                 or  #01  ;выбор ОЗУ вместо ПЗУ
 396+ 0AB3 01 FD 1F              ld   bc,#1ffd
 397+ 0AB6              PageSlot3DOS
 398+ 0AB6              		 ;or #00 ; #04 тут выбор ПЗУ TRDOS
 399+ 0AB6 ED 79                 out  (c),a
 400+ 0AB8 F1                    pop  af
 401+ 0AB9 F5                    push af
 402+ 0ABA E6 07                 and  #07
 403+ 0ABC              PageSlot3Scr ;тут выбор экрана и ПЗУ
 404+ 0ABC F6 10                 or   #10 ;#0 ;#18
 405+ 0ABE 06 7F                 ld   b,#7f
 406+ 0AC0 ED 79                 out  (c),a
 407+ 0AC2 F1                    pop  af
 408+ 0AC3 0F                    rrca
 409+ 0AC4 0F                    rrca
 410+ 0AC5 0F                    rrca
 411+ 0AC6 0F                    rrca
 412+ 0AC7 E6 07                 and  #07
 413+ 0AC9 06 DF                 ld   b,#df
 414+ 0ACB ED 79                 out  (c),a
 415+ 0ACD                       ;pop  hl
 416+ 0ACD C9                    ret
 417+ 0ACE
 418+ 0ACE              set_color
 419+ 0ACE 32 CC 0B     		ld (attr_screen),a
 420+ 0AD1 78           		ld a,b
 421+ 0AD2 32 CD 0B     		ld (attr_screen2),a
 422+ 0AD5 C9           		ret
 423+ 0AD6
 424+ 0AD6              set_scr5 ;включить экран 5
 425+ 0AD6 CD 6B 0A     		call gmxscroff ;выключить расширенный
 426+ 0AD9 3E 10        		ld a,#10
 427+ 0ADB 32 BD 0A     		ld (PageSlot3Scr+1),a
 428+ 0ADE 3A 17 2B     		ld a,(page_slot3_cur)
 429+ 0AE1 C3 AD 0A     		jp PageSlot3
 430+ 0AE4
 431+ 0AE4
 432+ 0AE4              set_scr7 ;включить экран 7
 433+ 0AE4 CD 6B 0A     		call gmxscroff ;выключить расширенный
 434+ 0AE7 3E 18        		ld a,#18
 435+ 0AE9 32 BD 0A     		ld (PageSlot3Scr+1),a
 436+ 0AEC 3A 17 2B     		ld a,(page_slot3_cur)
 437+ 0AEF C3 AD 0A     		jp PageSlot3
 438+ 0AF2
 439+ 0AF2
 440+ 0AF2              set_scr39 ;включить экран 39
 441+ 0AF2 CD 63 0A     		call gmxscron ;выключить расширенный
 442+ 0AF5 3E 10        		ld a,#10
 443+ 0AF7 32 BD 0A     		ld (PageSlot3Scr+1),a
 444+ 0AFA 3A 17 2B     		ld a,(page_slot3_cur)
 445+ 0AFD C3 AD 0A     		jp PageSlot3
 446+ 0B00
 447+ 0B00
 448+ 0B00              set_scr3a ;включить экран 3b
 449+ 0B00 CD 63 0A     		call gmxscron ;выключить расширенный
 450+ 0B03 3E 18        		ld a,#18
 451+ 0B05 32 BD 0A     		ld (PageSlot3Scr+1),a
 452+ 0B08 3A 17 2B     		ld a,(page_slot3_cur)
 453+ 0B0B C3 AD 0A     		jp PageSlot3
 454+ 0B0E
 455+ 0B0E
 456+ 0B0E
 457+ 0B0E
 458+ 0B0E
 459+ 0B0E
 460+ 0B0E              ;Таблица страниц кроме #00-#07, #39, #3a, #77-7F
 461+ 0B0E              page_table    ;db   #00,#01,#02,#03,#04,#05,#06,#07,
 462+ 0B0E 08 09        		 db	  #08,#09
 463+ 0B10 0A 0B 0C 0D           db   #0a,#0b,#0c,#0d,#0e
 463+ 0B14 0E
 464+ 0B15 0F 10 11 12           db   #0f,#10,#11,#12,#13,#14
 464+ 0B19 13 14
 465+ 0B1B 15 16 17 18           db   #15,#16,#17,#18,#19,#1a
 465+ 0B1F 19 1A
 466+ 0B21 1B 1C 1D 1E           db   #1b,#1c,#1d,#1e,#1f,#20
 466+ 0B25 1F 20
 467+ 0B27 21 22 23 24           db   #21,#22,#23,#24,#25,#26
 467+ 0B2B 25 26
 468+ 0B2D 27 28 29 2A           db   #27,#28,#29,#2a,#2b,#2c
 468+ 0B31 2B 2C
 469+ 0B33 2D 2E 2F 30           db   #2d,#2e,#2f,#30,#31,#32
 469+ 0B37 31 32
 470+ 0B39 33 34 35 36           db   #33,#34,#35,#36,#37,#38
 470+ 0B3D 37 38
 471+ 0B3F 3B 3C 3D 3E           db   #3b,#3c,#3d,#3e,#3f,#40
 471+ 0B43 3F 40
 472+ 0B45 41 42 43 44           db   #41,#42,#43,#44,#45,#46
 472+ 0B49 45 46
 473+ 0B4B 47 48 49 4A           db   #47,#48,#49,#4a,#4b,#4c
 473+ 0B4F 4B 4C
 474+ 0B51
 475+ 0B51 4D 4E 4F 50           db   #4d,#4e,#4f,#50,#51,#52
 475+ 0B55 51 52
 476+ 0B57 53 54 55 56           db   #53,#54,#55,#56,#57,#58
 476+ 0B5B 57 58
 477+ 0B5D 59 5A 5B 5C           db   #59,#5a,#5b,#5c,#5d,#5e
 477+ 0B61 5D 5E
 478+ 0B63 5F 60 61 62           db   #5f,#60,#61,#62,#63,#64
 478+ 0B67 63 64
 479+ 0B69 65 66 67 68           db   #65,#66,#67,#68,#69,#6a
 479+ 0B6D 69 6A
 480+ 0B6F 6B 6C 6D 6E           db   #6b,#6c,#6d,#6e,#6f,#70
 480+ 0B73 6F 70
 481+ 0B75 71 72 73 74           db   #71,#72,#73,#74,#75,#76
 481+ 0B79 75 76
 482+ 0B7B                       ;db   #77,#78,#79,#7a,#7b,#7c,#7d,#7e
 483+ 0B7B                       ;db   #7f
 484+ 0B7B              page_table_end
 485+ 0B7B 00 00 00...           ds 128-(page_table_end-page_table) ;забить остаток нулями
 486+ 0B8E
 487+ 0B8E
 488+ 0B8E
 489+ 0B8E              ;font equ #4000 ; Using ZX-Spectrum screen as font buffer
 490+ 0B8E              ;font_file db "data/font.bin", 0
 491+ 0B8E
 492+ 0B8E              PageSlot2 ;включение банка из A в слот памяти 2
 493+ 0B8E EE 02        	xor 2
 494+ 0B90 01 FD 78     	ld bc,#78fd
 495+ 0B93 ED 79        	out (c),a
 496+ 0B95 C9           	ret
 497+ 0B96
 498+ 0B96
 499+ 0B96              table_addr_scr	;адреса строк текста
 500+ 0B96 00 00        	defw	00000h ;0
 501+ 0B98 80 02        	defw	00280h
 502+ 0B9A 00 05        	defw	00500h
 503+ 0B9C 80 07        	defw	00780h
 504+ 0B9E 00 0A        	defw	00a00h
 505+ 0BA0 80 0C        	defw	00c80h
 506+ 0BA2 00 0F        	defw	00f00h
 507+ 0BA4 80 11        	defw	01180h
 508+ 0BA6
 509+ 0BA6 00 14        	defw	01400h ;8
 510+ 0BA8 80 16        	defw	01680h
 511+ 0BAA 00 19        	defw	01900h
 512+ 0BAC 80 1B        	defw	01b80h
 513+ 0BAE 00 1E        	defw	01e00h
 514+ 0BB0 80 20        	defw	02080h
 515+ 0BB2 00 23        	defw	02300h
 516+ 0BB4 80 25        	defw	02580h
 517+ 0BB6
 518+ 0BB6 00 28        	defw	02800h ;16
 519+ 0BB8 80 2A        	defw	02a80h
 520+ 0BBA 00 2D        	defw	02d00h
 521+ 0BBC 80 2F        	defw	02f80h
 522+ 0BBE 00 32        	defw	03200h
 523+ 0BC0 80 34        	defw	03480h
 524+ 0BC2 00 37        	defw	03700h
 525+ 0BC4 80 39        	defw	03980h
 526+ 0BC6
 527+ 0BC6 00 3C        	defw	03c00h ;24
 528+ 0BC8 80 3E        	defw	03e80h ;25 вне экрана
 529+ 0BCA
 530+ 0BCA
 531+ 0BCA 00           col_screen			db	0	;столбец
 532+ 0BCB 00           row_screen			db	0	;строка
 533+ 0BCC              ;half_tile_screen	db	0
 534+ 0BCC 07           attr_screen			db	07	;основной цвет
 535+ 0BCD 0C           attr_screen2		db	#c	;второй цвет
 536+ 0BCE
 537+ 0BCE
 538+ 0BCE              ;col_screen_temp			dw	0
 539+ 0BCE              ;half_tile_screen_temp	db	0
 540+ 0BCE
 541+ 0BCE 01           single_symbol_print db 1
 542+ 0BCF 00           single_symbol 		db 0
 543+ 0BD0
 544+ 0BD0 00 00 00...  fill_buff ds 80+1
 545+ 0C21
 546+ 0C21                  endmodule
# file closed: Drv/zsgmx.asm
2457  0C21              	include Drv/zsfat.asm ;драйвер диска
# file opened: Drv/zsfat.asm
   1+ 0C21              ;trdos & fat32 driver (izzx)
   2+ 0C21                  MODULE Dos
   3+ 0C21              ; API methods - для всех процессов
   4+ 0C21              ;ESX_GETSETDRV = #89
   5+ 0C21              ;ESX_FOPEN = #9A
   6+ 0C21              ;ESX_FCLOSE = #9B
   7+ 0C21              ;ESX_FSYNC = #9C
   8+ 0C21              ;ESX_FREAD = #9D
   9+ 0C21              ;ESX_FWRITE = #9E
  10+ 0C21
  11+ 0C21              ; File modes
  12+ 0C21              FMODE_READ = #01
  13+ 0C21              ;FMODE_WRITE = #06
  14+ 0C21              FMODE_CREATE = #0E
  15+ 0C21
  16+ 0C21                  ; MACRO esxCall func
  17+ 0C21                  ; rst #8 : db func
  18+ 0C21                  ; ENDM
  19+ 0C21
  20+ 0C21              ;макросы только для внутренней работы самого модуля через BIOS
  21+ 0C21              ;
  22+ 0C21              ;R8DOS			вызов функции R8DOS
  23+ 0C21              ;R8FAT			вызов функции R8FAT
  24+ 0C21              ;R8DOSc			вызов функции R8DOS
  25+ 0C21              ;
  26+ 0C21              ;------------------------------------------------------------------------------
  27+ 0C21              ;вызов функции R8DOS
  28+ 0C21              ;вх: =0 номер функции
  29+ 0C21              ;
  30+ 0C21              	MACRO	R8DOS nFunc
  31+ 0C21 ~            	ld	c,nFunc
  32+ 0C21 ~            	rst	#08
  33+ 0C21 ~            	db	#81
  34+ 0C21              	ENDM
  35+ 0C21
  36+ 0C21              ;------------------------------------------------------------------------------
  37+ 0C21              ;вызов функции R8FAT
  38+ 0C21              ;вх: =0 номер функции
  39+ 0C21              ;
  40+ 0C21              	MACRO	R8FAT nFunc
  41+ 0C21 ~            	ld	c,nFunc
  42+ 0C21 ~            	rst	#08
  43+ 0C21 ~            	db	#91
  44+ 0C21              	ENDM
  45+ 0C21
  46+ 0C21              ;------------------------------------------------------------------------------
  47+ 0C21              ;вызов функции R8DOS
  48+ 0C21              ;вх: c - номер функции
  49+ 0C21              ;
  50+ 0C21              	MACRO	R8DOSc
  51+ 0C21 ~            	rst	#08
  52+ 0C21 ~            	db	#81
  53+ 0C21              	ENDM
  54+ 0C21
  55+ 0C21              ;------------------------------------------------------------------------------
  56+ 0C21              ;вызов функции #02 (FileMan) R8CONF
  57+ 0C21              ;вх: =#00 - номер функции файл менеджера
  58+ 0C21              ;
  59+ 0C21              	MACRO	R8C02FM nFunct
  60+ 0C21 ~            	ld	bc,#100*nFunct+#02
  61+ 0C21 ~            	rst	#08
  62+ 0C21 ~            	db	#8E
  63+ 0C21              	ENDM
  64+ 0C21
  65+ 0C21              ;==============================================================================
  66+ 0C21              r8f00_DeinitFAT		equ #00 ;деинициализация переменных раздела FAT
  67+ 0C21              r8f01_InitFAT		equ #01 ;инициализация переменных раздела FAT, если он еще не инициализирован
  68+ 0C21              r8f02_ReadDIR		equ #02 ;чтение секторов текущего каталога
  69+ 0C21              r8f03_SetRoot		equ #03 ;установка корневого каталога текущим
  70+ 0C21              r8f04_FindPath		equ #04 ;поиск файла по заданному пути в текущем каталоге со входом в подкаталоги с проверкой синтаксиса (с установкой найденного каталога текущим)
  71+ 0C21              r8f05_OpenDir		equ #05 ;вход в каталог/выход в родительский каталог
  72+ 0C21
  73+ 0C21              r8f07_FileOpen		equ #07 ;открыть файл для последующих операций с ним
  74+ 0C21              r8f08_FileRead		equ #08	;чтение данных из файла в память
  75+ 0C21              r8f09_FileWrite		equ #09	;запись данных из памяти в файл
  76+ 0C21
  77+ 0C21              r8f0E_CreateFileLFN	equ #0E ;создание файла с длинным именем в текущем каталоге
  78+ 0C21              r8f0F_CreateFileSFN	equ #0F ;создание файла с именем 8+3 в текущем каталоге	в fcb должны быть установлены: fcbName, fcbExt, fcbSize
  79+ 0C21              r8f13_GetPath 		equ #13 ;получение текущего пути
  80+ 0C21
  81+ 0C21              r8d2D_FindPart		equ #2D ;поиск разделов FAT32 и MFS на текущем винчестере
  82+ 0C21              r8d2E_CngHDD		equ #2E ;смена текущего винчестера
  83+ 0C21
  84+ 0C21              ;конец макросов BIOS
  85+ 0C21
  86+ 0C21              files_fat_max equ 8 ;максимальное число открытых файлов fat
  87+ 0C21              files_trd_max equ 8 ;максимальное число открытых файлов trd
  88+ 0C21              fcb_fat_size equ 32 ;размер дискриптора fcb
  89+ 0C21
  90+ 0C21
  91+ 0C21
  92+ 0C21              ; Returns:
  93+ 0C21              ;  A - current drive
  94+ 0C21              ; getDefaultDrive: ;нигде не используется
  95+ 0C21                  ; ld a, 0 : esxCall ESX_GETSETDRV
  96+ 0C21                  ; ret
  97+ 0C21
  98+ 0C21
  99+ 0C21
 100+ 0C21              ; Opens file on default drive
 101+ 0C21              ; B - File mode
 102+ 0C21              ; HL - File name
 103+ 0C21              ; Returns:
 104+ 0C21              ;  A - file stream id
 105+ 0C21              ; DE, BC - File size
 106+ 0C21              ; IX - fcb
 107+ 0C21              ; fopen:
 108+ 0C21                  ; ; push bc : push hl
 109+ 0C21                  ; ; call getDefaultDrive
 110+ 0C21                  ; ; pop ix : pop bc
 111+ 0C21                  ; ; esxCall ESX_FOPEN
 112+ 0C21                  ; ; ret
 113+ 0C21              	; ld a,b
 114+ 0C21              	; cp FMODE_READ ;если режим открытие файла
 115+ 0C21              	; jr z,fopen_r
 116+ 0C21              	; cp FMODE_CREATE
 117+ 0C21              	; jr z,fopen_c ;если режим создание файла
 118+ 0C21              	; jp file_error ;иначе выход
 119+ 0C21
 120+ 0C21
 121+ 0C21              fopen_r	;открытие существующего файла на чтение
 122+ 0C21
 123+ 0C21 CD 6D 0C     	call fopen_prep
 124+ 0C24 DA 6E 0D     	jp 	c,file_error
 125+ 0C27
 126+ 0C27 32 15 0F     	ld (file_fat_id_cur),a
 127+ 0C2A
 128+ 0C2A              	;сначала сделаем текущей папку активного приложения
 129+ 0C2A D9           	exx
 130+ 0C2B 3A 20 2B     	ld a,(proc_id_cur)
 131+ 0C2E CD 6C 0E     	call calc_dir_deskr
 132+ 0C31 EB           	ex de,hl
 133+ 0C32 21 00 00     	ld hl,0
 134+ 0C35                  ; hl - адрес пути (=#0000 - путь отсутствует)
 135+ 0C35                  ; de - адрес дескриптора директории/файла
 136+ 0C35              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 136+ 0C35 0E 05       >	ld	c,r8f05_OpenDir
 136+ 0C37 CF          >	rst	#08
 136+ 0C38 91          >	db	#91
 137+ 0C39 D9           	exx
 138+ 0C3A
 139+ 0C3A 3A 15 0F     	ld a,(file_fat_id_cur)
 140+ 0C3D              	R8FAT r8f07_FileOpen ;открыть
 140+ 0C3D 0E 07       >	ld	c,r8f07_FileOpen
 140+ 0C3F CF          >	rst	#08
 140+ 0C40 91          >	db	#91
 141+ 0C41 DA 6E 0D     	jp 	c,file_error
 142+ 0C44
 143+ 0C44
 144+ 0C44 C3 7A 0C     	jp fopen_ex
 145+ 0C47
 146+ 0C47
 147+ 0C47              fopen_c	;создание нового файла
 148+ 0C47
 149+ 0C47 CD 6D 0C     	call fopen_prep
 150+ 0C4A DA 6E 0D     	jp 	c,file_error
 151+ 0C4D
 152+ 0C4D
 153+ 0C4D 32 15 0F     	ld (file_fat_id_cur),a
 154+ 0C50
 155+ 0C50              	;сначала сделаем текущей папку активного приложения
 156+ 0C50 D9           	exx
 157+ 0C51 3A 20 2B     	ld a,(proc_id_cur)
 158+ 0C54 CD 6C 0E     	call calc_dir_deskr
 159+ 0C57 EB           	ex de,hl
 160+ 0C58 21 00 00     	ld hl,0
 161+ 0C5B                  ; hl - адрес пути (=#0000 - путь отсутствует)
 162+ 0C5B                  ; de - адрес дескриптора директории/файла
 163+ 0C5B              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 163+ 0C5B 0E 05       >	ld	c,r8f05_OpenDir
 163+ 0C5D CF          >	rst	#08
 163+ 0C5E 91          >	db	#91
 164+ 0C5F D9           	exx
 165+ 0C60
 166+ 0C60 3A 15 0F     	ld a,(file_fat_id_cur)
 167+ 0C63              	R8FAT	r8f0E_CreateFileLFN	;создание файла
 167+ 0C63 0E 0E       >	ld	c,r8f0E_CreateFileLFN
 167+ 0C65 CF          >	rst	#08
 167+ 0C66 91          >	db	#91
 168+ 0C67 DA 6E 0D     	jp 	c,file_error
 169+ 0C6A
 170+ 0C6A C3 7A 0C     	jp fopen_ex
 171+ 0C6D
 172+ 0C6D
 173+ 0C6D              fopen_prep ;проверка перед открытием файла
 174+ 0C6D 3A C1 0F     	ld a,(fs_fat_init_flag)
 175+ 0C70 B7           	or a
 176+ 0C71 37           	scf
 177+ 0C72 C8           	ret z
 178+ 0C73
 179+ 0C73 E5           	push hl
 180+ 0C74 CD DB 0E     	call find_empty_fcb_fat ;какой fcb свободен?
 181+ 0C77 EB           	ex de,hl ;fcb in de
 182+ 0C78 E1           	pop hl
 183+ 0C79 C9           	ret ;выйти с флагом
 184+ 0C7A
 185+ 0C7A
 186+ 0C7A              fopen_ex
 187+ 0C7A              	;успешно создали/открыли
 188+ 0C7A D5           	push de
 189+ 0C7B DD E1        	pop ix ;вернуть fcb
 190+ 0C7D 21 05 11     	ld hl,fcb_fat_table
 191+ 0C80 3A 15 0F     	ld a,(file_fat_id_cur)
 192+ 0C83 4F           	ld c,a
 193+ 0C84 06 00        	ld b,0
 194+ 0C86 09           	add hl,bc
 195+ 0C87 3A 20 2B     	ld a,(proc_id_cur)
 196+ 0C8A 77           	ld (hl),a ;флаг что файл открыт (id текущего процесса)
 197+ 0C8B
 198+ 0C8B              	;вернуть размер файла
 199+ 0C8B DD 4E 14     	ld	c,(ix+#14) ;младшие байты длины
 200+ 0C8E DD 46 15     	ld	b,(ix+#15)
 201+ 0C91
 202+ 0C91 DD 5E 16     	ld	e,(ix+#16) ;старшие байты длины
 203+ 0C94 DD 56 17     	ld  d,(ix+#17)
 204+ 0C97
 205+ 0C97 3A 15 0F     	ld a,(file_fat_id_cur) ;вернуть id
 206+ 0C9A B7           	or a
 207+ 0C9B C9           	ret
 208+ 0C9C
 209+ 0C9C
 210+ 0C9C
 211+ 0C9C
 212+ 0C9C              init_fs_fat	;инициализация файловой системы
 213+ 0C9C              	; ld a,(fs_fat_init_flag) ;если в первый раз
 214+ 0C9C              	; or a
 215+ 0C9C              	; jr nz,init_fs_fat2
 216+ 0C9C AF           	xor a
 217+ 0C9D 32 C1 0F     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 218+ 0CA0 3E 04        	ld a,4 ;номер дисковода по умолчанию E
 219+ 0CA2 32 7E 0E     	ld (fs_drive_number_cur),a
 220+ 0CA5 CD 8E 0E     	call GetNumPart ;узнаем какая буква последняя, сколько разделов FAT
 221+ 0CA8 30 0B        	jr nc,init_fs_fat_prn2
 222+ 0CAA B7           	or a
 223+ 0CAB 20 08        	jr nz,init_fs_fat_prn2
 224+ 0CAD 21 37 0F     	ld hl,msg_fat_not_found
 225+ 0CB0 CD B1 09     	call drvgmx.printZ
 226+ 0CB3 37           	scf ;ошибка
 227+ 0CB4 C9           	ret
 228+ 0CB5
 229+ 0CB5
 230+ 0CB5              init_fs_fat_prn2
 231+ 0CB5              	;печать списка разделов
 232+ 0CB5 21 17 0F     	ld hl,msg_fat_found
 233+ 0CB8 CD B1 09     	call drvgmx.printZ
 234+ 0CBB 21 7F 0E     	ld hl,typeDrive
 235+ 0CBE 3A 8C 0E     	ld a,(numDrives)
 236+ 0CC1 47           	ld b,a ;цикл по количеству разделов
 237+ 0CC2 0E 45        	ld c,"E" ;первая буква диска FAT
 238+ 0CC4              init_fs_fat_prn1
 239+ 0CC4 C5           	push bc
 240+ 0CC5 E5           	push hl
 241+ 0CC6 79           	ld a,c ;имя диска
 242+ 0CC7 CD BC 09     	call drvgmx.putC
 243+ 0CCA 3E 3A        	ld a,":" ;
 244+ 0CCC CD BC 09     	call drvgmx.putC
 245+ 0CCF              	;тип S или H
 246+ 0CCF 3E 48        	ld a,"H"
 247+ 0CD1 E1           	pop hl
 248+ 0CD2 E5           	push hl
 249+ 0CD3 CB 5E        	bit 3,(hl) ;SD?
 250+ 0CD5 28 02        	jr z,init_fs_fat_prn3
 251+ 0CD7 3E 53        	ld a,"S"
 252+ 0CD9              init_fs_fat_prn3
 253+ 0CD9 CD BC 09     	call drvgmx.putC ;первая буква
 254+ 0CDC 3E 44        	ld a,"D"
 255+ 0CDE CD BC 09     	call drvgmx.putC ;вторая буква
 256+ 0CE1              	;номер диска
 257+ 0CE1 E1           	pop hl
 258+ 0CE2 E5           	push hl
 259+ 0CE3 7E           	ld a,(hl)
 260+ 0CE4 E6 04        	and %00000100
 261+ 0CE6 0F           	rrca
 262+ 0CE7 0F           	rrca
 263+ 0CE8 C6 30        	add "0"
 264+ 0CEA CD BC 09     	call drvgmx.putC ;номер диска
 265+ 0CED              	;номер раздела
 266+ 0CED 3E 2C        	ld a,","
 267+ 0CEF CD BC 09     	call drvgmx.putC ;разделитель
 268+ 0CF2 E1           	pop hl
 269+ 0CF3 E5           	push hl
 270+ 0CF4 7E           	ld a,(hl)
 271+ 0CF5 E6 03        	and %00000011
 272+ 0CF7 C6 30        	add "0"
 273+ 0CF9 CD BC 09     	call drvgmx.putC ;номер раздела
 274+ 0CFC 3E 0D        	ld a,13 ;новая строка
 275+ 0CFE CD BC 09     	call drvgmx.putC
 276+ 0D01 E1           	pop hl
 277+ 0D02 23           	inc hl
 278+ 0D03 C1           	pop bc
 279+ 0D04 0C           	inc c
 280+ 0D05 10 BD        	djnz init_fs_fat_prn1
 281+ 0D07
 282+ 0D07
 283+ 0D07              	;поиск системы и выбор диска
 284+ 0D07 3A 8C 0E     	ld a,(numDrives)
 285+ 0D0A DD 6F        	ld ixl,a ;цикл по количеству разделов
 286+ 0D0C 3A 7E 0E     	ld a,(fs_drive_number_cur)
 287+ 0D0F              init_fs_fat_find_os_cl
 288+ 0D0F 01 7B 0E     	ld bc,typeDrive-4
 289+ 0D12 6F           	ld l,a
 290+ 0D13 26 00        	ld h,0
 291+ 0D15 09           	add hl,bc
 292+ 0D16 7E           	ld a,(hl) ;получили код раздела из списка
 293+ 0D17
 294+ 0D17 CD 4E 0D     	call init_fs_fat_warm ;выбрать раздел
 295+ 0D1A D8           	ret c
 296+ 0D1B
 297+ 0D1B              	;поиск пути в разделе
 298+ 0D1B 21 C2 0F     	ld	hl,OS_PathFAT		;путь к каталогу системы
 299+ 0D1E 11 D5 0F     	ld	de,dir_fat_deskr ;будет дескриптор системной папки
 300+ 0D21 AF           	xor	a
 301+ 0D22 3D           	dec	a ;установить текущим
 302+ 0D23              	R8FAT	r8f04_FindPath
 302+ 0D23 0E 04       >	ld	c,r8f04_FindPath
 302+ 0D25 CF          >	rst	#08
 302+ 0D26 91          >	db	#91
 303+ 0D27 30 10        	jr nc,init_fs_fat_find_os_ok
 304+ 0D29
 305+ 0D29 3A 7E 0E     	ld a,(fs_drive_number_cur)
 306+ 0D2C 3C           	inc a
 307+ 0D2D 32 7E 0E     	ld (fs_drive_number_cur),a
 308+ 0D30 DD 2D        	dec ixl
 309+ 0D32 20 DB        	jr nz,init_fs_fat_find_os_cl
 310+ 0D34
 311+ 0D34
 312+ 0D34              	;не нашли ОС
 313+ 0D34 CD 7E 0D         call   file_error_print_dir_not_found ;если не нашли, файл будет в корне
 314+ 0D37 37           	scf
 315+ 0D38 C9           	ret
 316+ 0D39              init_fs_fat_find_os_ok
 317+ 0D39              	;нашли раздел с ОС
 318+ 0D39 21 24 0F     	ld hl,msg_fat_found_os
 319+ 0D3C CD B1 09     	call drvgmx.printZ
 320+ 0D3F 3A 7E 0E     	ld a,(fs_drive_number_cur)
 321+ 0D42 C6 41        	add a,"A"
 322+ 0D44 CD BC 09     	call drvgmx.putC
 323+ 0D47 3E 0D        	ld a,13
 324+ 0D49 CD BC 09     	call drvgmx.putC
 325+ 0D4C B7           	or a
 326+ 0D4D C9           	ret
 327+ 0D4E
 328+ 0D4E
 329+ 0D4E              init_fs_fat_warm
 330+ 0D4E              ;переинициализация FAT раздела, когда разделы-диски уже найдены
 331+ 0D4E              ;вх: a - код раздела
 332+ 0D4E 32 16 0F     	ld (fs_fat_part_code_cur),a ;запомнить текущий раздел
 333+ 0D51 AF           	xor a
 334+ 0D52 32 C1 0F     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 335+ 0D55 3A 16 0F     	ld a,(fs_fat_part_code_cur)
 336+ 0D58
 337+ 0D58              	; R8FAT	r8f00_DeinitFAT
 338+ 0D58              	; jp 		c,file_error
 339+ 0D58
 340+ 0D58
 341+ 0D58              	R8FAT	r8f01_InitFAT ;инициализация
 341+ 0D58 0E 01       >	ld	c,r8f01_InitFAT
 341+ 0D5A CF          >	rst	#08
 341+ 0D5B 91          >	db	#91
 342+ 0D5C D2 67 0D         jp      nc,init_fs_fat3
 343+ 0D5F 21 47 0F     	ld hl,msg_fat_init_error
 344+ 0D62 CD B1 09     	call drvgmx.printZ
 345+ 0D65 37           	scf
 346+ 0D66 C9           	ret
 347+ 0D67
 348+ 0D67              init_fs_fat3
 349+ 0D67
 350+ 0D67
 351+ 0D67              ;получить текущий путь
 352+ 0D67              	; ld	hl,#4000		;адрес буфера для размещения текущего пути (256 байт)
 353+ 0D67              	; R8FAT	r8f13_GetPath ;получить путь
 354+ 0D67
 355+ 0D67              ;init_fs_fat_ex ;выход
 356+ 0D67 3E 01        	ld a,1
 357+ 0D69 32 C1 0F     	ld (fs_fat_init_flag),a
 358+ 0D6C B7           	or a
 359+ 0D6D C9           	ret
 360+ 0D6E
 361+ 0D6E
 362+ 0D6E
 363+ 0D6E
 364+ 0D6E
 365+ 0D6E
 366+ 0D6E              file_error ;выход с ошибкой
 367+ 0D6E 11 00 00     	ld de,0
 368+ 0D71 01 00 00     	ld bc,0 ;длина 0
 369+ 0D74 37           	scf ;ошибка
 370+ 0D75 C9           	ret
 371+ 0D76
 372+ 0D76              file_error_general_print ;выход с общей ошибкой и сообщением
 373+ 0D76 21 58 0F     	ld hl,msg_file_error_general
 374+ 0D79 CD B1 09     	call drvgmx.printZ
 375+ 0D7C 37           	scf ;ошибка
 376+ 0D7D C9           	ret
 377+ 0D7E
 378+ 0D7E              file_error_print_dir_not_found ;выход с ошибкой и сообщением
 379+ 0D7E 21 A9 0F     	ld hl,msg_dir_not_found
 380+ 0D81 CD B1 09     	call drvgmx.printZ
 381+ 0D84 37           	scf ;ошибка
 382+ 0D85 C9           	ret
 383+ 0D86
 384+ 0D86              file_error_print_file_too_big ;выход с ошибкой и сообщением
 385+ 0D86 21 65 0F     	ld hl,msg_file_too_big
 386+ 0D89 CD B1 09     	call drvgmx.printZ
 387+ 0D8C 37           	scf ;ошибка
 388+ 0D8D C9           	ret
 389+ 0D8E
 390+ 0D8E              file_error_print_file_not_found ;выход с ошибкой и сообщением
 391+ 0D8E 21 74 0F     	ld hl,msg_file_not_found
 392+ 0D91 CD B1 09     	call drvgmx.printZ
 393+ 0D94 37           	scf ;ошибка
 394+ 0D95 C9           	ret
 395+ 0D96
 396+ 0D96              file_error_print_file_open_error ;выход с ошибкой и сообщением
 397+ 0D96 21 85 0F     	ld hl,msg_file_open_error
 398+ 0D99 CD B1 09     	call drvgmx.printZ
 399+ 0D9C 37           	scf ;ошибка
 400+ 0D9D C9           	ret
 401+ 0D9E
 402+ 0D9E              file_error_print_file_read_error ;выход с ошибкой и сообщением
 403+ 0D9E 21 97 0F     	ld hl,msg_file_read_error
 404+ 0DA1 CD B1 09     	call drvgmx.printZ
 405+ 0DA4 37           	scf ;ошибка
 406+ 0DA5 C9           	ret
 407+ 0DA6
 408+ 0DA6
 409+ 0DA6
 410+ 0DA6
 411+ 0DA6              ; A - file stream id
 412+ 0DA6              fclose:
 413+ 0DA6                  ;esxCall ESX_FCLOSE
 414+ 0DA6              	; push af
 415+ 0DA6              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 416+ 0DA6              	; pop af
 417+ 0DA6              	; cp 2 ;если обычный файл
 418+ 0DA6              	; jp nz,fclose_scl
 419+ 0DA6
 420+ 0DA6              close_fcb_fat ;закрытие fcb файла по номеру
 421+ 0DA6              ;вх: a - id файла
 422+ 0DA6              	;выход hl - fcb;
 423+ 0DA6 21 23 11     	ld hl,fcb_fat
 424+ 0DA9 B7           	or a
 425+ 0DAA 28 07        	jr z,close_fcb_fat_ex
 426+ 0DAC 47           	ld b,a
 427+ 0DAD 11 20 00     	ld de,fcb_fat_size
 428+ 0DB0              close_fcb_fat_cl
 429+ 0DB0              	;вычислить адрес fcb
 430+ 0DB0 19           	add hl,de
 431+ 0DB1 10 FD        	djnz close_fcb_fat_cl
 432+ 0DB3              close_fcb_fat_ex
 433+ 0DB3 E5           	push hl
 434+ 0DB4 54           	ld d,h ;почистить fcb
 435+ 0DB5 5D           	ld e,l
 436+ 0DB6 13           	inc de
 437+ 0DB7 01 1F 00     	ld bc,fcb_fat_size-1
 438+ 0DBA 36 00        	ld (hl),0
 439+ 0DBC ED B0        	ldir
 440+ 0DBE 21 05 11     	ld hl,fcb_fat_table
 441+ 0DC1 4F           	ld c,a
 442+ 0DC2 06 00        	ld b,0
 443+ 0DC4 09           	add hl,bc
 444+ 0DC5 36 00        	ld (hl),0 ;и флаг открытия fcb_fat_table
 445+ 0DC7 E1           	pop hl
 446+ 0DC8 C9           	ret
 447+ 0DC9
 448+ 0DC9
 449+ 0DC9
 450+ 0DC9              ;закрытие всех файлов процесса
 451+ 0DC9              ;вх: A - id процесса
 452+ 0DC9              fclose_proc_all
 453+ 0DC9 21 05 11     	ld hl,fcb_fat_table
 454+ 0DCC 06 08        	ld b,files_fat_max
 455+ 0DCE 0E 00        	ld c,0 ;id файла
 456+ 0DD0              fclose_proc_all_cl
 457+ 0DD0 BE           	cp (hl) ;совпадает с id процесса?
 458+ 0DD1 20 08        	jr nz,fclose_proc_all_skip
 459+ 0DD3 F5           	push af
 460+ 0DD4 79           	ld a,c ;id файла
 461+ 0DD5 D9           	exx
 462+ 0DD6 CD A6 0D     	call close_fcb_fat ;закрыть
 463+ 0DD9 D9           	exx
 464+ 0DDA F1           	pop af
 465+ 0DDB              fclose_proc_all_skip
 466+ 0DDB 23           	inc hl
 467+ 0DDC 0C           	inc c
 468+ 0DDD 10 F1        	djnz fclose_proc_all_cl
 469+ 0DDF C9           	ret
 470+ 0DE0
 471+ 0DE0
 472+ 0DE0
 473+ 0DE0
 474+ 0DE0
 475+ 0DE0
 476+ 0DE0              ; A - file stream id
 477+ 0DE0              ; DE - length
 478+ 0DE0              ; HL - buffer
 479+ 0DE0              ; Returns
 480+ 0DE0              ;  BC - length(how much was actually read)
 481+ 0DE0              fread: ;(id=1)
 482+ 0DE0                  ; push hl : pop ix
 483+ 0DE0                  ; esxCall ESX_FREAD
 484+ 0DE0
 485+ 0DE0 ED 53 BF 0F  	ld (file_size_tmp),de
 486+ 0DE4
 487+ 0DE4 CD 18 0E     	call file_check_act ;проверка
 488+ 0DE7 DA 6E 0D     	jp c,file_error
 489+ 0DEA
 490+ 0DEA ED 4B BF 0F  	ld bc,(file_size_tmp) ;размер
 491+ 0DEE 79           	ld a,c ;ba - количество байт для чтения
 492+ 0DEF
 493+ 0DEF              	R8FAT r8f08_FileRead	;читать файл
 493+ 0DEF 0E 08       >	ld	c,r8f08_FileRead
 493+ 0DF1 CF          >	rst	#08
 493+ 0DF2 91          >	db	#91
 494+ 0DF3 DA 6E 0D     	jp c,file_error
 495+ 0DF6
 496+ 0DF6 ED 4B BF 0F  	ld bc,(file_size_tmp) ;размер
 497+ 0DFA B7           	or a
 498+ 0DFB C9           	ret
 499+ 0DFC
 500+ 0DFC
 501+ 0DFC              ; A - file stream id
 502+ 0DFC              ; BC - length
 503+ 0DFC              ; HL - buffer
 504+ 0DFC              ; Returns:
 505+ 0DFC              ;   BC - actually written bytes
 506+ 0DFC              fwrite: ;
 507+ 0DFC                  ; push hl : pop ix
 508+ 0DFC                  ; esxCall ESX_FWRITE
 509+ 0DFC
 510+ 0DFC               ;запись файла fat
 511+ 0DFC ED 53 BF 0F   	ld (file_size_tmp),de
 512+ 0E00
 513+ 0E00 CD 18 0E     	call file_check_act ;проверка
 514+ 0E03 DA 6E 0D     	jp c,file_error
 515+ 0E06
 516+ 0E06 ED 4B BF 0F  	ld bc,(file_size_tmp) ;размер
 517+ 0E0A 79           	ld a,c ;ba - количество байт для записи
 518+ 0E0B
 519+ 0E0B              	R8FAT r8f09_FileWrite	;записать в файл
 519+ 0E0B 0E 09       >	ld	c,r8f09_FileWrite
 519+ 0E0D CF          >	rst	#08
 519+ 0E0E 91          >	db	#91
 520+ 0E0F DA 6E 0D     	jp c,file_error
 521+ 0E12
 522+ 0E12 ED 4B BF 0F  	ld bc,(file_size_tmp) ;размер
 523+ 0E16 B7           	or a
 524+ 0E17 C9           	ret
 525+ 0E18              ;---------------------------------------
 526+ 0E18
 527+ 0E18              file_check_act
 528+ 0E18              ;проверка файла на актуальность
 529+ 0E18              ;вых: A - id, DE - fcb
 530+ 0E18 32 15 0F     	ld (file_fat_id_cur),a ;сохранить id
 531+ 0E1B
 532+ 0E1B 3A C1 0F     	ld a,(fs_fat_init_flag)
 533+ 0E1E B7           	or a
 534+ 0E1F 37           	scf
 535+ 0E20 C8           	ret z ;выход если не инициализирована ФС
 536+ 0E21
 537+ 0E21 E5           	push hl
 538+ 0E22 C5           	push bc
 539+ 0E23 3A 15 0F     	ld a,(file_fat_id_cur)
 540+ 0E26 CD FD 0E     	call find_fcb_fat ;найти fcb
 541+ 0E29 EB           	ex de,hl ;fcb в de
 542+ 0E2A D5           	push de
 543+ 0E2B DD E1        	pop ix ;fcb
 544+ 0E2D C1           	pop bc
 545+ 0E2E 21 20 2B     	ld hl,proc_id_cur ;сравнить с кодом текущего процесса, чтобы имел доступ только к своему файлу
 546+ 0E31 BE           	cp (hl)
 547+ 0E32 E1           	pop hl
 548+ 0E33 37           	scf
 549+ 0E34 C0           	ret nz
 550+ 0E35
 551+ 0E35 B7           	or a
 552+ 0E36 37           	scf
 553+ 0E37 C8           	ret z ;выход если файл не открыт
 554+ 0E38
 555+ 0E38
 556+ 0E38
 557+ 0E38 3A 16 0F     	ld a,(fs_fat_part_code_cur) ;сравнить какой раздел у файла и какой активный
 558+ 0E3B DD BE 1F     	cp (ix+#1f)
 559+ 0E3E C4 4E 0D     	call nz,init_fs_fat_warm ;переинициировать
 560+ 0E41 C9           	ret
 561+ 0E42
 562+ 0E42
 563+ 0E42
 564+ 0E42              ;чтение секторов текущего каталога
 565+ 0E42              ; вх:
 566+ 0E42                   ; hl - буфер для чтения
 567+ 0E42                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 568+ 0E42                   ; b - максимальное количество секторов для чтения
 569+ 0E42              read_dir
 570+ 0E42              	;сначала сделаем текущей папку активного приложения
 571+ 0E42 D9           	exx
 572+ 0E43 3A 20 2B     	ld a,(proc_id_cur)
 573+ 0E46 CD 6C 0E     	call calc_dir_deskr
 574+ 0E49 EB           	ex de,hl
 575+ 0E4A 21 00 00     	ld hl,0
 576+ 0E4D                  ; hl - адрес пути (=#0000 - путь отсутствует)
 577+ 0E4D                  ; de - адрес дескриптора директории/файла
 578+ 0E4D              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 578+ 0E4D 0E 05       >	ld	c,r8f05_OpenDir
 578+ 0E4F CF          >	rst	#08
 578+ 0E50 91          >	db	#91
 579+ 0E51 D9           	exx
 580+ 0E52
 581+ 0E52              	;теперь запрос
 582+ 0E52              	R8FAT r8f02_ReadDIR	;читать
 582+ 0E52 0E 02       >	ld	c,r8f02_ReadDIR
 582+ 0E54 CF          >	rst	#08
 582+ 0E55 91          >	db	#91
 583+ 0E56 C9               ret
 584+ 0E57
 585+ 0E57
 586+ 0E57
 587+ 0E57              ;вход в каталог/выход в родительский каталог
 588+ 0E57              ; вх: hl - адрес пути (=#0000 - путь отсутствует)
 589+ 0E57              ; de - адрес дескриптора директории/файла
 590+ 0E57              ; вых: a - если путь был указан, новая длина пути
 591+ 0E57              open_dir
 592+ 0E57 D5           	push de ;дескриптор
 593+ 0E58
 594+ 0E58              	R8FAT r8f05_OpenDir	;открыть
 594+ 0E58 0E 05       >	ld	c,r8f05_OpenDir
 594+ 0E5A CF          >	rst	#08
 594+ 0E5B 91          >	db	#91
 595+ 0E5C
 596+ 0E5C              	;скопировать дескриптор приложения
 597+ 0E5C F5           	push af
 598+ 0E5D 3A 20 2B     	ld a,(proc_id_cur)
 599+ 0E60 CD 6C 0E     	call calc_dir_deskr ;узнать дескриптор
 600+ 0E63 F1           	pop af
 601+ 0E64 EB           	ex de,hl
 602+ 0E65 E1           	pop hl ;дескриптор, отправленный приложеием
 603+ 0E66 01 20 00     	ld bc,32
 604+ 0E69 ED B0        	ldir
 605+ 0E6B C9           	ret
 606+ 0E6C
 607+ 0E6C
 608+ 0E6C
 609+ 0E6C
 610+ 0E6C
 611+ 0E6C
 612+ 0E6C              calc_dir_deskr ;определяет адрес дескриптора каталога
 613+ 0E6C 21 D5 0F     	ld hl,dir_fat_deskr
 614+ 0E6F B7           	or a
 615+ 0E70 28 0B        	jr z,calc_dir_deskr_ex ;на выход если 0
 616+ 0E72 FE 09        	cp proc_max+1
 617+ 0E74 30 07        	jr nc,calc_dir_deskr_ex ;защита
 618+ 0E76 11 20 00     	ld de,fcb_fat_size
 619+ 0E79 47           	ld b,a
 620+ 0E7A              calc_dir_deskr_cl
 621+ 0E7A 19           	add hl,de
 622+ 0E7B 10 FD        	djnz calc_dir_deskr_cl
 623+ 0E7D              calc_dir_deskr_ex
 624+ 0E7D C9           	ret
 625+ 0E7E
 626+ 0E7E
 627+ 0E7E
 628+ 0E7E
 629+ 0E7E              ; A - file stream id
 630+ 0E7E              ; fsync:
 631+ 0E7E              ;     esxCall ESX_FSYNC
 632+ 0E7E                  ; ret
 633+ 0E7E
 634+ 0E7E
 635+ 0E7E              ; ; HL - name (name.ext)
 636+ 0E7E              ; ; Returns:
 637+ 0E7E              ; ; HL - name (name    e)
 638+ 0E7E              ; format_name ;подгоняет имя файла под стандарт trdos (8+1)
 639+ 0E7E
 640+ 0E7E              	; ;сначала попробуем убрать из пути подпапку, если она есть
 641+ 0E7E              	; ld (temp_hl),hl ;сохраним адрес исходного имени
 642+ 0E7E              	; ld b,#00 ;не больше 255 символов
 643+ 0E7E              ; format_name5
 644+ 0E7E              	; ld a,(hl)
 645+ 0E7E              	; cp "/" ;если есть подпапка
 646+ 0E7E              	; jr z,format_name_path_yep
 647+ 0E7E              	; ld a,(hl)
 648+ 0E7E              	; cp "." ;если ещё не дошли до расширения
 649+ 0E7E              	; jr nz,format_name6
 650+ 0E7E              	; ld hl,(temp_hl) ;если дошли до расширения, то путей нет, вернёмся на начало имени
 651+ 0E7E              	; jr format_name_7 ;на выход
 652+ 0E7E              ; format_name6
 653+ 0E7E              	; inc hl
 654+ 0E7E              	; djnz format_name5
 655+ 0E7E
 656+ 0E7E              ; format_name_path_yep ;нашли
 657+ 0E7E              	; inc hl ;пропустим знак "/"
 658+ 0E7E
 659+ 0E7E              ; format_name_7
 660+ 0E7E
 661+ 0E7E              	; push hl ;очистим место для нового имени
 662+ 0E7E              	; ld hl,f_name
 663+ 0E7E              	; ld de,f_name+1
 664+ 0E7E              	; ld (hl)," "
 665+ 0E7E              	; ld bc,8+1
 666+ 0E7E              	; ldir
 667+ 0E7E              	; ld (hl),0
 668+ 0E7E              	; ld bc,16-8-1-1
 669+ 0E7E              	; ldir
 670+ 0E7E              	; pop hl
 671+ 0E7E
 672+ 0E7E              	; ld bc,#09ff ;длина имени 9 символов
 673+ 0E7E              	; ld de,f_name ;куда
 674+ 0E7E              ; format_name2
 675+ 0E7E              	; ld a,(hl)
 676+ 0E7E              	; cp "."
 677+ 0E7E              	; jr nz,format_name1
 678+ 0E7E              	; ld de,f_name+8
 679+ 0E7E              	; inc hl
 680+ 0E7E              	; ldi ; и в конце расширение 3 буквы
 681+ 0E7E              	; ldi
 682+ 0E7E              	; ldi
 683+ 0E7E              	; ;ex de,hl ;сохраним адрес исходного расширения
 684+ 0E7E              	; jr format_name_e
 685+ 0E7E              ; format_name1
 686+ 0E7E              	; ldi
 687+ 0E7E              	; djnz format_name2
 688+ 0E7E
 689+ 0E7E              	; ;если имя длинное, пропустим лишнее до расширения
 690+ 0E7E              	; ld b,#00 ;не больше 255 символов
 691+ 0E7E              ; format_name3
 692+ 0E7E              	; ld a,(hl)
 693+ 0E7E              	; cp "."
 694+ 0E7E              	; jr nz,format_name4
 695+ 0E7E              	; ld de,f_name+8
 696+ 0E7E              	; inc hl
 697+ 0E7E              	; ldi ; и в конце расширение 3 буквы
 698+ 0E7E              	; ldi
 699+ 0E7E              	; ldi
 700+ 0E7E              	; ;ex de,hl ;сохраним адрес исходного расширения
 701+ 0E7E              	; jr format_name_e
 702+ 0E7E              ; format_name4
 703+ 0E7E              	; inc hl
 704+ 0E7E              	; djnz format_name3
 705+ 0E7E
 706+ 0E7E              ; format_name_e ;выход
 707+ 0E7E              	; ld hl,f_name ;вернём результат
 708+ 0E7E              	; ret
 709+ 0E7E
 710+ 0E7E              ; DE - trk/sec
 711+ 0E7E              ; B - sectors step
 712+ 0E7E              ; Returns:
 713+ 0E7E              ; DE - trk/sec
 714+ 0E7E              ; calc_next_pos		;вперёд на N секторов
 715+ 0E7E              			; ;ld b,4
 716+ 0E7E              			; ;ld  de,(#5ceb)
 717+ 0E7E              ; calc_next_pos2
 718+ 0E7E              			; inc e
 719+ 0E7E              			; ld a,e
 720+ 0E7E              			; cp 16
 721+ 0E7E              			; jr c,calc_next_pos1
 722+ 0E7E              			; inc d
 723+ 0E7E              			; ld e,0
 724+ 0E7E              ; calc_next_pos1
 725+ 0E7E              			; ;ld (#5ceb),de
 726+ 0E7E              			; djnz calc_next_pos2
 727+ 0E7E              			; ret
 728+ 0E7E
 729+ 0E7E
 730+ 0E7E              ;testt db "123.trd"
 731+ 0E7E              ; write_ima db "Select disk "
 732+ 0E7E              ; write_ima_d db "A: (E-" ;текущая буква
 733+ 0E7E              ; write_ima_e	db "D)> " ;последняя буква
 734+ 0E7E              		; db 13,10,0
 735+ 0E7E              ;prev_drive db 0 ;предыдущий номер дисковода
 736+ 0E7E 00           fs_drive_number_cur db 0 ;текущий диск/раздел
 737+ 0E7F
 738+ 0E7F              ; ; trdExt1 db ".trd", 0
 739+ 0E7F              ; ; trdExt2 db ".TRD", 0
 740+ 0E7F
 741+ 0E7F              ; ; sclExt1 db ".scl", 0
 742+ 0E7F              ; ; sclExt2 db ".SCL", 0
 743+ 0E7F
 744+ 0E7F              ; f_name ds 16 ;имя файла
 745+ 0E7F              ; f_r_cur_trk dw 	 0 ;текущие сектор-дорожка файла на чтение
 746+ 0E7F              ; f_r_len_sec db 0 ;длина файла на чтение в секторах
 747+ 0E7F              ; f_r_len dw 0;длина файла в байтах
 748+ 0E7F              ; f_r_flag db 0 ;флаг что открыт файл на чтение
 749+ 0E7F
 750+ 0E7F              ; f_w_cur_trk dw 	 0 ;текущие сектор-дорожка файла на запись
 751+ 0E7F              ; f_w_len_sec db 0 ;длина файла на запись в секторах
 752+ 0E7F              ; f_w_flag db 0 ;флаг что открыт файл на запись
 753+ 0E7F              ; f_w_len ds 4 ;длина записанных данных
 754+ 0E7F              ; write_end_flag db 0 ;флаг что нужно записать остаток
 755+ 0E7F
 756+ 0E7F              ; temp_bc dw 0 ;хранение регистра
 757+ 0E7F              ; temp_hl dw 0 ;хранение регистра
 758+ 0E7F              ; temp_hl2 dw 0 ;хранение регистра
 759+ 0E7F
 760+ 0E7F              ; sec_shift db 0 ;указатель на каком байте остановлена запись
 761+ 0E7F              ; sec_shift2 db 0 ;указатель на каком байте остановлена запись (остаток)
 762+ 0E7F              ; sec_part db 0 ;сколько секторов во второй порции для записи
 763+ 0E7F              ; sec_shift_flag db 0 ;флаг что буфер сектора не заполнен
 764+ 0E7F
 765+ 0E7F              ; ;секция scl
 766+ 0E7F              ; scl_sign db "SINCLAIR" ;метка
 767+ 0E7F              ; scl_que db 0 ;флаг запроса порции данных
 768+ 0E7F              ; scl_err db "SCL image error!",0
 769+ 0E7F              ; scl_parse_ret_adr dw 0; адрес возврата в цикл
 770+ 0E7F              ; scl_cat_cycl db 0 ;переменная цикла
 771+ 0E7F              ; scl_files db 0 ;всего файлов
 772+ 0E7F              ; scl_temp_hl dw 0;;хранение регистра
 773+ 0E7F              ; scl_temp_hl2 dw 0;
 774+ 0E7F              ; scl_temp_de dw 0;
 775+ 0E7F              ; scl_temp_bc dw 0;
 776+ 0E7F              ; cat_cur_adr dw 0;
 777+ 0E7F              ; ;scl end
 778+ 0E7F
 779+ 0E7F              ; ;секция сохранения любого файла
 780+ 0E7F              ; file_err db "Not enough space!",0
 781+ 0E7F              ; sec_cat db 0 ;сектор каталога
 782+ 0E7F              ; file_num db "0" ;номер части для больших файлов
 783+ 0E7F
 784+ 0E7F              	; ;по адресу #4000 шрифт
 785+ 0E7F              ; cat_buf equ #4800 ;буфер для кататога диска 9*256
 786+ 0E7F              ; sec_buf equ cat_buf + 9*256 ;буфер сектора для записи 256
 787+ 0E7F              ; scl_buf equ sec_buf + 512 ;промежуточный буфер 256
 788+ 0E7F              ; scl_buf2 equ scl_buf + 512 ;промежуточный буфер 256
 789+ 0E7F              ; ;общая ошибка с файлами
 790+ 0E7F              ; com_file_err db "File error!",0
 791+ 0E7F              ;com_file_err_flag db 0 ;общая ошибка
 792+ 0E7F
 793+ 0E7F
 794+ 0E7F
 795+ 0E7F
 796+ 0E7F              ;Раздел SMUC и SD ------------------------------------
 797+ 0E7F
 798+ 0E7F
 799+ 0E7F              ;список доступных разделов на винчестерах
 800+ 0E7F              ;7,=0/1 тип раздела MFS/FAT
 801+ 0E7F              ;6,=1 раздел есть
 802+ 0E7F              ;3,=0/1 Hdd/SD card
 803+ 0E7F              ;2,=0/1 для HDD master/slave
 804+ 0E7F              ;0..1,=?? номер раздела
 805+ 0E7F              ;
 806+ 0E7F 00 00 00...  typeDrive	ds 3*4+1
 807+ 0E8C              ;typeDriveFAT	ds 3*4+1 ;список всех разделов FAT
 808+ 0E8C 00           numDrives db 0 ;количество устройств
 809+ 0E8D              ;numDrivesFAT db 0 ;количество устройств FAT
 810+ 0E8D 00           next_lett db 0 ;следующая свободная буква диска
 811+ 0E8E
 812+ 0E8E              ;подсчет количества доступных разделов на всех устройствах
 813+ 0E8E              ;вых: hl,a - количество устройств
 814+ 0E8E              ;     typeDrives - сформированная таблица
 815+ 0E8E              ;     cy=1 не обнаружено ни одного устройства
 816+ 0E8E              ;
 817+ 0E8E              GetNumPart
 818+ 0E8E              ;
 819+ 0E8E D5           	push	de
 820+ 0E8F C5           	push	bc
 821+ 0E90 21 7F 0E     	ld	hl,typeDrive
 822+ 0E93 E5           	push	hl
 823+ 0E94 AF           	xor	a
 824+ 0E95 CD AF 0E     	call	proc_01			;HDD master
 825+ 0E98 3E 01        	ld	a,#01
 826+ 0E9A CD AF 0E     	call	proc_01			;HDD slave
 827+ 0E9D 3E 02        	ld	a,#02
 828+ 0E9F CD AF 0E     	call	proc_01			;SD card
 829+ 0EA2 D1           	pop	de
 830+ 0EA3 B7           	or	a
 831+ 0EA4 ED 52        	sbc	hl,de			;количество разделов на HDD
 832+ 0EA6              	IFDEF	useTRD
 833+ 0EA6 ~            	 ld	a,l
 834+ 0EA6 ~            	 add	a,#04
 835+ 0EA6 ~            	 ld	l,a
 836+ 0EA6              	ELSE
 837+ 0EA6 7D           	 ld	a,l
 838+ 0EA7              	ENDIF
 839+ 0EA7 C1           	pop	bc
 840+ 0EA8 D1           	pop	de
 841+ 0EA9 32 8C 0E     	ld	(numDrives),a
 842+ 0EAC FE 01        	cp	1
 843+ 0EAE C9           	ret
 844+ 0EAF
 845+ 0EAF              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 846+ 0EAF              ;формирование таблицы с доступными разделами на винчестере
 847+ 0EAF              ;вх:  a =#00 выбрать master
 848+ 0EAF              ;       =#01 выбрать slave
 849+ 0EAF              ;       =#02 выбрать SD card
 850+ 0EAF              ;     hl - адрес в таблице разделов typeDrives
 851+ 0EAF              ;вых: hl - новый адрес в таблице разделов typeDrives
 852+ 0EAF              ;
 853+ 0EAF 4F           proc_01	ld	c,a
 854+ 0EB0 E5           	push	hl
 855+ 0EB1 C5           	push	bc
 856+ 0EB2              	R8DOS	r8d2E_CngHDD
 856+ 0EB2 0E 2E       >	ld	c,r8d2E_CngHDD
 856+ 0EB4 CF          >	rst	#08
 856+ 0EB5 81          >	db	#81
 857+ 0EB6 38 04        	jr	c,goto001		;на текущем канале нет винчестера
 858+ 0EB8              	R8DOS	r8d2D_FindPart
 858+ 0EB8 0E 2D       >	ld	c,r8d2D_FindPart
 858+ 0EBA CF          >	rst	#08
 858+ 0EBB 81          >	db	#81
 859+ 0EBC C1           goto001	pop	bc
 860+ 0EBD E1           	pop	hl
 861+ 0EBE D8           	ret	c			;на текущем винчестере нет разделов
 862+ 0EBF 47           	ld	b,a
 863+ 0EC0 79           	ld	a,c
 864+ 0EC1 87           	add	a,a
 865+ 0EC2 87           	add	a,a
 866+ 0EC3 4F           	ld	c,a			;номер винчестера и первого раздела
 867+ 0EC4 78           	ld	a,b
 868+ 0EC5 06 04        	ld	b,#04
 869+ 0EC7 36 00        loop001	ld	(hl),#00
 870+ 0EC9 1F           	rra
 871+ 0ECA 30 0A        	jr	nc,goto002		;нет раздела
 872+ 0ECC              	IFDEF	useMFS
 873+ 0ECC ~            	 ld	(hl),c
 874+ 0ECC ~            	 set	6,(hl)			;=%01???hpp MFS
 875+ 0ECC ~            	 rra
 876+ 0ECC ~            	 jr	nc,goto003		;это MFS
 877+ 0ECC ~            	 set	7,(hl)			;=%11???hpp это FAT
 878+ 0ECC              	ELSE
 879+ 0ECC 1F           	 rra
 880+ 0ECD 30 08        	 jr	nc,goto004		;это MFS
 881+ 0ECF 71           	 ld	(hl),c
 882+ 0ED0 CB F6        	 set	6,(hl)			;раздел есть
 883+ 0ED2 CB FE        	 set	7,(hl)			;=%11???hpp это FAT
 884+ 0ED4              	ENDIF
 885+ 0ED4 23           goto003	inc	hl
 886+ 0ED5 17           	rla
 887+ 0ED6 1F           goto002	rra
 888+ 0ED7 0C           goto004	inc	c
 889+ 0ED8 10 ED        	djnz	loop001
 890+ 0EDA C9           	ret
 891+ 0EDB
 892+ 0EDB
 893+ 0EDB
 894+ 0EDB              ;конец секции SMUC и SD ----------------------------
 895+ 0EDB
 896+ 0EDB
 897+ 0EDB              find_empty_fcb_fat ;поиск свободного fcb для файла
 898+ 0EDB              	;выход hl - fcb; a - file_id
 899+ 0EDB 21 05 11     	ld hl,fcb_fat_table
 900+ 0EDE 0E 00        	ld c,0 ;номер файла
 901+ 0EE0 06 08        	ld b,files_fat_max ;цикл
 902+ 0EE2              find_empty_fcb_fat_cl
 903+ 0EE2 7E           	ld a,(hl)
 904+ 0EE3 B7           	or a
 905+ 0EE4 28 06        	jr z,find_empty_fcb_fat_ex
 906+ 0EE6 23           	inc hl
 907+ 0EE7 0C           	inc c
 908+ 0EE8 10 F8        	djnz find_empty_fcb_fat_cl
 909+ 0EEA              	;не нашли свободного
 910+ 0EEA 37           	scf
 911+ 0EEB C9           	ret
 912+ 0EEC              find_empty_fcb_fat_ex
 913+ 0EEC              	;вычислить адрес fcb
 914+ 0EEC 21 23 11     	ld hl,fcb_fat
 915+ 0EEF 0C           	inc c
 916+ 0EF0 0D           	dec c
 917+ 0EF1 28 07        	jr z,find_empty_fcb_fat_ex1
 918+ 0EF3 11 20 00     	ld de,fcb_fat_size
 919+ 0EF6 41           	ld b,c
 920+ 0EF7              find_empty_fcb_fat_cl2
 921+ 0EF7 19           	add hl,de
 922+ 0EF8 10 FD        	djnz find_empty_fcb_fat_cl2
 923+ 0EFA              find_empty_fcb_fat_ex1
 924+ 0EFA 79           	ld a,c ;file-id
 925+ 0EFB B7           	or a
 926+ 0EFC C9           	ret
 927+ 0EFD
 928+ 0EFD
 929+ 0EFD              find_fcb_fat ;поиск fcb файла по номеру
 930+ 0EFD              	;вх: a - id файла
 931+ 0EFD              	;вых: hl - fcb; a - значение из fcb_fat_table
 932+ 0EFD 21 23 11     	ld hl,fcb_fat
 933+ 0F00 B7           	or a
 934+ 0F01 28 07        	jr z,find_fcb_fat_ex
 935+ 0F03 47           	ld b,a
 936+ 0F04 11 20 00     	ld de,fcb_fat_size
 937+ 0F07              find_fcb_fat_cl
 938+ 0F07              	;вычислить адрес fcb
 939+ 0F07 19           	add hl,de
 940+ 0F08 10 FD        	djnz find_fcb_fat_cl
 941+ 0F0A              find_fcb_fat_ex
 942+ 0F0A E5           	push hl
 943+ 0F0B 21 05 11     	ld hl,fcb_fat_table
 944+ 0F0E 4F           	ld c,a
 945+ 0F0F 06 00        	ld b,0
 946+ 0F11 09           	add hl,bc
 947+ 0F12 7E           	ld a,(hl) ;вернуть флаг
 948+ 0F13 E1           	pop hl
 949+ 0F14 C9           	ret
 950+ 0F15
 951+ 0F15
 952+ 0F15
 953+ 0F15
 954+ 0F15
 955+ 0F15 00           file_fat_id_cur db 0 ;текущий файл id
 956+ 0F16 00           fs_fat_part_code_cur db 0 ;текущий раздел
 957+ 0F17 46 6F 75 6E  msg_fat_found db "Found FAT:",13,10,0
 957+ 0F1B 64 20 46 41
 957+ 0F1F 54 3A 0D 0A
 957+ 0F23 00
 958+ 0F24 46 6F 75 6E  msg_fat_found_os db "Found OS on disk: ",0
 958+ 0F28 64 20 4F 53
 958+ 0F2C 20 6F 6E 20
 958+ 0F30 64 69 73 6B
 958+ 0F34 3A 20 00
 959+ 0F37 46 41 54 20  msg_fat_not_found db "FAT not found",13,10,0
 959+ 0F3B 6E 6F 74 20
 959+ 0F3F 66 6F 75 6E
 959+ 0F43 64 0D 0A 00
 960+ 0F47 46 41 54 20  msg_fat_init_error db "FAT init_error",13,10,0
 960+ 0F4B 69 6E 69 74
 960+ 0F4F 5F 65 72 72
 960+ 0F53 6F 72 0D 0A
 960+ 0F57 00
 961+ 0F58 46 69 6C 65  msg_file_error_general db "File error",13,10,0
 961+ 0F5C 20 65 72 72
 961+ 0F60 6F 72 0D 0A
 961+ 0F64 00
 962+ 0F65 46 69 6C 65  msg_file_too_big db "File too_big",13,10,0
 962+ 0F69 20 74 6F 6F
 962+ 0F6D 5F 62 69 67
 962+ 0F71 0D 0A 00
 963+ 0F74 46 69 6C 65  msg_file_not_found db "File not found",13,10,0
 963+ 0F78 20 6E 6F 74
 963+ 0F7C 20 66 6F 75
 963+ 0F80 6E 64 0D 0A
 963+ 0F84 00
 964+ 0F85 46 69 6C 65  msg_file_open_error db "File open error",13,10,0
 964+ 0F89 20 6F 70 65
 964+ 0F8D 6E 20 65 72
 964+ 0F91 72 6F 72 0D
 964+ 0F95 0A 00
 965+ 0F97 46 69 6C 65  msg_file_read_error db "File read error",13,10,0
 965+ 0F9B 20 72 65 61
 965+ 0F9F 64 20 65 72
 965+ 0FA3 72 6F 72 0D
 965+ 0FA7 0A 00
 966+ 0FA9 44 69 72 65  msg_dir_not_found db "Directory not found",13,10,0
 966+ 0FAD 63 74 6F 72
 966+ 0FB1 79 20 6E 6F
 966+ 0FB5 74 20 66 6F
 966+ 0FB9 75 6E 64 0D
 966+ 0FBD 0A 00
 967+ 0FBF 00 00        file_size_tmp dw 0 ;временно
 968+ 0FC1
 969+ 0FC1 00           fs_fat_init_flag: db 0 ;флаг инициализации
 970+ 0FC2 5C 4F 53 5A  OS_PathFAT db "\\OSZ",0 ;папка ОС
 970+ 0FC6 00
 971+ 0FC7
 972+ 0FC7 66 61 74 5F  	db "fat_dir_descr:" ;дескрипторы открытых папок fat по одной на приложение
 972+ 0FCB 64 69 72 5F
 972+ 0FCF 64 65 73 63
 972+ 0FD3 72 3A
 973+ 0FD5 00 00 00...  dir_fat_deskr ds fcb_fat_size*(proc_max+1)	;дескрипторы папок
 974+ 10F5
 975+ 10F5
 976+ 10F5 66 61 74 5F  	db "fat_files_table:"
 976+ 10F9 66 69 6C 65
 976+ 10FD 73 5F 74 61
 976+ 1101 62 6C 65 3A
 977+ 1105 00 00 00...  fcb_fat_table ds files_fat_max ;флаги открытия файлов
 978+ 110D 00 00 00...  fcb_trd_table ds files_trd_max ;флаги открытия файлов
 979+ 1115
 980+ 1115 66 61 74 5F  	db "fat_files_fcb:"
 980+ 1119 66 69 6C 65
 980+ 111D 73 5F 66 63
 980+ 1121 62 3A
 981+ 1123 00 00 00...  fcb_fat ds fcb_fat_size*files_fat_max ;для файлов fat
 982+ 1223 00 00 00...  fcb_trd ds fcb_fat_size*files_trd_max ;для файлов trd
 983+ 1323
 984+ 1323
 985+ 1323
 986+ 1323                  ENDMODULE
# file closed: Drv/zsfat.asm
2458  1323              	include Drv/DrvKey.main.a80 ;драйвер клавиатуры
# file opened: Drv/DrvKey.main.a80
   1+ 1323              ;ࠩ  
   2+ 1323              ;Driver Keyboard v2.10
   3+ 1323              ;(c) 2002-2024 LW aka PLM
   4+ 1323              ;
   5+ 1323              ;Date Creating: 10.07.2002
   6+ 1323              ;Last   Update: 17.01.2024
   7+ 1323              ;Last  Edition: 17.01.2024
   8+ 1323              ;
   9+ 1323              ;:
  10+ 1323              ;DrvKey.main.a80	-  䠩
  11+ 1323              ;DrvKey.asm.a80		- 楤
  12+ 1323              ;DrvKey.var.a80		- ६
  13+ 1323              ;DrvKey.info		- ଠ  ࠩ
  14+ 1323              ;DrvKey.lua.a80		- LUA
  15+ 1323              ;
  16+ 1323              ;------------------------------------------------------------------------------
  17+ 1323              ; 樨
  18+ 1323              ;	DEVICE 	ZXSPECTRUM128
  19+ 1323              ;	INCLUDE "DrvKey.lua.a80"
  20+ 1323              ;	PAGE	#XX
  21+ 1323              	MODULE	DrvKey
  22+ 1323
  23+ 1323              ;------------------------------------------------------------------------------
  24+ 1323              ;⠭ ࠩ
  25+ 1323
  26+ 1323              ; ᥬ஢:
  27+ 1323              AdrDrvKeyboard	equ $ ;#XXXX
  28+ 1323
  29+ 1323              ;   
  30+ 1323              keyLeft		equ #08
  31+ 1323              keyRight	equ #09
  32+ 1323              keyUp		equ #0B
  33+ 1323              keyDown		equ #0A
  34+ 1323
  35+ 1323              ;࠭ /
  36+ 1323              keyPageDown	equ #05
  37+ 1323              keyPageUp	equ #04
  38+ 1323
  39+ 1323              ;/砫 ப, insert
  40+ 1323              keyHome		equ #01
  41+ 1323              keyEnd		equ #03
  42+ 1323              keyInsert	equ #02
  43+ 1323
  44+ 1323              ;⥬ 
  45+ 1323              keyBreak	equ #18
  46+ 1323              keyEdit		equ #07
  47+ 1323              keyCaps		equ #06
  48+ 1323              keyBackSpace	equ #0C
  49+ 1323              keyDelete	equ #0F
  50+ 1323              keyEnter	equ #0D
  51+ 1323
  52+ 1323              ;CapsShift/SymbolShift   樨
  53+ 1323              keyCS		equ #1C
  54+ 1323              keySS		equ #1D
  55+ 1323              keyCsEnter	equ #19
  56+ 1323              keySsSpace	equ #1A		;tab
  57+ 1323              keySsEnter	equ #1B
  58+ 1323              keyExtMode	equ #0E
  59+ 1323
  60+ 1323              ;  ० EXT mode (cs+ss+key)
  61+ 1323              keyWordLeft	equ #10
  62+ 1323              keyWordRight	equ #11
  63+ 1323              keyGrf		equ #12
  64+ 1323              keyDelEnd	equ #13
  65+ 1323              keyDelBegin	equ #16
  66+ 1323              keyCsSsSpace	equ #14
  67+ 1323              keyCsSsEnter	equ #15
  68+ 1323              ;free code: #00,#17,#1E,#1F
  69+ 1323
  70+ 1323              ; 譨 ⠡  ᪫ 
  71+ 1323              ;OutsideGrfTable		equ #XXXX ;#0000
  72+ 1323              ;OutsideRus_jcuken	equ #XXXX ;#0000
  73+ 1323              ;OutsideRus_qwerty	equ #XXXX ;#0000
  74+ 1323
  75+ 1323              ;------------------------------------------------------------------------------
  76+ 1323              ;᫮ ࠭樨
  77+ 1323
  78+ 1323              ; ᯮ짮 /  48k
  79+ 1323              	;DEFINE	Used_ROM ;
  80+ 1323              	DEFINE	UseEXTkeys	;ᯮ짮 権 cs+ss+key
  81+ 1323              	DEFINE	CommandMode	;ᯮ짮  ०
  82+ 1323              	IFDEF	Used_ROM
  83+ 1323 ~            	UNDEFINE UseEXTkeys
  84+ 1323              	ENDIF
  85+ 1323
  86+ 1323              ;祭 ᪫ 
  87+ 1323              	DEFINE	GrfMode		;ᯮ짮 ᪫ grf
  88+ 1323              	DEFINE	RusMode		;ᯮ짮 ᪫ rus
  89+ 1323
  90+ 1323              ;祭 ⠡ ᪫
  91+ 1323              	DEFINE	TblKeyGrf_ver1
  92+ 1323              	DEFINE	Rus_jcuken
  93+ 1323              	DEFINE	Rus_qwerty
  94+ 1323
  95+ 1323              ;祭 ⠡ EXT+key (command mode)
  96+ 1323              ;  ᯮ짮 ⮫쪮 
  97+ 1323              	IFDEF	UseEXTkeys
  98+ 1323              	DEFINE	TblEXTkey_Test	;⮢ ᪫
  99+ 1323              ;	DEFINE	TblEXTkey_Word	; ZX-Word
 100+ 1323              	ENDIF
 101+ 1323
 102+ 1323              ;  ᯮ ७ ⠡ ᪫ 
 103+ 1323              	DEFINE	InsideGrfTable
 104+ 1323              	DEFINE	InsideRusTable
 105+ 1323
 106+ 1323              ;祭 㭪樨 ࠩ
 107+ 1323              ;	DEFINE  NoFuncDrvKey	; 楤 맮 㭪権 ࠩ
 108+ 1323              	DEFINE	NoCtlDrvKey	; ஢ન  ⢮ 㭪樨
 109+ 1323              	DEFINE	DrvKey_02	;⠭/祭 䫠 ࠩ
 110+ 1323              	DEFINE	DrvKey_03	;⠭ ਮ প  ⮯
 111+ 1323              	DEFINE	DrvKey_04	;祭 ਮ প  ⮯
 112+ 1323
 113+ 1323              ;------------------------------------------------------------------------------
 114+ 1323
 115+ 1323              	ORG	AdrDrvKeyboard
 116+ 1323              Start	INCLUDE	"DrvKey.asm.a80"
# file opened: Drv/DrvKey.asm.a80
   1++1323              ;楤  Keyboard Driver
   2++1323              ;䠩 DrvKey.asm.a80
   3++1323              ;
   4++1323              ;DriverKeyboard		맮 ࠩ 
   5++1323              ;FunctDrvKeyboard	맮 㭪樨 ࠩ 
   6++1323              ;GetCodesPressKey	祭  ⮩ 
   7++1323              ;GetRepeatDelays	祭 ਮ প  ⮯
   8++1323              ;SetRepeatDelays	⠭ ਮ প  ⮯
   9++1323              ;SetFlagsDriver		⠭/祭 䫠 ࠩ
  10++1323              ;ScanKeyboardDelay	   ⮬ ६ থ
  11++1323              ;ScanKeyboard		   
  12++1323              ;ScanAllKeys		   
  13++1323              ;
  14++1323              ;------------------------------------------------------------------------------
  15++1323              ;------------------------------------------------------------------------------
  16++1323              ;맮 ࠩ 
  17++1323              ;: 6,(FlgScanKeys) =1 -     
  18++1323              ;     hl=FlgScanKeys
  19++1323              ;     d - ᪠ ⮩ 
  20++1323              ;     a,e -   ⮩   ⥪饩 ᪫ 
  21++1323              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  22++1323              ;     bc -  ।
  23++1323              ;
  24++1323 C3 5B 13     @DriverKeyboard		jp	ScanKeyboardDelay
  25++1326
  26++1326              ;------------------------------------------------------------------------------
  27++1326              	IFNDEF	NoFuncDrvKey
  28++1326              ;맮 㭪樨 ࠩ 
  29++1326              ;:  c -  㭪樨 [#00..#04]
  30++1326              ;     hl,de,b,a - ࠬ 㭪樨
  31++1326              ;: ॣ ⠭  ⢥⢨  뢠 㭪樥
  32++1326              ;
  33++1326              @FunctDrvKeyboard
  34++1326              ;
  35++1326              	IFDEF	NoCtlDrvKey
  36++1326 E5           	 push	hl
  37++1327 F5           	 push	af
  38++1328 78           	 ld	a,b
  39++1329 06 00        	 ld	b,#00
  40++132B 21 38 13     	 ld	hl,TableAdrFunct
  41++132E 09           	 add	hl,bc
  42++132F 09           	 add	hl,bc
  43++1330 47           	 ld	b,a
  44++1331 7E           	 ld	a,(hl)
  45++1332 23           	 inc	hl
  46++1333 66           	 ld	h,(hl)
  47++1334 6F           	 ld	l,a
  48++1335 F1           	 pop	af
  49++1336 E3           	 ex	(sp),hl
  50++1337 C9           	 ret
  51++1338              	ELSE
  52++1338 ~            	 push	hl
  53++1338 ~            	 push	af
  54++1338 ~            	 ld	a,c
  55++1338 ~            	 cp	#05
  56++1338 ~            	 jr	nc,goto017		;騩  㭪樨
  57++1338 ~            	 ld	a,b
  58++1338 ~            	 ld	hl,TableAdrFunct
  59++1338 ~            	 ld	b,#00
  60++1338 ~            	 add	hl,bc
  61++1338 ~            	 add	hl,bc
  62++1338 ~            	 ld	b,a
  63++1338 ~            	 ld	a,(hl)
  64++1338 ~            	 inc	hl
  65++1338 ~            	 ld	h,(hl)
  66++1338 ~            	 ld	l,a
  67++1338 ~            	 and	h
  68++1338 ~            	 inc	a
  69++1338 ~            	 jr	z,goto017		;㭪  
  70++1338 ~            	 pop	af
  71++1338 ~            	 ex	(sp),hl
  72++1338 ~            	 ret
  73++1338 ~            goto017	 pop	af
  74++1338 ~            	 pop	hl
  75++1338 ~            	 ret
  76++1338              	ENDIF
  77++1338
  78++1338              	ENDIF
  79++1338
  80++1338              ;------------------------------------------------------------------------------
  81++1338              TableAdrFunct	ifused
  82++1338              ;⠡ ᮢ 㭪権 ࠩ
  83++1338              ;TableAdrFunct
  84++1338              ;
  85++1338 97 13        		  dw ScanKeyboard
  86++133A 42 13        		  dw GetCodesPressKey
  87++133C               IFDEF DrvKey_02
  87++133C 52 13          dw SetFlagsDriver
  87++133E                 ELSE
  87++133E ~              dw #FFFF
  87++133E               ENDIF
  88++133E               IFDEF DrvKey_03
  88++133E 4D 13          dw SetRepeatDelays
  88++1340                ELSE
  88++1340 ~              dw #FFFF
  88++1340               ENDIF
  89++1340               IFDEF DrvKey_04
  89++1340 48 13          dw GetRepeatDelays
  89++1342                ELSE
  89++1342 ~              dw #FFFF
  89++1342               ENDIF
  90++1342              		endif
  91++1342
  92++1342              ;------------------------------------------------------------------------------
  93++1342              GetCodesPressKey	ifused
  94++1342              ;祭  ⮩ 
  95++1342              ;:  ----
  96++1342              ;: d - ᪠ ⮩ 
  97++1342              ;     a,e -   ⮩   ⥪饩 ᪫ 
  98++1342              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  99++1342              ;
 100++1342              ;GetCodesPressKey
 101++1342              ;
 102++1342 ED 5B 2F 16  	ld	de,(PrintCodePresKey)
 103++1346 7B           	ld	a,e
 104++1347 C9           	ret
 105++1348
 106++1348              	endif
 107++1348
 108++1348              ;------------------------------------------------------------------------------
 109++1348              GetRepeatDelays	ifused
 110++1348              ;祭 ਮ প  ⮯
 111++1348              ;:  ----
 112++1348              ;: d - ਮ ⮯
 113++1348              ;     e - প । ⮯஬
 114++1348              ;
 115++1348              ;GetRepeatDelays
 116++1348              ;
 117++1348 ED 5B 2D 16  	ld      de,(KeyRepeatDelay)
 118++134C C9           	ret
 119++134D
 120++134D              	endif
 121++134D
 122++134D              ;------------------------------------------------------------------------------
 123++134D              SetRepeatDelays	ifused
 124++134D              ;⠭ ਮ প  ⮯
 125++134D              ;:  d - ਮ ⮯
 126++134D              ;     e - প । ⮯஬
 127++134D              ;: ॣ  
 128++134D              ;
 129++134D              ;SetRepeatDelays
 130++134D              ;
 131++134D ED 53 2D 16  	ld	(KeyRepeatDelay),de
 132++1351 C9           	ret
 133++1352
 134++1352              	endif
 135++1352
 136++1352              ;------------------------------------------------------------------------------
 137++1352              SetFlagsDriver	ifused
 138++1352              ;e⠭/祭 䫠 ࠩ
 139++1352              ;:  d - ᪠ 䫠
 140++1352              ;     e - 塞 䫠
 141++1352              ;: a - 䫠 ࠩ
 142++1352              ;
 143++1352              ;SetFlagsDriver
 144++1352              ;
 145++1352 3A 2B 16     	ld	a,(FlgScanKeys)
 146++1355 A2           	and	d
 147++1356 B3           	or	e
 148++1357 32 2B 16     	ld	(FlgScanKeys),a
 149++135A C9           	ret
 150++135B
 151++135B              	endif
 152++135B
 153++135B              ;------------------------------------------------------------------------------
 154++135B              ;   ⮬ ६ থ
 155++135B              ;:  (PrintCodePresKey) -   ⮩ 
 156++135B              ;: 6,(FlgScanKeys) =1 -     
 157++135B              ;     hl=FlgScanKeys
 158++135B              ;     d - ᪠ ⮩ 
 159++135B              ;     a,e -   ⮩   ⥪饩 ᪫ 
 160++135B              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
 161++135B              ;     bc -  ।
 162++135B              ;
 163++135B              ScanKeyboardDelay
 164++135B              ;
 165++135B CD 97 13     	call	ScanKeyboard		;a=(PrintCodePresKey)
 166++135E 21 2B 16     	ld	hl,FlgScanKeys
 167++1361 CB F6        	set	6,(hl)
 168++1363              ;	ld	a,(PrintCodePresKey)
 169++1363 FE FF        	cp	#FF
 170++1365 28 24        	jr	z,goto012		;  
 171++1367 FE 00        cng_01	cp	#00
 172++1369 20 1E        	jr	nz,goto013		; 㣠 
 173++136B ED 4B 2D 16  	ld	bc,(KeyRepeatDelay)
 174++136F 11 00 00     cng_02	ld	de,#0000
 175++1372 1C           	inc	e
 176++1373 20 01        	jr	nz,goto014
 177++1375 1D           	dec	e
 178++1376 7B           goto014	ld	a,e
 179++1377 B9           	cp	c
 180++1378 20 17        	jr	nz,goto015		;প  ⮯
 181++137A 1D           	dec	e
 182++137B 14           	inc	d
 183++137C 20 01        	jr	nz,goto016
 184++137E 15           	dec	d
 185++137F 7A           goto016	ld	a,d
 186++1380 B8           	cp	b
 187++1381 38 0E        	jr	c,goto015
 188++1383 16 00        	ld	d,#00
 189++1385 CB B6        	res	6,(hl)
 190++1387 18 08        	jr	goto015
 191++1389 CB B6        goto013 res     6,(hl)
 192++138B 32 68 13     goto012	ld	(cng_01+1),a
 193++138E 11 00 00     	ld	de,#0000
 194++1391 ED 53 70 13  goto015	ld	(cng_02+1),de
 195++1395 18 AB        	jr	GetCodesPressKey
 196++1397
 197++1397              ;------------------------------------------------------------------------------
 198++1397              ;     樥 ⭮ 
 199++1397              ;:  (FlgScanKeys) - 䫠
 200++1397              ;: (ScanCodePresKey) - ᪠ ⮩ 
 201++1397              ;     a -   ⮩ 
 202++1397              ;     (PrintCodePresKey) -   ⮩   ⥪饩 ᪫
 203++1397              ;        (Grf\Rus\Lat)  ⮬ ० CapsLock
 204++1397              ;     7,(FlgScanKeys) =1 ⨬ 
 205++1397              ;     hl,de,bc,a -  ।
 206++1397              ;
 207++1397              ScanKeyboard
 208++1397              ;
 209++1397              ; 
 210++1397              	IFDEF	Used_ROM
 211++1397 ~            	 call	#028E
 212++1397              	ELSE
 213++1397 CD 26 14     	 call	ScanAllKeys
 214++139A              	ENDIF
 215++139A 21 2B 16     	ld	hl,FlgScanKeys
 216++139D CB AE        	res	5,(hl)
 217++139F CB BE        	res	7,(hl)
 218++13A1 28 04        	jr	z,goto006		; - 
 219++13A3 1E FF        goto021	ld	e,#FF
 220++13A5 CB FE        	set	7,(hl)			;⨬ 
 221++13A7
 222++13A7              ;室, ᫨     
 223++13A7 7B           goto006	ld	a,e
 224++13A8 32 30 16     	ld	(ScanCodePresKey),a
 225++13AB 3C           	inc	a
 226++13AC 28 73        	jr	z,goto011
 227++13AE
 228++13AE              ;  ० ⮫쪮  cs+ss
 229++13AE E5           	push	hl
 230++13AF 4E           	ld	c,(hl)			;c=(FlgScanKeys)
 231++13B0              	IFDEF	CommandMode
 232++13B0 CB 41        	 bit	0,c
 233++13B2 28 02        	 jr	z,goto018		;몫祭 Command Mode
 234++13B4              	 IFDEF	Used_ROM
 235++13B4 ~            	  ld	a,d
 236++13B4 ~            	  cp	#18
 237++13B4 ~            	  jr	z,goto019		; SS
 238++13B4              	 ELSE
 239++13B4 CB 8A        	  res	1,d			; SS
 240++13B6              	 ENDIF
 241++13B6              	ENDIF
 242++13B6
 243++13B6              ;塞    ⨭᪮ ᪫  ᪠ 
 244++13B6 7A           goto018	ld	a,d
 245++13B7              	IFDEF	Used_ROM
 246++13B7 ~            	 ld	hl,tableSSkeys
 247++13B7 ~            	 cp	#18
 248++13B7 ~            	 jr	z,goto007		; ⮩ ss
 249++13B7 ~            	 ld	hl,tableCSkeys
 250++13B7 ~            	 cp	#27
 251++13B7 ~            	 jr	z,goto007		; ⮩ cs
 252++13B7 ~            goto019	 ld	hl,tablePrnKeys
 253++13B7              	ELSE
 254++13B7 21 BB 14     	 ld	hl,tableSSkeys
 255++13BA FE 02        	 cp	#02
 256++13BC 28 12        	 jr	z,goto007		; ⮩ ss
 257++13BE              	 IFDEF	UseEXTkeys
 258++13BE 21 E3 14     	  ld	hl,tableEXTKeys
 259++13C1 CB E9        	  set	5,c			;  cs+ss
 260++13C3 30 0B        	  jr	nc,goto007		; ⮩ cs+ss
 261++13C5 CB A9        	  res	5,c
 262++13C7              	 ENDIF
 263++13C7 21 93 14     	 ld	hl,tableCSkeys
 264++13CA B7           	 or	a
 265++13CB 20 03        	 jr	nz,goto007		; ⮩ cs
 266++13CD 21 6B 14     	 ld	hl,tablePrnKeys
 267++13D0              	ENDIF
 268++13D0 16 00        goto007	ld	d,#00
 269++13D2 19           	add	hl,de
 270++13D3 5E           	ld	e,(hl)			; 
 271++13D4 E1           	pop	hl
 272++13D5 71           	ld	(hl),c
 273++13D6 7B           	ld	a,e
 274++13D7 3C           	inc	a
 275++13D8 28 C9        	jr	z,goto021
 276++13DA              ;de -   ⮩   ⨭᪮ ᪫   ० Caps
 277++13DA
 278++13DA              ;᫨ 祭  ० ⠭ ᨬ  孨 ॣ
 279++13DA              	IFDEF	CommandMode
 280++13DA 79           	 ld	a,c
 281++13DB E6 21        	 and	%00100001
 282++13DD 20 0D        	 jr	nz,goto020		;祭 Command Mode
 283++13DF              	ENDIF
 284++13DF
 285++13DF              ;४ ⭮   ⮬ ० CapsLock
 286++13DF 7B           	ld	a,e
 287++13E0 CB 49        	bit	1,c
 288++13E2 28 13        	jr	z,goto008		;caps 몫祭
 289++13E4 FE 41        	cp	"A"
 290++13E6 38 0F        	jr	c,goto008
 291++13E8 FE 5B        	cp	"Z"+1
 292++13EA 38 09        	jr	c,goto009
 293++13EC              	IFDEF	CommandMode
 294++13EC 7B           goto020	 ld	a,e
 295++13ED              	ENDIF
 296++13ED FE 61        	cp	"a"
 297++13EF 38 06        	jr	c,goto008
 298++13F1 FE 7B        	cp	"z"+1
 299++13F3 30 02        	jr	nc,goto008
 300++13F5 EE 20        goto009	xor	%00100000
 301++13F7 5F           goto008	ld	e,a
 302++13F8              ;de,a -   ⮩   ⨭᪮ ᪫
 303++13F8
 304++13F8              ; ८ࠧ, ᫨ 祭  ०
 305++13F8              	IFDEF	CommandMode
 306++13F8 79           	 ld	a,c
 307++13F9 E6 21        	 and	%00100001
 308++13FB 7B           	 ld	a,e
 309++13FC 20 23        	 jr	nz,goto011		;祭 Command Mode
 310++13FE              	ENDIF
 311++13FE
 312++13FE              ;⠭ ⭮   ᮮ⢥⢨  祭 ᪫: Grf\Rus\Lat
 313++13FE              ;  grf ᪫
 314++13FE              	IFDEF	GrfMode
 315++13FE              	 IFDEF	InsideGrfTable
 316++13FE FE 20        	  cp	#20
 317++1400 38 1F        	  jr	c,goto011
 318++1402              	 ENDIF
 319++1402 21 EB 14     	 ld	hl,TblKeyGrf
 320++1405 CB 51        	 bit	2,c
 321++1407 20 16        	 jr	nz,goto010		;祭 Grf
 322++1409              	ENDIF
 323++1409              ;  rus ᪫
 324++1409              	IFDEF	RusMode
 325++1409 CB 59        	 bit	3,c
 326++140B 28 14        	 jr	z,goto011		;᪫ rus 몫祭
 327++140D              	 IFDEF	InsideRusTable
 328++140D FE 20        	  cp	#20
 329++140F 38 10        	  jr	c,goto011
 330++1411              	 ENDIF
 331++1411              	 IFDEF	Rus_jcuken
 332++1411 21 AB 15     	  ld	hl,TblKeyRus_jcuken
 333++1414              	  IFDEF	Rus_qwerty
 334++1414 CB 61        	   bit	4,c
 335++1416 20 07        	   jr	nz,goto010		;祭 ᪫ Rus 㪥
 336++1418              	  ENDIF
 337++1418              	 ENDIF
 338++1418              	 IFDEF	Rus_qwerty
 339++1418 21 4B 15     	  ld	hl,TblKeyRus_qwerty
 340++141B              	 ENDIF
 341++141B 18 02        	 jr	goto010
 342++141D              	ENDIF
 343++141D 18 02        	jr	goto011
 344++141F 19           goto010	add	hl,de
 345++1420 5E           	ld	e,(hl)
 346++1421              ;e -   ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
 347++1421              ;     ⮬ ० CapsLock
 348++1421
 349++1421 7B           goto011 ld      a,e
 350++1422 32 2F 16             ld      (PrintCodePresKey),a
 351++1425 C9                   ret
 352++1426
 353++1426              ;------------------------------------------------------------------------------
 354++1426              ScanAllKeys	ifused
 355++1426              ;    ( /  48k #028E)
 356++1426              ;ਬ砭: ⠡ ScanCode
 357++1426              ;Ŀ
 358++1426              ; 1  2  3  4  5  6  7  8  9  0 
 359++1426              ;#24#1C#14#0C#04#03#0B#13#1B#23
 360++1426              ;Ĵ
 361++1426              ; Q  W  Q  R  T  Y  U  I  O  P 
 362++1426              ;#25#1D#15#0D#05#02#0A#12#1A#22
 363++1426              ;Ĵ
 364++1426              ; A  S  D  F  G  h  J  K  L ent
 365++1426              ;#26#1E#16#0E#06#01#09#11#19#21
 366++1426              ;Ĵ
 367++1426              ;s  Z  X  C  V  B  N  M ss sp 
 368++1426              ;#27#1F#17#0F#07#00#08#10#18#20
 369++1426              ;
 370++1426              ;:  ----
 371++1426              ;: nz - ⨬ 
 372++1426              ;       hl,de,bc,a -  ।
 373++1426              ;     z  -       CS/SS    
 374++1426              ;       e =#FF -   
 375++1426              ;       0,d/c=1   c CS
 376++1426              ;       1,d/c=1   c SS
 377++1426              ;       e - ScanCode  ⮩ 
 378++1426              ;       a=#00
 379++1426              ;       hl,b -  ।
 380++1426              ;
 381++1426              ;ScanAllKeys
 382++1426              ;
 383++1426 2E 2F        	ld	l,#27+#08
 384++1428 11 FF FF     	ld	de,#FFFF
 385++142B 01 FF FE     	ld	bc,#FEFF
 386++142E
 387++142E              ;  ⠭ ⮢   ॣ c,d,e
 388++142E 78           loop003	ld	a,b
 389++142F DB FE        	in	a,(#FE)
 390++1431 2F           	cpl
 391++1432 E6 1F        	and	#1F
 392++1434 28 0F        	jr	z,goto001
 393++1436 67           	ld	h,a
 394++1437 7D           	ld	a,l
 395++1438 0C           loop002	inc	c
 396++1439 C0           	ret	nz			;   
 397++143A D6 08        loop001	sub	#08
 398++143C CB 3C        	srl	h
 399++143E 30 FA        	jr	nc,loop001
 400++1440 4A           	ld	c,d
 401++1441 53           	ld	d,e
 402++1442 5F           	ld	e,a			; ⮩ 
 403++1443 20 F3        	jr	nz,loop002
 404++1445 2D           goto001	dec	l
 405++1446 CB 00        	rlc	b
 406++1448 38 E4        	jr	c,loop003
 407++144A              ;=key 1, d=key 2, e=key 3
 408++144A              ;=#FF, d=key 1, e=key 2
 409++144A              ;=#FF, d=#FF, e=key 1
 410++144A
 411++144A              ;஢ઠ 権 
 412++144A 79           	ld	a,c
 413++144B 3C           	inc	a
 414++144C 28 04        	jr	z,goto002		;    
 415++144E D6 28        	sub	#27+1
 416++1450 C0           	ret	nz			;ࢠ   cs
 417++1451 3C           	inc	a
 418++1452 4F           goto002	ld	c,a			;0,c=0/1   cs/ cs
 419++1453 7A           	ld	a,d
 420++1454 3C           	inc	a
 421++1455 28 11        	jr	z,goto004		;   -> e - ᪠/#FF
 422++1457 FE 28        	cp	#27+1
 423++1459 28 0C        	jr	z,goto003
 424++145B FE 19        	cp	#18+1
 425++145D 28 05        	jr	z,goto005		; ss
 426++145F 7B           	ld	a,e
 427++1460 5A           	ld	e,d
 428++1461 FE 18        	cp	#18
 429++1463 C0           	ret	nz			;⨬ 
 430++1464 CB C9        goto005	set	1,c			; ss
 431++1466 0D           	dec	c
 432++1467 0C           goto003	inc	c
 433++1468 51           goto004	ld	d,c			;0,d=0/1 cs  /
 434++1469 AF           	xor	a			;1,d=0/1 ss  /
 435++146A C9           	ret
 436++146B
 437++146B                      endif
 438++146B
 439++146B              ;==============================================================================
 440++146B              		ifused	tablePrnKeys
 441++146B              ;⠡  
 442++146B              ;cs - off
 443++146B              ;ss - off
 444++146B              ;
 445++146B 62 68 79 36  tablePrnKeys	db "bhy65tgv"	;#00-#07
 445++146F 35 74 67 76
 446++1473 6E 6A 75 37  		db "nju74rfc"	;#08-#0F
 446++1477 34 72 66 63
 447++147B 6D 6B 69 38  		db "mki83edx"	;#10-#17
 447++147F 33 65 64 78
 448++1483 1D           		db keySS	;#18
 449++1484 6C 6F 39 32  		db "lo92wsz"	;#19-#1F
 449++1488 77 73 7A
 450++148B 20           		db " "		;#20
 451++148C 0D           		db keyEnter	;#21
 452++148D 70 30 31 71  		db "p01qa"	;#22-#26
 452++1491 61
 453++1492 1C           		db keyCS	;#27
 454++1493
 455++1493              		endif
 456++1493
 457++1493              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 458++1493              		ifused	tableCSkeys
 459++1493              ;⠡  
 460++1493              ;cs - on
 461++1493              ;ss - off
 462++1493              ;
 463++1493 42 48 59     tableCSkeys	db "BHY"	;#00-#02
 464++1496 0A           		db keyDown	;#03
 465++1497 08           		db keyLeft	;#04
 466++1498 54 47 56     		db "TGV"	;#05-#07
 467++149B 4E 4A 55     		db "NJU"	;#08-#0A
 468++149E 0B           		db keyUp	;#0B
 469++149F 05           		db keyPageDown	;#0C
 470++14A0 52 46 43     		db "RFC"	;#0D-#0F
 471++14A3 4D 4B 49     		db "MKI"	;#10-#12
 472++14A6 09           		db keyRight	;#13
 473++14A7 04           		db keyPageUp	;#14
 474++14A8 45 44 58     		db "EDX"	;#15-#17
 475++14AB 0E           		db keyExtMode	;#18
 476++14AC 4C 4F        		db "LO"		;#19-#1A
 477++14AE 0F           		db keyDelete	;#1B
 478++14AF 06           		db keyCaps	;#1C
 479++14B0 57 53 5A     		db "WSZ"	;#1D-#1F
 480++14B3 18           		db keyBreak	;#20
 481++14B4 19           		db keyCsEnter	;#21
 482++14B5 50           		db "P"		;#22
 483++14B6 0C           		db keyBackSpace	;#23
 484++14B7 07           		db keyEdit	;#24
 485++14B8 51 41        		db "QA"		;#25-#26
 486++14BA 1C           		db keyCS	;#27
 487++14BB
 488++14BB              		endif
 489++14BB
 490++14BB              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 491++14BB              		ifused	tableSSkeys
 492++14BB              ;⠡  
 493++14BB              ;cs - off
 494++14BB              ;ss - on
 495++14BB              ;
 496++14BB 2A 5E 5B 26  tableSSkeys	db "*^[&%>}/"	;#00-#07
 496++14BF 25 3E 7D 2F
 497++14C3 2C 2D 5D 27  		db ",-]'$<{?"	;#08-#0F
 497++14C7 24 3C 7B 3F
 498++14CB 2E 2B 7F 28  		db ".+(#"	;#10-#14
 498++14CF 23
 499++14D0 03           		db keyEnd	;#15
 500++14D1 5C 60        		db #5C,#60	;#16-#17 (\`)
 501++14D3 1D           		db keySS	;#18
 502++14D4 3D 3B 29 40  		db "=;)@"	;#19-#1C
 503++14D8 02           		db keyInsert	;#1D
 504++14D9 7C 3A        		db "|:"		;#1E-#1F
 505++14DB 1A           		db keySsSpace	;#20
 506++14DC 1B           		db keySsEnter	;#21
 507++14DD 22           		db #22		;#22 (")
 508++14DE 5F 21        		db "_!"		;#23-#24
 509++14E0 01           		db keyHome	;#25
 510++14E1 7E           		db "~"		;#26
 511++14E2 0E           		db keyExtMode	;#27
 512++14E3
 513++14E3              		endif
 514++14E3
 515++14E3              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 516++14E3              		ifused	tableEXTKeys
 517++14E3              ;⠡  , ᪫  ZX-Word
 518++14E3              ;cs - on
 519++14E3              ;ss - on
 520++14E3              ;
 521++14E3              tableEXTKeys
 522++14E3
 523++14E3              		IFDEF	TblEXTkey_Test	;⮢ ᪫
 524++14E3 42 48 59     		db "BHY"	;#00-#02
 525++14E6 03           		db keyEnd	;#03 key 6
 526++14E7 10           		db keyWordLeft	;#04 key 5
 527++14E8 54 47 56     		db "TGV"	;#05-#07
 528++14EB 4E 4A 55     		db "NJU"	;#08-#0A
 529++14EE 01           		db keyHome	;#0B key 7
 530++14EF FF           		db #FF		;#0C key 4
 531++14F0 52 46 43     		db "RFC"	;#0D-#0F
 532++14F3 4D 4B 49     		db "MKI"	;#10-#12
 533++14F6 11           		db keyWordRight	;#13 key 8
 534++14F7 FF           		db #FF		;#14 key 3
 535++14F8 45 44 58     		db "EDX"	;#15-#17
 536++14FB FF           		db #FF		;#18 key SS
 537++14FC 4C 4F        		db "LO"		;#19-#1A
 538++14FE 13           		db keyDelEnd	;#1B key 9
 539++14FF FF           		db #FF		;#1C key 2
 540++1500 57 53 5A     		db "WSZ"	;#1D-#1F
 541++1503 14           		db keyCsSsSpace	;#20
 542++1504 15           		db keyCsSsEnter	;#21
 543++1505 50           		db "P"		;#22
 544++1506 16           		db keyDelBegin	;#23 key 0
 545++1507 12           		db keyGrf	;#24 key 1
 546++1508 51 41        		db "QA"		;#25-#26
 547++150A FF           		db #FF		;#27 key CS
 548++150B              		ENDIF
 549++150B
 550++150B              		IFDEF	TblEXTkey_Word	; ZX-Word
 551++150B ~            		db "BHY"	;#00-#02
 552++150B ~            		db keyEnd	;#03 key 6
 553++150B ~            		db keyWordLeft	;#04 key 5
 554++150B ~            		db "TG",#FF	;#05-#07
 555++150B ~            		db #FF,#FF,#FF	;#08-#0A
 556++150B ~            		db keyHome	;#0B key 7
 557++150B ~            		db #FF		;#0C key 4
 558++150B ~            		db "RFC"	;#0D-#0F
 559++150B ~            		db #FF,#FF,#FF	;#10-#12
 560++150B ~            		db keyWordRight	;#13 key 8
 561++150B ~            		db #FF		;#14 key 3
 562++150B ~            		db "EDX"	;#15-#17
 563++150B ~            		db #FF		;#18 key SS
 564++150B ~            		db #FF,"O"	;#19-#1A
 565++150B ~            		db keyDelete	;#1B key 9
 566++150B ~            		db keyInsert	;#1C key 2
 567++150B ~            		db #FF,#FF,"Z"	;#1D-#1F
 568++150B ~            		db #FF		;#20
 569++150B ~            		db #FF		;#21
 570++150B ~            		db "P"		;#22
 571++150B ~            		db keyBackSpace	;#23 key 0
 572++150B ~            		db keyEdit	;#24 key 1
 573++150B ~            		db "Q",#FF	;#25-#26
 574++150B ~            		db #FF		;#27 key CS
 575++150B              		ENDIF
 576++150B
 577++150B              		endif
 578++150B
 579++150B              ;------------------------------------------------------------------------------
 580++150B              	IFDEF	GrfMode
 581++150B              	IFDEF	TblKeyGrf_ver1
 582++150B              	IFDEF	InsideGrfTable
 583++150B
 584++150B              ;᪠ ᪫: version 01
 585++150B              ;
 586++150B              TblKeyGrf	equ $-#20
 587++150B              ;
 588++150B              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 589++150B              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 590++150B              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 591++150B              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 592++150B 20 21 22 23  	db " !",#22,"#$%&'"
 592++150F 24 25 26 27
 593++1513 28 29 2A 2B  	db "()*+,-./"
 593++1517 2C 2D 2E 2F
 594++151B 30 31 32 33  	db "01234567"
 594++151F 34 35 36 37
 595++1523 38 39 3A 3B  	db "89:;<=>?"
 595++1527 3C 3D 3E 3F
 596++152B 40 C7 D4 BD  	db "@Խ"
 596++152F B6 B7 BA C6
 597++1533 D8 CD B5 B3  	db "͵۾"
 597++1537 DB BE CF DD
 598++153B DE D6 C4 D7  	db "ո"
 598++153F D5 B8 F0 D2
 599++1543 D0 D1 D3 5B  	db "[",#5C,"]^_"
 599++1547 5C 5D 5E 5F
 600++154B 60 C3 C8 D9  	db "`ٴ"
 600++154F B4 BF B3 CC
 601++1553 CE CD B9 BA  	db "͹ʱ"
 601++1557 B0 BC CA B1
 602++155B B2 DA C4 C5  	db "ɻ"
 602++155F C9 BB FB C2
 603++1563 C1 CB C0 7B  	db "{|}~"
 603++1567 7C 7D 7E 7F
 604++156B
 605++156B              	ELSE
 606++156B ~            TblKeyGrf	equ	OutsideGrfTable
 607++156B              	ENDIF
 608++156B              	ENDIF
 609++156B              	ENDIF
 610++156B
 611++156B              ;------------------------------------------------------------------------------
 612++156B              	IFDEF	RusMode
 613++156B              	IFDEF	Rus_qwerty
 614++156B              	IFDEF	InsideRusTable
 615++156B
 616++156B              ;᪠ ᪫: 
 617++156B              ;
 618++156B              TblKeyRus_qwerty	equ $-#20
 619++156B              ;
 620++156B              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 621++156B              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 622++156B              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 623++156B              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 624++156B 20 21 22 23  	db " !",#22,"#$%&'"
 624++156F 24 25 26 27
 625++1573 28 29 2A 2B  	db "()*+,-./"
 625++1577 2C 2D 2E 2F
 626++157B 30 31 32 33  	db "01234567"
 626++157F 34 35 36 37
 627++1583 38 39 3A 3B  	db "89:;<=>?"
 627++1587 3C 3D 3E 3F
 628++158B 40 80 81 96  	db "@"
 628++158F 84 85 94 83
 629++1593 95 88 89 8A  	db ""
 629++1597 8B 8C 8D 8E
 630++159B 8F 9F 90 91  	db ""
 630++159F 92 93 86 82
 631++15A3 9C 9B 87 5B  	db "[",#5C,"]^"
 631++15A7 5C 5D 5E 9A
 632++15AB 9E A0 A1 E6  	db "椥"
 632++15AF A4 A5 E4 A3
 633++15B3 E5 A8 A9 AA  	db "娩"
 633++15B7 AB AC AD AE
 634++15BB AF EF E0 E1  	db "㦢"
 634++15BF E2 E3 A6 A2
 635++15C3 EC EB A7 98  	db "맘"
 635++15C7 9D 99 97 7F
 636++15CB
 637++15CB              	ELSE
 638++15CB ~            TblKeyRus_qwerty	equ	OutsideRus_qwerty
 639++15CB              	ENDIF
 640++15CB              	ENDIF
 641++15CB              	ENDIF
 642++15CB
 643++15CB              ;------------------------------------------------------------------------------
 644++15CB              	IFDEF	RusMode
 645++15CB              	IFDEF	Rus_jcuken
 646++15CB              	IFDEF	InsideRusTable
 647++15CB
 648++15CB              ;᪠ ᪫: 㪥
 649++15CB              ;
 650++15CB              TblKeyRus_jcuken	equ	$-#20
 651++15CB              ;
 652++15CB              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 653++15CB              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 654++15CB              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 655++15CB              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 656++15CB 20 21 22 23  	db " !",#22,"#$%&'"
 656++15CF 24 25 26 27
 657++15D3 28 29 2A 2B  	db "()*+,-./"
 657++15D7 2C 2D 2E 2F
 658++15DB 30 31 32 33  	db "01234567"
 658++15DF 34 35 36 37
 659++15E3 38 39 3A 3B  	db "89:;<=>?"
 659++15E7 3C 3D 3E 3F
 660++15EB 9E 94 88 91  	db ""
 660++15EF 82 93 80 8F
 661++15F3 90 98 8E 8B  	db ""
 661++15F7 84 9C 92 99
 662++15FB 87 89 8A 9B  	db ""
 662++15FF 85 83 8C 96
 663++1603 97 8D 9F 95  	db ""
 663++1607 9D 86 81 9A
 664++160B EE E4 A8 E1  	db "㠯"
 664++160F A2 E3 A0 AF
 665++1613 E0 E8 AE AB  	db "讫"
 665++1617 A4 EC E2 E9
 666++161B A7 A9 AA EB  	db "륣"
 666++161F A5 A3 AC E6
 667++1623 E7 AD EF E5  	db ""
 667++1627 ED A6 A1 7F
 668++162B
 669++162B              	ELSE
 670++162B ~            TblKeyRus_jcuken	equ	OutsideRus_jcuken
 671++162B              	ENDIF
 672++162B              	ENDIF
 673++162B              	ENDIF
 674++162B
 675++162B              ;------------------------------------------------------------------------------
 676++162B              	ifused	TblKeyLat
 677++162B ~            ;⠭⭠ ⨭᪠ ᪫
 678++162B ~            ;
 679++162B ~            TblKeyLat	equ	$-#20
 680++162B ~            ;
 681++162B ~            ;	db #00,#01,#02,#03,#04,#05,#06,#07
 682++162B ~            ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 683++162B ~            ;	db #10,#11,#12,#13,#14,#15,#16,#17
 684++162B ~            ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 685++162B ~            	db " !",""","#$%&'"
 686++162B ~            	db "()*+,-./"
 687++162B ~            	db "01234567"
 688++162B ~            	db "89:;<=>?"
 689++162B ~            	db "@ABCDEFG"
 690++162B ~            	db "HIJKLMNO"
 691++162B ~            	db "PQRSTUVW"
 692++162B ~            	db "XYZ[\]^_"
 693++162B ~            	db "`abcdefg"
 694++162B ~            	db "hijklmno"
 695++162B ~            	db "pqrstuvw"
 696++162B ~            	db "xyz{|}~"
 697++162B ~
 698++162B              	endif
 699++162B
 700++162B              ;==============================================================================
 701++162B
# file closed: Drv/DrvKey.asm.a80
 117+ 162B              	INCLUDE	"DrvKey.var.a80"
# file opened: Drv/DrvKey.var.a80
   1++162B              ;६ Keyboard Driver
   2++162B              ;䠩 DrvKey.var.a80
   3++162B              ;
   4++162B              ;䫠 ࠩ
   5++162B              ;7,=1     
   6++162B              ;6,=1     
   7++162B              ;5,=1 ᨬ  ० cs+ss+key
   8++162B              ;4,=1/0 Rus 㪥/Rus 
   9++162B              ;3,=1/0 Rus/Lat
  10++162B              ;2,=1/0 Grf on/off
  11++162B              ;1,=1/0 CapsLock on/off
  12++162B              ;0,=1/0 Command on/off
  13++162B 30           FlgScanKeys     db %00110000
  14++162C 00           		db %00000000	;१
  15++162D
  16++162D              ;稭 প  ⮯
  17++162D 0F           KeyRepeatDelay    db #0F
  18++162E              ;ਮ ⮯
  19++162E 05           KeyRepeatPeriod   db #05
  20++162F
  21++162F              ;  ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
  22++162F              ;   ⮬ ० CapsLock
  23++162F 00           PrintCodePresKey  db #00
  24++1630              ;᪠ ⮩ 
  25++1630 00           ScanCodePresKey   db #00
  26++1631
  27++1631
# file closed: Drv/DrvKey.var.a80
 118+ 1631              End	DISPLAY	"Lenght DrvKey = ",/A,End-Start
 119+ 1631              ;	SAVEBIN	"!bin/drvkeys.bin",Start,End-Start
 120+ 1631              	ENDMODULE
 121+ 1631
# file closed: Drv/DrvKey.main.a80
2459  1631              	include player.asm ;плеер AY, TS
# file opened: player.asm
   1+ 1631              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2+ 1631              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3+ 1631              ;Specially for AlCo
   4+ 1631              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5+ 1631              	MODULE VTPL
   6+ 1631              ;Release number
   7+ 1631              Release EQU "0"
   8+ 1631              ;Conditional assembly
   9+ 1631              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10+ 1631              CurPosCounter=0
  11+ 1631              ;2) Allow channels allocation bits at (START+10)
  12+ 1631              ACBBAC=0
  13+ 1631              ;3) Allow loop checking and disabling
  14+ 1631              LoopChecker=1
  15+ 1631              ;4) Insert official identificator
  16+ 1631              Id=0
  17+ 1631              ;5) Set IY for correct return to ZX Basic
  18+ 1631              Basic=1
  19+ 1631
  20+ 1631              ;Features
  21+ 1631              ;--------
  22+ 1631              ;-Can be compiled at any address (i.e. no need rounding ORG
  23+ 1631              ; address).
  24+ 1631              ;-Variables (VARS) can be located at any address (not only after
  25+ 1631              ; code block).
  26+ 1631              ;-INIT subprogram checks PT3-module version and rightly
  27+ 1631              ; generates both note and volume tables outside of code block
  28+ 1631              ; (in VARS).
  29+ 1631              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30+ 1631              ; PT3 module version).
  31+ 1631              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32+ 1631              ; and higher).
  33+ 1631              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34+ 1631              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35+ 1631              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36+ 1631              ;-See also notes at the end of this source code.
  37+ 1631
  38+ 1631              ;Limitations
  39+ 1631              ;-----------
  40+ 1631              ;-Can run in RAM only (self-modified code is used).
  41+ 1631              ;-PT2 position list must be end by #FF marker only.
  42+ 1631
  43+ 1631              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44+ 1631              ;into RAM or INIT subprogram was not called before.
  45+ 1631
  46+ 1631              ;Call MUTE or INIT one more time to mute sound after stopping
  47+ 1631              ;playing
  48+ 1631
  49+ 1631              ;Test codes (commented)
  50+ 1631              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51+ 1631              ;	LD (START+10),A
  52+ 1631              ;	LD HL,#8000 ;Mod1
  53+ 1631              ;	LD DE,#A000 ;Mod2 (optional)
  54+ 1631              ;	CALL START+3
  55+ 1631              ;	EI
  56+ 1631              ;_LP	HALT
  57+ 1631              ;	CALL START+5
  58+ 1631              ;	XOR A
  59+ 1631              ;	IN A,(#FE)
  60+ 1631              ;	CPL
  61+ 1631              ;	AND 15
  62+ 1631              ;	JR Z,_LP
  63+ 1631              ;	JR START+8
  64+ 1631
  65+ 1631              TonA	EQU 0
  66+ 1631              TonB	EQU 2
  67+ 1631              TonC	EQU 4
  68+ 1631              Noise	EQU 6
  69+ 1631              Mixer	EQU 7
  70+ 1631              AmplA	EQU 8
  71+ 1631              AmplB	EQU 9
  72+ 1631              AmplC	EQU 10
  73+ 1631              Env	EQU 11
  74+ 1631              EnvTp	EQU 13
  75+ 1631
  76+ 1631              ;Entry and other points
  77+ 1631              ;START initialize playing of modules at MDLADDR (single module)
  78+ 1631              ;START+3 initialization with module address in HL and DE (TS)
  79+ 1631              ;START+5 play one quark
  80+ 1631              ;START+8 mute
  81+ 1631              ;START+10 setup and status flags
  82+ 1631
  83+ 1631              START:
  84+ 1631 21 00 C0     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85+ 1634 18 3C        	JR INIT
  86+ 1636 C3 95 1E     	JP PLAY
  87+ 1639 18 25        	JR MUTE
  88+ 163B 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89+ 163C              	     ;(optional);
  90+ 163C              	     ;set bit1 for PT2 and reset for PT3 before
  91+ 163C              	     ;calling INIT;
  92+ 163C              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93+ 163C              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94+ 163C              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95+ 163C              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96+ 163C              	     ;documented and must be converted to new standard.
  97+ 163C              	     ;bit6 is set each time, when loop point of 2nd TS
  98+ 163C              	     ;module is passed (optional).
  99+ 163C              	     ;bit7 is set each time, when loop point of 1st TS
 100+ 163C              	     ;or of single module is passed (optional).
 101+ 163C
 102+ 163C              ;Identifier
 103+ 163C              	IF Id
 104+ 163C ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105+ 163C              	ENDIF
 106+ 163C
 107+ 163C              	IF LoopChecker
 108+ 163C 21 3B 16     CHECKLP	LD HL,SETUP
 109+ 163F FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110+ 1643 28 04        	JR Z,CHL1
 111+ 1645 CB F6        	SET 6,(HL)
 112+ 1647 18 02        	JR CHL2
 113+ 1649 CB FE        CHL1	SET 7,(HL)
 114+ 164B CB 46        CHL2	BIT 0,(HL)
 115+ 164D C8           	RET Z
 116+ 164E E1           	POP HL
 117+ 164F FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118+ 1652 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119+ 1655 AF           	XOR A
 120+ 1656 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121+ 1659 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122+ 165C FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123+ 165F C9           	RET
 124+ 1660              	ENDIF
 125+ 1660
 126+ 1660 AF           MUTE: XOR A
 127+ 1661 67           	LD H,A
 128+ 1662 6F           	LD L,A
 129+ 1663 32 EA 1F     	LD (VARS1+VRS.AYREGS+AmplA),A
 130+ 1666 22 EB 1F     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131+ 1669 32 71 20     	LD (VARS2+VRS.AYREGS+AmplA),A
 132+ 166C 22 72 20     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133+ 166F C3 AD 1E     	JP ROUT
 134+ 1672
 135+ 1672              INIT:
 136+ 1672              ;HL - AddressOfModule
 137+ 1672              ;DE - AddresOf2ndModule
 138+ 1672 D5           	PUSH DE
 139+ 1673 E5           	PUSH HL
 140+ 1674 21 68 1F     	LD HL,VARS
 141+ 1677 36 00        	LD (HL),0
 142+ 1679 11 69 1F     	LD DE,VARS+1
 143+ 167C 01 0E 01     	LD BC,VAR0END-VARS-1
 144+ 167F ED B0        	LDIR
 145+ 1681 23           	INC HL
 146+ 1682 22 CB 1F     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147+ 1685 22 52 20     	LD (VARS2+VRS.AdInPtA),HL
 148+ 1688
 149+ 1688 E1           	POP HL
 150+ 1689 FD 21 CD 1F  	LD IY,VARS1+100
 151+ 168D 3A 3B 16     	LD A,(START+10)
 152+ 1690 E6 02        	AND 2
 153+ 1692 C2 1B 17     	JP NZ,I_PT2
 154+ 1695
 155+ 1695 CD 68 18     	CALL INITPT3
 156+ 1698 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157+ 169B 22 3B 1C     	LD (SamCnv),HL
 158+ 169E 3E BA        	LD A,#BA
 159+ 16A0 32 06 1C     	LD (OrnCP),A
 160+ 16A3 32 32 1C     	LD (SamCP),A
 161+ 16A6 3E 7B        	LD A,#7B
 162+ 16A8 32 09 1C     	LD (OrnLD),A
 163+ 16AB 32 35 1C     	LD (SamLD),A
 164+ 16AE 3E 87        	LD A,#87
 165+ 16B0 32 2C 1C     	LD (SamClc2),A
 166+ 16B3 E1           	POP HL
 167+ 16B4              	;Use version and ton table of 1st module
 168+ 16B4 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169+ 16B7 D6 30        	SUB #30
 170+ 16B9 38 04        	JR C,L20
 171+ 16BB FE 0A        	CP 10
 172+ 16BD 38 02        	JR C,L21
 173+ 16BF 3E 06        L20	LD A,6
 174+ 16C1 32 D9 1A     L21	LD (Version),A
 175+ 16C4 F5           	PUSH AF ;VolTable version
 176+ 16C5 FE 04        	CP 4
 177+ 16C7 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178+ 16CA 17           	RLA
 179+ 16CB E6 07        	AND 7
 180+ 16CD F5           	PUSH AF ;NoteTable number
 181+ 16CE
 182+ 16CE FD 21 54 20  	LD IY,VARS2+100
 183+ 16D2 3A 3B 16     	LD A,(START+10)
 184+ 16D5 E6 30        	AND 48
 185+ 16D7 28 37        	JR Z,NOTS
 186+ 16D9 FE 10        	CP 16
 187+ 16DB 28 27        	JR Z,TwoPT3s
 188+ 16DD 3A D9 1A     	LD A,(Version)
 189+ 16E0 FE 07        	CP 7
 190+ 16E2 38 2C        	JR C,NOTS
 191+ 16E4 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192+ 16E7 FE 20        	CP #20
 193+ 16E9 28 25        	JR Z,NOTS
 194+ 16EB 21 69 1F     	LD HL,VARS1
 195+ 16EE 11 F0 1F     	LD DE,VARS2
 196+ 16F1 01 87 00     	LD BC,VRS
 197+ 16F4 ED B0        	LDIR
 198+ 16F6 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199+ 16FA 4F           	LD C,A
 200+ 16FB 87           	ADD A,A
 201+ 16FC 81           	ADD A,C
 202+ 16FD D6 02        	SUB 2
 203+ 16FF 32 A0 1D     	LD (TSSub),A
 204+ 1702 18 03        	JR AlCoTS_
 205+ 1704 CD 68 18     TwoPT3s	CALL INITPT3
 206+ 1707 3E 01        AlCoTS_	LD A,1
 207+ 1709 32 68 1F     	LD (is_ts),A
 208+ 170C FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209+ 1710
 210+ 1710 01 25 1A     NOTS	LD BC,PT3PD
 211+ 1713 21 00 00     	LD HL,0
 212+ 1716 11 30 1F     	LD DE,PT3EMPTYORN
 213+ 1719 18 48        	JR INITCOMMON
 214+ 171B
 215+ 171B CD A0 18     I_PT2	CALL INITPT2
 216+ 171E 21 CB 51     	LD HL,#51CB
 217+ 1721 22 3B 1C     	LD (SamCnv),HL
 218+ 1724 3E BB        	LD A,#BB
 219+ 1726 32 06 1C     	LD (OrnCP),A
 220+ 1729 32 32 1C     	LD (SamCP),A
 221+ 172C 3E 7A        	LD A,#7A
 222+ 172E 32 09 1C     	LD (OrnLD),A
 223+ 1731 32 35 1C     	LD (SamLD),A
 224+ 1734 3E 80        	LD A,#80
 225+ 1736 32 2C 1C     	LD (SamClc2),A
 226+ 1739 E1           	POP HL
 227+ 173A 3E 05        	LD A,5
 228+ 173C 32 D9 1A     	LD (Version),A
 229+ 173F F5           	PUSH AF
 230+ 1740 3E 02        	LD A,2
 231+ 1742 F5           	PUSH AF
 232+ 1743
 233+ 1743 3A 3B 16     	LD A,(START+10)
 234+ 1746 E6 30        	AND 48
 235+ 1748 28 10        	JR Z,NOTS2
 236+ 174A
 237+ 174A FD 21 54 20  	LD IY,VARS2+100
 238+ 174E 3E 01        	LD A,1
 239+ 1750 32 68 1F     	LD (is_ts),A
 240+ 1753 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241+ 1757 CD A0 18     	CALL INITPT2
 242+ 175A
 243+ 175A 01 5F 19     NOTS2	LD BC,PT2PD
 244+ 175D 21 87 86     	LD HL,#8687
 245+ 1760 11 86 20     	LD DE,PT2EMPTYORN
 246+ 1763
 247+ 1763              INITCOMMON
 248+ 1763
 249+ 1763              	IF Basic
 250+ 1763 FD 21 3A 5C  	LD IY,#5C3A
 251+ 1767              	ENDIF
 252+ 1767
 253+ 1767 ED 43 10 19  	LD (PTDEC),BC
 254+ 176B 22 A2 1D     	LD (PsCalc),HL
 255+ 176E D5           	PUSH DE
 256+ 176F
 257+ 176F              ;note table data depacker
 258+ 176F              ;(c) Ivan Roshin
 259+ 176F 11 33 1F     	LD DE,T_PACK
 260+ 1772 01 D8 20     	LD BC,T1_+(2*49)-1
 261+ 1775 1A           TP_0	LD A,(DE)
 262+ 1776 13           	INC DE
 263+ 1777 FE 1E        	CP 15*2
 264+ 1779 30 06        	JR NC,TP_1
 265+ 177B 67           	LD H,A
 266+ 177C 1A           	LD A,(DE)
 267+ 177D 6F           	LD L,A
 268+ 177E 13           	INC DE
 269+ 177F 18 07        	JR TP_2
 270+ 1781 D5           TP_1	PUSH DE
 271+ 1782 16 00        	LD D,0
 272+ 1784 5F           	LD E,A
 273+ 1785 19           	ADD HL,DE
 274+ 1786 19           	ADD HL,DE
 275+ 1787 D1           	POP DE
 276+ 1788 7C           TP_2	LD A,H
 277+ 1789 02           	LD (BC),A
 278+ 178A 0B           	DEC BC
 279+ 178B 7D           	LD A,L
 280+ 178C 02           	LD (BC),A
 281+ 178D 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282+ 178E D6 F0        	SUB #F8*2
 283+ 1790 20 E3        	JR NZ,TP_0
 284+ 1792
 285+ 1792 3C           	INC A
 286+ 1793 32 D6 1F     	LD (VARS1+VRS.DelyCnt),A
 287+ 1796 32 5D 20     	LD (VARS2+VRS.DelyCnt),A
 288+ 1799 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289+ 179C 22 87 1F     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290+ 179F 22 A4 1F     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291+ 17A2 22 C1 1F     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292+ 17A5 22 0E 20     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293+ 17A8 22 2B 20     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294+ 17AB 22 48 20     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295+ 17AE E1           	POP HL
 296+ 17AF 22 79 1F     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297+ 17B2 22 96 1F     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298+ 17B5 22 B3 1F     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299+ 17B8 22 00 20     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300+ 17BB 22 1D 20     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301+ 17BE 22 3A 20     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302+ 17C1
 303+ 17C1 F1           	POP AF
 304+ 17C2
 305+ 17C2              ;NoteTableCreator (c) Ivan Roshin
 306+ 17C2              ;A - NoteTableNumber*2+VersionForNoteTable
 307+ 17C2              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308+ 17C2
 309+ 17C2 21 E0 1E     	LD HL,NT_DATA
 310+ 17C5 16 00        	LD D,0
 311+ 17C7 87           	ADD A,A
 312+ 17C8 5F           	LD E,A
 313+ 17C9 19           	ADD HL,DE
 314+ 17CA 5E           	LD E,(HL)
 315+ 17CB 23           	INC HL
 316+ 17CC CB 3B        	SRL E
 317+ 17CE 9F           	SBC A,A
 318+ 17CF E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319+ 17D1 32 F9 17     	LD (L3),A
 320+ 17D4 EB           	EX DE,HL
 321+ 17D5 01 77 20     	LD BC,T1_
 322+ 17D8 09           	ADD HL,BC
 323+ 17D9
 324+ 17D9 1A           	LD A,(DE)
player.asm(325): warning: value 0x1EF0 is truncated to 8bit value: 0xF0
 325+ 17DA C6 F0        	ADD A,T_
 326+ 17DC 4F           	LD C,A
 327+ 17DD CE 1E        	ADC A,T_/256
 328+ 17DF 91           	SUB C
 329+ 17E0 47           	LD B,A
 330+ 17E1 C5           	PUSH BC
 331+ 17E2 11 67 21     	LD DE,NT_
 332+ 17E5 D5           	PUSH DE
 333+ 17E6
 334+ 17E6 06 0C        	LD B,12
 335+ 17E8 C5           L1	PUSH BC
 336+ 17E9 4E           	LD C,(HL)
 337+ 17EA 23           	INC HL
 338+ 17EB E5           	PUSH HL
 339+ 17EC 46           	LD B,(HL)
 340+ 17ED
 341+ 17ED D5           	PUSH DE
 342+ 17EE EB           	EX DE,HL
 343+ 17EF 11 17 00     	LD DE,23
 344+ 17F2 DD 26 08     	LD IXH,8
 345+ 17F5
 346+ 17F5 CB 38        L2	SRL B
 347+ 17F7 CB 19        	RR C
 348+ 17F9 19           L3	DB #19	;AND A or NOP
 349+ 17FA 79           	LD A,C
 350+ 17FB 8A           	ADC A,D	;=ADC 0
 351+ 17FC 77           	LD (HL),A
 352+ 17FD 23           	INC HL
 353+ 17FE 78           	LD A,B
 354+ 17FF 8A           	ADC A,D
 355+ 1800 77           	LD (HL),A
 356+ 1801 19           	ADD HL,DE
 357+ 1802 DD 25        	DEC IXH
 358+ 1804 20 EF        	JR NZ,L2
 359+ 1806
 360+ 1806 D1           	POP DE
 361+ 1807 13           	INC DE
 362+ 1808 13           	INC DE
 363+ 1809 E1           	POP HL
 364+ 180A 23           	INC HL
 365+ 180B C1           	POP BC
 366+ 180C 10 DA        	DJNZ L1
 367+ 180E
 368+ 180E E1           	POP HL
 369+ 180F D1           	POP DE
 370+ 1810
 371+ 1810 7B           	LD A,E
player.asm(372): warning: value 0x1EFC is truncated to 8bit value: 0xFC
 372+ 1811 FE FC        	CP TCOLD_1
 373+ 1813 20 05        	JR NZ,CORR_1
 374+ 1815 3E FD        	LD A,#FD
 375+ 1817 32 95 21     	LD (NT_+#2E),A
 376+ 181A
 377+ 181A 1A           CORR_1	LD A,(DE)
 378+ 181B A7           	AND A
 379+ 181C 28 11        	JR Z,TC_EXIT
 380+ 181E 1F           	RRA
 381+ 181F F5           	PUSH AF
 382+ 1820 87           	ADD A,A
 383+ 1821 4F           	LD C,A
 384+ 1822 09           	ADD HL,BC
 385+ 1823 F1           	POP AF
 386+ 1824 30 02        	JR NC,CORR_2
 387+ 1826 35           	DEC (HL)
 388+ 1827 35           	DEC (HL)
 389+ 1828 34           CORR_2	INC (HL)
 390+ 1829 A7           	AND A
 391+ 182A ED 42        	SBC HL,BC
 392+ 182C 13           	INC DE
 393+ 182D 18 EB        	JR CORR_1
 394+ 182F
 395+ 182F              TC_EXIT
 396+ 182F
 397+ 182F F1           	POP AF
 398+ 1830
 399+ 1830              ;VolTableCreator (c) Ivan Roshin
 400+ 1830              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401+ 1830              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402+ 1830
 403+ 1830 FE 05        	CP 5
 404+ 1832 21 11 00     	LD HL,#11
 405+ 1835 54           	LD D,H
 406+ 1836 5C           	LD E,H
 407+ 1837 3E 17        	LD A,#17
 408+ 1839 30 03        	JR NC,M1
 409+ 183B 2D           	DEC L
 410+ 183C 5D           	LD E,L
 411+ 183D AF           	XOR A
 412+ 183E 32 4F 18     M1      LD (M2),A
 413+ 1841
 414+ 1841 DD 21 77 20  	LD IX,VT_+16
 415+ 1845
 416+ 1845 0E 0F        	LD C,#F
 417+ 1847 E5           INITV2  PUSH HL
 418+ 1848
 419+ 1848 19           	ADD HL,DE
 420+ 1849 EB           	EX DE,HL
 421+ 184A ED 62        	SBC HL,HL
 422+ 184C
 423+ 184C 06 10        	LD B,#10
 424+ 184E 7D           INITV1  LD A,L
 425+ 184F 7D           M2      DB #7D
 426+ 1850 7C           	LD A,H
 427+ 1851 CE 00        	ADC A,0
 428+ 1853 DD 77 00     	LD (IX),A
 429+ 1856 DD 23        	INC IX
 430+ 1858 19           	ADD HL,DE
 431+ 1859 10 F3        	DJNZ INITV1
 432+ 185B
 433+ 185B E1           	POP HL
 434+ 185C 7B           	LD A,E
 435+ 185D FE 77        	CP #77
 436+ 185F 20 01        	JR NZ,M3
 437+ 1861 1C           	INC E
 438+ 1862 0D           M3      DEC C
 439+ 1863 20 E2        	JR NZ,INITV2
 440+ 1865
 441+ 1865 C3 AD 1E     	JP ROUT
 442+ 1868
 443+ 1868 CD DB 18     INITPT3	CALL SETMDAD
 444+ 186B E5           	PUSH HL
 445+ 186C 11 64 00     	LD DE,100
 446+ 186F 19           	ADD HL,DE
 447+ 1870 7E           	LD A,(HL)
 448+ 1871 FD 77 08     	LD (IY-100+VRS.Delay),A
 449+ 1874 E5           	PUSH HL
 450+ 1875 DD E1        	POP IX
 451+ 1877 19           	ADD HL,DE
 452+ 1878 CD E9 18     	CALL SETCPPT
 453+ 187B DD 5E 02     	LD E,(IX+102-100)
 454+ 187E 23           	INC HL
 455+ 187F
 456+ 187F              	IF CurPosCounter
 457+ 187F ~            	LD (IY-100+VRS.PosSub),L
 458+ 187F              	ENDIF
 459+ 187F
 460+ 187F 19           	ADD HL,DE
 461+ 1880 CD F0 18     	CALL SETLPPT
 462+ 1883 D1           	POP DE
 463+ 1884 DD 6E 03     	LD L,(IX+103-100)
 464+ 1887 DD 66 04     	LD H,(IX+104-100)
 465+ 188A 19           	ADD HL,DE
 466+ 188B CD D4 18     	CALL SETPTPT
 467+ 188E 21 A9 00     	LD HL,169
 468+ 1891 19           	ADD HL,DE
 469+ 1892 CD E2 18     	CALL SETORPT
 470+ 1895 21 69 00     	LD HL,105
 471+ 1898 19           	ADD HL,DE
 472+ 1899
 473+ 1899 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474+ 189C FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475+ 189F C9           	RET
 476+ 18A0
 477+ 18A0 7E           INITPT2	LD A,(HL)
 478+ 18A1 FD 77 08     	LD (IY-100+VRS.Delay),A
 479+ 18A4 E5           	PUSH HL
 480+ 18A5 E5           	PUSH HL
 481+ 18A6 E5           	PUSH HL
 482+ 18A7 23           	INC HL
 483+ 18A8 23           	INC HL
 484+ 18A9 7E           	LD A,(HL)
 485+ 18AA 23           	INC HL
 486+ 18AB CD 99 18     	CALL SETSMPT
 487+ 18AE 5E           	LD E,(HL)
 488+ 18AF 23           	INC HL
 489+ 18B0 56           	LD D,(HL)
 490+ 18B1 E1           	POP HL
 491+ 18B2 A7           	AND A
 492+ 18B3 ED 52        	SBC HL,DE
 493+ 18B5 CD DB 18     	CALL SETMDAD
 494+ 18B8 E1           	POP HL
 495+ 18B9 11 43 00     	LD DE,67
 496+ 18BC 19           	ADD HL,DE
 497+ 18BD CD E2 18     	CALL SETORPT
 498+ 18C0 1E 20        	LD E,32
 499+ 18C2 19           	ADD HL,DE
 500+ 18C3 4E           	LD C,(HL)
 501+ 18C4 23           	INC HL
 502+ 18C5 46           	LD B,(HL)
 503+ 18C6 1E 1E        	LD E,30
 504+ 18C8 19           	ADD HL,DE
 505+ 18C9 CD E9 18     	CALL SETCPPT
 506+ 18CC 5F           	LD E,A
 507+ 18CD 23           	INC HL
 508+ 18CE
 509+ 18CE              	IF CurPosCounter
 510+ 18CE ~            	LD (IY-100+VRS.PosSub),L
 511+ 18CE              	ENDIF
 512+ 18CE
 513+ 18CE 19           	ADD HL,DE
 514+ 18CF CD F0 18     	CALL SETLPPT
 515+ 18D2 E1           	POP HL
 516+ 18D3 09           	ADD HL,BC
 517+ 18D4
 518+ 18D4 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519+ 18D7 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520+ 18DA C9           	RET
 521+ 18DB
 522+ 18DB FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523+ 18DE FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524+ 18E1 C9           	RET
 525+ 18E2
 526+ 18E2 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527+ 18E5 FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528+ 18E8 C9           	RET
 529+ 18E9
 530+ 18E9 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531+ 18EC FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532+ 18EF C9           	RET
 533+ 18F0
 534+ 18F0 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535+ 18F3 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536+ 18F6 C9           	RET
 537+ 18F7
 538+ 18F7 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539+ 18FA FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540+ 18FD C9           	RET
 541+ 18FE
 542+ 18FE FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543+ 1901 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544+ 1904 C9           	RET
 545+ 1905
 546+ 1905 FD E5        GETIX	PUSH IY
 547+ 1907 DD E1        	POP IX
 548+ 1909 DD 19        	ADD IX,DE
 549+ 190B C9           	RET
 550+ 190C
 551+ 190C CD 05 19     PTDECOD CALL GETIX
 552+ 190F              PTDEC	EQU $+1
 553+ 190F C3 C3 C3     	JP #C3C3
 554+ 1912
 555+ 1912              ;PT2 pattern decoder
 556+ 1912 CD A8 1B     PD2_SAM	CALL SETSAM
 557+ 1915 18 4A        	JR PD2_LOOP
 558+ 1917
 559+ 1917 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560+ 191A 18 45        	JR PD2_LOOP
 561+ 191C
 562+ 191C DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563+ 1920 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564+ 1923 0A           	LD A,(BC)
 565+ 1924 03           	INC BC
 566+ 1925 6F           	LD L,A
 567+ 1926 0A           	LD A,(BC)
 568+ 1927 03           	INC BC
 569+ 1928 67           	LD H,A
 570+ 1929 CD F7 18     	CALL SETENBS
 571+ 192C 18 33        	JR PD2_LOOP
 572+ 192E
 573+ 192E CD 89 1B     PD2_ORN	CALL SETORN
 574+ 1931 18 2E        	JR PD2_LOOP
 575+ 1933
 576+ 1933 3C           PD2_SKIP INC A
 577+ 1934 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578+ 1937 18 28        	JR PD2_LOOP
 579+ 1939
 580+ 1939 0F           PD2_VOL	RRCA
 581+ 193A 0F           	RRCA
 582+ 193B 0F           	RRCA
 583+ 193C 0F           	RRCA
 584+ 193D DD 77 10     	LD (IX-12+CHP.Volume),A
 585+ 1940 18 1F        	JR PD2_LOOP
 586+ 1942
 587+ 1942 CD 59 1B     PD2_DEL	CALL C_DELAY
 588+ 1945 18 1A        	JR PD2_LOOP
 589+ 1947
 590+ 1947 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591+ 194B 3C           	INC A
 592+ 194C DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593+ 194F DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594+ 1952 0A           	LD A,(BC)
 595+ 1953 03           	INC BC
 596+ 1954 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597+ 1957 87           	ADD A,A
 598+ 1958 9F           	SBC A,A
 599+ 1959 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600+ 195C 37           	SCF
 601+ 195D 18 01        	JR PD2_LP2
 602+ 195F
 603+ 195F A7           PT2PD	AND A
 604+ 1960
 605+ 1960 08           PD2_LP2	EX AF,AF'
 606+ 1961
 607+ 1961 0A           PD2_LOOP LD A,(BC)
 608+ 1962 03           	INC BC
 609+ 1963 C6 20        	ADD A,#20
 610+ 1965 28 3F        	JR Z,PD2_REL
 611+ 1967 38 A9        	JR C,PD2_SAM
 612+ 1969 C6 60        	ADD A,96
 613+ 196B 38 3E        	JR C,PD2_NOTE
 614+ 196D 3C           	INC A
 615+ 196E 28 A7        	JR Z,PD2_EOff
 616+ 1970 C6 0F        	ADD A,15
 617+ 1972 CA 88 1A     	JP Z,PD_FIN
 618+ 1975 38 A5        	JR C,PD2_ENV
 619+ 1977 C6 10        	ADD A,#10
 620+ 1979 38 B3        	JR C,PD2_ORN
 621+ 197B C6 40        	ADD A,#40
 622+ 197D 38 B4        	JR C,PD2_SKIP
 623+ 197F C6 10        	ADD A,#10
 624+ 1981 38 B6        	JR C,PD2_VOL
 625+ 1983 3C           	INC A
 626+ 1984 28 BC        	JR Z,PD2_DEL
 627+ 1986 3C           	INC A
 628+ 1987 28 BE        	JR Z,PD2_GLIS
 629+ 1989 3C           	INC A
 630+ 198A 28 0A        	JR Z,PD2_PORT
 631+ 198C 3C           	INC A
 632+ 198D 28 12        	JR Z,PD2_STOP
 633+ 198F 0A           	LD A,(BC)
 634+ 1990 03           	INC BC
 635+ 1991 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636+ 1994 18 CB        	JR PD2_LOOP
 637+ 1996
 638+ 1996 DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639+ 199A 0A           	LD A,(BC)
 640+ 199B 03           	INC BC
 641+ 199C 03           	INC BC ;ignoring precalc delta to right sound
 642+ 199D 03           	INC BC
 643+ 199E 37           	SCF
 644+ 199F 18 BF        	JR PD2_LP2
 645+ 19A1
 646+ 19A1 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647+ 19A4 18 BB        	JR PD2_LOOP
 648+ 19A6
 649+ 19A6 DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650+ 19A9 18 2C        	JR PD2_EXIT
 651+ 19AB
 652+ 19AB 6F           PD2_NOTE LD L,A
 653+ 19AC DD 7E 06     	LD A,(IX-12+CHP.Note)
 654+ 19AF 32 C2 1A     	LD (PrNote+1),A
 655+ 19B2 DD 75 06     	LD (IX-12+CHP.Note),L
 656+ 19B5 AF           	XOR A
 657+ 19B6 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658+ 19B9 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659+ 19BD 08           	EX AF,AF'
 660+ 19BE 30 16        	JR NC,NOGLIS2
 661+ 19C0 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662+ 19C4 20 0C        	JR NZ,NOPORT2
 663+ 19C6 32 E8 1A     	LD (LoStep),A
 664+ 19C9 87           	ADD A,A
 665+ 19CA 9F           	SBC A,A
 666+ 19CB 08           	EX AF,AF'
 667+ 19CC 67           	LD H,A
 668+ 19CD 6F           	LD L,A
 669+ 19CE 3C           	INC A
 670+ 19CF CD A3 1A     	CALL SETPORT
 671+ 19D2 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672+ 19D6 AF           NOGLIS2	XOR A
 673+ 19D7
 674+ 19D7
 675+ 19D7 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676+ 19DA DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677+ 19DD DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678+ 19E0 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679+ 19E3 C3 88 1A     	JP PD_FIN
 680+ 19E6
 681+ 19E6              ;PT3 pattern decoder
 682+ 19E6 DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683+ 19EA CD 89 1B     	CALL SETORN
 684+ 19ED 0A           PD_SAM_	LD A,(BC)
 685+ 19EE 03           	INC BC
 686+ 19EF 0F           	RRCA
 687+ 19F0
 688+ 19F0 CD A8 1B     PD_SAM	CALL SETSAM
 689+ 19F3 18 3F        	JR PD_LOOP
 690+ 19F5
 691+ 19F5 0F           PD_VOL	RRCA
 692+ 19F6 0F           	RRCA
 693+ 19F7 0F           	RRCA
 694+ 19F8 0F           	RRCA
 695+ 19F9 DD 77 10     	LD (IX-12+CHP.Volume),A
 696+ 19FC 18 39        	JR PD_LP2
 697+ 19FE
 698+ 19FE DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699+ 1A01 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700+ 1A04 18 31        	JR PD_LP2
 701+ 1A06
 702+ 1A06 3D           PD_SorE	DEC A
 703+ 1A07 20 07        	JR NZ,PD_ENV
 704+ 1A09 0A           	LD A,(BC)
 705+ 1A0A 03           	INC BC
 706+ 1A0B DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707+ 1A0E 18 27        	JR PD_LP2
 708+ 1A10
 709+ 1A10 CD 6E 1B     PD_ENV	CALL SETENV
 710+ 1A13 18 22        	JR PD_LP2
 711+ 1A15
 712+ 1A15 CD 89 1B     PD_ORN	CALL SETORN
 713+ 1A18 18 1A        	JR PD_LOOP
 714+ 1A1A
 715+ 1A1A DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716+ 1A1D DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717+ 1A20 C4 6E 1B     	CALL NZ,SETENV
 718+ 1A23 18 C8        	JR PD_SAM_
 719+ 1A25
 720+ 1A25 DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721+ 1A28 32 C2 1A     	LD (PrNote+1),A
 722+ 1A2B DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723+ 1A2E DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724+ 1A31 22 DF 1A     	LD (PrSlide+1),HL
 725+ 1A34
 726+ 1A34 11 10 20     PD_LOOP	LD DE,#2010
 727+ 1A37 0A           PD_LP2	LD A,(BC)
 728+ 1A38 03           	INC BC
 729+ 1A39 83           	ADD A,E
 730+ 1A3A 38 AA        	JR C,PD_OrSm
 731+ 1A3C 82           	ADD A,D
 732+ 1A3D 28 49        	JR Z,PD_FIN
 733+ 1A3F 38 AF        	JR C,PD_SAM
 734+ 1A41 83           	ADD A,E
 735+ 1A42 28 25        	JR Z,PD_REL
 736+ 1A44 38 AF        	JR C,PD_VOL
 737+ 1A46 83           	ADD A,E
 738+ 1A47 28 B5        	JR Z,PD_EOff
 739+ 1A49 38 BB        	JR C,PD_SorE
 740+ 1A4B C6 60        	ADD A,96
 741+ 1A4D 38 20        	JR C,PD_NOTE
 742+ 1A4F 83           	ADD A,E
 743+ 1A50 38 C3        	JR C,PD_ORN
 744+ 1A52 82           	ADD A,D
 745+ 1A53 38 0F        	JR C,PD_NOIS
 746+ 1A55 83           	ADD A,E
 747+ 1A56 38 C2        	JR C,PD_ESAM
 748+ 1A58 87           	ADD A,A
 749+ 1A59 5F           	LD E,A
 750+ 1A5A 21 E4 FA     	LD HL,SPCCOMS+#FF20-#2000
 751+ 1A5D 19           	ADD HL,DE
 752+ 1A5E 5E           	LD E,(HL)
 753+ 1A5F 23           	INC HL
 754+ 1A60 56           	LD D,(HL)
 755+ 1A61 D5           	PUSH DE
 756+ 1A62 18 D0        	JR PD_LOOP
 757+ 1A64
 758+ 1A64 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759+ 1A67 18 CE        	JR PD_LP2
 760+ 1A69
 761+ 1A69 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762+ 1A6D 18 08        	JR PD_RES
 763+ 1A6F
 764+ 1A6F DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765+ 1A72 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766+ 1A76 AF           	XOR A
 767+ 1A77
 768+ 1A77 ED 73 86 1A  PD_RES	LD (PDSP_+1),SP
 769+ 1A7B DD F9        	LD SP,IX
 770+ 1A7D 67           	LD H,A
 771+ 1A7E 6F           	LD L,A
 772+ 1A7F E5           	PUSH HL
 773+ 1A80 E5           	PUSH HL
 774+ 1A81 E5           	PUSH HL
 775+ 1A82 E5           	PUSH HL
 776+ 1A83 E5           	PUSH HL
 777+ 1A84 E5           	PUSH HL
 778+ 1A85 31 31 31     PDSP_	LD SP,#3131
 779+ 1A88
 780+ 1A88 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781+ 1A8B DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782+ 1A8E C9           	RET
 783+ 1A8F
 784+ 1A8F 0A           C_PORTM LD A,(BC)
 785+ 1A90 03           	INC BC
 786+ 1A91              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787+ 1A91              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788+ 1A91 03           	INC BC
 789+ 1A92 03           	INC BC
 790+ 1A93 08           	EX AF,AF'
 791+ 1A94 0A           	LD A,(BC) ;SIGNED TONE STEP
 792+ 1A95 03           	INC BC
 793+ 1A96 32 E8 1A     	LD (LoStep),A
 794+ 1A99 0A           	LD A,(BC)
 795+ 1A9A 03           	INC BC
 796+ 1A9B A7           	AND A
 797+ 1A9C 08           	EX AF,AF'
 798+ 1A9D DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799+ 1AA0 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800+ 1AA3
 801+ 1AA3              ;Set portamento variables
 802+ 1AA3              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803+ 1AA3
 804+ 1AA3 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805+ 1AA7 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806+ 1AAA DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807+ 1AAD E5           	PUSH HL
 808+ 1AAE 11 67 21     	LD DE,NT_
 809+ 1AB1 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810+ 1AB4 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811+ 1AB7 87           	ADD A,A
 812+ 1AB8 6F           	LD L,A
 813+ 1AB9 26 00        	LD H,0
 814+ 1ABB 19           	ADD HL,DE
 815+ 1ABC 7E           	LD A,(HL)
 816+ 1ABD 23           	INC HL
 817+ 1ABE 66           	LD H,(HL)
 818+ 1ABF 6F           	LD L,A
 819+ 1AC0 E5           	PUSH HL
 820+ 1AC1 3E 3E        PrNote	LD A,#3E
 821+ 1AC3 DD 77 06     	LD (IX-12+CHP.Note),A
 822+ 1AC6 87           	ADD A,A
 823+ 1AC7 6F           	LD L,A
 824+ 1AC8 26 00        	LD H,0
 825+ 1ACA 19           	ADD HL,DE
 826+ 1ACB 5E           	LD E,(HL)
 827+ 1ACC 23           	INC HL
 828+ 1ACD 56           	LD D,(HL)
 829+ 1ACE E1           	POP HL
 830+ 1ACF ED 52        	SBC HL,DE
 831+ 1AD1 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832+ 1AD4 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833+ 1AD7 D1           	POP DE
 834+ 1AD8              Version EQU $+1
 835+ 1AD8 3E 3E        	LD A,#3E
 836+ 1ADA FE 06        	CP 6
 837+ 1ADC 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838+ 1ADE 11 11 11     PrSlide	LD DE,#1111
 839+ 1AE1 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840+ 1AE4 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841+ 1AE7              LoStep	EQU $+1
 842+ 1AE7 3E 3E        OLDPRTM	LD A,#3E
 843+ 1AE9 08           	EX AF,AF'
 844+ 1AEA 28 01        	JR Z,NOSIG
 845+ 1AEC EB           	EX DE,HL
 846+ 1AED ED 52        NOSIG	SBC HL,DE
 847+ 1AEF F2 F7 1A     	JP P,SET_STP
 848+ 1AF2 2F           	CPL
 849+ 1AF3 08           	EX AF,AF'
 850+ 1AF4 ED 44        	NEG
 851+ 1AF6 08           	EX AF,AF'
 852+ 1AF7 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853+ 1AFA 08           	EX AF,AF'
 854+ 1AFB DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855+ 1AFE DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856+ 1B02 C9           	RET
 857+ 1B03
 858+ 1B03 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859+ 1B07 0A           	LD A,(BC)
 860+ 1B08 03           	INC BC
 861+ 1B09 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862+ 1B0C A7           	AND A
 863+ 1B0D 20 07        	JR NZ,GL36
 864+ 1B0F 3A D9 1A     	LD A,(Version) ;AlCo PT3.7+
 865+ 1B12 FE 07        	CP 7
 866+ 1B14 9F           	SBC A,A
 867+ 1B15 3C           	INC A
 868+ 1B16 DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869+ 1B19 0A           	LD A,(BC)
 870+ 1B1A 03           	INC BC
 871+ 1B1B 08           	EX AF,AF'
 872+ 1B1C 0A           	LD A,(BC)
 873+ 1B1D 03           	INC BC
 874+ 1B1E 18 D7        	JR SET_STP
 875+ 1B20
 876+ 1B20 0A           C_SMPOS	LD A,(BC)
 877+ 1B21 03           	INC BC
 878+ 1B22 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879+ 1B25 C9           	RET
 880+ 1B26
 881+ 1B26 0A           C_ORPOS	LD A,(BC)
 882+ 1B27 03           	INC BC
 883+ 1B28 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884+ 1B2B C9           	RET
 885+ 1B2C
 886+ 1B2C 0A           C_VIBRT	LD A,(BC)
 887+ 1B2D 03           	INC BC
 888+ 1B2E DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889+ 1B31 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890+ 1B34 0A           	LD A,(BC)
 891+ 1B35 03           	INC BC
 892+ 1B36 DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893+ 1B39 AF           	XOR A
 894+ 1B3A DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895+ 1B3D DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896+ 1B40 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897+ 1B43 C9           	RET
 898+ 1B44
 899+ 1B44 0A           C_ENGLS	LD A,(BC)
 900+ 1B45 03           	INC BC
 901+ 1B46 FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902+ 1B49 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903+ 1B4C 0A           	LD A,(BC)
 904+ 1B4D 03           	INC BC
 905+ 1B4E 6F           	LD L,A
 906+ 1B4F 0A           	LD A,(BC)
 907+ 1B50 03           	INC BC
 908+ 1B51 67           	LD H,A
 909+ 1B52 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910+ 1B55 FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911+ 1B58 C9           	RET
 912+ 1B59
 913+ 1B59 0A           C_DELAY	LD A,(BC)
 914+ 1B5A 03           	INC BC
 915+ 1B5B FD 77 08     	LD (IY-100+VRS.Delay),A
 916+ 1B5E 21 F2 1F     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917+ 1B61 CB 4E        	BIT 1,(HL)
 918+ 1B63 C8           	RET Z
 919+ 1B64 32 D5 1F     	LD (VARS1+VRS.Delay),A
 920+ 1B67 32 D6 1F     	LD (VARS1+VRS.DelyCnt),A
 921+ 1B6A 32 5C 20     	LD (VARS2+VRS.Delay),A
 922+ 1B6D C9           	RET
 923+ 1B6E
 924+ 1B6E DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925+ 1B71 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926+ 1B74 0A           	LD A,(BC)
 927+ 1B75 03           	INC BC
 928+ 1B76 67           	LD H,A
 929+ 1B77 0A           	LD A,(BC)
 930+ 1B78 03           	INC BC
 931+ 1B79 6F           	LD L,A
 932+ 1B7A CD F7 18     	CALL SETENBS
 933+ 1B7D AF           	XOR A
 934+ 1B7E DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935+ 1B81 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936+ 1B84 67           	LD H,A
 937+ 1B85 6F           	LD L,A
 938+ 1B86 C3 FE 18     	JP SETESLD
 939+ 1B89
 940+ 1B89 87           SETORN	ADD A,A
 941+ 1B8A 5F           	LD E,A
 942+ 1B8B 16 00        	LD D,0
 943+ 1B8D DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944+ 1B90 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945+ 1B93 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946+ 1B96 19           	ADD HL,DE
 947+ 1B97 5E           	LD E,(HL)
 948+ 1B98 23           	INC HL
 949+ 1B99 56           	LD D,(HL)
 950+ 1B9A FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951+ 1B9D FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952+ 1BA0 19           	ADD HL,DE
 953+ 1BA1 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954+ 1BA4 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955+ 1BA7 C9           C_NOP	RET
 956+ 1BA8
 957+ 1BA8 87           SETSAM	ADD A,A
 958+ 1BA9 5F           	LD E,A
 959+ 1BAA 16 00        	LD D,0
 960+ 1BAC FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961+ 1BAF FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962+ 1BB2 19           	ADD HL,DE
 963+ 1BB3 5E           	LD E,(HL)
 964+ 1BB4 23           	INC HL
 965+ 1BB5 56           	LD D,(HL)
 966+ 1BB6 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967+ 1BB9 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968+ 1BBC 19           	ADD HL,DE
 969+ 1BBD DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970+ 1BC0 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971+ 1BC3 C9           	RET
 972+ 1BC4
 973+ 1BC4              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974+ 1BC4 A7 1B        SPCCOMS DW C_NOP
 975+ 1BC6 03 1B        	DW C_GLISS
 976+ 1BC8 8F 1A        	DW C_PORTM
 977+ 1BCA 20 1B        	DW C_SMPOS
 978+ 1BCC 26 1B        	DW C_ORPOS
 979+ 1BCE 2C 1B        	DW C_VIBRT
 980+ 1BD0 A7 1B        	DW C_NOP
 981+ 1BD2 A7 1B        	DW C_NOP
 982+ 1BD4 44 1B        	DW C_ENGLS
 983+ 1BD6 59 1B        	DW C_DELAY
 984+ 1BD8 A7 1B        	DW C_NOP
 985+ 1BDA A7 1B        	DW C_NOP
 986+ 1BDC A7 1B        	DW C_NOP
 987+ 1BDE A7 1B        	DW C_NOP
 988+ 1BE0 A7 1B        	DW C_NOP
 989+ 1BE2 A7 1B        	DW C_NOP
 990+ 1BE4
 991+ 1BE4 CD 05 19     CHREGS	CALL GETIX
 992+ 1BE7 AF           	XOR A
 993+ 1BE8 32 24 1E     	LD (Ampl),A
 994+ 1BEB DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995+ 1BEF E5           	PUSH HL
 996+ 1BF0 CA 37 1D     	JP Z,CH_EXIT
 997+ 1BF3 ED 73 81 1C  	LD (CSP_+1),SP
 998+ 1BF7 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999+ 1BFA DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000+ 1BFD F9           	LD SP,HL
1001+ 1BFE D1           	POP DE
1002+ 1BFF 67           	LD H,A
1003+ 1C00 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004+ 1C03 6F           	LD L,A
1005+ 1C04 39           	ADD HL,SP
1006+ 1C05 3C           	INC A
1007+ 1C06              		;PT2	PT3
1008+ 1C06 3C           OrnCP	INC A	;CP E	CP D
1009+ 1C07 38 01        	JR C,CH_ORPS
1010+ 1C09 01           OrnLD	DB 1	;LD A,D	LD A,E
1011+ 1C0A DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012+ 1C0D DD 7E 12     	LD A,(IX+CHP.Note)
1013+ 1C10 86           	ADD A,(HL)
1014+ 1C11 F2 15 1C     	JP P,CH_NTP
1015+ 1C14 AF           	XOR A
1016+ 1C15 FE 60        CH_NTP	CP 96
1017+ 1C17 38 02        	JR C,CH_NOK
1018+ 1C19 3E 5F        	LD A,95
1019+ 1C1B 87           CH_NOK	ADD A,A
1020+ 1C1C 08           	EX AF,AF'
1021+ 1C1D DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022+ 1C20 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023+ 1C23 F9           	LD SP,HL
1024+ 1C24 D1           	POP DE
1025+ 1C25 26 00        	LD H,0
1026+ 1C27 DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027+ 1C2A 47           	LD B,A
1028+ 1C2B 87           	ADD A,A
1029+ 1C2C 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030+ 1C2D 6F           	LD L,A
1031+ 1C2E 39           	ADD HL,SP
1032+ 1C2F F9           	LD SP,HL
1033+ 1C30 78           	LD A,B
1034+ 1C31 3C           	INC A
1035+ 1C32              		;PT2	PT3
1036+ 1C32 3C           SamCP	INC A	;CP E	CP D
1037+ 1C33 38 01        	JR C,CH_SMPS
1038+ 1C35 01           SamLD	DB 1	;LD A,D	LD A,E
1039+ 1C36 DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040+ 1C39 C1           	POP BC
1041+ 1C3A E1           	POP HL
1042+ 1C3B
1043+ 1C3B              ;Convert PT2 sample to PT3
1044+ 1C3B              		;PT2		PT3
1045+ 1C3B E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046+ 1C3C E1           	POP HL
1047+ 1C3D 60           	LD H,B
1048+ 1C3E 20 06        	JR NZ,$+8
1049+ 1C40 EB           	EX DE,HL
1050+ 1C41 A7           	AND A
1051+ 1C42 ED 62        	SBC HL,HL
1052+ 1C44 ED 52        	SBC HL,DE
1053+ 1C46 51           	LD D,C
1054+ 1C47 CB 19        	RR C
1055+ 1C49 9F           	SBC A,A
1056+ 1C4A 2F           	CPL
1057+ 1C4B E6 3E        	AND #3E
1058+ 1C4D CB 19        	RR C
1059+ 1C4F CB 18        	RR B
1060+ 1C51 A1           	AND C
1061+ 1C52 4F           	LD C,A
1062+ 1C53 78           	LD A,B
1063+ 1C54 1F           	RRA
1064+ 1C55 1F           	RRA
1065+ 1C56 CB 1A        	RR D
1066+ 1C58 1F           	RRA
1067+ 1C59 E6 9F        	AND #9F
1068+ 1C5B 47           	LD B,A
1069+ 1C5C
1070+ 1C5C DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071+ 1C5F DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072+ 1C62 19           	ADD HL,DE
1073+ 1C63 CB 70        	BIT 6,B
1074+ 1C65 28 06        	JR Z,CH_NOAC
1075+ 1C67 DD 75 08     	LD (IX+CHP.TnAcc),L
1076+ 1C6A DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077+ 1C6D EB           CH_NOAC EX DE,HL
1078+ 1C6E 08           	EX AF,AF'
player.asm(1079): warning: value 0x2167 is truncated to 8bit value: 0x67
1079+ 1C6F C6 67        	ADD A,NT_
1080+ 1C71 6F           	LD L,A
1081+ 1C72 CE 21        	ADC A,NT_/256
1082+ 1C74 95           	SUB L
1083+ 1C75 67           	LD H,A
1084+ 1C76 F9           	LD SP,HL
1085+ 1C77 E1           	POP HL
1086+ 1C78 19           	ADD HL,DE
1087+ 1C79 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088+ 1C7C DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089+ 1C7F 19           	ADD HL,DE
1090+ 1C80 31 31 31     CSP_	LD SP,#3131
1091+ 1C83 E3           	EX (SP),HL
1092+ 1C84 AF           	XOR A
1093+ 1C85 DD B6 05     	OR (IX+CHP.TSlCnt)
1094+ 1C88 28 3E        	JR Z,CH_AMP
1095+ 1C8A DD 35 05     	DEC (IX+CHP.TSlCnt)
1096+ 1C8D 20 39        	JR NZ,CH_AMP
1097+ 1C8F DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098+ 1C92 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099+ 1C95 DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100+ 1C98 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101+ 1C9B 7C           	LD A,H
1102+ 1C9C 19           	ADD HL,DE
1103+ 1C9D DD 75 06     	LD (IX+CHP.CrTnSl),L
1104+ 1CA0 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105+ 1CA3 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106+ 1CA7 20 1F        	JR NZ,CH_AMP
1107+ 1CA9 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108+ 1CAC DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109+ 1CAF A7           	AND A
1110+ 1CB0 28 01        	JR Z,CH_STPP
1111+ 1CB2 EB           	EX DE,HL
1112+ 1CB3 ED 52        CH_STPP SBC HL,DE
1113+ 1CB5 FA C8 1C     	JP M,CH_AMP
1114+ 1CB8 DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115+ 1CBB DD 77 12     	LD (IX+CHP.Note),A
1116+ 1CBE AF           	XOR A
1117+ 1CBF DD 77 05     	LD (IX+CHP.TSlCnt),A
1118+ 1CC2 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119+ 1CC5 DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120+ 1CC8 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121+ 1CCB CB 79        	BIT 7,C
1122+ 1CCD 28 13        	JR Z,CH_NOAM
1123+ 1CCF CB 71        	BIT 6,C
1124+ 1CD1 28 07        	JR Z,CH_AMIN
1125+ 1CD3 FE 0F        	CP 15
1126+ 1CD5 28 0B        	JR Z,CH_NOAM
1127+ 1CD7 3C           	INC A
1128+ 1CD8 18 05        	JR CH_SVAM
1129+ 1CDA FE F1        CH_AMIN	CP -15
1130+ 1CDC 28 04        	JR Z,CH_NOAM
1131+ 1CDE 3D           	DEC A
1132+ 1CDF DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133+ 1CE2 6F           CH_NOAM	LD L,A
1134+ 1CE3 78           	LD A,B
1135+ 1CE4 E6 0F        	AND 15
1136+ 1CE6 85           	ADD A,L
1137+ 1CE7 F2 EB 1C     	JP P,CH_APOS
1138+ 1CEA AF           	XOR A
1139+ 1CEB FE 10        CH_APOS	CP 16
1140+ 1CED 38 02        	JR C,CH_VOL
1141+ 1CEF 3E 0F        	LD A,15
1142+ 1CF1 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x2067 is truncated to 8bit value: 0x67
1143+ 1CF4 C6 67        	ADD A,VT_
1144+ 1CF6 6F           	LD L,A
1145+ 1CF7 CE 20        	ADC A,VT_/256
1146+ 1CF9 95           	SUB L
1147+ 1CFA 67           	LD H,A
1148+ 1CFB 7E           	LD A,(HL)
1149+ 1CFC CB 41        CH_ENV	BIT 0,C
1150+ 1CFE 20 03        	JR NZ,CH_NOEN
1151+ 1D00 DD B6 14     	OR (IX+CHP.Env_En)
1152+ 1D03 32 24 1E     CH_NOEN	LD (Ampl),A
1153+ 1D06 CB 78        	BIT 7,B
1154+ 1D08 79           	LD A,C
1155+ 1D09 28 1A        	JR Z,NO_ENSL
1156+ 1D0B 17           	RLA
1157+ 1D0C 17           	RLA
1158+ 1D0D CB 2F        	SRA A
1159+ 1D0F CB 2F        	SRA A
1160+ 1D11 CB 2F        	SRA A
1161+ 1D13 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162+ 1D16 CB 68        	BIT 5,B
1163+ 1D18 28 03        	JR Z,NO_ENAC
1164+ 1D1A DD 77 04     	LD (IX+CHP.CrEnSl),A
1165+ 1D1D FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166+ 1D20 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167+ 1D23 18 0E        	JR CH_MIX
1168+ 1D25 1F           NO_ENSL RRA
1169+ 1D26 DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170+ 1D29 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171+ 1D2C CB 68        	BIT 5,B
1172+ 1D2E 28 03        	JR Z,CH_MIX
1173+ 1D30 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174+ 1D33 78           CH_MIX	LD A,B
1175+ 1D34 1F           	RRA
1176+ 1D35 E6 48        	AND #48
1177+ 1D37 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178+ 1D3A 0F           	RRCA
1179+ 1D3B FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180+ 1D3E E1           	POP HL
1181+ 1D3F AF           	XOR A
1182+ 1D40 DD B6 0A     	OR (IX+CHP.COnOff)
1183+ 1D43 C8           	RET Z
1184+ 1D44 DD 35 0A     	DEC (IX+CHP.COnOff)
1185+ 1D47 C0           	RET NZ
1186+ 1D48 DD AE 15     	XOR (IX+CHP.Flags)
1187+ 1D4B DD 77 15     	LD (IX+CHP.Flags),A
1188+ 1D4E 1F           	RRA
1189+ 1D4F DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190+ 1D52 38 03        	JR C,CH_ONDL
1191+ 1D54 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192+ 1D57 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193+ 1D5A C9           	RET
1194+ 1D5B
1195+ 1D5B AF           PLAY_	XOR A
1196+ 1D5C FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197+ 1D5F FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198+ 1D62 3D           	DEC A
1199+ 1D63 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200+ 1D66 FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201+ 1D69 C2 11 1E     	JP NZ,PL2
1202+ 1D6C FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203+ 1D6F 20 6C        	JR NZ,PL1B
1204+ 1D71 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205+ 1D74 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206+ 1D77 0A           	LD A,(BC)
1207+ 1D78 A7           	AND A
1208+ 1D79 20 56        	JR NZ,PL1A
1209+ 1D7B 57           	LD D,A
1210+ 1D7C FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211+ 1D7F FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212+ 1D82 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213+ 1D85 23           	INC HL
1214+ 1D86 7E           	LD A,(HL)
1215+ 1D87 3C           	INC A
1216+ 1D88 20 0B        	JR NZ,PLNLP
1217+ 1D8A
1218+ 1D8A              	IF LoopChecker
1219+ 1D8A CD 3C 16     	CALL CHECKLP
1220+ 1D8D              	ENDIF
1221+ 1D8D
1222+ 1D8D FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223+ 1D90 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224+ 1D93 7E           	LD A,(HL)
1225+ 1D94 3C           	INC A
1226+ 1D95 CD E9 18     PLNLP	CALL SETCPPT
1227+ 1D98 3D           	DEC A
1228+ 1D99 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229+ 1D9D 28 03        	JR Z,NoAlCo
1230+ 1D9F              TSSub	EQU $+1
1231+ 1D9F D6 D6        	SUB #D6
1232+ 1DA1 2F           	CPL
1233+ 1DA2              NoAlCo
1234+ 1DA2              		;PT2		PT3
1235+ 1DA2 3D           PsCalc	DEC A	;ADD A,A	NOP
1236+ 1DA3 3D           	DEC A	;ADD A,(HL)	NOP
1237+ 1DA4 87           	ADD A,A
1238+ 1DA5 5F           	LD E,A
1239+ 1DA6 CB 12        	RL D
1240+ 1DA8
1241+ 1DA8              	IF CurPosCounter
1242+ 1DA8 ~            	LD A,L
1243+ 1DA8 ~            	SUB (IY-100+VRS.PosSub)
1244+ 1DA8 ~            	LD (IY-100+VRS.CurPos),A
1245+ 1DA8              	ENDIF
1246+ 1DA8
1247+ 1DA8 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248+ 1DAB FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249+ 1DAE 19           	ADD HL,DE
1250+ 1DAF FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251+ 1DB2 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252+ 1DB5 ED 73 CF 1D  	LD (PSP_+1),SP
1253+ 1DB9 F9           	LD SP,HL
1254+ 1DBA E1           	POP HL
1255+ 1DBB 19           	ADD HL,DE
1256+ 1DBC 44           	LD B,H
1257+ 1DBD 4D           	LD C,L
1258+ 1DBE E1           	POP HL
1259+ 1DBF 19           	ADD HL,DE
1260+ 1DC0 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261+ 1DC3 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262+ 1DC6 E1           	POP HL
1263+ 1DC7 19           	ADD HL,DE
1264+ 1DC8 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265+ 1DCB FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266+ 1DCE 31 31 31     PSP_	LD SP,#3131
1267+ 1DD1 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268+ 1DD4 CD 0C 19     	CALL PTDECOD
1269+ 1DD7 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270+ 1DDA FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271+ 1DDD
1272+ 1DDD FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273+ 1DE0 20 12        	JR NZ,PL1C
1274+ 1DE2 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275+ 1DE5 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276+ 1DE8 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277+ 1DEB CD 0C 19     	CALL PTDECOD
1278+ 1DEE FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279+ 1DF1 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280+ 1DF4
1281+ 1DF4 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282+ 1DF7 20 12        	JR NZ,PL1D
1283+ 1DF9 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284+ 1DFC FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285+ 1DFF FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286+ 1E02 CD 0C 19     	CALL PTDECOD
1287+ 1E05 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288+ 1E08 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289+ 1E0B
1290+ 1E0B FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291+ 1E0E FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292+ 1E11
1293+ 1E11 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294+ 1E14 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295+ 1E17 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296+ 1E1A CD E4 1B     	CALL CHREGS
1297+ 1E1D FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298+ 1E20 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299+ 1E23              Ampl	EQU $+1
1300+ 1E23 3E 3E        	LD A,#3E
1301+ 1E25 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302+ 1E28 11 BC FF     	LD DE,VRS.ChanB-100
1303+ 1E2B FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304+ 1E2E FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305+ 1E31 CD E4 1B     	CALL CHREGS
1306+ 1E34 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307+ 1E37 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308+ 1E3A 3A 24 1E     	LD A,(Ampl)
1309+ 1E3D FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310+ 1E40 11 D9 FF     	LD DE,VRS.ChanC-100
1311+ 1E43 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312+ 1E46 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313+ 1E49 CD E4 1B     	CALL CHREGS
1314+ 1E4C FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315+ 1E4F FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316+ 1E52 3A 24 1E     	LD A,(Ampl)
1317+ 1E55 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318+ 1E58
1319+ 1E58 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320+ 1E5B FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321+ 1E5E FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322+ 1E61
1323+ 1E61 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324+ 1E64 5F           	LD E,A
1325+ 1E65 87           	ADD A,A
1326+ 1E66 9F           	SBC A,A
1327+ 1E67 57           	LD D,A
1328+ 1E68 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329+ 1E6B FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330+ 1E6E 19           	ADD HL,DE
1331+ 1E6F FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332+ 1E72 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333+ 1E75 19           	ADD HL,DE
1334+ 1E76 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335+ 1E79 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336+ 1E7C
1337+ 1E7C AF           	XOR A
1338+ 1E7D FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339+ 1E80 C8           	RET Z
1340+ 1E81 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341+ 1E84 C0           	RET NZ
1342+ 1E85 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343+ 1E88 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344+ 1E8B FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345+ 1E8E FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346+ 1E91 19           	ADD HL,DE
1347+ 1E92 C3 FE 18     	JP SETESLD
1348+ 1E95
1349+ 1E95 FD 21 CD 1F  PLAY    LD IY,VARS1+100
1350+ 1E99 CD 5B 1D     	CALL PLAY_
1351+ 1E9C 3A 68 1F     	LD A,(is_ts)
1352+ 1E9F A7           	AND A
1353+ 1EA0 28 07        	JR Z,PL_nts
1354+ 1EA2 FD 21 54 20  	LD IY,VARS2+100
1355+ 1EA6 CD 5B 1D     	CALL PLAY_
1356+ 1EA9              PL_nts
1357+ 1EA9              	IF Basic
1358+ 1EA9 FD 21 3A 5C  	LD IY,#5C3A
1359+ 1EAD              	ENDIF
1360+ 1EAD
1361+ 1EAD 01 FD FF     ROUT	LD BC,#FFFD
1362+ 1EB0 3A 68 1F     	LD A,(is_ts)
1363+ 1EB3 A7           	AND A
1364+ 1EB4 28 02        	JR Z,r_nts ;keep old standard
1365+ 1EB6 ED 41        	OUT (C),B
1366+ 1EB8 08           r_nts	EX AF,AF'
1367+ 1EB9
1368+ 1EB9              	IF ACBBAC
1369+ 1EB9 ~            	LD IX,VARS1+VRS.AYREGS
1370+ 1EB9              	ELSE
1371+ 1EB9 21 E2 1F     	LD HL,VARS1+VRS.AYREGS
1372+ 1EBC              	ENDIF
1373+ 1EBC
1374+ 1EBC CD C8 1E     	CALL ROUT_
1375+ 1EBF 08           	EX AF,AF'
1376+ 1EC0 C8           	RET Z
1377+ 1EC1 42           	LD B,D
1378+ 1EC2 2F           	CPL
1379+ 1EC3 ED 79        	OUT (C),A
1380+ 1EC5
1381+ 1EC5              	IF ACBBAC
1382+ 1EC5 ~            	LD IX,VARS2+VRS.AYREGS
1383+ 1EC5              	ELSE
1384+ 1EC5 21 69 20     	LD HL,VARS2+VRS.AYREGS
1385+ 1EC8              	ENDIF
1386+ 1EC8
1387+ 1EC8              ROUT_
1388+ 1EC8              	IF ACBBAC
1389+ 1EC8 ~            	LD A,(SETUP)
1390+ 1EC8 ~            	AND 12
1391+ 1EC8 ~            	JR Z,ABC
1392+ 1EC8 ~            	ADD A,CHTABLE
1393+ 1EC8 ~            	LD E,A
1394+ 1EC8 ~            	ADC A,CHTABLE/256
1395+ 1EC8 ~            	SUB E
1396+ 1EC8 ~            	LD D,A
1397+ 1EC8 ~            	LD B,0
1398+ 1EC8 ~            	PUSH IX
1399+ 1EC8 ~            	POP HL
1400+ 1EC8 ~            	LD A,(DE)
1401+ 1EC8 ~            	INC DE
1402+ 1EC8 ~            	LD C,A
1403+ 1EC8 ~            	ADD HL,BC
1404+ 1EC8 ~            	LD A,(IX+TonB)
1405+ 1EC8 ~            	LD C,(HL)
1406+ 1EC8 ~            	LD (IX+TonB),C
1407+ 1EC8 ~            	LD (HL),A
1408+ 1EC8 ~            	INC HL
1409+ 1EC8 ~            	LD A,(IX+TonB+1)
1410+ 1EC8 ~            	LD C,(HL)
1411+ 1EC8 ~            	LD (IX+TonB+1),C
1412+ 1EC8 ~            	LD (HL),A
1413+ 1EC8 ~            	LD A,(DE)
1414+ 1EC8 ~            	INC DE
1415+ 1EC8 ~            	LD C,A
1416+ 1EC8 ~            	ADD HL,BC
1417+ 1EC8 ~            	LD A,(IX+AmplB)
1418+ 1EC8 ~            	LD C,(HL)
1419+ 1EC8 ~            	LD (IX+AmplB),C
1420+ 1EC8 ~            	LD (HL),A
1421+ 1EC8 ~            	LD A,(DE)
1422+ 1EC8 ~            	INC DE
1423+ 1EC8 ~            	LD (RxCA1),A
1424+ 1EC8 ~            	XOR 8
1425+ 1EC8 ~            	LD (RxCA2),A
1426+ 1EC8 ~            	LD A,(DE)
1427+ 1EC8 ~            	AND (IX+Mixer)
1428+ 1EC8 ~            	LD E,A
1429+ 1EC8 ~            	LD A,(IX+Mixer)
1430+ 1EC8 ~            RxCA1	DB #E6
1431+ 1EC8 ~            	AND %010010
1432+ 1EC8 ~            	OR E
1433+ 1EC8 ~            	LD E,A
1434+ 1EC8 ~            	LD A,(IX+Mixer)
1435+ 1EC8 ~            	AND %010010
1436+ 1EC8 ~            RxCA2	OR E
1437+ 1EC8 ~            	OR E
1438+ 1EC8 ~            	LD (IX+Mixer),A
1439+ 1EC8 ~            ABC
1440+ 1EC8              	ENDIF
1441+ 1EC8
1442+ 1EC8 AF           	XOR A
1443+ 1EC9 11 BF FF     	LD DE,#FFBF
1444+ 1ECC
1445+ 1ECC              	IF ACBBAC
1446+ 1ECC ~            	LD BC,#FFFD
1447+ 1ECC ~            	PUSH IX
1448+ 1ECC ~            	POP HL
1449+ 1ECC              	ENDIF
1450+ 1ECC
1451+ 1ECC ED 79        LOUT	OUT (C),A
1452+ 1ECE 43           	LD B,E
1453+ 1ECF ED A3        	OUTI
1454+ 1ED1 42           	LD B,D
1455+ 1ED2 3C           	INC A
1456+ 1ED3 FE 0D        	CP 13
1457+ 1ED5 20 F5        	JR NZ,LOUT
1458+ 1ED7 ED 79        	OUT (C),A
1459+ 1ED9 7E           	LD A,(HL)
1460+ 1EDA A7           	AND A
1461+ 1EDB F8           	RET M
1462+ 1EDC 43           	LD B,E
1463+ 1EDD ED 79        	OUT (C),A
1464+ 1EDF C9           	RET
1465+ 1EE0
1466+ 1EE0              	IF ACBBAC
1467+ 1EE0 ~            CHTABLE	EQU $-4
1468+ 1EE0 ~            	DB 4,5,15,%001001,0,7,7,%100100
1469+ 1EE0              	ENDIF
1470+ 1EE0
1471+ 1EE0 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472+ 1EE1 2A           	DB TCNEW_0-T_
1473+ 1EE2 65           	DB (T_OLD_0-T1_)*2+1
1474+ 1EE3 00           	DB TCOLD_0-T_
1475+ 1EE4 01           	DB (T_NEW_1-T1_)*2+1
1476+ 1EE5 0C           	DB TCNEW_1-T_
1477+ 1EE6 01           	DB (T_OLD_1-T1_)*2+1
1478+ 1EE7 0C           	DB TCOLD_1-T_
1479+ 1EE8 94           	DB (T_NEW_2-T1_)*2
1480+ 1EE9 35           	DB TCNEW_2-T_
1481+ 1EEA 30           	DB (T_OLD_2-T1_)*2
1482+ 1EEB 0E           	DB TCOLD_2-T_
1483+ 1EEC 60           	DB (T_NEW_3-T1_)*2
1484+ 1EED 20           	DB TCNEW_3-T_
1485+ 1EEE 60           	DB (T_OLD_3-T1_)*2
1486+ 1EEF 21           	DB TCOLD_3-T_
1487+ 1EF0
1488+ 1EF0              T_
1489+ 1EF0
1490+ 1EF0 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490+ 1EF4 0D 0F 13 15
1491+ 1EF8 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492+ 1EFC 5D 00        TCOLD_1	DB #5C+1,0
1493+ 1EFE 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493+ 1F02 5F 71 82 8C
1493+ 1F06 9C
1494+ 1F07 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494+ 1F0B AA AC AE AE
1494+ 1F0F 00
1495+ 1F10 57           TCNEW_3	DB #56+1
1496+ 1F11 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496+ 1F15 2D 2F 33 BF
1496+ 1F19 00
1497+ 1F1A 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497+ 1F1E 2B 2D 31 55
1498+ 1F22 BD BF 00     	DB #BC+1,#BE+1,0
1499+ 1F25              TCNEW_1 EQU TCOLD_1
1500+ 1F25 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500+ 1F29 2B 3B 4D 5F
1501+ 1F2D BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502+ 1F31
1503+ 1F31              PT3EMPTYORN EQU $-1
1504+ 1F31 01 00        	DB 1,0
1505+ 1F33
1506+ 1F33              ;first 12 values of tone tables (packed)
1507+ 1F33
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508+ 1F33 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509+ 1F35 69           	DB #0755-#06EC
1510+ 1F36 70           	DB #07C5-#0755
1511+ 1F37 76           	DB #083B-#07C5
1512+ 1F38 7D           	DB #08B8-#083B
1513+ 1F39 85           	DB #093D-#08B8
1514+ 1F3A 8D           	DB #09CA-#093D
1515+ 1F3B 95           	DB #0A5F-#09CA
1516+ 1F3C 9D           	DB #0AFC-#0A5F
1517+ 1F3D A8           	DB #0BA4-#0AFC
1518+ 1F3E B1           	DB #0C55-#0BA4
1519+ 1F3F BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520+ 1F40 0C DA        	DB #066D*2/256,#066D*2
1521+ 1F42 62           	DB #06CF-#066D
1522+ 1F43 68           	DB #0737-#06CF
1523+ 1F44 6D           	DB #07A4-#0737
1524+ 1F45 75           	DB #0819-#07A4
1525+ 1F46 7B           	DB #0894-#0819
1526+ 1F47 83           	DB #0917-#0894
1527+ 1F48 8A           	DB #09A1-#0917
1528+ 1F49 92           	DB #0A33-#09A1
1529+ 1F4A 9C           	DB #0ACF-#0A33
1530+ 1F4B A4           	DB #0B73-#0ACF
1531+ 1F4C AF           	DB #0C22-#0B73
1532+ 1F4D B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533+ 1F4E 0E 08        	DB #0704*2/256,#0704*2
1534+ 1F50 6A           	DB #076E-#0704
1535+ 1F51 72           	DB #07E0-#076E
1536+ 1F52 78           	DB #0858-#07E0
1537+ 1F53 7E           	DB #08D6-#0858
1538+ 1F54 86           	DB #095C-#08D6
1539+ 1F55 90           	DB #09EC-#095C
1540+ 1F56 96           	DB #0A82-#09EC
1541+ 1F57 A0           	DB #0B22-#0A82
1542+ 1F58 AA           	DB #0BCC-#0B22
1543+ 1F59 B4           	DB #0C80-#0BCC
1544+ 1F5A BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545+ 1F5B 0F C0        	DB #07E0*2/256,#07E0*2
1546+ 1F5D 78           	DB #0858-#07E0
1547+ 1F5E 88           	DB #08E0-#0858
1548+ 1F5F 80           	DB #0960-#08E0
1549+ 1F60 90           	DB #09F0-#0960
1550+ 1F61 98           	DB #0A88-#09F0
1551+ 1F62 A0           	DB #0B28-#0A88
1552+ 1F63 B0           	DB #0BD8-#0B28
1553+ 1F64 A8           	DB #0C80-#0BD8
1554+ 1F65 E0           	DB #0D60-#0C80
1555+ 1F66 B0           	DB #0E10-#0D60
1556+ 1F67 E8           	DB #0EF8-#0E10
1557+ 1F68
1558+ 1F68              ;vars from here can be stripped
1559+ 1F68              ;you can move VARS to any other address
1560+ 1F68
1561+ 1F68              VARS
1562+ 1F68
1563+ 1F68 00           is_ts	DB 0
1564+ 1F69
1565+ 1F69              ;ChannelsVars
1566+ 1F69              	STRUCT	CHP
1567+ 1F69 ~            ;reset group
1568+ 1F69 ~            PsInOr	DB 0
1569+ 1F69 ~            PsInSm	DB 0
1570+ 1F69 ~            CrAmSl	DB 0
1571+ 1F69 ~            CrNsSl	DB 0
1572+ 1F69 ~            CrEnSl	DB 0
1573+ 1F69 ~            TSlCnt	DB 0
1574+ 1F69 ~            CrTnSl	DW 0
1575+ 1F69 ~            TnAcc	DW 0
1576+ 1F69 ~            COnOff	DB 0
1577+ 1F69 ~            ;reset group
1578+ 1F69 ~
1579+ 1F69 ~            OnOffD	DB 0
1580+ 1F69 ~
1581+ 1F69 ~            ;IX for PTDECOD here (+12)
1582+ 1F69 ~            OffOnD	DB 0
1583+ 1F69 ~            OrnPtr	DW 0
1584+ 1F69 ~            SamPtr	DW 0
1585+ 1F69 ~            NNtSkp	DB 0
1586+ 1F69 ~            Note	DB 0
1587+ 1F69 ~            SlToNt	DB 0
1588+ 1F69 ~            Env_En	DB 0
1589+ 1F69 ~            Flags	DB 0
1590+ 1F69 ~             ;Enabled - 0, SimpleGliss - 2
1591+ 1F69 ~            TnSlDl	DB 0
1592+ 1F69 ~            TSlStp	DW 0
1593+ 1F69 ~            TnDelt	DW 0
1594+ 1F69 ~            NtSkCn	DB 0
1595+ 1F69 ~            Volume	DB 0
1596+ 1F69              	ENDS
1597+ 1F69
1598+ 1F69              	STRUCT	VRS
1599+ 1F69 ~
1600+ 1F69 ~            ;IF not works in STRUCT in SjASM :(
1601+ 1F69 ~            ;	IF CurPosCounter
1602+ 1F69 ~            CurPos	DB 0
1603+ 1F69 ~            PosSub	DB 0
1604+ 1F69 ~            ;	ENDIF
1605+ 1F69 ~
1606+ 1F69 ~            ModNum	DB 0 ;bit0: ChipNum
1607+ 1F69 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608+ 1F69 ~
1609+ 1F69 ~            ChanA	DS CHP
1610+ 1F69 ~            ChanB	DS CHP
1611+ 1F69 ~            ChanC	DS CHP
1612+ 1F69 ~
1613+ 1F69 ~            ;GlobalVars
1614+ 1F69 ~            MODADDR	DW 0
1615+ 1F69 ~            OrnPtrs	DW 0
1616+ 1F69 ~            SamPtrs	DW 0
1617+ 1F69 ~            PatsPtr	DW 0
1618+ 1F69 ~            AdInPtA	DW 0
1619+ 1F69 ~            AdInPtB	DW 0
1620+ 1F69 ~            AdInPtC	DW 0
1621+ 1F69 ~            CrPsPtr	DW 0
1622+ 1F69 ~            LPosPtr	DW 0
1623+ 1F69 ~            Delay	DB 0
1624+ 1F69 ~            DelyCnt	DB 0
1625+ 1F69 ~            ESldAdd	DW 0
1626+ 1F69 ~            CurESld	DW 0
1627+ 1F69 ~            Env_Del	DB 0
1628+ 1F69 ~            CurEDel	DB 0
1629+ 1F69 ~            Ns_Base	DB 0
1630+ 1F69 ~            AddToNs	DB 0
1631+ 1F69 ~            AddToEn	DB 0
1632+ 1F69 ~            EnvBase	DW 0
1633+ 1F69 ~            AYREGS	DS 14
1634+ 1F69              	ENDS
1635+ 1F69
1636+ 1F69 00 00 00...  VARS1	DS VRS
1637+ 1FF0 00 00 00...  VARS2	DS VRS
1638+ 2077
1639+ 2077              VT_	EQU $-16
1640+ 2077 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641+ 2167
1642+ 2167              T1_	EQU VT_+16 ;Tone tables data depacked here
1643+ 2167
1644+ 2167              T_OLD_1	EQU T1_
1645+ 2167              T_OLD_2	EQU T_OLD_1+24
1646+ 2167              T_OLD_3	EQU T_OLD_2+24
1647+ 2167              T_OLD_0	EQU T_OLD_3+2
1648+ 2167              T_NEW_0	EQU T_OLD_0
1649+ 2167              T_NEW_1	EQU T_OLD_1
1650+ 2167              T_NEW_2	EQU T_NEW_0+24
1651+ 2167              T_NEW_3	EQU T_OLD_3
1652+ 2167
1653+ 2167              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654+ 2167
1655+ 2167 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656+ 2227
1657+ 2227              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658+ 2227
1659+ 2227              VARSEND EQU $
1660+ 2227
1661+ 2227              MDLADDR EQU outputBuffer
1662+ 2227
1663+ 2227              ;Release 0 steps:
1664+ 2227              ;04/21/2007
1665+ 2227              ;Works start (PTxPlay adaptation); first beta.
1666+ 2227              ;04/22/2007
1667+ 2227              ;Job finished; beta-testing.
1668+ 2227              ;04/23/2007
1669+ 2227              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670+ 2227              ;04/29/2007
1671+ 2227              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672+ 2227              ;modules of v3.7+.
1673+ 2227
1674+ 2227              ;Size (minimal build for ZX Spectrum):
1675+ 2227              ;Code block #908 bytes
1676+ 2227              ;Variables #2BF bytes (can be stripped)
1677+ 2227              ;Total size #908+#2BF=#BC7 (3015) bytes
1678+ 2227              	ENDMODULE
# file closed: player.asm
2460  2227 00 00 00...  	align 256
2461  2300              font
2462  2300              	incbin fontV6.chr ;шрифт
2463  2B00
2464  2B00              ;Переменные
2465  2B00 00           proc_next_find_focus_flag db 0 ;флаг внеочередного вызова процесса в фокусе
2466  2B01 00           Interrupt_new_flag db 0 ;флаг только что было прерывание
2467  2B02 00           uart_enable db 0; флаг есть порт uart
2468  2B03 00           proc_play_ay db 0 ;код процесса с музыкой AY
2469  2B04 00           proc_play_ay_slot2 db 0 ;страница с музыкой AY
2470  2B05 00           proc_play_ay_slot3 db 0 ;страница с музыкой AY
2471  2B06 00           scr_cur db 0 ;текущий активный экран
2472  2B07 00           proc_id_focus db 0 ;процесс, у которого фокус (видимый экран и доступно управление)
2473  2B08 00 00        proc_stack_addr_tmp dw 0 ; временно адрес стека
2474  2B0A 00 00        proc_stack_addr_tmp_wait dw 0 ; временно адрес стека
2475  2B0C 00           os_wait_flag db 0; флаг вызова os_wait
2476  2B0D 00           proc_next_find_skip_flag db 0; флаг дополнительных проверок переключения задач
2477  2B0E 00 00        proc_stack_addr_return_tmp dw 0 ;временно адрес возврата из прерываний
2478  2B10 00           key_proc_switch_flag db 0 ;флаг что нажата клавиша переключения задач
2479  2B11 00           key_lang_flag db 0 ;флаг что нажата клавиша rus lat
2480  2B12 00           key_caps_lock_switch_flag db 0 ;флаг что нажата клавиша caps lock
2481  2B13 00           key_graph_flag db 0 ;флаг что нажата клавиша graph
2482  2B14 00           key_sys_focus db 0 ;кнопка sys процесс в фокус
2483  2B15 00 00        FlgScanKeys_addr dw 0 ;адрес флаги драйвера
2484  2B17              ;stack_adr_sys dw 0 ;адрес системного стека
2485  2B17 00           page_slot3_cur db 0 ;текущая страница вы слоте 3
2486  2B18 00           page_slot2_cur db 0 ;текущая страница вы слоте 2
2487  2B19 00           con_scr_cur db 0 ;страница активного экрана пиксели
2488  2B1A 00           con_atr_cur db 0 ;страница активного экрана атрибуты
2489  2B1B 00           key_cur db 0 ;печатный код нажатой клавиши
2490  2B1C 00           file_id_cur db 0 ;временно id файла
2491  2B1D
2492  2B1D 00           proc_id_next db 0 ;код следующего процесса
2493  2B1E 00 00        proc_stack_adr_tmp dw 0 ;временно адрес стека
2494  2B20 00           proc_id_cur db 0 ;id текущего процесса
2495  2B21              ;proc_id_cur_tmp db 0 ;временно id процесса
2496  2B21              ;proc_sys_name db "SYS        ",0 ;имя системного процесса
2497  2B21              ;proc_cmd_name db "CMD        ",0 ;имя процесса консоль
2498  2B21 00 00 00 00  sys_timer ds 4 ;таймер - счётчик прерываний
2499  2B25
2500  2B25 00 00 00...  	align 256
2501  2C00              proc_table ;данные процессов и приложений
2502  2C00 00 00 00...  	ds proc_descr_size*proc_max ;на командную строку, список страниц и прочее
2503  3400              	;#00 - id процесса
2504  3400              	;#01 - id родительского
2505  3400              	;#02 - страница #8000
2506  3400              	;#03 - страница #c000
2507  3400              	;#04 - страница буфер экран пиксели
2508  3400              	;#05 - страница буфер экран атрибуты
2509  3400              	;#06-07 - адрес стека
2510  3400              	;#08-09 - позиция аппаратного скрола
2511  3400              	;#0a-0b - координаты курсора
2512  3400              	;#0c-0d - цвет текста основной, цвет второй
2513  3400              	;#0e-0f - адрес вызова по прерыванию
2514  3400              	;#10-1b - Имя
2515  3400              	;#1c - графический режим (номер страницы. 0 - текстовый)
2516  3400              	;#1d - флаг, что процесс запросил os_wait
2517  3400
2518  3400              	;..#80 - верх стека
2519  3400
2520  3400              proc_page_table	;таблица занятых процессами страниц
2521  3400 00 00 00...  	ds 128 ;у GMX всего 128
2522  3480
2523  3480
2524  3480              esp_link_id_table;_id_table ;таблица соединений ESP
2525  3480              	;0 - id процесса (одновременно флаг "соединение используется")
2526  3480              	;1 - запрос соединения (=1 - активен)
2527  3480              	;2 - результат соединения (=1 - успешно, =255 - ошибка)
2528  3480              	;3 - запрос на отправку (=1 - активен)
2529  3480              	;4 - результат отправки (=1 - успешно, =255 - ошибка)
2530  3480              	;5 - запрос на приём (=1 - активен)
2531  3480              	;6 - результат приёма (=1 - успешно, =255 - ошибка)
2532  3480              	;7-8 - адрес назначения данных (для принятых)
2533  3480              	;9-10 - длина данных
2534  3480              	;11-13 -
2535  3480              	;14 - тип (TCP, UDP, SSL)
2536  3480              	;15-58 - адрес сервера, в конце 0
2537  3480              	;59-63 - порт сервера, в конце 0
2538  3480
2539  3480 00 00 00...  	ds 1*esp_link_id_table_size_item ;1 соединение
2540  34C0
2541  34C0              ; esp_buffer_flag ;флаги управления буфером ESP
2542  34C0              	; ;0 - буфер занят системным процессом (=1 - идёт передача)
2543  34C0              	; ;1-2 - длина данных
2544  34C0              	; ds 1
2545  34C0
2546  34C0
2547  34C0              ; proc_name_01	db "radio.apg",0
2548  34C0              ; proc_name_02	db "moonr.apg",0
2549  34C0              ; proc_name_03	db "nc.apg",0
2550  34C0 73 79 73 2E  proc_name_sys	db "sys.osg",0
2550  34C4 6F 73 67 00
2551  34C8              ; proc_name_net	db "net.apg",0
2552  34C8
2553  34C8
2554  34C8              ;Константы
2555  34C8              uart_port equ #EF ;порт
2556  34C8              outputBuffer equ #c000 ;адрес файла для плеера AY
2557  34C8              proc_color_def equ 7 ;цвет текста консоли
2558  34C8              proc_color2_def equ #c ;цвет текста консоли 2 яркий
2559  34C8              function_max equ 41+1 ;всего функций
2560  34C8              proc_size_max equ #80 ;максимальный размер приложения старший байт
2561  34C8              proc_descr_size equ 256 ;область памяти на одно приложение
2562  34C8              proc_max equ 8 ;максимальное количество приложений
2563  34C8              page_max equ drvgmx.page_table_end-drvgmx.page_table ;всего доступных страниц из 128
2564  34C8              proc_id_system equ 1 ;код системного процесса
2565  34C8              ;proc_stack equ #4000;адрес стека для процессов
2566  34C8              ;proc_stack_size equ 128 ;размер стека для процесса
2567  34C8              con_scr_real equ #39 ;экран физический
2568  34C8              con_atr_real equ #79 ;атрибуты
2569  34C8              ;page_slot2_def equ 2 ;страница по умолчанию слот 2
2570  34C8              ;page_slot3_def equ 1 ;страница по умолчанию слот 3
2571  34C8              proc_switch_key equ #1b ;код перключения задач sh+Enter
2572  34C8              ;esp_max_link_id equ 5 ;всего соединений ESP
2573  34C8              esp_link_id_table_size_item equ 64 ;размер элемента в таблице соединений
2574  34C8
2575  34C8              ;Сообщения
2576  34C8              msg_init_uart_found
2577  34C8 55 41 52 54  	db "UART #EF found",13,10,0
2577  34CC 20 23 45 46
2577  34D0 20 66 6F 75
2577  34D4 6E 64 0D 0A
2577  34D8 00
2578  34D9              msg_init_uart_not_found
2579  34D9 55 41 52 54  	db "UART #EF not found",13,10,0
2579  34DD 20 23 45 46
2579  34E1 20 6E 6F 74
2579  34E5 20 66 6F 75
2579  34E9 6E 64 0D 0A
2579  34ED 00
2580  34EE              msg_proc_max
2581  34EE 4E 6F 74 20  	db "Not enough processes",13,10,0
2581  34F2 65 6E 6F 75
2581  34F6 67 68 20 70
2581  34FA 72 6F 63 65
2581  34FE 73 73 65 73
2581  3502 0D 0A 00
2582  3505              msg_mem_max
2583  3505 4E 6F 74 20  	db "Not enough memory",13,10,0
2583  3509 65 6E 6F 75
2583  350D 67 68 20 6D
2583  3511 65 6D 6F 72
2583  3515 79 0D 0A 00
2584  3519
2585  3519
2586  3519
2587  3519              msg_ver_os
2588  3519 4F 53 20 76  	db "OS ver 2025.02.07",13,10,0
2588  351D 65 72 20 32
2588  3521 30 32 35 2E
2588  3525 30 32 2E 30
2588  3529 37 0D 0A 00
2589  352D
2590  352D
2591  352D
2592  352D
2593  352D
2594  352D
2595  352D              ; start_sys_incl
2596  352D              	; incbin sys.apg ;
2597  352D              ; end_sys_incl
2598  352D
2599  352D              ; start_cmd_incl
2600  352D              	; incbin cmd.apg ;
2601  352D              ; end_cmd_incl
2602  352D
2603  352D              	;Последний перед #4000 буфер для данных от ESP
2604  352D 00 00 00...  esp_buffer ds 1500 ;буфер для обмена с ESP
2605  3B09
2606  3B09              end_os_main
2607  3B09              	SAVETRD "OS.TRD",|"OS.C",start_os_main,$-start_os_main ;сохранить в TRD
2608  3B09              	SAVEBIN "os.c",start_os_main,$-start_os_main ;сохранить для FAT
2609  3B09
2610  3B09              	;манипуляции для создания hobeta
2611  3B09              	org #c000
2612  C000              	incbin "os.c"
2613  FB09              	SAVEHOB "os.$c","os.C",#C000,end_os_main-start_os_main ;
2614  FB09
2615  FB09
2616  FB09
2617  FB09
2618  FB09
# file closed: os_main.asm
