# file opened: os_main.asm
   1  0000              ;OS GMX (izzx, 2024-2025)
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "os_defs.asm"
# file opened: os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 200+ 0000                  ; ld c,#14
 201+ 0000                  ; rst #20
 202+ 0000                  ; endm
 203+ 0000
 204+ 0000
 205+ 0000              ;плеер AY ----------------------------
 206+ 0000
 207+ 0000              ;инициализация плеера AY;
 208+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 209+ 0000 ~                ld c,#15
 210+ 0000 ~                rst #20
 211+ 0000                  endm
 212+ 0000
 213+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 214+ 0000                  macro OS_VTPL_PLAY ;()
 215+ 0000 ~                ld c,#16
 216+ 0000 ~                rst #20
 217+ 0000                  endm
 218+ 0000
 219+ 0000              ;заглушить плеер AY;
 220+ 0000                  macro OS_VTPL_MUTE ;()
 221+ 0000 ~                ld c,#17
 222+ 0000 ~                rst #20
 223+ 0000                  endm
 224+ 0000
 225+ 0000              ;получить значение переменной плеера;
 226+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 227+ 0000 ~                ld c,#18
 228+ 0000 ~                rst #20
 229+ 0000                  endm
 230+ 0000
 231+ 0000
 232+ 0000              ;прочие ------------------------------
 233+ 0000
 234+ 0000
 235+ 0000              ;скопировать данные из страницы в страницу
 236+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 237+ 0000                  macro OS_RAM_COPY
 238+ 0000 ~                ld c,#19
 239+ 0000 ~                rst #20
 240+ 0000                  endm
 241+ 0000
 242+ 0000              ;получить дополнительную страницу памяти;
 243+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 244+ 0000 ~                ld c,#1a
 245+ 0000 ~                rst #20
 246+ 0000                  endm
 247+ 0000
 248+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 249+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 250+ 0000 ~                ld c,#1b
 251+ 0000 ~                rst #20
 252+ 0000                  endm
 253+ 0000
 254+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 255+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 256+ 0000 ~                ld c,#1c
 257+ 0000 ~                rst #20
 258+ 0000                  endm
 259+ 0000
 260+ 0000              ;включить экран N;
 261+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 262+ 0000              ;переключать может только приложение в фокусе
 263+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 264+ 0000              ;при переключении процессов сохраняется только экран #39
 265+ 0000                  macro OS_SET_SCREEN ;
 266+ 0000 ~                ld c,#1d
 267+ 0000 ~                rst #20
 268+ 0000                  endm
 269+ 0000
 270+ 0000
 271+ 0000              ;получить номера страниц процесса;
 272+ 0000              ;вх:
 273+ 0000              ;вых: b, c - страницы в слотах 2, 3
 274+ 0000                  macro OS_GET_MAIN_PAGES ;
 275+ 0000 ~                ld c,#1e
 276+ 0000 ~                rst #20
 277+ 0000                  endm
 278+ 0000
 279+ 0000              ;получить значение системного таймера
 280+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 281+ 0000 ~                ld c,#1F
 282+ 0000 ~                rst #20
 283+ 0000                  endm
 284+ 0000
 285+ 0000
 286+ 0000
 287+ 0000                  ; macro OS_ ;
 288+ 0000                  ; ld c,#20
 289+ 0000                  ; rst #20
 290+ 0000                  ; endm
 291+ 0000
 292+ 0000
 293+ 0000              ;дисковые операции -------------------
 294+ 0000
 295+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 296+ 0000
 297+ 0000              ; fcbFAT (из руководства к монитору)
 298+ 0000              ; формат fcb для работы с FAT
 299+ 0000
 300+ 0000              ; +#00 8 имя файла
 301+ 0000              ; +#08 3 расширение файла
 302+ 0000              ; +#0B 1 атрибуты файла
 303+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 304+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 305+ 0000              ; +#14 4 размер файла/каталога в байтах
 306+ 0000              ; +#18 4 указатель в файле
 307+ 0000              ; +#1C 1 для внутренних нужд
 308+ 0000              ; +#1D 1 для внутренних нужд
 309+ 0000              ; +#1E 1 резерв
 310+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 311+ 0000              	; 1-0,nn номер раздела
 312+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 313+ 0000              	    ; значение %11 недопустимо
 314+ 0000
 315+ 0000              ;открыть файл для чтения или записи
 316+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 317+ 0000 ~                ld c,#21
 318+ 0000 ~                rst #20
 319+ 0000                  endm
 320+ 0000
 321+ 0000              ;создать файл
 322+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 323+ 0000 ~                ld c,#22
 324+ 0000 ~                rst #20
 325+ 0000                  endm
 326+ 0000
 327+ 0000              ;прочитать из файла
 328+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
 329+ 0000 ~                ld c,#23
 330+ 0000 ~                rst #20
 331+ 0000                  endm
 332+ 0000
 333+ 0000              ;записать в файл
 334+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 335+ 0000 ~                ld c,#24
 336+ 0000 ~                rst #20
 337+ 0000                  endm
 338+ 0000
 339+ 0000              ;закрыть файл
 340+ 0000                  macro OS_FILE_CLOSE ;A - id file
 341+ 0000 ~                ld c,#25
 342+ 0000 ~                rst #20
 343+ 0000                  endm
 344+ 0000
 345+ 0000              ;чтение секторов текущего каталога
 346+ 0000              ; вх:
 347+ 0000                   ; hl - буфер для чтения
 348+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 349+ 0000                   ; b - максимальное количество секторов для чтения
 350+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 351+ 0000                     ; a=errRWnum
 352+ 0000                     ; a=errInvalidPart
 353+ 0000                     ; a=errFileEmpty
 354+ 0000                   ; cy=0, a=errEoF - каталог закончился
 355+ 0000                     ; hl - следующий адрес в буфере
 356+ 0000                     ; de - номер первого непрочитанного сектора
 357+ 0000                     ; b - не прочитано секторов
 358+ 0000                   ; cy=0 - считано успешно
 359+ 0000                     ; hl - следующий адрес в буфере
 360+ 0000                     ; de - номер первого непрочитанного сектора
 361+ 0000                     ; b=#00
 362+ 0000                  macro OS_DIR_READ ;
 363+ 0000 ~                ld c,#26
 364+ 0000 ~                rst #20
 365+ 0000                  endm
 366+ 0000
 367+ 0000              ;вход в каталог/выход в родительский каталог
 368+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 369+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 370+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 371+ 0000              	; переход в родительский, последнее имя в пути удалится).
 372+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 373+ 0000              	; добавится имя файла
 374+ 0000              ; вх:
 375+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 376+ 0000                   ; de - адрес дескриптора директории/файла
 377+ 0000              ; вых: a - если путь был указан, новая длина пути
 378+ 0000                  macro OS_DIR_OPEN ;
 379+ 0000 ~                ld c,#27
 380+ 0000 ~                rst #20
 381+ 0000                  endm
 382+ 0000
 383+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 384+ 0000              ;проверки на допустимость значений не производится
 385+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 386+ 0000              ;вх: A - id файла
 387+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 388+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 389+ 0000                  macro OS_FILE_POSITION ;
 390+ 0000 ~                ld c,#28
 391+ 0000 ~                rst #20
 392+ 0000                  endm
 393+ 0000
 394+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 395+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 396+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 397+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 398+ 0000                  macro OS_FIND_PATH ;
 399+ 0000 ~                ld c,#29
 400+ 0000 ~                rst #20
 401+ 0000                  endm
 402+ 0000
 403+ 0000
 404+ 0000              ; получение длинного имени файла
 405+ 0000              ;вх: hl - адрес буфера для имени
 406+ 0000              ;    de - номер записи в текущем каталоге
 407+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 408+ 0000              ; 	a - длина имени, с учетом нуля
 409+ 0000                  macro OS_GET_LFN ;
 410+ 0000 ~                ld c,#2a
 411+ 0000 ~                rst #20
 412+ 0000                  endm
 413+ 0000
# file closed: os_defs.asm
   4  0000
   5  0000              ;sys - системный процесс для OS
   6  0000              	org PROGSTART
   7  8000              	;bank 1
   8  8000              start_sys
   9  8000 FB           	ei
  10  8001              	;halt ;ожидание старта после прерывания
  11  8001              	;halt
  12  8001 AF           	xor a
  13  8002 D3 FE        	out (254),a
  14  8004 21 19 35     	ld hl,msg_ver_os
  15  8007              	;печать приветствия
  16  8007 CD D1 09     	call drvgmx.printZ
  17  800A
  18  800A 11 00 18     	ld de,#1800 ;координаты yx
  19  800D              	OS_SET_XY
  19  800D 0E 01       >    ld c,#01
  19  800F E7          >    rst #20
  20  8010 21 B5 82     	ld hl,msg_press_num_to_close
  21  8013              	OS_PRINTZ
  21  8013 0E 09       >    ld c,#09
  21  8015 E7          >    rst #20
  22  8016
  23  8016              	;автозапуск приложений
  24  8016 11 00 17     	ld de,#1700 ;координаты yx
  25  8019              	OS_SET_XY
  25  8019 0E 01       >    ld c,#01
  25  801B E7          >    rst #20
  26  801C 21 08 83     	ld hl,sys_file_autorun_name ;имя списка
  27  801F CD 41 0C     	call Dos.fopen_r ;откроем файл для чтения
  28  8022 DC B0 0D     	call c,Dos.file_error_print_file_open_error
  29  8025 DA A4 80     	jp c,sys_loop
  30  8028 32 07 83     	ld (sys_file_autorun_id_tmp),a ;запомнить id
  31  802B
  32  802B              	;проверка длины файла не больше #8000
  33  802B 7A           	ld	a,d ;самые старшие байты длины
  34  802C B3           	or e
  35  802D 28 09        	jr z,sys_file_size_ok ;если не слищком большой
  36  802F              sys_file_too_big
  37  802F 21 CB 0F     	ld hl,Dos.msg_file_too_big
  38  8032 CD D1 09     	call drvgmx.printZ
  39  8035 C3 A4 80     	jp sys_loop
  40  8038
  41  8038
  42  8038              sys_file_size_ok
  43  8038 78           	ld	a,b ;младший старший байт длины
  44  8039 FE 80        	cp #80
  45  803B 30 F2        	jr nc,sys_file_too_big
  46  803D              	;размер нормальный, прочитаем
  47  803D ED 43 14 83  	ld (sys_file_autorun_lenght),bc
  48  8041 21 00 C0     	ld hl,#c000
  49  8044 3A 07 83     	ld a,(sys_file_autorun_id_tmp)
  50  8047 50           	ld d,b ;размер
  51  8048 59           	ld e,c
  52  8049 CD FA 0D     	call Dos.fread
  53  804C 30 0B        	jr nc,sys_file_size_ok2
  54  804E              	;если ошибка
  55  804E CD B8 0D     	call Dos.file_error_print_file_read_error
  56  8051 3A 07 83     	ld a,(sys_file_autorun_id_tmp)
  57  8054 CD C0 0D     	call Dos.fclose ;закрыть файл
  58  8057 18 4B        	jr sys_loop
  59  8059              sys_file_size_ok2
  60  8059 3A 07 83     	ld a,(sys_file_autorun_id_tmp)
  61  805C CD C0 0D     	call Dos.fclose ;закрыть файл
  62  805F
  63  805F
  64  805F              	;анализ файла
  65  805F 21 00 C0     	ld hl,#c000
  66  8062 ED 4B 14 83  	ld bc,(sys_file_autorun_lenght) ;цикл
  67  8066              sys_file_autorun_cl
  68  8066 C5           	push bc
  69  8067 7E           	ld a,(hl)
  70  8068 FE 20        	cp " "
  71  806A 38 2C        	jr c,sys_file_autorun_next
  72  806C
  73  806C              	;тут нашли первое имя
  74  806C E5           	push hl
  75  806D 21 17 83     	ld hl,sys_file_autorun_name_tmp ;почистить буфер
  76  8070 11 18 83     	ld de,sys_file_autorun_name_tmp+1
  77  8073 01 FF 00     	ld bc,256-1
  78  8076 36 00        	ld (hl),0
  79  8078 ED B0        	ldir
  80  807A
  81  807A E1           	pop hl
  82  807B 11 17 83     	ld de,sys_file_autorun_name_tmp ;куда
  83  807E 01 00 00     	ld bc,#0000 ;макс длина 255
  84  8081              	;ld ixl,0 ;счётчик
  85  8081              sys_file_autorun_cl2
  86  8081 7E           	ld a,(hl)
  87  8082 FE 20        	cp " "
  88  8084 38 04        	jr c,sys_file_autorun_cl2_ex
  89  8086 ED A0        	ldi
  90  8088 10 F7        	djnz sys_file_autorun_cl2
  91  808A
  92  808A              sys_file_autorun_cl2_ex
  93  808A              	;запустим
  94  808A E5           	push hl
  95  808B 21 17 83     	ld hl,sys_file_autorun_name_tmp		;строка с именем
  96  808E CD D8 02     	call proc_run
  97  8091 DD 7E 00     	ld a,(ix)
  98  8094 32 16 83     	ld (sys_file_autorun_focus),a ;запомнить последний
  99  8097 E1           	pop hl
 100  8098              	;тут надо бы уменьщить счётчик bc на длину имени
 101  8098              sys_file_autorun_next
 102  8098 23           	inc hl
 103  8099 C1           	pop bc
 104  809A 0B           	dec bc
 105  809B 78           	ld a,b
 106  809C B1           	or c
 107  809D 20 C7        	jr nz, sys_file_autorun_cl
 108  809F
 109  809F 3E 01        	ld a,1
 110  80A1              	;ld a,(sys_file_autorun_focus)
 111  80A1 CD 37 02     	call proc_set_focus ;на передний план
 112  80A4
 113  80A4
 114  80A4              	;jr file_load_ok
 115  80A4              	;call proc_run_cmd ;запустить консоль
 116  80A4              	;call proc_run_cmd ;запустить консоль
 117  80A4              	; call proc_run_cmd ;запустить консоль
 118  80A4              	; call proc_run_cmd ;запустить консоль
 119  80A4              	; call proc_run_cmd ;запустить консоль
 120  80A4              	;call proc_run_cmd ;запустить консоль
 121  80A4              	;call proc_run_cmd ;запустить консоль
 122  80A4
 123  80A4              	; ld hl,proc_name_net		;строка с именем
 124  80A4              	; call proc_run ;запуск
 125  80A4
 126  80A4              	; ld hl,proc_name_01		;строка с именем
 127  80A4              	; call proc_run
 128  80A4
 129  80A4              	; ld hl,proc_name_02		;строка с именем
 130  80A4              	; call proc_run
 131  80A4
 132  80A4              	; ld hl,proc_name_03		;строка с именем
 133  80A4              	; call proc_run
 134  80A4              	; ld a,(ix)
 135  80A4              	; call proc_set_focus ;на передний план
 136  80A4
 137  80A4              sys_loop
 138  80A4              	;OS_WAIT ;для системного процесса не рекомендуется
 139  80A4 76           	halt
 140  80A5 CD 67 82     	call print_active ;индикатор
 141  80A8
 142  80A8              	OS_GET_CHAR
 142  80A8 0E 10       >    ld c,#10
 142  80AA E7          >    rst #20
 143  80AB
 144  80AB              	;печать кода нажатой клавиши
 145  80AB              	;ld a,(key_cur)
 146  80AB FE FF        	cp 255
 147  80AD 28 14        	jr z,sys_loop_skip_print_char
 148  80AF F5           	push af
 149  80B0 6F           	ld l,a
 150  80B1 26 00        	ld h,0
 151  80B3 CD F0 05     	call toDecimal
 152  80B6 11 4C 18     	ld de,#184c ;координаты yx
 153  80B9              	OS_SET_XY
 153  80B9 0E 01       >    ld c,#01
 153  80BB E7          >    rst #20
 154  80BC 21 48 06     	ld hl,decimalS+2
 155  80BF CD D1 09     	call drvgmx.printZ
 156  80C2 F1           	pop af
 157  80C3              	;-------
 158  80C3              sys_loop_skip_print_char
 159  80C3 FE 16        	cp 22 ;кнопка выхода в монитор
 160  80C5 CA 71 81     	jp z,call_monitor
 161  80C8 FE 13        	cp 19 ;кнопка запуска NC
 162  80CA CA 5F 81     	jp z,run_nc
 163  80CD FE 32        	cp "2" ;кнопки от 2 до 9
 164  80CF 38 0C        	jr c,sys_loop_skip
 165  80D1 FE 39        	cp "9"
 166  80D3 30 08        	jr nc,sys_loop_skip
 167  80D5              	;здесь надо закрыть процесс
 168  80D5 D6 30        	sub "0"
 169  80D7 CD 76 06     	call proc_close_skip
 170  80DA
 171  80DA              sys_loop_skip2
 172  80DA CD 55 81     	call release_key
 173  80DD
 174  80DD
 175  80DD              sys_loop_skip
 176  80DD 3A 10 2B     	ld a,(key_proc_switch_flag) ;если нажали переключение фокуса
 177  80E0 B7           	or a
 178  80E1 28 11        	jr z,sys_loop_skip_key_focus
 179  80E3 CD 26 02     	call proc_focus_next
 180  80E6 CD 55 81     	call release_key
 181  80E9 AF           	xor a
 182  80EA 32 10 2B     	ld (key_proc_switch_flag),a
 183  80ED 3E FF        	ld a,255
 184  80EF 32 1B 2B     	ld (key_cur),a ;очистить буфер
 185  80F2 18 56        	jr sys_loop_skip_key
 186  80F4
 187  80F4              sys_loop_skip_key_focus
 188  80F4 3A 12 2B     	ld a,(key_caps_lock_switch_flag) ;если нажали caps_lock
 189  80F7 B7           	or a
 190  80F8 28 10        	jr z,sys_loop_skip_key_caps_lock
 191  80FA 2A 15 2B     	ld hl,(FlgScanKeys_addr)
 192  80FD 3E 02        	ld a,%00000010	;?1,=1/0 CapsLock on/off
 193  80FF AE           	xor (hl)
 194  8100 77           	ld (hl),a
 195  8101 CD 55 81     	call release_key
 196  8104 AF           	xor a
 197  8105 32 12 2B     	ld (key_caps_lock_switch_flag),a
 198  8108 18 40        	jr sys_loop_skip_key
 199  810A
 200  810A              sys_loop_skip_key_caps_lock
 201  810A 3A 11 2B     	ld a,(key_lang_flag) ;если нажали rus_lat
 202  810D B7           	or a
 203  810E 28 10        	jr z,sys_loop_skip_key_rus_lat
 204  8110 2A 15 2B     	ld hl,(FlgScanKeys_addr)
 205  8113 3E 08        	ld a,%00001000	;3,=1/0 Rus/Lat
 206  8115 AE           	xor (hl) ;флаг FlgScanKeys
 207  8116 77           	ld (hl),a
 208  8117 CD 55 81     	call release_key
 209  811A AF           	xor a
 210  811B 32 11 2B     	ld (key_lang_flag),a
 211  811E 18 2A        	jr sys_loop_skip_key
 212  8120
 213  8120              sys_loop_skip_key_rus_lat
 214  8120 3A 13 2B     	ld a,(key_graph_flag) ;если нажали graph
 215  8123 B7           	or a
 216  8124 28 10        	jr z,sys_loop_skip_key_graph
 217  8126 2A 15 2B     	ld hl,(FlgScanKeys_addr)
 218  8129 3E 04        	ld a,%00000100	;2,=1/0 Grf on/off
 219  812B AE           	xor (hl)
 220  812C 77           	ld (hl),a
 221  812D CD 55 81     	call release_key
 222  8130 AF           	xor a
 223  8131 32 13 2B     	ld (key_graph_flag),a
 224  8134 18 14        	jr sys_loop_skip_key
 225  8136
 226  8136              sys_loop_skip_key_graph
 227  8136 3A 14 2B     	ld a,(key_sys_focus) ;если нажали EXT+1
 228  8139 B7           	or a
 229  813A 28 0E        	jr z,sys_loop_skip_key_sys_focus
 230  813C              	;фокус на системный процесс
 231  813C 3E 01        	ld a,1
 232  813E CD 37 02     	call proc_set_focus
 233  8141 CD 55 81     	call release_key
 234  8144 AF           	xor a
 235  8145 32 14 2B     	ld (key_sys_focus),a
 236  8148 18 00        	jr sys_loop_skip_key
 237  814A
 238  814A
 239  814A              sys_loop_skip_key_sys_focus
 240  814A
 241  814A              sys_loop_skip_key
 242  814A
 243  814A
 244  814A 3A 21 2B     	ld a,(sys_timer) ;иногда печатаем системную информацию
 245  814D E6 0F        	and %00001111
 246  814F CC 8C 81     	call z,sys_print_info
 247  8152              	; OS_GETCHAR ;получить нажатую клавишу
 248  8152              	; cp 255
 249  8152              	; jr z,sys_loop
 250  8152              	; OS_PRINT_CHARF ;печать символа
 251  8152
 252  8152
 253  8152
 254  8152 C3 A4 80     	jp sys_loop
 255  8155
 256  8155
 257  8155
 258  8155
 259  8155              release_key ;ждать отпускания клавиши
 260  8155              	;OS_WAIT ;для системного процесса не рекомендуется
 261  8155 76           	halt
 262  8156              	;ld hl,(FlgScanKeys_addr)
 263  8156              	;ждать пока отпустят все клавиши
 264  8156 AF           WAITKEY	XOR A
 264  8157 DB FE         IN A,(#FE)
 264  8159 2F            CPL
 264  815A E6 1F         AND #1F
 264  815C 20 F8         JR nz,WAITKEY
 265  815E              	;bit 6,(hl)
 266  815E              	;jr z,release_key
 267  815E C9           	ret
 268  815F
 269  815F              run_nc
 270  815F 21 89 82     	ld hl,proc_name_nc		;строка с именем
 271  8162 CD D8 02     	call proc_run
 272  8165 DA DA 80     	jp c,sys_loop_skip2
 273  8168 DD 7E 00     	ld a,(ix)
 274  816B CD 37 02     	call proc_set_focus ;на передний план
 275  816E C3 DA 80     	jp sys_loop_skip2
 276  8171
 277  8171              call_monitor	;вызов теневого монитора
 278  8171 F3           	di
 279  8172 ED 73 8A 81  	ld (call_monitor_tmp_sp),sp
 280  8176 31 00 60     	ld sp,#6000 ;временный стек
 281  8179 CD 66 00     	call #66
 282  817C ED 7B 8A 81  	ld sp,(call_monitor_tmp_sp)
 283  8180
 284  8180 3A 7C 0F     	ld a,(Dos.fs_fat_part_code_cur)
 285  8183 CD 68 0D     	call Dos.init_fs_fat_warm ;переинициализация FAT
 286  8186 FB           	ei
 287  8187 C3 DA 80     	jp sys_loop_skip2
 288  818A
 289  818A 00 00        call_monitor_tmp_sp dw 0 ;временно
 290  818C
 291  818C              ;печать информации
 292  818C              sys_print_info
 293  818C              	;инфо об открытых файлах
 294  818C              sys_print_info_files
 295  818C 21 6B 11     	ld hl,Dos.fcb_fat_table
 296  818F 06 08        	ld b,Dos.files_fat_max
 297  8191 0E 00        	ld c,0 ;счётчик
 298  8193              sys_print_info_files_cl
 299  8193 7E           	ld a,(hl)
 300  8194 B7           	or a
 301  8195 28 01        	jr z,sys_print_info_files_skip
 302  8197 0C           	inc c
 303  8198              sys_print_info_files_skip
 304  8198 10 F9        	djnz sys_print_info_files_cl
 305  819A
 306  819A 69           	ld l,c
 307  819B 26 00        	ld h,0
 308  819D CD F0 05     	call toDecimal
 309  81A0 11 00 0B     	ld de,#0b00 ;координаты yx
 310  81A3              	OS_SET_XY
 310  81A3 0E 01       >    ld c,#01
 310  81A5 E7          >    rst #20
 311  81A6 21 90 82     	ld hl,msg_files
 312  81A9 CD D1 09     	call drvgmx.printZ
 313  81AC 21 49 06     	ld hl,decimalS+3
 314  81AF CD D1 09     	call drvgmx.printZ
 315  81B2
 316  81B2              	;печать информации о памяти и процессах
 317  81B2 CD E9 81     	call get_proc_total ;печать и подсчёт процессов
 318  81B5 6F           	ld l,a
 319  81B6 26 00        	ld h,0
 320  81B8 CD F0 05     	call toDecimal
 321  81BB 11 00 0D     	ld de,#0d00 ;координаты yx
 322  81BE              	OS_SET_XY
 322  81BE 0E 01       >    ld c,#01
 322  81C0 E7          >    rst #20
 323  81C1 21 98 82     	ld hl,msg_processes
 324  81C4 CD D1 09     	call drvgmx.printZ
 325  81C7 21 49 06     	ld hl,decimalS+3
 326  81CA CD D1 09     	call drvgmx.printZ
 327  81CD
 328  81CD 11 00 0C     	ld de,#0c00 ;координаты yx
 329  81D0              	OS_SET_XY
 329  81D0 0E 01       >    ld c,#01
 329  81D2 E7          >    rst #20
 330  81D3 21 A4 82     	ld hl,msg_free_ram
 331  81D6 CD D1 09     	call drvgmx.printZ
 332  81D9 CD 56 82     	call get_free_ram ;памяти
 333  81DC 6F           	ld l,a
 334  81DD 26 00        	ld h,0
 335  81DF CD F0 05     	call toDecimal
 336  81E2 21 48 06     	ld hl,decimalS+2
 337  81E5 CD D1 09     	call drvgmx.printZ
 338  81E8 C9           	ret
 339  81E9
 340  81E9
 341  81E9
 342  81E9
 343  81E9              get_proc_total
 344  81E9              	;поиск и печать количества запущеных процессов
 345  81E9              	;вых: a - количество активных
 346  81E9 11 00 0E     	ld de,#0e00 ;координаты yx
 347  81EC              	OS_SET_XY
 347  81EC 0E 01       >    ld c,#01
 347  81EE E7          >    rst #20
 348  81EF DD 21 00 2C  	ld ix,proc_table
 349  81F3 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 350  81F5 0E 00        	ld c,0 ;счётчик
 351  81F7              get_proc_total_cl
 352  81F7 DD 7E 00     	ld a,(ix)
 353  81FA B7           	or a ;свободен?
 354  81FB 28 1F        	jr z,get_proc_total_cl1
 355  81FD
 356  81FD C5           	push bc
 357  81FE C6 30        	add '0' ;печать id
 358  8200              	OS_PRINT_CHARF
 358  8200 D7          >	rst #10
 359  8201 3E 20        	ld a," "
 360  8203              	OS_PRINT_CHARF
 360  8203 D7          >	rst #10
 361  8204 DD 7E 01     	ld a,(ix+1)
 362  8207 C6 30        	add '0' ;печать id родительского
 363  8209              	OS_PRINT_CHARF
 363  8209 D7          >	rst #10
 364  820A 3E 20        	ld a," "
 365  820C              	OS_PRINT_CHARF
 365  820C D7          >	rst #10
 366  820D
 367  820D DD E5        	push ix
 368  820F E1           	pop hl
 369  8210 01 10 00     	ld bc,16
 370  8213 09           	add hl,bc
 371  8214              	OS_PRINTZ ;печать имени
 371  8214 0E 09       >    ld c,#09
 371  8216 E7          >    rst #20
 372  8217
 373  8217 3E 0D        	ld a,13
 374  8219              	OS_PRINT_CHARF
 374  8219 D7          >	rst #10
 375  821A
 376  821A C1           	pop bc
 377  821B
 378  821B 0C           	inc c ;прибавить
 379  821C              get_proc_total_cl1
 380  821C DD 24        	inc ixh
 381  821E 10 D7        	djnz get_proc_total_cl
 382  8220 79           	ld a,c
 383  8221 32 44 82     	ld (get_proc_total_count),a
 384  8224
 385  8224              	;почистить пустые строки (надо оптимизировать по времени)
 386  8224 3E 08        	ld a,proc_max
 387  8226 91           	sub c ;сколько пустых стрк должно быть
 388  8227 28 17        	jr z,get_proc_total_ex
 389  8229 47           	ld b,a ;цикл
 390  822A 11 00 0E     	ld de,#0e00 ;координаты yx
 391  822D 79           	ld a,c
 392  822E 82           	add d
 393  822F 57           	ld d,a
 394  8230              get_proc_total_cl2
 395  8230 D5           	push de
 396  8231 C5           	push bc
 397  8232              	OS_SET_XY
 397  8232 0E 01       >    ld c,#01
 397  8234 E7          >    rst #20
 398  8235 21 45 82     	ld hl,get_proc_total_clear
 399  8238              	OS_PRINTZ ;очистить
 399  8238 0E 09       >    ld c,#09
 399  823A E7          >    rst #20
 400  823B C1           	pop bc
 401  823C D1           	pop de
 402  823D 14           	inc d
 403  823E 10 F0        	djnz get_proc_total_cl2
 404  8240
 405  8240              get_proc_total_ex
 406  8240 3A 44 82     	ld a,(get_proc_total_count)
 407  8243 C9           	ret
 408  8244 00           get_proc_total_count db 0 ;временно
 409  8245 20 20 20 20  get_proc_total_clear db "                ",0
 409  8249 20 20 20 20
 409  824D 20 20 20 20
 409  8251 20 20 20 20
 409  8255 00
 410  8256
 411  8256
 412  8256              get_free_ram
 413  8256              	;поиск количества свободных страниц памяти
 414  8256              	;вых: a - количество свободных
 415  8256 21 00 34     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 416  8259 06 6D        	ld b,page_max ;всего страниц
 417  825B 0E 00        	ld c,0 ;счётчик
 418  825D              get_free_ram_cl
 419  825D 7E           	ld a,(hl)
 420  825E B7           	or a ;свободен?
 421  825F 20 01        	jr nz,get_free_ram_cl1
 422  8261 0C           	inc c ;прибавить
 423  8262              get_free_ram_cl1
 424  8262 23           	inc hl
 425  8263 10 F8        	djnz get_free_ram_cl
 426  8265 79           	ld a,c
 427  8266 C9           	ret
 428  8267
 429  8267
 430  8267
 431  8267              print_active ;значёк активности
 432  8267 11 00 0A     	ld de,#0a00 ;координаты yx
 433  826A              	OS_SET_XY
 433  826A 0E 01       >    ld c,#01
 433  826C E7          >    rst #20
 434  826D 21 F9 82     	ld hl,msg_active
 435  8270              	OS_PRINTZ
 435  8270 0E 09       >    ld c,#09
 435  8272 E7          >    rst #20
 436  8273 3A 06 83     	ld a,(msg_active_cur)
 437  8276 3C           	inc a
 438  8277 FE 04        	cp 4
 439  8279 38 01        	jr c,print_active1
 440  827B AF           	xor a
 441  827C              print_active1
 442  827C 32 06 83     	ld (msg_active_cur),a
 443  827F 4F           	ld c,a
 444  8280 06 00        	ld b,0
 445  8282 21 01 83     	ld hl,msg_active1
 446  8285 09           	add hl,bc
 447  8286 7E           	ld a,(hl)
 448  8287              	OS_PRINT_CHARF
 448  8287 D7          >	rst #10
 449  8288 C9           	ret
 450  8289
 451  8289
 452  8289
 453  8289
 454  8289
 455  8289
 456  8289 6E 63 2E 61  proc_name_nc db "nc.apg",0
 456  828D 70 67 00
 457  8290
 458  8290              msg_files
 459  8290 46 69 6C 65  	db "Files: ",0
 459  8294 73 3A 20 00
 460  8298              msg_processes
 461  8298 50 72 6F 63  	db "Processes: ",0
 461  829C 65 73 73 65
 461  82A0 73 3A 20 00
 462  82A4              msg_free_ram
 463  82A4 46 72 65 65  	db "Free pages RAM: ",0
 463  82A8 20 70 61 67
 463  82AC 65 73 20 52
 463  82B0 41 4D 3A 20
 463  82B4 00
 464  82B5              msg_press_num_to_close
 465  82B5 53 53 2B 45  	db "SS+Enter - switch. 2-8 - close process. Ext+0 - Monitor. Ext+9 - NC",0
 465  82B9 6E 74 65 72
 465  82BD 20 2D 20 73
 465  82C1 77 69 74 63
 465  82C5 68 2E 20 32
 465  82C9 2D 38 20 2D
 465  82CD 20 63 6C 6F
 465  82D1 73 65 20 70
 465  82D5 72 6F 63 65
 465  82D9 73 73 2E 20
 465  82DD 45 78 74 2B
 465  82E1 30 20 2D 20
 465  82E5 4D 6F 6E 69
 465  82E9 74 6F 72 2E
 465  82ED 20 45 78 74
 465  82F1 2B 39 20 2D
 465  82F5 20 4E 43 00
 466  82F9 41 63 74 69  msg_active db "Active ",0
 466  82FD 76 65 20 00
 467  8301 7C 2F 2D 5C  msg_active1 db "|/-\\",0
 467  8305 00
 468  8306 00           msg_active_cur db 0 ;текущий значёк активности
 469  8307
 470  8307 00           sys_file_autorun_id_tmp db 0 ;временно
 471  8308 61 75 74 6F  sys_file_autorun_name	db "autorun.txt",0
 471  830C 72 75 6E 2E
 471  8310 74 78 74 00
 472  8314 00 00        sys_file_autorun_lenght dw 0 ;временно
 473  8316 00           sys_file_autorun_focus db 0 ;временно
 474  8317 00 00 00...  sys_file_autorun_name_tmp ds 256
 475  8417
 476  8417
 477  8417              end_sys
 478  8417              	savebin "sys.osg",start_sys,$-start_sys
 479  8417              ;------------------------------------------------------------------------
 480  8417
 481  8417
 482  8417
 483  8417
 484  8417
 485  8417
 486  8417
 487  8417
 488  8417
 489  8417
 490  8417
 491  8417
 492  8417
 493  8417
 494  8417
 495  8417
 496  8417
 497  8417
 498  8417
 499  8417
 500  8417
 501  8417
 502  8417
 503  8417
 504  8417
 505  8417              ;sys - сетевой процесс для OS
 506  8417              	org PROGSTART
 507  8000              start_net
 508  8000
 509  8000 21 1B 85     	ld hl,msg_ver_net
 510  8003              	;печать приветствия
 511  8003 CD D1 09     	call drvgmx.printZ
 512  8006
 513  8006              ;uart #EF (wifi)
 514  8006 AF           	xor a
 515  8007 32 02 2B     	ld (uart_enable),a ;флаг порт отсутствует
 516  800A              	; ld a,1
 517  800A              	; ld (esp_link_id_table),a ;временно занять порт
 518  800A CD CA 81     	call Uart.check
 519  800D FE FF        	cp 255
 520  800F              	;jr z,init_uart_no ;отключить проверку можно тут
 521  800F              	;нашли uart
 522  800F 3E 01        	ld a,1
 523  8011 32 02 2B     	ld (uart_enable),a ;порт есть
 524  8014 21 C8 34     	ld hl,msg_init_uart_found
 525  8017 CD D1 09     	call drvgmx.printZ
 526  801A CD 3B 82     	call Wifi.init
 527  801D 18 06        	jr init_uart_yes
 528  801F              init_uart_no
 529  801F              	;печать
 530  801F 21 D9 34     	ld hl,msg_init_uart_not_found
 531  8022 CD D1 09     	call drvgmx.printZ
 532  8025              init_uart_yes
 533  8025
 534  8025
 535  8025              net_loop
 536  8025              	OS_WAIT
 536  8025 DF          >	rst #18
 537  8026 CD 9A 81     	call print_active_net ;индикатор
 538  8029 CD 3C 80     	call esp_check_open ;проверить соединения
 539  802C CD A2 80     	call esp_check_send ;проверить пакеты на отправку
 540  802F CD C5 80     	call esp_check_get ;проверить пакеты на приём
 541  8032 3A 21 2B     	ld a,(sys_timer) ;иногда печатаем сетевую информацию
 542  8035 E6 0E        	and %00001110
 543  8037 CC 1C 81     	call z,print_esp_link
 544  803A
 545  803A 18 E9        	jr net_loop
 546  803C
 547  803C
 548  803C              esp_check_open ;проверка очереди соединений ESP
 549  803C DD 21 80 34  	ld ix,esp_link_id_table ;
 550  8040              	;push bc
 551  8040 DD 7E 01     	ld a,(ix+1)
 552  8043 B7           	or a ;запрос есть?
 553  8044 C8           	ret z
 554  8045              	;есть запрос
 555  8045
 556  8045 DD 7E 0E     	ld a,(ix+14) ;подставить тип соединения
 557  8048 B7           	or a
 558  8049 20 11        	jr nz,esp_check_open_type1
 559  804B 3E 54        	ld a,'T'
 560  804D 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 561  8050 3E 43        	ld a,'C'
 562  8052 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 563  8055 3E 50        	ld a,'P'
 564  8057 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 565  805A 18 2A        	jr esp_check_open_type_skip
 566  805C              esp_check_open_type1
 567  805C FE 01        	cp 1
 568  805E 20 11        	jr nz,esp_check_open_type2
 569  8060 3E 55        	ld a,'U'
 570  8062 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 571  8065 3E 44        	ld a,'D'
 572  8067 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 573  806A 3E 50        	ld a,'P'
 574  806C 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 575  806F 18 15        	jr esp_check_open_type_skip
 576  8071              esp_check_open_type2
 577  8071 FE 02        	cp 2
 578  8073 20 11        	jr nz,esp_check_open_type_skip
 579  8075 3E 53        	ld a,'S'
 580  8077 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 581  807A 3E 53        	ld a,'S'
 582  807C 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 583  807F 3E 4C        	ld a,'L'
 584  8081 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 585  8084 18 00        	jr esp_check_open_type_skip
 586  8086
 587  8086              esp_check_open_type_skip
 588  8086 11 BB 34     	ld de,esp_link_id_table+59 ;номер порта
 589  8089 21 8F 34     	ld hl,esp_link_id_table+15 ;;адрес сервера
 590  808C CD DD 82     	call Wifi.openTCP
 591  808F 30 04        	jr nc,esp_check_open_res
 592  8091 3E FF        	ld a,255 ;ошибка
 593  8093 18 05        	jr esp_check_open_err
 594  8095              esp_check_open_res
 595  8095              	;результат запишем
 596  8095 3A 3A 82     	ld a,(Wifi.closed)
 597  8098 EE 01        	xor 1
 598  809A              esp_check_open_err
 599  809A DD 77 02     	ld (ix+2),a ;поставить флаг результата открытия
 600  809D DD 36 01 00  	ld (ix+1),0 ;сбросить флаг запроса
 601  80A1 C9           	ret
 602  80A2
 603  80A2
 604  80A2
 605  80A2
 606  80A2
 607  80A2              esp_check_send ;проверить пакеты на отправку
 608  80A2 DD 21 80 34  	ld ix,esp_link_id_table ;
 609  80A6 DD 7E 03     	ld a,(ix+3)
 610  80A9 B7           	or a ;запрос есть?
 611  80AA C8           	ret z
 612  80AB              	;есть запрос
 613  80AB DD 5E 09     	ld e,(ix+9) ;длина данных
 614  80AE DD 56 0A     	ld d,(ix+10)
 615  80B1 21 2D 35     	ld hl,esp_buffer ;адрес
 616  80B4 CD 9E 83     	call Wifi.tcpSend
 617  80B7 3E 01        	ld a,1 ;успех
 618  80B9 30 02        	jr nc,esp_check_send_res
 619  80BB 3E FF        	ld a,255 ;ошибка
 620  80BD              esp_check_send_res
 621  80BD DD 77 04     	ld (ix+4),a ;поставить флаг результата отправки
 622  80C0 DD 36 03 00  	ld (ix+3),0 ;сбросить флаг запроса
 623  80C4 C9           	ret
 624  80C5
 625  80C5
 626  80C5
 627  80C5
 628  80C5
 629  80C5              esp_check_get ;проверить пакеты на приём
 630  80C5 DD 21 80 34  	ld ix,esp_link_id_table ;
 631  80C9 DD 7E 05     	ld a,(ix+5)
 632  80CC B7           	or a ;запрос есть?
 633  80CD C8           	ret z
 634  80CE              	;есть запрос
 635  80CE 21 00 00     	ld hl,0
 636  80D1 22 36 82     	ld (Wifi.bytes_avail), hl ;длину сбросим
 637  80D4 21 2D 35     	ld hl,esp_buffer ;адрес
 638  80D7 22 38 82     	ld (Wifi.buffer_pointer),hl ;
 639  80DA CD E0 83     	call Wifi.getPacket
 640  80DD 30 0A        	jr nc,esp_check_get_res
 641  80DF 3E FF        	ld a,255 ;ошибка
 642  80E1 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 643  80E4 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 644  80E8 C9           	ret
 645  80E9              esp_check_get_res
 646  80E9              	;если что-то принято
 647  80E9 ED 4B 36 82  	ld bc,(Wifi.bytes_avail) ;длина
 648  80ED DD 71 09     	ld (ix+9),c ;длина принятых
 649  80F0 DD 70 0A     	ld (ix+10),b
 650  80F3
 651  80F3 78           	ld a,b
 652  80F4 B1           	or c
 653  80F5 28 0F        	jr z,esp_check_get_skip_copy2 ;защита от нулевой длины
 654  80F7
 655  80F7 DD 5E 07     	ld e,(ix+7) ;адрес назначения
 656  80FA DD 56 08     	ld d,(ix+8)
 657  80FD DD 7E 00     	ld a,(ix) ;id назначения
 658  8100 21 2D 35     	ld hl,esp_buffer ;откуда
 659  8103 CD C7 05     	call esp_buffer_copy ;перекинем данные силами ядра
 660  8106
 661  8106              esp_check_get_skip_copy2
 662  8106 DD 21 80 34  	ld ix,esp_link_id_table ;
 663  810A 3A 3A 82     	ld a,(Wifi.closed)
 664  810D EE 01        	xor 1
 665  810F DD 77 02     	ld (ix+2),a ;поставить текущий флаг открытия
 666  8112 3E 01        	ld a,1 ;успех
 667  8114 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 668  8117 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 669  811B C9           	ret
 670  811C
 671  811C
 672  811C              print_esp_link
 673  811C 26 0B        	ld h,#0b
 674  811E 3E 20        	ld a," "
 675  8120              	OS_FILL_LINE ;почистить строку
 675  8120 0E 03       >    ld c,#03
 675  8122 E7          >    rst #20
 676  8123 DD 21 80 34  	ld ix,esp_link_id_table
 677  8127
 678  8127 11 00 0B     	ld de,#0b00 ;координаты yx
 679  812A              	OS_SET_XY
 679  812A 0E 01       >    ld c,#01
 679  812C E7          >    rst #20
 680  812D 21 00 85     	ld hl,msg_esp_link
 681  8130              	OS_PRINTZ
 681  8130 0E 09       >    ld c,#09
 681  8132 E7          >    rst #20
 682  8133 DD 7E 00     	ld a,(ix)
 683  8136 C6 30        	add '0'
 684  8138              	OS_PRINT_CHARF ;id
 684  8138 D7          >	rst #10
 685  8139 3E 20        	ld a," "
 686  813B              	OS_PRINT_CHARF
 686  813B D7          >	rst #10
 687  813C
 688  813C DD 7E 00     	ld a,(ix)
 689  813F B7           	or a
 690  8140 C8           	ret z ;если нет соединений
 691  8141
 692  8141 21 09 85     	ld hl,msg_esp_transmit
 693  8144              	OS_PRINTZ
 693  8144 0E 09       >    ld c,#09
 693  8146 E7          >    rst #20
 694  8147 DD 7E 04     	ld a,(ix+4)
 695  814A B7           	or a
 696  814B 28 1C        	jr z,print_esp_link2
 697  814D DD 7E 05     	ld a,(ix+5) ;при этом не начался приём
 698  8150 4F           	ld c,a
 699  8151 DD 7E 06     	ld a,(ix+6)
 700  8154 B1           	or c
 701  8155 20 12        	jr nz,print_esp_link2
 702  8157 DD 6E 09     	ld l,(ix+9)
 703  815A DD 66 0A     	ld h,(ix+10)
 704  815D CD F0 05     	call toDecimal
 705  8160 21 46 06     	ld hl,decimalS
 706  8163              	OS_PRINTZ	;отправлено
 706  8163 0E 09       >    ld c,#09
 706  8165 E7          >    rst #20
 707  8166 3E 20        	ld a," "
 708  8168              	OS_PRINT_CHARF
 708  8168 D7          >	rst #10
 709  8169              print_esp_link2
 710  8169
 711  8169 21 0F 85     	ld hl,msg_esp_receive
 712  816C              	OS_PRINTZ
 712  816C 0E 09       >    ld c,#09
 712  816E E7          >    rst #20
 713  816F DD 7E 06     	ld a,(ix+6)
 714  8172 B7           	or a
 715  8173 28 12        	jr z,print_esp_link3
 716  8175 DD 6E 09     	ld l,(ix+9)
 717  8178 DD 66 0A     	ld h,(ix+10)
 718  817B CD F0 05     	call toDecimal
 719  817E 21 46 06     	ld hl,decimalS
 720  8181              	OS_PRINTZ	;принято
 720  8181 0E 09       >    ld c,#09
 720  8183 E7          >    rst #20
 721  8184 3E 20        	ld a," "
 722  8186              	OS_PRINT_CHARF
 722  8186 D7          >	rst #10
 723  8187              print_esp_link3
 724  8187
 725  8187 21 15 85     	ld hl,msg_esp_address
 726  818A              	OS_PRINTZ
 726  818A 0E 09       >    ld c,#09
 726  818C E7          >    rst #20
 727  818D DD 7E 02     	ld a,(ix+2) ;соединение установлено
 728  8190 B7           	or a
 729  8191 28 06        	jr z,print_esp_link4
 730  8193 21 8F 34     	ld hl,esp_link_id_table+15 ;сервер
 731  8196              	OS_PRINTZ
 731  8196 0E 09       >    ld c,#09
 731  8198 E7          >    rst #20
 732  8199              print_esp_link4
 733  8199 C9           	ret
 734  819A
 735  819A
 736  819A
 737  819A
 738  819A              print_active_net ;значёк активности
 739  819A 11 00 0A     	ld de,#0a00 ;координаты yx
 740  819D              	OS_SET_XY
 740  819D 0E 01       >    ld c,#01
 740  819F E7          >    rst #20
 741  81A0 21 BC 81     	ld hl,msg_active_net
 742  81A3              	OS_PRINTZ
 742  81A3 0E 09       >    ld c,#09
 742  81A5 E7          >    rst #20
 743  81A6 3A C9 81     	ld a,(msg_active_net_cur)
 744  81A9 3C           	inc a
 745  81AA FE 04        	cp 4
 746  81AC 38 01        	jr c,print_active_net1
 747  81AE AF           	xor a
 748  81AF              print_active_net1
 749  81AF 32 C9 81     	ld (msg_active_net_cur),a
 750  81B2 4F           	ld c,a
 751  81B3 06 00        	ld b,0
 752  81B5 21 C4 81     	ld hl,msg_active_net1
 753  81B8 09           	add hl,bc
 754  81B9 7E           	ld a,(hl)
 755  81BA              	OS_PRINT_CHARF
 755  81BA D7          >	rst #10
 756  81BB C9           	ret
 757  81BC
 758  81BC
 759  81BC
 760  81BC
 761  81BC
 762  81BC
 763  81BC 41 63 74 69  msg_active_net db "Active ",0
 763  81C0 76 65 20 00
 764  81C4 7C 2F 2D 5C  msg_active_net1 db "|/-\\",0
 764  81C8 00
 765  81C9 00           msg_active_net_cur db 0 ;текущий значёк активности
 766  81CA
 767  81CA              	include Drv/zx-wifi.asm ;драйвер сетевой карты ESP
# file opened: Drv/zx-wifi.asm
   1+ 81CA              ; This driver works with 16c550 uart that's support AFE
   2+ 81CA                  module Uart
   3+ 81CA              ; Make init shorter and readable:-)
   4+ 81CA                  macro outp port, value
   5+ 81CA ~            	ld b, port
   6+ 81CA ~            	ld c, #EF
   7+ 81CA ~                ld a, value
   8+ 81CA ~                out (c), a
   9+ 81CA                  endm
  10+ 81CA
  11+ 81CA              ; Internal port constants
  12+ 81CA              RBR_THR = #F8
  13+ 81CA              IER     = RBR_THR + 1
  14+ 81CA              IIR_FCR = RBR_THR + 2
  15+ 81CA              LCR     = RBR_THR + 3
  16+ 81CA              MCR     = RBR_THR + 4
  17+ 81CA              LSR     = RBR_THR + 5
  18+ 81CA              MSR     = RBR_THR + 6
  19+ 81CA              SR      = RBR_THR + 7
  20+ 81CA
  21+ 81CA
  22+ 81CA              ;out: a=255 - no UART
  23+ 81CA              check: ;проверка есть ли карта
  24+ 81CA 3E F8        	ld a, RBR_THR
  25+ 81CC DB FE            in a, (#fe)
  26+ 81CE FE FF        	cp #ff
  27+ 81D0 C0           	ret nz ;если читает 255, то нет карты
  28+ 81D1 3E F8        	ld a, RBR_THR
  29+ 81D3 DB FE            in a, (#fe) ;второй раз для надёжности
  30+ 81D5 FE FF        	cp #ff
  31+ 81D7 C9           	ret
  32+ 81D8
  33+ 81D8
  34+ 81D8              init:
  35+ 81D8                  outp MCR,     #0d  // Assert RTS
  35+ 81D8 06 FC       >	ld b, MCR
  35+ 81DA 0E EF       >	ld c, #EF
  35+ 81DC 3E 0D       >    ld a, #0d
  35+ 81DE ED 79       >    out (c), a
  36+ 81E0                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  36+ 81E0 06 FA       >	ld b, IIR_FCR
  36+ 81E2 0E EF       >	ld c, #EF
  36+ 81E4 3E 87       >    ld a, #87
  36+ 81E6 ED 79       >    out (c), a
  37+ 81E8                  outp LCR,     #83  // 8n1, DLAB=1
  37+ 81E8 06 FB       >	ld b, LCR
  37+ 81EA 0E EF       >	ld c, #EF
  37+ 81EC 3E 83       >    ld a, #83
  37+ 81EE ED 79       >    out (c), a
  38+ 81F0                  outp RBR_THR, #01  // 115200 (divider 1)
  38+ 81F0 06 F8       >	ld b, RBR_THR
  38+ 81F2 0E EF       >	ld c, #EF
  38+ 81F4 3E 01       >    ld a, #01
  38+ 81F6 ED 79       >    out (c), a
  39+ 81F8                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  39+ 81F8 06 F9       >	ld b, IER
  39+ 81FA 0E EF       >	ld c, #EF
  39+ 81FC 3E 00       >    ld a, #00
  39+ 81FE ED 79       >    out (c), a
  40+ 8200
  41+ 8200                  outp LCR,     #03 // 8n1, DLAB=0
  41+ 8200 06 FB       >	ld b, LCR
  41+ 8202 0E EF       >	ld c, #EF
  41+ 8204 3E 03       >    ld a, #03
  41+ 8206 ED 79       >    out (c), a
  42+ 8208                  outp IER,     #00 // Disable int
  42+ 8208 06 F9       >	ld b, IER
  42+ 820A 0E EF       >	ld c, #EF
  42+ 820C 3E 00       >    ld a, #00
  42+ 820E ED 79       >    out (c), a
  43+ 8210                  outp MCR,     #2f // Enable AFE
  43+ 8210 06 FC       >	ld b, MCR
  43+ 8212 0E EF       >	ld c, #EF
  43+ 8214 3E 2F       >    ld a, #2f
  43+ 8216 ED 79       >    out (c), a
  44+ 8218 C9               ret
  45+ 8219
  46+ 8219              ;retry_rec_count_max equ %00011111 ;ждать столько прерываний
  47+ 8219
  48+ 8219              ; Flag C <- Data available
  49+ 8219              ; isAvailable:
  50+ 8219                  ; ld a, LSR
  51+ 8219                  ; in a, (#EF)
  52+ 8219                  ; rrca
  53+ 8219                  ; ret
  54+ 8219
  55+ 8219              ; Non-blocking read
  56+ 8219              ; Flag C <- is byte was readen
  57+ 8219              ; A <- byte
  58+ 8219              ; read1:
  59+ 8219                  ; ld a, LSR
  60+ 8219                  ; in a, (#EF)
  61+ 8219                  ; rrca
  62+ 8219                  ; ret nc
  63+ 8219                  ; ld a, RBR_THR
  64+ 8219                  ; in a, (#EF)
  65+ 8219                  ; scf
  66+ 8219                  ; ret
  67+ 8219
  68+ 8219              ; Tries read byte with timeout
  69+ 8219              ; Flag C <- is byte read
  70+ 8219              ; A <- byte
  71+ 8219              read:
  72+ 8219              	;xor a ;4
  73+ 8219              	;ld (#5C78),a ;обнулить счётчик ожидания ;13
  74+ 8219              .wait
  75+ 8219 3E FD            ld a, LSR
  76+ 821B DB EF            in a, (#EF)
  77+ 821D 0F               rrca
  78+ 821E 30 F9        	jr nc, .wait
  79+ 8220 3E F8            ld a, RBR_THR
  80+ 8222 DB EF            in a, (#EF)
  81+ 8224 C9           	ret
  82+ 8225              ; .readW
  83+ 8225              	; OS_GETTIMER
  84+ 8225              	; ld a,e
  85+ 8225              	; and retry_rec_count_max
  86+ 8225              	; ;ld a,(#5C78)
  87+ 8225              	; ;cp retry_rec_count_max
  88+ 8225              	; jr nz, .wait ;ещё попытка
  89+ 8225              	; xor a ;выключим флаг переноса если время вышло
  90+ 8225              	; ret
  91+ 8225
  92+ 8225
  93+ 8225
  94+ 8225
  95+ 8225              ; Blocking read
  96+ 8225              ; A <- Byte
  97+ 8225              ; readB:
  98+ 8225                  ; ld a, LSR
  99+ 8225                  ; in a, (#EF)
 100+ 8225                  ; rrca
 101+ 8225                  ; jr nc, readB
 102+ 8225              	; ld a, RBR_THR
 103+ 8225                  ; in a, (#EF)
 104+ 8225                  ; ret
 105+ 8225
 106+ 8225              ; A -> byte to send
 107+ 8225              write:
 108+ 8225 F5               push af
 109+ 8226              .wait
 110+ 8226 3E FD        	ld a, LSR
 111+ 8228 DB EF            in a, (#EF)
 112+ 822A E6 20            and #20
 113+ 822C 28 F8            jr z, .wait
 114+ 822E F1               pop af
 115+ 822F 06 F8        	ld b, RBR_THR
 116+ 8231 0E EF        	ld c, #EF
 117+ 8233 ED 79            out (c), a
 118+ 8235 C9               ret
 119+ 8236
 120+ 8236                  endmodule
# file closed: Drv/zx-wifi.asm
 768  8236              	include Drv/wifi.asm ;работа с ESP
# file opened: Drv/wifi.asm
   1+ 8236                  MODULE Wifi
   2+ 8236 00 00        bytes_avail dw 0 ;байт для приёма
   3+ 8238 00 00        buffer_pointer dw 0 ;указатель на адрес буфера
   4+ 823A 01           closed db 1 ;флаг "соединение закрыто"
   5+ 823B              ;link_id db 0 ;текущий id соединения
   6+ 823B              buffer_end equ #40 ;ограничение буфера адрес #4000
   7+ 823B
   8+ 823B              ; Initialize Wifi chip to work
   9+ 823B              init:
  10+ 823B 21 B4 82         ld hl, .uartIniting
  10+ 823E CD D1 09       call drvgmx.printZ
  11+ 8241 CD D8 81         call Uart.init ;
  12+ 8244 21 C5 82         ld hl, .chipIniting
  12+ 8247 CD D1 09       call drvgmx.printZ
  13+ 824A                  ;EspCmdOkErr "ATE0"
  14+ 824A 21 94 84     	ld hl,cmd_ATE0
  15+ 824D CD 83 83     	call espSendZ
  16+ 8250 CD 1C 83     	call checkOkErr
  17+ 8253 38 3F            jr c, .initError
  18+ 8255
  19+ 8255                  ;EspCmdOkErr "AT+CIPSERVER=0"
  20+ 8255 21 9B 84     	ld hl,cmd_CIPSERVER
  21+ 8258 CD 83 83     	call espSendZ
  22+ 825B CD 1C 83     	call checkOkErr
  23+ 825E                  ;jr c, .initError ;не проверяем ошибку
  24+ 825E                  ;EspCmdOkErr "AT+CIPCLOSE" ;  Close if there some connection was. Don't care about result
  25+ 825E 21 CC 84     	ld hl,cmd_CIPCLOSE
  26+ 8261 CD 83 83     	call espSendZ
  27+ 8264 3E 35        	ld a,'5' ;закрыть все соединения
  28+ 8266 CD 25 82     	call Uart.write
  29+ 8269 3E 0D            ld a, 13
  29+ 826B CD 25 82       call Uart.write
  30+ 826E 3E 0A            ld a, 10
  30+ 8270 CD 25 82       call Uart.write
  31+ 8273 CD 1C 83     	call checkOkErr
  32+ 8276                  ;jr c, .initError ;не проверяем ошибку
  33+ 8276                  ;EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  34+ 8276 21 D8 84     	ld hl,cmd_CIPMUX
  35+ 8279 CD 83 83     	call espSendZ
  36+ 827C CD 1C 83     	call checkOkErr
  37+ 827F 38 13            jr c, .initError
  38+ 8281
  39+ 8281                  ;EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  40+ 8281 21 E6 84     	ld hl,cmd_CIPDINFO
  41+ 8284 CD 83 83     	call espSendZ
  42+ 8287 CD 1C 83     	call checkOkErr
  43+ 828A 38 08            jr c, .initError
  44+ 828C
  45+ 828C 21 D6 82         ld hl, .doneInit
  45+ 828F CD D1 09       call drvgmx.printZ
  46+ 8292
  47+ 8292 B7               or a
  48+ 8293 C9               ret
  49+ 8294              .initError
  50+ 8294 21 9C 82         ld hl, .errMsg
  50+ 8297 CD D1 09       call drvgmx.printZ
  51+ 829A 37               scf
  52+ 829B C9               ret
  53+ 829C 57 69 46 69  .errMsg db "WiFi chip init failed!",13,0
  53+ 82A0 20 63 68 69
  53+ 82A4 70 20 69 6E
  53+ 82A8 69 74 20 66
  53+ 82AC 61 69 6C 65
  53+ 82B0 64 21 0D 00
  54+ 82B4 55 61 72 74  .uartIniting db "Uart initing...",13,0
  54+ 82B8 20 69 6E 69
  54+ 82BC 74 69 6E 67
  54+ 82C0 2E 2E 2E 0D
  54+ 82C4 00
  55+ 82C5 43 68 69 70  .chipIniting db "Chip initing...",13,0
  55+ 82C9 20 69 6E 69
  55+ 82CD 74 69 6E 67
  55+ 82D1 2E 2E 2E 0D
  55+ 82D5 00
  56+ 82D6 44 6F 6E 65  .doneInit    db "Done!",13,0
  56+ 82DA 21 0D 00
  57+ 82DD                  IFNDEF PROXY
  58+ 82DD              ; HL - host pointer in gopher row
  59+ 82DD              ; DE - port pointer in gopher row
  60+ 82DD              openTCP:
  61+ 82DD D5               push de
  62+ 82DE E5               push hl
  63+ 82DF                  ;EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  64+ 82DF 21 CC 84     	ld hl,cmd_CIPCLOSE
  65+ 82E2 CD 83 83     	call espSendZ
  66+ 82E5              	; ld a,(link_id)
  67+ 82E5              	; call Uart.write
  68+ 82E5 3E 0D            ld a, 13
  68+ 82E7 CD 25 82       call Uart.write
  69+ 82EA 3E 0A            ld a, 10
  69+ 82EC CD 25 82       call Uart.write
  70+ 82EF CD 1C 83     	call checkOkErr
  71+ 82F2
  72+ 82F2                  ;EspSend 'AT+CIPSTART,"TCP","' ;
  73+ 82F2 21 AC 84     	ld hl,cmd_CIPSTART
  74+ 82F5 CD 83 83     	call espSendZ
  75+ 82F8              	; ld a,(link_id)
  76+ 82F8              	; call Uart.write
  77+ 82F8              	; ld hl,cmd_CIPSTART2
  78+ 82F8              	; call espSendZ
  79+ 82F8
  80+ 82F8
  81+ 82F8 E1               pop hl
  82+ 82F9 CD 8C 83         call espSendT
  83+ 82FC                  ;EspSend '",'
  84+ 82FC 3E 22            ld a, '"'
  84+ 82FE CD 25 82       call Uart.write
  85+ 8301 3E 2C            ld a, ','
  85+ 8303 CD 25 82       call Uart.write
  86+ 8306 E1               pop hl
  87+ 8307 CD 8C 83         call espSendT
  88+ 830A 3E 0D            ld a, 13
  88+ 830C CD 25 82       call Uart.write
  89+ 830F 3E 0A            ld a, 10
  89+ 8311 CD 25 82       call Uart.write
  90+ 8314 AF               xor a
  90+ 8315 32 3A 82       ld (closed), a
  91+ 8318 C3 1C 83         jp checkOkErr
  92+ 831B
  93+ 831B              continue:
  94+ 831B C9               ret
  95+ 831C                  ENDIF
  96+ 831C
  97+ 831C
  98+ 831C
  99+ 831C              checkOkErr:
 100+ 831C CD 19 82         call Uart.read
 101+ 831F FE 4F            cp 'O'
 101+ 8321 28 0A          jr z, .okStart ; OK
 102+ 8323 FE 45            cp 'E'
 102+ 8325 28 19          jr z, .errStart ; ERROR
 103+ 8327 FE 46            cp 'F'
 103+ 8329 28 36          jr z, .failStart ; FAIL
 104+ 832B 18 EF            jr checkOkErr
 105+ 832D              .okStart
 106+ 832D CD 19 82         call Uart.read
 106+ 8330 FE 4B          cp 'K'
 106+ 8332 20 E8          jr nz, checkOkErr
 107+ 8334 CD 19 82         call Uart.read
 107+ 8337 FE 0D          cp 13
 107+ 8339 20 E1          jr nz, checkOkErr
 108+ 833B CD 7B 83         call .flushToLF
 109+ 833E B7               or a
 110+ 833F C9               ret
 111+ 8340              .errStart
 112+ 8340 CD 19 82         call Uart.read
 112+ 8343 FE 52          cp 'R'
 112+ 8345 20 D5          jr nz, checkOkErr
 113+ 8347 CD 19 82         call Uart.read
 113+ 834A FE 52          cp 'R'
 113+ 834C 20 CE          jr nz, checkOkErr
 114+ 834E CD 19 82         call Uart.read
 114+ 8351 FE 4F          cp 'O'
 114+ 8353 20 C7          jr nz, checkOkErr
 115+ 8355 CD 19 82         call Uart.read
 115+ 8358 FE 52          cp 'R'
 115+ 835A 20 C0          jr nz, checkOkErr
 116+ 835C CD 7B 83         call .flushToLF
 117+ 835F 37               scf
 118+ 8360 C9               ret
 119+ 8361              .failStart
 120+ 8361 CD 19 82         call Uart.read
 120+ 8364 FE 41          cp 'A'
 120+ 8366 20 B4          jr nz, checkOkErr
 121+ 8368 CD 19 82         call Uart.read
 121+ 836B FE 49          cp 'I'
 121+ 836D 20 AD          jr nz, checkOkErr
 122+ 836F CD 19 82         call Uart.read
 122+ 8372 FE 4C          cp 'L'
 122+ 8374 20 A6          jr nz, checkOkErr
 123+ 8376 CD 7B 83         call .flushToLF
 124+ 8379 37               scf
 125+ 837A C9               ret
 126+ 837B              .flushToLF
 127+ 837B CD 19 82         call Uart.read
 128+ 837E FE 0A            cp 10
 128+ 8380 20 F9          jr nz, .flushToLF
 129+ 8382 C9               ret
 130+ 8383
 131+ 8383              ; Send buffer to UART
 132+ 8383              ; HL - buff
 133+ 8383              ; E - count
 134+ 8383              ; espSend:
 135+ 8383                  ; ld a, (hl) : call Uart.write
 136+ 8383                  ; inc hl
 137+ 8383                  ; dec e
 138+ 8383                  ; jr nz, espSend
 139+ 8383                  ; ret
 140+ 8383
 141+ 8383              ; Send buffer to UART
 142+ 8383              ; HL - buff (0 - end!)
 143+ 8383              espSendZ:
 144+ 8383 7E               ld a, (hl)
 145+ 8384 B7           	or a
 146+ 8385 C8           	ret z
 147+ 8386 CD 25 82     	call Uart.write
 148+ 8389 23               inc hl
 149+ 838A 18 F7            jr espSendZ
 150+ 838C
 151+ 838C
 152+ 838C              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 153+ 838C              espSendT:
 154+ 838C 7E               ld a, (hl)
 155+ 838D
 156+ 838D A7               and a
 156+ 838E C8             ret z
 157+ 838F FE 09            cp 9
 157+ 8391 C8             ret z
 158+ 8392 FE 0D            cp 13
 158+ 8394 C8             ret z
 159+ 8395 FE 0A            cp 10
 159+ 8397 C8             ret z
 160+ 8398
 161+ 8398 CD 25 82         call Uart.write
 162+ 839B 23               inc hl
 163+ 839C 18 EE            jr espSendT
 164+ 839E
 165+ 839E              ; HL - stringZ to send
 166+ 839E              ; Adds CR LF
 167+ 839E              ; tcpSendZ:
 168+ 839E                  ; push hl
 169+ 839E                  ; ;EspSend "AT+CIPSEND=" ;
 170+ 839E              	; ld hl,cmd_CIPSEND
 171+ 839E              	; call espSendZ
 172+ 839E              	; ; ld a,(link_id)
 173+ 839E              	; ; call Uart.write
 174+ 839E                  ; ;ld a, ',' : call Uart.write
 175+ 839E
 176+ 839E                  ; pop de : push de
 177+ 839E                  ; call strLen
 178+ 839E                  ; inc hl : inc hl ; +CRLF
 179+ 839E                  ; call hlToNumEsp
 180+ 839E                  ; ld a, 13 : call Uart.write
 181+ 839E                  ; ld a, 10 : call Uart.write
 182+ 839E                  ; call checkOkErr : jr c,.exit_err
 183+ 839E              ; .wait
 184+ 839E                  ; call Uart.read : cp '>' : jr nz, .wait
 185+ 839E                  ; pop hl
 186+ 839E              ; .loop
 187+ 839E                  ; ld a, (hl) : and a : jr z, .exit
 188+ 839E                  ; call Uart.write
 189+ 839E                  ; inc hl
 190+ 839E                  ; jp .loop
 191+ 839E              ; .exit
 192+ 839E                  ; ld a, 13 : call Uart.write
 193+ 839E                  ; ld a, 10 : call Uart.write
 194+ 839E                  ; jp checkOkErr
 195+ 839E              ; .exit_err
 196+ 839E              	; pop hl
 197+ 839E              	; ret
 198+ 839E
 199+ 839E
 200+ 839E
 201+ 839E              ; HL - string to send
 202+ 839E              ; DE - lenght
 203+ 839E              ; Adds CR LF
 204+ 839E              tcpSend:
 205+ 839E E5               push hl
 206+ 839F D5           	push de ;
 207+ 83A0                  ;EspSend "AT+CIPSEND=" ;
 208+ 83A0 21 C0 84     	ld hl,cmd_CIPSEND
 209+ 83A3 CD 83 83     	call espSendZ
 210+ 83A6              	; ld a,(link_id)
 211+ 83A6              	; call Uart.write
 212+ 83A6                  ;ld a, ',' : call Uart.write
 213+ 83A6
 214+ 83A6 E1               pop hl
 214+ 83A7 E5             push hl ;длина
 215+ 83A8                  ;call strLen
 216+ 83A8 23               inc hl
 216+ 83A9 23             inc hl ; +CRLF
 217+ 83AA CD 6D 84         call hlToNumEsp
 218+ 83AD 3E 0D            ld a, 13
 218+ 83AF CD 25 82       call Uart.write
 219+ 83B2 3E 0A            ld a, 10
 219+ 83B4 CD 25 82       call Uart.write
 220+ 83B7 CD 1C 83         call checkOkErr
 220+ 83BA 38 21          jr c,.exit_err2
 221+ 83BC              .wait2
 222+ 83BC CD 19 82         call Uart.read
 222+ 83BF FE 3E          cp '>'
 222+ 83C1 20 F9          jr nz, .wait2
 223+ 83C3 D1           	pop de ;длина
 224+ 83C4 E1               pop hl
 225+ 83C5              .loop2
 226+ 83C5 7E               ld a, (hl)
 227+ 83C6 CD 25 82         call Uart.write
 228+ 83C9 23               inc hl
 229+ 83CA 1B           	dec de
 230+ 83CB 7A           	ld a,d
 231+ 83CC B3           	or e
 232+ 83CD C2 C5 83         jp nz, .loop2
 233+ 83D0              .exit2
 234+ 83D0 3E 0D            ld a, 13
 234+ 83D2 CD 25 82       call Uart.write
 235+ 83D5 3E 0A            ld a, 10
 235+ 83D7 CD 25 82       call Uart.write
 236+ 83DA C3 1C 83         jp checkOkErr
 237+ 83DD              .exit_err2
 238+ 83DD D1           	pop de
 239+ 83DE E1           	pop hl
 240+ 83DF C9           	ret
 241+ 83E0
 242+ 83E0
 243+ 83E0
 244+ 83E0
 245+ 83E0              getPacket:
 246+ 83E0 CD 19 82         call Uart.read
 247+ 83E3 FE 2B            cp '+'
 247+ 83E5 28 28          jr z, .ipdBegun    ; "+IPD," packet
 248+ 83E7 FE 4F            cp 'O'
 248+ 83E9 28 02          jr z, .closedBegun ; It enough to check "OSED\n" :-)
 249+ 83EB 18 F3            jr getPacket
 250+ 83ED              .closedBegun
 251+ 83ED CD 19 82         call Uart.read
 251+ 83F0 FE 53          cp 'S'
 251+ 83F2 20 EC          jr nz, getPacket
 252+ 83F4 CD 19 82         call Uart.read
 252+ 83F7 FE 45          cp 'E'
 252+ 83F9 20 E5          jr nz, getPacket
 253+ 83FB CD 19 82         call Uart.read
 253+ 83FE FE 44          cp 'D'
 253+ 8400 20 DE          jr nz, getPacket
 254+ 8402 CD 19 82         call Uart.read
 254+ 8405 FE 0D          cp 13
 254+ 8407 20 D7          jr nz, getPacket
 255+ 8409 3E 01 32 3A      ld a, 1, (closed), a
 255+ 840D 82
 256+ 840E C9               ret
 257+ 840F              .ipdBegun
 258+ 840F CD 19 82         call Uart.read
 258+ 8412 FE 49          cp 'I'
 258+ 8414 20 CA          jr nz, getPacket
 259+ 8416 CD 19 82         call Uart.read
 259+ 8419 FE 50          cp 'P'
 259+ 841B 20 C3          jr nz, getPacket
 260+ 841D CD 19 82         call Uart.read
 260+ 8420 FE 44          cp 'D'
 260+ 8422 20 BC          jr nz, getPacket
 261+ 8424 CD 19 82         call Uart.read ; Comma
 262+ 8427              	; call Uart.read ; link ID
 263+ 8427              	; ld (link_id),a ;запомнить
 264+ 8427              	;call Uart.read ; Comma
 265+ 8427 CD 54 84         call .count_ipd_lenght
 265+ 842A 22 36 82       ld (bytes_avail), hl
 266+ 842D 44 4D            ld bc, hl
 267+ 842F 2A 38 82         ld hl, (buffer_pointer)
 268+ 8432              .readp
 269+ 8432 7C               ld a, h
 269+ 8433 FE 40          cp buffer_end
 269+ 8435 30 12          jr nc, .skipbuff ;
 270+ 8437 C5 E5            push bc, hl
 271+ 8439 CD 19 82         call Uart.read
 272+ 843C E1 C1            pop hl, bc
 273+ 843E 77               ld (hl), a
 274+ 843F 0B               dec bc
 274+ 8440 23             inc hl
 275+ 8441 78               ld a, b
 275+ 8442 B1             or c
 275+ 8443 20 ED          jr nz, .readp
 276+ 8445 22 38 82         ld (buffer_pointer), hl
 277+ 8448 C9               ret
 278+ 8449              .skipbuff
 279+ 8449 C5               push bc
 280+ 844A CD 19 82         call Uart.read
 281+ 844D C1               pop bc
 282+ 844E 0B               dec bc
 282+ 844F 78             ld a, b
 282+ 8450 B1             or c
 282+ 8451 20 F6          jr nz, .skipbuff
 283+ 8453 C9               ret
 284+ 8454              .count_ipd_lenght
 285+ 8454 21 00 00     		ld hl,0			; count lenght
 286+ 8457 E5           .cil1	push  hl
 287+ 8458 CD 19 82             call Uart.read
 288+ 845B E1                   pop hl
 289+ 845C FE 3A        		cp ':'
 289+ 845E C8             ret z
 290+ 845F D6 30        		sub 0x30
 290+ 8461 4D             ld c,l
 290+ 8462 44             ld b,h
 290+ 8463 29             add hl,hl
 290+ 8464 29             add hl,hl
 290+ 8465 09             add hl,bc
 290+ 8466 29             add hl,hl
 290+ 8467 4F             ld c,a
 290+ 8468 06 00          ld b,0
 290+ 846A 09             add hl,bc
 291+ 846B 18 EA        		jr .cil1
 292+ 846D
 293+ 846D              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 294+ 846D              ; HL - number
 295+ 846D              ; It will be written to UART
 296+ 846D              hlToNumEsp:
 297+ 846D 01 F0 D8     	ld	bc,-10000
 298+ 8470 CD 86 84     	call	.n1
 299+ 8473 01 18 FC     	ld	bc,-1000
 300+ 8476 CD 86 84     	call	.n1
 301+ 8479 01 9C FF     	ld	bc,-100
 302+ 847C CD 86 84     	call	.n1
 303+ 847F 0E F6        	ld	c,-10
 304+ 8481 CD 86 84     	call	.n1
 305+ 8484 0E FF        	ld	c,-1
 306+ 8486 3E 2F        .n1	ld	a,'0'-1
 307+ 8488 3C           .n2	inc	a
 308+ 8489 09           	add	hl,bc
 309+ 848A 38 FC        	jr	c, .n2
 310+ 848C ED 42        	sbc	hl,bc
 311+ 848E C5               push bc
 312+ 848F CD 25 82     	call Uart.write
 313+ 8492 C1               pop bc
 314+ 8493 C9               ret
 315+ 8494
 316+ 8494
 317+ 8494              ;команды
 318+ 8494 41 54 45 30  cmd_ATE0 db "ATE0",13,10,0 ;эхо?
 318+ 8498 0D 0A 00
 319+ 849B 41 54 2B 43  cmd_CIPSERVER db "AT+CIPSERVER=0",13,10,0 ;удалить сервер
 319+ 849F 49 50 53 45
 319+ 84A3 52 56 45 52
 319+ 84A7 3D 30 0D 0A
 319+ 84AB 00
 320+ 84AC 41 54 2B 43  cmd_CIPSTART db 'AT+CIPSTART="' ;продолжение
 320+ 84B0 49 50 53 54
 320+ 84B4 41 52 54 3D
 320+ 84B8 22
 321+ 84B9              	;тут тип
 322+ 84B9 54 43 50 22  cmd_CIPSTART2 db 'TCP","',0 ;продолжение
 322+ 84BD 2C 22 00
 323+ 84C0 41 54 2B 43  cmd_CIPSEND db "AT+CIPSEND=",0 ;отправить данные
 323+ 84C4 49 50 53 45
 323+ 84C8 4E 44 3D 00
 324+ 84CC              	;тут ID
 325+ 84CC 41 54 2B 43  cmd_CIPCLOSE db "AT+CIPCLOSE",0 ;закрыть соединение
 325+ 84D0 49 50 43 4C
 325+ 84D4 4F 53 45 00
 326+ 84D8              	;тут ID
 327+ 84D8 41 54 2B 43  cmd_CIPMUX db "AT+CIPMUX=0",13,10,0 ; Single connection mode
 327+ 84DC 49 50 4D 55
 327+ 84E0 58 3D 30 0D
 327+ 84E4 0A 00
 328+ 84E6 41 54 2B 43  cmd_CIPDINFO db "AT+CIPDINFO=0",13,10,0 ; Disable additional info
 328+ 84EA 49 50 44 49
 328+ 84EE 4E 46 4F 3D
 328+ 84F2 30 0D 0A 00
 329+ 84F6
 330+ 84F6                  ENDMODULE
# file closed: Drv/wifi.asm
 769  84F6              	include Drv/utils.asm ;работа с ESP
# file opened: Drv/utils.asm
   1+ 84F6              ;;; Macroses!!!!
   2+ 84F6                  ; MACRO EspSend Text
   3+ 84F6                  ; ld hl, .txtB
   4+ 84F6                  ; ld e, (.txtE - .txtB)
   5+ 84F6                  ; call espSend
   6+ 84F6                  ; jr .txtE
   7+ 84F6              ; .txtB
   8+ 84F6                  ; db Text
   9+ 84F6              ; .txtE
  10+ 84F6                  ; ENDM
  11+ 84F6
  12+ 84F6                  ; MACRO EspCmd Text
  13+ 84F6                  ; ld hl, .txtB
  14+ 84F6                  ; ld e, (.txtE - .txtB)
  15+ 84F6                  ; call espSend
  16+ 84F6                  ; jr .txtE
  17+ 84F6              ; .txtB
  18+ 84F6                  ; db Text
  19+ 84F6                  ; db 13, 10
  20+ 84F6              ; .txtE
  21+ 84F6                  ; ENDM
  22+ 84F6
  23+ 84F6                  ; MACRO EspCmdOkErr text
  24+ 84F6                  ; EspCmd text
  25+ 84F6                  ; call checkOkErr
  26+ 84F6                  ; ENDM
  27+ 84F6
  28+ 84F6              ; IN DE - string pointer
  29+ 84F6              ; OUT HL - string len
  30+ 84F6              strLen:
  31+ 84F6 21 00 00         ld hl, 0
  32+ 84F9              .loop
  33+ 84F9 1A               ld a, (de)
  33+ 84FA A7             and a
  33+ 84FB C8             ret z
  34+ 84FC 13 23            inc de, hl
  35+ 84FE 18 F9            jr .loop
# file closed: Drv/utils.asm
 770  8500
 771  8500              msg_esp_link
 772  8500 45 53 50 20  	db "ESP id: ",0
 772  8504 69 64 3A 20
 772  8508 00
 773  8509              msg_esp_transmit
 774  8509 54 72 6E 3A  	db "Trn: ",0
 774  850D 20 00
 775  850F              msg_esp_receive
 776  850F 52 63 76 3A  	db "Rcv: ",0
 776  8513 20 00
 777  8515              msg_esp_address
 778  8515 41 64 72 3A  	db "Adr: ",0
 778  8519 20 00
 779  851B
 780  851B              msg_ver_net
 781  851B 4E 45 54 20  	db "NET ver 2025.01.14",13,10,0
 781  851F 76 65 72 20
 781  8523 32 30 32 35
 781  8527 2E 30 31 2E
 781  852B 31 34 0D 0A
 781  852F 00
 782  8530
 783  8530              end_net
 784  8530              	savebin "net.apg",start_net,$-start_net
 785  8530
 786  8530              ;------------------------------------------------------------------------
 787  8530
 788  8530
 789  8530
 790  8530
 791  8530
 792  8530
 793  8530
 794  8530
 795  8530
 796  8530
 797  8530
 798  8530
 799  8530
 800  8530
 801  8530
 802  8530
 803  8530
 804  8530
 805  8530
 806  8530              ;ядро системы
 807  8530              	org #0000
 808  0000              	;bank 0
 809  0000              start_os_main
 810  0000
 811  0000 C3 01 C1     x0000	jp	InitProgramm + #c000	;RST #00	;+#C000 после запуска меняется
 812  0003 00 00 00...  	ds	#08-3
 813  0008
 814  0008 18 31        x0008	jr	x003B			;обработка RST #08
 815  000A 00           	nop
 816  000B 00           x000B	nop
 817  000C 00           	nop
 818  000D 18 75        x000D	jr	ExitMon
 819  000F 00           	ds	#01
 820  0010
 821  0010 C3 DC 09     x0010	jp	drvgmx.putC  ;RST #10		;печать одного символа
 822  0013
 823  0013 ED 79        x0013	out	(c),a
 824  0015 00           	nop
 825  0016 00 00        	ds	#02
 826  0018
 827  0018 C3 4C 06     x0018	jp os_wait ;передача управления ОС ;RST #18
 828  001B 00 00 00...  		ds #05 ;ds	#08
 829  0020
 830  0020 C3 D7 06     x0020	jp function  ;RST #20
 831  0023 00 00 00...  		ds	#05 ;#08
 832  0028
 833  0028 00 00 00...  x0028	ds	#08 ;RST #28
 834  0030
 835  0030 00 00 00     x0030	ds	#03 ;RST #30
 836  0033
 837  0033 ED 79        x0033	out	(c),a
 838  0035 00           	nop
 839  0036
 840  0036 00 23        x0036	dw	font
 841  0038
 842  0038              ;обработчик прерываний
 843  0038 C3 50 07     x0038	jp	Interrupts ;#RST 38
 844  003B
 845  003B              ;обработка RST 8
 846  003B F5           x003B	push	af
 847  003C ED 5F        	ld	a,r
 848  003E EA 43 00     	jp	pe,x0043
 849  0041 ED 5F        	ld	a,r
 850  0043 F5           x0043	push	af
 851  0044 3E 10        	ld	a,#10			;вход из ram 0
 852  0046 F5           	push	af
 853  0047 33           	inc	sp
 854  0048 C5           	push	bc
 855  0049 E5           	push	hl
 856  004A 01 00 00     	ld	bc,#0000
 857  004D 3E 02        	ld	a,#02
 858  004F ED 79        	out	(c),a
 859  0051 01 FD 7E     	ld	bc,#7EFD
 860  0054 ED 60        	in	h,(c)			;h=in #7EFD
 861  0056 06 7A        	ld	b,#7A
 862  0058 ED 68        	in	l,(c)			;l=in #7AFD
 863  005A 06 1F        	ld	b,#1F
 864  005C 3E 12        	ld	a,#12
 865  005E 18 B3        	jr	x0013
 866  0060 00 00 00...  	ds	#06			;=#0060
 867  0066
 868  0066              ;обработка NMI
 869  0066              ;
 870  0066 F5           x0066   push  af
 871  0067 ED 5F           ld  a,r
 872  0069 F3              di
 873  006A F5              push  af
 874  006B 3E 20           ld  a,#20
 875  006D F5              push  af
 876  006E 33              inc  sp
 877  006F C5              push  bc
 878  0070 E5              push  hl
 879  0071 01 FD 7E        ld  bc,#7EFD
 880  0074 ED 60           in  h,(c)    ;h=in #7EFD
 881  0076 06 7A           ld  b,#7A
 882  0078 ED 68           in  l,(c)    ;l=in #7AFD
 883  007A 06 1F           ld  b,#1F    ;18 байт
 884  007C 3E 12           ld  a,#12
 885  007E C3 33 00        jp  x0033
 886  0081
 887  0081 00           	nop
 888  0082 00           	nop
 889  0083 00           	nop
 890  0084              x0084
 891  0084              ;возврат из монитора =#0084
 892  0084 ED 51        ExitMon	out	(c),d			;#1FFD
 893  0086 06 7F        	ld	b,#7F
 894  0088 ED 59        	out	(c),e			;#7FFD
 895  008A 01 00 00     	ld	bc,#0000
 896  008D ED 79        	out	(c),a
 897  008F D1           	pop	de
 898  0090 C1           	pop	bc
 899  0091 33           	inc	sp
 900  0092 F1           	pop	af
 901  0093 ED 4F        	ld	r,a
 902  0095 E2 9B 00     	jp	po,x009B
 903  0098 F1           	pop	af
 904  0099 FB           	ei
 905  009A C9           	ret
 906  009B F1           x009B	pop	af
 907  009C F3           	di
 908  009D C9           	ret
 909  009E
 910  009E              x009E
 911  009E              ; StartWord
 912  009E              	; ldir
 913  009E              	; call	onPageTXT
 914  009E              	; jp	MainLoopEdit
 915  009E              	; INSERT	"Info/!version.txt"
 916  009E              	; INSERT	"Info/!build.txt"
 917  009E              	; db	"GMX"
 918  009E 00 00 00...  y009E	ds	#00FF-$
 919  00FF
 920  00FF 38 00        x00FF	dw	x0038
 921  0101
 922  0101
 923  0101
 924  0101              ;Первый запуск
 925  0101              InitProgramm
 926  0101 F3           	di
 927  0102 31 00 41     	ld sp,#4100 ;временный адрес стека
 928  0105 3E 01        	ld a, #01 ;включить ОЗУ вместо ПЗУ
 929  0107 01 FD 1F         ld   bc,#1ffd
 930  010A ED 79        	out (c),a
 931  010C 21 15 01     	ld hl,Start_warm ;заменить адрес старта
 932  010F 22 01 00     	ld (#0001),hl
 933  0112 C3 00 00     	jp 0
 934  0115
 935  0115
 936  0115              ; rst #08: db #8F установка/удаление резидента из памяти
 937  0115              ; при "теплой" перезагрузке, если резидент установлен в странице, то эта страница
 938  0115                ; будет впечатана в 3е окно и управление передано по заданному адресу
 939  0115              ; вх:  a - номер страницы для установки резидента
 940  0115                      ; =#08 - удаление резидента
 941  0115                      ; 7,a =1 однократный вызов
 942  0115                   ; hl - адрес старта в странице
 943  0115              ; вых: cy=1 резидент не установлен
 944  0115              ; сначала копируем в эту страницу то что надо
 945  0115              ; и только потом вызываем функцию
 946  0115              ; для гмх страницу 8 и #78 задавать нельзя
 947  0115              ; перед повторной установкой резидента, вызывать функцию удаления не нужно
 948  0115
 949  0115              ;Старт системы
 950  0115              Start_warm
 951  0115              	;di
 952  0115 ED 56        	im 1
 953  0117
 954  0117              ;------------------------------------------------------------------------------
 955  0117              ;вызов функции #00(00) (SetRam0) установка работы со страницей ram 0 вместо rom, требуется для
 956  0117              ;корректного выхода из монитора, при ресете отключается
 957  0117              ;вх:  c=#00(00)
 958  0117              ;     cy=1 - установка
 959  0117              ;     cy=0 - отключение
 960  0117              ;вых: регистры не меняются
 961  0117              ;   R8CONF
 962  0117 0E 00        	ld	c,#00
 963  0119 37           	scf
 964  011A CF           	rst	#08
 965  011B 8E           	db	#8E
 966  011C              ;
 967  011C
 968  011C
 969  011C
 970  011C              	;подготовить системный процесс
 971  011C 3E 01        	ld a,proc_id_system ;код системного процесса
 972  011E 32 20 2B     	ld (proc_id_cur),a ;запомнить как текущий
 973  0121 32 07 2B     	ld (proc_id_focus),a ;сразу в фокусе
 974  0124              	;ld (proc_run_prepar_id_tmp),a ;для правильного выделения памяти
 975  0124 AF           	xor a
 976  0125 32 1D 2B     	ld (proc_id_next),a ;для вычисления следующего процесса
 977  0128
 978  0128 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
 979  012A 32 19 2B     	ld (con_scr_cur),a
 980  012D 3E 79        	ld a,con_atr_real ;атрибуты реальные
 981  012F 32 1A 2B     	ld (con_atr_cur),a
 982  0132 3E 39        	ld a,#39 ;видимый экран
 983  0134 32 06 2B     	ld (scr_cur),a
 984  0137 CD 27 09     	call drvgmx.init
 985  013A
 986  013A CD B6 0C     	call Dos.init_fs_fat ;выбор раздела (буквы диска)
 987  013D
 988  013D 21 C0 34     	ld hl,proc_name_sys		;строка с именем
 989  0140 CD D8 02     	call proc_run ;запуск
 990  0143 DA 77 01     	jp c,loop_idle ;не вышло
 991  0146
 992  0146
 993  0146              	; ;запустить системный процесс
 994  0146              ; ;proc_run_sys
 995  0146              ; ;запуск sys не с диска, а из состава ОС
 996  0146              	; ld hl,proc_sys_name
 997  0146              	; call proc_run_prepar
 998  0146              	; ret c
 999  0146
1000  0146              	;включить страницы
1001  0146              	;;ld ix,(proc_run_prepar_deskr_tmp)
1002  0146 DD 7E 02     	ld a,(ix+2)
1003  0149 32 18 2B     	ld (page_slot2_cur),a ;сделать страницы текущими
1004  014C CD AE 0B     	call drvgmx.PageSlot2
1005  014F DD 7E 03     	ld a,(ix+3)
1006  0152 32 17 2B     	ld (page_slot3_cur),a
1007  0155 CD CD 0A     	call drvgmx.PageSlot3
1008  0158              	;цвета
1009  0158 3E 07        	ld a,proc_color_def ;цвет
1010  015A 32 EC 0B     	ld (drvgmx.attr_screen),a
1011  015D DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1012  0160              	;
1013  0160 3E 0C        	ld a,proc_color2_def ;цвет 2
1014  0162 32 ED 0B     	ld (drvgmx.attr_screen2),a
1015  0165 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1016  0168              	; ;перенести код
1017  0168              	; ld hl,start_sys_incl
1018  0168              	; ld de,PROGSTART
1019  0168              	; ld bc,end_sys_incl-start_sys_incl
1020  0168              	; ldir
1021  0168              	;подготовить правильный старт
1022  0168 DD 6E 06     	ld l,(ix+6) ;стек нового процесса
1023  016B DD 66 07     	ld h,(ix+7) ;стек
1024  016E F9           	ld sp,hl
1025  016F
1026  016F 3E 01        	ld a,proc_id_system
1027  0171 DD 77 00     	ld (ix),a
1028  0174 C3 00 80     	jp PROGSTART ;старт сначала на заглушку
1029  0177
1030  0177
1031  0177
1032  0177
1033  0177
1034  0177              loop_idle ;заглушка
1035  0177 18 FE        	jr loop_idle ;
1036  0179
1037  0179
1038  0179
1039  0179
1040  0179
1041  0179              ; proc_run_cmd
1042  0179              ; ; запуск cmd не с диска, а из состава ОС
1043  0179              	; ld hl,proc_cmd_name
1044  0179              	; call proc_run_prepar
1045  0179              	; ret c
1046  0179              	; ;включить страницы
1047  0179              	; ;ld ix,(proc_run_prepar_deskr_tmp)
1048  0179              	; ld a,(ix+2)
1049  0179              	; call drvgmx.PageSlot2
1050  0179              	; ld a,(ix+3)
1051  0179              	; call drvgmx.PageSlot3
1052  0179              	; ;перенести код
1053  0179              	; ld hl,start_cmd_incl
1054  0179              	; ld de,PROGSTART
1055  0179              	; ld bc,end_cmd_incl-start_cmd_incl
1056  0179              	; ldir
1057  0179
1058  0179              	; jp file_load_ok ;продолжить стандартно
1059  0179
1060  0179
1061  0179
1062  0179
1063  0179
1064  0179              proc_run_prepar
1065  0179              ;подготовка к запуску процесса
1066  0179              ;выделение памяти и прочее
1067  0179              ;вх: hl - имя процесса (файла) 8+3 символов
1068  0179              ;вых: a - номер процесса, IX - дескриптор
1069  0179
1070  0179 22 F8 01     	ld (proc_run_prepar_name_tmp),hl ;сохранить имя
1071  017C              	;поиск свободного дескриптора
1072  017C 21 00 2C     	ld hl,proc_table
1073  017F 11 00 01     	ld de,proc_descr_size
1074  0182 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
1075  0184 0E 01        	ld c,proc_id_system ;первый номер
1076  0186              proc_run_prepar_cl
1077  0186 7E           	ld a,(hl)
1078  0187 B7           	or a ;свободен?
1079  0188 28 0C        	jr z,proc_run_prepar_ok
1080  018A 19           	add hl,de
1081  018B 0C           	inc c
1082  018C 10 F8        	djnz proc_run_prepar_cl
1083  018E              	;не нашли свободного
1084  018E 21 EE 34     	ld hl,msg_proc_max
1085  0191 CD D1 09     	call drvgmx.printZ ;сообщение
1086  0194 37           	scf
1087  0195 C9           	ret
1088  0196              proc_run_prepar_ok
1089  0196              	;есть свободный
1090  0196 E5           	push hl
1091  0197 DD E1        	pop ix ;дискриптор процесса
1092  0199 22 FC 01     	ld (proc_run_prepar_deskr_tmp),hl
1093  019C 79           	ld a,c ;присвоить номер
1094  019D 32 FA 01     	ld (proc_run_prepar_id_tmp),a
1095  01A0
1096  01A0
1097  01A0 3A 20 2B     	ld a,(proc_id_cur)
1098  01A3 DD 77 01     	ld (ix+1),a ;код родительского
1099  01A6
1100  01A6              	;скопировать имя
1101  01A6 11 10 00     	ld de,16 ;
1102  01A9 19           	add hl,de
1103  01AA EB           	ex de,hl
1104  01AB 2A F8 01     	ld hl,(proc_run_prepar_name_tmp)
1105  01AE 01 0C 00     	ld bc,8+3+1
1106  01B1 ED B0        	ldir
1107  01B3
1108  01B3
1109  01B3              	;выделение памяти стандартное количество окон
1110  01B3 CD FE 01     	call proc_find_ram
1111  01B6 38 1D        	jr c,proc_run_prepar_no_mem
1112  01B8 DD 77 02     	ld (ix+2),a ;страница 8000
1113  01BB CD FE 01     	call proc_find_ram
1114  01BE 38 15        	jr c,proc_run_prepar_no_mem
1115  01C0 DD 77 03     	ld (ix+3),a ;страница c000
1116  01C3 CD FE 01     	call proc_find_ram
1117  01C6 38 0D        	jr c,proc_run_prepar_no_mem
1118  01C8 DD 77 04     	ld (ix+4),a ;страница пиксели
1119  01CB CD FE 01     	call proc_find_ram
1120  01CE 38 05        	jr c,proc_run_prepar_no_mem
1121  01D0 DD 77 05     	ld (ix+5),a ;страница атрибуты
1122  01D3
1123  01D3 18 0E        	jr proc_run_prepar_mem_ok
1124  01D5
1125  01D5              proc_run_prepar_no_mem
1126  01D5 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1127  01D8 CD 17 02     	call proc_clear_ram ;освободить память обратно
1128  01DB
1129  01DB 21 05 35     	ld hl,msg_mem_max
1130  01DE CD D1 09     	call drvgmx.printZ ;сообщение
1131  01E1 37           	scf
1132  01E2 C9           	ret
1133  01E3
1134  01E3              proc_run_prepar_mem_ok ;памяти хватило
1135  01E3
1136  01E3              	;определить адрес стека
1137  01E3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1138  01E6 21 00 2B     	ld hl,proc_table-256
1139  01E9 84           	add h
1140  01EA 67           	ld h,a
1141  01EB 2E 80        	ld l,#80 ;на стек меньше 128 байт
1142  01ED              	; ld hl,proc_stack
1143  01ED              	; or a
1144  01ED              	; jr z,proc_run_prepar_ex
1145  01ED              	; ld b,a
1146  01ED              	; ld de,proc_stack_size
1147  01ED              ; proc_run_prepar_cl2 ;цикл
1148  01ED              	; add hl,de
1149  01ED              	; djnz proc_run_prepar_cl2
1150  01ED              ;proc_run_prepar_ex
1151  01ED DD 75 06     	ld (ix+6),l ;адрес стека
1152  01F0 DD 74 07     	ld (ix+7),h ;адрес стека
1153  01F3              	; ld a,(proc_run_prepar_id_tmp) ;id
1154  01F3              	; ld (ix+0),a
1155  01F3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1156  01F6 B7           	or a
1157  01F7 C9           	ret
1158  01F8
1159  01F8 00 00        proc_run_prepar_name_tmp dw 0 ;временно имя нового процесса
1160  01FA 00           proc_run_prepar_id_tmp db 0 ;временно id нового процесса
1161  01FB 00           proc_run_file_id_tmp db 0 ;временно id файла
1162  01FC 00 00        proc_run_prepar_deskr_tmp dw 0 ;временно дескриптор процесса
1163  01FE
1164  01FE              proc_find_ram	;поиск свободной страницы памяти
1165  01FE              ;вых: a - номер страницы, также записан id процесса в таблицу proc_page_table
1166  01FE 11 2E 0B     	ld de,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
1167  0201 21 00 34     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
1168  0204 06 6D        	ld b,page_max
1169  0206              proc_find_ram_cl
1170  0206 AF           	xor a
1171  0207 B6           	or (hl)
1172  0208 28 06        	jr z,proc_find_ram_ok1 ;нашли
1173  020A              	;ищем дальше
1174  020A 23           	inc hl
1175  020B 13           	inc de
1176  020C 10 F8        	djnz proc_find_ram_cl
1177  020E              	;совсем не нашли
1178  020E 37           	scf
1179  020F C9           	ret
1180  0210              proc_find_ram_ok1
1181  0210 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1182  0213 77           	ld (hl),a ;записать id процесса в таблицу
1183  0214 1A           	ld a,(de) ;вернуть номер страницы
1184  0215 B7           	or a
1185  0216 C9           	ret
1186  0217
1187  0217
1188  0217              proc_clear_ram ;освбождение всех страниц памяти процесса
1189  0217              ;вх: a - номер процесса
1190  0217 21 00 34     	ld hl,proc_page_table
1191  021A 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
1192  021C              proc_clear_ram_cl ;
1193  021C BE           	cp (hl) ;совпадает с номером процесса?
1194  021D 20 02        	jr nz,proc_clear1
1195  021F 36 00        	ld (hl),0 ;освободить
1196  0221              proc_clear1
1197  0221 23           	inc hl
1198  0222 10 F8        	djnz proc_clear_ram_cl
1199  0224 B7           	or a
1200  0225 C9           	ret
1201  0226
1202  0226
1203  0226
1204  0226              proc_focus_next
1205  0226              	;переключение фокуса на следующий процесс
1206  0226 3E 01        	ld a,1
1207  0228 32 0D 2B     	ld (proc_next_find_skip_flag),a ;флаг пропустить лишние проверки
1208  022B 3A 07 2B     	ld a,(proc_id_focus)
1209  022E CD D5 08     	call proc_next_find_skip ;узнать кто следующий
1210  0231 08           	ex af,af'
1211  0232 AF           	xor a
1212  0233 32 0D 2B     	ld (proc_next_find_skip_flag),a ;флаг убрать
1213  0236 08           	ex af,af'
1214  0237              	;ret c ;выернуться если один процесс
1215  0237              	;или сменить фокус, код ниже
1216  0237
1217  0237
1218  0237
1219  0237              ;передать фокус процессу
1220  0237              ;вх: a - id процесса
1221  0237              proc_set_focus
1222  0237 21 07 2B     	ld hl,proc_id_focus
1223  023A BE           	cp (hl)
1224  023B C8           	ret z ;если уже в фокусе, ничего не делаем
1225  023C 32 CA 02     	ld (proc_set_focus_id_tmp),a ;сохранить
1226  023F
1227  023F 21 00 2B     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1228  0242 84           	add h
1229  0243 67           	ld h,a
1230  0244 AF           	xor a
1231  0245 B6           	or (hl)
1232  0246 C8           	ret z
1233  0247
1234  0247
1235  0247              	;сохранить в буфер процесса текущий экран
1236  0247 3A 07 2B     	ld a,(proc_id_focus) ;текущий в фокусе
1237  024A 21 00 2B     	ld hl,proc_table - 256
1238  024D 84           	add h
1239  024E 67           	ld h,a
1240  024F E5           	push hl
1241  0250 DD E1        	pop ix ;дескриптор процесса предыдущего
1242  0252
1243  0252 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1244  0255 CD CD 0A     	call drvgmx.PageSlot3
1245  0258 3E 39        	ld a,con_scr_real ;настоящий экран
1246  025A CD AE 0B     	call drvgmx.PageSlot2
1247  025D 21 00 80     	ld hl,#8000 ;скопировать
1248  0260 11 00 C0     	ld de,#c000
1249  0263 01 00 40     	ld bc,#4000
1250  0266 ED B0        	ldir
1251  0268
1252  0268 DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1253  026B CD CD 0A     	call drvgmx.PageSlot3
1254  026E 3E 79        	ld a,con_atr_real
1255  0270 CD AE 0B     	call drvgmx.PageSlot2
1256  0273 21 00 80     	ld hl,#8000 ;скопировать
1257  0276 11 00 C0     	ld de,#c000
1258  0279 01 00 40     	ld bc,#4000
1259  027C ED B0        	ldir
1260  027E
1261  027E              	;сохранить позицию скрола
1262  027E              	;ld hl,(drvgmx.curscrl)
1263  027E              	;ld (ix+#08),hl ;позиция скрола
1264  027E
1265  027E
1266  027E              	;вернуть из буфера экран нужного процесса
1267  027E 3A CA 02     	ld a,(proc_set_focus_id_tmp)
1268  0281 21 00 2B     	ld hl,proc_table - 256
1269  0284 84           	add h
1270  0285 67           	ld h,a
1271  0286 E5           	push hl
1272  0287 DD E1        	pop ix ;дескриптор процесса который будет в фокусе
1273  0289
1274  0289 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1275  028C CD CD 0A     	call drvgmx.PageSlot3
1276  028F 3E 39        	ld a,con_scr_real ;настоящий экран
1277  0291 CD AE 0B     	call drvgmx.PageSlot2
1278  0294 21 00 C0     	ld hl,#c000 ;скопировать
1279  0297 11 00 80     	ld de,#8000
1280  029A 01 00 40     	ld bc,#4000
1281  029D ED B0        	ldir
1282  029F
1283  029F DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1284  02A2 CD CD 0A     	call drvgmx.PageSlot3
1285  02A5 3E 79        	ld a,con_atr_real
1286  02A7 CD AE 0B     	call drvgmx.PageSlot2
1287  02AA 21 00 C0     	ld hl,#c000 ;скопировать
1288  02AD 11 00 80     	ld de,#8000
1289  02B0 01 00 40     	ld bc,#4000
1290  02B3 ED B0        	ldir
1291  02B5
1292  02B5 CD CB 02     	call page_cur_return
1293  02B8
1294  02B8
1295  02B8 3A CA 02     	ld a,(proc_set_focus_id_tmp)
1296  02BB              	;запомнить активный процесс
1297  02BB 32 07 2B     	ld (proc_id_focus),a
1298  02BE
1299  02BE              	;ld hl,(ix+#08) ;позиция скрола
1300  02BE              	;ld (drvgmx.curscrl),hl
1301  02BE              	;call drvgmx.gmxscroll ;обновить скролл
1302  02BE DD 7E 1D     	ld a, (ix + #1d) ;активный экран
1303  02C1 B7           	or a
1304  02C2 28 03        	jr z,proc_set_focus_scr
1305  02C4 CD A1 04     	call set_scr_no_txt ;включить
1306  02C7              proc_set_focus_scr
1307  02C7 C3 50 07     	jp Interrupts ;сразу на другой процесс
1308  02CA              	;or a
1309  02CA              	;ret
1310  02CA 00           proc_set_focus_id_tmp db 0 ; временно
1311  02CB
1312  02CB
1313  02CB
1314  02CB              page_cur_return
1315  02CB              ;вернуть текущие страницы
1316  02CB 3A 18 2B     	ld a,(page_slot2_cur)
1317  02CE CD AE 0B     	call drvgmx.PageSlot2
1318  02D1 3A 17 2B     	ld a,(page_slot3_cur)
1319  02D4 CD CD 0A     	call drvgmx.PageSlot3
1320  02D7 C9           	ret
1321  02D8
1322  02D8
1323  02D8              ;запустить процесс
1324  02D8              ;вх: hl - имя файла (заканчивается на 0)
1325  02D8              proc_run
1326  02D8 CD 79 01     	call proc_run_prepar ;выделить память
1327  02DB D8           	ret c
1328  02DC
1329  02DC 2A F8 01     	ld hl,(proc_run_prepar_name_tmp) ;имя
1330  02DF              	;ld b,Dos.FMODE_READ
1331  02DF CD 41 0C     	call Dos.fopen_r ;откроем файл для чтения
1332  02E2 DC B0 0D     	call c,Dos.file_error_print_file_open_error
1333  02E5 DA CD 03     	jp c,file_load_err
1334  02E8 32 FB 01     	ld (proc_run_file_id_tmp),a ;запомнить id
1335  02EB
1336  02EB              	;проверка длины файла не больше #8000
1337  02EB 7A           	ld	a,d ;самые старшие байты длины
1338  02EC B3           	or e
1339  02ED 28 09        	jr z,file_size_ok ;если не слищком большой
1340  02EF              file_too_big
1341  02EF 21 CB 0F     	ld hl,Dos.msg_file_too_big
1342  02F2 CD D1 09     	call drvgmx.printZ
1343  02F5 C3 CD 03     	jp file_load_err
1344  02F8
1345  02F8
1346  02F8              file_size_ok
1347  02F8 78           	ld	a,b ;младший старший байт длины
1348  02F9 FE 81        	cp proc_size_max+1
1349  02FB 30 F2        	jr nc,file_too_big
1350  02FD              	;размер нормальный, прочитаем
1351  02FD
1352  02FD
1353  02FD
1354  02FD              	;включить страницы
1355  02FD DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp)
1356  0301 DD 7E 02     	ld a,(ix+2)
1357  0304 CD AE 0B     	call drvgmx.PageSlot2
1358  0307 DD 7E 03     	ld a,(ix+3)
1359  030A CD CD 0A     	call drvgmx.PageSlot3
1360  030D
1361  030D 21 00 80     	ld hl,PROGSTART
1362  0310 3A FB 01     	ld a,(proc_run_file_id_tmp)
1363  0313 50           	ld d,b ;размер
1364  0314 59           	ld e,c
1365  0315 CD FA 0D     	call Dos.fread
1366  0318 30 0E        	jr nc,file_size_ok2
1367  031A              	;если ошибка вернуть страницы
1368  031A CD B8 0D     	call Dos.file_error_print_file_read_error
1369  031D CD CB 02     	call page_cur_return
1370  0320 3A FB 01     	ld a,(proc_run_file_id_tmp)
1371  0323 CD C0 0D     	call Dos.fclose ;закрыть файл
1372  0326 37           	scf
1373  0327 C9           	ret
1374  0328              file_size_ok2
1375  0328 3A FB 01     	ld a,(proc_run_file_id_tmp)
1376  032B CD C0 0D     	call Dos.fclose ;закрыть файл
1377  032E              	;jr file_load_ok
1378  032E
1379  032E              	;скопировать дескриптор системной папки, будет у приложения такая же папка по умолчанию
1380  032E 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;номер будущего процесса
1381  0331 CD 86 0E     	call Dos.calc_dir_deskr
1382  0334 EB           	ex de,hl
1383  0335 21 3B 10     	ld hl,Dos.dir_fat_deskr
1384  0338 01 20 00     	ld bc,Dos.fcb_fat_size
1385  033B ED B0        	ldir
1386  033D
1387  033D              file_load_ok ;загрузился нормально
1388  033D DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp) ;вспомнить дескриптор
1389  0341              	;очистить экран
1390  0341              	;сначала запомнить как было
1391  0341 2A EC 0B     	ld hl,(drvgmx.attr_screen)
1392  0344 22 CF 03     	ld (proc_run_attr_screen_tmp),hl
1393  0347              	; запомнить координаты экрана предыдущего
1394  0347 2A EA 0B     	ld hl,(drvgmx.col_screen)
1395  034A 22 D3 03     	ld (proc_run_col_screen_tmp),hl ;координаты
1396  034D              	;страницы буфера
1397  034D 3A 19 2B     	ld a,(con_scr_cur)
1398  0350 32 D1 03     	ld (proc_run_con_scr_cur_tmp),a
1399  0353 3A 1A 2B     	ld a,(con_atr_cur)
1400  0356 32 D2 03     	ld (proc_run_con_atr_cur_tmp),a
1401  0359              	;скрола
1402  0359 2A BE 0A     	ld hl,(drvgmx.curscrl)
1403  035C 22 D5 03     	ld (proc_run_curscrl_tmp),hl
1404  035F
1405  035F
1406  035F
1407  035F              	;чистить буфер экрана
1408  035F 3E 07        	ld a,proc_color_def ;цвет
1409  0361 32 EC 0B     	ld (drvgmx.attr_screen),a
1410  0364 DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1411  0367              	;
1412  0367 3E 0C        	ld a,proc_color2_def ;цвет 2
1413  0369 32 ED 0B     	ld (drvgmx.attr_screen2),a
1414  036C DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1415  036F              	;
1416  036F DD 7E 04     	ld a,(ix+4)
1417  0372 32 19 2B     	ld (con_scr_cur),a
1418  0375 DD 7E 05     	ld a,(ix+5)
1419  0378 32 1A 2B     	ld (con_atr_cur),a
1420  037B CD 2A 09     	call drvgmx.cls
1421  037E 21 00 00     	ld hl,0
1422  0381 DD 75 08 DD  	ld (ix+#08),hl ;позиция скрола
1422  0385 74 09
1423  0387 DD 75 0A DD  	ld (ix+#0a),hl ;позиция курсора
1423  038B 74 0B
1424  038D              	;вернуть
1425  038D 2A CF 03     	ld hl,(proc_run_attr_screen_tmp)
1426  0390 22 EC 0B     	ld (drvgmx.attr_screen),hl
1427  0393 2A D3 03     	ld hl,(proc_run_col_screen_tmp) ;координаты
1428  0396 22 EA 0B     	ld (drvgmx.col_screen),hl
1429  0399 3A D1 03     	ld a,(proc_run_con_scr_cur_tmp)
1430  039C 32 19 2B     	ld (con_scr_cur),a
1431  039F 3A D2 03     	ld a,(proc_run_con_atr_cur_tmp)
1432  03A2 32 1A 2B     	ld (con_atr_cur),a
1433  03A5 2A D5 03     	ld hl,(proc_run_curscrl_tmp)
1434  03A8 22 BE 0A     	ld (drvgmx.curscrl),hl
1435  03AB
1436  03AB
1437  03AB
1438  03AB
1439  03AB              	;подготовить правильный старт
1440  03AB DD 6E 06     	ld l,(ix+6) ;адрес стека
1441  03AE DD 66 07     	ld h,(ix+7) ;адрес стека
1442  03B1 01 00 80     	ld bc,PROGSTART ;возврат сюда
1443  03B4 2B           	dec hl
1444  03B5 70           	ld (hl),b
1445  03B6 2B           	dec hl
1446  03B7 71           	ld (hl),c
1447  03B8 01 EC FF     	ld bc,-20 ;возврат будет с восстановлением регистров
1448  03BB 09           	add hl,bc
1449  03BC
1450  03BC DD 75 06     	ld (ix+6),l ;адрес стека
1451  03BF DD 74 07     	ld (ix+7),h ;адрес стека
1452  03C2 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1453  03C5 DD 77 00     	ld (ix),a ;в последнюю очередь код (флаг что процесс работает)
1454  03C8
1455  03C8 CD CB 02     	call page_cur_return
1456  03CB B7           	or a
1457  03CC C9           	ret
1458  03CD
1459  03CD
1460  03CD              file_load_err
1461  03CD 37           	scf
1462  03CE C9           	ret
1463  03CF
1464  03CF 00 00        proc_run_attr_screen_tmp dw 0 ;временно
1465  03D1 00           proc_run_con_scr_cur_tmp db 0 ;временно
1466  03D2 00           proc_run_con_atr_cur_tmp db 0 ;временно
1467  03D3 00 00        proc_run_col_screen_tmp dw 0 ;временно
1468  03D5 00 00        proc_run_curscrl_tmp dw 0 ;временно
1469  03D7
1470  03D7
1471  03D7
1472  03D7
1473  03D7
1474  03D7
1475  03D7
1476  03D7
1477  03D7              get_c ;функция получение кода нажатой клавиши
1478  03D7              	;вых: a - код последней клавиши, 255 - ничего не нажато
1479  03D7 3A 20 2B     	ld a,(proc_id_cur) ;сравнить если процесс в фокусе
1480  03DA 21 07 2B     	ld hl,proc_id_focus
1481  03DD BE           	cp (hl)
1482  03DE 3E FF        	ld a,255 ;ничего не нажато если не в фокусе
1483  03E0 C0           	ret nz
1484  03E1 3A 1B 2B     	ld a,(key_cur) ;или вернуть клавишу
1485  03E4 F5           	push af
1486  03E5 3E FF        	ld a,255
1487  03E7 32 1B 2B     	ld (key_cur),a ;очистить буфер
1488  03EA F1           	pop af
1489  03EB C9           	ret
1490  03EC
1491  03EC              get_timer ;функция получить значение системного таймера
1492  03EC ED 5B 21 2B  	ld de,(sys_timer) ;младшие байты
1493  03F0 2A 23 2B     	ld hl,(sys_timer+2)
1494  03F3 C9           	ret
1495  03F4
1496  03F4
1497  03F4
1498  03F4              page_copy ;скопировать страницу в страницу
1499  03F4              ;скопировать данные из страницы в страницу
1500  03F4              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
1501  03F4 ED 43 2A 04  	ld (page_copy_tmp),bc
1502  03F8 32 2A 04     	ld (page_copy_tmp),a
1503  03FB D9           	exx
1504  03FC CD 2C 04     	call page_check_owner 	;проверка разрешений
1505  03FF D8           	ret c
1506  0400 3A 2B 04     	ld a,(page_copy_tmp+1)
1507  0403 CD 2C 04     	call page_check_owner 	;проверка разрешений
1508  0406 D8           	ret c
1509  0407 DD 7C        	ld a,ixh ;не больше размера страницы
1510  0409 FE 41        	cp #41
1511  040B 30 1B        	jr nc,page_copy_err
1512  040D DD B5        	or ixl
1513  040F 28 17        	jr z,page_copy_err ;и не 0 длина
1514  0411 3A 2A 04     	ld a,(page_copy_tmp)
1515  0414 CD AE 0B     	call drvgmx.PageSlot2
1516  0417 3A 2B 04     	ld a,(page_copy_tmp+1)
1517  041A CD CD 0A     	call drvgmx.PageSlot3
1518  041D D9           	exx ;вспомнить регистры
1519  041E              	 ;скопировать
1520  041E DD E5        	push ix
1521  0420 C1           	pop bc ;длина
1522  0421 ED B0        	ldir
1523  0423 CD CB 02     	call page_cur_return ;вернуть страницы
1524  0426 AF           	xor a
1525  0427 C9           	ret
1526  0428              page_copy_err
1527  0428 37           	scf
1528  0429 C9           	ret
1529  042A
1530  042A
1531  042A 00 00        page_copy_tmp dw 0 ;временно
1532  042C
1533  042C              page_check_owner ;проверить разрешена ли страница для процесса
1534  042C FE 05        	cp #05 ;видео страница
1535  042E C8           	ret z
1536  042F FE 07        	cp #07 ;видео страница
1537  0431 C8           	ret z
1538  0432 FE 39        	cp #39 ;видео страница
1539  0434 C8           	ret z
1540  0435 FE 3A        	cp #3a ;видео страница
1541  0437 C8           	ret z
1542  0438 FE 79        	cp #79 ;видео страница
1543  043A C8           	ret z
1544  043B FE 7A        	cp #7a ;видео страница
1545  043D C8           	ret z
1546  043E 32 62 04     	ld (page_check_owner_tmp),a
1547  0441 21 2E 0B     	ld hl,drvgmx.page_table ;таблица памяти
1548  0444 06 6D        	ld b,page_max ;всего страниц
1549  0446 0E 00        	ld c,0 ;индекс
1550  0448              page_check_owner_cl ;найти такую страницу
1551  0448 BE           	cp (hl)
1552  0449 28 06        	jr z,page_check_owner_ex
1553  044B 0C           	inc c
1554  044C 23           	inc hl
1555  044D 10 F9        	djnz page_check_owner_cl
1556  044F 37           	scf ;не нашли в списке страниц
1557  0450 C9           	ret
1558  0451              page_check_owner_ex
1559  0451              	;нашли
1560  0451 06 00        	ld b,0
1561  0453 21 00 34     	ld hl,proc_page_table ;сверить с кодом текущего процесса
1562  0456 09           	add hl,bc
1563  0457 3A 20 2B     	ld a,(proc_id_cur)
1564  045A BE           	cp (hl)
1565  045B 37           	scf ;не совпадает владелец с процессом
1566  045C 3A 62 04     	ld a,(page_check_owner_tmp)
1567  045F C0           	ret nz
1568  0460 B7           	or a
1569  0461 C9           	ret
1570  0462 00           page_check_owner_tmp db 0 ;временно
1571  0463
1572  0463
1573  0463              set_VTPL_PLAY ;запустить плеер AY. будет играть на прерываниях
1574  0463 3A 18 2B     	ld a,(page_slot2_cur)
1575  0466 32 04 2B     	ld (proc_play_ay_slot2),a ;запомнить страницы с музыкой
1576  0469 3A 17 2B     	ld a,(page_slot3_cur)
1577  046C 32 05 2B     	ld (proc_play_ay_slot3),a
1578  046F 3A 20 2B     	ld a,(proc_id_cur) ;код процесса, который играет музыку
1579  0472 32 03 2B     	ld (proc_play_ay),a
1580  0475 C9           	ret
1581  0476
1582  0476              set_VTPL_MUTE ;остановить плеер AY
1583  0476 AF           	xor a
1584  0477 32 03 2B     	ld (proc_play_ay),a
1585  047A C3 C6 16     	jp VTPL.MUTE
1586  047D
1587  047D
1588  047D              get_VTPL_SETUP ;получить адрес переменной плеера
1589  047D 21 A1 16     	ld hl,VTPL.SETUP
1590  0480 C9           	ret
1591  0481
1592  0481
1593  0481              get_proc_page ;получить номера страниц процесса
1594  0481              	;вых: BC - страницы в слоте 2, 3
1595  0481 3A 18 2B     	ld a,(page_slot2_cur)
1596  0484 47           	ld b,a
1597  0485 3A 17 2B     	ld a,(page_slot3_cur)
1598  0488 4F           	ld c,a
1599  0489 C9           	ret
1600  048A
1601  048A
1602  048A              set_scr ;установить активный экран
1603  048A              	;проверки
1604  048A 08           	ex af,af'
1605  048B 3A 20 2B     	ld a,(proc_id_cur)
1606  048E 21 07 2B     	ld hl,proc_id_focus
1607  0491 BE           	cp (hl)
1608  0492 20 21        	jr nz,set_scr_err
1609  0494 CD CE 06     	call get_proc_descr
1610  0497 08           	ex af,af'
1611  0498 DD 77 1C     	ld (ix+#1c),a ;запомнить
1612  049B B7           	or a
1613  049C 20 03        	jr nz,set_scr_no_txt
1614  049E              	;включить текстовый
1615  049E C3 12 0B     	jp drvgmx.set_scr39	;основной экран
1616  04A1              set_scr_no_txt
1617  04A1 FE 05        	cp #05
1618  04A3 CA F6 0A     	jp z,drvgmx.set_scr5
1619  04A6 FE 07        	cp #07
1620  04A8 CA 04 0B     	jp z,drvgmx.set_scr7
1621  04AB FE 39        	cp #39
1622  04AD CA 12 0B     	jp z,drvgmx.set_scr39
1623  04B0 FE 3A        	cp #3a
1624  04B2 CA 20 0B     	jp z,drvgmx.set_scr3a
1625  04B5              set_scr_err
1626  04B5 37           	scf
1627  04B6 C9           	ret
1628  04B7
1629  04B7              set_page_slot2	;включить страницу в слот 2 (#8000);
1630  04B7 CD 2C 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1631  04BA D8           	ret c
1632  04BB 08           	ex af,af'
1633  04BC 3A 20 2B     	ld a,(proc_id_cur)
1634  04BF 21 00 2B     	ld hl,proc_table - 256
1635  04C2 84           	add h
1636  04C3 67           	ld h,a
1637  04C4 E5           	push hl
1638  04C5 DD E1        	pop ix ;дескриптор
1639  04C7 08           	ex af,af'
1640  04C8 DD 77 02     	ld (ix+#02),a ;запомнить текущую страницу процесса
1641  04CB C3 AE 0B     	jp drvgmx.PageSlot2 ;включить
1642  04CE
1643  04CE
1644  04CE              set_page_slot3	;включить страницу в слот 2 (#8000);
1645  04CE CD 2C 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1646  04D1 D8           	ret c
1647  04D2 08           	ex af,af'
1648  04D3 3A 20 2B     	ld a,(proc_id_cur)
1649  04D6 21 00 2B     	ld hl,proc_table - 256
1650  04D9 84           	add h
1651  04DA 67           	ld h,a
1652  04DB E5           	push hl
1653  04DC DD E1        	pop ix ;дескриптор
1654  04DE 08           	ex af,af'
1655  04DF DD 77 03     	ld (ix+#03),a ;запомнить текущую страницу процесса
1656  04E2 C3 CD 0A     	jp drvgmx.PageSlot3
1657  04E5
1658  04E5
1659  04E5
1660  04E5              set_interrupt ;установка адреса обработчика прерываний процесса;
1661  04E5 EB           	ex de,hl
1662  04E6 3A 20 2B     	ld a,(proc_id_cur)
1663  04E9 21 00 2B     	ld hl,proc_table - 256
1664  04EC 84           	add h
1665  04ED 67           	ld h,a
1666  04EE E5           	push hl
1667  04EF DD E1        	pop ix ;дескриптор
1668  04F1 EB           	ex de,hl
1669  04F2 DD 75 0E     	ld (ix+#0e),l ;адрес
1670  04F5 DD 74 0F     	ld (ix+#0f),h ;адрес
1671  04F8 C9           	ret
1672  04F9
1673  04F9
1674  04F9
1675  04F9
1676  04F9              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; hl - строка адрес, de - строка порт
1677  04F9              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1678  04F9              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто);
1679  04F9              esp_open ;установить соединение ESP (CIPSTART);
1680  04F9 08           	ex af,af'
1681  04FA CD 7E 05     	call esp_check_err
1682  04FD D8           	ret c
1683  04FE 08           	ex af,af'
1684  04FF FE 03        	cp 3
1685  0501 28 21        	jr z,esp_open_direct ;для терминала
1686  0503 DD 77 0E     	ld (ix+14),a ;тип
1687  0506 D5           	push de ;сохранить порт
1688  0507 11 8F 34     	ld de,esp_link_id_table+15 ;на имя сервера
1689  050A CD E5 05     	call copyZ ;скопировать
1690  050D 11 BB 34     	ld de,esp_link_id_table+59 ;тут адрес порта
1691  0510 E1           	pop hl
1692  0511 CD E5 05     	call copyZ
1693  0514 3A 20 2B     	ld a,(proc_id_cur)
1694  0517 DD 77 00     	ld (ix),a ;флаг занято
1695  051A DD 36 02 00  	ld (ix+2),0 ;флаг результат открытия
1696  051E DD 36 01 01  	ld (ix+1),1 ;флаг запрос на открытие
1697  0522 AF           	xor a
1698  0523 C9           	ret
1699  0524
1700  0524              esp_open_direct ;прямая связь с портом
1701  0524 3A 20 2B     	ld a,(proc_id_cur)
1702  0527 DD 77 00     	ld (ix),a ;флаг занято
1703  052A AF           	xor a
1704  052B C9           	ret
1705  052C
1706  052C              esp_open_err
1707  052C 3E FF        	ld a,255
1708  052E 37           	scf
1709  052F C9           	ret
1710  0530
1711  0530
1712  0530
1713  0530              ;вх:
1714  0530              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1715  0530              esp_close ;закрыть соединение ESP
1716  0530 CD 7E 05     	call esp_check_err
1717  0533 D8           	ret c
1718  0534 AF           	xor a
1719  0535 DD 77 00     	ld (ix),a ;закрыть
1720  0538 C9           	ret
1721  0539
1722  0539
1723  0539
1724  0539
1725  0539              ;вх: hl - адрес данных, de - длина данных
1726  0539              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1727  0539              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено)
1728  0539              esp_send ;послать запрос ESP (CIPSEND);
1729  0539 CD 7E 05     	call esp_check_err
1730  053C D8           	ret c
1731  053D D5           	push de ; длина
1732  053E C1           	pop bc
1733  053F DD 73 09     	ld (ix+9),e  ;длина
1734  0542 DD 72 0A     	ld (ix+10),d
1735  0545 11 2D 35     	ld de,esp_buffer ;перенести данные в буфер отправки
1736  0548 ED B0        	ldir
1737  054A
1738  054A DD 36 04 00  	ld (ix+4),0 ;флаг результат отправки
1739  054E DD 36 03 01  	ld (ix+3),1 ;флаг запрос отправки
1740  0552 AF           	xor a
1741  0553 DD 77 06     	ld (ix+6),a ;флаг результат приёма
1742  0556 DD 77 05     	ld (ix+5),a ;флаг запрос на приём
1743  0559 C9           	ret
1744  055A
1745  055A              esp_send_err
1746  055A 3E FF        	ld a,255
1747  055C 37           	scf
1748  055D C9           	ret
1749  055E
1750  055E
1751  055E
1752  055E
1753  055E              ;вх: hl - адрес для данных
1754  055E              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1755  055E              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято)
1756  055E              esp_get ;получить пакет ESP (+IPD);
1757  055E CD 7E 05     	call esp_check_err
1758  0561 D8           	ret c
1759  0562 DD 75 07     	ld (ix+7),l ;адрес данных
1760  0565 DD 74 08     	ld (ix+8),h ;адрес данных
1761  0568 DD 36 06 00  	ld (ix+6),0 ;флаг результат приёма
1762  056C DD 36 05 01  	ld (ix+5),1 ;флаг запрос на приём
1763  0570 AF           	xor a
1764  0571 DD 77 04     	ld (ix+4),a ;флаг результат отправки
1765  0574 DD 77 03     	ld (ix+3),a ;флаг запрос отправки
1766  0577 DD 77 09     	ld (ix+9),a  ;длина
1767  057A DD 77 0A     	ld (ix+10),a
1768  057D C9           	ret
1769  057E
1770  057E              ;проверка есть ли порт и кто владелец в данный момент
1771  057E              esp_check_err
1772  057E DD 21 80 34  	ld ix,esp_link_id_table
1773  0582 3A 02 2B     	ld a,(uart_enable)
1774  0585 B7           	or a
1775  0586 28 0F        	jr z,esp_check_err1 ;нет порта
1776  0588 DD 7E 00     	ld a,(ix)
1777  058B B7           	or a
1778  058C C8           	ret z ;выход без ошибки, если никем не занят
1779  058D 3A 20 2B     	ld a,(proc_id_cur) ;проверить кто владелец соединения
1780  0590 DD BE 00     	cp (ix)
1781  0593 20 02        	jr nz,esp_check_err1 ;выйти с ошибкой, если буфер занят другим
1782  0595 AF           	xor a
1783  0596 C9           	ret
1784  0597              esp_check_err1
1785  0597 3E FF        	ld a,255
1786  0599 37           	scf
1787  059A C9           	ret
1788  059B
1789  059B
1790  059B
1791  059B              ;прочитать байт из порта uart
1792  059B              ;вх:
1793  059B              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
1794  059B              ;вых: A - считанный байт
1795  059B              uart_read ;
1796  059B CD 7E 05     	call esp_check_err
1797  059E D8           	ret c
1798  059F              	;прочитать сразу, не через сетевой процесс
1799  059F 3E FD            ld a, Uart.LSR
1800  05A1 DB EF            in a, (uart_port)
1801  05A3 0F               rrca
1802  05A4 30 06        	jr nc,uart_read_err
1803  05A6 3E F8            ld a, Uart.RBR_THR
1804  05A8 DB EF            in a, (uart_port)
1805  05AA B7           	or a ;сбросить флаг
1806  05AB C9           	ret
1807  05AC              uart_read_err
1808  05AC AF           	xor a
1809  05AD 37           	scf
1810  05AE C9           	ret
1811  05AF
1812  05AF
1813  05AF              ;записать байт в порт uart
1814  05AF              ;вх: A -байт
1815  05AF              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1816  05AF              uart_write ;
1817  05AF 08           	ex af,af'
1818  05B0 CD 7E 05     	call esp_check_err
1819  05B3 D8           	ret c
1820  05B4              	;записать
1821  05B4 3E FD        	ld a, Uart.LSR
1822  05B6 DB EF            in a, (uart_port)
1823  05B8 E6 20            and #20
1824  05BA 28 09            jr z,uart_write_err ;порт не готов
1825  05BC 08               ex af,af'
1826  05BD 06 F8        	ld b, Uart.RBR_THR
1827  05BF 0E EF        	ld c, uart_port
1828  05C1 ED 79            out (c), a
1829  05C3 B7           	or a ;сбросить флаг
1830  05C4 C9           	ret
1831  05C5              uart_write_err
1832  05C5 37           	scf
1833  05C6 C9           	ret
1834  05C7
1835  05C7
1836  05C7              ;вх: a - id процесса куда копировать, hl - откуда, de - куда, bc - длина
1837  05C7              esp_buffer_copy ;скопировать принятое из буфера ESP
1838  05C7 D9           	exx
1839  05C8 21 00 2B     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1840  05CB 84           	add h
1841  05CC 67           	ld h,a
1842  05CD AF           	xor a
1843  05CE B6           	or (hl)
1844  05CF C8           	ret z
1845  05D0
1846  05D0 E5           	push hl
1847  05D1 DD E1        	pop ix ;дескриптор процесса
1848  05D3              	;включить страницы целевого процесса
1849  05D3 DD 7E 02     	ld a,(ix+2)
1850  05D6 CD AE 0B     	call drvgmx.PageSlot2
1851  05D9 DD 7E 03     	ld a,(ix+3)
1852  05DC CD CD 0A     	call drvgmx.PageSlot3
1853  05DF D9           	exx
1854  05E0
1855  05E0 ED B0        	ldir
1856  05E2
1857  05E2              	;вернуть страницы
1858  05E2 C3 CB 02     	jp page_cur_return
1859  05E5
1860  05E5
1861  05E5
1862  05E5
1863  05E5              ;вх: hl - откуда de - куда
1864  05E5              copyZ ;копировать данные до кода 0
1865  05E5 7E           	ld a,(hl)
1866  05E6 B7           	or a
1867  05E7 28 04        	jr z,copyZ_ex
1868  05E9 ED A0        	ldi
1869  05EB 18 F8        	jr copyZ
1870  05ED              copyZ_ex
1871  05ED AF           	xor a
1872  05EE 12           	ld (de),a  ;в конце 0
1873  05EF C9           	ret
1874  05F0
1875  05F0
1876  05F0
1877  05F0              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
1878  05F0              				;на входе в HL число
1879  05F0 11 10 27     			ld de,10000 ;десятки тысяч
1880  05F3 3E FF        			ld a,255
1881  05F5              toDecimal10k
1882  05F5 A7           			and a
1883  05F6 ED 52        			sbc hl,de
1884  05F8 3C           			inc a
1885  05F9 30 FA        			jr nc,toDecimal10k
1886  05FB 19           			add hl,de
1887  05FC C6 30        			add a,48
1888  05FE 32 46 06     			ld (decimalS),a
1889  0601 11 E8 03     			ld de,1000 ;тысячи
1890  0604 3E FF        			ld a,255
1891  0606              toDecimal1k
1892  0606 A7           			and a
1893  0607 ED 52        			sbc hl,de
1894  0609 3C           			inc a
1895  060A 30 FA        			jr nc,toDecimal1k
1896  060C 19           			add hl,de
1897  060D C6 30        			add a,48
1898  060F 32 47 06     			ld (decimalS+1),a
1899  0612 11 64 00     			ld de,100 ;сотни
1900  0615 3E FF        			ld a,255
1901  0617              toDecimal01k
1902  0617 A7           			and a
1903  0618 ED 52        			sbc hl,de
1904  061A 3C           			inc a
1905  061B 30 FA        			jr nc,toDecimal01k
1906  061D 19           			add hl,de
1907  061E C6 30        			add a,48
1908  0620 32 48 06     			ld (decimalS+2),a
1909  0623 11 0A 00     			ld de,10 ;десятки
1910  0626 3E FF        			ld a,255
1911  0628              toDecimal001k
1912  0628 A7           			and a
1913  0629 ED 52        			sbc hl,de
1914  062B 3C           			inc a
1915  062C 30 FA        			jr nc,toDecimal001k
1916  062E 19           			add hl,de
1917  062F C6 30        			add a,48
1918  0631 32 49 06     			ld (decimalS+3),a
1919  0634 11 01 00     			ld de,1 ;единицы
1920  0637 3E FF        			ld a,255
1921  0639              toDecimal0001k
1922  0639 A7           			and a
1923  063A ED 52        			sbc hl,de
1924  063C 3C           			inc a
1925  063D 30 FA        			jr nc,toDecimal0001k
1926  063F 19           			add hl,de
1927  0640 C6 30        			add a,48
1928  0642 32 4A 06     			ld (decimalS+4),a
1929  0645
1930  0645 C9           			ret
1931  0646 00 00 00...  decimalS ds 6 ;здесь будет цифра
1932  064C
1933  064C
1934  064C
1935  064C
1936  064C              ;передача управления ОС до следующего прерывания;
1937  064C              os_wait ;
1938  064C F5           	push af
1939  064D C5           	push bc
1940  064E D5           	push de
1941  064F E5           	push hl
1942  0650 D9           	exx
1943  0651 08           	ex af,af'
1944  0652 F5           	push af
1945  0653 C5           	push bc
1946  0654 D5           	push de
1947  0655 E5           	push hl
1948  0656 DD E5        	push ix
1949  0658 FD E5        	push iy
1950  065A ED 73 0A 2B  	ld (proc_stack_addr_tmp_wait),sp ;запомнить адрес стека
1951  065E 3E 01        	ld a,1
1952  0660 32 0C 2B     	ld (os_wait_flag),a ;флаг внеочередная смена процесса
1953  0663 3A 20 2B     	ld a,(proc_id_cur)
1954  0666 CD CE 06     	call get_proc_descr
1955  0669 DD 36 1D 01  	ld (ix+#1d),1 ;флаг что процесс запросил os_wait
1956  066D C3 03 08     	jp proc_next_wait ;на следующий процесс
1957  0670
1958  0670
1959  0670
1960  0670              ;закрыть процесс
1961  0670              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
1962  0670              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
1963  0670              proc_close
1964  0670 B7           	or a
1965  0671 20 03        	jr nz,proc_close_skip
1966  0673 3A 20 2B     	ld a,(proc_id_cur) ;текущий
1967  0676              proc_close_skip
1968  0676 FE 09        	cp proc_max+1 ;защита
1969  0678 D0           	ret nc
1970  0679 32 CD 06     	ld (proc_close_id_tmp),a ;запомнить
1971  067C
1972  067C 21 07 2B     	ld hl,proc_id_focus ;если он был в фокусе
1973  067F BE           	cp (hl)
1974  0680 20 05        	jr nz,proc_close_skip3
1975  0682 3E 01        	ld a,1
1976  0684 CD 37 02     	call proc_set_focus ;сменить фокус на системный процесс
1977  0687
1978  0687              proc_close_skip3
1979  0687              ;очистить таблицу процессов
1980  0687 3A CD 06     	ld a,(proc_close_id_tmp)
1981  068A CD CE 06     	call get_proc_descr
1982  068D 54           	ld d,h
1983  068E 5D           	ld e,l
1984  068F 13           	inc de
1985  0690 36 00        	ld (hl),0
1986  0692 01 FF 00     	ld bc,proc_descr_size-1
1987  0695 ED B0        	ldir
1988  0697
1989  0697              ;очистить таблицу памяти
1990  0697 3A CD 06     	ld a,(proc_close_id_tmp)
1991  069A CD 17 02     	call proc_clear_ram
1992  069D
1993  069D              ;очистить таблицу файлов FAT
1994  069D 3A CD 06     	ld a,(proc_close_id_tmp)
1995  06A0 CD E3 0D     	call Dos.fclose_proc_all
1996  06A3
1997  06A3              ;очистить таблицу соединений ESP
1998  06A3 3A CD 06     	ld a,(proc_close_id_tmp)
1999  06A6 21 80 34     	ld hl,esp_link_id_table
2000  06A9 BE           	cp (hl) ;id процесса совпадает?
2001  06AA 20 0A        	jr nz,proc_close_skip2
2002  06AC 54           	ld d,h
2003  06AD 5D           	ld e,l
2004  06AE 13           	inc de
2005  06AF 01 3F 00     	ld bc,esp_link_id_table_size_item-1
2006  06B2 36 00        	ld (hl),0 ;очистить
2007  06B4 ED B0        	ldir
2008  06B6              proc_close_skip2
2009  06B6
2010  06B6              ;остановить плеер
2011  06B6 3A CD 06     	ld a,(proc_close_id_tmp)
2012  06B9 21 03 2B     	ld hl,proc_play_ay
2013  06BC BE           	cp (hl)
2014  06BD 20 03        	jr nz,proc_close_skip4
2015  06BF CD 76 04     	call set_VTPL_MUTE
2016  06C2
2017  06C2              proc_close_skip4
2018  06C2
2019  06C2              ;выход
2020  06C2 3A CD 06     	ld a,(proc_close_id_tmp)
2021  06C5 21 20 2B     	ld hl,proc_id_cur
2022  06C8 BE           	cp (hl)
2023  06C9 C0           	ret nz ;выйти если вызывал не сам процесс
2024  06CA
2025  06CA C3 4C 06     	jp os_wait ;если вызывал закрытие сам процесс, то сразу переключиться на следующий
2026  06CD 00           proc_close_id_tmp db 0 ;временно
2027  06CE
2028  06CE
2029  06CE
2030  06CE
2031  06CE
2032  06CE              ;получить дескриптор процесса (адрес в таблице процессов)
2033  06CE              ;вх: A - id процесса
2034  06CE              ;вых: HL, IX - дескриптор
2035  06CE              get_proc_descr
2036  06CE 21 00 2B     	ld hl,proc_table - 256
2037  06D1 84           	add h
2038  06D2 67           	ld h,a
2039  06D3 E5           	push hl
2040  06D4 DD E1        	pop ix ;дескриптор
2041  06D6 C9           	ret
2042  06D7
2043  06D7
2044  06D7
2045  06D7              ;выбор функции (вызова)
2046  06D7              function
2047  06D7 08           	ex af,af'
2048  06D8 79           	ld a,c
2049  06D9 FE 2B        	cp function_max ;проверка на общее количество
2050  06DB 38 05        	jr c,function1
2051  06DD              function_no
2052  06DD 08           	ex af,af'
2053  06DE 3E FF        	ld a,255 ;??????
2054  06E0 37           	scf
2055  06E1 C9           	ret
2056  06E2              function1
2057  06E2 D9           	exx
2058  06E3 6F           	ld l,a
2059  06E4 26 00        	ld h,0
2060  06E6 29           	add hl,hl ;*2
2061  06E7 01 F6 06     	ld bc,function_table
2062  06EA 09           	add hl,bc
2063  06EB 5E           	ld e,(hl)
2064  06EC 23           	inc hl
2065  06ED 56           	ld d,(hl)
2066  06EE 7B           	ld a,e ;временно проверка есть ли такая функция
2067  06EF B2           	or d
2068  06F0 28 EB        	jr z,function_no ;-^
2069  06F2 D5           	push de
2070  06F3 D9           	exx
2071  06F4 08           	ex af,af'
2072  06F5 C9           	ret ;перейти по адресу функции
2073  06F6
2074  06F6
2075  06F6              function_table ;таблица функций
2076  06F6 2A 09        	dw drvgmx.cls  ; #00 (0 dec) - очистить консоль;
2077  06F8 66 09        	dw drvgmx.gotoXY ; #01 (1 dec) - установить позицию курсора в консоли
2078  06FA DC 09        	dw drvgmx.putC ; #02 (2 dec) - печать символа в консоль;
2079  06FC 77 09        	dw drvgmx.fillLine ; #03 (3 dec) - заполнение строки одним символом
2080  06FE 91 09        	dw drvgmx.paintLine ; #04 (4 dec) - покрасить строку цветом
2081  0700 00 00        	dw 0 ;#05 (5 dec) -
2082  0702 EE 0A        	dw drvgmx.set_color ;#06 (6 dec) - установить цвет текста в консоли
2083  0704 00 00        	dw 0 ;#07 (7 dec) - ;
2084  0706 00 00        	dw 0 ;#08 (8 dec) - ;
2085  0708 D1 09        	dw drvgmx.printZ ; #09 (9 dec) - печать в консоль до кода 0
2086  070A 9B 05        	dw uart_read ;#0A (10 dec) - прочитать байт из порта uart
2087  070C AF 05        	dw uart_write ;#0B (11 dec) - записать байт в порт uart
2088  070E 30 05        	dw esp_close ;#0C (12 dec) - закрыть соединение ESP
2089  0710 F9 04        	dw esp_open ;#0D (13 dec) - установить соединение ESP (CIPSTART);
2090  0712 39 05        	dw esp_send ;#0E (14 dec) - послать запрос ESP (CIPSEND);
2091  0714 5E 05        	dw esp_get ;#0F (15 dec) - получить пакет ESP (+IPD);
2092  0716 D7 03        	dw get_c ;#10 (16 dec) - получить код нажатой клавиши;
2093  0718 D8 02        	dw proc_run ;#11 (17 dec) - запустить процесс;
2094  071A 37 02        	dw proc_set_focus ;#12 (18 dec) - установить фокус;
2095  071C 70 06        	dw proc_close ;#13 (19 dec)-закрыть процесс;
2096  071E E5 04        	dw set_interrupt ;#14 (20 dec) - установка адреса обработчика прерываний процесса;
2097  0720 D8 16        	dw VTPL.INIT ;#15 (21 dec) - инициализация плеера AY;
2098  0722 63 04        	dw set_VTPL_PLAY ;#16 (22 dec) - запустить плеер AY;
2099  0724 76 04        	dw set_VTPL_MUTE ;#17 (23 dec) - заглушить плеер AY;
2100  0726 7D 04        	dw get_VTPL_SETUP ;#18 (24 dec) - получить значение переменной плеера;
2101  0728 F4 03        	dw page_copy ;#19 (25 dec) - скопировать данные из страницы в страницу
2102  072A FE 01        	dw proc_find_ram ;#1A (26 dec) - получить дополнительную страницу памяти;
2103  072C B7 04        	dw set_page_slot2 ;#1B (27 dec) - включить страницу в слот 2 (#8000);
2104  072E CE 04        	dw set_page_slot3 ;#1C (28 dec) - включить страницу в слот 3 (#c000);
2105  0730 8A 04        	dw set_scr ;#1D (29 dec) - включить экран N;
2106  0732 81 04        	dw get_proc_page ;#1E (30 dec) - получить номера страниц процесса;
2107  0734 EC 03        	dw get_timer ;#1F (31 dec) - получить значение системного таймера
2108  0736 00 00        	dw 0 ;#20 (32 dec) - ;инициализация?
2109  0738 41 0C        	dw Dos.fopen_r ;#21 (33 dec) - открыть файл для чтения или записи;
2110  073A 64 0C        	dw Dos.fopen_c ;#22 (34 dec) - создать файл;
2111  073C FA 0D        	dw Dos.fread ;#23 (35 dec) - прочитать из файла;
2112  073E 16 0E        	dw Dos.fwrite ;#24 (36 dec) - записать в файл;
2113  0740 C0 0D        	dw Dos.fclose ;#25 (37 dec) - закрыть файл;
2114  0742 5C 0E        	dw Dos.read_dir ;#26 (38 dec) - чтение секторов текущего каталога
2115  0744 71 0E        	dw Dos.open_dir ;#27 (39 dec) - вход в каталог/выход в родительский каталог
2116  0746 98 0E        	dw Dos.file_position ;#28 (40 dec) - установка/чтение указателя в файле
2117  0748 C4 0E        	dw Dos.find_path ;#29 (41 dec) - ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
2118  074A DF 0E        	dw Dos.get_LFN ;#2a (42 dec) - ; получение длинного имени файла
2119  074C
2120  074C
2121  074C 00 00 00 00  	align 16
2122  0750              ;обработчик прерываний
2123  0750              Interrupts
2124  0750 F3           	di
2125  0751 E3           	ex (sp),hl
2126  0752 22 0E 2B     	ld (proc_stack_addr_return_tmp),hl ;запомнить откуда вызвали прерывание
2127  0755 E3           	ex (sp),hl
2128  0756 F5           	push af
2129  0757 C5           	push bc
2130  0758 D5           	push de
2131  0759 E5           	push hl
2132  075A D9           	exx
2133  075B 08           	ex af,af'
2134  075C F5           	push af
2135  075D C5           	push bc
2136  075E D5           	push de
2137  075F E5           	push hl
2138  0760 DD E5        	push ix
2139  0762 FD E5        	push iy
2140  0764 ED 73 08 2B  	ld (proc_stack_addr_tmp),sp ;запомнить адрес стека
2141  0768              	; ld a,1
2142  0768              	; out (254),a
2143  0768
2144  0768 3E 01        	ld a,1
2145  076A 32 01 2B     	ld (Interrupt_new_flag),a ;флаг что было новое прерывание
2146  076D              	;сбросить флаги os_wait, потому что произошло обычное прерывание
2147  076D AF           	xor a
2148  076E 21 1D 2C     	ld hl,proc_table+#1d
2149  0771 77           	ld (hl),a
2150  0772 24           	inc h
2151  0773 77           	ld (hl),a
2152  0774 24           	inc h
2153  0775 77           	ld (hl),a
2154  0776 24           	inc h
2155  0777 77           	ld (hl),a
2156  0778 24           	inc h
2157  0779 77           	ld (hl),a
2158  077A 24           	inc h
2159  077B 77           	ld (hl),a
2160  077C 24           	inc h
2161  077D 77           	ld (hl),a
2162  077E 24           	inc h
2163  077F 77           	ld (hl),a
2164  0780
2165  0780
2166  0780
2167  0780              ;таймер
2168  0780 2A 21 2B     	ld hl,(sys_timer)
2169  0783 23           	inc hl
2170  0784 22 21 2B     	ld (sys_timer),hl
2171  0787 7C           	ld a,h
2172  0788 B5           	or l
2173  0789 20 07        	jr nz,Interrupts_timer
2174  078B 2A 23 2B     	ld hl,(sys_timer+2)
2175  078E 23           	inc hl
2176  078F 22 23 2B     	ld (sys_timer+2),hl
2177  0792              Interrupts_timer
2178  0792
2179  0792
2180  0792              ;опрос клавиатуры
2181  0792 CD 89 13     	call @DriverKeyboard
2182  0795 22 15 2B     	ld (FlgScanKeys_addr),hl ;адрес переменной
2183  0798 CB 76        	bit 6,(hl)
2184  079A 20 03        	jr nz,Interrupts_key1 ;если не нажата ни одна
2185  079C 32 1B 2B     	ld (key_cur),a ;запомнить клавишу
2186  079F              Interrupts_key1
2187  079F
2188  079F FE 1B        	cp proc_switch_key ;если клавиша переключения задач
2189  07A1 20 03        	jr nz,Interrupts_key_switch_no
2190  07A3 32 10 2B     	ld (key_proc_switch_flag),a ;сохранить нажатие
2191  07A6              Interrupts_key_switch_no
2192  07A6
2193  07A6 FE 07        	cp DrvKey.keyEdit
2194  07A8 20 05        	jr nz,Interrupts_key2
2195  07AA              	;переключение языка
2196  07AA 32 11 2B     	ld (key_lang_flag),a
2197  07AD 18 17        	jr Interrupts_key_ex
2198  07AF              Interrupts_key2
2199  07AF FE 06        	cp DrvKey.keyCaps
2200  07B1 20 05        	jr nz,Interrupts_key3
2201  07B3              	;переключение заглавных
2202  07B3 32 12 2B     	ld (key_caps_lock_switch_flag),a
2203  07B6 18 0E        	jr Interrupts_key_ex
2204  07B8              Interrupts_key3
2205  07B8 FE 0F        	cp DrvKey.keyDelete
2206  07BA 20 03        	jr nz,Interrupts_key4
2207  07BC              	;графическая
2208  07BC 32 13 2B     	ld (key_graph_flag),a
2209  07BF
2210  07BF              Interrupts_key4
2211  07BF FE 12        	cp 18
2212  07C1 20 03        	jr nz,Interrupts_key_ex
2213  07C3              	;sys процесс в фокус
2214  07C3 32 14 2B     	ld (key_sys_focus),a
2215  07C6
2216  07C6
2217  07C6
2218  07C6              Interrupts_key_ex
2219  07C6              	;с клавиатурой всё
2220  07C6
2221  07C6
2222  07C6
2223  07C6
2224  07C6
2225  07C6              ;определить текущие страницы памяти
2226  07C6 01 FD 7A     	ld bc,#7AFD
2227  07C9 ED 78        	in a,(c)
2228  07CB E6 7F        	and %01111111
2229  07CD 32 26 09     	ld (Interrupts_cur_page_slot3),a
2230  07D0 01 FD 78     	ld bc,#78fd
2231  07D3 ED 78        	in a,(c)
2232  07D5 EE 02        	xor %00000010
2233  07D7 32 25 09     	ld (Interrupts_cur_page_slot2),a
2234  07DA
2235  07DA
2236  07DA
2237  07DA
2238  07DA              ;плеер музыки и прочие неотложные процессы
2239  07DA 3A 03 2B     	ld a,(proc_play_ay)
2240  07DD B7           	or a
2241  07DE 28 1B        	jr z,Interrupts_ay_skip
2242  07E0 3A 04 2B     	ld a,(proc_play_ay_slot2) ;страницы с музыкой
2243  07E3 CD AE 0B     	call drvgmx.PageSlot2
2244  07E6 3A 05 2B     	ld a,(proc_play_ay_slot3) ;страницы с музыкой
2245  07E9 CD CD 0A     	call drvgmx.PageSlot3
2246  07EC CD FB 1E     	call VTPL.PLAY ;играть
2247  07EF
2248  07EF
2249  07EF              ;вернуть страницы
2250  07EF 3A 25 09     	ld a,(Interrupts_cur_page_slot2)
2251  07F2 CD AE 0B     	call drvgmx.PageSlot2
2252  07F5 3A 26 09     	ld a,(Interrupts_cur_page_slot3)
2253  07F8 CD CD 0A     	call drvgmx.PageSlot3
2254  07FB
2255  07FB
2256  07FB              Interrupts_ay_skip
2257  07FB
2258  07FB
2259  07FB
2260  07FB
2261  07FB
2262  07FB
2263  07FB
2264  07FB
2265  07FB              ;многозадачность тут
2266  07FB 3A 0F 2B     	ld a,(proc_stack_addr_return_tmp+1) ;узнать адрес откуда были прерывания
2267  07FE FE 40        	cp #40 ;если прерывание было в области пзу, значит работала система
2268  0800 DA A2 08     	jp c,Interrupts_ex ;пропустим переключения на другие задачи
2269  0803
2270  0803              proc_next_wait	;сюда приходит после вызова OS_WAIT, мимо обработки прерывания по INT
2271  0803 CD B8 08     	call proc_next_find
2272  0806              	;jp c,Interrupts_ex ;если процесс один, то на выход
2273  0806
2274  0806              	; push hl ;дескриптор следующего
2275  0806              	; pop ix
2276  0806
2277  0806
2278  0806              	;запомнить стек предыдущего (текущего) процесса
2279  0806 3A 20 2B     	ld a,(proc_id_cur)
2280  0809 21 00 2B     	ld hl,proc_table - 256
2281  080C 84           	add h
2282  080D 67           	ld h,a
2283  080E E5           	push hl
2284  080F FD E1        	pop iy ;дескриптор предыдущего
2285  0811
2286  0811 01 06 00     	ld bc,6
2287  0814 09           	add hl,bc
2288  0815 ED 4B 08 2B  	ld bc,(proc_stack_addr_tmp)
2289  0819 3A 0C 2B     	ld a,(os_wait_flag)
2290  081C B7           	or a
2291  081D 28 08        	jr z,proc_next_wait_no
2292  081F ED 4B 0A 2B  	ld bc,(proc_stack_addr_tmp_wait) ;если в режиме вызова os_wait
2293  0823 AF           	xor a
2294  0824 32 0C 2B     	ld (os_wait_flag),a
2295  0827              proc_next_wait_no
2296  0827 71           	ld (hl),c
2297  0828 23           	inc hl
2298  0829 70           	ld (hl),b
2299  082A
2300  082A              	;запомнить координаты экрана предыдущего
2301  082A 2A EA 0B     	ld hl,(drvgmx.col_screen)
2302  082D FD 75 0A FD  	ld (iy+#0a),hl ;координаты
2302  0831 74 0B
2303  0833
2304  0833 2A EC 0B     	ld hl,(drvgmx.attr_screen)
2305  0836 FD 75 0C FD  	ld (iy+#0c),hl ;атрибуты (цвет текста)
2305  083A 74 0D
2306  083C
2307  083C 2A BE 0A     	ld hl,(drvgmx.curscrl)
2308  083F FD 75 08 FD  	ld (iy+#08),hl ;позиция скрола
2308  0843 74 09
2309  0845
2310  0845
2311  0845
2312  0845              	;следующий
2313  0845 DD 7E 02     	ld a,(ix+2)
2314  0848 32 18 2B     	ld (page_slot2_cur),a ;сделать страницы текущими
2315  084B CD AE 0B     	call drvgmx.PageSlot2
2316  084E DD 7E 03     	ld a,(ix+3)
2317  0851 32 17 2B     	ld (page_slot3_cur),a
2318  0854 CD CD 0A     	call drvgmx.PageSlot3
2319  0857
2320  0857
2321  0857              	;параметры экрана (консоли)
2322  0857 DD 6E 0A DD  	ld hl,(ix+#0a) ;координаты
2322  085B 66 0B
2323  085D 22 EA 0B     	ld (drvgmx.col_screen),hl
2324  0860
2325  0860 DD 6E 0C DD  	ld hl,(ix+#0c) ;атрибуты (цвет текста)
2325  0864 66 0D
2326  0866 22 EC 0B     	ld (drvgmx.attr_screen),hl
2327  0869
2328  0869 DD 6E 08 DD  	ld hl,(ix+#08) ;позиция скрола
2328  086D 66 09
2329  086F 22 BE 0A     	ld (drvgmx.curscrl),hl
2330  0872
2331  0872
2332  0872
2333  0872 3A 07 2B     	ld a,(proc_id_focus) ;если это процесс в фокусе
2334  0875 DD BE 00     	cp (ix)
2335  0878 20 0C        	jr nz,proc_next_no_focus
2336  087A 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
2337  087C 32 19 2B     	ld (con_scr_cur),a
2338  087F 3E 79        	ld a,con_atr_real ;атрибуты реальные
2339  0881 32 1A 2B     	ld (con_atr_cur),a
2340  0884 18 0C        	jr proc_next2
2341  0886              proc_next_no_focus
2342  0886              	;если не в фокусе
2343  0886 DD 7E 04     	ld a,(ix+4) ;пиксели
2344  0889 32 19 2B     	ld (con_scr_cur),a
2345  088C DD 7E 05     	ld a,(ix+5) ;атрибуты
2346  088F 32 1A 2B     	ld (con_atr_cur),a
2347  0892              proc_next2
2348  0892 DD 6E 06     	ld l,(ix+6) ;стек
2349  0895 DD 66 07     	ld h,(ix+7) ;стек
2350  0898 F9           	ld sp,hl
2351  0899
2352  0899 3A 1D 2B     	ld a,(proc_id_next)
2353  089C 32 20 2B     	ld (proc_id_cur),a ;сменить текущий
2354  089F
2355  089F CD B5 0A     	call drvgmx.gmxscroll ;обновить скролл
2356  08A2
2357  08A2              Interrupts_ex
2358  08A2 AF           	xor a
2359  08A3 D3 FE        	out (254),a
2360  08A5 32 01 2B     	ld (Interrupt_new_flag),a ;флаг что было прерывание убрать
2361  08A8 FD E1        	pop iy
2362  08AA DD E1        	pop ix
2363  08AC E1           	pop hl
2364  08AD D1           	pop de
2365  08AE C1           	pop bc
2366  08AF F1           	pop af
2367  08B0 D9           	exx
2368  08B1 08           	ex af,af
2369  08B2 E1           	pop hl
2370  08B3 D1           	pop de
2371  08B4 C1           	pop bc
2372  08B5 F1           	pop af
2373  08B6 FB           	ei
2374  08B7 C9           	ret
2375  08B8
2376  08B8
2377  08B8              	;поиск следующей задачи
2378  08B8              	;вых: hl, ix - дескриптор следующего процесса
2379  08B8              proc_next_find
2380  08B8 3A 01 2B     	ld a,(Interrupt_new_flag) ;флаг только что было прерывание
2381  08BB B7           	or a
2382  08BC 28 14        	jr z,proc_next_find_no_interrupt
2383  08BE              	;тут попытка первым после прерывания запустить процесс в фокусе
2384  08BE 3A 00 2B     	ld a,(proc_next_find_focus_flag)
2385  08C1 B7           	or a
2386  08C2 20 0E        	jr nz,proc_next_find_no_interrupt ;пропустить, если уже запускали недавно, по всем процессам не прошлись
2387  08C4 3A 07 2B     	ld a,(proc_id_focus)
2388  08C7 32 00 2B     	ld (proc_next_find_focus_flag),a ;флаг что процесс в фокусе уже запускали
2389  08CA 32 1D 2B     	ld (proc_id_next),a
2390  08CD CD CE 06     	call get_proc_descr ;получить дескриптор
2391  08D0 B7           	or a
2392  08D1 C9           	ret ;запустить его
2393  08D2
2394  08D2              proc_next_find_no_interrupt
2395  08D2 3A 1D 2B     	ld a,(proc_id_next) ;узнать следующий
2396  08D5              proc_next_find_skip
2397  08D5 3C           	inc a
2398  08D6 FE 09        	cp proc_max+1
2399  08D8 38 02        	jr c,proc_next_find1
2400  08DA 3E 01        	ld a,proc_id_system
2401  08DC              proc_next_find1
2402  08DC 32 1D 2B     	ld (proc_id_next),a
2403  08DF
2404  08DF CD CE 06     	call get_proc_descr ;получить дескриптор
2405  08E2
2406  08E2 DD 7E 00     	ld a,(ix)
2407  08E5 B7           	or a ;нет активного процесса?
2408  08E6 28 D0        	jr z,proc_next_find ;искать дальше
2409  08E8
2410  08E8 3A 07 2B     	ld a,(proc_id_focus)
2411  08EB DD BE 00     	cp (ix)
2412  08EE 20 04        	jr nz,proc_next_find2 ;если не в фокусе
2413  08F0 AF           	xor a ;сбросить флаг, все процессы по кругу прошли
2414  08F1 32 00 2B     	ld (proc_next_find_focus_flag),a
2415  08F4
2416  08F4              proc_next_find2
2417  08F4 DD 7E 00     	ld a,(ix)
2418  08F7 FE 01        	cp 1 ;системный процесс? для него исключение, можно вызывать всегда
2419  08F9 C8           	ret z
2420  08FA
2421  08FA 3A 07 2B     	ld a,(proc_id_focus)
2422  08FD DD BE 00     	cp (ix)	;если в фокусе
2423  0900 28 B6        	jr z,proc_next_find ;искать дальше. потому что для процесса в фокусе отдельный приоритет
2424  0902
2425  0902
2426  0902              	;дополнительные проверки
2427  0902 3A 0D 2B     	ld a,(proc_next_find_skip_flag)
2428  0905 B7           	or a
2429  0906 20 14        	jr nz,proc_next_find_skip_flag_yep ;пропустить дополнительные
2430  0908
2431  0908              	;проверить было ли прерывание, чтобы не вызвать процесс второй раз
2432  0908 DD 7E 1D     	ld a,(ix+#1d) ;флаг вызова os_wait этого процесса
2433  090B B7           	or a
2434  090C 20 AA        	jr nz,proc_next_find ;искать дальше
2435  090E
2436  090E
2437  090E              	;проверить графический режим
2438  090E DD 7E 1C     	ld a,(ix+#1c) ;режим
2439  0911 B7           	or a
2440  0912 28 08        	jr z,proc_next_find_no_graph ;не графический
2441  0914              	;графический
2442  0914 3A 07 2B     	ld a,(proc_id_focus)
2443  0917 DD BE 00     	cp (ix)
2444  091A 20 9C        	jr nz,proc_next_find ;искать дальше, если он не в фокусе
2445  091C
2446  091C              proc_next_find_no_graph
2447  091C
2448  091C              proc_next_find_skip_flag_yep
2449  091C              	;нашли следующий процесс
2450  091C 3A 20 2B     	ld a,(proc_id_cur)
2451  091F BE           	cp (hl) ;если это он и был (всего один процесс)
2452  0920 37           	scf
2453  0921 C8           	ret z
2454  0922 7E           	ld a,(hl) ;или вернуть id слудующего
2455  0923 B7           	or a
2456  0924 C9           	ret
2457  0925
2458  0925 00           Interrupts_cur_page_slot2 db 0 ;временно
2459  0926 00           Interrupts_cur_page_slot3 db 0 ;временно
2460  0927
2461  0927
2462  0927
2463  0927
2464  0927
2465  0927              	include Drv/zsgmx.asm ;драйвер экрана и памяти
# file opened: Drv/zsgmx.asm
   1+ 0927              COLOR=1
   2+ 0927              ;; ZS GMX screen driver (izzx)
   3+ 0927              	define LINE_LIMIT 80
   4+ 0927                  module drvgmx
   5+ 0927              hsize   equ 25 ;всего строк
   6+ 0927              scraddr equ #c000 ;адрес экрана
   7+ 0927              scrsize equ 16000  ;размер экрана
   8+ 0927              scrline equ 80*8   ;размер строки в байтах
   9+ 0927
  10+ 0927              init:
  11+ 0927                  ; ld hl, font_file, b, Dos.FMODE_READ
  12+ 0927                  ; call Dos.fopen
  13+ 0927                  ; push af
  14+ 0927                  ; ld bc, 2048, hl, font
  15+ 0927                  ; call Dos.fread
  16+ 0927                  ; pop af
  17+ 0927                  ; call Dos.fclose
  18+ 0927              	; xor a : out (#fe), a
  19+ 0927              	; call cls
  20+ 0927              	; ret
  21+ 0927 CD 12 0B     	call set_scr39 ;включить экран
  22+ 092A              cls:
  23+ 092A 11 00 00         ld de, 0
  23+ 092D
  24+ 092D ED 53 BE 0A  	ld (curscrl),de ;скролл выключить
  25+ 0931 CD B5 0A     	call gmxscroll
  26+ 0934 11 00 00         ld de, 0
  26+ 0937
  27+ 0937 CD 66 09     	call gotoXY
  28+ 093A                  ;ld a, 7 : call Memory.setPage
  29+ 093A 3A 19 2B     	ld a,(con_scr_cur) ;пиксели
  30+ 093D CD CD 0A     	call PageSlot3 ;включить страницу пикселей
  31+ 0940 AF               xor a
  31+ 0941               ; out (#fe), a
  32+ 0941 21 00 C0 11      ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  32+ 0945 01 C0 01 7F
  32+ 0949 3E 77
  32+ 094B ED B0          ldir ;очистить
  33+ 094D 3A 1A 2B     	ld a,(con_atr_cur) ;атрибуты
  34+ 0950 CD CD 0A     	call PageSlot3 ;включить страницу атрибутов
  35+ 0953 AF           	xor a ;ld a,(attr_screen) ;цвет
  36+ 0954 21 00 C0 11  	ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  36+ 0958 01 C0 01 7F
  36+ 095C 3E 77
  36+ 095E ED B0          ldir ;очистить
  37+ 0960              	;call gmxscron ;включить расширенный экран
  38+ 0960 3A 17 2B     	ld a,(page_slot3_cur)
  39+ 0963 C3 CD 0A     	jp PageSlot3 ;вернуть страницу
  40+ 0966                  ;jp Memory.setPage
  41+ 0966
  42+ 0966
  43+ 0966              ; Set console coordinates
  44+ 0966              ; d = row(0..23), e = column (0..79)
  45+ 0966              gotoXY:
  46+ 0966              	;rr e
  47+ 0966              	; ld a, 0
  48+ 0966              	; ld (half_tile_screen), a
  49+ 0966 7A           	ld a,d ;проверка координаты строки
  50+ 0967 FE 19        	cp hsize
  51+ 0969 D0           	ret nc
  52+ 096A 7B           	ld a,e ;проверка координаты столбца
  53+ 096B FE 50        	cp 80
  54+ 096D D0           	ret nc
  55+ 096E ED 53 EA 0B      ld (col_screen), de
  56+ 0972 C9               ret
  57+ 0973
  58+ 0973              disable:
  59+ 0973                  ; Nothing to disable
  60+ 0973 CD 8B 0A     	call gmxscroff ;выключить расширенный экран
  61+ 0976 C9               ret
  62+ 0977
  63+ 0977              ; H - line
  64+ 0977              ; A - char
  65+ 0977              fillLine: ;заполнение строки одним символом
  66+ 0977 F5               push af
  67+ 0978 54 1E 00         ld d, h, e, 0
  67+ 097B CD 66 09       call gotoXY
  68+ 097E F1               pop af
  69+ 097F 21 F0 0B 11      ld hl, fill_buff, de, fill_buff + 1, bc, 80-1, (hl), a
  69+ 0983 F1 0B 01 4F
  69+ 0987 00 77
  69+ 0989 ED B0          ldir
  70+ 098B 21 F0 0B         ld hl, fill_buff
  70+ 098E C3 D1 09       jp printZ
  71+ 0991
  72+ 0991              paintLine: ;на входе в A номер строки, которую надо покрасить, B - цвет
  73+ 0991 C5           	push bc
  74+ 0992 47               ld b, a
  75+ 0993 0E 00            ld c, 0
  76+ 0995 CD 41 0A         call bc_to_attr
  77+ 0998 E5           	push hl
  78+ 0999 3A 1A 2B     	ld a,(con_atr_cur) ;атрибуты
  79+ 099C CD CD 0A     	call PageSlot3
  80+ 099F E1           	pop hl
  81+ 09A0 C1           	pop bc
  82+ 09A1 78           	ld a,b;цвет
  83+ 09A2 77               ld (hl), a
  84+ 09A3 54 5D            ld de, hl
  85+ 09A5 13               inc de
  86+ 09A6 01 7F 02         ld bc, (80*8)-1
  87+ 09A9 ED B0            ldir
  88+ 09AB 3A 17 2B         ld a,(page_slot3_cur)
  89+ 09AE C3 CD 0A     	jp PageSlot3 ;вернуть страницу
  90+ 09B1
  91+ 09B1
  92+ 09B1              mvCR ;каретка вниз (по коду 13)
  93+ 09B1 ED 5B EA 0B  	ld de, (col_screen)
  94+ 09B5 14           	inc d ;row++
  95+ 09B6 7A           	ld a,d
  96+ 09B7 FE 19        	cp hsize ;последняя строка
  97+ 09B9 38 11        	jr c,mvCR1
  98+ 09BB 3A 19 2B     	ld a,(con_scr_cur) ;пиксели
  99+ 09BE CD CD 0A     	call PageSlot3 ;включить страницу пикселей
 100+ 09C1 CD 93 0A     	call scroll
 101+ 09C4 3A 17 2B     	ld a,(page_slot3_cur)
 102+ 09C7 CD CD 0A     	call PageSlot3 ;вернуть страницу
 103+ 09CA 16 18        	ld d,hsize-1 ;остаться на последне строке
 104+ 09CC              mvCR1
 105+ 09CC 1E 00        	ld e, 0
 106+ 09CE              	; ld a, 0
 107+ 09CE              	; ld (half_tile_screen), a
 108+ 09CE C3 66 09     	jp gotoXY
 109+ 09D1
 110+ 09D1              ; Print just one symbol
 111+ 09D1              ; A - symbol
 112+ 09D1              ; putC
 113+ 09D1               	; ld hl, single_symbol_print ;single_symbol
 114+ 09D1              	; ld (hl), a
 115+ 09D1              	; ;ld a, 7 : call Memory.setPage
 116+ 09D1              	; ; ld a,(con_scr_cur) ;пиксели
 117+ 09D1              	; ; call PageSlot3
 118+ 09D1                  ; ld hl, single_symbol_print
 119+ 09D1                  ; call printL
 120+ 09D1                  ; ld a,(page_slot3_cur)
 121+ 09D1              	; jp PageSlot3 ;вернуть страницу
 122+ 09D1
 123+ 09D1              ; Put string
 124+ 09D1              ; hl - string pointer that's begins from symbol count
 125+ 09D1              printZ
 126+ 09D1 7E               ld a, (hl)
 126+ 09D2 A7             and a
 126+ 09D3 C8             ret z
 127+ 09D4 E5               push hl
 128+ 09D5 CD DC 09         call putC
 129+ 09D8 E1               pop hl
 130+ 09D9 23               inc hl
 131+ 09DA 18 F5            jr printZ
 132+ 09DC
 133+ 09DC              ; printL
 134+ 09DC                      ; ld	a, (hl)
 135+ 09DC              		; and	a
 136+ 09DC              		; ret	z
 137+ 09DC              putC
 138+ 09DC FE 0D        		cp 13
 138+ 09DE CA B1 09       jp z, mvCR
 139+ 09E1 FE 0A        		cp 10
 139+ 09E3 C8            ret z ;пропустить символ
 140+ 09E4
 141+ 09E4 CD 3D 0A     		call calc_addr_scr
 142+ 09E7 54           		ld d,h ;координаты экрана в DE
 143+ 09E8 5D           		ld e,l
 144+ 09E9 6F           		ld	l,a
 145+ 09EA 26 00        		ld	h,0
 146+ 09EC 29           		add	hl,hl
 147+ 09ED 29           		add	hl,hl
 148+ 09EE 29           		add	hl,hl
 149+ 09EF 01 00 23             ld      bc,font
 150+ 09F2 09                   add     hl,bc ;hl - адрес шрифта буквы
 151+ 09F3
 152+ 09F3                      ;push    de
 153+ 09F3
 154+ 09F3 3A 19 2B     	ld a,(con_scr_cur) ;страница пиксели
 155+ 09F6 D9           	exx
 156+ 09F7 CD CD 0A     	call PageSlot3
 157+ 09FA D9           	exx
 158+ 09FB D5           	push de ;сохранить адрес символа на экране
 159+ 09FC
 160+ 09FC 01 FF 08         ld  bc,#08ff
 161+ 09FF              print80_1
 162+ 09FF ED A0        	ldi ;один байт
 163+ 0A01
 164+ 0A01 E5           	push hl ;на строку пикселей вниз
 165+ 0A02 21 4F 00     	ld hl,80-1
 166+ 0A05 19           	add hl,de
 167+ 0A06 EB           	ex de,hl
 168+ 0A07 E1           	pop hl
 169+ 0A08
 170+ 0A08 10 F5        	djnz    print80_1
 171+ 0A0A
 172+ 0A0A
 173+ 0A0A 3A 1A 2B     	ld a,(con_atr_cur) ;страница атрибуты
 174+ 0A0D CD CD 0A     	call PageSlot3
 175+ 0A10
 176+ 0A10 E1           	pop hl ;адрес символа на экране
 177+ 0A11
 178+ 0A11 06 08            ld      b,8
 179+ 0A13 3A EC 0B     	ld a,(attr_screen)
 180+ 0A16 11 50 00     	ld de,80
 181+ 0A19              print80_1_attr ;теперь так же атрибуты
 182+ 0A19
 183+ 0A19 77           	ld (hl),a
 184+ 0A1A 19           	add hl,de
 185+ 0A1B
 186+ 0A1B 10 FC        	djnz    print80_1_attr
 187+ 0A1D
 188+ 0A1D
 189+ 0A1D
 190+ 0A1D              ; move cursor на одну позицию вперёд
 191+ 0A1D              move_cr80
 192+ 0A1D              	;inc	de
 193+ 0A1D
 194+ 0A1D 21 EA 0B     	ld	hl,col_screen
 195+ 0A20 34           	inc	(hl) ;увеличить столбец
 196+ 0A21 7E           	ld	a,(hl)
 197+ 0A22
 198+ 0A22 FE 50        	cp	80
 199+ 0A24 38 10        	jr	c,move_cr80_01 ;на выход
 200+ 0A26
 201+ 0A26 AF           	xor	a
 202+ 0A27              	;ld	(half_tile_screen),a
 203+ 0A27 77           	ld	(hl),a
 204+ 0A28              	;ld	c,a
 205+ 0A28
 206+ 0A28 23           	inc	hl ;на переменную row
 207+ 0A29 34           	inc	(hl)
 208+ 0A2A 7E           	ld	a,(hl)
 209+ 0A2B              	;ld	b,a
 210+ 0A2B
 211+ 0A2B FE 19        	cp	hsize ;всего строк
 212+ 0A2D DA 36 0A     	jp	c,move_cr80_01
 213+ 0A30
 214+ 0A30 3E 18        	ld	a,hsize-1
 215+ 0A32 77           	ld	(hl),a
 216+ 0A33              	;ld	b,a
 217+ 0A33
 218+ 0A33 CD 93 0A     	call scroll ;сдвиг вверх
 219+ 0A36              	; push	bc
 220+ 0A36              	; call	scroll_up8
 221+ 0A36              	; pop	bc
 222+ 0A36
 223+ 0A36              move_cr80_01
 224+ 0A36              	; call	calc_addr_scr
 225+ 0A36 3A 17 2B     	ld a,(page_slot3_cur)
 226+ 0A39 C3 CD 0A     	jp PageSlot3 ;вернуть страницу
 227+ 0A3C C9           	ret
 228+ 0A3D
 229+ 0A3D              calc_addr_scr	;определение адреса экрана по координатам символа
 230+ 0A3D ED 4B EA 0B  	ld	bc,(col_screen)
 231+ 0A41              bc_to_attr:
 232+ 0A41 26 00        	ld h,0
 233+ 0A43 68           	ld l,b ;строка
 234+ 0A44 29           	add hl,hl ;*2
 235+ 0A45 11 B6 0B     	ld de,table_addr_scr
 236+ 0A48 19           	add hl,de
 237+ 0A49 5E           	ld e,(hl)
 238+ 0A4A 23           	inc hl
 239+ 0A4B 56           	ld d,(hl) ;узнали координаты строки
 240+ 0A4C 26 00        	ld h,0
 241+ 0A4E 69           	ld l,c ;колонка
 242+ 0A4F 19           	add hl,de ;узнали адрес символа
 243+ 0A50
 244+ 0A50 ED 5B BE 0A  	ld de,(curscrl) ;добавить аппаратный скрол
 245+ 0A54 19           	add hl,de
 246+ 0A55 11 80 3E     	ld de,scrsize
 247+ 0A58 A7           	and a		;check over
 248+ 0A59 ED 52        	sbc hl,de
 249+ 0A5B 30 01        	jr nc,calc02
 250+ 0A5D 19           	add hl,de
 251+ 0A5E              calc02:
 252+ 0A5E 11 00 C0     	ld de,scraddr  ;screen
 253+ 0A61 19           	add hl,de
 254+ 0A62
 255+ 0A62              	; ld      a,b
 256+ 0A62              	; ld      d,a
 257+ 0A62              	; rrca
 258+ 0A62              	; rrca
 259+ 0A62              	; rrca
 260+ 0A62              	; and     a,224
 261+ 0A62              	; add     a,c
 262+ 0A62              	; ld      e,a
 263+ 0A62              	; ld      a,d
 264+ 0A62              	; and     24
 265+ 0A62              	; or      #c0
 266+ 0A62              	; ld      d,a
 267+ 0A62 C9           	ret
 268+ 0A63
 269+ 0A63
 270+ 0A63
 271+ 0A63              clear_line ;очистить строку
 272+ 0A63                  ;ld b, hsize-1 ;последняя
 273+ 0A63                  ;ld c, 0
 274+ 0A63 CD 41 0A         call bc_to_attr ;узнать адрес
 275+ 0A66 E5           	push hl
 276+ 0A67 54           	ld d,h
 277+ 0A68 5D           	ld e,l
 278+ 0A69 13           	inc de
 279+ 0A6A 01 7F 02     	ld bc,scrline-1
 280+ 0A6D 36 00        	ld (hl),0
 281+ 0A6F ED B0        	ldir
 282+ 0A71 3A 1A 2B     	ld a,(con_atr_cur) ;теперь страница атрибутов
 283+ 0A74 CD CD 0A     	call PageSlot3 ;
 284+ 0A77 E1           	pop hl
 285+ 0A78 54           	ld d,h
 286+ 0A79 5D           	ld e,l
 287+ 0A7A 13           	inc de
 288+ 0A7B 01 7F 02     	ld bc,scrline-1
 289+ 0A7E              	;ld a,(con_atr_cur) ;атрибуты
 290+ 0A7E 36 00        	ld (hl),0
 291+ 0A80 ED B0        	ldir
 292+ 0A82 C9           	ret
 293+ 0A83
 294+ 0A83              gmxscron
 295+ 0A83 01 FD 7E                 ld      bc,#7efd
 296+ 0A86 3E C8                    ld      a,#c8
 297+ 0A88 ED 79                    out     (c),a
 298+ 0A8A                          ; ld      bc,#7ffd
 299+ 0A8A                          ; ld      a,#10    ;5 screen
 300+ 0A8A                          ; out     (c),a
 301+ 0A8A C9                       ret
 302+ 0A8B
 303+ 0A8B              ; gmxscron2
 304+ 0A8B                          ; ld      bc,#7efd
 305+ 0A8B                          ; ld      a,#c8
 306+ 0A8B                          ; out     (c),a
 307+ 0A8B                          ; ld      bc,#7ffd
 308+ 0A8B                          ; ld      a,#18    ;7 screen
 309+ 0A8B                          ; out     (c),a
 310+ 0A8B                          ; ret
 311+ 0A8B
 312+ 0A8B              gmxscroff
 313+ 0A8B 01 FD 7E                 ld      bc,#7efd
 314+ 0A8E 3E C0                    ld      a,#c0
 315+ 0A90 ED 79                    out     (c),a
 316+ 0A92                          ; ld      bc,#7ffd
 317+ 0A92                          ; ld      a,#10    ;5 screen
 318+ 0A92                          ; out     (c),a
 319+ 0A92 C9                       ret
 320+ 0A93
 321+ 0A93
 322+ 0A93
 323+ 0A93
 324+ 0A93
 325+ 0A93
 326+ 0A93              scroll: ;push hl         ; скpолл экpана на стpоку ввеpх
 327+ 0A93 2A BE 0A     	ld hl,(curscrl)	;hard scroll
 328+ 0A96 11 80 02     	ld de,scrline
 329+ 0A99 19           	add hl,de	;next line
 330+ 0A9A 11 80 3E     	ld de,scrsize	;chek over 16000
 331+ 0A9D A7           	and a
 332+ 0A9E ED 52        	sbc hl,de
 333+ 0AA0 30 03        	jr nc,scrollchek
 334+ 0AA2 19           	add hl,de
 335+ 0AA3 18 03        	jr scrollchek1
 336+ 0AA5              scrollchek:
 337+ 0AA5 21 00 00     	ld hl,0
 338+ 0AA8              scrollchek1:
 339+ 0AA8 22 BE 0A     	ld (curscrl),hl
 340+ 0AAB CD B5 0A     	call gmxscroll
 341+ 0AAE
 342+ 0AAE 06 18            ld b,hsize-1    ;last line
 343+ 0AB0 0E 00        	ld c,0
 344+ 0AB2                  ;ld a,(attr_screen) ;цвет
 345+ 0AB2 C3 63 0A         jp clear_line      ; очистка последней стpоки
 346+ 0AB5                  ;ret
 347+ 0AB5               ;аппаратный скрол вверх
 348+ 0AB5              gmxscroll:
 349+ 0AB5              ;set hard scroll
 350+ 0AB5              ;in:
 351+ 0AB5              ;out:
 352+ 0AB5              	;push af
 353+ 0AB5              	;push bc
 354+ 0AB5              	;push de
 355+ 0AB5 21 20 2B     	ld hl,proc_id_cur
 356+ 0AB8 3A 07 2B     	ld a,(proc_id_focus)
 357+ 0ABB BE           	cp (hl)
 358+ 0ABC C0           	ret nz ;скрол меняем только когда в фокусе
 359+ 0ABD
 360+ 0ABD 11 00 00     	ld de,0
 361+ 0AC0              curscrl equ $-2 ;current hard scroll (0-15999)
 362+ 0AC0 01 FD 7A     	ld bc,07AFDh
 363+ 0AC3 7B           	ld a,e
 364+ 0AC4 ED 79        	out (c),a
 365+ 0AC6 01 FD 7C     	ld bc,07CFDh
 366+ 0AC9 7A           	ld a,d
 367+ 0ACA ED 79        	out (c),a
 368+ 0ACC              	;pop de
 369+ 0ACC              	;pop bc
 370+ 0ACC              	;pop af
 371+ 0ACC C9           	ret
 372+ 0ACD
 373+ 0ACD
 374+ 0ACD
 375+ 0ACD
 376+ 0ACD
 377+ 0ACD              PageSlot3
 378+ 0ACD              ; драйвер памяти Scorpion GMX 2Mb
 379+ 0ACD
 380+ 0ACD                       ;push hl
 381+ 0ACD                       ; ld   hl,page_table
 382+ 0ACD                       ; add  a,l
 383+ 0ACD                       ; jr   nc,PageSlot3_1
 384+ 0ACD                       ; inc  h          ;коррекция
 385+ 0ACD              ; PageSlot3_1  ld   l,a
 386+ 0ACD                       ; ld   a,(hl)
 387+ 0ACD                       ;pop  hl
 388+ 0ACD                       ;cp   #ff
 389+ 0ACD                       ;scf
 390+ 0ACD                       ;ret  z
 391+ 0ACD                       ;push bc
 392+ 0ACD F5                    push af
 393+ 0ACE 07                    rlca
 394+ 0ACF E6 10        		 and #10
 395+ 0AD1 F6 01                 or  #01  ;выбор ОЗУ вместо ПЗУ
 396+ 0AD3 01 FD 1F              ld   bc,#1ffd
 397+ 0AD6              PageSlot3DOS
 398+ 0AD6              		 ;or #00 ; #04 тут выбор ПЗУ TRDOS
 399+ 0AD6 ED 79                 out  (c),a
 400+ 0AD8 F1                    pop  af
 401+ 0AD9 F5                    push af
 402+ 0ADA E6 07                 and  #07
 403+ 0ADC              PageSlot3Scr ;тут выбор экрана и ПЗУ
 404+ 0ADC F6 10                 or   #10 ;#0 ;#18
 405+ 0ADE 06 7F                 ld   b,#7f
 406+ 0AE0 ED 79                 out  (c),a
 407+ 0AE2 F1                    pop  af
 408+ 0AE3 0F                    rrca
 409+ 0AE4 0F                    rrca
 410+ 0AE5 0F                    rrca
 411+ 0AE6 0F                    rrca
 412+ 0AE7 E6 07                 and  #07
 413+ 0AE9 06 DF                 ld   b,#df
 414+ 0AEB ED 79                 out  (c),a
 415+ 0AED                       ;pop  hl
 416+ 0AED C9                    ret
 417+ 0AEE
 418+ 0AEE              set_color
 419+ 0AEE 32 EC 0B     		ld (attr_screen),a
 420+ 0AF1 78           		ld a,b
 421+ 0AF2 32 ED 0B     		ld (attr_screen2),a
 422+ 0AF5 C9           		ret
 423+ 0AF6
 424+ 0AF6              set_scr5 ;включить экран 5
 425+ 0AF6 CD 8B 0A     		call gmxscroff ;выключить расширенный
 426+ 0AF9 3E 10        		ld a,#10
 427+ 0AFB 32 DD 0A     		ld (PageSlot3Scr+1),a
 428+ 0AFE 3A 17 2B     		ld a,(page_slot3_cur)
 429+ 0B01 C3 CD 0A     		jp PageSlot3
 430+ 0B04
 431+ 0B04
 432+ 0B04              set_scr7 ;включить экран 7
 433+ 0B04 CD 8B 0A     		call gmxscroff ;выключить расширенный
 434+ 0B07 3E 18        		ld a,#18
 435+ 0B09 32 DD 0A     		ld (PageSlot3Scr+1),a
 436+ 0B0C 3A 17 2B     		ld a,(page_slot3_cur)
 437+ 0B0F C3 CD 0A     		jp PageSlot3
 438+ 0B12
 439+ 0B12
 440+ 0B12              set_scr39 ;включить экран 39
 441+ 0B12 CD 83 0A     		call gmxscron ;выключить расширенный
 442+ 0B15 3E 10        		ld a,#10
 443+ 0B17 32 DD 0A     		ld (PageSlot3Scr+1),a
 444+ 0B1A 3A 17 2B     		ld a,(page_slot3_cur)
 445+ 0B1D C3 CD 0A     		jp PageSlot3
 446+ 0B20
 447+ 0B20
 448+ 0B20              set_scr3a ;включить экран 3b
 449+ 0B20 CD 83 0A     		call gmxscron ;выключить расширенный
 450+ 0B23 3E 18        		ld a,#18
 451+ 0B25 32 DD 0A     		ld (PageSlot3Scr+1),a
 452+ 0B28 3A 17 2B     		ld a,(page_slot3_cur)
 453+ 0B2B C3 CD 0A     		jp PageSlot3
 454+ 0B2E
 455+ 0B2E
 456+ 0B2E
 457+ 0B2E
 458+ 0B2E
 459+ 0B2E
 460+ 0B2E              ;Таблица страниц кроме #00-#07, #39, #3a, #77-7F
 461+ 0B2E              page_table    ;db   #00,#01,#02,#03,#04,#05,#06,#07,
 462+ 0B2E 08 09        		 db	  #08,#09
 463+ 0B30 0A 0B 0C 0D           db   #0a,#0b,#0c,#0d,#0e
 463+ 0B34 0E
 464+ 0B35 0F 10 11 12           db   #0f,#10,#11,#12,#13,#14
 464+ 0B39 13 14
 465+ 0B3B 15 16 17 18           db   #15,#16,#17,#18,#19,#1a
 465+ 0B3F 19 1A
 466+ 0B41 1B 1C 1D 1E           db   #1b,#1c,#1d,#1e,#1f,#20
 466+ 0B45 1F 20
 467+ 0B47 21 22 23 24           db   #21,#22,#23,#24,#25,#26
 467+ 0B4B 25 26
 468+ 0B4D 27 28 29 2A           db   #27,#28,#29,#2a,#2b,#2c
 468+ 0B51 2B 2C
 469+ 0B53 2D 2E 2F 30           db   #2d,#2e,#2f,#30,#31,#32
 469+ 0B57 31 32
 470+ 0B59 33 34 35 36           db   #33,#34,#35,#36,#37,#38
 470+ 0B5D 37 38
 471+ 0B5F 3B 3C 3D 3E           db   #3b,#3c,#3d,#3e,#3f,#40
 471+ 0B63 3F 40
 472+ 0B65 41 42 43 44           db   #41,#42,#43,#44,#45,#46
 472+ 0B69 45 46
 473+ 0B6B 47 48 49 4A           db   #47,#48,#49,#4a,#4b,#4c
 473+ 0B6F 4B 4C
 474+ 0B71
 475+ 0B71 4D 4E 4F 50           db   #4d,#4e,#4f,#50,#51,#52
 475+ 0B75 51 52
 476+ 0B77 53 54 55 56           db   #53,#54,#55,#56,#57,#58
 476+ 0B7B 57 58
 477+ 0B7D 59 5A 5B 5C           db   #59,#5a,#5b,#5c,#5d,#5e
 477+ 0B81 5D 5E
 478+ 0B83 5F 60 61 62           db   #5f,#60,#61,#62,#63,#64
 478+ 0B87 63 64
 479+ 0B89 65 66 67 68           db   #65,#66,#67,#68,#69,#6a
 479+ 0B8D 69 6A
 480+ 0B8F 6B 6C 6D 6E           db   #6b,#6c,#6d,#6e,#6f,#70
 480+ 0B93 6F 70
 481+ 0B95 71 72 73 74           db   #71,#72,#73,#74,#75,#76
 481+ 0B99 75 76
 482+ 0B9B                       ;db   #77,#78,#79,#7a,#7b,#7c,#7d,#7e
 483+ 0B9B                       ;db   #7f
 484+ 0B9B              page_table_end
 485+ 0B9B 00 00 00...           ds 128-(page_table_end-page_table) ;забить остаток нулями
 486+ 0BAE
 487+ 0BAE
 488+ 0BAE
 489+ 0BAE              ;font equ #4000 ; Using ZX-Spectrum screen as font buffer
 490+ 0BAE              ;font_file db "data/font.bin", 0
 491+ 0BAE
 492+ 0BAE              PageSlot2 ;включение банка из A в слот памяти 2
 493+ 0BAE EE 02        	xor 2
 494+ 0BB0 01 FD 78     	ld bc,#78fd
 495+ 0BB3 ED 79        	out (c),a
 496+ 0BB5 C9           	ret
 497+ 0BB6
 498+ 0BB6
 499+ 0BB6              table_addr_scr	;адреса строк текста
 500+ 0BB6 00 00        	defw	00000h ;0
 501+ 0BB8 80 02        	defw	00280h
 502+ 0BBA 00 05        	defw	00500h
 503+ 0BBC 80 07        	defw	00780h
 504+ 0BBE 00 0A        	defw	00a00h
 505+ 0BC0 80 0C        	defw	00c80h
 506+ 0BC2 00 0F        	defw	00f00h
 507+ 0BC4 80 11        	defw	01180h
 508+ 0BC6
 509+ 0BC6 00 14        	defw	01400h ;8
 510+ 0BC8 80 16        	defw	01680h
 511+ 0BCA 00 19        	defw	01900h
 512+ 0BCC 80 1B        	defw	01b80h
 513+ 0BCE 00 1E        	defw	01e00h
 514+ 0BD0 80 20        	defw	02080h
 515+ 0BD2 00 23        	defw	02300h
 516+ 0BD4 80 25        	defw	02580h
 517+ 0BD6
 518+ 0BD6 00 28        	defw	02800h ;16
 519+ 0BD8 80 2A        	defw	02a80h
 520+ 0BDA 00 2D        	defw	02d00h
 521+ 0BDC 80 2F        	defw	02f80h
 522+ 0BDE 00 32        	defw	03200h
 523+ 0BE0 80 34        	defw	03480h
 524+ 0BE2 00 37        	defw	03700h
 525+ 0BE4 80 39        	defw	03980h
 526+ 0BE6
 527+ 0BE6 00 3C        	defw	03c00h ;24
 528+ 0BE8 80 3E        	defw	03e80h ;25 вне экрана
 529+ 0BEA
 530+ 0BEA
 531+ 0BEA 00           col_screen			db	0	;столбец
 532+ 0BEB 00           row_screen			db	0	;строка
 533+ 0BEC              ;half_tile_screen	db	0
 534+ 0BEC 07           attr_screen			db	07	;основной цвет
 535+ 0BED 0C           attr_screen2		db	#c	;второй цвет
 536+ 0BEE
 537+ 0BEE
 538+ 0BEE              ;col_screen_temp			dw	0
 539+ 0BEE              ;half_tile_screen_temp	db	0
 540+ 0BEE
 541+ 0BEE 01           single_symbol_print db 1
 542+ 0BEF 00           single_symbol 		db 0
 543+ 0BF0
 544+ 0BF0 00 00 00...  fill_buff ds 80+1
 545+ 0C41
 546+ 0C41                  endmodule
# file closed: Drv/zsgmx.asm
2466  0C41              	include Drv/zsfat.asm ;драйвер диска
# file opened: Drv/zsfat.asm
   1+ 0C41              ;trdos & fat32 driver (izzx)
   2+ 0C41                  MODULE Dos
   3+ 0C41              ; API methods - для всех процессов
   4+ 0C41              ;ESX_GETSETDRV = #89
   5+ 0C41              ;ESX_FOPEN = #9A
   6+ 0C41              ;ESX_FCLOSE = #9B
   7+ 0C41              ;ESX_FSYNC = #9C
   8+ 0C41              ;ESX_FREAD = #9D
   9+ 0C41              ;ESX_FWRITE = #9E
  10+ 0C41
  11+ 0C41              ; File modes
  12+ 0C41              FMODE_READ = #01
  13+ 0C41              ;FMODE_WRITE = #06
  14+ 0C41              FMODE_CREATE = #0E
  15+ 0C41
  16+ 0C41                  ; MACRO esxCall func
  17+ 0C41                  ; rst #8 : db func
  18+ 0C41                  ; ENDM
  19+ 0C41
  20+ 0C41              ;макросы только для внутренней работы самого модуля через BIOS
  21+ 0C41              ;
  22+ 0C41              ;R8DOS			вызов функции R8DOS
  23+ 0C41              ;R8FAT			вызов функции R8FAT
  24+ 0C41              ;R8DOSc			вызов функции R8DOS
  25+ 0C41              ;
  26+ 0C41              ;------------------------------------------------------------------------------
  27+ 0C41              ;вызов функции R8DOS
  28+ 0C41              ;вх: =0 номер функции
  29+ 0C41              ;
  30+ 0C41              	MACRO	R8DOS nFunc
  31+ 0C41 ~            	ld	c,nFunc
  32+ 0C41 ~            	rst	#08
  33+ 0C41 ~            	db	#81
  34+ 0C41              	ENDM
  35+ 0C41
  36+ 0C41              ;------------------------------------------------------------------------------
  37+ 0C41              ;вызов функции R8FAT
  38+ 0C41              ;вх: =0 номер функции
  39+ 0C41              ;
  40+ 0C41              	MACRO	R8FAT nFunc
  41+ 0C41 ~            	ld	c,nFunc
  42+ 0C41 ~            	rst	#08
  43+ 0C41 ~            	db	#91
  44+ 0C41              	ENDM
  45+ 0C41
  46+ 0C41              ;------------------------------------------------------------------------------
  47+ 0C41              ;вызов функции R8DOS
  48+ 0C41              ;вх: c - номер функции
  49+ 0C41              ;
  50+ 0C41              	MACRO	R8DOSc
  51+ 0C41 ~            	rst	#08
  52+ 0C41 ~            	db	#81
  53+ 0C41              	ENDM
  54+ 0C41
  55+ 0C41              ;------------------------------------------------------------------------------
  56+ 0C41              ;вызов функции #02 (FileMan) R8CONF
  57+ 0C41              ;вх: =#00 - номер функции файл менеджера
  58+ 0C41              ;
  59+ 0C41              	MACRO	R8C02FM nFunct
  60+ 0C41 ~            	ld	bc,#100*nFunct+#02
  61+ 0C41 ~            	rst	#08
  62+ 0C41 ~            	db	#8E
  63+ 0C41              	ENDM
  64+ 0C41
  65+ 0C41              ;==============================================================================
  66+ 0C41              r8f00_DeinitFAT		equ #00 ;деинициализация переменных раздела FAT
  67+ 0C41              r8f01_InitFAT		equ #01 ;инициализация переменных раздела FAT, если он еще не инициализирован
  68+ 0C41              r8f02_ReadDIR		equ #02 ;чтение секторов текущего каталога
  69+ 0C41              r8f03_SetRoot		equ #03 ;установка корневого каталога текущим
  70+ 0C41              r8f04_FindPath		equ #04 ;поиск файла по заданному пути в текущем каталоге со входом в подкаталоги с проверкой синтаксиса (с установкой найденного каталога текущим)
  71+ 0C41              r8f05_OpenDir		equ #05 ;вход в каталог/выход в родительский каталог
  72+ 0C41
  73+ 0C41              r8f07_FileOpen		equ #07 ;открыть файл для последующих операций с ним
  74+ 0C41              r8f08_FileRead		equ #08	;чтение данных из файла в память
  75+ 0C41              r8f09_FileWrite		equ #09	;запись данных из памяти в файл
  76+ 0C41
  77+ 0C41              r8f0E_CreateFileLFN	equ #0E ;создание файла с длинным именем в текущем каталоге
  78+ 0C41              r8f0F_CreateFileSFN	equ #0F ;создание файла с именем 8+3 в текущем каталоге	в fcb должны быть установлены: fcbName, fcbExt, fcbSize
  79+ 0C41              r8f13_GetPath 		equ #13 ;получение текущего пути
  80+ 0C41              r8f14_GetLFN		equ #14 ;получение длинного имени файла
  81+ 0C41
  82+ 0C41              r8d2D_FindPart		equ #2D ;поиск разделов FAT32 и MFS на текущем винчестере
  83+ 0C41              r8d2E_CngHDD		equ #2E ;смена текущего винчестера
  84+ 0C41
  85+ 0C41              ;конец макросов BIOS
  86+ 0C41
  87+ 0C41              files_fat_max equ 8 ;максимальное число открытых файлов fat
  88+ 0C41              files_trd_max equ 8 ;максимальное число открытых файлов trd
  89+ 0C41              fcb_fat_size equ 32 ;размер дискриптора fcb
  90+ 0C41
  91+ 0C41
  92+ 0C41
  93+ 0C41              ; Returns:
  94+ 0C41              ;  A - current drive
  95+ 0C41              ; getDefaultDrive: ;нигде не используется
  96+ 0C41                  ; ld a, 0 : esxCall ESX_GETSETDRV
  97+ 0C41                  ; ret
  98+ 0C41
  99+ 0C41
 100+ 0C41
 101+ 0C41              ; Opens file on default drive
 102+ 0C41              ; B - File mode
 103+ 0C41              ; HL - File name
 104+ 0C41              ; Returns:
 105+ 0C41              ;  A - file stream id
 106+ 0C41              ; DE, BC - File size
 107+ 0C41              ; IX - fcb
 108+ 0C41              ; fopen:
 109+ 0C41                  ; ; push bc : push hl
 110+ 0C41                  ; ; call getDefaultDrive
 111+ 0C41                  ; ; pop ix : pop bc
 112+ 0C41                  ; ; esxCall ESX_FOPEN
 113+ 0C41                  ; ; ret
 114+ 0C41              	; ld a,b
 115+ 0C41              	; cp FMODE_READ ;если режим открытие файла
 116+ 0C41              	; jr z,fopen_r
 117+ 0C41              	; cp FMODE_CREATE
 118+ 0C41              	; jr z,fopen_c ;если режим создание файла
 119+ 0C41              	; jp file_error ;иначе выход
 120+ 0C41
 121+ 0C41
 122+ 0C41              fopen_r	;открытие существующего файла на чтение
 123+ 0C41
 124+ 0C41 CD 87 0C     	call fopen_prep
 125+ 0C44 DA 88 0D     	jp 	c,file_error
 126+ 0C47
 127+ 0C47 32 7B 0F     	ld (file_fat_id_cur),a
 128+ 0C4A
 129+ 0C4A              	;сначала сделаем текущей папку активного приложения
 130+ 0C4A D9           	exx
 131+ 0C4B 3A 20 2B     	ld a,(proc_id_cur)
 132+ 0C4E CD 86 0E     	call calc_dir_deskr
 133+ 0C51 EB           	ex de,hl
 134+ 0C52 21 00 00     	ld hl,0
 135+ 0C55                  ; hl - адрес пути (=#0000 - путь отсутствует)
 136+ 0C55                  ; de - адрес дескриптора директории/файла
 137+ 0C55              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 137+ 0C55 0E 05       >	ld	c,r8f05_OpenDir
 137+ 0C57 CF          >	rst	#08
 137+ 0C58 91          >	db	#91
 138+ 0C59 D9           	exx
 139+ 0C5A
 140+ 0C5A              	;ld a,(file_fat_id_cur)
 141+ 0C5A              	R8FAT r8f07_FileOpen ;открыть
 141+ 0C5A 0E 07       >	ld	c,r8f07_FileOpen
 141+ 0C5C CF          >	rst	#08
 141+ 0C5D 91          >	db	#91
 142+ 0C5E DA 88 0D     	jp 	c,file_error
 143+ 0C61
 144+ 0C61
 145+ 0C61 C3 94 0C     	jp fopen_ex
 146+ 0C64
 147+ 0C64
 148+ 0C64              fopen_c	;создание нового файла
 149+ 0C64
 150+ 0C64 CD 87 0C     	call fopen_prep
 151+ 0C67 DA 88 0D     	jp 	c,file_error
 152+ 0C6A
 153+ 0C6A
 154+ 0C6A 32 7B 0F     	ld (file_fat_id_cur),a
 155+ 0C6D
 156+ 0C6D              	;сначала сделаем текущей папку активного приложения
 157+ 0C6D D9           	exx
 158+ 0C6E 3A 20 2B     	ld a,(proc_id_cur)
 159+ 0C71 CD 86 0E     	call calc_dir_deskr
 160+ 0C74 EB           	ex de,hl
 161+ 0C75 21 00 00     	ld hl,0
 162+ 0C78                  ; hl - адрес пути (=#0000 - путь отсутствует)
 163+ 0C78                  ; de - адрес дескриптора директории/файла
 164+ 0C78              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 164+ 0C78 0E 05       >	ld	c,r8f05_OpenDir
 164+ 0C7A CF          >	rst	#08
 164+ 0C7B 91          >	db	#91
 165+ 0C7C D9           	exx
 166+ 0C7D
 167+ 0C7D              	;ld a,(file_fat_id_cur)
 168+ 0C7D              	R8FAT	r8f0E_CreateFileLFN	;создание файла
 168+ 0C7D 0E 0E       >	ld	c,r8f0E_CreateFileLFN
 168+ 0C7F CF          >	rst	#08
 168+ 0C80 91          >	db	#91
 169+ 0C81 DA 88 0D     	jp 	c,file_error
 170+ 0C84
 171+ 0C84 C3 94 0C     	jp fopen_ex
 172+ 0C87
 173+ 0C87
 174+ 0C87              fopen_prep ;проверка перед открытием файла
 175+ 0C87 3A 27 10     	ld a,(fs_fat_init_flag)
 176+ 0C8A B7           	or a
 177+ 0C8B 37           	scf
 178+ 0C8C C8           	ret z
 179+ 0C8D
 180+ 0C8D E5           	push hl
 181+ 0C8E CD 41 0F     	call find_empty_fcb_fat ;какой fcb свободен?
 182+ 0C91 EB           	ex de,hl ;fcb in de
 183+ 0C92 E1           	pop hl
 184+ 0C93 C9           	ret ;выйти с флагом
 185+ 0C94
 186+ 0C94
 187+ 0C94              fopen_ex
 188+ 0C94              	;успешно создали/открыли
 189+ 0C94 D5           	push de
 190+ 0C95 DD E1        	pop ix ;вернуть fcb
 191+ 0C97 21 6B 11     	ld hl,fcb_fat_table
 192+ 0C9A 3A 7B 0F     	ld a,(file_fat_id_cur)
 193+ 0C9D 4F           	ld c,a
 194+ 0C9E 06 00        	ld b,0
 195+ 0CA0 09           	add hl,bc
 196+ 0CA1 3A 20 2B     	ld a,(proc_id_cur)
 197+ 0CA4 77           	ld (hl),a ;флаг что файл открыт (id текущего процесса)
 198+ 0CA5
 199+ 0CA5              	;вернуть размер файла
 200+ 0CA5 DD 4E 14     	ld	c,(ix+#14) ;младшие байты длины
 201+ 0CA8 DD 46 15     	ld	b,(ix+#15)
 202+ 0CAB
 203+ 0CAB DD 5E 16     	ld	e,(ix+#16) ;старшие байты длины
 204+ 0CAE DD 56 17     	ld  d,(ix+#17)
 205+ 0CB1
 206+ 0CB1 3A 7B 0F     	ld a,(file_fat_id_cur) ;вернуть id
 207+ 0CB4 B7           	or a
 208+ 0CB5 C9           	ret
 209+ 0CB6
 210+ 0CB6
 211+ 0CB6
 212+ 0CB6
 213+ 0CB6              init_fs_fat	;инициализация файловой системы
 214+ 0CB6              	; ld a,(fs_fat_init_flag) ;если в первый раз
 215+ 0CB6              	; or a
 216+ 0CB6              	; jr nz,init_fs_fat2
 217+ 0CB6 AF           	xor a
 218+ 0CB7 32 27 10     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 219+ 0CBA 3E 04        	ld a,4 ;номер дисковода по умолчанию E
 220+ 0CBC 32 E4 0E     	ld (fs_drive_number_cur),a
 221+ 0CBF CD F4 0E     	call GetNumPart ;узнаем какая буква последняя, сколько разделов FAT
 222+ 0CC2 30 0B        	jr nc,init_fs_fat_prn2
 223+ 0CC4 B7           	or a
 224+ 0CC5 20 08        	jr nz,init_fs_fat_prn2
 225+ 0CC7 21 9D 0F     	ld hl,msg_fat_not_found
 226+ 0CCA CD D1 09     	call drvgmx.printZ
 227+ 0CCD 37           	scf ;ошибка
 228+ 0CCE C9           	ret
 229+ 0CCF
 230+ 0CCF
 231+ 0CCF              init_fs_fat_prn2
 232+ 0CCF              	;печать списка разделов
 233+ 0CCF 21 7D 0F     	ld hl,msg_fat_found
 234+ 0CD2 CD D1 09     	call drvgmx.printZ
 235+ 0CD5 21 E5 0E     	ld hl,typeDrive
 236+ 0CD8 3A F2 0E     	ld a,(numDrives)
 237+ 0CDB 47           	ld b,a ;цикл по количеству разделов
 238+ 0CDC 0E 45        	ld c,"E" ;первая буква диска FAT
 239+ 0CDE              init_fs_fat_prn1
 240+ 0CDE C5           	push bc
 241+ 0CDF E5           	push hl
 242+ 0CE0 79           	ld a,c ;имя диска
 243+ 0CE1 CD DC 09     	call drvgmx.putC
 244+ 0CE4 3E 3A        	ld a,":" ;
 245+ 0CE6 CD DC 09     	call drvgmx.putC
 246+ 0CE9              	;тип S или H
 247+ 0CE9 3E 48        	ld a,"H"
 248+ 0CEB E1           	pop hl
 249+ 0CEC E5           	push hl
 250+ 0CED CB 5E        	bit 3,(hl) ;SD?
 251+ 0CEF 28 02        	jr z,init_fs_fat_prn3
 252+ 0CF1 3E 53        	ld a,"S"
 253+ 0CF3              init_fs_fat_prn3
 254+ 0CF3 CD DC 09     	call drvgmx.putC ;первая буква
 255+ 0CF6 3E 44        	ld a,"D"
 256+ 0CF8 CD DC 09     	call drvgmx.putC ;вторая буква
 257+ 0CFB              	;номер диска
 258+ 0CFB E1           	pop hl
 259+ 0CFC E5           	push hl
 260+ 0CFD 7E           	ld a,(hl)
 261+ 0CFE E6 04        	and %00000100
 262+ 0D00 0F           	rrca
 263+ 0D01 0F           	rrca
 264+ 0D02 C6 30        	add "0"
 265+ 0D04 CD DC 09     	call drvgmx.putC ;номер диска
 266+ 0D07              	;номер раздела
 267+ 0D07 3E 2C        	ld a,","
 268+ 0D09 CD DC 09     	call drvgmx.putC ;разделитель
 269+ 0D0C E1           	pop hl
 270+ 0D0D E5           	push hl
 271+ 0D0E 7E           	ld a,(hl)
 272+ 0D0F E6 03        	and %00000011
 273+ 0D11 C6 30        	add "0"
 274+ 0D13 CD DC 09     	call drvgmx.putC ;номер раздела
 275+ 0D16 3E 0D        	ld a,13 ;новая строка
 276+ 0D18 CD DC 09     	call drvgmx.putC
 277+ 0D1B E1           	pop hl
 278+ 0D1C 23           	inc hl
 279+ 0D1D C1           	pop bc
 280+ 0D1E 0C           	inc c
 281+ 0D1F 10 BD        	djnz init_fs_fat_prn1
 282+ 0D21
 283+ 0D21
 284+ 0D21              	;поиск системы и выбор диска
 285+ 0D21 3A F2 0E     	ld a,(numDrives)
 286+ 0D24 DD 6F        	ld ixl,a ;цикл по количеству разделов
 287+ 0D26 3A E4 0E     	ld a,(fs_drive_number_cur)
 288+ 0D29              init_fs_fat_find_os_cl
 289+ 0D29 01 E1 0E     	ld bc,typeDrive-4
 290+ 0D2C 6F           	ld l,a
 291+ 0D2D 26 00        	ld h,0
 292+ 0D2F 09           	add hl,bc
 293+ 0D30 7E           	ld a,(hl) ;получили код раздела из списка
 294+ 0D31
 295+ 0D31 CD 68 0D     	call init_fs_fat_warm ;выбрать раздел
 296+ 0D34 D8           	ret c
 297+ 0D35
 298+ 0D35              	;поиск пути в разделе
 299+ 0D35 21 28 10     	ld	hl,OS_PathFAT		;путь к каталогу системы
 300+ 0D38 11 3B 10     	ld	de,dir_fat_deskr ;будет дескриптор системной папки
 301+ 0D3B AF           	xor	a
 302+ 0D3C 3D           	dec	a ;установить текущим
 303+ 0D3D              	R8FAT	r8f04_FindPath
 303+ 0D3D 0E 04       >	ld	c,r8f04_FindPath
 303+ 0D3F CF          >	rst	#08
 303+ 0D40 91          >	db	#91
 304+ 0D41 30 10        	jr nc,init_fs_fat_find_os_ok
 305+ 0D43
 306+ 0D43 3A E4 0E     	ld a,(fs_drive_number_cur)
 307+ 0D46 3C           	inc a
 308+ 0D47 32 E4 0E     	ld (fs_drive_number_cur),a
 309+ 0D4A DD 2D        	dec ixl
 310+ 0D4C 20 DB        	jr nz,init_fs_fat_find_os_cl
 311+ 0D4E
 312+ 0D4E
 313+ 0D4E              	;не нашли ОС
 314+ 0D4E CD 98 0D         call   file_error_print_dir_not_found ;если не нашли, файл будет в корне
 315+ 0D51 37           	scf
 316+ 0D52 C9           	ret
 317+ 0D53              init_fs_fat_find_os_ok
 318+ 0D53              	;нашли раздел с ОС
 319+ 0D53 21 8A 0F     	ld hl,msg_fat_found_os
 320+ 0D56 CD D1 09     	call drvgmx.printZ
 321+ 0D59 3A E4 0E     	ld a,(fs_drive_number_cur)
 322+ 0D5C C6 41        	add a,"A"
 323+ 0D5E CD DC 09     	call drvgmx.putC
 324+ 0D61 3E 0D        	ld a,13
 325+ 0D63 CD DC 09     	call drvgmx.putC
 326+ 0D66 B7           	or a
 327+ 0D67 C9           	ret
 328+ 0D68
 329+ 0D68
 330+ 0D68              init_fs_fat_warm
 331+ 0D68              ;переинициализация FAT раздела, когда разделы-диски уже найдены
 332+ 0D68              ;вх: a - код раздела
 333+ 0D68 32 7C 0F     	ld (fs_fat_part_code_cur),a ;запомнить текущий раздел
 334+ 0D6B AF           	xor a
 335+ 0D6C 32 27 10     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 336+ 0D6F 3A 7C 0F     	ld a,(fs_fat_part_code_cur)
 337+ 0D72
 338+ 0D72              	; R8FAT	r8f00_DeinitFAT
 339+ 0D72              	; jp 		c,file_error
 340+ 0D72
 341+ 0D72
 342+ 0D72              	R8FAT	r8f01_InitFAT ;инициализация
 342+ 0D72 0E 01       >	ld	c,r8f01_InitFAT
 342+ 0D74 CF          >	rst	#08
 342+ 0D75 91          >	db	#91
 343+ 0D76 D2 81 0D         jp      nc,init_fs_fat3
 344+ 0D79 21 AD 0F     	ld hl,msg_fat_init_error
 345+ 0D7C CD D1 09     	call drvgmx.printZ
 346+ 0D7F 37           	scf
 347+ 0D80 C9           	ret
 348+ 0D81
 349+ 0D81              init_fs_fat3
 350+ 0D81
 351+ 0D81
 352+ 0D81              ;получить текущий путь
 353+ 0D81              	; ld	hl,#4000		;адрес буфера для размещения текущего пути (256 байт)
 354+ 0D81              	; R8FAT	r8f13_GetPath ;получить путь
 355+ 0D81
 356+ 0D81              ;init_fs_fat_ex ;выход
 357+ 0D81 3E 01        	ld a,1
 358+ 0D83 32 27 10     	ld (fs_fat_init_flag),a
 359+ 0D86 B7           	or a
 360+ 0D87 C9           	ret
 361+ 0D88
 362+ 0D88
 363+ 0D88
 364+ 0D88
 365+ 0D88
 366+ 0D88
 367+ 0D88              file_error ;выход с ошибкой
 368+ 0D88 11 00 00     	ld de,0
 369+ 0D8B 01 00 00     	ld bc,0 ;длина 0
 370+ 0D8E 37           	scf ;ошибка
 371+ 0D8F C9           	ret
 372+ 0D90
 373+ 0D90              file_error_general_print ;выход с общей ошибкой и сообщением
 374+ 0D90 21 BE 0F     	ld hl,msg_file_error_general
 375+ 0D93 CD D1 09     	call drvgmx.printZ
 376+ 0D96 37           	scf ;ошибка
 377+ 0D97 C9           	ret
 378+ 0D98
 379+ 0D98              file_error_print_dir_not_found ;выход с ошибкой и сообщением
 380+ 0D98 21 0F 10     	ld hl,msg_dir_not_found
 381+ 0D9B CD D1 09     	call drvgmx.printZ
 382+ 0D9E 37           	scf ;ошибка
 383+ 0D9F C9           	ret
 384+ 0DA0
 385+ 0DA0              file_error_print_file_too_big ;выход с ошибкой и сообщением
 386+ 0DA0 21 CB 0F     	ld hl,msg_file_too_big
 387+ 0DA3 CD D1 09     	call drvgmx.printZ
 388+ 0DA6 37           	scf ;ошибка
 389+ 0DA7 C9           	ret
 390+ 0DA8
 391+ 0DA8              file_error_print_file_not_found ;выход с ошибкой и сообщением
 392+ 0DA8 21 DA 0F     	ld hl,msg_file_not_found
 393+ 0DAB CD D1 09     	call drvgmx.printZ
 394+ 0DAE 37           	scf ;ошибка
 395+ 0DAF C9           	ret
 396+ 0DB0
 397+ 0DB0              file_error_print_file_open_error ;выход с ошибкой и сообщением
 398+ 0DB0 21 EB 0F     	ld hl,msg_file_open_error
 399+ 0DB3 CD D1 09     	call drvgmx.printZ
 400+ 0DB6 37           	scf ;ошибка
 401+ 0DB7 C9           	ret
 402+ 0DB8
 403+ 0DB8              file_error_print_file_read_error ;выход с ошибкой и сообщением
 404+ 0DB8 21 FD 0F     	ld hl,msg_file_read_error
 405+ 0DBB CD D1 09     	call drvgmx.printZ
 406+ 0DBE 37           	scf ;ошибка
 407+ 0DBF C9           	ret
 408+ 0DC0
 409+ 0DC0
 410+ 0DC0
 411+ 0DC0
 412+ 0DC0              ; A - file stream id
 413+ 0DC0              fclose:
 414+ 0DC0                  ;esxCall ESX_FCLOSE
 415+ 0DC0              	; push af
 416+ 0DC0              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 417+ 0DC0              	; pop af
 418+ 0DC0              	; cp 2 ;если обычный файл
 419+ 0DC0              	; jp nz,fclose_scl
 420+ 0DC0
 421+ 0DC0              close_fcb_fat ;закрытие fcb файла по номеру
 422+ 0DC0              ;вх: a - id файла
 423+ 0DC0              	;выход hl - fcb;
 424+ 0DC0 21 89 11     	ld hl,fcb_fat
 425+ 0DC3 B7           	or a
 426+ 0DC4 28 07        	jr z,close_fcb_fat_ex
 427+ 0DC6 47           	ld b,a
 428+ 0DC7 11 20 00     	ld de,fcb_fat_size
 429+ 0DCA              close_fcb_fat_cl
 430+ 0DCA              	;вычислить адрес fcb
 431+ 0DCA 19           	add hl,de
 432+ 0DCB 10 FD        	djnz close_fcb_fat_cl
 433+ 0DCD              close_fcb_fat_ex
 434+ 0DCD E5           	push hl
 435+ 0DCE 54           	ld d,h ;почистить fcb
 436+ 0DCF 5D           	ld e,l
 437+ 0DD0 13           	inc de
 438+ 0DD1 01 1F 00     	ld bc,fcb_fat_size-1
 439+ 0DD4 36 00        	ld (hl),0
 440+ 0DD6 ED B0        	ldir
 441+ 0DD8 21 6B 11     	ld hl,fcb_fat_table
 442+ 0DDB 4F           	ld c,a
 443+ 0DDC 06 00        	ld b,0
 444+ 0DDE 09           	add hl,bc
 445+ 0DDF 36 00        	ld (hl),0 ;и флаг открытия fcb_fat_table
 446+ 0DE1 E1           	pop hl
 447+ 0DE2 C9           	ret
 448+ 0DE3
 449+ 0DE3
 450+ 0DE3
 451+ 0DE3              ;закрытие всех файлов процесса
 452+ 0DE3              ;вх: A - id процесса
 453+ 0DE3              fclose_proc_all
 454+ 0DE3 21 6B 11     	ld hl,fcb_fat_table
 455+ 0DE6 06 08        	ld b,files_fat_max
 456+ 0DE8 0E 00        	ld c,0 ;id файла
 457+ 0DEA              fclose_proc_all_cl
 458+ 0DEA BE           	cp (hl) ;совпадает с id процесса?
 459+ 0DEB 20 08        	jr nz,fclose_proc_all_skip
 460+ 0DED F5           	push af
 461+ 0DEE 79           	ld a,c ;id файла
 462+ 0DEF D9           	exx
 463+ 0DF0 CD C0 0D     	call close_fcb_fat ;закрыть
 464+ 0DF3 D9           	exx
 465+ 0DF4 F1           	pop af
 466+ 0DF5              fclose_proc_all_skip
 467+ 0DF5 23           	inc hl
 468+ 0DF6 0C           	inc c
 469+ 0DF7 10 F1        	djnz fclose_proc_all_cl
 470+ 0DF9 C9           	ret
 471+ 0DFA
 472+ 0DFA
 473+ 0DFA
 474+ 0DFA
 475+ 0DFA
 476+ 0DFA
 477+ 0DFA              ; A - file stream id
 478+ 0DFA              ; DE - length
 479+ 0DFA              ; HL - buffer
 480+ 0DFA              ; Returns
 481+ 0DFA              ;  BC - length(how much was actually read)
 482+ 0DFA              fread: ;(id=1)
 483+ 0DFA                  ; push hl : pop ix
 484+ 0DFA                  ; esxCall ESX_FREAD
 485+ 0DFA
 486+ 0DFA ED 53 25 10  	ld (file_size_tmp),de
 487+ 0DFE
 488+ 0DFE CD 32 0E     	call file_check_act ;проверка
 489+ 0E01 DA 88 0D     	jp c,file_error
 490+ 0E04
 491+ 0E04 ED 4B 25 10  	ld bc,(file_size_tmp) ;размер
 492+ 0E08 79           	ld a,c ;ba - количество байт для чтения
 493+ 0E09
 494+ 0E09              	R8FAT r8f08_FileRead	;читать файл
 494+ 0E09 0E 08       >	ld	c,r8f08_FileRead
 494+ 0E0B CF          >	rst	#08
 494+ 0E0C 91          >	db	#91
 495+ 0E0D DA 88 0D     	jp c,file_error
 496+ 0E10
 497+ 0E10 ED 4B 25 10  	ld bc,(file_size_tmp) ;размер
 498+ 0E14 B7           	or a
 499+ 0E15 C9           	ret
 500+ 0E16
 501+ 0E16
 502+ 0E16              ; A - file stream id
 503+ 0E16              ; DE - length
 504+ 0E16              ; HL - buffer
 505+ 0E16              ; Returns:
 506+ 0E16              ;   BC - actually written bytes
 507+ 0E16              fwrite: ;
 508+ 0E16                  ; push hl : pop ix
 509+ 0E16                  ; esxCall ESX_FWRITE
 510+ 0E16
 511+ 0E16               ;запись файла fat
 512+ 0E16 ED 53 25 10   	ld (file_size_tmp),de
 513+ 0E1A
 514+ 0E1A CD 32 0E     	call file_check_act ;проверка
 515+ 0E1D DA 88 0D     	jp c,file_error
 516+ 0E20
 517+ 0E20 ED 4B 25 10  	ld bc,(file_size_tmp) ;размер
 518+ 0E24 79           	ld a,c ;ba - количество байт для записи
 519+ 0E25
 520+ 0E25              	R8FAT r8f09_FileWrite	;записать в файл
 520+ 0E25 0E 09       >	ld	c,r8f09_FileWrite
 520+ 0E27 CF          >	rst	#08
 520+ 0E28 91          >	db	#91
 521+ 0E29 DA 88 0D     	jp c,file_error
 522+ 0E2C
 523+ 0E2C ED 4B 25 10  	ld bc,(file_size_tmp) ;размер
 524+ 0E30 B7           	or a
 525+ 0E31 C9           	ret
 526+ 0E32              ;---------------------------------------
 527+ 0E32
 528+ 0E32              file_check_act
 529+ 0E32              ;проверка файла на актуальность
 530+ 0E32              ;вых: A - id, DE - fcb
 531+ 0E32 32 7B 0F     	ld (file_fat_id_cur),a ;сохранить id
 532+ 0E35
 533+ 0E35 3A 27 10     	ld a,(fs_fat_init_flag)
 534+ 0E38 B7           	or a
 535+ 0E39 37           	scf
 536+ 0E3A C8           	ret z ;выход если не инициализирована ФС
 537+ 0E3B
 538+ 0E3B E5           	push hl
 539+ 0E3C C5           	push bc
 540+ 0E3D 3A 7B 0F     	ld a,(file_fat_id_cur)
 541+ 0E40 CD 63 0F     	call find_fcb_fat ;найти fcb
 542+ 0E43 EB           	ex de,hl ;fcb в de
 543+ 0E44 D5           	push de
 544+ 0E45 DD E1        	pop ix ;fcb
 545+ 0E47 C1           	pop bc
 546+ 0E48 21 20 2B     	ld hl,proc_id_cur ;сравнить с кодом текущего процесса, чтобы имел доступ только к своему файлу
 547+ 0E4B BE           	cp (hl)
 548+ 0E4C E1           	pop hl
 549+ 0E4D 37           	scf
 550+ 0E4E C0           	ret nz
 551+ 0E4F
 552+ 0E4F B7           	or a
 553+ 0E50 37           	scf
 554+ 0E51 C8           	ret z ;выход если файл не открыт
 555+ 0E52
 556+ 0E52
 557+ 0E52
 558+ 0E52 3A 7C 0F     	ld a,(fs_fat_part_code_cur) ;сравнить какой раздел у файла и какой активный
 559+ 0E55 DD BE 1F     	cp (ix+#1f)
 560+ 0E58 C4 68 0D     	call nz,init_fs_fat_warm ;переинициировать
 561+ 0E5B C9           	ret
 562+ 0E5C
 563+ 0E5C
 564+ 0E5C
 565+ 0E5C              ;чтение секторов текущего каталога
 566+ 0E5C              ; вх:
 567+ 0E5C                   ; hl - буфер для чтения
 568+ 0E5C                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 569+ 0E5C                   ; b - максимальное количество секторов для чтения
 570+ 0E5C              read_dir
 571+ 0E5C              	;сначала сделаем текущей папку активного приложения
 572+ 0E5C D9           	exx
 573+ 0E5D 3A 20 2B     	ld a,(proc_id_cur)
 574+ 0E60 CD 86 0E     	call calc_dir_deskr
 575+ 0E63 EB           	ex de,hl
 576+ 0E64 21 00 00     	ld hl,0
 577+ 0E67                  ; hl - адрес пути (=#0000 - путь отсутствует)
 578+ 0E67                  ; de - адрес дескриптора директории/файла
 579+ 0E67              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 579+ 0E67 0E 05       >	ld	c,r8f05_OpenDir
 579+ 0E69 CF          >	rst	#08
 579+ 0E6A 91          >	db	#91
 580+ 0E6B D9           	exx
 581+ 0E6C
 582+ 0E6C              	;теперь запрос
 583+ 0E6C              	R8FAT r8f02_ReadDIR	;читать
 583+ 0E6C 0E 02       >	ld	c,r8f02_ReadDIR
 583+ 0E6E CF          >	rst	#08
 583+ 0E6F 91          >	db	#91
 584+ 0E70 C9               ret
 585+ 0E71
 586+ 0E71
 587+ 0E71
 588+ 0E71              ;вход в каталог/выход в родительский каталог
 589+ 0E71              ; вх: hl - адрес пути (=#0000 - путь отсутствует)
 590+ 0E71              ; de - адрес дескриптора директории/файла
 591+ 0E71              ; вых: a - если путь был указан, новая длина пути
 592+ 0E71              open_dir
 593+ 0E71 D5           	push de ;дескриптор
 594+ 0E72
 595+ 0E72              	R8FAT r8f05_OpenDir	;открыть
 595+ 0E72 0E 05       >	ld	c,r8f05_OpenDir
 595+ 0E74 CF          >	rst	#08
 595+ 0E75 91          >	db	#91
 596+ 0E76
 597+ 0E76              	;скопировать дескриптор приложения
 598+ 0E76 F5           	push af
 599+ 0E77 3A 20 2B     	ld a,(proc_id_cur)
 600+ 0E7A CD 86 0E     	call calc_dir_deskr ;узнать дескриптор
 601+ 0E7D F1           	pop af
 602+ 0E7E EB           	ex de,hl
 603+ 0E7F E1           	pop hl ;дескриптор, отправленный приложеием
 604+ 0E80 01 20 00     	ld bc,32
 605+ 0E83 ED B0        	ldir
 606+ 0E85 C9           	ret
 607+ 0E86
 608+ 0E86
 609+ 0E86
 610+ 0E86
 611+ 0E86
 612+ 0E86
 613+ 0E86              calc_dir_deskr ;определяет адрес дескриптора каталога
 614+ 0E86 21 3B 10     	ld hl,dir_fat_deskr
 615+ 0E89 B7           	or a
 616+ 0E8A 28 0B        	jr z,calc_dir_deskr_ex ;на выход если 0
 617+ 0E8C FE 09        	cp proc_max+1
 618+ 0E8E 30 07        	jr nc,calc_dir_deskr_ex ;защита
 619+ 0E90 11 20 00     	ld de,fcb_fat_size
 620+ 0E93 47           	ld b,a
 621+ 0E94              calc_dir_deskr_cl
 622+ 0E94 19           	add hl,de
 623+ 0E95 10 FD        	djnz calc_dir_deskr_cl
 624+ 0E97              calc_dir_deskr_ex
 625+ 0E97 C9           	ret
 626+ 0E98
 627+ 0E98
 628+ 0E98
 629+ 0E98
 630+ 0E98              ; A - file stream id
 631+ 0E98              ; DE - position hi
 632+ 0E98              ; HL - position low
 633+ 0E98              ; Returns:
 634+ 0E98              ;
 635+ 0E98              file_position: ;
 636+ 0E98              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 637+ 0E98 38 14        	jr c,file_position_set
 638+ 0E9A              	;чтение
 639+ 0E9A CD 32 0E     	call file_check_act ;проверка
 640+ 0E9D DA 88 0D     	jp c,file_error
 641+ 0EA0              	;прочитаем позицию
 642+ 0EA0 DD 6E 18     	ld l,(ix+#18)
 643+ 0EA3 DD 66 19     	ld h,(ix+#19)
 644+ 0EA6 DD 5E 1A     	ld e,(ix+#1a)
 645+ 0EA9 DD 56 1B     	ld d,(ix+#1b)
 646+ 0EAC B7           	or a
 647+ 0EAD C9           	ret
 648+ 0EAE
 649+ 0EAE
 650+ 0EAE              file_position_set
 651+ 0EAE              	;установка
 652+ 0EAE D5           	push de
 653+ 0EAF CD 32 0E     	call file_check_act ;проверка
 654+ 0EB2 D1           	pop de
 655+ 0EB3 DA 88 0D     	jp c,file_error
 656+ 0EB6              	;установим позицию
 657+ 0EB6 DD 75 18     	ld (ix+#18),l
 658+ 0EB9 DD 74 19     	ld (ix+#19),h
 659+ 0EBC DD 73 1A     	ld (ix+#1a),e
 660+ 0EBF DD 72 1B     	ld (ix+#1b),d
 661+ 0EC2 B7           	or a
 662+ 0EC3 C9           	ret
 663+ 0EC4
 664+ 0EC4
 665+ 0EC4
 666+ 0EC4
 667+ 0EC4              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 668+ 0EC4              ;вх:   hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 669+ 0EC4              ;	  формат пути: \[DIR\DIR\..\DIR\]filename.ext
 670+ 0EC4              find_path
 671+ 0EC4              	;сначала сделаем текущей папку активного приложения
 672+ 0EC4 F5           	push af
 673+ 0EC5 E5           	push hl
 674+ 0EC6 3A 20 2B     	ld a,(proc_id_cur)
 675+ 0EC9 CD 86 0E     	call calc_dir_deskr
 676+ 0ECC EB           	ex de,hl
 677+ 0ECD 21 00 00     	ld hl,0
 678+ 0ED0                  ; hl - адрес пути (=#0000 - путь отсутствует)
 679+ 0ED0                  ; de - адрес дескриптора директории/файла
 680+ 0ED0              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 680+ 0ED0 0E 05       >	ld	c,r8f05_OpenDir
 680+ 0ED2 CF          >	rst	#08
 680+ 0ED3 91          >	db	#91
 681+ 0ED4
 682+ 0ED4              	R8FAT r8f03_SetRoot ;перейти в корень диска
 682+ 0ED4 0E 03       >	ld	c,r8f03_SetRoot
 682+ 0ED6 CF          >	rst	#08
 682+ 0ED7 91          >	db	#91
 683+ 0ED8
 684+ 0ED8 E1           	pop hl
 685+ 0ED9 F1           	pop af
 686+ 0EDA              	;поиск пути в разделе
 687+ 0EDA              	; xor	a
 688+ 0EDA              	; dec	a ;установить текущим
 689+ 0EDA              	R8FAT	r8f04_FindPath
 689+ 0EDA 0E 04       >	ld	c,r8f04_FindPath
 689+ 0EDC CF          >	rst	#08
 689+ 0EDD 91          >	db	#91
 690+ 0EDE
 691+ 0EDE              ; #04(04) (FindPath) поиск файла по заданному пути в текущем каталоге со входом в
 692+ 0EDE              	; подкаталоги с проверкой синтаксиса (с установкой найденного каталога
 693+ 0EDE              	; текущим)
 694+ 0EDE              ; вх:  c=#04(04)
 695+ 0EDE                   ; hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 696+ 0EDE              	  ; формат пути: \[DIR\DIR\..\DIR\]filename.ext
 697+ 0EDE                   ; de - адрес буфера (#20 байт) для дескриптора найденного файла/каталога
 698+ 0EDE                   ; a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 699+ 0EDE
 700+ 0EDE C9           	ret
 701+ 0EDF
 702+ 0EDF
 703+ 0EDF
 704+ 0EDF
 705+ 0EDF
 706+ 0EDF
 707+ 0EDF
 708+ 0EDF
 709+ 0EDF              ; получение длинного имени файла
 710+ 0EDF              ;вх: hl - адрес буфера для имени
 711+ 0EDF              ;    de - номер записи в текущем каталоге
 712+ 0EDF              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 713+ 0EDF              ; 	a - длина имени, с учетом нуля
 714+ 0EDF              get_LFN
 715+ 0EDF
 716+ 0EDF
 717+ 0EDF              	R8FAT r8f14_GetLFN
 717+ 0EDF 0E 14       >	ld	c,r8f14_GetLFN
 717+ 0EE1 CF          >	rst	#08
 717+ 0EE2 91          >	db	#91
 718+ 0EE3              ; #14(20) (GetLFN) получение длинного имени файла
 719+ 0EE3              ; вх:  c=#14(20)
 720+ 0EE3                   ; hl - адрес буфера для имени
 721+ 0EE3                   ; de - номер записи в текущем каталоге
 722+ 0EE3              ; вых: cy=1 ошибка чтения -> a - код ошибки
 723+ 0EE3                   ; hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то
 724+ 0EE3                        ; возвращается короткое имя)
 725+ 0EE3                   ; a - длина имени, с учетом нуля
 726+ 0EE3                   ; de,bc - не определены
 727+ 0EE3
 728+ 0EE3 C9           	 ret
 729+ 0EE4
 730+ 0EE4
 731+ 0EE4
 732+ 0EE4
 733+ 0EE4
 734+ 0EE4
 735+ 0EE4
 736+ 0EE4
 737+ 0EE4              ; A - file stream id
 738+ 0EE4              ; fsync:
 739+ 0EE4              ;     esxCall ESX_FSYNC
 740+ 0EE4                  ; ret
 741+ 0EE4
 742+ 0EE4
 743+ 0EE4              ; ; HL - name (name.ext)
 744+ 0EE4              ; ; Returns:
 745+ 0EE4              ; ; HL - name (name    e)
 746+ 0EE4              ; format_name ;подгоняет имя файла под стандарт trdos (8+1)
 747+ 0EE4
 748+ 0EE4              	; ;сначала попробуем убрать из пути подпапку, если она есть
 749+ 0EE4              	; ld (temp_hl),hl ;сохраним адрес исходного имени
 750+ 0EE4              	; ld b,#00 ;не больше 255 символов
 751+ 0EE4              ; format_name5
 752+ 0EE4              	; ld a,(hl)
 753+ 0EE4              	; cp "/" ;если есть подпапка
 754+ 0EE4              	; jr z,format_name_path_yep
 755+ 0EE4              	; ld a,(hl)
 756+ 0EE4              	; cp "." ;если ещё не дошли до расширения
 757+ 0EE4              	; jr nz,format_name6
 758+ 0EE4              	; ld hl,(temp_hl) ;если дошли до расширения, то путей нет, вернёмся на начало имени
 759+ 0EE4              	; jr format_name_7 ;на выход
 760+ 0EE4              ; format_name6
 761+ 0EE4              	; inc hl
 762+ 0EE4              	; djnz format_name5
 763+ 0EE4
 764+ 0EE4              ; format_name_path_yep ;нашли
 765+ 0EE4              	; inc hl ;пропустим знак "/"
 766+ 0EE4
 767+ 0EE4              ; format_name_7
 768+ 0EE4
 769+ 0EE4              	; push hl ;очистим место для нового имени
 770+ 0EE4              	; ld hl,f_name
 771+ 0EE4              	; ld de,f_name+1
 772+ 0EE4              	; ld (hl)," "
 773+ 0EE4              	; ld bc,8+1
 774+ 0EE4              	; ldir
 775+ 0EE4              	; ld (hl),0
 776+ 0EE4              	; ld bc,16-8-1-1
 777+ 0EE4              	; ldir
 778+ 0EE4              	; pop hl
 779+ 0EE4
 780+ 0EE4              	; ld bc,#09ff ;длина имени 9 символов
 781+ 0EE4              	; ld de,f_name ;куда
 782+ 0EE4              ; format_name2
 783+ 0EE4              	; ld a,(hl)
 784+ 0EE4              	; cp "."
 785+ 0EE4              	; jr nz,format_name1
 786+ 0EE4              	; ld de,f_name+8
 787+ 0EE4              	; inc hl
 788+ 0EE4              	; ldi ; и в конце расширение 3 буквы
 789+ 0EE4              	; ldi
 790+ 0EE4              	; ldi
 791+ 0EE4              	; ;ex de,hl ;сохраним адрес исходного расширения
 792+ 0EE4              	; jr format_name_e
 793+ 0EE4              ; format_name1
 794+ 0EE4              	; ldi
 795+ 0EE4              	; djnz format_name2
 796+ 0EE4
 797+ 0EE4              	; ;если имя длинное, пропустим лишнее до расширения
 798+ 0EE4              	; ld b,#00 ;не больше 255 символов
 799+ 0EE4              ; format_name3
 800+ 0EE4              	; ld a,(hl)
 801+ 0EE4              	; cp "."
 802+ 0EE4              	; jr nz,format_name4
 803+ 0EE4              	; ld de,f_name+8
 804+ 0EE4              	; inc hl
 805+ 0EE4              	; ldi ; и в конце расширение 3 буквы
 806+ 0EE4              	; ldi
 807+ 0EE4              	; ldi
 808+ 0EE4              	; ;ex de,hl ;сохраним адрес исходного расширения
 809+ 0EE4              	; jr format_name_e
 810+ 0EE4              ; format_name4
 811+ 0EE4              	; inc hl
 812+ 0EE4              	; djnz format_name3
 813+ 0EE4
 814+ 0EE4              ; format_name_e ;выход
 815+ 0EE4              	; ld hl,f_name ;вернём результат
 816+ 0EE4              	; ret
 817+ 0EE4
 818+ 0EE4              ; DE - trk/sec
 819+ 0EE4              ; B - sectors step
 820+ 0EE4              ; Returns:
 821+ 0EE4              ; DE - trk/sec
 822+ 0EE4              ; calc_next_pos		;вперёд на N секторов
 823+ 0EE4              			; ;ld b,4
 824+ 0EE4              			; ;ld  de,(#5ceb)
 825+ 0EE4              ; calc_next_pos2
 826+ 0EE4              			; inc e
 827+ 0EE4              			; ld a,e
 828+ 0EE4              			; cp 16
 829+ 0EE4              			; jr c,calc_next_pos1
 830+ 0EE4              			; inc d
 831+ 0EE4              			; ld e,0
 832+ 0EE4              ; calc_next_pos1
 833+ 0EE4              			; ;ld (#5ceb),de
 834+ 0EE4              			; djnz calc_next_pos2
 835+ 0EE4              			; ret
 836+ 0EE4
 837+ 0EE4
 838+ 0EE4              ;testt db "123.trd"
 839+ 0EE4              ; write_ima db "Select disk "
 840+ 0EE4              ; write_ima_d db "A: (E-" ;текущая буква
 841+ 0EE4              ; write_ima_e	db "D)> " ;последняя буква
 842+ 0EE4              		; db 13,10,0
 843+ 0EE4              ;prev_drive db 0 ;предыдущий номер дисковода
 844+ 0EE4 00           fs_drive_number_cur db 0 ;текущий диск/раздел
 845+ 0EE5
 846+ 0EE5              ; ; trdExt1 db ".trd", 0
 847+ 0EE5              ; ; trdExt2 db ".TRD", 0
 848+ 0EE5
 849+ 0EE5              ; ; sclExt1 db ".scl", 0
 850+ 0EE5              ; ; sclExt2 db ".SCL", 0
 851+ 0EE5
 852+ 0EE5              ; f_name ds 16 ;имя файла
 853+ 0EE5              ; f_r_cur_trk dw 	 0 ;текущие сектор-дорожка файла на чтение
 854+ 0EE5              ; f_r_len_sec db 0 ;длина файла на чтение в секторах
 855+ 0EE5              ; f_r_len dw 0;длина файла в байтах
 856+ 0EE5              ; f_r_flag db 0 ;флаг что открыт файл на чтение
 857+ 0EE5
 858+ 0EE5              ; f_w_cur_trk dw 	 0 ;текущие сектор-дорожка файла на запись
 859+ 0EE5              ; f_w_len_sec db 0 ;длина файла на запись в секторах
 860+ 0EE5              ; f_w_flag db 0 ;флаг что открыт файл на запись
 861+ 0EE5              ; f_w_len ds 4 ;длина записанных данных
 862+ 0EE5              ; write_end_flag db 0 ;флаг что нужно записать остаток
 863+ 0EE5
 864+ 0EE5              ; temp_bc dw 0 ;хранение регистра
 865+ 0EE5              ; temp_hl dw 0 ;хранение регистра
 866+ 0EE5              ; temp_hl2 dw 0 ;хранение регистра
 867+ 0EE5
 868+ 0EE5              ; sec_shift db 0 ;указатель на каком байте остановлена запись
 869+ 0EE5              ; sec_shift2 db 0 ;указатель на каком байте остановлена запись (остаток)
 870+ 0EE5              ; sec_part db 0 ;сколько секторов во второй порции для записи
 871+ 0EE5              ; sec_shift_flag db 0 ;флаг что буфер сектора не заполнен
 872+ 0EE5
 873+ 0EE5              ; ;секция scl
 874+ 0EE5              ; scl_sign db "SINCLAIR" ;метка
 875+ 0EE5              ; scl_que db 0 ;флаг запроса порции данных
 876+ 0EE5              ; scl_err db "SCL image error!",0
 877+ 0EE5              ; scl_parse_ret_adr dw 0; адрес возврата в цикл
 878+ 0EE5              ; scl_cat_cycl db 0 ;переменная цикла
 879+ 0EE5              ; scl_files db 0 ;всего файлов
 880+ 0EE5              ; scl_temp_hl dw 0;;хранение регистра
 881+ 0EE5              ; scl_temp_hl2 dw 0;
 882+ 0EE5              ; scl_temp_de dw 0;
 883+ 0EE5              ; scl_temp_bc dw 0;
 884+ 0EE5              ; cat_cur_adr dw 0;
 885+ 0EE5              ; ;scl end
 886+ 0EE5
 887+ 0EE5              ; ;секция сохранения любого файла
 888+ 0EE5              ; file_err db "Not enough space!",0
 889+ 0EE5              ; sec_cat db 0 ;сектор каталога
 890+ 0EE5              ; file_num db "0" ;номер части для больших файлов
 891+ 0EE5
 892+ 0EE5              	; ;по адресу #4000 шрифт
 893+ 0EE5              ; cat_buf equ #4800 ;буфер для кататога диска 9*256
 894+ 0EE5              ; sec_buf equ cat_buf + 9*256 ;буфер сектора для записи 256
 895+ 0EE5              ; scl_buf equ sec_buf + 512 ;промежуточный буфер 256
 896+ 0EE5              ; scl_buf2 equ scl_buf + 512 ;промежуточный буфер 256
 897+ 0EE5              ; ;общая ошибка с файлами
 898+ 0EE5              ; com_file_err db "File error!",0
 899+ 0EE5              ;com_file_err_flag db 0 ;общая ошибка
 900+ 0EE5
 901+ 0EE5
 902+ 0EE5
 903+ 0EE5
 904+ 0EE5              ;Раздел SMUC и SD ------------------------------------
 905+ 0EE5
 906+ 0EE5
 907+ 0EE5              ;список доступных разделов на винчестерах
 908+ 0EE5              ;7,=0/1 тип раздела MFS/FAT
 909+ 0EE5              ;6,=1 раздел есть
 910+ 0EE5              ;3,=0/1 Hdd/SD card
 911+ 0EE5              ;2,=0/1 для HDD master/slave
 912+ 0EE5              ;0..1,=?? номер раздела
 913+ 0EE5              ;
 914+ 0EE5 00 00 00...  typeDrive	ds 3*4+1
 915+ 0EF2              ;typeDriveFAT	ds 3*4+1 ;список всех разделов FAT
 916+ 0EF2 00           numDrives db 0 ;количество устройств
 917+ 0EF3              ;numDrivesFAT db 0 ;количество устройств FAT
 918+ 0EF3 00           next_lett db 0 ;следующая свободная буква диска
 919+ 0EF4
 920+ 0EF4              ;подсчет количества доступных разделов на всех устройствах
 921+ 0EF4              ;вых: hl,a - количество устройств
 922+ 0EF4              ;     typeDrives - сформированная таблица
 923+ 0EF4              ;     cy=1 не обнаружено ни одного устройства
 924+ 0EF4              ;
 925+ 0EF4              GetNumPart
 926+ 0EF4              ;
 927+ 0EF4 D5           	push	de
 928+ 0EF5 C5           	push	bc
 929+ 0EF6 21 E5 0E     	ld	hl,typeDrive
 930+ 0EF9 E5           	push	hl
 931+ 0EFA AF           	xor	a
 932+ 0EFB CD 15 0F     	call	proc_01			;HDD master
 933+ 0EFE 3E 01        	ld	a,#01
 934+ 0F00 CD 15 0F     	call	proc_01			;HDD slave
 935+ 0F03 3E 02        	ld	a,#02
 936+ 0F05 CD 15 0F     	call	proc_01			;SD card
 937+ 0F08 D1           	pop	de
 938+ 0F09 B7           	or	a
 939+ 0F0A ED 52        	sbc	hl,de			;количество разделов на HDD
 940+ 0F0C              	IFDEF	useTRD
 941+ 0F0C ~            	 ld	a,l
 942+ 0F0C ~            	 add	a,#04
 943+ 0F0C ~            	 ld	l,a
 944+ 0F0C              	ELSE
 945+ 0F0C 7D           	 ld	a,l
 946+ 0F0D              	ENDIF
 947+ 0F0D C1           	pop	bc
 948+ 0F0E D1           	pop	de
 949+ 0F0F 32 F2 0E     	ld	(numDrives),a
 950+ 0F12 FE 01        	cp	1
 951+ 0F14 C9           	ret
 952+ 0F15
 953+ 0F15              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 954+ 0F15              ;формирование таблицы с доступными разделами на винчестере
 955+ 0F15              ;вх:  a =#00 выбрать master
 956+ 0F15              ;       =#01 выбрать slave
 957+ 0F15              ;       =#02 выбрать SD card
 958+ 0F15              ;     hl - адрес в таблице разделов typeDrives
 959+ 0F15              ;вых: hl - новый адрес в таблице разделов typeDrives
 960+ 0F15              ;
 961+ 0F15 4F           proc_01	ld	c,a
 962+ 0F16 E5           	push	hl
 963+ 0F17 C5           	push	bc
 964+ 0F18              	R8DOS	r8d2E_CngHDD
 964+ 0F18 0E 2E       >	ld	c,r8d2E_CngHDD
 964+ 0F1A CF          >	rst	#08
 964+ 0F1B 81          >	db	#81
 965+ 0F1C 38 04        	jr	c,goto001		;на текущем канале нет винчестера
 966+ 0F1E              	R8DOS	r8d2D_FindPart
 966+ 0F1E 0E 2D       >	ld	c,r8d2D_FindPart
 966+ 0F20 CF          >	rst	#08
 966+ 0F21 81          >	db	#81
 967+ 0F22 C1           goto001	pop	bc
 968+ 0F23 E1           	pop	hl
 969+ 0F24 D8           	ret	c			;на текущем винчестере нет разделов
 970+ 0F25 47           	ld	b,a
 971+ 0F26 79           	ld	a,c
 972+ 0F27 87           	add	a,a
 973+ 0F28 87           	add	a,a
 974+ 0F29 4F           	ld	c,a			;номер винчестера и первого раздела
 975+ 0F2A 78           	ld	a,b
 976+ 0F2B 06 04        	ld	b,#04
 977+ 0F2D 36 00        loop001	ld	(hl),#00
 978+ 0F2F 1F           	rra
 979+ 0F30 30 0A        	jr	nc,goto002		;нет раздела
 980+ 0F32              	IFDEF	useMFS
 981+ 0F32 ~            	 ld	(hl),c
 982+ 0F32 ~            	 set	6,(hl)			;=%01???hpp MFS
 983+ 0F32 ~            	 rra
 984+ 0F32 ~            	 jr	nc,goto003		;это MFS
 985+ 0F32 ~            	 set	7,(hl)			;=%11???hpp это FAT
 986+ 0F32              	ELSE
 987+ 0F32 1F           	 rra
 988+ 0F33 30 08        	 jr	nc,goto004		;это MFS
 989+ 0F35 71           	 ld	(hl),c
 990+ 0F36 CB F6        	 set	6,(hl)			;раздел есть
 991+ 0F38 CB FE        	 set	7,(hl)			;=%11???hpp это FAT
 992+ 0F3A              	ENDIF
 993+ 0F3A 23           goto003	inc	hl
 994+ 0F3B 17           	rla
 995+ 0F3C 1F           goto002	rra
 996+ 0F3D 0C           goto004	inc	c
 997+ 0F3E 10 ED        	djnz	loop001
 998+ 0F40 C9           	ret
 999+ 0F41
1000+ 0F41
1001+ 0F41
1002+ 0F41              ;конец секции SMUC и SD ----------------------------
1003+ 0F41
1004+ 0F41
1005+ 0F41              find_empty_fcb_fat ;поиск свободного fcb для файла
1006+ 0F41              	;выход hl - fcb; a - file_id
1007+ 0F41 21 6B 11     	ld hl,fcb_fat_table
1008+ 0F44 0E 00        	ld c,0 ;номер файла
1009+ 0F46 06 08        	ld b,files_fat_max ;цикл
1010+ 0F48              find_empty_fcb_fat_cl
1011+ 0F48 7E           	ld a,(hl)
1012+ 0F49 B7           	or a
1013+ 0F4A 28 06        	jr z,find_empty_fcb_fat_ex
1014+ 0F4C 23           	inc hl
1015+ 0F4D 0C           	inc c
1016+ 0F4E 10 F8        	djnz find_empty_fcb_fat_cl
1017+ 0F50              	;не нашли свободного
1018+ 0F50 37           	scf
1019+ 0F51 C9           	ret
1020+ 0F52              find_empty_fcb_fat_ex
1021+ 0F52              	;вычислить адрес fcb
1022+ 0F52 21 89 11     	ld hl,fcb_fat
1023+ 0F55 0C           	inc c
1024+ 0F56 0D           	dec c
1025+ 0F57 28 07        	jr z,find_empty_fcb_fat_ex1
1026+ 0F59 11 20 00     	ld de,fcb_fat_size
1027+ 0F5C 41           	ld b,c
1028+ 0F5D              find_empty_fcb_fat_cl2
1029+ 0F5D 19           	add hl,de
1030+ 0F5E 10 FD        	djnz find_empty_fcb_fat_cl2
1031+ 0F60              find_empty_fcb_fat_ex1
1032+ 0F60 79           	ld a,c ;file-id
1033+ 0F61 B7           	or a
1034+ 0F62 C9           	ret
1035+ 0F63
1036+ 0F63
1037+ 0F63              find_fcb_fat ;поиск fcb файла по номеру
1038+ 0F63              	;вх: a - id файла
1039+ 0F63              	;вых: hl - fcb; a - значение из fcb_fat_table
1040+ 0F63 21 89 11     	ld hl,fcb_fat
1041+ 0F66 B7           	or a
1042+ 0F67 28 07        	jr z,find_fcb_fat_ex
1043+ 0F69 47           	ld b,a
1044+ 0F6A 11 20 00     	ld de,fcb_fat_size
1045+ 0F6D              find_fcb_fat_cl
1046+ 0F6D              	;вычислить адрес fcb
1047+ 0F6D 19           	add hl,de
1048+ 0F6E 10 FD        	djnz find_fcb_fat_cl
1049+ 0F70              find_fcb_fat_ex
1050+ 0F70 E5           	push hl
1051+ 0F71 21 6B 11     	ld hl,fcb_fat_table
1052+ 0F74 4F           	ld c,a
1053+ 0F75 06 00        	ld b,0
1054+ 0F77 09           	add hl,bc
1055+ 0F78 7E           	ld a,(hl) ;вернуть флаг
1056+ 0F79 E1           	pop hl
1057+ 0F7A C9           	ret
1058+ 0F7B
1059+ 0F7B
1060+ 0F7B
1061+ 0F7B
1062+ 0F7B
1063+ 0F7B 00           file_fat_id_cur db 0 ;текущий файл id
1064+ 0F7C 00           fs_fat_part_code_cur db 0 ;текущий раздел
1065+ 0F7D 46 6F 75 6E  msg_fat_found db "Found FAT:",13,10,0
1065+ 0F81 64 20 46 41
1065+ 0F85 54 3A 0D 0A
1065+ 0F89 00
1066+ 0F8A 46 6F 75 6E  msg_fat_found_os db "Found OS on disk: ",0
1066+ 0F8E 64 20 4F 53
1066+ 0F92 20 6F 6E 20
1066+ 0F96 64 69 73 6B
1066+ 0F9A 3A 20 00
1067+ 0F9D 46 41 54 20  msg_fat_not_found db "FAT not found",13,10,0
1067+ 0FA1 6E 6F 74 20
1067+ 0FA5 66 6F 75 6E
1067+ 0FA9 64 0D 0A 00
1068+ 0FAD 46 41 54 20  msg_fat_init_error db "FAT init_error",13,10,0
1068+ 0FB1 69 6E 69 74
1068+ 0FB5 5F 65 72 72
1068+ 0FB9 6F 72 0D 0A
1068+ 0FBD 00
1069+ 0FBE 46 69 6C 65  msg_file_error_general db "File error",13,10,0
1069+ 0FC2 20 65 72 72
1069+ 0FC6 6F 72 0D 0A
1069+ 0FCA 00
1070+ 0FCB 46 69 6C 65  msg_file_too_big db "File too_big",13,10,0
1070+ 0FCF 20 74 6F 6F
1070+ 0FD3 5F 62 69 67
1070+ 0FD7 0D 0A 00
1071+ 0FDA 46 69 6C 65  msg_file_not_found db "File not found",13,10,0
1071+ 0FDE 20 6E 6F 74
1071+ 0FE2 20 66 6F 75
1071+ 0FE6 6E 64 0D 0A
1071+ 0FEA 00
1072+ 0FEB 46 69 6C 65  msg_file_open_error db "File open error",13,10,0
1072+ 0FEF 20 6F 70 65
1072+ 0FF3 6E 20 65 72
1072+ 0FF7 72 6F 72 0D
1072+ 0FFB 0A 00
1073+ 0FFD 46 69 6C 65  msg_file_read_error db "File read error",13,10,0
1073+ 1001 20 72 65 61
1073+ 1005 64 20 65 72
1073+ 1009 72 6F 72 0D
1073+ 100D 0A 00
1074+ 100F 44 69 72 65  msg_dir_not_found db "Directory not found",13,10,0
1074+ 1013 63 74 6F 72
1074+ 1017 79 20 6E 6F
1074+ 101B 74 20 66 6F
1074+ 101F 75 6E 64 0D
1074+ 1023 0A 00
1075+ 1025 00 00        file_size_tmp dw 0 ;временно
1076+ 1027
1077+ 1027 00           fs_fat_init_flag: db 0 ;флаг инициализации
1078+ 1028 5C 4F 53 5A  OS_PathFAT db "\\OSZ",0 ;папка ОС
1078+ 102C 00
1079+ 102D
1080+ 102D 66 61 74 5F  	db "fat_dir_descr:" ;дескрипторы открытых папок fat по одной на приложение
1080+ 1031 64 69 72 5F
1080+ 1035 64 65 73 63
1080+ 1039 72 3A
1081+ 103B 00 00 00...  dir_fat_deskr ds fcb_fat_size*(proc_max+1)	;дескрипторы папок
1082+ 115B
1083+ 115B
1084+ 115B 66 61 74 5F  	db "fat_files_table:"
1084+ 115F 66 69 6C 65
1084+ 1163 73 5F 74 61
1084+ 1167 62 6C 65 3A
1085+ 116B 00 00 00...  fcb_fat_table ds files_fat_max ;флаги открытия файлов
1086+ 1173 00 00 00...  fcb_trd_table ds files_trd_max ;флаги открытия файлов
1087+ 117B
1088+ 117B 66 61 74 5F  	db "fat_files_fcb:"
1088+ 117F 66 69 6C 65
1088+ 1183 73 5F 66 63
1088+ 1187 62 3A
1089+ 1189 00 00 00...  fcb_fat ds fcb_fat_size*files_fat_max ;для файлов fat
1090+ 1289 00 00 00...  fcb_trd ds fcb_fat_size*files_trd_max ;для файлов trd
1091+ 1389
1092+ 1389
1093+ 1389
1094+ 1389                  ENDMODULE
# file closed: Drv/zsfat.asm
2467  1389              	include Drv/DrvKey.main.a80 ;драйвер клавиатуры
# file opened: Drv/DrvKey.main.a80
   1+ 1389              ;ࠩ  
   2+ 1389              ;Driver Keyboard v2.10
   3+ 1389              ;(c) 2002-2024 LW aka PLM
   4+ 1389              ;
   5+ 1389              ;Date Creating: 10.07.2002
   6+ 1389              ;Last   Update: 17.01.2024
   7+ 1389              ;Last  Edition: 17.01.2024
   8+ 1389              ;
   9+ 1389              ;:
  10+ 1389              ;DrvKey.main.a80	-  䠩
  11+ 1389              ;DrvKey.asm.a80		- 楤
  12+ 1389              ;DrvKey.var.a80		- ६
  13+ 1389              ;DrvKey.info		- ଠ  ࠩ
  14+ 1389              ;DrvKey.lua.a80		- LUA
  15+ 1389              ;
  16+ 1389              ;------------------------------------------------------------------------------
  17+ 1389              ; 樨
  18+ 1389              ;	DEVICE 	ZXSPECTRUM128
  19+ 1389              ;	INCLUDE "DrvKey.lua.a80"
  20+ 1389              ;	PAGE	#XX
  21+ 1389              	MODULE	DrvKey
  22+ 1389
  23+ 1389              ;------------------------------------------------------------------------------
  24+ 1389              ;⠭ ࠩ
  25+ 1389
  26+ 1389              ; ᥬ஢:
  27+ 1389              AdrDrvKeyboard	equ $ ;#XXXX
  28+ 1389
  29+ 1389              ;   
  30+ 1389              keyLeft		equ #08
  31+ 1389              keyRight	equ #09
  32+ 1389              keyUp		equ #0B
  33+ 1389              keyDown		equ #0A
  34+ 1389
  35+ 1389              ;࠭ /
  36+ 1389              keyPageDown	equ #05
  37+ 1389              keyPageUp	equ #04
  38+ 1389
  39+ 1389              ;/砫 ப, insert
  40+ 1389              keyHome		equ #01
  41+ 1389              keyEnd		equ #03
  42+ 1389              keyInsert	equ #02
  43+ 1389
  44+ 1389              ;⥬ 
  45+ 1389              keyBreak	equ #18
  46+ 1389              keyEdit		equ #07
  47+ 1389              keyCaps		equ #06
  48+ 1389              keyBackSpace	equ #0C
  49+ 1389              keyDelete	equ #0F
  50+ 1389              keyEnter	equ #0D
  51+ 1389
  52+ 1389              ;CapsShift/SymbolShift   樨
  53+ 1389              keyCS		equ #1C
  54+ 1389              keySS		equ #1D
  55+ 1389              keyCsEnter	equ #19
  56+ 1389              keySsSpace	equ #1A		;tab
  57+ 1389              keySsEnter	equ #1B
  58+ 1389              keyExtMode	equ #0E
  59+ 1389
  60+ 1389              ;  ० EXT mode (cs+ss+key)
  61+ 1389              keyWordLeft	equ #10
  62+ 1389              keyWordRight	equ #11
  63+ 1389              keyGrf		equ #12
  64+ 1389              keyDelEnd	equ #13
  65+ 1389              keyDelBegin	equ #16
  66+ 1389              keyCsSsSpace	equ #14
  67+ 1389              keyCsSsEnter	equ #15
  68+ 1389              ;free code: #00,#17,#1E,#1F
  69+ 1389
  70+ 1389              ; 譨 ⠡  ᪫ 
  71+ 1389              ;OutsideGrfTable		equ #XXXX ;#0000
  72+ 1389              ;OutsideRus_jcuken	equ #XXXX ;#0000
  73+ 1389              ;OutsideRus_qwerty	equ #XXXX ;#0000
  74+ 1389
  75+ 1389              ;------------------------------------------------------------------------------
  76+ 1389              ;᫮ ࠭樨
  77+ 1389
  78+ 1389              ; ᯮ짮 /  48k
  79+ 1389              	;DEFINE	Used_ROM ;
  80+ 1389              	DEFINE	UseEXTkeys	;ᯮ짮 権 cs+ss+key
  81+ 1389              	DEFINE	CommandMode	;ᯮ짮  ०
  82+ 1389              	IFDEF	Used_ROM
  83+ 1389 ~            	UNDEFINE UseEXTkeys
  84+ 1389              	ENDIF
  85+ 1389
  86+ 1389              ;祭 ᪫ 
  87+ 1389              	DEFINE	GrfMode		;ᯮ짮 ᪫ grf
  88+ 1389              	DEFINE	RusMode		;ᯮ짮 ᪫ rus
  89+ 1389
  90+ 1389              ;祭 ⠡ ᪫
  91+ 1389              	DEFINE	TblKeyGrf_ver1
  92+ 1389              	DEFINE	Rus_jcuken
  93+ 1389              	DEFINE	Rus_qwerty
  94+ 1389
  95+ 1389              ;祭 ⠡ EXT+key (command mode)
  96+ 1389              ;  ᯮ짮 ⮫쪮 
  97+ 1389              	IFDEF	UseEXTkeys
  98+ 1389              	DEFINE	TblEXTkey_Test	;⮢ ᪫
  99+ 1389              ;	DEFINE	TblEXTkey_Word	; ZX-Word
 100+ 1389              	ENDIF
 101+ 1389
 102+ 1389              ;  ᯮ ७ ⠡ ᪫ 
 103+ 1389              	DEFINE	InsideGrfTable
 104+ 1389              	DEFINE	InsideRusTable
 105+ 1389
 106+ 1389              ;祭 㭪樨 ࠩ
 107+ 1389              ;	DEFINE  NoFuncDrvKey	; 楤 맮 㭪権 ࠩ
 108+ 1389              	DEFINE	NoCtlDrvKey	; ஢ન  ⢮ 㭪樨
 109+ 1389              	DEFINE	DrvKey_02	;⠭/祭 䫠 ࠩ
 110+ 1389              	DEFINE	DrvKey_03	;⠭ ਮ প  ⮯
 111+ 1389              	DEFINE	DrvKey_04	;祭 ਮ প  ⮯
 112+ 1389
 113+ 1389              ;------------------------------------------------------------------------------
 114+ 1389
 115+ 1389              	ORG	AdrDrvKeyboard
 116+ 1389              Start	INCLUDE	"DrvKey.asm.a80"
# file opened: Drv/DrvKey.asm.a80
   1++1389              ;楤  Keyboard Driver
   2++1389              ;䠩 DrvKey.asm.a80
   3++1389              ;
   4++1389              ;DriverKeyboard		맮 ࠩ 
   5++1389              ;FunctDrvKeyboard	맮 㭪樨 ࠩ 
   6++1389              ;GetCodesPressKey	祭  ⮩ 
   7++1389              ;GetRepeatDelays	祭 ਮ প  ⮯
   8++1389              ;SetRepeatDelays	⠭ ਮ প  ⮯
   9++1389              ;SetFlagsDriver		⠭/祭 䫠 ࠩ
  10++1389              ;ScanKeyboardDelay	   ⮬ ६ থ
  11++1389              ;ScanKeyboard		   
  12++1389              ;ScanAllKeys		   
  13++1389              ;
  14++1389              ;------------------------------------------------------------------------------
  15++1389              ;------------------------------------------------------------------------------
  16++1389              ;맮 ࠩ 
  17++1389              ;: 6,(FlgScanKeys) =1 -     
  18++1389              ;     hl=FlgScanKeys
  19++1389              ;     d - ᪠ ⮩ 
  20++1389              ;     a,e -   ⮩   ⥪饩 ᪫ 
  21++1389              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  22++1389              ;     bc -  ।
  23++1389              ;
  24++1389 C3 C1 13     @DriverKeyboard		jp	ScanKeyboardDelay
  25++138C
  26++138C              ;------------------------------------------------------------------------------
  27++138C              	IFNDEF	NoFuncDrvKey
  28++138C              ;맮 㭪樨 ࠩ 
  29++138C              ;:  c -  㭪樨 [#00..#04]
  30++138C              ;     hl,de,b,a - ࠬ 㭪樨
  31++138C              ;: ॣ ⠭  ⢥⢨  뢠 㭪樥
  32++138C              ;
  33++138C              @FunctDrvKeyboard
  34++138C              ;
  35++138C              	IFDEF	NoCtlDrvKey
  36++138C E5           	 push	hl
  37++138D F5           	 push	af
  38++138E 78           	 ld	a,b
  39++138F 06 00        	 ld	b,#00
  40++1391 21 9E 13     	 ld	hl,TableAdrFunct
  41++1394 09           	 add	hl,bc
  42++1395 09           	 add	hl,bc
  43++1396 47           	 ld	b,a
  44++1397 7E           	 ld	a,(hl)
  45++1398 23           	 inc	hl
  46++1399 66           	 ld	h,(hl)
  47++139A 6F           	 ld	l,a
  48++139B F1           	 pop	af
  49++139C E3           	 ex	(sp),hl
  50++139D C9           	 ret
  51++139E              	ELSE
  52++139E ~            	 push	hl
  53++139E ~            	 push	af
  54++139E ~            	 ld	a,c
  55++139E ~            	 cp	#05
  56++139E ~            	 jr	nc,goto017		;騩  㭪樨
  57++139E ~            	 ld	a,b
  58++139E ~            	 ld	hl,TableAdrFunct
  59++139E ~            	 ld	b,#00
  60++139E ~            	 add	hl,bc
  61++139E ~            	 add	hl,bc
  62++139E ~            	 ld	b,a
  63++139E ~            	 ld	a,(hl)
  64++139E ~            	 inc	hl
  65++139E ~            	 ld	h,(hl)
  66++139E ~            	 ld	l,a
  67++139E ~            	 and	h
  68++139E ~            	 inc	a
  69++139E ~            	 jr	z,goto017		;㭪  
  70++139E ~            	 pop	af
  71++139E ~            	 ex	(sp),hl
  72++139E ~            	 ret
  73++139E ~            goto017	 pop	af
  74++139E ~            	 pop	hl
  75++139E ~            	 ret
  76++139E              	ENDIF
  77++139E
  78++139E              	ENDIF
  79++139E
  80++139E              ;------------------------------------------------------------------------------
  81++139E              TableAdrFunct	ifused
  82++139E              ;⠡ ᮢ 㭪権 ࠩ
  83++139E              ;TableAdrFunct
  84++139E              ;
  85++139E FD 13        		  dw ScanKeyboard
  86++13A0 A8 13        		  dw GetCodesPressKey
  87++13A2               IFDEF DrvKey_02
  87++13A2 B8 13          dw SetFlagsDriver
  87++13A4                 ELSE
  87++13A4 ~              dw #FFFF
  87++13A4               ENDIF
  88++13A4               IFDEF DrvKey_03
  88++13A4 B3 13          dw SetRepeatDelays
  88++13A6                ELSE
  88++13A6 ~              dw #FFFF
  88++13A6               ENDIF
  89++13A6               IFDEF DrvKey_04
  89++13A6 AE 13          dw GetRepeatDelays
  89++13A8                ELSE
  89++13A8 ~              dw #FFFF
  89++13A8               ENDIF
  90++13A8              		endif
  91++13A8
  92++13A8              ;------------------------------------------------------------------------------
  93++13A8              GetCodesPressKey	ifused
  94++13A8              ;祭  ⮩ 
  95++13A8              ;:  ----
  96++13A8              ;: d - ᪠ ⮩ 
  97++13A8              ;     a,e -   ⮩   ⥪饩 ᪫ 
  98++13A8              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  99++13A8              ;
 100++13A8              ;GetCodesPressKey
 101++13A8              ;
 102++13A8 ED 5B 95 16  	ld	de,(PrintCodePresKey)
 103++13AC 7B           	ld	a,e
 104++13AD C9           	ret
 105++13AE
 106++13AE              	endif
 107++13AE
 108++13AE              ;------------------------------------------------------------------------------
 109++13AE              GetRepeatDelays	ifused
 110++13AE              ;祭 ਮ প  ⮯
 111++13AE              ;:  ----
 112++13AE              ;: d - ਮ ⮯
 113++13AE              ;     e - প । ⮯஬
 114++13AE              ;
 115++13AE              ;GetRepeatDelays
 116++13AE              ;
 117++13AE ED 5B 93 16  	ld      de,(KeyRepeatDelay)
 118++13B2 C9           	ret
 119++13B3
 120++13B3              	endif
 121++13B3
 122++13B3              ;------------------------------------------------------------------------------
 123++13B3              SetRepeatDelays	ifused
 124++13B3              ;⠭ ਮ প  ⮯
 125++13B3              ;:  d - ਮ ⮯
 126++13B3              ;     e - প । ⮯஬
 127++13B3              ;: ॣ  
 128++13B3              ;
 129++13B3              ;SetRepeatDelays
 130++13B3              ;
 131++13B3 ED 53 93 16  	ld	(KeyRepeatDelay),de
 132++13B7 C9           	ret
 133++13B8
 134++13B8              	endif
 135++13B8
 136++13B8              ;------------------------------------------------------------------------------
 137++13B8              SetFlagsDriver	ifused
 138++13B8              ;e⠭/祭 䫠 ࠩ
 139++13B8              ;:  d - ᪠ 䫠
 140++13B8              ;     e - 塞 䫠
 141++13B8              ;: a - 䫠 ࠩ
 142++13B8              ;
 143++13B8              ;SetFlagsDriver
 144++13B8              ;
 145++13B8 3A 91 16     	ld	a,(FlgScanKeys)
 146++13BB A2           	and	d
 147++13BC B3           	or	e
 148++13BD 32 91 16     	ld	(FlgScanKeys),a
 149++13C0 C9           	ret
 150++13C1
 151++13C1              	endif
 152++13C1
 153++13C1              ;------------------------------------------------------------------------------
 154++13C1              ;   ⮬ ६ থ
 155++13C1              ;:  (PrintCodePresKey) -   ⮩ 
 156++13C1              ;: 6,(FlgScanKeys) =1 -     
 157++13C1              ;     hl=FlgScanKeys
 158++13C1              ;     d - ᪠ ⮩ 
 159++13C1              ;     a,e -   ⮩   ⥪饩 ᪫ 
 160++13C1              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
 161++13C1              ;     bc -  ।
 162++13C1              ;
 163++13C1              ScanKeyboardDelay
 164++13C1              ;
 165++13C1 CD FD 13     	call	ScanKeyboard		;a=(PrintCodePresKey)
 166++13C4 21 91 16     	ld	hl,FlgScanKeys
 167++13C7 CB F6        	set	6,(hl)
 168++13C9              ;	ld	a,(PrintCodePresKey)
 169++13C9 FE FF        	cp	#FF
 170++13CB 28 24        	jr	z,goto012		;  
 171++13CD FE 00        cng_01	cp	#00
 172++13CF 20 1E        	jr	nz,goto013		; 㣠 
 173++13D1 ED 4B 93 16  	ld	bc,(KeyRepeatDelay)
 174++13D5 11 00 00     cng_02	ld	de,#0000
 175++13D8 1C           	inc	e
 176++13D9 20 01        	jr	nz,goto014
 177++13DB 1D           	dec	e
 178++13DC 7B           goto014	ld	a,e
 179++13DD B9           	cp	c
 180++13DE 20 17        	jr	nz,goto015		;প  ⮯
 181++13E0 1D           	dec	e
 182++13E1 14           	inc	d
 183++13E2 20 01        	jr	nz,goto016
 184++13E4 15           	dec	d
 185++13E5 7A           goto016	ld	a,d
 186++13E6 B8           	cp	b
 187++13E7 38 0E        	jr	c,goto015
 188++13E9 16 00        	ld	d,#00
 189++13EB CB B6        	res	6,(hl)
 190++13ED 18 08        	jr	goto015
 191++13EF CB B6        goto013 res     6,(hl)
 192++13F1 32 CE 13     goto012	ld	(cng_01+1),a
 193++13F4 11 00 00     	ld	de,#0000
 194++13F7 ED 53 D6 13  goto015	ld	(cng_02+1),de
 195++13FB 18 AB        	jr	GetCodesPressKey
 196++13FD
 197++13FD              ;------------------------------------------------------------------------------
 198++13FD              ;     樥 ⭮ 
 199++13FD              ;:  (FlgScanKeys) - 䫠
 200++13FD              ;: (ScanCodePresKey) - ᪠ ⮩ 
 201++13FD              ;     a -   ⮩ 
 202++13FD              ;     (PrintCodePresKey) -   ⮩   ⥪饩 ᪫
 203++13FD              ;        (Grf\Rus\Lat)  ⮬ ० CapsLock
 204++13FD              ;     7,(FlgScanKeys) =1 ⨬ 
 205++13FD              ;     hl,de,bc,a -  ।
 206++13FD              ;
 207++13FD              ScanKeyboard
 208++13FD              ;
 209++13FD              ; 
 210++13FD              	IFDEF	Used_ROM
 211++13FD ~            	 call	#028E
 212++13FD              	ELSE
 213++13FD CD 8C 14     	 call	ScanAllKeys
 214++1400              	ENDIF
 215++1400 21 91 16     	ld	hl,FlgScanKeys
 216++1403 CB AE        	res	5,(hl)
 217++1405 CB BE        	res	7,(hl)
 218++1407 28 04        	jr	z,goto006		; - 
 219++1409 1E FF        goto021	ld	e,#FF
 220++140B CB FE        	set	7,(hl)			;⨬ 
 221++140D
 222++140D              ;室, ᫨     
 223++140D 7B           goto006	ld	a,e
 224++140E 32 96 16     	ld	(ScanCodePresKey),a
 225++1411 3C           	inc	a
 226++1412 28 73        	jr	z,goto011
 227++1414
 228++1414              ;  ० ⮫쪮  cs+ss
 229++1414 E5           	push	hl
 230++1415 4E           	ld	c,(hl)			;c=(FlgScanKeys)
 231++1416              	IFDEF	CommandMode
 232++1416 CB 41        	 bit	0,c
 233++1418 28 02        	 jr	z,goto018		;몫祭 Command Mode
 234++141A              	 IFDEF	Used_ROM
 235++141A ~            	  ld	a,d
 236++141A ~            	  cp	#18
 237++141A ~            	  jr	z,goto019		; SS
 238++141A              	 ELSE
 239++141A CB 8A        	  res	1,d			; SS
 240++141C              	 ENDIF
 241++141C              	ENDIF
 242++141C
 243++141C              ;塞    ⨭᪮ ᪫  ᪠ 
 244++141C 7A           goto018	ld	a,d
 245++141D              	IFDEF	Used_ROM
 246++141D ~            	 ld	hl,tableSSkeys
 247++141D ~            	 cp	#18
 248++141D ~            	 jr	z,goto007		; ⮩ ss
 249++141D ~            	 ld	hl,tableCSkeys
 250++141D ~            	 cp	#27
 251++141D ~            	 jr	z,goto007		; ⮩ cs
 252++141D ~            goto019	 ld	hl,tablePrnKeys
 253++141D              	ELSE
 254++141D 21 21 15     	 ld	hl,tableSSkeys
 255++1420 FE 02        	 cp	#02
 256++1422 28 12        	 jr	z,goto007		; ⮩ ss
 257++1424              	 IFDEF	UseEXTkeys
 258++1424 21 49 15     	  ld	hl,tableEXTKeys
 259++1427 CB E9        	  set	5,c			;  cs+ss
 260++1429 30 0B        	  jr	nc,goto007		; ⮩ cs+ss
 261++142B CB A9        	  res	5,c
 262++142D              	 ENDIF
 263++142D 21 F9 14     	 ld	hl,tableCSkeys
 264++1430 B7           	 or	a
 265++1431 20 03        	 jr	nz,goto007		; ⮩ cs
 266++1433 21 D1 14     	 ld	hl,tablePrnKeys
 267++1436              	ENDIF
 268++1436 16 00        goto007	ld	d,#00
 269++1438 19           	add	hl,de
 270++1439 5E           	ld	e,(hl)			; 
 271++143A E1           	pop	hl
 272++143B 71           	ld	(hl),c
 273++143C 7B           	ld	a,e
 274++143D 3C           	inc	a
 275++143E 28 C9        	jr	z,goto021
 276++1440              ;de -   ⮩   ⨭᪮ ᪫   ० Caps
 277++1440
 278++1440              ;᫨ 祭  ० ⠭ ᨬ  孨 ॣ
 279++1440              	IFDEF	CommandMode
 280++1440 79           	 ld	a,c
 281++1441 E6 21        	 and	%00100001
 282++1443 20 0D        	 jr	nz,goto020		;祭 Command Mode
 283++1445              	ENDIF
 284++1445
 285++1445              ;४ ⭮   ⮬ ० CapsLock
 286++1445 7B           	ld	a,e
 287++1446 CB 49        	bit	1,c
 288++1448 28 13        	jr	z,goto008		;caps 몫祭
 289++144A FE 41        	cp	"A"
 290++144C 38 0F        	jr	c,goto008
 291++144E FE 5B        	cp	"Z"+1
 292++1450 38 09        	jr	c,goto009
 293++1452              	IFDEF	CommandMode
 294++1452 7B           goto020	 ld	a,e
 295++1453              	ENDIF
 296++1453 FE 61        	cp	"a"
 297++1455 38 06        	jr	c,goto008
 298++1457 FE 7B        	cp	"z"+1
 299++1459 30 02        	jr	nc,goto008
 300++145B EE 20        goto009	xor	%00100000
 301++145D 5F           goto008	ld	e,a
 302++145E              ;de,a -   ⮩   ⨭᪮ ᪫
 303++145E
 304++145E              ; ८ࠧ, ᫨ 祭  ०
 305++145E              	IFDEF	CommandMode
 306++145E 79           	 ld	a,c
 307++145F E6 21        	 and	%00100001
 308++1461 7B           	 ld	a,e
 309++1462 20 23        	 jr	nz,goto011		;祭 Command Mode
 310++1464              	ENDIF
 311++1464
 312++1464              ;⠭ ⭮   ᮮ⢥⢨  祭 ᪫: Grf\Rus\Lat
 313++1464              ;  grf ᪫
 314++1464              	IFDEF	GrfMode
 315++1464              	 IFDEF	InsideGrfTable
 316++1464 FE 20        	  cp	#20
 317++1466 38 1F        	  jr	c,goto011
 318++1468              	 ENDIF
 319++1468 21 51 15     	 ld	hl,TblKeyGrf
 320++146B CB 51        	 bit	2,c
 321++146D 20 16        	 jr	nz,goto010		;祭 Grf
 322++146F              	ENDIF
 323++146F              ;  rus ᪫
 324++146F              	IFDEF	RusMode
 325++146F CB 59        	 bit	3,c
 326++1471 28 14        	 jr	z,goto011		;᪫ rus 몫祭
 327++1473              	 IFDEF	InsideRusTable
 328++1473 FE 20        	  cp	#20
 329++1475 38 10        	  jr	c,goto011
 330++1477              	 ENDIF
 331++1477              	 IFDEF	Rus_jcuken
 332++1477 21 11 16     	  ld	hl,TblKeyRus_jcuken
 333++147A              	  IFDEF	Rus_qwerty
 334++147A CB 61        	   bit	4,c
 335++147C 20 07        	   jr	nz,goto010		;祭 ᪫ Rus 㪥
 336++147E              	  ENDIF
 337++147E              	 ENDIF
 338++147E              	 IFDEF	Rus_qwerty
 339++147E 21 B1 15     	  ld	hl,TblKeyRus_qwerty
 340++1481              	 ENDIF
 341++1481 18 02        	 jr	goto010
 342++1483              	ENDIF
 343++1483 18 02        	jr	goto011
 344++1485 19           goto010	add	hl,de
 345++1486 5E           	ld	e,(hl)
 346++1487              ;e -   ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
 347++1487              ;     ⮬ ० CapsLock
 348++1487
 349++1487 7B           goto011 ld      a,e
 350++1488 32 95 16             ld      (PrintCodePresKey),a
 351++148B C9                   ret
 352++148C
 353++148C              ;------------------------------------------------------------------------------
 354++148C              ScanAllKeys	ifused
 355++148C              ;    ( /  48k #028E)
 356++148C              ;ਬ砭: ⠡ ScanCode
 357++148C              ;Ŀ
 358++148C              ; 1  2  3  4  5  6  7  8  9  0 
 359++148C              ;#24#1C#14#0C#04#03#0B#13#1B#23
 360++148C              ;Ĵ
 361++148C              ; Q  W  Q  R  T  Y  U  I  O  P 
 362++148C              ;#25#1D#15#0D#05#02#0A#12#1A#22
 363++148C              ;Ĵ
 364++148C              ; A  S  D  F  G  h  J  K  L ent
 365++148C              ;#26#1E#16#0E#06#01#09#11#19#21
 366++148C              ;Ĵ
 367++148C              ;s  Z  X  C  V  B  N  M ss sp 
 368++148C              ;#27#1F#17#0F#07#00#08#10#18#20
 369++148C              ;
 370++148C              ;:  ----
 371++148C              ;: nz - ⨬ 
 372++148C              ;       hl,de,bc,a -  ।
 373++148C              ;     z  -       CS/SS    
 374++148C              ;       e =#FF -   
 375++148C              ;       0,d/c=1   c CS
 376++148C              ;       1,d/c=1   c SS
 377++148C              ;       e - ScanCode  ⮩ 
 378++148C              ;       a=#00
 379++148C              ;       hl,b -  ।
 380++148C              ;
 381++148C              ;ScanAllKeys
 382++148C              ;
 383++148C 2E 2F        	ld	l,#27+#08
 384++148E 11 FF FF     	ld	de,#FFFF
 385++1491 01 FF FE     	ld	bc,#FEFF
 386++1494
 387++1494              ;  ⠭ ⮢   ॣ c,d,e
 388++1494 78           loop003	ld	a,b
 389++1495 DB FE        	in	a,(#FE)
 390++1497 2F           	cpl
 391++1498 E6 1F        	and	#1F
 392++149A 28 0F        	jr	z,goto001
 393++149C 67           	ld	h,a
 394++149D 7D           	ld	a,l
 395++149E 0C           loop002	inc	c
 396++149F C0           	ret	nz			;   
 397++14A0 D6 08        loop001	sub	#08
 398++14A2 CB 3C        	srl	h
 399++14A4 30 FA        	jr	nc,loop001
 400++14A6 4A           	ld	c,d
 401++14A7 53           	ld	d,e
 402++14A8 5F           	ld	e,a			; ⮩ 
 403++14A9 20 F3        	jr	nz,loop002
 404++14AB 2D           goto001	dec	l
 405++14AC CB 00        	rlc	b
 406++14AE 38 E4        	jr	c,loop003
 407++14B0              ;=key 1, d=key 2, e=key 3
 408++14B0              ;=#FF, d=key 1, e=key 2
 409++14B0              ;=#FF, d=#FF, e=key 1
 410++14B0
 411++14B0              ;஢ઠ 権 
 412++14B0 79           	ld	a,c
 413++14B1 3C           	inc	a
 414++14B2 28 04        	jr	z,goto002		;    
 415++14B4 D6 28        	sub	#27+1
 416++14B6 C0           	ret	nz			;ࢠ   cs
 417++14B7 3C           	inc	a
 418++14B8 4F           goto002	ld	c,a			;0,c=0/1   cs/ cs
 419++14B9 7A           	ld	a,d
 420++14BA 3C           	inc	a
 421++14BB 28 11        	jr	z,goto004		;   -> e - ᪠/#FF
 422++14BD FE 28        	cp	#27+1
 423++14BF 28 0C        	jr	z,goto003
 424++14C1 FE 19        	cp	#18+1
 425++14C3 28 05        	jr	z,goto005		; ss
 426++14C5 7B           	ld	a,e
 427++14C6 5A           	ld	e,d
 428++14C7 FE 18        	cp	#18
 429++14C9 C0           	ret	nz			;⨬ 
 430++14CA CB C9        goto005	set	1,c			; ss
 431++14CC 0D           	dec	c
 432++14CD 0C           goto003	inc	c
 433++14CE 51           goto004	ld	d,c			;0,d=0/1 cs  /
 434++14CF AF           	xor	a			;1,d=0/1 ss  /
 435++14D0 C9           	ret
 436++14D1
 437++14D1                      endif
 438++14D1
 439++14D1              ;==============================================================================
 440++14D1              		ifused	tablePrnKeys
 441++14D1              ;⠡  
 442++14D1              ;cs - off
 443++14D1              ;ss - off
 444++14D1              ;
 445++14D1 62 68 79 36  tablePrnKeys	db "bhy65tgv"	;#00-#07
 445++14D5 35 74 67 76
 446++14D9 6E 6A 75 37  		db "nju74rfc"	;#08-#0F
 446++14DD 34 72 66 63
 447++14E1 6D 6B 69 38  		db "mki83edx"	;#10-#17
 447++14E5 33 65 64 78
 448++14E9 1D           		db keySS	;#18
 449++14EA 6C 6F 39 32  		db "lo92wsz"	;#19-#1F
 449++14EE 77 73 7A
 450++14F1 20           		db " "		;#20
 451++14F2 0D           		db keyEnter	;#21
 452++14F3 70 30 31 71  		db "p01qa"	;#22-#26
 452++14F7 61
 453++14F8 1C           		db keyCS	;#27
 454++14F9
 455++14F9              		endif
 456++14F9
 457++14F9              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 458++14F9              		ifused	tableCSkeys
 459++14F9              ;⠡  
 460++14F9              ;cs - on
 461++14F9              ;ss - off
 462++14F9              ;
 463++14F9 42 48 59     tableCSkeys	db "BHY"	;#00-#02
 464++14FC 0A           		db keyDown	;#03
 465++14FD 08           		db keyLeft	;#04
 466++14FE 54 47 56     		db "TGV"	;#05-#07
 467++1501 4E 4A 55     		db "NJU"	;#08-#0A
 468++1504 0B           		db keyUp	;#0B
 469++1505 05           		db keyPageDown	;#0C
 470++1506 52 46 43     		db "RFC"	;#0D-#0F
 471++1509 4D 4B 49     		db "MKI"	;#10-#12
 472++150C 09           		db keyRight	;#13
 473++150D 04           		db keyPageUp	;#14
 474++150E 45 44 58     		db "EDX"	;#15-#17
 475++1511 0E           		db keyExtMode	;#18
 476++1512 4C 4F        		db "LO"		;#19-#1A
 477++1514 0F           		db keyDelete	;#1B
 478++1515 06           		db keyCaps	;#1C
 479++1516 57 53 5A     		db "WSZ"	;#1D-#1F
 480++1519 18           		db keyBreak	;#20
 481++151A 19           		db keyCsEnter	;#21
 482++151B 50           		db "P"		;#22
 483++151C 0C           		db keyBackSpace	;#23
 484++151D 07           		db keyEdit	;#24
 485++151E 51 41        		db "QA"		;#25-#26
 486++1520 1C           		db keyCS	;#27
 487++1521
 488++1521              		endif
 489++1521
 490++1521              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 491++1521              		ifused	tableSSkeys
 492++1521              ;⠡  
 493++1521              ;cs - off
 494++1521              ;ss - on
 495++1521              ;
 496++1521 2A 5E 5B 26  tableSSkeys	db "*^[&%>}/"	;#00-#07
 496++1525 25 3E 7D 2F
 497++1529 2C 2D 5D 27  		db ",-]'$<{?"	;#08-#0F
 497++152D 24 3C 7B 3F
 498++1531 2E 2B 7F 28  		db ".+(#"	;#10-#14
 498++1535 23
 499++1536 03           		db keyEnd	;#15
 500++1537 5C 60        		db #5C,#60	;#16-#17 (\`)
 501++1539 1D           		db keySS	;#18
 502++153A 3D 3B 29 40  		db "=;)@"	;#19-#1C
 503++153E 02           		db keyInsert	;#1D
 504++153F 7C 3A        		db "|:"		;#1E-#1F
 505++1541 1A           		db keySsSpace	;#20
 506++1542 1B           		db keySsEnter	;#21
 507++1543 22           		db #22		;#22 (")
 508++1544 5F 21        		db "_!"		;#23-#24
 509++1546 01           		db keyHome	;#25
 510++1547 7E           		db "~"		;#26
 511++1548 0E           		db keyExtMode	;#27
 512++1549
 513++1549              		endif
 514++1549
 515++1549              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 516++1549              		ifused	tableEXTKeys
 517++1549              ;⠡  , ᪫  ZX-Word
 518++1549              ;cs - on
 519++1549              ;ss - on
 520++1549              ;
 521++1549              tableEXTKeys
 522++1549
 523++1549              		IFDEF	TblEXTkey_Test	;⮢ ᪫
 524++1549 42 48 59     		db "BHY"	;#00-#02
 525++154C 03           		db keyEnd	;#03 key 6
 526++154D 10           		db keyWordLeft	;#04 key 5
 527++154E 54 47 56     		db "TGV"	;#05-#07
 528++1551 4E 4A 55     		db "NJU"	;#08-#0A
 529++1554 01           		db keyHome	;#0B key 7
 530++1555 FF           		db #FF		;#0C key 4
 531++1556 52 46 43     		db "RFC"	;#0D-#0F
 532++1559 4D 4B 49     		db "MKI"	;#10-#12
 533++155C 11           		db keyWordRight	;#13 key 8
 534++155D FF           		db #FF		;#14 key 3
 535++155E 45 44 58     		db "EDX"	;#15-#17
 536++1561 FF           		db #FF		;#18 key SS
 537++1562 4C 4F        		db "LO"		;#19-#1A
 538++1564 13           		db keyDelEnd	;#1B key 9
 539++1565 FF           		db #FF		;#1C key 2
 540++1566 57 53 5A     		db "WSZ"	;#1D-#1F
 541++1569 14           		db keyCsSsSpace	;#20
 542++156A 15           		db keyCsSsEnter	;#21
 543++156B 50           		db "P"		;#22
 544++156C 16           		db keyDelBegin	;#23 key 0
 545++156D 12           		db keyGrf	;#24 key 1
 546++156E 51 41        		db "QA"		;#25-#26
 547++1570 FF           		db #FF		;#27 key CS
 548++1571              		ENDIF
 549++1571
 550++1571              		IFDEF	TblEXTkey_Word	; ZX-Word
 551++1571 ~            		db "BHY"	;#00-#02
 552++1571 ~            		db keyEnd	;#03 key 6
 553++1571 ~            		db keyWordLeft	;#04 key 5
 554++1571 ~            		db "TG",#FF	;#05-#07
 555++1571 ~            		db #FF,#FF,#FF	;#08-#0A
 556++1571 ~            		db keyHome	;#0B key 7
 557++1571 ~            		db #FF		;#0C key 4
 558++1571 ~            		db "RFC"	;#0D-#0F
 559++1571 ~            		db #FF,#FF,#FF	;#10-#12
 560++1571 ~            		db keyWordRight	;#13 key 8
 561++1571 ~            		db #FF		;#14 key 3
 562++1571 ~            		db "EDX"	;#15-#17
 563++1571 ~            		db #FF		;#18 key SS
 564++1571 ~            		db #FF,"O"	;#19-#1A
 565++1571 ~            		db keyDelete	;#1B key 9
 566++1571 ~            		db keyInsert	;#1C key 2
 567++1571 ~            		db #FF,#FF,"Z"	;#1D-#1F
 568++1571 ~            		db #FF		;#20
 569++1571 ~            		db #FF		;#21
 570++1571 ~            		db "P"		;#22
 571++1571 ~            		db keyBackSpace	;#23 key 0
 572++1571 ~            		db keyEdit	;#24 key 1
 573++1571 ~            		db "Q",#FF	;#25-#26
 574++1571 ~            		db #FF		;#27 key CS
 575++1571              		ENDIF
 576++1571
 577++1571              		endif
 578++1571
 579++1571              ;------------------------------------------------------------------------------
 580++1571              	IFDEF	GrfMode
 581++1571              	IFDEF	TblKeyGrf_ver1
 582++1571              	IFDEF	InsideGrfTable
 583++1571
 584++1571              ;᪠ ᪫: version 01
 585++1571              ;
 586++1571              TblKeyGrf	equ $-#20
 587++1571              ;
 588++1571              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 589++1571              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 590++1571              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 591++1571              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 592++1571 20 21 22 23  	db " !",#22,"#$%&'"
 592++1575 24 25 26 27
 593++1579 28 29 2A 2B  	db "()*+,-./"
 593++157D 2C 2D 2E 2F
 594++1581 30 31 32 33  	db "01234567"
 594++1585 34 35 36 37
 595++1589 38 39 3A 3B  	db "89:;<=>?"
 595++158D 3C 3D 3E 3F
 596++1591 40 C7 D4 BD  	db "@Խ"
 596++1595 B6 B7 BA C6
 597++1599 D8 CD B5 B3  	db "͵۾"
 597++159D DB BE CF DD
 598++15A1 DE D6 C4 D7  	db "ո"
 598++15A5 D5 B8 F0 D2
 599++15A9 D0 D1 D3 5B  	db "[",#5C,"]^_"
 599++15AD 5C 5D 5E 5F
 600++15B1 60 C3 C8 D9  	db "`ٴ"
 600++15B5 B4 BF B3 CC
 601++15B9 CE CD B9 BA  	db "͹ʱ"
 601++15BD B0 BC CA B1
 602++15C1 B2 DA C4 C5  	db "ɻ"
 602++15C5 C9 BB FB C2
 603++15C9 C1 CB C0 7B  	db "{|}~"
 603++15CD 7C 7D 7E 7F
 604++15D1
 605++15D1              	ELSE
 606++15D1 ~            TblKeyGrf	equ	OutsideGrfTable
 607++15D1              	ENDIF
 608++15D1              	ENDIF
 609++15D1              	ENDIF
 610++15D1
 611++15D1              ;------------------------------------------------------------------------------
 612++15D1              	IFDEF	RusMode
 613++15D1              	IFDEF	Rus_qwerty
 614++15D1              	IFDEF	InsideRusTable
 615++15D1
 616++15D1              ;᪠ ᪫: 
 617++15D1              ;
 618++15D1              TblKeyRus_qwerty	equ $-#20
 619++15D1              ;
 620++15D1              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 621++15D1              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 622++15D1              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 623++15D1              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 624++15D1 20 21 22 23  	db " !",#22,"#$%&'"
 624++15D5 24 25 26 27
 625++15D9 28 29 2A 2B  	db "()*+,-./"
 625++15DD 2C 2D 2E 2F
 626++15E1 30 31 32 33  	db "01234567"
 626++15E5 34 35 36 37
 627++15E9 38 39 3A 3B  	db "89:;<=>?"
 627++15ED 3C 3D 3E 3F
 628++15F1 40 80 81 96  	db "@"
 628++15F5 84 85 94 83
 629++15F9 95 88 89 8A  	db ""
 629++15FD 8B 8C 8D 8E
 630++1601 8F 9F 90 91  	db ""
 630++1605 92 93 86 82
 631++1609 9C 9B 87 5B  	db "[",#5C,"]^"
 631++160D 5C 5D 5E 9A
 632++1611 9E A0 A1 E6  	db "椥"
 632++1615 A4 A5 E4 A3
 633++1619 E5 A8 A9 AA  	db "娩"
 633++161D AB AC AD AE
 634++1621 AF EF E0 E1  	db "㦢"
 634++1625 E2 E3 A6 A2
 635++1629 EC EB A7 98  	db "맘"
 635++162D 9D 99 97 7F
 636++1631
 637++1631              	ELSE
 638++1631 ~            TblKeyRus_qwerty	equ	OutsideRus_qwerty
 639++1631              	ENDIF
 640++1631              	ENDIF
 641++1631              	ENDIF
 642++1631
 643++1631              ;------------------------------------------------------------------------------
 644++1631              	IFDEF	RusMode
 645++1631              	IFDEF	Rus_jcuken
 646++1631              	IFDEF	InsideRusTable
 647++1631
 648++1631              ;᪠ ᪫: 㪥
 649++1631              ;
 650++1631              TblKeyRus_jcuken	equ	$-#20
 651++1631              ;
 652++1631              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 653++1631              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 654++1631              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 655++1631              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 656++1631 20 21 22 23  	db " !",#22,"#$%&'"
 656++1635 24 25 26 27
 657++1639 28 29 2A 2B  	db "()*+,-./"
 657++163D 2C 2D 2E 2F
 658++1641 30 31 32 33  	db "01234567"
 658++1645 34 35 36 37
 659++1649 38 39 3A 3B  	db "89:;<=>?"
 659++164D 3C 3D 3E 3F
 660++1651 9E 94 88 91  	db ""
 660++1655 82 93 80 8F
 661++1659 90 98 8E 8B  	db ""
 661++165D 84 9C 92 99
 662++1661 87 89 8A 9B  	db ""
 662++1665 85 83 8C 96
 663++1669 97 8D 9F 95  	db ""
 663++166D 9D 86 81 9A
 664++1671 EE E4 A8 E1  	db "㠯"
 664++1675 A2 E3 A0 AF
 665++1679 E0 E8 AE AB  	db "讫"
 665++167D A4 EC E2 E9
 666++1681 A7 A9 AA EB  	db "륣"
 666++1685 A5 A3 AC E6
 667++1689 E7 AD EF E5  	db ""
 667++168D ED A6 A1 7F
 668++1691
 669++1691              	ELSE
 670++1691 ~            TblKeyRus_jcuken	equ	OutsideRus_jcuken
 671++1691              	ENDIF
 672++1691              	ENDIF
 673++1691              	ENDIF
 674++1691
 675++1691              ;------------------------------------------------------------------------------
 676++1691              	ifused	TblKeyLat
 677++1691 ~            ;⠭⭠ ⨭᪠ ᪫
 678++1691 ~            ;
 679++1691 ~            TblKeyLat	equ	$-#20
 680++1691 ~            ;
 681++1691 ~            ;	db #00,#01,#02,#03,#04,#05,#06,#07
 682++1691 ~            ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 683++1691 ~            ;	db #10,#11,#12,#13,#14,#15,#16,#17
 684++1691 ~            ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 685++1691 ~            	db " !",""","#$%&'"
 686++1691 ~            	db "()*+,-./"
 687++1691 ~            	db "01234567"
 688++1691 ~            	db "89:;<=>?"
 689++1691 ~            	db "@ABCDEFG"
 690++1691 ~            	db "HIJKLMNO"
 691++1691 ~            	db "PQRSTUVW"
 692++1691 ~            	db "XYZ[\]^_"
 693++1691 ~            	db "`abcdefg"
 694++1691 ~            	db "hijklmno"
 695++1691 ~            	db "pqrstuvw"
 696++1691 ~            	db "xyz{|}~"
 697++1691 ~
 698++1691              	endif
 699++1691
 700++1691              ;==============================================================================
 701++1691
# file closed: Drv/DrvKey.asm.a80
 117+ 1691              	INCLUDE	"DrvKey.var.a80"
# file opened: Drv/DrvKey.var.a80
   1++1691              ;६ Keyboard Driver
   2++1691              ;䠩 DrvKey.var.a80
   3++1691              ;
   4++1691              ;䫠 ࠩ
   5++1691              ;7,=1     
   6++1691              ;6,=1     
   7++1691              ;5,=1 ᨬ  ० cs+ss+key
   8++1691              ;4,=1/0 Rus 㪥/Rus 
   9++1691              ;3,=1/0 Rus/Lat
  10++1691              ;2,=1/0 Grf on/off
  11++1691              ;1,=1/0 CapsLock on/off
  12++1691              ;0,=1/0 Command on/off
  13++1691 30           FlgScanKeys     db %00110000
  14++1692 00           		db %00000000	;१
  15++1693
  16++1693              ;稭 প  ⮯
  17++1693 0F           KeyRepeatDelay    db #0F
  18++1694              ;ਮ ⮯
  19++1694 05           KeyRepeatPeriod   db #05
  20++1695
  21++1695              ;  ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
  22++1695              ;   ⮬ ० CapsLock
  23++1695 00           PrintCodePresKey  db #00
  24++1696              ;᪠ ⮩ 
  25++1696 00           ScanCodePresKey   db #00
  26++1697
  27++1697
# file closed: Drv/DrvKey.var.a80
 118+ 1697              End	DISPLAY	"Lenght DrvKey = ",/A,End-Start
 119+ 1697              ;	SAVEBIN	"!bin/drvkeys.bin",Start,End-Start
 120+ 1697              	ENDMODULE
 121+ 1697
# file closed: Drv/DrvKey.main.a80
2468  1697              	include player.asm ;плеер AY, TS
# file opened: player.asm
   1+ 1697              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2+ 1697              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3+ 1697              ;Specially for AlCo
   4+ 1697              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5+ 1697              	MODULE VTPL
   6+ 1697              ;Release number
   7+ 1697              Release EQU "0"
   8+ 1697              ;Conditional assembly
   9+ 1697              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10+ 1697              CurPosCounter=0
  11+ 1697              ;2) Allow channels allocation bits at (START+10)
  12+ 1697              ACBBAC=0
  13+ 1697              ;3) Allow loop checking and disabling
  14+ 1697              LoopChecker=1
  15+ 1697              ;4) Insert official identificator
  16+ 1697              Id=0
  17+ 1697              ;5) Set IY for correct return to ZX Basic
  18+ 1697              Basic=1
  19+ 1697
  20+ 1697              ;Features
  21+ 1697              ;--------
  22+ 1697              ;-Can be compiled at any address (i.e. no need rounding ORG
  23+ 1697              ; address).
  24+ 1697              ;-Variables (VARS) can be located at any address (not only after
  25+ 1697              ; code block).
  26+ 1697              ;-INIT subprogram checks PT3-module version and rightly
  27+ 1697              ; generates both note and volume tables outside of code block
  28+ 1697              ; (in VARS).
  29+ 1697              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30+ 1697              ; PT3 module version).
  31+ 1697              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32+ 1697              ; and higher).
  33+ 1697              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34+ 1697              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35+ 1697              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36+ 1697              ;-See also notes at the end of this source code.
  37+ 1697
  38+ 1697              ;Limitations
  39+ 1697              ;-----------
  40+ 1697              ;-Can run in RAM only (self-modified code is used).
  41+ 1697              ;-PT2 position list must be end by #FF marker only.
  42+ 1697
  43+ 1697              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44+ 1697              ;into RAM or INIT subprogram was not called before.
  45+ 1697
  46+ 1697              ;Call MUTE or INIT one more time to mute sound after stopping
  47+ 1697              ;playing
  48+ 1697
  49+ 1697              ;Test codes (commented)
  50+ 1697              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51+ 1697              ;	LD (START+10),A
  52+ 1697              ;	LD HL,#8000 ;Mod1
  53+ 1697              ;	LD DE,#A000 ;Mod2 (optional)
  54+ 1697              ;	CALL START+3
  55+ 1697              ;	EI
  56+ 1697              ;_LP	HALT
  57+ 1697              ;	CALL START+5
  58+ 1697              ;	XOR A
  59+ 1697              ;	IN A,(#FE)
  60+ 1697              ;	CPL
  61+ 1697              ;	AND 15
  62+ 1697              ;	JR Z,_LP
  63+ 1697              ;	JR START+8
  64+ 1697
  65+ 1697              TonA	EQU 0
  66+ 1697              TonB	EQU 2
  67+ 1697              TonC	EQU 4
  68+ 1697              Noise	EQU 6
  69+ 1697              Mixer	EQU 7
  70+ 1697              AmplA	EQU 8
  71+ 1697              AmplB	EQU 9
  72+ 1697              AmplC	EQU 10
  73+ 1697              Env	EQU 11
  74+ 1697              EnvTp	EQU 13
  75+ 1697
  76+ 1697              ;Entry and other points
  77+ 1697              ;START initialize playing of modules at MDLADDR (single module)
  78+ 1697              ;START+3 initialization with module address in HL and DE (TS)
  79+ 1697              ;START+5 play one quark
  80+ 1697              ;START+8 mute
  81+ 1697              ;START+10 setup and status flags
  82+ 1697
  83+ 1697              START:
  84+ 1697 21 00 C0     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85+ 169A 18 3C        	JR INIT
  86+ 169C C3 FB 1E     	JP PLAY
  87+ 169F 18 25        	JR MUTE
  88+ 16A1 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89+ 16A2              	     ;(optional);
  90+ 16A2              	     ;set bit1 for PT2 and reset for PT3 before
  91+ 16A2              	     ;calling INIT;
  92+ 16A2              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93+ 16A2              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94+ 16A2              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95+ 16A2              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96+ 16A2              	     ;documented and must be converted to new standard.
  97+ 16A2              	     ;bit6 is set each time, when loop point of 2nd TS
  98+ 16A2              	     ;module is passed (optional).
  99+ 16A2              	     ;bit7 is set each time, when loop point of 1st TS
 100+ 16A2              	     ;or of single module is passed (optional).
 101+ 16A2
 102+ 16A2              ;Identifier
 103+ 16A2              	IF Id
 104+ 16A2 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105+ 16A2              	ENDIF
 106+ 16A2
 107+ 16A2              	IF LoopChecker
 108+ 16A2 21 A1 16     CHECKLP	LD HL,SETUP
 109+ 16A5 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110+ 16A9 28 04        	JR Z,CHL1
 111+ 16AB CB F6        	SET 6,(HL)
 112+ 16AD 18 02        	JR CHL2
 113+ 16AF CB FE        CHL1	SET 7,(HL)
 114+ 16B1 CB 46        CHL2	BIT 0,(HL)
 115+ 16B3 C8           	RET Z
 116+ 16B4 E1           	POP HL
 117+ 16B5 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118+ 16B8 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119+ 16BB AF           	XOR A
 120+ 16BC FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121+ 16BF FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122+ 16C2 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123+ 16C5 C9           	RET
 124+ 16C6              	ENDIF
 125+ 16C6
 126+ 16C6 AF           MUTE: XOR A
 127+ 16C7 67           	LD H,A
 128+ 16C8 6F           	LD L,A
 129+ 16C9 32 50 20     	LD (VARS1+VRS.AYREGS+AmplA),A
 130+ 16CC 22 51 20     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131+ 16CF 32 D7 20     	LD (VARS2+VRS.AYREGS+AmplA),A
 132+ 16D2 22 D8 20     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133+ 16D5 C3 13 1F     	JP ROUT
 134+ 16D8
 135+ 16D8              INIT:
 136+ 16D8              ;HL - AddressOfModule
 137+ 16D8              ;DE - AddresOf2ndModule
 138+ 16D8 D5           	PUSH DE
 139+ 16D9 E5           	PUSH HL
 140+ 16DA 21 CE 1F     	LD HL,VARS
 141+ 16DD 36 00        	LD (HL),0
 142+ 16DF 11 CF 1F     	LD DE,VARS+1
 143+ 16E2 01 0E 01     	LD BC,VAR0END-VARS-1
 144+ 16E5 ED B0        	LDIR
 145+ 16E7 23           	INC HL
 146+ 16E8 22 31 20     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147+ 16EB 22 B8 20     	LD (VARS2+VRS.AdInPtA),HL
 148+ 16EE
 149+ 16EE E1           	POP HL
 150+ 16EF FD 21 33 20  	LD IY,VARS1+100
 151+ 16F3 3A A1 16     	LD A,(START+10)
 152+ 16F6 E6 02        	AND 2
 153+ 16F8 C2 81 17     	JP NZ,I_PT2
 154+ 16FB
 155+ 16FB CD CE 18     	CALL INITPT3
 156+ 16FE 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157+ 1701 22 A1 1C     	LD (SamCnv),HL
 158+ 1704 3E BA        	LD A,#BA
 159+ 1706 32 6C 1C     	LD (OrnCP),A
 160+ 1709 32 98 1C     	LD (SamCP),A
 161+ 170C 3E 7B        	LD A,#7B
 162+ 170E 32 6F 1C     	LD (OrnLD),A
 163+ 1711 32 9B 1C     	LD (SamLD),A
 164+ 1714 3E 87        	LD A,#87
 165+ 1716 32 92 1C     	LD (SamClc2),A
 166+ 1719 E1           	POP HL
 167+ 171A              	;Use version and ton table of 1st module
 168+ 171A DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169+ 171D D6 30        	SUB #30
 170+ 171F 38 04        	JR C,L20
 171+ 1721 FE 0A        	CP 10
 172+ 1723 38 02        	JR C,L21
 173+ 1725 3E 06        L20	LD A,6
 174+ 1727 32 3F 1B     L21	LD (Version),A
 175+ 172A F5           	PUSH AF ;VolTable version
 176+ 172B FE 04        	CP 4
 177+ 172D DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178+ 1730 17           	RLA
 179+ 1731 E6 07        	AND 7
 180+ 1733 F5           	PUSH AF ;NoteTable number
 181+ 1734
 182+ 1734 FD 21 BA 20  	LD IY,VARS2+100
 183+ 1738 3A A1 16     	LD A,(START+10)
 184+ 173B E6 30        	AND 48
 185+ 173D 28 37        	JR Z,NOTS
 186+ 173F FE 10        	CP 16
 187+ 1741 28 27        	JR Z,TwoPT3s
 188+ 1743 3A 3F 1B     	LD A,(Version)
 189+ 1746 FE 07        	CP 7
 190+ 1748 38 2C        	JR C,NOTS
 191+ 174A DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192+ 174D FE 20        	CP #20
 193+ 174F 28 25        	JR Z,NOTS
 194+ 1751 21 CF 1F     	LD HL,VARS1
 195+ 1754 11 56 20     	LD DE,VARS2
 196+ 1757 01 87 00     	LD BC,VRS
 197+ 175A ED B0        	LDIR
 198+ 175C FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199+ 1760 4F           	LD C,A
 200+ 1761 87           	ADD A,A
 201+ 1762 81           	ADD A,C
 202+ 1763 D6 02        	SUB 2
 203+ 1765 32 06 1E     	LD (TSSub),A
 204+ 1768 18 03        	JR AlCoTS_
 205+ 176A CD CE 18     TwoPT3s	CALL INITPT3
 206+ 176D 3E 01        AlCoTS_	LD A,1
 207+ 176F 32 CE 1F     	LD (is_ts),A
 208+ 1772 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209+ 1776
 210+ 1776 01 8B 1A     NOTS	LD BC,PT3PD
 211+ 1779 21 00 00     	LD HL,0
 212+ 177C 11 96 1F     	LD DE,PT3EMPTYORN
 213+ 177F 18 48        	JR INITCOMMON
 214+ 1781
 215+ 1781 CD 06 19     I_PT2	CALL INITPT2
 216+ 1784 21 CB 51     	LD HL,#51CB
 217+ 1787 22 A1 1C     	LD (SamCnv),HL
 218+ 178A 3E BB        	LD A,#BB
 219+ 178C 32 6C 1C     	LD (OrnCP),A
 220+ 178F 32 98 1C     	LD (SamCP),A
 221+ 1792 3E 7A        	LD A,#7A
 222+ 1794 32 6F 1C     	LD (OrnLD),A
 223+ 1797 32 9B 1C     	LD (SamLD),A
 224+ 179A 3E 80        	LD A,#80
 225+ 179C 32 92 1C     	LD (SamClc2),A
 226+ 179F E1           	POP HL
 227+ 17A0 3E 05        	LD A,5
 228+ 17A2 32 3F 1B     	LD (Version),A
 229+ 17A5 F5           	PUSH AF
 230+ 17A6 3E 02        	LD A,2
 231+ 17A8 F5           	PUSH AF
 232+ 17A9
 233+ 17A9 3A A1 16     	LD A,(START+10)
 234+ 17AC E6 30        	AND 48
 235+ 17AE 28 10        	JR Z,NOTS2
 236+ 17B0
 237+ 17B0 FD 21 BA 20  	LD IY,VARS2+100
 238+ 17B4 3E 01        	LD A,1
 239+ 17B6 32 CE 1F     	LD (is_ts),A
 240+ 17B9 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241+ 17BD CD 06 19     	CALL INITPT2
 242+ 17C0
 243+ 17C0 01 C5 19     NOTS2	LD BC,PT2PD
 244+ 17C3 21 87 86     	LD HL,#8687
 245+ 17C6 11 EC 20     	LD DE,PT2EMPTYORN
 246+ 17C9
 247+ 17C9              INITCOMMON
 248+ 17C9
 249+ 17C9              	IF Basic
 250+ 17C9 FD 21 3A 5C  	LD IY,#5C3A
 251+ 17CD              	ENDIF
 252+ 17CD
 253+ 17CD ED 43 76 19  	LD (PTDEC),BC
 254+ 17D1 22 08 1E     	LD (PsCalc),HL
 255+ 17D4 D5           	PUSH DE
 256+ 17D5
 257+ 17D5              ;note table data depacker
 258+ 17D5              ;(c) Ivan Roshin
 259+ 17D5 11 99 1F     	LD DE,T_PACK
 260+ 17D8 01 3E 21     	LD BC,T1_+(2*49)-1
 261+ 17DB 1A           TP_0	LD A,(DE)
 262+ 17DC 13           	INC DE
 263+ 17DD FE 1E        	CP 15*2
 264+ 17DF 30 06        	JR NC,TP_1
 265+ 17E1 67           	LD H,A
 266+ 17E2 1A           	LD A,(DE)
 267+ 17E3 6F           	LD L,A
 268+ 17E4 13           	INC DE
 269+ 17E5 18 07        	JR TP_2
 270+ 17E7 D5           TP_1	PUSH DE
 271+ 17E8 16 00        	LD D,0
 272+ 17EA 5F           	LD E,A
 273+ 17EB 19           	ADD HL,DE
 274+ 17EC 19           	ADD HL,DE
 275+ 17ED D1           	POP DE
 276+ 17EE 7C           TP_2	LD A,H
 277+ 17EF 02           	LD (BC),A
 278+ 17F0 0B           	DEC BC
 279+ 17F1 7D           	LD A,L
 280+ 17F2 02           	LD (BC),A
 281+ 17F3 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282+ 17F4 D6 F0        	SUB #F8*2
 283+ 17F6 20 E3        	JR NZ,TP_0
 284+ 17F8
 285+ 17F8 3C           	INC A
 286+ 17F9 32 3C 20     	LD (VARS1+VRS.DelyCnt),A
 287+ 17FC 32 C3 20     	LD (VARS2+VRS.DelyCnt),A
 288+ 17FF 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289+ 1802 22 ED 1F     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290+ 1805 22 0A 20     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291+ 1808 22 27 20     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292+ 180B 22 74 20     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293+ 180E 22 91 20     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294+ 1811 22 AE 20     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295+ 1814 E1           	POP HL
 296+ 1815 22 DF 1F     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297+ 1818 22 FC 1F     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298+ 181B 22 19 20     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299+ 181E 22 66 20     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300+ 1821 22 83 20     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301+ 1824 22 A0 20     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302+ 1827
 303+ 1827 F1           	POP AF
 304+ 1828
 305+ 1828              ;NoteTableCreator (c) Ivan Roshin
 306+ 1828              ;A - NoteTableNumber*2+VersionForNoteTable
 307+ 1828              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308+ 1828
 309+ 1828 21 46 1F     	LD HL,NT_DATA
 310+ 182B 16 00        	LD D,0
 311+ 182D 87           	ADD A,A
 312+ 182E 5F           	LD E,A
 313+ 182F 19           	ADD HL,DE
 314+ 1830 5E           	LD E,(HL)
 315+ 1831 23           	INC HL
 316+ 1832 CB 3B        	SRL E
 317+ 1834 9F           	SBC A,A
 318+ 1835 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319+ 1837 32 5F 18     	LD (L3),A
 320+ 183A EB           	EX DE,HL
 321+ 183B 01 DD 20     	LD BC,T1_
 322+ 183E 09           	ADD HL,BC
 323+ 183F
 324+ 183F 1A           	LD A,(DE)
player.asm(325): warning: value 0x1F56 is truncated to 8bit value: 0x56
 325+ 1840 C6 56        	ADD A,T_
 326+ 1842 4F           	LD C,A
 327+ 1843 CE 1F        	ADC A,T_/256
 328+ 1845 91           	SUB C
 329+ 1846 47           	LD B,A
 330+ 1847 C5           	PUSH BC
 331+ 1848 11 CD 21     	LD DE,NT_
 332+ 184B D5           	PUSH DE
 333+ 184C
 334+ 184C 06 0C        	LD B,12
 335+ 184E C5           L1	PUSH BC
 336+ 184F 4E           	LD C,(HL)
 337+ 1850 23           	INC HL
 338+ 1851 E5           	PUSH HL
 339+ 1852 46           	LD B,(HL)
 340+ 1853
 341+ 1853 D5           	PUSH DE
 342+ 1854 EB           	EX DE,HL
 343+ 1855 11 17 00     	LD DE,23
 344+ 1858 DD 26 08     	LD IXH,8
 345+ 185B
 346+ 185B CB 38        L2	SRL B
 347+ 185D CB 19        	RR C
 348+ 185F 19           L3	DB #19	;AND A or NOP
 349+ 1860 79           	LD A,C
 350+ 1861 8A           	ADC A,D	;=ADC 0
 351+ 1862 77           	LD (HL),A
 352+ 1863 23           	INC HL
 353+ 1864 78           	LD A,B
 354+ 1865 8A           	ADC A,D
 355+ 1866 77           	LD (HL),A
 356+ 1867 19           	ADD HL,DE
 357+ 1868 DD 25        	DEC IXH
 358+ 186A 20 EF        	JR NZ,L2
 359+ 186C
 360+ 186C D1           	POP DE
 361+ 186D 13           	INC DE
 362+ 186E 13           	INC DE
 363+ 186F E1           	POP HL
 364+ 1870 23           	INC HL
 365+ 1871 C1           	POP BC
 366+ 1872 10 DA        	DJNZ L1
 367+ 1874
 368+ 1874 E1           	POP HL
 369+ 1875 D1           	POP DE
 370+ 1876
 371+ 1876 7B           	LD A,E
player.asm(372): warning: value 0x1F62 is truncated to 8bit value: 0x62
 372+ 1877 FE 62        	CP TCOLD_1
 373+ 1879 20 05        	JR NZ,CORR_1
 374+ 187B 3E FD        	LD A,#FD
 375+ 187D 32 FB 21     	LD (NT_+#2E),A
 376+ 1880
 377+ 1880 1A           CORR_1	LD A,(DE)
 378+ 1881 A7           	AND A
 379+ 1882 28 11        	JR Z,TC_EXIT
 380+ 1884 1F           	RRA
 381+ 1885 F5           	PUSH AF
 382+ 1886 87           	ADD A,A
 383+ 1887 4F           	LD C,A
 384+ 1888 09           	ADD HL,BC
 385+ 1889 F1           	POP AF
 386+ 188A 30 02        	JR NC,CORR_2
 387+ 188C 35           	DEC (HL)
 388+ 188D 35           	DEC (HL)
 389+ 188E 34           CORR_2	INC (HL)
 390+ 188F A7           	AND A
 391+ 1890 ED 42        	SBC HL,BC
 392+ 1892 13           	INC DE
 393+ 1893 18 EB        	JR CORR_1
 394+ 1895
 395+ 1895              TC_EXIT
 396+ 1895
 397+ 1895 F1           	POP AF
 398+ 1896
 399+ 1896              ;VolTableCreator (c) Ivan Roshin
 400+ 1896              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401+ 1896              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402+ 1896
 403+ 1896 FE 05        	CP 5
 404+ 1898 21 11 00     	LD HL,#11
 405+ 189B 54           	LD D,H
 406+ 189C 5C           	LD E,H
 407+ 189D 3E 17        	LD A,#17
 408+ 189F 30 03        	JR NC,M1
 409+ 18A1 2D           	DEC L
 410+ 18A2 5D           	LD E,L
 411+ 18A3 AF           	XOR A
 412+ 18A4 32 B5 18     M1      LD (M2),A
 413+ 18A7
 414+ 18A7 DD 21 DD 20  	LD IX,VT_+16
 415+ 18AB
 416+ 18AB 0E 0F        	LD C,#F
 417+ 18AD E5           INITV2  PUSH HL
 418+ 18AE
 419+ 18AE 19           	ADD HL,DE
 420+ 18AF EB           	EX DE,HL
 421+ 18B0 ED 62        	SBC HL,HL
 422+ 18B2
 423+ 18B2 06 10        	LD B,#10
 424+ 18B4 7D           INITV1  LD A,L
 425+ 18B5 7D           M2      DB #7D
 426+ 18B6 7C           	LD A,H
 427+ 18B7 CE 00        	ADC A,0
 428+ 18B9 DD 77 00     	LD (IX),A
 429+ 18BC DD 23        	INC IX
 430+ 18BE 19           	ADD HL,DE
 431+ 18BF 10 F3        	DJNZ INITV1
 432+ 18C1
 433+ 18C1 E1           	POP HL
 434+ 18C2 7B           	LD A,E
 435+ 18C3 FE 77        	CP #77
 436+ 18C5 20 01        	JR NZ,M3
 437+ 18C7 1C           	INC E
 438+ 18C8 0D           M3      DEC C
 439+ 18C9 20 E2        	JR NZ,INITV2
 440+ 18CB
 441+ 18CB C3 13 1F     	JP ROUT
 442+ 18CE
 443+ 18CE CD 41 19     INITPT3	CALL SETMDAD
 444+ 18D1 E5           	PUSH HL
 445+ 18D2 11 64 00     	LD DE,100
 446+ 18D5 19           	ADD HL,DE
 447+ 18D6 7E           	LD A,(HL)
 448+ 18D7 FD 77 08     	LD (IY-100+VRS.Delay),A
 449+ 18DA E5           	PUSH HL
 450+ 18DB DD E1        	POP IX
 451+ 18DD 19           	ADD HL,DE
 452+ 18DE CD 4F 19     	CALL SETCPPT
 453+ 18E1 DD 5E 02     	LD E,(IX+102-100)
 454+ 18E4 23           	INC HL
 455+ 18E5
 456+ 18E5              	IF CurPosCounter
 457+ 18E5 ~            	LD (IY-100+VRS.PosSub),L
 458+ 18E5              	ENDIF
 459+ 18E5
 460+ 18E5 19           	ADD HL,DE
 461+ 18E6 CD 56 19     	CALL SETLPPT
 462+ 18E9 D1           	POP DE
 463+ 18EA DD 6E 03     	LD L,(IX+103-100)
 464+ 18ED DD 66 04     	LD H,(IX+104-100)
 465+ 18F0 19           	ADD HL,DE
 466+ 18F1 CD 3A 19     	CALL SETPTPT
 467+ 18F4 21 A9 00     	LD HL,169
 468+ 18F7 19           	ADD HL,DE
 469+ 18F8 CD 48 19     	CALL SETORPT
 470+ 18FB 21 69 00     	LD HL,105
 471+ 18FE 19           	ADD HL,DE
 472+ 18FF
 473+ 18FF FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474+ 1902 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475+ 1905 C9           	RET
 476+ 1906
 477+ 1906 7E           INITPT2	LD A,(HL)
 478+ 1907 FD 77 08     	LD (IY-100+VRS.Delay),A
 479+ 190A E5           	PUSH HL
 480+ 190B E5           	PUSH HL
 481+ 190C E5           	PUSH HL
 482+ 190D 23           	INC HL
 483+ 190E 23           	INC HL
 484+ 190F 7E           	LD A,(HL)
 485+ 1910 23           	INC HL
 486+ 1911 CD FF 18     	CALL SETSMPT
 487+ 1914 5E           	LD E,(HL)
 488+ 1915 23           	INC HL
 489+ 1916 56           	LD D,(HL)
 490+ 1917 E1           	POP HL
 491+ 1918 A7           	AND A
 492+ 1919 ED 52        	SBC HL,DE
 493+ 191B CD 41 19     	CALL SETMDAD
 494+ 191E E1           	POP HL
 495+ 191F 11 43 00     	LD DE,67
 496+ 1922 19           	ADD HL,DE
 497+ 1923 CD 48 19     	CALL SETORPT
 498+ 1926 1E 20        	LD E,32
 499+ 1928 19           	ADD HL,DE
 500+ 1929 4E           	LD C,(HL)
 501+ 192A 23           	INC HL
 502+ 192B 46           	LD B,(HL)
 503+ 192C 1E 1E        	LD E,30
 504+ 192E 19           	ADD HL,DE
 505+ 192F CD 4F 19     	CALL SETCPPT
 506+ 1932 5F           	LD E,A
 507+ 1933 23           	INC HL
 508+ 1934
 509+ 1934              	IF CurPosCounter
 510+ 1934 ~            	LD (IY-100+VRS.PosSub),L
 511+ 1934              	ENDIF
 512+ 1934
 513+ 1934 19           	ADD HL,DE
 514+ 1935 CD 56 19     	CALL SETLPPT
 515+ 1938 E1           	POP HL
 516+ 1939 09           	ADD HL,BC
 517+ 193A
 518+ 193A FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519+ 193D FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520+ 1940 C9           	RET
 521+ 1941
 522+ 1941 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523+ 1944 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524+ 1947 C9           	RET
 525+ 1948
 526+ 1948 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527+ 194B FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528+ 194E C9           	RET
 529+ 194F
 530+ 194F FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531+ 1952 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532+ 1955 C9           	RET
 533+ 1956
 534+ 1956 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535+ 1959 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536+ 195C C9           	RET
 537+ 195D
 538+ 195D FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539+ 1960 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540+ 1963 C9           	RET
 541+ 1964
 542+ 1964 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543+ 1967 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544+ 196A C9           	RET
 545+ 196B
 546+ 196B FD E5        GETIX	PUSH IY
 547+ 196D DD E1        	POP IX
 548+ 196F DD 19        	ADD IX,DE
 549+ 1971 C9           	RET
 550+ 1972
 551+ 1972 CD 6B 19     PTDECOD CALL GETIX
 552+ 1975              PTDEC	EQU $+1
 553+ 1975 C3 C3 C3     	JP #C3C3
 554+ 1978
 555+ 1978              ;PT2 pattern decoder
 556+ 1978 CD 0E 1C     PD2_SAM	CALL SETSAM
 557+ 197B 18 4A        	JR PD2_LOOP
 558+ 197D
 559+ 197D DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560+ 1980 18 45        	JR PD2_LOOP
 561+ 1982
 562+ 1982 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563+ 1986 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564+ 1989 0A           	LD A,(BC)
 565+ 198A 03           	INC BC
 566+ 198B 6F           	LD L,A
 567+ 198C 0A           	LD A,(BC)
 568+ 198D 03           	INC BC
 569+ 198E 67           	LD H,A
 570+ 198F CD 5D 19     	CALL SETENBS
 571+ 1992 18 33        	JR PD2_LOOP
 572+ 1994
 573+ 1994 CD EF 1B     PD2_ORN	CALL SETORN
 574+ 1997 18 2E        	JR PD2_LOOP
 575+ 1999
 576+ 1999 3C           PD2_SKIP INC A
 577+ 199A DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578+ 199D 18 28        	JR PD2_LOOP
 579+ 199F
 580+ 199F 0F           PD2_VOL	RRCA
 581+ 19A0 0F           	RRCA
 582+ 19A1 0F           	RRCA
 583+ 19A2 0F           	RRCA
 584+ 19A3 DD 77 10     	LD (IX-12+CHP.Volume),A
 585+ 19A6 18 1F        	JR PD2_LOOP
 586+ 19A8
 587+ 19A8 CD BF 1B     PD2_DEL	CALL C_DELAY
 588+ 19AB 18 1A        	JR PD2_LOOP
 589+ 19AD
 590+ 19AD DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591+ 19B1 3C           	INC A
 592+ 19B2 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593+ 19B5 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594+ 19B8 0A           	LD A,(BC)
 595+ 19B9 03           	INC BC
 596+ 19BA DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597+ 19BD 87           	ADD A,A
 598+ 19BE 9F           	SBC A,A
 599+ 19BF DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600+ 19C2 37           	SCF
 601+ 19C3 18 01        	JR PD2_LP2
 602+ 19C5
 603+ 19C5 A7           PT2PD	AND A
 604+ 19C6
 605+ 19C6 08           PD2_LP2	EX AF,AF'
 606+ 19C7
 607+ 19C7 0A           PD2_LOOP LD A,(BC)
 608+ 19C8 03           	INC BC
 609+ 19C9 C6 20        	ADD A,#20
 610+ 19CB 28 3F        	JR Z,PD2_REL
 611+ 19CD 38 A9        	JR C,PD2_SAM
 612+ 19CF C6 60        	ADD A,96
 613+ 19D1 38 3E        	JR C,PD2_NOTE
 614+ 19D3 3C           	INC A
 615+ 19D4 28 A7        	JR Z,PD2_EOff
 616+ 19D6 C6 0F        	ADD A,15
 617+ 19D8 CA EE 1A     	JP Z,PD_FIN
 618+ 19DB 38 A5        	JR C,PD2_ENV
 619+ 19DD C6 10        	ADD A,#10
 620+ 19DF 38 B3        	JR C,PD2_ORN
 621+ 19E1 C6 40        	ADD A,#40
 622+ 19E3 38 B4        	JR C,PD2_SKIP
 623+ 19E5 C6 10        	ADD A,#10
 624+ 19E7 38 B6        	JR C,PD2_VOL
 625+ 19E9 3C           	INC A
 626+ 19EA 28 BC        	JR Z,PD2_DEL
 627+ 19EC 3C           	INC A
 628+ 19ED 28 BE        	JR Z,PD2_GLIS
 629+ 19EF 3C           	INC A
 630+ 19F0 28 0A        	JR Z,PD2_PORT
 631+ 19F2 3C           	INC A
 632+ 19F3 28 12        	JR Z,PD2_STOP
 633+ 19F5 0A           	LD A,(BC)
 634+ 19F6 03           	INC BC
 635+ 19F7 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636+ 19FA 18 CB        	JR PD2_LOOP
 637+ 19FC
 638+ 19FC DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639+ 1A00 0A           	LD A,(BC)
 640+ 1A01 03           	INC BC
 641+ 1A02 03           	INC BC ;ignoring precalc delta to right sound
 642+ 1A03 03           	INC BC
 643+ 1A04 37           	SCF
 644+ 1A05 18 BF        	JR PD2_LP2
 645+ 1A07
 646+ 1A07 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647+ 1A0A 18 BB        	JR PD2_LOOP
 648+ 1A0C
 649+ 1A0C DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650+ 1A0F 18 2C        	JR PD2_EXIT
 651+ 1A11
 652+ 1A11 6F           PD2_NOTE LD L,A
 653+ 1A12 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654+ 1A15 32 28 1B     	LD (PrNote+1),A
 655+ 1A18 DD 75 06     	LD (IX-12+CHP.Note),L
 656+ 1A1B AF           	XOR A
 657+ 1A1C DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658+ 1A1F DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659+ 1A23 08           	EX AF,AF'
 660+ 1A24 30 16        	JR NC,NOGLIS2
 661+ 1A26 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662+ 1A2A 20 0C        	JR NZ,NOPORT2
 663+ 1A2C 32 4E 1B     	LD (LoStep),A
 664+ 1A2F 87           	ADD A,A
 665+ 1A30 9F           	SBC A,A
 666+ 1A31 08           	EX AF,AF'
 667+ 1A32 67           	LD H,A
 668+ 1A33 6F           	LD L,A
 669+ 1A34 3C           	INC A
 670+ 1A35 CD 09 1B     	CALL SETPORT
 671+ 1A38 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672+ 1A3C AF           NOGLIS2	XOR A
 673+ 1A3D
 674+ 1A3D
 675+ 1A3D DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676+ 1A40 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677+ 1A43 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678+ 1A46 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679+ 1A49 C3 EE 1A     	JP PD_FIN
 680+ 1A4C
 681+ 1A4C              ;PT3 pattern decoder
 682+ 1A4C DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683+ 1A50 CD EF 1B     	CALL SETORN
 684+ 1A53 0A           PD_SAM_	LD A,(BC)
 685+ 1A54 03           	INC BC
 686+ 1A55 0F           	RRCA
 687+ 1A56
 688+ 1A56 CD 0E 1C     PD_SAM	CALL SETSAM
 689+ 1A59 18 3F        	JR PD_LOOP
 690+ 1A5B
 691+ 1A5B 0F           PD_VOL	RRCA
 692+ 1A5C 0F           	RRCA
 693+ 1A5D 0F           	RRCA
 694+ 1A5E 0F           	RRCA
 695+ 1A5F DD 77 10     	LD (IX-12+CHP.Volume),A
 696+ 1A62 18 39        	JR PD_LP2
 697+ 1A64
 698+ 1A64 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699+ 1A67 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700+ 1A6A 18 31        	JR PD_LP2
 701+ 1A6C
 702+ 1A6C 3D           PD_SorE	DEC A
 703+ 1A6D 20 07        	JR NZ,PD_ENV
 704+ 1A6F 0A           	LD A,(BC)
 705+ 1A70 03           	INC BC
 706+ 1A71 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707+ 1A74 18 27        	JR PD_LP2
 708+ 1A76
 709+ 1A76 CD D4 1B     PD_ENV	CALL SETENV
 710+ 1A79 18 22        	JR PD_LP2
 711+ 1A7B
 712+ 1A7B CD EF 1B     PD_ORN	CALL SETORN
 713+ 1A7E 18 1A        	JR PD_LOOP
 714+ 1A80
 715+ 1A80 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716+ 1A83 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717+ 1A86 C4 D4 1B     	CALL NZ,SETENV
 718+ 1A89 18 C8        	JR PD_SAM_
 719+ 1A8B
 720+ 1A8B DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721+ 1A8E 32 28 1B     	LD (PrNote+1),A
 722+ 1A91 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723+ 1A94 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724+ 1A97 22 45 1B     	LD (PrSlide+1),HL
 725+ 1A9A
 726+ 1A9A 11 10 20     PD_LOOP	LD DE,#2010
 727+ 1A9D 0A           PD_LP2	LD A,(BC)
 728+ 1A9E 03           	INC BC
 729+ 1A9F 83           	ADD A,E
 730+ 1AA0 38 AA        	JR C,PD_OrSm
 731+ 1AA2 82           	ADD A,D
 732+ 1AA3 28 49        	JR Z,PD_FIN
 733+ 1AA5 38 AF        	JR C,PD_SAM
 734+ 1AA7 83           	ADD A,E
 735+ 1AA8 28 25        	JR Z,PD_REL
 736+ 1AAA 38 AF        	JR C,PD_VOL
 737+ 1AAC 83           	ADD A,E
 738+ 1AAD 28 B5        	JR Z,PD_EOff
 739+ 1AAF 38 BB        	JR C,PD_SorE
 740+ 1AB1 C6 60        	ADD A,96
 741+ 1AB3 38 20        	JR C,PD_NOTE
 742+ 1AB5 83           	ADD A,E
 743+ 1AB6 38 C3        	JR C,PD_ORN
 744+ 1AB8 82           	ADD A,D
 745+ 1AB9 38 0F        	JR C,PD_NOIS
 746+ 1ABB 83           	ADD A,E
 747+ 1ABC 38 C2        	JR C,PD_ESAM
 748+ 1ABE 87           	ADD A,A
 749+ 1ABF 5F           	LD E,A
 750+ 1AC0 21 4A FB     	LD HL,SPCCOMS+#FF20-#2000
 751+ 1AC3 19           	ADD HL,DE
 752+ 1AC4 5E           	LD E,(HL)
 753+ 1AC5 23           	INC HL
 754+ 1AC6 56           	LD D,(HL)
 755+ 1AC7 D5           	PUSH DE
 756+ 1AC8 18 D0        	JR PD_LOOP
 757+ 1ACA
 758+ 1ACA FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759+ 1ACD 18 CE        	JR PD_LP2
 760+ 1ACF
 761+ 1ACF DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762+ 1AD3 18 08        	JR PD_RES
 763+ 1AD5
 764+ 1AD5 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765+ 1AD8 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766+ 1ADC AF           	XOR A
 767+ 1ADD
 768+ 1ADD ED 73 EC 1A  PD_RES	LD (PDSP_+1),SP
 769+ 1AE1 DD F9        	LD SP,IX
 770+ 1AE3 67           	LD H,A
 771+ 1AE4 6F           	LD L,A
 772+ 1AE5 E5           	PUSH HL
 773+ 1AE6 E5           	PUSH HL
 774+ 1AE7 E5           	PUSH HL
 775+ 1AE8 E5           	PUSH HL
 776+ 1AE9 E5           	PUSH HL
 777+ 1AEA E5           	PUSH HL
 778+ 1AEB 31 31 31     PDSP_	LD SP,#3131
 779+ 1AEE
 780+ 1AEE DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781+ 1AF1 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782+ 1AF4 C9           	RET
 783+ 1AF5
 784+ 1AF5 0A           C_PORTM LD A,(BC)
 785+ 1AF6 03           	INC BC
 786+ 1AF7              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787+ 1AF7              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788+ 1AF7 03           	INC BC
 789+ 1AF8 03           	INC BC
 790+ 1AF9 08           	EX AF,AF'
 791+ 1AFA 0A           	LD A,(BC) ;SIGNED TONE STEP
 792+ 1AFB 03           	INC BC
 793+ 1AFC 32 4E 1B     	LD (LoStep),A
 794+ 1AFF 0A           	LD A,(BC)
 795+ 1B00 03           	INC BC
 796+ 1B01 A7           	AND A
 797+ 1B02 08           	EX AF,AF'
 798+ 1B03 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799+ 1B06 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800+ 1B09
 801+ 1B09              ;Set portamento variables
 802+ 1B09              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803+ 1B09
 804+ 1B09 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805+ 1B0D DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806+ 1B10 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807+ 1B13 E5           	PUSH HL
 808+ 1B14 11 CD 21     	LD DE,NT_
 809+ 1B17 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810+ 1B1A DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811+ 1B1D 87           	ADD A,A
 812+ 1B1E 6F           	LD L,A
 813+ 1B1F 26 00        	LD H,0
 814+ 1B21 19           	ADD HL,DE
 815+ 1B22 7E           	LD A,(HL)
 816+ 1B23 23           	INC HL
 817+ 1B24 66           	LD H,(HL)
 818+ 1B25 6F           	LD L,A
 819+ 1B26 E5           	PUSH HL
 820+ 1B27 3E 3E        PrNote	LD A,#3E
 821+ 1B29 DD 77 06     	LD (IX-12+CHP.Note),A
 822+ 1B2C 87           	ADD A,A
 823+ 1B2D 6F           	LD L,A
 824+ 1B2E 26 00        	LD H,0
 825+ 1B30 19           	ADD HL,DE
 826+ 1B31 5E           	LD E,(HL)
 827+ 1B32 23           	INC HL
 828+ 1B33 56           	LD D,(HL)
 829+ 1B34 E1           	POP HL
 830+ 1B35 ED 52        	SBC HL,DE
 831+ 1B37 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832+ 1B3A DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833+ 1B3D D1           	POP DE
 834+ 1B3E              Version EQU $+1
 835+ 1B3E 3E 3E        	LD A,#3E
 836+ 1B40 FE 06        	CP 6
 837+ 1B42 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838+ 1B44 11 11 11     PrSlide	LD DE,#1111
 839+ 1B47 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840+ 1B4A DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841+ 1B4D              LoStep	EQU $+1
 842+ 1B4D 3E 3E        OLDPRTM	LD A,#3E
 843+ 1B4F 08           	EX AF,AF'
 844+ 1B50 28 01        	JR Z,NOSIG
 845+ 1B52 EB           	EX DE,HL
 846+ 1B53 ED 52        NOSIG	SBC HL,DE
 847+ 1B55 F2 5D 1B     	JP P,SET_STP
 848+ 1B58 2F           	CPL
 849+ 1B59 08           	EX AF,AF'
 850+ 1B5A ED 44        	NEG
 851+ 1B5C 08           	EX AF,AF'
 852+ 1B5D DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853+ 1B60 08           	EX AF,AF'
 854+ 1B61 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855+ 1B64 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856+ 1B68 C9           	RET
 857+ 1B69
 858+ 1B69 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859+ 1B6D 0A           	LD A,(BC)
 860+ 1B6E 03           	INC BC
 861+ 1B6F DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862+ 1B72 A7           	AND A
 863+ 1B73 20 07        	JR NZ,GL36
 864+ 1B75 3A 3F 1B     	LD A,(Version) ;AlCo PT3.7+
 865+ 1B78 FE 07        	CP 7
 866+ 1B7A 9F           	SBC A,A
 867+ 1B7B 3C           	INC A
 868+ 1B7C DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869+ 1B7F 0A           	LD A,(BC)
 870+ 1B80 03           	INC BC
 871+ 1B81 08           	EX AF,AF'
 872+ 1B82 0A           	LD A,(BC)
 873+ 1B83 03           	INC BC
 874+ 1B84 18 D7        	JR SET_STP
 875+ 1B86
 876+ 1B86 0A           C_SMPOS	LD A,(BC)
 877+ 1B87 03           	INC BC
 878+ 1B88 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879+ 1B8B C9           	RET
 880+ 1B8C
 881+ 1B8C 0A           C_ORPOS	LD A,(BC)
 882+ 1B8D 03           	INC BC
 883+ 1B8E DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884+ 1B91 C9           	RET
 885+ 1B92
 886+ 1B92 0A           C_VIBRT	LD A,(BC)
 887+ 1B93 03           	INC BC
 888+ 1B94 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889+ 1B97 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890+ 1B9A 0A           	LD A,(BC)
 891+ 1B9B 03           	INC BC
 892+ 1B9C DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893+ 1B9F AF           	XOR A
 894+ 1BA0 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895+ 1BA3 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896+ 1BA6 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897+ 1BA9 C9           	RET
 898+ 1BAA
 899+ 1BAA 0A           C_ENGLS	LD A,(BC)
 900+ 1BAB 03           	INC BC
 901+ 1BAC FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902+ 1BAF FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903+ 1BB2 0A           	LD A,(BC)
 904+ 1BB3 03           	INC BC
 905+ 1BB4 6F           	LD L,A
 906+ 1BB5 0A           	LD A,(BC)
 907+ 1BB6 03           	INC BC
 908+ 1BB7 67           	LD H,A
 909+ 1BB8 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910+ 1BBB FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911+ 1BBE C9           	RET
 912+ 1BBF
 913+ 1BBF 0A           C_DELAY	LD A,(BC)
 914+ 1BC0 03           	INC BC
 915+ 1BC1 FD 77 08     	LD (IY-100+VRS.Delay),A
 916+ 1BC4 21 58 20     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917+ 1BC7 CB 4E        	BIT 1,(HL)
 918+ 1BC9 C8           	RET Z
 919+ 1BCA 32 3B 20     	LD (VARS1+VRS.Delay),A
 920+ 1BCD 32 3C 20     	LD (VARS1+VRS.DelyCnt),A
 921+ 1BD0 32 C2 20     	LD (VARS2+VRS.Delay),A
 922+ 1BD3 C9           	RET
 923+ 1BD4
 924+ 1BD4 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925+ 1BD7 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926+ 1BDA 0A           	LD A,(BC)
 927+ 1BDB 03           	INC BC
 928+ 1BDC 67           	LD H,A
 929+ 1BDD 0A           	LD A,(BC)
 930+ 1BDE 03           	INC BC
 931+ 1BDF 6F           	LD L,A
 932+ 1BE0 CD 5D 19     	CALL SETENBS
 933+ 1BE3 AF           	XOR A
 934+ 1BE4 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935+ 1BE7 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936+ 1BEA 67           	LD H,A
 937+ 1BEB 6F           	LD L,A
 938+ 1BEC C3 64 19     	JP SETESLD
 939+ 1BEF
 940+ 1BEF 87           SETORN	ADD A,A
 941+ 1BF0 5F           	LD E,A
 942+ 1BF1 16 00        	LD D,0
 943+ 1BF3 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944+ 1BF6 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945+ 1BF9 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946+ 1BFC 19           	ADD HL,DE
 947+ 1BFD 5E           	LD E,(HL)
 948+ 1BFE 23           	INC HL
 949+ 1BFF 56           	LD D,(HL)
 950+ 1C00 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951+ 1C03 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952+ 1C06 19           	ADD HL,DE
 953+ 1C07 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954+ 1C0A DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955+ 1C0D C9           C_NOP	RET
 956+ 1C0E
 957+ 1C0E 87           SETSAM	ADD A,A
 958+ 1C0F 5F           	LD E,A
 959+ 1C10 16 00        	LD D,0
 960+ 1C12 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961+ 1C15 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962+ 1C18 19           	ADD HL,DE
 963+ 1C19 5E           	LD E,(HL)
 964+ 1C1A 23           	INC HL
 965+ 1C1B 56           	LD D,(HL)
 966+ 1C1C FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967+ 1C1F FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968+ 1C22 19           	ADD HL,DE
 969+ 1C23 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970+ 1C26 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971+ 1C29 C9           	RET
 972+ 1C2A
 973+ 1C2A              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974+ 1C2A 0D 1C        SPCCOMS DW C_NOP
 975+ 1C2C 69 1B        	DW C_GLISS
 976+ 1C2E F5 1A        	DW C_PORTM
 977+ 1C30 86 1B        	DW C_SMPOS
 978+ 1C32 8C 1B        	DW C_ORPOS
 979+ 1C34 92 1B        	DW C_VIBRT
 980+ 1C36 0D 1C        	DW C_NOP
 981+ 1C38 0D 1C        	DW C_NOP
 982+ 1C3A AA 1B        	DW C_ENGLS
 983+ 1C3C BF 1B        	DW C_DELAY
 984+ 1C3E 0D 1C        	DW C_NOP
 985+ 1C40 0D 1C        	DW C_NOP
 986+ 1C42 0D 1C        	DW C_NOP
 987+ 1C44 0D 1C        	DW C_NOP
 988+ 1C46 0D 1C        	DW C_NOP
 989+ 1C48 0D 1C        	DW C_NOP
 990+ 1C4A
 991+ 1C4A CD 6B 19     CHREGS	CALL GETIX
 992+ 1C4D AF           	XOR A
 993+ 1C4E 32 8A 1E     	LD (Ampl),A
 994+ 1C51 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995+ 1C55 E5           	PUSH HL
 996+ 1C56 CA 9D 1D     	JP Z,CH_EXIT
 997+ 1C59 ED 73 E7 1C  	LD (CSP_+1),SP
 998+ 1C5D DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999+ 1C60 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000+ 1C63 F9           	LD SP,HL
1001+ 1C64 D1           	POP DE
1002+ 1C65 67           	LD H,A
1003+ 1C66 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004+ 1C69 6F           	LD L,A
1005+ 1C6A 39           	ADD HL,SP
1006+ 1C6B 3C           	INC A
1007+ 1C6C              		;PT2	PT3
1008+ 1C6C 3C           OrnCP	INC A	;CP E	CP D
1009+ 1C6D 38 01        	JR C,CH_ORPS
1010+ 1C6F 01           OrnLD	DB 1	;LD A,D	LD A,E
1011+ 1C70 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012+ 1C73 DD 7E 12     	LD A,(IX+CHP.Note)
1013+ 1C76 86           	ADD A,(HL)
1014+ 1C77 F2 7B 1C     	JP P,CH_NTP
1015+ 1C7A AF           	XOR A
1016+ 1C7B FE 60        CH_NTP	CP 96
1017+ 1C7D 38 02        	JR C,CH_NOK
1018+ 1C7F 3E 5F        	LD A,95
1019+ 1C81 87           CH_NOK	ADD A,A
1020+ 1C82 08           	EX AF,AF'
1021+ 1C83 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022+ 1C86 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023+ 1C89 F9           	LD SP,HL
1024+ 1C8A D1           	POP DE
1025+ 1C8B 26 00        	LD H,0
1026+ 1C8D DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027+ 1C90 47           	LD B,A
1028+ 1C91 87           	ADD A,A
1029+ 1C92 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030+ 1C93 6F           	LD L,A
1031+ 1C94 39           	ADD HL,SP
1032+ 1C95 F9           	LD SP,HL
1033+ 1C96 78           	LD A,B
1034+ 1C97 3C           	INC A
1035+ 1C98              		;PT2	PT3
1036+ 1C98 3C           SamCP	INC A	;CP E	CP D
1037+ 1C99 38 01        	JR C,CH_SMPS
1038+ 1C9B 01           SamLD	DB 1	;LD A,D	LD A,E
1039+ 1C9C DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040+ 1C9F C1           	POP BC
1041+ 1CA0 E1           	POP HL
1042+ 1CA1
1043+ 1CA1              ;Convert PT2 sample to PT3
1044+ 1CA1              		;PT2		PT3
1045+ 1CA1 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046+ 1CA2 E1           	POP HL
1047+ 1CA3 60           	LD H,B
1048+ 1CA4 20 06        	JR NZ,$+8
1049+ 1CA6 EB           	EX DE,HL
1050+ 1CA7 A7           	AND A
1051+ 1CA8 ED 62        	SBC HL,HL
1052+ 1CAA ED 52        	SBC HL,DE
1053+ 1CAC 51           	LD D,C
1054+ 1CAD CB 19        	RR C
1055+ 1CAF 9F           	SBC A,A
1056+ 1CB0 2F           	CPL
1057+ 1CB1 E6 3E        	AND #3E
1058+ 1CB3 CB 19        	RR C
1059+ 1CB5 CB 18        	RR B
1060+ 1CB7 A1           	AND C
1061+ 1CB8 4F           	LD C,A
1062+ 1CB9 78           	LD A,B
1063+ 1CBA 1F           	RRA
1064+ 1CBB 1F           	RRA
1065+ 1CBC CB 1A        	RR D
1066+ 1CBE 1F           	RRA
1067+ 1CBF E6 9F        	AND #9F
1068+ 1CC1 47           	LD B,A
1069+ 1CC2
1070+ 1CC2 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071+ 1CC5 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072+ 1CC8 19           	ADD HL,DE
1073+ 1CC9 CB 70        	BIT 6,B
1074+ 1CCB 28 06        	JR Z,CH_NOAC
1075+ 1CCD DD 75 08     	LD (IX+CHP.TnAcc),L
1076+ 1CD0 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077+ 1CD3 EB           CH_NOAC EX DE,HL
1078+ 1CD4 08           	EX AF,AF'
player.asm(1079): warning: value 0x21CD is truncated to 8bit value: 0xCD
1079+ 1CD5 C6 CD        	ADD A,NT_
1080+ 1CD7 6F           	LD L,A
1081+ 1CD8 CE 21        	ADC A,NT_/256
1082+ 1CDA 95           	SUB L
1083+ 1CDB 67           	LD H,A
1084+ 1CDC F9           	LD SP,HL
1085+ 1CDD E1           	POP HL
1086+ 1CDE 19           	ADD HL,DE
1087+ 1CDF DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088+ 1CE2 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089+ 1CE5 19           	ADD HL,DE
1090+ 1CE6 31 31 31     CSP_	LD SP,#3131
1091+ 1CE9 E3           	EX (SP),HL
1092+ 1CEA AF           	XOR A
1093+ 1CEB DD B6 05     	OR (IX+CHP.TSlCnt)
1094+ 1CEE 28 3E        	JR Z,CH_AMP
1095+ 1CF0 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096+ 1CF3 20 39        	JR NZ,CH_AMP
1097+ 1CF5 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098+ 1CF8 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099+ 1CFB DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100+ 1CFE DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101+ 1D01 7C           	LD A,H
1102+ 1D02 19           	ADD HL,DE
1103+ 1D03 DD 75 06     	LD (IX+CHP.CrTnSl),L
1104+ 1D06 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105+ 1D09 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106+ 1D0D 20 1F        	JR NZ,CH_AMP
1107+ 1D0F DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108+ 1D12 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109+ 1D15 A7           	AND A
1110+ 1D16 28 01        	JR Z,CH_STPP
1111+ 1D18 EB           	EX DE,HL
1112+ 1D19 ED 52        CH_STPP SBC HL,DE
1113+ 1D1B FA 2E 1D     	JP M,CH_AMP
1114+ 1D1E DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115+ 1D21 DD 77 12     	LD (IX+CHP.Note),A
1116+ 1D24 AF           	XOR A
1117+ 1D25 DD 77 05     	LD (IX+CHP.TSlCnt),A
1118+ 1D28 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119+ 1D2B DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120+ 1D2E DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121+ 1D31 CB 79        	BIT 7,C
1122+ 1D33 28 13        	JR Z,CH_NOAM
1123+ 1D35 CB 71        	BIT 6,C
1124+ 1D37 28 07        	JR Z,CH_AMIN
1125+ 1D39 FE 0F        	CP 15
1126+ 1D3B 28 0B        	JR Z,CH_NOAM
1127+ 1D3D 3C           	INC A
1128+ 1D3E 18 05        	JR CH_SVAM
1129+ 1D40 FE F1        CH_AMIN	CP -15
1130+ 1D42 28 04        	JR Z,CH_NOAM
1131+ 1D44 3D           	DEC A
1132+ 1D45 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133+ 1D48 6F           CH_NOAM	LD L,A
1134+ 1D49 78           	LD A,B
1135+ 1D4A E6 0F        	AND 15
1136+ 1D4C 85           	ADD A,L
1137+ 1D4D F2 51 1D     	JP P,CH_APOS
1138+ 1D50 AF           	XOR A
1139+ 1D51 FE 10        CH_APOS	CP 16
1140+ 1D53 38 02        	JR C,CH_VOL
1141+ 1D55 3E 0F        	LD A,15
1142+ 1D57 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x20CD is truncated to 8bit value: 0xCD
1143+ 1D5A C6 CD        	ADD A,VT_
1144+ 1D5C 6F           	LD L,A
1145+ 1D5D CE 20        	ADC A,VT_/256
1146+ 1D5F 95           	SUB L
1147+ 1D60 67           	LD H,A
1148+ 1D61 7E           	LD A,(HL)
1149+ 1D62 CB 41        CH_ENV	BIT 0,C
1150+ 1D64 20 03        	JR NZ,CH_NOEN
1151+ 1D66 DD B6 14     	OR (IX+CHP.Env_En)
1152+ 1D69 32 8A 1E     CH_NOEN	LD (Ampl),A
1153+ 1D6C CB 78        	BIT 7,B
1154+ 1D6E 79           	LD A,C
1155+ 1D6F 28 1A        	JR Z,NO_ENSL
1156+ 1D71 17           	RLA
1157+ 1D72 17           	RLA
1158+ 1D73 CB 2F        	SRA A
1159+ 1D75 CB 2F        	SRA A
1160+ 1D77 CB 2F        	SRA A
1161+ 1D79 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162+ 1D7C CB 68        	BIT 5,B
1163+ 1D7E 28 03        	JR Z,NO_ENAC
1164+ 1D80 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165+ 1D83 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166+ 1D86 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167+ 1D89 18 0E        	JR CH_MIX
1168+ 1D8B 1F           NO_ENSL RRA
1169+ 1D8C DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170+ 1D8F FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171+ 1D92 CB 68        	BIT 5,B
1172+ 1D94 28 03        	JR Z,CH_MIX
1173+ 1D96 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174+ 1D99 78           CH_MIX	LD A,B
1175+ 1D9A 1F           	RRA
1176+ 1D9B E6 48        	AND #48
1177+ 1D9D FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178+ 1DA0 0F           	RRCA
1179+ 1DA1 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180+ 1DA4 E1           	POP HL
1181+ 1DA5 AF           	XOR A
1182+ 1DA6 DD B6 0A     	OR (IX+CHP.COnOff)
1183+ 1DA9 C8           	RET Z
1184+ 1DAA DD 35 0A     	DEC (IX+CHP.COnOff)
1185+ 1DAD C0           	RET NZ
1186+ 1DAE DD AE 15     	XOR (IX+CHP.Flags)
1187+ 1DB1 DD 77 15     	LD (IX+CHP.Flags),A
1188+ 1DB4 1F           	RRA
1189+ 1DB5 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190+ 1DB8 38 03        	JR C,CH_ONDL
1191+ 1DBA DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192+ 1DBD DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193+ 1DC0 C9           	RET
1194+ 1DC1
1195+ 1DC1 AF           PLAY_	XOR A
1196+ 1DC2 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197+ 1DC5 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198+ 1DC8 3D           	DEC A
1199+ 1DC9 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200+ 1DCC FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201+ 1DCF C2 77 1E     	JP NZ,PL2
1202+ 1DD2 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203+ 1DD5 20 6C        	JR NZ,PL1B
1204+ 1DD7 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205+ 1DDA FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206+ 1DDD 0A           	LD A,(BC)
1207+ 1DDE A7           	AND A
1208+ 1DDF 20 56        	JR NZ,PL1A
1209+ 1DE1 57           	LD D,A
1210+ 1DE2 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211+ 1DE5 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212+ 1DE8 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213+ 1DEB 23           	INC HL
1214+ 1DEC 7E           	LD A,(HL)
1215+ 1DED 3C           	INC A
1216+ 1DEE 20 0B        	JR NZ,PLNLP
1217+ 1DF0
1218+ 1DF0              	IF LoopChecker
1219+ 1DF0 CD A2 16     	CALL CHECKLP
1220+ 1DF3              	ENDIF
1221+ 1DF3
1222+ 1DF3 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223+ 1DF6 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224+ 1DF9 7E           	LD A,(HL)
1225+ 1DFA 3C           	INC A
1226+ 1DFB CD 4F 19     PLNLP	CALL SETCPPT
1227+ 1DFE 3D           	DEC A
1228+ 1DFF FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229+ 1E03 28 03        	JR Z,NoAlCo
1230+ 1E05              TSSub	EQU $+1
1231+ 1E05 D6 D6        	SUB #D6
1232+ 1E07 2F           	CPL
1233+ 1E08              NoAlCo
1234+ 1E08              		;PT2		PT3
1235+ 1E08 3D           PsCalc	DEC A	;ADD A,A	NOP
1236+ 1E09 3D           	DEC A	;ADD A,(HL)	NOP
1237+ 1E0A 87           	ADD A,A
1238+ 1E0B 5F           	LD E,A
1239+ 1E0C CB 12        	RL D
1240+ 1E0E
1241+ 1E0E              	IF CurPosCounter
1242+ 1E0E ~            	LD A,L
1243+ 1E0E ~            	SUB (IY-100+VRS.PosSub)
1244+ 1E0E ~            	LD (IY-100+VRS.CurPos),A
1245+ 1E0E              	ENDIF
1246+ 1E0E
1247+ 1E0E FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248+ 1E11 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249+ 1E14 19           	ADD HL,DE
1250+ 1E15 FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251+ 1E18 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252+ 1E1B ED 73 35 1E  	LD (PSP_+1),SP
1253+ 1E1F F9           	LD SP,HL
1254+ 1E20 E1           	POP HL
1255+ 1E21 19           	ADD HL,DE
1256+ 1E22 44           	LD B,H
1257+ 1E23 4D           	LD C,L
1258+ 1E24 E1           	POP HL
1259+ 1E25 19           	ADD HL,DE
1260+ 1E26 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261+ 1E29 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262+ 1E2C E1           	POP HL
1263+ 1E2D 19           	ADD HL,DE
1264+ 1E2E FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265+ 1E31 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266+ 1E34 31 31 31     PSP_	LD SP,#3131
1267+ 1E37 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268+ 1E3A CD 72 19     	CALL PTDECOD
1269+ 1E3D FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270+ 1E40 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271+ 1E43
1272+ 1E43 FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273+ 1E46 20 12        	JR NZ,PL1C
1274+ 1E48 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275+ 1E4B FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276+ 1E4E FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277+ 1E51 CD 72 19     	CALL PTDECOD
1278+ 1E54 FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279+ 1E57 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280+ 1E5A
1281+ 1E5A FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282+ 1E5D 20 12        	JR NZ,PL1D
1283+ 1E5F 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284+ 1E62 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285+ 1E65 FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286+ 1E68 CD 72 19     	CALL PTDECOD
1287+ 1E6B FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288+ 1E6E FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289+ 1E71
1290+ 1E71 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291+ 1E74 FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292+ 1E77
1293+ 1E77 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294+ 1E7A FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295+ 1E7D FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296+ 1E80 CD 4A 1C     	CALL CHREGS
1297+ 1E83 FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298+ 1E86 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299+ 1E89              Ampl	EQU $+1
1300+ 1E89 3E 3E        	LD A,#3E
1301+ 1E8B FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302+ 1E8E 11 BC FF     	LD DE,VRS.ChanB-100
1303+ 1E91 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304+ 1E94 FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305+ 1E97 CD 4A 1C     	CALL CHREGS
1306+ 1E9A FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307+ 1E9D FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308+ 1EA0 3A 8A 1E     	LD A,(Ampl)
1309+ 1EA3 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310+ 1EA6 11 D9 FF     	LD DE,VRS.ChanC-100
1311+ 1EA9 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312+ 1EAC FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313+ 1EAF CD 4A 1C     	CALL CHREGS
1314+ 1EB2 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315+ 1EB5 FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316+ 1EB8 3A 8A 1E     	LD A,(Ampl)
1317+ 1EBB FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318+ 1EBE
1319+ 1EBE FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320+ 1EC1 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321+ 1EC4 FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322+ 1EC7
1323+ 1EC7 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324+ 1ECA 5F           	LD E,A
1325+ 1ECB 87           	ADD A,A
1326+ 1ECC 9F           	SBC A,A
1327+ 1ECD 57           	LD D,A
1328+ 1ECE FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329+ 1ED1 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330+ 1ED4 19           	ADD HL,DE
1331+ 1ED5 FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332+ 1ED8 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333+ 1EDB 19           	ADD HL,DE
1334+ 1EDC FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335+ 1EDF FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336+ 1EE2
1337+ 1EE2 AF           	XOR A
1338+ 1EE3 FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339+ 1EE6 C8           	RET Z
1340+ 1EE7 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341+ 1EEA C0           	RET NZ
1342+ 1EEB FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343+ 1EEE FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344+ 1EF1 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345+ 1EF4 FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346+ 1EF7 19           	ADD HL,DE
1347+ 1EF8 C3 64 19     	JP SETESLD
1348+ 1EFB
1349+ 1EFB FD 21 33 20  PLAY    LD IY,VARS1+100
1350+ 1EFF CD C1 1D     	CALL PLAY_
1351+ 1F02 3A CE 1F     	LD A,(is_ts)
1352+ 1F05 A7           	AND A
1353+ 1F06 28 07        	JR Z,PL_nts
1354+ 1F08 FD 21 BA 20  	LD IY,VARS2+100
1355+ 1F0C CD C1 1D     	CALL PLAY_
1356+ 1F0F              PL_nts
1357+ 1F0F              	IF Basic
1358+ 1F0F FD 21 3A 5C  	LD IY,#5C3A
1359+ 1F13              	ENDIF
1360+ 1F13
1361+ 1F13 01 FD FF     ROUT	LD BC,#FFFD
1362+ 1F16 3A CE 1F     	LD A,(is_ts)
1363+ 1F19 A7           	AND A
1364+ 1F1A 28 02        	JR Z,r_nts ;keep old standard
1365+ 1F1C ED 41        	OUT (C),B
1366+ 1F1E 08           r_nts	EX AF,AF'
1367+ 1F1F
1368+ 1F1F              	IF ACBBAC
1369+ 1F1F ~            	LD IX,VARS1+VRS.AYREGS
1370+ 1F1F              	ELSE
1371+ 1F1F 21 48 20     	LD HL,VARS1+VRS.AYREGS
1372+ 1F22              	ENDIF
1373+ 1F22
1374+ 1F22 CD 2E 1F     	CALL ROUT_
1375+ 1F25 08           	EX AF,AF'
1376+ 1F26 C8           	RET Z
1377+ 1F27 42           	LD B,D
1378+ 1F28 2F           	CPL
1379+ 1F29 ED 79        	OUT (C),A
1380+ 1F2B
1381+ 1F2B              	IF ACBBAC
1382+ 1F2B ~            	LD IX,VARS2+VRS.AYREGS
1383+ 1F2B              	ELSE
1384+ 1F2B 21 CF 20     	LD HL,VARS2+VRS.AYREGS
1385+ 1F2E              	ENDIF
1386+ 1F2E
1387+ 1F2E              ROUT_
1388+ 1F2E              	IF ACBBAC
1389+ 1F2E ~            	LD A,(SETUP)
1390+ 1F2E ~            	AND 12
1391+ 1F2E ~            	JR Z,ABC
1392+ 1F2E ~            	ADD A,CHTABLE
1393+ 1F2E ~            	LD E,A
1394+ 1F2E ~            	ADC A,CHTABLE/256
1395+ 1F2E ~            	SUB E
1396+ 1F2E ~            	LD D,A
1397+ 1F2E ~            	LD B,0
1398+ 1F2E ~            	PUSH IX
1399+ 1F2E ~            	POP HL
1400+ 1F2E ~            	LD A,(DE)
1401+ 1F2E ~            	INC DE
1402+ 1F2E ~            	LD C,A
1403+ 1F2E ~            	ADD HL,BC
1404+ 1F2E ~            	LD A,(IX+TonB)
1405+ 1F2E ~            	LD C,(HL)
1406+ 1F2E ~            	LD (IX+TonB),C
1407+ 1F2E ~            	LD (HL),A
1408+ 1F2E ~            	INC HL
1409+ 1F2E ~            	LD A,(IX+TonB+1)
1410+ 1F2E ~            	LD C,(HL)
1411+ 1F2E ~            	LD (IX+TonB+1),C
1412+ 1F2E ~            	LD (HL),A
1413+ 1F2E ~            	LD A,(DE)
1414+ 1F2E ~            	INC DE
1415+ 1F2E ~            	LD C,A
1416+ 1F2E ~            	ADD HL,BC
1417+ 1F2E ~            	LD A,(IX+AmplB)
1418+ 1F2E ~            	LD C,(HL)
1419+ 1F2E ~            	LD (IX+AmplB),C
1420+ 1F2E ~            	LD (HL),A
1421+ 1F2E ~            	LD A,(DE)
1422+ 1F2E ~            	INC DE
1423+ 1F2E ~            	LD (RxCA1),A
1424+ 1F2E ~            	XOR 8
1425+ 1F2E ~            	LD (RxCA2),A
1426+ 1F2E ~            	LD A,(DE)
1427+ 1F2E ~            	AND (IX+Mixer)
1428+ 1F2E ~            	LD E,A
1429+ 1F2E ~            	LD A,(IX+Mixer)
1430+ 1F2E ~            RxCA1	DB #E6
1431+ 1F2E ~            	AND %010010
1432+ 1F2E ~            	OR E
1433+ 1F2E ~            	LD E,A
1434+ 1F2E ~            	LD A,(IX+Mixer)
1435+ 1F2E ~            	AND %010010
1436+ 1F2E ~            RxCA2	OR E
1437+ 1F2E ~            	OR E
1438+ 1F2E ~            	LD (IX+Mixer),A
1439+ 1F2E ~            ABC
1440+ 1F2E              	ENDIF
1441+ 1F2E
1442+ 1F2E AF           	XOR A
1443+ 1F2F 11 BF FF     	LD DE,#FFBF
1444+ 1F32
1445+ 1F32              	IF ACBBAC
1446+ 1F32 ~            	LD BC,#FFFD
1447+ 1F32 ~            	PUSH IX
1448+ 1F32 ~            	POP HL
1449+ 1F32              	ENDIF
1450+ 1F32
1451+ 1F32 ED 79        LOUT	OUT (C),A
1452+ 1F34 43           	LD B,E
1453+ 1F35 ED A3        	OUTI
1454+ 1F37 42           	LD B,D
1455+ 1F38 3C           	INC A
1456+ 1F39 FE 0D        	CP 13
1457+ 1F3B 20 F5        	JR NZ,LOUT
1458+ 1F3D ED 79        	OUT (C),A
1459+ 1F3F 7E           	LD A,(HL)
1460+ 1F40 A7           	AND A
1461+ 1F41 F8           	RET M
1462+ 1F42 43           	LD B,E
1463+ 1F43 ED 79        	OUT (C),A
1464+ 1F45 C9           	RET
1465+ 1F46
1466+ 1F46              	IF ACBBAC
1467+ 1F46 ~            CHTABLE	EQU $-4
1468+ 1F46 ~            	DB 4,5,15,%001001,0,7,7,%100100
1469+ 1F46              	ENDIF
1470+ 1F46
1471+ 1F46 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472+ 1F47 2A           	DB TCNEW_0-T_
1473+ 1F48 65           	DB (T_OLD_0-T1_)*2+1
1474+ 1F49 00           	DB TCOLD_0-T_
1475+ 1F4A 01           	DB (T_NEW_1-T1_)*2+1
1476+ 1F4B 0C           	DB TCNEW_1-T_
1477+ 1F4C 01           	DB (T_OLD_1-T1_)*2+1
1478+ 1F4D 0C           	DB TCOLD_1-T_
1479+ 1F4E 94           	DB (T_NEW_2-T1_)*2
1480+ 1F4F 35           	DB TCNEW_2-T_
1481+ 1F50 30           	DB (T_OLD_2-T1_)*2
1482+ 1F51 0E           	DB TCOLD_2-T_
1483+ 1F52 60           	DB (T_NEW_3-T1_)*2
1484+ 1F53 20           	DB TCNEW_3-T_
1485+ 1F54 60           	DB (T_OLD_3-T1_)*2
1486+ 1F55 21           	DB TCOLD_3-T_
1487+ 1F56
1488+ 1F56              T_
1489+ 1F56
1490+ 1F56 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490+ 1F5A 0D 0F 13 15
1491+ 1F5E 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492+ 1F62 5D 00        TCOLD_1	DB #5C+1,0
1493+ 1F64 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493+ 1F68 5F 71 82 8C
1493+ 1F6C 9C
1494+ 1F6D 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494+ 1F71 AA AC AE AE
1494+ 1F75 00
1495+ 1F76 57           TCNEW_3	DB #56+1
1496+ 1F77 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496+ 1F7B 2D 2F 33 BF
1496+ 1F7F 00
1497+ 1F80 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497+ 1F84 2B 2D 31 55
1498+ 1F88 BD BF 00     	DB #BC+1,#BE+1,0
1499+ 1F8B              TCNEW_1 EQU TCOLD_1
1500+ 1F8B 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500+ 1F8F 2B 3B 4D 5F
1501+ 1F93 BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502+ 1F97
1503+ 1F97              PT3EMPTYORN EQU $-1
1504+ 1F97 01 00        	DB 1,0
1505+ 1F99
1506+ 1F99              ;first 12 values of tone tables (packed)
1507+ 1F99
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508+ 1F99 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509+ 1F9B 69           	DB #0755-#06EC
1510+ 1F9C 70           	DB #07C5-#0755
1511+ 1F9D 76           	DB #083B-#07C5
1512+ 1F9E 7D           	DB #08B8-#083B
1513+ 1F9F 85           	DB #093D-#08B8
1514+ 1FA0 8D           	DB #09CA-#093D
1515+ 1FA1 95           	DB #0A5F-#09CA
1516+ 1FA2 9D           	DB #0AFC-#0A5F
1517+ 1FA3 A8           	DB #0BA4-#0AFC
1518+ 1FA4 B1           	DB #0C55-#0BA4
1519+ 1FA5 BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520+ 1FA6 0C DA        	DB #066D*2/256,#066D*2
1521+ 1FA8 62           	DB #06CF-#066D
1522+ 1FA9 68           	DB #0737-#06CF
1523+ 1FAA 6D           	DB #07A4-#0737
1524+ 1FAB 75           	DB #0819-#07A4
1525+ 1FAC 7B           	DB #0894-#0819
1526+ 1FAD 83           	DB #0917-#0894
1527+ 1FAE 8A           	DB #09A1-#0917
1528+ 1FAF 92           	DB #0A33-#09A1
1529+ 1FB0 9C           	DB #0ACF-#0A33
1530+ 1FB1 A4           	DB #0B73-#0ACF
1531+ 1FB2 AF           	DB #0C22-#0B73
1532+ 1FB3 B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533+ 1FB4 0E 08        	DB #0704*2/256,#0704*2
1534+ 1FB6 6A           	DB #076E-#0704
1535+ 1FB7 72           	DB #07E0-#076E
1536+ 1FB8 78           	DB #0858-#07E0
1537+ 1FB9 7E           	DB #08D6-#0858
1538+ 1FBA 86           	DB #095C-#08D6
1539+ 1FBB 90           	DB #09EC-#095C
1540+ 1FBC 96           	DB #0A82-#09EC
1541+ 1FBD A0           	DB #0B22-#0A82
1542+ 1FBE AA           	DB #0BCC-#0B22
1543+ 1FBF B4           	DB #0C80-#0BCC
1544+ 1FC0 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545+ 1FC1 0F C0        	DB #07E0*2/256,#07E0*2
1546+ 1FC3 78           	DB #0858-#07E0
1547+ 1FC4 88           	DB #08E0-#0858
1548+ 1FC5 80           	DB #0960-#08E0
1549+ 1FC6 90           	DB #09F0-#0960
1550+ 1FC7 98           	DB #0A88-#09F0
1551+ 1FC8 A0           	DB #0B28-#0A88
1552+ 1FC9 B0           	DB #0BD8-#0B28
1553+ 1FCA A8           	DB #0C80-#0BD8
1554+ 1FCB E0           	DB #0D60-#0C80
1555+ 1FCC B0           	DB #0E10-#0D60
1556+ 1FCD E8           	DB #0EF8-#0E10
1557+ 1FCE
1558+ 1FCE              ;vars from here can be stripped
1559+ 1FCE              ;you can move VARS to any other address
1560+ 1FCE
1561+ 1FCE              VARS
1562+ 1FCE
1563+ 1FCE 00           is_ts	DB 0
1564+ 1FCF
1565+ 1FCF              ;ChannelsVars
1566+ 1FCF              	STRUCT	CHP
1567+ 1FCF ~            ;reset group
1568+ 1FCF ~            PsInOr	DB 0
1569+ 1FCF ~            PsInSm	DB 0
1570+ 1FCF ~            CrAmSl	DB 0
1571+ 1FCF ~            CrNsSl	DB 0
1572+ 1FCF ~            CrEnSl	DB 0
1573+ 1FCF ~            TSlCnt	DB 0
1574+ 1FCF ~            CrTnSl	DW 0
1575+ 1FCF ~            TnAcc	DW 0
1576+ 1FCF ~            COnOff	DB 0
1577+ 1FCF ~            ;reset group
1578+ 1FCF ~
1579+ 1FCF ~            OnOffD	DB 0
1580+ 1FCF ~
1581+ 1FCF ~            ;IX for PTDECOD here (+12)
1582+ 1FCF ~            OffOnD	DB 0
1583+ 1FCF ~            OrnPtr	DW 0
1584+ 1FCF ~            SamPtr	DW 0
1585+ 1FCF ~            NNtSkp	DB 0
1586+ 1FCF ~            Note	DB 0
1587+ 1FCF ~            SlToNt	DB 0
1588+ 1FCF ~            Env_En	DB 0
1589+ 1FCF ~            Flags	DB 0
1590+ 1FCF ~             ;Enabled - 0, SimpleGliss - 2
1591+ 1FCF ~            TnSlDl	DB 0
1592+ 1FCF ~            TSlStp	DW 0
1593+ 1FCF ~            TnDelt	DW 0
1594+ 1FCF ~            NtSkCn	DB 0
1595+ 1FCF ~            Volume	DB 0
1596+ 1FCF              	ENDS
1597+ 1FCF
1598+ 1FCF              	STRUCT	VRS
1599+ 1FCF ~
1600+ 1FCF ~            ;IF not works in STRUCT in SjASM :(
1601+ 1FCF ~            ;	IF CurPosCounter
1602+ 1FCF ~            CurPos	DB 0
1603+ 1FCF ~            PosSub	DB 0
1604+ 1FCF ~            ;	ENDIF
1605+ 1FCF ~
1606+ 1FCF ~            ModNum	DB 0 ;bit0: ChipNum
1607+ 1FCF ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608+ 1FCF ~
1609+ 1FCF ~            ChanA	DS CHP
1610+ 1FCF ~            ChanB	DS CHP
1611+ 1FCF ~            ChanC	DS CHP
1612+ 1FCF ~
1613+ 1FCF ~            ;GlobalVars
1614+ 1FCF ~            MODADDR	DW 0
1615+ 1FCF ~            OrnPtrs	DW 0
1616+ 1FCF ~            SamPtrs	DW 0
1617+ 1FCF ~            PatsPtr	DW 0
1618+ 1FCF ~            AdInPtA	DW 0
1619+ 1FCF ~            AdInPtB	DW 0
1620+ 1FCF ~            AdInPtC	DW 0
1621+ 1FCF ~            CrPsPtr	DW 0
1622+ 1FCF ~            LPosPtr	DW 0
1623+ 1FCF ~            Delay	DB 0
1624+ 1FCF ~            DelyCnt	DB 0
1625+ 1FCF ~            ESldAdd	DW 0
1626+ 1FCF ~            CurESld	DW 0
1627+ 1FCF ~            Env_Del	DB 0
1628+ 1FCF ~            CurEDel	DB 0
1629+ 1FCF ~            Ns_Base	DB 0
1630+ 1FCF ~            AddToNs	DB 0
1631+ 1FCF ~            AddToEn	DB 0
1632+ 1FCF ~            EnvBase	DW 0
1633+ 1FCF ~            AYREGS	DS 14
1634+ 1FCF              	ENDS
1635+ 1FCF
1636+ 1FCF 00 00 00...  VARS1	DS VRS
1637+ 2056 00 00 00...  VARS2	DS VRS
1638+ 20DD
1639+ 20DD              VT_	EQU $-16
1640+ 20DD 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641+ 21CD
1642+ 21CD              T1_	EQU VT_+16 ;Tone tables data depacked here
1643+ 21CD
1644+ 21CD              T_OLD_1	EQU T1_
1645+ 21CD              T_OLD_2	EQU T_OLD_1+24
1646+ 21CD              T_OLD_3	EQU T_OLD_2+24
1647+ 21CD              T_OLD_0	EQU T_OLD_3+2
1648+ 21CD              T_NEW_0	EQU T_OLD_0
1649+ 21CD              T_NEW_1	EQU T_OLD_1
1650+ 21CD              T_NEW_2	EQU T_NEW_0+24
1651+ 21CD              T_NEW_3	EQU T_OLD_3
1652+ 21CD
1653+ 21CD              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654+ 21CD
1655+ 21CD 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656+ 228D
1657+ 228D              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658+ 228D
1659+ 228D              VARSEND EQU $
1660+ 228D
1661+ 228D              MDLADDR EQU outputBuffer
1662+ 228D
1663+ 228D              ;Release 0 steps:
1664+ 228D              ;04/21/2007
1665+ 228D              ;Works start (PTxPlay adaptation); first beta.
1666+ 228D              ;04/22/2007
1667+ 228D              ;Job finished; beta-testing.
1668+ 228D              ;04/23/2007
1669+ 228D              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670+ 228D              ;04/29/2007
1671+ 228D              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672+ 228D              ;modules of v3.7+.
1673+ 228D
1674+ 228D              ;Size (minimal build for ZX Spectrum):
1675+ 228D              ;Code block #908 bytes
1676+ 228D              ;Variables #2BF bytes (can be stripped)
1677+ 228D              ;Total size #908+#2BF=#BC7 (3015) bytes
1678+ 228D              	ENDMODULE
# file closed: player.asm
2469  228D 00 00 00...  	align 256
2470  2300              font
2471  2300              	incbin fontV6.chr ;шрифт
2472  2B00
2473  2B00              ;Переменные
2474  2B00 00           proc_next_find_focus_flag db 0 ;флаг внеочередного вызова процесса в фокусе
2475  2B01 00           Interrupt_new_flag db 0 ;флаг только что было прерывание
2476  2B02 00           uart_enable db 0; флаг есть порт uart
2477  2B03 00           proc_play_ay db 0 ;код процесса с музыкой AY
2478  2B04 00           proc_play_ay_slot2 db 0 ;страница с музыкой AY
2479  2B05 00           proc_play_ay_slot3 db 0 ;страница с музыкой AY
2480  2B06 00           scr_cur db 0 ;текущий активный экран
2481  2B07 00           proc_id_focus db 0 ;процесс, у которого фокус (видимый экран и доступно управление)
2482  2B08 00 00        proc_stack_addr_tmp dw 0 ; временно адрес стека
2483  2B0A 00 00        proc_stack_addr_tmp_wait dw 0 ; временно адрес стека
2484  2B0C 00           os_wait_flag db 0; флаг вызова os_wait
2485  2B0D 00           proc_next_find_skip_flag db 0; флаг дополнительных проверок переключения задач
2486  2B0E 00 00        proc_stack_addr_return_tmp dw 0 ;временно адрес возврата из прерываний
2487  2B10 00           key_proc_switch_flag db 0 ;флаг что нажата клавиша переключения задач
2488  2B11 00           key_lang_flag db 0 ;флаг что нажата клавиша rus lat
2489  2B12 00           key_caps_lock_switch_flag db 0 ;флаг что нажата клавиша caps lock
2490  2B13 00           key_graph_flag db 0 ;флаг что нажата клавиша graph
2491  2B14 00           key_sys_focus db 0 ;кнопка sys процесс в фокус
2492  2B15 00 00        FlgScanKeys_addr dw 0 ;адрес флаги драйвера
2493  2B17              ;stack_adr_sys dw 0 ;адрес системного стека
2494  2B17 00           page_slot3_cur db 0 ;текущая страница вы слоте 3
2495  2B18 00           page_slot2_cur db 0 ;текущая страница вы слоте 2
2496  2B19 00           con_scr_cur db 0 ;страница активного экрана пиксели
2497  2B1A 00           con_atr_cur db 0 ;страница активного экрана атрибуты
2498  2B1B 00           key_cur db 0 ;печатный код нажатой клавиши
2499  2B1C 00           file_id_cur db 0 ;временно id файла
2500  2B1D
2501  2B1D 00           proc_id_next db 0 ;код следующего процесса
2502  2B1E 00 00        proc_stack_adr_tmp dw 0 ;временно адрес стека
2503  2B20 00           proc_id_cur db 0 ;id текущего процесса
2504  2B21              ;proc_id_cur_tmp db 0 ;временно id процесса
2505  2B21              ;proc_sys_name db "SYS        ",0 ;имя системного процесса
2506  2B21              ;proc_cmd_name db "CMD        ",0 ;имя процесса консоль
2507  2B21 00 00 00 00  sys_timer ds 4 ;таймер - счётчик прерываний
2508  2B25
2509  2B25 00 00 00...  	align 256
2510  2C00              proc_table ;данные процессов и приложений
2511  2C00 00 00 00...  	ds proc_descr_size*proc_max ;на командную строку, список страниц и прочее
2512  3400              	;#00 - id процесса
2513  3400              	;#01 - id родительского
2514  3400              	;#02 - страница #8000
2515  3400              	;#03 - страница #c000
2516  3400              	;#04 - страница буфер экран пиксели
2517  3400              	;#05 - страница буфер экран атрибуты
2518  3400              	;#06-07 - адрес стека
2519  3400              	;#08-09 - позиция аппаратного скрола
2520  3400              	;#0a-0b - координаты курсора
2521  3400              	;#0c-0d - цвет текста основной, цвет второй
2522  3400              	;#0e-0f - адрес вызова по прерыванию
2523  3400              	;#10-1b - Имя
2524  3400              	;#1c - графический режим (номер страницы. 0 - текстовый)
2525  3400              	;#1d - флаг, что процесс запросил os_wait
2526  3400
2527  3400              	;..#80 - верх стека
2528  3400
2529  3400              proc_page_table	;таблица занятых процессами страниц
2530  3400 00 00 00...  	ds 128 ;у GMX всего 128
2531  3480
2532  3480
2533  3480              esp_link_id_table;_id_table ;таблица соединений ESP
2534  3480              	;0 - id процесса (одновременно флаг "соединение используется")
2535  3480              	;1 - запрос соединения (=1 - активен)
2536  3480              	;2 - результат соединения (=1 - успешно, =255 - ошибка)
2537  3480              	;3 - запрос на отправку (=1 - активен)
2538  3480              	;4 - результат отправки (=1 - успешно, =255 - ошибка)
2539  3480              	;5 - запрос на приём (=1 - активен)
2540  3480              	;6 - результат приёма (=1 - успешно, =255 - ошибка)
2541  3480              	;7-8 - адрес назначения данных (для принятых)
2542  3480              	;9-10 - длина данных
2543  3480              	;11-13 -
2544  3480              	;14 - тип (TCP, UDP, SSL)
2545  3480              	;15-58 - адрес сервера, в конце 0
2546  3480              	;59-63 - порт сервера, в конце 0
2547  3480
2548  3480 00 00 00...  	ds 1*esp_link_id_table_size_item ;1 соединение
2549  34C0
2550  34C0              ; esp_buffer_flag ;флаги управления буфером ESP
2551  34C0              	; ;0 - буфер занят системным процессом (=1 - идёт передача)
2552  34C0              	; ;1-2 - длина данных
2553  34C0              	; ds 1
2554  34C0
2555  34C0
2556  34C0              ; proc_name_01	db "radio.apg",0
2557  34C0              ; proc_name_02	db "moonr.apg",0
2558  34C0              ; proc_name_03	db "nc.apg",0
2559  34C0 73 79 73 2E  proc_name_sys	db "sys.osg",0
2559  34C4 6F 73 67 00
2560  34C8              ; proc_name_net	db "net.apg",0
2561  34C8
2562  34C8
2563  34C8              ;Константы
2564  34C8              uart_port equ #EF ;порт
2565  34C8              outputBuffer equ #c000 ;адрес файла для плеера AY
2566  34C8              proc_color_def equ 7 ;цвет текста консоли
2567  34C8              proc_color2_def equ #c ;цвет текста консоли 2 яркий
2568  34C8              function_max equ 42+1 ;всего функций
2569  34C8              proc_size_max equ #80 ;максимальный размер приложения старший байт
2570  34C8              proc_descr_size equ 256 ;область памяти на одно приложение
2571  34C8              proc_max equ 8 ;максимальное количество приложений
2572  34C8              page_max equ drvgmx.page_table_end-drvgmx.page_table ;всего доступных страниц из 128
2573  34C8              proc_id_system equ 1 ;код системного процесса
2574  34C8              ;proc_stack equ #4000;адрес стека для процессов
2575  34C8              ;proc_stack_size equ 128 ;размер стека для процесса
2576  34C8              con_scr_real equ #39 ;экран физический
2577  34C8              con_atr_real equ #79 ;атрибуты
2578  34C8              ;page_slot2_def equ 2 ;страница по умолчанию слот 2
2579  34C8              ;page_slot3_def equ 1 ;страница по умолчанию слот 3
2580  34C8              proc_switch_key equ #1b ;код перключения задач sh+Enter
2581  34C8              ;esp_max_link_id equ 5 ;всего соединений ESP
2582  34C8              esp_link_id_table_size_item equ 64 ;размер элемента в таблице соединений
2583  34C8
2584  34C8              ;Сообщения
2585  34C8              msg_init_uart_found
2586  34C8 55 41 52 54  	db "UART #EF found",13,10,0
2586  34CC 20 23 45 46
2586  34D0 20 66 6F 75
2586  34D4 6E 64 0D 0A
2586  34D8 00
2587  34D9              msg_init_uart_not_found
2588  34D9 55 41 52 54  	db "UART #EF not found",13,10,0
2588  34DD 20 23 45 46
2588  34E1 20 6E 6F 74
2588  34E5 20 66 6F 75
2588  34E9 6E 64 0D 0A
2588  34ED 00
2589  34EE              msg_proc_max
2590  34EE 4E 6F 74 20  	db "Not enough processes",13,10,0
2590  34F2 65 6E 6F 75
2590  34F6 67 68 20 70
2590  34FA 72 6F 63 65
2590  34FE 73 73 65 73
2590  3502 0D 0A 00
2591  3505              msg_mem_max
2592  3505 4E 6F 74 20  	db "Not enough memory",13,10,0
2592  3509 65 6E 6F 75
2592  350D 67 68 20 6D
2592  3511 65 6D 6F 72
2592  3515 79 0D 0A 00
2593  3519
2594  3519
2595  3519
2596  3519              msg_ver_os
2597  3519 4F 53 20 76  	db "OS ver 2025.06.20",13,10,0
2597  351D 65 72 20 32
2597  3521 30 32 35 2E
2597  3525 30 36 2E 32
2597  3529 30 0D 0A 00
2598  352D
2599  352D
2600  352D
2601  352D
2602  352D
2603  352D
2604  352D              ; start_sys_incl
2605  352D              	; incbin sys.apg ;
2606  352D              ; end_sys_incl
2607  352D
2608  352D              ; start_cmd_incl
2609  352D              	; incbin cmd.apg ;
2610  352D              ; end_cmd_incl
2611  352D
2612  352D              	;Последний перед #4000 буфер для данных от ESP
2613  352D 00 00 00...  esp_buffer ds 1500 ;буфер для обмена с ESP
2614  3B09
2615  3B09              end_os_main
2616  3B09              	SAVETRD "OS.TRD",|"OS.C",start_os_main,$-start_os_main ;сохранить в TRD
2617  3B09              	SAVEBIN "os.c",start_os_main,$-start_os_main ;сохранить для FAT
2618  3B09
2619  3B09              	;манипуляции для создания hobeta
2620  3B09              	org #c000
2621  C000              	incbin "os.c"
2622  FB09              	SAVEHOB "os.$c","os.C",#C000,end_os_main-start_os_main ;
2623  FB09
2624  FB09
2625  FB09
2626  FB09
2627  FB09
# file closed: os_main.asm
