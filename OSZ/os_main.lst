# file opened: os_main.asm
   1  0000              ;OS GMX (izzx, 2024)
   2  0000
   3  0000
   4  0000              ;sys - системный процесс для OS
   5  0000                 device ZXSPECTRUM128
   6  0000              	include "os_defs.asm"
# file opened: os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;вывод в консоль --------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000              ;очистить консоль
  28+ 0000              	macro OS_CLS ;clear visible area of terminal
  29+ 0000 ~                ld c,#00
  30+ 0000 ~                rst #20
  31+ 0000                  endm
  32+ 0000
  33+ 0000              ;установить позицию курсора в консоли
  34+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  35+ 0000 ~                ld c,#01
  36+ 0000 ~                rst #20
  37+ 0000                  endm
  38+ 0000
  39+ 0000              ;печать символа в консоль
  40+ 0000                  macro OS_PRINT_CHAR ;a=char
  41+ 0000 ~                ld c,#02
  42+ 0000 ~                rst #20
  43+ 0000                  endm
  44+ 0000
  45+ 0000              ;заполнение строки одним символом
  46+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  47+ 0000 ~                ld c,#03
  48+ 0000 ~                rst #20
  49+ 0000                  endm
  50+ 0000
  51+ 0000              ;покрасить строку цветом
  52+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  53+ 0000 ~                ld c,#04
  54+ 0000 ~                rst #20
  55+ 0000                  endm
  56+ 0000
  57+ 0000
  58+ 0000                  ; macro OS_ ;
  59+ 0000                  ; ld c,#05
  60+ 0000                  ; rst #20
  61+ 0000                  ; endm
  62+ 0000
  63+ 0000              ;установить цвет текста в консоли;
  64+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  65+ 0000 ~                ld c,#06
  66+ 0000 ~                rst #20
  67+ 0000                  endm
  68+ 0000
  69+ 0000                  ; macro OS_ ;
  70+ 0000                  ; ld c,#07
  71+ 0000                  ; rst #20
  72+ 0000                  ; endm
  73+ 0000
  74+ 0000                  ; macro OS_ ;
  75+ 0000                  ; ld c,#08
  76+ 0000                  ; rst #20
  77+ 0000                  ; endm
  78+ 0000
  79+ 0000
  80+ 0000
  81+ 0000              ;печать в консоль до кода 0
  82+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
  83+ 0000 ~                ld c,#09
  84+ 0000 ~                rst #20
  85+ 0000                  endm
  86+ 0000
  87+ 0000
  88+ 0000                  ; macro OS_
  89+ 0000                  ; ld c,#0a
  90+ 0000                  ; rst #20
  91+ 0000                  ; endm
  92+ 0000
  93+ 0000                  ; macro OS_
  94+ 0000                  ; ld c,#0b
  95+ 0000                  ; rst #20
  96+ 0000                  ; endm
  97+ 0000
  98+ 0000              ;закрыть соединение ESP
  99+ 0000              ;вх:
 100+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом
 101+ 0000                  macro OS_ESP_CLOSE
 102+ 0000 ~                ld c,#0c
 103+ 0000 ~                rst #20
 104+ 0000                  endm
 105+ 0000
 106+ 0000              ;установить соединение ESP (CIPSTART);
 107+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; hl - строка адрес, de - строка порт
 108+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 109+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 110+ 0000                  macro OS_ESP_OPEN
 111+ 0000 ~                ld c,#0d
 112+ 0000 ~                rst #20
 113+ 0000                  endm
 114+ 0000
 115+ 0000              ;послать запрос ESP (CIPSEND);
 116+ 0000              ;вх: hl - адрес данных, de - длина данных
 117+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом
 118+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 119+ 0000                  macro OS_ESP_SEND
 120+ 0000 ~                ld c,#0e
 121+ 0000 ~                rst #20
 122+ 0000                  endm
 123+ 0000
 124+ 0000              ;получить пакет ESP (+IPD);
 125+ 0000              ;вх: hl - адрес для данных
 126+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом
 127+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 128+ 0000                  macro OS_ESP_GET
 129+ 0000 ~                ld c,#0f
 130+ 0000 ~                rst #20
 131+ 0000                  endm
 132+ 0000
 133+ 0000              ;ввод с консоли ----------------------
 134+ 0000
 135+ 0000              ;получить код нажатой клавиши
 136+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 137+ 0000 ~                ld c,#10
 138+ 0000 ~                rst #20
 139+ 0000                  endm
 140+ 0000
 141+ 0000
 142+ 0000                  ; macro OS_ ;
 143+ 0000                  ; ld c,#11
 144+ 0000                  ; rst #20
 145+ 0000                  ; endm
 146+ 0000
 147+ 0000                  ; macro OS_ ;
 148+ 0000                  ; ld c,#12
 149+ 0000                  ; rst #20
 150+ 0000                  ; endm
 151+ 0000
 152+ 0000                  ; macro OS_ ;
 153+ 0000                  ; ld c,#13
 154+ 0000                  ; rst #20
 155+ 0000                  ; endm
 156+ 0000
 157+ 0000
 158+ 0000              ;прерывания --------------------------
 159+ 0000
 160+ 0000              ;установка адреса обработчика прерываний процесса;
 161+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 162+ 0000                  ; ld c,#14
 163+ 0000                  ; rst #20
 164+ 0000                  ; endm
 165+ 0000
 166+ 0000
 167+ 0000              ;плеер AY ----------------------------
 168+ 0000
 169+ 0000              ;инициализация плеера AY;
 170+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 171+ 0000 ~                ld c,#15
 172+ 0000 ~                rst #20
 173+ 0000                  endm
 174+ 0000
 175+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 176+ 0000                  macro OS_VTPL_PLAY ;()
 177+ 0000 ~                ld c,#16
 178+ 0000 ~                rst #20
 179+ 0000                  endm
 180+ 0000
 181+ 0000              ;заглушить плеер AY;
 182+ 0000                  macro OS_VTPL_MUTE ;()
 183+ 0000 ~                ld c,#17
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;получить значение переменной плеера;
 188+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 189+ 0000 ~                ld c,#18
 190+ 0000 ~                rst #20
 191+ 0000                  endm
 192+ 0000
 193+ 0000
 194+ 0000              ;прочие ------------------------------
 195+ 0000
 196+ 0000
 197+ 0000              ;скопировать данные из страницы в страницу
 198+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 199+ 0000                  macro OS_RAM_COPY
 200+ 0000 ~                ld c,#19
 201+ 0000 ~                rst #20
 202+ 0000                  endm
 203+ 0000
 204+ 0000              ;получить дополнительную страницу памяти;
 205+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 206+ 0000 ~                ld c,#1a
 207+ 0000 ~                rst #20
 208+ 0000                  endm
 209+ 0000
 210+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 211+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 212+ 0000 ~                ld c,#1b
 213+ 0000 ~                rst #20
 214+ 0000                  endm
 215+ 0000
 216+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 217+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 218+ 0000 ~                ld c,#1c
 219+ 0000 ~                rst #20
 220+ 0000                  endm
 221+ 0000
 222+ 0000              ;включить экран N;
 223+ 0000                  macro OS_SET_SCREEN ;(A - number screen 5, 7, 39, 3a)
 224+ 0000 ~                ld c,#1d
 225+ 0000 ~                rst #20
 226+ 0000                  endm
 227+ 0000
 228+ 0000
 229+ 0000              ;получить номера страниц процесса;
 230+ 0000              ;вх:
 231+ 0000              ;вых: b, c - страницы в слотах 2, 3
 232+ 0000                  macro OS_GET_MAIN_PAGES ;
 233+ 0000 ~                ld c,#1e
 234+ 0000 ~                rst #20
 235+ 0000                  endm
 236+ 0000
 237+ 0000              ;получить значение системного таймера
 238+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 239+ 0000 ~                ld c,#1F
 240+ 0000 ~                rst #20
 241+ 0000                  endm
 242+ 0000
 243+ 0000
 244+ 0000
 245+ 0000                  ; macro OS_ ;
 246+ 0000                  ; ld c,#20
 247+ 0000                  ; rst #20
 248+ 0000                  ; endm
 249+ 0000
 250+ 0000
 251+ 0000              ;дисковые операции -------------------
 252+ 0000
 253+ 0000              ;открыть файл для чтения или записи
 254+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size)
 255+ 0000 ~                ld c,#21
 256+ 0000 ~                rst #20
 257+ 0000                  endm
 258+ 0000
 259+ 0000              ;создать файл
 260+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file)
 261+ 0000 ~                ld c,#22
 262+ 0000 ~                rst #20
 263+ 0000                  endm
 264+ 0000
 265+ 0000              ;прочитать из файла
 266+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
 267+ 0000 ~                ld c,#23
 268+ 0000 ~                rst #20
 269+ 0000                  endm
 270+ 0000
 271+ 0000              ;записать в файл
 272+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 273+ 0000 ~                ld c,#24
 274+ 0000 ~                rst #20
 275+ 0000                  endm
 276+ 0000
 277+ 0000              ;закрыть файл
 278+ 0000                  macro OS_FILE_CLOSE ;A - id file
 279+ 0000 ~                ld c,#25
 280+ 0000 ~                rst #20
 281+ 0000                  endm
 282+ 0000
 283+ 0000                  ; macro OS_ ;
 284+ 0000                  ; ld c,#26
 285+ 0000                  ; rst #20
 286+ 0000                  ; endm
 287+ 0000
 288+ 0000                  ; macro OS_ ;
 289+ 0000                  ; ld c,#27
 290+ 0000                  ; rst #20
 291+ 0000                  ; endm
 292+ 0000
 293+ 0000                  ; macro OS_ ;
 294+ 0000                  ; ld c,#28
 295+ 0000                  ; rst #20
 296+ 0000                  ; endm
 297+ 0000
 298+ 0000                  ; macro OS_ ;
 299+ 0000                  ; ld c,#29
 300+ 0000                  ; rst #20
 301+ 0000                  ; endm
 302+ 0000
 303+ 0000
# file closed: os_defs.asm
   7  0000              	org PROGSTART
   8  8000              	;bank 1
   9  8000              start_sys
  10  8000 FB           	ei
  11  8001 76           	halt ;ожидание старта после прерывания
  12  8002 76           	halt
  13  8003 21 25 31     	ld hl,msg_ver_os
  14  8006              	;печать приветствия
  15  8006 CD 0B 08     	call drvgmx.printZ
  16  8009
  17  8009
  18  8009              ;инициализация устройств
  19  8009              ;uart #EF (wifi)
  20  8009 AF           	xor a
  21  800A 32 00 27     	ld (uart_enable),a ;флаг порт отсутствует
  22  800D CD 7E 82     	call Uart.check
  23  8010 FE FF        	cp 255
  24  8012              	;jr z,init_uart_no ;отключена проверка
  25  8012              	;нашли uart
  26  8012 3E 01        	ld a,1
  27  8014 32 00 27     	ld (uart_enable),a ;порт есть
  28  8017 21 D4 30     	ld hl,msg_init_uart_found
  29  801A CD 0B 08     	call drvgmx.printZ
  30  801D CD EF 82     	call Wifi.init
  31  8020 18 06        	jr init_uart_yes
  32  8022              init_uart_no
  33  8022              	;печать
  34  8022 21 E5 30     	ld hl,msg_init_uart_not_found
  35  8025 CD 0B 08     	call drvgmx.printZ
  36  8028              init_uart_yes
  37  8028
  38  8028 CD D0 0A     	call Dos.init_fs_fat ;выбор раздела (буквы диска)
  39  802B
  40  802B              	;call proc_run_cmd ;запустить консоль
  41  802B              	;call proc_run_cmd ;запустить консоль
  42  802B              	; call proc_run_cmd ;запустить консоль
  43  802B              	; call proc_run_cmd ;запустить консоль
  44  802B              	; call proc_run_cmd ;запустить консоль
  45  802B              	;call proc_run_cmd ;запустить консоль
  46  802B              	;call proc_run_cmd ;запустить консоль
  47  802B
  48  802B 21 C0 30     	ld hl,proc_name_01		;строка с именем
  49  802E CD EA 02     	call proc_run
  50  8031
  51  8031 21 CA 30     	ld hl,proc_name_02		;строка с именем
  52  8034 CD EA 02     	call proc_run
  53  8037
  54  8037
  55  8037 DD 7E 00     	ld a,(ix)
  56  803A CD 52 02     	call proc_set_focus ;на передний план
  57  803D
  58  803D              sys_loop
  59  803D 76           	halt
  60  803E CD 7C 81     	call print_active
  61  8041 3A 0A 27     	ld a,(proc_switch_key_flag)
  62  8044 B7           	or a
  63  8045 28 0F        	jr z,sys_loop1
  64  8047 CD 4C 02     	call proc_focus_next
  65  804A              sys_loop_switch
  66  804A 76           	halt
  67  804B              	OS_GET_CHAR ;ждать пока отпустят
  67  804B 0E 10       >    ld c,#10
  67  804D E7          >    rst #20
  68  804E FE FF        	cp 255
  69  8050 20 F8        	jr nz,sys_loop_switch
  70  8052 AF           	xor a
  71  8053 32 0A 27     	ld (proc_switch_key_flag),a
  72  8056              sys_loop1
  73  8056 3A 2D 27     	ld a,(sys_timer) ;иногда печатаем системную информацию
  74  8059 E6 1C        	and %00011100
  75  805B CC 71 80     	call z,sys_print_info
  76  805E              	; OS_GETCHAR ;получить нажатую клавишу
  77  805E              	; cp 255
  78  805E              	; jr z,sys_loop
  79  805E              	; OS_PRINT_CHARF ;печать символа
  80  805E
  81  805E CD 9E 81     	call esp_check_open ;проверить соединения
  82  8061 CD 04 82     	call esp_check_send ;проверить пакеты на отправку
  83  8064 CD 27 82     	call esp_check_get ;проверить пакеты на приём
  84  8067 3A 2D 27     	ld a,(sys_timer) ;иногда печатаем сетевую информацию
  85  806A E6 0E        	and %00001110
  86  806C CC B4 80     	call z,print_esp_link
  87  806F
  88  806F 18 CC        	jr sys_loop
  89  8071
  90  8071
  91  8071              sys_print_info
  92  8071              	;печать информации о памяти и процессах
  93  8071 CD 32 81     	call get_proc_total ;печать и подсчёт процессов
  94  8074 6F           	ld l,a
  95  8075 26 00        	ld h,0
  96  8077 CD B4 85     	call toDecimal
  97  807A 11 00 0D     	ld de,#0d00 ;координаты yx
  98  807D              	OS_SET_XY
  98  807D 0E 01       >    ld c,#01
  98  807F E7          >    rst #20
  99  8080 21 10 86     	ld hl,msg_processes
 100  8083 CD 0B 08     	call drvgmx.printZ
 101  8086 21 0D 86     	ld hl,decimalS+3
 102  8089 CD 0B 08     	call drvgmx.printZ
 103  808C
 104  808C 11 00 0C     	ld de,#0c00 ;координаты yx
 105  808F              	OS_SET_XY
 105  808F 0E 01       >    ld c,#01
 105  8091 E7          >    rst #20
 106  8092 21 1C 86     	ld hl,msg_free_ram
 107  8095 CD 0B 08     	call drvgmx.printZ
 108  8098 CD 6B 81     	call get_free_ram ;памяти
 109  809B 6F           	ld l,a
 110  809C 26 00        	ld h,0
 111  809E CD B4 85     	call toDecimal
 112  80A1 21 0C 86     	ld hl,decimalS+2
 113  80A4 CD 0B 08     	call drvgmx.printZ
 114  80A7 11 00 18     	ld de,#1800 ;координаты yx
 115  80AA              	OS_SET_XY
 115  80AA 0E 01       >    ld c,#01
 115  80AC E7          >    rst #20
 116  80AD 21 48 86     	ld hl,msg_press_num_to_close
 117  80B0              	OS_PRINTZ
 117  80B0 0E 09       >    ld c,#09
 117  80B2 E7          >    rst #20
 118  80B3 C9           	ret
 119  80B4
 120  80B4
 121  80B4              print_esp_link
 122  80B4 26 0B        	ld h,#0b
 123  80B6 3E 20        	ld a," "
 124  80B8              	OS_FILL_LINE ;почистить строку
 124  80B8 0E 03       >    ld c,#03
 124  80BA E7          >    rst #20
 125  80BB DD 21 80 30  	ld ix,esp_link_id_table
 126  80BF DD 7E 00     	ld a,(ix)
 127  80C2 B7           	or a
 128  80C3 C8           	ret z ;если нет соединений
 129  80C4 11 00 0B     	ld de,#0b00 ;координаты yx
 130  80C7              	OS_SET_XY
 130  80C7 0E 01       >    ld c,#01
 130  80C9 E7          >    rst #20
 131  80CA 21 2D 86     	ld hl,msg_esp_link
 132  80CD              	OS_PRINTZ
 132  80CD 0E 09       >    ld c,#09
 132  80CF E7          >    rst #20
 133  80D0 DD 7E 00     	ld a,(ix)
 134  80D3 C6 30        	add '0'
 135  80D5              	OS_PRINT_CHARF ;id
 135  80D5 D7          >	rst #10
 136  80D6 3E 20        	ld a," "
 137  80D8              	OS_PRINT_CHARF
 137  80D8 D7          >	rst #10
 138  80D9
 139  80D9 21 36 86     	ld hl,msg_esp_transmit
 140  80DC              	OS_PRINTZ
 140  80DC 0E 09       >    ld c,#09
 140  80DE E7          >    rst #20
 141  80DF DD 7E 04     	ld a,(ix+4)
 142  80E2 B7           	or a
 143  80E3 28 1C        	jr z,print_esp_link2
 144  80E5 DD 7E 05     	ld a,(ix+5) ;при этом не начался приём
 145  80E8 4F           	ld c,a
 146  80E9 DD 7E 06     	ld a,(ix+6)
 147  80EC B1           	or c
 148  80ED 20 12        	jr nz,print_esp_link2
 149  80EF DD 6E 09     	ld l,(ix+9)
 150  80F2 DD 66 0A     	ld h,(ix+10)
 151  80F5 CD B4 85     	call toDecimal
 152  80F8 21 0A 86     	ld hl,decimalS
 153  80FB              	OS_PRINTZ	;отправлено
 153  80FB 0E 09       >    ld c,#09
 153  80FD E7          >    rst #20
 154  80FE 3E 20        	ld a," "
 155  8100              	OS_PRINT_CHARF
 155  8100 D7          >	rst #10
 156  8101              print_esp_link2
 157  8101
 158  8101 21 3C 86     	ld hl,msg_esp_receive
 159  8104              	OS_PRINTZ
 159  8104 0E 09       >    ld c,#09
 159  8106 E7          >    rst #20
 160  8107 DD 7E 06     	ld a,(ix+6)
 161  810A B7           	or a
 162  810B 28 12        	jr z,print_esp_link3
 163  810D DD 6E 09     	ld l,(ix+9)
 164  8110 DD 66 0A     	ld h,(ix+10)
 165  8113 CD B4 85     	call toDecimal
 166  8116 21 0A 86     	ld hl,decimalS
 167  8119              	OS_PRINTZ	;принято
 167  8119 0E 09       >    ld c,#09
 167  811B E7          >    rst #20
 168  811C 3E 20        	ld a," "
 169  811E              	OS_PRINT_CHARF
 169  811E D7          >	rst #10
 170  811F              print_esp_link3
 171  811F
 172  811F 21 42 86     	ld hl,msg_esp_address
 173  8122              	OS_PRINTZ
 173  8122 0E 09       >    ld c,#09
 173  8124 E7          >    rst #20
 174  8125 DD 7E 02     	ld a,(ix+2) ;соединение установлено
 175  8128 B7           	or a
 176  8129 28 06        	jr z,print_esp_link4
 177  812B 21 8F 30     	ld hl,esp_link_id_table+15 ;сервер
 178  812E              	OS_PRINTZ
 178  812E 0E 09       >    ld c,#09
 178  8130 E7          >    rst #20
 179  8131              print_esp_link4
 180  8131 C9           	ret
 181  8132
 182  8132              get_proc_total
 183  8132              	;поиск и печать количества запущеных процессов
 184  8132              	;вых: a - количество активных
 185  8132 11 00 0E     	ld de,#0e00 ;координаты yx
 186  8135              	OS_SET_XY
 186  8135 0E 01       >    ld c,#01
 186  8137 E7          >    rst #20
 187  8138 DD 21 00 28  	ld ix,proc_table
 188  813C 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 189  813E 0E 00        	ld c,0 ;счётчик
 190  8140              get_proc_total_cl
 191  8140 DD 7E 00     	ld a,(ix)
 192  8143 B7           	or a ;свободен?
 193  8144 28 1F        	jr z,get_proc_total_cl1
 194  8146
 195  8146 C5           	push bc
 196  8147 C6 30        	add '0' ;печать id
 197  8149              	OS_PRINT_CHARF
 197  8149 D7          >	rst #10
 198  814A 3E 20        	ld a," "
 199  814C              	OS_PRINT_CHARF
 199  814C D7          >	rst #10
 200  814D DD 7E 01     	ld a,(ix+1)
 201  8150 C6 30        	add '0' ;печать id родительского
 202  8152              	OS_PRINT_CHARF
 202  8152 D7          >	rst #10
 203  8153 3E 20        	ld a," "
 204  8155              	OS_PRINT_CHARF
 204  8155 D7          >	rst #10
 205  8156
 206  8156 DD E5        	push ix
 207  8158 E1           	pop hl
 208  8159 01 10 00     	ld bc,16
 209  815C 09           	add hl,bc
 210  815D              	OS_PRINTZ ;печать имени
 210  815D 0E 09       >    ld c,#09
 210  815F E7          >    rst #20
 211  8160
 212  8160 3E 0D        	ld a,13
 213  8162              	OS_PRINT_CHARF
 213  8162 D7          >	rst #10
 214  8163
 215  8163 C1           	pop bc
 216  8164
 217  8164 0C           	inc c ;прибавить
 218  8165              get_proc_total_cl1
 219  8165 DD 24        	inc ixh
 220  8167 10 D7        	djnz get_proc_total_cl
 221  8169 79           	ld a,c
 222  816A C9           	ret
 223  816B
 224  816B
 225  816B              get_free_ram
 226  816B              	;поиск количества свободных страниц памяти
 227  816B              	;вых: a - количество свободных
 228  816B 21 00 30     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 229  816E 06 6D        	ld b,page_max ;всего страниц
 230  8170 0E 00        	ld c,0 ;счётчик
 231  8172              get_free_ram_cl
 232  8172 7E           	ld a,(hl)
 233  8173 B7           	or a ;свободен?
 234  8174 20 01        	jr nz,get_free_ram_cl1
 235  8176 0C           	inc c ;прибавить
 236  8177              get_free_ram_cl1
 237  8177 23           	inc hl
 238  8178 10 F8        	djnz get_free_ram_cl
 239  817A 79           	ld a,c
 240  817B C9           	ret
 241  817C
 242  817C
 243  817C
 244  817C              print_active ;значёк активности
 245  817C 11 00 0A     	ld de,#0a00 ;координаты yx
 246  817F              	OS_SET_XY
 246  817F 0E 01       >    ld c,#01
 246  8181 E7          >    rst #20
 247  8182 21 67 86     	ld hl,msg_active
 248  8185              	OS_PRINTZ
 248  8185 0E 09       >    ld c,#09
 248  8187 E7          >    rst #20
 249  8188 3A 74 86     	ld a,(msg_active_cur)
 250  818B 3C           	inc a
 251  818C FE 04        	cp 4
 252  818E 38 01        	jr c,print_active1
 253  8190 AF           	xor a
 254  8191              print_active1
 255  8191 32 74 86     	ld (msg_active_cur),a
 256  8194 4F           	ld c,a
 257  8195 06 00        	ld b,0
 258  8197 21 6F 86     	ld hl,msg_active1
 259  819A 09           	add hl,bc
 260  819B 7E           	ld a,(hl)
 261  819C              	OS_PRINT_CHARF
 261  819C D7          >	rst #10
 262  819D C9           	ret
 263  819E
 264  819E
 265  819E
 266  819E
 267  819E              esp_check_open ;проверка очереди соединений ESP
 268  819E DD 21 80 30  	ld ix,esp_link_id_table ;
 269  81A2              	;push bc
 270  81A2 DD 7E 01     	ld a,(ix+1)
 271  81A5 B7           	or a ;запрос есть?
 272  81A6 C8           	ret z
 273  81A7              	;есть запрос
 274  81A7
 275  81A7 DD 7E 0E     	ld a,(ix+14) ;подставить тип соединения
 276  81AA B7           	or a
 277  81AB 20 11        	jr nz,esp_check_open_type1
 278  81AD 3E 54        	ld a,'T'
 279  81AF 32 6D 85     	ld (Wifi.cmd_CIPSTART2+0),a
 280  81B2 3E 43        	ld a,'C'
 281  81B4 32 6E 85     	ld (Wifi.cmd_CIPSTART2+1),a
 282  81B7 3E 50        	ld a,'P'
 283  81B9 32 6F 85     	ld (Wifi.cmd_CIPSTART2+2),a
 284  81BC 18 2A        	jr esp_check_open_type_skip
 285  81BE              esp_check_open_type1
 286  81BE FE 01        	cp 1
 287  81C0 20 11        	jr nz,esp_check_open_type2
 288  81C2 3E 55        	ld a,'U'
 289  81C4 32 6D 85     	ld (Wifi.cmd_CIPSTART2+0),a
 290  81C7 3E 44        	ld a,'D'
 291  81C9 32 6E 85     	ld (Wifi.cmd_CIPSTART2+1),a
 292  81CC 3E 50        	ld a,'P'
 293  81CE 32 6F 85     	ld (Wifi.cmd_CIPSTART2+2),a
 294  81D1 18 15        	jr esp_check_open_type_skip
 295  81D3              esp_check_open_type2
 296  81D3 FE 02        	cp 2
 297  81D5 20 11        	jr nz,esp_check_open_type_skip
 298  81D7 3E 53        	ld a,'S'
 299  81D9 32 6D 85     	ld (Wifi.cmd_CIPSTART2+0),a
 300  81DC 3E 53        	ld a,'S'
 301  81DE 32 6E 85     	ld (Wifi.cmd_CIPSTART2+1),a
 302  81E1 3E 4C        	ld a,'L'
 303  81E3 32 6F 85     	ld (Wifi.cmd_CIPSTART2+2),a
 304  81E6 18 00        	jr esp_check_open_type_skip
 305  81E8
 306  81E8              esp_check_open_type_skip
 307  81E8 11 BB 30     	ld de,esp_link_id_table+59 ;номер порта
 308  81EB 21 8F 30     	ld hl,esp_link_id_table+15 ;;адрес сервера
 309  81EE CD 91 83     	call Wifi.openTCP
 310  81F1 30 04        	jr nc,esp_check_open_res
 311  81F3 3E FF        	ld a,255 ;ошибка
 312  81F5 18 05        	jr esp_check_open_err
 313  81F7              esp_check_open_res
 314  81F7              	;результат запишем
 315  81F7 3A EE 82     	ld a,(Wifi.closed)
 316  81FA EE 01        	xor 1
 317  81FC              esp_check_open_err
 318  81FC DD 77 02     	ld (ix+2),a ;поставить флаг результата открытия
 319  81FF DD 36 01 00  	ld (ix+1),0 ;сбросить флаг запроса
 320  8203 C9           	ret
 321  8204
 322  8204
 323  8204
 324  8204
 325  8204
 326  8204              esp_check_send ;проверить пакеты на отправку
 327  8204 DD 21 80 30  	ld ix,esp_link_id_table ;
 328  8208 DD 7E 03     	ld a,(ix+3)
 329  820B B7           	or a ;запрос есть?
 330  820C C8           	ret z
 331  820D              	;есть запрос
 332  820D DD 5E 09     	ld e,(ix+9) ;длина данных
 333  8210 DD 56 0A     	ld d,(ix+10)
 334  8213 21 24 3A     	ld hl,esp_buffer ;адрес
 335  8216 CD 52 84     	call Wifi.tcpSend
 336  8219 3E 01        	ld a,1 ;успех
 337  821B 30 02        	jr nc,esp_check_send_res
 338  821D 3E FF        	ld a,255 ;ошибка
 339  821F              esp_check_send_res
 340  821F DD 77 04     	ld (ix+4),a ;поставить флаг результата отправки
 341  8222 DD 36 03 00  	ld (ix+3),0 ;сбросить флаг запроса
 342  8226 C9           	ret
 343  8227
 344  8227
 345  8227
 346  8227
 347  8227
 348  8227              esp_check_get ;проверить пакеты на приём
 349  8227 DD 21 80 30  	ld ix,esp_link_id_table ;
 350  822B DD 7E 05     	ld a,(ix+5)
 351  822E B7           	or a ;запрос есть?
 352  822F C8           	ret z
 353  8230              	;есть запрос
 354  8230 21 00 00     	ld hl,0
 355  8233 22 EA 82     	ld (Wifi.bytes_avail), hl ;длину сбросим
 356  8236 21 24 3A     	ld hl,esp_buffer ;адрес
 357  8239 22 EC 82     	ld (Wifi.buffer_pointer),hl ;
 358  823C CD 94 84     	call Wifi.getPacket
 359  823F 30 0A        	jr nc,esp_check_get_res
 360  8241 3E FF        	ld a,255 ;ошибка
 361  8243 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 362  8246 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 363  824A C9           	ret
 364  824B              esp_check_get_res
 365  824B              	;если что-то принято
 366  824B ED 4B EA 82  	ld bc,(Wifi.bytes_avail) ;длина
 367  824F DD 71 09     	ld (ix+9),c ;длина принятых
 368  8252 DD 70 0A     	ld (ix+10),b
 369  8255
 370  8255 78           	ld a,b
 371  8256 B1           	or c
 372  8257 28 0F        	jr z,esp_check_get_skip_copy2 ;защита от нулевой длины
 373  8259
 374  8259 DD 5E 07     	ld e,(ix+7) ;адрес назначения
 375  825C DD 56 08     	ld d,(ix+8)
 376  825F DD 7E 00     	ld a,(ix) ;id назначения
 377  8262 21 24 3A     	ld hl,esp_buffer ;откуда
 378  8265 CD 59 05     	call esp_buffer_copy ;перекинем данные силами ядра
 379  8268
 380  8268              esp_check_get_skip_copy2
 381  8268 DD 21 80 30  	ld ix,esp_link_id_table ;
 382  826C 3A EE 82     	ld a,(Wifi.closed)
 383  826F EE 01        	xor 1
 384  8271 DD 77 02     	ld (ix+2),a ;поставить текущий флаг открытия
 385  8274 3E 01        	ld a,1 ;успех
 386  8276 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 387  8279 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 388  827D C9           	ret
 389  827E
 390  827E
 391  827E
 392  827E              	include Drv/zx-wifi.asm ;драйвер сетевой карты ESP
# file opened: Drv/zx-wifi.asm
   1+ 827E              ; This driver works with 16c550 uart that's support AFE
   2+ 827E                  module Uart
   3+ 827E              ; Make init shorter and readable:-)
   4+ 827E                  macro outp port, value
   5+ 827E ~            	ld b, port
   6+ 827E ~            	ld c, #EF
   7+ 827E ~                ld a, value
   8+ 827E ~                out (c), a
   9+ 827E                  endm
  10+ 827E
  11+ 827E              ; Internal port constants
  12+ 827E              RBR_THR = #F8
  13+ 827E              IER     = RBR_THR + 1
  14+ 827E              IIR_FCR = RBR_THR + 2
  15+ 827E              LCR     = RBR_THR + 3
  16+ 827E              MCR     = RBR_THR + 4
  17+ 827E              LSR     = RBR_THR + 5
  18+ 827E              MSR     = RBR_THR + 6
  19+ 827E              SR      = RBR_THR + 7
  20+ 827E
  21+ 827E
  22+ 827E              ;out: a=255 - no UART
  23+ 827E              check: ;проверка есть ли карта
  24+ 827E 3E F8        	ld a, RBR_THR
  25+ 8280 DB FE            in a, (#fe)
  26+ 8282 FE FF        	cp #ff
  27+ 8284 C0           	ret nz ;если читает 255, то нет карты
  28+ 8285 3E F8        	ld a, RBR_THR
  29+ 8287 DB FE            in a, (#fe) ;второй раз для надёжности
  30+ 8289 FE FF        	cp #ff
  31+ 828B C9           	ret
  32+ 828C
  33+ 828C
  34+ 828C              init:
  35+ 828C                  outp MCR,     #0d  // Assert RTS
  35+ 828C 06 FC       >	ld b, MCR
  35+ 828E 0E EF       >	ld c, #EF
  35+ 8290 3E 0D       >    ld a, #0d
  35+ 8292 ED 79       >    out (c), a
  36+ 8294                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  36+ 8294 06 FA       >	ld b, IIR_FCR
  36+ 8296 0E EF       >	ld c, #EF
  36+ 8298 3E 87       >    ld a, #87
  36+ 829A ED 79       >    out (c), a
  37+ 829C                  outp LCR,     #83  // 8n1, DLAB=1
  37+ 829C 06 FB       >	ld b, LCR
  37+ 829E 0E EF       >	ld c, #EF
  37+ 82A0 3E 83       >    ld a, #83
  37+ 82A2 ED 79       >    out (c), a
  38+ 82A4                  outp RBR_THR, #01  // 115200 (divider 1)
  38+ 82A4 06 F8       >	ld b, RBR_THR
  38+ 82A6 0E EF       >	ld c, #EF
  38+ 82A8 3E 01       >    ld a, #01
  38+ 82AA ED 79       >    out (c), a
  39+ 82AC                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  39+ 82AC 06 F9       >	ld b, IER
  39+ 82AE 0E EF       >	ld c, #EF
  39+ 82B0 3E 00       >    ld a, #00
  39+ 82B2 ED 79       >    out (c), a
  40+ 82B4
  41+ 82B4                  outp LCR,     #03 // 8n1, DLAB=0
  41+ 82B4 06 FB       >	ld b, LCR
  41+ 82B6 0E EF       >	ld c, #EF
  41+ 82B8 3E 03       >    ld a, #03
  41+ 82BA ED 79       >    out (c), a
  42+ 82BC                  outp IER,     #00 // Disable int
  42+ 82BC 06 F9       >	ld b, IER
  42+ 82BE 0E EF       >	ld c, #EF
  42+ 82C0 3E 00       >    ld a, #00
  42+ 82C2 ED 79       >    out (c), a
  43+ 82C4                  outp MCR,     #2f // Enable AFE
  43+ 82C4 06 FC       >	ld b, MCR
  43+ 82C6 0E EF       >	ld c, #EF
  43+ 82C8 3E 2F       >    ld a, #2f
  43+ 82CA ED 79       >    out (c), a
  44+ 82CC C9               ret
  45+ 82CD
  46+ 82CD              ;retry_rec_count_max equ %00011111 ;ждать столько прерываний
  47+ 82CD
  48+ 82CD              ; Flag C <- Data available
  49+ 82CD              ; isAvailable:
  50+ 82CD                  ; ld a, LSR
  51+ 82CD                  ; in a, (#EF)
  52+ 82CD                  ; rrca
  53+ 82CD                  ; ret
  54+ 82CD
  55+ 82CD              ; Non-blocking read
  56+ 82CD              ; Flag C <- is byte was readen
  57+ 82CD              ; A <- byte
  58+ 82CD              ; read1:
  59+ 82CD                  ; ld a, LSR
  60+ 82CD                  ; in a, (#EF)
  61+ 82CD                  ; rrca
  62+ 82CD                  ; ret nc
  63+ 82CD                  ; ld a, RBR_THR
  64+ 82CD                  ; in a, (#EF)
  65+ 82CD                  ; scf
  66+ 82CD                  ; ret
  67+ 82CD
  68+ 82CD              ; Tries read byte with timeout
  69+ 82CD              ; Flag C <- is byte read
  70+ 82CD              ; A <- byte
  71+ 82CD              read:
  72+ 82CD              	;xor a ;4
  73+ 82CD              	;ld (#5C78),a ;обнулить счётчик ожидания ;13
  74+ 82CD              .wait
  75+ 82CD 3E FD            ld a, LSR
  76+ 82CF DB EF            in a, (#EF)
  77+ 82D1 0F               rrca
  78+ 82D2 30 F9        	jr nc, .wait
  79+ 82D4 3E F8            ld a, RBR_THR
  80+ 82D6 DB EF            in a, (#EF)
  81+ 82D8 C9           	ret
  82+ 82D9              ; .readW
  83+ 82D9              	; OS_GETTIMER
  84+ 82D9              	; ld a,e
  85+ 82D9              	; and retry_rec_count_max
  86+ 82D9              	; ;ld a,(#5C78)
  87+ 82D9              	; ;cp retry_rec_count_max
  88+ 82D9              	; jr nz, .wait ;ещё попытка
  89+ 82D9              	; xor a ;выключим флаг переноса если время вышло
  90+ 82D9              	; ret
  91+ 82D9
  92+ 82D9
  93+ 82D9
  94+ 82D9
  95+ 82D9              ; Blocking read
  96+ 82D9              ; A <- Byte
  97+ 82D9              ; readB:
  98+ 82D9                  ; ld a, LSR
  99+ 82D9                  ; in a, (#EF)
 100+ 82D9                  ; rrca
 101+ 82D9                  ; jr nc, readB
 102+ 82D9              	; ld a, RBR_THR
 103+ 82D9                  ; in a, (#EF)
 104+ 82D9                  ; ret
 105+ 82D9
 106+ 82D9              ; A -> byte to send
 107+ 82D9              write:
 108+ 82D9 F5               push af
 109+ 82DA              .wait
 110+ 82DA 3E FD        	ld a, LSR
 111+ 82DC DB EF            in a, (#EF)
 112+ 82DE E6 20            and #20
 113+ 82E0 28 F8            jr z, .wait
 114+ 82E2 F1               pop af
 115+ 82E3 06 F8        	ld b, RBR_THR
 116+ 82E5 0E EF        	ld c, #EF
 117+ 82E7 ED 79            out (c), a
 118+ 82E9 C9               ret
 119+ 82EA
 120+ 82EA                  endmodule
# file closed: Drv/zx-wifi.asm
 393  82EA              	include Drv/wifi.asm ;работа с ESP
# file opened: Drv/wifi.asm
   1+ 82EA                  MODULE Wifi
   2+ 82EA 00 00        bytes_avail dw 0 ;байт для приёма
   3+ 82EC 00 00        buffer_pointer dw 0 ;указатель на адрес буфера
   4+ 82EE 01           closed db 1 ;флаг "соединение закрыто"
   5+ 82EF              ;link_id db 0 ;текущий id соединения
   6+ 82EF              buffer_end equ #40 ;ограничение буфера адрес #4000
   7+ 82EF
   8+ 82EF              ; Initialize Wifi chip to work
   9+ 82EF              init:
  10+ 82EF 21 68 83         ld hl, .uartIniting
  10+ 82F2 CD 0B 08       call drvgmx.printZ
  11+ 82F5 CD 8C 82         call Uart.init ;
  12+ 82F8 21 79 83         ld hl, .chipIniting
  12+ 82FB CD 0B 08       call drvgmx.printZ
  13+ 82FE                  ;EspCmdOkErr "ATE0"
  14+ 82FE 21 48 85     	ld hl,cmd_ATE0
  15+ 8301 CD 37 84     	call espSendZ
  16+ 8304 CD D0 83     	call checkOkErr
  17+ 8307 38 3F            jr c, .initError
  18+ 8309
  19+ 8309                  ;EspCmdOkErr "AT+CIPSERVER=0"
  20+ 8309 21 4F 85     	ld hl,cmd_CIPSERVER
  21+ 830C CD 37 84     	call espSendZ
  22+ 830F CD D0 83     	call checkOkErr
  23+ 8312                  ;jr c, .initError ;не проверяем ошибку
  24+ 8312                  ;EspCmdOkErr "AT+CIPCLOSE" ;  Close if there some connection was. Don't care about result
  25+ 8312 21 80 85     	ld hl,cmd_CIPCLOSE
  26+ 8315 CD 37 84     	call espSendZ
  27+ 8318 3E 35        	ld a,'5' ;закрыть все соединения
  28+ 831A CD D9 82     	call Uart.write
  29+ 831D 3E 0D            ld a, 13
  29+ 831F CD D9 82       call Uart.write
  30+ 8322 3E 0A            ld a, 10
  30+ 8324 CD D9 82       call Uart.write
  31+ 8327 CD D0 83     	call checkOkErr
  32+ 832A                  ;jr c, .initError ;не проверяем ошибку
  33+ 832A                  ;EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  34+ 832A 21 8C 85     	ld hl,cmd_CIPMUX
  35+ 832D CD 37 84     	call espSendZ
  36+ 8330 CD D0 83     	call checkOkErr
  37+ 8333 38 13            jr c, .initError
  38+ 8335
  39+ 8335                  ;EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  40+ 8335 21 9A 85     	ld hl,cmd_CIPDINFO
  41+ 8338 CD 37 84     	call espSendZ
  42+ 833B CD D0 83     	call checkOkErr
  43+ 833E 38 08            jr c, .initError
  44+ 8340
  45+ 8340 21 8A 83         ld hl, .doneInit
  45+ 8343 CD 0B 08       call drvgmx.printZ
  46+ 8346
  47+ 8346 B7               or a
  48+ 8347 C9               ret
  49+ 8348              .initError
  50+ 8348 21 50 83         ld hl, .errMsg
  50+ 834B CD 0B 08       call drvgmx.printZ
  51+ 834E 37               scf
  52+ 834F C9               ret
  53+ 8350 57 69 46 69  .errMsg db "WiFi chip init failed!",13,0
  53+ 8354 20 63 68 69
  53+ 8358 70 20 69 6E
  53+ 835C 69 74 20 66
  53+ 8360 61 69 6C 65
  53+ 8364 64 21 0D 00
  54+ 8368 55 61 72 74  .uartIniting db "Uart initing...",13,0
  54+ 836C 20 69 6E 69
  54+ 8370 74 69 6E 67
  54+ 8374 2E 2E 2E 0D
  54+ 8378 00
  55+ 8379 43 68 69 70  .chipIniting db "Chip initing...",13,0
  55+ 837D 20 69 6E 69
  55+ 8381 74 69 6E 67
  55+ 8385 2E 2E 2E 0D
  55+ 8389 00
  56+ 838A 44 6F 6E 65  .doneInit    db "Done!",13,0
  56+ 838E 21 0D 00
  57+ 8391                  IFNDEF PROXY
  58+ 8391              ; HL - host pointer in gopher row
  59+ 8391              ; DE - port pointer in gopher row
  60+ 8391              openTCP:
  61+ 8391 D5               push de
  62+ 8392 E5               push hl
  63+ 8393                  ;EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  64+ 8393 21 80 85     	ld hl,cmd_CIPCLOSE
  65+ 8396 CD 37 84     	call espSendZ
  66+ 8399              	; ld a,(link_id)
  67+ 8399              	; call Uart.write
  68+ 8399 3E 0D            ld a, 13
  68+ 839B CD D9 82       call Uart.write
  69+ 839E 3E 0A            ld a, 10
  69+ 83A0 CD D9 82       call Uart.write
  70+ 83A3 CD D0 83     	call checkOkErr
  71+ 83A6
  72+ 83A6                  ;EspSend 'AT+CIPSTART,"TCP","' ;
  73+ 83A6 21 60 85     	ld hl,cmd_CIPSTART
  74+ 83A9 CD 37 84     	call espSendZ
  75+ 83AC              	; ld a,(link_id)
  76+ 83AC              	; call Uart.write
  77+ 83AC              	; ld hl,cmd_CIPSTART2
  78+ 83AC              	; call espSendZ
  79+ 83AC
  80+ 83AC
  81+ 83AC E1               pop hl
  82+ 83AD CD 40 84         call espSendT
  83+ 83B0                  ;EspSend '",'
  84+ 83B0 3E 22            ld a, '"'
  84+ 83B2 CD D9 82       call Uart.write
  85+ 83B5 3E 2C            ld a, ','
  85+ 83B7 CD D9 82       call Uart.write
  86+ 83BA E1               pop hl
  87+ 83BB CD 40 84         call espSendT
  88+ 83BE 3E 0D            ld a, 13
  88+ 83C0 CD D9 82       call Uart.write
  89+ 83C3 3E 0A            ld a, 10
  89+ 83C5 CD D9 82       call Uart.write
  90+ 83C8 AF               xor a
  90+ 83C9 32 EE 82       ld (closed), a
  91+ 83CC C3 D0 83         jp checkOkErr
  92+ 83CF
  93+ 83CF              continue:
  94+ 83CF C9               ret
  95+ 83D0                  ENDIF
  96+ 83D0
  97+ 83D0
  98+ 83D0
  99+ 83D0              checkOkErr:
 100+ 83D0 CD CD 82         call Uart.read
 101+ 83D3 FE 4F            cp 'O'
 101+ 83D5 28 0A          jr z, .okStart ; OK
 102+ 83D7 FE 45            cp 'E'
 102+ 83D9 28 19          jr z, .errStart ; ERROR
 103+ 83DB FE 46            cp 'F'
 103+ 83DD 28 36          jr z, .failStart ; FAIL
 104+ 83DF 18 EF            jr checkOkErr
 105+ 83E1              .okStart
 106+ 83E1 CD CD 82         call Uart.read
 106+ 83E4 FE 4B          cp 'K'
 106+ 83E6 20 E8          jr nz, checkOkErr
 107+ 83E8 CD CD 82         call Uart.read
 107+ 83EB FE 0D          cp 13
 107+ 83ED 20 E1          jr nz, checkOkErr
 108+ 83EF CD 2F 84         call .flushToLF
 109+ 83F2 B7               or a
 110+ 83F3 C9               ret
 111+ 83F4              .errStart
 112+ 83F4 CD CD 82         call Uart.read
 112+ 83F7 FE 52          cp 'R'
 112+ 83F9 20 D5          jr nz, checkOkErr
 113+ 83FB CD CD 82         call Uart.read
 113+ 83FE FE 52          cp 'R'
 113+ 8400 20 CE          jr nz, checkOkErr
 114+ 8402 CD CD 82         call Uart.read
 114+ 8405 FE 4F          cp 'O'
 114+ 8407 20 C7          jr nz, checkOkErr
 115+ 8409 CD CD 82         call Uart.read
 115+ 840C FE 52          cp 'R'
 115+ 840E 20 C0          jr nz, checkOkErr
 116+ 8410 CD 2F 84         call .flushToLF
 117+ 8413 37               scf
 118+ 8414 C9               ret
 119+ 8415              .failStart
 120+ 8415 CD CD 82         call Uart.read
 120+ 8418 FE 41          cp 'A'
 120+ 841A 20 B4          jr nz, checkOkErr
 121+ 841C CD CD 82         call Uart.read
 121+ 841F FE 49          cp 'I'
 121+ 8421 20 AD          jr nz, checkOkErr
 122+ 8423 CD CD 82         call Uart.read
 122+ 8426 FE 4C          cp 'L'
 122+ 8428 20 A6          jr nz, checkOkErr
 123+ 842A CD 2F 84         call .flushToLF
 124+ 842D 37               scf
 125+ 842E C9               ret
 126+ 842F              .flushToLF
 127+ 842F CD CD 82         call Uart.read
 128+ 8432 FE 0A            cp 10
 128+ 8434 20 F9          jr nz, .flushToLF
 129+ 8436 C9               ret
 130+ 8437
 131+ 8437              ; Send buffer to UART
 132+ 8437              ; HL - buff
 133+ 8437              ; E - count
 134+ 8437              ; espSend:
 135+ 8437                  ; ld a, (hl) : call Uart.write
 136+ 8437                  ; inc hl
 137+ 8437                  ; dec e
 138+ 8437                  ; jr nz, espSend
 139+ 8437                  ; ret
 140+ 8437
 141+ 8437              ; Send buffer to UART
 142+ 8437              ; HL - buff (0 - end!)
 143+ 8437              espSendZ:
 144+ 8437 7E               ld a, (hl)
 145+ 8438 B7           	or a
 146+ 8439 C8           	ret z
 147+ 843A CD D9 82     	call Uart.write
 148+ 843D 23               inc hl
 149+ 843E 18 F7            jr espSendZ
 150+ 8440
 151+ 8440
 152+ 8440              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 153+ 8440              espSendT:
 154+ 8440 7E               ld a, (hl)
 155+ 8441
 156+ 8441 A7               and a
 156+ 8442 C8             ret z
 157+ 8443 FE 09            cp 9
 157+ 8445 C8             ret z
 158+ 8446 FE 0D            cp 13
 158+ 8448 C8             ret z
 159+ 8449 FE 0A            cp 10
 159+ 844B C8             ret z
 160+ 844C
 161+ 844C CD D9 82         call Uart.write
 162+ 844F 23               inc hl
 163+ 8450 18 EE            jr espSendT
 164+ 8452
 165+ 8452              ; HL - stringZ to send
 166+ 8452              ; Adds CR LF
 167+ 8452              ; tcpSendZ:
 168+ 8452                  ; push hl
 169+ 8452                  ; ;EspSend "AT+CIPSEND=" ;
 170+ 8452              	; ld hl,cmd_CIPSEND
 171+ 8452              	; call espSendZ
 172+ 8452              	; ; ld a,(link_id)
 173+ 8452              	; ; call Uart.write
 174+ 8452                  ; ;ld a, ',' : call Uart.write
 175+ 8452
 176+ 8452                  ; pop de : push de
 177+ 8452                  ; call strLen
 178+ 8452                  ; inc hl : inc hl ; +CRLF
 179+ 8452                  ; call hlToNumEsp
 180+ 8452                  ; ld a, 13 : call Uart.write
 181+ 8452                  ; ld a, 10 : call Uart.write
 182+ 8452                  ; call checkOkErr : jr c,.exit_err
 183+ 8452              ; .wait
 184+ 8452                  ; call Uart.read : cp '>' : jr nz, .wait
 185+ 8452                  ; pop hl
 186+ 8452              ; .loop
 187+ 8452                  ; ld a, (hl) : and a : jr z, .exit
 188+ 8452                  ; call Uart.write
 189+ 8452                  ; inc hl
 190+ 8452                  ; jp .loop
 191+ 8452              ; .exit
 192+ 8452                  ; ld a, 13 : call Uart.write
 193+ 8452                  ; ld a, 10 : call Uart.write
 194+ 8452                  ; jp checkOkErr
 195+ 8452              ; .exit_err
 196+ 8452              	; pop hl
 197+ 8452              	; ret
 198+ 8452
 199+ 8452
 200+ 8452
 201+ 8452              ; HL - string to send
 202+ 8452              ; DE - lenght
 203+ 8452              ; Adds CR LF
 204+ 8452              tcpSend:
 205+ 8452 E5               push hl
 206+ 8453 D5           	push de ;
 207+ 8454                  ;EspSend "AT+CIPSEND=" ;
 208+ 8454 21 74 85     	ld hl,cmd_CIPSEND
 209+ 8457 CD 37 84     	call espSendZ
 210+ 845A              	; ld a,(link_id)
 211+ 845A              	; call Uart.write
 212+ 845A                  ;ld a, ',' : call Uart.write
 213+ 845A
 214+ 845A E1               pop hl
 214+ 845B E5             push hl ;длина
 215+ 845C                  ;call strLen
 216+ 845C 23               inc hl
 216+ 845D 23             inc hl ; +CRLF
 217+ 845E CD 21 85         call hlToNumEsp
 218+ 8461 3E 0D            ld a, 13
 218+ 8463 CD D9 82       call Uart.write
 219+ 8466 3E 0A            ld a, 10
 219+ 8468 CD D9 82       call Uart.write
 220+ 846B CD D0 83         call checkOkErr
 220+ 846E 38 21          jr c,.exit_err2
 221+ 8470              .wait2
 222+ 8470 CD CD 82         call Uart.read
 222+ 8473 FE 3E          cp '>'
 222+ 8475 20 F9          jr nz, .wait2
 223+ 8477 D1           	pop de ;длина
 224+ 8478 E1               pop hl
 225+ 8479              .loop2
 226+ 8479 7E               ld a, (hl)
 227+ 847A CD D9 82         call Uart.write
 228+ 847D 23               inc hl
 229+ 847E 1B           	dec de
 230+ 847F 7A           	ld a,d
 231+ 8480 B3           	or e
 232+ 8481 C2 79 84         jp nz, .loop2
 233+ 8484              .exit2
 234+ 8484 3E 0D            ld a, 13
 234+ 8486 CD D9 82       call Uart.write
 235+ 8489 3E 0A            ld a, 10
 235+ 848B CD D9 82       call Uart.write
 236+ 848E C3 D0 83         jp checkOkErr
 237+ 8491              .exit_err2
 238+ 8491 D1           	pop de
 239+ 8492 E1           	pop hl
 240+ 8493 C9           	ret
 241+ 8494
 242+ 8494
 243+ 8494
 244+ 8494
 245+ 8494              getPacket:
 246+ 8494 CD CD 82         call Uart.read
 247+ 8497 FE 2B            cp '+'
 247+ 8499 28 28          jr z, .ipdBegun    ; "+IPD," packet
 248+ 849B FE 4F            cp 'O'
 248+ 849D 28 02          jr z, .closedBegun ; It enough to check "OSED\n" :-)
 249+ 849F 18 F3            jr getPacket
 250+ 84A1              .closedBegun
 251+ 84A1 CD CD 82         call Uart.read
 251+ 84A4 FE 53          cp 'S'
 251+ 84A6 20 EC          jr nz, getPacket
 252+ 84A8 CD CD 82         call Uart.read
 252+ 84AB FE 45          cp 'E'
 252+ 84AD 20 E5          jr nz, getPacket
 253+ 84AF CD CD 82         call Uart.read
 253+ 84B2 FE 44          cp 'D'
 253+ 84B4 20 DE          jr nz, getPacket
 254+ 84B6 CD CD 82         call Uart.read
 254+ 84B9 FE 0D          cp 13
 254+ 84BB 20 D7          jr nz, getPacket
 255+ 84BD 3E 01 32 EE      ld a, 1, (closed), a
 255+ 84C1 82
 256+ 84C2 C9               ret
 257+ 84C3              .ipdBegun
 258+ 84C3 CD CD 82         call Uart.read
 258+ 84C6 FE 49          cp 'I'
 258+ 84C8 20 CA          jr nz, getPacket
 259+ 84CA CD CD 82         call Uart.read
 259+ 84CD FE 50          cp 'P'
 259+ 84CF 20 C3          jr nz, getPacket
 260+ 84D1 CD CD 82         call Uart.read
 260+ 84D4 FE 44          cp 'D'
 260+ 84D6 20 BC          jr nz, getPacket
 261+ 84D8 CD CD 82         call Uart.read ; Comma
 262+ 84DB              	; call Uart.read ; link ID
 263+ 84DB              	; ld (link_id),a ;запомнить
 264+ 84DB              	;call Uart.read ; Comma
 265+ 84DB CD 08 85         call .count_ipd_lenght
 265+ 84DE 22 EA 82       ld (bytes_avail), hl
 266+ 84E1 44 4D            ld bc, hl
 267+ 84E3 2A EC 82         ld hl, (buffer_pointer)
 268+ 84E6              .readp
 269+ 84E6 7C               ld a, h
 269+ 84E7 FE 40          cp buffer_end
 269+ 84E9 30 12          jr nc, .skipbuff ;
 270+ 84EB C5 E5            push bc, hl
 271+ 84ED CD CD 82         call Uart.read
 272+ 84F0 E1 C1            pop hl, bc
 273+ 84F2 77               ld (hl), a
 274+ 84F3 0B               dec bc
 274+ 84F4 23             inc hl
 275+ 84F5 78               ld a, b
 275+ 84F6 B1             or c
 275+ 84F7 20 ED          jr nz, .readp
 276+ 84F9 22 EC 82         ld (buffer_pointer), hl
 277+ 84FC C9               ret
 278+ 84FD              .skipbuff
 279+ 84FD C5               push bc
 280+ 84FE CD CD 82         call Uart.read
 281+ 8501 C1               pop bc
 282+ 8502 0B               dec bc
 282+ 8503 78             ld a, b
 282+ 8504 B1             or c
 282+ 8505 20 F6          jr nz, .skipbuff
 283+ 8507 C9               ret
 284+ 8508              .count_ipd_lenght
 285+ 8508 21 00 00     		ld hl,0			; count lenght
 286+ 850B E5           .cil1	push  hl
 287+ 850C CD CD 82             call Uart.read
 288+ 850F E1                   pop hl
 289+ 8510 FE 3A        		cp ':'
 289+ 8512 C8             ret z
 290+ 8513 D6 30        		sub 0x30
 290+ 8515 4D             ld c,l
 290+ 8516 44             ld b,h
 290+ 8517 29             add hl,hl
 290+ 8518 29             add hl,hl
 290+ 8519 09             add hl,bc
 290+ 851A 29             add hl,hl
 290+ 851B 4F             ld c,a
 290+ 851C 06 00          ld b,0
 290+ 851E 09             add hl,bc
 291+ 851F 18 EA        		jr .cil1
 292+ 8521
 293+ 8521              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 294+ 8521              ; HL - number
 295+ 8521              ; It will be written to UART
 296+ 8521              hlToNumEsp:
 297+ 8521 01 F0 D8     	ld	bc,-10000
 298+ 8524 CD 3A 85     	call	.n1
 299+ 8527 01 18 FC     	ld	bc,-1000
 300+ 852A CD 3A 85     	call	.n1
 301+ 852D 01 9C FF     	ld	bc,-100
 302+ 8530 CD 3A 85     	call	.n1
 303+ 8533 0E F6        	ld	c,-10
 304+ 8535 CD 3A 85     	call	.n1
 305+ 8538 0E FF        	ld	c,-1
 306+ 853A 3E 2F        .n1	ld	a,'0'-1
 307+ 853C 3C           .n2	inc	a
 308+ 853D 09           	add	hl,bc
 309+ 853E 38 FC        	jr	c, .n2
 310+ 8540 ED 42        	sbc	hl,bc
 311+ 8542 C5               push bc
 312+ 8543 CD D9 82     	call Uart.write
 313+ 8546 C1               pop bc
 314+ 8547 C9               ret
 315+ 8548
 316+ 8548
 317+ 8548              ;команды
 318+ 8548 41 54 45 30  cmd_ATE0 db "ATE0",13,10,0 ;эхо?
 318+ 854C 0D 0A 00
 319+ 854F 41 54 2B 43  cmd_CIPSERVER db "AT+CIPSERVER=0",13,10,0 ;удалить сервер
 319+ 8553 49 50 53 45
 319+ 8557 52 56 45 52
 319+ 855B 3D 30 0D 0A
 319+ 855F 00
 320+ 8560 41 54 2B 43  cmd_CIPSTART db 'AT+CIPSTART="' ;продолжение
 320+ 8564 49 50 53 54
 320+ 8568 41 52 54 3D
 320+ 856C 22
 321+ 856D              	;тут тип
 322+ 856D 54 43 50 22  cmd_CIPSTART2 db 'TCP","',0 ;продолжение
 322+ 8571 2C 22 00
 323+ 8574 41 54 2B 43  cmd_CIPSEND db "AT+CIPSEND=",0 ;отправить данные
 323+ 8578 49 50 53 45
 323+ 857C 4E 44 3D 00
 324+ 8580              	;тут ID
 325+ 8580 41 54 2B 43  cmd_CIPCLOSE db "AT+CIPCLOSE",0 ;закрыть соединение
 325+ 8584 49 50 43 4C
 325+ 8588 4F 53 45 00
 326+ 858C              	;тут ID
 327+ 858C 41 54 2B 43  cmd_CIPMUX db "AT+CIPMUX=0",13,10,0 ; Single connection mode
 327+ 8590 49 50 4D 55
 327+ 8594 58 3D 30 0D
 327+ 8598 0A 00
 328+ 859A 41 54 2B 43  cmd_CIPDINFO db "AT+CIPDINFO=0",13,10,0 ; Disable additional info
 328+ 859E 49 50 44 49
 328+ 85A2 4E 46 4F 3D
 328+ 85A6 30 0D 0A 00
 329+ 85AA
 330+ 85AA                  ENDMODULE
# file closed: Drv/wifi.asm
 394  85AA              	include Drv/utils.asm ;работа с ESP
# file opened: Drv/utils.asm
   1+ 85AA              ;;; Macroses!!!!
   2+ 85AA                  ; MACRO EspSend Text
   3+ 85AA                  ; ld hl, .txtB
   4+ 85AA                  ; ld e, (.txtE - .txtB)
   5+ 85AA                  ; call espSend
   6+ 85AA                  ; jr .txtE
   7+ 85AA              ; .txtB
   8+ 85AA                  ; db Text
   9+ 85AA              ; .txtE
  10+ 85AA                  ; ENDM
  11+ 85AA
  12+ 85AA                  ; MACRO EspCmd Text
  13+ 85AA                  ; ld hl, .txtB
  14+ 85AA                  ; ld e, (.txtE - .txtB)
  15+ 85AA                  ; call espSend
  16+ 85AA                  ; jr .txtE
  17+ 85AA              ; .txtB
  18+ 85AA                  ; db Text
  19+ 85AA                  ; db 13, 10
  20+ 85AA              ; .txtE
  21+ 85AA                  ; ENDM
  22+ 85AA
  23+ 85AA                  ; MACRO EspCmdOkErr text
  24+ 85AA                  ; EspCmd text
  25+ 85AA                  ; call checkOkErr
  26+ 85AA                  ; ENDM
  27+ 85AA
  28+ 85AA              ; IN DE - string pointer
  29+ 85AA              ; OUT HL - string len
  30+ 85AA              strLen:
  31+ 85AA 21 00 00         ld hl, 0
  32+ 85AD              .loop
  33+ 85AD 1A               ld a, (de)
  33+ 85AE A7             and a
  33+ 85AF C8             ret z
  34+ 85B0 13 23            inc de, hl
  35+ 85B2 18 F9            jr .loop
# file closed: Drv/utils.asm
 395  85B4
 396  85B4              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 397  85B4              				;на входе в HL число
 398  85B4 11 10 27     			ld de,10000 ;десятки тысяч
 399  85B7 3E FF        			ld a,255
 400  85B9              toDecimal10k
 401  85B9 A7           			and a
 402  85BA ED 52        			sbc hl,de
 403  85BC 3C           			inc a
 404  85BD 30 FA        			jr nc,toDecimal10k
 405  85BF 19           			add hl,de
 406  85C0 C6 30        			add a,48
 407  85C2 32 0A 86     			ld (decimalS),a
 408  85C5 11 E8 03     			ld de,1000 ;тысячи
 409  85C8 3E FF        			ld a,255
 410  85CA              toDecimal1k
 411  85CA A7           			and a
 412  85CB ED 52        			sbc hl,de
 413  85CD 3C           			inc a
 414  85CE 30 FA        			jr nc,toDecimal1k
 415  85D0 19           			add hl,de
 416  85D1 C6 30        			add a,48
 417  85D3 32 0B 86     			ld (decimalS+1),a
 418  85D6 11 64 00     			ld de,100 ;сотни
 419  85D9 3E FF        			ld a,255
 420  85DB              toDecimal01k
 421  85DB A7           			and a
 422  85DC ED 52        			sbc hl,de
 423  85DE 3C           			inc a
 424  85DF 30 FA        			jr nc,toDecimal01k
 425  85E1 19           			add hl,de
 426  85E2 C6 30        			add a,48
 427  85E4 32 0C 86     			ld (decimalS+2),a
 428  85E7 11 0A 00     			ld de,10 ;десятки
 429  85EA 3E FF        			ld a,255
 430  85EC              toDecimal001k
 431  85EC A7           			and a
 432  85ED ED 52        			sbc hl,de
 433  85EF 3C           			inc a
 434  85F0 30 FA        			jr nc,toDecimal001k
 435  85F2 19           			add hl,de
 436  85F3 C6 30        			add a,48
 437  85F5 32 0D 86     			ld (decimalS+3),a
 438  85F8 11 01 00     			ld de,1 ;единицы
 439  85FB 3E FF        			ld a,255
 440  85FD              toDecimal0001k
 441  85FD A7           			and a
 442  85FE ED 52        			sbc hl,de
 443  8600 3C           			inc a
 444  8601 30 FA        			jr nc,toDecimal0001k
 445  8603 19           			add hl,de
 446  8604 C6 30        			add a,48
 447  8606 32 0E 86     			ld (decimalS+4),a
 448  8609
 449  8609 C9           			ret
 450  860A 00 00 00...  decimalS ds 6 ;здесь будет цифра
 451  8610
 452  8610              msg_processes
 453  8610 50 72 6F 63  	db "Processes: ",0
 453  8614 65 73 73 65
 453  8618 73 3A 20 00
 454  861C              msg_free_ram
 455  861C 46 72 65 65  	db "Free pages RAM: ",0
 455  8620 20 70 61 67
 455  8624 65 73 20 52
 455  8628 41 4D 3A 20
 455  862C 00
 456  862D              msg_esp_link
 457  862D 45 53 50 20  	db "ESP id: ",0
 457  8631 69 64 3A 20
 457  8635 00
 458  8636              msg_esp_transmit
 459  8636 54 72 6E 3A  	db "Trn: ",0
 459  863A 20 00
 460  863C              msg_esp_receive
 461  863C 52 63 76 3A  	db "Rcv: ",0
 461  8640 20 00
 462  8642              msg_esp_address
 463  8642 41 64 72 3A  	db "Adr: ",0
 463  8646 20 00
 464  8648              msg_press_num_to_close
 465  8648 50 72 65 73  	db "Press number process to close.",0
 465  864C 73 20 6E 75
 465  8650 6D 62 65 72
 465  8654 20 70 72 6F
 465  8658 63 65 73 73
 465  865C 20 74 6F 20
 465  8660 63 6C 6F 73
 465  8664 65 2E 00
 466  8667 41 63 74 69  msg_active db "Active ",0
 466  866B 76 65 20 00
 467  866F 7C 2F 2D 5C  msg_active1 db "|/-\\",0
 467  8673 00
 468  8674 00           msg_active_cur db 0 ;текущий значёк активности
 469  8675
 470  8675              end_sys
 471  8675              	;SAVETRD "OS.TRD",|"cmd.C",start_cmd,$-start_cmd
 472  8675              	savebin "sys.com",start_sys,$-start_sys
 473  8675              ;------------------------------------------------------------------------
 474  8675
 475  8675
 476  8675
 477  8675
 478  8675
 479  8675
 480  8675
 481  8675              ;ядро системы
 482  8675                  ;device ZXSPECTRUM128
 483  8675              	;include os_defs.asm ;список функций
 484  8675
 485  8675              	org #0000
 486  0000              	;bank 0
 487  0000              start_os_main
 488  0000
 489  0000 C3 01 C1     x0000	jp	InitProgramm + #c000		;+#C000 после запуска меняется
 490  0003 00 00 00...  	ds	#08-3
 491  0008
 492  0008 18 31        x0008	jr	x003B			;обработка rst 8
 493  000A 00           	nop
 494  000B 00           x000B	nop
 495  000C 00           	nop
 496  000D 18 75        x000D	jr	ExitMon
 497  000F 00           	ds	#01
 498  0010
 499  0010 C3 16 08     x0010	jp	drvgmx.putC  ;PrnSym_Rst10		;печать одного символа
 500  0013
 501  0013 ED 79        x0013	out	(c),a
 502  0015 00           	nop
 503  0016 00 00        	ds	#02
 504  0018
 505  0018 00 00 00...  x0018	ds	#08
 506  0020
 507  0020 C3 83 05     x0020	jp function  ;rst #20
 508  0023 00 00 00...  		ds	#05 ;#08
 509  0028
 510  0028 00 00 00...  x0028	ds	#08 ;rst #28
 511  0030
 512  0030 00 00 00     x0030	ds	#03 ;rst #30
 513  0033
 514  0033 ED 79        x0033	out	(c),a
 515  0035 00           	nop
 516  0036
 517  0036 00 1F        x0036	dw	font
 518  0038
 519  0038              ;обработчик прерываний
 520  0038 C3 00 06     x0038	jp	Interrupts
 521  003B
 522  003B              ;обработка RST 8
 523  003B F5           x003B	push	af
 524  003C ED 5F        	ld	a,r
 525  003E EA 43 00     	jp	pe,x0043
 526  0041 ED 5F        	ld	a,r
 527  0043 F5           x0043	push	af
 528  0044 3E 10        	ld	a,#10			;вход из ram 0
 529  0046 F5           	push	af
 530  0047 33           	inc	sp
 531  0048 C5           	push	bc
 532  0049 E5           	push	hl
 533  004A 01 00 00     	ld	bc,#0000
 534  004D 3E 02        	ld	a,#02
 535  004F ED 79        	out	(c),a
 536  0051 01 FD 7E     	ld	bc,#7EFD
 537  0054 ED 60        	in	h,(c)			;h=in #7EFD
 538  0056 06 7A        	ld	b,#7A
 539  0058 ED 68        	in	l,(c)			;l=in #7AFD
 540  005A 06 1F        	ld	b,#1F
 541  005C 3E 12        	ld	a,#12
 542  005E 18 B3        	jr	x0013
 543  0060 00 00 00...  	ds	#06			;=#0060
 544  0066
 545  0066              ;обработка NMI
 546  0066              ;
 547  0066 F5           x0066	push	af
 548  0067 ED 5F        	ld	a,r
 549  0069 F5           	push	af
 550  006A 3E 20        	ld	a,#20			;вход из ram 0
 551  006C F5           	push	af
 552  006D 33           	inc	sp
 553  006E C5           	push	bc
 554  006F E5           	push	hl
 555  0070 2A 01 C0     	ld	hl,(#C001)
 556  0073 E3           	ex	(sp),hl
 557  0074 3E 55        	ld	a,#55
 558  0076 32 01 C0     	ld	(#C001),a
 559  0079 2F           	cpl
 560  007A 32 02 C0     	ld	(#C001+1),a
 561  007D 01 FD 1F     	ld	bc,#1FFD
 562  0080 3E 12        	ld	a,#12
 563  0082 18 AF        	jr	x0033
 564  0084
 565  0084              ;возврат из монитора =#0084
 566  0084 ED 51        ExitMon	out	(c),d			;#1FFD
 567  0086 06 7F        	ld	b,#7F
 568  0088 ED 59        	out	(c),e			;#7FFD
 569  008A 01 00 00     	ld	bc,#0000
 570  008D ED 79        	out	(c),a
 571  008F D1           	pop	de
 572  0090 C1           	pop	bc
 573  0091 33           	inc	sp
 574  0092 F1           	pop	af
 575  0093 ED 4F        	ld	r,a
 576  0095 E2 9B 00     	jp	po,x009B
 577  0098 F1           	pop	af
 578  0099 FB           	ei
 579  009A C9           	ret
 580  009B F1           x009B	pop	af
 581  009C F3           	di
 582  009D C9           	ret
 583  009E
 584  009E              x009E
 585  009E              ; StartWord
 586  009E              	; ldir
 587  009E              	; call	onPageTXT
 588  009E              	; jp	MainLoopEdit
 589  009E              	; INSERT	"Info/!version.txt"
 590  009E              	; INSERT	"Info/!build.txt"
 591  009E              	; db	"GMX"
 592  009E 00 00 00...  y009E	ds	#00FF-$
 593  00FF
 594  00FF 38 00        x00FF	dw	x0038
 595  0101
 596  0101
 597  0101
 598  0101              ;Первый запуск
 599  0101              InitProgramm
 600  0101 F3           	di
 601  0102 31 00 41     	ld sp,#4100 ;временный адрес стека
 602  0105 3E 01        	ld a, #01 ;включить ОЗУ вместо ПЗУ
 603  0107 01 FD 1F         ld   bc,#1ffd
 604  010A ED 79        	out (c),a
 605  010C 21 15 01     	ld hl,Start_warm ;заменить адрес старта
 606  010F 22 01 00     	ld (#0001),hl
 607  0112 C3 00 00     	jp 0
 608  0115
 609  0115
 610  0115              ; rst #08: db #8F установка/удаление резидента из памяти
 611  0115              ; при "теплой" перезагрузке, если резидент установлен в странице, то эта страница
 612  0115                ; будет впечатана в 3е окно и управление передано по заданному адресу
 613  0115              ; вх:  a - номер страницы для установки резидента
 614  0115                      ; =#08 - удаление резидента
 615  0115                      ; 7,a =1 однократный вызов
 616  0115                   ; hl - адрес старта в странице
 617  0115              ; вых: cy=1 резидент не установлен
 618  0115              ; сначала копируем в эту страницу то что надо
 619  0115              ; и только потом вызываем функцию
 620  0115              ; для гмх страницу 8 и #78 задавать нельзя
 621  0115              ; перед повторной установкой резидента, вызывать функцию удаления не нужно
 622  0115
 623  0115              ;Старт системы
 624  0115              Start_warm
 625  0115              	;di
 626  0115 ED 56        	im 1
 627  0117
 628  0117              ;------------------------------------------------------------------------------
 629  0117              ;вызов функции #00(00) (SetRam0) установка работы со страницей ram 0 вместо rom, требуется для
 630  0117              ;корректного выхода из монитора, при ресете отключается
 631  0117              ;вх:  c=#00(00)
 632  0117              ;     cy=1 - установка
 633  0117              ;     cy=0 - отключение
 634  0117              ;вых: регистры не меняются
 635  0117              ;   R8CONF
 636  0117 0E 00        	ld	c,#00
 637  0119 37           	scf
 638  011A CF           	rst	#08
 639  011B 8E           	db	#8E
 640  011C              ;
 641  011C              	;ei
 642  011C              	;подготовить системный процесс
 643  011C 3E 01        	ld a,proc_id_system ;код системного процесса
 644  011E 32 14 27     	ld (proc_id_cur),a ;запомнить как текущий
 645  0121 32 05 27     	ld (proc_id_focus),a ;сразу в фокусе
 646  0124              	;ld (proc_run_prepar_id_tmp),a ;для правильного выделения памяти
 647  0124 32 11 27     	ld (proc_id_next),a ;для вычисления следующего процесса
 648  0127
 649  0127 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
 650  0129 32 0D 27     	ld (con_scr_cur),a
 651  012C 3E 79        	ld a,con_atr_real ;атрибуты реальные
 652  012E 32 0E 27     	ld (con_atr_cur),a
 653  0131 3E 39        	ld a,#39 ;видимый экран
 654  0133 32 04 27     	ld (scr_cur),a
 655  0136 CD 61 07     	call drvgmx.init
 656  0139
 657  0139              	;запустить системный процесс
 658  0139              ;proc_run_sys
 659  0139              ;запуск sys не с диска, а из состава ОС
 660  0139 21 15 27     	ld hl,proc_sys_name
 661  013C CD 9F 01     	call proc_run_prepar
 662  013F D8           	ret c
 663  0140
 664  0140              	;включить страницы
 665  0140              	;ld ix,(proc_run_prepar_deskr_tmp)
 666  0140 DD 7E 02     	ld a,(ix+2)
 667  0143 32 0C 27     	ld (page_slot2_cur),a ;сделать страницы текущими
 668  0146 CD E8 09     	call drvgmx.PageSlot2
 669  0149 DD 7E 03     	ld a,(ix+3)
 670  014C 32 0B 27     	ld (page_slot3_cur),a
 671  014F CD 07 09     	call drvgmx.PageSlot3
 672  0152              	;цвета
 673  0152 3E 07        	ld a,proc_color_def ;цвет
 674  0154 32 26 0A     	ld (drvgmx.attr_screen),a
 675  0157 DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
 676  015A              	;
 677  015A 3E 0C        	ld a,proc_color2_def ;цвет 2
 678  015C 32 27 0A     	ld (drvgmx.attr_screen2),a
 679  015F DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
 680  0162              	;перенести код
 681  0162 21 39 31     	ld hl,start_sys_incl
 682  0165 11 00 80     	ld de,PROGSTART
 683  0168 01 75 06     	ld bc,end_sys_incl-start_sys_incl
 684  016B ED B0        	ldir
 685  016D              	;подготовить правильный старт
 686  016D DD 6E 06     	ld l,(ix+6) ;стек нового процесса
 687  0170 DD 66 07     	ld h,(ix+7) ;стек
 688  0173 F9           	ld sp,hl
 689  0174
 690  0174 3E 01        	ld a,proc_id_system
 691  0176 DD 77 00     	ld (ix),a
 692  0179 C3 00 80     	jp PROGSTART ;старт сначала на заглушку
 693  017C
 694  017C
 695  017C
 696  017C
 697  017C              ;запуск теста
 698  017C
 699  017C
 700  017C              	; ld hl,proc_name_01		;строка с именем
 701  017C              	; call proc_run
 702  017C              	;jr c,loop_idle
 703  017C
 704  017C
 705  017C               	; ld hl,proc_name_02		;строка с именем
 706  017C              	; call proc_run
 707  017C
 708  017C               	; ld hl,proc_name_03		;строка с именем
 709  017C              	; call proc_run
 710  017C
 711  017C               	; ld hl,proc_name_02		;строка с именем
 712  017C              	; call proc_run
 713  017C
 714  017C               	; ld hl,proc_name_02		;строка с именем
 715  017C              	; call proc_run
 716  017C
 717  017C              	; ld a,3
 718  017C              	; call Dos.fclose
 719  017C
 720  017C              	; ld hl,proc_name_01		;строка с именем
 721  017C              	; call proc_run
 722  017C
 723  017C
 724  017C
 725  017C
 726  017C
 727  017C              loop_idle ;заглушка
 728  017C 18 FE        	jr loop_idle ;
 729  017E
 730  017E
 731  017E
 732  017E
 733  017E
 734  017E              proc_run_cmd
 735  017E              ; запуск cmd не с диска, а из состава ОС
 736  017E 21 21 27     	ld hl,proc_cmd_name
 737  0181 CD 9F 01     	call proc_run_prepar
 738  0184 D8           	ret c
 739  0185              	;включить страницы
 740  0185              	;ld ix,(proc_run_prepar_deskr_tmp)
 741  0185 DD 7E 02     	ld a,(ix+2)
 742  0188 CD E8 09     	call drvgmx.PageSlot2
 743  018B DD 7E 03     	ld a,(ix+3)
 744  018E CD 07 09     	call drvgmx.PageSlot3
 745  0191              	;перенести код
 746  0191 21 AE 37     	ld hl,start_cmd_incl
 747  0194 11 00 80     	ld de,PROGSTART
 748  0197 01 3E 00     	ld bc,end_cmd_incl-start_cmd_incl
 749  019A ED B0        	ldir
 750  019C
 751  019C C3 3A 03     	jp file_load_ok ;продолжить стандартно
 752  019F
 753  019F
 754  019F
 755  019F
 756  019F
 757  019F              proc_run_prepar
 758  019F              ;подготовка к запуску процесса
 759  019F              ;выделение памяти и прочее
 760  019F              ;вх: hl - имя процесса (файла) 8+3 символов
 761  019F              ;вых: a - номер процесса, IX - дескриптор
 762  019F
 763  019F 22 1E 02     	ld (proc_run_prepar_name_tmp),hl ;сохранить имя
 764  01A2              	;поиск свободного дескриптора
 765  01A2 21 00 28     	ld hl,proc_table
 766  01A5 11 00 01     	ld de,proc_descr_size
 767  01A8 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 768  01AA 0E 01        	ld c,proc_id_system ;первый номер
 769  01AC              proc_run_prepar_cl
 770  01AC 7E           	ld a,(hl)
 771  01AD B7           	or a ;свободен?
 772  01AE 28 0C        	jr z,proc_run_prepar_ok
 773  01B0 19           	add hl,de
 774  01B1 0C           	inc c
 775  01B2 10 F8        	djnz proc_run_prepar_cl
 776  01B4              	;не нашли свободного
 777  01B4 21 FA 30     	ld hl,msg_proc_max
 778  01B7 CD 0B 08     	call drvgmx.printZ ;сообщение
 779  01BA 37           	scf
 780  01BB C9           	ret
 781  01BC              proc_run_prepar_ok
 782  01BC              	;есть свободный
 783  01BC E5           	push hl
 784  01BD DD E1        	pop ix ;дискриптор процесса
 785  01BF 22 22 02     	ld (proc_run_prepar_deskr_tmp),hl
 786  01C2 79           	ld a,c ;присвоить номер
 787  01C3 32 20 02     	ld (proc_run_prepar_id_tmp),a
 788  01C6
 789  01C6
 790  01C6 3A 14 27     	ld a,(proc_id_cur)
 791  01C9 DD 77 01     	ld (ix+1),a ;код родительского
 792  01CC
 793  01CC              	;скопировать имя
 794  01CC 11 10 00     	ld de,16 ;
 795  01CF 19           	add hl,de
 796  01D0 EB           	ex de,hl
 797  01D1 2A 1E 02     	ld hl,(proc_run_prepar_name_tmp)
 798  01D4 01 0B 00     	ld bc,8+3
 799  01D7 ED B0        	ldir
 800  01D9
 801  01D9
 802  01D9              	;выделение памяти стандартное количество окон
 803  01D9 CD 24 02     	call proc_find_ram
 804  01DC 38 1D        	jr c,proc_run_prepar_no_mem
 805  01DE DD 77 02     	ld (ix+2),a ;страница 8000
 806  01E1 CD 24 02     	call proc_find_ram
 807  01E4 38 15        	jr c,proc_run_prepar_no_mem
 808  01E6 DD 77 03     	ld (ix+3),a ;страница c000
 809  01E9 CD 24 02     	call proc_find_ram
 810  01EC 38 0D        	jr c,proc_run_prepar_no_mem
 811  01EE DD 77 04     	ld (ix+4),a ;страница пиксели
 812  01F1 CD 24 02     	call proc_find_ram
 813  01F4 38 05        	jr c,proc_run_prepar_no_mem
 814  01F6 DD 77 05     	ld (ix+5),a ;страница атрибуты
 815  01F9
 816  01F9 18 0E        	jr proc_run_prepar_mem_ok
 817  01FB
 818  01FB              proc_run_prepar_no_mem
 819  01FB 3A 20 02     	ld a,(proc_run_prepar_id_tmp)
 820  01FE CD 3D 02     	call proc_clear_ram ;освободить память обратно
 821  0201
 822  0201 21 11 31     	ld hl,msg_mem_max
 823  0204 CD 0B 08     	call drvgmx.printZ ;сообщение
 824  0207 37           	scf
 825  0208 C9           	ret
 826  0209
 827  0209              proc_run_prepar_mem_ok ;памяти хватило
 828  0209
 829  0209              	;определить адрес стека
 830  0209 3A 20 02     	ld a,(proc_run_prepar_id_tmp) ;id
 831  020C 21 00 27     	ld hl,proc_table-256
 832  020F 84           	add h
 833  0210 67           	ld h,a
 834  0211 2E 80        	ld l,#80 ;на стек меньше 128 байт
 835  0213              	; ld hl,proc_stack
 836  0213              	; or a
 837  0213              	; jr z,proc_run_prepar_ex
 838  0213              	; ld b,a
 839  0213              	; ld de,proc_stack_size
 840  0213              ; proc_run_prepar_cl2 ;цикл
 841  0213              	; add hl,de
 842  0213              	; djnz proc_run_prepar_cl2
 843  0213              ;proc_run_prepar_ex
 844  0213 DD 75 06     	ld (ix+6),l ;адрес стека
 845  0216 DD 74 07     	ld (ix+7),h ;адрес стека
 846  0219              	; ld a,(proc_run_prepar_id_tmp) ;id
 847  0219              	; ld (ix+0),a
 848  0219 3A 20 02     	ld a,(proc_run_prepar_id_tmp) ;id
 849  021C B7           	or a
 850  021D C9           	ret
 851  021E
 852  021E 00 00        proc_run_prepar_name_tmp dw 0 ;временно имя нового процесса
 853  0220 00           proc_run_prepar_id_tmp db 0 ;временно id нового процесса
 854  0221 00           proc_run_file_id_tmp db 0 ;временно id файла
 855  0222 00 00        proc_run_prepar_deskr_tmp dw 0 ;временно дескриптор процесса
 856  0224
 857  0224              proc_find_ram	;поиск свободной страницы памяти
 858  0224              ;вых: a - номер страницы, также записан id процесса в таблицу proc_page_table
 859  0224 11 68 09     	ld de,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
 860  0227 21 00 30     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 861  022A 06 6D        	ld b,page_max
 862  022C              proc_find_ram_cl
 863  022C AF           	xor a
 864  022D B6           	or (hl)
 865  022E 28 06        	jr z,proc_find_ram_ok1 ;нашли
 866  0230              	;ищем дальше
 867  0230 23           	inc hl
 868  0231 13           	inc de
 869  0232 10 F8        	djnz proc_find_ram_cl
 870  0234              	;совсем не нашли
 871  0234 37           	scf
 872  0235 C9           	ret
 873  0236              proc_find_ram_ok1
 874  0236 3A 20 02     	ld a,(proc_run_prepar_id_tmp)
 875  0239 77           	ld (hl),a ;записать id процесса в таблицу
 876  023A 1A           	ld a,(de) ;вернуть номер страницы
 877  023B B7           	or a
 878  023C C9           	ret
 879  023D
 880  023D
 881  023D              proc_clear_ram ;освбождение всех страниц памяти процесса
 882  023D              ;вх: a - номер процесса
 883  023D 21 00 30     	ld hl,proc_page_table
 884  0240 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
 885  0242              proc_clear_ram_cl ;
 886  0242 BE           	cp (hl) ;совпадает с номером процесса?
 887  0243 20 02        	jr nz,proc_clear1
 888  0245 36 00        	ld (hl),0 ;освободить
 889  0247              proc_clear1
 890  0247 23           	inc hl
 891  0248 10 F8        	djnz proc_clear_ram_cl
 892  024A B7           	or a
 893  024B C9           	ret
 894  024C
 895  024C
 896  024C
 897  024C              proc_focus_next
 898  024C              	;переключение фокуса на следующий процесс
 899  024C 3A 05 27     	ld a,(proc_id_focus)
 900  024F CD 43 07     	call proc_next_skip
 901  0252              	;ret c ;выернуться если один процесс
 902  0252              	;или сменить фокус, код ниже
 903  0252
 904  0252
 905  0252              proc_set_focus ;получение фокуса процессом
 906  0252              ;вх: a - id процесса
 907  0252 21 05 27     	ld hl,proc_id_focus
 908  0255 BE           	cp (hl)
 909  0256 C8           	ret z ;если уже в фокусе, ничего не делаем
 910  0257 32 DC 02     	ld (proc_set_focus_id_tmp),a ;сохранить
 911  025A
 912  025A 21 00 27     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
 913  025D 84           	add h
 914  025E 67           	ld h,a
 915  025F AF           	xor a
 916  0260 B6           	or (hl)
 917  0261 C8           	ret z
 918  0262
 919  0262
 920  0262              	;сохранить в буфер процесса текущий экран
 921  0262 3A 05 27     	ld a,(proc_id_focus) ;текущий в фокусе
 922  0265 21 00 27     	ld hl,proc_table - 256
 923  0268 84           	add h
 924  0269 67           	ld h,a
 925  026A E5           	push hl
 926  026B DD E1        	pop ix ;дескриптор процесса предыдущего
 927  026D
 928  026D DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
 929  0270 CD 07 09     	call drvgmx.PageSlot3
 930  0273 3E 39        	ld a,con_scr_real ;настоящий экран
 931  0275 CD E8 09     	call drvgmx.PageSlot2
 932  0278 21 00 80     	ld hl,#8000 ;скопировать
 933  027B 11 00 C0     	ld de,#c000
 934  027E 01 00 40     	ld bc,#4000
 935  0281 ED B0        	ldir
 936  0283
 937  0283 DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
 938  0286 CD 07 09     	call drvgmx.PageSlot3
 939  0289 3E 79        	ld a,con_atr_real
 940  028B CD E8 09     	call drvgmx.PageSlot2
 941  028E 21 00 80     	ld hl,#8000 ;скопировать
 942  0291 11 00 C0     	ld de,#c000
 943  0294 01 00 40     	ld bc,#4000
 944  0297 ED B0        	ldir
 945  0299
 946  0299              	;сохранить позицию скрола
 947  0299              	;ld hl,(drvgmx.curscrl)
 948  0299              	;ld (ix+#08),hl ;позиция скрола
 949  0299
 950  0299
 951  0299              	;вернуть из буфера экран нужного процесса
 952  0299 3A DC 02     	ld a,(proc_set_focus_id_tmp)
 953  029C 21 00 27     	ld hl,proc_table - 256
 954  029F 84           	add h
 955  02A0 67           	ld h,a
 956  02A1 E5           	push hl
 957  02A2 DD E1        	pop ix ;дескриптор процесса который будет в фокусе
 958  02A4
 959  02A4 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
 960  02A7 CD 07 09     	call drvgmx.PageSlot3
 961  02AA 3E 39        	ld a,con_scr_real ;настоящий экран
 962  02AC CD E8 09     	call drvgmx.PageSlot2
 963  02AF 21 00 C0     	ld hl,#c000 ;скопировать
 964  02B2 11 00 80     	ld de,#8000
 965  02B5 01 00 40     	ld bc,#4000
 966  02B8 ED B0        	ldir
 967  02BA
 968  02BA DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
 969  02BD CD 07 09     	call drvgmx.PageSlot3
 970  02C0 3E 79        	ld a,con_atr_real
 971  02C2 CD E8 09     	call drvgmx.PageSlot2
 972  02C5 21 00 C0     	ld hl,#c000 ;скопировать
 973  02C8 11 00 80     	ld de,#8000
 974  02CB 01 00 40     	ld bc,#4000
 975  02CE ED B0        	ldir
 976  02D0
 977  02D0 CD DD 02     	call page_cur_return
 978  02D3
 979  02D3
 980  02D3 3A DC 02     	ld a,(proc_set_focus_id_tmp)
 981  02D6              	;запомнить активный процесс
 982  02D6 32 05 27     	ld (proc_id_focus),a
 983  02D9
 984  02D9              	;ld hl,(ix+#08) ;позиция скрола
 985  02D9              	;ld (drvgmx.curscrl),hl
 986  02D9              	;call drvgmx.gmxscroll ;обновить скролл
 987  02D9 C3 00 06     	jp Interrupts ;сразу на другой процесс
 988  02DC              	;or a
 989  02DC              	;ret
 990  02DC 00           proc_set_focus_id_tmp db 0 ; временно
 991  02DD
 992  02DD
 993  02DD
 994  02DD              page_cur_return
 995  02DD              ;вернуть текущие страницы
 996  02DD 3A 0C 27     	ld a,(page_slot2_cur)
 997  02E0 CD E8 09     	call drvgmx.PageSlot2
 998  02E3 3A 0B 27     	ld a,(page_slot3_cur)
 999  02E6 CD 07 09     	call drvgmx.PageSlot3
1000  02E9 C9           	ret
1001  02EA
1002  02EA
1003  02EA              proc_run
1004  02EA              ;запуск процесса
1005  02EA              ;вх: hl - имя файла
1006  02EA CD 9F 01     	call proc_run_prepar ;выделить память
1007  02ED D8           	ret c
1008  02EE
1009  02EE 2A 1E 02     	ld hl,(proc_run_prepar_name_tmp) ;имя
1010  02F1              	;ld b,Dos.FMODE_READ
1011  02F1 CD 7B 0A     	call Dos.fopen_r ;откроем файл для чтения
1012  02F4 DC CA 0B     	call c,Dos.file_error_print_file_open_error
1013  02F7 DA BB 03     	jp c,file_load_err
1014  02FA 32 21 02     	ld (proc_run_file_id_tmp),a ;запомнить id
1015  02FD
1016  02FD              	;проверка длины файла не больше #8000
1017  02FD 7A           	ld	a,d ;самые старшие байты длины
1018  02FE B3           	or e
1019  02FF 28 09        	jr z,file_size_ok ;если не слищком большой
1020  0301              file_too_big
1021  0301 21 6D 0D     	ld hl,Dos.msg_file_too_big
1022  0304 CD 0B 08     	call drvgmx.printZ
1023  0307 C3 BB 03     	jp file_load_err
1024  030A
1025  030A
1026  030A              file_size_ok
1027  030A 78           	ld	a,b ;младший старший байт длины
1028  030B FE 81        	cp proc_size_max+1
1029  030D 30 F2        	jr nc,file_too_big
1030  030F              	;размер нормальный, прочитаем
1031  030F              	; halt
1032  030F              	; halt
1033  030F              ; WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
1034  030F
1035  030F              	;включить страницы
1036  030F DD 2A 22 02  	ld ix,(proc_run_prepar_deskr_tmp)
1037  0313 DD 7E 02     	ld a,(ix+2)
1038  0316 CD E8 09     	call drvgmx.PageSlot2
1039  0319 DD 7E 03     	ld a,(ix+3)
1040  031C CD 07 09     	call drvgmx.PageSlot3
1041  031F
1042  031F 21 00 80     	ld hl,PROGSTART
1043  0322 3A 21 02     	ld a,(proc_run_file_id_tmp)
1044  0325 50           	ld d,b ;размер
1045  0326 59           	ld e,c
1046  0327 CD FD 0B     	call Dos.fread
1047  032A 30 08        	jr nc,file_size_ok2
1048  032C              	;если ошибка вернуть страницы
1049  032C CD D2 0B     	call Dos.file_error_print_file_read_error
1050  032F CD DD 02     	call page_cur_return
1051  0332 37           	scf
1052  0333 C9           	ret
1053  0334              file_size_ok2
1054  0334 3A 21 02     	ld a,(proc_run_file_id_tmp)
1055  0337 CD DA 0B     	call Dos.fclose
1056  033A              	;jr file_load_ok
1057  033A
1058  033A
1059  033A              file_load_ok ;загрузился нормально
1060  033A DD 2A 22 02  	ld ix,(proc_run_prepar_deskr_tmp) ;вспомнить дескриптор
1061  033E              	;очистить экран
1062  033E              	;сначала запомнить как было
1063  033E 2A 26 0A     	ld hl,(drvgmx.attr_screen)
1064  0341 22 BD 03     	ld (proc_run_attr_screen_tmp),hl
1065  0344              	; запомнить координаты экрана предыдущего
1066  0344 2A 24 0A     	ld hl,(drvgmx.col_screen)
1067  0347 22 C1 03     	ld (proc_run_col_screen_tmp),hl ;координаты
1068  034A              	;страницы буфера
1069  034A 3A 0D 27     	ld a,(con_scr_cur)
1070  034D 32 BF 03     	ld (proc_run_con_scr_cur_tmp),a
1071  0350 3A 0E 27     	ld a,(con_atr_cur)
1072  0353 32 C0 03     	ld (proc_run_con_atr_cur_tmp),a
1073  0356              	;скрола
1074  0356 2A F8 08     	ld hl,(drvgmx.curscrl)
1075  0359 22 C3 03     	ld (proc_run_curscrl_tmp),hl
1076  035C
1077  035C
1078  035C
1079  035C              	;чистить буфер экрана
1080  035C 3E 07        	ld a,proc_color_def ;цвет
1081  035E 32 26 0A     	ld (drvgmx.attr_screen),a
1082  0361 DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1083  0364              	;
1084  0364 3E 0C        	ld a,proc_color2_def ;цвет 2
1085  0366 32 27 0A     	ld (drvgmx.attr_screen2),a
1086  0369 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1087  036C              	;
1088  036C DD 7E 04     	ld a,(ix+4)
1089  036F 32 0D 27     	ld (con_scr_cur),a
1090  0372 DD 7E 05     	ld a,(ix+5)
1091  0375 32 0E 27     	ld (con_atr_cur),a
1092  0378 CD 64 07     	call drvgmx.cls
1093  037B              	;вернуть
1094  037B 2A BD 03     	ld hl,(proc_run_attr_screen_tmp)
1095  037E 22 26 0A     	ld (drvgmx.attr_screen),hl
1096  0381 2A C1 03     	ld hl,(proc_run_col_screen_tmp) ;координаты
1097  0384 22 24 0A     	ld (drvgmx.col_screen),hl
1098  0387 3A BF 03     	ld a,(proc_run_con_scr_cur_tmp)
1099  038A 32 0D 27     	ld (con_scr_cur),a
1100  038D 3A C0 03     	ld a,(proc_run_con_atr_cur_tmp)
1101  0390 32 0E 27     	ld (con_atr_cur),a
1102  0393 2A C3 03     	ld hl,(proc_run_curscrl_tmp)
1103  0396 22 F8 08     	ld (drvgmx.curscrl),hl
1104  0399
1105  0399
1106  0399
1107  0399
1108  0399              	;подготовить правильный старт
1109  0399 DD 6E 06     	ld l,(ix+6) ;адрес стека
1110  039C DD 66 07     	ld h,(ix+7) ;адрес стека
1111  039F 01 00 80     	ld bc,PROGSTART ;возврат сюда
1112  03A2 2B           	dec hl
1113  03A3 70           	ld (hl),b
1114  03A4 2B           	dec hl
1115  03A5 71           	ld (hl),c
1116  03A6 01 EC FF     	ld bc,-20 ;возврат будет с восстановлением регистров
1117  03A9 09           	add hl,bc
1118  03AA
1119  03AA DD 75 06     	ld (ix+6),l ;адрес стека
1120  03AD DD 74 07     	ld (ix+7),h ;адрес стека
1121  03B0 3A 20 02     	ld a,(proc_run_prepar_id_tmp)
1122  03B3 DD 77 00     	ld (ix),a ;в последнюю очередь код (флаг что процесс работает)
1123  03B6
1124  03B6 CD DD 02     	call page_cur_return
1125  03B9 B7           	or a
1126  03BA C9           	ret
1127  03BB
1128  03BB
1129  03BB              file_load_err
1130  03BB 37           	scf
1131  03BC C9           	ret
1132  03BD
1133  03BD 00 00        proc_run_attr_screen_tmp dw 0 ;временно
1134  03BF 00           proc_run_con_scr_cur_tmp db 0 ;временно
1135  03C0 00           proc_run_con_atr_cur_tmp db 0 ;временно
1136  03C1 00 00        proc_run_col_screen_tmp dw 0 ;временно
1137  03C3 00 00        proc_run_curscrl_tmp dw 0 ;временно
1138  03C5
1139  03C5
1140  03C5
1141  03C5
1142  03C5
1143  03C5
1144  03C5
1145  03C5
1146  03C5              get_c ;функция получение кода нажатой клавиши
1147  03C5              	;вых: a - код последней клавиши, 255 - ничего не нажато
1148  03C5 3A 14 27     	ld a,(proc_id_cur) ;сравнить если процесс в фокусе
1149  03C8 21 05 27     	ld hl,proc_id_focus
1150  03CB BE           	cp (hl)
1151  03CC 3E FF        	ld a,255 ;ничего не нажато если не в фокусе
1152  03CE C0           	ret nz
1153  03CF 3A 0F 27     	ld a,(key_cur) ;или вернуть клавишу
1154  03D2 F5           	push af
1155  03D3 3E FF        	ld a,255
1156  03D5 32 0F 27     	ld (key_cur),a ;очистить буфер
1157  03D8 F1           	pop af
1158  03D9 C9           	ret
1159  03DA
1160  03DA              get_timer ;функция получить значение системного таймера
1161  03DA ED 5B 2D 27  	ld de,(sys_timer) ;младшие байты
1162  03DE 2A 2F 27     	ld hl,(sys_timer+2)
1163  03E1 C9           	ret
1164  03E2
1165  03E2
1166  03E2
1167  03E2              page_copy ;скопировать страницу в страницу
1168  03E2              ;скопировать данные из страницы в страницу
1169  03E2              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
1170  03E2 ED 43 18 04  	ld (page_copy_tmp),bc
1171  03E6 32 18 04     	ld (page_copy_tmp),a
1172  03E9 D9           	exx
1173  03EA CD 1A 04     	call page_check_owner 	;проверка разрешений
1174  03ED D8           	ret c
1175  03EE 3A 19 04     	ld a,(page_copy_tmp+1)
1176  03F1 CD 1A 04     	call page_check_owner 	;проверка разрешений
1177  03F4 D8           	ret c
1178  03F5 DD 7C        	ld a,ixh ;не больше размера страницы
1179  03F7 FE 41        	cp #41
1180  03F9 30 1B        	jr nc,page_copy_err
1181  03FB DD B5        	or ixl
1182  03FD 28 17        	jr z,page_copy_err ;и не 0 длина
1183  03FF 3A 18 04     	ld a,(page_copy_tmp)
1184  0402 CD E8 09     	call drvgmx.PageSlot2
1185  0405 3A 19 04     	ld a,(page_copy_tmp+1)
1186  0408 CD 07 09     	call drvgmx.PageSlot3
1187  040B D9           	exx ;вспомнить регистры
1188  040C              	 ;скопировать
1189  040C DD E5        	push ix
1190  040E C1           	pop bc ;длина
1191  040F ED B0        	ldir
1192  0411 CD DD 02     	call page_cur_return ;вернуть страницы
1193  0414 AF           	xor a
1194  0415 C9           	ret
1195  0416              page_copy_err
1196  0416 37           	scf
1197  0417 C9           	ret
1198  0418
1199  0418
1200  0418 00 00        page_copy_tmp dw 0 ;временно
1201  041A
1202  041A              page_check_owner ;проверить разрешена ли страница для процесса
1203  041A FE 05        	cp #05 ;видео страница
1204  041C C8           	ret z
1205  041D FE 07        	cp #07 ;видео страница
1206  041F C8           	ret z
1207  0420 FE 39        	cp #39 ;видео страница
1208  0422 C8           	ret z
1209  0423 FE 3A        	cp #3a ;видео страница
1210  0425 C8           	ret z
1211  0426 32 4A 04     	ld (page_check_owner_tmp),a
1212  0429 21 68 09     	ld hl,drvgmx.page_table ;таблица памяти
1213  042C 06 6D        	ld b,page_max ;всего страниц
1214  042E 0E 00        	ld c,0 ;индекс
1215  0430              page_check_owner_cl ;найти такую страницу
1216  0430 BE           	cp (hl)
1217  0431 28 06        	jr z,page_check_owner_ex
1218  0433 0C           	inc c
1219  0434 23           	inc hl
1220  0435 10 F9        	djnz page_check_owner_cl
1221  0437 37           	scf ;не нашли в списке страниц
1222  0438 C9           	ret
1223  0439              page_check_owner_ex
1224  0439              	;нашли
1225  0439 06 00        	ld b,0
1226  043B 21 00 30     	ld hl,proc_page_table ;сверить с кодом текущего процесса
1227  043E 09           	add hl,bc
1228  043F 3A 14 27     	ld a,(proc_id_cur)
1229  0442 BE           	cp (hl)
1230  0443 37           	scf ;не совпадает владелец с процессом
1231  0444 3A 4A 04     	ld a,(page_check_owner_tmp)
1232  0447 C0           	ret nz
1233  0448 B7           	or a
1234  0449 C9           	ret
1235  044A 00           page_check_owner_tmp db 0 ;временно
1236  044B
1237  044B
1238  044B              set_VTPL_PLAY ;запустить плеер AY. будет играть на прерываниях
1239  044B 3A 0C 27     	ld a,(page_slot2_cur)
1240  044E 32 02 27     	ld (proc_play_ay_slot2),a ;запомнить страницы с музыкой
1241  0451 3A 0B 27     	ld a,(page_slot3_cur)
1242  0454 32 03 27     	ld (proc_play_ay_slot3),a
1243  0457 3A 14 27     	ld a,(proc_id_cur) ;код процесса, который играет музыку
1244  045A 32 01 27     	ld (proc_play_ay),a
1245  045D C9           	ret
1246  045E
1247  045E              set_VTPL_MUTE ;остановить плеер AY
1248  045E AF           	xor a
1249  045F 32 01 27     	ld (proc_play_ay),a
1250  0462 C3 2C 13     	jp VTPL.MUTE
1251  0465
1252  0465
1253  0465              get_VTPL_SETUP ;получить адрес переменной плеера
1254  0465 21 07 13     	ld hl,VTPL.SETUP
1255  0468 C9           	ret
1256  0469
1257  0469
1258  0469              get_proc_page ;получить номера страниц процесса
1259  0469              	;вых: BC - страницы в слоте 2, 3
1260  0469 3A 0C 27     	ld a,(page_slot2_cur)
1261  046C 47           	ld b,a
1262  046D 3A 0B 27     	ld a,(page_slot3_cur)
1263  0470 4F           	ld c,a
1264  0471 C9           	ret
1265  0472
1266  0472
1267  0472              set_scr ;установить активный экран
1268  0472 FE 05        	cp #05
1269  0474 CA 30 09     	jp z,drvgmx.set_scr5
1270  0477 FE 07        	cp #07
1271  0479 CA 3E 09     	jp z,drvgmx.set_scr7
1272  047C FE 39        	cp #39
1273  047E CA 4C 09     	jp z,drvgmx.set_scr39
1274  0481 FE 3A        	cp #3a
1275  0483 CA 5A 09     	jp z,drvgmx.set_scr3a
1276  0486 37           	scf
1277  0487 C9           	ret
1278  0488
1279  0488              set_page_slot2	;включить страницу в слот 2 (#8000);
1280  0488 CD 1A 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1281  048B D8           	ret c
1282  048C 08           	ex af,af'
1283  048D 3A 14 27     	ld a,(proc_id_cur)
1284  0490 21 00 27     	ld hl,proc_table - 256
1285  0493 84           	add h
1286  0494 67           	ld h,a
1287  0495 E5           	push hl
1288  0496 DD E1        	pop ix ;дескриптор
1289  0498 08           	ex af,af'
1290  0499 DD 77 02     	ld (ix+#02),a ;запомнить текущую страницу процесса
1291  049C C3 E8 09     	jp drvgmx.PageSlot2 ;включить
1292  049F
1293  049F
1294  049F              set_page_slot3	;включить страницу в слот 2 (#8000);
1295  049F CD 1A 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1296  04A2 D8           	ret c
1297  04A3 08           	ex af,af'
1298  04A4 3A 14 27     	ld a,(proc_id_cur)
1299  04A7 21 00 27     	ld hl,proc_table - 256
1300  04AA 84           	add h
1301  04AB 67           	ld h,a
1302  04AC E5           	push hl
1303  04AD DD E1        	pop ix ;дескриптор
1304  04AF 08           	ex af,af'
1305  04B0 DD 77 03     	ld (ix+#03),a ;запомнить текущую страницу процесса
1306  04B3 C3 07 09     	jp drvgmx.PageSlot3
1307  04B6
1308  04B6
1309  04B6
1310  04B6              set_interrupt ;установка адреса обработчика прерываний процесса;
1311  04B6 EB           	ex de,hl
1312  04B7 3A 14 27     	ld a,(proc_id_cur)
1313  04BA 21 00 27     	ld hl,proc_table - 256
1314  04BD 84           	add h
1315  04BE 67           	ld h,a
1316  04BF E5           	push hl
1317  04C0 DD E1        	pop ix ;дескриптор
1318  04C2 EB           	ex de,hl
1319  04C3 DD 75 0E     	ld (ix+#0e),l ;адрес
1320  04C6 DD 74 0F     	ld (ix+#0f),h ;адрес
1321  04C9 C9           	ret
1322  04CA
1323  04CA
1324  04CA
1325  04CA
1326  04CA              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; hl - строка адрес, de - строка порт
1327  04CA              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1328  04CA              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто);
1329  04CA              esp_open ;установить соединение ESP (CIPSTART);
1330  04CA DD 21 80 30  	ld ix,esp_link_id_table
1331  04CE 08           	ex af,af'
1332  04CF 3A 00 27     	ld a,(uart_enable)
1333  04D2 B7           	or a
1334  04D3 28 28        	jr z,esp_open_err ;нет порта
1335  04D5 DD 7E 00     	ld a,(ix)
1336  04D8 B7           	or a
1337  04D9 20 22        	jr nz,esp_open_err ;выйти если буфер занят
1338  04DB 08           	ex af,af'
1339  04DC DD 77 0E     	ld (ix+14),a ;тип
1340  04DF D5           	push de ;сохранить порт
1341  04E0 11 8F 30     	ld de,esp_link_id_table+15 ;на имя сервера
1342  04E3 CD 77 05     	call copyZ ;скопировать
1343  04E6 11 BB 30     	ld de,esp_link_id_table+59 ;тут адрес порта
1344  04E9 E1           	pop hl
1345  04EA CD 77 05     	call copyZ
1346  04ED 3A 14 27     	ld a,(proc_id_cur)
1347  04F0 DD 77 00     	ld (ix),a ;флаг занято
1348  04F3 DD 36 02 00  	ld (ix+2),0 ;флаг результат открытия
1349  04F7 DD 36 01 01  	ld (ix+1),1 ;флаг запрос на открытие
1350  04FB AF           	xor a
1351  04FC C9           	ret
1352  04FD
1353  04FD              esp_open_err
1354  04FD 3E FF        	ld a,255
1355  04FF 37           	scf
1356  0500 C9           	ret
1357  0501
1358  0501
1359  0501
1360  0501              ;вх:
1361  0501              ;вых: CY=0 - OK; CY=1 - занято другим процессом
1362  0501              esp_close ;закрыть соединение ESP
1363  0501 DD 21 80 30  	ld ix,esp_link_id_table
1364  0505 3A 14 27     	ld a,(proc_id_cur) ;проверить кто владелец соединения
1365  0508 DD BE 00     	cp (ix)
1366  050B 37           	scf
1367  050C C0           	ret nz ;выйти если чужое
1368  050D AF           	xor a
1369  050E DD 77 00     	ld (ix),a ;закрыть
1370  0511 C9           	ret
1371  0512
1372  0512
1373  0512
1374  0512
1375  0512              ;вх: hl - адрес данных, de - длина данных
1376  0512              ;вых: CY=0 - OK; CY=1 - занято другим процессом
1377  0512              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено)
1378  0512              esp_send ;послать запрос ESP (CIPSEND);
1379  0512 DD 21 80 30  	ld ix,esp_link_id_table
1380  0516 3A 14 27     	ld a,(proc_id_cur) ;проверить кто владелец соединения
1381  0519 DD BE 00     	cp (ix)
1382  051C 20 17        	jr nz,esp_send_err ;выйти если буфер занят другим
1383  051E D5           	push de ; длина
1384  051F C1           	pop bc
1385  0520 DD 73 09     	ld (ix+9),e  ;длина
1386  0523 DD 72 0A     	ld (ix+10),d
1387  0526 11 24 3A     	ld de,esp_buffer ;перенести данные в буфер отправки
1388  0529 ED B0        	ldir
1389  052B
1390  052B DD 36 04 00  	ld (ix+4),0 ;флаг результат отправки
1391  052F DD 36 03 01  	ld (ix+3),1 ;флаг запрос отправки
1392  0533 AF           	xor a
1393  0534 C9           	ret
1394  0535
1395  0535              esp_send_err
1396  0535 3E FF        	ld a,255
1397  0537 37           	scf
1398  0538 C9           	ret
1399  0539
1400  0539
1401  0539
1402  0539
1403  0539              ;вх: hl - адрес для данных
1404  0539              ;вых: CY=0 - OK; CY=1 - занято другим процессом
1405  0539              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято)
1406  0539              esp_get ;получить пакет ESP (+IPD);
1407  0539 DD 21 80 30  	ld ix,esp_link_id_table
1408  053D 3A 14 27     	ld a,(proc_id_cur) ;проверить кто владелец соединения
1409  0540 DD BE 00     	cp (ix)
1410  0543 20 10        	jr nz,esp_get_err ;выйти если буфер занят другим
1411  0545 DD 75 07     	ld (ix+7),l ;адрес данных
1412  0548 DD 74 08     	ld (ix+8),h ;адрес данных
1413  054B DD 36 06 00  	ld (ix+6),0 ;флаг результат приёма
1414  054F DD 36 05 01  	ld (ix+5),1 ;флаг запрос на приём
1415  0553 AF           	xor a
1416  0554 C9           	ret
1417  0555
1418  0555              esp_get_err
1419  0555 3E FF        	ld a,255
1420  0557 37           	scf
1421  0558 C9           	ret
1422  0559
1423  0559
1424  0559              ;вх: a - id процесса куда копировать, hl - откуда, de - куда, bc - длина
1425  0559              esp_buffer_copy ;скопировать принятое из буфера ESP
1426  0559 D9           	exx
1427  055A 21 00 27     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1428  055D 84           	add h
1429  055E 67           	ld h,a
1430  055F AF           	xor a
1431  0560 B6           	or (hl)
1432  0561 C8           	ret z
1433  0562
1434  0562 E5           	push hl
1435  0563 DD E1        	pop ix ;дескриптор процесса
1436  0565              	;включить страницы целевого процесса
1437  0565 DD 7E 02     	ld a,(ix+2)
1438  0568 CD E8 09     	call drvgmx.PageSlot2
1439  056B DD 7E 03     	ld a,(ix+3)
1440  056E CD 07 09     	call drvgmx.PageSlot3
1441  0571 D9           	exx
1442  0572
1443  0572 ED B0        	ldir
1444  0574
1445  0574              	;вернуть страницы
1446  0574 C3 DD 02     	jp page_cur_return
1447  0577
1448  0577
1449  0577
1450  0577
1451  0577              ;вх: hl - откуда de - куда
1452  0577              copyZ ;копировать данные до кода 0
1453  0577 7E           	ld a,(hl)
1454  0578 B7           	or a
1455  0579 28 05        	jr z,copyZ_ex
1456  057B 12           	ld (de),a
1457  057C 13           	inc de
1458  057D 23           	inc hl
1459  057E 18 F7        	jr copyZ
1460  0580              copyZ_ex
1461  0580 AF           	xor a
1462  0581 12           	ld (de),a  ;в конце 0
1463  0582 C9           	ret
1464  0583
1465  0583
1466  0583
1467  0583
1468  0583              ;выбор функции (вызова)
1469  0583              function
1470  0583 08           	ex af,af'
1471  0584 79           	ld a,c
1472  0585 FE 2A        	cp function_max ;проверка на общее количество
1473  0587 38 05        	jr c,function1
1474  0589              function_no
1475  0589 08           	ex af,af'
1476  058A 3E FF        	ld a,255 ;??????
1477  058C 37           	scf
1478  058D C9           	ret
1479  058E              function1
1480  058E D9           	exx
1481  058F 6F           	ld l,a
1482  0590 26 00        	ld h,0
1483  0592 29           	add hl,hl ;*2
1484  0593 01 A2 05     	ld bc,function_table
1485  0596 09           	add hl,bc
1486  0597 5E           	ld e,(hl)
1487  0598 23           	inc hl
1488  0599 56           	ld d,(hl)
1489  059A 7B           	ld a,e ;временно проверка есть ли такая функция
1490  059B B2           	or d
1491  059C 28 EB        	jr z,function_no ;-^
1492  059E D5           	push de
1493  059F D9           	exx
1494  05A0 08           	ex af,af'
1495  05A1 C9           	ret ;перейти по адресу функции
1496  05A2
1497  05A2
1498  05A2              function_table ;таблица функций
1499  05A2 64 07        	dw drvgmx.cls  ; #00 (0 dec) - очистить консоль;
1500  05A4 A0 07        	dw drvgmx.gotoXY ; #01 (1 dec) - установить позицию курсора в консоли
1501  05A6 16 08        	dw drvgmx.putC ; #02 (2 dec) - печать символа в консоль;
1502  05A8 B1 07        	dw drvgmx.fillLine ; #03 (3 dec) - заполнение строки одним символом
1503  05AA CB 07        	dw drvgmx.paintLine ; #04 (4 dec) - покрасить строку цветом
1504  05AC 00 00        	dw 0 ;#05 (5 dec) -
1505  05AE 28 09        	dw drvgmx.set_color ;#06 (6 dec) - установить цвет текста в консоли;
1506  05B0 00 00        	dw 0 ;#07 (7 dec) - ???????? ???? ?????????? ????????? (???);
1507  05B2 00 00        	dw 0 ;#08 (8 dec) - ?????????? ???? ?????????? ????????? (???);
1508  05B4 0B 08        	dw drvgmx.printZ ; #09 (9 dec) - ????? ?????? ????????;
1509  05B6 00 00        	dw 0 ;#0A (10 dec) - ;
1510  05B8 00 00        	dw 0 ;#0B (11 dec) - ;
1511  05BA 01 05        	dw esp_close ;#0C (12 dec) - закрыть соединение ESP
1512  05BC CA 04        	dw esp_open ;#0D (13 dec) - установить соединение ESP (CIPSTART);
1513  05BE 12 05        	dw esp_send ;#0E (14 dec) - послать запрос ESP (CIPSEND);
1514  05C0 39 05        	dw esp_get ;#0F (15 dec) - получить пакет ESP (+IPD);
1515  05C2 C5 03        	dw get_c ;#10 (16 dec) - получить код нажатой клавиши;
1516  05C4 00 00        	dw 0 ;#11 (17 dec) - ????? ???????;
1517  05C6 00 00        	dw 0 ;#12 (18 dec) - ????? ??????????;
1518  05C8 00 00        	dw 0 ;#13 (19 dec)-???????? ?????;
1519  05CA B6 04        	dw set_interrupt ;#14 (20 dec) - установка адреса обработчика прерываний процесса;
1520  05CC 3E 13        	dw VTPL.INIT ;#15 (21 dec) - инициализация плеера AY;
1521  05CE 4B 04        	dw set_VTPL_PLAY ;#16 (22 dec) - запустить плеер AY;
1522  05D0 5E 04        	dw set_VTPL_MUTE ;#17 (23 dec) - заглушить плеер AY;
1523  05D2 65 04        	dw get_VTPL_SETUP ;#18 (24 dec) - получить значение переменной плеера;
1524  05D4 E2 03        	dw page_copy ;#19 (25 dec) - скопировать страницу в страницу;
1525  05D6 24 02        	dw proc_find_ram ;#1A (26 dec) - получить дополнительную страницу памяти;
1526  05D8 88 04        	dw set_page_slot2 ;#1B (27 dec) - включить страницу в слот 2 (#8000);
1527  05DA 9F 04        	dw set_page_slot3 ;#1C (28 dec) - включить страницу в слот 3 (#c000);
1528  05DC 72 04        	dw set_scr ;#1D (29 dec) - включить экран N;
1529  05DE 69 04        	dw get_proc_page ;#1E (30 dec) - получить номера страниц процесса;
1530  05E0 DA 03        	dw get_timer ;#1F (31 dec) - получить значение системного таймера
1531  05E2 00 00        	dw 0 ;#20 (32 dec) - ;инициализация?
1532  05E4 7B 0A        	dw Dos.fopen_r ;#21 (33 dec) - открыть файл для чтения или записи;
1533  05E6 8E 0A        	dw Dos.fopen_c ;#22 (34 dec) - создать файл;
1534  05E8 FD 0B        	dw Dos.fread ;#23 (35 dec) - прочитать из файла;
1535  05EA 19 0C        	dw Dos.fwrite ;#24 (36 dec) - записать в файл;
1536  05EC DA 0B        	dw Dos.fclose ;#25 (37 dec) - закрыть файл;
1537  05EE 00 00        	dw 0 ;#26 (38 dec) -
1538  05F0 00 00        	dw 0 ;#27 (39 dec) -
1539  05F2 00 00        	dw 0 ;#28 (40 dec) - ?????? ?????? ?? ?????????? ????.
1540  05F4 00 00        	dw 0 ;#29 (41 dec) - ??????? ??????;
1541  05F6
1542  05F6
1543  05F6
1544  05F6
1545  05F6
1546  05F6 00 00 00...  	align 16
1547  0600              ;обработчик прерываний
1548  0600              Interrupts
1549  0600 F3           	di
1550  0601 E3           	ex (sp),hl
1551  0602 22 08 27     	ld (proc_stack_addr_return_tmp),hl ;запомнить откуда вызвали прерывание
1552  0605 E3           	ex (sp),hl
1553  0606 F5           	push af
1554  0607 C5           	push bc
1555  0608 D5           	push de
1556  0609 E5           	push hl
1557  060A D9           	exx
1558  060B 08           	ex af,af'
1559  060C F5           	push af
1560  060D C5           	push bc
1561  060E D5           	push de
1562  060F E5           	push hl
1563  0610 DD E5        	push ix
1564  0612 FD E5        	push iy
1565  0614 ED 73 06 27  	ld (proc_stack_addr_tmp),sp ;запомнить адрес стека
1566  0618 3E 01        	ld a,1
1567  061A D3 FE        	out (254),a
1568  061C
1569  061C              	;таймер
1570  061C 2A 2D 27     	ld hl,(sys_timer)
1571  061F 23           	inc hl
1572  0620 22 2D 27     	ld (sys_timer),hl
1573  0623 7C           	ld a,h
1574  0624 B5           	or l
1575  0625 20 07        	jr nz,Interrupts_timer
1576  0627 2A 2F 27     	ld hl,(sys_timer+2)
1577  062A 23           	inc hl
1578  062B 22 2F 27     	ld (sys_timer+2),hl
1579  062E              Interrupts_timer
1580  062E
1581  062E
1582  062E              ;опрос клавиатуры
1583  062E CD EF 0F     	call @DriverKeyboard
1584  0631 FE 1B        	cp proc_switch_key ;если клавиша переключения задач
1585  0633 20 03        	jr nz,Interrupts_key_switch_no
1586  0635 32 0A 27     	ld (proc_switch_key_flag),a ;сохранить нажатие
1587  0638              Interrupts_key_switch_no
1588  0638 CB 76        	bit 6,(hl)
1589  063A 20 03        	jr nz,Interrupts_key1 ;если не нажата ни одна
1590  063C
1591  063C 32 0F 27     	ld (key_cur),a ;запомнить клавишу
1592  063F              Interrupts_key1
1593  063F              	;
1594  063F FE 07        	cp DrvKey.keyEdit
1595  0641 20 06        	jr nz,Interrupts_key2
1596  0643              	;переключение языка
1597  0643 3E 08        	ld a,%00001000	;3,=1/0 Rus/Lat
1598  0645 AE           	xor (hl) ;флаг FlgScanKeys
1599  0646 77           	ld (hl),a
1600  0647 18 12        	jr Interrupts_key_ex
1601  0649              Interrupts_key2
1602  0649 FE 06        	cp DrvKey.keyCaps
1603  064B 20 06        	jr nz,Interrupts_key3
1604  064D              	;переключение заглавных
1605  064D 3E 02        	ld a,%00000010	;?1,=1/0 CapsLock on/off
1606  064F AE           	xor (hl)
1607  0650 77           	ld (hl),a
1608  0651 18 08        	jr Interrupts_key_ex
1609  0653              Interrupts_key3
1610  0653 FE 0F        	cp DrvKey.keyDelete
1611  0655 20 04        	jr nz,Interrupts_key_ex
1612  0657              	;графическая
1613  0657 3E 04        	ld a,%00000100	;2,=1/0 Grf on/off
1614  0659 AE           	xor (hl)
1615  065A 77           	ld (hl),a
1616  065B              Interrupts_key_ex
1617  065B              	;с клавиатурой всё
1618  065B
1619  065B
1620  065B
1621  065B
1622  065B
1623  065B              ;определить текущие страницы памяти
1624  065B 01 FD 7A     	ld bc,#7AFD
1625  065E ED 78        	in a,(c)
1626  0660 E6 7F        	and %01111111
1627  0662 32 60 07     	ld (Interrupts_cur_page_slot3),a
1628  0665 01 FD 78     	ld bc,#78fd
1629  0668 ED 78        	in a,(c)
1630  066A EE 02        	xor %00000010
1631  066C 32 5F 07     	ld (Interrupts_cur_page_slot2),a
1632  066F
1633  066F
1634  066F
1635  066F
1636  066F              ;плеер музыки и прочие неотложные процессы
1637  066F 3A 01 27     	ld a,(proc_play_ay)
1638  0672 B7           	or a
1639  0673 28 1B        	jr z,Interrupts_ay_skip
1640  0675 3A 02 27     	ld a,(proc_play_ay_slot2) ;страницы с музыкой
1641  0678 CD E8 09     	call drvgmx.PageSlot2
1642  067B 3A 03 27     	ld a,(proc_play_ay_slot3) ;страницы с музыкой
1643  067E CD 07 09     	call drvgmx.PageSlot3
1644  0681 CD 61 1B     	call VTPL.PLAY ;играть
1645  0684
1646  0684
1647  0684              ;вернуть страницы
1648  0684 3A 5F 07     	ld a,(Interrupts_cur_page_slot2)
1649  0687 CD E8 09     	call drvgmx.PageSlot2
1650  068A 3A 60 07     	ld a,(Interrupts_cur_page_slot3)
1651  068D CD 07 09     	call drvgmx.PageSlot3
1652  0690
1653  0690
1654  0690              Interrupts_ay_skip
1655  0690
1656  0690
1657  0690
1658  0690
1659  0690
1660  0690
1661  0690
1662  0690
1663  0690              ;многозадачность тут
1664  0690 3A 09 27     	ld a,(proc_stack_addr_return_tmp+1) ;узнать адрес откуда были прерывания
1665  0693 FE 40        	cp #40 ;если прерывание было в области пзу, значит работала система
1666  0695 DA 2C 07     	jp c,Interrupts_ex ;пропустим переключения на другие задачи
1667  0698
1668  0698
1669  0698 CD 40 07     	call proc_next
1670  069B              	;jr c,Interrupts_ex ;если процесс один, то на выход
1671  069B
1672  069B E5           	push hl ;дескриптор следующего
1673  069C DD E1        	pop ix
1674  069E
1675  069E
1676  069E              	;запомнить стек предыдущего (текущего) процесса
1677  069E 3A 14 27     	ld a,(proc_id_cur)
1678  06A1 21 00 27     	ld hl,proc_table - 256
1679  06A4 84           	add h
1680  06A5 67           	ld h,a
1681  06A6 E5           	push hl
1682  06A7 FD E1        	pop iy ;дескриптор предыдущего
1683  06A9
1684  06A9 01 06 00     	ld bc,6
1685  06AC 09           	add hl,bc
1686  06AD ED 4B 06 27  	ld bc,(proc_stack_addr_tmp)
1687  06B1 71           	ld (hl),c
1688  06B2 23           	inc hl
1689  06B3 70           	ld (hl),b
1690  06B4
1691  06B4              	;запомнить координаты экрана предыдущего
1692  06B4 2A 24 0A     	ld hl,(drvgmx.col_screen)
1693  06B7 FD 75 0A FD  	ld (iy+#0a),hl ;координаты
1693  06BB 74 0B
1694  06BD
1695  06BD 2A 26 0A     	ld hl,(drvgmx.attr_screen)
1696  06C0 FD 75 0C FD  	ld (iy+#0c),hl ;атрибуты (цвет текста)
1696  06C4 74 0D
1697  06C6
1698  06C6 2A F8 08     	ld hl,(drvgmx.curscrl)
1699  06C9 FD 75 08 FD  	ld (iy+#08),hl ;позиция скрола
1699  06CD 74 09
1700  06CF
1701  06CF
1702  06CF
1703  06CF              	;следующий
1704  06CF DD 7E 02     	ld a,(ix+2)
1705  06D2 32 0C 27     	ld (page_slot2_cur),a ;сделать страницы текущими
1706  06D5 CD E8 09     	call drvgmx.PageSlot2
1707  06D8 DD 7E 03     	ld a,(ix+3)
1708  06DB 32 0B 27     	ld (page_slot3_cur),a
1709  06DE CD 07 09     	call drvgmx.PageSlot3
1710  06E1
1711  06E1
1712  06E1              	;параметры экрана (консоли)
1713  06E1 DD 6E 0A DD  	ld hl,(ix+#0a) ;координаты
1713  06E5 66 0B
1714  06E7 22 24 0A     	ld (drvgmx.col_screen),hl
1715  06EA
1716  06EA DD 6E 0C DD  	ld hl,(ix+#0c) ;атрибуты (цвет текста)
1716  06EE 66 0D
1717  06F0 22 26 0A     	ld (drvgmx.attr_screen),hl
1718  06F3
1719  06F3 DD 6E 08 DD  	ld hl,(ix+#08) ;позиция скрола
1719  06F7 66 09
1720  06F9 22 F8 08     	ld (drvgmx.curscrl),hl
1721  06FC
1722  06FC
1723  06FC
1724  06FC 3A 05 27     	ld a,(proc_id_focus) ;если это процесс в фокусе
1725  06FF DD BE 00     	cp (ix)
1726  0702 20 0C        	jr nz,proc_next_no_focus
1727  0704 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
1728  0706 32 0D 27     	ld (con_scr_cur),a
1729  0709 3E 79        	ld a,con_atr_real ;атрибуты реальные
1730  070B 32 0E 27     	ld (con_atr_cur),a
1731  070E 18 0C        	jr proc_next2
1732  0710              proc_next_no_focus
1733  0710              	;если не в фокусе
1734  0710 DD 7E 04     	ld a,(ix+4) ;пиксели
1735  0713 32 0D 27     	ld (con_scr_cur),a
1736  0716 DD 7E 05     	ld a,(ix+5) ;атрибуты
1737  0719 32 0E 27     	ld (con_atr_cur),a
1738  071C              proc_next2
1739  071C DD 6E 06     	ld l,(ix+6) ;стек
1740  071F DD 66 07     	ld h,(ix+7) ;стек
1741  0722 F9           	ld sp,hl
1742  0723
1743  0723 3A 11 27     	ld a,(proc_id_next)
1744  0726 32 14 27     	ld (proc_id_cur),a ;сменить текущий
1745  0729
1746  0729 CD EF 08     	call drvgmx.gmxscroll ;обновить скролл
1747  072C
1748  072C              Interrupts_ex
1749  072C 3E 00        	ld a,0
1750  072E D3 FE        	out (254),a
1751  0730 FD E1        	pop iy
1752  0732 DD E1        	pop ix
1753  0734 E1           	pop hl
1754  0735 D1           	pop de
1755  0736 C1           	pop bc
1756  0737 F1           	pop af
1757  0738 D9           	exx
1758  0739 08           	ex af,af
1759  073A E1           	pop hl
1760  073B D1           	pop de
1761  073C C1           	pop bc
1762  073D F1           	pop af
1763  073E FB           	ei
1764  073F C9           	ret
1765  0740
1766  0740              proc_next
1767  0740              	;переключение на следующую задачу
1768  0740              	;вых: hl - дескриптор следующего процесса
1769  0740 3A 11 27     	ld a,(proc_id_next) ;узнать следующий
1770  0743              proc_next_skip
1771  0743 3C           	inc a
1772  0744 FE 09        	cp proc_max+1
1773  0746 38 02        	jr c,proc_next1
1774  0748 3E 01        	ld a,proc_id_system
1775  074A              proc_next1
1776  074A 32 11 27     	ld (proc_id_next),a
1777  074D
1778  074D 21 00 27     	ld hl,proc_table-256 ;номера процессов начинаются с 1
1779  0750 84           	add h ;перейти на номер кратный 256
1780  0751 67           	ld h,a
1781  0752 7E           	ld a,(hl)
1782  0753 B7           	or a ;нет активного процесса?
1783  0754 28 EA        	jr z,proc_next ;искать дальше
1784  0756              	;нашли следующий процесс
1785  0756 3A 14 27     	ld a,(proc_id_cur)
1786  0759 BE           	cp (hl) ;если это он и был (всего один процесс)
1787  075A 37           	scf
1788  075B C8           	ret z
1789  075C 7E           	ld a,(hl) ;или вернуть id слудующего
1790  075D B7           	or a
1791  075E C9           	ret
1792  075F
1793  075F 00           Interrupts_cur_page_slot2 db 0 ;временно
1794  0760 00           Interrupts_cur_page_slot3 db 0 ;временно
1795  0761
1796  0761
1797  0761
1798  0761
1799  0761
1800  0761              	include Drv/zsgmx.asm ;драйвер экрана и памяти
# file opened: Drv/zsgmx.asm
   1+ 0761              COLOR=1
   2+ 0761              ;; ZS GMX screen driver (izzx)
   3+ 0761              	define LINE_LIMIT 80
   4+ 0761                  module drvgmx
   5+ 0761              hsize   equ 25 ;всего строк
   6+ 0761              scraddr equ #c000 ;адрес экрана
   7+ 0761              scrsize equ 16000  ;размер экрана
   8+ 0761              scrline equ 80*8   ;размер строки в байтах
   9+ 0761
  10+ 0761              init:
  11+ 0761                  ; ld hl, font_file, b, Dos.FMODE_READ
  12+ 0761                  ; call Dos.fopen
  13+ 0761                  ; push af
  14+ 0761                  ; ld bc, 2048, hl, font
  15+ 0761                  ; call Dos.fread
  16+ 0761                  ; pop af
  17+ 0761                  ; call Dos.fclose
  18+ 0761              	; xor a : out (#fe), a
  19+ 0761              	; call cls
  20+ 0761              	; ret
  21+ 0761 CD 4C 09     	call set_scr39 ;включить экран
  22+ 0764              cls:
  23+ 0764 11 00 00         ld de, 0
  23+ 0767
  24+ 0767 ED 53 F8 08  	ld (curscrl),de ;скролл выключить
  25+ 076B CD EF 08     	call gmxscroll
  26+ 076E 11 00 00         ld de, 0
  26+ 0771
  27+ 0771 CD A0 07     	call gotoXY
  28+ 0774                  ;ld a, 7 : call Memory.setPage
  29+ 0774 3A 0D 27     	ld a,(con_scr_cur) ;пиксели
  30+ 0777 CD 07 09     	call PageSlot3 ;включить страницу пикселей
  31+ 077A AF               xor a
  31+ 077B               ; out (#fe), a
  32+ 077B 21 00 C0 11      ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  32+ 077F 01 C0 01 7F
  32+ 0783 3E 77
  32+ 0785 ED B0          ldir ;очистить
  33+ 0787 3A 0E 27     	ld a,(con_atr_cur) ;атрибуты
  34+ 078A CD 07 09     	call PageSlot3 ;включить страницу атрибутов
  35+ 078D AF           	xor a ;ld a,(attr_screen) ;цвет
  36+ 078E 21 00 C0 11  	ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  36+ 0792 01 C0 01 7F
  36+ 0796 3E 77
  36+ 0798 ED B0          ldir ;очистить
  37+ 079A              	;call gmxscron ;включить расширенный экран
  38+ 079A 3A 0B 27     	ld a,(page_slot3_cur)
  39+ 079D C3 07 09     	jp PageSlot3 ;вернуть страницу
  40+ 07A0                  ;jp Memory.setPage
  41+ 07A0
  42+ 07A0
  43+ 07A0              ; Set console coordinates
  44+ 07A0              ; d = row(0..23), e = column (0..79)
  45+ 07A0              gotoXY:
  46+ 07A0              	;rr e
  47+ 07A0              	; ld a, 0
  48+ 07A0              	; ld (half_tile_screen), a
  49+ 07A0 7A           	ld a,d ;проверка координаты строки
  50+ 07A1 FE 19        	cp hsize
  51+ 07A3 D0           	ret nc
  52+ 07A4 7B           	ld a,e ;проверка координаты столбца
  53+ 07A5 FE 50        	cp 80
  54+ 07A7 D0           	ret nc
  55+ 07A8 ED 53 24 0A      ld (col_screen), de
  56+ 07AC C9               ret
  57+ 07AD
  58+ 07AD              disable:
  59+ 07AD                  ; Nothing to disable
  60+ 07AD CD C5 08     	call gmxscroff ;выключить расширенный экран
  61+ 07B0 C9               ret
  62+ 07B1
  63+ 07B1              ; H - line
  64+ 07B1              ; A - char
  65+ 07B1              fillLine: ;заполнение строки одним символом
  66+ 07B1 F5               push af
  67+ 07B2 54 1E 00         ld d, h, e, 0
  67+ 07B5 CD A0 07       call gotoXY
  68+ 07B8 F1               pop af
  69+ 07B9 21 2A 0A 11      ld hl, fill_buff, de, fill_buff + 1, bc, 80-1, (hl), a
  69+ 07BD 2B 0A 01 4F
  69+ 07C1 00 77
  69+ 07C3 ED B0          ldir
  70+ 07C5 21 2A 0A         ld hl, fill_buff
  70+ 07C8 C3 0B 08       jp printZ
  71+ 07CB
  72+ 07CB              paintLine: ;на входе в A номер строки, которую надо покрасить, B - цвет
  73+ 07CB C5           	push bc
  74+ 07CC 47               ld b, a
  75+ 07CD 0E 00            ld c, 0
  76+ 07CF CD 7B 08         call bc_to_attr
  77+ 07D2 E5           	push hl
  78+ 07D3 3A 0E 27     	ld a,(con_atr_cur) ;атрибуты
  79+ 07D6 CD 07 09     	call PageSlot3
  80+ 07D9 E1           	pop hl
  81+ 07DA C1           	pop bc
  82+ 07DB 78           	ld a,b;цвет
  83+ 07DC 77               ld (hl), a
  84+ 07DD 54 5D            ld de, hl
  85+ 07DF 13               inc de
  86+ 07E0 01 7F 02         ld bc, (80*8)-1
  87+ 07E3 ED B0            ldir
  88+ 07E5 3A 0B 27         ld a,(page_slot3_cur)
  89+ 07E8 C3 07 09     	jp PageSlot3 ;вернуть страницу
  90+ 07EB
  91+ 07EB
  92+ 07EB              mvCR ;каретка вниз (по коду 13)
  93+ 07EB ED 5B 24 0A  	ld de, (col_screen)
  94+ 07EF 14           	inc d ;row++
  95+ 07F0 7A           	ld a,d
  96+ 07F1 FE 19        	cp hsize ;последняя строка
  97+ 07F3 38 11        	jr c,mvCR1
  98+ 07F5 3A 0D 27     	ld a,(con_scr_cur) ;пиксели
  99+ 07F8 CD 07 09     	call PageSlot3 ;включить страницу пикселей
 100+ 07FB CD CD 08     	call scroll
 101+ 07FE 3A 0B 27     	ld a,(page_slot3_cur)
 102+ 0801 CD 07 09     	call PageSlot3 ;вернуть страницу
 103+ 0804 16 18        	ld d,hsize-1 ;остаться на последне строке
 104+ 0806              mvCR1
 105+ 0806 1E 00        	ld e, 0
 106+ 0808              	; ld a, 0
 107+ 0808              	; ld (half_tile_screen), a
 108+ 0808 C3 A0 07     	jp gotoXY
 109+ 080B
 110+ 080B              ; Print just one symbol
 111+ 080B              ; A - symbol
 112+ 080B              ; putC
 113+ 080B               	; ld hl, single_symbol_print ;single_symbol
 114+ 080B              	; ld (hl), a
 115+ 080B              	; ;ld a, 7 : call Memory.setPage
 116+ 080B              	; ; ld a,(con_scr_cur) ;пиксели
 117+ 080B              	; ; call PageSlot3
 118+ 080B                  ; ld hl, single_symbol_print
 119+ 080B                  ; call printL
 120+ 080B                  ; ld a,(page_slot3_cur)
 121+ 080B              	; jp PageSlot3 ;вернуть страницу
 122+ 080B
 123+ 080B              ; Put string
 124+ 080B              ; hl - string pointer that's begins from symbol count
 125+ 080B              printZ
 126+ 080B 7E               ld a, (hl)
 126+ 080C A7             and a
 126+ 080D C8             ret z
 127+ 080E E5               push hl
 128+ 080F CD 16 08         call putC
 129+ 0812 E1               pop hl
 130+ 0813 23               inc hl
 131+ 0814 18 F5            jr printZ
 132+ 0816
 133+ 0816              ; printL
 134+ 0816                      ; ld	a, (hl)
 135+ 0816              		; and	a
 136+ 0816              		; ret	z
 137+ 0816              putC
 138+ 0816 FE 0D        		cp 13
 138+ 0818 CA EB 07       jp z, mvCR
 139+ 081B FE 0A        		cp 10
 139+ 081D C8            ret z ;пропустить символ
 140+ 081E
 141+ 081E CD 77 08     		call calc_addr_scr
 142+ 0821 54           		ld d,h ;координаты экрана в DE
 143+ 0822 5D           		ld e,l
 144+ 0823 6F           		ld	l,a
 145+ 0824 26 00        		ld	h,0
 146+ 0826 29           		add	hl,hl
 147+ 0827 29           		add	hl,hl
 148+ 0828 29           		add	hl,hl
 149+ 0829 01 00 1F             ld      bc,font
 150+ 082C 09                   add     hl,bc ;hl - адрес шрифта буквы
 151+ 082D
 152+ 082D                      ;push    de
 153+ 082D
 154+ 082D 3A 0D 27     	ld a,(con_scr_cur) ;страница пиксели
 155+ 0830 D9           	exx
 156+ 0831 CD 07 09     	call PageSlot3
 157+ 0834 D9           	exx
 158+ 0835 D5           	push de ;сохранить адрес символа на экране
 159+ 0836
 160+ 0836 01 FF 08         ld  bc,#08ff
 161+ 0839              print80_1
 162+ 0839 ED A0        	ldi ;один байт
 163+ 083B
 164+ 083B E5           	push hl ;на строку пикселей вниз
 165+ 083C 21 4F 00     	ld hl,80-1
 166+ 083F 19           	add hl,de
 167+ 0840 EB           	ex de,hl
 168+ 0841 E1           	pop hl
 169+ 0842
 170+ 0842 10 F5        	djnz    print80_1
 171+ 0844
 172+ 0844
 173+ 0844 3A 0E 27     	ld a,(con_atr_cur) ;страница атрибуты
 174+ 0847 CD 07 09     	call PageSlot3
 175+ 084A
 176+ 084A E1           	pop hl ;адрес символа на экране
 177+ 084B
 178+ 084B 06 08            ld      b,8
 179+ 084D 3A 26 0A     	ld a,(attr_screen)
 180+ 0850 11 50 00     	ld de,80
 181+ 0853              print80_1_attr ;теперь так же атрибуты
 182+ 0853
 183+ 0853 77           	ld (hl),a
 184+ 0854 19           	add hl,de
 185+ 0855
 186+ 0855 10 FC        	djnz    print80_1_attr
 187+ 0857
 188+ 0857
 189+ 0857
 190+ 0857              ; move cursor на одну позицию вперёд
 191+ 0857              move_cr80
 192+ 0857              	;inc	de
 193+ 0857
 194+ 0857 21 24 0A     	ld	hl,col_screen
 195+ 085A 34           	inc	(hl) ;увеличить столбец
 196+ 085B 7E           	ld	a,(hl)
 197+ 085C
 198+ 085C FE 50        	cp	80
 199+ 085E 38 10        	jr	c,move_cr80_01 ;на выход
 200+ 0860
 201+ 0860 AF           	xor	a
 202+ 0861              	;ld	(half_tile_screen),a
 203+ 0861 77           	ld	(hl),a
 204+ 0862              	;ld	c,a
 205+ 0862
 206+ 0862 23           	inc	hl ;на переменную row
 207+ 0863 34           	inc	(hl)
 208+ 0864 7E           	ld	a,(hl)
 209+ 0865              	;ld	b,a
 210+ 0865
 211+ 0865 FE 19        	cp	hsize ;всего строк
 212+ 0867 DA 70 08     	jp	c,move_cr80_01
 213+ 086A
 214+ 086A 3E 18        	ld	a,hsize-1
 215+ 086C 77           	ld	(hl),a
 216+ 086D              	;ld	b,a
 217+ 086D
 218+ 086D CD CD 08     	call scroll ;сдвиг вверх
 219+ 0870              	; push	bc
 220+ 0870              	; call	scroll_up8
 221+ 0870              	; pop	bc
 222+ 0870
 223+ 0870              move_cr80_01
 224+ 0870              	; call	calc_addr_scr
 225+ 0870 3A 0B 27     	ld a,(page_slot3_cur)
 226+ 0873 C3 07 09     	jp PageSlot3 ;вернуть страницу
 227+ 0876 C9           	ret
 228+ 0877
 229+ 0877              calc_addr_scr	;определение адреса экрана по координатам символа
 230+ 0877 ED 4B 24 0A  	ld	bc,(col_screen)
 231+ 087B              bc_to_attr:
 232+ 087B 26 00        	ld h,0
 233+ 087D 68           	ld l,b ;строка
 234+ 087E 29           	add hl,hl ;*2
 235+ 087F 11 F0 09     	ld de,table_addr_scr
 236+ 0882 19           	add hl,de
 237+ 0883 5E           	ld e,(hl)
 238+ 0884 23           	inc hl
 239+ 0885 56           	ld d,(hl) ;узнали координаты строки
 240+ 0886 26 00        	ld h,0
 241+ 0888 69           	ld l,c ;колонка
 242+ 0889 19           	add hl,de ;узнали адрес символа
 243+ 088A
 244+ 088A ED 5B F8 08  	ld de,(curscrl) ;добавить аппаратный скрол
 245+ 088E 19           	add hl,de
 246+ 088F 11 80 3E     	ld de,scrsize
 247+ 0892 A7           	and a		;check over
 248+ 0893 ED 52        	sbc hl,de
 249+ 0895 30 01        	jr nc,calc02
 250+ 0897 19           	add hl,de
 251+ 0898              calc02:
 252+ 0898 11 00 C0     	ld de,scraddr  ;screen
 253+ 089B 19           	add hl,de
 254+ 089C
 255+ 089C              	; ld      a,b
 256+ 089C              	; ld      d,a
 257+ 089C              	; rrca
 258+ 089C              	; rrca
 259+ 089C              	; rrca
 260+ 089C              	; and     a,224
 261+ 089C              	; add     a,c
 262+ 089C              	; ld      e,a
 263+ 089C              	; ld      a,d
 264+ 089C              	; and     24
 265+ 089C              	; or      #c0
 266+ 089C              	; ld      d,a
 267+ 089C C9           	ret
 268+ 089D
 269+ 089D
 270+ 089D
 271+ 089D              clear_line ;очистить строку
 272+ 089D                  ;ld b, hsize-1 ;последняя
 273+ 089D                  ;ld c, 0
 274+ 089D CD 7B 08         call bc_to_attr ;узнать адрес
 275+ 08A0 E5           	push hl
 276+ 08A1 54           	ld d,h
 277+ 08A2 5D           	ld e,l
 278+ 08A3 13           	inc de
 279+ 08A4 01 7F 02     	ld bc,scrline-1
 280+ 08A7 36 00        	ld (hl),0
 281+ 08A9 ED B0        	ldir
 282+ 08AB 3A 0E 27     	ld a,(con_atr_cur) ;теперь страница атрибутов
 283+ 08AE CD 07 09     	call PageSlot3 ;
 284+ 08B1 E1           	pop hl
 285+ 08B2 54           	ld d,h
 286+ 08B3 5D           	ld e,l
 287+ 08B4 13           	inc de
 288+ 08B5 01 7F 02     	ld bc,scrline-1
 289+ 08B8              	;ld a,(con_atr_cur) ;атрибуты
 290+ 08B8 36 00        	ld (hl),0
 291+ 08BA ED B0        	ldir
 292+ 08BC C9           	ret
 293+ 08BD
 294+ 08BD              gmxscron
 295+ 08BD 01 FD 7E                 ld      bc,#7efd
 296+ 08C0 3E C8                    ld      a,#c8
 297+ 08C2 ED 79                    out     (c),a
 298+ 08C4                          ; ld      bc,#7ffd
 299+ 08C4                          ; ld      a,#10    ;5 screen
 300+ 08C4                          ; out     (c),a
 301+ 08C4 C9                       ret
 302+ 08C5
 303+ 08C5              ; gmxscron2
 304+ 08C5                          ; ld      bc,#7efd
 305+ 08C5                          ; ld      a,#c8
 306+ 08C5                          ; out     (c),a
 307+ 08C5                          ; ld      bc,#7ffd
 308+ 08C5                          ; ld      a,#18    ;7 screen
 309+ 08C5                          ; out     (c),a
 310+ 08C5                          ; ret
 311+ 08C5
 312+ 08C5              gmxscroff
 313+ 08C5 01 FD 7E                 ld      bc,#7efd
 314+ 08C8 3E C0                    ld      a,#c0
 315+ 08CA ED 79                    out     (c),a
 316+ 08CC                          ; ld      bc,#7ffd
 317+ 08CC                          ; ld      a,#10    ;5 screen
 318+ 08CC                          ; out     (c),a
 319+ 08CC C9                       ret
 320+ 08CD
 321+ 08CD
 322+ 08CD
 323+ 08CD
 324+ 08CD
 325+ 08CD
 326+ 08CD              scroll: ;push hl         ; скpолл экpана на стpоку ввеpх
 327+ 08CD 2A F8 08     	ld hl,(curscrl)	;hard scroll
 328+ 08D0 11 80 02     	ld de,scrline
 329+ 08D3 19           	add hl,de	;next line
 330+ 08D4 11 80 3E     	ld de,scrsize	;chek over 16000
 331+ 08D7 A7           	and a
 332+ 08D8 ED 52        	sbc hl,de
 333+ 08DA 30 03        	jr nc,scrollchek
 334+ 08DC 19           	add hl,de
 335+ 08DD 18 03        	jr scrollchek1
 336+ 08DF              scrollchek:
 337+ 08DF 21 00 00     	ld hl,0
 338+ 08E2              scrollchek1:
 339+ 08E2 22 F8 08     	ld (curscrl),hl
 340+ 08E5 CD EF 08     	call gmxscroll
 341+ 08E8
 342+ 08E8 06 18            ld b,hsize-1    ;last line
 343+ 08EA 0E 00        	ld c,0
 344+ 08EC                  ;ld a,(attr_screen) ;цвет
 345+ 08EC C3 9D 08         jp clear_line      ; очистка последней стpоки
 346+ 08EF                  ;ret
 347+ 08EF               ;аппаратный скрол вверх
 348+ 08EF              gmxscroll:
 349+ 08EF              ;set hard scroll
 350+ 08EF              ;in:
 351+ 08EF              ;out:
 352+ 08EF              	;push af
 353+ 08EF              	;push bc
 354+ 08EF              	;push de
 355+ 08EF 21 14 27     	ld hl,proc_id_cur
 356+ 08F2 3A 05 27     	ld a,(proc_id_focus)
 357+ 08F5 BE           	cp (hl)
 358+ 08F6 C0           	ret nz ;скрол меняем только когда в фокусе
 359+ 08F7
 360+ 08F7 11 00 00     	ld de,0
 361+ 08FA              curscrl equ $-2 ;current hard scroll (0-15999)
 362+ 08FA 01 FD 7A     	ld bc,07AFDh
 363+ 08FD 7B           	ld a,e
 364+ 08FE ED 79        	out (c),a
 365+ 0900 01 FD 7C     	ld bc,07CFDh
 366+ 0903 7A           	ld a,d
 367+ 0904 ED 79        	out (c),a
 368+ 0906              	;pop de
 369+ 0906              	;pop bc
 370+ 0906              	;pop af
 371+ 0906 C9           	ret
 372+ 0907
 373+ 0907
 374+ 0907
 375+ 0907
 376+ 0907
 377+ 0907              PageSlot3
 378+ 0907              ; драйвер памяти Scorpion GMX 2Mb
 379+ 0907
 380+ 0907                       ;push hl
 381+ 0907                       ; ld   hl,page_table
 382+ 0907                       ; add  a,l
 383+ 0907                       ; jr   nc,PageSlot3_1
 384+ 0907                       ; inc  h          ;коррекция
 385+ 0907              ; PageSlot3_1  ld   l,a
 386+ 0907                       ; ld   a,(hl)
 387+ 0907                       ;pop  hl
 388+ 0907                       ;cp   #ff
 389+ 0907                       ;scf
 390+ 0907                       ;ret  z
 391+ 0907                       ;push bc
 392+ 0907 F5                    push af
 393+ 0908 07                    rlca
 394+ 0909 E6 10        		 and #10
 395+ 090B F6 01                 or  #01  ;выбор ОЗУ вместо ПЗУ
 396+ 090D 01 FD 1F              ld   bc,#1ffd
 397+ 0910              PageSlot3DOS
 398+ 0910              		 ;or #00 ; #04 тут выбор ПЗУ TRDOS
 399+ 0910 ED 79                 out  (c),a
 400+ 0912 F1                    pop  af
 401+ 0913 F5                    push af
 402+ 0914 E6 07                 and  #07
 403+ 0916              PageSlot3Scr ;тут выбор экрана и ПЗУ
 404+ 0916 F6 10                 or   #10 ;#0 ;#18
 405+ 0918 06 7F                 ld   b,#7f
 406+ 091A ED 79                 out  (c),a
 407+ 091C F1                    pop  af
 408+ 091D 0F                    rrca
 409+ 091E 0F                    rrca
 410+ 091F 0F                    rrca
 411+ 0920 0F                    rrca
 412+ 0921 E6 07                 and  #07
 413+ 0923 06 DF                 ld   b,#df
 414+ 0925 ED 79                 out  (c),a
 415+ 0927                       ;pop  hl
 416+ 0927 C9                    ret
 417+ 0928
 418+ 0928              set_color
 419+ 0928 32 26 0A     		ld (attr_screen),a
 420+ 092B 78           		ld a,b
 421+ 092C 32 27 0A     		ld (attr_screen2),a
 422+ 092F C9           		ret
 423+ 0930
 424+ 0930              set_scr5 ;включить экран 5
 425+ 0930 CD C5 08     		call gmxscroff ;выключить расширенный
 426+ 0933 3E 10        		ld a,#10
 427+ 0935 32 17 09     		ld (PageSlot3Scr+1),a
 428+ 0938 3A 0B 27     		ld a,(page_slot3_cur)
 429+ 093B C3 07 09     		jp PageSlot3
 430+ 093E
 431+ 093E
 432+ 093E              set_scr7 ;включить экран 7
 433+ 093E CD C5 08     		call gmxscroff ;выключить расширенный
 434+ 0941 3E 18        		ld a,#18
 435+ 0943 32 17 09     		ld (PageSlot3Scr+1),a
 436+ 0946 3A 0B 27     		ld a,(page_slot3_cur)
 437+ 0949 C3 07 09     		jp PageSlot3
 438+ 094C
 439+ 094C
 440+ 094C              set_scr39 ;включить экран 39
 441+ 094C CD BD 08     		call gmxscron ;выключить расширенный
 442+ 094F 3E 10        		ld a,#10
 443+ 0951 32 17 09     		ld (PageSlot3Scr+1),a
 444+ 0954 3A 0B 27     		ld a,(page_slot3_cur)
 445+ 0957 C3 07 09     		jp PageSlot3
 446+ 095A
 447+ 095A
 448+ 095A              set_scr3a ;включить экран 3b
 449+ 095A CD BD 08     		call gmxscron ;выключить расширенный
 450+ 095D 3E 18        		ld a,#18
 451+ 095F 32 17 09     		ld (PageSlot3Scr+1),a
 452+ 0962 3A 0B 27     		ld a,(page_slot3_cur)
 453+ 0965 C3 07 09     		jp PageSlot3
 454+ 0968
 455+ 0968
 456+ 0968
 457+ 0968
 458+ 0968
 459+ 0968
 460+ 0968              ;Таблица страниц кроме #00-#07, #39, #3a, #77-7F
 461+ 0968              page_table    ;db   #00,#01,#02,#03,#04,#05,#06,#07,
 462+ 0968 08 09        		 db	  #08,#09
 463+ 096A 0A 0B 0C 0D           db   #0a,#0b,#0c,#0d,#0e
 463+ 096E 0E
 464+ 096F 0F 10 11 12           db   #0f,#10,#11,#12,#13,#14
 464+ 0973 13 14
 465+ 0975 15 16 17 18           db   #15,#16,#17,#18,#19,#1a
 465+ 0979 19 1A
 466+ 097B 1B 1C 1D 1E           db   #1b,#1c,#1d,#1e,#1f,#20
 466+ 097F 1F 20
 467+ 0981 21 22 23 24           db   #21,#22,#23,#24,#25,#26
 467+ 0985 25 26
 468+ 0987 27 28 29 2A           db   #27,#28,#29,#2a,#2b,#2c
 468+ 098B 2B 2C
 469+ 098D 2D 2E 2F 30           db   #2d,#2e,#2f,#30,#31,#32
 469+ 0991 31 32
 470+ 0993 33 34 35 36           db   #33,#34,#35,#36,#37,#38
 470+ 0997 37 38
 471+ 0999 3B 3C 3D 3E           db   #3b,#3c,#3d,#3e,#3f,#40
 471+ 099D 3F 40
 472+ 099F 41 42 43 44           db   #41,#42,#43,#44,#45,#46
 472+ 09A3 45 46
 473+ 09A5 47 48 49 4A           db   #47,#48,#49,#4a,#4b,#4c
 473+ 09A9 4B 4C
 474+ 09AB
 475+ 09AB 4D 4E 4F 50           db   #4d,#4e,#4f,#50,#51,#52
 475+ 09AF 51 52
 476+ 09B1 53 54 55 56           db   #53,#54,#55,#56,#57,#58
 476+ 09B5 57 58
 477+ 09B7 59 5A 5B 5C           db   #59,#5a,#5b,#5c,#5d,#5e
 477+ 09BB 5D 5E
 478+ 09BD 5F 60 61 62           db   #5f,#60,#61,#62,#63,#64
 478+ 09C1 63 64
 479+ 09C3 65 66 67 68           db   #65,#66,#67,#68,#69,#6a
 479+ 09C7 69 6A
 480+ 09C9 6B 6C 6D 6E           db   #6b,#6c,#6d,#6e,#6f,#70
 480+ 09CD 6F 70
 481+ 09CF 71 72 73 74           db   #71,#72,#73,#74,#75,#76
 481+ 09D3 75 76
 482+ 09D5                       ;db   #77,#78,#79,#7a,#7b,#7c,#7d,#7e
 483+ 09D5                       ;db   #7f
 484+ 09D5              page_table_end
 485+ 09D5 00 00 00...           ds 128-(page_table_end-page_table) ;забить остаток нулями
 486+ 09E8
 487+ 09E8
 488+ 09E8
 489+ 09E8              ;font equ #4000 ; Using ZX-Spectrum screen as font buffer
 490+ 09E8              ;font_file db "data/font.bin", 0
 491+ 09E8
 492+ 09E8              PageSlot2 ;включение банка из A в слот памяти 2
 493+ 09E8 EE 02        	xor 2
 494+ 09EA 01 FD 78     	ld bc,#78fd
 495+ 09ED ED 79        	out (c),a
 496+ 09EF C9           	ret
 497+ 09F0
 498+ 09F0
 499+ 09F0              table_addr_scr	;адреса строк текста
 500+ 09F0 00 00        	defw	00000h ;0
 501+ 09F2 80 02        	defw	00280h
 502+ 09F4 00 05        	defw	00500h
 503+ 09F6 80 07        	defw	00780h
 504+ 09F8 00 0A        	defw	00a00h
 505+ 09FA 80 0C        	defw	00c80h
 506+ 09FC 00 0F        	defw	00f00h
 507+ 09FE 80 11        	defw	01180h
 508+ 0A00
 509+ 0A00 00 14        	defw	01400h ;8
 510+ 0A02 80 16        	defw	01680h
 511+ 0A04 00 19        	defw	01900h
 512+ 0A06 80 1B        	defw	01b80h
 513+ 0A08 00 1E        	defw	01e00h
 514+ 0A0A 80 20        	defw	02080h
 515+ 0A0C 00 23        	defw	02300h
 516+ 0A0E 80 25        	defw	02580h
 517+ 0A10
 518+ 0A10 00 28        	defw	02800h ;16
 519+ 0A12 80 2A        	defw	02a80h
 520+ 0A14 00 2D        	defw	02d00h
 521+ 0A16 80 2F        	defw	02f80h
 522+ 0A18 00 32        	defw	03200h
 523+ 0A1A 80 34        	defw	03480h
 524+ 0A1C 00 37        	defw	03700h
 525+ 0A1E 80 39        	defw	03980h
 526+ 0A20
 527+ 0A20 00 3C        	defw	03c00h ;24
 528+ 0A22 80 3E        	defw	03e80h ;25 вне экрана
 529+ 0A24
 530+ 0A24
 531+ 0A24 00           col_screen			db	0	;столбец
 532+ 0A25 00           row_screen			db	0	;строка
 533+ 0A26              ;half_tile_screen	db	0
 534+ 0A26 07           attr_screen			db	07	;основной цвет
 535+ 0A27 0C           attr_screen2		db	#c	;второй цвет
 536+ 0A28
 537+ 0A28
 538+ 0A28              ;col_screen_temp			dw	0
 539+ 0A28              ;half_tile_screen_temp	db	0
 540+ 0A28
 541+ 0A28 01           single_symbol_print db 1
 542+ 0A29 00           single_symbol 		db 0
 543+ 0A2A
 544+ 0A2A 00 00 00...  fill_buff ds 80+1
 545+ 0A7B
 546+ 0A7B                  endmodule
# file closed: Drv/zsgmx.asm
1801  0A7B              	include Drv/zsfat.asm ;драйвер диска
# file opened: Drv/zsfat.asm
   1+ 0A7B              ;trdos & fat32 driver (izzx)
   2+ 0A7B                  MODULE Dos
   3+ 0A7B              ; API methods - для всех процессов
   4+ 0A7B              ;ESX_GETSETDRV = #89
   5+ 0A7B              ;ESX_FOPEN = #9A
   6+ 0A7B              ;ESX_FCLOSE = #9B
   7+ 0A7B              ;ESX_FSYNC = #9C
   8+ 0A7B              ;ESX_FREAD = #9D
   9+ 0A7B              ;ESX_FWRITE = #9E
  10+ 0A7B
  11+ 0A7B              ; File modes
  12+ 0A7B              FMODE_READ = #01
  13+ 0A7B              ;FMODE_WRITE = #06
  14+ 0A7B              FMODE_CREATE = #0E
  15+ 0A7B
  16+ 0A7B                  ; MACRO esxCall func
  17+ 0A7B                  ; rst #8 : db func
  18+ 0A7B                  ; ENDM
  19+ 0A7B
  20+ 0A7B              ;макросы только для внутренней работы самого модуля через BIOS
  21+ 0A7B              ;
  22+ 0A7B              ;R8DOS			вызов функции R8DOS
  23+ 0A7B              ;R8FAT			вызов функции R8FAT
  24+ 0A7B              ;R8DOSc			вызов функции R8DOS
  25+ 0A7B              ;
  26+ 0A7B              ;------------------------------------------------------------------------------
  27+ 0A7B              ;вызов функции R8DOS
  28+ 0A7B              ;вх: =0 номер функции
  29+ 0A7B              ;
  30+ 0A7B              	MACRO	R8DOS nFunc
  31+ 0A7B ~            	ld	c,nFunc
  32+ 0A7B ~            	rst	#08
  33+ 0A7B ~            	db	#81
  34+ 0A7B              	ENDM
  35+ 0A7B
  36+ 0A7B              ;------------------------------------------------------------------------------
  37+ 0A7B              ;вызов функции R8FAT
  38+ 0A7B              ;вх: =0 номер функции
  39+ 0A7B              ;
  40+ 0A7B              	MACRO	R8FAT nFunc
  41+ 0A7B ~            	ld	c,nFunc
  42+ 0A7B ~            	rst	#08
  43+ 0A7B ~            	db	#91
  44+ 0A7B              	ENDM
  45+ 0A7B
  46+ 0A7B              ;------------------------------------------------------------------------------
  47+ 0A7B              ;вызов функции R8DOS
  48+ 0A7B              ;вх: c - номер функции
  49+ 0A7B              ;
  50+ 0A7B              	MACRO	R8DOSc
  51+ 0A7B ~            	rst	#08
  52+ 0A7B ~            	db	#81
  53+ 0A7B              	ENDM
  54+ 0A7B
  55+ 0A7B              ;------------------------------------------------------------------------------
  56+ 0A7B              ;вызов функции #02 (FileMan) R8CONF
  57+ 0A7B              ;вх: =#00 - номер функции файл менеджера
  58+ 0A7B              ;
  59+ 0A7B              	MACRO	R8C02FM nFunct
  60+ 0A7B ~            	ld	bc,#100*nFunct+#02
  61+ 0A7B ~            	rst	#08
  62+ 0A7B ~            	db	#8E
  63+ 0A7B              	ENDM
  64+ 0A7B
  65+ 0A7B              ;==============================================================================
  66+ 0A7B              r8f00_DeinitFAT		equ #00
  67+ 0A7B              r8f01_InitFAT		equ #01
  68+ 0A7B              r8f04_FindPath		equ #04
  69+ 0A7B              r8f07_FileOpen		equ #07 ;открыть файл для последующих операций с ним
  70+ 0A7B              r8f08_FileRead		equ #08	;чтение данных из файла в память
  71+ 0A7B              r8f09_FileWrite		equ #09	;запись данных из памяти в файл
  72+ 0A7B              r8f0E_CreateFileLFN	equ #0E ;создание файла с длинным именем в текущем каталоге
  73+ 0A7B              r8f0F_CreateFileSFN	equ #0F
  74+ 0A7B
  75+ 0A7B              r8f13_GetPath 		equ #13;(19) получение текущего пути
  76+ 0A7B
  77+ 0A7B              r8d2D_FindPart		equ #2D
  78+ 0A7B              r8d2E_CngHDD		equ #2E
  79+ 0A7B
  80+ 0A7B              ;конец макросов BIOS
  81+ 0A7B
  82+ 0A7B              files_fat_max equ 8 ;максимальное число открытых файлов fat
  83+ 0A7B              files_trd_max equ 8 ;максимальное число открытых файлов trd
  84+ 0A7B              fcb_fat_size equ 32 ;размер дискриптора fcb
  85+ 0A7B
  86+ 0A7B
  87+ 0A7B
  88+ 0A7B              ; Returns:
  89+ 0A7B              ;  A - current drive
  90+ 0A7B              ; getDefaultDrive: ;нигде не используется
  91+ 0A7B                  ; ld a, 0 : esxCall ESX_GETSETDRV
  92+ 0A7B                  ; ret
  93+ 0A7B
  94+ 0A7B
  95+ 0A7B
  96+ 0A7B              ; Opens file on default drive
  97+ 0A7B              ; B - File mode
  98+ 0A7B              ; HL - File name
  99+ 0A7B              ; Returns:
 100+ 0A7B              ;  A - file stream id
 101+ 0A7B              ; DE, BC - File size
 102+ 0A7B              ; IX - fcb
 103+ 0A7B              ; fopen:
 104+ 0A7B                  ; ; push bc : push hl
 105+ 0A7B                  ; ; call getDefaultDrive
 106+ 0A7B                  ; ; pop ix : pop bc
 107+ 0A7B                  ; ; esxCall ESX_FOPEN
 108+ 0A7B                  ; ; ret
 109+ 0A7B              	; ld a,b
 110+ 0A7B              	; cp FMODE_READ ;если режим открытие файла
 111+ 0A7B              	; jr z,fopen_r
 112+ 0A7B              	; cp FMODE_CREATE
 113+ 0A7B              	; jr z,fopen_c ;если режим создание файла
 114+ 0A7B              	; jp file_error ;иначе выход
 115+ 0A7B
 116+ 0A7B
 117+ 0A7B              fopen_r	;открытие существующего файла на чтение
 118+ 0A7B
 119+ 0A7B CD A1 0A     	call fopen_prep
 120+ 0A7E DA A2 0B     	jp 	c,file_error
 121+ 0A81
 122+ 0A81 32 1D 0D     	ld (file_fat_id_cur),a
 123+ 0A84              	R8FAT r8f07_FileOpen ;открыть
 123+ 0A84 0E 07       >	ld	c,r8f07_FileOpen
 123+ 0A86 CF          >	rst	#08
 123+ 0A87 91          >	db	#91
 124+ 0A88 DA A2 0B     	jp 	c,file_error
 125+ 0A8B
 126+ 0A8B
 127+ 0A8B C3 AE 0A     	jp fopen_ex
 128+ 0A8E
 129+ 0A8E
 130+ 0A8E              fopen_c	;создание нового файла
 131+ 0A8E
 132+ 0A8E CD A1 0A     	call fopen_prep
 133+ 0A91 DA A2 0B     	jp 	c,file_error
 134+ 0A94
 135+ 0A94
 136+ 0A94 32 1D 0D     	ld (file_fat_id_cur),a
 137+ 0A97              	R8FAT	r8f0E_CreateFileLFN	;создание файла
 137+ 0A97 0E 0E       >	ld	c,r8f0E_CreateFileLFN
 137+ 0A99 CF          >	rst	#08
 137+ 0A9A 91          >	db	#91
 138+ 0A9B DA A2 0B     	jp 	c,file_error
 139+ 0A9E
 140+ 0A9E C3 AE 0A     	jp fopen_ex
 141+ 0AA1
 142+ 0AA1
 143+ 0AA1              fopen_prep ;проверка перед открытием файла
 144+ 0AA1 3A BC 0C     	ld a,(fs_fat_init_flag)
 145+ 0AA4 B7           	or a
 146+ 0AA5 37           	scf
 147+ 0AA6 C8           	ret z
 148+ 0AA7
 149+ 0AA7 E5           	push hl
 150+ 0AA8 CD E3 0C     	call find_empty_fcb_fat ;какой fcb свободен?
 151+ 0AAB EB           	ex de,hl ;fcb in de
 152+ 0AAC E1           	pop hl
 153+ 0AAD C9           	ret ;выйти с флагом
 154+ 0AAE
 155+ 0AAE
 156+ 0AAE              fopen_ex
 157+ 0AAE              	;успешно создали/открыли
 158+ 0AAE D5           	push de
 159+ 0AAF DD E1        	pop ix ;вернуть fcb
 160+ 0AB1 21 D7 0D     	ld hl,fcb_fat_table
 161+ 0AB4 3A 1D 0D     	ld a,(file_fat_id_cur)
 162+ 0AB7 4F           	ld c,a
 163+ 0AB8 06 00        	ld b,0
 164+ 0ABA 09           	add hl,bc
 165+ 0ABB 3A 14 27     	ld a,(proc_id_cur)
 166+ 0ABE 77           	ld (hl),a ;флаг что файл открыт (id текущего процесса)
 167+ 0ABF
 168+ 0ABF              	;вернуть размер файла
 169+ 0ABF DD 4E 14     	ld	c,(ix+#14) ;младшие байты длины
 170+ 0AC2 DD 46 15     	ld	b,(ix+#15)
 171+ 0AC5
 172+ 0AC5 DD 5E 16     	ld	e,(ix+#16) ;старшие байты длины
 173+ 0AC8 DD 56 17     	ld  d,(ix+#17)
 174+ 0ACB
 175+ 0ACB 3A 1D 0D     	ld a,(file_fat_id_cur) ;вернуть id
 176+ 0ACE B7           	or a
 177+ 0ACF C9           	ret
 178+ 0AD0
 179+ 0AD0
 180+ 0AD0
 181+ 0AD0
 182+ 0AD0              init_fs_fat	;инициализация файловой системы
 183+ 0AD0              	; ld a,(fs_fat_init_flag) ;если в первый раз
 184+ 0AD0              	; or a
 185+ 0AD0              	; jr nz,init_fs_fat2
 186+ 0AD0 AF           	xor a
 187+ 0AD1 32 BC 0C     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 188+ 0AD4 3E 04        	ld a,4 ;номер дисковода по умолчанию E
 189+ 0AD6 32 5F 0C     	ld (fs_drive_number_cur),a
 190+ 0AD9 CD 6F 0C     	call GetNumPart ;узнаем какая буква последняя, сколько разделов FAT
 191+ 0ADC 30 0B        	jr nc,init_fs_fat_prn2
 192+ 0ADE B7           	or a
 193+ 0ADF 20 08        	jr nz,init_fs_fat_prn2
 194+ 0AE1 21 3F 0D     	ld hl,msg_fat_not_found
 195+ 0AE4 CD 0B 08     	call drvgmx.printZ
 196+ 0AE7 37           	scf ;ошибка
 197+ 0AE8 C9           	ret
 198+ 0AE9
 199+ 0AE9
 200+ 0AE9              init_fs_fat_prn2
 201+ 0AE9              	;печать списка разделов
 202+ 0AE9 21 1F 0D     	ld hl,msg_fat_found
 203+ 0AEC CD 0B 08     	call drvgmx.printZ
 204+ 0AEF 21 60 0C     	ld hl,typeDrive
 205+ 0AF2 3A 6D 0C     	ld a,(numDrives)
 206+ 0AF5 47           	ld b,a ;цикл по количеству разделов
 207+ 0AF6 0E 45        	ld c,"E" ;первая буква диска FAT
 208+ 0AF8              init_fs_fat_prn1
 209+ 0AF8 C5           	push bc
 210+ 0AF9 E5           	push hl
 211+ 0AFA 79           	ld a,c ;имя диска
 212+ 0AFB CD 16 08     	call drvgmx.putC
 213+ 0AFE 3E 3A        	ld a,":" ;
 214+ 0B00 CD 16 08     	call drvgmx.putC
 215+ 0B03              	;тип S или H
 216+ 0B03 3E 48        	ld a,"H"
 217+ 0B05 E1           	pop hl
 218+ 0B06 E5           	push hl
 219+ 0B07 CB 5E        	bit 3,(hl) ;SD?
 220+ 0B09 28 02        	jr z,init_fs_fat_prn3
 221+ 0B0B 3E 53        	ld a,"S"
 222+ 0B0D              init_fs_fat_prn3
 223+ 0B0D CD 16 08     	call drvgmx.putC ;первая буква
 224+ 0B10 3E 44        	ld a,"D"
 225+ 0B12 CD 16 08     	call drvgmx.putC ;вторая буква
 226+ 0B15              	;номер диска
 227+ 0B15 E1           	pop hl
 228+ 0B16 E5           	push hl
 229+ 0B17 7E           	ld a,(hl)
 230+ 0B18 E6 04        	and %00000100
 231+ 0B1A 0F           	rrca
 232+ 0B1B 0F           	rrca
 233+ 0B1C C6 30        	add "0"
 234+ 0B1E CD 16 08     	call drvgmx.putC ;номер диска
 235+ 0B21              	;номер раздела
 236+ 0B21 3E 2C        	ld a,","
 237+ 0B23 CD 16 08     	call drvgmx.putC ;разделитель
 238+ 0B26 E1           	pop hl
 239+ 0B27 E5           	push hl
 240+ 0B28 7E           	ld a,(hl)
 241+ 0B29 E6 03        	and %00000011
 242+ 0B2B C6 30        	add "0"
 243+ 0B2D CD 16 08     	call drvgmx.putC ;номер раздела
 244+ 0B30 3E 0D        	ld a,13 ;новая строка
 245+ 0B32 CD 16 08     	call drvgmx.putC
 246+ 0B35 E1           	pop hl
 247+ 0B36 23           	inc hl
 248+ 0B37 C1           	pop bc
 249+ 0B38 0C           	inc c
 250+ 0B39 10 BD        	djnz init_fs_fat_prn1
 251+ 0B3B
 252+ 0B3B
 253+ 0B3B              	;поиск системы и выбор диска
 254+ 0B3B 3A 6D 0C     	ld a,(numDrives)
 255+ 0B3E DD 6F        	ld ixl,a ;цикл по количеству разделов
 256+ 0B40 3A 5F 0C     	ld a,(fs_drive_number_cur)
 257+ 0B43              init_fs_fat_find_os_cl
 258+ 0B43 01 5C 0C     	ld bc,typeDrive-4
 259+ 0B46 6F           	ld l,a
 260+ 0B47 26 00        	ld h,0
 261+ 0B49 09           	add hl,bc
 262+ 0B4A 7E           	ld a,(hl) ;получили код раздела из списка
 263+ 0B4B
 264+ 0B4B CD 82 0B     	call init_fs_fat_warm ;выбрать раздел
 265+ 0B4E D8           	ret c
 266+ 0B4F
 267+ 0B4F              	;поиск пути в разделе
 268+ 0B4F 21 BD 0C     	ld	hl,OS_PathFAT		;путь к каталогу системы
 269+ 0B52 11 C2 0C     	ld	de,fcb_OS_PathFAT
 270+ 0B55 AF           	xor	a
 271+ 0B56 3D           	dec	a ;установить текущим
 272+ 0B57              	R8FAT	r8f04_FindPath
 272+ 0B57 0E 04       >	ld	c,r8f04_FindPath
 272+ 0B59 CF          >	rst	#08
 272+ 0B5A 91          >	db	#91
 273+ 0B5B 30 10        	jr nc,init_fs_fat_find_os_ok
 274+ 0B5D
 275+ 0B5D 3A 5F 0C     	ld a,(fs_drive_number_cur)
 276+ 0B60 3C           	inc a
 277+ 0B61 32 5F 0C     	ld (fs_drive_number_cur),a
 278+ 0B64 DD 2D        	dec ixl
 279+ 0B66 20 DB        	jr nz,init_fs_fat_find_os_cl
 280+ 0B68
 281+ 0B68
 282+ 0B68              	;не нашли ОС
 283+ 0B68 CD B2 0B         call   file_error_print_dir_not_found ;если не нашли, файл будет в корне
 284+ 0B6B 37           	scf
 285+ 0B6C C9           	ret
 286+ 0B6D              init_fs_fat_find_os_ok
 287+ 0B6D              	;нашли раздел с ОС
 288+ 0B6D 21 2C 0D     	ld hl,msg_fat_found_os
 289+ 0B70 CD 0B 08     	call drvgmx.printZ
 290+ 0B73 3A 5F 0C     	ld a,(fs_drive_number_cur)
 291+ 0B76 C6 41        	add a,"A"
 292+ 0B78 CD 16 08     	call drvgmx.putC
 293+ 0B7B 3E 0D        	ld a,13
 294+ 0B7D CD 16 08     	call drvgmx.putC
 295+ 0B80 B7           	or a
 296+ 0B81 C9           	ret
 297+ 0B82
 298+ 0B82
 299+ 0B82              init_fs_fat_warm
 300+ 0B82              ;переинициализация FAT раздела, когда разделы-диски уже найдены
 301+ 0B82              ;вх: a - код раздела
 302+ 0B82 32 1E 0D     	ld (fs_fat_part_code_cur),a ;запомнить текущий раздел
 303+ 0B85 AF           	xor a
 304+ 0B86 32 BC 0C     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 305+ 0B89 3A 1E 0D     	ld a,(fs_fat_part_code_cur)
 306+ 0B8C
 307+ 0B8C              	; R8FAT	r8f00_DeinitFAT
 308+ 0B8C              	; jp 		c,file_error
 309+ 0B8C
 310+ 0B8C
 311+ 0B8C              	R8FAT	r8f01_InitFAT ;инициализация
 311+ 0B8C 0E 01       >	ld	c,r8f01_InitFAT
 311+ 0B8E CF          >	rst	#08
 311+ 0B8F 91          >	db	#91
 312+ 0B90 D2 9B 0B         jp      nc,init_fs_fat3
 313+ 0B93 21 4F 0D     	ld hl,msg_fat_init_error
 314+ 0B96 CD 0B 08     	call drvgmx.printZ
 315+ 0B99 37           	scf
 316+ 0B9A C9           	ret
 317+ 0B9B
 318+ 0B9B              init_fs_fat3
 319+ 0B9B
 320+ 0B9B
 321+ 0B9B              ;получить текущий путь
 322+ 0B9B              	; ld	hl,#4000		;адрес буфера для размещения текущего пути (256 байт)
 323+ 0B9B              	; R8FAT	r8f13_GetPath ;получить путь
 324+ 0B9B
 325+ 0B9B              ;init_fs_fat_ex ;выход
 326+ 0B9B 3E 01        	ld a,1
 327+ 0B9D 32 BC 0C     	ld (fs_fat_init_flag),a
 328+ 0BA0 B7           	or a
 329+ 0BA1 C9           	ret
 330+ 0BA2
 331+ 0BA2
 332+ 0BA2
 333+ 0BA2
 334+ 0BA2
 335+ 0BA2
 336+ 0BA2              file_error ;выход с ошибкой
 337+ 0BA2 11 00 00     	ld de,0
 338+ 0BA5 01 00 00     	ld bc,0 ;длина 0
 339+ 0BA8 37           	scf ;ошибка
 340+ 0BA9 C9           	ret
 341+ 0BAA
 342+ 0BAA              file_error_general_print ;выход с общей ошибкой и сообщением
 343+ 0BAA 21 60 0D     	ld hl,msg_file_error_general
 344+ 0BAD CD 0B 08     	call drvgmx.printZ
 345+ 0BB0 37           	scf ;ошибка
 346+ 0BB1 C9           	ret
 347+ 0BB2
 348+ 0BB2              file_error_print_dir_not_found ;выход с ошибкой и сообщением
 349+ 0BB2 21 B1 0D     	ld hl,msg_dir_not_found
 350+ 0BB5 CD 0B 08     	call drvgmx.printZ
 351+ 0BB8 37           	scf ;ошибка
 352+ 0BB9 C9           	ret
 353+ 0BBA
 354+ 0BBA              file_error_print_file_too_big ;выход с ошибкой и сообщением
 355+ 0BBA 21 6D 0D     	ld hl,msg_file_too_big
 356+ 0BBD CD 0B 08     	call drvgmx.printZ
 357+ 0BC0 37           	scf ;ошибка
 358+ 0BC1 C9           	ret
 359+ 0BC2
 360+ 0BC2              file_error_print_file_not_found ;выход с ошибкой и сообщением
 361+ 0BC2 21 7C 0D     	ld hl,msg_file_not_found
 362+ 0BC5 CD 0B 08     	call drvgmx.printZ
 363+ 0BC8 37           	scf ;ошибка
 364+ 0BC9 C9           	ret
 365+ 0BCA
 366+ 0BCA              file_error_print_file_open_error ;выход с ошибкой и сообщением
 367+ 0BCA 21 8D 0D     	ld hl,msg_file_open_error
 368+ 0BCD CD 0B 08     	call drvgmx.printZ
 369+ 0BD0 37           	scf ;ошибка
 370+ 0BD1 C9           	ret
 371+ 0BD2
 372+ 0BD2              file_error_print_file_read_error ;выход с ошибкой и сообщением
 373+ 0BD2 21 9F 0D     	ld hl,msg_file_read_error
 374+ 0BD5 CD 0B 08     	call drvgmx.printZ
 375+ 0BD8 37           	scf ;ошибка
 376+ 0BD9 C9           	ret
 377+ 0BDA
 378+ 0BDA
 379+ 0BDA
 380+ 0BDA
 381+ 0BDA              ; A - file stream id
 382+ 0BDA              fclose:
 383+ 0BDA                  ;esxCall ESX_FCLOSE
 384+ 0BDA              	; push af
 385+ 0BDA              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 386+ 0BDA              	; pop af
 387+ 0BDA              	; cp 2 ;если обычный файл
 388+ 0BDA              	; jp nz,fclose_scl
 389+ 0BDA
 390+ 0BDA              close_fcb_fat ;закрытие fcb файла по номеру
 391+ 0BDA              ;вх: a - id файла
 392+ 0BDA              	;выход hl - fcb;
 393+ 0BDA 21 EF 0D     	ld hl,fcb_fat
 394+ 0BDD B7           	or a
 395+ 0BDE 28 07        	jr z,close_fcb_fat_ex
 396+ 0BE0 47           	ld b,a
 397+ 0BE1 11 20 00     	ld de,fcb_fat_size
 398+ 0BE4              close_fcb_fat_cl
 399+ 0BE4              	;вычислить адрес fcb
 400+ 0BE4 19           	add hl,de
 401+ 0BE5 10 FD        	djnz close_fcb_fat_cl
 402+ 0BE7              close_fcb_fat_ex
 403+ 0BE7 E5           	push hl
 404+ 0BE8 54           	ld d,h ;почистить fcb
 405+ 0BE9 5D           	ld e,l
 406+ 0BEA 13           	inc de
 407+ 0BEB 01 1F 00     	ld bc,fcb_fat_size-1
 408+ 0BEE 36 00        	ld (hl),0
 409+ 0BF0 ED B0        	ldir
 410+ 0BF2 21 D7 0D     	ld hl,fcb_fat_table
 411+ 0BF5 4F           	ld c,a
 412+ 0BF6 06 00        	ld b,0
 413+ 0BF8 09           	add hl,bc
 414+ 0BF9 36 00        	ld (hl),0 ;и флаг открытия fcb_fat_table
 415+ 0BFB E1           	pop hl
 416+ 0BFC C9           	ret
 417+ 0BFD
 418+ 0BFD
 419+ 0BFD
 420+ 0BFD
 421+ 0BFD              ; A - file stream id
 422+ 0BFD              ; DE - length
 423+ 0BFD              ; HL - buffer
 424+ 0BFD              ; Returns
 425+ 0BFD              ;  BC - length(how much was actually read)
 426+ 0BFD              fread: ;(id=1)
 427+ 0BFD                  ; push hl : pop ix
 428+ 0BFD                  ; esxCall ESX_FREAD
 429+ 0BFD
 430+ 0BFD ED 53 C7 0D  	ld (file_size_tmp),de
 431+ 0C01
 432+ 0C01 CD 35 0C     	call file_check_act ;проверка
 433+ 0C04 DA A2 0B     	jp c,file_error
 434+ 0C07
 435+ 0C07 ED 4B C7 0D  	ld bc,(file_size_tmp) ;размер
 436+ 0C0B 79           	ld a,c ;ba - количество байт для чтения
 437+ 0C0C
 438+ 0C0C              	R8FAT r8f08_FileRead	;читать файл
 438+ 0C0C 0E 08       >	ld	c,r8f08_FileRead
 438+ 0C0E CF          >	rst	#08
 438+ 0C0F 91          >	db	#91
 439+ 0C10 DA A2 0B     	jp c,file_error
 440+ 0C13
 441+ 0C13 ED 4B C7 0D  	ld bc,(file_size_tmp) ;размер
 442+ 0C17 B7           	or a
 443+ 0C18 C9           	ret
 444+ 0C19
 445+ 0C19
 446+ 0C19              ; A - file stream id
 447+ 0C19              ; BC - length
 448+ 0C19              ; HL - buffer
 449+ 0C19              ; Returns:
 450+ 0C19              ;   BC - actually written bytes
 451+ 0C19              fwrite: ;
 452+ 0C19                  ; push hl : pop ix
 453+ 0C19                  ; esxCall ESX_FWRITE
 454+ 0C19
 455+ 0C19               ;запись файла fat
 456+ 0C19 ED 53 C7 0D   	ld (file_size_tmp),de
 457+ 0C1D
 458+ 0C1D CD 35 0C     	call file_check_act ;проверка
 459+ 0C20 DA A2 0B     	jp c,file_error
 460+ 0C23
 461+ 0C23 ED 4B C7 0D  	ld bc,(file_size_tmp) ;размер
 462+ 0C27 79           	ld a,c ;ba - количество байт для записи
 463+ 0C28
 464+ 0C28              	R8FAT r8f09_FileWrite	;записать в файл
 464+ 0C28 0E 09       >	ld	c,r8f09_FileWrite
 464+ 0C2A CF          >	rst	#08
 464+ 0C2B 91          >	db	#91
 465+ 0C2C DA A2 0B     	jp c,file_error
 466+ 0C2F
 467+ 0C2F ED 4B C7 0D  	ld bc,(file_size_tmp) ;размер
 468+ 0C33 B7           	or a
 469+ 0C34 C9           	ret
 470+ 0C35              ;---------------------------------------
 471+ 0C35
 472+ 0C35              file_check_act
 473+ 0C35              ;проверка файла на актуальность
 474+ 0C35              ;вых: A - id, DE - fcb
 475+ 0C35 32 1D 0D     	ld (file_fat_id_cur),a ;сохранить id
 476+ 0C38
 477+ 0C38 3A BC 0C     	ld a,(fs_fat_init_flag)
 478+ 0C3B B7           	or a
 479+ 0C3C 37           	scf
 480+ 0C3D C8           	ret z ;выход если не инициализирована ФС
 481+ 0C3E
 482+ 0C3E E5           	push hl
 483+ 0C3F C5           	push bc
 484+ 0C40 3A 1D 0D     	ld a,(file_fat_id_cur)
 485+ 0C43 CD 05 0D     	call find_fcb_fat ;найти fcb
 486+ 0C46 EB           	ex de,hl ;fcb в de
 487+ 0C47 D5           	push de
 488+ 0C48 DD E1        	pop ix ;fcb
 489+ 0C4A C1           	pop bc
 490+ 0C4B 21 14 27     	ld hl,proc_id_cur ;сравнить с кодом текущего процесса, чтобы имел доступ только к своему файлу
 491+ 0C4E BE           	cp (hl)
 492+ 0C4F E1           	pop hl
 493+ 0C50 37           	scf
 494+ 0C51 C0           	ret nz
 495+ 0C52
 496+ 0C52 B7           	or a
 497+ 0C53 37           	scf
 498+ 0C54 C8           	ret z ;выход если файл не открыт
 499+ 0C55
 500+ 0C55
 501+ 0C55
 502+ 0C55 3A 1E 0D     	ld a,(fs_fat_part_code_cur) ;сравнить какой раздел у файла и какой активный
 503+ 0C58 DD BE 1F     	cp (ix+#1f)
 504+ 0C5B C4 82 0B     	call nz,init_fs_fat_warm ;переинициировать
 505+ 0C5E C9           	ret
 506+ 0C5F
 507+ 0C5F
 508+ 0C5F
 509+ 0C5F
 510+ 0C5F              ; A - file stream id
 511+ 0C5F              ; fsync:
 512+ 0C5F              ;     esxCall ESX_FSYNC
 513+ 0C5F                  ; ret
 514+ 0C5F
 515+ 0C5F
 516+ 0C5F              ; ; HL - name (name.ext)
 517+ 0C5F              ; ; Returns:
 518+ 0C5F              ; ; HL - name (name    e)
 519+ 0C5F              ; format_name ;подгоняет имя файла под стандарт trdos (8+1)
 520+ 0C5F
 521+ 0C5F              	; ;сначала попробуем убрать из пути подпапку, если она есть
 522+ 0C5F              	; ld (temp_hl),hl ;сохраним адрес исходного имени
 523+ 0C5F              	; ld b,#00 ;не больше 255 символов
 524+ 0C5F              ; format_name5
 525+ 0C5F              	; ld a,(hl)
 526+ 0C5F              	; cp "/" ;если есть подпапка
 527+ 0C5F              	; jr z,format_name_path_yep
 528+ 0C5F              	; ld a,(hl)
 529+ 0C5F              	; cp "." ;если ещё не дошли до расширения
 530+ 0C5F              	; jr nz,format_name6
 531+ 0C5F              	; ld hl,(temp_hl) ;если дошли до расширения, то путей нет, вернёмся на начало имени
 532+ 0C5F              	; jr format_name_7 ;на выход
 533+ 0C5F              ; format_name6
 534+ 0C5F              	; inc hl
 535+ 0C5F              	; djnz format_name5
 536+ 0C5F
 537+ 0C5F              ; format_name_path_yep ;нашли
 538+ 0C5F              	; inc hl ;пропустим знак "/"
 539+ 0C5F
 540+ 0C5F              ; format_name_7
 541+ 0C5F
 542+ 0C5F              	; push hl ;очистим место для нового имени
 543+ 0C5F              	; ld hl,f_name
 544+ 0C5F              	; ld de,f_name+1
 545+ 0C5F              	; ld (hl)," "
 546+ 0C5F              	; ld bc,8+1
 547+ 0C5F              	; ldir
 548+ 0C5F              	; ld (hl),0
 549+ 0C5F              	; ld bc,16-8-1-1
 550+ 0C5F              	; ldir
 551+ 0C5F              	; pop hl
 552+ 0C5F
 553+ 0C5F              	; ld bc,#09ff ;длина имени 9 символов
 554+ 0C5F              	; ld de,f_name ;куда
 555+ 0C5F              ; format_name2
 556+ 0C5F              	; ld a,(hl)
 557+ 0C5F              	; cp "."
 558+ 0C5F              	; jr nz,format_name1
 559+ 0C5F              	; ld de,f_name+8
 560+ 0C5F              	; inc hl
 561+ 0C5F              	; ldi ; и в конце расширение 3 буквы
 562+ 0C5F              	; ldi
 563+ 0C5F              	; ldi
 564+ 0C5F              	; ;ex de,hl ;сохраним адрес исходного расширения
 565+ 0C5F              	; jr format_name_e
 566+ 0C5F              ; format_name1
 567+ 0C5F              	; ldi
 568+ 0C5F              	; djnz format_name2
 569+ 0C5F
 570+ 0C5F              	; ;если имя длинное, пропустим лишнее до расширения
 571+ 0C5F              	; ld b,#00 ;не больше 255 символов
 572+ 0C5F              ; format_name3
 573+ 0C5F              	; ld a,(hl)
 574+ 0C5F              	; cp "."
 575+ 0C5F              	; jr nz,format_name4
 576+ 0C5F              	; ld de,f_name+8
 577+ 0C5F              	; inc hl
 578+ 0C5F              	; ldi ; и в конце расширение 3 буквы
 579+ 0C5F              	; ldi
 580+ 0C5F              	; ldi
 581+ 0C5F              	; ;ex de,hl ;сохраним адрес исходного расширения
 582+ 0C5F              	; jr format_name_e
 583+ 0C5F              ; format_name4
 584+ 0C5F              	; inc hl
 585+ 0C5F              	; djnz format_name3
 586+ 0C5F
 587+ 0C5F              ; format_name_e ;выход
 588+ 0C5F              	; ld hl,f_name ;вернём результат
 589+ 0C5F              	; ret
 590+ 0C5F
 591+ 0C5F              ; DE - trk/sec
 592+ 0C5F              ; B - sectors step
 593+ 0C5F              ; Returns:
 594+ 0C5F              ; DE - trk/sec
 595+ 0C5F              ; calc_next_pos		;вперёд на N секторов
 596+ 0C5F              			; ;ld b,4
 597+ 0C5F              			; ;ld  de,(#5ceb)
 598+ 0C5F              ; calc_next_pos2
 599+ 0C5F              			; inc e
 600+ 0C5F              			; ld a,e
 601+ 0C5F              			; cp 16
 602+ 0C5F              			; jr c,calc_next_pos1
 603+ 0C5F              			; inc d
 604+ 0C5F              			; ld e,0
 605+ 0C5F              ; calc_next_pos1
 606+ 0C5F              			; ;ld (#5ceb),de
 607+ 0C5F              			; djnz calc_next_pos2
 608+ 0C5F              			; ret
 609+ 0C5F
 610+ 0C5F
 611+ 0C5F              ;testt db "123.trd"
 612+ 0C5F              ; write_ima db "Select disk "
 613+ 0C5F              ; write_ima_d db "A: (E-" ;текущая буква
 614+ 0C5F              ; write_ima_e	db "D)> " ;последняя буква
 615+ 0C5F              		; db 13,10,0
 616+ 0C5F              ;prev_drive db 0 ;предыдущий номер дисковода
 617+ 0C5F 00           fs_drive_number_cur db 0 ;текущий диск/раздел
 618+ 0C60
 619+ 0C60              ; ; trdExt1 db ".trd", 0
 620+ 0C60              ; ; trdExt2 db ".TRD", 0
 621+ 0C60
 622+ 0C60              ; ; sclExt1 db ".scl", 0
 623+ 0C60              ; ; sclExt2 db ".SCL", 0
 624+ 0C60
 625+ 0C60              ; f_name ds 16 ;имя файла
 626+ 0C60              ; f_r_cur_trk dw 	 0 ;текущие сектор-дорожка файла на чтение
 627+ 0C60              ; f_r_len_sec db 0 ;длина файла на чтение в секторах
 628+ 0C60              ; f_r_len dw 0;длина файла в байтах
 629+ 0C60              ; f_r_flag db 0 ;флаг что открыт файл на чтение
 630+ 0C60
 631+ 0C60              ; f_w_cur_trk dw 	 0 ;текущие сектор-дорожка файла на запись
 632+ 0C60              ; f_w_len_sec db 0 ;длина файла на запись в секторах
 633+ 0C60              ; f_w_flag db 0 ;флаг что открыт файл на запись
 634+ 0C60              ; f_w_len ds 4 ;длина записанных данных
 635+ 0C60              ; write_end_flag db 0 ;флаг что нужно записать остаток
 636+ 0C60
 637+ 0C60              ; temp_bc dw 0 ;хранение регистра
 638+ 0C60              ; temp_hl dw 0 ;хранение регистра
 639+ 0C60              ; temp_hl2 dw 0 ;хранение регистра
 640+ 0C60
 641+ 0C60              ; sec_shift db 0 ;указатель на каком байте остановлена запись
 642+ 0C60              ; sec_shift2 db 0 ;указатель на каком байте остановлена запись (остаток)
 643+ 0C60              ; sec_part db 0 ;сколько секторов во второй порции для записи
 644+ 0C60              ; sec_shift_flag db 0 ;флаг что буфер сектора не заполнен
 645+ 0C60
 646+ 0C60              ; ;секция scl
 647+ 0C60              ; scl_sign db "SINCLAIR" ;метка
 648+ 0C60              ; scl_que db 0 ;флаг запроса порции данных
 649+ 0C60              ; scl_err db "SCL image error!",0
 650+ 0C60              ; scl_parse_ret_adr dw 0; адрес возврата в цикл
 651+ 0C60              ; scl_cat_cycl db 0 ;переменная цикла
 652+ 0C60              ; scl_files db 0 ;всего файлов
 653+ 0C60              ; scl_temp_hl dw 0;;хранение регистра
 654+ 0C60              ; scl_temp_hl2 dw 0;
 655+ 0C60              ; scl_temp_de dw 0;
 656+ 0C60              ; scl_temp_bc dw 0;
 657+ 0C60              ; cat_cur_adr dw 0;
 658+ 0C60              ; ;scl end
 659+ 0C60
 660+ 0C60              ; ;секция сохранения любого файла
 661+ 0C60              ; file_err db "Not enough space!",0
 662+ 0C60              ; sec_cat db 0 ;сектор каталога
 663+ 0C60              ; file_num db "0" ;номер части для больших файлов
 664+ 0C60
 665+ 0C60              	; ;по адресу #4000 шрифт
 666+ 0C60              ; cat_buf equ #4800 ;буфер для кататога диска 9*256
 667+ 0C60              ; sec_buf equ cat_buf + 9*256 ;буфер сектора для записи 256
 668+ 0C60              ; scl_buf equ sec_buf + 512 ;промежуточный буфер 256
 669+ 0C60              ; scl_buf2 equ scl_buf + 512 ;промежуточный буфер 256
 670+ 0C60              ; ;общая ошибка с файлами
 671+ 0C60              ; com_file_err db "File error!",0
 672+ 0C60              ;com_file_err_flag db 0 ;общая ошибка
 673+ 0C60
 674+ 0C60
 675+ 0C60
 676+ 0C60
 677+ 0C60              ;Раздел SMUC и SD ------------------------------------
 678+ 0C60
 679+ 0C60
 680+ 0C60              ;список доступных разделов на винчестерах
 681+ 0C60              ;7,=0/1 тип раздела MFS/FAT
 682+ 0C60              ;6,=1 раздел есть
 683+ 0C60              ;3,=0/1 Hdd/SD card
 684+ 0C60              ;2,=0/1 для HDD master/slave
 685+ 0C60              ;0..1,=?? номер раздела
 686+ 0C60              ;
 687+ 0C60 00 00 00...  typeDrive	ds 3*4+1
 688+ 0C6D              ;typeDriveFAT	ds 3*4+1 ;список всех разделов FAT
 689+ 0C6D 00           numDrives db 0 ;количество устройств
 690+ 0C6E              ;numDrivesFAT db 0 ;количество устройств FAT
 691+ 0C6E 00           next_lett db 0 ;следующая свободная буква диска
 692+ 0C6F
 693+ 0C6F              ;подсчет количества доступных разделов на всех устройствах
 694+ 0C6F              ;вых: hl,a - количество устройств
 695+ 0C6F              ;     typeDrives - сформированная таблица
 696+ 0C6F              ;     cy=1 не обнаружено ни одного устройства
 697+ 0C6F              ;
 698+ 0C6F              GetNumPart
 699+ 0C6F              ;
 700+ 0C6F D5           	push	de
 701+ 0C70 C5           	push	bc
 702+ 0C71 21 60 0C     	ld	hl,typeDrive
 703+ 0C74 E5           	push	hl
 704+ 0C75 AF           	xor	a
 705+ 0C76 CD 90 0C     	call	proc_01			;HDD master
 706+ 0C79 3E 01        	ld	a,#01
 707+ 0C7B CD 90 0C     	call	proc_01			;HDD slave
 708+ 0C7E 3E 02        	ld	a,#02
 709+ 0C80 CD 90 0C     	call	proc_01			;SD card
 710+ 0C83 D1           	pop	de
 711+ 0C84 B7           	or	a
 712+ 0C85 ED 52        	sbc	hl,de			;количество разделов на HDD
 713+ 0C87              	IFDEF	useTRD
 714+ 0C87 ~            	 ld	a,l
 715+ 0C87 ~            	 add	a,#04
 716+ 0C87 ~            	 ld	l,a
 717+ 0C87              	ELSE
 718+ 0C87 7D           	 ld	a,l
 719+ 0C88              	ENDIF
 720+ 0C88 C1           	pop	bc
 721+ 0C89 D1           	pop	de
 722+ 0C8A 32 6D 0C     	ld	(numDrives),a
 723+ 0C8D FE 01        	cp	1
 724+ 0C8F C9           	ret
 725+ 0C90
 726+ 0C90              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 727+ 0C90              ;формирование таблицы с доступными разделами на винчестере
 728+ 0C90              ;вх:  a =#00 выбрать master
 729+ 0C90              ;       =#01 выбрать slave
 730+ 0C90              ;       =#02 выбрать SD card
 731+ 0C90              ;     hl - адрес в таблице разделов typeDrives
 732+ 0C90              ;вых: hl - новый адрес в таблице разделов typeDrives
 733+ 0C90              ;
 734+ 0C90 4F           proc_01	ld	c,a
 735+ 0C91 E5           	push	hl
 736+ 0C92 C5           	push	bc
 737+ 0C93              	R8DOS	r8d2E_CngHDD
 737+ 0C93 0E 2E       >	ld	c,r8d2E_CngHDD
 737+ 0C95 CF          >	rst	#08
 737+ 0C96 81          >	db	#81
 738+ 0C97 38 04        	jr	c,goto001		;на текущем канале нет винчестера
 739+ 0C99              	R8DOS	r8d2D_FindPart
 739+ 0C99 0E 2D       >	ld	c,r8d2D_FindPart
 739+ 0C9B CF          >	rst	#08
 739+ 0C9C 81          >	db	#81
 740+ 0C9D C1           goto001	pop	bc
 741+ 0C9E E1           	pop	hl
 742+ 0C9F D8           	ret	c			;на текущем винчестере нет разделов
 743+ 0CA0 47           	ld	b,a
 744+ 0CA1 79           	ld	a,c
 745+ 0CA2 87           	add	a,a
 746+ 0CA3 87           	add	a,a
 747+ 0CA4 4F           	ld	c,a			;номер винчестера и первого раздела
 748+ 0CA5 78           	ld	a,b
 749+ 0CA6 06 04        	ld	b,#04
 750+ 0CA8 36 00        loop001	ld	(hl),#00
 751+ 0CAA 1F           	rra
 752+ 0CAB 30 0A        	jr	nc,goto002		;нет раздела
 753+ 0CAD              	IFDEF	useMFS
 754+ 0CAD ~            	 ld	(hl),c
 755+ 0CAD ~            	 set	6,(hl)			;=%01???hpp MFS
 756+ 0CAD ~            	 rra
 757+ 0CAD ~            	 jr	nc,goto003		;это MFS
 758+ 0CAD ~            	 set	7,(hl)			;=%11???hpp это FAT
 759+ 0CAD              	ELSE
 760+ 0CAD 1F           	 rra
 761+ 0CAE 30 08        	 jr	nc,goto004		;это MFS
 762+ 0CB0 71           	 ld	(hl),c
 763+ 0CB1 CB F6        	 set	6,(hl)			;раздел есть
 764+ 0CB3 CB FE        	 set	7,(hl)			;=%11???hpp это FAT
 765+ 0CB5              	ENDIF
 766+ 0CB5 23           goto003	inc	hl
 767+ 0CB6 17           	rla
 768+ 0CB7 1F           goto002	rra
 769+ 0CB8 0C           goto004	inc	c
 770+ 0CB9 10 ED        	djnz	loop001
 771+ 0CBB C9           	ret
 772+ 0CBC
 773+ 0CBC
 774+ 0CBC
 775+ 0CBC 00           fs_fat_init_flag: db 0 ;флаг инициализации
 776+ 0CBD              ;fcb_tmp ds fcb_fat_size ;буфер fcb временно
 777+ 0CBD 5C 4F 53 5A  OS_PathFAT db "\\OSZ",0 ;папка ОС
 777+ 0CC1 00
 778+ 0CC2 00 00 00...  fcb_OS_PathFAT ds fcb_fat_size	;буфер fcb
 779+ 0CE2 00           	nop
 780+ 0CE3              ;конец секции SMUC и SD ----------------------------
 781+ 0CE3
 782+ 0CE3
 783+ 0CE3              find_empty_fcb_fat ;поиск свободного fcb для файла
 784+ 0CE3              	;выход hl - fcb; a - file_id
 785+ 0CE3 21 D7 0D     	ld hl,fcb_fat_table
 786+ 0CE6 0E 00        	ld c,0 ;номер файла
 787+ 0CE8 06 08        	ld b,files_fat_max ;цикл
 788+ 0CEA              find_empty_fcb_fat_cl
 789+ 0CEA 7E           	ld a,(hl)
 790+ 0CEB B7           	or a
 791+ 0CEC 28 06        	jr z,find_empty_fcb_fat_ex
 792+ 0CEE 23           	inc hl
 793+ 0CEF 0C           	inc c
 794+ 0CF0 10 F8        	djnz find_empty_fcb_fat_cl
 795+ 0CF2              	;не нашли свободного
 796+ 0CF2 37           	scf
 797+ 0CF3 C9           	ret
 798+ 0CF4              find_empty_fcb_fat_ex
 799+ 0CF4              	;вычислить адрес fcb
 800+ 0CF4 21 EF 0D     	ld hl,fcb_fat
 801+ 0CF7 0C           	inc c
 802+ 0CF8 0D           	dec c
 803+ 0CF9 28 07        	jr z,find_empty_fcb_fat_ex1
 804+ 0CFB 11 20 00     	ld de,fcb_fat_size
 805+ 0CFE 41           	ld b,c
 806+ 0CFF              find_empty_fcb_fat_cl2
 807+ 0CFF 19           	add hl,de
 808+ 0D00 10 FD        	djnz find_empty_fcb_fat_cl2
 809+ 0D02              find_empty_fcb_fat_ex1
 810+ 0D02 79           	ld a,c ;file-id
 811+ 0D03 B7           	or a
 812+ 0D04 C9           	ret
 813+ 0D05
 814+ 0D05
 815+ 0D05              find_fcb_fat ;поиск fcb файла по номеру
 816+ 0D05              	;вх: a - id файла
 817+ 0D05              	;вых: hl - fcb; a - значение из fcb_fat_table
 818+ 0D05 21 EF 0D     	ld hl,fcb_fat
 819+ 0D08 B7           	or a
 820+ 0D09 28 07        	jr z,find_fcb_fat_ex
 821+ 0D0B 47           	ld b,a
 822+ 0D0C 11 20 00     	ld de,fcb_fat_size
 823+ 0D0F              find_fcb_fat_cl
 824+ 0D0F              	;вычислить адрес fcb
 825+ 0D0F 19           	add hl,de
 826+ 0D10 10 FD        	djnz find_fcb_fat_cl
 827+ 0D12              find_fcb_fat_ex
 828+ 0D12 E5           	push hl
 829+ 0D13 21 D7 0D     	ld hl,fcb_fat_table
 830+ 0D16 4F           	ld c,a
 831+ 0D17 06 00        	ld b,0
 832+ 0D19 09           	add hl,bc
 833+ 0D1A 7E           	ld a,(hl) ;вернуть флаг
 834+ 0D1B E1           	pop hl
 835+ 0D1C C9           	ret
 836+ 0D1D
 837+ 0D1D
 838+ 0D1D
 839+ 0D1D
 840+ 0D1D
 841+ 0D1D 00           file_fat_id_cur db 0 ;текущий файл id
 842+ 0D1E 00           fs_fat_part_code_cur db 0 ;текущий раздел
 843+ 0D1F 46 6F 75 6E  msg_fat_found db "Found FAT:",13,10,0
 843+ 0D23 64 20 46 41
 843+ 0D27 54 3A 0D 0A
 843+ 0D2B 00
 844+ 0D2C 46 6F 75 6E  msg_fat_found_os db "Found OS on disk: ",0
 844+ 0D30 64 20 4F 53
 844+ 0D34 20 6F 6E 20
 844+ 0D38 64 69 73 6B
 844+ 0D3C 3A 20 00
 845+ 0D3F 46 41 54 20  msg_fat_not_found db "FAT not found",13,10,0
 845+ 0D43 6E 6F 74 20
 845+ 0D47 66 6F 75 6E
 845+ 0D4B 64 0D 0A 00
 846+ 0D4F 46 41 54 20  msg_fat_init_error db "FAT init_error",13,10,0
 846+ 0D53 69 6E 69 74
 846+ 0D57 5F 65 72 72
 846+ 0D5B 6F 72 0D 0A
 846+ 0D5F 00
 847+ 0D60 46 69 6C 65  msg_file_error_general db "File error",13,10,0
 847+ 0D64 20 65 72 72
 847+ 0D68 6F 72 0D 0A
 847+ 0D6C 00
 848+ 0D6D 46 69 6C 65  msg_file_too_big db "File too_big",13,10,0
 848+ 0D71 20 74 6F 6F
 848+ 0D75 5F 62 69 67
 848+ 0D79 0D 0A 00
 849+ 0D7C 46 69 6C 65  msg_file_not_found db "File not found",13,10,0
 849+ 0D80 20 6E 6F 74
 849+ 0D84 20 66 6F 75
 849+ 0D88 6E 64 0D 0A
 849+ 0D8C 00
 850+ 0D8D 46 69 6C 65  msg_file_open_error db "File open error",13,10,0
 850+ 0D91 20 6F 70 65
 850+ 0D95 6E 20 65 72
 850+ 0D99 72 6F 72 0D
 850+ 0D9D 0A 00
 851+ 0D9F 46 69 6C 65  msg_file_read_error db "File read error",13,10,0
 851+ 0DA3 20 72 65 61
 851+ 0DA7 64 20 65 72
 851+ 0DAB 72 6F 72 0D
 851+ 0DAF 0A 00
 852+ 0DB1 44 69 72 65  msg_dir_not_found db "Directory not found",13,10,0
 852+ 0DB5 63 74 6F 72
 852+ 0DB9 79 20 6E 6F
 852+ 0DBD 74 20 66 6F
 852+ 0DC1 75 6E 64 0D
 852+ 0DC5 0A 00
 853+ 0DC7 00 00        file_size_tmp dw 0 ;временно
 854+ 0DC9
 855+ 0DC9 66 63 62 5F  	db "fcb_fat_table:"
 855+ 0DCD 66 61 74 5F
 855+ 0DD1 74 61 62 6C
 855+ 0DD5 65 3A
 856+ 0DD7 00 00 00...  fcb_fat_table ds files_fat_max ;флаги открытия файлов
 857+ 0DDF 00 00 00...  fcb_trd_table ds files_trd_max ;флаги открытия файлов
 858+ 0DE7 66 63 62 5F  	db "fcb_fat:"
 858+ 0DEB 66 61 74 3A
 859+ 0DEF 00 00 00...  fcb_fat ds fcb_fat_size*files_fat_max ;для файлов fat
 860+ 0EEF 00 00 00...  fcb_trd ds fcb_fat_size*files_trd_max ;для файлов trd
 861+ 0FEF
 862+ 0FEF
 863+ 0FEF
 864+ 0FEF                  ENDMODULE
# file closed: Drv/zsfat.asm
1802  0FEF              	include Drv/DrvKey.main.a80 ;драйвер клавиатуры
# file opened: Drv/DrvKey.main.a80
   1+ 0FEF              ;ࠩ  
   2+ 0FEF              ;Driver Keyboard v2.10
   3+ 0FEF              ;(c) 2002-2024 LW aka PLM
   4+ 0FEF              ;
   5+ 0FEF              ;Date Creating: 10.07.2002
   6+ 0FEF              ;Last   Update: 17.01.2024
   7+ 0FEF              ;Last  Edition: 17.01.2024
   8+ 0FEF              ;
   9+ 0FEF              ;:
  10+ 0FEF              ;DrvKey.main.a80	-  䠩
  11+ 0FEF              ;DrvKey.asm.a80		- 楤
  12+ 0FEF              ;DrvKey.var.a80		- ६
  13+ 0FEF              ;DrvKey.info		- ଠ  ࠩ
  14+ 0FEF              ;DrvKey.lua.a80		- LUA
  15+ 0FEF              ;
  16+ 0FEF              ;------------------------------------------------------------------------------
  17+ 0FEF              ; 樨
  18+ 0FEF              ;	DEVICE 	ZXSPECTRUM128
  19+ 0FEF              ;	INCLUDE "DrvKey.lua.a80"
  20+ 0FEF              ;	PAGE	#XX
  21+ 0FEF              	MODULE	DrvKey
  22+ 0FEF
  23+ 0FEF              ;------------------------------------------------------------------------------
  24+ 0FEF              ;⠭ ࠩ
  25+ 0FEF
  26+ 0FEF              ; ᥬ஢:
  27+ 0FEF              AdrDrvKeyboard	equ $ ;#XXXX
  28+ 0FEF
  29+ 0FEF              ;   
  30+ 0FEF              keyLeft		equ #08
  31+ 0FEF              keyRight	equ #09
  32+ 0FEF              keyUp		equ #0B
  33+ 0FEF              keyDown		equ #0A
  34+ 0FEF
  35+ 0FEF              ;࠭ /
  36+ 0FEF              keyPageDown	equ #05
  37+ 0FEF              keyPageUp	equ #04
  38+ 0FEF
  39+ 0FEF              ;/砫 ப, insert
  40+ 0FEF              keyHome		equ #01
  41+ 0FEF              keyEnd		equ #03
  42+ 0FEF              keyInsert	equ #02
  43+ 0FEF
  44+ 0FEF              ;⥬ 
  45+ 0FEF              keyBreak	equ #18
  46+ 0FEF              keyEdit		equ #07
  47+ 0FEF              keyCaps		equ #06
  48+ 0FEF              keyBackSpace	equ #0C
  49+ 0FEF              keyDelete	equ #0F
  50+ 0FEF              keyEnter	equ #0D
  51+ 0FEF
  52+ 0FEF              ;CapsShift/SymbolShift   樨
  53+ 0FEF              keyCS		equ #1C
  54+ 0FEF              keySS		equ #1D
  55+ 0FEF              keyCsEnter	equ #19
  56+ 0FEF              keySsSpace	equ #1A		;tab
  57+ 0FEF              keySsEnter	equ #1B
  58+ 0FEF              keyExtMode	equ #0E
  59+ 0FEF
  60+ 0FEF              ;  ० EXT mode (cs+ss+key)
  61+ 0FEF              keyWordLeft	equ #10
  62+ 0FEF              keyWordRight	equ #11
  63+ 0FEF              keyGrf		equ #12
  64+ 0FEF              keyDelEnd	equ #13
  65+ 0FEF              keyDelBegin	equ #16
  66+ 0FEF              keyCsSsSpace	equ #14
  67+ 0FEF              keyCsSsEnter	equ #15
  68+ 0FEF              ;free code: #00,#17,#1E,#1F
  69+ 0FEF
  70+ 0FEF              ; 譨 ⠡  ᪫ 
  71+ 0FEF              ;OutsideGrfTable		equ #XXXX ;#0000
  72+ 0FEF              ;OutsideRus_jcuken	equ #XXXX ;#0000
  73+ 0FEF              ;OutsideRus_qwerty	equ #XXXX ;#0000
  74+ 0FEF
  75+ 0FEF              ;------------------------------------------------------------------------------
  76+ 0FEF              ;᫮ ࠭樨
  77+ 0FEF
  78+ 0FEF              ; ᯮ짮 /  48k
  79+ 0FEF              	;DEFINE	Used_ROM ;
  80+ 0FEF              	DEFINE	UseEXTkeys	;ᯮ짮 権 cs+ss+key
  81+ 0FEF              	DEFINE	CommandMode	;ᯮ짮  ०
  82+ 0FEF              	IFDEF	Used_ROM
  83+ 0FEF ~            	UNDEFINE UseEXTkeys
  84+ 0FEF              	ENDIF
  85+ 0FEF
  86+ 0FEF              ;祭 ᪫ 
  87+ 0FEF              	DEFINE	GrfMode		;ᯮ짮 ᪫ grf
  88+ 0FEF              	DEFINE	RusMode		;ᯮ짮 ᪫ rus
  89+ 0FEF
  90+ 0FEF              ;祭 ⠡ ᪫
  91+ 0FEF              	DEFINE	TblKeyGrf_ver1
  92+ 0FEF              	DEFINE	Rus_jcuken
  93+ 0FEF              	DEFINE	Rus_qwerty
  94+ 0FEF
  95+ 0FEF              ;祭 ⠡ EXT+key (command mode)
  96+ 0FEF              ;  ᯮ짮 ⮫쪮 
  97+ 0FEF              	IFDEF	UseEXTkeys
  98+ 0FEF              	DEFINE	TblEXTkey_Test	;⮢ ᪫
  99+ 0FEF              ;	DEFINE	TblEXTkey_Word	; ZX-Word
 100+ 0FEF              	ENDIF
 101+ 0FEF
 102+ 0FEF              ;  ᯮ ७ ⠡ ᪫ 
 103+ 0FEF              	DEFINE	InsideGrfTable
 104+ 0FEF              	DEFINE	InsideRusTable
 105+ 0FEF
 106+ 0FEF              ;祭 㭪樨 ࠩ
 107+ 0FEF              ;	DEFINE  NoFuncDrvKey	; 楤 맮 㭪権 ࠩ
 108+ 0FEF              	DEFINE	NoCtlDrvKey	; ஢ન  ⢮ 㭪樨
 109+ 0FEF              	DEFINE	DrvKey_02	;⠭/祭 䫠 ࠩ
 110+ 0FEF              	DEFINE	DrvKey_03	;⠭ ਮ প  ⮯
 111+ 0FEF              	DEFINE	DrvKey_04	;祭 ਮ প  ⮯
 112+ 0FEF
 113+ 0FEF              ;------------------------------------------------------------------------------
 114+ 0FEF
 115+ 0FEF              	ORG	AdrDrvKeyboard
 116+ 0FEF              Start	INCLUDE	"DrvKey.asm.a80"
# file opened: Drv/DrvKey.asm.a80
   1++0FEF              ;楤  Keyboard Driver
   2++0FEF              ;䠩 DrvKey.asm.a80
   3++0FEF              ;
   4++0FEF              ;DriverKeyboard		맮 ࠩ 
   5++0FEF              ;FunctDrvKeyboard	맮 㭪樨 ࠩ 
   6++0FEF              ;GetCodesPressKey	祭  ⮩ 
   7++0FEF              ;GetRepeatDelays	祭 ਮ প  ⮯
   8++0FEF              ;SetRepeatDelays	⠭ ਮ প  ⮯
   9++0FEF              ;SetFlagsDriver		⠭/祭 䫠 ࠩ
  10++0FEF              ;ScanKeyboardDelay	   ⮬ ६ থ
  11++0FEF              ;ScanKeyboard		   
  12++0FEF              ;ScanAllKeys		   
  13++0FEF              ;
  14++0FEF              ;------------------------------------------------------------------------------
  15++0FEF              ;------------------------------------------------------------------------------
  16++0FEF              ;맮 ࠩ 
  17++0FEF              ;: 6,(FlgScanKeys) =1 -     
  18++0FEF              ;     hl=FlgScanKeys
  19++0FEF              ;     d - ᪠ ⮩ 
  20++0FEF              ;     a,e -   ⮩   ⥪饩 ᪫ 
  21++0FEF              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  22++0FEF              ;     bc -  ।
  23++0FEF              ;
  24++0FEF C3 27 10     @DriverKeyboard		jp	ScanKeyboardDelay
  25++0FF2
  26++0FF2              ;------------------------------------------------------------------------------
  27++0FF2              	IFNDEF	NoFuncDrvKey
  28++0FF2              ;맮 㭪樨 ࠩ 
  29++0FF2              ;:  c -  㭪樨 [#00..#04]
  30++0FF2              ;     hl,de,b,a - ࠬ 㭪樨
  31++0FF2              ;: ॣ ⠭  ⢥⢨  뢠 㭪樥
  32++0FF2              ;
  33++0FF2              @FunctDrvKeyboard
  34++0FF2              ;
  35++0FF2              	IFDEF	NoCtlDrvKey
  36++0FF2 E5           	 push	hl
  37++0FF3 F5           	 push	af
  38++0FF4 78           	 ld	a,b
  39++0FF5 06 00        	 ld	b,#00
  40++0FF7 21 04 10     	 ld	hl,TableAdrFunct
  41++0FFA 09           	 add	hl,bc
  42++0FFB 09           	 add	hl,bc
  43++0FFC 47           	 ld	b,a
  44++0FFD 7E           	 ld	a,(hl)
  45++0FFE 23           	 inc	hl
  46++0FFF 66           	 ld	h,(hl)
  47++1000 6F           	 ld	l,a
  48++1001 F1           	 pop	af
  49++1002 E3           	 ex	(sp),hl
  50++1003 C9           	 ret
  51++1004              	ELSE
  52++1004 ~            	 push	hl
  53++1004 ~            	 push	af
  54++1004 ~            	 ld	a,c
  55++1004 ~            	 cp	#05
  56++1004 ~            	 jr	nc,goto017		;騩  㭪樨
  57++1004 ~            	 ld	a,b
  58++1004 ~            	 ld	hl,TableAdrFunct
  59++1004 ~            	 ld	b,#00
  60++1004 ~            	 add	hl,bc
  61++1004 ~            	 add	hl,bc
  62++1004 ~            	 ld	b,a
  63++1004 ~            	 ld	a,(hl)
  64++1004 ~            	 inc	hl
  65++1004 ~            	 ld	h,(hl)
  66++1004 ~            	 ld	l,a
  67++1004 ~            	 and	h
  68++1004 ~            	 inc	a
  69++1004 ~            	 jr	z,goto017		;㭪  
  70++1004 ~            	 pop	af
  71++1004 ~            	 ex	(sp),hl
  72++1004 ~            	 ret
  73++1004 ~            goto017	 pop	af
  74++1004 ~            	 pop	hl
  75++1004 ~            	 ret
  76++1004              	ENDIF
  77++1004
  78++1004              	ENDIF
  79++1004
  80++1004              ;------------------------------------------------------------------------------
  81++1004              TableAdrFunct	ifused
  82++1004              ;⠡ ᮢ 㭪権 ࠩ
  83++1004              ;TableAdrFunct
  84++1004              ;
  85++1004 63 10        		  dw ScanKeyboard
  86++1006 0E 10        		  dw GetCodesPressKey
  87++1008               IFDEF DrvKey_02
  87++1008 1E 10          dw SetFlagsDriver
  87++100A                 ELSE
  87++100A ~              dw #FFFF
  87++100A               ENDIF
  88++100A               IFDEF DrvKey_03
  88++100A 19 10          dw SetRepeatDelays
  88++100C                ELSE
  88++100C ~              dw #FFFF
  88++100C               ENDIF
  89++100C               IFDEF DrvKey_04
  89++100C 14 10          dw GetRepeatDelays
  89++100E                ELSE
  89++100E ~              dw #FFFF
  89++100E               ENDIF
  90++100E              		endif
  91++100E
  92++100E              ;------------------------------------------------------------------------------
  93++100E              GetCodesPressKey	ifused
  94++100E              ;祭  ⮩ 
  95++100E              ;:  ----
  96++100E              ;: d - ᪠ ⮩ 
  97++100E              ;     a,e -   ⮩   ⥪饩 ᪫ 
  98++100E              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  99++100E              ;
 100++100E              ;GetCodesPressKey
 101++100E              ;
 102++100E ED 5B FB 12  	ld	de,(PrintCodePresKey)
 103++1012 7B           	ld	a,e
 104++1013 C9           	ret
 105++1014
 106++1014              	endif
 107++1014
 108++1014              ;------------------------------------------------------------------------------
 109++1014              GetRepeatDelays	ifused
 110++1014              ;祭 ਮ প  ⮯
 111++1014              ;:  ----
 112++1014              ;: d - ਮ ⮯
 113++1014              ;     e - প । ⮯஬
 114++1014              ;
 115++1014              ;GetRepeatDelays
 116++1014              ;
 117++1014 ED 5B F9 12  	ld      de,(KeyRepeatDelay)
 118++1018 C9           	ret
 119++1019
 120++1019              	endif
 121++1019
 122++1019              ;------------------------------------------------------------------------------
 123++1019              SetRepeatDelays	ifused
 124++1019              ;⠭ ਮ প  ⮯
 125++1019              ;:  d - ਮ ⮯
 126++1019              ;     e - প । ⮯஬
 127++1019              ;: ॣ  
 128++1019              ;
 129++1019              ;SetRepeatDelays
 130++1019              ;
 131++1019 ED 53 F9 12  	ld	(KeyRepeatDelay),de
 132++101D C9           	ret
 133++101E
 134++101E              	endif
 135++101E
 136++101E              ;------------------------------------------------------------------------------
 137++101E              SetFlagsDriver	ifused
 138++101E              ;e⠭/祭 䫠 ࠩ
 139++101E              ;:  d - ᪠ 䫠
 140++101E              ;     e - 塞 䫠
 141++101E              ;: a - 䫠 ࠩ
 142++101E              ;
 143++101E              ;SetFlagsDriver
 144++101E              ;
 145++101E 3A F7 12     	ld	a,(FlgScanKeys)
 146++1021 A2           	and	d
 147++1022 B3           	or	e
 148++1023 32 F7 12     	ld	(FlgScanKeys),a
 149++1026 C9           	ret
 150++1027
 151++1027              	endif
 152++1027
 153++1027              ;------------------------------------------------------------------------------
 154++1027              ;   ⮬ ६ থ
 155++1027              ;:  (PrintCodePresKey) -   ⮩ 
 156++1027              ;: 6,(FlgScanKeys) =1 -     
 157++1027              ;     hl=FlgScanKeys
 158++1027              ;     d - ᪠ ⮩ 
 159++1027              ;     a,e -   ⮩   ⥪饩 ᪫ 
 160++1027              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
 161++1027              ;     bc -  ।
 162++1027              ;
 163++1027              ScanKeyboardDelay
 164++1027              ;
 165++1027 CD 63 10     	call	ScanKeyboard		;a=(PrintCodePresKey)
 166++102A 21 F7 12     	ld	hl,FlgScanKeys
 167++102D CB F6        	set	6,(hl)
 168++102F              ;	ld	a,(PrintCodePresKey)
 169++102F FE FF        	cp	#FF
 170++1031 28 24        	jr	z,goto012		;  
 171++1033 FE 00        cng_01	cp	#00
 172++1035 20 1E        	jr	nz,goto013		; 㣠 
 173++1037 ED 4B F9 12  	ld	bc,(KeyRepeatDelay)
 174++103B 11 00 00     cng_02	ld	de,#0000
 175++103E 1C           	inc	e
 176++103F 20 01        	jr	nz,goto014
 177++1041 1D           	dec	e
 178++1042 7B           goto014	ld	a,e
 179++1043 B9           	cp	c
 180++1044 20 17        	jr	nz,goto015		;প  ⮯
 181++1046 1D           	dec	e
 182++1047 14           	inc	d
 183++1048 20 01        	jr	nz,goto016
 184++104A 15           	dec	d
 185++104B 7A           goto016	ld	a,d
 186++104C B8           	cp	b
 187++104D 38 0E        	jr	c,goto015
 188++104F 16 00        	ld	d,#00
 189++1051 CB B6        	res	6,(hl)
 190++1053 18 08        	jr	goto015
 191++1055 CB B6        goto013 res     6,(hl)
 192++1057 32 34 10     goto012	ld	(cng_01+1),a
 193++105A 11 00 00     	ld	de,#0000
 194++105D ED 53 3C 10  goto015	ld	(cng_02+1),de
 195++1061 18 AB        	jr	GetCodesPressKey
 196++1063
 197++1063              ;------------------------------------------------------------------------------
 198++1063              ;     樥 ⭮ 
 199++1063              ;:  (FlgScanKeys) - 䫠
 200++1063              ;: (ScanCodePresKey) - ᪠ ⮩ 
 201++1063              ;     a -   ⮩ 
 202++1063              ;     (PrintCodePresKey) -   ⮩   ⥪饩 ᪫
 203++1063              ;        (Grf\Rus\Lat)  ⮬ ० CapsLock
 204++1063              ;     7,(FlgScanKeys) =1 ⨬ 
 205++1063              ;     hl,de,bc,a -  ।
 206++1063              ;
 207++1063              ScanKeyboard
 208++1063              ;
 209++1063              ; 
 210++1063              	IFDEF	Used_ROM
 211++1063 ~            	 call	#028E
 212++1063              	ELSE
 213++1063 CD F2 10     	 call	ScanAllKeys
 214++1066              	ENDIF
 215++1066 21 F7 12     	ld	hl,FlgScanKeys
 216++1069 CB AE        	res	5,(hl)
 217++106B CB BE        	res	7,(hl)
 218++106D 28 04        	jr	z,goto006		; - 
 219++106F 1E FF        goto021	ld	e,#FF
 220++1071 CB FE        	set	7,(hl)			;⨬ 
 221++1073
 222++1073              ;室, ᫨     
 223++1073 7B           goto006	ld	a,e
 224++1074 32 FC 12     	ld	(ScanCodePresKey),a
 225++1077 3C           	inc	a
 226++1078 28 73        	jr	z,goto011
 227++107A
 228++107A              ;  ० ⮫쪮  cs+ss
 229++107A E5           	push	hl
 230++107B 4E           	ld	c,(hl)			;c=(FlgScanKeys)
 231++107C              	IFDEF	CommandMode
 232++107C CB 41        	 bit	0,c
 233++107E 28 02        	 jr	z,goto018		;몫祭 Command Mode
 234++1080              	 IFDEF	Used_ROM
 235++1080 ~            	  ld	a,d
 236++1080 ~            	  cp	#18
 237++1080 ~            	  jr	z,goto019		; SS
 238++1080              	 ELSE
 239++1080 CB 8A        	  res	1,d			; SS
 240++1082              	 ENDIF
 241++1082              	ENDIF
 242++1082
 243++1082              ;塞    ⨭᪮ ᪫  ᪠ 
 244++1082 7A           goto018	ld	a,d
 245++1083              	IFDEF	Used_ROM
 246++1083 ~            	 ld	hl,tableSSkeys
 247++1083 ~            	 cp	#18
 248++1083 ~            	 jr	z,goto007		; ⮩ ss
 249++1083 ~            	 ld	hl,tableCSkeys
 250++1083 ~            	 cp	#27
 251++1083 ~            	 jr	z,goto007		; ⮩ cs
 252++1083 ~            goto019	 ld	hl,tablePrnKeys
 253++1083              	ELSE
 254++1083 21 87 11     	 ld	hl,tableSSkeys
 255++1086 FE 02        	 cp	#02
 256++1088 28 12        	 jr	z,goto007		; ⮩ ss
 257++108A              	 IFDEF	UseEXTkeys
 258++108A 21 AF 11     	  ld	hl,tableEXTKeys
 259++108D CB E9        	  set	5,c			;  cs+ss
 260++108F 30 0B        	  jr	nc,goto007		; ⮩ cs+ss
 261++1091 CB A9        	  res	5,c
 262++1093              	 ENDIF
 263++1093 21 5F 11     	 ld	hl,tableCSkeys
 264++1096 B7           	 or	a
 265++1097 20 03        	 jr	nz,goto007		; ⮩ cs
 266++1099 21 37 11     	 ld	hl,tablePrnKeys
 267++109C              	ENDIF
 268++109C 16 00        goto007	ld	d,#00
 269++109E 19           	add	hl,de
 270++109F 5E           	ld	e,(hl)			; 
 271++10A0 E1           	pop	hl
 272++10A1 71           	ld	(hl),c
 273++10A2 7B           	ld	a,e
 274++10A3 3C           	inc	a
 275++10A4 28 C9        	jr	z,goto021
 276++10A6              ;de -   ⮩   ⨭᪮ ᪫   ० Caps
 277++10A6
 278++10A6              ;᫨ 祭  ० ⠭ ᨬ  孨 ॣ
 279++10A6              	IFDEF	CommandMode
 280++10A6 79           	 ld	a,c
 281++10A7 E6 21        	 and	%00100001
 282++10A9 20 0D        	 jr	nz,goto020		;祭 Command Mode
 283++10AB              	ENDIF
 284++10AB
 285++10AB              ;४ ⭮   ⮬ ० CapsLock
 286++10AB 7B           	ld	a,e
 287++10AC CB 49        	bit	1,c
 288++10AE 28 13        	jr	z,goto008		;caps 몫祭
 289++10B0 FE 41        	cp	"A"
 290++10B2 38 0F        	jr	c,goto008
 291++10B4 FE 5B        	cp	"Z"+1
 292++10B6 38 09        	jr	c,goto009
 293++10B8              	IFDEF	CommandMode
 294++10B8 7B           goto020	 ld	a,e
 295++10B9              	ENDIF
 296++10B9 FE 61        	cp	"a"
 297++10BB 38 06        	jr	c,goto008
 298++10BD FE 7B        	cp	"z"+1
 299++10BF 30 02        	jr	nc,goto008
 300++10C1 EE 20        goto009	xor	%00100000
 301++10C3 5F           goto008	ld	e,a
 302++10C4              ;de,a -   ⮩   ⨭᪮ ᪫
 303++10C4
 304++10C4              ; ८ࠧ, ᫨ 祭  ०
 305++10C4              	IFDEF	CommandMode
 306++10C4 79           	 ld	a,c
 307++10C5 E6 21        	 and	%00100001
 308++10C7 7B           	 ld	a,e
 309++10C8 20 23        	 jr	nz,goto011		;祭 Command Mode
 310++10CA              	ENDIF
 311++10CA
 312++10CA              ;⠭ ⭮   ᮮ⢥⢨  祭 ᪫: Grf\Rus\Lat
 313++10CA              ;  grf ᪫
 314++10CA              	IFDEF	GrfMode
 315++10CA              	 IFDEF	InsideGrfTable
 316++10CA FE 20        	  cp	#20
 317++10CC 38 1F        	  jr	c,goto011
 318++10CE              	 ENDIF
 319++10CE 21 B7 11     	 ld	hl,TblKeyGrf
 320++10D1 CB 51        	 bit	2,c
 321++10D3 20 16        	 jr	nz,goto010		;祭 Grf
 322++10D5              	ENDIF
 323++10D5              ;  rus ᪫
 324++10D5              	IFDEF	RusMode
 325++10D5 CB 59        	 bit	3,c
 326++10D7 28 14        	 jr	z,goto011		;᪫ rus 몫祭
 327++10D9              	 IFDEF	InsideRusTable
 328++10D9 FE 20        	  cp	#20
 329++10DB 38 10        	  jr	c,goto011
 330++10DD              	 ENDIF
 331++10DD              	 IFDEF	Rus_jcuken
 332++10DD 21 77 12     	  ld	hl,TblKeyRus_jcuken
 333++10E0              	  IFDEF	Rus_qwerty
 334++10E0 CB 61        	   bit	4,c
 335++10E2 20 07        	   jr	nz,goto010		;祭 ᪫ Rus 㪥
 336++10E4              	  ENDIF
 337++10E4              	 ENDIF
 338++10E4              	 IFDEF	Rus_qwerty
 339++10E4 21 17 12     	  ld	hl,TblKeyRus_qwerty
 340++10E7              	 ENDIF
 341++10E7 18 02        	 jr	goto010
 342++10E9              	ENDIF
 343++10E9 18 02        	jr	goto011
 344++10EB 19           goto010	add	hl,de
 345++10EC 5E           	ld	e,(hl)
 346++10ED              ;e -   ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
 347++10ED              ;     ⮬ ० CapsLock
 348++10ED
 349++10ED 7B           goto011 ld      a,e
 350++10EE 32 FB 12             ld      (PrintCodePresKey),a
 351++10F1 C9                   ret
 352++10F2
 353++10F2              ;------------------------------------------------------------------------------
 354++10F2              ScanAllKeys	ifused
 355++10F2              ;    ( /  48k #028E)
 356++10F2              ;ਬ砭: ⠡ ScanCode
 357++10F2              ;Ŀ
 358++10F2              ; 1  2  3  4  5  6  7  8  9  0 
 359++10F2              ;#24#1C#14#0C#04#03#0B#13#1B#23
 360++10F2              ;Ĵ
 361++10F2              ; Q  W  Q  R  T  Y  U  I  O  P 
 362++10F2              ;#25#1D#15#0D#05#02#0A#12#1A#22
 363++10F2              ;Ĵ
 364++10F2              ; A  S  D  F  G  h  J  K  L ent
 365++10F2              ;#26#1E#16#0E#06#01#09#11#19#21
 366++10F2              ;Ĵ
 367++10F2              ;s  Z  X  C  V  B  N  M ss sp 
 368++10F2              ;#27#1F#17#0F#07#00#08#10#18#20
 369++10F2              ;
 370++10F2              ;:  ----
 371++10F2              ;: nz - ⨬ 
 372++10F2              ;       hl,de,bc,a -  ।
 373++10F2              ;     z  -       CS/SS    
 374++10F2              ;       e =#FF -   
 375++10F2              ;       0,d/c=1   c CS
 376++10F2              ;       1,d/c=1   c SS
 377++10F2              ;       e - ScanCode  ⮩ 
 378++10F2              ;       a=#00
 379++10F2              ;       hl,b -  ।
 380++10F2              ;
 381++10F2              ;ScanAllKeys
 382++10F2              ;
 383++10F2 2E 2F        	ld	l,#27+#08
 384++10F4 11 FF FF     	ld	de,#FFFF
 385++10F7 01 FF FE     	ld	bc,#FEFF
 386++10FA
 387++10FA              ;  ⠭ ⮢   ॣ c,d,e
 388++10FA 78           loop003	ld	a,b
 389++10FB DB FE        	in	a,(#FE)
 390++10FD 2F           	cpl
 391++10FE E6 1F        	and	#1F
 392++1100 28 0F        	jr	z,goto001
 393++1102 67           	ld	h,a
 394++1103 7D           	ld	a,l
 395++1104 0C           loop002	inc	c
 396++1105 C0           	ret	nz			;   
 397++1106 D6 08        loop001	sub	#08
 398++1108 CB 3C        	srl	h
 399++110A 30 FA        	jr	nc,loop001
 400++110C 4A           	ld	c,d
 401++110D 53           	ld	d,e
 402++110E 5F           	ld	e,a			; ⮩ 
 403++110F 20 F3        	jr	nz,loop002
 404++1111 2D           goto001	dec	l
 405++1112 CB 00        	rlc	b
 406++1114 38 E4        	jr	c,loop003
 407++1116              ;=key 1, d=key 2, e=key 3
 408++1116              ;=#FF, d=key 1, e=key 2
 409++1116              ;=#FF, d=#FF, e=key 1
 410++1116
 411++1116              ;஢ઠ 権 
 412++1116 79           	ld	a,c
 413++1117 3C           	inc	a
 414++1118 28 04        	jr	z,goto002		;    
 415++111A D6 28        	sub	#27+1
 416++111C C0           	ret	nz			;ࢠ   cs
 417++111D 3C           	inc	a
 418++111E 4F           goto002	ld	c,a			;0,c=0/1   cs/ cs
 419++111F 7A           	ld	a,d
 420++1120 3C           	inc	a
 421++1121 28 11        	jr	z,goto004		;   -> e - ᪠/#FF
 422++1123 FE 28        	cp	#27+1
 423++1125 28 0C        	jr	z,goto003
 424++1127 FE 19        	cp	#18+1
 425++1129 28 05        	jr	z,goto005		; ss
 426++112B 7B           	ld	a,e
 427++112C 5A           	ld	e,d
 428++112D FE 18        	cp	#18
 429++112F C0           	ret	nz			;⨬ 
 430++1130 CB C9        goto005	set	1,c			; ss
 431++1132 0D           	dec	c
 432++1133 0C           goto003	inc	c
 433++1134 51           goto004	ld	d,c			;0,d=0/1 cs  /
 434++1135 AF           	xor	a			;1,d=0/1 ss  /
 435++1136 C9           	ret
 436++1137
 437++1137                      endif
 438++1137
 439++1137              ;==============================================================================
 440++1137              		ifused	tablePrnKeys
 441++1137              ;⠡  
 442++1137              ;cs - off
 443++1137              ;ss - off
 444++1137              ;
 445++1137 62 68 79 36  tablePrnKeys	db "bhy65tgv"	;#00-#07
 445++113B 35 74 67 76
 446++113F 6E 6A 75 37  		db "nju74rfc"	;#08-#0F
 446++1143 34 72 66 63
 447++1147 6D 6B 69 38  		db "mki83edx"	;#10-#17
 447++114B 33 65 64 78
 448++114F 1D           		db keySS	;#18
 449++1150 6C 6F 39 32  		db "lo92wsz"	;#19-#1F
 449++1154 77 73 7A
 450++1157 20           		db " "		;#20
 451++1158 0D           		db keyEnter	;#21
 452++1159 70 30 31 71  		db "p01qa"	;#22-#26
 452++115D 61
 453++115E 1C           		db keyCS	;#27
 454++115F
 455++115F              		endif
 456++115F
 457++115F              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 458++115F              		ifused	tableCSkeys
 459++115F              ;⠡  
 460++115F              ;cs - on
 461++115F              ;ss - off
 462++115F              ;
 463++115F 42 48 59     tableCSkeys	db "BHY"	;#00-#02
 464++1162 0A           		db keyDown	;#03
 465++1163 08           		db keyLeft	;#04
 466++1164 54 47 56     		db "TGV"	;#05-#07
 467++1167 4E 4A 55     		db "NJU"	;#08-#0A
 468++116A 0B           		db keyUp	;#0B
 469++116B 05           		db keyPageDown	;#0C
 470++116C 52 46 43     		db "RFC"	;#0D-#0F
 471++116F 4D 4B 49     		db "MKI"	;#10-#12
 472++1172 09           		db keyRight	;#13
 473++1173 04           		db keyPageUp	;#14
 474++1174 45 44 58     		db "EDX"	;#15-#17
 475++1177 0E           		db keyExtMode	;#18
 476++1178 4C 4F        		db "LO"		;#19-#1A
 477++117A 0F           		db keyDelete	;#1B
 478++117B 06           		db keyCaps	;#1C
 479++117C 57 53 5A     		db "WSZ"	;#1D-#1F
 480++117F 18           		db keyBreak	;#20
 481++1180 19           		db keyCsEnter	;#21
 482++1181 50           		db "P"		;#22
 483++1182 0C           		db keyBackSpace	;#23
 484++1183 07           		db keyEdit	;#24
 485++1184 51 41        		db "QA"		;#25-#26
 486++1186 1C           		db keyCS	;#27
 487++1187
 488++1187              		endif
 489++1187
 490++1187              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 491++1187              		ifused	tableSSkeys
 492++1187              ;⠡  
 493++1187              ;cs - off
 494++1187              ;ss - on
 495++1187              ;
 496++1187 2A 5E 5B 26  tableSSkeys	db "*^[&%>}/"	;#00-#07
 496++118B 25 3E 7D 2F
 497++118F 2C 2D 5D 27  		db ",-]'$<{?"	;#08-#0F
 497++1193 24 3C 7B 3F
 498++1197 2E 2B 7F 28  		db ".+(#"	;#10-#14
 498++119B 23
 499++119C 03           		db keyEnd	;#15
 500++119D 5C 60        		db #5C,#60	;#16-#17 (\`)
 501++119F 1D           		db keySS	;#18
 502++11A0 3D 3B 29 40  		db "=;)@"	;#19-#1C
 503++11A4 02           		db keyInsert	;#1D
 504++11A5 7C 3A        		db "|:"		;#1E-#1F
 505++11A7 1A           		db keySsSpace	;#20
 506++11A8 1B           		db keySsEnter	;#21
 507++11A9 22           		db #22		;#22 (")
 508++11AA 5F 21        		db "_!"		;#23-#24
 509++11AC 01           		db keyHome	;#25
 510++11AD 7E           		db "~"		;#26
 511++11AE 0E           		db keyExtMode	;#27
 512++11AF
 513++11AF              		endif
 514++11AF
 515++11AF              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 516++11AF              		ifused	tableEXTKeys
 517++11AF              ;⠡  , ᪫  ZX-Word
 518++11AF              ;cs - on
 519++11AF              ;ss - on
 520++11AF              ;
 521++11AF              tableEXTKeys
 522++11AF
 523++11AF              		IFDEF	TblEXTkey_Test	;⮢ ᪫
 524++11AF 42 48 59     		db "BHY"	;#00-#02
 525++11B2 03           		db keyEnd	;#03 key 6
 526++11B3 10           		db keyWordLeft	;#04 key 5
 527++11B4 54 47 56     		db "TGV"	;#05-#07
 528++11B7 4E 4A 55     		db "NJU"	;#08-#0A
 529++11BA 01           		db keyHome	;#0B key 7
 530++11BB FF           		db #FF		;#0C key 4
 531++11BC 52 46 43     		db "RFC"	;#0D-#0F
 532++11BF 4D 4B 49     		db "MKI"	;#10-#12
 533++11C2 11           		db keyWordRight	;#13 key 8
 534++11C3 FF           		db #FF		;#14 key 3
 535++11C4 45 44 58     		db "EDX"	;#15-#17
 536++11C7 FF           		db #FF		;#18 key SS
 537++11C8 4C 4F        		db "LO"		;#19-#1A
 538++11CA 13           		db keyDelEnd	;#1B key 9
 539++11CB FF           		db #FF		;#1C key 2
 540++11CC 57 53 5A     		db "WSZ"	;#1D-#1F
 541++11CF 14           		db keyCsSsSpace	;#20
 542++11D0 15           		db keyCsSsEnter	;#21
 543++11D1 50           		db "P"		;#22
 544++11D2 16           		db keyDelBegin	;#23 key 0
 545++11D3 12           		db keyGrf	;#24 key 1
 546++11D4 51 41        		db "QA"		;#25-#26
 547++11D6 FF           		db #FF		;#27 key CS
 548++11D7              		ENDIF
 549++11D7
 550++11D7              		IFDEF	TblEXTkey_Word	; ZX-Word
 551++11D7 ~            		db "BHY"	;#00-#02
 552++11D7 ~            		db keyEnd	;#03 key 6
 553++11D7 ~            		db keyWordLeft	;#04 key 5
 554++11D7 ~            		db "TG",#FF	;#05-#07
 555++11D7 ~            		db #FF,#FF,#FF	;#08-#0A
 556++11D7 ~            		db keyHome	;#0B key 7
 557++11D7 ~            		db #FF		;#0C key 4
 558++11D7 ~            		db "RFC"	;#0D-#0F
 559++11D7 ~            		db #FF,#FF,#FF	;#10-#12
 560++11D7 ~            		db keyWordRight	;#13 key 8
 561++11D7 ~            		db #FF		;#14 key 3
 562++11D7 ~            		db "EDX"	;#15-#17
 563++11D7 ~            		db #FF		;#18 key SS
 564++11D7 ~            		db #FF,"O"	;#19-#1A
 565++11D7 ~            		db keyDelete	;#1B key 9
 566++11D7 ~            		db keyInsert	;#1C key 2
 567++11D7 ~            		db #FF,#FF,"Z"	;#1D-#1F
 568++11D7 ~            		db #FF		;#20
 569++11D7 ~            		db #FF		;#21
 570++11D7 ~            		db "P"		;#22
 571++11D7 ~            		db keyBackSpace	;#23 key 0
 572++11D7 ~            		db keyEdit	;#24 key 1
 573++11D7 ~            		db "Q",#FF	;#25-#26
 574++11D7 ~            		db #FF		;#27 key CS
 575++11D7              		ENDIF
 576++11D7
 577++11D7              		endif
 578++11D7
 579++11D7              ;------------------------------------------------------------------------------
 580++11D7              	IFDEF	GrfMode
 581++11D7              	IFDEF	TblKeyGrf_ver1
 582++11D7              	IFDEF	InsideGrfTable
 583++11D7
 584++11D7              ;᪠ ᪫: version 01
 585++11D7              ;
 586++11D7              TblKeyGrf	equ $-#20
 587++11D7              ;
 588++11D7              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 589++11D7              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 590++11D7              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 591++11D7              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 592++11D7 20 21 22 23  	db " !",#22,"#$%&'"
 592++11DB 24 25 26 27
 593++11DF 28 29 2A 2B  	db "()*+,-./"
 593++11E3 2C 2D 2E 2F
 594++11E7 30 31 32 33  	db "01234567"
 594++11EB 34 35 36 37
 595++11EF 38 39 3A 3B  	db "89:;<=>?"
 595++11F3 3C 3D 3E 3F
 596++11F7 40 C7 D4 BD  	db "@Խ"
 596++11FB B6 B7 BA C6
 597++11FF D8 CD B5 B3  	db "͵۾"
 597++1203 DB BE CF DD
 598++1207 DE D6 C4 D7  	db "ո"
 598++120B D5 B8 F0 D2
 599++120F D0 D1 D3 5B  	db "[",#5C,"]^_"
 599++1213 5C 5D 5E 5F
 600++1217 60 C3 C8 D9  	db "`ٴ"
 600++121B B4 BF B3 CC
 601++121F CE CD B9 BA  	db "͹ʱ"
 601++1223 B0 BC CA B1
 602++1227 B2 DA C4 C5  	db "ɻ"
 602++122B C9 BB FB C2
 603++122F C1 CB C0 7B  	db "{|}~"
 603++1233 7C 7D 7E 7F
 604++1237
 605++1237              	ELSE
 606++1237 ~            TblKeyGrf	equ	OutsideGrfTable
 607++1237              	ENDIF
 608++1237              	ENDIF
 609++1237              	ENDIF
 610++1237
 611++1237              ;------------------------------------------------------------------------------
 612++1237              	IFDEF	RusMode
 613++1237              	IFDEF	Rus_qwerty
 614++1237              	IFDEF	InsideRusTable
 615++1237
 616++1237              ;᪠ ᪫: 
 617++1237              ;
 618++1237              TblKeyRus_qwerty	equ $-#20
 619++1237              ;
 620++1237              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 621++1237              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 622++1237              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 623++1237              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 624++1237 20 21 22 23  	db " !",#22,"#$%&'"
 624++123B 24 25 26 27
 625++123F 28 29 2A 2B  	db "()*+,-./"
 625++1243 2C 2D 2E 2F
 626++1247 30 31 32 33  	db "01234567"
 626++124B 34 35 36 37
 627++124F 38 39 3A 3B  	db "89:;<=>?"
 627++1253 3C 3D 3E 3F
 628++1257 40 80 81 96  	db "@"
 628++125B 84 85 94 83
 629++125F 95 88 89 8A  	db ""
 629++1263 8B 8C 8D 8E
 630++1267 8F 9F 90 91  	db ""
 630++126B 92 93 86 82
 631++126F 9C 9B 87 5B  	db "[",#5C,"]^"
 631++1273 5C 5D 5E 9A
 632++1277 9E A0 A1 E6  	db "椥"
 632++127B A4 A5 E4 A3
 633++127F E5 A8 A9 AA  	db "娩"
 633++1283 AB AC AD AE
 634++1287 AF EF E0 E1  	db "㦢"
 634++128B E2 E3 A6 A2
 635++128F EC EB A7 98  	db "맘"
 635++1293 9D 99 97 7F
 636++1297
 637++1297              	ELSE
 638++1297 ~            TblKeyRus_qwerty	equ	OutsideRus_qwerty
 639++1297              	ENDIF
 640++1297              	ENDIF
 641++1297              	ENDIF
 642++1297
 643++1297              ;------------------------------------------------------------------------------
 644++1297              	IFDEF	RusMode
 645++1297              	IFDEF	Rus_jcuken
 646++1297              	IFDEF	InsideRusTable
 647++1297
 648++1297              ;᪠ ᪫: 㪥
 649++1297              ;
 650++1297              TblKeyRus_jcuken	equ	$-#20
 651++1297              ;
 652++1297              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 653++1297              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 654++1297              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 655++1297              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 656++1297 20 21 22 23  	db " !",#22,"#$%&'"
 656++129B 24 25 26 27
 657++129F 28 29 2A 2B  	db "()*+,-./"
 657++12A3 2C 2D 2E 2F
 658++12A7 30 31 32 33  	db "01234567"
 658++12AB 34 35 36 37
 659++12AF 38 39 3A 3B  	db "89:;<=>?"
 659++12B3 3C 3D 3E 3F
 660++12B7 9E 94 88 91  	db ""
 660++12BB 82 93 80 8F
 661++12BF 90 98 8E 8B  	db ""
 661++12C3 84 9C 92 99
 662++12C7 87 89 8A 9B  	db ""
 662++12CB 85 83 8C 96
 663++12CF 97 8D 9F 95  	db ""
 663++12D3 9D 86 81 9A
 664++12D7 EE E4 A8 E1  	db "㠯"
 664++12DB A2 E3 A0 AF
 665++12DF E0 E8 AE AB  	db "讫"
 665++12E3 A4 EC E2 E9
 666++12E7 A7 A9 AA EB  	db "륣"
 666++12EB A5 A3 AC E6
 667++12EF E7 AD EF E5  	db ""
 667++12F3 ED A6 A1 7F
 668++12F7
 669++12F7              	ELSE
 670++12F7 ~            TblKeyRus_jcuken	equ	OutsideRus_jcuken
 671++12F7              	ENDIF
 672++12F7              	ENDIF
 673++12F7              	ENDIF
 674++12F7
 675++12F7              ;------------------------------------------------------------------------------
 676++12F7              	ifused	TblKeyLat
 677++12F7 ~            ;⠭⭠ ⨭᪠ ᪫
 678++12F7 ~            ;
 679++12F7 ~            TblKeyLat	equ	$-#20
 680++12F7 ~            ;
 681++12F7 ~            ;	db #00,#01,#02,#03,#04,#05,#06,#07
 682++12F7 ~            ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 683++12F7 ~            ;	db #10,#11,#12,#13,#14,#15,#16,#17
 684++12F7 ~            ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 685++12F7 ~            	db " !",""","#$%&'"
 686++12F7 ~            	db "()*+,-./"
 687++12F7 ~            	db "01234567"
 688++12F7 ~            	db "89:;<=>?"
 689++12F7 ~            	db "@ABCDEFG"
 690++12F7 ~            	db "HIJKLMNO"
 691++12F7 ~            	db "PQRSTUVW"
 692++12F7 ~            	db "XYZ[\]^_"
 693++12F7 ~            	db "`abcdefg"
 694++12F7 ~            	db "hijklmno"
 695++12F7 ~            	db "pqrstuvw"
 696++12F7 ~            	db "xyz{|}~"
 697++12F7 ~
 698++12F7              	endif
 699++12F7
 700++12F7              ;==============================================================================
 701++12F7
# file closed: Drv/DrvKey.asm.a80
 117+ 12F7              	INCLUDE	"DrvKey.var.a80"
# file opened: Drv/DrvKey.var.a80
   1++12F7              ;६ Keyboard Driver
   2++12F7              ;䠩 DrvKey.var.a80
   3++12F7              ;
   4++12F7              ;䫠 ࠩ
   5++12F7              ;7,=1     
   6++12F7              ;6,=1     
   7++12F7              ;5,=1 ᨬ  ० cs+ss+key
   8++12F7              ;4,=1/0 Rus 㪥/Rus 
   9++12F7              ;3,=1/0 Rus/Lat
  10++12F7              ;2,=1/0 Grf on/off
  11++12F7              ;1,=1/0 CapsLock on/off
  12++12F7              ;0,=1/0 Command on/off
  13++12F7 30           FlgScanKeys     db %00110000
  14++12F8 00           		db %00000000	;१
  15++12F9
  16++12F9              ;稭 প  ⮯
  17++12F9 0F           KeyRepeatDelay    db #0F
  18++12FA              ;ਮ ⮯
  19++12FA 05           KeyRepeatPeriod   db #05
  20++12FB
  21++12FB              ;  ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
  22++12FB              ;   ⮬ ० CapsLock
  23++12FB 00           PrintCodePresKey  db #00
  24++12FC              ;᪠ ⮩ 
  25++12FC 00           ScanCodePresKey   db #00
  26++12FD
  27++12FD
# file closed: Drv/DrvKey.var.a80
 118+ 12FD              End	DISPLAY	"Lenght DrvKey = ",/A,End-Start
 119+ 12FD              ;	SAVEBIN	"!bin/drvkeys.bin",Start,End-Start
 120+ 12FD              	ENDMODULE
 121+ 12FD
# file closed: Drv/DrvKey.main.a80
1803  12FD              	include player.asm ;плеер AY, TS
# file opened: player.asm
   1+ 12FD              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2+ 12FD              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3+ 12FD              ;Specially for AlCo
   4+ 12FD              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5+ 12FD              	MODULE VTPL
   6+ 12FD              ;Release number
   7+ 12FD              Release EQU "0"
   8+ 12FD              ;Conditional assembly
   9+ 12FD              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10+ 12FD              CurPosCounter=0
  11+ 12FD              ;2) Allow channels allocation bits at (START+10)
  12+ 12FD              ACBBAC=0
  13+ 12FD              ;3) Allow loop checking and disabling
  14+ 12FD              LoopChecker=1
  15+ 12FD              ;4) Insert official identificator
  16+ 12FD              Id=0
  17+ 12FD              ;5) Set IY for correct return to ZX Basic
  18+ 12FD              Basic=1
  19+ 12FD
  20+ 12FD              ;Features
  21+ 12FD              ;--------
  22+ 12FD              ;-Can be compiled at any address (i.e. no need rounding ORG
  23+ 12FD              ; address).
  24+ 12FD              ;-Variables (VARS) can be located at any address (not only after
  25+ 12FD              ; code block).
  26+ 12FD              ;-INIT subprogram checks PT3-module version and rightly
  27+ 12FD              ; generates both note and volume tables outside of code block
  28+ 12FD              ; (in VARS).
  29+ 12FD              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30+ 12FD              ; PT3 module version).
  31+ 12FD              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32+ 12FD              ; and higher).
  33+ 12FD              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34+ 12FD              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35+ 12FD              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36+ 12FD              ;-See also notes at the end of this source code.
  37+ 12FD
  38+ 12FD              ;Limitations
  39+ 12FD              ;-----------
  40+ 12FD              ;-Can run in RAM only (self-modified code is used).
  41+ 12FD              ;-PT2 position list must be end by #FF marker only.
  42+ 12FD
  43+ 12FD              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44+ 12FD              ;into RAM or INIT subprogram was not called before.
  45+ 12FD
  46+ 12FD              ;Call MUTE or INIT one more time to mute sound after stopping
  47+ 12FD              ;playing
  48+ 12FD
  49+ 12FD              ;Test codes (commented)
  50+ 12FD              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51+ 12FD              ;	LD (START+10),A
  52+ 12FD              ;	LD HL,#8000 ;Mod1
  53+ 12FD              ;	LD DE,#A000 ;Mod2 (optional)
  54+ 12FD              ;	CALL START+3
  55+ 12FD              ;	EI
  56+ 12FD              ;_LP	HALT
  57+ 12FD              ;	CALL START+5
  58+ 12FD              ;	XOR A
  59+ 12FD              ;	IN A,(#FE)
  60+ 12FD              ;	CPL
  61+ 12FD              ;	AND 15
  62+ 12FD              ;	JR Z,_LP
  63+ 12FD              ;	JR START+8
  64+ 12FD
  65+ 12FD              TonA	EQU 0
  66+ 12FD              TonB	EQU 2
  67+ 12FD              TonC	EQU 4
  68+ 12FD              Noise	EQU 6
  69+ 12FD              Mixer	EQU 7
  70+ 12FD              AmplA	EQU 8
  71+ 12FD              AmplB	EQU 9
  72+ 12FD              AmplC	EQU 10
  73+ 12FD              Env	EQU 11
  74+ 12FD              EnvTp	EQU 13
  75+ 12FD
  76+ 12FD              ;Entry and other points
  77+ 12FD              ;START initialize playing of modules at MDLADDR (single module)
  78+ 12FD              ;START+3 initialization with module address in HL and DE (TS)
  79+ 12FD              ;START+5 play one quark
  80+ 12FD              ;START+8 mute
  81+ 12FD              ;START+10 setup and status flags
  82+ 12FD
  83+ 12FD              START:
  84+ 12FD 21 00 C0     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85+ 1300 18 3C        	JR INIT
  86+ 1302 C3 61 1B     	JP PLAY
  87+ 1305 18 25        	JR MUTE
  88+ 1307 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89+ 1308              	     ;(optional);
  90+ 1308              	     ;set bit1 for PT2 and reset for PT3 before
  91+ 1308              	     ;calling INIT;
  92+ 1308              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93+ 1308              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94+ 1308              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95+ 1308              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96+ 1308              	     ;documented and must be converted to new standard.
  97+ 1308              	     ;bit6 is set each time, when loop point of 2nd TS
  98+ 1308              	     ;module is passed (optional).
  99+ 1308              	     ;bit7 is set each time, when loop point of 1st TS
 100+ 1308              	     ;or of single module is passed (optional).
 101+ 1308
 102+ 1308              ;Identifier
 103+ 1308              	IF Id
 104+ 1308 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105+ 1308              	ENDIF
 106+ 1308
 107+ 1308              	IF LoopChecker
 108+ 1308 21 07 13     CHECKLP	LD HL,SETUP
 109+ 130B FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110+ 130F 28 04        	JR Z,CHL1
 111+ 1311 CB F6        	SET 6,(HL)
 112+ 1313 18 02        	JR CHL2
 113+ 1315 CB FE        CHL1	SET 7,(HL)
 114+ 1317 CB 46        CHL2	BIT 0,(HL)
 115+ 1319 C8           	RET Z
 116+ 131A E1           	POP HL
 117+ 131B FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118+ 131E FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119+ 1321 AF           	XOR A
 120+ 1322 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121+ 1325 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122+ 1328 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123+ 132B C9           	RET
 124+ 132C              	ENDIF
 125+ 132C
 126+ 132C AF           MUTE: XOR A
 127+ 132D 67           	LD H,A
 128+ 132E 6F           	LD L,A
 129+ 132F 32 B6 1C     	LD (VARS1+VRS.AYREGS+AmplA),A
 130+ 1332 22 B7 1C     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131+ 1335 32 3D 1D     	LD (VARS2+VRS.AYREGS+AmplA),A
 132+ 1338 22 3E 1D     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133+ 133B C3 79 1B     	JP ROUT
 134+ 133E
 135+ 133E              INIT:
 136+ 133E              ;HL - AddressOfModule
 137+ 133E              ;DE - AddresOf2ndModule
 138+ 133E D5           	PUSH DE
 139+ 133F E5           	PUSH HL
 140+ 1340 21 34 1C     	LD HL,VARS
 141+ 1343 36 00        	LD (HL),0
 142+ 1345 11 35 1C     	LD DE,VARS+1
 143+ 1348 01 0E 01     	LD BC,VAR0END-VARS-1
 144+ 134B ED B0        	LDIR
 145+ 134D 23           	INC HL
 146+ 134E 22 97 1C     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147+ 1351 22 1E 1D     	LD (VARS2+VRS.AdInPtA),HL
 148+ 1354
 149+ 1354 E1           	POP HL
 150+ 1355 FD 21 99 1C  	LD IY,VARS1+100
 151+ 1359 3A 07 13     	LD A,(START+10)
 152+ 135C E6 02        	AND 2
 153+ 135E C2 E7 13     	JP NZ,I_PT2
 154+ 1361
 155+ 1361 CD 34 15     	CALL INITPT3
 156+ 1364 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157+ 1367 22 07 19     	LD (SamCnv),HL
 158+ 136A 3E BA        	LD A,#BA
 159+ 136C 32 D2 18     	LD (OrnCP),A
 160+ 136F 32 FE 18     	LD (SamCP),A
 161+ 1372 3E 7B        	LD A,#7B
 162+ 1374 32 D5 18     	LD (OrnLD),A
 163+ 1377 32 01 19     	LD (SamLD),A
 164+ 137A 3E 87        	LD A,#87
 165+ 137C 32 F8 18     	LD (SamClc2),A
 166+ 137F E1           	POP HL
 167+ 1380              	;Use version and ton table of 1st module
 168+ 1380 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169+ 1383 D6 30        	SUB #30
 170+ 1385 38 04        	JR C,L20
 171+ 1387 FE 0A        	CP 10
 172+ 1389 38 02        	JR C,L21
 173+ 138B 3E 06        L20	LD A,6
 174+ 138D 32 A5 17     L21	LD (Version),A
 175+ 1390 F5           	PUSH AF ;VolTable version
 176+ 1391 FE 04        	CP 4
 177+ 1393 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178+ 1396 17           	RLA
 179+ 1397 E6 07        	AND 7
 180+ 1399 F5           	PUSH AF ;NoteTable number
 181+ 139A
 182+ 139A FD 21 20 1D  	LD IY,VARS2+100
 183+ 139E 3A 07 13     	LD A,(START+10)
 184+ 13A1 E6 30        	AND 48
 185+ 13A3 28 37        	JR Z,NOTS
 186+ 13A5 FE 10        	CP 16
 187+ 13A7 28 27        	JR Z,TwoPT3s
 188+ 13A9 3A A5 17     	LD A,(Version)
 189+ 13AC FE 07        	CP 7
 190+ 13AE 38 2C        	JR C,NOTS
 191+ 13B0 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192+ 13B3 FE 20        	CP #20
 193+ 13B5 28 25        	JR Z,NOTS
 194+ 13B7 21 35 1C     	LD HL,VARS1
 195+ 13BA 11 BC 1C     	LD DE,VARS2
 196+ 13BD 01 87 00     	LD BC,VRS
 197+ 13C0 ED B0        	LDIR
 198+ 13C2 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199+ 13C6 4F           	LD C,A
 200+ 13C7 87           	ADD A,A
 201+ 13C8 81           	ADD A,C
 202+ 13C9 D6 02        	SUB 2
 203+ 13CB 32 6C 1A     	LD (TSSub),A
 204+ 13CE 18 03        	JR AlCoTS_
 205+ 13D0 CD 34 15     TwoPT3s	CALL INITPT3
 206+ 13D3 3E 01        AlCoTS_	LD A,1
 207+ 13D5 32 34 1C     	LD (is_ts),A
 208+ 13D8 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209+ 13DC
 210+ 13DC 01 F1 16     NOTS	LD BC,PT3PD
 211+ 13DF 21 00 00     	LD HL,0
 212+ 13E2 11 FC 1B     	LD DE,PT3EMPTYORN
 213+ 13E5 18 48        	JR INITCOMMON
 214+ 13E7
 215+ 13E7 CD 6C 15     I_PT2	CALL INITPT2
 216+ 13EA 21 CB 51     	LD HL,#51CB
 217+ 13ED 22 07 19     	LD (SamCnv),HL
 218+ 13F0 3E BB        	LD A,#BB
 219+ 13F2 32 D2 18     	LD (OrnCP),A
 220+ 13F5 32 FE 18     	LD (SamCP),A
 221+ 13F8 3E 7A        	LD A,#7A
 222+ 13FA 32 D5 18     	LD (OrnLD),A
 223+ 13FD 32 01 19     	LD (SamLD),A
 224+ 1400 3E 80        	LD A,#80
 225+ 1402 32 F8 18     	LD (SamClc2),A
 226+ 1405 E1           	POP HL
 227+ 1406 3E 05        	LD A,5
 228+ 1408 32 A5 17     	LD (Version),A
 229+ 140B F5           	PUSH AF
 230+ 140C 3E 02        	LD A,2
 231+ 140E F5           	PUSH AF
 232+ 140F
 233+ 140F 3A 07 13     	LD A,(START+10)
 234+ 1412 E6 30        	AND 48
 235+ 1414 28 10        	JR Z,NOTS2
 236+ 1416
 237+ 1416 FD 21 20 1D  	LD IY,VARS2+100
 238+ 141A 3E 01        	LD A,1
 239+ 141C 32 34 1C     	LD (is_ts),A
 240+ 141F FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241+ 1423 CD 6C 15     	CALL INITPT2
 242+ 1426
 243+ 1426 01 2B 16     NOTS2	LD BC,PT2PD
 244+ 1429 21 87 86     	LD HL,#8687
 245+ 142C 11 52 1D     	LD DE,PT2EMPTYORN
 246+ 142F
 247+ 142F              INITCOMMON
 248+ 142F
 249+ 142F              	IF Basic
 250+ 142F FD 21 3A 5C  	LD IY,#5C3A
 251+ 1433              	ENDIF
 252+ 1433
 253+ 1433 ED 43 DC 15  	LD (PTDEC),BC
 254+ 1437 22 6E 1A     	LD (PsCalc),HL
 255+ 143A D5           	PUSH DE
 256+ 143B
 257+ 143B              ;note table data depacker
 258+ 143B              ;(c) Ivan Roshin
 259+ 143B 11 FF 1B     	LD DE,T_PACK
 260+ 143E 01 A4 1D     	LD BC,T1_+(2*49)-1
 261+ 1441 1A           TP_0	LD A,(DE)
 262+ 1442 13           	INC DE
 263+ 1443 FE 1E        	CP 15*2
 264+ 1445 30 06        	JR NC,TP_1
 265+ 1447 67           	LD H,A
 266+ 1448 1A           	LD A,(DE)
 267+ 1449 6F           	LD L,A
 268+ 144A 13           	INC DE
 269+ 144B 18 07        	JR TP_2
 270+ 144D D5           TP_1	PUSH DE
 271+ 144E 16 00        	LD D,0
 272+ 1450 5F           	LD E,A
 273+ 1451 19           	ADD HL,DE
 274+ 1452 19           	ADD HL,DE
 275+ 1453 D1           	POP DE
 276+ 1454 7C           TP_2	LD A,H
 277+ 1455 02           	LD (BC),A
 278+ 1456 0B           	DEC BC
 279+ 1457 7D           	LD A,L
 280+ 1458 02           	LD (BC),A
 281+ 1459 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282+ 145A D6 F0        	SUB #F8*2
 283+ 145C 20 E3        	JR NZ,TP_0
 284+ 145E
 285+ 145E 3C           	INC A
 286+ 145F 32 A2 1C     	LD (VARS1+VRS.DelyCnt),A
 287+ 1462 32 29 1D     	LD (VARS2+VRS.DelyCnt),A
 288+ 1465 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289+ 1468 22 53 1C     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290+ 146B 22 70 1C     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291+ 146E 22 8D 1C     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292+ 1471 22 DA 1C     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293+ 1474 22 F7 1C     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294+ 1477 22 14 1D     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295+ 147A E1           	POP HL
 296+ 147B 22 45 1C     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297+ 147E 22 62 1C     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298+ 1481 22 7F 1C     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299+ 1484 22 CC 1C     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300+ 1487 22 E9 1C     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301+ 148A 22 06 1D     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302+ 148D
 303+ 148D F1           	POP AF
 304+ 148E
 305+ 148E              ;NoteTableCreator (c) Ivan Roshin
 306+ 148E              ;A - NoteTableNumber*2+VersionForNoteTable
 307+ 148E              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308+ 148E
 309+ 148E 21 AC 1B     	LD HL,NT_DATA
 310+ 1491 16 00        	LD D,0
 311+ 1493 87           	ADD A,A
 312+ 1494 5F           	LD E,A
 313+ 1495 19           	ADD HL,DE
 314+ 1496 5E           	LD E,(HL)
 315+ 1497 23           	INC HL
 316+ 1498 CB 3B        	SRL E
 317+ 149A 9F           	SBC A,A
 318+ 149B E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319+ 149D 32 C5 14     	LD (L3),A
 320+ 14A0 EB           	EX DE,HL
 321+ 14A1 01 43 1D     	LD BC,T1_
 322+ 14A4 09           	ADD HL,BC
 323+ 14A5
 324+ 14A5 1A           	LD A,(DE)
player.asm(325): warning: value 0x1BBC is truncated to 8bit value: 0xBC
 325+ 14A6 C6 BC        	ADD A,T_
 326+ 14A8 4F           	LD C,A
 327+ 14A9 CE 1B        	ADC A,T_/256
 328+ 14AB 91           	SUB C
 329+ 14AC 47           	LD B,A
 330+ 14AD C5           	PUSH BC
 331+ 14AE 11 33 1E     	LD DE,NT_
 332+ 14B1 D5           	PUSH DE
 333+ 14B2
 334+ 14B2 06 0C        	LD B,12
 335+ 14B4 C5           L1	PUSH BC
 336+ 14B5 4E           	LD C,(HL)
 337+ 14B6 23           	INC HL
 338+ 14B7 E5           	PUSH HL
 339+ 14B8 46           	LD B,(HL)
 340+ 14B9
 341+ 14B9 D5           	PUSH DE
 342+ 14BA EB           	EX DE,HL
 343+ 14BB 11 17 00     	LD DE,23
 344+ 14BE DD 26 08     	LD IXH,8
 345+ 14C1
 346+ 14C1 CB 38        L2	SRL B
 347+ 14C3 CB 19        	RR C
 348+ 14C5 19           L3	DB #19	;AND A or NOP
 349+ 14C6 79           	LD A,C
 350+ 14C7 8A           	ADC A,D	;=ADC 0
 351+ 14C8 77           	LD (HL),A
 352+ 14C9 23           	INC HL
 353+ 14CA 78           	LD A,B
 354+ 14CB 8A           	ADC A,D
 355+ 14CC 77           	LD (HL),A
 356+ 14CD 19           	ADD HL,DE
 357+ 14CE DD 25        	DEC IXH
 358+ 14D0 20 EF        	JR NZ,L2
 359+ 14D2
 360+ 14D2 D1           	POP DE
 361+ 14D3 13           	INC DE
 362+ 14D4 13           	INC DE
 363+ 14D5 E1           	POP HL
 364+ 14D6 23           	INC HL
 365+ 14D7 C1           	POP BC
 366+ 14D8 10 DA        	DJNZ L1
 367+ 14DA
 368+ 14DA E1           	POP HL
 369+ 14DB D1           	POP DE
 370+ 14DC
 371+ 14DC 7B           	LD A,E
player.asm(372): warning: value 0x1BC8 is truncated to 8bit value: 0xC8
 372+ 14DD FE C8        	CP TCOLD_1
 373+ 14DF 20 05        	JR NZ,CORR_1
 374+ 14E1 3E FD        	LD A,#FD
 375+ 14E3 32 61 1E     	LD (NT_+#2E),A
 376+ 14E6
 377+ 14E6 1A           CORR_1	LD A,(DE)
 378+ 14E7 A7           	AND A
 379+ 14E8 28 11        	JR Z,TC_EXIT
 380+ 14EA 1F           	RRA
 381+ 14EB F5           	PUSH AF
 382+ 14EC 87           	ADD A,A
 383+ 14ED 4F           	LD C,A
 384+ 14EE 09           	ADD HL,BC
 385+ 14EF F1           	POP AF
 386+ 14F0 30 02        	JR NC,CORR_2
 387+ 14F2 35           	DEC (HL)
 388+ 14F3 35           	DEC (HL)
 389+ 14F4 34           CORR_2	INC (HL)
 390+ 14F5 A7           	AND A
 391+ 14F6 ED 42        	SBC HL,BC
 392+ 14F8 13           	INC DE
 393+ 14F9 18 EB        	JR CORR_1
 394+ 14FB
 395+ 14FB              TC_EXIT
 396+ 14FB
 397+ 14FB F1           	POP AF
 398+ 14FC
 399+ 14FC              ;VolTableCreator (c) Ivan Roshin
 400+ 14FC              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401+ 14FC              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402+ 14FC
 403+ 14FC FE 05        	CP 5
 404+ 14FE 21 11 00     	LD HL,#11
 405+ 1501 54           	LD D,H
 406+ 1502 5C           	LD E,H
 407+ 1503 3E 17        	LD A,#17
 408+ 1505 30 03        	JR NC,M1
 409+ 1507 2D           	DEC L
 410+ 1508 5D           	LD E,L
 411+ 1509 AF           	XOR A
 412+ 150A 32 1B 15     M1      LD (M2),A
 413+ 150D
 414+ 150D DD 21 43 1D  	LD IX,VT_+16
 415+ 1511
 416+ 1511 0E 0F        	LD C,#F
 417+ 1513 E5           INITV2  PUSH HL
 418+ 1514
 419+ 1514 19           	ADD HL,DE
 420+ 1515 EB           	EX DE,HL
 421+ 1516 ED 62        	SBC HL,HL
 422+ 1518
 423+ 1518 06 10        	LD B,#10
 424+ 151A 7D           INITV1  LD A,L
 425+ 151B 7D           M2      DB #7D
 426+ 151C 7C           	LD A,H
 427+ 151D CE 00        	ADC A,0
 428+ 151F DD 77 00     	LD (IX),A
 429+ 1522 DD 23        	INC IX
 430+ 1524 19           	ADD HL,DE
 431+ 1525 10 F3        	DJNZ INITV1
 432+ 1527
 433+ 1527 E1           	POP HL
 434+ 1528 7B           	LD A,E
 435+ 1529 FE 77        	CP #77
 436+ 152B 20 01        	JR NZ,M3
 437+ 152D 1C           	INC E
 438+ 152E 0D           M3      DEC C
 439+ 152F 20 E2        	JR NZ,INITV2
 440+ 1531
 441+ 1531 C3 79 1B     	JP ROUT
 442+ 1534
 443+ 1534 CD A7 15     INITPT3	CALL SETMDAD
 444+ 1537 E5           	PUSH HL
 445+ 1538 11 64 00     	LD DE,100
 446+ 153B 19           	ADD HL,DE
 447+ 153C 7E           	LD A,(HL)
 448+ 153D FD 77 08     	LD (IY-100+VRS.Delay),A
 449+ 1540 E5           	PUSH HL
 450+ 1541 DD E1        	POP IX
 451+ 1543 19           	ADD HL,DE
 452+ 1544 CD B5 15     	CALL SETCPPT
 453+ 1547 DD 5E 02     	LD E,(IX+102-100)
 454+ 154A 23           	INC HL
 455+ 154B
 456+ 154B              	IF CurPosCounter
 457+ 154B ~            	LD (IY-100+VRS.PosSub),L
 458+ 154B              	ENDIF
 459+ 154B
 460+ 154B 19           	ADD HL,DE
 461+ 154C CD BC 15     	CALL SETLPPT
 462+ 154F D1           	POP DE
 463+ 1550 DD 6E 03     	LD L,(IX+103-100)
 464+ 1553 DD 66 04     	LD H,(IX+104-100)
 465+ 1556 19           	ADD HL,DE
 466+ 1557 CD A0 15     	CALL SETPTPT
 467+ 155A 21 A9 00     	LD HL,169
 468+ 155D 19           	ADD HL,DE
 469+ 155E CD AE 15     	CALL SETORPT
 470+ 1561 21 69 00     	LD HL,105
 471+ 1564 19           	ADD HL,DE
 472+ 1565
 473+ 1565 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474+ 1568 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475+ 156B C9           	RET
 476+ 156C
 477+ 156C 7E           INITPT2	LD A,(HL)
 478+ 156D FD 77 08     	LD (IY-100+VRS.Delay),A
 479+ 1570 E5           	PUSH HL
 480+ 1571 E5           	PUSH HL
 481+ 1572 E5           	PUSH HL
 482+ 1573 23           	INC HL
 483+ 1574 23           	INC HL
 484+ 1575 7E           	LD A,(HL)
 485+ 1576 23           	INC HL
 486+ 1577 CD 65 15     	CALL SETSMPT
 487+ 157A 5E           	LD E,(HL)
 488+ 157B 23           	INC HL
 489+ 157C 56           	LD D,(HL)
 490+ 157D E1           	POP HL
 491+ 157E A7           	AND A
 492+ 157F ED 52        	SBC HL,DE
 493+ 1581 CD A7 15     	CALL SETMDAD
 494+ 1584 E1           	POP HL
 495+ 1585 11 43 00     	LD DE,67
 496+ 1588 19           	ADD HL,DE
 497+ 1589 CD AE 15     	CALL SETORPT
 498+ 158C 1E 20        	LD E,32
 499+ 158E 19           	ADD HL,DE
 500+ 158F 4E           	LD C,(HL)
 501+ 1590 23           	INC HL
 502+ 1591 46           	LD B,(HL)
 503+ 1592 1E 1E        	LD E,30
 504+ 1594 19           	ADD HL,DE
 505+ 1595 CD B5 15     	CALL SETCPPT
 506+ 1598 5F           	LD E,A
 507+ 1599 23           	INC HL
 508+ 159A
 509+ 159A              	IF CurPosCounter
 510+ 159A ~            	LD (IY-100+VRS.PosSub),L
 511+ 159A              	ENDIF
 512+ 159A
 513+ 159A 19           	ADD HL,DE
 514+ 159B CD BC 15     	CALL SETLPPT
 515+ 159E E1           	POP HL
 516+ 159F 09           	ADD HL,BC
 517+ 15A0
 518+ 15A0 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519+ 15A3 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520+ 15A6 C9           	RET
 521+ 15A7
 522+ 15A7 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523+ 15AA FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524+ 15AD C9           	RET
 525+ 15AE
 526+ 15AE FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527+ 15B1 FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528+ 15B4 C9           	RET
 529+ 15B5
 530+ 15B5 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531+ 15B8 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532+ 15BB C9           	RET
 533+ 15BC
 534+ 15BC FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535+ 15BF FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536+ 15C2 C9           	RET
 537+ 15C3
 538+ 15C3 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539+ 15C6 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540+ 15C9 C9           	RET
 541+ 15CA
 542+ 15CA FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543+ 15CD FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544+ 15D0 C9           	RET
 545+ 15D1
 546+ 15D1 FD E5        GETIX	PUSH IY
 547+ 15D3 DD E1        	POP IX
 548+ 15D5 DD 19        	ADD IX,DE
 549+ 15D7 C9           	RET
 550+ 15D8
 551+ 15D8 CD D1 15     PTDECOD CALL GETIX
 552+ 15DB              PTDEC	EQU $+1
 553+ 15DB C3 C3 C3     	JP #C3C3
 554+ 15DE
 555+ 15DE              ;PT2 pattern decoder
 556+ 15DE CD 74 18     PD2_SAM	CALL SETSAM
 557+ 15E1 18 4A        	JR PD2_LOOP
 558+ 15E3
 559+ 15E3 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560+ 15E6 18 45        	JR PD2_LOOP
 561+ 15E8
 562+ 15E8 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563+ 15EC FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564+ 15EF 0A           	LD A,(BC)
 565+ 15F0 03           	INC BC
 566+ 15F1 6F           	LD L,A
 567+ 15F2 0A           	LD A,(BC)
 568+ 15F3 03           	INC BC
 569+ 15F4 67           	LD H,A
 570+ 15F5 CD C3 15     	CALL SETENBS
 571+ 15F8 18 33        	JR PD2_LOOP
 572+ 15FA
 573+ 15FA CD 55 18     PD2_ORN	CALL SETORN
 574+ 15FD 18 2E        	JR PD2_LOOP
 575+ 15FF
 576+ 15FF 3C           PD2_SKIP INC A
 577+ 1600 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578+ 1603 18 28        	JR PD2_LOOP
 579+ 1605
 580+ 1605 0F           PD2_VOL	RRCA
 581+ 1606 0F           	RRCA
 582+ 1607 0F           	RRCA
 583+ 1608 0F           	RRCA
 584+ 1609 DD 77 10     	LD (IX-12+CHP.Volume),A
 585+ 160C 18 1F        	JR PD2_LOOP
 586+ 160E
 587+ 160E CD 25 18     PD2_DEL	CALL C_DELAY
 588+ 1611 18 1A        	JR PD2_LOOP
 589+ 1613
 590+ 1613 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591+ 1617 3C           	INC A
 592+ 1618 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593+ 161B DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594+ 161E 0A           	LD A,(BC)
 595+ 161F 03           	INC BC
 596+ 1620 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597+ 1623 87           	ADD A,A
 598+ 1624 9F           	SBC A,A
 599+ 1625 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600+ 1628 37           	SCF
 601+ 1629 18 01        	JR PD2_LP2
 602+ 162B
 603+ 162B A7           PT2PD	AND A
 604+ 162C
 605+ 162C 08           PD2_LP2	EX AF,AF'
 606+ 162D
 607+ 162D 0A           PD2_LOOP LD A,(BC)
 608+ 162E 03           	INC BC
 609+ 162F C6 20        	ADD A,#20
 610+ 1631 28 3F        	JR Z,PD2_REL
 611+ 1633 38 A9        	JR C,PD2_SAM
 612+ 1635 C6 60        	ADD A,96
 613+ 1637 38 3E        	JR C,PD2_NOTE
 614+ 1639 3C           	INC A
 615+ 163A 28 A7        	JR Z,PD2_EOff
 616+ 163C C6 0F        	ADD A,15
 617+ 163E CA 54 17     	JP Z,PD_FIN
 618+ 1641 38 A5        	JR C,PD2_ENV
 619+ 1643 C6 10        	ADD A,#10
 620+ 1645 38 B3        	JR C,PD2_ORN
 621+ 1647 C6 40        	ADD A,#40
 622+ 1649 38 B4        	JR C,PD2_SKIP
 623+ 164B C6 10        	ADD A,#10
 624+ 164D 38 B6        	JR C,PD2_VOL
 625+ 164F 3C           	INC A
 626+ 1650 28 BC        	JR Z,PD2_DEL
 627+ 1652 3C           	INC A
 628+ 1653 28 BE        	JR Z,PD2_GLIS
 629+ 1655 3C           	INC A
 630+ 1656 28 0A        	JR Z,PD2_PORT
 631+ 1658 3C           	INC A
 632+ 1659 28 12        	JR Z,PD2_STOP
 633+ 165B 0A           	LD A,(BC)
 634+ 165C 03           	INC BC
 635+ 165D DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636+ 1660 18 CB        	JR PD2_LOOP
 637+ 1662
 638+ 1662 DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639+ 1666 0A           	LD A,(BC)
 640+ 1667 03           	INC BC
 641+ 1668 03           	INC BC ;ignoring precalc delta to right sound
 642+ 1669 03           	INC BC
 643+ 166A 37           	SCF
 644+ 166B 18 BF        	JR PD2_LP2
 645+ 166D
 646+ 166D DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647+ 1670 18 BB        	JR PD2_LOOP
 648+ 1672
 649+ 1672 DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650+ 1675 18 2C        	JR PD2_EXIT
 651+ 1677
 652+ 1677 6F           PD2_NOTE LD L,A
 653+ 1678 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654+ 167B 32 8E 17     	LD (PrNote+1),A
 655+ 167E DD 75 06     	LD (IX-12+CHP.Note),L
 656+ 1681 AF           	XOR A
 657+ 1682 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658+ 1685 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659+ 1689 08           	EX AF,AF'
 660+ 168A 30 16        	JR NC,NOGLIS2
 661+ 168C DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662+ 1690 20 0C        	JR NZ,NOPORT2
 663+ 1692 32 B4 17     	LD (LoStep),A
 664+ 1695 87           	ADD A,A
 665+ 1696 9F           	SBC A,A
 666+ 1697 08           	EX AF,AF'
 667+ 1698 67           	LD H,A
 668+ 1699 6F           	LD L,A
 669+ 169A 3C           	INC A
 670+ 169B CD 6F 17     	CALL SETPORT
 671+ 169E DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672+ 16A2 AF           NOGLIS2	XOR A
 673+ 16A3
 674+ 16A3
 675+ 16A3 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676+ 16A6 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677+ 16A9 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678+ 16AC DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679+ 16AF C3 54 17     	JP PD_FIN
 680+ 16B2
 681+ 16B2              ;PT3 pattern decoder
 682+ 16B2 DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683+ 16B6 CD 55 18     	CALL SETORN
 684+ 16B9 0A           PD_SAM_	LD A,(BC)
 685+ 16BA 03           	INC BC
 686+ 16BB 0F           	RRCA
 687+ 16BC
 688+ 16BC CD 74 18     PD_SAM	CALL SETSAM
 689+ 16BF 18 3F        	JR PD_LOOP
 690+ 16C1
 691+ 16C1 0F           PD_VOL	RRCA
 692+ 16C2 0F           	RRCA
 693+ 16C3 0F           	RRCA
 694+ 16C4 0F           	RRCA
 695+ 16C5 DD 77 10     	LD (IX-12+CHP.Volume),A
 696+ 16C8 18 39        	JR PD_LP2
 697+ 16CA
 698+ 16CA DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699+ 16CD DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700+ 16D0 18 31        	JR PD_LP2
 701+ 16D2
 702+ 16D2 3D           PD_SorE	DEC A
 703+ 16D3 20 07        	JR NZ,PD_ENV
 704+ 16D5 0A           	LD A,(BC)
 705+ 16D6 03           	INC BC
 706+ 16D7 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707+ 16DA 18 27        	JR PD_LP2
 708+ 16DC
 709+ 16DC CD 3A 18     PD_ENV	CALL SETENV
 710+ 16DF 18 22        	JR PD_LP2
 711+ 16E1
 712+ 16E1 CD 55 18     PD_ORN	CALL SETORN
 713+ 16E4 18 1A        	JR PD_LOOP
 714+ 16E6
 715+ 16E6 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716+ 16E9 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717+ 16EC C4 3A 18     	CALL NZ,SETENV
 718+ 16EF 18 C8        	JR PD_SAM_
 719+ 16F1
 720+ 16F1 DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721+ 16F4 32 8E 17     	LD (PrNote+1),A
 722+ 16F7 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723+ 16FA DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724+ 16FD 22 AB 17     	LD (PrSlide+1),HL
 725+ 1700
 726+ 1700 11 10 20     PD_LOOP	LD DE,#2010
 727+ 1703 0A           PD_LP2	LD A,(BC)
 728+ 1704 03           	INC BC
 729+ 1705 83           	ADD A,E
 730+ 1706 38 AA        	JR C,PD_OrSm
 731+ 1708 82           	ADD A,D
 732+ 1709 28 49        	JR Z,PD_FIN
 733+ 170B 38 AF        	JR C,PD_SAM
 734+ 170D 83           	ADD A,E
 735+ 170E 28 25        	JR Z,PD_REL
 736+ 1710 38 AF        	JR C,PD_VOL
 737+ 1712 83           	ADD A,E
 738+ 1713 28 B5        	JR Z,PD_EOff
 739+ 1715 38 BB        	JR C,PD_SorE
 740+ 1717 C6 60        	ADD A,96
 741+ 1719 38 20        	JR C,PD_NOTE
 742+ 171B 83           	ADD A,E
 743+ 171C 38 C3        	JR C,PD_ORN
 744+ 171E 82           	ADD A,D
 745+ 171F 38 0F        	JR C,PD_NOIS
 746+ 1721 83           	ADD A,E
 747+ 1722 38 C2        	JR C,PD_ESAM
 748+ 1724 87           	ADD A,A
 749+ 1725 5F           	LD E,A
 750+ 1726 21 B0 F7     	LD HL,SPCCOMS+#FF20-#2000
 751+ 1729 19           	ADD HL,DE
 752+ 172A 5E           	LD E,(HL)
 753+ 172B 23           	INC HL
 754+ 172C 56           	LD D,(HL)
 755+ 172D D5           	PUSH DE
 756+ 172E 18 D0        	JR PD_LOOP
 757+ 1730
 758+ 1730 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759+ 1733 18 CE        	JR PD_LP2
 760+ 1735
 761+ 1735 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762+ 1739 18 08        	JR PD_RES
 763+ 173B
 764+ 173B DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765+ 173E DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766+ 1742 AF           	XOR A
 767+ 1743
 768+ 1743 ED 73 52 17  PD_RES	LD (PDSP_+1),SP
 769+ 1747 DD F9        	LD SP,IX
 770+ 1749 67           	LD H,A
 771+ 174A 6F           	LD L,A
 772+ 174B E5           	PUSH HL
 773+ 174C E5           	PUSH HL
 774+ 174D E5           	PUSH HL
 775+ 174E E5           	PUSH HL
 776+ 174F E5           	PUSH HL
 777+ 1750 E5           	PUSH HL
 778+ 1751 31 31 31     PDSP_	LD SP,#3131
 779+ 1754
 780+ 1754 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781+ 1757 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782+ 175A C9           	RET
 783+ 175B
 784+ 175B 0A           C_PORTM LD A,(BC)
 785+ 175C 03           	INC BC
 786+ 175D              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787+ 175D              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788+ 175D 03           	INC BC
 789+ 175E 03           	INC BC
 790+ 175F 08           	EX AF,AF'
 791+ 1760 0A           	LD A,(BC) ;SIGNED TONE STEP
 792+ 1761 03           	INC BC
 793+ 1762 32 B4 17     	LD (LoStep),A
 794+ 1765 0A           	LD A,(BC)
 795+ 1766 03           	INC BC
 796+ 1767 A7           	AND A
 797+ 1768 08           	EX AF,AF'
 798+ 1769 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799+ 176C DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800+ 176F
 801+ 176F              ;Set portamento variables
 802+ 176F              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803+ 176F
 804+ 176F DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805+ 1773 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806+ 1776 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807+ 1779 E5           	PUSH HL
 808+ 177A 11 33 1E     	LD DE,NT_
 809+ 177D DD 7E 06     	LD A,(IX-12+CHP.Note)
 810+ 1780 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811+ 1783 87           	ADD A,A
 812+ 1784 6F           	LD L,A
 813+ 1785 26 00        	LD H,0
 814+ 1787 19           	ADD HL,DE
 815+ 1788 7E           	LD A,(HL)
 816+ 1789 23           	INC HL
 817+ 178A 66           	LD H,(HL)
 818+ 178B 6F           	LD L,A
 819+ 178C E5           	PUSH HL
 820+ 178D 3E 3E        PrNote	LD A,#3E
 821+ 178F DD 77 06     	LD (IX-12+CHP.Note),A
 822+ 1792 87           	ADD A,A
 823+ 1793 6F           	LD L,A
 824+ 1794 26 00        	LD H,0
 825+ 1796 19           	ADD HL,DE
 826+ 1797 5E           	LD E,(HL)
 827+ 1798 23           	INC HL
 828+ 1799 56           	LD D,(HL)
 829+ 179A E1           	POP HL
 830+ 179B ED 52        	SBC HL,DE
 831+ 179D DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832+ 17A0 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833+ 17A3 D1           	POP DE
 834+ 17A4              Version EQU $+1
 835+ 17A4 3E 3E        	LD A,#3E
 836+ 17A6 FE 06        	CP 6
 837+ 17A8 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838+ 17AA 11 11 11     PrSlide	LD DE,#1111
 839+ 17AD DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840+ 17B0 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841+ 17B3              LoStep	EQU $+1
 842+ 17B3 3E 3E        OLDPRTM	LD A,#3E
 843+ 17B5 08           	EX AF,AF'
 844+ 17B6 28 01        	JR Z,NOSIG
 845+ 17B8 EB           	EX DE,HL
 846+ 17B9 ED 52        NOSIG	SBC HL,DE
 847+ 17BB F2 C3 17     	JP P,SET_STP
 848+ 17BE 2F           	CPL
 849+ 17BF 08           	EX AF,AF'
 850+ 17C0 ED 44        	NEG
 851+ 17C2 08           	EX AF,AF'
 852+ 17C3 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853+ 17C6 08           	EX AF,AF'
 854+ 17C7 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855+ 17CA DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856+ 17CE C9           	RET
 857+ 17CF
 858+ 17CF DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859+ 17D3 0A           	LD A,(BC)
 860+ 17D4 03           	INC BC
 861+ 17D5 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862+ 17D8 A7           	AND A
 863+ 17D9 20 07        	JR NZ,GL36
 864+ 17DB 3A A5 17     	LD A,(Version) ;AlCo PT3.7+
 865+ 17DE FE 07        	CP 7
 866+ 17E0 9F           	SBC A,A
 867+ 17E1 3C           	INC A
 868+ 17E2 DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869+ 17E5 0A           	LD A,(BC)
 870+ 17E6 03           	INC BC
 871+ 17E7 08           	EX AF,AF'
 872+ 17E8 0A           	LD A,(BC)
 873+ 17E9 03           	INC BC
 874+ 17EA 18 D7        	JR SET_STP
 875+ 17EC
 876+ 17EC 0A           C_SMPOS	LD A,(BC)
 877+ 17ED 03           	INC BC
 878+ 17EE DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879+ 17F1 C9           	RET
 880+ 17F2
 881+ 17F2 0A           C_ORPOS	LD A,(BC)
 882+ 17F3 03           	INC BC
 883+ 17F4 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884+ 17F7 C9           	RET
 885+ 17F8
 886+ 17F8 0A           C_VIBRT	LD A,(BC)
 887+ 17F9 03           	INC BC
 888+ 17FA DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889+ 17FD DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890+ 1800 0A           	LD A,(BC)
 891+ 1801 03           	INC BC
 892+ 1802 DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893+ 1805 AF           	XOR A
 894+ 1806 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895+ 1809 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896+ 180C DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897+ 180F C9           	RET
 898+ 1810
 899+ 1810 0A           C_ENGLS	LD A,(BC)
 900+ 1811 03           	INC BC
 901+ 1812 FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902+ 1815 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903+ 1818 0A           	LD A,(BC)
 904+ 1819 03           	INC BC
 905+ 181A 6F           	LD L,A
 906+ 181B 0A           	LD A,(BC)
 907+ 181C 03           	INC BC
 908+ 181D 67           	LD H,A
 909+ 181E FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910+ 1821 FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911+ 1824 C9           	RET
 912+ 1825
 913+ 1825 0A           C_DELAY	LD A,(BC)
 914+ 1826 03           	INC BC
 915+ 1827 FD 77 08     	LD (IY-100+VRS.Delay),A
 916+ 182A 21 BE 1C     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917+ 182D CB 4E        	BIT 1,(HL)
 918+ 182F C8           	RET Z
 919+ 1830 32 A1 1C     	LD (VARS1+VRS.Delay),A
 920+ 1833 32 A2 1C     	LD (VARS1+VRS.DelyCnt),A
 921+ 1836 32 28 1D     	LD (VARS2+VRS.Delay),A
 922+ 1839 C9           	RET
 923+ 183A
 924+ 183A DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925+ 183D FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926+ 1840 0A           	LD A,(BC)
 927+ 1841 03           	INC BC
 928+ 1842 67           	LD H,A
 929+ 1843 0A           	LD A,(BC)
 930+ 1844 03           	INC BC
 931+ 1845 6F           	LD L,A
 932+ 1846 CD C3 15     	CALL SETENBS
 933+ 1849 AF           	XOR A
 934+ 184A DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935+ 184D FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936+ 1850 67           	LD H,A
 937+ 1851 6F           	LD L,A
 938+ 1852 C3 CA 15     	JP SETESLD
 939+ 1855
 940+ 1855 87           SETORN	ADD A,A
 941+ 1856 5F           	LD E,A
 942+ 1857 16 00        	LD D,0
 943+ 1859 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944+ 185C FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945+ 185F FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946+ 1862 19           	ADD HL,DE
 947+ 1863 5E           	LD E,(HL)
 948+ 1864 23           	INC HL
 949+ 1865 56           	LD D,(HL)
 950+ 1866 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951+ 1869 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952+ 186C 19           	ADD HL,DE
 953+ 186D DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954+ 1870 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955+ 1873 C9           C_NOP	RET
 956+ 1874
 957+ 1874 87           SETSAM	ADD A,A
 958+ 1875 5F           	LD E,A
 959+ 1876 16 00        	LD D,0
 960+ 1878 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961+ 187B FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962+ 187E 19           	ADD HL,DE
 963+ 187F 5E           	LD E,(HL)
 964+ 1880 23           	INC HL
 965+ 1881 56           	LD D,(HL)
 966+ 1882 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967+ 1885 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968+ 1888 19           	ADD HL,DE
 969+ 1889 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970+ 188C DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971+ 188F C9           	RET
 972+ 1890
 973+ 1890              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974+ 1890 73 18        SPCCOMS DW C_NOP
 975+ 1892 CF 17        	DW C_GLISS
 976+ 1894 5B 17        	DW C_PORTM
 977+ 1896 EC 17        	DW C_SMPOS
 978+ 1898 F2 17        	DW C_ORPOS
 979+ 189A F8 17        	DW C_VIBRT
 980+ 189C 73 18        	DW C_NOP
 981+ 189E 73 18        	DW C_NOP
 982+ 18A0 10 18        	DW C_ENGLS
 983+ 18A2 25 18        	DW C_DELAY
 984+ 18A4 73 18        	DW C_NOP
 985+ 18A6 73 18        	DW C_NOP
 986+ 18A8 73 18        	DW C_NOP
 987+ 18AA 73 18        	DW C_NOP
 988+ 18AC 73 18        	DW C_NOP
 989+ 18AE 73 18        	DW C_NOP
 990+ 18B0
 991+ 18B0 CD D1 15     CHREGS	CALL GETIX
 992+ 18B3 AF           	XOR A
 993+ 18B4 32 F0 1A     	LD (Ampl),A
 994+ 18B7 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995+ 18BB E5           	PUSH HL
 996+ 18BC CA 03 1A     	JP Z,CH_EXIT
 997+ 18BF ED 73 4D 19  	LD (CSP_+1),SP
 998+ 18C3 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999+ 18C6 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000+ 18C9 F9           	LD SP,HL
1001+ 18CA D1           	POP DE
1002+ 18CB 67           	LD H,A
1003+ 18CC DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004+ 18CF 6F           	LD L,A
1005+ 18D0 39           	ADD HL,SP
1006+ 18D1 3C           	INC A
1007+ 18D2              		;PT2	PT3
1008+ 18D2 3C           OrnCP	INC A	;CP E	CP D
1009+ 18D3 38 01        	JR C,CH_ORPS
1010+ 18D5 01           OrnLD	DB 1	;LD A,D	LD A,E
1011+ 18D6 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012+ 18D9 DD 7E 12     	LD A,(IX+CHP.Note)
1013+ 18DC 86           	ADD A,(HL)
1014+ 18DD F2 E1 18     	JP P,CH_NTP
1015+ 18E0 AF           	XOR A
1016+ 18E1 FE 60        CH_NTP	CP 96
1017+ 18E3 38 02        	JR C,CH_NOK
1018+ 18E5 3E 5F        	LD A,95
1019+ 18E7 87           CH_NOK	ADD A,A
1020+ 18E8 08           	EX AF,AF'
1021+ 18E9 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022+ 18EC DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023+ 18EF F9           	LD SP,HL
1024+ 18F0 D1           	POP DE
1025+ 18F1 26 00        	LD H,0
1026+ 18F3 DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027+ 18F6 47           	LD B,A
1028+ 18F7 87           	ADD A,A
1029+ 18F8 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030+ 18F9 6F           	LD L,A
1031+ 18FA 39           	ADD HL,SP
1032+ 18FB F9           	LD SP,HL
1033+ 18FC 78           	LD A,B
1034+ 18FD 3C           	INC A
1035+ 18FE              		;PT2	PT3
1036+ 18FE 3C           SamCP	INC A	;CP E	CP D
1037+ 18FF 38 01        	JR C,CH_SMPS
1038+ 1901 01           SamLD	DB 1	;LD A,D	LD A,E
1039+ 1902 DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040+ 1905 C1           	POP BC
1041+ 1906 E1           	POP HL
1042+ 1907
1043+ 1907              ;Convert PT2 sample to PT3
1044+ 1907              		;PT2		PT3
1045+ 1907 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046+ 1908 E1           	POP HL
1047+ 1909 60           	LD H,B
1048+ 190A 20 06        	JR NZ,$+8
1049+ 190C EB           	EX DE,HL
1050+ 190D A7           	AND A
1051+ 190E ED 62        	SBC HL,HL
1052+ 1910 ED 52        	SBC HL,DE
1053+ 1912 51           	LD D,C
1054+ 1913 CB 19        	RR C
1055+ 1915 9F           	SBC A,A
1056+ 1916 2F           	CPL
1057+ 1917 E6 3E        	AND #3E
1058+ 1919 CB 19        	RR C
1059+ 191B CB 18        	RR B
1060+ 191D A1           	AND C
1061+ 191E 4F           	LD C,A
1062+ 191F 78           	LD A,B
1063+ 1920 1F           	RRA
1064+ 1921 1F           	RRA
1065+ 1922 CB 1A        	RR D
1066+ 1924 1F           	RRA
1067+ 1925 E6 9F        	AND #9F
1068+ 1927 47           	LD B,A
1069+ 1928
1070+ 1928 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071+ 192B DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072+ 192E 19           	ADD HL,DE
1073+ 192F CB 70        	BIT 6,B
1074+ 1931 28 06        	JR Z,CH_NOAC
1075+ 1933 DD 75 08     	LD (IX+CHP.TnAcc),L
1076+ 1936 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077+ 1939 EB           CH_NOAC EX DE,HL
1078+ 193A 08           	EX AF,AF'
player.asm(1079): warning: value 0x1E33 is truncated to 8bit value: 0x33
1079+ 193B C6 33        	ADD A,NT_
1080+ 193D 6F           	LD L,A
1081+ 193E CE 1E        	ADC A,NT_/256
1082+ 1940 95           	SUB L
1083+ 1941 67           	LD H,A
1084+ 1942 F9           	LD SP,HL
1085+ 1943 E1           	POP HL
1086+ 1944 19           	ADD HL,DE
1087+ 1945 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088+ 1948 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089+ 194B 19           	ADD HL,DE
1090+ 194C 31 31 31     CSP_	LD SP,#3131
1091+ 194F E3           	EX (SP),HL
1092+ 1950 AF           	XOR A
1093+ 1951 DD B6 05     	OR (IX+CHP.TSlCnt)
1094+ 1954 28 3E        	JR Z,CH_AMP
1095+ 1956 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096+ 1959 20 39        	JR NZ,CH_AMP
1097+ 195B DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098+ 195E DD 77 05     	LD (IX+CHP.TSlCnt),A
1099+ 1961 DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100+ 1964 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101+ 1967 7C           	LD A,H
1102+ 1968 19           	ADD HL,DE
1103+ 1969 DD 75 06     	LD (IX+CHP.CrTnSl),L
1104+ 196C DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105+ 196F DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106+ 1973 20 1F        	JR NZ,CH_AMP
1107+ 1975 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108+ 1978 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109+ 197B A7           	AND A
1110+ 197C 28 01        	JR Z,CH_STPP
1111+ 197E EB           	EX DE,HL
1112+ 197F ED 52        CH_STPP SBC HL,DE
1113+ 1981 FA 94 19     	JP M,CH_AMP
1114+ 1984 DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115+ 1987 DD 77 12     	LD (IX+CHP.Note),A
1116+ 198A AF           	XOR A
1117+ 198B DD 77 05     	LD (IX+CHP.TSlCnt),A
1118+ 198E DD 77 06     	LD (IX+CHP.CrTnSl),A
1119+ 1991 DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120+ 1994 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121+ 1997 CB 79        	BIT 7,C
1122+ 1999 28 13        	JR Z,CH_NOAM
1123+ 199B CB 71        	BIT 6,C
1124+ 199D 28 07        	JR Z,CH_AMIN
1125+ 199F FE 0F        	CP 15
1126+ 19A1 28 0B        	JR Z,CH_NOAM
1127+ 19A3 3C           	INC A
1128+ 19A4 18 05        	JR CH_SVAM
1129+ 19A6 FE F1        CH_AMIN	CP -15
1130+ 19A8 28 04        	JR Z,CH_NOAM
1131+ 19AA 3D           	DEC A
1132+ 19AB DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133+ 19AE 6F           CH_NOAM	LD L,A
1134+ 19AF 78           	LD A,B
1135+ 19B0 E6 0F        	AND 15
1136+ 19B2 85           	ADD A,L
1137+ 19B3 F2 B7 19     	JP P,CH_APOS
1138+ 19B6 AF           	XOR A
1139+ 19B7 FE 10        CH_APOS	CP 16
1140+ 19B9 38 02        	JR C,CH_VOL
1141+ 19BB 3E 0F        	LD A,15
1142+ 19BD DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x1D33 is truncated to 8bit value: 0x33
1143+ 19C0 C6 33        	ADD A,VT_
1144+ 19C2 6F           	LD L,A
1145+ 19C3 CE 1D        	ADC A,VT_/256
1146+ 19C5 95           	SUB L
1147+ 19C6 67           	LD H,A
1148+ 19C7 7E           	LD A,(HL)
1149+ 19C8 CB 41        CH_ENV	BIT 0,C
1150+ 19CA 20 03        	JR NZ,CH_NOEN
1151+ 19CC DD B6 14     	OR (IX+CHP.Env_En)
1152+ 19CF 32 F0 1A     CH_NOEN	LD (Ampl),A
1153+ 19D2 CB 78        	BIT 7,B
1154+ 19D4 79           	LD A,C
1155+ 19D5 28 1A        	JR Z,NO_ENSL
1156+ 19D7 17           	RLA
1157+ 19D8 17           	RLA
1158+ 19D9 CB 2F        	SRA A
1159+ 19DB CB 2F        	SRA A
1160+ 19DD CB 2F        	SRA A
1161+ 19DF DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162+ 19E2 CB 68        	BIT 5,B
1163+ 19E4 28 03        	JR Z,NO_ENAC
1164+ 19E6 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165+ 19E9 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166+ 19EC FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167+ 19EF 18 0E        	JR CH_MIX
1168+ 19F1 1F           NO_ENSL RRA
1169+ 19F2 DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170+ 19F5 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171+ 19F8 CB 68        	BIT 5,B
1172+ 19FA 28 03        	JR Z,CH_MIX
1173+ 19FC DD 77 03     	LD (IX+CHP.CrNsSl),A
1174+ 19FF 78           CH_MIX	LD A,B
1175+ 1A00 1F           	RRA
1176+ 1A01 E6 48        	AND #48
1177+ 1A03 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178+ 1A06 0F           	RRCA
1179+ 1A07 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180+ 1A0A E1           	POP HL
1181+ 1A0B AF           	XOR A
1182+ 1A0C DD B6 0A     	OR (IX+CHP.COnOff)
1183+ 1A0F C8           	RET Z
1184+ 1A10 DD 35 0A     	DEC (IX+CHP.COnOff)
1185+ 1A13 C0           	RET NZ
1186+ 1A14 DD AE 15     	XOR (IX+CHP.Flags)
1187+ 1A17 DD 77 15     	LD (IX+CHP.Flags),A
1188+ 1A1A 1F           	RRA
1189+ 1A1B DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190+ 1A1E 38 03        	JR C,CH_ONDL
1191+ 1A20 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192+ 1A23 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193+ 1A26 C9           	RET
1194+ 1A27
1195+ 1A27 AF           PLAY_	XOR A
1196+ 1A28 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197+ 1A2B FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198+ 1A2E 3D           	DEC A
1199+ 1A2F FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200+ 1A32 FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201+ 1A35 C2 DD 1A     	JP NZ,PL2
1202+ 1A38 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203+ 1A3B 20 6C        	JR NZ,PL1B
1204+ 1A3D FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205+ 1A40 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206+ 1A43 0A           	LD A,(BC)
1207+ 1A44 A7           	AND A
1208+ 1A45 20 56        	JR NZ,PL1A
1209+ 1A47 57           	LD D,A
1210+ 1A48 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211+ 1A4B FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212+ 1A4E FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213+ 1A51 23           	INC HL
1214+ 1A52 7E           	LD A,(HL)
1215+ 1A53 3C           	INC A
1216+ 1A54 20 0B        	JR NZ,PLNLP
1217+ 1A56
1218+ 1A56              	IF LoopChecker
1219+ 1A56 CD 08 13     	CALL CHECKLP
1220+ 1A59              	ENDIF
1221+ 1A59
1222+ 1A59 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223+ 1A5C FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224+ 1A5F 7E           	LD A,(HL)
1225+ 1A60 3C           	INC A
1226+ 1A61 CD B5 15     PLNLP	CALL SETCPPT
1227+ 1A64 3D           	DEC A
1228+ 1A65 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229+ 1A69 28 03        	JR Z,NoAlCo
1230+ 1A6B              TSSub	EQU $+1
1231+ 1A6B D6 D6        	SUB #D6
1232+ 1A6D 2F           	CPL
1233+ 1A6E              NoAlCo
1234+ 1A6E              		;PT2		PT3
1235+ 1A6E 3D           PsCalc	DEC A	;ADD A,A	NOP
1236+ 1A6F 3D           	DEC A	;ADD A,(HL)	NOP
1237+ 1A70 87           	ADD A,A
1238+ 1A71 5F           	LD E,A
1239+ 1A72 CB 12        	RL D
1240+ 1A74
1241+ 1A74              	IF CurPosCounter
1242+ 1A74 ~            	LD A,L
1243+ 1A74 ~            	SUB (IY-100+VRS.PosSub)
1244+ 1A74 ~            	LD (IY-100+VRS.CurPos),A
1245+ 1A74              	ENDIF
1246+ 1A74
1247+ 1A74 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248+ 1A77 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249+ 1A7A 19           	ADD HL,DE
1250+ 1A7B FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251+ 1A7E FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252+ 1A81 ED 73 9B 1A  	LD (PSP_+1),SP
1253+ 1A85 F9           	LD SP,HL
1254+ 1A86 E1           	POP HL
1255+ 1A87 19           	ADD HL,DE
1256+ 1A88 44           	LD B,H
1257+ 1A89 4D           	LD C,L
1258+ 1A8A E1           	POP HL
1259+ 1A8B 19           	ADD HL,DE
1260+ 1A8C FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261+ 1A8F FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262+ 1A92 E1           	POP HL
1263+ 1A93 19           	ADD HL,DE
1264+ 1A94 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265+ 1A97 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266+ 1A9A 31 31 31     PSP_	LD SP,#3131
1267+ 1A9D 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268+ 1AA0 CD D8 15     	CALL PTDECOD
1269+ 1AA3 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270+ 1AA6 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271+ 1AA9
1272+ 1AA9 FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273+ 1AAC 20 12        	JR NZ,PL1C
1274+ 1AAE 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275+ 1AB1 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276+ 1AB4 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277+ 1AB7 CD D8 15     	CALL PTDECOD
1278+ 1ABA FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279+ 1ABD FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280+ 1AC0
1281+ 1AC0 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282+ 1AC3 20 12        	JR NZ,PL1D
1283+ 1AC5 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284+ 1AC8 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285+ 1ACB FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286+ 1ACE CD D8 15     	CALL PTDECOD
1287+ 1AD1 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288+ 1AD4 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289+ 1AD7
1290+ 1AD7 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291+ 1ADA FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292+ 1ADD
1293+ 1ADD 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294+ 1AE0 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295+ 1AE3 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296+ 1AE6 CD B0 18     	CALL CHREGS
1297+ 1AE9 FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298+ 1AEC FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299+ 1AEF              Ampl	EQU $+1
1300+ 1AEF 3E 3E        	LD A,#3E
1301+ 1AF1 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302+ 1AF4 11 BC FF     	LD DE,VRS.ChanB-100
1303+ 1AF7 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304+ 1AFA FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305+ 1AFD CD B0 18     	CALL CHREGS
1306+ 1B00 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307+ 1B03 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308+ 1B06 3A F0 1A     	LD A,(Ampl)
1309+ 1B09 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310+ 1B0C 11 D9 FF     	LD DE,VRS.ChanC-100
1311+ 1B0F FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312+ 1B12 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313+ 1B15 CD B0 18     	CALL CHREGS
1314+ 1B18 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315+ 1B1B FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316+ 1B1E 3A F0 1A     	LD A,(Ampl)
1317+ 1B21 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318+ 1B24
1319+ 1B24 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320+ 1B27 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321+ 1B2A FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322+ 1B2D
1323+ 1B2D FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324+ 1B30 5F           	LD E,A
1325+ 1B31 87           	ADD A,A
1326+ 1B32 9F           	SBC A,A
1327+ 1B33 57           	LD D,A
1328+ 1B34 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329+ 1B37 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330+ 1B3A 19           	ADD HL,DE
1331+ 1B3B FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332+ 1B3E FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333+ 1B41 19           	ADD HL,DE
1334+ 1B42 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335+ 1B45 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336+ 1B48
1337+ 1B48 AF           	XOR A
1338+ 1B49 FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339+ 1B4C C8           	RET Z
1340+ 1B4D FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341+ 1B50 C0           	RET NZ
1342+ 1B51 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343+ 1B54 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344+ 1B57 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345+ 1B5A FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346+ 1B5D 19           	ADD HL,DE
1347+ 1B5E C3 CA 15     	JP SETESLD
1348+ 1B61
1349+ 1B61 FD 21 99 1C  PLAY    LD IY,VARS1+100
1350+ 1B65 CD 27 1A     	CALL PLAY_
1351+ 1B68 3A 34 1C     	LD A,(is_ts)
1352+ 1B6B A7           	AND A
1353+ 1B6C 28 07        	JR Z,PL_nts
1354+ 1B6E FD 21 20 1D  	LD IY,VARS2+100
1355+ 1B72 CD 27 1A     	CALL PLAY_
1356+ 1B75              PL_nts
1357+ 1B75              	IF Basic
1358+ 1B75 FD 21 3A 5C  	LD IY,#5C3A
1359+ 1B79              	ENDIF
1360+ 1B79
1361+ 1B79 01 FD FF     ROUT	LD BC,#FFFD
1362+ 1B7C 3A 34 1C     	LD A,(is_ts)
1363+ 1B7F A7           	AND A
1364+ 1B80 28 02        	JR Z,r_nts ;keep old standard
1365+ 1B82 ED 41        	OUT (C),B
1366+ 1B84 08           r_nts	EX AF,AF'
1367+ 1B85
1368+ 1B85              	IF ACBBAC
1369+ 1B85 ~            	LD IX,VARS1+VRS.AYREGS
1370+ 1B85              	ELSE
1371+ 1B85 21 AE 1C     	LD HL,VARS1+VRS.AYREGS
1372+ 1B88              	ENDIF
1373+ 1B88
1374+ 1B88 CD 94 1B     	CALL ROUT_
1375+ 1B8B 08           	EX AF,AF'
1376+ 1B8C C8           	RET Z
1377+ 1B8D 42           	LD B,D
1378+ 1B8E 2F           	CPL
1379+ 1B8F ED 79        	OUT (C),A
1380+ 1B91
1381+ 1B91              	IF ACBBAC
1382+ 1B91 ~            	LD IX,VARS2+VRS.AYREGS
1383+ 1B91              	ELSE
1384+ 1B91 21 35 1D     	LD HL,VARS2+VRS.AYREGS
1385+ 1B94              	ENDIF
1386+ 1B94
1387+ 1B94              ROUT_
1388+ 1B94              	IF ACBBAC
1389+ 1B94 ~            	LD A,(SETUP)
1390+ 1B94 ~            	AND 12
1391+ 1B94 ~            	JR Z,ABC
1392+ 1B94 ~            	ADD A,CHTABLE
1393+ 1B94 ~            	LD E,A
1394+ 1B94 ~            	ADC A,CHTABLE/256
1395+ 1B94 ~            	SUB E
1396+ 1B94 ~            	LD D,A
1397+ 1B94 ~            	LD B,0
1398+ 1B94 ~            	PUSH IX
1399+ 1B94 ~            	POP HL
1400+ 1B94 ~            	LD A,(DE)
1401+ 1B94 ~            	INC DE
1402+ 1B94 ~            	LD C,A
1403+ 1B94 ~            	ADD HL,BC
1404+ 1B94 ~            	LD A,(IX+TonB)
1405+ 1B94 ~            	LD C,(HL)
1406+ 1B94 ~            	LD (IX+TonB),C
1407+ 1B94 ~            	LD (HL),A
1408+ 1B94 ~            	INC HL
1409+ 1B94 ~            	LD A,(IX+TonB+1)
1410+ 1B94 ~            	LD C,(HL)
1411+ 1B94 ~            	LD (IX+TonB+1),C
1412+ 1B94 ~            	LD (HL),A
1413+ 1B94 ~            	LD A,(DE)
1414+ 1B94 ~            	INC DE
1415+ 1B94 ~            	LD C,A
1416+ 1B94 ~            	ADD HL,BC
1417+ 1B94 ~            	LD A,(IX+AmplB)
1418+ 1B94 ~            	LD C,(HL)
1419+ 1B94 ~            	LD (IX+AmplB),C
1420+ 1B94 ~            	LD (HL),A
1421+ 1B94 ~            	LD A,(DE)
1422+ 1B94 ~            	INC DE
1423+ 1B94 ~            	LD (RxCA1),A
1424+ 1B94 ~            	XOR 8
1425+ 1B94 ~            	LD (RxCA2),A
1426+ 1B94 ~            	LD A,(DE)
1427+ 1B94 ~            	AND (IX+Mixer)
1428+ 1B94 ~            	LD E,A
1429+ 1B94 ~            	LD A,(IX+Mixer)
1430+ 1B94 ~            RxCA1	DB #E6
1431+ 1B94 ~            	AND %010010
1432+ 1B94 ~            	OR E
1433+ 1B94 ~            	LD E,A
1434+ 1B94 ~            	LD A,(IX+Mixer)
1435+ 1B94 ~            	AND %010010
1436+ 1B94 ~            RxCA2	OR E
1437+ 1B94 ~            	OR E
1438+ 1B94 ~            	LD (IX+Mixer),A
1439+ 1B94 ~            ABC
1440+ 1B94              	ENDIF
1441+ 1B94
1442+ 1B94 AF           	XOR A
1443+ 1B95 11 BF FF     	LD DE,#FFBF
1444+ 1B98
1445+ 1B98              	IF ACBBAC
1446+ 1B98 ~            	LD BC,#FFFD
1447+ 1B98 ~            	PUSH IX
1448+ 1B98 ~            	POP HL
1449+ 1B98              	ENDIF
1450+ 1B98
1451+ 1B98 ED 79        LOUT	OUT (C),A
1452+ 1B9A 43           	LD B,E
1453+ 1B9B ED A3        	OUTI
1454+ 1B9D 42           	LD B,D
1455+ 1B9E 3C           	INC A
1456+ 1B9F FE 0D        	CP 13
1457+ 1BA1 20 F5        	JR NZ,LOUT
1458+ 1BA3 ED 79        	OUT (C),A
1459+ 1BA5 7E           	LD A,(HL)
1460+ 1BA6 A7           	AND A
1461+ 1BA7 F8           	RET M
1462+ 1BA8 43           	LD B,E
1463+ 1BA9 ED 79        	OUT (C),A
1464+ 1BAB C9           	RET
1465+ 1BAC
1466+ 1BAC              	IF ACBBAC
1467+ 1BAC ~            CHTABLE	EQU $-4
1468+ 1BAC ~            	DB 4,5,15,%001001,0,7,7,%100100
1469+ 1BAC              	ENDIF
1470+ 1BAC
1471+ 1BAC 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472+ 1BAD 2A           	DB TCNEW_0-T_
1473+ 1BAE 65           	DB (T_OLD_0-T1_)*2+1
1474+ 1BAF 00           	DB TCOLD_0-T_
1475+ 1BB0 01           	DB (T_NEW_1-T1_)*2+1
1476+ 1BB1 0C           	DB TCNEW_1-T_
1477+ 1BB2 01           	DB (T_OLD_1-T1_)*2+1
1478+ 1BB3 0C           	DB TCOLD_1-T_
1479+ 1BB4 94           	DB (T_NEW_2-T1_)*2
1480+ 1BB5 35           	DB TCNEW_2-T_
1481+ 1BB6 30           	DB (T_OLD_2-T1_)*2
1482+ 1BB7 0E           	DB TCOLD_2-T_
1483+ 1BB8 60           	DB (T_NEW_3-T1_)*2
1484+ 1BB9 20           	DB TCNEW_3-T_
1485+ 1BBA 60           	DB (T_OLD_3-T1_)*2
1486+ 1BBB 21           	DB TCOLD_3-T_
1487+ 1BBC
1488+ 1BBC              T_
1489+ 1BBC
1490+ 1BBC 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490+ 1BC0 0D 0F 13 15
1491+ 1BC4 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492+ 1BC8 5D 00        TCOLD_1	DB #5C+1,0
1493+ 1BCA 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493+ 1BCE 5F 71 82 8C
1493+ 1BD2 9C
1494+ 1BD3 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494+ 1BD7 AA AC AE AE
1494+ 1BDB 00
1495+ 1BDC 57           TCNEW_3	DB #56+1
1496+ 1BDD 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496+ 1BE1 2D 2F 33 BF
1496+ 1BE5 00
1497+ 1BE6 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497+ 1BEA 2B 2D 31 55
1498+ 1BEE BD BF 00     	DB #BC+1,#BE+1,0
1499+ 1BF1              TCNEW_1 EQU TCOLD_1
1500+ 1BF1 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500+ 1BF5 2B 3B 4D 5F
1501+ 1BF9 BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502+ 1BFD
1503+ 1BFD              PT3EMPTYORN EQU $-1
1504+ 1BFD 01 00        	DB 1,0
1505+ 1BFF
1506+ 1BFF              ;first 12 values of tone tables (packed)
1507+ 1BFF
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508+ 1BFF 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509+ 1C01 69           	DB #0755-#06EC
1510+ 1C02 70           	DB #07C5-#0755
1511+ 1C03 76           	DB #083B-#07C5
1512+ 1C04 7D           	DB #08B8-#083B
1513+ 1C05 85           	DB #093D-#08B8
1514+ 1C06 8D           	DB #09CA-#093D
1515+ 1C07 95           	DB #0A5F-#09CA
1516+ 1C08 9D           	DB #0AFC-#0A5F
1517+ 1C09 A8           	DB #0BA4-#0AFC
1518+ 1C0A B1           	DB #0C55-#0BA4
1519+ 1C0B BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520+ 1C0C 0C DA        	DB #066D*2/256,#066D*2
1521+ 1C0E 62           	DB #06CF-#066D
1522+ 1C0F 68           	DB #0737-#06CF
1523+ 1C10 6D           	DB #07A4-#0737
1524+ 1C11 75           	DB #0819-#07A4
1525+ 1C12 7B           	DB #0894-#0819
1526+ 1C13 83           	DB #0917-#0894
1527+ 1C14 8A           	DB #09A1-#0917
1528+ 1C15 92           	DB #0A33-#09A1
1529+ 1C16 9C           	DB #0ACF-#0A33
1530+ 1C17 A4           	DB #0B73-#0ACF
1531+ 1C18 AF           	DB #0C22-#0B73
1532+ 1C19 B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533+ 1C1A 0E 08        	DB #0704*2/256,#0704*2
1534+ 1C1C 6A           	DB #076E-#0704
1535+ 1C1D 72           	DB #07E0-#076E
1536+ 1C1E 78           	DB #0858-#07E0
1537+ 1C1F 7E           	DB #08D6-#0858
1538+ 1C20 86           	DB #095C-#08D6
1539+ 1C21 90           	DB #09EC-#095C
1540+ 1C22 96           	DB #0A82-#09EC
1541+ 1C23 A0           	DB #0B22-#0A82
1542+ 1C24 AA           	DB #0BCC-#0B22
1543+ 1C25 B4           	DB #0C80-#0BCC
1544+ 1C26 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545+ 1C27 0F C0        	DB #07E0*2/256,#07E0*2
1546+ 1C29 78           	DB #0858-#07E0
1547+ 1C2A 88           	DB #08E0-#0858
1548+ 1C2B 80           	DB #0960-#08E0
1549+ 1C2C 90           	DB #09F0-#0960
1550+ 1C2D 98           	DB #0A88-#09F0
1551+ 1C2E A0           	DB #0B28-#0A88
1552+ 1C2F B0           	DB #0BD8-#0B28
1553+ 1C30 A8           	DB #0C80-#0BD8
1554+ 1C31 E0           	DB #0D60-#0C80
1555+ 1C32 B0           	DB #0E10-#0D60
1556+ 1C33 E8           	DB #0EF8-#0E10
1557+ 1C34
1558+ 1C34              ;vars from here can be stripped
1559+ 1C34              ;you can move VARS to any other address
1560+ 1C34
1561+ 1C34              VARS
1562+ 1C34
1563+ 1C34 00           is_ts	DB 0
1564+ 1C35
1565+ 1C35              ;ChannelsVars
1566+ 1C35              	STRUCT	CHP
1567+ 1C35 ~            ;reset group
1568+ 1C35 ~            PsInOr	DB 0
1569+ 1C35 ~            PsInSm	DB 0
1570+ 1C35 ~            CrAmSl	DB 0
1571+ 1C35 ~            CrNsSl	DB 0
1572+ 1C35 ~            CrEnSl	DB 0
1573+ 1C35 ~            TSlCnt	DB 0
1574+ 1C35 ~            CrTnSl	DW 0
1575+ 1C35 ~            TnAcc	DW 0
1576+ 1C35 ~            COnOff	DB 0
1577+ 1C35 ~            ;reset group
1578+ 1C35 ~
1579+ 1C35 ~            OnOffD	DB 0
1580+ 1C35 ~
1581+ 1C35 ~            ;IX for PTDECOD here (+12)
1582+ 1C35 ~            OffOnD	DB 0
1583+ 1C35 ~            OrnPtr	DW 0
1584+ 1C35 ~            SamPtr	DW 0
1585+ 1C35 ~            NNtSkp	DB 0
1586+ 1C35 ~            Note	DB 0
1587+ 1C35 ~            SlToNt	DB 0
1588+ 1C35 ~            Env_En	DB 0
1589+ 1C35 ~            Flags	DB 0
1590+ 1C35 ~             ;Enabled - 0, SimpleGliss - 2
1591+ 1C35 ~            TnSlDl	DB 0
1592+ 1C35 ~            TSlStp	DW 0
1593+ 1C35 ~            TnDelt	DW 0
1594+ 1C35 ~            NtSkCn	DB 0
1595+ 1C35 ~            Volume	DB 0
1596+ 1C35              	ENDS
1597+ 1C35
1598+ 1C35              	STRUCT	VRS
1599+ 1C35 ~
1600+ 1C35 ~            ;IF not works in STRUCT in SjASM :(
1601+ 1C35 ~            ;	IF CurPosCounter
1602+ 1C35 ~            CurPos	DB 0
1603+ 1C35 ~            PosSub	DB 0
1604+ 1C35 ~            ;	ENDIF
1605+ 1C35 ~
1606+ 1C35 ~            ModNum	DB 0 ;bit0: ChipNum
1607+ 1C35 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608+ 1C35 ~
1609+ 1C35 ~            ChanA	DS CHP
1610+ 1C35 ~            ChanB	DS CHP
1611+ 1C35 ~            ChanC	DS CHP
1612+ 1C35 ~
1613+ 1C35 ~            ;GlobalVars
1614+ 1C35 ~            MODADDR	DW 0
1615+ 1C35 ~            OrnPtrs	DW 0
1616+ 1C35 ~            SamPtrs	DW 0
1617+ 1C35 ~            PatsPtr	DW 0
1618+ 1C35 ~            AdInPtA	DW 0
1619+ 1C35 ~            AdInPtB	DW 0
1620+ 1C35 ~            AdInPtC	DW 0
1621+ 1C35 ~            CrPsPtr	DW 0
1622+ 1C35 ~            LPosPtr	DW 0
1623+ 1C35 ~            Delay	DB 0
1624+ 1C35 ~            DelyCnt	DB 0
1625+ 1C35 ~            ESldAdd	DW 0
1626+ 1C35 ~            CurESld	DW 0
1627+ 1C35 ~            Env_Del	DB 0
1628+ 1C35 ~            CurEDel	DB 0
1629+ 1C35 ~            Ns_Base	DB 0
1630+ 1C35 ~            AddToNs	DB 0
1631+ 1C35 ~            AddToEn	DB 0
1632+ 1C35 ~            EnvBase	DW 0
1633+ 1C35 ~            AYREGS	DS 14
1634+ 1C35              	ENDS
1635+ 1C35
1636+ 1C35 00 00 00...  VARS1	DS VRS
1637+ 1CBC 00 00 00...  VARS2	DS VRS
1638+ 1D43
1639+ 1D43              VT_	EQU $-16
1640+ 1D43 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641+ 1E33
1642+ 1E33              T1_	EQU VT_+16 ;Tone tables data depacked here
1643+ 1E33
1644+ 1E33              T_OLD_1	EQU T1_
1645+ 1E33              T_OLD_2	EQU T_OLD_1+24
1646+ 1E33              T_OLD_3	EQU T_OLD_2+24
1647+ 1E33              T_OLD_0	EQU T_OLD_3+2
1648+ 1E33              T_NEW_0	EQU T_OLD_0
1649+ 1E33              T_NEW_1	EQU T_OLD_1
1650+ 1E33              T_NEW_2	EQU T_NEW_0+24
1651+ 1E33              T_NEW_3	EQU T_OLD_3
1652+ 1E33
1653+ 1E33              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654+ 1E33
1655+ 1E33 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656+ 1EF3
1657+ 1EF3              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658+ 1EF3
1659+ 1EF3              VARSEND EQU $
1660+ 1EF3
1661+ 1EF3              MDLADDR EQU outputBuffer
1662+ 1EF3
1663+ 1EF3              ;Release 0 steps:
1664+ 1EF3              ;04/21/2007
1665+ 1EF3              ;Works start (PTxPlay adaptation); first beta.
1666+ 1EF3              ;04/22/2007
1667+ 1EF3              ;Job finished; beta-testing.
1668+ 1EF3              ;04/23/2007
1669+ 1EF3              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670+ 1EF3              ;04/29/2007
1671+ 1EF3              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672+ 1EF3              ;modules of v3.7+.
1673+ 1EF3
1674+ 1EF3              ;Size (minimal build for ZX Spectrum):
1675+ 1EF3              ;Code block #908 bytes
1676+ 1EF3              ;Variables #2BF bytes (can be stripped)
1677+ 1EF3              ;Total size #908+#2BF=#BC7 (3015) bytes
1678+ 1EF3              	ENDMODULE
# file closed: player.asm
1804  1EF3 00 00 00...  	align 256
1805  1F00              font
1806  1F00              	incbin fontV6.chr ;шрифт
1807  2700
1808  2700              ;Переменные
1809  2700 00           uart_enable db 0; флаг есть порт uart
1810  2701 00           proc_play_ay db 0 ;код процесса с музыкой AY
1811  2702 00           proc_play_ay_slot2 db 0 ;страница с музыкой AY
1812  2703 00           proc_play_ay_slot3 db 0 ;страница с музыкой AY
1813  2704 00           scr_cur db 0 ;текущий активный экран
1814  2705 00           proc_id_focus db 0 ;процесс, у которого фокус (видимый экран и доступно управление)
1815  2706 00 00        proc_stack_addr_tmp dw 0 ; временно адрес стека
1816  2708 00 00        proc_stack_addr_return_tmp dw 0 ;временно адрес возврата из прерываний
1817  270A 00           proc_switch_key_flag db 0 ;флаг что нажата клавиша переключения задач
1818  270B              ;stack_adr_sys dw 0 ;адрес системного стека
1819  270B 00           page_slot3_cur db 0 ;текущая страница вы слоте 3
1820  270C 00           page_slot2_cur db 0 ;текущая страница вы слоте 2
1821  270D 00           con_scr_cur db 0 ;страница активного экрана пиксели
1822  270E 00           con_atr_cur db 0 ;страница активного экрана атрибуты
1823  270F 00           key_cur db 0 ;печатный код нажатой клавиши
1824  2710 00           file_id_cur db 0 ;временно id файла
1825  2711
1826  2711 00           proc_id_next db 0 ;код следующего процесса
1827  2712 00 00        proc_stack_adr_tmp dw 0 ;временно адрес стека
1828  2714 00           proc_id_cur db 0 ;id текущего процесса
1829  2715              ;proc_id_cur_tmp db 0 ;временно id процесса
1830  2715 53 59 53 20  proc_sys_name db "SYS        ",0 ;имя системного процесса
1830  2719 20 20 20 20
1830  271D 20 20 20 00
1831  2721 43 4D 44 20  proc_cmd_name db "CMD        ",0 ;имя процесса консоль
1831  2725 20 20 20 20
1831  2729 20 20 20 00
1832  272D 00 00 00 00  sys_timer ds 4 ;таймер - счётчик прерываний
1833  2731
1834  2731 00 00 00...  	align 256
1835  2800              proc_table ;данные процессов и приложений
1836  2800 00 00 00...  	ds proc_descr_size*proc_max ;на командную строку, список страниц и прочее
1837  3000              	;#00 - id процесса
1838  3000              	;#01 - id родительского
1839  3000              	;#02 - страница #8000
1840  3000              	;#03 - страница #c000
1841  3000              	;#04 - страница буфер экран пиксели
1842  3000              	;#05 - страница буфер экран атрибуты
1843  3000              	;#06-07 - адрес стека
1844  3000              	;#08-09 - позиция аппаратного скрола
1845  3000              	;#0a-0b - координаты курсора
1846  3000              	;#0c-0d - цвет текста основной, цвет второй
1847  3000              	;#0e-0f - адрес вызова по прерыванию
1848  3000              	;#0f-1a - Имя
1849  3000
1850  3000              	;..#80 - верх стека
1851  3000
1852  3000              proc_page_table	;таблица занятых процессами страниц
1853  3000 00 00 00...  	ds 128 ;у GMX всего 128
1854  3080
1855  3080
1856  3080              esp_link_id_table;_id_table ;таблица соединений ESP
1857  3080              	;0 - id процесса (одновременно флаг "соединение используется")
1858  3080              	;1 - запрос соединения (=1 - активен)
1859  3080              	;2 - результат соединения (=1 - успешно, =255 - ошибка)
1860  3080              	;3 - запрос на отправку (=1 - активен)
1861  3080              	;4 - результат отправки (=1 - успешно, =255 - ошибка)
1862  3080              	;5 - запрос на приём (=1 - активен)
1863  3080              	;6 - результат приёма (=1 - успешно, =255 - ошибка)
1864  3080              	;7-8 - адрес назначения данных (для принятых)
1865  3080              	;9-10 - длина данных
1866  3080              	;11-13 -
1867  3080              	;14 - тип (TCP, UDP, SSL)
1868  3080              	;15-58 - адрес сервера, в конце 0
1869  3080              	;59-63 - порт сервера, в конце 0
1870  3080
1871  3080 00 00 00...  	ds 1*esp_link_id_table_size_item ;1 соединение
1872  30C0
1873  30C0              ; esp_buffer_flag ;флаги управления буфером ESP
1874  30C0              	; ;0 - буфер занят системным процессом (=1 - идёт передача)
1875  30C0              	; ;1-2 - длина данных
1876  30C0              	; ds 1
1877  30C0
1878  30C0
1879  30C0
1880  30C0 72 61 64 69  proc_name_01	db "radio.com",0
1880  30C4 6F 2E 63 6F
1880  30C8 6D 00
1881  30CA 6D 6F 6F 6E  proc_name_02	db "moonr.com",0
1881  30CE 72 2E 63 6F
1881  30D2 6D 00
1882  30D4              ;proc_name_03	db "test.txt",0
1883  30D4
1884  30D4
1885  30D4              ;Константы
1886  30D4              outputBuffer equ #c000 ;адрес файла для плеера AY
1887  30D4              proc_color_def equ 7 ;цвет текста консоли
1888  30D4              proc_color2_def equ #c ;цвет текста консоли 2 яркий
1889  30D4              function_max equ 41+1 ;всего функций
1890  30D4              proc_size_max equ #80 ;максимальный размер приложения старший байт
1891  30D4              proc_descr_size equ 256 ;область памяти на одно приложение
1892  30D4              proc_max equ 8 ;максимальное количество приложений
1893  30D4              page_max equ drvgmx.page_table_end-drvgmx.page_table ;всего доступных страниц из 128
1894  30D4              proc_id_system equ 1 ;код системного процесса
1895  30D4              ;proc_stack equ #4000;адрес стека для процессов
1896  30D4              ;proc_stack_size equ 128 ;размер стека для процесса
1897  30D4              con_scr_real equ #39 ;экран физический
1898  30D4              con_atr_real equ #79 ;атрибуты
1899  30D4              ;page_slot2_def equ 2 ;страница по умолчанию слот 2
1900  30D4              ;page_slot3_def equ 1 ;страница по умолчанию слот 3
1901  30D4              proc_switch_key equ #1b ;код перключения задач sh+Enter
1902  30D4              ;esp_max_link_id equ 5 ;всего соединений ESP
1903  30D4              esp_buffer equ #4000-1500 ;буфер для обмена с ESP
1904  30D4              esp_link_id_table_size_item equ 64 ;размер элемента в таблице соединений
1905  30D4
1906  30D4              ;Сообщения
1907  30D4              msg_init_uart_found
1908  30D4 55 41 52 54  	db "UART #EF found",13,10,0
1908  30D8 20 23 45 46
1908  30DC 20 66 6F 75
1908  30E0 6E 64 0D 0A
1908  30E4 00
1909  30E5              msg_init_uart_not_found
1910  30E5 55 41 52 54  	db "UART #EF not found",13,10,0
1910  30E9 20 23 45 46
1910  30ED 20 6E 6F 74
1910  30F1 20 66 6F 75
1910  30F5 6E 64 0D 0A
1910  30F9 00
1911  30FA              msg_proc_max
1912  30FA 4E 6F 74 20  	db "Not enough processes",13,10,0
1912  30FE 65 6E 6F 75
1912  3102 67 68 20 70
1912  3106 72 6F 63 65
1912  310A 73 73 65 73
1912  310E 0D 0A 00
1913  3111              msg_mem_max
1914  3111 4E 6F 74 20  	db "Not enough memory",13,10,0
1914  3115 65 6E 6F 75
1914  3119 67 68 20 6D
1914  311D 65 6D 6F 72
1914  3121 79 0D 0A 00
1915  3125
1916  3125
1917  3125
1918  3125              msg_ver_os
1919  3125 4F 53 20 76  	db "OS ver 2024.12.11",13,10,0
1919  3129 65 72 20 32
1919  312D 30 32 34 2E
1919  3131 31 32 2E 31
1919  3135 31 0D 0A 00
1920  3139
1921  3139
1922  3139
1923  3139
1924  3139
1925  3139
1926  3139              start_sys_incl
1927  3139              	incbin sys.com ;
1928  37AE              end_sys_incl
1929  37AE
1930  37AE              start_cmd_incl
1931  37AE              	incbin cmd.com ;
1932  37EC              end_cmd_incl
1933  37EC
1934  37EC              	;Последний перед #4000 буфер для данных от ESP!
1935  37EC
1936  37EC              end_os_main
1937  37EC              	SAVETRD "OS.TRD",|"OS.C",start_os_main,$-start_os_main ;сохранить в TRD
1938  37EC              	savebin "os.com",start_os_main,$-start_os_main ;сохранить для FAT
1939  37EC
1940  37EC              	;манипуляции для создания hobeta
1941  37EC              	org #c000
1942  C000              	incbin os.com
1943  F7EC              	SAVEHOB "os.$c","os.C",#C000,end_os_main-start_os_main ;
1944  F7EC
1945  F7EC
1946  F7EC
1947  F7EC
1948  F7EC
# file closed: os_main.asm
