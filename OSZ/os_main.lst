# file opened: os_main.asm
   1  0000              ;OS GMX (izzx, 2024-2025)
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "os_defs.asm"
# file opened: os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000
  97+ 0000              ;включить/выключить моно режим для приложения
  98+ 0000              ;при включенном режиме разрешена запись в диапазон памяти #4000-#7fff + страницы приложения
  99+ 0000              ;вх: a = 0 - включить; a = 255 - выключить
 100+ 0000                  macro OS_SET_MONO_MODE ;
 101+ 0000 ~                ld c,#08
 102+ 0000 ~                rst #20
 103+ 0000                  endm
 104+ 0000
 105+ 0000
 106+ 0000
 107+ 0000              ;печать в консоль до кода 0
 108+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 109+ 0000 ~                ld c,#09
 110+ 0000 ~                rst #20
 111+ 0000                  endm
 112+ 0000
 113+ 0000
 114+ 0000              ;прочитать байт из порта uart
 115+ 0000              ;вх:
 116+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 117+ 0000              ;вых: A - считанный байт
 118+ 0000                  macro OS_UART_READ
 119+ 0000 ~                ld c,#0a
 120+ 0000 ~                rst #20
 121+ 0000                  endm
 122+ 0000
 123+ 0000              ;записать байт в порт uart
 124+ 0000              ;вх: A -байт
 125+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 126+ 0000                  macro OS_UART_WRITE
 127+ 0000 ~                ld c,#0b
 128+ 0000 ~                rst #20
 129+ 0000                  endm
 130+ 0000
 131+ 0000              ;закрыть соединение ESP
 132+ 0000              ;вх:
 133+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 134+ 0000                  macro OS_ESP_CLOSE
 135+ 0000 ~                ld c,#0c
 136+ 0000 ~                rst #20
 137+ 0000                  endm
 138+ 0000
 139+ 0000              ;установить соединение ESP (CIPSTART);
 140+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 141+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 142+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 143+ 0000                  macro OS_ESP_OPEN
 144+ 0000 ~                ld c,#0d
 145+ 0000 ~                rst #20
 146+ 0000                  endm
 147+ 0000
 148+ 0000              ;послать запрос ESP (CIPSEND);
 149+ 0000              ;вх: hl - адрес данных, de - длина данных
 150+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 151+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 152+ 0000                  macro OS_ESP_SEND
 153+ 0000 ~                ld c,#0e
 154+ 0000 ~                rst #20
 155+ 0000                  endm
 156+ 0000
 157+ 0000              ;получить пакет ESP (+IPD);
 158+ 0000              ;вх: hl - адрес для данных
 159+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 160+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 161+ 0000                  macro OS_ESP_GET
 162+ 0000 ~                ld c,#0f
 163+ 0000 ~                rst #20
 164+ 0000                  endm
 165+ 0000
 166+ 0000              ;ввод с консоли ----------------------
 167+ 0000
 168+ 0000              ;получить код нажатой клавиши
 169+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 170+ 0000 ~                ld c,#10
 171+ 0000 ~                rst #20
 172+ 0000                  endm
 173+ 0000
 174+ 0000
 175+ 0000              ;процессы ----------------------------
 176+ 0000
 177+ 0000              ;запустить процесс
 178+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 179+ 0000                  macro OS_PROC_RUN ;
 180+ 0000 ~                ld c,#11
 181+ 0000 ~                rst #20
 182+ 0000                  endm
 183+ 0000
 184+ 0000              ;установить фокус
 185+ 0000              ;вх: a - id процесса
 186+ 0000                  macro OS_PROC_SET_FOCUS ;
 187+ 0000 ~                ld c,#12
 188+ 0000 ~                rst #20
 189+ 0000                  endm
 190+ 0000
 191+ 0000              ;закрыть процесс
 192+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 193+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 194+ 0000                  macro OS_PROC_CLOSE ;
 195+ 0000 ~                ld c,#13
 196+ 0000 ~                rst #20
 197+ 0000                  endm
 198+ 0000
 199+ 0000
 200+ 0000              ;прерывания --------------------------
 201+ 0000
 202+ 0000              ;установка адреса обработчика прерываний процесса;
 203+ 0000              ;например, плеера музыки
 204+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 205+ 0000              ;на время выполнения включаются обе страницы процесса
 206+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 207+ 0000 ~                ld c,#14
 208+ 0000 ~                rst #20
 209+ 0000                  endm
 210+ 0000
 211+ 0000
 212+ 0000              ;плеер AY ----------------------------
 213+ 0000
 214+ 0000              ;инициализация плеера AY;
 215+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 216+ 0000 ~                ld c,#15
 217+ 0000 ~                rst #20
 218+ 0000                  endm
 219+ 0000
 220+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 221+ 0000                  macro OS_VTPL_PLAY ;()
 222+ 0000 ~                ld c,#16
 223+ 0000 ~                rst #20
 224+ 0000                  endm
 225+ 0000
 226+ 0000              ;заглушить плеер AY;
 227+ 0000                  macro OS_VTPL_MUTE ;()
 228+ 0000 ~                ld c,#17
 229+ 0000 ~                rst #20
 230+ 0000                  endm
 231+ 0000
 232+ 0000              ;получить значение переменной плеера;
 233+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 234+ 0000 ~                ld c,#18
 235+ 0000 ~                rst #20
 236+ 0000                  endm
 237+ 0000
 238+ 0000
 239+ 0000              ;прочие ------------------------------
 240+ 0000
 241+ 0000
 242+ 0000              ;скопировать данные из страницы в страницу
 243+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 244+ 0000                  macro OS_RAM_COPY
 245+ 0000 ~                ld c,#19
 246+ 0000 ~                rst #20
 247+ 0000                  endm
 248+ 0000
 249+ 0000              ;получить дополнительную страницу памяти;
 250+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 251+ 0000 ~                ld c,#1a
 252+ 0000 ~                rst #20
 253+ 0000                  endm
 254+ 0000
 255+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 256+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 257+ 0000 ~                ld c,#1b
 258+ 0000 ~                rst #20
 259+ 0000                  endm
 260+ 0000
 261+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 262+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 263+ 0000 ~                ld c,#1c
 264+ 0000 ~                rst #20
 265+ 0000                  endm
 266+ 0000
 267+ 0000              ;включить экран N;
 268+ 0000              ;вх: A - номер экрана (5(!), 7, #39, #3a; 0 = текстовый)
 269+ 0000              ;переключать может только приложение в фокусе
 270+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 271+ 0000              ;при переключении процессов сохраняется только экран #39
 272+ 0000              ;экран 5 использовать не желательно, там может быть буфер сети ESP или приложение в монопольном режиме (см. OS_SET_MONO_MODE)
 273+ 0000                  macro OS_SET_SCREEN ;
 274+ 0000 ~                ld c,#1d
 275+ 0000 ~                rst #20
 276+ 0000                  endm
 277+ 0000
 278+ 0000
 279+ 0000              ;получить номера страниц процесса;
 280+ 0000              ;вх:
 281+ 0000              ;вых: b, c - страницы в слотах 2, 3
 282+ 0000                  macro OS_GET_MAIN_PAGES ;
 283+ 0000 ~                ld c,#1e
 284+ 0000 ~                rst #20
 285+ 0000                  endm
 286+ 0000
 287+ 0000              ;получить значение системного таймера
 288+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 289+ 0000 ~                ld c,#1F
 290+ 0000 ~                rst #20
 291+ 0000                  endm
 292+ 0000
 293+ 0000
 294+ 0000              ;освободить страницу памяти
 295+ 0000              ;вх: a - номер страницы
 296+ 0000                  macro OS_DEL_PAGE ;
 297+ 0000 ~                ld c,#20
 298+ 0000 ~                rst #20
 299+ 0000                  endm
 300+ 0000
 301+ 0000
 302+ 0000              ;дисковые операции -------------------
 303+ 0000
 304+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 305+ 0000
 306+ 0000              ; fcbFAT (из руководства к монитору)
 307+ 0000              ; формат fcb для работы с FAT
 308+ 0000
 309+ 0000              ; +#00 8 имя файла
 310+ 0000              ; +#08 3 расширение файла
 311+ 0000              ; +#0B 1 атрибуты файла
 312+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 313+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 314+ 0000              ; +#14 4 размер файла/каталога в байтах
 315+ 0000              ; +#18 4 указатель в файле
 316+ 0000              ; +#1C 1 для внутренних нужд
 317+ 0000              ; +#1D 1 для внутренних нужд
 318+ 0000              ; +#1E 1 резерв
 319+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 320+ 0000              	; 1-0,nn номер раздела
 321+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 322+ 0000              	    ; значение %11 недопустимо
 323+ 0000
 324+ 0000              ;открыть файл для чтения или записи
 325+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 326+ 0000 ~                ld c,#21
 327+ 0000 ~                rst #20
 328+ 0000                  endm
 329+ 0000
 330+ 0000              ;создать файл
 331+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 332+ 0000 ~                ld c,#22
 333+ 0000 ~                rst #20
 334+ 0000                  endm
 335+ 0000
 336+ 0000              ;прочитать из файла
 337+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 338+ 0000 ~                ld c,#23
 339+ 0000 ~                rst #20
 340+ 0000                  endm
 341+ 0000
 342+ 0000              ;записать в файл
 343+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 344+ 0000 ~                ld c,#24
 345+ 0000 ~                rst #20
 346+ 0000                  endm
 347+ 0000
 348+ 0000              ;закрыть файл
 349+ 0000                  macro OS_FILE_CLOSE ;A - id file
 350+ 0000 ~                ld c,#25
 351+ 0000 ~                rst #20
 352+ 0000                  endm
 353+ 0000
 354+ 0000              ;чтение секторов текущего каталога
 355+ 0000              ; вх:
 356+ 0000                   ; hl - буфер для чтения
 357+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 358+ 0000                   ; b - максимальное количество секторов для чтения
 359+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 360+ 0000                     ; a=errRWnum
 361+ 0000                     ; a=errInvalidPart
 362+ 0000                     ; a=errFileEmpty
 363+ 0000                   ; cy=0, a=errEoF - каталог закончился
 364+ 0000                     ; hl - следующий адрес в буфере
 365+ 0000                     ; de - номер первого непрочитанного сектора
 366+ 0000                     ; b - не прочитано секторов
 367+ 0000                   ; cy=0 - считано успешно
 368+ 0000                     ; hl - следующий адрес в буфере
 369+ 0000                     ; de - номер первого непрочитанного сектора
 370+ 0000                     ; b=#00
 371+ 0000                  macro OS_DIR_READ ;
 372+ 0000 ~                ld c,#26
 373+ 0000 ~                rst #20
 374+ 0000                  endm
 375+ 0000
 376+ 0000              ;вход в каталог/выход в родительский каталог
 377+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 378+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 379+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 380+ 0000              	; переход в родительский, последнее имя в пути удалится).
 381+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 382+ 0000              	; добавится имя файла
 383+ 0000              ; вх:
 384+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 385+ 0000                   ; de - адрес дескриптора директории/файла
 386+ 0000              ; вых: a - если путь был указан, новая длина пути
 387+ 0000                  macro OS_DIR_OPEN ;
 388+ 0000 ~                ld c,#27
 389+ 0000 ~                rst #20
 390+ 0000                  endm
 391+ 0000
 392+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 393+ 0000              ;проверки на допустимость значений не производится
 394+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 395+ 0000              ;вх: A - id файла
 396+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 397+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 398+ 0000                  macro OS_FILE_POSITION ;
 399+ 0000 ~                ld c,#28
 400+ 0000 ~                rst #20
 401+ 0000                  endm
 402+ 0000
 403+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 404+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 405+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 406+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 407+ 0000                  macro OS_FIND_PATH ;
 408+ 0000 ~                ld c,#29
 409+ 0000 ~                rst #20
 410+ 0000                  endm
 411+ 0000
 412+ 0000
 413+ 0000              ; получение длинного имени файла
 414+ 0000              ;вх: hl - адрес буфера для имени
 415+ 0000              ;    de - номер записи в текущем каталоге
 416+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 417+ 0000              ; 	a - длина имени, с учетом нуля
 418+ 0000                  macro OS_GET_LFN ;
 419+ 0000 ~                ld c,#2a
 420+ 0000 ~                rst #20
 421+ 0000                  endm
 422+ 0000
# file closed: os_defs.asm
   4  0000
   5  0000              ;sys - системный процесс для OS
   6  0000              	org PROG_START
   7  8000              	;bank 1
   8  8000              start_sys
   9  8000 FB           	ei
  10  8001              	;halt ;ожидание старта после прерывания
  11  8001              	;halt
  12  8001 AF           	xor a
  13  8002 D3 FE        	out (254),a
  14  8004 21 19 36     	ld hl,msg_ver_os
  15  8007              	;печать приветствия
  16  8007 CD 80 0A     	call drvgmx.printZ
  17  800A
  18  800A 11 00 18     	ld de,#1800 ;координаты yx
  19  800D              	OS_SET_XY
  19  800D 0E 01       >    ld c,#01
  19  800F E7          >    rst #20
  20  8010 21 B5 82     	ld hl,msg_press_num_to_close
  21  8013              	OS_PRINTZ
  21  8013 0E 09       >    ld c,#09
  21  8015 E7          >    rst #20
  22  8016
  23  8016              	;автозапуск приложений
  24  8016 11 00 17     	ld de,#1700 ;координаты yx
  25  8019              	OS_SET_XY
  25  8019 0E 01       >    ld c,#01
  25  801B E7          >    rst #20
  26  801C 21 08 83     	ld hl,sys_file_autorun_name ;имя списка
  27  801F CD F0 0C     	call Dos.fopen_r ;откроем файл для чтения
  28  8022 DC 45 0E     	call c,Dos.file_error_print_file_open_error
  29  8025 DA A3 80     	jp c,sys_loop
  30  8028 32 07 83     	ld (sys_file_autorun_id_tmp),a ;запомнить id
  31  802B
  32  802B              	;проверка длины файла не больше #8000
  33  802B 7A           	ld	a,d ;самые старшие байты длины
  34  802C B3           	or e
  35  802D 28 09        	jr z,sys_file_size_ok ;если не слищком большой
  36  802F              sys_file_too_big
  37  802F 21 56 10     	ld hl,Dos.msg_file_too_big
  38  8032 CD 80 0A     	call drvgmx.printZ
  39  8035 C3 A3 80     	jp sys_loop
  40  8038
  41  8038
  42  8038              sys_file_size_ok
  43  8038 7C           	ld	a,h ;младший старший байт длины
  44  8039 FE 80        	cp #80
  45  803B 30 F2        	jr nc,sys_file_too_big
  46  803D              	;размер нормальный, прочитаем
  47  803D 22 14 83     	ld (sys_file_autorun_lenght),hl
  48  8040 54           	ld d,h ;размер
  49  8041 5D           	ld e,l
  50  8042 21 00 C0     	ld hl,#c000
  51  8045 3A 07 83     	ld a,(sys_file_autorun_id_tmp)
  52  8048 CD 8F 0E     	call Dos.fread
  53  804B 30 0B        	jr nc,sys_file_size_ok2
  54  804D              	;если ошибка
  55  804D CD 4D 0E     	call Dos.file_error_print_file_read_error
  56  8050 3A 07 83     	ld a,(sys_file_autorun_id_tmp)
  57  8053 CD 55 0E     	call Dos.fclose ;закрыть файл
  58  8056 18 4B        	jr sys_loop
  59  8058              sys_file_size_ok2
  60  8058 3A 07 83     	ld a,(sys_file_autorun_id_tmp)
  61  805B CD 55 0E     	call Dos.fclose ;закрыть файл
  62  805E
  63  805E
  64  805E              	;анализ файла
  65  805E 21 00 C0     	ld hl,#c000
  66  8061 ED 4B 14 83  	ld bc,(sys_file_autorun_lenght) ;цикл
  67  8065              sys_file_autorun_cl
  68  8065 C5           	push bc
  69  8066 7E           	ld a,(hl)
  70  8067 FE 20        	cp " "
  71  8069 38 2C        	jr c,sys_file_autorun_next
  72  806B
  73  806B              	;тут нашли первое имя
  74  806B E5           	push hl
  75  806C 21 17 83     	ld hl,sys_file_autorun_name_tmp ;почистить буфер
  76  806F 11 18 83     	ld de,sys_file_autorun_name_tmp+1
  77  8072 01 FF 00     	ld bc,256-1
  78  8075 36 00        	ld (hl),0
  79  8077 ED B0        	ldir
  80  8079
  81  8079 E1           	pop hl
  82  807A 11 17 83     	ld de,sys_file_autorun_name_tmp ;куда
  83  807D 01 00 00     	ld bc,#0000 ;макс длина 255
  84  8080              	;ld ixl,0 ;счётчик
  85  8080              sys_file_autorun_cl2
  86  8080 7E           	ld a,(hl)
  87  8081 FE 20        	cp " "
  88  8083 38 04        	jr c,sys_file_autorun_cl2_ex
  89  8085 ED A0        	ldi
  90  8087 10 F7        	djnz sys_file_autorun_cl2
  91  8089
  92  8089              sys_file_autorun_cl2_ex
  93  8089              	;запустим
  94  8089 E5           	push hl
  95  808A 21 17 83     	ld hl,sys_file_autorun_name_tmp		;строка с именем
  96  808D CD DE 02     	call proc_run
  97  8090 DD 7E 00     	ld a,(ix)
  98  8093 32 16 83     	ld (sys_file_autorun_focus),a ;запомнить последний
  99  8096 E1           	pop hl
 100  8097              	;тут надо бы уменьщить счётчик bc на длину имени
 101  8097              sys_file_autorun_next
 102  8097 23           	inc hl
 103  8098 C1           	pop bc
 104  8099 0B           	dec bc
 105  809A 78           	ld a,b
 106  809B B1           	or c
 107  809C 20 C7        	jr nz, sys_file_autorun_cl
 108  809E
 109  809E 3E 01        	ld a,1
 110  80A0              	;ld a,(sys_file_autorun_focus)
 111  80A0 CD 3D 02     	call proc_set_focus ;на передний план
 112  80A3
 113  80A3
 114  80A3              	;jr file_load_ok
 115  80A3              	;call proc_run_cmd ;запустить консоль
 116  80A3              	;call proc_run_cmd ;запустить консоль
 117  80A3              	; call proc_run_cmd ;запустить консоль
 118  80A3              	; call proc_run_cmd ;запустить консоль
 119  80A3              	; call proc_run_cmd ;запустить консоль
 120  80A3              	;call proc_run_cmd ;запустить консоль
 121  80A3              	;call proc_run_cmd ;запустить консоль
 122  80A3
 123  80A3              	; ld hl,proc_name_net		;строка с именем
 124  80A3              	; call proc_run ;запуск
 125  80A3
 126  80A3              	; ld hl,proc_name_01		;строка с именем
 127  80A3              	; call proc_run
 128  80A3
 129  80A3              	; ld hl,proc_name_02		;строка с именем
 130  80A3              	; call proc_run
 131  80A3
 132  80A3              	; ld hl,proc_name_03		;строка с именем
 133  80A3              	; call proc_run
 134  80A3              	; ld a,(ix)
 135  80A3              	; call proc_set_focus ;на передний план
 136  80A3
 137  80A3              sys_loop
 138  80A3              	;OS_WAIT ;для системного процесса не рекомендуется
 139  80A3 76           	halt
 140  80A4 CD 67 82     	call print_active ;индикатор
 141  80A7
 142  80A7              	OS_GET_CHAR
 142  80A7 0E 10       >    ld c,#10
 142  80A9 E7          >    rst #20
 143  80AA
 144  80AA              	;печать кода нажатой клавиши
 145  80AA              	;ld a,(key_cur)
 146  80AA FE FF        	cp 255
 147  80AC 28 14        	jr z,sys_loop_skip_print_char
 148  80AE F5           	push af
 149  80AF 6F           	ld l,a
 150  80B0 26 00        	ld h,0
 151  80B2 CD ED 05     	call toDecimal
 152  80B5 11 4C 18     	ld de,#184c ;координаты yx
 153  80B8              	OS_SET_XY
 153  80B8 0E 01       >    ld c,#01
 153  80BA E7          >    rst #20
 154  80BB 21 45 06     	ld hl,decimalS+2
 155  80BE CD 80 0A     	call drvgmx.printZ
 156  80C1 F1           	pop af
 157  80C2              	;-------
 158  80C2              sys_loop_skip_print_char
 159  80C2 FE 16        	cp 22 ;кнопка выхода в монитор
 160  80C4 CA 70 81     	jp z,call_monitor
 161  80C7 FE 13        	cp 19 ;кнопка запуска NC
 162  80C9 CA 5E 81     	jp z,run_nc
 163  80CC FE 32        	cp "2" ;кнопки от 2 до 9
 164  80CE 38 0C        	jr c,sys_loop_skip
 165  80D0 FE 39        	cp "9"
 166  80D2 30 08        	jr nc,sys_loop_skip
 167  80D4              	;здесь надо закрыть процесс
 168  80D4 D6 30        	sub "0"
 169  80D6 CD 73 06     	call proc_close_skip
 170  80D9
 171  80D9              sys_loop_skip2
 172  80D9 CD 54 81     	call release_key
 173  80DC
 174  80DC
 175  80DC              sys_loop_skip
 176  80DC 3A 10 2C     	ld a,(key_proc_switch_flag) ;если нажали переключение фокуса
 177  80DF B7           	or a
 178  80E0 28 11        	jr z,sys_loop_skip_key_focus
 179  80E2 CD 2C 02     	call proc_focus_next
 180  80E5 CD 54 81     	call release_key
 181  80E8 AF           	xor a
 182  80E9 32 10 2C     	ld (key_proc_switch_flag),a
 183  80EC 3E FF        	ld a,255
 184  80EE 32 1D 2C     	ld (key_cur),a ;очистить буфер
 185  80F1 18 56        	jr sys_loop_skip_key
 186  80F3
 187  80F3              sys_loop_skip_key_focus
 188  80F3 3A 12 2C     	ld a,(key_caps_lock_switch_flag) ;если нажали caps_lock
 189  80F6 B7           	or a
 190  80F7 28 10        	jr z,sys_loop_skip_key_caps_lock
 191  80F9 2A 15 2C     	ld hl,(FlgScanKeys_addr)
 192  80FC 3E 02        	ld a,%00000010	;?1,=1/0 CapsLock on/off
 193  80FE AE           	xor (hl)
 194  80FF 77           	ld (hl),a
 195  8100 CD 54 81     	call release_key
 196  8103 AF           	xor a
 197  8104 32 12 2C     	ld (key_caps_lock_switch_flag),a
 198  8107 18 40        	jr sys_loop_skip_key
 199  8109
 200  8109              sys_loop_skip_key_caps_lock
 201  8109 3A 11 2C     	ld a,(key_lang_flag) ;если нажали rus_lat
 202  810C B7           	or a
 203  810D 28 10        	jr z,sys_loop_skip_key_rus_lat
 204  810F 2A 15 2C     	ld hl,(FlgScanKeys_addr)
 205  8112 3E 08        	ld a,%00001000	;3,=1/0 Rus/Lat
 206  8114 AE           	xor (hl) ;флаг FlgScanKeys
 207  8115 77           	ld (hl),a
 208  8116 CD 54 81     	call release_key
 209  8119 AF           	xor a
 210  811A 32 11 2C     	ld (key_lang_flag),a
 211  811D 18 2A        	jr sys_loop_skip_key
 212  811F
 213  811F              sys_loop_skip_key_rus_lat
 214  811F 3A 13 2C     	ld a,(key_graph_flag) ;если нажали graph
 215  8122 B7           	or a
 216  8123 28 10        	jr z,sys_loop_skip_key_graph
 217  8125 2A 15 2C     	ld hl,(FlgScanKeys_addr)
 218  8128 3E 04        	ld a,%00000100	;2,=1/0 Grf on/off
 219  812A AE           	xor (hl)
 220  812B 77           	ld (hl),a
 221  812C CD 54 81     	call release_key
 222  812F AF           	xor a
 223  8130 32 13 2C     	ld (key_graph_flag),a
 224  8133 18 14        	jr sys_loop_skip_key
 225  8135
 226  8135              sys_loop_skip_key_graph
 227  8135 3A 14 2C     	ld a,(key_sys_focus) ;если нажали EXT+1
 228  8138 B7           	or a
 229  8139 28 0E        	jr z,sys_loop_skip_key_sys_focus
 230  813B              	;фокус на системный процесс
 231  813B 3E 01        	ld a,1
 232  813D CD 3D 02     	call proc_set_focus
 233  8140 CD 54 81     	call release_key
 234  8143 AF           	xor a
 235  8144 32 14 2C     	ld (key_sys_focus),a
 236  8147 18 00        	jr sys_loop_skip_key
 237  8149
 238  8149
 239  8149              sys_loop_skip_key_sys_focus
 240  8149
 241  8149              sys_loop_skip_key
 242  8149
 243  8149
 244  8149 3A 25 2C     	ld a,(sys_timer) ;иногда печатаем системную информацию
 245  814C E6 0F        	and %00001111
 246  814E CC 8B 81     	call z,sys_print_info
 247  8151              	; OS_GETCHAR ;получить нажатую клавишу
 248  8151              	; cp 255
 249  8151              	; jr z,sys_loop
 250  8151              	; OS_PRINT_CHARF ;печать символа
 251  8151
 252  8151
 253  8151
 254  8151 C3 A3 80     	jp sys_loop
 255  8154
 256  8154
 257  8154
 258  8154
 259  8154              release_key ;ждать отпускания клавиши
 260  8154              	;OS_WAIT ;для системного процесса не рекомендуется
 261  8154              	;ld hl,(FlgScanKeys_addr)
 262  8154              	;ждать пока отпустят все клавиши
 263  8154              WAITKEY
 264  8154 76           	halt
 265  8155 AF           	XOR A
 265  8156 DB FE         IN A,(#FE)
 265  8158 2F            CPL
 265  8159 E6 1F         AND #1F
 265  815B
 266  815B 20 F7        	JR nz,WAITKEY
 267  815D              	;bit 6,(hl)
 268  815D              	;jr z,release_key
 269  815D C9           	ret
 270  815E
 271  815E              run_nc
 272  815E 21 89 82     	ld hl,proc_name_nc		;строка с именем
 273  8161 CD DE 02     	call proc_run
 274  8164 DA D9 80     	jp c,sys_loop_skip2
 275  8167 DD 7E 00     	ld a,(ix)
 276  816A CD 3D 02     	call proc_set_focus ;на передний план
 277  816D C3 D9 80     	jp sys_loop_skip2
 278  8170
 279  8170              call_monitor	;вызов теневого монитора
 280  8170 F3           	di
 281  8171 ED 73 89 81  	ld (call_monitor_tmp_sp),sp
 282  8175 31 00 60     	ld sp,#6000 ;временный стек
 283  8178 CD 66 00     	call #66
 284  817B ED 7B 89 81  	ld sp,(call_monitor_tmp_sp)
 285  817F
 286  817F 3A 07 10     	ld a,(Dos.fs_fat_part_code_cur)
 287  8182 CD FD 0D     	call Dos.init_fs_fat_warm ;переинициализация FAT
 288  8185 FB           	ei
 289  8186 C3 D9 80     	jp sys_loop_skip2
 290  8189
 291  8189 00 00        call_monitor_tmp_sp dw 0 ;временно
 292  818B
 293  818B              ;печать информации
 294  818B              sys_print_info
 295  818B              	;инфо об открытых файлах
 296  818B              sys_print_info_files
 297  818B 21 F6 11     	ld hl,Dos.fcb_fat_table
 298  818E 06 08        	ld b,Dos.files_fat_max
 299  8190 0E 00        	ld c,0 ;счётчик
 300  8192              sys_print_info_files_cl
 301  8192 7E           	ld a,(hl)
 302  8193 B7           	or a
 303  8194 28 01        	jr z,sys_print_info_files_skip
 304  8196 0C           	inc c
 305  8197              sys_print_info_files_skip
 306  8197 23           	inc hl
 307  8198 10 F8        	djnz sys_print_info_files_cl
 308  819A
 309  819A 69           	ld l,c
 310  819B 26 00        	ld h,0
 311  819D CD ED 05     	call toDecimal
 312  81A0 11 00 0B     	ld de,#0b00 ;координаты yx
 313  81A3              	OS_SET_XY
 313  81A3 0E 01       >    ld c,#01
 313  81A5 E7          >    rst #20
 314  81A6 21 90 82     	ld hl,msg_files
 315  81A9 CD 80 0A     	call drvgmx.printZ
 316  81AC 21 46 06     	ld hl,decimalS+3
 317  81AF CD 80 0A     	call drvgmx.printZ
 318  81B2
 319  81B2              	;печать информации о памяти и процессах
 320  81B2 CD E9 81     	call get_proc_total ;печать и подсчёт процессов
 321  81B5 6F           	ld l,a
 322  81B6 26 00        	ld h,0
 323  81B8 CD ED 05     	call toDecimal
 324  81BB 11 00 0D     	ld de,#0d00 ;координаты yx
 325  81BE              	OS_SET_XY
 325  81BE 0E 01       >    ld c,#01
 325  81C0 E7          >    rst #20
 326  81C1 21 98 82     	ld hl,msg_processes
 327  81C4 CD 80 0A     	call drvgmx.printZ
 328  81C7 21 46 06     	ld hl,decimalS+3
 329  81CA CD 80 0A     	call drvgmx.printZ
 330  81CD
 331  81CD 11 00 0C     	ld de,#0c00 ;координаты yx
 332  81D0              	OS_SET_XY
 332  81D0 0E 01       >    ld c,#01
 332  81D2 E7          >    rst #20
 333  81D3 21 A4 82     	ld hl,msg_free_ram
 334  81D6 CD 80 0A     	call drvgmx.printZ
 335  81D9 CD 56 82     	call get_free_ram ;памяти
 336  81DC 6F           	ld l,a
 337  81DD 26 00        	ld h,0
 338  81DF CD ED 05     	call toDecimal
 339  81E2 21 45 06     	ld hl,decimalS+2
 340  81E5 CD 80 0A     	call drvgmx.printZ
 341  81E8 C9           	ret
 342  81E9
 343  81E9
 344  81E9
 345  81E9
 346  81E9              get_proc_total
 347  81E9              	;поиск и печать количества запущеных процессов
 348  81E9              	;вых: a - количество активных
 349  81E9 11 00 0E     	ld de,#0e00 ;координаты yx
 350  81EC              	OS_SET_XY
 350  81EC 0E 01       >    ld c,#01
 350  81EE E7          >    rst #20
 351  81EF DD 21 00 2D  	ld ix,proc_table
 352  81F3 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 353  81F5 0E 00        	ld c,0 ;счётчик
 354  81F7              get_proc_total_cl
 355  81F7 DD 7E 00     	ld a,(ix)
 356  81FA B7           	or a ;свободен?
 357  81FB 28 1F        	jr z,get_proc_total_cl1
 358  81FD
 359  81FD C5           	push bc
 360  81FE C6 30        	add '0' ;печать id
 361  8200              	OS_PRINT_CHARF
 361  8200 D7          >	rst #10
 362  8201 3E 20        	ld a," "
 363  8203              	OS_PRINT_CHARF
 363  8203 D7          >	rst #10
 364  8204 DD 7E 01     	ld a,(ix+1)
 365  8207 C6 30        	add '0' ;печать id родительского
 366  8209              	OS_PRINT_CHARF
 366  8209 D7          >	rst #10
 367  820A 3E 20        	ld a," "
 368  820C              	OS_PRINT_CHARF
 368  820C D7          >	rst #10
 369  820D
 370  820D DD E5        	push ix
 371  820F E1           	pop hl
 372  8210 01 10 00     	ld bc,16
 373  8213 09           	add hl,bc
 374  8214              	OS_PRINTZ ;печать имени
 374  8214 0E 09       >    ld c,#09
 374  8216 E7          >    rst #20
 375  8217
 376  8217 3E 0D        	ld a,13
 377  8219              	OS_PRINT_CHARF
 377  8219 D7          >	rst #10
 378  821A
 379  821A C1           	pop bc
 380  821B
 381  821B 0C           	inc c ;прибавить
 382  821C              get_proc_total_cl1
 383  821C DD 24        	inc ixh
 384  821E 10 D7        	djnz get_proc_total_cl
 385  8220 79           	ld a,c
 386  8221 32 44 82     	ld (get_proc_total_count),a
 387  8224
 388  8224              	;почистить пустые строки (надо оптимизировать по времени)
 389  8224 3E 08        	ld a,proc_max
 390  8226 91           	sub c ;сколько пустых стрк должно быть
 391  8227 28 17        	jr z,get_proc_total_ex
 392  8229 47           	ld b,a ;цикл
 393  822A 11 00 0E     	ld de,#0e00 ;координаты yx
 394  822D 79           	ld a,c
 395  822E 82           	add d
 396  822F 57           	ld d,a
 397  8230              get_proc_total_cl2
 398  8230 D5           	push de
 399  8231 C5           	push bc
 400  8232              	OS_SET_XY
 400  8232 0E 01       >    ld c,#01
 400  8234 E7          >    rst #20
 401  8235 21 45 82     	ld hl,get_proc_total_clear
 402  8238              	OS_PRINTZ ;очистить
 402  8238 0E 09       >    ld c,#09
 402  823A E7          >    rst #20
 403  823B C1           	pop bc
 404  823C D1           	pop de
 405  823D 14           	inc d
 406  823E 10 F0        	djnz get_proc_total_cl2
 407  8240
 408  8240              get_proc_total_ex
 409  8240 3A 44 82     	ld a,(get_proc_total_count)
 410  8243 C9           	ret
 411  8244 00           get_proc_total_count db 0 ;временно
 412  8245 20 20 20 20  get_proc_total_clear db "                ",0
 412  8249 20 20 20 20
 412  824D 20 20 20 20
 412  8251 20 20 20 20
 412  8255 00
 413  8256
 414  8256
 415  8256              get_free_ram
 416  8256              	;поиск количества свободных страниц памяти
 417  8256              	;вых: a - количество свободных
 418  8256 21 00 35     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 419  8259 06 6D        	ld b,page_max ;всего страниц
 420  825B 0E 00        	ld c,0 ;счётчик
 421  825D              get_free_ram_cl
 422  825D 7E           	ld a,(hl)
 423  825E B7           	or a ;свободен?
 424  825F 20 01        	jr nz,get_free_ram_cl1
 425  8261 0C           	inc c ;прибавить
 426  8262              get_free_ram_cl1
 427  8262 23           	inc hl
 428  8263 10 F8        	djnz get_free_ram_cl
 429  8265 79           	ld a,c
 430  8266 C9           	ret
 431  8267
 432  8267
 433  8267
 434  8267              print_active ;значёк активности
 435  8267 11 00 0A     	ld de,#0a00 ;координаты yx
 436  826A              	OS_SET_XY
 436  826A 0E 01       >    ld c,#01
 436  826C E7          >    rst #20
 437  826D 21 F9 82     	ld hl,msg_active
 438  8270              	OS_PRINTZ
 438  8270 0E 09       >    ld c,#09
 438  8272 E7          >    rst #20
 439  8273 3A 06 83     	ld a,(msg_active_cur)
 440  8276 3C           	inc a
 441  8277 FE 04        	cp 4
 442  8279 38 01        	jr c,print_active1
 443  827B AF           	xor a
 444  827C              print_active1
 445  827C 32 06 83     	ld (msg_active_cur),a
 446  827F 4F           	ld c,a
 447  8280 06 00        	ld b,0
 448  8282 21 01 83     	ld hl,msg_active1
 449  8285 09           	add hl,bc
 450  8286 7E           	ld a,(hl)
 451  8287              	OS_PRINT_CHARF
 451  8287 D7          >	rst #10
 452  8288 C9           	ret
 453  8289
 454  8289
 455  8289
 456  8289
 457  8289
 458  8289
 459  8289 6E 63 2E 61  proc_name_nc db "nc.apg",0
 459  828D 70 67 00
 460  8290
 461  8290              msg_files
 462  8290 46 69 6C 65  	db "Files: ",0
 462  8294 73 3A 20 00
 463  8298              msg_processes
 464  8298 50 72 6F 63  	db "Processes: ",0
 464  829C 65 73 73 65
 464  82A0 73 3A 20 00
 465  82A4              msg_free_ram
 466  82A4 46 72 65 65  	db "Free pages RAM: ",0
 466  82A8 20 70 61 67
 466  82AC 65 73 20 52
 466  82B0 41 4D 3A 20
 466  82B4 00
 467  82B5              msg_press_num_to_close
 468  82B5 53 53 2B 45  	db "SS+Enter - switch. 2-8 - close process. Ext+0 - Monitor. Ext+9 - NC",0
 468  82B9 6E 74 65 72
 468  82BD 20 2D 20 73
 468  82C1 77 69 74 63
 468  82C5 68 2E 20 32
 468  82C9 2D 38 20 2D
 468  82CD 20 63 6C 6F
 468  82D1 73 65 20 70
 468  82D5 72 6F 63 65
 468  82D9 73 73 2E 20
 468  82DD 45 78 74 2B
 468  82E1 30 20 2D 20
 468  82E5 4D 6F 6E 69
 468  82E9 74 6F 72 2E
 468  82ED 20 45 78 74
 468  82F1 2B 39 20 2D
 468  82F5 20 4E 43 00
 469  82F9 41 63 74 69  msg_active db "Active ",0
 469  82FD 76 65 20 00
 470  8301 7C 2F 2D 5C  msg_active1 db "|/-\\",0
 470  8305 00
 471  8306 00           msg_active_cur db 0 ;текущий значёк активности
 472  8307
 473  8307 00           sys_file_autorun_id_tmp db 0 ;временно
 474  8308 61 75 74 6F  sys_file_autorun_name	db "autorun.txt",0
 474  830C 72 75 6E 2E
 474  8310 74 78 74 00
 475  8314 00 00        sys_file_autorun_lenght dw 0 ;временно
 476  8316 00           sys_file_autorun_focus db 0 ;временно
 477  8317 00 00 00...  sys_file_autorun_name_tmp ds 256
 478  8417
 479  8417
 480  8417              end_sys
 481  8417              	savebin "sys.osg",start_sys,$-start_sys
 482  8417              ;------------------------------------------------------------------------
 483  8417
 484  8417
 485  8417
 486  8417
 487  8417
 488  8417
 489  8417
 490  8417
 491  8417
 492  8417
 493  8417
 494  8417
 495  8417
 496  8417
 497  8417
 498  8417
 499  8417
 500  8417
 501  8417
 502  8417
 503  8417
 504  8417
 505  8417
 506  8417
 507  8417
 508  8417              ;sys - сетевой процесс для OS
 509  8417              	org PROG_START
 510  8000              start_net
 511  8000
 512  8000 21 1B 85     	ld hl,msg_ver_net
 513  8003              	;печать приветствия
 514  8003 CD 80 0A     	call drvgmx.printZ
 515  8006
 516  8006              ;uart #EF (wifi)
 517  8006 AF           	xor a
 518  8007 32 02 2C     	ld (uart_enable),a ;флаг порт отсутствует
 519  800A              	; ld a,1
 520  800A              	; ld (esp_link_id_table),a ;временно занять порт
 521  800A CD CA 81     	call Uart.check
 522  800D FE FF        	cp 255
 523  800F              	;jr z,init_uart_no ;отключить проверку можно тут
 524  800F              	;нашли uart
 525  800F 3E 01        	ld a,1
 526  8011 32 02 2C     	ld (uart_enable),a ;порт есть
 527  8014 21 C8 35     	ld hl,msg_init_uart_found
 528  8017 CD 80 0A     	call drvgmx.printZ
 529  801A CD 3B 82     	call Wifi.init
 530  801D 18 06        	jr init_uart_yes
 531  801F              init_uart_no
 532  801F              	;печать
 533  801F 21 D9 35     	ld hl,msg_init_uart_not_found
 534  8022 CD 80 0A     	call drvgmx.printZ
 535  8025              init_uart_yes
 536  8025
 537  8025
 538  8025              net_loop
 539  8025              	OS_WAIT
 539  8025 DF          >	rst #18
 540  8026 CD 9A 81     	call print_active_net ;индикатор
 541  8029 CD 3C 80     	call esp_check_open ;проверить соединения
 542  802C CD A2 80     	call esp_check_send ;проверить пакеты на отправку
 543  802F CD C5 80     	call esp_check_get ;проверить пакеты на приём
 544  8032 3A 25 2C     	ld a,(sys_timer) ;иногда печатаем сетевую информацию
 545  8035 E6 0E        	and %00001110
 546  8037 CC 1C 81     	call z,print_esp_link
 547  803A
 548  803A 18 E9        	jr net_loop
 549  803C
 550  803C
 551  803C              esp_check_open ;проверка очереди соединений ESP
 552  803C DD 21 80 35  	ld ix,esp_link_id_table ;
 553  8040              	;push bc
 554  8040 DD 7E 01     	ld a,(ix+1)
 555  8043 B7           	or a ;запрос есть?
 556  8044 C8           	ret z
 557  8045              	;есть запрос
 558  8045
 559  8045 DD 7E 0E     	ld a,(ix+14) ;подставить тип соединения
 560  8048 B7           	or a
 561  8049 20 11        	jr nz,esp_check_open_type1
 562  804B 3E 54        	ld a,'T'
 563  804D 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 564  8050 3E 43        	ld a,'C'
 565  8052 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 566  8055 3E 50        	ld a,'P'
 567  8057 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 568  805A 18 2A        	jr esp_check_open_type_skip
 569  805C              esp_check_open_type1
 570  805C FE 01        	cp 1
 571  805E 20 11        	jr nz,esp_check_open_type2
 572  8060 3E 55        	ld a,'U'
 573  8062 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 574  8065 3E 44        	ld a,'D'
 575  8067 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 576  806A 3E 50        	ld a,'P'
 577  806C 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 578  806F 18 15        	jr esp_check_open_type_skip
 579  8071              esp_check_open_type2
 580  8071 FE 02        	cp 2
 581  8073 20 11        	jr nz,esp_check_open_type_skip
 582  8075 3E 53        	ld a,'S'
 583  8077 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 584  807A 3E 53        	ld a,'S'
 585  807C 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 586  807F 3E 4C        	ld a,'L'
 587  8081 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 588  8084 18 00        	jr esp_check_open_type_skip
 589  8086
 590  8086              esp_check_open_type_skip
 591  8086 11 BB 35     	ld de,esp_link_id_table+59 ;номер порта
 592  8089 21 8F 35     	ld hl,esp_link_id_table+15 ;;адрес сервера
 593  808C CD DD 82     	call Wifi.openTCP
 594  808F 30 04        	jr nc,esp_check_open_res
 595  8091 3E FF        	ld a,255 ;ошибка
 596  8093 18 05        	jr esp_check_open_err
 597  8095              esp_check_open_res
 598  8095              	;результат запишем
 599  8095 3A 3A 82     	ld a,(Wifi.closed)
 600  8098 EE 01        	xor 1
 601  809A              esp_check_open_err
 602  809A DD 77 02     	ld (ix+2),a ;поставить флаг результата открытия
 603  809D DD 36 01 00  	ld (ix+1),0 ;сбросить флаг запроса
 604  80A1 C9           	ret
 605  80A2
 606  80A2
 607  80A2
 608  80A2
 609  80A2
 610  80A2              esp_check_send ;проверить пакеты на отправку
 611  80A2 DD 21 80 35  	ld ix,esp_link_id_table ;
 612  80A6 DD 7E 03     	ld a,(ix+3)
 613  80A9 B7           	or a ;запрос есть?
 614  80AA C8           	ret z
 615  80AB              	;есть запрос
 616  80AB DD 5E 09     	ld e,(ix+9) ;длина данных
 617  80AE DD 56 0A     	ld d,(ix+10)
 618  80B1 21 2D 36     	ld hl,esp_buffer ;адрес
 619  80B4 CD 9E 83     	call Wifi.tcpSend
 620  80B7 3E 01        	ld a,1 ;успех
 621  80B9 30 02        	jr nc,esp_check_send_res
 622  80BB 3E FF        	ld a,255 ;ошибка
 623  80BD              esp_check_send_res
 624  80BD DD 77 04     	ld (ix+4),a ;поставить флаг результата отправки
 625  80C0 DD 36 03 00  	ld (ix+3),0 ;сбросить флаг запроса
 626  80C4 C9           	ret
 627  80C5
 628  80C5
 629  80C5
 630  80C5
 631  80C5
 632  80C5              esp_check_get ;проверить пакеты на приём
 633  80C5 DD 21 80 35  	ld ix,esp_link_id_table ;
 634  80C9 DD 7E 05     	ld a,(ix+5)
 635  80CC B7           	or a ;запрос есть?
 636  80CD C8           	ret z
 637  80CE              	;есть запрос
 638  80CE 21 00 00     	ld hl,0
 639  80D1 22 36 82     	ld (Wifi.bytes_avail), hl ;длину сбросим
 640  80D4 21 2D 36     	ld hl,esp_buffer ;адрес
 641  80D7 22 38 82     	ld (Wifi.buffer_pointer),hl ;
 642  80DA CD E0 83     	call Wifi.getPacket
 643  80DD 30 0A        	jr nc,esp_check_get_res
 644  80DF 3E FF        	ld a,255 ;ошибка
 645  80E1 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 646  80E4 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 647  80E8 C9           	ret
 648  80E9              esp_check_get_res
 649  80E9              	;если что-то принято
 650  80E9 ED 4B 36 82  	ld bc,(Wifi.bytes_avail) ;длина
 651  80ED DD 71 09     	ld (ix+9),c ;длина принятых
 652  80F0 DD 70 0A     	ld (ix+10),b
 653  80F3
 654  80F3 78           	ld a,b
 655  80F4 B1           	or c
 656  80F5 28 0F        	jr z,esp_check_get_skip_copy2 ;защита от нулевой длины
 657  80F7
 658  80F7 DD 5E 07     	ld e,(ix+7) ;адрес назначения
 659  80FA DD 56 08     	ld d,(ix+8)
 660  80FD DD 7E 00     	ld a,(ix) ;id назначения
 661  8100 21 2D 36     	ld hl,esp_buffer ;откуда
 662  8103 CD C4 05     	call esp_buffer_copy ;перекинем данные силами ядра
 663  8106
 664  8106              esp_check_get_skip_copy2
 665  8106 DD 21 80 35  	ld ix,esp_link_id_table ;
 666  810A 3A 3A 82     	ld a,(Wifi.closed)
 667  810D EE 01        	xor 1
 668  810F DD 77 02     	ld (ix+2),a ;поставить текущий флаг открытия
 669  8112 3E 01        	ld a,1 ;успех
 670  8114 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 671  8117 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 672  811B C9           	ret
 673  811C
 674  811C
 675  811C              print_esp_link
 676  811C 26 0B        	ld h,#0b
 677  811E 3E 20        	ld a," "
 678  8120              	OS_FILL_LINE ;почистить строку
 678  8120 0E 03       >    ld c,#03
 678  8122 E7          >    rst #20
 679  8123 DD 21 80 35  	ld ix,esp_link_id_table
 680  8127
 681  8127 11 00 0B     	ld de,#0b00 ;координаты yx
 682  812A              	OS_SET_XY
 682  812A 0E 01       >    ld c,#01
 682  812C E7          >    rst #20
 683  812D 21 00 85     	ld hl,msg_esp_link
 684  8130              	OS_PRINTZ
 684  8130 0E 09       >    ld c,#09
 684  8132 E7          >    rst #20
 685  8133 DD 7E 00     	ld a,(ix)
 686  8136 C6 30        	add '0'
 687  8138              	OS_PRINT_CHARF ;id
 687  8138 D7          >	rst #10
 688  8139 3E 20        	ld a," "
 689  813B              	OS_PRINT_CHARF
 689  813B D7          >	rst #10
 690  813C
 691  813C DD 7E 00     	ld a,(ix)
 692  813F B7           	or a
 693  8140 C8           	ret z ;если нет соединений
 694  8141
 695  8141 21 09 85     	ld hl,msg_esp_transmit
 696  8144              	OS_PRINTZ
 696  8144 0E 09       >    ld c,#09
 696  8146 E7          >    rst #20
 697  8147 DD 7E 04     	ld a,(ix+4)
 698  814A B7           	or a
 699  814B 28 1C        	jr z,print_esp_link2
 700  814D DD 7E 05     	ld a,(ix+5) ;при этом не начался приём
 701  8150 4F           	ld c,a
 702  8151 DD 7E 06     	ld a,(ix+6)
 703  8154 B1           	or c
 704  8155 20 12        	jr nz,print_esp_link2
 705  8157 DD 6E 09     	ld l,(ix+9)
 706  815A DD 66 0A     	ld h,(ix+10)
 707  815D CD ED 05     	call toDecimal
 708  8160 21 43 06     	ld hl,decimalS
 709  8163              	OS_PRINTZ	;отправлено
 709  8163 0E 09       >    ld c,#09
 709  8165 E7          >    rst #20
 710  8166 3E 20        	ld a," "
 711  8168              	OS_PRINT_CHARF
 711  8168 D7          >	rst #10
 712  8169              print_esp_link2
 713  8169
 714  8169 21 0F 85     	ld hl,msg_esp_receive
 715  816C              	OS_PRINTZ
 715  816C 0E 09       >    ld c,#09
 715  816E E7          >    rst #20
 716  816F DD 7E 06     	ld a,(ix+6)
 717  8172 B7           	or a
 718  8173 28 12        	jr z,print_esp_link3
 719  8175 DD 6E 09     	ld l,(ix+9)
 720  8178 DD 66 0A     	ld h,(ix+10)
 721  817B CD ED 05     	call toDecimal
 722  817E 21 43 06     	ld hl,decimalS
 723  8181              	OS_PRINTZ	;принято
 723  8181 0E 09       >    ld c,#09
 723  8183 E7          >    rst #20
 724  8184 3E 20        	ld a," "
 725  8186              	OS_PRINT_CHARF
 725  8186 D7          >	rst #10
 726  8187              print_esp_link3
 727  8187
 728  8187 21 15 85     	ld hl,msg_esp_address
 729  818A              	OS_PRINTZ
 729  818A 0E 09       >    ld c,#09
 729  818C E7          >    rst #20
 730  818D DD 7E 02     	ld a,(ix+2) ;соединение установлено
 731  8190 B7           	or a
 732  8191 28 06        	jr z,print_esp_link4
 733  8193 21 8F 35     	ld hl,esp_link_id_table+15 ;сервер
 734  8196              	OS_PRINTZ
 734  8196 0E 09       >    ld c,#09
 734  8198 E7          >    rst #20
 735  8199              print_esp_link4
 736  8199 C9           	ret
 737  819A
 738  819A
 739  819A
 740  819A
 741  819A              print_active_net ;значёк активности
 742  819A 11 00 0A     	ld de,#0a00 ;координаты yx
 743  819D              	OS_SET_XY
 743  819D 0E 01       >    ld c,#01
 743  819F E7          >    rst #20
 744  81A0 21 BC 81     	ld hl,msg_active_net
 745  81A3              	OS_PRINTZ
 745  81A3 0E 09       >    ld c,#09
 745  81A5 E7          >    rst #20
 746  81A6 3A C9 81     	ld a,(msg_active_net_cur)
 747  81A9 3C           	inc a
 748  81AA FE 04        	cp 4
 749  81AC 38 01        	jr c,print_active_net1
 750  81AE AF           	xor a
 751  81AF              print_active_net1
 752  81AF 32 C9 81     	ld (msg_active_net_cur),a
 753  81B2 4F           	ld c,a
 754  81B3 06 00        	ld b,0
 755  81B5 21 C4 81     	ld hl,msg_active_net1
 756  81B8 09           	add hl,bc
 757  81B9 7E           	ld a,(hl)
 758  81BA              	OS_PRINT_CHARF
 758  81BA D7          >	rst #10
 759  81BB C9           	ret
 760  81BC
 761  81BC
 762  81BC
 763  81BC
 764  81BC
 765  81BC
 766  81BC 41 63 74 69  msg_active_net db "Active ",0
 766  81C0 76 65 20 00
 767  81C4 7C 2F 2D 5C  msg_active_net1 db "|/-\\",0
 767  81C8 00
 768  81C9 00           msg_active_net_cur db 0 ;текущий значёк активности
 769  81CA
 770  81CA              	include Drv/zx-wifi.asm ;драйвер сетевой карты ESP
# file opened: Drv/zx-wifi.asm
   1+ 81CA              ; This driver works with 16c550 uart that's support AFE
   2+ 81CA                  module Uart
   3+ 81CA              ; Make init shorter and readable:-)
   4+ 81CA                  macro outp port, value
   5+ 81CA ~            	ld b, port
   6+ 81CA ~            	ld c, #EF
   7+ 81CA ~                ld a, value
   8+ 81CA ~                out (c), a
   9+ 81CA                  endm
  10+ 81CA
  11+ 81CA              ; Internal port constants
  12+ 81CA              RBR_THR = #F8
  13+ 81CA              IER     = RBR_THR + 1
  14+ 81CA              IIR_FCR = RBR_THR + 2
  15+ 81CA              LCR     = RBR_THR + 3
  16+ 81CA              MCR     = RBR_THR + 4
  17+ 81CA              LSR     = RBR_THR + 5
  18+ 81CA              MSR     = RBR_THR + 6
  19+ 81CA              SR      = RBR_THR + 7
  20+ 81CA
  21+ 81CA
  22+ 81CA              ;out: a=255 - no UART
  23+ 81CA              check: ;проверка есть ли карта
  24+ 81CA 3E F8        	ld a, RBR_THR
  25+ 81CC DB FE            in a, (#fe)
  26+ 81CE FE FF        	cp #ff
  27+ 81D0 C0           	ret nz ;если читает 255, то нет карты
  28+ 81D1 3E F8        	ld a, RBR_THR
  29+ 81D3 DB FE            in a, (#fe) ;второй раз для надёжности
  30+ 81D5 FE FF        	cp #ff
  31+ 81D7 C9           	ret
  32+ 81D8
  33+ 81D8
  34+ 81D8              init:
  35+ 81D8                  outp MCR,     #0d  // Assert RTS
  35+ 81D8 06 FC       >	ld b, MCR
  35+ 81DA 0E EF       >	ld c, #EF
  35+ 81DC 3E 0D       >    ld a, #0d
  35+ 81DE ED 79       >    out (c), a
  36+ 81E0                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  36+ 81E0 06 FA       >	ld b, IIR_FCR
  36+ 81E2 0E EF       >	ld c, #EF
  36+ 81E4 3E 87       >    ld a, #87
  36+ 81E6 ED 79       >    out (c), a
  37+ 81E8                  outp LCR,     #83  // 8n1, DLAB=1
  37+ 81E8 06 FB       >	ld b, LCR
  37+ 81EA 0E EF       >	ld c, #EF
  37+ 81EC 3E 83       >    ld a, #83
  37+ 81EE ED 79       >    out (c), a
  38+ 81F0                  outp RBR_THR, #01  // 115200 (divider 1)
  38+ 81F0 06 F8       >	ld b, RBR_THR
  38+ 81F2 0E EF       >	ld c, #EF
  38+ 81F4 3E 01       >    ld a, #01
  38+ 81F6 ED 79       >    out (c), a
  39+ 81F8                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  39+ 81F8 06 F9       >	ld b, IER
  39+ 81FA 0E EF       >	ld c, #EF
  39+ 81FC 3E 00       >    ld a, #00
  39+ 81FE ED 79       >    out (c), a
  40+ 8200
  41+ 8200                  outp LCR,     #03 // 8n1, DLAB=0
  41+ 8200 06 FB       >	ld b, LCR
  41+ 8202 0E EF       >	ld c, #EF
  41+ 8204 3E 03       >    ld a, #03
  41+ 8206 ED 79       >    out (c), a
  42+ 8208                  outp IER,     #00 // Disable int
  42+ 8208 06 F9       >	ld b, IER
  42+ 820A 0E EF       >	ld c, #EF
  42+ 820C 3E 00       >    ld a, #00
  42+ 820E ED 79       >    out (c), a
  43+ 8210                  outp MCR,     #2f // Enable AFE
  43+ 8210 06 FC       >	ld b, MCR
  43+ 8212 0E EF       >	ld c, #EF
  43+ 8214 3E 2F       >    ld a, #2f
  43+ 8216 ED 79       >    out (c), a
  44+ 8218 C9               ret
  45+ 8219
  46+ 8219              ;retry_rec_count_max equ %00011111 ;ждать столько прерываний
  47+ 8219
  48+ 8219              ; Flag C <- Data available
  49+ 8219              ; isAvailable:
  50+ 8219                  ; ld a, LSR
  51+ 8219                  ; in a, (#EF)
  52+ 8219                  ; rrca
  53+ 8219                  ; ret
  54+ 8219
  55+ 8219              ; Non-blocking read
  56+ 8219              ; Flag C <- is byte was readen
  57+ 8219              ; A <- byte
  58+ 8219              ; read1:
  59+ 8219                  ; ld a, LSR
  60+ 8219                  ; in a, (#EF)
  61+ 8219                  ; rrca
  62+ 8219                  ; ret nc
  63+ 8219                  ; ld a, RBR_THR
  64+ 8219                  ; in a, (#EF)
  65+ 8219                  ; scf
  66+ 8219                  ; ret
  67+ 8219
  68+ 8219              ; Tries read byte with timeout
  69+ 8219              ; Flag C <- is byte read
  70+ 8219              ; A <- byte
  71+ 8219              read:
  72+ 8219              	;xor a ;4
  73+ 8219              	;ld (#5C78),a ;обнулить счётчик ожидания ;13
  74+ 8219              .wait
  75+ 8219 3E FD            ld a, LSR
  76+ 821B DB EF            in a, (#EF)
  77+ 821D 0F               rrca
  78+ 821E 30 F9        	jr nc, .wait
  79+ 8220 3E F8            ld a, RBR_THR
  80+ 8222 DB EF            in a, (#EF)
  81+ 8224 C9           	ret
  82+ 8225              ; .readW
  83+ 8225              	; OS_GETTIMER
  84+ 8225              	; ld a,e
  85+ 8225              	; and retry_rec_count_max
  86+ 8225              	; ;ld a,(#5C78)
  87+ 8225              	; ;cp retry_rec_count_max
  88+ 8225              	; jr nz, .wait ;ещё попытка
  89+ 8225              	; xor a ;выключим флаг переноса если время вышло
  90+ 8225              	; ret
  91+ 8225
  92+ 8225
  93+ 8225
  94+ 8225
  95+ 8225              ; Blocking read
  96+ 8225              ; A <- Byte
  97+ 8225              ; readB:
  98+ 8225                  ; ld a, LSR
  99+ 8225                  ; in a, (#EF)
 100+ 8225                  ; rrca
 101+ 8225                  ; jr nc, readB
 102+ 8225              	; ld a, RBR_THR
 103+ 8225                  ; in a, (#EF)
 104+ 8225                  ; ret
 105+ 8225
 106+ 8225              ; A -> byte to send
 107+ 8225              write:
 108+ 8225 F5               push af
 109+ 8226              .wait
 110+ 8226 3E FD        	ld a, LSR
 111+ 8228 DB EF            in a, (#EF)
 112+ 822A E6 20            and #20
 113+ 822C 28 F8            jr z, .wait
 114+ 822E F1               pop af
 115+ 822F 06 F8        	ld b, RBR_THR
 116+ 8231 0E EF        	ld c, #EF
 117+ 8233 ED 79            out (c), a
 118+ 8235 C9               ret
 119+ 8236
 120+ 8236                  endmodule
# file closed: Drv/zx-wifi.asm
 771  8236              	include Drv/wifi.asm ;работа с ESP
# file opened: Drv/wifi.asm
   1+ 8236                  MODULE Wifi
   2+ 8236 00 00        bytes_avail dw 0 ;байт для приёма
   3+ 8238 00 00        buffer_pointer dw 0 ;указатель на адрес буфера
   4+ 823A 01           closed db 1 ;флаг "соединение закрыто"
   5+ 823B              ;link_id db 0 ;текущий id соединения
   6+ 823B              buffer_end equ #80 ;ограничение буфера адрес #4000
   7+ 823B
   8+ 823B              ; Initialize Wifi chip to work
   9+ 823B              init:
  10+ 823B 21 B4 82         ld hl, .uartIniting
  10+ 823E CD 80 0A       call drvgmx.printZ
  11+ 8241 CD D8 81         call Uart.init ;
  12+ 8244 21 C5 82         ld hl, .chipIniting
  12+ 8247 CD 80 0A       call drvgmx.printZ
  13+ 824A                  ;EspCmdOkErr "ATE0"
  14+ 824A 21 94 84     	ld hl,cmd_ATE0
  15+ 824D CD 83 83     	call espSendZ
  16+ 8250 CD 1C 83     	call checkOkErr
  17+ 8253 38 3F            jr c, .initError
  18+ 8255
  19+ 8255                  ;EspCmdOkErr "AT+CIPSERVER=0"
  20+ 8255 21 9B 84     	ld hl,cmd_CIPSERVER
  21+ 8258 CD 83 83     	call espSendZ
  22+ 825B CD 1C 83     	call checkOkErr
  23+ 825E                  ;jr c, .initError ;не проверяем ошибку
  24+ 825E                  ;EspCmdOkErr "AT+CIPCLOSE" ;  Close if there some connection was. Don't care about result
  25+ 825E 21 CC 84     	ld hl,cmd_CIPCLOSE
  26+ 8261 CD 83 83     	call espSendZ
  27+ 8264 3E 35        	ld a,'5' ;закрыть все соединения
  28+ 8266 CD 25 82     	call Uart.write
  29+ 8269 3E 0D            ld a, 13
  29+ 826B CD 25 82       call Uart.write
  30+ 826E 3E 0A            ld a, 10
  30+ 8270 CD 25 82       call Uart.write
  31+ 8273 CD 1C 83     	call checkOkErr
  32+ 8276                  ;jr c, .initError ;не проверяем ошибку
  33+ 8276                  ;EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  34+ 8276 21 D8 84     	ld hl,cmd_CIPMUX
  35+ 8279 CD 83 83     	call espSendZ
  36+ 827C CD 1C 83     	call checkOkErr
  37+ 827F 38 13            jr c, .initError
  38+ 8281
  39+ 8281                  ;EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  40+ 8281 21 E6 84     	ld hl,cmd_CIPDINFO
  41+ 8284 CD 83 83     	call espSendZ
  42+ 8287 CD 1C 83     	call checkOkErr
  43+ 828A 38 08            jr c, .initError
  44+ 828C
  45+ 828C 21 D6 82         ld hl, .doneInit
  45+ 828F CD 80 0A       call drvgmx.printZ
  46+ 8292
  47+ 8292 B7               or a
  48+ 8293 C9               ret
  49+ 8294              .initError
  50+ 8294 21 9C 82         ld hl, .errMsg
  50+ 8297 CD 80 0A       call drvgmx.printZ
  51+ 829A 37               scf
  52+ 829B C9               ret
  53+ 829C 57 69 46 69  .errMsg db "WiFi chip init failed!",13,0
  53+ 82A0 20 63 68 69
  53+ 82A4 70 20 69 6E
  53+ 82A8 69 74 20 66
  53+ 82AC 61 69 6C 65
  53+ 82B0 64 21 0D 00
  54+ 82B4 55 61 72 74  .uartIniting db "Uart initing...",13,0
  54+ 82B8 20 69 6E 69
  54+ 82BC 74 69 6E 67
  54+ 82C0 2E 2E 2E 0D
  54+ 82C4 00
  55+ 82C5 43 68 69 70  .chipIniting db "Chip initing...",13,0
  55+ 82C9 20 69 6E 69
  55+ 82CD 74 69 6E 67
  55+ 82D1 2E 2E 2E 0D
  55+ 82D5 00
  56+ 82D6 44 6F 6E 65  .doneInit    db "Done!",13,0
  56+ 82DA 21 0D 00
  57+ 82DD                  IFNDEF PROXY
  58+ 82DD              ; HL - host pointer in gopher row
  59+ 82DD              ; DE - port pointer in gopher row
  60+ 82DD              openTCP:
  61+ 82DD D5               push de
  62+ 82DE E5               push hl
  63+ 82DF                  ;EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  64+ 82DF 21 CC 84     	ld hl,cmd_CIPCLOSE
  65+ 82E2 CD 83 83     	call espSendZ
  66+ 82E5              	; ld a,(link_id)
  67+ 82E5              	; call Uart.write
  68+ 82E5 3E 0D            ld a, 13
  68+ 82E7 CD 25 82       call Uart.write
  69+ 82EA 3E 0A            ld a, 10
  69+ 82EC CD 25 82       call Uart.write
  70+ 82EF CD 1C 83     	call checkOkErr
  71+ 82F2
  72+ 82F2                  ;EspSend 'AT+CIPSTART,"TCP","' ;
  73+ 82F2 21 AC 84     	ld hl,cmd_CIPSTART
  74+ 82F5 CD 83 83     	call espSendZ
  75+ 82F8              	; ld a,(link_id)
  76+ 82F8              	; call Uart.write
  77+ 82F8              	; ld hl,cmd_CIPSTART2
  78+ 82F8              	; call espSendZ
  79+ 82F8
  80+ 82F8
  81+ 82F8 E1               pop hl
  82+ 82F9 CD 8C 83         call espSendT
  83+ 82FC                  ;EspSend '",'
  84+ 82FC 3E 22            ld a, '"'
  84+ 82FE CD 25 82       call Uart.write
  85+ 8301 3E 2C            ld a, ','
  85+ 8303 CD 25 82       call Uart.write
  86+ 8306 E1               pop hl
  87+ 8307 CD 8C 83         call espSendT
  88+ 830A 3E 0D            ld a, 13
  88+ 830C CD 25 82       call Uart.write
  89+ 830F 3E 0A            ld a, 10
  89+ 8311 CD 25 82       call Uart.write
  90+ 8314 AF               xor a
  90+ 8315 32 3A 82       ld (closed), a
  91+ 8318 C3 1C 83         jp checkOkErr
  92+ 831B
  93+ 831B              continue:
  94+ 831B C9               ret
  95+ 831C                  ENDIF
  96+ 831C
  97+ 831C
  98+ 831C
  99+ 831C              checkOkErr:
 100+ 831C CD 19 82         call Uart.read
 101+ 831F FE 4F            cp 'O'
 101+ 8321 28 0A          jr z, .okStart ; OK
 102+ 8323 FE 45            cp 'E'
 102+ 8325 28 19          jr z, .errStart ; ERROR
 103+ 8327 FE 46            cp 'F'
 103+ 8329 28 36          jr z, .failStart ; FAIL
 104+ 832B 18 EF            jr checkOkErr
 105+ 832D              .okStart
 106+ 832D CD 19 82         call Uart.read
 106+ 8330 FE 4B          cp 'K'
 106+ 8332 20 E8          jr nz, checkOkErr
 107+ 8334 CD 19 82         call Uart.read
 107+ 8337 FE 0D          cp 13
 107+ 8339 20 E1          jr nz, checkOkErr
 108+ 833B CD 7B 83         call .flushToLF
 109+ 833E B7               or a
 110+ 833F C9               ret
 111+ 8340              .errStart
 112+ 8340 CD 19 82         call Uart.read
 112+ 8343 FE 52          cp 'R'
 112+ 8345 20 D5          jr nz, checkOkErr
 113+ 8347 CD 19 82         call Uart.read
 113+ 834A FE 52          cp 'R'
 113+ 834C 20 CE          jr nz, checkOkErr
 114+ 834E CD 19 82         call Uart.read
 114+ 8351 FE 4F          cp 'O'
 114+ 8353 20 C7          jr nz, checkOkErr
 115+ 8355 CD 19 82         call Uart.read
 115+ 8358 FE 52          cp 'R'
 115+ 835A 20 C0          jr nz, checkOkErr
 116+ 835C CD 7B 83         call .flushToLF
 117+ 835F 37               scf
 118+ 8360 C9               ret
 119+ 8361              .failStart
 120+ 8361 CD 19 82         call Uart.read
 120+ 8364 FE 41          cp 'A'
 120+ 8366 20 B4          jr nz, checkOkErr
 121+ 8368 CD 19 82         call Uart.read
 121+ 836B FE 49          cp 'I'
 121+ 836D 20 AD          jr nz, checkOkErr
 122+ 836F CD 19 82         call Uart.read
 122+ 8372 FE 4C          cp 'L'
 122+ 8374 20 A6          jr nz, checkOkErr
 123+ 8376 CD 7B 83         call .flushToLF
 124+ 8379 37               scf
 125+ 837A C9               ret
 126+ 837B              .flushToLF
 127+ 837B CD 19 82         call Uart.read
 128+ 837E FE 0A            cp 10
 128+ 8380 20 F9          jr nz, .flushToLF
 129+ 8382 C9               ret
 130+ 8383
 131+ 8383              ; Send buffer to UART
 132+ 8383              ; HL - buff
 133+ 8383              ; E - count
 134+ 8383              ; espSend:
 135+ 8383                  ; ld a, (hl) : call Uart.write
 136+ 8383                  ; inc hl
 137+ 8383                  ; dec e
 138+ 8383                  ; jr nz, espSend
 139+ 8383                  ; ret
 140+ 8383
 141+ 8383              ; Send buffer to UART
 142+ 8383              ; HL - buff (0 - end!)
 143+ 8383              espSendZ:
 144+ 8383 7E               ld a, (hl)
 145+ 8384 B7           	or a
 146+ 8385 C8           	ret z
 147+ 8386 CD 25 82     	call Uart.write
 148+ 8389 23               inc hl
 149+ 838A 18 F7            jr espSendZ
 150+ 838C
 151+ 838C
 152+ 838C              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 153+ 838C              espSendT:
 154+ 838C 7E               ld a, (hl)
 155+ 838D
 156+ 838D A7               and a
 156+ 838E C8             ret z
 157+ 838F FE 09            cp 9
 157+ 8391 C8             ret z
 158+ 8392 FE 0D            cp 13
 158+ 8394 C8             ret z
 159+ 8395 FE 0A            cp 10
 159+ 8397 C8             ret z
 160+ 8398
 161+ 8398 CD 25 82         call Uart.write
 162+ 839B 23               inc hl
 163+ 839C 18 EE            jr espSendT
 164+ 839E
 165+ 839E              ; HL - stringZ to send
 166+ 839E              ; Adds CR LF
 167+ 839E              ; tcpSendZ:
 168+ 839E                  ; push hl
 169+ 839E                  ; ;EspSend "AT+CIPSEND=" ;
 170+ 839E              	; ld hl,cmd_CIPSEND
 171+ 839E              	; call espSendZ
 172+ 839E              	; ; ld a,(link_id)
 173+ 839E              	; ; call Uart.write
 174+ 839E                  ; ;ld a, ',' : call Uart.write
 175+ 839E
 176+ 839E                  ; pop de : push de
 177+ 839E                  ; call strLen
 178+ 839E                  ; inc hl : inc hl ; +CRLF
 179+ 839E                  ; call hlToNumEsp
 180+ 839E                  ; ld a, 13 : call Uart.write
 181+ 839E                  ; ld a, 10 : call Uart.write
 182+ 839E                  ; call checkOkErr : jr c,.exit_err
 183+ 839E              ; .wait
 184+ 839E                  ; call Uart.read : cp '>' : jr nz, .wait
 185+ 839E                  ; pop hl
 186+ 839E              ; .loop
 187+ 839E                  ; ld a, (hl) : and a : jr z, .exit
 188+ 839E                  ; call Uart.write
 189+ 839E                  ; inc hl
 190+ 839E                  ; jp .loop
 191+ 839E              ; .exit
 192+ 839E                  ; ld a, 13 : call Uart.write
 193+ 839E                  ; ld a, 10 : call Uart.write
 194+ 839E                  ; jp checkOkErr
 195+ 839E              ; .exit_err
 196+ 839E              	; pop hl
 197+ 839E              	; ret
 198+ 839E
 199+ 839E
 200+ 839E
 201+ 839E              ; HL - string to send
 202+ 839E              ; DE - lenght
 203+ 839E              ; Adds CR LF
 204+ 839E              tcpSend:
 205+ 839E E5               push hl
 206+ 839F D5           	push de ;
 207+ 83A0                  ;EspSend "AT+CIPSEND=" ;
 208+ 83A0 21 C0 84     	ld hl,cmd_CIPSEND
 209+ 83A3 CD 83 83     	call espSendZ
 210+ 83A6              	; ld a,(link_id)
 211+ 83A6              	; call Uart.write
 212+ 83A6                  ;ld a, ',' : call Uart.write
 213+ 83A6
 214+ 83A6 E1               pop hl
 214+ 83A7 E5             push hl ;длина
 215+ 83A8                  ;call strLen
 216+ 83A8 23               inc hl
 216+ 83A9 23             inc hl ; +CRLF
 217+ 83AA CD 6D 84         call hlToNumEsp
 218+ 83AD 3E 0D            ld a, 13
 218+ 83AF CD 25 82       call Uart.write
 219+ 83B2 3E 0A            ld a, 10
 219+ 83B4 CD 25 82       call Uart.write
 220+ 83B7 CD 1C 83         call checkOkErr
 220+ 83BA 38 21          jr c,.exit_err2
 221+ 83BC              .wait2
 222+ 83BC CD 19 82         call Uart.read
 222+ 83BF FE 3E          cp '>'
 222+ 83C1 20 F9          jr nz, .wait2
 223+ 83C3 D1           	pop de ;длина
 224+ 83C4 E1               pop hl
 225+ 83C5              .loop2
 226+ 83C5 7E               ld a, (hl)
 227+ 83C6 CD 25 82         call Uart.write
 228+ 83C9 23               inc hl
 229+ 83CA 1B           	dec de
 230+ 83CB 7A           	ld a,d
 231+ 83CC B3           	or e
 232+ 83CD C2 C5 83         jp nz, .loop2
 233+ 83D0              .exit2
 234+ 83D0 3E 0D            ld a, 13
 234+ 83D2 CD 25 82       call Uart.write
 235+ 83D5 3E 0A            ld a, 10
 235+ 83D7 CD 25 82       call Uart.write
 236+ 83DA C3 1C 83         jp checkOkErr
 237+ 83DD              .exit_err2
 238+ 83DD D1           	pop de
 239+ 83DE E1           	pop hl
 240+ 83DF C9           	ret
 241+ 83E0
 242+ 83E0
 243+ 83E0
 244+ 83E0
 245+ 83E0              getPacket:
 246+ 83E0 CD 19 82         call Uart.read
 247+ 83E3 FE 2B            cp '+'
 247+ 83E5 28 28          jr z, .ipdBegun    ; "+IPD," packet
 248+ 83E7 FE 4F            cp 'O'
 248+ 83E9 28 02          jr z, .closedBegun ; It enough to check "OSED\n" :-)
 249+ 83EB 18 F3            jr getPacket
 250+ 83ED              .closedBegun
 251+ 83ED CD 19 82         call Uart.read
 251+ 83F0 FE 53          cp 'S'
 251+ 83F2 20 EC          jr nz, getPacket
 252+ 83F4 CD 19 82         call Uart.read
 252+ 83F7 FE 45          cp 'E'
 252+ 83F9 20 E5          jr nz, getPacket
 253+ 83FB CD 19 82         call Uart.read
 253+ 83FE FE 44          cp 'D'
 253+ 8400 20 DE          jr nz, getPacket
 254+ 8402 CD 19 82         call Uart.read
 254+ 8405 FE 0D          cp 13
 254+ 8407 20 D7          jr nz, getPacket
 255+ 8409 3E 01 32 3A      ld a, 1, (closed), a
 255+ 840D 82
 256+ 840E C9               ret
 257+ 840F              .ipdBegun
 258+ 840F CD 19 82         call Uart.read
 258+ 8412 FE 49          cp 'I'
 258+ 8414 20 CA          jr nz, getPacket
 259+ 8416 CD 19 82         call Uart.read
 259+ 8419 FE 50          cp 'P'
 259+ 841B 20 C3          jr nz, getPacket
 260+ 841D CD 19 82         call Uart.read
 260+ 8420 FE 44          cp 'D'
 260+ 8422 20 BC          jr nz, getPacket
 261+ 8424 CD 19 82         call Uart.read ; Comma
 262+ 8427              	; call Uart.read ; link ID
 263+ 8427              	; ld (link_id),a ;запомнить
 264+ 8427              	;call Uart.read ; Comma
 265+ 8427 CD 54 84         call .count_ipd_lenght
 265+ 842A 22 36 82       ld (bytes_avail), hl
 266+ 842D 44 4D            ld bc, hl
 267+ 842F 2A 38 82         ld hl, (buffer_pointer)
 268+ 8432              .readp
 269+ 8432 7C               ld a, h
 269+ 8433 FE 80          cp buffer_end
 269+ 8435 30 12          jr nc, .skipbuff ;
 270+ 8437 C5 E5            push bc, hl
 271+ 8439 CD 19 82         call Uart.read
 272+ 843C E1 C1            pop hl, bc
 273+ 843E 77               ld (hl), a
 274+ 843F 0B               dec bc
 274+ 8440 23             inc hl
 275+ 8441 78               ld a, b
 275+ 8442 B1             or c
 275+ 8443 20 ED          jr nz, .readp
 276+ 8445 22 38 82         ld (buffer_pointer), hl
 277+ 8448 C9               ret
 278+ 8449              .skipbuff
 279+ 8449 C5               push bc
 280+ 844A CD 19 82         call Uart.read
 281+ 844D C1               pop bc
 282+ 844E 0B               dec bc
 282+ 844F 78             ld a, b
 282+ 8450 B1             or c
 282+ 8451 20 F6          jr nz, .skipbuff
 283+ 8453 C9               ret
 284+ 8454              .count_ipd_lenght
 285+ 8454 21 00 00     		ld hl,0			; count lenght
 286+ 8457 E5           .cil1	push  hl
 287+ 8458 CD 19 82             call Uart.read
 288+ 845B E1                   pop hl
 289+ 845C FE 3A        		cp ':'
 289+ 845E C8             ret z
 290+ 845F D6 30        		sub 0x30
 290+ 8461 4D             ld c,l
 290+ 8462 44             ld b,h
 290+ 8463 29             add hl,hl
 290+ 8464 29             add hl,hl
 290+ 8465 09             add hl,bc
 290+ 8466 29             add hl,hl
 290+ 8467 4F             ld c,a
 290+ 8468 06 00          ld b,0
 290+ 846A 09             add hl,bc
 291+ 846B 18 EA        		jr .cil1
 292+ 846D
 293+ 846D              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 294+ 846D              ; HL - number
 295+ 846D              ; It will be written to UART
 296+ 846D              hlToNumEsp:
 297+ 846D 01 F0 D8     	ld	bc,-10000
 298+ 8470 CD 86 84     	call	.n1
 299+ 8473 01 18 FC     	ld	bc,-1000
 300+ 8476 CD 86 84     	call	.n1
 301+ 8479 01 9C FF     	ld	bc,-100
 302+ 847C CD 86 84     	call	.n1
 303+ 847F 0E F6        	ld	c,-10
 304+ 8481 CD 86 84     	call	.n1
 305+ 8484 0E FF        	ld	c,-1
 306+ 8486 3E 2F        .n1	ld	a,'0'-1
 307+ 8488 3C           .n2	inc	a
 308+ 8489 09           	add	hl,bc
 309+ 848A 38 FC        	jr	c, .n2
 310+ 848C ED 42        	sbc	hl,bc
 311+ 848E C5               push bc
 312+ 848F CD 25 82     	call Uart.write
 313+ 8492 C1               pop bc
 314+ 8493 C9               ret
 315+ 8494
 316+ 8494
 317+ 8494              ;команды
 318+ 8494 41 54 45 30  cmd_ATE0 db "ATE0",13,10,0 ;эхо?
 318+ 8498 0D 0A 00
 319+ 849B 41 54 2B 43  cmd_CIPSERVER db "AT+CIPSERVER=0",13,10,0 ;удалить сервер
 319+ 849F 49 50 53 45
 319+ 84A3 52 56 45 52
 319+ 84A7 3D 30 0D 0A
 319+ 84AB 00
 320+ 84AC 41 54 2B 43  cmd_CIPSTART db 'AT+CIPSTART="' ;продолжение
 320+ 84B0 49 50 53 54
 320+ 84B4 41 52 54 3D
 320+ 84B8 22
 321+ 84B9              	;тут тип
 322+ 84B9 54 43 50 22  cmd_CIPSTART2 db 'TCP","',0 ;продолжение
 322+ 84BD 2C 22 00
 323+ 84C0 41 54 2B 43  cmd_CIPSEND db "AT+CIPSEND=",0 ;отправить данные
 323+ 84C4 49 50 53 45
 323+ 84C8 4E 44 3D 00
 324+ 84CC              	;тут ID
 325+ 84CC 41 54 2B 43  cmd_CIPCLOSE db "AT+CIPCLOSE",0 ;закрыть соединение
 325+ 84D0 49 50 43 4C
 325+ 84D4 4F 53 45 00
 326+ 84D8              	;тут ID
 327+ 84D8 41 54 2B 43  cmd_CIPMUX db "AT+CIPMUX=0",13,10,0 ; Single connection mode
 327+ 84DC 49 50 4D 55
 327+ 84E0 58 3D 30 0D
 327+ 84E4 0A 00
 328+ 84E6 41 54 2B 43  cmd_CIPDINFO db "AT+CIPDINFO=0",13,10,0 ; Disable additional info
 328+ 84EA 49 50 44 49
 328+ 84EE 4E 46 4F 3D
 328+ 84F2 30 0D 0A 00
 329+ 84F6
 330+ 84F6                  ENDMODULE
# file closed: Drv/wifi.asm
 772  84F6              	include Drv/utils.asm ;работа с ESP
# file opened: Drv/utils.asm
   1+ 84F6              ;;; Macroses!!!!
   2+ 84F6                  ; MACRO EspSend Text
   3+ 84F6                  ; ld hl, .txtB
   4+ 84F6                  ; ld e, (.txtE - .txtB)
   5+ 84F6                  ; call espSend
   6+ 84F6                  ; jr .txtE
   7+ 84F6              ; .txtB
   8+ 84F6                  ; db Text
   9+ 84F6              ; .txtE
  10+ 84F6                  ; ENDM
  11+ 84F6
  12+ 84F6                  ; MACRO EspCmd Text
  13+ 84F6                  ; ld hl, .txtB
  14+ 84F6                  ; ld e, (.txtE - .txtB)
  15+ 84F6                  ; call espSend
  16+ 84F6                  ; jr .txtE
  17+ 84F6              ; .txtB
  18+ 84F6                  ; db Text
  19+ 84F6                  ; db 13, 10
  20+ 84F6              ; .txtE
  21+ 84F6                  ; ENDM
  22+ 84F6
  23+ 84F6                  ; MACRO EspCmdOkErr text
  24+ 84F6                  ; EspCmd text
  25+ 84F6                  ; call checkOkErr
  26+ 84F6                  ; ENDM
  27+ 84F6
  28+ 84F6              ; IN DE - string pointer
  29+ 84F6              ; OUT HL - string len
  30+ 84F6              strLen:
  31+ 84F6 21 00 00         ld hl, 0
  32+ 84F9              .loop
  33+ 84F9 1A               ld a, (de)
  33+ 84FA A7             and a
  33+ 84FB C8             ret z
  34+ 84FC 13 23            inc de, hl
  35+ 84FE 18 F9            jr .loop
# file closed: Drv/utils.asm
 773  8500
 774  8500              msg_esp_link
 775  8500 45 53 50 20  	db "ESP id: ",0
 775  8504 69 64 3A 20
 775  8508 00
 776  8509              msg_esp_transmit
 777  8509 54 72 6E 3A  	db "Trn: ",0
 777  850D 20 00
 778  850F              msg_esp_receive
 779  850F 52 63 76 3A  	db "Rcv: ",0
 779  8513 20 00
 780  8515              msg_esp_address
 781  8515 41 64 72 3A  	db "Adr: ",0
 781  8519 20 00
 782  851B
 783  851B              msg_ver_net
 784  851B 4E 45 54 20  	db "NET ver 2025.01.14",13,10,0
 784  851F 76 65 72 20
 784  8523 32 30 32 35
 784  8527 2E 30 31 2E
 784  852B 31 34 0D 0A
 784  852F 00
 785  8530
 786  8530              end_net
 787  8530              	savebin "net.apg",start_net,$-start_net
 788  8530
 789  8530              ;------------------------------------------------------------------------
 790  8530
 791  8530
 792  8530
 793  8530
 794  8530
 795  8530
 796  8530
 797  8530
 798  8530
 799  8530
 800  8530
 801  8530
 802  8530
 803  8530
 804  8530
 805  8530
 806  8530
 807  8530
 808  8530
 809  8530              ;ядро системы
 810  8530              	org #0000
 811  0000              	;bank 0
 812  0000              start_os_main
 813  0000
 814  0000 C3 01 C1     x0000	jp	InitProgramm + #c000	;RST #00	;+#C000 после запуска меняется
 815  0003 00 00 00...  	ds	#08-3
 816  0008
 817  0008 18 31        x0008	jr	x003B			;обработка RST #08
 818  000A 00           	nop
 819  000B 00           x000B	nop
 820  000C 00           	nop
 821  000D 18 75        x000D	jr	ExitMon
 822  000F 00           	ds	#01
 823  0010
 824  0010 C3 8B 0A     x0010	jp	drvgmx.putC  ;RST #10		;печать одного символа
 825  0013
 826  0013 ED 79        x0013	out	(c),a
 827  0015 00           	nop
 828  0016 00 00        	ds	#02
 829  0018
 830  0018 C3 49 06     x0018	jp os_wait ;передача управления ОС ;RST #18
 831  001B 00 00 00...  		ds #05 ;ds	#08
 832  0020
 833  0020 C3 1C 07     x0020	jp function  ;RST #20
 834  0023 00 00 00...  		ds	#05 ;#08
 835  0028
 836  0028 00 00 00...  x0028	ds	#08 ;RST #28
 837  0030
 838  0030 00 00 00     x0030	ds	#03 ;RST #30
 839  0033
 840  0033 ED 79        x0033	out	(c),a
 841  0035 00           	nop
 842  0036
 843  0036 00 24        x0036	dw	font
 844  0038
 845  0038              ;обработчик прерываний
 846  0038 C3 A0 07     x0038	jp	Interrupts ;#RST 38
 847  003B
 848  003B              ;обработка RST 8
 849  003B F5           x003B	push	af
 850  003C ED 5F        	ld	a,r
 851  003E EA 43 00     	jp	pe,x0043
 852  0041 ED 5F        	ld	a,r
 853  0043 F5           x0043	push	af
 854  0044 3E 10        	ld	a,#10			;вход из ram 0
 855  0046 F5           	push	af
 856  0047 33           	inc	sp
 857  0048 C5           	push	bc
 858  0049 E5           	push	hl
 859  004A 01 00 00     	ld	bc,#0000
 860  004D 3E 02        	ld	a,#02
 861  004F ED 79        	out	(c),a
 862  0051 01 FD 7E     	ld	bc,#7EFD
 863  0054 ED 60        	in	h,(c)			;h=in #7EFD
 864  0056 06 7A        	ld	b,#7A
 865  0058 ED 68        	in	l,(c)			;l=in #7AFD
 866  005A 06 1F        	ld	b,#1F
 867  005C 3E 12        	ld	a,#12
 868  005E 18 B3        	jr	x0013
 869  0060 00 00 00...  	ds	#06			;=#0060
 870  0066
 871  0066              ;обработка NMI
 872  0066              ;
 873  0066 F5           x0066   push  af
 874  0067 ED 5F           ld  a,r
 875  0069 F3              di
 876  006A F5              push  af
 877  006B 3E 20           ld  a,#20
 878  006D F5              push  af
 879  006E 33              inc  sp
 880  006F C5              push  bc
 881  0070 E5              push  hl
 882  0071 01 FD 7E        ld  bc,#7EFD
 883  0074 ED 60           in  h,(c)    ;h=in #7EFD
 884  0076 06 7A           ld  b,#7A
 885  0078 ED 68           in  l,(c)    ;l=in #7AFD
 886  007A 06 1F           ld  b,#1F    ;18 байт
 887  007C 3E 12           ld  a,#12
 888  007E C3 33 00        jp  x0033
 889  0081
 890  0081 00           	nop
 891  0082 00           	nop
 892  0083 00           	nop
 893  0084              x0084
 894  0084              ;возврат из монитора =#0084
 895  0084 ED 51        ExitMon	out	(c),d			;#1FFD
 896  0086 06 7F        	ld	b,#7F
 897  0088 ED 59        	out	(c),e			;#7FFD
 898  008A 01 00 00     	ld	bc,#0000
 899  008D ED 79        	out	(c),a
 900  008F D1           	pop	de
 901  0090 C1           	pop	bc
 902  0091 33           	inc	sp
 903  0092 F1           	pop	af
 904  0093 ED 4F        	ld	r,a
 905  0095 E2 9B 00     	jp	po,x009B
 906  0098 F1           	pop	af
 907  0099 FB           	ei
 908  009A C9           	ret
 909  009B F1           x009B	pop	af
 910  009C F3           	di
 911  009D C9           	ret
 912  009E
 913  009E              x009E
 914  009E              ; StartWord
 915  009E              	; ldir
 916  009E              	; call	onPageTXT
 917  009E              	; jp	MainLoopEdit
 918  009E              	; INSERT	"Info/!version.txt"
 919  009E              	; INSERT	"Info/!build.txt"
 920  009E              	; db	"GMX"
 921  009E 00 00 00...  y009E	ds	#00FF-$
 922  00FF
 923  00FF 38 00        x00FF	dw	x0038
 924  0101
 925  0101
 926  0101
 927  0101              ;Первый запуск
 928  0101              InitProgramm
 929  0101 F3           	di
 930  0102 31 00 41     	ld sp,#4100 ;временный адрес стека
 931  0105 3E 01        	ld a, #01 ;включить ОЗУ вместо ПЗУ
 932  0107 01 FD 1F         ld   bc,#1ffd
 933  010A ED 79        	out (c),a
 934  010C 21 15 01     	ld hl,Start_warm ;заменить адрес старта
 935  010F 22 01 00     	ld (#0001),hl
 936  0112 C3 00 00     	jp 0
 937  0115
 938  0115
 939  0115              ; rst #08: db #8F установка/удаление резидента из памяти
 940  0115              ; при "теплой" перезагрузке, если резидент установлен в странице, то эта страница
 941  0115                ; будет впечатана в 3е окно и управление передано по заданному адресу
 942  0115              ; вх:  a - номер страницы для установки резидента
 943  0115                      ; =#08 - удаление резидента
 944  0115                      ; 7,a =1 однократный вызов
 945  0115                   ; hl - адрес старта в странице
 946  0115              ; вых: cy=1 резидент не установлен
 947  0115              ; сначала копируем в эту страницу то что надо
 948  0115              ; и только потом вызываем функцию
 949  0115              ; для гмх страницу 8 и #78 задавать нельзя
 950  0115              ; перед повторной установкой резидента, вызывать функцию удаления не нужно
 951  0115
 952  0115              ;Старт системы
 953  0115              Start_warm
 954  0115              	;di
 955  0115 ED 56        	im 1
 956  0117
 957  0117              ;------------------------------------------------------------------------------
 958  0117              ;вызов функции #00(00) (SetRam0) установка работы со страницей ram 0 вместо rom, требуется для
 959  0117              ;корректного выхода из монитора, при ресете отключается
 960  0117              ;вх:  c=#00(00)
 961  0117              ;     cy=1 - установка
 962  0117              ;     cy=0 - отключение
 963  0117              ;вых: регистры не меняются
 964  0117              ;   R8CONF
 965  0117 0E 00        	ld	c,#00
 966  0119 37           	scf
 967  011A CF           	rst	#08
 968  011B 8E           	db	#8E
 969  011C              ;
 970  011C
 971  011C
 972  011C
 973  011C              	;подготовить системный процесс
 974  011C 3E 01        	ld a,proc_id_system ;код системного процесса
 975  011E 32 23 2C     	ld (proc_id_cur),a ;запомнить как текущий
 976  0121 32 07 2C     	ld (proc_id_focus),a ;сразу в фокусе
 977  0124              	;ld (proc_run_prepar_id_tmp),a ;для правильного выделения памяти
 978  0124 AF           	xor a
 979  0125 32 20 2C     	ld (proc_id_next),a ;для вычисления следующего процесса
 980  0128
 981  0128 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
 982  012A 32 1B 2C     	ld (con_scr_cur),a
 983  012D 3E 79        	ld a,con_atr_real ;атрибуты реальные
 984  012F 32 1C 2C     	ld (con_atr_cur),a
 985  0132 3E 39        	ld a,#39 ;видимый экран
 986  0134 32 06 2C     	ld (scr_cur),a
 987  0137 CD D6 09     	call drvgmx.init
 988  013A
 989  013A CD 4B 0D     	call Dos.init_fs_fat ;выбор раздела (буквы диска)
 990  013D
 991  013D 21 C0 35     	ld hl,proc_name_sys		;строка с именем
 992  0140 CD DE 02     	call proc_run ;запуск
 993  0143 DA 77 01     	jp c,loop_idle ;не вышло
 994  0146
 995  0146
 996  0146              	; ;запустить системный процесс
 997  0146              ; ;proc_run_sys
 998  0146              ; ;запуск sys не с диска, а из состава ОС
 999  0146              	; ld hl,proc_sys_name
1000  0146              	; call proc_run_prepar
1001  0146              	; ret c
1002  0146
1003  0146              	;включить страницы
1004  0146              	;;ld ix,(proc_run_prepar_deskr_tmp)
1005  0146 DD 7E 02     	ld a,(ix+2)
1006  0149 32 17 2C     	ld (page_slot2_cur),a ;сделать страницы текущими
1007  014C CD 5D 0C     	call drvgmx.PageSlot2
1008  014F DD 7E 03     	ld a,(ix+3)
1009  0152 32 18 2C     	ld (page_slot3_cur),a
1010  0155 CD 7C 0B     	call drvgmx.PageSlot3
1011  0158              	;цвета
1012  0158 3E 07        	ld a,proc_color_def ;цвет
1013  015A 32 9B 0C     	ld (drvgmx.attr_screen),a
1014  015D DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1015  0160              	;
1016  0160 3E 0C        	ld a,proc_color2_def ;цвет 2
1017  0162 32 9C 0C     	ld (drvgmx.attr_screen2),a
1018  0165 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1019  0168              	; ;перенести код
1020  0168              	; ld hl,start_sys_incl
1021  0168              	; ld de,PROGSTART
1022  0168              	; ld bc,end_sys_incl-start_sys_incl
1023  0168              	; ldir
1024  0168              	;подготовить правильный старт
1025  0168 DD 6E 06     	ld l,(ix+6) ;стек нового процесса
1026  016B DD 66 07     	ld h,(ix+7) ;стек
1027  016E F9           	ld sp,hl
1028  016F
1029  016F 3E 01        	ld a,proc_id_system
1030  0171 DD 77 00     	ld (ix),a
1031  0174 C3 00 80     	jp PROG_START ;старт сначала на заглушку
1032  0177
1033  0177
1034  0177
1035  0177
1036  0177
1037  0177              loop_idle ;заглушка
1038  0177 18 FE        	jr loop_idle ;
1039  0179
1040  0179
1041  0179
1042  0179
1043  0179
1044  0179              ; proc_run_cmd
1045  0179              ; ; запуск cmd не с диска, а из состава ОС
1046  0179              	; ld hl,proc_cmd_name
1047  0179              	; call proc_run_prepar
1048  0179              	; ret c
1049  0179              	; ;включить страницы
1050  0179              	; ;ld ix,(proc_run_prepar_deskr_tmp)
1051  0179              	; ld a,(ix+2)
1052  0179              	; call drvgmx.PageSlot2
1053  0179              	; ld a,(ix+3)
1054  0179              	; call drvgmx.PageSlot3
1055  0179              	; ;перенести код
1056  0179              	; ld hl,start_cmd_incl
1057  0179              	; ld de,PROGSTART
1058  0179              	; ld bc,end_cmd_incl-start_cmd_incl
1059  0179              	; ldir
1060  0179
1061  0179              	; jp file_load_ok ;продолжить стандартно
1062  0179
1063  0179
1064  0179
1065  0179
1066  0179
1067  0179              proc_run_prepar
1068  0179              ;подготовка к запуску процесса
1069  0179              ;выделение памяти и прочее
1070  0179              ;вх: hl - имя процесса (файла) 8+3 символов
1071  0179              ;вых: a - номер процесса, IX - дескриптор
1072  0179
1073  0179 22 F8 01     	ld (proc_run_prepar_name_tmp),hl ;сохранить имя
1074  017C              	;поиск свободного дескриптора
1075  017C 21 00 2D     	ld hl,proc_table
1076  017F 11 00 01     	ld de,proc_descr_size
1077  0182 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
1078  0184 0E 01        	ld c,proc_id_system ;первый номер
1079  0186              proc_run_prepar_cl
1080  0186 7E           	ld a,(hl)
1081  0187 B7           	or a ;свободен?
1082  0188 28 0C        	jr z,proc_run_prepar_ok
1083  018A 19           	add hl,de
1084  018B 0C           	inc c
1085  018C 10 F8        	djnz proc_run_prepar_cl
1086  018E              	;не нашли свободного
1087  018E 21 EE 35     	ld hl,msg_proc_max
1088  0191 CD 80 0A     	call drvgmx.printZ ;сообщение
1089  0194 37           	scf
1090  0195 C9           	ret
1091  0196              proc_run_prepar_ok
1092  0196              	;есть свободный
1093  0196 E5           	push hl
1094  0197 DD E1        	pop ix ;дискриптор процесса
1095  0199 22 FC 01     	ld (proc_run_prepar_deskr_tmp),hl
1096  019C 79           	ld a,c ;присвоить номер
1097  019D 32 FA 01     	ld (proc_run_prepar_id_tmp),a
1098  01A0
1099  01A0
1100  01A0 3A 23 2C     	ld a,(proc_id_cur)
1101  01A3 DD 77 01     	ld (ix+1),a ;код родительского
1102  01A6
1103  01A6              	;скопировать имя
1104  01A6 11 10 00     	ld de,16 ;
1105  01A9 19           	add hl,de
1106  01AA EB           	ex de,hl
1107  01AB 2A F8 01     	ld hl,(proc_run_prepar_name_tmp)
1108  01AE 01 0C 00     	ld bc,8+3+1
1109  01B1 ED B0        	ldir
1110  01B3
1111  01B3
1112  01B3              	;выделение памяти стандартное количество окон
1113  01B3 CD 04 02     	call proc_find_ram
1114  01B6 38 1D        	jr c,proc_run_prepar_no_mem
1115  01B8 DD 77 02     	ld (ix+2),a ;страница 8000
1116  01BB CD 04 02     	call proc_find_ram
1117  01BE 38 15        	jr c,proc_run_prepar_no_mem
1118  01C0 DD 77 03     	ld (ix+3),a ;страница c000
1119  01C3 CD 04 02     	call proc_find_ram
1120  01C6 38 0D        	jr c,proc_run_prepar_no_mem
1121  01C8 DD 77 04     	ld (ix+4),a ;страница пиксели
1122  01CB CD 04 02     	call proc_find_ram
1123  01CE 38 05        	jr c,proc_run_prepar_no_mem
1124  01D0 DD 77 05     	ld (ix+5),a ;страница атрибуты
1125  01D3
1126  01D3 18 0E        	jr proc_run_prepar_mem_ok
1127  01D5
1128  01D5              proc_run_prepar_no_mem
1129  01D5 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1130  01D8 CD 1D 02     	call proc_clear_ram ;освободить память обратно
1131  01DB
1132  01DB 21 05 36     	ld hl,msg_mem_max
1133  01DE CD 80 0A     	call drvgmx.printZ ;сообщение
1134  01E1 37           	scf
1135  01E2 C9           	ret
1136  01E3
1137  01E3              proc_run_prepar_mem_ok ;памяти хватило
1138  01E3
1139  01E3              	;определить адрес стека
1140  01E3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1141  01E6 21 00 2C     	ld hl,proc_table-256
1142  01E9 84           	add h
1143  01EA 67           	ld h,a
1144  01EB 2E 80        	ld l,#80 ;на стек меньше 128 байт
1145  01ED              	; ld hl,proc_stack
1146  01ED              	; or a
1147  01ED              	; jr z,proc_run_prepar_ex
1148  01ED              	; ld b,a
1149  01ED              	; ld de,proc_stack_size
1150  01ED              ; proc_run_prepar_cl2 ;цикл
1151  01ED              	; add hl,de
1152  01ED              	; djnz proc_run_prepar_cl2
1153  01ED              ;proc_run_prepar_ex
1154  01ED DD 75 06     	ld (ix+6),l ;адрес стека
1155  01F0 DD 74 07     	ld (ix+7),h ;адрес стека
1156  01F3              	; ld a,(proc_run_prepar_id_tmp) ;id
1157  01F3              	; ld (ix+0),a
1158  01F3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1159  01F6 B7           	or a
1160  01F7 C9           	ret
1161  01F8
1162  01F8 00 00        proc_run_prepar_name_tmp dw 0 ;временно имя нового процесса
1163  01FA 00           proc_run_prepar_id_tmp db 0 ;временно id нового процесса
1164  01FB 00           proc_run_file_id_tmp db 0 ;временно id файла
1165  01FC 00 00        proc_run_prepar_deskr_tmp dw 0 ;временно дескриптор процесса
1166  01FE
1167  01FE
1168  01FE
1169  01FE
1170  01FE              proc_get_ram ;для вызова из процесса
1171  01FE 3A 23 2C     	ld a,(proc_id_cur)
1172  0201 32 FA 01     	ld (proc_run_prepar_id_tmp),a
1173  0204
1174  0204              proc_find_ram	;поиск свободной страницы памяти
1175  0204              ;вых: a - номер страницы, также записан id процесса в таблицу proc_page_table
1176  0204 11 DD 0B     	ld de,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
1177  0207 21 00 35     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
1178  020A 06 6D        	ld b,page_max
1179  020C              proc_find_ram_cl
1180  020C AF           	xor a
1181  020D B6           	or (hl)
1182  020E 28 06        	jr z,proc_find_ram_ok1 ;нашли
1183  0210              	;ищем дальше
1184  0210 23           	inc hl
1185  0211 13           	inc de
1186  0212 10 F8        	djnz proc_find_ram_cl
1187  0214              	;совсем не нашли
1188  0214 37           	scf
1189  0215 C9           	ret
1190  0216              proc_find_ram_ok1
1191  0216 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1192  0219 77           	ld (hl),a ;записать id процесса в таблицу
1193  021A 1A           	ld a,(de) ;вернуть номер страницы
1194  021B B7           	or a
1195  021C C9           	ret
1196  021D
1197  021D
1198  021D
1199  021D
1200  021D
1201  021D              proc_clear_ram ;освбождение всех страниц памяти процесса
1202  021D              ;вх: a - номер процесса
1203  021D 21 00 35     	ld hl,proc_page_table
1204  0220 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
1205  0222              proc_clear_ram_cl ;
1206  0222 BE           	cp (hl) ;совпадает с номером процесса?
1207  0223 20 02        	jr nz,proc_clear1
1208  0225 36 00        	ld (hl),0 ;освободить
1209  0227              proc_clear1
1210  0227 23           	inc hl
1211  0228 10 F8        	djnz proc_clear_ram_cl
1212  022A B7           	or a
1213  022B C9           	ret
1214  022C
1215  022C
1216  022C
1217  022C              proc_focus_next
1218  022C              	;переключение фокуса на следующий процесс
1219  022C 3E 01        	ld a,1
1220  022E 32 0D 2C     	ld (proc_next_find_skip_flag),a ;флаг пропустить лишние проверки
1221  0231 3A 07 2C     	ld a,(proc_id_focus)
1222  0234 CD 84 09     	call proc_next_find_skip ;узнать кто следующий
1223  0237 08           	ex af,af'
1224  0238 AF           	xor a
1225  0239 32 0D 2C     	ld (proc_next_find_skip_flag),a ;флаг убрать
1226  023C 08           	ex af,af'
1227  023D              	;ret c ;выернуться если один процесс
1228  023D              	;или сменить фокус, код ниже
1229  023D
1230  023D
1231  023D
1232  023D              ;передать фокус процессу
1233  023D              ;вх: a - id процесса
1234  023D              proc_set_focus
1235  023D 21 07 2C     	ld hl,proc_id_focus
1236  0240 BE           	cp (hl)
1237  0241 C8           	ret z ;если уже в фокусе, ничего не делаем
1238  0242 32 D0 02     	ld (proc_set_focus_id_tmp),a ;сохранить
1239  0245
1240  0245 21 00 2C     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1241  0248 84           	add h
1242  0249 67           	ld h,a
1243  024A AF           	xor a
1244  024B B6           	or (hl)
1245  024C C8           	ret z
1246  024D
1247  024D
1248  024D              	;сохранить в буфер процесса текущий экран
1249  024D 3A 07 2C     	ld a,(proc_id_focus) ;текущий в фокусе
1250  0250 21 00 2C     	ld hl,proc_table - 256
1251  0253 84           	add h
1252  0254 67           	ld h,a
1253  0255 E5           	push hl
1254  0256 DD E1        	pop ix ;дескриптор процесса предыдущего
1255  0258
1256  0258 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1257  025B CD 7C 0B     	call drvgmx.PageSlot3
1258  025E 3E 39        	ld a,con_scr_real ;настоящий экран
1259  0260 CD 5D 0C     	call drvgmx.PageSlot2
1260  0263 21 00 80     	ld hl,#8000 ;скопировать
1261  0266 11 00 C0     	ld de,#c000
1262  0269 01 00 40     	ld bc,#4000
1263  026C ED B0        	ldir
1264  026E
1265  026E DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1266  0271 CD 7C 0B     	call drvgmx.PageSlot3
1267  0274 3E 79        	ld a,con_atr_real
1268  0276 CD 5D 0C     	call drvgmx.PageSlot2
1269  0279 21 00 80     	ld hl,#8000 ;скопировать
1270  027C 11 00 C0     	ld de,#c000
1271  027F 01 00 40     	ld bc,#4000
1272  0282 ED B0        	ldir
1273  0284
1274  0284              	;сохранить позицию скрола
1275  0284              	;ld hl,(drvgmx.curscrl)
1276  0284              	;ld (ix+#08),hl ;позиция скрола
1277  0284
1278  0284
1279  0284              	;вернуть из буфера экран нужного процесса
1280  0284 3A D0 02     	ld a,(proc_set_focus_id_tmp)
1281  0287 21 00 2C     	ld hl,proc_table - 256
1282  028A 84           	add h
1283  028B 67           	ld h,a
1284  028C E5           	push hl
1285  028D DD E1        	pop ix ;дескриптор процесса который будет в фокусе
1286  028F
1287  028F DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1288  0292 CD 7C 0B     	call drvgmx.PageSlot3
1289  0295 3E 39        	ld a,con_scr_real ;настоящий экран
1290  0297 CD 5D 0C     	call drvgmx.PageSlot2
1291  029A 21 00 C0     	ld hl,#c000 ;скопировать
1292  029D 11 00 80     	ld de,#8000
1293  02A0 01 00 40     	ld bc,#4000
1294  02A3 ED B0        	ldir
1295  02A5
1296  02A5 DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1297  02A8 CD 7C 0B     	call drvgmx.PageSlot3
1298  02AB 3E 79        	ld a,con_atr_real
1299  02AD CD 5D 0C     	call drvgmx.PageSlot2
1300  02B0 21 00 C0     	ld hl,#c000 ;скопировать
1301  02B3 11 00 80     	ld de,#8000
1302  02B6 01 00 40     	ld bc,#4000
1303  02B9 ED B0        	ldir
1304  02BB
1305  02BB CD D1 02     	call page_cur_return
1306  02BE
1307  02BE
1308  02BE 3A D0 02     	ld a,(proc_set_focus_id_tmp)
1309  02C1              	;запомнить активный процесс
1310  02C1 32 07 2C     	ld (proc_id_focus),a
1311  02C4
1312  02C4              	;ld hl,(ix+#08) ;позиция скрола
1313  02C4              	;ld (drvgmx.curscrl),hl
1314  02C4              	;call drvgmx.gmxscroll ;обновить скролл
1315  02C4 DD 7E 1D     	ld a, (ix + #1d) ;активный экран
1316  02C7 B7           	or a
1317  02C8 28 03        	jr z,proc_set_focus_scr
1318  02CA CD A7 04     	call set_scr_no_txt ;включить
1319  02CD              proc_set_focus_scr
1320  02CD C3 A0 07     	jp Interrupts ;сразу на другой процесс
1321  02D0              	;or a
1322  02D0              	;ret
1323  02D0 00           proc_set_focus_id_tmp db 0 ; временно
1324  02D1
1325  02D1
1326  02D1
1327  02D1              page_cur_return
1328  02D1              ;вернуть текущие страницы
1329  02D1 3A 17 2C     	ld a,(page_slot2_cur)
1330  02D4 CD 5D 0C     	call drvgmx.PageSlot2
1331  02D7 3A 18 2C     	ld a,(page_slot3_cur)
1332  02DA CD 7C 0B     	call drvgmx.PageSlot3
1333  02DD C9           	ret
1334  02DE
1335  02DE
1336  02DE              ;запустить процесс
1337  02DE              ;вх: hl - имя файла (заканчивается на 0)
1338  02DE              proc_run
1339  02DE CD 79 01     	call proc_run_prepar ;выделить память
1340  02E1 D8           	ret c
1341  02E2
1342  02E2 2A F8 01     	ld hl,(proc_run_prepar_name_tmp) ;имя
1343  02E5              	;ld b,Dos.FMODE_READ
1344  02E5 CD F0 0C     	call Dos.fopen_r ;откроем файл для чтения
1345  02E8 DC 45 0E     	call c,Dos.file_error_print_file_open_error
1346  02EB DA D3 03     	jp c,file_load_err
1347  02EE 32 FB 01     	ld (proc_run_file_id_tmp),a ;запомнить id
1348  02F1
1349  02F1              	;проверка длины файла не больше #8000
1350  02F1 7A           	ld	a,d ;самые старшие байты длины
1351  02F2 B3           	or e
1352  02F3 28 09        	jr z,file_size_ok ;если не слищком большой
1353  02F5              file_too_big
1354  02F5 21 56 10     	ld hl,Dos.msg_file_too_big
1355  02F8 CD 80 0A     	call drvgmx.printZ
1356  02FB C3 D3 03     	jp file_load_err
1357  02FE
1358  02FE
1359  02FE              file_size_ok
1360  02FE 7C           	ld	a,h ;младший старший байт длины
1361  02FF FE 81        	cp proc_size_max+1
1362  0301 30 F2        	jr nc,file_too_big
1363  0303              	;размер нормальный, прочитаем
1364  0303
1365  0303
1366  0303
1367  0303              	;включить страницы
1368  0303 DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp)
1369  0307 DD 7E 02     	ld a,(ix+2)
1370  030A CD 5D 0C     	call drvgmx.PageSlot2
1371  030D DD 7E 03     	ld a,(ix+3)
1372  0310 CD 7C 0B     	call drvgmx.PageSlot3
1373  0313 54           	ld d,h ;размер
1374  0314 5D           	ld e,l
1375  0315 21 00 80     	ld hl,PROG_START
1376  0318 3A FB 01     	ld a,(proc_run_file_id_tmp)
1377  031B CD 8F 0E     	call Dos.fread
1378  031E 30 0E        	jr nc,file_size_ok2
1379  0320              	;если ошибка вернуть страницы
1380  0320 CD 4D 0E     	call Dos.file_error_print_file_read_error
1381  0323 CD D1 02     	call page_cur_return
1382  0326 3A FB 01     	ld a,(proc_run_file_id_tmp)
1383  0329 CD 55 0E     	call Dos.fclose ;закрыть файл
1384  032C 37           	scf
1385  032D C9           	ret
1386  032E              file_size_ok2
1387  032E 3A FB 01     	ld a,(proc_run_file_id_tmp)
1388  0331 CD 55 0E     	call Dos.fclose ;закрыть файл
1389  0334              	;jr file_load_ok
1390  0334
1391  0334              	;скопировать дескриптор системной папки, будет у приложения такая же папка по умолчанию
1392  0334 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;номер будущего процесса
1393  0337 CD 06 0F     	call Dos.calc_dir_deskr
1394  033A EB           	ex de,hl
1395  033B 21 C6 10     	ld hl,Dos.dir_fat_deskr
1396  033E 01 20 00     	ld bc,Dos.fcb_fat_size
1397  0341 ED B0        	ldir
1398  0343
1399  0343              file_load_ok ;загрузился нормально
1400  0343 DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp) ;вспомнить дескриптор
1401  0347              	;очистить экран
1402  0347              	;сначала запомнить как было
1403  0347 2A 9B 0C     	ld hl,(drvgmx.attr_screen)
1404  034A 22 D5 03     	ld (proc_run_attr_screen_tmp),hl
1405  034D              	; запомнить координаты экрана предыдущего
1406  034D 2A 99 0C     	ld hl,(drvgmx.col_screen)
1407  0350 22 D9 03     	ld (proc_run_col_screen_tmp),hl ;координаты
1408  0353              	;страницы буфера
1409  0353 3A 1B 2C     	ld a,(con_scr_cur)
1410  0356 32 D7 03     	ld (proc_run_con_scr_cur_tmp),a
1411  0359 3A 1C 2C     	ld a,(con_atr_cur)
1412  035C 32 D8 03     	ld (proc_run_con_atr_cur_tmp),a
1413  035F              	;скрола
1414  035F 2A 6D 0B     	ld hl,(drvgmx.curscrl)
1415  0362 22 DB 03     	ld (proc_run_curscrl_tmp),hl
1416  0365
1417  0365
1418  0365
1419  0365              	;чистить буфер экрана
1420  0365 3E 07        	ld a,proc_color_def ;цвет
1421  0367 32 9B 0C     	ld (drvgmx.attr_screen),a
1422  036A DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1423  036D              	;
1424  036D 3E 0C        	ld a,proc_color2_def ;цвет 2
1425  036F 32 9C 0C     	ld (drvgmx.attr_screen2),a
1426  0372 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1427  0375              	;
1428  0375 DD 7E 04     	ld a,(ix+4)
1429  0378 32 1B 2C     	ld (con_scr_cur),a
1430  037B DD 7E 05     	ld a,(ix+5)
1431  037E 32 1C 2C     	ld (con_atr_cur),a
1432  0381 CD D9 09     	call drvgmx.cls
1433  0384 21 00 00     	ld hl,0
1434  0387 DD 75 08 DD  	ld (ix+#08),hl ;позиция скрола
1434  038B 74 09
1435  038D DD 75 0A DD  	ld (ix+#0a),hl ;позиция курсора
1435  0391 74 0B
1436  0393              	;вернуть
1437  0393 2A D5 03     	ld hl,(proc_run_attr_screen_tmp)
1438  0396 22 9B 0C     	ld (drvgmx.attr_screen),hl
1439  0399 2A D9 03     	ld hl,(proc_run_col_screen_tmp) ;координаты
1440  039C 22 99 0C     	ld (drvgmx.col_screen),hl
1441  039F 3A D7 03     	ld a,(proc_run_con_scr_cur_tmp)
1442  03A2 32 1B 2C     	ld (con_scr_cur),a
1443  03A5 3A D8 03     	ld a,(proc_run_con_atr_cur_tmp)
1444  03A8 32 1C 2C     	ld (con_atr_cur),a
1445  03AB 2A DB 03     	ld hl,(proc_run_curscrl_tmp)
1446  03AE 22 6D 0B     	ld (drvgmx.curscrl),hl
1447  03B1
1448  03B1
1449  03B1
1450  03B1
1451  03B1              	;подготовить правильный старт
1452  03B1 DD 6E 06     	ld l,(ix+6) ;адрес стека
1453  03B4 DD 66 07     	ld h,(ix+7) ;адрес стека
1454  03B7 01 00 80     	ld bc,PROG_START ;возврат сюда
1455  03BA 2B           	dec hl
1456  03BB 70           	ld (hl),b
1457  03BC 2B           	dec hl
1458  03BD 71           	ld (hl),c
1459  03BE 01 EC FF     	ld bc,-20 ;возврат будет с восстановлением регистров
1460  03C1 09           	add hl,bc
1461  03C2
1462  03C2 DD 75 06     	ld (ix+6),l ;адрес стека
1463  03C5 DD 74 07     	ld (ix+7),h ;адрес стека
1464  03C8 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1465  03CB DD 77 00     	ld (ix),a ;в последнюю очередь код (флаг что процесс работает)
1466  03CE
1467  03CE CD D1 02     	call page_cur_return
1468  03D1 B7           	or a
1469  03D2 C9           	ret
1470  03D3
1471  03D3
1472  03D3              file_load_err
1473  03D3 37           	scf
1474  03D4 C9           	ret
1475  03D5
1476  03D5 00 00        proc_run_attr_screen_tmp dw 0 ;временно
1477  03D7 00           proc_run_con_scr_cur_tmp db 0 ;временно
1478  03D8 00           proc_run_con_atr_cur_tmp db 0 ;временно
1479  03D9 00 00        proc_run_col_screen_tmp dw 0 ;временно
1480  03DB 00 00        proc_run_curscrl_tmp dw 0 ;временно
1481  03DD
1482  03DD
1483  03DD
1484  03DD
1485  03DD
1486  03DD
1487  03DD
1488  03DD
1489  03DD              get_c ;функция получение кода нажатой клавиши
1490  03DD              	;вых: a - код последней клавиши, 255 - ничего не нажато
1491  03DD 3A 23 2C     	ld a,(proc_id_cur) ;сравнить если процесс в фокусе
1492  03E0 21 07 2C     	ld hl,proc_id_focus
1493  03E3 BE           	cp (hl)
1494  03E4 3E FF        	ld a,255 ;ничего не нажато если не в фокусе
1495  03E6 C0           	ret nz
1496  03E7 3A 1D 2C     	ld a,(key_cur) ;или вернуть клавишу
1497  03EA F5           	push af
1498  03EB 3E FF        	ld a,255
1499  03ED 32 1D 2C     	ld (key_cur),a ;очистить буфер
1500  03F0 F1           	pop af
1501  03F1 C9           	ret
1502  03F2
1503  03F2              get_timer ;функция получить значение системного таймера
1504  03F2 ED 5B 25 2C  	ld de,(sys_timer) ;младшие байты
1505  03F6 2A 27 2C     	ld hl,(sys_timer+2)
1506  03F9 C9           	ret
1507  03FA
1508  03FA
1509  03FA
1510  03FA              page_copy ;скопировать страницу в страницу
1511  03FA              ;скопировать данные из страницы в страницу
1512  03FA              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
1513  03FA ED 43 30 04  	ld (page_copy_tmp),bc
1514  03FE 32 30 04     	ld (page_copy_tmp),a
1515  0401 D9           	exx
1516  0402 CD 32 04     	call page_check_owner 	;проверка разрешений
1517  0405 D8           	ret c
1518  0406 3A 31 04     	ld a,(page_copy_tmp+1)
1519  0409 CD 32 04     	call page_check_owner 	;проверка разрешений
1520  040C D8           	ret c
1521  040D DD 7C        	ld a,ixh ;не больше размера страницы
1522  040F FE 41        	cp #41
1523  0411 30 1B        	jr nc,page_copy_err
1524  0413 DD B5        	or ixl
1525  0415 28 17        	jr z,page_copy_err ;и не 0 длина
1526  0417 3A 30 04     	ld a,(page_copy_tmp)
1527  041A CD 5D 0C     	call drvgmx.PageSlot2
1528  041D 3A 31 04     	ld a,(page_copy_tmp+1)
1529  0420 CD 7C 0B     	call drvgmx.PageSlot3
1530  0423 D9           	exx ;вспомнить регистры
1531  0424              	 ;скопировать
1532  0424 DD E5        	push ix
1533  0426 C1           	pop bc ;длина
1534  0427 ED B0        	ldir
1535  0429 CD D1 02     	call page_cur_return ;вернуть страницы
1536  042C AF           	xor a
1537  042D C9           	ret
1538  042E              page_copy_err
1539  042E 37           	scf
1540  042F C9           	ret
1541  0430
1542  0430
1543  0430 00 00        page_copy_tmp dw 0 ;временно
1544  0432
1545  0432              page_check_owner ;проверить разрешена ли страница для процесса
1546  0432 FE 05        	cp #05 ;видео страница
1547  0434 C8           	ret z
1548  0435 FE 07        	cp #07 ;видео страница
1549  0437 C8           	ret z
1550  0438 FE 39        	cp #39 ;видео страница
1551  043A C8           	ret z
1552  043B FE 3A        	cp #3a ;видео страница
1553  043D C8           	ret z
1554  043E FE 79        	cp #79 ;видео страница
1555  0440 C8           	ret z
1556  0441 FE 7A        	cp #7a ;видео страница
1557  0443 C8           	ret z
1558  0444 32 68 04     	ld (page_check_owner_tmp),a
1559  0447 21 DD 0B     	ld hl,drvgmx.page_table ;таблица памяти
1560  044A 06 6D        	ld b,page_max ;всего страниц
1561  044C 0E 00        	ld c,0 ;индекс
1562  044E              page_check_owner_cl ;найти такую страницу
1563  044E BE           	cp (hl)
1564  044F 28 06        	jr z,page_check_owner_ex
1565  0451 0C           	inc c
1566  0452 23           	inc hl
1567  0453 10 F9        	djnz page_check_owner_cl
1568  0455 37           	scf ;не нашли в списке страниц
1569  0456 C9           	ret
1570  0457              page_check_owner_ex
1571  0457              	;нашли
1572  0457 06 00        	ld b,0
1573  0459 21 00 35     	ld hl,proc_page_table ;сверить с кодом текущего процесса
1574  045C 09           	add hl,bc
1575  045D 3A 23 2C     	ld a,(proc_id_cur)
1576  0460 BE           	cp (hl)
1577  0461 37           	scf ;не совпадает владелец с процессом
1578  0462 3A 68 04     	ld a,(page_check_owner_tmp)
1579  0465 C0           	ret nz
1580  0466 B7           	or a
1581  0467 C9           	ret
1582  0468 00           page_check_owner_tmp db 0 ;временно
1583  0469
1584  0469
1585  0469              set_VTPL_PLAY ;запустить плеер AY. будет играть на прерываниях
1586  0469 3A 17 2C     	ld a,(page_slot2_cur)
1587  046C 32 04 2C     	ld (proc_play_ay_slot2),a ;запомнить страницы с музыкой
1588  046F 3A 18 2C     	ld a,(page_slot3_cur)
1589  0472 32 05 2C     	ld (proc_play_ay_slot3),a
1590  0475 3A 23 2C     	ld a,(proc_id_cur) ;код процесса, который играет музыку
1591  0478 32 03 2C     	ld (proc_play_ay),a
1592  047B C9           	ret
1593  047C
1594  047C              set_VTPL_MUTE ;остановить плеер AY
1595  047C AF           	xor a
1596  047D 32 03 2C     	ld (proc_play_ay),a
1597  0480 C3 51 17     	jp VTPL.MUTE
1598  0483
1599  0483
1600  0483              get_VTPL_SETUP ;получить адрес переменной плеера
1601  0483 21 2C 17     	ld hl,VTPL.SETUP
1602  0486 C9           	ret
1603  0487
1604  0487
1605  0487              get_proc_page ;получить номера страниц процесса
1606  0487              	;вых: BC - страницы в слоте 2, 3
1607  0487 3A 17 2C     	ld a,(page_slot2_cur)
1608  048A 47           	ld b,a
1609  048B 3A 18 2C     	ld a,(page_slot3_cur)
1610  048E 4F           	ld c,a
1611  048F C9           	ret
1612  0490
1613  0490
1614  0490              set_scr ;установить активный экран
1615  0490              	;проверки
1616  0490 08           	ex af,af'
1617  0491 3A 23 2C     	ld a,(proc_id_cur)
1618  0494 21 07 2C     	ld hl,proc_id_focus
1619  0497 BE           	cp (hl)
1620  0498 20 21        	jr nz,set_scr_err
1621  049A CD D3 06     	call get_proc_descr
1622  049D 08           	ex af,af'
1623  049E DD 77 1C     	ld (ix+#1c),a ;запомнить
1624  04A1 B7           	or a
1625  04A2 20 03        	jr nz,set_scr_no_txt
1626  04A4              	;включить текстовый
1627  04A4 C3 C1 0B     	jp drvgmx.set_scr39	;основной экран
1628  04A7              set_scr_no_txt
1629  04A7 FE 05        	cp #05
1630  04A9 CA A5 0B     	jp z,drvgmx.set_scr5
1631  04AC FE 07        	cp #07
1632  04AE CA B3 0B     	jp z,drvgmx.set_scr7
1633  04B1 FE 39        	cp #39
1634  04B3 CA C1 0B     	jp z,drvgmx.set_scr39
1635  04B6 FE 3A        	cp #3a
1636  04B8 CA CF 0B     	jp z,drvgmx.set_scr3a
1637  04BB              set_scr_err
1638  04BB 37           	scf
1639  04BC C9           	ret
1640  04BD
1641  04BD              set_page_slot2	;включить страницу в слот 2 (#8000);
1642  04BD CD 32 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1643  04C0 D8           	ret c
1644  04C1 08           	ex af,af'
1645  04C2 3A 23 2C     	ld a,(proc_id_cur)
1646  04C5 CD D3 06     	call get_proc_descr
1647  04C8 08           	ex af,af'
1648  04C9 DD 77 02     	ld (ix+#02),a ;запомнить текущую страницу процесса
1649  04CC 32 17 2C     	ld (page_slot2_cur),a
1650  04CF C3 5D 0C     	jp drvgmx.PageSlot2 ;включить
1651  04D2
1652  04D2
1653  04D2              set_page_slot3	;включить страницу в слот 3 (#c000);
1654  04D2 CD 32 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1655  04D5 D8           	ret c
1656  04D6 08           	ex af,af'
1657  04D7 3A 23 2C     	ld a,(proc_id_cur)
1658  04DA CD D3 06     	call get_proc_descr
1659  04DD 08           	ex af,af'
1660  04DE DD 77 03     	ld (ix+#03),a ;запомнить текущую страницу процесса
1661  04E1 32 18 2C     	ld (page_slot3_cur),a
1662  04E4 C3 7C 0B     	jp drvgmx.PageSlot3
1663  04E7
1664  04E7
1665  04E7
1666  04E7              set_interrupt ;установка адреса обработчика прерываний процесса;
1667  04E7 EB           	ex de,hl
1668  04E8 3A 23 2C     	ld a,(proc_id_cur)
1669  04EB CD D3 06     	call get_proc_descr ;узнать адрес дескриптора
1670  04EE EB           	ex de,hl
1671  04EF DD 75 0E     	ld (ix+#0e),l ;адрес
1672  04F2 DD 74 0F     	ld (ix+#0f),h ;адрес
1673  04F5 C9           	ret
1674  04F6
1675  04F6
1676  04F6
1677  04F6
1678  04F6              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; hl - строка адрес, de - строка порт
1679  04F6              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1680  04F6              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто);
1681  04F6              esp_open ;установить соединение ESP (CIPSTART);
1682  04F6 08           	ex af,af'
1683  04F7 CD 7B 05     	call esp_check_err
1684  04FA D8           	ret c
1685  04FB 08           	ex af,af'
1686  04FC FE 03        	cp 3
1687  04FE 28 21        	jr z,esp_open_direct ;для терминала
1688  0500 DD 77 0E     	ld (ix+14),a ;тип
1689  0503 D5           	push de ;сохранить порт
1690  0504 11 8F 35     	ld de,esp_link_id_table+15 ;на имя сервера
1691  0507 CD E2 05     	call copyZ ;скопировать
1692  050A 11 BB 35     	ld de,esp_link_id_table+59 ;тут адрес порта
1693  050D E1           	pop hl
1694  050E CD E2 05     	call copyZ
1695  0511 3A 23 2C     	ld a,(proc_id_cur)
1696  0514 DD 77 00     	ld (ix),a ;флаг занято
1697  0517 DD 36 02 00  	ld (ix+2),0 ;флаг результат открытия
1698  051B DD 36 01 01  	ld (ix+1),1 ;флаг запрос на открытие
1699  051F AF           	xor a
1700  0520 C9           	ret
1701  0521
1702  0521              esp_open_direct ;прямая связь с портом
1703  0521 3A 23 2C     	ld a,(proc_id_cur)
1704  0524 DD 77 00     	ld (ix),a ;флаг занято
1705  0527 AF           	xor a
1706  0528 C9           	ret
1707  0529
1708  0529              esp_open_err
1709  0529 3E FF        	ld a,255
1710  052B 37           	scf
1711  052C C9           	ret
1712  052D
1713  052D
1714  052D
1715  052D              ;вх:
1716  052D              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1717  052D              esp_close ;закрыть соединение ESP
1718  052D CD 7B 05     	call esp_check_err
1719  0530 D8           	ret c
1720  0531 AF           	xor a
1721  0532 DD 77 00     	ld (ix),a ;закрыть
1722  0535 C9           	ret
1723  0536
1724  0536
1725  0536
1726  0536
1727  0536              ;вх: hl - адрес данных, de - длина данных
1728  0536              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1729  0536              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено)
1730  0536              esp_send ;послать запрос ESP (CIPSEND);
1731  0536 CD 7B 05     	call esp_check_err
1732  0539 D8           	ret c
1733  053A D5           	push de ; длина
1734  053B C1           	pop bc
1735  053C DD 73 09     	ld (ix+9),e  ;длина
1736  053F DD 72 0A     	ld (ix+10),d
1737  0542 11 2D 36     	ld de,esp_buffer ;перенести данные в буфер отправки
1738  0545 ED B0        	ldir
1739  0547
1740  0547 DD 36 04 00  	ld (ix+4),0 ;флаг результат отправки
1741  054B DD 36 03 01  	ld (ix+3),1 ;флаг запрос отправки
1742  054F AF           	xor a
1743  0550 DD 77 06     	ld (ix+6),a ;флаг результат приёма
1744  0553 DD 77 05     	ld (ix+5),a ;флаг запрос на приём
1745  0556 C9           	ret
1746  0557
1747  0557              esp_send_err
1748  0557 3E FF        	ld a,255
1749  0559 37           	scf
1750  055A C9           	ret
1751  055B
1752  055B
1753  055B
1754  055B
1755  055B              ;вх: hl - адрес для данных
1756  055B              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1757  055B              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято)
1758  055B              esp_get ;получить пакет ESP (+IPD);
1759  055B CD 7B 05     	call esp_check_err
1760  055E D8           	ret c
1761  055F DD 75 07     	ld (ix+7),l ;адрес данных
1762  0562 DD 74 08     	ld (ix+8),h ;адрес данных
1763  0565 DD 36 06 00  	ld (ix+6),0 ;флаг результат приёма
1764  0569 DD 36 05 01  	ld (ix+5),1 ;флаг запрос на приём
1765  056D AF           	xor a
1766  056E DD 77 04     	ld (ix+4),a ;флаг результат отправки
1767  0571 DD 77 03     	ld (ix+3),a ;флаг запрос отправки
1768  0574 DD 77 09     	ld (ix+9),a  ;длина
1769  0577 DD 77 0A     	ld (ix+10),a
1770  057A C9           	ret
1771  057B
1772  057B              ;проверка есть ли порт и кто владелец в данный момент
1773  057B              esp_check_err
1774  057B DD 21 80 35  	ld ix,esp_link_id_table
1775  057F 3A 02 2C     	ld a,(uart_enable)
1776  0582 B7           	or a
1777  0583 28 0F        	jr z,esp_check_err1 ;нет порта
1778  0585 DD 7E 00     	ld a,(ix)
1779  0588 B7           	or a
1780  0589 C8           	ret z ;выход без ошибки, если никем не занят
1781  058A 3A 23 2C     	ld a,(proc_id_cur) ;проверить кто владелец соединения
1782  058D DD BE 00     	cp (ix)
1783  0590 20 02        	jr nz,esp_check_err1 ;выйти с ошибкой, если буфер занят другим
1784  0592 AF           	xor a
1785  0593 C9           	ret
1786  0594              esp_check_err1
1787  0594 3E FF        	ld a,255
1788  0596 37           	scf
1789  0597 C9           	ret
1790  0598
1791  0598
1792  0598
1793  0598              ;прочитать байт из порта uart
1794  0598              ;вх:
1795  0598              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
1796  0598              ;вых: A - считанный байт
1797  0598              uart_read ;
1798  0598 CD 7B 05     	call esp_check_err
1799  059B D8           	ret c
1800  059C              	;прочитать сразу, не через сетевой процесс
1801  059C 3E FD            ld a, Uart.LSR
1802  059E DB EF            in a, (uart_port)
1803  05A0 0F               rrca
1804  05A1 30 06        	jr nc,uart_read_err
1805  05A3 3E F8            ld a, Uart.RBR_THR
1806  05A5 DB EF            in a, (uart_port)
1807  05A7 B7           	or a ;сбросить флаг
1808  05A8 C9           	ret
1809  05A9              uart_read_err
1810  05A9 AF           	xor a
1811  05AA 37           	scf
1812  05AB C9           	ret
1813  05AC
1814  05AC
1815  05AC              ;записать байт в порт uart
1816  05AC              ;вх: A -байт
1817  05AC              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1818  05AC              uart_write ;
1819  05AC 08           	ex af,af'
1820  05AD CD 7B 05     	call esp_check_err
1821  05B0 D8           	ret c
1822  05B1              	;записать
1823  05B1 3E FD        	ld a, Uart.LSR
1824  05B3 DB EF            in a, (uart_port)
1825  05B5 E6 20            and #20
1826  05B7 28 09            jr z,uart_write_err ;порт не готов
1827  05B9 08               ex af,af'
1828  05BA 06 F8        	ld b, Uart.RBR_THR
1829  05BC 0E EF        	ld c, uart_port
1830  05BE ED 79            out (c), a
1831  05C0 B7           	or a ;сбросить флаг
1832  05C1 C9           	ret
1833  05C2              uart_write_err
1834  05C2 37           	scf
1835  05C3 C9           	ret
1836  05C4
1837  05C4
1838  05C4              ;вх: a - id процесса куда копировать, hl - откуда, de - куда, bc - длина
1839  05C4              esp_buffer_copy ;скопировать принятое из буфера ESP
1840  05C4 D9           	exx
1841  05C5 21 00 2C     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1842  05C8 84           	add h
1843  05C9 67           	ld h,a
1844  05CA AF           	xor a
1845  05CB B6           	or (hl)
1846  05CC C8           	ret z
1847  05CD
1848  05CD E5           	push hl
1849  05CE DD E1        	pop ix ;дескриптор процесса
1850  05D0              	;включить страницы целевого процесса
1851  05D0 DD 7E 02     	ld a,(ix+2)
1852  05D3 CD 5D 0C     	call drvgmx.PageSlot2
1853  05D6 DD 7E 03     	ld a,(ix+3)
1854  05D9 CD 7C 0B     	call drvgmx.PageSlot3
1855  05DC D9           	exx
1856  05DD
1857  05DD ED B0        	ldir
1858  05DF
1859  05DF              	;вернуть страницы
1860  05DF C3 D1 02     	jp page_cur_return
1861  05E2
1862  05E2
1863  05E2
1864  05E2
1865  05E2              ;вх: hl - откуда de - куда
1866  05E2              copyZ ;копировать данные до кода 0
1867  05E2 7E           	ld a,(hl)
1868  05E3 B7           	or a
1869  05E4 28 04        	jr z,copyZ_ex
1870  05E6 ED A0        	ldi
1871  05E8 18 F8        	jr copyZ
1872  05EA              copyZ_ex
1873  05EA AF           	xor a
1874  05EB 12           	ld (de),a  ;в конце 0
1875  05EC C9           	ret
1876  05ED
1877  05ED
1878  05ED
1879  05ED              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
1880  05ED              				;на входе в HL число
1881  05ED 11 10 27     			ld de,10000 ;десятки тысяч
1882  05F0 3E FF        			ld a,255
1883  05F2              toDecimal10k
1884  05F2 A7           			and a
1885  05F3 ED 52        			sbc hl,de
1886  05F5 3C           			inc a
1887  05F6 30 FA        			jr nc,toDecimal10k
1888  05F8 19           			add hl,de
1889  05F9 C6 30        			add a,48
1890  05FB 32 43 06     			ld (decimalS),a
1891  05FE 11 E8 03     			ld de,1000 ;тысячи
1892  0601 3E FF        			ld a,255
1893  0603              toDecimal1k
1894  0603 A7           			and a
1895  0604 ED 52        			sbc hl,de
1896  0606 3C           			inc a
1897  0607 30 FA        			jr nc,toDecimal1k
1898  0609 19           			add hl,de
1899  060A C6 30        			add a,48
1900  060C 32 44 06     			ld (decimalS+1),a
1901  060F 11 64 00     			ld de,100 ;сотни
1902  0612 3E FF        			ld a,255
1903  0614              toDecimal01k
1904  0614 A7           			and a
1905  0615 ED 52        			sbc hl,de
1906  0617 3C           			inc a
1907  0618 30 FA        			jr nc,toDecimal01k
1908  061A 19           			add hl,de
1909  061B C6 30        			add a,48
1910  061D 32 45 06     			ld (decimalS+2),a
1911  0620 11 0A 00     			ld de,10 ;десятки
1912  0623 3E FF        			ld a,255
1913  0625              toDecimal001k
1914  0625 A7           			and a
1915  0626 ED 52        			sbc hl,de
1916  0628 3C           			inc a
1917  0629 30 FA        			jr nc,toDecimal001k
1918  062B 19           			add hl,de
1919  062C C6 30        			add a,48
1920  062E 32 46 06     			ld (decimalS+3),a
1921  0631 11 01 00     			ld de,1 ;единицы
1922  0634 3E FF        			ld a,255
1923  0636              toDecimal0001k
1924  0636 A7           			and a
1925  0637 ED 52        			sbc hl,de
1926  0639 3C           			inc a
1927  063A 30 FA        			jr nc,toDecimal0001k
1928  063C 19           			add hl,de
1929  063D C6 30        			add a,48
1930  063F 32 47 06     			ld (decimalS+4),a
1931  0642
1932  0642 C9           			ret
1933  0643 00 00 00...  decimalS ds 6 ;здесь будет цифра
1934  0649
1935  0649
1936  0649
1937  0649
1938  0649              ;передача управления ОС до следующего прерывания;
1939  0649              os_wait ;
1940  0649 F5           	push af
1941  064A C5           	push bc
1942  064B D5           	push de
1943  064C E5           	push hl
1944  064D D9           	exx
1945  064E 08           	ex af,af'
1946  064F F5           	push af
1947  0650 C5           	push bc
1948  0651 D5           	push de
1949  0652 E5           	push hl
1950  0653 DD E5        	push ix
1951  0655 FD E5        	push iy
1952  0657 ED 73 0A 2C  	ld (proc_stack_addr_tmp_wait),sp ;запомнить адрес стека
1953  065B 3E 01        	ld a,1
1954  065D 32 0C 2C     	ld (os_wait_flag),a ;флаг внеочередная смена процесса
1955  0660 3A 23 2C     	ld a,(proc_id_cur)
1956  0663 CD D3 06     	call get_proc_descr
1957  0666 DD 36 1D 01  	ld (ix+#1d),1 ;флаг что процесс запросил os_wait
1958  066A C3 B2 08     	jp proc_next_wait ;на следующий процесс
1959  066D
1960  066D
1961  066D
1962  066D              ;закрыть процесс
1963  066D              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
1964  066D              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
1965  066D              proc_close
1966  066D B7           	or a
1967  066E 20 03        	jr nz,proc_close_skip
1968  0670 3A 23 2C     	ld a,(proc_id_cur) ;текущий
1969  0673              proc_close_skip
1970  0673 FE 09        	cp proc_max+1 ;защита
1971  0675 D0           	ret nc
1972  0676 32 D2 06     	ld (proc_close_id_tmp),a ;запомнить
1973  0679
1974  0679 21 07 2C     	ld hl,proc_id_focus ;если он был в фокусе
1975  067C BE           	cp (hl)
1976  067D 20 05        	jr nz,proc_close_skip3
1977  067F 3E 01        	ld a,1
1978  0681 CD 3D 02     	call proc_set_focus ;сменить фокус на системный процесс
1979  0684
1980  0684              proc_close_skip3
1981  0684              ;очистить таблицу процессов
1982  0684 3A D2 06     	ld a,(proc_close_id_tmp)
1983  0687 CD D3 06     	call get_proc_descr
1984  068A 54           	ld d,h
1985  068B 5D           	ld e,l
1986  068C 13           	inc de
1987  068D 36 00        	ld (hl),0
1988  068F 01 FF 00     	ld bc,proc_descr_size-1
1989  0692 ED B0        	ldir
1990  0694
1991  0694              ;очистить таблицу памяти
1992  0694 3A D2 06     	ld a,(proc_close_id_tmp)
1993  0697 CD 1D 02     	call proc_clear_ram
1994  069A
1995  069A              ;очистить таблицу файлов FAT
1996  069A 3A D2 06     	ld a,(proc_close_id_tmp)
1997  069D CD 78 0E     	call Dos.fclose_proc_all
1998  06A0
1999  06A0              ;очистить таблицу соединений ESP
2000  06A0 3A D2 06     	ld a,(proc_close_id_tmp)
2001  06A3 21 80 35     	ld hl,esp_link_id_table
2002  06A6 BE           	cp (hl) ;id процесса совпадает?
2003  06A7 20 0A        	jr nz,proc_close_skip2
2004  06A9 54           	ld d,h
2005  06AA 5D           	ld e,l
2006  06AB 13           	inc de
2007  06AC 01 3F 00     	ld bc,esp_link_id_table_size_item-1
2008  06AF 36 00        	ld (hl),0 ;очистить
2009  06B1 ED B0        	ldir
2010  06B3              proc_close_skip2
2011  06B3
2012  06B3              ;остановить плеер
2013  06B3 3A D2 06     	ld a,(proc_close_id_tmp)
2014  06B6 21 03 2C     	ld hl,proc_play_ay
2015  06B9 BE           	cp (hl)
2016  06BA 20 03        	jr nz,proc_close_skip4
2017  06BC CD 7C 04     	call set_VTPL_MUTE
2018  06BF
2019  06BF              proc_close_skip4
2020  06BF              ;выключить режим моно
2021  06BF 21 1F 2C     	ld hl,mono_mode_id
2022  06C2 BE           	cp (hl)
2023  06C3 20 02        	jr nz,proc_close_skip5
2024  06C5 AF           	xor a
2025  06C6 77           	ld (hl),a
2026  06C7
2027  06C7              proc_close_skip5
2028  06C7              ;выход
2029  06C7 3A D2 06     	ld a,(proc_close_id_tmp)
2030  06CA 21 23 2C     	ld hl,proc_id_cur
2031  06CD BE           	cp (hl)
2032  06CE C0           	ret nz ;выйти если вызывал не сам процесс
2033  06CF
2034  06CF C3 49 06     	jp os_wait ;если вызывал закрытие сам процесс, то сразу переключиться на следующий
2035  06D2 00           proc_close_id_tmp db 0 ;временно
2036  06D3
2037  06D3
2038  06D3
2039  06D3
2040  06D3
2041  06D3              ;получить дескриптор процесса (адрес в таблице процессов)
2042  06D3              ;вх: A - id процесса
2043  06D3              ;вых: HL, IX - дескриптор
2044  06D3              get_proc_descr
2045  06D3 21 00 2C     	ld hl,proc_table - 256
2046  06D6 84           	add h
2047  06D7 67           	ld h,a
2048  06D8 E5           	push hl
2049  06D9 DD E1        	pop ix ;дескриптор
2050  06DB C9           	ret
2051  06DC
2052  06DC
2053  06DC              ;освободить страницу памяти
2054  06DC              ;вх: a - номер страницы
2055  06DC              proc_del_ram
2056  06DC 21 DD 0B     	ld hl,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
2057  06DF 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
2058  06E1 0E 00        	ld c,0 ;счётчик
2059  06E3              proc_del_ram_cl ;
2060  06E3 BE           	cp (hl) ;совпадает с номером страницы?
2061  06E4 20 10        	jr nz,proc_del_ram1
2062  06E6 21 00 35     	ld hl,proc_page_table
2063  06E9 06 00        	ld b,0
2064  06EB 09           	add hl,bc ;адрес записи
2065  06EC 3A 23 2C     	ld a,(proc_id_cur)
2066  06EF BE           	cp (hl)
2067  06F0 20 08        	jr nz,proc_del_ram_err ;если чужая страница
2068  06F2 36 00        	ld (hl),0 ;освободить
2069  06F4 B7           	or a
2070  06F5 C9           	ret
2071  06F6
2072  06F6              proc_del_ram1
2073  06F6 23           	inc hl
2074  06F7 0C           	inc c
2075  06F8 10 E9        	djnz proc_del_ram_cl
2076  06FA              proc_del_ram_err
2077  06FA 37           	scf ;не нашли страницы
2078  06FB C9           	ret
2079  06FC
2080  06FC
2081  06FC
2082  06FC              ;включить/выключить моно режим для приложения
2083  06FC              ;вх: a = 0 - включить; a = 255 - выключить
2084  06FC              set_mono_mode
2085  06FC B7           	or a
2086  06FD 28 0D        	jr z,set_mono_mode_on
2087  06FF              	;выключить
2088  06FF 3A 23 2C     	ld a,(proc_id_cur) ;проверка что этим процессом было занято
2089  0702 21 1F 2C     	ld hl,mono_mode_id
2090  0705 BE           	cp (hl)
2091  0706 20 12        	jr nz,set_mono_mode_err
2092  0708 AF           	xor a
2093  0709 36 00        	ld (hl),0
2094  070B C9           	ret
2095  070C
2096  070C              set_mono_mode_on
2097  070C              	;включить
2098  070C 3A 1F 2C     	ld a,(mono_mode_id)
2099  070F B7           	or a
2100  0710 20 08        	jr nz,set_mono_mode_err ;кем-то занято
2101  0712
2102  0712 3A 23 2C     	ld a,(proc_id_cur)
2103  0715 32 1F 2C     	ld (mono_mode_id),a
2104  0718 AF           	xor a
2105  0719 C9           	ret
2106  071A
2107  071A              set_mono_mode_err
2108  071A 37           	scf
2109  071B C9           	ret
2110  071C
2111  071C
2112  071C
2113  071C
2114  071C
2115  071C
2116  071C
2117  071C
2118  071C              ;выбор функции (вызова)
2119  071C              function
2120  071C 08           	ex af,af'
2121  071D 79           	ld a,c
2122  071E FE 2B        	cp function_max ;проверка на общее количество
2123  0720 38 05        	jr c,function1
2124  0722              function_no
2125  0722 08           	ex af,af'
2126  0723 3E FF        	ld a,255 ;??????
2127  0725 37           	scf
2128  0726 C9           	ret
2129  0727              function1
2130  0727 D9           	exx
2131  0728 6F           	ld l,a
2132  0729 26 00        	ld h,0
2133  072B 29           	add hl,hl ;*2
2134  072C 01 3B 07     	ld bc,function_table
2135  072F 09           	add hl,bc
2136  0730 5E           	ld e,(hl)
2137  0731 23           	inc hl
2138  0732 56           	ld d,(hl)
2139  0733 7B           	ld a,e ;временно проверка есть ли такая функция
2140  0734 B2           	or d
2141  0735 28 EB        	jr z,function_no ;-^
2142  0737 D5           	push de
2143  0738 D9           	exx
2144  0739 08           	ex af,af'
2145  073A C9           	ret ;перейти по адресу функции
2146  073B
2147  073B
2148  073B              function_table ;таблица функций
2149  073B D9 09        	dw drvgmx.cls  ; #00 (0 dec) - очистить консоль;
2150  073D 15 0A        	dw drvgmx.gotoXY ; #01 (1 dec) - установить позицию курсора в консоли
2151  073F 8B 0A        	dw drvgmx.putC ; #02 (2 dec) - печать символа в консоль;
2152  0741 26 0A        	dw drvgmx.fillLine ; #03 (3 dec) - заполнение строки одним символом
2153  0743 40 0A        	dw drvgmx.paintLine ; #04 (4 dec) - покрасить строку цветом
2154  0745 00 00        	dw 0 ;#05 (5 dec) -
2155  0747 9D 0B        	dw drvgmx.set_color ;#06 (6 dec) - установить цвет текста в консоли
2156  0749 00 00        	dw 0 ;#07 (7 dec) - ;
2157  074B FC 06        	dw set_mono_mode ;#08 (8 dec) - включить/выключить моно режим для приложения
2158  074D 80 0A        	dw drvgmx.printZ ; #09 (9 dec) - печать в консоль до кода 0
2159  074F 98 05        	dw uart_read ;#0A (10 dec) - прочитать байт из порта uart
2160  0751 AC 05        	dw uart_write ;#0B (11 dec) - записать байт в порт uart
2161  0753 2D 05        	dw esp_close ;#0C (12 dec) - закрыть соединение ESP
2162  0755 F6 04        	dw esp_open ;#0D (13 dec) - установить соединение ESP (CIPSTART);
2163  0757 36 05        	dw esp_send ;#0E (14 dec) - послать запрос ESP (CIPSEND);
2164  0759 5B 05        	dw esp_get ;#0F (15 dec) - получить пакет ESP (+IPD);
2165  075B DD 03        	dw get_c ;#10 (16 dec) - получить код нажатой клавиши;
2166  075D DE 02        	dw proc_run ;#11 (17 dec) - запустить процесс;
2167  075F 3D 02        	dw proc_set_focus ;#12 (18 dec) - установить фокус;
2168  0761 6D 06        	dw proc_close ;#13 (19 dec)-закрыть процесс;
2169  0763 E7 04        	dw set_interrupt ;#14 (20 dec) - установка адреса обработчика прерываний процесса;
2170  0765 63 17        	dw VTPL.INIT ;#15 (21 dec) - инициализация плеера AY;
2171  0767 69 04        	dw set_VTPL_PLAY ;#16 (22 dec) - запустить плеер AY;
2172  0769 7C 04        	dw set_VTPL_MUTE ;#17 (23 dec) - заглушить плеер AY;
2173  076B 83 04        	dw get_VTPL_SETUP ;#18 (24 dec) - получить значение переменной плеера;
2174  076D FA 03        	dw page_copy ;#19 (25 dec) - скопировать данные из страницы в страницу
2175  076F FE 01        	dw proc_get_ram ;#1A (26 dec) - получить дополнительную страницу памяти;
2176  0771 BD 04        	dw set_page_slot2 ;#1B (27 dec) - включить страницу в слот 2 (#8000);
2177  0773 D2 04        	dw set_page_slot3 ;#1C (28 dec) - включить страницу в слот 3 (#c000);
2178  0775 90 04        	dw set_scr ;#1D (29 dec) - включить экран N;
2179  0777 87 04        	dw get_proc_page ;#1E (30 dec) - получить номера страниц процесса;
2180  0779 F2 03        	dw get_timer ;#1F (31 dec) - получить значение системного таймера
2181  077B DC 06        	dw proc_del_ram ;#20 (32 dec) - освободить страницу памяти
2182  077D F0 0C        	dw Dos.fopen_r ;#21 (33 dec) - открыть файл для чтения или записи;
2183  077F 06 0D        	dw Dos.fopen_c ;#22 (34 dec) - создать файл;
2184  0781 8F 0E        	dw Dos.fread ;#23 (35 dec) - прочитать из файла;
2185  0783 A7 0E        	dw Dos.fwrite ;#24 (36 dec) - записать в файл;
2186  0785 55 0E        	dw Dos.fclose ;#25 (37 dec) - закрыть файл;
2187  0787 E9 0E        	dw Dos.read_dir ;#26 (38 dec) - чтение секторов текущего каталога
2188  0789 F1 0E        	dw Dos.open_dir ;#27 (39 dec) - вход в каталог/выход в родительский каталог
2189  078B 18 0F        	dw Dos.file_position ;#28 (40 dec) - установка/чтение указателя в файле
2190  078D 44 0F        	dw Dos.find_path ;#29 (41 dec) - ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
2191  078F 56 0F        	dw Dos.get_LFN ;#2a (42 dec) - ; получение длинного имени файла
2192  0791
2193  0791
2194  0791 00 00 00...  	align 16
2195  07A0              ;обработчик прерываний
2196  07A0              Interrupts
2197  07A0 F3           	di
2198  07A1 E3           	ex (sp),hl
2199  07A2 22 0E 2C     	ld (proc_stack_addr_return_tmp),hl ;запомнить откуда вызвали прерывание
2200  07A5 E3           	ex (sp),hl
2201  07A6 F5           	push af
2202  07A7 C5           	push bc
2203  07A8 D5           	push de
2204  07A9 E5           	push hl
2205  07AA D9           	exx
2206  07AB 08           	ex af,af'
2207  07AC F5           	push af
2208  07AD C5           	push bc
2209  07AE D5           	push de
2210  07AF E5           	push hl
2211  07B0 DD E5        	push ix
2212  07B2 FD E5        	push iy
2213  07B4 ED 73 08 2C  	ld (proc_stack_addr_tmp),sp ;запомнить адрес стека
2214  07B8              	; ld a,1
2215  07B8              	; out (254),a
2216  07B8
2217  07B8 3E 01        	ld a,1
2218  07BA 32 01 2C     	ld (Interrupt_new_flag),a ;флаг что было новое прерывание
2219  07BD              	;сбросить флаги os_wait, потому что произошло обычное прерывание
2220  07BD AF           	xor a
2221  07BE 21 1D 2D     	ld hl,proc_table+#1d
2222  07C1 77           	ld (hl),a
2223  07C2 24           	inc h
2224  07C3 77           	ld (hl),a
2225  07C4 24           	inc h
2226  07C5 77           	ld (hl),a
2227  07C6 24           	inc h
2228  07C7 77           	ld (hl),a
2229  07C8 24           	inc h
2230  07C9 77           	ld (hl),a
2231  07CA 24           	inc h
2232  07CB 77           	ld (hl),a
2233  07CC 24           	inc h
2234  07CD 77           	ld (hl),a
2235  07CE 24           	inc h
2236  07CF 77           	ld (hl),a
2237  07D0
2238  07D0
2239  07D0
2240  07D0              ;таймер
2241  07D0 2A 25 2C     	ld hl,(sys_timer)
2242  07D3 23           	inc hl
2243  07D4 22 25 2C     	ld (sys_timer),hl
2244  07D7 7C           	ld a,h
2245  07D8 B5           	or l
2246  07D9 20 07        	jr nz,Interrupts_timer
2247  07DB 2A 27 2C     	ld hl,(sys_timer+2)
2248  07DE 23           	inc hl
2249  07DF 22 27 2C     	ld (sys_timer+2),hl
2250  07E2              Interrupts_timer
2251  07E2
2252  07E2
2253  07E2              ;опрос клавиатуры
2254  07E2 CD 14 14     	call @DriverKeyboard
2255  07E5 22 15 2C     	ld (FlgScanKeys_addr),hl ;адрес переменной
2256  07E8 CB 76        	bit 6,(hl)
2257  07EA 20 03        	jr nz,Interrupts_key1 ;если не нажата ни одна
2258  07EC 32 1D 2C     	ld (key_cur),a ;запомнить клавишу
2259  07EF              Interrupts_key1
2260  07EF
2261  07EF FE 1B        	cp proc_switch_key ;если клавиша переключения задач
2262  07F1 20 03        	jr nz,Interrupts_key_switch_no
2263  07F3 32 10 2C     	ld (key_proc_switch_flag),a ;сохранить нажатие
2264  07F6              Interrupts_key_switch_no
2265  07F6
2266  07F6 FE 07        	cp DrvKey.keyEdit
2267  07F8 20 05        	jr nz,Interrupts_key2
2268  07FA              	;переключение языка
2269  07FA 32 11 2C     	ld (key_lang_flag),a
2270  07FD 18 17        	jr Interrupts_key_ex
2271  07FF              Interrupts_key2
2272  07FF FE 06        	cp DrvKey.keyCaps
2273  0801 20 05        	jr nz,Interrupts_key3
2274  0803              	;переключение заглавных
2275  0803 32 12 2C     	ld (key_caps_lock_switch_flag),a
2276  0806 18 0E        	jr Interrupts_key_ex
2277  0808              Interrupts_key3
2278  0808 FE 0F        	cp DrvKey.keyDelete
2279  080A 20 03        	jr nz,Interrupts_key4
2280  080C              	;графическая
2281  080C 32 13 2C     	ld (key_graph_flag),a
2282  080F
2283  080F              Interrupts_key4
2284  080F FE 12        	cp 18
2285  0811 20 03        	jr nz,Interrupts_key_ex
2286  0813              	;sys процесс в фокус
2287  0813 32 14 2C     	ld (key_sys_focus),a
2288  0816
2289  0816
2290  0816
2291  0816              Interrupts_key_ex
2292  0816              	;с клавиатурой всё
2293  0816
2294  0816
2295  0816
2296  0816
2297  0816
2298  0816              ;определить текущие страницы памяти
2299  0816 01 FD 7A     	ld bc,#7AFD
2300  0819 ED 78        	in a,(c)
2301  081B E6 7F        	and %01111111
2302  081D 32 D5 09     	ld (Interrupts_cur_page_slot3),a
2303  0820 01 FD 78     	ld bc,#78fd
2304  0823 ED 78        	in a,(c)
2305  0825 EE 02        	xor %00000010
2306  0827 32 D4 09     	ld (Interrupts_cur_page_slot2),a
2307  082A
2308  082A 3A 23 2C     	ld a,(proc_id_cur) ;сохранить текущий процесс
2309  082D 32 24 2C     	ld (proc_id_cur_tmp),a
2310  0830 ED 4B 17 2C  	ld bc,(page_slot2_cur) ;две переменные текущие страницы
2311  0834 ED 43 19 2C  	ld (page_slot2_cur_tmp),bc
2312  0838
2313  0838
2314  0838
2315  0838
2316  0838              ;плеер музыки и прочие неотложные процессы
2317  0838 3A 03 2C     	ld a,(proc_play_ay)
2318  083B B7           	or a
2319  083C 28 0F        	jr z,Interrupts_ay_skip
2320  083E 3A 04 2C     	ld a,(proc_play_ay_slot2) ;страницы с музыкой
2321  0841 CD 5D 0C     	call drvgmx.PageSlot2
2322  0844 3A 05 2C     	ld a,(proc_play_ay_slot3) ;страницы с музыкой
2323  0847 CD 7C 0B     	call drvgmx.PageSlot3
2324  084A CD 93 1F     	call VTPL.PLAY ;играть
2325  084D
2326  084D
2327  084D              Interrupts_ay_skip
2328  084D
2329  084D              	;проверить обработчики прерываний всех процессов
2330  084D 3E 01        	ld a,1 ;первый
2331  084F CD D3 06     	call get_proc_descr ;узнать адрес дескриптора
2332  0852 06 08        	ld b,proc_max ;цикл всего процессов
2333  0854              Interrupts_proc_cl
2334  0854 AF           	xor a
2335  0855 DD B6 00     	or (ix+#00) ;рабочий процесс?
2336  0858 28 32        	jr z,Interrupts_proc_cl_skip
2337  085A
2338  085A DD 7E 0E     	ld a,(ix+#0e) ;адрес
2339  085D DD B6 0F     	or (ix+#0f) ;адрес
2340  0860              	;задан адрес прерываний?
2341  0860 28 2A        	jr z,Interrupts_proc_cl_skip
2342  0862
2343  0862              	;вызов обработчика
2344  0862 DD E5        	push ix
2345  0864 C5           	push bc
2346  0865
2347  0865 DD 7E 00     	ld a,(ix+#00)
2348  0868 32 23 2C     	ld (proc_id_cur),a ;временно установить номер процесса
2349  086B
2350  086B DD 7E 02     	ld a,(ix+#02) ;страницы процесса
2351  086E 32 17 2C     	ld (page_slot2_cur),a
2352  0871 CD 5D 0C     	call drvgmx.PageSlot2
2353  0874 DD 7E 03     	ld a,(ix+#03) ;страницы процесса
2354  0877 32 18 2C     	ld (page_slot3_cur),a
2355  087A CD 7C 0B     	call drvgmx.PageSlot3
2356  087D 21 89 08     	ld hl,Interrupts_proc_cl_ret
2357  0880 E5           	push hl ;адрес возврата
2358  0881 DD 6E 0E     	ld l,(ix+#0e) ;адрес
2359  0884 DD 66 0F     	ld h,(ix+#0f) ;адрес
2360  0887 E5           	push hl ;адрес очередного обработчика
2361  0888 C9           	ret ;запустить
2362  0889
2363  0889              Interrupts_proc_cl_ret
2364  0889 C1           	pop bc
2365  088A DD E1        	pop ix
2366  088C
2367  088C              Interrupts_proc_cl_skip
2368  088C DD 24        	inc ixh ;следующий
2369  088E 10 C4        	djnz Interrupts_proc_cl
2370  0890
2371  0890
2372  0890              ;вернуть страницы
2373  0890 3A D4 09     	ld a,(Interrupts_cur_page_slot2)
2374  0893 CD 5D 0C     	call drvgmx.PageSlot2
2375  0896 3A D5 09     	ld a,(Interrupts_cur_page_slot3)
2376  0899 CD 7C 0B     	call drvgmx.PageSlot3
2377  089C
2378  089C 3A 24 2C     	ld a,(proc_id_cur_tmp) ;вернуть текущий процесс
2379  089F 32 23 2C     	ld (proc_id_cur),a
2380  08A2 ED 4B 19 2C  	ld bc,(page_slot2_cur_tmp) ;две переменные текущие страницы
2381  08A6 ED 43 17 2C  	ld (page_slot2_cur),bc
2382  08AA
2383  08AA
2384  08AA
2385  08AA              ;многозадачность тут
2386  08AA 3A 0F 2C     	ld a,(proc_stack_addr_return_tmp+1) ;узнать адрес откуда были прерывания
2387  08AD FE 40        	cp #40 ;если прерывание было в области пзу, значит работала система
2388  08AF DA 51 09     	jp c,Interrupts_ex ;пропустим переключения на другие задачи
2389  08B2
2390  08B2              proc_next_wait	;сюда приходит после вызова OS_WAIT, мимо обработки прерывания по INT
2391  08B2 CD 67 09     	call proc_next_find
2392  08B5              	;jp c,Interrupts_ex ;если процесс один, то на выход
2393  08B5
2394  08B5              	; push hl ;дескриптор следующего
2395  08B5              	; pop ix
2396  08B5
2397  08B5
2398  08B5              	;запомнить стек предыдущего (текущего) процесса
2399  08B5 3A 23 2C     	ld a,(proc_id_cur)
2400  08B8 21 00 2C     	ld hl,proc_table - 256
2401  08BB 84           	add h
2402  08BC 67           	ld h,a
2403  08BD E5           	push hl
2404  08BE FD E1        	pop iy ;дескриптор предыдущего
2405  08C0
2406  08C0 01 06 00     	ld bc,6
2407  08C3 09           	add hl,bc
2408  08C4 ED 4B 08 2C  	ld bc,(proc_stack_addr_tmp)
2409  08C8 3A 0C 2C     	ld a,(os_wait_flag)
2410  08CB B7           	or a
2411  08CC 28 08        	jr z,proc_next_wait_no
2412  08CE ED 4B 0A 2C  	ld bc,(proc_stack_addr_tmp_wait) ;если в режиме вызова os_wait
2413  08D2 AF           	xor a
2414  08D3 32 0C 2C     	ld (os_wait_flag),a
2415  08D6              proc_next_wait_no
2416  08D6 71           	ld (hl),c
2417  08D7 23           	inc hl
2418  08D8 70           	ld (hl),b
2419  08D9
2420  08D9              	;запомнить координаты экрана предыдущего
2421  08D9 2A 99 0C     	ld hl,(drvgmx.col_screen)
2422  08DC FD 75 0A FD  	ld (iy+#0a),hl ;координаты
2422  08E0 74 0B
2423  08E2
2424  08E2 2A 9B 0C     	ld hl,(drvgmx.attr_screen)
2425  08E5 FD 75 0C FD  	ld (iy+#0c),hl ;атрибуты (цвет текста)
2425  08E9 74 0D
2426  08EB
2427  08EB 2A 6D 0B     	ld hl,(drvgmx.curscrl)
2428  08EE FD 75 08 FD  	ld (iy+#08),hl ;позиция скрола
2428  08F2 74 09
2429  08F4
2430  08F4
2431  08F4
2432  08F4              	;следующий
2433  08F4 DD 7E 02     	ld a,(ix+2)
2434  08F7 32 17 2C     	ld (page_slot2_cur),a ;сделать страницы текущими
2435  08FA CD 5D 0C     	call drvgmx.PageSlot2
2436  08FD DD 7E 03     	ld a,(ix+3)
2437  0900 32 18 2C     	ld (page_slot3_cur),a
2438  0903 CD 7C 0B     	call drvgmx.PageSlot3
2439  0906
2440  0906
2441  0906              	;параметры экрана (консоли)
2442  0906 DD 6E 0A DD  	ld hl,(ix+#0a) ;координаты
2442  090A 66 0B
2443  090C 22 99 0C     	ld (drvgmx.col_screen),hl
2444  090F
2445  090F DD 6E 0C DD  	ld hl,(ix+#0c) ;атрибуты (цвет текста)
2445  0913 66 0D
2446  0915 22 9B 0C     	ld (drvgmx.attr_screen),hl
2447  0918
2448  0918 DD 6E 08 DD  	ld hl,(ix+#08) ;позиция скрола
2448  091C 66 09
2449  091E 22 6D 0B     	ld (drvgmx.curscrl),hl
2450  0921
2451  0921
2452  0921
2453  0921 3A 07 2C     	ld a,(proc_id_focus) ;если это процесс в фокусе
2454  0924 DD BE 00     	cp (ix)
2455  0927 20 0C        	jr nz,proc_next_no_focus
2456  0929 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
2457  092B 32 1B 2C     	ld (con_scr_cur),a
2458  092E 3E 79        	ld a,con_atr_real ;атрибуты реальные
2459  0930 32 1C 2C     	ld (con_atr_cur),a
2460  0933 18 0C        	jr proc_next2
2461  0935              proc_next_no_focus
2462  0935              	;если не в фокусе
2463  0935 DD 7E 04     	ld a,(ix+4) ;пиксели
2464  0938 32 1B 2C     	ld (con_scr_cur),a
2465  093B DD 7E 05     	ld a,(ix+5) ;атрибуты
2466  093E 32 1C 2C     	ld (con_atr_cur),a
2467  0941              proc_next2
2468  0941 DD 6E 06     	ld l,(ix+6) ;стек
2469  0944 DD 66 07     	ld h,(ix+7) ;стек
2470  0947 F9           	ld sp,hl
2471  0948
2472  0948 3A 20 2C     	ld a,(proc_id_next)
2473  094B 32 23 2C     	ld (proc_id_cur),a ;сменить текущий
2474  094E
2475  094E CD 64 0B     	call drvgmx.gmxscroll ;обновить скролл
2476  0951
2477  0951              Interrupts_ex
2478  0951 AF           	xor a
2479  0952 D3 FE        	out (254),a
2480  0954 32 01 2C     	ld (Interrupt_new_flag),a ;флаг что было прерывание убрать
2481  0957 FD E1        	pop iy
2482  0959 DD E1        	pop ix
2483  095B E1           	pop hl
2484  095C D1           	pop de
2485  095D C1           	pop bc
2486  095E F1           	pop af
2487  095F D9           	exx
2488  0960 08           	ex af,af
2489  0961 E1           	pop hl
2490  0962 D1           	pop de
2491  0963 C1           	pop bc
2492  0964 F1           	pop af
2493  0965 FB           	ei
2494  0966 C9           	ret
2495  0967
2496  0967
2497  0967              	;поиск следующей задачи
2498  0967              	;вых: hl, ix - дескриптор следующего процесса
2499  0967              proc_next_find
2500  0967 3A 01 2C     	ld a,(Interrupt_new_flag) ;флаг только что было прерывание
2501  096A B7           	or a
2502  096B 28 14        	jr z,proc_next_find_no_interrupt
2503  096D              	;тут попытка первым после прерывания запустить процесс в фокусе
2504  096D 3A 00 2C     	ld a,(proc_next_find_focus_flag)
2505  0970 B7           	or a
2506  0971 20 0E        	jr nz,proc_next_find_no_interrupt ;пропустить, если уже запускали недавно, по всем процессам не прошлись
2507  0973 3A 07 2C     	ld a,(proc_id_focus)
2508  0976 32 00 2C     	ld (proc_next_find_focus_flag),a ;флаг что процесс в фокусе уже запускали
2509  0979 32 20 2C     	ld (proc_id_next),a
2510  097C CD D3 06     	call get_proc_descr ;получить дескриптор
2511  097F B7           	or a
2512  0980 C9           	ret ;запустить его
2513  0981
2514  0981              proc_next_find_no_interrupt
2515  0981 3A 20 2C     	ld a,(proc_id_next) ;узнать следующий
2516  0984              proc_next_find_skip
2517  0984 3C           	inc a
2518  0985 FE 09        	cp proc_max+1
2519  0987 38 02        	jr c,proc_next_find1
2520  0989 3E 01        	ld a,proc_id_system
2521  098B              proc_next_find1
2522  098B 32 20 2C     	ld (proc_id_next),a
2523  098E
2524  098E CD D3 06     	call get_proc_descr ;получить дескриптор
2525  0991
2526  0991 DD 7E 00     	ld a,(ix)
2527  0994 B7           	or a ;нет активного процесса?
2528  0995 28 D0        	jr z,proc_next_find ;искать дальше
2529  0997
2530  0997 3A 07 2C     	ld a,(proc_id_focus)
2531  099A DD BE 00     	cp (ix)
2532  099D 20 04        	jr nz,proc_next_find2 ;если не в фокусе
2533  099F AF           	xor a ;сбросить флаг, все процессы по кругу прошли
2534  09A0 32 00 2C     	ld (proc_next_find_focus_flag),a
2535  09A3
2536  09A3              proc_next_find2
2537  09A3 DD 7E 00     	ld a,(ix)
2538  09A6 FE 01        	cp 1 ;системный процесс? для него исключение, можно вызывать всегда
2539  09A8 C8           	ret z
2540  09A9
2541  09A9 3A 07 2C     	ld a,(proc_id_focus)
2542  09AC DD BE 00     	cp (ix)	;если в фокусе
2543  09AF 28 B6        	jr z,proc_next_find ;искать дальше. потому что для процесса в фокусе отдельный приоритет
2544  09B1
2545  09B1
2546  09B1              	;дополнительные проверки
2547  09B1 3A 0D 2C     	ld a,(proc_next_find_skip_flag)
2548  09B4 B7           	or a
2549  09B5 20 14        	jr nz,proc_next_find_skip_flag_yep ;пропустить дополнительные
2550  09B7
2551  09B7              	;проверить было ли прерывание, чтобы не вызвать процесс второй раз
2552  09B7 DD 7E 1D     	ld a,(ix+#1d) ;флаг вызова os_wait этого процесса
2553  09BA B7           	or a
2554  09BB 20 AA        	jr nz,proc_next_find ;искать дальше
2555  09BD
2556  09BD
2557  09BD              	;проверить графический режим
2558  09BD DD 7E 1C     	ld a,(ix+#1c) ;режим
2559  09C0 B7           	or a
2560  09C1 28 08        	jr z,proc_next_find_no_graph ;не графический
2561  09C3              	;графический
2562  09C3 3A 07 2C     	ld a,(proc_id_focus)
2563  09C6 DD BE 00     	cp (ix)
2564  09C9 20 9C        	jr nz,proc_next_find ;искать дальше, если он не в фокусе
2565  09CB
2566  09CB              proc_next_find_no_graph
2567  09CB
2568  09CB              proc_next_find_skip_flag_yep
2569  09CB              	;нашли следующий процесс
2570  09CB 3A 23 2C     	ld a,(proc_id_cur)
2571  09CE BE           	cp (hl) ;если это он и был (всего один процесс)
2572  09CF 37           	scf
2573  09D0 C8           	ret z
2574  09D1 7E           	ld a,(hl) ;или вернуть id слудующего
2575  09D2 B7           	or a
2576  09D3 C9           	ret
2577  09D4
2578  09D4 00           Interrupts_cur_page_slot2 db 0 ;временно
2579  09D5 00           Interrupts_cur_page_slot3 db 0 ;временно
2580  09D6
2581  09D6
2582  09D6
2583  09D6
2584  09D6
2585  09D6              	include Drv/zsgmx.asm ;драйвер экрана и памяти
# file opened: Drv/zsgmx.asm
   1+ 09D6              COLOR=1
   2+ 09D6              ;; ZS GMX screen driver (izzx)
   3+ 09D6              	define LINE_LIMIT 80
   4+ 09D6                  module drvgmx
   5+ 09D6              hsize   equ 25 ;всего строк
   6+ 09D6              scraddr equ #c000 ;адрес экрана
   7+ 09D6              scrsize equ 16000  ;размер экрана
   8+ 09D6              scrline equ 80*8   ;размер строки в байтах
   9+ 09D6
  10+ 09D6              init:
  11+ 09D6                  ; ld hl, font_file, b, Dos.FMODE_READ
  12+ 09D6                  ; call Dos.fopen
  13+ 09D6                  ; push af
  14+ 09D6                  ; ld bc, 2048, hl, font
  15+ 09D6                  ; call Dos.fread
  16+ 09D6                  ; pop af
  17+ 09D6                  ; call Dos.fclose
  18+ 09D6              	; xor a : out (#fe), a
  19+ 09D6              	; call cls
  20+ 09D6              	; ret
  21+ 09D6 CD C1 0B     	call set_scr39 ;включить экран
  22+ 09D9              cls:
  23+ 09D9 11 00 00         ld de, 0
  23+ 09DC
  24+ 09DC ED 53 6D 0B  	ld (curscrl),de ;скролл выключить
  25+ 09E0 CD 64 0B     	call gmxscroll
  26+ 09E3 11 00 00         ld de, 0
  26+ 09E6
  27+ 09E6 CD 15 0A     	call gotoXY
  28+ 09E9                  ;ld a, 7 : call Memory.setPage
  29+ 09E9 3A 1B 2C     	ld a,(con_scr_cur) ;пиксели
  30+ 09EC CD 7C 0B     	call PageSlot3 ;включить страницу пикселей
  31+ 09EF AF               xor a
  31+ 09F0               ; out (#fe), a
  32+ 09F0 21 00 C0 11      ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  32+ 09F4 01 C0 01 7F
  32+ 09F8 3E 77
  32+ 09FA ED B0          ldir ;очистить
  33+ 09FC 3A 1C 2C     	ld a,(con_atr_cur) ;атрибуты
  34+ 09FF CD 7C 0B     	call PageSlot3 ;включить страницу атрибутов
  35+ 0A02 AF           	xor a ;ld a,(attr_screen) ;цвет
  36+ 0A03 21 00 C0 11  	ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  36+ 0A07 01 C0 01 7F
  36+ 0A0B 3E 77
  36+ 0A0D ED B0          ldir ;очистить
  37+ 0A0F              	;call gmxscron ;включить расширенный экран
  38+ 0A0F 3A 18 2C     	ld a,(page_slot3_cur)
  39+ 0A12 C3 7C 0B     	jp PageSlot3 ;вернуть страницу
  40+ 0A15                  ;jp Memory.setPage
  41+ 0A15
  42+ 0A15
  43+ 0A15              ; Set console coordinates
  44+ 0A15              ; d = row(0..23), e = column (0..79)
  45+ 0A15              gotoXY:
  46+ 0A15              	;rr e
  47+ 0A15              	; ld a, 0
  48+ 0A15              	; ld (half_tile_screen), a
  49+ 0A15 7A           	ld a,d ;проверка координаты строки
  50+ 0A16 FE 19        	cp hsize
  51+ 0A18 D0           	ret nc
  52+ 0A19 7B           	ld a,e ;проверка координаты столбца
  53+ 0A1A FE 50        	cp 80
  54+ 0A1C D0           	ret nc
  55+ 0A1D ED 53 99 0C      ld (col_screen), de
  56+ 0A21 C9               ret
  57+ 0A22
  58+ 0A22              disable:
  59+ 0A22                  ; Nothing to disable
  60+ 0A22 CD 3A 0B     	call gmxscroff ;выключить расширенный экран
  61+ 0A25 C9               ret
  62+ 0A26
  63+ 0A26              ; H - line
  64+ 0A26              ; A - char
  65+ 0A26              fillLine: ;заполнение строки одним символом
  66+ 0A26 F5               push af
  67+ 0A27 54 1E 00         ld d, h, e, 0
  67+ 0A2A CD 15 0A       call gotoXY
  68+ 0A2D F1               pop af
  69+ 0A2E 21 9F 0C 11      ld hl, fill_buff, de, fill_buff + 1, bc, 80-1, (hl), a
  69+ 0A32 A0 0C 01 4F
  69+ 0A36 00 77
  69+ 0A38 ED B0          ldir
  70+ 0A3A 21 9F 0C         ld hl, fill_buff
  70+ 0A3D C3 80 0A       jp printZ
  71+ 0A40
  72+ 0A40              paintLine: ;на входе в A номер строки, которую надо покрасить, B - цвет
  73+ 0A40 C5           	push bc
  74+ 0A41 47               ld b, a
  75+ 0A42 0E 00            ld c, 0
  76+ 0A44 CD F0 0A         call bc_to_attr
  77+ 0A47 E5           	push hl
  78+ 0A48 3A 1C 2C     	ld a,(con_atr_cur) ;атрибуты
  79+ 0A4B CD 7C 0B     	call PageSlot3
  80+ 0A4E E1           	pop hl
  81+ 0A4F C1           	pop bc
  82+ 0A50 78           	ld a,b;цвет
  83+ 0A51 77               ld (hl), a
  84+ 0A52 54 5D            ld de, hl
  85+ 0A54 13               inc de
  86+ 0A55 01 7F 02         ld bc, (80*8)-1
  87+ 0A58 ED B0            ldir
  88+ 0A5A 3A 18 2C         ld a,(page_slot3_cur)
  89+ 0A5D C3 7C 0B     	jp PageSlot3 ;вернуть страницу
  90+ 0A60
  91+ 0A60
  92+ 0A60              mvCR ;каретка вниз (по коду 13)
  93+ 0A60 ED 5B 99 0C  	ld de, (col_screen)
  94+ 0A64 14           	inc d ;row++
  95+ 0A65 7A           	ld a,d
  96+ 0A66 FE 19        	cp hsize ;последняя строка
  97+ 0A68 38 11        	jr c,mvCR1
  98+ 0A6A 3A 1B 2C     	ld a,(con_scr_cur) ;пиксели
  99+ 0A6D CD 7C 0B     	call PageSlot3 ;включить страницу пикселей
 100+ 0A70 CD 42 0B     	call scroll
 101+ 0A73 3A 18 2C     	ld a,(page_slot3_cur)
 102+ 0A76 CD 7C 0B     	call PageSlot3 ;вернуть страницу
 103+ 0A79 16 18        	ld d,hsize-1 ;остаться на последне строке
 104+ 0A7B              mvCR1
 105+ 0A7B 1E 00        	ld e, 0
 106+ 0A7D              	; ld a, 0
 107+ 0A7D              	; ld (half_tile_screen), a
 108+ 0A7D C3 15 0A     	jp gotoXY
 109+ 0A80
 110+ 0A80              ; Print just one symbol
 111+ 0A80              ; A - symbol
 112+ 0A80              ; putC
 113+ 0A80               	; ld hl, single_symbol_print ;single_symbol
 114+ 0A80              	; ld (hl), a
 115+ 0A80              	; ;ld a, 7 : call Memory.setPage
 116+ 0A80              	; ; ld a,(con_scr_cur) ;пиксели
 117+ 0A80              	; ; call PageSlot3
 118+ 0A80                  ; ld hl, single_symbol_print
 119+ 0A80                  ; call printL
 120+ 0A80                  ; ld a,(page_slot3_cur)
 121+ 0A80              	; jp PageSlot3 ;вернуть страницу
 122+ 0A80
 123+ 0A80              ; Put string
 124+ 0A80              ; hl - string pointer that's begins from symbol count
 125+ 0A80              printZ
 126+ 0A80 7E               ld a, (hl)
 126+ 0A81 A7             and a
 126+ 0A82 C8             ret z
 127+ 0A83 E5               push hl
 128+ 0A84 CD 8B 0A         call putC
 129+ 0A87 E1               pop hl
 130+ 0A88 23               inc hl
 131+ 0A89 18 F5            jr printZ
 132+ 0A8B
 133+ 0A8B              ; printL
 134+ 0A8B                      ; ld	a, (hl)
 135+ 0A8B              		; and	a
 136+ 0A8B              		; ret	z
 137+ 0A8B              putC
 138+ 0A8B FE 0D        		cp 13
 138+ 0A8D CA 60 0A       jp z, mvCR
 139+ 0A90 FE 0A        		cp 10
 139+ 0A92 C8            ret z ;пропустить символ
 140+ 0A93
 141+ 0A93 CD EC 0A     		call calc_addr_scr
 142+ 0A96 54           		ld d,h ;координаты экрана в DE
 143+ 0A97 5D           		ld e,l
 144+ 0A98 6F           		ld	l,a
 145+ 0A99 26 00        		ld	h,0
 146+ 0A9B 29           		add	hl,hl
 147+ 0A9C 29           		add	hl,hl
 148+ 0A9D 29           		add	hl,hl
 149+ 0A9E 01 00 24             ld      bc,font
 150+ 0AA1 09                   add     hl,bc ;hl - адрес шрифта буквы
 151+ 0AA2
 152+ 0AA2                      ;push    de
 153+ 0AA2
 154+ 0AA2 3A 1B 2C     	ld a,(con_scr_cur) ;страница пиксели
 155+ 0AA5 D9           	exx
 156+ 0AA6 CD 7C 0B     	call PageSlot3
 157+ 0AA9 D9           	exx
 158+ 0AAA D5           	push de ;сохранить адрес символа на экране
 159+ 0AAB
 160+ 0AAB 01 FF 08         ld  bc,#08ff
 161+ 0AAE              print80_1
 162+ 0AAE ED A0        	ldi ;один байт
 163+ 0AB0
 164+ 0AB0 E5           	push hl ;на строку пикселей вниз
 165+ 0AB1 21 4F 00     	ld hl,80-1
 166+ 0AB4 19           	add hl,de
 167+ 0AB5 EB           	ex de,hl
 168+ 0AB6 E1           	pop hl
 169+ 0AB7
 170+ 0AB7 10 F5        	djnz    print80_1
 171+ 0AB9
 172+ 0AB9
 173+ 0AB9 3A 1C 2C     	ld a,(con_atr_cur) ;страница атрибуты
 174+ 0ABC CD 7C 0B     	call PageSlot3
 175+ 0ABF
 176+ 0ABF E1           	pop hl ;адрес символа на экране
 177+ 0AC0
 178+ 0AC0 06 08            ld      b,8
 179+ 0AC2 3A 9B 0C     	ld a,(attr_screen)
 180+ 0AC5 11 50 00     	ld de,80
 181+ 0AC8              print80_1_attr ;теперь так же атрибуты
 182+ 0AC8
 183+ 0AC8 77           	ld (hl),a
 184+ 0AC9 19           	add hl,de
 185+ 0ACA
 186+ 0ACA 10 FC        	djnz    print80_1_attr
 187+ 0ACC
 188+ 0ACC
 189+ 0ACC
 190+ 0ACC              ; move cursor на одну позицию вперёд
 191+ 0ACC              move_cr80
 192+ 0ACC              	;inc	de
 193+ 0ACC
 194+ 0ACC 21 99 0C     	ld	hl,col_screen
 195+ 0ACF 34           	inc	(hl) ;увеличить столбец
 196+ 0AD0 7E           	ld	a,(hl)
 197+ 0AD1
 198+ 0AD1 FE 50        	cp	80
 199+ 0AD3 38 10        	jr	c,move_cr80_01 ;на выход
 200+ 0AD5
 201+ 0AD5 AF           	xor	a
 202+ 0AD6              	;ld	(half_tile_screen),a
 203+ 0AD6 77           	ld	(hl),a
 204+ 0AD7              	;ld	c,a
 205+ 0AD7
 206+ 0AD7 23           	inc	hl ;на переменную row
 207+ 0AD8 34           	inc	(hl)
 208+ 0AD9 7E           	ld	a,(hl)
 209+ 0ADA              	;ld	b,a
 210+ 0ADA
 211+ 0ADA FE 19        	cp	hsize ;всего строк
 212+ 0ADC DA E5 0A     	jp	c,move_cr80_01
 213+ 0ADF
 214+ 0ADF 3E 18        	ld	a,hsize-1
 215+ 0AE1 77           	ld	(hl),a
 216+ 0AE2              	;ld	b,a
 217+ 0AE2
 218+ 0AE2 CD 42 0B     	call scroll ;сдвиг вверх
 219+ 0AE5              	; push	bc
 220+ 0AE5              	; call	scroll_up8
 221+ 0AE5              	; pop	bc
 222+ 0AE5
 223+ 0AE5              move_cr80_01
 224+ 0AE5              	; call	calc_addr_scr
 225+ 0AE5 3A 18 2C     	ld a,(page_slot3_cur)
 226+ 0AE8 C3 7C 0B     	jp PageSlot3 ;вернуть страницу
 227+ 0AEB C9           	ret
 228+ 0AEC
 229+ 0AEC              calc_addr_scr	;определение адреса экрана по координатам символа
 230+ 0AEC ED 4B 99 0C  	ld	bc,(col_screen)
 231+ 0AF0              bc_to_attr:
 232+ 0AF0 26 00        	ld h,0
 233+ 0AF2 68           	ld l,b ;строка
 234+ 0AF3 29           	add hl,hl ;*2
 235+ 0AF4 11 65 0C     	ld de,table_addr_scr
 236+ 0AF7 19           	add hl,de
 237+ 0AF8 5E           	ld e,(hl)
 238+ 0AF9 23           	inc hl
 239+ 0AFA 56           	ld d,(hl) ;узнали координаты строки
 240+ 0AFB 26 00        	ld h,0
 241+ 0AFD 69           	ld l,c ;колонка
 242+ 0AFE 19           	add hl,de ;узнали адрес символа
 243+ 0AFF
 244+ 0AFF ED 5B 6D 0B  	ld de,(curscrl) ;добавить аппаратный скрол
 245+ 0B03 19           	add hl,de
 246+ 0B04 11 80 3E     	ld de,scrsize
 247+ 0B07 A7           	and a		;check over
 248+ 0B08 ED 52        	sbc hl,de
 249+ 0B0A 30 01        	jr nc,calc02
 250+ 0B0C 19           	add hl,de
 251+ 0B0D              calc02:
 252+ 0B0D 11 00 C0     	ld de,scraddr  ;screen
 253+ 0B10 19           	add hl,de
 254+ 0B11
 255+ 0B11              	; ld      a,b
 256+ 0B11              	; ld      d,a
 257+ 0B11              	; rrca
 258+ 0B11              	; rrca
 259+ 0B11              	; rrca
 260+ 0B11              	; and     a,224
 261+ 0B11              	; add     a,c
 262+ 0B11              	; ld      e,a
 263+ 0B11              	; ld      a,d
 264+ 0B11              	; and     24
 265+ 0B11              	; or      #c0
 266+ 0B11              	; ld      d,a
 267+ 0B11 C9           	ret
 268+ 0B12
 269+ 0B12
 270+ 0B12
 271+ 0B12              clear_line ;очистить строку
 272+ 0B12                  ;ld b, hsize-1 ;последняя
 273+ 0B12                  ;ld c, 0
 274+ 0B12 CD F0 0A         call bc_to_attr ;узнать адрес
 275+ 0B15 E5           	push hl
 276+ 0B16 54           	ld d,h
 277+ 0B17 5D           	ld e,l
 278+ 0B18 13           	inc de
 279+ 0B19 01 7F 02     	ld bc,scrline-1
 280+ 0B1C 36 00        	ld (hl),0
 281+ 0B1E ED B0        	ldir
 282+ 0B20 3A 1C 2C     	ld a,(con_atr_cur) ;теперь страница атрибутов
 283+ 0B23 CD 7C 0B     	call PageSlot3 ;
 284+ 0B26 E1           	pop hl
 285+ 0B27 54           	ld d,h
 286+ 0B28 5D           	ld e,l
 287+ 0B29 13           	inc de
 288+ 0B2A 01 7F 02     	ld bc,scrline-1
 289+ 0B2D              	;ld a,(con_atr_cur) ;атрибуты
 290+ 0B2D 36 00        	ld (hl),0
 291+ 0B2F ED B0        	ldir
 292+ 0B31 C9           	ret
 293+ 0B32
 294+ 0B32              gmxscron
 295+ 0B32 01 FD 7E                 ld      bc,#7efd
 296+ 0B35 3E C8                    ld      a,#c8
 297+ 0B37 ED 79                    out     (c),a
 298+ 0B39                          ; ld      bc,#7ffd
 299+ 0B39                          ; ld      a,#10    ;5 screen
 300+ 0B39                          ; out     (c),a
 301+ 0B39 C9                       ret
 302+ 0B3A
 303+ 0B3A              ; gmxscron2
 304+ 0B3A                          ; ld      bc,#7efd
 305+ 0B3A                          ; ld      a,#c8
 306+ 0B3A                          ; out     (c),a
 307+ 0B3A                          ; ld      bc,#7ffd
 308+ 0B3A                          ; ld      a,#18    ;7 screen
 309+ 0B3A                          ; out     (c),a
 310+ 0B3A                          ; ret
 311+ 0B3A
 312+ 0B3A              gmxscroff
 313+ 0B3A 01 FD 7E                 ld      bc,#7efd
 314+ 0B3D 3E C0                    ld      a,#c0
 315+ 0B3F ED 79                    out     (c),a
 316+ 0B41                          ; ld      bc,#7ffd
 317+ 0B41                          ; ld      a,#10    ;5 screen
 318+ 0B41                          ; out     (c),a
 319+ 0B41 C9                       ret
 320+ 0B42
 321+ 0B42
 322+ 0B42
 323+ 0B42
 324+ 0B42
 325+ 0B42
 326+ 0B42              scroll: ;push hl         ; скpолл экpана на стpоку ввеpх
 327+ 0B42 2A 6D 0B     	ld hl,(curscrl)	;hard scroll
 328+ 0B45 11 80 02     	ld de,scrline
 329+ 0B48 19           	add hl,de	;next line
 330+ 0B49 11 80 3E     	ld de,scrsize	;chek over 16000
 331+ 0B4C A7           	and a
 332+ 0B4D ED 52        	sbc hl,de
 333+ 0B4F 30 03        	jr nc,scrollchek
 334+ 0B51 19           	add hl,de
 335+ 0B52 18 03        	jr scrollchek1
 336+ 0B54              scrollchek:
 337+ 0B54 21 00 00     	ld hl,0
 338+ 0B57              scrollchek1:
 339+ 0B57 22 6D 0B     	ld (curscrl),hl
 340+ 0B5A CD 64 0B     	call gmxscroll
 341+ 0B5D
 342+ 0B5D 06 18            ld b,hsize-1    ;last line
 343+ 0B5F 0E 00        	ld c,0
 344+ 0B61                  ;ld a,(attr_screen) ;цвет
 345+ 0B61 C3 12 0B         jp clear_line      ; очистка последней стpоки
 346+ 0B64                  ;ret
 347+ 0B64               ;аппаратный скрол вверх
 348+ 0B64              gmxscroll:
 349+ 0B64              ;set hard scroll
 350+ 0B64              ;in:
 351+ 0B64              ;out:
 352+ 0B64              	;push af
 353+ 0B64              	;push bc
 354+ 0B64              	;push de
 355+ 0B64 21 23 2C     	ld hl,proc_id_cur
 356+ 0B67 3A 07 2C     	ld a,(proc_id_focus)
 357+ 0B6A BE           	cp (hl)
 358+ 0B6B C0           	ret nz ;скрол меняем только когда в фокусе
 359+ 0B6C
 360+ 0B6C 11 00 00     	ld de,0
 361+ 0B6F              curscrl equ $-2 ;current hard scroll (0-15999)
 362+ 0B6F 01 FD 7A     	ld bc,07AFDh
 363+ 0B72 7B           	ld a,e
 364+ 0B73 ED 79        	out (c),a
 365+ 0B75 01 FD 7C     	ld bc,07CFDh
 366+ 0B78 7A           	ld a,d
 367+ 0B79 ED 79        	out (c),a
 368+ 0B7B              	;pop de
 369+ 0B7B              	;pop bc
 370+ 0B7B              	;pop af
 371+ 0B7B C9           	ret
 372+ 0B7C
 373+ 0B7C
 374+ 0B7C
 375+ 0B7C
 376+ 0B7C
 377+ 0B7C              PageSlot3
 378+ 0B7C              ; драйвер памяти Scorpion GMX 2Mb
 379+ 0B7C
 380+ 0B7C                       ;push hl
 381+ 0B7C                       ; ld   hl,page_table
 382+ 0B7C                       ; add  a,l
 383+ 0B7C                       ; jr   nc,PageSlot3_1
 384+ 0B7C                       ; inc  h          ;коррекция
 385+ 0B7C              ; PageSlot3_1  ld   l,a
 386+ 0B7C                       ; ld   a,(hl)
 387+ 0B7C                       ;pop  hl
 388+ 0B7C                       ;cp   #ff
 389+ 0B7C                       ;scf
 390+ 0B7C                       ;ret  z
 391+ 0B7C                       ;push bc
 392+ 0B7C F5                    push af
 393+ 0B7D 07                    rlca
 394+ 0B7E E6 10        		 and #10
 395+ 0B80 F6 01                 or  #01  ;выбор ОЗУ вместо ПЗУ
 396+ 0B82 01 FD 1F              ld   bc,#1ffd
 397+ 0B85              PageSlot3DOS
 398+ 0B85              		 ;or #00 ; #04 тут выбор ПЗУ TRDOS
 399+ 0B85 ED 79                 out  (c),a
 400+ 0B87 F1                    pop  af
 401+ 0B88 F5                    push af
 402+ 0B89 E6 07                 and  #07
 403+ 0B8B              PageSlot3Scr ;тут выбор экрана и ПЗУ
 404+ 0B8B F6 10                 or   #10 ;#0 ;#18
 405+ 0B8D 06 7F                 ld   b,#7f
 406+ 0B8F ED 79                 out  (c),a
 407+ 0B91 F1                    pop  af
 408+ 0B92 0F                    rrca
 409+ 0B93 0F                    rrca
 410+ 0B94 0F                    rrca
 411+ 0B95 0F                    rrca
 412+ 0B96 E6 07                 and  #07
 413+ 0B98 06 DF                 ld   b,#df
 414+ 0B9A ED 79                 out  (c),a
 415+ 0B9C                       ;pop  hl
 416+ 0B9C C9                    ret
 417+ 0B9D
 418+ 0B9D              set_color
 419+ 0B9D 32 9B 0C     		ld (attr_screen),a
 420+ 0BA0 78           		ld a,b
 421+ 0BA1 32 9C 0C     		ld (attr_screen2),a
 422+ 0BA4 C9           		ret
 423+ 0BA5
 424+ 0BA5              set_scr5 ;включить экран 5
 425+ 0BA5 CD 3A 0B     		call gmxscroff ;выключить расширенный
 426+ 0BA8 3E 10        		ld a,#10
 427+ 0BAA 32 8C 0B     		ld (PageSlot3Scr+1),a
 428+ 0BAD 3A 18 2C     		ld a,(page_slot3_cur)
 429+ 0BB0 C3 7C 0B     		jp PageSlot3
 430+ 0BB3
 431+ 0BB3
 432+ 0BB3              set_scr7 ;включить экран 7
 433+ 0BB3 CD 3A 0B     		call gmxscroff ;выключить расширенный
 434+ 0BB6 3E 18        		ld a,#18
 435+ 0BB8 32 8C 0B     		ld (PageSlot3Scr+1),a
 436+ 0BBB 3A 18 2C     		ld a,(page_slot3_cur)
 437+ 0BBE C3 7C 0B     		jp PageSlot3
 438+ 0BC1
 439+ 0BC1
 440+ 0BC1              set_scr39 ;включить экран 39
 441+ 0BC1 CD 32 0B     		call gmxscron ;выключить расширенный
 442+ 0BC4 3E 10        		ld a,#10
 443+ 0BC6 32 8C 0B     		ld (PageSlot3Scr+1),a
 444+ 0BC9 3A 18 2C     		ld a,(page_slot3_cur)
 445+ 0BCC C3 7C 0B     		jp PageSlot3
 446+ 0BCF
 447+ 0BCF
 448+ 0BCF              set_scr3a ;включить экран 3b
 449+ 0BCF CD 32 0B     		call gmxscron ;выключить расширенный
 450+ 0BD2 3E 18        		ld a,#18
 451+ 0BD4 32 8C 0B     		ld (PageSlot3Scr+1),a
 452+ 0BD7 3A 18 2C     		ld a,(page_slot3_cur)
 453+ 0BDA C3 7C 0B     		jp PageSlot3
 454+ 0BDD
 455+ 0BDD
 456+ 0BDD
 457+ 0BDD
 458+ 0BDD
 459+ 0BDD
 460+ 0BDD              ;Таблица страниц кроме #00-#07, #39, #3a, #77-7F
 461+ 0BDD              page_table    ;db   #00,#01,#02,#03,#04,#05,#06,#07,
 462+ 0BDD 08 09        		 db	  #08,#09
 463+ 0BDF 0A 0B 0C 0D           db   #0a,#0b,#0c,#0d,#0e
 463+ 0BE3 0E
 464+ 0BE4 0F 10 11 12           db   #0f,#10,#11,#12,#13,#14
 464+ 0BE8 13 14
 465+ 0BEA 15 16 17 18           db   #15,#16,#17,#18,#19,#1a
 465+ 0BEE 19 1A
 466+ 0BF0 1B 1C 1D 1E           db   #1b,#1c,#1d,#1e,#1f,#20
 466+ 0BF4 1F 20
 467+ 0BF6 21 22 23 24           db   #21,#22,#23,#24,#25,#26
 467+ 0BFA 25 26
 468+ 0BFC 27 28 29 2A           db   #27,#28,#29,#2a,#2b,#2c
 468+ 0C00 2B 2C
 469+ 0C02 2D 2E 2F 30           db   #2d,#2e,#2f,#30,#31,#32
 469+ 0C06 31 32
 470+ 0C08 33 34 35 36           db   #33,#34,#35,#36,#37,#38
 470+ 0C0C 37 38
 471+ 0C0E 3B 3C 3D 3E           db   #3b,#3c,#3d,#3e,#3f,#40
 471+ 0C12 3F 40
 472+ 0C14 41 42 43 44           db   #41,#42,#43,#44,#45,#46
 472+ 0C18 45 46
 473+ 0C1A 47 48 49 4A           db   #47,#48,#49,#4a,#4b,#4c
 473+ 0C1E 4B 4C
 474+ 0C20
 475+ 0C20 4D 4E 4F 50           db   #4d,#4e,#4f,#50,#51,#52
 475+ 0C24 51 52
 476+ 0C26 53 54 55 56           db   #53,#54,#55,#56,#57,#58
 476+ 0C2A 57 58
 477+ 0C2C 59 5A 5B 5C           db   #59,#5a,#5b,#5c,#5d,#5e
 477+ 0C30 5D 5E
 478+ 0C32 5F 60 61 62           db   #5f,#60,#61,#62,#63,#64
 478+ 0C36 63 64
 479+ 0C38 65 66 67 68           db   #65,#66,#67,#68,#69,#6a
 479+ 0C3C 69 6A
 480+ 0C3E 6B 6C 6D 6E           db   #6b,#6c,#6d,#6e,#6f,#70
 480+ 0C42 6F 70
 481+ 0C44 71 72 73 74           db   #71,#72,#73,#74,#75,#76
 481+ 0C48 75 76
 482+ 0C4A                       ;db   #77,#78,#79,#7a,#7b,#7c,#7d,#7e
 483+ 0C4A                       ;db   #7f
 484+ 0C4A              page_table_end
 485+ 0C4A 00 00 00...           ds 128-(page_table_end-page_table) ;забить остаток нулями
 486+ 0C5D
 487+ 0C5D
 488+ 0C5D
 489+ 0C5D              ;font equ #4000 ; Using ZX-Spectrum screen as font buffer
 490+ 0C5D              ;font_file db "data/font.bin", 0
 491+ 0C5D
 492+ 0C5D              PageSlot2 ;включение банка из A в слот памяти 2
 493+ 0C5D EE 02        	xor 2
 494+ 0C5F 01 FD 78     	ld bc,#78fd
 495+ 0C62 ED 79        	out (c),a
 496+ 0C64 C9           	ret
 497+ 0C65
 498+ 0C65
 499+ 0C65              table_addr_scr	;адреса строк текста
 500+ 0C65 00 00        	defw	00000h ;0
 501+ 0C67 80 02        	defw	00280h
 502+ 0C69 00 05        	defw	00500h
 503+ 0C6B 80 07        	defw	00780h
 504+ 0C6D 00 0A        	defw	00a00h
 505+ 0C6F 80 0C        	defw	00c80h
 506+ 0C71 00 0F        	defw	00f00h
 507+ 0C73 80 11        	defw	01180h
 508+ 0C75
 509+ 0C75 00 14        	defw	01400h ;8
 510+ 0C77 80 16        	defw	01680h
 511+ 0C79 00 19        	defw	01900h
 512+ 0C7B 80 1B        	defw	01b80h
 513+ 0C7D 00 1E        	defw	01e00h
 514+ 0C7F 80 20        	defw	02080h
 515+ 0C81 00 23        	defw	02300h
 516+ 0C83 80 25        	defw	02580h
 517+ 0C85
 518+ 0C85 00 28        	defw	02800h ;16
 519+ 0C87 80 2A        	defw	02a80h
 520+ 0C89 00 2D        	defw	02d00h
 521+ 0C8B 80 2F        	defw	02f80h
 522+ 0C8D 00 32        	defw	03200h
 523+ 0C8F 80 34        	defw	03480h
 524+ 0C91 00 37        	defw	03700h
 525+ 0C93 80 39        	defw	03980h
 526+ 0C95
 527+ 0C95 00 3C        	defw	03c00h ;24
 528+ 0C97 80 3E        	defw	03e80h ;25 вне экрана
 529+ 0C99
 530+ 0C99
 531+ 0C99 00           col_screen			db	0	;столбец
 532+ 0C9A 00           row_screen			db	0	;строка
 533+ 0C9B              ;half_tile_screen	db	0
 534+ 0C9B 07           attr_screen			db	07	;основной цвет
 535+ 0C9C 0C           attr_screen2		db	#c	;второй цвет
 536+ 0C9D
 537+ 0C9D
 538+ 0C9D              ;col_screen_temp			dw	0
 539+ 0C9D              ;half_tile_screen_temp	db	0
 540+ 0C9D
 541+ 0C9D 01           single_symbol_print db 1
 542+ 0C9E 00           single_symbol 		db 0
 543+ 0C9F
 544+ 0C9F 00 00 00...  fill_buff ds 80+1
 545+ 0CF0
 546+ 0CF0                  endmodule
# file closed: Drv/zsgmx.asm
2586  0CF0              	include Drv/zsfat.asm ;драйвер диска
# file opened: Drv/zsfat.asm
   1+ 0CF0              ;trdos & fat32 driver (izzx)
   2+ 0CF0                  MODULE Dos
   3+ 0CF0              ; API methods - для всех процессов
   4+ 0CF0              ;ESX_GETSETDRV = #89
   5+ 0CF0              ;ESX_FOPEN = #9A
   6+ 0CF0              ;ESX_FCLOSE = #9B
   7+ 0CF0              ;ESX_FSYNC = #9C
   8+ 0CF0              ;ESX_FREAD = #9D
   9+ 0CF0              ;ESX_FWRITE = #9E
  10+ 0CF0
  11+ 0CF0              ; File modes
  12+ 0CF0              FMODE_READ = #01
  13+ 0CF0              ;FMODE_WRITE = #06
  14+ 0CF0              FMODE_CREATE = #0E
  15+ 0CF0
  16+ 0CF0                  ; MACRO esxCall func
  17+ 0CF0                  ; rst #8 : db func
  18+ 0CF0                  ; ENDM
  19+ 0CF0
  20+ 0CF0              ;макросы только для внутренней работы самого модуля через BIOS
  21+ 0CF0              ;
  22+ 0CF0              ;R8DOS			вызов функции R8DOS
  23+ 0CF0              ;R8FAT			вызов функции R8FAT
  24+ 0CF0              ;R8DOSc			вызов функции R8DOS
  25+ 0CF0              ;
  26+ 0CF0              ;------------------------------------------------------------------------------
  27+ 0CF0              ;вызов функции R8DOS
  28+ 0CF0              ;вх: =0 номер функции
  29+ 0CF0              ;
  30+ 0CF0              	MACRO	R8DOS nFunc
  31+ 0CF0 ~            	ld	c,nFunc
  32+ 0CF0 ~            	rst	#08
  33+ 0CF0 ~            	db	#81
  34+ 0CF0              	ENDM
  35+ 0CF0
  36+ 0CF0              ;------------------------------------------------------------------------------
  37+ 0CF0              ;вызов функции R8FAT
  38+ 0CF0              ;вх: =0 номер функции
  39+ 0CF0              ;
  40+ 0CF0              	MACRO	R8FAT nFunc
  41+ 0CF0 ~            	ld	c,nFunc
  42+ 0CF0 ~            	rst	#08
  43+ 0CF0 ~            	db	#91
  44+ 0CF0              	ENDM
  45+ 0CF0
  46+ 0CF0              ;------------------------------------------------------------------------------
  47+ 0CF0              ;вызов функции R8DOS
  48+ 0CF0              ;вх: c - номер функции
  49+ 0CF0              ;
  50+ 0CF0              	MACRO	R8DOSc
  51+ 0CF0 ~            	rst	#08
  52+ 0CF0 ~            	db	#81
  53+ 0CF0              	ENDM
  54+ 0CF0
  55+ 0CF0              ;------------------------------------------------------------------------------
  56+ 0CF0              ;вызов функции #02 (FileMan) R8CONF
  57+ 0CF0              ;вх: =#00 - номер функции файл менеджера
  58+ 0CF0              ;
  59+ 0CF0              	MACRO	R8C02FM nFunct
  60+ 0CF0 ~            	ld	bc,#100*nFunct+#02
  61+ 0CF0 ~            	rst	#08
  62+ 0CF0 ~            	db	#8E
  63+ 0CF0              	ENDM
  64+ 0CF0
  65+ 0CF0              ;==============================================================================
  66+ 0CF0              r8f00_DeinitFAT		equ #00 ;деинициализация переменных раздела FAT
  67+ 0CF0              r8f01_InitFAT		equ #01 ;инициализация переменных раздела FAT, если он еще не инициализирован
  68+ 0CF0              r8f02_ReadDIR		equ #02 ;чтение секторов текущего каталога
  69+ 0CF0              r8f03_SetRoot		equ #03 ;установка корневого каталога текущим
  70+ 0CF0              r8f04_FindPath		equ #04 ;поиск файла по заданному пути в текущем каталоге со входом в подкаталоги с проверкой синтаксиса (с установкой найденного каталога текущим)
  71+ 0CF0              r8f05_OpenDir		equ #05 ;вход в каталог/выход в родительский каталог
  72+ 0CF0
  73+ 0CF0              r8f07_FileOpen		equ #07 ;открыть файл для последующих операций с ним
  74+ 0CF0              r8f08_FileRead		equ #08	;чтение данных из файла в память
  75+ 0CF0              r8f09_FileWrite		equ #09	;запись данных из памяти в файл
  76+ 0CF0
  77+ 0CF0              r8f0E_CreateFileLFN	equ #0E ;создание файла с длинным именем в текущем каталоге
  78+ 0CF0              r8f0F_CreateFileSFN	equ #0F ;создание файла с именем 8+3 в текущем каталоге	в fcb должны быть установлены: fcbName, fcbExt, fcbSize
  79+ 0CF0              r8f13_GetPath 		equ #13 ;получение текущего пути
  80+ 0CF0              r8f14_GetLFN		equ #14 ;получение длинного имени файла
  81+ 0CF0
  82+ 0CF0              r8d2D_FindPart		equ #2D ;поиск разделов FAT32 и MFS на текущем винчестере
  83+ 0CF0              r8d2E_CngHDD		equ #2E ;смена текущего винчестера
  84+ 0CF0
  85+ 0CF0              ;конец макросов BIOS
  86+ 0CF0
  87+ 0CF0              files_fat_max equ 8 ;максимальное число открытых файлов fat
  88+ 0CF0              files_trd_max equ 8 ;максимальное число открытых файлов trd
  89+ 0CF0              fcb_fat_size equ 32 ;размер дискриптора fcb
  90+ 0CF0
  91+ 0CF0
  92+ 0CF0
  93+ 0CF0              ; Returns:
  94+ 0CF0              ;  A - current drive
  95+ 0CF0              ; getDefaultDrive: ;нигде не используется
  96+ 0CF0                  ; ld a, 0 : esxCall ESX_GETSETDRV
  97+ 0CF0                  ; ret
  98+ 0CF0
  99+ 0CF0
 100+ 0CF0
 101+ 0CF0              ; Opens file on default drive
 102+ 0CF0              ; B - File mode
 103+ 0CF0              ; HL - File name
 104+ 0CF0              ; Returns:
 105+ 0CF0              ;  A - file stream id
 106+ 0CF0              ; DE, HL - File size
 107+ 0CF0              ; IX - fcb
 108+ 0CF0              ; fopen:
 109+ 0CF0                  ; ; push bc : push hl
 110+ 0CF0                  ; ; call getDefaultDrive
 111+ 0CF0                  ; ; pop ix : pop bc
 112+ 0CF0                  ; ; esxCall ESX_FOPEN
 113+ 0CF0                  ; ; ret
 114+ 0CF0              	; ld a,b
 115+ 0CF0              	; cp FMODE_READ ;если режим открытие файла
 116+ 0CF0              	; jr z,fopen_r
 117+ 0CF0              	; cp FMODE_CREATE
 118+ 0CF0              	; jr z,fopen_c ;если режим создание файла
 119+ 0CF0              	; jp file_error ;иначе выход
 120+ 0CF0
 121+ 0CF0
 122+ 0CF0              fopen_r	;открытие существующего файла на чтение
 123+ 0CF0
 124+ 0CF0 CD 1C 0D     	call fopen_prep
 125+ 0CF3 DA 1D 0E     	jp 	c,file_error
 126+ 0CF6
 127+ 0CF6 32 06 10     	ld (file_fat_id_cur),a
 128+ 0CF9
 129+ 0CF9              	;сначала сделаем текущей папку активного приложения
 130+ 0CF9 CD 5E 0F     	call restore_path
 131+ 0CFC
 132+ 0CFC              	;ld a,(file_fat_id_cur)
 133+ 0CFC              	R8FAT r8f07_FileOpen ;открыть
 133+ 0CFC 0E 07       >	ld	c,r8f07_FileOpen
 133+ 0CFE CF          >	rst	#08
 133+ 0CFF 91          >	db	#91
 134+ 0D00 DA 1D 0E     	jp 	c,file_error
 135+ 0D03
 136+ 0D03
 137+ 0D03 C3 29 0D     	jp fopen_ex
 138+ 0D06
 139+ 0D06
 140+ 0D06              fopen_c	;создание нового файла
 141+ 0D06
 142+ 0D06 CD 1C 0D     	call fopen_prep
 143+ 0D09 DA 1D 0E     	jp 	c,file_error
 144+ 0D0C
 145+ 0D0C
 146+ 0D0C 32 06 10     	ld (file_fat_id_cur),a
 147+ 0D0F
 148+ 0D0F              	;сначала сделаем текущей папку активного приложения
 149+ 0D0F CD 5E 0F     	call restore_path
 150+ 0D12
 151+ 0D12              	;ld a,(file_fat_id_cur)
 152+ 0D12              	R8FAT	r8f0E_CreateFileLFN	;создание файла
 152+ 0D12 0E 0E       >	ld	c,r8f0E_CreateFileLFN
 152+ 0D14 CF          >	rst	#08
 152+ 0D15 91          >	db	#91
 153+ 0D16 DA 1D 0E     	jp 	c,file_error
 154+ 0D19
 155+ 0D19 C3 29 0D     	jp fopen_ex
 156+ 0D1C
 157+ 0D1C
 158+ 0D1C              fopen_prep ;проверка перед открытием файла
 159+ 0D1C 3A B2 10     	ld a,(fs_fat_init_flag)
 160+ 0D1F B7           	or a
 161+ 0D20 37           	scf
 162+ 0D21 C8           	ret z
 163+ 0D22
 164+ 0D22 E5           	push hl
 165+ 0D23 CD CC 0F     	call find_empty_fcb_fat ;какой fcb свободен?
 166+ 0D26 EB           	ex de,hl ;fcb in de
 167+ 0D27 E1           	pop hl
 168+ 0D28 C9           	ret ;выйти с флагом
 169+ 0D29
 170+ 0D29
 171+ 0D29              fopen_ex
 172+ 0D29              	;успешно создали/открыли
 173+ 0D29 D5           	push de
 174+ 0D2A DD E1        	pop ix ;вернуть fcb
 175+ 0D2C 21 F6 11     	ld hl,fcb_fat_table
 176+ 0D2F 3A 06 10     	ld a,(file_fat_id_cur)
 177+ 0D32 4F           	ld c,a
 178+ 0D33 06 00        	ld b,0
 179+ 0D35 09           	add hl,bc
 180+ 0D36 3A 23 2C     	ld a,(proc_id_cur)
 181+ 0D39 77           	ld (hl),a ;флаг что файл открыт (id текущего процесса)
 182+ 0D3A
 183+ 0D3A              	;вернуть размер файла
 184+ 0D3A DD 6E 14     	ld	l,(ix+#14) ;младшие байты длины
 185+ 0D3D DD 66 15     	ld	h,(ix+#15)
 186+ 0D40
 187+ 0D40 DD 5E 16     	ld	e,(ix+#16) ;старшие байты длины
 188+ 0D43 DD 56 17     	ld  d,(ix+#17)
 189+ 0D46
 190+ 0D46 3A 06 10     	ld a,(file_fat_id_cur) ;вернуть id
 191+ 0D49 B7           	or a
 192+ 0D4A C9           	ret
 193+ 0D4B
 194+ 0D4B
 195+ 0D4B
 196+ 0D4B
 197+ 0D4B              init_fs_fat	;инициализация файловой системы
 198+ 0D4B              	; ld a,(fs_fat_init_flag) ;если в первый раз
 199+ 0D4B              	; or a
 200+ 0D4B              	; jr nz,init_fs_fat2
 201+ 0D4B AF           	xor a
 202+ 0D4C 32 B2 10     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 203+ 0D4F 3E 04        	ld a,4 ;номер дисковода по умолчанию E
 204+ 0D51 32 6F 0F     	ld (fs_drive_number_cur),a
 205+ 0D54 CD 7F 0F     	call GetNumPart ;узнаем какая буква последняя, сколько разделов FAT
 206+ 0D57 30 0B        	jr nc,init_fs_fat_prn2
 207+ 0D59 B7           	or a
 208+ 0D5A 20 08        	jr nz,init_fs_fat_prn2
 209+ 0D5C 21 28 10     	ld hl,msg_fat_not_found
 210+ 0D5F CD 80 0A     	call drvgmx.printZ
 211+ 0D62 37           	scf ;ошибка
 212+ 0D63 C9           	ret
 213+ 0D64
 214+ 0D64
 215+ 0D64              init_fs_fat_prn2
 216+ 0D64              	;печать списка разделов
 217+ 0D64 21 08 10     	ld hl,msg_fat_found
 218+ 0D67 CD 80 0A     	call drvgmx.printZ
 219+ 0D6A 21 70 0F     	ld hl,typeDrive
 220+ 0D6D 3A 7D 0F     	ld a,(numDrives)
 221+ 0D70 47           	ld b,a ;цикл по количеству разделов
 222+ 0D71 0E 45        	ld c,"E" ;первая буква диска FAT
 223+ 0D73              init_fs_fat_prn1
 224+ 0D73 C5           	push bc
 225+ 0D74 E5           	push hl
 226+ 0D75 79           	ld a,c ;имя диска
 227+ 0D76 CD 8B 0A     	call drvgmx.putC
 228+ 0D79 3E 3A        	ld a,":" ;
 229+ 0D7B CD 8B 0A     	call drvgmx.putC
 230+ 0D7E              	;тип S или H
 231+ 0D7E 3E 48        	ld a,"H"
 232+ 0D80 E1           	pop hl
 233+ 0D81 E5           	push hl
 234+ 0D82 CB 5E        	bit 3,(hl) ;SD?
 235+ 0D84 28 02        	jr z,init_fs_fat_prn3
 236+ 0D86 3E 53        	ld a,"S"
 237+ 0D88              init_fs_fat_prn3
 238+ 0D88 CD 8B 0A     	call drvgmx.putC ;первая буква
 239+ 0D8B 3E 44        	ld a,"D"
 240+ 0D8D CD 8B 0A     	call drvgmx.putC ;вторая буква
 241+ 0D90              	;номер диска
 242+ 0D90 E1           	pop hl
 243+ 0D91 E5           	push hl
 244+ 0D92 7E           	ld a,(hl)
 245+ 0D93 E6 04        	and %00000100
 246+ 0D95 0F           	rrca
 247+ 0D96 0F           	rrca
 248+ 0D97 C6 30        	add "0"
 249+ 0D99 CD 8B 0A     	call drvgmx.putC ;номер диска
 250+ 0D9C              	;номер раздела
 251+ 0D9C 3E 2C        	ld a,","
 252+ 0D9E CD 8B 0A     	call drvgmx.putC ;разделитель
 253+ 0DA1 E1           	pop hl
 254+ 0DA2 E5           	push hl
 255+ 0DA3 7E           	ld a,(hl)
 256+ 0DA4 E6 03        	and %00000011
 257+ 0DA6 C6 30        	add "0"
 258+ 0DA8 CD 8B 0A     	call drvgmx.putC ;номер раздела
 259+ 0DAB 3E 0D        	ld a,13 ;новая строка
 260+ 0DAD CD 8B 0A     	call drvgmx.putC
 261+ 0DB0 E1           	pop hl
 262+ 0DB1 23           	inc hl
 263+ 0DB2 C1           	pop bc
 264+ 0DB3 0C           	inc c
 265+ 0DB4 10 BD        	djnz init_fs_fat_prn1
 266+ 0DB6
 267+ 0DB6
 268+ 0DB6              	;поиск системы и выбор диска
 269+ 0DB6 3A 7D 0F     	ld a,(numDrives)
 270+ 0DB9 DD 6F        	ld ixl,a ;цикл по количеству разделов
 271+ 0DBB 3A 6F 0F     	ld a,(fs_drive_number_cur)
 272+ 0DBE              init_fs_fat_find_os_cl
 273+ 0DBE 01 6C 0F     	ld bc,typeDrive-4
 274+ 0DC1 6F           	ld l,a
 275+ 0DC2 26 00        	ld h,0
 276+ 0DC4 09           	add hl,bc
 277+ 0DC5 7E           	ld a,(hl) ;получили код раздела из списка
 278+ 0DC6
 279+ 0DC6 CD FD 0D     	call init_fs_fat_warm ;выбрать раздел
 280+ 0DC9 D8           	ret c
 281+ 0DCA
 282+ 0DCA              	;поиск пути в разделе
 283+ 0DCA 21 B3 10     	ld	hl,OS_PathFAT		;путь к каталогу системы
 284+ 0DCD 11 C6 10     	ld	de,dir_fat_deskr ;будет дескриптор системной папки
 285+ 0DD0 AF           	xor	a
 286+ 0DD1 3D           	dec	a ;установить текущим
 287+ 0DD2              	R8FAT	r8f04_FindPath
 287+ 0DD2 0E 04       >	ld	c,r8f04_FindPath
 287+ 0DD4 CF          >	rst	#08
 287+ 0DD5 91          >	db	#91
 288+ 0DD6 30 10        	jr nc,init_fs_fat_find_os_ok
 289+ 0DD8
 290+ 0DD8 3A 6F 0F     	ld a,(fs_drive_number_cur)
 291+ 0DDB 3C           	inc a
 292+ 0DDC 32 6F 0F     	ld (fs_drive_number_cur),a
 293+ 0DDF DD 2D        	dec ixl
 294+ 0DE1 20 DB        	jr nz,init_fs_fat_find_os_cl
 295+ 0DE3
 296+ 0DE3
 297+ 0DE3              	;не нашли ОС
 298+ 0DE3 CD 2D 0E         call   file_error_print_dir_not_found ;если не нашли, файл будет в корне
 299+ 0DE6 37           	scf
 300+ 0DE7 C9           	ret
 301+ 0DE8              init_fs_fat_find_os_ok
 302+ 0DE8              	;нашли раздел с ОС
 303+ 0DE8 21 15 10     	ld hl,msg_fat_found_os
 304+ 0DEB CD 80 0A     	call drvgmx.printZ
 305+ 0DEE 3A 6F 0F     	ld a,(fs_drive_number_cur)
 306+ 0DF1 C6 41        	add a,"A"
 307+ 0DF3 CD 8B 0A     	call drvgmx.putC
 308+ 0DF6 3E 0D        	ld a,13
 309+ 0DF8 CD 8B 0A     	call drvgmx.putC
 310+ 0DFB B7           	or a
 311+ 0DFC C9           	ret
 312+ 0DFD
 313+ 0DFD
 314+ 0DFD              init_fs_fat_warm
 315+ 0DFD              ;переинициализация FAT раздела, когда разделы-диски уже найдены
 316+ 0DFD              ;вх: a - код раздела
 317+ 0DFD 32 07 10     	ld (fs_fat_part_code_cur),a ;запомнить текущий раздел
 318+ 0E00 AF           	xor a
 319+ 0E01 32 B2 10     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 320+ 0E04 3A 07 10     	ld a,(fs_fat_part_code_cur)
 321+ 0E07
 322+ 0E07              	; R8FAT	r8f00_DeinitFAT
 323+ 0E07              	; jp 		c,file_error
 324+ 0E07
 325+ 0E07
 326+ 0E07              	R8FAT	r8f01_InitFAT ;инициализация
 326+ 0E07 0E 01       >	ld	c,r8f01_InitFAT
 326+ 0E09 CF          >	rst	#08
 326+ 0E0A 91          >	db	#91
 327+ 0E0B D2 16 0E         jp      nc,init_fs_fat3
 328+ 0E0E 21 38 10     	ld hl,msg_fat_init_error
 329+ 0E11 CD 80 0A     	call drvgmx.printZ
 330+ 0E14 37           	scf
 331+ 0E15 C9           	ret
 332+ 0E16
 333+ 0E16              init_fs_fat3
 334+ 0E16
 335+ 0E16
 336+ 0E16              ;получить текущий путь
 337+ 0E16              	; ld	hl,#4000		;адрес буфера для размещения текущего пути (256 байт)
 338+ 0E16              	; R8FAT	r8f13_GetPath ;получить путь
 339+ 0E16
 340+ 0E16              ;init_fs_fat_ex ;выход
 341+ 0E16 3E 01        	ld a,1
 342+ 0E18 32 B2 10     	ld (fs_fat_init_flag),a
 343+ 0E1B B7           	or a
 344+ 0E1C C9           	ret
 345+ 0E1D
 346+ 0E1D
 347+ 0E1D
 348+ 0E1D
 349+ 0E1D
 350+ 0E1D
 351+ 0E1D              file_error ;выход с ошибкой
 352+ 0E1D 11 00 00     	ld de,0
 353+ 0E20 01 00 00     	ld bc,0 ;длина 0
 354+ 0E23 37           	scf ;ошибка
 355+ 0E24 C9           	ret
 356+ 0E25
 357+ 0E25              file_error_general_print ;выход с общей ошибкой и сообщением
 358+ 0E25 21 49 10     	ld hl,msg_file_error_general
 359+ 0E28 CD 80 0A     	call drvgmx.printZ
 360+ 0E2B 37           	scf ;ошибка
 361+ 0E2C C9           	ret
 362+ 0E2D
 363+ 0E2D              file_error_print_dir_not_found ;выход с ошибкой и сообщением
 364+ 0E2D 21 9A 10     	ld hl,msg_dir_not_found
 365+ 0E30 CD 80 0A     	call drvgmx.printZ
 366+ 0E33 37           	scf ;ошибка
 367+ 0E34 C9           	ret
 368+ 0E35
 369+ 0E35              file_error_print_file_too_big ;выход с ошибкой и сообщением
 370+ 0E35 21 56 10     	ld hl,msg_file_too_big
 371+ 0E38 CD 80 0A     	call drvgmx.printZ
 372+ 0E3B 37           	scf ;ошибка
 373+ 0E3C C9           	ret
 374+ 0E3D
 375+ 0E3D              file_error_print_file_not_found ;выход с ошибкой и сообщением
 376+ 0E3D 21 65 10     	ld hl,msg_file_not_found
 377+ 0E40 CD 80 0A     	call drvgmx.printZ
 378+ 0E43 37           	scf ;ошибка
 379+ 0E44 C9           	ret
 380+ 0E45
 381+ 0E45              file_error_print_file_open_error ;выход с ошибкой и сообщением
 382+ 0E45 21 76 10     	ld hl,msg_file_open_error
 383+ 0E48 CD 80 0A     	call drvgmx.printZ
 384+ 0E4B 37           	scf ;ошибка
 385+ 0E4C C9           	ret
 386+ 0E4D
 387+ 0E4D              file_error_print_file_read_error ;выход с ошибкой и сообщением
 388+ 0E4D 21 88 10     	ld hl,msg_file_read_error
 389+ 0E50 CD 80 0A     	call drvgmx.printZ
 390+ 0E53 37           	scf ;ошибка
 391+ 0E54 C9           	ret
 392+ 0E55
 393+ 0E55
 394+ 0E55
 395+ 0E55
 396+ 0E55              ; A - file stream id
 397+ 0E55              fclose:
 398+ 0E55                  ;esxCall ESX_FCLOSE
 399+ 0E55              	; push af
 400+ 0E55              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 401+ 0E55              	; pop af
 402+ 0E55              	; cp 2 ;если обычный файл
 403+ 0E55              	; jp nz,fclose_scl
 404+ 0E55
 405+ 0E55              close_fcb_fat ;закрытие fcb файла по номеру
 406+ 0E55              ;вх: a - id файла
 407+ 0E55              	;выход hl - fcb;
 408+ 0E55 21 14 12     	ld hl,fcb_fat
 409+ 0E58 B7           	or a
 410+ 0E59 28 07        	jr z,close_fcb_fat_ex
 411+ 0E5B 47           	ld b,a
 412+ 0E5C 11 20 00     	ld de,fcb_fat_size
 413+ 0E5F              close_fcb_fat_cl
 414+ 0E5F              	;вычислить адрес fcb
 415+ 0E5F 19           	add hl,de
 416+ 0E60 10 FD        	djnz close_fcb_fat_cl
 417+ 0E62              close_fcb_fat_ex
 418+ 0E62 E5           	push hl
 419+ 0E63 54           	ld d,h ;почистить fcb
 420+ 0E64 5D           	ld e,l
 421+ 0E65 13           	inc de
 422+ 0E66 01 1F 00     	ld bc,fcb_fat_size-1
 423+ 0E69 36 00        	ld (hl),0
 424+ 0E6B ED B0        	ldir
 425+ 0E6D 21 F6 11     	ld hl,fcb_fat_table
 426+ 0E70 4F           	ld c,a
 427+ 0E71 06 00        	ld b,0
 428+ 0E73 09           	add hl,bc
 429+ 0E74 36 00        	ld (hl),0 ;и флаг открытия fcb_fat_table
 430+ 0E76 E1           	pop hl
 431+ 0E77 C9           	ret
 432+ 0E78
 433+ 0E78
 434+ 0E78
 435+ 0E78              ;закрытие всех файлов процесса
 436+ 0E78              ;вх: A - id процесса
 437+ 0E78              fclose_proc_all
 438+ 0E78 21 F6 11     	ld hl,fcb_fat_table
 439+ 0E7B 06 08        	ld b,files_fat_max
 440+ 0E7D 0E 00        	ld c,0 ;id файла
 441+ 0E7F              fclose_proc_all_cl
 442+ 0E7F BE           	cp (hl) ;совпадает с id процесса?
 443+ 0E80 20 08        	jr nz,fclose_proc_all_skip
 444+ 0E82 F5           	push af
 445+ 0E83 79           	ld a,c ;id файла
 446+ 0E84 D9           	exx
 447+ 0E85 CD 55 0E     	call close_fcb_fat ;закрыть
 448+ 0E88 D9           	exx
 449+ 0E89 F1           	pop af
 450+ 0E8A              fclose_proc_all_skip
 451+ 0E8A 23           	inc hl
 452+ 0E8B 0C           	inc c
 453+ 0E8C 10 F1        	djnz fclose_proc_all_cl
 454+ 0E8E C9           	ret
 455+ 0E8F
 456+ 0E8F
 457+ 0E8F
 458+ 0E8F
 459+ 0E8F
 460+ 0E8F
 461+ 0E8F              ; A - file stream id
 462+ 0E8F              ; DE - length
 463+ 0E8F              ; HL - buffer
 464+ 0E8F              ; Returns
 465+ 0E8F              ;  BC - length(how much was actually read)
 466+ 0E8F              fread: ;(id=1)
 467+ 0E8F                  ; push hl : pop ix
 468+ 0E8F                  ; esxCall ESX_FREAD
 469+ 0E8F
 470+ 0E8F ED 53 B0 10  	ld (file_size_tmp),de
 471+ 0E93
 472+ 0E93 CD BF 0E     	call file_check_act ;проверка
 473+ 0E96 DA 1D 0E     	jp c,file_error
 474+ 0E99
 475+ 0E99 ED 4B B0 10  	ld bc,(file_size_tmp) ;размер
 476+ 0E9D 79           	ld a,c ;ba - количество байт для чтения
 477+ 0E9E
 478+ 0E9E              	R8FAT r8f08_FileRead	;читать файл
 478+ 0E9E 0E 08       >	ld	c,r8f08_FileRead
 478+ 0EA0 CF          >	rst	#08
 478+ 0EA1 91          >	db	#91
 479+ 0EA2 DA 1D 0E     	jp c,file_error
 480+ 0EA5
 481+ 0EA5              	;ld bc,(file_size_tmp) ;размер
 482+ 0EA5 B7           	or a
 483+ 0EA6 C9           	ret
 484+ 0EA7
 485+ 0EA7
 486+ 0EA7              ; A - file stream id
 487+ 0EA7              ; DE - length
 488+ 0EA7              ; HL - buffer
 489+ 0EA7              ; Returns:
 490+ 0EA7              ;   BC - actually written bytes
 491+ 0EA7              fwrite: ;
 492+ 0EA7                  ; push hl : pop ix
 493+ 0EA7                  ; esxCall ESX_FWRITE
 494+ 0EA7
 495+ 0EA7               ;запись файла fat
 496+ 0EA7 ED 53 B0 10   	ld (file_size_tmp),de
 497+ 0EAB
 498+ 0EAB CD BF 0E     	call file_check_act ;проверка
 499+ 0EAE DA 1D 0E     	jp c,file_error
 500+ 0EB1
 501+ 0EB1 ED 4B B0 10  	ld bc,(file_size_tmp) ;размер
 502+ 0EB5 79           	ld a,c ;ba - количество байт для записи
 503+ 0EB6
 504+ 0EB6              	R8FAT r8f09_FileWrite	;записать в файл
 504+ 0EB6 0E 09       >	ld	c,r8f09_FileWrite
 504+ 0EB8 CF          >	rst	#08
 504+ 0EB9 91          >	db	#91
 505+ 0EBA DA 1D 0E     	jp c,file_error
 506+ 0EBD
 507+ 0EBD              	;ld bc,(file_size_tmp) ;размер
 508+ 0EBD B7           	or a
 509+ 0EBE C9           	ret
 510+ 0EBF              ;---------------------------------------
 511+ 0EBF
 512+ 0EBF              file_check_act
 513+ 0EBF              ;проверка файла на актуальность
 514+ 0EBF              ;вых: A - id, DE - fcb
 515+ 0EBF 32 06 10     	ld (file_fat_id_cur),a ;сохранить id
 516+ 0EC2
 517+ 0EC2 3A B2 10     	ld a,(fs_fat_init_flag)
 518+ 0EC5 B7           	or a
 519+ 0EC6 37           	scf
 520+ 0EC7 C8           	ret z ;выход если не инициализирована ФС
 521+ 0EC8
 522+ 0EC8 E5           	push hl
 523+ 0EC9 C5           	push bc
 524+ 0ECA 3A 06 10     	ld a,(file_fat_id_cur)
 525+ 0ECD CD EE 0F     	call find_fcb_fat ;найти fcb
 526+ 0ED0 EB           	ex de,hl ;fcb в de
 527+ 0ED1 D5           	push de
 528+ 0ED2 DD E1        	pop ix ;fcb
 529+ 0ED4 C1           	pop bc
 530+ 0ED5 21 23 2C     	ld hl,proc_id_cur ;сравнить с кодом текущего процесса, чтобы имел доступ только к своему файлу
 531+ 0ED8 BE           	cp (hl)
 532+ 0ED9 E1           	pop hl
 533+ 0EDA 37           	scf
 534+ 0EDB C0           	ret nz
 535+ 0EDC
 536+ 0EDC B7           	or a
 537+ 0EDD 37           	scf
 538+ 0EDE C8           	ret z ;выход если файл не открыт
 539+ 0EDF
 540+ 0EDF
 541+ 0EDF
 542+ 0EDF 3A 07 10     	ld a,(fs_fat_part_code_cur) ;сравнить какой раздел у файла и какой активный
 543+ 0EE2 DD BE 1F     	cp (ix+#1f)
 544+ 0EE5 C4 FD 0D     	call nz,init_fs_fat_warm ;переинициировать
 545+ 0EE8 C9           	ret
 546+ 0EE9
 547+ 0EE9
 548+ 0EE9
 549+ 0EE9              ;чтение секторов текущего каталога
 550+ 0EE9              ; вх:
 551+ 0EE9                   ; hl - буфер для чтения
 552+ 0EE9                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 553+ 0EE9                   ; b - максимальное количество секторов для чтения
 554+ 0EE9              read_dir
 555+ 0EE9              	;сначала сделаем текущей папку активного приложения
 556+ 0EE9 CD 5E 0F     	call restore_path
 557+ 0EEC
 558+ 0EEC              	;теперь запрос
 559+ 0EEC              	R8FAT r8f02_ReadDIR	;читать
 559+ 0EEC 0E 02       >	ld	c,r8f02_ReadDIR
 559+ 0EEE CF          >	rst	#08
 559+ 0EEF 91          >	db	#91
 560+ 0EF0 C9               ret
 561+ 0EF1
 562+ 0EF1
 563+ 0EF1
 564+ 0EF1              ;вход в каталог/выход в родительский каталог
 565+ 0EF1              ; вх: hl - адрес пути (=#0000 - путь отсутствует)
 566+ 0EF1              ; de - адрес дескриптора директории/файла
 567+ 0EF1              ; вых: a - если путь был указан, новая длина пути
 568+ 0EF1              open_dir
 569+ 0EF1 D5           	push de ;дескриптор
 570+ 0EF2
 571+ 0EF2              	R8FAT r8f05_OpenDir	;открыть
 571+ 0EF2 0E 05       >	ld	c,r8f05_OpenDir
 571+ 0EF4 CF          >	rst	#08
 571+ 0EF5 91          >	db	#91
 572+ 0EF6
 573+ 0EF6              	;скопировать дескриптор приложения
 574+ 0EF6 F5           	push af
 575+ 0EF7 3A 23 2C     	ld a,(proc_id_cur)
 576+ 0EFA CD 06 0F     	call calc_dir_deskr ;узнать дескриптор
 577+ 0EFD F1           	pop af
 578+ 0EFE EB           	ex de,hl
 579+ 0EFF E1           	pop hl ;дескриптор, отправленный приложением
 580+ 0F00 01 20 00     	ld bc,32
 581+ 0F03 ED B0        	ldir
 582+ 0F05 C9           	ret
 583+ 0F06
 584+ 0F06
 585+ 0F06
 586+ 0F06
 587+ 0F06
 588+ 0F06
 589+ 0F06              calc_dir_deskr ;определяет адрес дескриптора каталога
 590+ 0F06 21 C6 10     	ld hl,dir_fat_deskr
 591+ 0F09 B7           	or a
 592+ 0F0A 28 0B        	jr z,calc_dir_deskr_ex ;на выход если 0
 593+ 0F0C FE 09        	cp proc_max+1
 594+ 0F0E 30 07        	jr nc,calc_dir_deskr_ex ;защита
 595+ 0F10 11 20 00     	ld de,fcb_fat_size
 596+ 0F13 47           	ld b,a
 597+ 0F14              calc_dir_deskr_cl
 598+ 0F14 19           	add hl,de
 599+ 0F15 10 FD        	djnz calc_dir_deskr_cl
 600+ 0F17              calc_dir_deskr_ex
 601+ 0F17 C9           	ret
 602+ 0F18
 603+ 0F18
 604+ 0F18
 605+ 0F18
 606+ 0F18              ; A - file stream id
 607+ 0F18              ; DE - position hi
 608+ 0F18              ; HL - position low
 609+ 0F18              ; Returns:
 610+ 0F18              ;
 611+ 0F18              file_position: ;
 612+ 0F18              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 613+ 0F18 38 14        	jr c,file_position_set
 614+ 0F1A              	;чтение
 615+ 0F1A CD BF 0E     	call file_check_act ;проверка
 616+ 0F1D DA 1D 0E     	jp c,file_error
 617+ 0F20              	;прочитаем позицию
 618+ 0F20 DD 6E 18     	ld l,(ix+#18)
 619+ 0F23 DD 66 19     	ld h,(ix+#19)
 620+ 0F26 DD 5E 1A     	ld e,(ix+#1a)
 621+ 0F29 DD 56 1B     	ld d,(ix+#1b)
 622+ 0F2C B7           	or a
 623+ 0F2D C9           	ret
 624+ 0F2E
 625+ 0F2E
 626+ 0F2E              file_position_set
 627+ 0F2E              	;установка
 628+ 0F2E D5           	push de
 629+ 0F2F CD BF 0E     	call file_check_act ;проверка
 630+ 0F32 D1           	pop de
 631+ 0F33 DA 1D 0E     	jp c,file_error
 632+ 0F36              	;установим позицию
 633+ 0F36 DD 75 18     	ld (ix+#18),l
 634+ 0F39 DD 74 19     	ld (ix+#19),h
 635+ 0F3C DD 73 1A     	ld (ix+#1a),e
 636+ 0F3F DD 72 1B     	ld (ix+#1b),d
 637+ 0F42 B7           	or a
 638+ 0F43 C9           	ret
 639+ 0F44
 640+ 0F44
 641+ 0F44
 642+ 0F44
 643+ 0F44              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 644+ 0F44              ;вх:   hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 645+ 0F44              ;	  формат пути: \[DIR\DIR\..\DIR\]filename.ext
 646+ 0F44              find_path
 647+ 0F44              	;сначала сделаем текущей папку активного приложения
 648+ 0F44 F5           	push af
 649+ 0F45              	; push hl
 650+ 0F45
 651+ 0F45 CD 5E 0F     	call restore_path
 652+ 0F48 D9           	exx
 653+ 0F49 D5           	push de ;дескриптор
 654+ 0F4A D9           	exx
 655+ 0F4B
 656+ 0F4B              	R8FAT r8f03_SetRoot ;перейти в корень диска
 656+ 0F4B 0E 03       >	ld	c,r8f03_SetRoot
 656+ 0F4D CF          >	rst	#08
 656+ 0F4E 91          >	db	#91
 657+ 0F4F
 658+ 0F4F D1           	pop de ;дескриптор
 659+ 0F50              	; pop hl
 660+ 0F50 F1           	pop af
 661+ 0F51              	;поиск пути в разделе
 662+ 0F51              	; xor	a
 663+ 0F51              	; dec	a ;установить текущим
 664+ 0F51
 665+ 0F51
 666+ 0F51              ; #04(04) (FindPath) поиск файла по заданному пути в текущем каталоге со входом в
 667+ 0F51              	; подкаталоги с проверкой синтаксиса (с установкой найденного каталога
 668+ 0F51              	; текущим)
 669+ 0F51              ; вх:  c=#04(04)
 670+ 0F51                   ; hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 671+ 0F51              	  ; формат пути: \[DIR\DIR\..\DIR\]filename.ext
 672+ 0F51                   ; de - адрес буфера (#20 байт) для дескриптора найденного файла/каталога
 673+ 0F51                   ; a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 674+ 0F51              	R8FAT	r8f04_FindPath
 674+ 0F51 0E 04       >	ld	c,r8f04_FindPath
 674+ 0F53 CF          >	rst	#08
 674+ 0F54 91          >	db	#91
 675+ 0F55 C9           	ret
 676+ 0F56
 677+ 0F56
 678+ 0F56
 679+ 0F56
 680+ 0F56
 681+ 0F56
 682+ 0F56
 683+ 0F56
 684+ 0F56              ; получение длинного имени файла
 685+ 0F56              ;вх: hl - адрес буфера для имени
 686+ 0F56              ;    de - номер записи в текущем каталоге
 687+ 0F56              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 688+ 0F56              ; 	a - длина имени, с учетом нуля
 689+ 0F56              get_LFN
 690+ 0F56
 691+ 0F56              	;сначала сделаем текущей папку активного приложения
 692+ 0F56 CD 5E 0F     	call restore_path
 693+ 0F59
 694+ 0F59              	R8FAT r8f14_GetLFN
 694+ 0F59 0E 14       >	ld	c,r8f14_GetLFN
 694+ 0F5B CF          >	rst	#08
 694+ 0F5C 91          >	db	#91
 695+ 0F5D              ; #14(20) (GetLFN) получение длинного имени файла
 696+ 0F5D              ; вх:  c=#14(20)
 697+ 0F5D                   ; hl - адрес буфера для имени
 698+ 0F5D                   ; de - номер записи в текущем каталоге
 699+ 0F5D              ; вых: cy=1 ошибка чтения -> a - код ошибки
 700+ 0F5D                   ; hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то
 701+ 0F5D                        ; возвращается короткое имя)
 702+ 0F5D                   ; a - длина имени, с учетом нуля
 703+ 0F5D                   ; de,bc - не определены
 704+ 0F5D
 705+ 0F5D C9           	 ret
 706+ 0F5E
 707+ 0F5E
 708+ 0F5E              restore_path
 709+ 0F5E D9           	exx
 710+ 0F5F 3A 23 2C     	ld a,(proc_id_cur)
 711+ 0F62 CD 06 0F     	call calc_dir_deskr
 712+ 0F65 EB           	ex de,hl
 713+ 0F66 21 00 00     	ld hl,0
 714+ 0F69                  ; hl - адрес пути (=#0000 - путь отсутствует)
 715+ 0F69                  ; de - адрес дескриптора директории/файла
 716+ 0F69              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 716+ 0F69 0E 05       >	ld	c,r8f05_OpenDir
 716+ 0F6B CF          >	rst	#08
 716+ 0F6C 91          >	db	#91
 717+ 0F6D D9           	exx
 718+ 0F6E C9           	ret
 719+ 0F6F
 720+ 0F6F
 721+ 0F6F
 722+ 0F6F              ; A - file stream id
 723+ 0F6F              ; fsync:
 724+ 0F6F              ;     esxCall ESX_FSYNC
 725+ 0F6F                  ; ret
 726+ 0F6F
 727+ 0F6F
 728+ 0F6F              ; ; HL - name (name.ext)
 729+ 0F6F              ; ; Returns:
 730+ 0F6F              ; ; HL - name (name    e)
 731+ 0F6F              ; format_name ;подгоняет имя файла под стандарт trdos (8+1)
 732+ 0F6F
 733+ 0F6F              	; ;сначала попробуем убрать из пути подпапку, если она есть
 734+ 0F6F              	; ld (temp_hl),hl ;сохраним адрес исходного имени
 735+ 0F6F              	; ld b,#00 ;не больше 255 символов
 736+ 0F6F              ; format_name5
 737+ 0F6F              	; ld a,(hl)
 738+ 0F6F              	; cp "/" ;если есть подпапка
 739+ 0F6F              	; jr z,format_name_path_yep
 740+ 0F6F              	; ld a,(hl)
 741+ 0F6F              	; cp "." ;если ещё не дошли до расширения
 742+ 0F6F              	; jr nz,format_name6
 743+ 0F6F              	; ld hl,(temp_hl) ;если дошли до расширения, то путей нет, вернёмся на начало имени
 744+ 0F6F              	; jr format_name_7 ;на выход
 745+ 0F6F              ; format_name6
 746+ 0F6F              	; inc hl
 747+ 0F6F              	; djnz format_name5
 748+ 0F6F
 749+ 0F6F              ; format_name_path_yep ;нашли
 750+ 0F6F              	; inc hl ;пропустим знак "/"
 751+ 0F6F
 752+ 0F6F              ; format_name_7
 753+ 0F6F
 754+ 0F6F              	; push hl ;очистим место для нового имени
 755+ 0F6F              	; ld hl,f_name
 756+ 0F6F              	; ld de,f_name+1
 757+ 0F6F              	; ld (hl)," "
 758+ 0F6F              	; ld bc,8+1
 759+ 0F6F              	; ldir
 760+ 0F6F              	; ld (hl),0
 761+ 0F6F              	; ld bc,16-8-1-1
 762+ 0F6F              	; ldir
 763+ 0F6F              	; pop hl
 764+ 0F6F
 765+ 0F6F              	; ld bc,#09ff ;длина имени 9 символов
 766+ 0F6F              	; ld de,f_name ;куда
 767+ 0F6F              ; format_name2
 768+ 0F6F              	; ld a,(hl)
 769+ 0F6F              	; cp "."
 770+ 0F6F              	; jr nz,format_name1
 771+ 0F6F              	; ld de,f_name+8
 772+ 0F6F              	; inc hl
 773+ 0F6F              	; ldi ; и в конце расширение 3 буквы
 774+ 0F6F              	; ldi
 775+ 0F6F              	; ldi
 776+ 0F6F              	; ;ex de,hl ;сохраним адрес исходного расширения
 777+ 0F6F              	; jr format_name_e
 778+ 0F6F              ; format_name1
 779+ 0F6F              	; ldi
 780+ 0F6F              	; djnz format_name2
 781+ 0F6F
 782+ 0F6F              	; ;если имя длинное, пропустим лишнее до расширения
 783+ 0F6F              	; ld b,#00 ;не больше 255 символов
 784+ 0F6F              ; format_name3
 785+ 0F6F              	; ld a,(hl)
 786+ 0F6F              	; cp "."
 787+ 0F6F              	; jr nz,format_name4
 788+ 0F6F              	; ld de,f_name+8
 789+ 0F6F              	; inc hl
 790+ 0F6F              	; ldi ; и в конце расширение 3 буквы
 791+ 0F6F              	; ldi
 792+ 0F6F              	; ldi
 793+ 0F6F              	; ;ex de,hl ;сохраним адрес исходного расширения
 794+ 0F6F              	; jr format_name_e
 795+ 0F6F              ; format_name4
 796+ 0F6F              	; inc hl
 797+ 0F6F              	; djnz format_name3
 798+ 0F6F
 799+ 0F6F              ; format_name_e ;выход
 800+ 0F6F              	; ld hl,f_name ;вернём результат
 801+ 0F6F              	; ret
 802+ 0F6F
 803+ 0F6F              ; DE - trk/sec
 804+ 0F6F              ; B - sectors step
 805+ 0F6F              ; Returns:
 806+ 0F6F              ; DE - trk/sec
 807+ 0F6F              ; calc_next_pos		;вперёд на N секторов
 808+ 0F6F              			; ;ld b,4
 809+ 0F6F              			; ;ld  de,(#5ceb)
 810+ 0F6F              ; calc_next_pos2
 811+ 0F6F              			; inc e
 812+ 0F6F              			; ld a,e
 813+ 0F6F              			; cp 16
 814+ 0F6F              			; jr c,calc_next_pos1
 815+ 0F6F              			; inc d
 816+ 0F6F              			; ld e,0
 817+ 0F6F              ; calc_next_pos1
 818+ 0F6F              			; ;ld (#5ceb),de
 819+ 0F6F              			; djnz calc_next_pos2
 820+ 0F6F              			; ret
 821+ 0F6F
 822+ 0F6F
 823+ 0F6F              ;testt db "123.trd"
 824+ 0F6F              ; write_ima db "Select disk "
 825+ 0F6F              ; write_ima_d db "A: (E-" ;текущая буква
 826+ 0F6F              ; write_ima_e	db "D)> " ;последняя буква
 827+ 0F6F              		; db 13,10,0
 828+ 0F6F              ;prev_drive db 0 ;предыдущий номер дисковода
 829+ 0F6F 00           fs_drive_number_cur db 0 ;текущий диск/раздел
 830+ 0F70
 831+ 0F70              ; ; trdExt1 db ".trd", 0
 832+ 0F70              ; ; trdExt2 db ".TRD", 0
 833+ 0F70
 834+ 0F70              ; ; sclExt1 db ".scl", 0
 835+ 0F70              ; ; sclExt2 db ".SCL", 0
 836+ 0F70
 837+ 0F70              ; f_name ds 16 ;имя файла
 838+ 0F70              ; f_r_cur_trk dw 	 0 ;текущие сектор-дорожка файла на чтение
 839+ 0F70              ; f_r_len_sec db 0 ;длина файла на чтение в секторах
 840+ 0F70              ; f_r_len dw 0;длина файла в байтах
 841+ 0F70              ; f_r_flag db 0 ;флаг что открыт файл на чтение
 842+ 0F70
 843+ 0F70              ; f_w_cur_trk dw 	 0 ;текущие сектор-дорожка файла на запись
 844+ 0F70              ; f_w_len_sec db 0 ;длина файла на запись в секторах
 845+ 0F70              ; f_w_flag db 0 ;флаг что открыт файл на запись
 846+ 0F70              ; f_w_len ds 4 ;длина записанных данных
 847+ 0F70              ; write_end_flag db 0 ;флаг что нужно записать остаток
 848+ 0F70
 849+ 0F70              ; temp_bc dw 0 ;хранение регистра
 850+ 0F70              ; temp_hl dw 0 ;хранение регистра
 851+ 0F70              ; temp_hl2 dw 0 ;хранение регистра
 852+ 0F70
 853+ 0F70              ; sec_shift db 0 ;указатель на каком байте остановлена запись
 854+ 0F70              ; sec_shift2 db 0 ;указатель на каком байте остановлена запись (остаток)
 855+ 0F70              ; sec_part db 0 ;сколько секторов во второй порции для записи
 856+ 0F70              ; sec_shift_flag db 0 ;флаг что буфер сектора не заполнен
 857+ 0F70
 858+ 0F70              ; ;секция scl
 859+ 0F70              ; scl_sign db "SINCLAIR" ;метка
 860+ 0F70              ; scl_que db 0 ;флаг запроса порции данных
 861+ 0F70              ; scl_err db "SCL image error!",0
 862+ 0F70              ; scl_parse_ret_adr dw 0; адрес возврата в цикл
 863+ 0F70              ; scl_cat_cycl db 0 ;переменная цикла
 864+ 0F70              ; scl_files db 0 ;всего файлов
 865+ 0F70              ; scl_temp_hl dw 0;;хранение регистра
 866+ 0F70              ; scl_temp_hl2 dw 0;
 867+ 0F70              ; scl_temp_de dw 0;
 868+ 0F70              ; scl_temp_bc dw 0;
 869+ 0F70              ; cat_cur_adr dw 0;
 870+ 0F70              ; ;scl end
 871+ 0F70
 872+ 0F70              ; ;секция сохранения любого файла
 873+ 0F70              ; file_err db "Not enough space!",0
 874+ 0F70              ; sec_cat db 0 ;сектор каталога
 875+ 0F70              ; file_num db "0" ;номер части для больших файлов
 876+ 0F70
 877+ 0F70              	; ;по адресу #4000 шрифт
 878+ 0F70              ; cat_buf equ #4800 ;буфер для кататога диска 9*256
 879+ 0F70              ; sec_buf equ cat_buf + 9*256 ;буфер сектора для записи 256
 880+ 0F70              ; scl_buf equ sec_buf + 512 ;промежуточный буфер 256
 881+ 0F70              ; scl_buf2 equ scl_buf + 512 ;промежуточный буфер 256
 882+ 0F70              ; ;общая ошибка с файлами
 883+ 0F70              ; com_file_err db "File error!",0
 884+ 0F70              ;com_file_err_flag db 0 ;общая ошибка
 885+ 0F70
 886+ 0F70
 887+ 0F70
 888+ 0F70
 889+ 0F70              ;Раздел SMUC и SD ------------------------------------
 890+ 0F70
 891+ 0F70
 892+ 0F70              ;список доступных разделов на винчестерах
 893+ 0F70              ;7,=0/1 тип раздела MFS/FAT
 894+ 0F70              ;6,=1 раздел есть
 895+ 0F70              ;3,=0/1 Hdd/SD card
 896+ 0F70              ;2,=0/1 для HDD master/slave
 897+ 0F70              ;0..1,=?? номер раздела
 898+ 0F70              ;
 899+ 0F70 00 00 00...  typeDrive	ds 3*4+1
 900+ 0F7D              ;typeDriveFAT	ds 3*4+1 ;список всех разделов FAT
 901+ 0F7D 00           numDrives db 0 ;количество устройств
 902+ 0F7E              ;numDrivesFAT db 0 ;количество устройств FAT
 903+ 0F7E 00           next_lett db 0 ;следующая свободная буква диска
 904+ 0F7F
 905+ 0F7F              ;подсчет количества доступных разделов на всех устройствах
 906+ 0F7F              ;вых: hl,a - количество устройств
 907+ 0F7F              ;     typeDrives - сформированная таблица
 908+ 0F7F              ;     cy=1 не обнаружено ни одного устройства
 909+ 0F7F              ;
 910+ 0F7F              GetNumPart
 911+ 0F7F              ;
 912+ 0F7F D5           	push	de
 913+ 0F80 C5           	push	bc
 914+ 0F81 21 70 0F     	ld	hl,typeDrive
 915+ 0F84 E5           	push	hl
 916+ 0F85 AF           	xor	a
 917+ 0F86 CD A0 0F     	call	proc_01			;HDD master
 918+ 0F89 3E 01        	ld	a,#01
 919+ 0F8B CD A0 0F     	call	proc_01			;HDD slave
 920+ 0F8E 3E 02        	ld	a,#02
 921+ 0F90 CD A0 0F     	call	proc_01			;SD card
 922+ 0F93 D1           	pop	de
 923+ 0F94 B7           	or	a
 924+ 0F95 ED 52        	sbc	hl,de			;количество разделов на HDD
 925+ 0F97              	IFDEF	useTRD
 926+ 0F97 ~            	 ld	a,l
 927+ 0F97 ~            	 add	a,#04
 928+ 0F97 ~            	 ld	l,a
 929+ 0F97              	ELSE
 930+ 0F97 7D           	 ld	a,l
 931+ 0F98              	ENDIF
 932+ 0F98 C1           	pop	bc
 933+ 0F99 D1           	pop	de
 934+ 0F9A 32 7D 0F     	ld	(numDrives),a
 935+ 0F9D FE 01        	cp	1
 936+ 0F9F C9           	ret
 937+ 0FA0
 938+ 0FA0              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 939+ 0FA0              ;формирование таблицы с доступными разделами на винчестере
 940+ 0FA0              ;вх:  a =#00 выбрать master
 941+ 0FA0              ;       =#01 выбрать slave
 942+ 0FA0              ;       =#02 выбрать SD card
 943+ 0FA0              ;     hl - адрес в таблице разделов typeDrives
 944+ 0FA0              ;вых: hl - новый адрес в таблице разделов typeDrives
 945+ 0FA0              ;
 946+ 0FA0 4F           proc_01	ld	c,a
 947+ 0FA1 E5           	push	hl
 948+ 0FA2 C5           	push	bc
 949+ 0FA3              	R8DOS	r8d2E_CngHDD
 949+ 0FA3 0E 2E       >	ld	c,r8d2E_CngHDD
 949+ 0FA5 CF          >	rst	#08
 949+ 0FA6 81          >	db	#81
 950+ 0FA7 38 04        	jr	c,goto001		;на текущем канале нет винчестера
 951+ 0FA9              	R8DOS	r8d2D_FindPart
 951+ 0FA9 0E 2D       >	ld	c,r8d2D_FindPart
 951+ 0FAB CF          >	rst	#08
 951+ 0FAC 81          >	db	#81
 952+ 0FAD C1           goto001	pop	bc
 953+ 0FAE E1           	pop	hl
 954+ 0FAF D8           	ret	c			;на текущем винчестере нет разделов
 955+ 0FB0 47           	ld	b,a
 956+ 0FB1 79           	ld	a,c
 957+ 0FB2 87           	add	a,a
 958+ 0FB3 87           	add	a,a
 959+ 0FB4 4F           	ld	c,a			;номер винчестера и первого раздела
 960+ 0FB5 78           	ld	a,b
 961+ 0FB6 06 04        	ld	b,#04
 962+ 0FB8 36 00        loop001	ld	(hl),#00
 963+ 0FBA 1F           	rra
 964+ 0FBB 30 0A        	jr	nc,goto002		;нет раздела
 965+ 0FBD              	IFDEF	useMFS
 966+ 0FBD ~            	 ld	(hl),c
 967+ 0FBD ~            	 set	6,(hl)			;=%01???hpp MFS
 968+ 0FBD ~            	 rra
 969+ 0FBD ~            	 jr	nc,goto003		;это MFS
 970+ 0FBD ~            	 set	7,(hl)			;=%11???hpp это FAT
 971+ 0FBD              	ELSE
 972+ 0FBD 1F           	 rra
 973+ 0FBE 30 08        	 jr	nc,goto004		;это MFS
 974+ 0FC0 71           	 ld	(hl),c
 975+ 0FC1 CB F6        	 set	6,(hl)			;раздел есть
 976+ 0FC3 CB FE        	 set	7,(hl)			;=%11???hpp это FAT
 977+ 0FC5              	ENDIF
 978+ 0FC5 23           goto003	inc	hl
 979+ 0FC6 17           	rla
 980+ 0FC7 1F           goto002	rra
 981+ 0FC8 0C           goto004	inc	c
 982+ 0FC9 10 ED        	djnz	loop001
 983+ 0FCB C9           	ret
 984+ 0FCC
 985+ 0FCC
 986+ 0FCC
 987+ 0FCC              ;конец секции SMUC и SD ----------------------------
 988+ 0FCC
 989+ 0FCC
 990+ 0FCC              find_empty_fcb_fat ;поиск свободного fcb для файла
 991+ 0FCC              	;выход hl - fcb; a - file_id
 992+ 0FCC 21 F6 11     	ld hl,fcb_fat_table
 993+ 0FCF 0E 00        	ld c,0 ;номер файла
 994+ 0FD1 06 08        	ld b,files_fat_max ;цикл
 995+ 0FD3              find_empty_fcb_fat_cl
 996+ 0FD3 7E           	ld a,(hl)
 997+ 0FD4 B7           	or a
 998+ 0FD5 28 06        	jr z,find_empty_fcb_fat_ex
 999+ 0FD7 23           	inc hl
1000+ 0FD8 0C           	inc c
1001+ 0FD9 10 F8        	djnz find_empty_fcb_fat_cl
1002+ 0FDB              	;не нашли свободного
1003+ 0FDB 37           	scf
1004+ 0FDC C9           	ret
1005+ 0FDD              find_empty_fcb_fat_ex
1006+ 0FDD              	;вычислить адрес fcb
1007+ 0FDD 21 14 12     	ld hl,fcb_fat
1008+ 0FE0 0C           	inc c
1009+ 0FE1 0D           	dec c
1010+ 0FE2 28 07        	jr z,find_empty_fcb_fat_ex1
1011+ 0FE4 11 20 00     	ld de,fcb_fat_size
1012+ 0FE7 41           	ld b,c
1013+ 0FE8              find_empty_fcb_fat_cl2
1014+ 0FE8 19           	add hl,de
1015+ 0FE9 10 FD        	djnz find_empty_fcb_fat_cl2
1016+ 0FEB              find_empty_fcb_fat_ex1
1017+ 0FEB 79           	ld a,c ;file-id
1018+ 0FEC B7           	or a
1019+ 0FED C9           	ret
1020+ 0FEE
1021+ 0FEE
1022+ 0FEE              find_fcb_fat ;поиск fcb файла по номеру
1023+ 0FEE              	;вх: a - id файла
1024+ 0FEE              	;вых: hl - fcb; a - значение из fcb_fat_table
1025+ 0FEE 21 14 12     	ld hl,fcb_fat
1026+ 0FF1 B7           	or a
1027+ 0FF2 28 07        	jr z,find_fcb_fat_ex
1028+ 0FF4 47           	ld b,a
1029+ 0FF5 11 20 00     	ld de,fcb_fat_size
1030+ 0FF8              find_fcb_fat_cl
1031+ 0FF8              	;вычислить адрес fcb
1032+ 0FF8 19           	add hl,de
1033+ 0FF9 10 FD        	djnz find_fcb_fat_cl
1034+ 0FFB              find_fcb_fat_ex
1035+ 0FFB E5           	push hl
1036+ 0FFC 21 F6 11     	ld hl,fcb_fat_table
1037+ 0FFF 4F           	ld c,a
1038+ 1000 06 00        	ld b,0
1039+ 1002 09           	add hl,bc
1040+ 1003 7E           	ld a,(hl) ;вернуть флаг
1041+ 1004 E1           	pop hl
1042+ 1005 C9           	ret
1043+ 1006
1044+ 1006
1045+ 1006
1046+ 1006
1047+ 1006
1048+ 1006 00           file_fat_id_cur db 0 ;текущий файл id
1049+ 1007 00           fs_fat_part_code_cur db 0 ;текущий раздел
1050+ 1008 46 6F 75 6E  msg_fat_found db "Found FAT:",13,10,0
1050+ 100C 64 20 46 41
1050+ 1010 54 3A 0D 0A
1050+ 1014 00
1051+ 1015 46 6F 75 6E  msg_fat_found_os db "Found OS on disk: ",0
1051+ 1019 64 20 4F 53
1051+ 101D 20 6F 6E 20
1051+ 1021 64 69 73 6B
1051+ 1025 3A 20 00
1052+ 1028 46 41 54 20  msg_fat_not_found db "FAT not found",13,10,0
1052+ 102C 6E 6F 74 20
1052+ 1030 66 6F 75 6E
1052+ 1034 64 0D 0A 00
1053+ 1038 46 41 54 20  msg_fat_init_error db "FAT init_error",13,10,0
1053+ 103C 69 6E 69 74
1053+ 1040 5F 65 72 72
1053+ 1044 6F 72 0D 0A
1053+ 1048 00
1054+ 1049 46 69 6C 65  msg_file_error_general db "File error",13,10,0
1054+ 104D 20 65 72 72
1054+ 1051 6F 72 0D 0A
1054+ 1055 00
1055+ 1056 46 69 6C 65  msg_file_too_big db "File too_big",13,10,0
1055+ 105A 20 74 6F 6F
1055+ 105E 5F 62 69 67
1055+ 1062 0D 0A 00
1056+ 1065 46 69 6C 65  msg_file_not_found db "File not found",13,10,0
1056+ 1069 20 6E 6F 74
1056+ 106D 20 66 6F 75
1056+ 1071 6E 64 0D 0A
1056+ 1075 00
1057+ 1076 46 69 6C 65  msg_file_open_error db "File open error",13,10,0
1057+ 107A 20 6F 70 65
1057+ 107E 6E 20 65 72
1057+ 1082 72 6F 72 0D
1057+ 1086 0A 00
1058+ 1088 46 69 6C 65  msg_file_read_error db "File read error",13,10,0
1058+ 108C 20 72 65 61
1058+ 1090 64 20 65 72
1058+ 1094 72 6F 72 0D
1058+ 1098 0A 00
1059+ 109A 44 69 72 65  msg_dir_not_found db "Directory not found",13,10,0
1059+ 109E 63 74 6F 72
1059+ 10A2 79 20 6E 6F
1059+ 10A6 74 20 66 6F
1059+ 10AA 75 6E 64 0D
1059+ 10AE 0A 00
1060+ 10B0 00 00        file_size_tmp dw 0 ;временно
1061+ 10B2
1062+ 10B2 00           fs_fat_init_flag: db 0 ;флаг инициализации
1063+ 10B3 5C 4F 53 5A  OS_PathFAT db "\\OSZ",0 ;папка ОС
1063+ 10B7 00
1064+ 10B8
1065+ 10B8 66 61 74 5F  	db "fat_dir_descr:" ;дескрипторы открытых папок fat по одной на приложение
1065+ 10BC 64 69 72 5F
1065+ 10C0 64 65 73 63
1065+ 10C4 72 3A
1066+ 10C6 00 00 00...  dir_fat_deskr ds fcb_fat_size*(proc_max+1)	;дескрипторы папок
1067+ 11E6
1068+ 11E6
1069+ 11E6 66 61 74 5F  	db "fat_files_table:"
1069+ 11EA 66 69 6C 65
1069+ 11EE 73 5F 74 61
1069+ 11F2 62 6C 65 3A
1070+ 11F6 00 00 00...  fcb_fat_table ds files_fat_max ;флаги открытия файлов
1071+ 11FE 00 00 00...  fcb_trd_table ds files_trd_max ;флаги открытия файлов
1072+ 1206
1073+ 1206 66 61 74 5F  	db "fat_files_fcb:"
1073+ 120A 66 69 6C 65
1073+ 120E 73 5F 66 63
1073+ 1212 62 3A
1074+ 1214 00 00 00...  fcb_fat ds fcb_fat_size*files_fat_max ;для файлов fat
1075+ 1314 00 00 00...  fcb_trd ds fcb_fat_size*files_trd_max ;для файлов trd
1076+ 1414
1077+ 1414
1078+ 1414
1079+ 1414                  ENDMODULE
# file closed: Drv/zsfat.asm
2587  1414              	include Drv/DrvKey.main.a80 ;драйвер клавиатуры
# file opened: Drv/DrvKey.main.a80
   1+ 1414              ;ࠩ  
   2+ 1414              ;Driver Keyboard v2.10
   3+ 1414              ;(c) 2002-2024 LW aka PLM
   4+ 1414              ;
   5+ 1414              ;Date Creating: 10.07.2002
   6+ 1414              ;Last   Update: 17.01.2024
   7+ 1414              ;Last  Edition: 17.01.2024
   8+ 1414              ;
   9+ 1414              ;:
  10+ 1414              ;DrvKey.main.a80	-  䠩
  11+ 1414              ;DrvKey.asm.a80		- 楤
  12+ 1414              ;DrvKey.var.a80		- ६
  13+ 1414              ;DrvKey.info		- ଠ  ࠩ
  14+ 1414              ;DrvKey.lua.a80		- LUA
  15+ 1414              ;
  16+ 1414              ;------------------------------------------------------------------------------
  17+ 1414              ; 樨
  18+ 1414              ;	DEVICE 	ZXSPECTRUM128
  19+ 1414              ;	INCLUDE "DrvKey.lua.a80"
  20+ 1414              ;	PAGE	#XX
  21+ 1414              	MODULE	DrvKey
  22+ 1414
  23+ 1414              ;------------------------------------------------------------------------------
  24+ 1414              ;⠭ ࠩ
  25+ 1414
  26+ 1414              ; ᥬ஢:
  27+ 1414              AdrDrvKeyboard	equ $ ;#XXXX
  28+ 1414
  29+ 1414              ;   
  30+ 1414              keyLeft		equ #08
  31+ 1414              keyRight	equ #09
  32+ 1414              keyUp		equ #0B
  33+ 1414              keyDown		equ #0A
  34+ 1414
  35+ 1414              ;࠭ /
  36+ 1414              keyPageDown	equ #05
  37+ 1414              keyPageUp	equ #04
  38+ 1414
  39+ 1414              ;/砫 ப, insert
  40+ 1414              keyHome		equ #01
  41+ 1414              keyEnd		equ #03
  42+ 1414              keyInsert	equ #02
  43+ 1414
  44+ 1414              ;⥬ 
  45+ 1414              keyBreak	equ #18
  46+ 1414              keyEdit		equ #07
  47+ 1414              keyCaps		equ #06
  48+ 1414              keyBackSpace	equ #0C
  49+ 1414              keyDelete	equ #0F
  50+ 1414              keyEnter	equ #0D
  51+ 1414
  52+ 1414              ;CapsShift/SymbolShift   樨
  53+ 1414              keyCS		equ #1C
  54+ 1414              keySS		equ #1D
  55+ 1414              keyCsEnter	equ #19
  56+ 1414              keySsSpace	equ #1A		;tab
  57+ 1414              keySsEnter	equ #1B
  58+ 1414              keyExtMode	equ #0E
  59+ 1414
  60+ 1414              ;  ० EXT mode (cs+ss+key)
  61+ 1414              keyWordLeft	equ #10
  62+ 1414              keyWordRight	equ #11
  63+ 1414              keyGrf		equ #12
  64+ 1414              keyDelEnd	equ #13
  65+ 1414              keyDelBegin	equ #16
  66+ 1414              keyCsSsSpace	equ #14
  67+ 1414              keyCsSsEnter	equ #15
  68+ 1414              ;free code: #00,#17,#1E,#1F
  69+ 1414
  70+ 1414              ; 譨 ⠡  ᪫ 
  71+ 1414              ;OutsideGrfTable		equ #XXXX ;#0000
  72+ 1414              ;OutsideRus_jcuken	equ #XXXX ;#0000
  73+ 1414              ;OutsideRus_qwerty	equ #XXXX ;#0000
  74+ 1414
  75+ 1414              ;------------------------------------------------------------------------------
  76+ 1414              ;᫮ ࠭樨
  77+ 1414
  78+ 1414              ; ᯮ짮 /  48k
  79+ 1414              	;DEFINE	Used_ROM ;
  80+ 1414              	DEFINE	UseEXTkeys	;ᯮ짮 権 cs+ss+key
  81+ 1414              	DEFINE	CommandMode	;ᯮ짮  ०
  82+ 1414              	IFDEF	Used_ROM
  83+ 1414 ~            	UNDEFINE UseEXTkeys
  84+ 1414              	ENDIF
  85+ 1414
  86+ 1414              ;祭 ᪫ 
  87+ 1414              	DEFINE	GrfMode		;ᯮ짮 ᪫ grf
  88+ 1414              	DEFINE	RusMode		;ᯮ짮 ᪫ rus
  89+ 1414
  90+ 1414              ;祭 ⠡ ᪫
  91+ 1414              	DEFINE	TblKeyGrf_ver1
  92+ 1414              	DEFINE	Rus_jcuken
  93+ 1414              	DEFINE	Rus_qwerty
  94+ 1414
  95+ 1414              ;祭 ⠡ EXT+key (command mode)
  96+ 1414              ;  ᯮ짮 ⮫쪮 
  97+ 1414              	IFDEF	UseEXTkeys
  98+ 1414              	DEFINE	TblEXTkey_Test	;⮢ ᪫
  99+ 1414              ;	DEFINE	TblEXTkey_Word	; ZX-Word
 100+ 1414              	ENDIF
 101+ 1414
 102+ 1414              ;  ᯮ ७ ⠡ ᪫ 
 103+ 1414              	DEFINE	InsideGrfTable
 104+ 1414              	DEFINE	InsideRusTable
 105+ 1414
 106+ 1414              ;祭 㭪樨 ࠩ
 107+ 1414              ;	DEFINE  NoFuncDrvKey	; 楤 맮 㭪権 ࠩ
 108+ 1414              	DEFINE	NoCtlDrvKey	; ஢ન  ⢮ 㭪樨
 109+ 1414              	DEFINE	DrvKey_02	;⠭/祭 䫠 ࠩ
 110+ 1414              	DEFINE	DrvKey_03	;⠭ ਮ প  ⮯
 111+ 1414              	DEFINE	DrvKey_04	;祭 ਮ প  ⮯
 112+ 1414
 113+ 1414              ;------------------------------------------------------------------------------
 114+ 1414
 115+ 1414              	ORG	AdrDrvKeyboard
 116+ 1414              Start	INCLUDE	"DrvKey.asm.a80"
# file opened: Drv/DrvKey.asm.a80
   1++1414              ;楤  Keyboard Driver
   2++1414              ;䠩 DrvKey.asm.a80
   3++1414              ;
   4++1414              ;DriverKeyboard		맮 ࠩ 
   5++1414              ;FunctDrvKeyboard	맮 㭪樨 ࠩ 
   6++1414              ;GetCodesPressKey	祭  ⮩ 
   7++1414              ;GetRepeatDelays	祭 ਮ প  ⮯
   8++1414              ;SetRepeatDelays	⠭ ਮ প  ⮯
   9++1414              ;SetFlagsDriver		⠭/祭 䫠 ࠩ
  10++1414              ;ScanKeyboardDelay	   ⮬ ६ থ
  11++1414              ;ScanKeyboard		   
  12++1414              ;ScanAllKeys		   
  13++1414              ;
  14++1414              ;------------------------------------------------------------------------------
  15++1414              ;------------------------------------------------------------------------------
  16++1414              ;맮 ࠩ 
  17++1414              ;: 6,(FlgScanKeys) =1 -     
  18++1414              ;     hl=FlgScanKeys
  19++1414              ;     d - ᪠ ⮩ 
  20++1414              ;     a,e -   ⮩   ⥪饩 ᪫ 
  21++1414              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  22++1414              ;     bc -  ।
  23++1414              ;
  24++1414 C3 4C 14     @DriverKeyboard		jp	ScanKeyboardDelay
  25++1417
  26++1417              ;------------------------------------------------------------------------------
  27++1417              	IFNDEF	NoFuncDrvKey
  28++1417              ;맮 㭪樨 ࠩ 
  29++1417              ;:  c -  㭪樨 [#00..#04]
  30++1417              ;     hl,de,b,a - ࠬ 㭪樨
  31++1417              ;: ॣ ⠭  ⢥⢨  뢠 㭪樥
  32++1417              ;
  33++1417              @FunctDrvKeyboard
  34++1417              ;
  35++1417              	IFDEF	NoCtlDrvKey
  36++1417 E5           	 push	hl
  37++1418 F5           	 push	af
  38++1419 78           	 ld	a,b
  39++141A 06 00        	 ld	b,#00
  40++141C 21 29 14     	 ld	hl,TableAdrFunct
  41++141F 09           	 add	hl,bc
  42++1420 09           	 add	hl,bc
  43++1421 47           	 ld	b,a
  44++1422 7E           	 ld	a,(hl)
  45++1423 23           	 inc	hl
  46++1424 66           	 ld	h,(hl)
  47++1425 6F           	 ld	l,a
  48++1426 F1           	 pop	af
  49++1427 E3           	 ex	(sp),hl
  50++1428 C9           	 ret
  51++1429              	ELSE
  52++1429 ~            	 push	hl
  53++1429 ~            	 push	af
  54++1429 ~            	 ld	a,c
  55++1429 ~            	 cp	#05
  56++1429 ~            	 jr	nc,goto017		;騩  㭪樨
  57++1429 ~            	 ld	a,b
  58++1429 ~            	 ld	hl,TableAdrFunct
  59++1429 ~            	 ld	b,#00
  60++1429 ~            	 add	hl,bc
  61++1429 ~            	 add	hl,bc
  62++1429 ~            	 ld	b,a
  63++1429 ~            	 ld	a,(hl)
  64++1429 ~            	 inc	hl
  65++1429 ~            	 ld	h,(hl)
  66++1429 ~            	 ld	l,a
  67++1429 ~            	 and	h
  68++1429 ~            	 inc	a
  69++1429 ~            	 jr	z,goto017		;㭪  
  70++1429 ~            	 pop	af
  71++1429 ~            	 ex	(sp),hl
  72++1429 ~            	 ret
  73++1429 ~            goto017	 pop	af
  74++1429 ~            	 pop	hl
  75++1429 ~            	 ret
  76++1429              	ENDIF
  77++1429
  78++1429              	ENDIF
  79++1429
  80++1429              ;------------------------------------------------------------------------------
  81++1429              TableAdrFunct	ifused
  82++1429              ;⠡ ᮢ 㭪権 ࠩ
  83++1429              ;TableAdrFunct
  84++1429              ;
  85++1429 88 14        		  dw ScanKeyboard
  86++142B 33 14        		  dw GetCodesPressKey
  87++142D               IFDEF DrvKey_02
  87++142D 43 14          dw SetFlagsDriver
  87++142F                 ELSE
  87++142F ~              dw #FFFF
  87++142F               ENDIF
  88++142F               IFDEF DrvKey_03
  88++142F 3E 14          dw SetRepeatDelays
  88++1431                ELSE
  88++1431 ~              dw #FFFF
  88++1431               ENDIF
  89++1431               IFDEF DrvKey_04
  89++1431 39 14          dw GetRepeatDelays
  89++1433                ELSE
  89++1433 ~              dw #FFFF
  89++1433               ENDIF
  90++1433              		endif
  91++1433
  92++1433              ;------------------------------------------------------------------------------
  93++1433              GetCodesPressKey	ifused
  94++1433              ;祭  ⮩ 
  95++1433              ;:  ----
  96++1433              ;: d - ᪠ ⮩ 
  97++1433              ;     a,e -   ⮩   ⥪饩 ᪫ 
  98++1433              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  99++1433              ;
 100++1433              ;GetCodesPressKey
 101++1433              ;
 102++1433 ED 5B 20 17  	ld	de,(PrintCodePresKey)
 103++1437 7B           	ld	a,e
 104++1438 C9           	ret
 105++1439
 106++1439              	endif
 107++1439
 108++1439              ;------------------------------------------------------------------------------
 109++1439              GetRepeatDelays	ifused
 110++1439              ;祭 ਮ প  ⮯
 111++1439              ;:  ----
 112++1439              ;: d - ਮ ⮯
 113++1439              ;     e - প । ⮯஬
 114++1439              ;
 115++1439              ;GetRepeatDelays
 116++1439              ;
 117++1439 ED 5B 1E 17  	ld      de,(KeyRepeatDelay)
 118++143D C9           	ret
 119++143E
 120++143E              	endif
 121++143E
 122++143E              ;------------------------------------------------------------------------------
 123++143E              SetRepeatDelays	ifused
 124++143E              ;⠭ ਮ প  ⮯
 125++143E              ;:  d - ਮ ⮯
 126++143E              ;     e - প । ⮯஬
 127++143E              ;: ॣ  
 128++143E              ;
 129++143E              ;SetRepeatDelays
 130++143E              ;
 131++143E ED 53 1E 17  	ld	(KeyRepeatDelay),de
 132++1442 C9           	ret
 133++1443
 134++1443              	endif
 135++1443
 136++1443              ;------------------------------------------------------------------------------
 137++1443              SetFlagsDriver	ifused
 138++1443              ;e⠭/祭 䫠 ࠩ
 139++1443              ;:  d - ᪠ 䫠
 140++1443              ;     e - 塞 䫠
 141++1443              ;: a - 䫠 ࠩ
 142++1443              ;
 143++1443              ;SetFlagsDriver
 144++1443              ;
 145++1443 3A 1C 17     	ld	a,(FlgScanKeys)
 146++1446 A2           	and	d
 147++1447 B3           	or	e
 148++1448 32 1C 17     	ld	(FlgScanKeys),a
 149++144B C9           	ret
 150++144C
 151++144C              	endif
 152++144C
 153++144C              ;------------------------------------------------------------------------------
 154++144C              ;   ⮬ ६ থ
 155++144C              ;:  (PrintCodePresKey) -   ⮩ 
 156++144C              ;: 6,(FlgScanKeys) =1 -     
 157++144C              ;     hl=FlgScanKeys
 158++144C              ;     d - ᪠ ⮩ 
 159++144C              ;     a,e -   ⮩   ⥪饩 ᪫ 
 160++144C              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
 161++144C              ;     bc -  ।
 162++144C              ;
 163++144C              ScanKeyboardDelay
 164++144C              ;
 165++144C CD 88 14     	call	ScanKeyboard		;a=(PrintCodePresKey)
 166++144F 21 1C 17     	ld	hl,FlgScanKeys
 167++1452 CB F6        	set	6,(hl)
 168++1454              ;	ld	a,(PrintCodePresKey)
 169++1454 FE FF        	cp	#FF
 170++1456 28 24        	jr	z,goto012		;  
 171++1458 FE 00        cng_01	cp	#00
 172++145A 20 1E        	jr	nz,goto013		; 㣠 
 173++145C ED 4B 1E 17  	ld	bc,(KeyRepeatDelay)
 174++1460 11 00 00     cng_02	ld	de,#0000
 175++1463 1C           	inc	e
 176++1464 20 01        	jr	nz,goto014
 177++1466 1D           	dec	e
 178++1467 7B           goto014	ld	a,e
 179++1468 B9           	cp	c
 180++1469 20 17        	jr	nz,goto015		;প  ⮯
 181++146B 1D           	dec	e
 182++146C 14           	inc	d
 183++146D 20 01        	jr	nz,goto016
 184++146F 15           	dec	d
 185++1470 7A           goto016	ld	a,d
 186++1471 B8           	cp	b
 187++1472 38 0E        	jr	c,goto015
 188++1474 16 00        	ld	d,#00
 189++1476 CB B6        	res	6,(hl)
 190++1478 18 08        	jr	goto015
 191++147A CB B6        goto013 res     6,(hl)
 192++147C 32 59 14     goto012	ld	(cng_01+1),a
 193++147F 11 00 00     	ld	de,#0000
 194++1482 ED 53 61 14  goto015	ld	(cng_02+1),de
 195++1486 18 AB        	jr	GetCodesPressKey
 196++1488
 197++1488              ;------------------------------------------------------------------------------
 198++1488              ;     樥 ⭮ 
 199++1488              ;:  (FlgScanKeys) - 䫠
 200++1488              ;: (ScanCodePresKey) - ᪠ ⮩ 
 201++1488              ;     a -   ⮩ 
 202++1488              ;     (PrintCodePresKey) -   ⮩   ⥪饩 ᪫
 203++1488              ;        (Grf\Rus\Lat)  ⮬ ० CapsLock
 204++1488              ;     7,(FlgScanKeys) =1 ⨬ 
 205++1488              ;     hl,de,bc,a -  ।
 206++1488              ;
 207++1488              ScanKeyboard
 208++1488              ;
 209++1488              ; 
 210++1488              	IFDEF	Used_ROM
 211++1488 ~            	 call	#028E
 212++1488              	ELSE
 213++1488 CD 17 15     	 call	ScanAllKeys
 214++148B              	ENDIF
 215++148B 21 1C 17     	ld	hl,FlgScanKeys
 216++148E CB AE        	res	5,(hl)
 217++1490 CB BE        	res	7,(hl)
 218++1492 28 04        	jr	z,goto006		; - 
 219++1494 1E FF        goto021	ld	e,#FF
 220++1496 CB FE        	set	7,(hl)			;⨬ 
 221++1498
 222++1498              ;室, ᫨     
 223++1498 7B           goto006	ld	a,e
 224++1499 32 21 17     	ld	(ScanCodePresKey),a
 225++149C 3C           	inc	a
 226++149D 28 73        	jr	z,goto011
 227++149F
 228++149F              ;  ० ⮫쪮  cs+ss
 229++149F E5           	push	hl
 230++14A0 4E           	ld	c,(hl)			;c=(FlgScanKeys)
 231++14A1              	IFDEF	CommandMode
 232++14A1 CB 41        	 bit	0,c
 233++14A3 28 02        	 jr	z,goto018		;몫祭 Command Mode
 234++14A5              	 IFDEF	Used_ROM
 235++14A5 ~            	  ld	a,d
 236++14A5 ~            	  cp	#18
 237++14A5 ~            	  jr	z,goto019		; SS
 238++14A5              	 ELSE
 239++14A5 CB 8A        	  res	1,d			; SS
 240++14A7              	 ENDIF
 241++14A7              	ENDIF
 242++14A7
 243++14A7              ;塞    ⨭᪮ ᪫  ᪠ 
 244++14A7 7A           goto018	ld	a,d
 245++14A8              	IFDEF	Used_ROM
 246++14A8 ~            	 ld	hl,tableSSkeys
 247++14A8 ~            	 cp	#18
 248++14A8 ~            	 jr	z,goto007		; ⮩ ss
 249++14A8 ~            	 ld	hl,tableCSkeys
 250++14A8 ~            	 cp	#27
 251++14A8 ~            	 jr	z,goto007		; ⮩ cs
 252++14A8 ~            goto019	 ld	hl,tablePrnKeys
 253++14A8              	ELSE
 254++14A8 21 AC 15     	 ld	hl,tableSSkeys
 255++14AB FE 02        	 cp	#02
 256++14AD 28 12        	 jr	z,goto007		; ⮩ ss
 257++14AF              	 IFDEF	UseEXTkeys
 258++14AF 21 D4 15     	  ld	hl,tableEXTKeys
 259++14B2 CB E9        	  set	5,c			;  cs+ss
 260++14B4 30 0B        	  jr	nc,goto007		; ⮩ cs+ss
 261++14B6 CB A9        	  res	5,c
 262++14B8              	 ENDIF
 263++14B8 21 84 15     	 ld	hl,tableCSkeys
 264++14BB B7           	 or	a
 265++14BC 20 03        	 jr	nz,goto007		; ⮩ cs
 266++14BE 21 5C 15     	 ld	hl,tablePrnKeys
 267++14C1              	ENDIF
 268++14C1 16 00        goto007	ld	d,#00
 269++14C3 19           	add	hl,de
 270++14C4 5E           	ld	e,(hl)			; 
 271++14C5 E1           	pop	hl
 272++14C6 71           	ld	(hl),c
 273++14C7 7B           	ld	a,e
 274++14C8 3C           	inc	a
 275++14C9 28 C9        	jr	z,goto021
 276++14CB              ;de -   ⮩   ⨭᪮ ᪫   ० Caps
 277++14CB
 278++14CB              ;᫨ 祭  ० ⠭ ᨬ  孨 ॣ
 279++14CB              	IFDEF	CommandMode
 280++14CB 79           	 ld	a,c
 281++14CC E6 21        	 and	%00100001
 282++14CE 20 0D        	 jr	nz,goto020		;祭 Command Mode
 283++14D0              	ENDIF
 284++14D0
 285++14D0              ;४ ⭮   ⮬ ० CapsLock
 286++14D0 7B           	ld	a,e
 287++14D1 CB 49        	bit	1,c
 288++14D3 28 13        	jr	z,goto008		;caps 몫祭
 289++14D5 FE 41        	cp	"A"
 290++14D7 38 0F        	jr	c,goto008
 291++14D9 FE 5B        	cp	"Z"+1
 292++14DB 38 09        	jr	c,goto009
 293++14DD              	IFDEF	CommandMode
 294++14DD 7B           goto020	 ld	a,e
 295++14DE              	ENDIF
 296++14DE FE 61        	cp	"a"
 297++14E0 38 06        	jr	c,goto008
 298++14E2 FE 7B        	cp	"z"+1
 299++14E4 30 02        	jr	nc,goto008
 300++14E6 EE 20        goto009	xor	%00100000
 301++14E8 5F           goto008	ld	e,a
 302++14E9              ;de,a -   ⮩   ⨭᪮ ᪫
 303++14E9
 304++14E9              ; ८ࠧ, ᫨ 祭  ०
 305++14E9              	IFDEF	CommandMode
 306++14E9 79           	 ld	a,c
 307++14EA E6 21        	 and	%00100001
 308++14EC 7B           	 ld	a,e
 309++14ED 20 23        	 jr	nz,goto011		;祭 Command Mode
 310++14EF              	ENDIF
 311++14EF
 312++14EF              ;⠭ ⭮   ᮮ⢥⢨  祭 ᪫: Grf\Rus\Lat
 313++14EF              ;  grf ᪫
 314++14EF              	IFDEF	GrfMode
 315++14EF              	 IFDEF	InsideGrfTable
 316++14EF FE 20        	  cp	#20
 317++14F1 38 1F        	  jr	c,goto011
 318++14F3              	 ENDIF
 319++14F3 21 DC 15     	 ld	hl,TblKeyGrf
 320++14F6 CB 51        	 bit	2,c
 321++14F8 20 16        	 jr	nz,goto010		;祭 Grf
 322++14FA              	ENDIF
 323++14FA              ;  rus ᪫
 324++14FA              	IFDEF	RusMode
 325++14FA CB 59        	 bit	3,c
 326++14FC 28 14        	 jr	z,goto011		;᪫ rus 몫祭
 327++14FE              	 IFDEF	InsideRusTable
 328++14FE FE 20        	  cp	#20
 329++1500 38 10        	  jr	c,goto011
 330++1502              	 ENDIF
 331++1502              	 IFDEF	Rus_jcuken
 332++1502 21 9C 16     	  ld	hl,TblKeyRus_jcuken
 333++1505              	  IFDEF	Rus_qwerty
 334++1505 CB 61        	   bit	4,c
 335++1507 20 07        	   jr	nz,goto010		;祭 ᪫ Rus 㪥
 336++1509              	  ENDIF
 337++1509              	 ENDIF
 338++1509              	 IFDEF	Rus_qwerty
 339++1509 21 3C 16     	  ld	hl,TblKeyRus_qwerty
 340++150C              	 ENDIF
 341++150C 18 02        	 jr	goto010
 342++150E              	ENDIF
 343++150E 18 02        	jr	goto011
 344++1510 19           goto010	add	hl,de
 345++1511 5E           	ld	e,(hl)
 346++1512              ;e -   ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
 347++1512              ;     ⮬ ० CapsLock
 348++1512
 349++1512 7B           goto011 ld      a,e
 350++1513 32 20 17             ld      (PrintCodePresKey),a
 351++1516 C9                   ret
 352++1517
 353++1517              ;------------------------------------------------------------------------------
 354++1517              ScanAllKeys	ifused
 355++1517              ;    ( /  48k #028E)
 356++1517              ;ਬ砭: ⠡ ScanCode
 357++1517              ;Ŀ
 358++1517              ; 1  2  3  4  5  6  7  8  9  0 
 359++1517              ;#24#1C#14#0C#04#03#0B#13#1B#23
 360++1517              ;Ĵ
 361++1517              ; Q  W  Q  R  T  Y  U  I  O  P 
 362++1517              ;#25#1D#15#0D#05#02#0A#12#1A#22
 363++1517              ;Ĵ
 364++1517              ; A  S  D  F  G  h  J  K  L ent
 365++1517              ;#26#1E#16#0E#06#01#09#11#19#21
 366++1517              ;Ĵ
 367++1517              ;s  Z  X  C  V  B  N  M ss sp 
 368++1517              ;#27#1F#17#0F#07#00#08#10#18#20
 369++1517              ;
 370++1517              ;:  ----
 371++1517              ;: nz - ⨬ 
 372++1517              ;       hl,de,bc,a -  ।
 373++1517              ;     z  -       CS/SS    
 374++1517              ;       e =#FF -   
 375++1517              ;       0,d/c=1   c CS
 376++1517              ;       1,d/c=1   c SS
 377++1517              ;       e - ScanCode  ⮩ 
 378++1517              ;       a=#00
 379++1517              ;       hl,b -  ।
 380++1517              ;
 381++1517              ;ScanAllKeys
 382++1517              ;
 383++1517 2E 2F        	ld	l,#27+#08
 384++1519 11 FF FF     	ld	de,#FFFF
 385++151C 01 FF FE     	ld	bc,#FEFF
 386++151F
 387++151F              ;  ⠭ ⮢   ॣ c,d,e
 388++151F 78           loop003	ld	a,b
 389++1520 DB FE        	in	a,(#FE)
 390++1522 2F           	cpl
 391++1523 E6 1F        	and	#1F
 392++1525 28 0F        	jr	z,goto001
 393++1527 67           	ld	h,a
 394++1528 7D           	ld	a,l
 395++1529 0C           loop002	inc	c
 396++152A C0           	ret	nz			;   
 397++152B D6 08        loop001	sub	#08
 398++152D CB 3C        	srl	h
 399++152F 30 FA        	jr	nc,loop001
 400++1531 4A           	ld	c,d
 401++1532 53           	ld	d,e
 402++1533 5F           	ld	e,a			; ⮩ 
 403++1534 20 F3        	jr	nz,loop002
 404++1536 2D           goto001	dec	l
 405++1537 CB 00        	rlc	b
 406++1539 38 E4        	jr	c,loop003
 407++153B              ;=key 1, d=key 2, e=key 3
 408++153B              ;=#FF, d=key 1, e=key 2
 409++153B              ;=#FF, d=#FF, e=key 1
 410++153B
 411++153B              ;஢ઠ 権 
 412++153B 79           	ld	a,c
 413++153C 3C           	inc	a
 414++153D 28 04        	jr	z,goto002		;    
 415++153F D6 28        	sub	#27+1
 416++1541 C0           	ret	nz			;ࢠ   cs
 417++1542 3C           	inc	a
 418++1543 4F           goto002	ld	c,a			;0,c=0/1   cs/ cs
 419++1544 7A           	ld	a,d
 420++1545 3C           	inc	a
 421++1546 28 11        	jr	z,goto004		;   -> e - ᪠/#FF
 422++1548 FE 28        	cp	#27+1
 423++154A 28 0C        	jr	z,goto003
 424++154C FE 19        	cp	#18+1
 425++154E 28 05        	jr	z,goto005		; ss
 426++1550 7B           	ld	a,e
 427++1551 5A           	ld	e,d
 428++1552 FE 18        	cp	#18
 429++1554 C0           	ret	nz			;⨬ 
 430++1555 CB C9        goto005	set	1,c			; ss
 431++1557 0D           	dec	c
 432++1558 0C           goto003	inc	c
 433++1559 51           goto004	ld	d,c			;0,d=0/1 cs  /
 434++155A AF           	xor	a			;1,d=0/1 ss  /
 435++155B C9           	ret
 436++155C
 437++155C                      endif
 438++155C
 439++155C              ;==============================================================================
 440++155C              		ifused	tablePrnKeys
 441++155C              ;⠡  
 442++155C              ;cs - off
 443++155C              ;ss - off
 444++155C              ;
 445++155C 62 68 79 36  tablePrnKeys	db "bhy65tgv"	;#00-#07
 445++1560 35 74 67 76
 446++1564 6E 6A 75 37  		db "nju74rfc"	;#08-#0F
 446++1568 34 72 66 63
 447++156C 6D 6B 69 38  		db "mki83edx"	;#10-#17
 447++1570 33 65 64 78
 448++1574 1D           		db keySS	;#18
 449++1575 6C 6F 39 32  		db "lo92wsz"	;#19-#1F
 449++1579 77 73 7A
 450++157C 20           		db " "		;#20
 451++157D 0D           		db keyEnter	;#21
 452++157E 70 30 31 71  		db "p01qa"	;#22-#26
 452++1582 61
 453++1583 1C           		db keyCS	;#27
 454++1584
 455++1584              		endif
 456++1584
 457++1584              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 458++1584              		ifused	tableCSkeys
 459++1584              ;⠡  
 460++1584              ;cs - on
 461++1584              ;ss - off
 462++1584              ;
 463++1584 42 48 59     tableCSkeys	db "BHY"	;#00-#02
 464++1587 0A           		db keyDown	;#03
 465++1588 08           		db keyLeft	;#04
 466++1589 54 47 56     		db "TGV"	;#05-#07
 467++158C 4E 4A 55     		db "NJU"	;#08-#0A
 468++158F 0B           		db keyUp	;#0B
 469++1590 05           		db keyPageDown	;#0C
 470++1591 52 46 43     		db "RFC"	;#0D-#0F
 471++1594 4D 4B 49     		db "MKI"	;#10-#12
 472++1597 09           		db keyRight	;#13
 473++1598 04           		db keyPageUp	;#14
 474++1599 45 44 58     		db "EDX"	;#15-#17
 475++159C 0E           		db keyExtMode	;#18
 476++159D 4C 4F        		db "LO"		;#19-#1A
 477++159F 0F           		db keyDelete	;#1B
 478++15A0 06           		db keyCaps	;#1C
 479++15A1 57 53 5A     		db "WSZ"	;#1D-#1F
 480++15A4 18           		db keyBreak	;#20
 481++15A5 19           		db keyCsEnter	;#21
 482++15A6 50           		db "P"		;#22
 483++15A7 0C           		db keyBackSpace	;#23
 484++15A8 07           		db keyEdit	;#24
 485++15A9 51 41        		db "QA"		;#25-#26
 486++15AB 1C           		db keyCS	;#27
 487++15AC
 488++15AC              		endif
 489++15AC
 490++15AC              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 491++15AC              		ifused	tableSSkeys
 492++15AC              ;⠡  
 493++15AC              ;cs - off
 494++15AC              ;ss - on
 495++15AC              ;
 496++15AC 2A 5E 5B 26  tableSSkeys	db "*^[&%>}/"	;#00-#07
 496++15B0 25 3E 7D 2F
 497++15B4 2C 2D 5D 27  		db ",-]'$<{?"	;#08-#0F
 497++15B8 24 3C 7B 3F
 498++15BC 2E 2B 7F 28  		db ".+(#"	;#10-#14
 498++15C0 23
 499++15C1 03           		db keyEnd	;#15
 500++15C2 5C 60        		db #5C,#60	;#16-#17 (\`)
 501++15C4 1D           		db keySS	;#18
 502++15C5 3D 3B 29 40  		db "=;)@"	;#19-#1C
 503++15C9 02           		db keyInsert	;#1D
 504++15CA 7C 3A        		db "|:"		;#1E-#1F
 505++15CC 1A           		db keySsSpace	;#20
 506++15CD 1B           		db keySsEnter	;#21
 507++15CE 22           		db #22		;#22 (")
 508++15CF 5F 21        		db "_!"		;#23-#24
 509++15D1 01           		db keyHome	;#25
 510++15D2 7E           		db "~"		;#26
 511++15D3 0E           		db keyExtMode	;#27
 512++15D4
 513++15D4              		endif
 514++15D4
 515++15D4              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 516++15D4              		ifused	tableEXTKeys
 517++15D4              ;⠡  , ᪫  ZX-Word
 518++15D4              ;cs - on
 519++15D4              ;ss - on
 520++15D4              ;
 521++15D4              tableEXTKeys
 522++15D4
 523++15D4              		IFDEF	TblEXTkey_Test	;⮢ ᪫
 524++15D4 42 48 59     		db "BHY"	;#00-#02
 525++15D7 03           		db keyEnd	;#03 key 6
 526++15D8 10           		db keyWordLeft	;#04 key 5
 527++15D9 54 47 56     		db "TGV"	;#05-#07
 528++15DC 4E 4A 55     		db "NJU"	;#08-#0A
 529++15DF 01           		db keyHome	;#0B key 7
 530++15E0 FF           		db #FF		;#0C key 4
 531++15E1 52 46 43     		db "RFC"	;#0D-#0F
 532++15E4 4D 4B 49     		db "MKI"	;#10-#12
 533++15E7 11           		db keyWordRight	;#13 key 8
 534++15E8 FF           		db #FF		;#14 key 3
 535++15E9 45 44 58     		db "EDX"	;#15-#17
 536++15EC FF           		db #FF		;#18 key SS
 537++15ED 4C 4F        		db "LO"		;#19-#1A
 538++15EF 13           		db keyDelEnd	;#1B key 9
 539++15F0 FF           		db #FF		;#1C key 2
 540++15F1 57 53 5A     		db "WSZ"	;#1D-#1F
 541++15F4 14           		db keyCsSsSpace	;#20
 542++15F5 15           		db keyCsSsEnter	;#21
 543++15F6 50           		db "P"		;#22
 544++15F7 16           		db keyDelBegin	;#23 key 0
 545++15F8 12           		db keyGrf	;#24 key 1
 546++15F9 51 41        		db "QA"		;#25-#26
 547++15FB FF           		db #FF		;#27 key CS
 548++15FC              		ENDIF
 549++15FC
 550++15FC              		IFDEF	TblEXTkey_Word	; ZX-Word
 551++15FC ~            		db "BHY"	;#00-#02
 552++15FC ~            		db keyEnd	;#03 key 6
 553++15FC ~            		db keyWordLeft	;#04 key 5
 554++15FC ~            		db "TG",#FF	;#05-#07
 555++15FC ~            		db #FF,#FF,#FF	;#08-#0A
 556++15FC ~            		db keyHome	;#0B key 7
 557++15FC ~            		db #FF		;#0C key 4
 558++15FC ~            		db "RFC"	;#0D-#0F
 559++15FC ~            		db #FF,#FF,#FF	;#10-#12
 560++15FC ~            		db keyWordRight	;#13 key 8
 561++15FC ~            		db #FF		;#14 key 3
 562++15FC ~            		db "EDX"	;#15-#17
 563++15FC ~            		db #FF		;#18 key SS
 564++15FC ~            		db #FF,"O"	;#19-#1A
 565++15FC ~            		db keyDelete	;#1B key 9
 566++15FC ~            		db keyInsert	;#1C key 2
 567++15FC ~            		db #FF,#FF,"Z"	;#1D-#1F
 568++15FC ~            		db #FF		;#20
 569++15FC ~            		db #FF		;#21
 570++15FC ~            		db "P"		;#22
 571++15FC ~            		db keyBackSpace	;#23 key 0
 572++15FC ~            		db keyEdit	;#24 key 1
 573++15FC ~            		db "Q",#FF	;#25-#26
 574++15FC ~            		db #FF		;#27 key CS
 575++15FC              		ENDIF
 576++15FC
 577++15FC              		endif
 578++15FC
 579++15FC              ;------------------------------------------------------------------------------
 580++15FC              	IFDEF	GrfMode
 581++15FC              	IFDEF	TblKeyGrf_ver1
 582++15FC              	IFDEF	InsideGrfTable
 583++15FC
 584++15FC              ;᪠ ᪫: version 01
 585++15FC              ;
 586++15FC              TblKeyGrf	equ $-#20
 587++15FC              ;
 588++15FC              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 589++15FC              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 590++15FC              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 591++15FC              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 592++15FC 20 21 22 23  	db " !",#22,"#$%&'"
 592++1600 24 25 26 27
 593++1604 28 29 2A 2B  	db "()*+,-./"
 593++1608 2C 2D 2E 2F
 594++160C 30 31 32 33  	db "01234567"
 594++1610 34 35 36 37
 595++1614 38 39 3A 3B  	db "89:;<=>?"
 595++1618 3C 3D 3E 3F
 596++161C 40 C7 D4 BD  	db "@Խ"
 596++1620 B6 B7 BA C6
 597++1624 D8 CD B5 B3  	db "͵۾"
 597++1628 DB BE CF DD
 598++162C DE D6 C4 D7  	db "ո"
 598++1630 D5 B8 F0 D2
 599++1634 D0 D1 D3 5B  	db "[",#5C,"]^_"
 599++1638 5C 5D 5E 5F
 600++163C 60 C3 C8 D9  	db "`ٴ"
 600++1640 B4 BF B3 CC
 601++1644 CE CD B9 BA  	db "͹ʱ"
 601++1648 B0 BC CA B1
 602++164C B2 DA C4 C5  	db "ɻ"
 602++1650 C9 BB FB C2
 603++1654 C1 CB C0 7B  	db "{|}~"
 603++1658 7C 7D 7E 7F
 604++165C
 605++165C              	ELSE
 606++165C ~            TblKeyGrf	equ	OutsideGrfTable
 607++165C              	ENDIF
 608++165C              	ENDIF
 609++165C              	ENDIF
 610++165C
 611++165C              ;------------------------------------------------------------------------------
 612++165C              	IFDEF	RusMode
 613++165C              	IFDEF	Rus_qwerty
 614++165C              	IFDEF	InsideRusTable
 615++165C
 616++165C              ;᪠ ᪫: 
 617++165C              ;
 618++165C              TblKeyRus_qwerty	equ $-#20
 619++165C              ;
 620++165C              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 621++165C              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 622++165C              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 623++165C              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 624++165C 20 21 22 23  	db " !",#22,"#$%&'"
 624++1660 24 25 26 27
 625++1664 28 29 2A 2B  	db "()*+,-./"
 625++1668 2C 2D 2E 2F
 626++166C 30 31 32 33  	db "01234567"
 626++1670 34 35 36 37
 627++1674 38 39 3A 3B  	db "89:;<=>?"
 627++1678 3C 3D 3E 3F
 628++167C 40 80 81 96  	db "@"
 628++1680 84 85 94 83
 629++1684 95 88 89 8A  	db ""
 629++1688 8B 8C 8D 8E
 630++168C 8F 9F 90 91  	db ""
 630++1690 92 93 86 82
 631++1694 9C 9B 87 5B  	db "[",#5C,"]^"
 631++1698 5C 5D 5E 9A
 632++169C 9E A0 A1 E6  	db "椥"
 632++16A0 A4 A5 E4 A3
 633++16A4 E5 A8 A9 AA  	db "娩"
 633++16A8 AB AC AD AE
 634++16AC AF EF E0 E1  	db "㦢"
 634++16B0 E2 E3 A6 A2
 635++16B4 EC EB A7 98  	db "맘"
 635++16B8 9D 99 97 7F
 636++16BC
 637++16BC              	ELSE
 638++16BC ~            TblKeyRus_qwerty	equ	OutsideRus_qwerty
 639++16BC              	ENDIF
 640++16BC              	ENDIF
 641++16BC              	ENDIF
 642++16BC
 643++16BC              ;------------------------------------------------------------------------------
 644++16BC              	IFDEF	RusMode
 645++16BC              	IFDEF	Rus_jcuken
 646++16BC              	IFDEF	InsideRusTable
 647++16BC
 648++16BC              ;᪠ ᪫: 㪥
 649++16BC              ;
 650++16BC              TblKeyRus_jcuken	equ	$-#20
 651++16BC              ;
 652++16BC              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 653++16BC              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 654++16BC              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 655++16BC              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 656++16BC 20 21 22 23  	db " !",#22,"#$%&'"
 656++16C0 24 25 26 27
 657++16C4 28 29 2A 2B  	db "()*+,-./"
 657++16C8 2C 2D 2E 2F
 658++16CC 30 31 32 33  	db "01234567"
 658++16D0 34 35 36 37
 659++16D4 38 39 3A 3B  	db "89:;<=>?"
 659++16D8 3C 3D 3E 3F
 660++16DC 9E 94 88 91  	db ""
 660++16E0 82 93 80 8F
 661++16E4 90 98 8E 8B  	db ""
 661++16E8 84 9C 92 99
 662++16EC 87 89 8A 9B  	db ""
 662++16F0 85 83 8C 96
 663++16F4 97 8D 9F 95  	db ""
 663++16F8 9D 86 81 9A
 664++16FC EE E4 A8 E1  	db "㠯"
 664++1700 A2 E3 A0 AF
 665++1704 E0 E8 AE AB  	db "讫"
 665++1708 A4 EC E2 E9
 666++170C A7 A9 AA EB  	db "륣"
 666++1710 A5 A3 AC E6
 667++1714 E7 AD EF E5  	db ""
 667++1718 ED A6 A1 7F
 668++171C
 669++171C              	ELSE
 670++171C ~            TblKeyRus_jcuken	equ	OutsideRus_jcuken
 671++171C              	ENDIF
 672++171C              	ENDIF
 673++171C              	ENDIF
 674++171C
 675++171C              ;------------------------------------------------------------------------------
 676++171C              	ifused	TblKeyLat
 677++171C ~            ;⠭⭠ ⨭᪠ ᪫
 678++171C ~            ;
 679++171C ~            TblKeyLat	equ	$-#20
 680++171C ~            ;
 681++171C ~            ;	db #00,#01,#02,#03,#04,#05,#06,#07
 682++171C ~            ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 683++171C ~            ;	db #10,#11,#12,#13,#14,#15,#16,#17
 684++171C ~            ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 685++171C ~            	db " !",""","#$%&'"
 686++171C ~            	db "()*+,-./"
 687++171C ~            	db "01234567"
 688++171C ~            	db "89:;<=>?"
 689++171C ~            	db "@ABCDEFG"
 690++171C ~            	db "HIJKLMNO"
 691++171C ~            	db "PQRSTUVW"
 692++171C ~            	db "XYZ[\]^_"
 693++171C ~            	db "`abcdefg"
 694++171C ~            	db "hijklmno"
 695++171C ~            	db "pqrstuvw"
 696++171C ~            	db "xyz{|}~"
 697++171C ~
 698++171C              	endif
 699++171C
 700++171C              ;==============================================================================
 701++171C
# file closed: Drv/DrvKey.asm.a80
 117+ 171C              	INCLUDE	"DrvKey.var.a80"
# file opened: Drv/DrvKey.var.a80
   1++171C              ;६ Keyboard Driver
   2++171C              ;䠩 DrvKey.var.a80
   3++171C              ;
   4++171C              ;䫠 ࠩ
   5++171C              ;7,=1     
   6++171C              ;6,=1     
   7++171C              ;5,=1 ᨬ  ० cs+ss+key
   8++171C              ;4,=1/0 Rus 㪥/Rus 
   9++171C              ;3,=1/0 Rus/Lat
  10++171C              ;2,=1/0 Grf on/off
  11++171C              ;1,=1/0 CapsLock on/off
  12++171C              ;0,=1/0 Command on/off
  13++171C 30           FlgScanKeys     db %00110000
  14++171D 00           		db %00000000	;१
  15++171E
  16++171E              ;稭 প  ⮯
  17++171E 0F           KeyRepeatDelay    db #0F
  18++171F              ;ਮ ⮯
  19++171F 05           KeyRepeatPeriod   db #05
  20++1720
  21++1720              ;  ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
  22++1720              ;   ⮬ ० CapsLock
  23++1720 00           PrintCodePresKey  db #00
  24++1721              ;᪠ ⮩ 
  25++1721 00           ScanCodePresKey   db #00
  26++1722
  27++1722
# file closed: Drv/DrvKey.var.a80
 118+ 1722              End	DISPLAY	"Lenght DrvKey = ",/A,End-Start
 119+ 1722              ;	SAVEBIN	"!bin/drvkeys.bin",Start,End-Start
 120+ 1722              	ENDMODULE
 121+ 1722
# file closed: Drv/DrvKey.main.a80
2588  1722              	include player.asm ;плеер AY, TS
# file opened: player.asm
   1+ 1722              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2+ 1722              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3+ 1722              ;Specially for AlCo
   4+ 1722              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5+ 1722              	MODULE VTPL
   6+ 1722              ;Release number
   7+ 1722              Release EQU "0"
   8+ 1722              ;Conditional assembly
   9+ 1722              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10+ 1722              CurPosCounter=1
  11+ 1722              ;2) Allow channels allocation bits at (START+10)
  12+ 1722              ACBBAC=0
  13+ 1722              ;3) Allow loop checking and disabling
  14+ 1722              LoopChecker=1
  15+ 1722              ;4) Insert official identificator
  16+ 1722              Id=0
  17+ 1722              ;5) Set IY for correct return to ZX Basic
  18+ 1722              Basic=1
  19+ 1722
  20+ 1722              ;Features
  21+ 1722              ;--------
  22+ 1722              ;-Can be compiled at any address (i.e. no need rounding ORG
  23+ 1722              ; address).
  24+ 1722              ;-Variables (VARS) can be located at any address (not only after
  25+ 1722              ; code block).
  26+ 1722              ;-INIT subprogram checks PT3-module version and rightly
  27+ 1722              ; generates both note and volume tables outside of code block
  28+ 1722              ; (in VARS).
  29+ 1722              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30+ 1722              ; PT3 module version).
  31+ 1722              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32+ 1722              ; and higher).
  33+ 1722              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34+ 1722              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35+ 1722              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36+ 1722              ;-See also notes at the end of this source code.
  37+ 1722
  38+ 1722              ;Limitations
  39+ 1722              ;-----------
  40+ 1722              ;-Can run in RAM only (self-modified code is used).
  41+ 1722              ;-PT2 position list must be end by #FF marker only.
  42+ 1722
  43+ 1722              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44+ 1722              ;into RAM or INIT subprogram was not called before.
  45+ 1722
  46+ 1722              ;Call MUTE or INIT one more time to mute sound after stopping
  47+ 1722              ;playing
  48+ 1722
  49+ 1722              ;Test codes (commented)
  50+ 1722              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51+ 1722              ;	LD (START+10),A
  52+ 1722              ;	LD HL,#8000 ;Mod1
  53+ 1722              ;	LD DE,#A000 ;Mod2 (optional)
  54+ 1722              ;	CALL START+3
  55+ 1722              ;	EI
  56+ 1722              ;_LP	HALT
  57+ 1722              ;	CALL START+5
  58+ 1722              ;	XOR A
  59+ 1722              ;	IN A,(#FE)
  60+ 1722              ;	CPL
  61+ 1722              ;	AND 15
  62+ 1722              ;	JR Z,_LP
  63+ 1722              ;	JR START+8
  64+ 1722
  65+ 1722              TonA	EQU 0
  66+ 1722              TonB	EQU 2
  67+ 1722              TonC	EQU 4
  68+ 1722              Noise	EQU 6
  69+ 1722              Mixer	EQU 7
  70+ 1722              AmplA	EQU 8
  71+ 1722              AmplB	EQU 9
  72+ 1722              AmplC	EQU 10
  73+ 1722              Env	EQU 11
  74+ 1722              EnvTp	EQU 13
  75+ 1722
  76+ 1722              ;Entry and other points
  77+ 1722              ;START initialize playing of modules at MDLADDR (single module)
  78+ 1722              ;START+3 initialization with module address in HL and DE (TS)
  79+ 1722              ;START+5 play one quark
  80+ 1722              ;START+8 mute
  81+ 1722              ;START+10 setup and status flags
  82+ 1722
  83+ 1722              START:
  84+ 1722 21 00 C0     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85+ 1725 18 3C        	JR INIT
  86+ 1727 C3 93 1F     	JP PLAY
  87+ 172A 18 25        	JR MUTE
  88+ 172C 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89+ 172D              	     ;(optional);
  90+ 172D              	     ;set bit1 for PT2 and reset for PT3 before
  91+ 172D              	     ;calling INIT;
  92+ 172D              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93+ 172D              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94+ 172D              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95+ 172D              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96+ 172D              	     ;documented and must be converted to new standard.
  97+ 172D              	     ;bit6 is set each time, when loop point of 2nd TS
  98+ 172D              	     ;module is passed (optional).
  99+ 172D              	     ;bit7 is set each time, when loop point of 1st TS
 100+ 172D              	     ;or of single module is passed (optional).
 101+ 172D
 102+ 172D              ;Identifier
 103+ 172D              	IF Id
 104+ 172D ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105+ 172D              	ENDIF
 106+ 172D
 107+ 172D              	IF LoopChecker
 108+ 172D 21 2C 17     CHECKLP	LD HL,SETUP
 109+ 1730 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110+ 1734 28 04        	JR Z,CHL1
 111+ 1736 CB F6        	SET 6,(HL)
 112+ 1738 18 02        	JR CHL2
 113+ 173A CB FE        CHL1	SET 7,(HL)
 114+ 173C CB 46        CHL2	BIT 0,(HL)
 115+ 173E C8           	RET Z
 116+ 173F E1           	POP HL
 117+ 1740 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118+ 1743 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119+ 1746 AF           	XOR A
 120+ 1747 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121+ 174A FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122+ 174D FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123+ 1750 C9           	RET
 124+ 1751              	ENDIF
 125+ 1751
 126+ 1751 AF           MUTE: XOR A
 127+ 1752 67           	LD H,A
 128+ 1753 6F           	LD L,A
 129+ 1754 32 E8 20     	LD (VARS1+VRS.AYREGS+AmplA),A
 130+ 1757 22 E9 20     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131+ 175A 32 6F 21     	LD (VARS2+VRS.AYREGS+AmplA),A
 132+ 175D 22 70 21     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133+ 1760 C3 AB 1F     	JP ROUT
 134+ 1763
 135+ 1763              INIT:
 136+ 1763              ;HL - AddressOfModule
 137+ 1763              ;DE - AddresOf2ndModule
 138+ 1763 D5           	PUSH DE
 139+ 1764 E5           	PUSH HL
 140+ 1765 21 66 20     	LD HL,VARS
 141+ 1768 36 00        	LD (HL),0
 142+ 176A 11 67 20     	LD DE,VARS+1
 143+ 176D 01 0E 01     	LD BC,VAR0END-VARS-1
 144+ 1770 ED B0        	LDIR
 145+ 1772 23           	INC HL
 146+ 1773 22 C9 20     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147+ 1776 22 50 21     	LD (VARS2+VRS.AdInPtA),HL
 148+ 1779
 149+ 1779 E1           	POP HL
 150+ 177A FD 21 CB 20  	LD IY,VARS1+100
 151+ 177E 3A 2C 17     	LD A,(START+10)
 152+ 1781 E6 02        	AND 2
 153+ 1783 C2 0C 18     	JP NZ,I_PT2
 154+ 1786
 155+ 1786 CD 59 19     	CALL INITPT3
 156+ 1789 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157+ 178C 22 32 1D     	LD (SamCnv),HL
 158+ 178F 3E BA        	LD A,#BA
 159+ 1791 32 FD 1C     	LD (OrnCP),A
 160+ 1794 32 29 1D     	LD (SamCP),A
 161+ 1797 3E 7B        	LD A,#7B
 162+ 1799 32 00 1D     	LD (OrnLD),A
 163+ 179C 32 2C 1D     	LD (SamLD),A
 164+ 179F 3E 87        	LD A,#87
 165+ 17A1 32 23 1D     	LD (SamClc2),A
 166+ 17A4 E1           	POP HL
 167+ 17A5              	;Use version and ton table of 1st module
 168+ 17A5 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169+ 17A8 D6 30        	SUB #30
 170+ 17AA 38 04        	JR C,L20
 171+ 17AC FE 0A        	CP 10
 172+ 17AE 38 02        	JR C,L21
 173+ 17B0 3E 06        L20	LD A,6
 174+ 17B2 32 D0 1B     L21	LD (Version),A
 175+ 17B5 F5           	PUSH AF ;VolTable version
 176+ 17B6 FE 04        	CP 4
 177+ 17B8 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178+ 17BB 17           	RLA
 179+ 17BC E6 07        	AND 7
 180+ 17BE F5           	PUSH AF ;NoteTable number
 181+ 17BF
 182+ 17BF FD 21 52 21  	LD IY,VARS2+100
 183+ 17C3 3A 2C 17     	LD A,(START+10)
 184+ 17C6 E6 30        	AND 48
 185+ 17C8 28 37        	JR Z,NOTS
 186+ 17CA FE 10        	CP 16
 187+ 17CC 28 27        	JR Z,TwoPT3s
 188+ 17CE 3A D0 1B     	LD A,(Version)
 189+ 17D1 FE 07        	CP 7
 190+ 17D3 38 2C        	JR C,NOTS
 191+ 17D5 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192+ 17D8 FE 20        	CP #20
 193+ 17DA 28 25        	JR Z,NOTS
 194+ 17DC 21 67 20     	LD HL,VARS1
 195+ 17DF 11 EE 20     	LD DE,VARS2
 196+ 17E2 01 87 00     	LD BC,VRS
 197+ 17E5 ED B0        	LDIR
 198+ 17E7 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199+ 17EB 4F           	LD C,A
 200+ 17EC 87           	ADD A,A
 201+ 17ED 81           	ADD A,C
 202+ 17EE D6 02        	SUB 2
 203+ 17F0 32 97 1E     	LD (TSSub),A
 204+ 17F3 18 03        	JR AlCoTS_
 205+ 17F5 CD 59 19     TwoPT3s	CALL INITPT3
 206+ 17F8 3E 01        AlCoTS_	LD A,1
 207+ 17FA 32 66 20     	LD (is_ts),A
 208+ 17FD FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209+ 1801
 210+ 1801 01 1C 1B     NOTS	LD BC,PT3PD
 211+ 1804 21 00 00     	LD HL,0
 212+ 1807 11 2E 20     	LD DE,PT3EMPTYORN
 213+ 180A 18 48        	JR INITCOMMON
 214+ 180C
 215+ 180C CD 94 19     I_PT2	CALL INITPT2
 216+ 180F 21 CB 51     	LD HL,#51CB
 217+ 1812 22 32 1D     	LD (SamCnv),HL
 218+ 1815 3E BB        	LD A,#BB
 219+ 1817 32 FD 1C     	LD (OrnCP),A
 220+ 181A 32 29 1D     	LD (SamCP),A
 221+ 181D 3E 7A        	LD A,#7A
 222+ 181F 32 00 1D     	LD (OrnLD),A
 223+ 1822 32 2C 1D     	LD (SamLD),A
 224+ 1825 3E 80        	LD A,#80
 225+ 1827 32 23 1D     	LD (SamClc2),A
 226+ 182A E1           	POP HL
 227+ 182B 3E 05        	LD A,5
 228+ 182D 32 D0 1B     	LD (Version),A
 229+ 1830 F5           	PUSH AF
 230+ 1831 3E 02        	LD A,2
 231+ 1833 F5           	PUSH AF
 232+ 1834
 233+ 1834 3A 2C 17     	LD A,(START+10)
 234+ 1837 E6 30        	AND 48
 235+ 1839 28 10        	JR Z,NOTS2
 236+ 183B
 237+ 183B FD 21 52 21  	LD IY,VARS2+100
 238+ 183F 3E 01        	LD A,1
 239+ 1841 32 66 20     	LD (is_ts),A
 240+ 1844 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241+ 1848 CD 94 19     	CALL INITPT2
 242+ 184B
 243+ 184B 01 56 1A     NOTS2	LD BC,PT2PD
 244+ 184E 21 87 86     	LD HL,#8687
 245+ 1851 11 84 21     	LD DE,PT2EMPTYORN
 246+ 1854
 247+ 1854              INITCOMMON
 248+ 1854
 249+ 1854              	IF Basic
 250+ 1854 FD 21 3A 5C  	LD IY,#5C3A
 251+ 1858              	ENDIF
 252+ 1858
 253+ 1858 ED 43 07 1A  	LD (PTDEC),BC
 254+ 185C 22 99 1E     	LD (PsCalc),HL
 255+ 185F D5           	PUSH DE
 256+ 1860
 257+ 1860              ;note table data depacker
 258+ 1860              ;(c) Ivan Roshin
 259+ 1860 11 31 20     	LD DE,T_PACK
 260+ 1863 01 D6 21     	LD BC,T1_+(2*49)-1
 261+ 1866 1A           TP_0	LD A,(DE)
 262+ 1867 13           	INC DE
 263+ 1868 FE 1E        	CP 15*2
 264+ 186A 30 06        	JR NC,TP_1
 265+ 186C 67           	LD H,A
 266+ 186D 1A           	LD A,(DE)
 267+ 186E 6F           	LD L,A
 268+ 186F 13           	INC DE
 269+ 1870 18 07        	JR TP_2
 270+ 1872 D5           TP_1	PUSH DE
 271+ 1873 16 00        	LD D,0
 272+ 1875 5F           	LD E,A
 273+ 1876 19           	ADD HL,DE
 274+ 1877 19           	ADD HL,DE
 275+ 1878 D1           	POP DE
 276+ 1879 7C           TP_2	LD A,H
 277+ 187A 02           	LD (BC),A
 278+ 187B 0B           	DEC BC
 279+ 187C 7D           	LD A,L
 280+ 187D 02           	LD (BC),A
 281+ 187E 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282+ 187F D6 F0        	SUB #F8*2
 283+ 1881 20 E3        	JR NZ,TP_0
 284+ 1883
 285+ 1883 3C           	INC A
 286+ 1884 32 D4 20     	LD (VARS1+VRS.DelyCnt),A
 287+ 1887 32 5B 21     	LD (VARS2+VRS.DelyCnt),A
 288+ 188A 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289+ 188D 22 85 20     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290+ 1890 22 A2 20     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291+ 1893 22 BF 20     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292+ 1896 22 0C 21     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293+ 1899 22 29 21     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294+ 189C 22 46 21     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295+ 189F E1           	POP HL
 296+ 18A0 22 77 20     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297+ 18A3 22 94 20     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298+ 18A6 22 B1 20     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299+ 18A9 22 FE 20     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300+ 18AC 22 1B 21     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301+ 18AF 22 38 21     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302+ 18B2
 303+ 18B2 F1           	POP AF
 304+ 18B3
 305+ 18B3              ;NoteTableCreator (c) Ivan Roshin
 306+ 18B3              ;A - NoteTableNumber*2+VersionForNoteTable
 307+ 18B3              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308+ 18B3
 309+ 18B3 21 DE 1F     	LD HL,NT_DATA
 310+ 18B6 16 00        	LD D,0
 311+ 18B8 87           	ADD A,A
 312+ 18B9 5F           	LD E,A
 313+ 18BA 19           	ADD HL,DE
 314+ 18BB 5E           	LD E,(HL)
 315+ 18BC 23           	INC HL
 316+ 18BD CB 3B        	SRL E
 317+ 18BF 9F           	SBC A,A
 318+ 18C0 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319+ 18C2 32 EA 18     	LD (L3),A
 320+ 18C5 EB           	EX DE,HL
 321+ 18C6 01 75 21     	LD BC,T1_
 322+ 18C9 09           	ADD HL,BC
 323+ 18CA
 324+ 18CA 1A           	LD A,(DE)
player.asm(325): warning: value 0x1FEE is truncated to 8bit value: 0xEE
 325+ 18CB C6 EE        	ADD A,T_
 326+ 18CD 4F           	LD C,A
 327+ 18CE CE 1F        	ADC A,T_/256
 328+ 18D0 91           	SUB C
 329+ 18D1 47           	LD B,A
 330+ 18D2 C5           	PUSH BC
 331+ 18D3 11 65 22     	LD DE,NT_
 332+ 18D6 D5           	PUSH DE
 333+ 18D7
 334+ 18D7 06 0C        	LD B,12
 335+ 18D9 C5           L1	PUSH BC
 336+ 18DA 4E           	LD C,(HL)
 337+ 18DB 23           	INC HL
 338+ 18DC E5           	PUSH HL
 339+ 18DD 46           	LD B,(HL)
 340+ 18DE
 341+ 18DE D5           	PUSH DE
 342+ 18DF EB           	EX DE,HL
 343+ 18E0 11 17 00     	LD DE,23
 344+ 18E3 DD 26 08     	LD IXH,8
 345+ 18E6
 346+ 18E6 CB 38        L2	SRL B
 347+ 18E8 CB 19        	RR C
 348+ 18EA 19           L3	DB #19	;AND A or NOP
 349+ 18EB 79           	LD A,C
 350+ 18EC 8A           	ADC A,D	;=ADC 0
 351+ 18ED 77           	LD (HL),A
 352+ 18EE 23           	INC HL
 353+ 18EF 78           	LD A,B
 354+ 18F0 8A           	ADC A,D
 355+ 18F1 77           	LD (HL),A
 356+ 18F2 19           	ADD HL,DE
 357+ 18F3 DD 25        	DEC IXH
 358+ 18F5 20 EF        	JR NZ,L2
 359+ 18F7
 360+ 18F7 D1           	POP DE
 361+ 18F8 13           	INC DE
 362+ 18F9 13           	INC DE
 363+ 18FA E1           	POP HL
 364+ 18FB 23           	INC HL
 365+ 18FC C1           	POP BC
 366+ 18FD 10 DA        	DJNZ L1
 367+ 18FF
 368+ 18FF E1           	POP HL
 369+ 1900 D1           	POP DE
 370+ 1901
 371+ 1901 7B           	LD A,E
player.asm(372): warning: value 0x1FFA is truncated to 8bit value: 0xFA
 372+ 1902 FE FA        	CP TCOLD_1
 373+ 1904 20 05        	JR NZ,CORR_1
 374+ 1906 3E FD        	LD A,#FD
 375+ 1908 32 93 22     	LD (NT_+#2E),A
 376+ 190B
 377+ 190B 1A           CORR_1	LD A,(DE)
 378+ 190C A7           	AND A
 379+ 190D 28 11        	JR Z,TC_EXIT
 380+ 190F 1F           	RRA
 381+ 1910 F5           	PUSH AF
 382+ 1911 87           	ADD A,A
 383+ 1912 4F           	LD C,A
 384+ 1913 09           	ADD HL,BC
 385+ 1914 F1           	POP AF
 386+ 1915 30 02        	JR NC,CORR_2
 387+ 1917 35           	DEC (HL)
 388+ 1918 35           	DEC (HL)
 389+ 1919 34           CORR_2	INC (HL)
 390+ 191A A7           	AND A
 391+ 191B ED 42        	SBC HL,BC
 392+ 191D 13           	INC DE
 393+ 191E 18 EB        	JR CORR_1
 394+ 1920
 395+ 1920              TC_EXIT
 396+ 1920
 397+ 1920 F1           	POP AF
 398+ 1921
 399+ 1921              ;VolTableCreator (c) Ivan Roshin
 400+ 1921              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401+ 1921              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402+ 1921
 403+ 1921 FE 05        	CP 5
 404+ 1923 21 11 00     	LD HL,#11
 405+ 1926 54           	LD D,H
 406+ 1927 5C           	LD E,H
 407+ 1928 3E 17        	LD A,#17
 408+ 192A 30 03        	JR NC,M1
 409+ 192C 2D           	DEC L
 410+ 192D 5D           	LD E,L
 411+ 192E AF           	XOR A
 412+ 192F 32 40 19     M1      LD (M2),A
 413+ 1932
 414+ 1932 DD 21 75 21  	LD IX,VT_+16
 415+ 1936
 416+ 1936 0E 0F        	LD C,#F
 417+ 1938 E5           INITV2  PUSH HL
 418+ 1939
 419+ 1939 19           	ADD HL,DE
 420+ 193A EB           	EX DE,HL
 421+ 193B ED 62        	SBC HL,HL
 422+ 193D
 423+ 193D 06 10        	LD B,#10
 424+ 193F 7D           INITV1  LD A,L
 425+ 1940 7D           M2      DB #7D
 426+ 1941 7C           	LD A,H
 427+ 1942 CE 00        	ADC A,0
 428+ 1944 DD 77 00     	LD (IX),A
 429+ 1947 DD 23        	INC IX
 430+ 1949 19           	ADD HL,DE
 431+ 194A 10 F3        	DJNZ INITV1
 432+ 194C
 433+ 194C E1           	POP HL
 434+ 194D 7B           	LD A,E
 435+ 194E FE 77        	CP #77
 436+ 1950 20 01        	JR NZ,M3
 437+ 1952 1C           	INC E
 438+ 1953 0D           M3      DEC C
 439+ 1954 20 E2        	JR NZ,INITV2
 440+ 1956
 441+ 1956 C3 AB 1F     	JP ROUT
 442+ 1959
 443+ 1959 CD D2 19     INITPT3	CALL SETMDAD
 444+ 195C E5           	PUSH HL
 445+ 195D 11 64 00     	LD DE,100
 446+ 1960 19           	ADD HL,DE
 447+ 1961 7E           	LD A,(HL)
 448+ 1962 FD 77 08     	LD (IY-100+VRS.Delay),A
 449+ 1965 E5           	PUSH HL
 450+ 1966 DD E1        	POP IX
 451+ 1968 19           	ADD HL,DE
 452+ 1969 CD E0 19     	CALL SETCPPT
 453+ 196C DD 5E 02     	LD E,(IX+102-100)
 454+ 196F 23           	INC HL
 455+ 1970
 456+ 1970              	IF CurPosCounter
 457+ 1970 FD 75 9D     	LD (IY-100+VRS.PosSub),L
 458+ 1973              	ENDIF
 459+ 1973
 460+ 1973 19           	ADD HL,DE
 461+ 1974 CD E7 19     	CALL SETLPPT
 462+ 1977 D1           	POP DE
 463+ 1978 DD 6E 03     	LD L,(IX+103-100)
 464+ 197B DD 66 04     	LD H,(IX+104-100)
 465+ 197E 19           	ADD HL,DE
 466+ 197F CD CB 19     	CALL SETPTPT
 467+ 1982 21 A9 00     	LD HL,169
 468+ 1985 19           	ADD HL,DE
 469+ 1986 CD D9 19     	CALL SETORPT
 470+ 1989 21 69 00     	LD HL,105
 471+ 198C 19           	ADD HL,DE
 472+ 198D
 473+ 198D FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474+ 1990 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475+ 1993 C9           	RET
 476+ 1994
 477+ 1994 7E           INITPT2	LD A,(HL)
 478+ 1995 FD 77 08     	LD (IY-100+VRS.Delay),A
 479+ 1998 E5           	PUSH HL
 480+ 1999 E5           	PUSH HL
 481+ 199A E5           	PUSH HL
 482+ 199B 23           	INC HL
 483+ 199C 23           	INC HL
 484+ 199D 7E           	LD A,(HL)
 485+ 199E 23           	INC HL
 486+ 199F CD 8D 19     	CALL SETSMPT
 487+ 19A2 5E           	LD E,(HL)
 488+ 19A3 23           	INC HL
 489+ 19A4 56           	LD D,(HL)
 490+ 19A5 E1           	POP HL
 491+ 19A6 A7           	AND A
 492+ 19A7 ED 52        	SBC HL,DE
 493+ 19A9 CD D2 19     	CALL SETMDAD
 494+ 19AC E1           	POP HL
 495+ 19AD 11 43 00     	LD DE,67
 496+ 19B0 19           	ADD HL,DE
 497+ 19B1 CD D9 19     	CALL SETORPT
 498+ 19B4 1E 20        	LD E,32
 499+ 19B6 19           	ADD HL,DE
 500+ 19B7 4E           	LD C,(HL)
 501+ 19B8 23           	INC HL
 502+ 19B9 46           	LD B,(HL)
 503+ 19BA 1E 1E        	LD E,30
 504+ 19BC 19           	ADD HL,DE
 505+ 19BD CD E0 19     	CALL SETCPPT
 506+ 19C0 5F           	LD E,A
 507+ 19C1 23           	INC HL
 508+ 19C2
 509+ 19C2              	IF CurPosCounter
 510+ 19C2 FD 75 9D     	LD (IY-100+VRS.PosSub),L
 511+ 19C5              	ENDIF
 512+ 19C5
 513+ 19C5 19           	ADD HL,DE
 514+ 19C6 CD E7 19     	CALL SETLPPT
 515+ 19C9 E1           	POP HL
 516+ 19CA 09           	ADD HL,BC
 517+ 19CB
 518+ 19CB FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519+ 19CE FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520+ 19D1 C9           	RET
 521+ 19D2
 522+ 19D2 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523+ 19D5 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524+ 19D8 C9           	RET
 525+ 19D9
 526+ 19D9 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527+ 19DC FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528+ 19DF C9           	RET
 529+ 19E0
 530+ 19E0 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531+ 19E3 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532+ 19E6 C9           	RET
 533+ 19E7
 534+ 19E7 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535+ 19EA FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536+ 19ED C9           	RET
 537+ 19EE
 538+ 19EE FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539+ 19F1 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540+ 19F4 C9           	RET
 541+ 19F5
 542+ 19F5 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543+ 19F8 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544+ 19FB C9           	RET
 545+ 19FC
 546+ 19FC FD E5        GETIX	PUSH IY
 547+ 19FE DD E1        	POP IX
 548+ 1A00 DD 19        	ADD IX,DE
 549+ 1A02 C9           	RET
 550+ 1A03
 551+ 1A03 CD FC 19     PTDECOD CALL GETIX
 552+ 1A06              PTDEC	EQU $+1
 553+ 1A06 C3 C3 C3     	JP #C3C3
 554+ 1A09
 555+ 1A09              ;PT2 pattern decoder
 556+ 1A09 CD 9F 1C     PD2_SAM	CALL SETSAM
 557+ 1A0C 18 4A        	JR PD2_LOOP
 558+ 1A0E
 559+ 1A0E DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560+ 1A11 18 45        	JR PD2_LOOP
 561+ 1A13
 562+ 1A13 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563+ 1A17 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564+ 1A1A 0A           	LD A,(BC)
 565+ 1A1B 03           	INC BC
 566+ 1A1C 6F           	LD L,A
 567+ 1A1D 0A           	LD A,(BC)
 568+ 1A1E 03           	INC BC
 569+ 1A1F 67           	LD H,A
 570+ 1A20 CD EE 19     	CALL SETENBS
 571+ 1A23 18 33        	JR PD2_LOOP
 572+ 1A25
 573+ 1A25 CD 80 1C     PD2_ORN	CALL SETORN
 574+ 1A28 18 2E        	JR PD2_LOOP
 575+ 1A2A
 576+ 1A2A 3C           PD2_SKIP INC A
 577+ 1A2B DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578+ 1A2E 18 28        	JR PD2_LOOP
 579+ 1A30
 580+ 1A30 0F           PD2_VOL	RRCA
 581+ 1A31 0F           	RRCA
 582+ 1A32 0F           	RRCA
 583+ 1A33 0F           	RRCA
 584+ 1A34 DD 77 10     	LD (IX-12+CHP.Volume),A
 585+ 1A37 18 1F        	JR PD2_LOOP
 586+ 1A39
 587+ 1A39 CD 50 1C     PD2_DEL	CALL C_DELAY
 588+ 1A3C 18 1A        	JR PD2_LOOP
 589+ 1A3E
 590+ 1A3E DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591+ 1A42 3C           	INC A
 592+ 1A43 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593+ 1A46 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594+ 1A49 0A           	LD A,(BC)
 595+ 1A4A 03           	INC BC
 596+ 1A4B DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597+ 1A4E 87           	ADD A,A
 598+ 1A4F 9F           	SBC A,A
 599+ 1A50 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600+ 1A53 37           	SCF
 601+ 1A54 18 01        	JR PD2_LP2
 602+ 1A56
 603+ 1A56 A7           PT2PD	AND A
 604+ 1A57
 605+ 1A57 08           PD2_LP2	EX AF,AF'
 606+ 1A58
 607+ 1A58 0A           PD2_LOOP LD A,(BC)
 608+ 1A59 03           	INC BC
 609+ 1A5A C6 20        	ADD A,#20
 610+ 1A5C 28 3F        	JR Z,PD2_REL
 611+ 1A5E 38 A9        	JR C,PD2_SAM
 612+ 1A60 C6 60        	ADD A,96
 613+ 1A62 38 3E        	JR C,PD2_NOTE
 614+ 1A64 3C           	INC A
 615+ 1A65 28 A7        	JR Z,PD2_EOff
 616+ 1A67 C6 0F        	ADD A,15
 617+ 1A69 CA 7F 1B     	JP Z,PD_FIN
 618+ 1A6C 38 A5        	JR C,PD2_ENV
 619+ 1A6E C6 10        	ADD A,#10
 620+ 1A70 38 B3        	JR C,PD2_ORN
 621+ 1A72 C6 40        	ADD A,#40
 622+ 1A74 38 B4        	JR C,PD2_SKIP
 623+ 1A76 C6 10        	ADD A,#10
 624+ 1A78 38 B6        	JR C,PD2_VOL
 625+ 1A7A 3C           	INC A
 626+ 1A7B 28 BC        	JR Z,PD2_DEL
 627+ 1A7D 3C           	INC A
 628+ 1A7E 28 BE        	JR Z,PD2_GLIS
 629+ 1A80 3C           	INC A
 630+ 1A81 28 0A        	JR Z,PD2_PORT
 631+ 1A83 3C           	INC A
 632+ 1A84 28 12        	JR Z,PD2_STOP
 633+ 1A86 0A           	LD A,(BC)
 634+ 1A87 03           	INC BC
 635+ 1A88 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636+ 1A8B 18 CB        	JR PD2_LOOP
 637+ 1A8D
 638+ 1A8D DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639+ 1A91 0A           	LD A,(BC)
 640+ 1A92 03           	INC BC
 641+ 1A93 03           	INC BC ;ignoring precalc delta to right sound
 642+ 1A94 03           	INC BC
 643+ 1A95 37           	SCF
 644+ 1A96 18 BF        	JR PD2_LP2
 645+ 1A98
 646+ 1A98 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647+ 1A9B 18 BB        	JR PD2_LOOP
 648+ 1A9D
 649+ 1A9D DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650+ 1AA0 18 2C        	JR PD2_EXIT
 651+ 1AA2
 652+ 1AA2 6F           PD2_NOTE LD L,A
 653+ 1AA3 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654+ 1AA6 32 B9 1B     	LD (PrNote+1),A
 655+ 1AA9 DD 75 06     	LD (IX-12+CHP.Note),L
 656+ 1AAC AF           	XOR A
 657+ 1AAD DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658+ 1AB0 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659+ 1AB4 08           	EX AF,AF'
 660+ 1AB5 30 16        	JR NC,NOGLIS2
 661+ 1AB7 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662+ 1ABB 20 0C        	JR NZ,NOPORT2
 663+ 1ABD 32 DF 1B     	LD (LoStep),A
 664+ 1AC0 87           	ADD A,A
 665+ 1AC1 9F           	SBC A,A
 666+ 1AC2 08           	EX AF,AF'
 667+ 1AC3 67           	LD H,A
 668+ 1AC4 6F           	LD L,A
 669+ 1AC5 3C           	INC A
 670+ 1AC6 CD 9A 1B     	CALL SETPORT
 671+ 1AC9 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672+ 1ACD AF           NOGLIS2	XOR A
 673+ 1ACE
 674+ 1ACE
 675+ 1ACE DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676+ 1AD1 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677+ 1AD4 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678+ 1AD7 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679+ 1ADA C3 7F 1B     	JP PD_FIN
 680+ 1ADD
 681+ 1ADD              ;PT3 pattern decoder
 682+ 1ADD DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683+ 1AE1 CD 80 1C     	CALL SETORN
 684+ 1AE4 0A           PD_SAM_	LD A,(BC)
 685+ 1AE5 03           	INC BC
 686+ 1AE6 0F           	RRCA
 687+ 1AE7
 688+ 1AE7 CD 9F 1C     PD_SAM	CALL SETSAM
 689+ 1AEA 18 3F        	JR PD_LOOP
 690+ 1AEC
 691+ 1AEC 0F           PD_VOL	RRCA
 692+ 1AED 0F           	RRCA
 693+ 1AEE 0F           	RRCA
 694+ 1AEF 0F           	RRCA
 695+ 1AF0 DD 77 10     	LD (IX-12+CHP.Volume),A
 696+ 1AF3 18 39        	JR PD_LP2
 697+ 1AF5
 698+ 1AF5 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699+ 1AF8 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700+ 1AFB 18 31        	JR PD_LP2
 701+ 1AFD
 702+ 1AFD 3D           PD_SorE	DEC A
 703+ 1AFE 20 07        	JR NZ,PD_ENV
 704+ 1B00 0A           	LD A,(BC)
 705+ 1B01 03           	INC BC
 706+ 1B02 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707+ 1B05 18 27        	JR PD_LP2
 708+ 1B07
 709+ 1B07 CD 65 1C     PD_ENV	CALL SETENV
 710+ 1B0A 18 22        	JR PD_LP2
 711+ 1B0C
 712+ 1B0C CD 80 1C     PD_ORN	CALL SETORN
 713+ 1B0F 18 1A        	JR PD_LOOP
 714+ 1B11
 715+ 1B11 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716+ 1B14 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717+ 1B17 C4 65 1C     	CALL NZ,SETENV
 718+ 1B1A 18 C8        	JR PD_SAM_
 719+ 1B1C
 720+ 1B1C DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721+ 1B1F 32 B9 1B     	LD (PrNote+1),A
 722+ 1B22 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723+ 1B25 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724+ 1B28 22 D6 1B     	LD (PrSlide+1),HL
 725+ 1B2B
 726+ 1B2B 11 10 20     PD_LOOP	LD DE,#2010
 727+ 1B2E 0A           PD_LP2	LD A,(BC)
 728+ 1B2F 03           	INC BC
 729+ 1B30 83           	ADD A,E
 730+ 1B31 38 AA        	JR C,PD_OrSm
 731+ 1B33 82           	ADD A,D
 732+ 1B34 28 49        	JR Z,PD_FIN
 733+ 1B36 38 AF        	JR C,PD_SAM
 734+ 1B38 83           	ADD A,E
 735+ 1B39 28 25        	JR Z,PD_REL
 736+ 1B3B 38 AF        	JR C,PD_VOL
 737+ 1B3D 83           	ADD A,E
 738+ 1B3E 28 B5        	JR Z,PD_EOff
 739+ 1B40 38 BB        	JR C,PD_SorE
 740+ 1B42 C6 60        	ADD A,96
 741+ 1B44 38 20        	JR C,PD_NOTE
 742+ 1B46 83           	ADD A,E
 743+ 1B47 38 C3        	JR C,PD_ORN
 744+ 1B49 82           	ADD A,D
 745+ 1B4A 38 0F        	JR C,PD_NOIS
 746+ 1B4C 83           	ADD A,E
 747+ 1B4D 38 C2        	JR C,PD_ESAM
 748+ 1B4F 87           	ADD A,A
 749+ 1B50 5F           	LD E,A
 750+ 1B51 21 DB FB     	LD HL,SPCCOMS+#FF20-#2000
 751+ 1B54 19           	ADD HL,DE
 752+ 1B55 5E           	LD E,(HL)
 753+ 1B56 23           	INC HL
 754+ 1B57 56           	LD D,(HL)
 755+ 1B58 D5           	PUSH DE
 756+ 1B59 18 D0        	JR PD_LOOP
 757+ 1B5B
 758+ 1B5B FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759+ 1B5E 18 CE        	JR PD_LP2
 760+ 1B60
 761+ 1B60 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762+ 1B64 18 08        	JR PD_RES
 763+ 1B66
 764+ 1B66 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765+ 1B69 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766+ 1B6D AF           	XOR A
 767+ 1B6E
 768+ 1B6E ED 73 7D 1B  PD_RES	LD (PDSP_+1),SP
 769+ 1B72 DD F9        	LD SP,IX
 770+ 1B74 67           	LD H,A
 771+ 1B75 6F           	LD L,A
 772+ 1B76 E5           	PUSH HL
 773+ 1B77 E5           	PUSH HL
 774+ 1B78 E5           	PUSH HL
 775+ 1B79 E5           	PUSH HL
 776+ 1B7A E5           	PUSH HL
 777+ 1B7B E5           	PUSH HL
 778+ 1B7C 31 31 31     PDSP_	LD SP,#3131
 779+ 1B7F
 780+ 1B7F DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781+ 1B82 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782+ 1B85 C9           	RET
 783+ 1B86
 784+ 1B86 0A           C_PORTM LD A,(BC)
 785+ 1B87 03           	INC BC
 786+ 1B88              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787+ 1B88              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788+ 1B88 03           	INC BC
 789+ 1B89 03           	INC BC
 790+ 1B8A 08           	EX AF,AF'
 791+ 1B8B 0A           	LD A,(BC) ;SIGNED TONE STEP
 792+ 1B8C 03           	INC BC
 793+ 1B8D 32 DF 1B     	LD (LoStep),A
 794+ 1B90 0A           	LD A,(BC)
 795+ 1B91 03           	INC BC
 796+ 1B92 A7           	AND A
 797+ 1B93 08           	EX AF,AF'
 798+ 1B94 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799+ 1B97 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800+ 1B9A
 801+ 1B9A              ;Set portamento variables
 802+ 1B9A              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803+ 1B9A
 804+ 1B9A DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805+ 1B9E DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806+ 1BA1 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807+ 1BA4 E5           	PUSH HL
 808+ 1BA5 11 65 22     	LD DE,NT_
 809+ 1BA8 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810+ 1BAB DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811+ 1BAE 87           	ADD A,A
 812+ 1BAF 6F           	LD L,A
 813+ 1BB0 26 00        	LD H,0
 814+ 1BB2 19           	ADD HL,DE
 815+ 1BB3 7E           	LD A,(HL)
 816+ 1BB4 23           	INC HL
 817+ 1BB5 66           	LD H,(HL)
 818+ 1BB6 6F           	LD L,A
 819+ 1BB7 E5           	PUSH HL
 820+ 1BB8 3E 3E        PrNote	LD A,#3E
 821+ 1BBA DD 77 06     	LD (IX-12+CHP.Note),A
 822+ 1BBD 87           	ADD A,A
 823+ 1BBE 6F           	LD L,A
 824+ 1BBF 26 00        	LD H,0
 825+ 1BC1 19           	ADD HL,DE
 826+ 1BC2 5E           	LD E,(HL)
 827+ 1BC3 23           	INC HL
 828+ 1BC4 56           	LD D,(HL)
 829+ 1BC5 E1           	POP HL
 830+ 1BC6 ED 52        	SBC HL,DE
 831+ 1BC8 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832+ 1BCB DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833+ 1BCE D1           	POP DE
 834+ 1BCF              Version EQU $+1
 835+ 1BCF 3E 3E        	LD A,#3E
 836+ 1BD1 FE 06        	CP 6
 837+ 1BD3 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838+ 1BD5 11 11 11     PrSlide	LD DE,#1111
 839+ 1BD8 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840+ 1BDB DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841+ 1BDE              LoStep	EQU $+1
 842+ 1BDE 3E 3E        OLDPRTM	LD A,#3E
 843+ 1BE0 08           	EX AF,AF'
 844+ 1BE1 28 01        	JR Z,NOSIG
 845+ 1BE3 EB           	EX DE,HL
 846+ 1BE4 ED 52        NOSIG	SBC HL,DE
 847+ 1BE6 F2 EE 1B     	JP P,SET_STP
 848+ 1BE9 2F           	CPL
 849+ 1BEA 08           	EX AF,AF'
 850+ 1BEB ED 44        	NEG
 851+ 1BED 08           	EX AF,AF'
 852+ 1BEE DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853+ 1BF1 08           	EX AF,AF'
 854+ 1BF2 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855+ 1BF5 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856+ 1BF9 C9           	RET
 857+ 1BFA
 858+ 1BFA DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859+ 1BFE 0A           	LD A,(BC)
 860+ 1BFF 03           	INC BC
 861+ 1C00 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862+ 1C03 A7           	AND A
 863+ 1C04 20 07        	JR NZ,GL36
 864+ 1C06 3A D0 1B     	LD A,(Version) ;AlCo PT3.7+
 865+ 1C09 FE 07        	CP 7
 866+ 1C0B 9F           	SBC A,A
 867+ 1C0C 3C           	INC A
 868+ 1C0D DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869+ 1C10 0A           	LD A,(BC)
 870+ 1C11 03           	INC BC
 871+ 1C12 08           	EX AF,AF'
 872+ 1C13 0A           	LD A,(BC)
 873+ 1C14 03           	INC BC
 874+ 1C15 18 D7        	JR SET_STP
 875+ 1C17
 876+ 1C17 0A           C_SMPOS	LD A,(BC)
 877+ 1C18 03           	INC BC
 878+ 1C19 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879+ 1C1C C9           	RET
 880+ 1C1D
 881+ 1C1D 0A           C_ORPOS	LD A,(BC)
 882+ 1C1E 03           	INC BC
 883+ 1C1F DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884+ 1C22 C9           	RET
 885+ 1C23
 886+ 1C23 0A           C_VIBRT	LD A,(BC)
 887+ 1C24 03           	INC BC
 888+ 1C25 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889+ 1C28 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890+ 1C2B 0A           	LD A,(BC)
 891+ 1C2C 03           	INC BC
 892+ 1C2D DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893+ 1C30 AF           	XOR A
 894+ 1C31 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895+ 1C34 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896+ 1C37 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897+ 1C3A C9           	RET
 898+ 1C3B
 899+ 1C3B 0A           C_ENGLS	LD A,(BC)
 900+ 1C3C 03           	INC BC
 901+ 1C3D FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902+ 1C40 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903+ 1C43 0A           	LD A,(BC)
 904+ 1C44 03           	INC BC
 905+ 1C45 6F           	LD L,A
 906+ 1C46 0A           	LD A,(BC)
 907+ 1C47 03           	INC BC
 908+ 1C48 67           	LD H,A
 909+ 1C49 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910+ 1C4C FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911+ 1C4F C9           	RET
 912+ 1C50
 913+ 1C50 0A           C_DELAY	LD A,(BC)
 914+ 1C51 03           	INC BC
 915+ 1C52 FD 77 08     	LD (IY-100+VRS.Delay),A
 916+ 1C55 21 F0 20     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917+ 1C58 CB 4E        	BIT 1,(HL)
 918+ 1C5A C8           	RET Z
 919+ 1C5B 32 D3 20     	LD (VARS1+VRS.Delay),A
 920+ 1C5E 32 D4 20     	LD (VARS1+VRS.DelyCnt),A
 921+ 1C61 32 5A 21     	LD (VARS2+VRS.Delay),A
 922+ 1C64 C9           	RET
 923+ 1C65
 924+ 1C65 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925+ 1C68 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926+ 1C6B 0A           	LD A,(BC)
 927+ 1C6C 03           	INC BC
 928+ 1C6D 67           	LD H,A
 929+ 1C6E 0A           	LD A,(BC)
 930+ 1C6F 03           	INC BC
 931+ 1C70 6F           	LD L,A
 932+ 1C71 CD EE 19     	CALL SETENBS
 933+ 1C74 AF           	XOR A
 934+ 1C75 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935+ 1C78 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936+ 1C7B 67           	LD H,A
 937+ 1C7C 6F           	LD L,A
 938+ 1C7D C3 F5 19     	JP SETESLD
 939+ 1C80
 940+ 1C80 87           SETORN	ADD A,A
 941+ 1C81 5F           	LD E,A
 942+ 1C82 16 00        	LD D,0
 943+ 1C84 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944+ 1C87 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945+ 1C8A FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946+ 1C8D 19           	ADD HL,DE
 947+ 1C8E 5E           	LD E,(HL)
 948+ 1C8F 23           	INC HL
 949+ 1C90 56           	LD D,(HL)
 950+ 1C91 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951+ 1C94 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952+ 1C97 19           	ADD HL,DE
 953+ 1C98 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954+ 1C9B DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955+ 1C9E C9           C_NOP	RET
 956+ 1C9F
 957+ 1C9F 87           SETSAM	ADD A,A
 958+ 1CA0 5F           	LD E,A
 959+ 1CA1 16 00        	LD D,0
 960+ 1CA3 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961+ 1CA6 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962+ 1CA9 19           	ADD HL,DE
 963+ 1CAA 5E           	LD E,(HL)
 964+ 1CAB 23           	INC HL
 965+ 1CAC 56           	LD D,(HL)
 966+ 1CAD FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967+ 1CB0 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968+ 1CB3 19           	ADD HL,DE
 969+ 1CB4 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970+ 1CB7 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971+ 1CBA C9           	RET
 972+ 1CBB
 973+ 1CBB              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974+ 1CBB 9E 1C        SPCCOMS DW C_NOP
 975+ 1CBD FA 1B        	DW C_GLISS
 976+ 1CBF 86 1B        	DW C_PORTM
 977+ 1CC1 17 1C        	DW C_SMPOS
 978+ 1CC3 1D 1C        	DW C_ORPOS
 979+ 1CC5 23 1C        	DW C_VIBRT
 980+ 1CC7 9E 1C        	DW C_NOP
 981+ 1CC9 9E 1C        	DW C_NOP
 982+ 1CCB 3B 1C        	DW C_ENGLS
 983+ 1CCD 50 1C        	DW C_DELAY
 984+ 1CCF 9E 1C        	DW C_NOP
 985+ 1CD1 9E 1C        	DW C_NOP
 986+ 1CD3 9E 1C        	DW C_NOP
 987+ 1CD5 9E 1C        	DW C_NOP
 988+ 1CD7 9E 1C        	DW C_NOP
 989+ 1CD9 9E 1C        	DW C_NOP
 990+ 1CDB
 991+ 1CDB CD FC 19     CHREGS	CALL GETIX
 992+ 1CDE AF           	XOR A
 993+ 1CDF 32 22 1F     	LD (Ampl),A
 994+ 1CE2 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995+ 1CE6 E5           	PUSH HL
 996+ 1CE7 CA 2E 1E     	JP Z,CH_EXIT
 997+ 1CEA ED 73 78 1D  	LD (CSP_+1),SP
 998+ 1CEE DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999+ 1CF1 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000+ 1CF4 F9           	LD SP,HL
1001+ 1CF5 D1           	POP DE
1002+ 1CF6 67           	LD H,A
1003+ 1CF7 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004+ 1CFA 6F           	LD L,A
1005+ 1CFB 39           	ADD HL,SP
1006+ 1CFC 3C           	INC A
1007+ 1CFD              		;PT2	PT3
1008+ 1CFD 3C           OrnCP	INC A	;CP E	CP D
1009+ 1CFE 38 01        	JR C,CH_ORPS
1010+ 1D00 01           OrnLD	DB 1	;LD A,D	LD A,E
1011+ 1D01 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012+ 1D04 DD 7E 12     	LD A,(IX+CHP.Note)
1013+ 1D07 86           	ADD A,(HL)
1014+ 1D08 F2 0C 1D     	JP P,CH_NTP
1015+ 1D0B AF           	XOR A
1016+ 1D0C FE 60        CH_NTP	CP 96
1017+ 1D0E 38 02        	JR C,CH_NOK
1018+ 1D10 3E 5F        	LD A,95
1019+ 1D12 87           CH_NOK	ADD A,A
1020+ 1D13 08           	EX AF,AF'
1021+ 1D14 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022+ 1D17 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023+ 1D1A F9           	LD SP,HL
1024+ 1D1B D1           	POP DE
1025+ 1D1C 26 00        	LD H,0
1026+ 1D1E DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027+ 1D21 47           	LD B,A
1028+ 1D22 87           	ADD A,A
1029+ 1D23 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030+ 1D24 6F           	LD L,A
1031+ 1D25 39           	ADD HL,SP
1032+ 1D26 F9           	LD SP,HL
1033+ 1D27 78           	LD A,B
1034+ 1D28 3C           	INC A
1035+ 1D29              		;PT2	PT3
1036+ 1D29 3C           SamCP	INC A	;CP E	CP D
1037+ 1D2A 38 01        	JR C,CH_SMPS
1038+ 1D2C 01           SamLD	DB 1	;LD A,D	LD A,E
1039+ 1D2D DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040+ 1D30 C1           	POP BC
1041+ 1D31 E1           	POP HL
1042+ 1D32
1043+ 1D32              ;Convert PT2 sample to PT3
1044+ 1D32              		;PT2		PT3
1045+ 1D32 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046+ 1D33 E1           	POP HL
1047+ 1D34 60           	LD H,B
1048+ 1D35 20 06        	JR NZ,$+8
1049+ 1D37 EB           	EX DE,HL
1050+ 1D38 A7           	AND A
1051+ 1D39 ED 62        	SBC HL,HL
1052+ 1D3B ED 52        	SBC HL,DE
1053+ 1D3D 51           	LD D,C
1054+ 1D3E CB 19        	RR C
1055+ 1D40 9F           	SBC A,A
1056+ 1D41 2F           	CPL
1057+ 1D42 E6 3E        	AND #3E
1058+ 1D44 CB 19        	RR C
1059+ 1D46 CB 18        	RR B
1060+ 1D48 A1           	AND C
1061+ 1D49 4F           	LD C,A
1062+ 1D4A 78           	LD A,B
1063+ 1D4B 1F           	RRA
1064+ 1D4C 1F           	RRA
1065+ 1D4D CB 1A        	RR D
1066+ 1D4F 1F           	RRA
1067+ 1D50 E6 9F        	AND #9F
1068+ 1D52 47           	LD B,A
1069+ 1D53
1070+ 1D53 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071+ 1D56 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072+ 1D59 19           	ADD HL,DE
1073+ 1D5A CB 70        	BIT 6,B
1074+ 1D5C 28 06        	JR Z,CH_NOAC
1075+ 1D5E DD 75 08     	LD (IX+CHP.TnAcc),L
1076+ 1D61 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077+ 1D64 EB           CH_NOAC EX DE,HL
1078+ 1D65 08           	EX AF,AF'
player.asm(1079): warning: value 0x2265 is truncated to 8bit value: 0x65
1079+ 1D66 C6 65        	ADD A,NT_
1080+ 1D68 6F           	LD L,A
1081+ 1D69 CE 22        	ADC A,NT_/256
1082+ 1D6B 95           	SUB L
1083+ 1D6C 67           	LD H,A
1084+ 1D6D F9           	LD SP,HL
1085+ 1D6E E1           	POP HL
1086+ 1D6F 19           	ADD HL,DE
1087+ 1D70 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088+ 1D73 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089+ 1D76 19           	ADD HL,DE
1090+ 1D77 31 31 31     CSP_	LD SP,#3131
1091+ 1D7A E3           	EX (SP),HL
1092+ 1D7B AF           	XOR A
1093+ 1D7C DD B6 05     	OR (IX+CHP.TSlCnt)
1094+ 1D7F 28 3E        	JR Z,CH_AMP
1095+ 1D81 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096+ 1D84 20 39        	JR NZ,CH_AMP
1097+ 1D86 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098+ 1D89 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099+ 1D8C DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100+ 1D8F DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101+ 1D92 7C           	LD A,H
1102+ 1D93 19           	ADD HL,DE
1103+ 1D94 DD 75 06     	LD (IX+CHP.CrTnSl),L
1104+ 1D97 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105+ 1D9A DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106+ 1D9E 20 1F        	JR NZ,CH_AMP
1107+ 1DA0 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108+ 1DA3 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109+ 1DA6 A7           	AND A
1110+ 1DA7 28 01        	JR Z,CH_STPP
1111+ 1DA9 EB           	EX DE,HL
1112+ 1DAA ED 52        CH_STPP SBC HL,DE
1113+ 1DAC FA BF 1D     	JP M,CH_AMP
1114+ 1DAF DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115+ 1DB2 DD 77 12     	LD (IX+CHP.Note),A
1116+ 1DB5 AF           	XOR A
1117+ 1DB6 DD 77 05     	LD (IX+CHP.TSlCnt),A
1118+ 1DB9 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119+ 1DBC DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120+ 1DBF DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121+ 1DC2 CB 79        	BIT 7,C
1122+ 1DC4 28 13        	JR Z,CH_NOAM
1123+ 1DC6 CB 71        	BIT 6,C
1124+ 1DC8 28 07        	JR Z,CH_AMIN
1125+ 1DCA FE 0F        	CP 15
1126+ 1DCC 28 0B        	JR Z,CH_NOAM
1127+ 1DCE 3C           	INC A
1128+ 1DCF 18 05        	JR CH_SVAM
1129+ 1DD1 FE F1        CH_AMIN	CP -15
1130+ 1DD3 28 04        	JR Z,CH_NOAM
1131+ 1DD5 3D           	DEC A
1132+ 1DD6 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133+ 1DD9 6F           CH_NOAM	LD L,A
1134+ 1DDA 78           	LD A,B
1135+ 1DDB E6 0F        	AND 15
1136+ 1DDD 85           	ADD A,L
1137+ 1DDE F2 E2 1D     	JP P,CH_APOS
1138+ 1DE1 AF           	XOR A
1139+ 1DE2 FE 10        CH_APOS	CP 16
1140+ 1DE4 38 02        	JR C,CH_VOL
1141+ 1DE6 3E 0F        	LD A,15
1142+ 1DE8 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x2165 is truncated to 8bit value: 0x65
1143+ 1DEB C6 65        	ADD A,VT_
1144+ 1DED 6F           	LD L,A
1145+ 1DEE CE 21        	ADC A,VT_/256
1146+ 1DF0 95           	SUB L
1147+ 1DF1 67           	LD H,A
1148+ 1DF2 7E           	LD A,(HL)
1149+ 1DF3 CB 41        CH_ENV	BIT 0,C
1150+ 1DF5 20 03        	JR NZ,CH_NOEN
1151+ 1DF7 DD B6 14     	OR (IX+CHP.Env_En)
1152+ 1DFA 32 22 1F     CH_NOEN	LD (Ampl),A
1153+ 1DFD CB 78        	BIT 7,B
1154+ 1DFF 79           	LD A,C
1155+ 1E00 28 1A        	JR Z,NO_ENSL
1156+ 1E02 17           	RLA
1157+ 1E03 17           	RLA
1158+ 1E04 CB 2F        	SRA A
1159+ 1E06 CB 2F        	SRA A
1160+ 1E08 CB 2F        	SRA A
1161+ 1E0A DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162+ 1E0D CB 68        	BIT 5,B
1163+ 1E0F 28 03        	JR Z,NO_ENAC
1164+ 1E11 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165+ 1E14 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166+ 1E17 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167+ 1E1A 18 0E        	JR CH_MIX
1168+ 1E1C 1F           NO_ENSL RRA
1169+ 1E1D DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170+ 1E20 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171+ 1E23 CB 68        	BIT 5,B
1172+ 1E25 28 03        	JR Z,CH_MIX
1173+ 1E27 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174+ 1E2A 78           CH_MIX	LD A,B
1175+ 1E2B 1F           	RRA
1176+ 1E2C E6 48        	AND #48
1177+ 1E2E FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178+ 1E31 0F           	RRCA
1179+ 1E32 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180+ 1E35 E1           	POP HL
1181+ 1E36 AF           	XOR A
1182+ 1E37 DD B6 0A     	OR (IX+CHP.COnOff)
1183+ 1E3A C8           	RET Z
1184+ 1E3B DD 35 0A     	DEC (IX+CHP.COnOff)
1185+ 1E3E C0           	RET NZ
1186+ 1E3F DD AE 15     	XOR (IX+CHP.Flags)
1187+ 1E42 DD 77 15     	LD (IX+CHP.Flags),A
1188+ 1E45 1F           	RRA
1189+ 1E46 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190+ 1E49 38 03        	JR C,CH_ONDL
1191+ 1E4B DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192+ 1E4E DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193+ 1E51 C9           	RET
1194+ 1E52
1195+ 1E52 AF           PLAY_	XOR A
1196+ 1E53 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197+ 1E56 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198+ 1E59 3D           	DEC A
1199+ 1E5A FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200+ 1E5D FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201+ 1E60 C2 0F 1F     	JP NZ,PL2
1202+ 1E63 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203+ 1E66 20 73        	JR NZ,PL1B
1204+ 1E68 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205+ 1E6B FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206+ 1E6E 0A           	LD A,(BC)
1207+ 1E6F A7           	AND A
1208+ 1E70 20 5D        	JR NZ,PL1A
1209+ 1E72 57           	LD D,A
1210+ 1E73 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211+ 1E76 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212+ 1E79 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213+ 1E7C 23           	INC HL
1214+ 1E7D 7E           	LD A,(HL)
1215+ 1E7E 3C           	INC A
1216+ 1E7F 20 0B        	JR NZ,PLNLP
1217+ 1E81
1218+ 1E81              	IF LoopChecker
1219+ 1E81 CD 2D 17     	CALL CHECKLP
1220+ 1E84              	ENDIF
1221+ 1E84
1222+ 1E84 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223+ 1E87 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224+ 1E8A 7E           	LD A,(HL)
1225+ 1E8B 3C           	INC A
1226+ 1E8C CD E0 19     PLNLP	CALL SETCPPT
1227+ 1E8F 3D           	DEC A
1228+ 1E90 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229+ 1E94 28 03        	JR Z,NoAlCo
1230+ 1E96              TSSub	EQU $+1
1231+ 1E96 D6 D6        	SUB #D6
1232+ 1E98 2F           	CPL
1233+ 1E99              NoAlCo
1234+ 1E99              		;PT2		PT3
1235+ 1E99 3D           PsCalc	DEC A	;ADD A,A	NOP
1236+ 1E9A 3D           	DEC A	;ADD A,(HL)	NOP
1237+ 1E9B 87           	ADD A,A
1238+ 1E9C 5F           	LD E,A
1239+ 1E9D CB 12        	RL D
1240+ 1E9F
1241+ 1E9F              	IF CurPosCounter
1242+ 1E9F 7D           	LD A,L
1243+ 1EA0 FD 96 9D     	SUB (IY-100+VRS.PosSub)
1244+ 1EA3 FD 77 9C     	LD (IY-100+VRS.CurPos),A
1245+ 1EA6              	ENDIF
1246+ 1EA6
1247+ 1EA6 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248+ 1EA9 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249+ 1EAC 19           	ADD HL,DE
1250+ 1EAD FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251+ 1EB0 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252+ 1EB3 ED 73 CD 1E  	LD (PSP_+1),SP
1253+ 1EB7 F9           	LD SP,HL
1254+ 1EB8 E1           	POP HL
1255+ 1EB9 19           	ADD HL,DE
1256+ 1EBA 44           	LD B,H
1257+ 1EBB 4D           	LD C,L
1258+ 1EBC E1           	POP HL
1259+ 1EBD 19           	ADD HL,DE
1260+ 1EBE FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261+ 1EC1 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262+ 1EC4 E1           	POP HL
1263+ 1EC5 19           	ADD HL,DE
1264+ 1EC6 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265+ 1EC9 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266+ 1ECC 31 31 31     PSP_	LD SP,#3131
1267+ 1ECF 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268+ 1ED2 CD 03 1A     	CALL PTDECOD
1269+ 1ED5 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270+ 1ED8 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271+ 1EDB
1272+ 1EDB FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273+ 1EDE 20 12        	JR NZ,PL1C
1274+ 1EE0 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275+ 1EE3 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276+ 1EE6 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277+ 1EE9 CD 03 1A     	CALL PTDECOD
1278+ 1EEC FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279+ 1EEF FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280+ 1EF2
1281+ 1EF2 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282+ 1EF5 20 12        	JR NZ,PL1D
1283+ 1EF7 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284+ 1EFA FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285+ 1EFD FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286+ 1F00 CD 03 1A     	CALL PTDECOD
1287+ 1F03 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288+ 1F06 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289+ 1F09
1290+ 1F09 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291+ 1F0C FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292+ 1F0F
1293+ 1F0F 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294+ 1F12 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295+ 1F15 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296+ 1F18 CD DB 1C     	CALL CHREGS
1297+ 1F1B FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298+ 1F1E FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299+ 1F21              Ampl	EQU $+1
1300+ 1F21 3E 3E        	LD A,#3E
1301+ 1F23 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302+ 1F26 11 BC FF     	LD DE,VRS.ChanB-100
1303+ 1F29 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304+ 1F2C FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305+ 1F2F CD DB 1C     	CALL CHREGS
1306+ 1F32 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307+ 1F35 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308+ 1F38 3A 22 1F     	LD A,(Ampl)
1309+ 1F3B FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310+ 1F3E 11 D9 FF     	LD DE,VRS.ChanC-100
1311+ 1F41 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312+ 1F44 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313+ 1F47 CD DB 1C     	CALL CHREGS
1314+ 1F4A FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315+ 1F4D FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316+ 1F50 3A 22 1F     	LD A,(Ampl)
1317+ 1F53 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318+ 1F56
1319+ 1F56 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320+ 1F59 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321+ 1F5C FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322+ 1F5F
1323+ 1F5F FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324+ 1F62 5F           	LD E,A
1325+ 1F63 87           	ADD A,A
1326+ 1F64 9F           	SBC A,A
1327+ 1F65 57           	LD D,A
1328+ 1F66 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329+ 1F69 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330+ 1F6C 19           	ADD HL,DE
1331+ 1F6D FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332+ 1F70 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333+ 1F73 19           	ADD HL,DE
1334+ 1F74 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335+ 1F77 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336+ 1F7A
1337+ 1F7A AF           	XOR A
1338+ 1F7B FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339+ 1F7E C8           	RET Z
1340+ 1F7F FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341+ 1F82 C0           	RET NZ
1342+ 1F83 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343+ 1F86 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344+ 1F89 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345+ 1F8C FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346+ 1F8F 19           	ADD HL,DE
1347+ 1F90 C3 F5 19     	JP SETESLD
1348+ 1F93
1349+ 1F93 FD 21 CB 20  PLAY    LD IY,VARS1+100
1350+ 1F97 CD 52 1E     	CALL PLAY_
1351+ 1F9A 3A 66 20     	LD A,(is_ts)
1352+ 1F9D A7           	AND A
1353+ 1F9E 28 07        	JR Z,PL_nts
1354+ 1FA0 FD 21 52 21  	LD IY,VARS2+100
1355+ 1FA4 CD 52 1E     	CALL PLAY_
1356+ 1FA7              PL_nts
1357+ 1FA7              	IF Basic
1358+ 1FA7 FD 21 3A 5C  	LD IY,#5C3A
1359+ 1FAB              	ENDIF
1360+ 1FAB
1361+ 1FAB 01 FD FF     ROUT	LD BC,#FFFD
1362+ 1FAE 3A 66 20     	LD A,(is_ts)
1363+ 1FB1 A7           	AND A
1364+ 1FB2 28 02        	JR Z,r_nts ;keep old standard
1365+ 1FB4 ED 41        	OUT (C),B
1366+ 1FB6 08           r_nts	EX AF,AF'
1367+ 1FB7
1368+ 1FB7              	IF ACBBAC
1369+ 1FB7 ~            	LD IX,VARS1+VRS.AYREGS
1370+ 1FB7              	ELSE
1371+ 1FB7 21 E0 20     	LD HL,VARS1+VRS.AYREGS
1372+ 1FBA              	ENDIF
1373+ 1FBA
1374+ 1FBA CD C6 1F     	CALL ROUT_
1375+ 1FBD 08           	EX AF,AF'
1376+ 1FBE C8           	RET Z
1377+ 1FBF 42           	LD B,D
1378+ 1FC0 2F           	CPL
1379+ 1FC1 ED 79        	OUT (C),A
1380+ 1FC3
1381+ 1FC3              	IF ACBBAC
1382+ 1FC3 ~            	LD IX,VARS2+VRS.AYREGS
1383+ 1FC3              	ELSE
1384+ 1FC3 21 67 21     	LD HL,VARS2+VRS.AYREGS
1385+ 1FC6              	ENDIF
1386+ 1FC6
1387+ 1FC6              ROUT_
1388+ 1FC6              	IF ACBBAC
1389+ 1FC6 ~            	LD A,(SETUP)
1390+ 1FC6 ~            	AND 12
1391+ 1FC6 ~            	JR Z,ABC
1392+ 1FC6 ~            	ADD A,CHTABLE
1393+ 1FC6 ~            	LD E,A
1394+ 1FC6 ~            	ADC A,CHTABLE/256
1395+ 1FC6 ~            	SUB E
1396+ 1FC6 ~            	LD D,A
1397+ 1FC6 ~            	LD B,0
1398+ 1FC6 ~            	PUSH IX
1399+ 1FC6 ~            	POP HL
1400+ 1FC6 ~            	LD A,(DE)
1401+ 1FC6 ~            	INC DE
1402+ 1FC6 ~            	LD C,A
1403+ 1FC6 ~            	ADD HL,BC
1404+ 1FC6 ~            	LD A,(IX+TonB)
1405+ 1FC6 ~            	LD C,(HL)
1406+ 1FC6 ~            	LD (IX+TonB),C
1407+ 1FC6 ~            	LD (HL),A
1408+ 1FC6 ~            	INC HL
1409+ 1FC6 ~            	LD A,(IX+TonB+1)
1410+ 1FC6 ~            	LD C,(HL)
1411+ 1FC6 ~            	LD (IX+TonB+1),C
1412+ 1FC6 ~            	LD (HL),A
1413+ 1FC6 ~            	LD A,(DE)
1414+ 1FC6 ~            	INC DE
1415+ 1FC6 ~            	LD C,A
1416+ 1FC6 ~            	ADD HL,BC
1417+ 1FC6 ~            	LD A,(IX+AmplB)
1418+ 1FC6 ~            	LD C,(HL)
1419+ 1FC6 ~            	LD (IX+AmplB),C
1420+ 1FC6 ~            	LD (HL),A
1421+ 1FC6 ~            	LD A,(DE)
1422+ 1FC6 ~            	INC DE
1423+ 1FC6 ~            	LD (RxCA1),A
1424+ 1FC6 ~            	XOR 8
1425+ 1FC6 ~            	LD (RxCA2),A
1426+ 1FC6 ~            	LD A,(DE)
1427+ 1FC6 ~            	AND (IX+Mixer)
1428+ 1FC6 ~            	LD E,A
1429+ 1FC6 ~            	LD A,(IX+Mixer)
1430+ 1FC6 ~            RxCA1	DB #E6
1431+ 1FC6 ~            	AND %010010
1432+ 1FC6 ~            	OR E
1433+ 1FC6 ~            	LD E,A
1434+ 1FC6 ~            	LD A,(IX+Mixer)
1435+ 1FC6 ~            	AND %010010
1436+ 1FC6 ~            RxCA2	OR E
1437+ 1FC6 ~            	OR E
1438+ 1FC6 ~            	LD (IX+Mixer),A
1439+ 1FC6 ~            ABC
1440+ 1FC6              	ENDIF
1441+ 1FC6
1442+ 1FC6 AF           	XOR A
1443+ 1FC7 11 BF FF     	LD DE,#FFBF
1444+ 1FCA
1445+ 1FCA              	IF ACBBAC
1446+ 1FCA ~            	LD BC,#FFFD
1447+ 1FCA ~            	PUSH IX
1448+ 1FCA ~            	POP HL
1449+ 1FCA              	ENDIF
1450+ 1FCA
1451+ 1FCA ED 79        LOUT	OUT (C),A
1452+ 1FCC 43           	LD B,E
1453+ 1FCD ED A3        	OUTI
1454+ 1FCF 42           	LD B,D
1455+ 1FD0 3C           	INC A
1456+ 1FD1 FE 0D        	CP 13
1457+ 1FD3 20 F5        	JR NZ,LOUT
1458+ 1FD5 ED 79        	OUT (C),A
1459+ 1FD7 7E           	LD A,(HL)
1460+ 1FD8 A7           	AND A
1461+ 1FD9 F8           	RET M
1462+ 1FDA 43           	LD B,E
1463+ 1FDB ED 79        	OUT (C),A
1464+ 1FDD C9           	RET
1465+ 1FDE
1466+ 1FDE              	IF ACBBAC
1467+ 1FDE ~            CHTABLE	EQU $-4
1468+ 1FDE ~            	DB 4,5,15,%001001,0,7,7,%100100
1469+ 1FDE              	ENDIF
1470+ 1FDE
1471+ 1FDE 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472+ 1FDF 2A           	DB TCNEW_0-T_
1473+ 1FE0 65           	DB (T_OLD_0-T1_)*2+1
1474+ 1FE1 00           	DB TCOLD_0-T_
1475+ 1FE2 01           	DB (T_NEW_1-T1_)*2+1
1476+ 1FE3 0C           	DB TCNEW_1-T_
1477+ 1FE4 01           	DB (T_OLD_1-T1_)*2+1
1478+ 1FE5 0C           	DB TCOLD_1-T_
1479+ 1FE6 94           	DB (T_NEW_2-T1_)*2
1480+ 1FE7 35           	DB TCNEW_2-T_
1481+ 1FE8 30           	DB (T_OLD_2-T1_)*2
1482+ 1FE9 0E           	DB TCOLD_2-T_
1483+ 1FEA 60           	DB (T_NEW_3-T1_)*2
1484+ 1FEB 20           	DB TCNEW_3-T_
1485+ 1FEC 60           	DB (T_OLD_3-T1_)*2
1486+ 1FED 21           	DB TCOLD_3-T_
1487+ 1FEE
1488+ 1FEE              T_
1489+ 1FEE
1490+ 1FEE 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490+ 1FF2 0D 0F 13 15
1491+ 1FF6 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492+ 1FFA 5D 00        TCOLD_1	DB #5C+1,0
1493+ 1FFC 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493+ 2000 5F 71 82 8C
1493+ 2004 9C
1494+ 2005 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494+ 2009 AA AC AE AE
1494+ 200D 00
1495+ 200E 57           TCNEW_3	DB #56+1
1496+ 200F 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496+ 2013 2D 2F 33 BF
1496+ 2017 00
1497+ 2018 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497+ 201C 2B 2D 31 55
1498+ 2020 BD BF 00     	DB #BC+1,#BE+1,0
1499+ 2023              TCNEW_1 EQU TCOLD_1
1500+ 2023 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500+ 2027 2B 3B 4D 5F
1501+ 202B BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502+ 202F
1503+ 202F              PT3EMPTYORN EQU $-1
1504+ 202F 01 00        	DB 1,0
1505+ 2031
1506+ 2031              ;first 12 values of tone tables (packed)
1507+ 2031
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508+ 2031 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509+ 2033 69           	DB #0755-#06EC
1510+ 2034 70           	DB #07C5-#0755
1511+ 2035 76           	DB #083B-#07C5
1512+ 2036 7D           	DB #08B8-#083B
1513+ 2037 85           	DB #093D-#08B8
1514+ 2038 8D           	DB #09CA-#093D
1515+ 2039 95           	DB #0A5F-#09CA
1516+ 203A 9D           	DB #0AFC-#0A5F
1517+ 203B A8           	DB #0BA4-#0AFC
1518+ 203C B1           	DB #0C55-#0BA4
1519+ 203D BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520+ 203E 0C DA        	DB #066D*2/256,#066D*2
1521+ 2040 62           	DB #06CF-#066D
1522+ 2041 68           	DB #0737-#06CF
1523+ 2042 6D           	DB #07A4-#0737
1524+ 2043 75           	DB #0819-#07A4
1525+ 2044 7B           	DB #0894-#0819
1526+ 2045 83           	DB #0917-#0894
1527+ 2046 8A           	DB #09A1-#0917
1528+ 2047 92           	DB #0A33-#09A1
1529+ 2048 9C           	DB #0ACF-#0A33
1530+ 2049 A4           	DB #0B73-#0ACF
1531+ 204A AF           	DB #0C22-#0B73
1532+ 204B B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533+ 204C 0E 08        	DB #0704*2/256,#0704*2
1534+ 204E 6A           	DB #076E-#0704
1535+ 204F 72           	DB #07E0-#076E
1536+ 2050 78           	DB #0858-#07E0
1537+ 2051 7E           	DB #08D6-#0858
1538+ 2052 86           	DB #095C-#08D6
1539+ 2053 90           	DB #09EC-#095C
1540+ 2054 96           	DB #0A82-#09EC
1541+ 2055 A0           	DB #0B22-#0A82
1542+ 2056 AA           	DB #0BCC-#0B22
1543+ 2057 B4           	DB #0C80-#0BCC
1544+ 2058 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545+ 2059 0F C0        	DB #07E0*2/256,#07E0*2
1546+ 205B 78           	DB #0858-#07E0
1547+ 205C 88           	DB #08E0-#0858
1548+ 205D 80           	DB #0960-#08E0
1549+ 205E 90           	DB #09F0-#0960
1550+ 205F 98           	DB #0A88-#09F0
1551+ 2060 A0           	DB #0B28-#0A88
1552+ 2061 B0           	DB #0BD8-#0B28
1553+ 2062 A8           	DB #0C80-#0BD8
1554+ 2063 E0           	DB #0D60-#0C80
1555+ 2064 B0           	DB #0E10-#0D60
1556+ 2065 E8           	DB #0EF8-#0E10
1557+ 2066
1558+ 2066              ;vars from here can be stripped
1559+ 2066              ;you can move VARS to any other address
1560+ 2066
1561+ 2066              VARS
1562+ 2066
1563+ 2066 00           is_ts	DB 0
1564+ 2067
1565+ 2067              ;ChannelsVars
1566+ 2067              	STRUCT	CHP
1567+ 2067 ~            ;reset group
1568+ 2067 ~            PsInOr	DB 0
1569+ 2067 ~            PsInSm	DB 0
1570+ 2067 ~            CrAmSl	DB 0
1571+ 2067 ~            CrNsSl	DB 0
1572+ 2067 ~            CrEnSl	DB 0
1573+ 2067 ~            TSlCnt	DB 0
1574+ 2067 ~            CrTnSl	DW 0
1575+ 2067 ~            TnAcc	DW 0
1576+ 2067 ~            COnOff	DB 0
1577+ 2067 ~            ;reset group
1578+ 2067 ~
1579+ 2067 ~            OnOffD	DB 0
1580+ 2067 ~
1581+ 2067 ~            ;IX for PTDECOD here (+12)
1582+ 2067 ~            OffOnD	DB 0
1583+ 2067 ~            OrnPtr	DW 0
1584+ 2067 ~            SamPtr	DW 0
1585+ 2067 ~            NNtSkp	DB 0
1586+ 2067 ~            Note	DB 0
1587+ 2067 ~            SlToNt	DB 0
1588+ 2067 ~            Env_En	DB 0
1589+ 2067 ~            Flags	DB 0
1590+ 2067 ~             ;Enabled - 0, SimpleGliss - 2
1591+ 2067 ~            TnSlDl	DB 0
1592+ 2067 ~            TSlStp	DW 0
1593+ 2067 ~            TnDelt	DW 0
1594+ 2067 ~            NtSkCn	DB 0
1595+ 2067 ~            Volume	DB 0
1596+ 2067              	ENDS
1597+ 2067
1598+ 2067              	STRUCT	VRS
1599+ 2067 ~
1600+ 2067 ~            ;IF not works in STRUCT in SjASM :(
1601+ 2067 ~            ;	IF CurPosCounter
1602+ 2067 ~            CurPos	DB 0
1603+ 2067 ~            PosSub	DB 0
1604+ 2067 ~            ;	ENDIF
1605+ 2067 ~
1606+ 2067 ~            ModNum	DB 0 ;bit0: ChipNum
1607+ 2067 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608+ 2067 ~
1609+ 2067 ~            ChanA	DS CHP
1610+ 2067 ~            ChanB	DS CHP
1611+ 2067 ~            ChanC	DS CHP
1612+ 2067 ~
1613+ 2067 ~            ;GlobalVars
1614+ 2067 ~            MODADDR	DW 0
1615+ 2067 ~            OrnPtrs	DW 0
1616+ 2067 ~            SamPtrs	DW 0
1617+ 2067 ~            PatsPtr	DW 0
1618+ 2067 ~            AdInPtA	DW 0
1619+ 2067 ~            AdInPtB	DW 0
1620+ 2067 ~            AdInPtC	DW 0
1621+ 2067 ~            CrPsPtr	DW 0
1622+ 2067 ~            LPosPtr	DW 0
1623+ 2067 ~            Delay	DB 0
1624+ 2067 ~            DelyCnt	DB 0
1625+ 2067 ~            ESldAdd	DW 0
1626+ 2067 ~            CurESld	DW 0
1627+ 2067 ~            Env_Del	DB 0
1628+ 2067 ~            CurEDel	DB 0
1629+ 2067 ~            Ns_Base	DB 0
1630+ 2067 ~            AddToNs	DB 0
1631+ 2067 ~            AddToEn	DB 0
1632+ 2067 ~            EnvBase	DW 0
1633+ 2067 ~            AYREGS	DS 14
1634+ 2067              	ENDS
1635+ 2067
1636+ 2067 00 00 00...  VARS1	DS VRS
1637+ 20EE 00 00 00...  VARS2	DS VRS
1638+ 2175
1639+ 2175              VT_	EQU $-16
1640+ 2175 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641+ 2265
1642+ 2265              T1_	EQU VT_+16 ;Tone tables data depacked here
1643+ 2265
1644+ 2265              T_OLD_1	EQU T1_
1645+ 2265              T_OLD_2	EQU T_OLD_1+24
1646+ 2265              T_OLD_3	EQU T_OLD_2+24
1647+ 2265              T_OLD_0	EQU T_OLD_3+2
1648+ 2265              T_NEW_0	EQU T_OLD_0
1649+ 2265              T_NEW_1	EQU T_OLD_1
1650+ 2265              T_NEW_2	EQU T_NEW_0+24
1651+ 2265              T_NEW_3	EQU T_OLD_3
1652+ 2265
1653+ 2265              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654+ 2265
1655+ 2265 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656+ 2325
1657+ 2325              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658+ 2325
1659+ 2325              VARSEND EQU $
1660+ 2325
1661+ 2325              MDLADDR EQU outputBuffer
1662+ 2325
1663+ 2325              ;Release 0 steps:
1664+ 2325              ;04/21/2007
1665+ 2325              ;Works start (PTxPlay adaptation); first beta.
1666+ 2325              ;04/22/2007
1667+ 2325              ;Job finished; beta-testing.
1668+ 2325              ;04/23/2007
1669+ 2325              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670+ 2325              ;04/29/2007
1671+ 2325              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672+ 2325              ;modules of v3.7+.
1673+ 2325
1674+ 2325              ;Size (minimal build for ZX Spectrum):
1675+ 2325              ;Code block #908 bytes
1676+ 2325              ;Variables #2BF bytes (can be stripped)
1677+ 2325              ;Total size #908+#2BF=#BC7 (3015) bytes
1678+ 2325              	ENDMODULE
# file closed: player.asm
2589  2325 00 00 00...  	align 256
2590  2400              font
2591  2400              	incbin fontV6.chr ;шрифт
2592  2C00
2593  2C00              ;Переменные
2594  2C00 00           proc_next_find_focus_flag db 0 ;флаг внеочередного вызова процесса в фокусе
2595  2C01 00           Interrupt_new_flag db 0 ;флаг только что было прерывание
2596  2C02 00           uart_enable db 0; флаг есть порт uart
2597  2C03 00           proc_play_ay db 0 ;код процесса с музыкой AY
2598  2C04 00           proc_play_ay_slot2 db 0 ;страница с музыкой AY
2599  2C05 00           proc_play_ay_slot3 db 0 ;страница с музыкой AY
2600  2C06 00           scr_cur db 0 ;текущий активный экран
2601  2C07 00           proc_id_focus db 0 ;процесс, у которого фокус (видимый экран и доступно управление)
2602  2C08 00 00        proc_stack_addr_tmp dw 0 ; временно адрес стека
2603  2C0A 00 00        proc_stack_addr_tmp_wait dw 0 ; временно адрес стека
2604  2C0C 00           os_wait_flag db 0; флаг вызова os_wait
2605  2C0D 00           proc_next_find_skip_flag db 0; флаг дополнительных проверок переключения задач
2606  2C0E 00 00        proc_stack_addr_return_tmp dw 0 ;временно адрес возврата из прерываний
2607  2C10 00           key_proc_switch_flag db 0 ;флаг что нажата клавиша переключения задач
2608  2C11 00           key_lang_flag db 0 ;флаг что нажата клавиша rus lat
2609  2C12 00           key_caps_lock_switch_flag db 0 ;флаг что нажата клавиша caps lock
2610  2C13 00           key_graph_flag db 0 ;флаг что нажата клавиша graph
2611  2C14 00           key_sys_focus db 0 ;кнопка sys процесс в фокус
2612  2C15 00 00        FlgScanKeys_addr dw 0 ;адрес флаги драйвера
2613  2C17              ;stack_adr_sys dw 0 ;адрес системного стека
2614  2C17 00           page_slot2_cur db 0 ;текущая страница в слоте 2
2615  2C18 00           page_slot3_cur db 0 ;текущая страница в слоте 3
2616  2C19 00           page_slot2_cur_tmp db 0 ;текущая страница в слоте 2 временно
2617  2C1A 00           page_slot3_cur_tmp db 0 ;текущая страница в слоте 3 временно
2618  2C1B 00           con_scr_cur db 0 ;страница активного экрана пиксели
2619  2C1C 00           con_atr_cur db 0 ;страница активного экрана атрибуты
2620  2C1D 00           key_cur db 0 ;печатный код нажатой клавиши
2621  2C1E 00           file_id_cur db 0 ;временно id файла
2622  2C1F 00           mono_mode_id db 0 ;id процесса в режиме моно
2623  2C20
2624  2C20 00           proc_id_next db 0 ;код следующего процесса
2625  2C21 00 00        proc_stack_adr_tmp dw 0 ;временно адрес стека
2626  2C23 00           proc_id_cur db 0 ;id текущего процесса
2627  2C24 00           proc_id_cur_tmp db 0 ;временно id процесса
2628  2C25              ;proc_sys_name db "SYS        ",0 ;имя системного процесса
2629  2C25              ;proc_cmd_name db "CMD        ",0 ;имя процесса консоль
2630  2C25 00 00 00 00  sys_timer ds 4 ;таймер - счётчик прерываний
2631  2C29
2632  2C29 00 00 00...  	align 256
2633  2D00              proc_table ;данные процессов и приложений
2634  2D00 00 00 00...  	ds proc_descr_size*proc_max ;на командную строку, список страниц и прочее
2635  3500              	;#00 - id процесса
2636  3500              	;#01 - id родительского
2637  3500              	;#02 - страница #8000
2638  3500              	;#03 - страница #c000
2639  3500              	;#04 - страница буфер экран пиксели
2640  3500              	;#05 - страница буфер экран атрибуты
2641  3500              	;#06-07 - адрес стека
2642  3500              	;#08-09 - позиция аппаратного скрола
2643  3500              	;#0a-0b - координаты курсора
2644  3500              	;#0c-0d - цвет текста основной, цвет второй
2645  3500              	;#0e-0f - адрес вызова по прерыванию
2646  3500              	;#10-1b - Имя
2647  3500              	;#1c - графический режим (номер страницы. 0 - текстовый)
2648  3500              	;#1d - флаг, что процесс запросил os_wait
2649  3500
2650  3500              	;..#80 - верх стека
2651  3500
2652  3500              proc_page_table	;таблица занятых процессами страниц
2653  3500 00 00 00...  	ds 128 ;у GMX всего 128
2654  3580
2655  3580
2656  3580              esp_link_id_table;_id_table ;таблица соединений ESP
2657  3580              	;0 - id процесса (одновременно флаг "соединение используется")
2658  3580              	;1 - запрос соединения (=1 - активен)
2659  3580              	;2 - результат соединения (=1 - успешно, =255 - ошибка)
2660  3580              	;3 - запрос на отправку (=1 - активен)
2661  3580              	;4 - результат отправки (=1 - успешно, =255 - ошибка)
2662  3580              	;5 - запрос на приём (=1 - активен)
2663  3580              	;6 - результат приёма (=1 - успешно, =255 - ошибка)
2664  3580              	;7-8 - адрес назначения данных (для принятых)
2665  3580              	;9-10 - длина данных
2666  3580              	;11-13 -
2667  3580              	;14 - тип (TCP, UDP, SSL)
2668  3580              	;15-58 - адрес сервера, в конце 0
2669  3580              	;59-63 - порт сервера, в конце 0
2670  3580
2671  3580 00 00 00...  	ds 1*esp_link_id_table_size_item ;1 соединение
2672  35C0
2673  35C0              ; esp_buffer_flag ;флаги управления буфером ESP
2674  35C0              	; ;0 - буфер занят системным процессом (=1 - идёт передача)
2675  35C0              	; ;1-2 - длина данных
2676  35C0              	; ds 1
2677  35C0
2678  35C0
2679  35C0              ; proc_name_01	db "radio.apg",0
2680  35C0              ; proc_name_02	db "moonr.apg",0
2681  35C0              ; proc_name_03	db "nc.apg",0
2682  35C0 73 79 73 2E  proc_name_sys	db "sys.osg",0
2682  35C4 6F 73 67 00
2683  35C8              ; proc_name_net	db "net.apg",0
2684  35C8
2685  35C8
2686  35C8              ;Константы
2687  35C8              uart_port equ #EF ;порт
2688  35C8              outputBuffer equ #c000 ;адрес файла для плеера AY
2689  35C8              proc_color_def equ 7 ;цвет текста консоли
2690  35C8              proc_color2_def equ #c ;цвет текста консоли 2 яркий
2691  35C8              function_max equ 42+1 ;всего функций
2692  35C8              proc_size_max equ #80 ;максимальный размер приложения старший байт
2693  35C8              proc_descr_size equ 256 ;область памяти на одно приложение
2694  35C8              proc_max equ 8 ;максимальное количество приложений
2695  35C8              page_max equ drvgmx.page_table_end-drvgmx.page_table ;всего доступных страниц из 128
2696  35C8              proc_id_system equ 1 ;код системного процесса
2697  35C8              ;proc_stack equ #4000;адрес стека для процессов
2698  35C8              ;proc_stack_size equ 128 ;размер стека для процесса
2699  35C8              con_scr_real equ #39 ;экран физический
2700  35C8              con_atr_real equ #79 ;атрибуты
2701  35C8              ;page_slot2_def equ 2 ;страница по умолчанию слот 2
2702  35C8              ;page_slot3_def equ 1 ;страница по умолчанию слот 3
2703  35C8              proc_switch_key equ #1b ;код перключения задач sh+Enter
2704  35C8              ;esp_max_link_id equ 5 ;всего соединений ESP
2705  35C8              esp_link_id_table_size_item equ 64 ;размер элемента в таблице соединений
2706  35C8
2707  35C8              ;Сообщения
2708  35C8              msg_init_uart_found
2709  35C8 55 41 52 54  	db "UART #EF found",13,10,0
2709  35CC 20 23 45 46
2709  35D0 20 66 6F 75
2709  35D4 6E 64 0D 0A
2709  35D8 00
2710  35D9              msg_init_uart_not_found
2711  35D9 55 41 52 54  	db "UART #EF not found",13,10,0
2711  35DD 20 23 45 46
2711  35E1 20 6E 6F 74
2711  35E5 20 66 6F 75
2711  35E9 6E 64 0D 0A
2711  35ED 00
2712  35EE              msg_proc_max
2713  35EE 4E 6F 74 20  	db "Not enough processes",13,10,0
2713  35F2 65 6E 6F 75
2713  35F6 67 68 20 70
2713  35FA 72 6F 63 65
2713  35FE 73 73 65 73
2713  3602 0D 0A 00
2714  3605              msg_mem_max
2715  3605 4E 6F 74 20  	db "Not enough memory",13,10,0
2715  3609 65 6E 6F 75
2715  360D 67 68 20 6D
2715  3611 65 6D 6F 72
2715  3615 79 0D 0A 00
2716  3619
2717  3619
2718  3619
2719  3619              msg_ver_os
2720  3619 4F 53 20 76  	db "OS ver 2025.10.08",13,10,0
2720  361D 65 72 20 32
2720  3621 30 32 35 2E
2720  3625 31 30 2E 30
2720  3629 38 0D 0A 00
2721  362D
2722  362D
2723  362D
2724  362D
2725  362D
2726  362D
2727  362D              ; start_sys_incl
2728  362D              	; incbin sys.apg ;
2729  362D              ; end_sys_incl
2730  362D
2731  362D              ; start_cmd_incl
2732  362D              	; incbin cmd.apg ;
2733  362D              ; end_cmd_incl
2734  362D
2735  362D              	;Последний перед #4000 буфер для данных от ESP
2736  362D 00 00 00...  esp_buffer ds 1500 ;буфер для обмена с ESP
2737  3C09
2738  3C09              end_os_main
2739  3C09              	SAVETRD "OS.TRD",|"OS.C",start_os_main,$-start_os_main ;сохранить в TRD
2740  3C09              	SAVEBIN "os.c",start_os_main,$-start_os_main ;сохранить для FAT
2741  3C09
2742  3C09              	;манипуляции для создания hobeta
2743  3C09              	org #c000
2744  C000              	incbin "os.c"
2745  FC09              	SAVEHOB "os.$c","os.C",#C000,end_os_main-start_os_main ;
2746  FC09
2747  FC09
2748  FC09
2749  FC09
2750  FC09
# file closed: os_main.asm
