# file opened: os_main.asm
   1  0000              ;OS GMX (izzx, 2024-2025)
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "os_defs.asm"
# file opened: os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000              ;например, плеера музыки
 200+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 201+ 0000              ;на время выполнения включаются обе страницы процесса
 202+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 203+ 0000 ~                ld c,#14
 204+ 0000 ~                rst #20
 205+ 0000                  endm
 206+ 0000
 207+ 0000
 208+ 0000              ;плеер AY ----------------------------
 209+ 0000
 210+ 0000              ;инициализация плеера AY;
 211+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 212+ 0000 ~                ld c,#15
 213+ 0000 ~                rst #20
 214+ 0000                  endm
 215+ 0000
 216+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 217+ 0000                  macro OS_VTPL_PLAY ;()
 218+ 0000 ~                ld c,#16
 219+ 0000 ~                rst #20
 220+ 0000                  endm
 221+ 0000
 222+ 0000              ;заглушить плеер AY;
 223+ 0000                  macro OS_VTPL_MUTE ;()
 224+ 0000 ~                ld c,#17
 225+ 0000 ~                rst #20
 226+ 0000                  endm
 227+ 0000
 228+ 0000              ;получить значение переменной плеера;
 229+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 230+ 0000 ~                ld c,#18
 231+ 0000 ~                rst #20
 232+ 0000                  endm
 233+ 0000
 234+ 0000
 235+ 0000              ;прочие ------------------------------
 236+ 0000
 237+ 0000
 238+ 0000              ;скопировать данные из страницы в страницу
 239+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 240+ 0000                  macro OS_RAM_COPY
 241+ 0000 ~                ld c,#19
 242+ 0000 ~                rst #20
 243+ 0000                  endm
 244+ 0000
 245+ 0000              ;получить дополнительную страницу памяти;
 246+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 247+ 0000 ~                ld c,#1a
 248+ 0000 ~                rst #20
 249+ 0000                  endm
 250+ 0000
 251+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 252+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 253+ 0000 ~                ld c,#1b
 254+ 0000 ~                rst #20
 255+ 0000                  endm
 256+ 0000
 257+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 258+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 259+ 0000 ~                ld c,#1c
 260+ 0000 ~                rst #20
 261+ 0000                  endm
 262+ 0000
 263+ 0000              ;включить экран N;
 264+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 265+ 0000              ;переключать может только приложение в фокусе
 266+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 267+ 0000              ;при переключении процессов сохраняется только экран #39
 268+ 0000                  macro OS_SET_SCREEN ;
 269+ 0000 ~                ld c,#1d
 270+ 0000 ~                rst #20
 271+ 0000                  endm
 272+ 0000
 273+ 0000
 274+ 0000              ;получить номера страниц процесса;
 275+ 0000              ;вх:
 276+ 0000              ;вых: b, c - страницы в слотах 2, 3
 277+ 0000                  macro OS_GET_MAIN_PAGES ;
 278+ 0000 ~                ld c,#1e
 279+ 0000 ~                rst #20
 280+ 0000                  endm
 281+ 0000
 282+ 0000              ;получить значение системного таймера
 283+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 284+ 0000 ~                ld c,#1F
 285+ 0000 ~                rst #20
 286+ 0000                  endm
 287+ 0000
 288+ 0000
 289+ 0000              ;освободить страницу памяти
 290+ 0000              ;вх: a - номер страницы
 291+ 0000                  macro OS_DEL_PAGE ;
 292+ 0000 ~                ld c,#20
 293+ 0000 ~                rst #20
 294+ 0000                  endm
 295+ 0000
 296+ 0000
 297+ 0000              ;дисковые операции -------------------
 298+ 0000
 299+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 300+ 0000
 301+ 0000              ; fcbFAT (из руководства к монитору)
 302+ 0000              ; формат fcb для работы с FAT
 303+ 0000
 304+ 0000              ; +#00 8 имя файла
 305+ 0000              ; +#08 3 расширение файла
 306+ 0000              ; +#0B 1 атрибуты файла
 307+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 308+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 309+ 0000              ; +#14 4 размер файла/каталога в байтах
 310+ 0000              ; +#18 4 указатель в файле
 311+ 0000              ; +#1C 1 для внутренних нужд
 312+ 0000              ; +#1D 1 для внутренних нужд
 313+ 0000              ; +#1E 1 резерв
 314+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 315+ 0000              	; 1-0,nn номер раздела
 316+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 317+ 0000              	    ; значение %11 недопустимо
 318+ 0000
 319+ 0000              ;открыть файл для чтения или записи
 320+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 321+ 0000 ~                ld c,#21
 322+ 0000 ~                rst #20
 323+ 0000                  endm
 324+ 0000
 325+ 0000              ;создать файл
 326+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 327+ 0000 ~                ld c,#22
 328+ 0000 ~                rst #20
 329+ 0000                  endm
 330+ 0000
 331+ 0000              ;прочитать из файла
 332+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 333+ 0000 ~                ld c,#23
 334+ 0000 ~                rst #20
 335+ 0000                  endm
 336+ 0000
 337+ 0000              ;записать в файл
 338+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 339+ 0000 ~                ld c,#24
 340+ 0000 ~                rst #20
 341+ 0000                  endm
 342+ 0000
 343+ 0000              ;закрыть файл
 344+ 0000                  macro OS_FILE_CLOSE ;A - id file
 345+ 0000 ~                ld c,#25
 346+ 0000 ~                rst #20
 347+ 0000                  endm
 348+ 0000
 349+ 0000              ;чтение секторов текущего каталога
 350+ 0000              ; вх:
 351+ 0000                   ; hl - буфер для чтения
 352+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 353+ 0000                   ; b - максимальное количество секторов для чтения
 354+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 355+ 0000                     ; a=errRWnum
 356+ 0000                     ; a=errInvalidPart
 357+ 0000                     ; a=errFileEmpty
 358+ 0000                   ; cy=0, a=errEoF - каталог закончился
 359+ 0000                     ; hl - следующий адрес в буфере
 360+ 0000                     ; de - номер первого непрочитанного сектора
 361+ 0000                     ; b - не прочитано секторов
 362+ 0000                   ; cy=0 - считано успешно
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b=#00
 366+ 0000                  macro OS_DIR_READ ;
 367+ 0000 ~                ld c,#26
 368+ 0000 ~                rst #20
 369+ 0000                  endm
 370+ 0000
 371+ 0000              ;вход в каталог/выход в родительский каталог
 372+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 373+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 374+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 375+ 0000              	; переход в родительский, последнее имя в пути удалится).
 376+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 377+ 0000              	; добавится имя файла
 378+ 0000              ; вх:
 379+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 380+ 0000                   ; de - адрес дескриптора директории/файла
 381+ 0000              ; вых: a - если путь был указан, новая длина пути
 382+ 0000                  macro OS_DIR_OPEN ;
 383+ 0000 ~                ld c,#27
 384+ 0000 ~                rst #20
 385+ 0000                  endm
 386+ 0000
 387+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 388+ 0000              ;проверки на допустимость значений не производится
 389+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 390+ 0000              ;вх: A - id файла
 391+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 392+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 393+ 0000                  macro OS_FILE_POSITION ;
 394+ 0000 ~                ld c,#28
 395+ 0000 ~                rst #20
 396+ 0000                  endm
 397+ 0000
 398+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 399+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 400+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 401+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 402+ 0000                  macro OS_FIND_PATH ;
 403+ 0000 ~                ld c,#29
 404+ 0000 ~                rst #20
 405+ 0000                  endm
 406+ 0000
 407+ 0000
 408+ 0000              ; получение длинного имени файла
 409+ 0000              ;вх: hl - адрес буфера для имени
 410+ 0000              ;    de - номер записи в текущем каталоге
 411+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 412+ 0000              ; 	a - длина имени, с учетом нуля
 413+ 0000                  macro OS_GET_LFN ;
 414+ 0000 ~                ld c,#2a
 415+ 0000 ~                rst #20
 416+ 0000                  endm
 417+ 0000
# file closed: os_defs.asm
   4  0000
   5  0000              ;sys - системный процесс для OS
   6  0000              	org PROG_START
   7  8000              	;bank 1
   8  8000              start_sys
   9  8000 FB           	ei
  10  8001              	;halt ;ожидание старта после прерывания
  11  8001              	;halt
  12  8001 AF           	xor a
  13  8002 D3 FE        	out (254),a
  14  8004 21 19 36     	ld hl,msg_ver_os
  15  8007              	;печать приветствия
  16  8007 CD 50 0A     	call drvgmx.printZ
  17  800A
  18  800A 11 00 18     	ld de,#1800 ;координаты yx
  19  800D              	OS_SET_XY
  19  800D 0E 01       >    ld c,#01
  19  800F E7          >    rst #20
  20  8010 21 B6 82     	ld hl,msg_press_num_to_close
  21  8013              	OS_PRINTZ
  21  8013 0E 09       >    ld c,#09
  21  8015 E7          >    rst #20
  22  8016
  23  8016              	;автозапуск приложений
  24  8016 11 00 17     	ld de,#1700 ;координаты yx
  25  8019              	OS_SET_XY
  25  8019 0E 01       >    ld c,#01
  25  801B E7          >    rst #20
  26  801C 21 09 83     	ld hl,sys_file_autorun_name ;имя списка
  27  801F CD C0 0C     	call Dos.fopen_r ;откроем файл для чтения
  28  8022 DC 2F 0E     	call c,Dos.file_error_print_file_open_error
  29  8025 DA A4 80     	jp c,sys_loop
  30  8028 32 08 83     	ld (sys_file_autorun_id_tmp),a ;запомнить id
  31  802B
  32  802B              	;проверка длины файла не больше #8000
  33  802B 7A           	ld	a,d ;самые старшие байты длины
  34  802C B3           	or e
  35  802D 28 09        	jr z,sys_file_size_ok ;если не слищком большой
  36  802F              sys_file_too_big
  37  802F 21 42 10     	ld hl,Dos.msg_file_too_big
  38  8032 CD 50 0A     	call drvgmx.printZ
  39  8035 C3 A4 80     	jp sys_loop
  40  8038
  41  8038
  42  8038              sys_file_size_ok
  43  8038 78           	ld	a,b ;младший старший байт длины
  44  8039 FE 80        	cp #80
  45  803B 30 F2        	jr nc,sys_file_too_big
  46  803D              	;размер нормальный, прочитаем
  47  803D ED 43 15 83  	ld (sys_file_autorun_lenght),bc
  48  8041 21 00 C0     	ld hl,#c000
  49  8044 3A 08 83     	ld a,(sys_file_autorun_id_tmp)
  50  8047 50           	ld d,b ;размер
  51  8048 59           	ld e,c
  52  8049 CD 79 0E     	call Dos.fread
  53  804C 30 0B        	jr nc,sys_file_size_ok2
  54  804E              	;если ошибка
  55  804E CD 37 0E     	call Dos.file_error_print_file_read_error
  56  8051 3A 08 83     	ld a,(sys_file_autorun_id_tmp)
  57  8054 CD 3F 0E     	call Dos.fclose ;закрыть файл
  58  8057 18 4B        	jr sys_loop
  59  8059              sys_file_size_ok2
  60  8059 3A 08 83     	ld a,(sys_file_autorun_id_tmp)
  61  805C CD 3F 0E     	call Dos.fclose ;закрыть файл
  62  805F
  63  805F
  64  805F              	;анализ файла
  65  805F 21 00 C0     	ld hl,#c000
  66  8062 ED 4B 15 83  	ld bc,(sys_file_autorun_lenght) ;цикл
  67  8066              sys_file_autorun_cl
  68  8066 C5           	push bc
  69  8067 7E           	ld a,(hl)
  70  8068 FE 20        	cp " "
  71  806A 38 2C        	jr c,sys_file_autorun_next
  72  806C
  73  806C              	;тут нашли первое имя
  74  806C E5           	push hl
  75  806D 21 18 83     	ld hl,sys_file_autorun_name_tmp ;почистить буфер
  76  8070 11 19 83     	ld de,sys_file_autorun_name_tmp+1
  77  8073 01 FF 00     	ld bc,256-1
  78  8076 36 00        	ld (hl),0
  79  8078 ED B0        	ldir
  80  807A
  81  807A E1           	pop hl
  82  807B 11 18 83     	ld de,sys_file_autorun_name_tmp ;куда
  83  807E 01 00 00     	ld bc,#0000 ;макс длина 255
  84  8081              	;ld ixl,0 ;счётчик
  85  8081              sys_file_autorun_cl2
  86  8081 7E           	ld a,(hl)
  87  8082 FE 20        	cp " "
  88  8084 38 04        	jr c,sys_file_autorun_cl2_ex
  89  8086 ED A0        	ldi
  90  8088 10 F7        	djnz sys_file_autorun_cl2
  91  808A
  92  808A              sys_file_autorun_cl2_ex
  93  808A              	;запустим
  94  808A E5           	push hl
  95  808B 21 18 83     	ld hl,sys_file_autorun_name_tmp		;строка с именем
  96  808E CD DE 02     	call proc_run
  97  8091 DD 7E 00     	ld a,(ix)
  98  8094 32 17 83     	ld (sys_file_autorun_focus),a ;запомнить последний
  99  8097 E1           	pop hl
 100  8098              	;тут надо бы уменьщить счётчик bc на длину имени
 101  8098              sys_file_autorun_next
 102  8098 23           	inc hl
 103  8099 C1           	pop bc
 104  809A 0B           	dec bc
 105  809B 78           	ld a,b
 106  809C B1           	or c
 107  809D 20 C7        	jr nz, sys_file_autorun_cl
 108  809F
 109  809F 3E 01        	ld a,1
 110  80A1              	;ld a,(sys_file_autorun_focus)
 111  80A1 CD 3D 02     	call proc_set_focus ;на передний план
 112  80A4
 113  80A4
 114  80A4              	;jr file_load_ok
 115  80A4              	;call proc_run_cmd ;запустить консоль
 116  80A4              	;call proc_run_cmd ;запустить консоль
 117  80A4              	; call proc_run_cmd ;запустить консоль
 118  80A4              	; call proc_run_cmd ;запустить консоль
 119  80A4              	; call proc_run_cmd ;запустить консоль
 120  80A4              	;call proc_run_cmd ;запустить консоль
 121  80A4              	;call proc_run_cmd ;запустить консоль
 122  80A4
 123  80A4              	; ld hl,proc_name_net		;строка с именем
 124  80A4              	; call proc_run ;запуск
 125  80A4
 126  80A4              	; ld hl,proc_name_01		;строка с именем
 127  80A4              	; call proc_run
 128  80A4
 129  80A4              	; ld hl,proc_name_02		;строка с именем
 130  80A4              	; call proc_run
 131  80A4
 132  80A4              	; ld hl,proc_name_03		;строка с именем
 133  80A4              	; call proc_run
 134  80A4              	; ld a,(ix)
 135  80A4              	; call proc_set_focus ;на передний план
 136  80A4
 137  80A4              sys_loop
 138  80A4              	;OS_WAIT ;для системного процесса не рекомендуется
 139  80A4 76           	halt
 140  80A5 CD 68 82     	call print_active ;индикатор
 141  80A8
 142  80A8              	OS_GET_CHAR
 142  80A8 0E 10       >    ld c,#10
 142  80AA E7          >    rst #20
 143  80AB
 144  80AB              	;печать кода нажатой клавиши
 145  80AB              	;ld a,(key_cur)
 146  80AB FE FF        	cp 255
 147  80AD 28 14        	jr z,sys_loop_skip_print_char
 148  80AF F5           	push af
 149  80B0 6F           	ld l,a
 150  80B1 26 00        	ld h,0
 151  80B3 CD ED 05     	call toDecimal
 152  80B6 11 4C 18     	ld de,#184c ;координаты yx
 153  80B9              	OS_SET_XY
 153  80B9 0E 01       >    ld c,#01
 153  80BB E7          >    rst #20
 154  80BC 21 45 06     	ld hl,decimalS+2
 155  80BF CD 50 0A     	call drvgmx.printZ
 156  80C2 F1           	pop af
 157  80C3              	;-------
 158  80C3              sys_loop_skip_print_char
 159  80C3 FE 16        	cp 22 ;кнопка выхода в монитор
 160  80C5 CA 71 81     	jp z,call_monitor
 161  80C8 FE 13        	cp 19 ;кнопка запуска NC
 162  80CA CA 5F 81     	jp z,run_nc
 163  80CD FE 32        	cp "2" ;кнопки от 2 до 9
 164  80CF 38 0C        	jr c,sys_loop_skip
 165  80D1 FE 39        	cp "9"
 166  80D3 30 08        	jr nc,sys_loop_skip
 167  80D5              	;здесь надо закрыть процесс
 168  80D5 D6 30        	sub "0"
 169  80D7 CD 73 06     	call proc_close_skip
 170  80DA
 171  80DA              sys_loop_skip2
 172  80DA CD 55 81     	call release_key
 173  80DD
 174  80DD
 175  80DD              sys_loop_skip
 176  80DD 3A 10 2C     	ld a,(key_proc_switch_flag) ;если нажали переключение фокуса
 177  80E0 B7           	or a
 178  80E1 28 11        	jr z,sys_loop_skip_key_focus
 179  80E3 CD 2C 02     	call proc_focus_next
 180  80E6 CD 55 81     	call release_key
 181  80E9 AF           	xor a
 182  80EA 32 10 2C     	ld (key_proc_switch_flag),a
 183  80ED 3E FF        	ld a,255
 184  80EF 32 1D 2C     	ld (key_cur),a ;очистить буфер
 185  80F2 18 56        	jr sys_loop_skip_key
 186  80F4
 187  80F4              sys_loop_skip_key_focus
 188  80F4 3A 12 2C     	ld a,(key_caps_lock_switch_flag) ;если нажали caps_lock
 189  80F7 B7           	or a
 190  80F8 28 10        	jr z,sys_loop_skip_key_caps_lock
 191  80FA 2A 15 2C     	ld hl,(FlgScanKeys_addr)
 192  80FD 3E 02        	ld a,%00000010	;?1,=1/0 CapsLock on/off
 193  80FF AE           	xor (hl)
 194  8100 77           	ld (hl),a
 195  8101 CD 55 81     	call release_key
 196  8104 AF           	xor a
 197  8105 32 12 2C     	ld (key_caps_lock_switch_flag),a
 198  8108 18 40        	jr sys_loop_skip_key
 199  810A
 200  810A              sys_loop_skip_key_caps_lock
 201  810A 3A 11 2C     	ld a,(key_lang_flag) ;если нажали rus_lat
 202  810D B7           	or a
 203  810E 28 10        	jr z,sys_loop_skip_key_rus_lat
 204  8110 2A 15 2C     	ld hl,(FlgScanKeys_addr)
 205  8113 3E 08        	ld a,%00001000	;3,=1/0 Rus/Lat
 206  8115 AE           	xor (hl) ;флаг FlgScanKeys
 207  8116 77           	ld (hl),a
 208  8117 CD 55 81     	call release_key
 209  811A AF           	xor a
 210  811B 32 11 2C     	ld (key_lang_flag),a
 211  811E 18 2A        	jr sys_loop_skip_key
 212  8120
 213  8120              sys_loop_skip_key_rus_lat
 214  8120 3A 13 2C     	ld a,(key_graph_flag) ;если нажали graph
 215  8123 B7           	or a
 216  8124 28 10        	jr z,sys_loop_skip_key_graph
 217  8126 2A 15 2C     	ld hl,(FlgScanKeys_addr)
 218  8129 3E 04        	ld a,%00000100	;2,=1/0 Grf on/off
 219  812B AE           	xor (hl)
 220  812C 77           	ld (hl),a
 221  812D CD 55 81     	call release_key
 222  8130 AF           	xor a
 223  8131 32 13 2C     	ld (key_graph_flag),a
 224  8134 18 14        	jr sys_loop_skip_key
 225  8136
 226  8136              sys_loop_skip_key_graph
 227  8136 3A 14 2C     	ld a,(key_sys_focus) ;если нажали EXT+1
 228  8139 B7           	or a
 229  813A 28 0E        	jr z,sys_loop_skip_key_sys_focus
 230  813C              	;фокус на системный процесс
 231  813C 3E 01        	ld a,1
 232  813E CD 3D 02     	call proc_set_focus
 233  8141 CD 55 81     	call release_key
 234  8144 AF           	xor a
 235  8145 32 14 2C     	ld (key_sys_focus),a
 236  8148 18 00        	jr sys_loop_skip_key
 237  814A
 238  814A
 239  814A              sys_loop_skip_key_sys_focus
 240  814A
 241  814A              sys_loop_skip_key
 242  814A
 243  814A
 244  814A 3A 24 2C     	ld a,(sys_timer) ;иногда печатаем системную информацию
 245  814D E6 0F        	and %00001111
 246  814F CC 8C 81     	call z,sys_print_info
 247  8152              	; OS_GETCHAR ;получить нажатую клавишу
 248  8152              	; cp 255
 249  8152              	; jr z,sys_loop
 250  8152              	; OS_PRINT_CHARF ;печать символа
 251  8152
 252  8152
 253  8152
 254  8152 C3 A4 80     	jp sys_loop
 255  8155
 256  8155
 257  8155
 258  8155
 259  8155              release_key ;ждать отпускания клавиши
 260  8155              	;OS_WAIT ;для системного процесса не рекомендуется
 261  8155 76           	halt
 262  8156              	;ld hl,(FlgScanKeys_addr)
 263  8156              	;ждать пока отпустят все клавиши
 264  8156 AF           WAITKEY	XOR A
 264  8157 DB FE         IN A,(#FE)
 264  8159 2F            CPL
 264  815A E6 1F         AND #1F
 264  815C 20 F8         JR nz,WAITKEY
 265  815E              	;bit 6,(hl)
 266  815E              	;jr z,release_key
 267  815E C9           	ret
 268  815F
 269  815F              run_nc
 270  815F 21 8A 82     	ld hl,proc_name_nc		;строка с именем
 271  8162 CD DE 02     	call proc_run
 272  8165 DA DA 80     	jp c,sys_loop_skip2
 273  8168 DD 7E 00     	ld a,(ix)
 274  816B CD 3D 02     	call proc_set_focus ;на передний план
 275  816E C3 DA 80     	jp sys_loop_skip2
 276  8171
 277  8171              call_monitor	;вызов теневого монитора
 278  8171 F3           	di
 279  8172 ED 73 8A 81  	ld (call_monitor_tmp_sp),sp
 280  8176 31 00 60     	ld sp,#6000 ;временный стек
 281  8179 CD 66 00     	call #66
 282  817C ED 7B 8A 81  	ld sp,(call_monitor_tmp_sp)
 283  8180
 284  8180 3A F3 0F     	ld a,(Dos.fs_fat_part_code_cur)
 285  8183 CD E7 0D     	call Dos.init_fs_fat_warm ;переинициализация FAT
 286  8186 FB           	ei
 287  8187 C3 DA 80     	jp sys_loop_skip2
 288  818A
 289  818A 00 00        call_monitor_tmp_sp dw 0 ;временно
 290  818C
 291  818C              ;печать информации
 292  818C              sys_print_info
 293  818C              	;инфо об открытых файлах
 294  818C              sys_print_info_files
 295  818C 21 E2 11     	ld hl,Dos.fcb_fat_table
 296  818F 06 08        	ld b,Dos.files_fat_max
 297  8191 0E 00        	ld c,0 ;счётчик
 298  8193              sys_print_info_files_cl
 299  8193 7E           	ld a,(hl)
 300  8194 B7           	or a
 301  8195 28 01        	jr z,sys_print_info_files_skip
 302  8197 0C           	inc c
 303  8198              sys_print_info_files_skip
 304  8198 23           	inc hl
 305  8199 10 F8        	djnz sys_print_info_files_cl
 306  819B
 307  819B 69           	ld l,c
 308  819C 26 00        	ld h,0
 309  819E CD ED 05     	call toDecimal
 310  81A1 11 00 0B     	ld de,#0b00 ;координаты yx
 311  81A4              	OS_SET_XY
 311  81A4 0E 01       >    ld c,#01
 311  81A6 E7          >    rst #20
 312  81A7 21 91 82     	ld hl,msg_files
 313  81AA CD 50 0A     	call drvgmx.printZ
 314  81AD 21 46 06     	ld hl,decimalS+3
 315  81B0 CD 50 0A     	call drvgmx.printZ
 316  81B3
 317  81B3              	;печать информации о памяти и процессах
 318  81B3 CD EA 81     	call get_proc_total ;печать и подсчёт процессов
 319  81B6 6F           	ld l,a
 320  81B7 26 00        	ld h,0
 321  81B9 CD ED 05     	call toDecimal
 322  81BC 11 00 0D     	ld de,#0d00 ;координаты yx
 323  81BF              	OS_SET_XY
 323  81BF 0E 01       >    ld c,#01
 323  81C1 E7          >    rst #20
 324  81C2 21 99 82     	ld hl,msg_processes
 325  81C5 CD 50 0A     	call drvgmx.printZ
 326  81C8 21 46 06     	ld hl,decimalS+3
 327  81CB CD 50 0A     	call drvgmx.printZ
 328  81CE
 329  81CE 11 00 0C     	ld de,#0c00 ;координаты yx
 330  81D1              	OS_SET_XY
 330  81D1 0E 01       >    ld c,#01
 330  81D3 E7          >    rst #20
 331  81D4 21 A5 82     	ld hl,msg_free_ram
 332  81D7 CD 50 0A     	call drvgmx.printZ
 333  81DA CD 57 82     	call get_free_ram ;памяти
 334  81DD 6F           	ld l,a
 335  81DE 26 00        	ld h,0
 336  81E0 CD ED 05     	call toDecimal
 337  81E3 21 45 06     	ld hl,decimalS+2
 338  81E6 CD 50 0A     	call drvgmx.printZ
 339  81E9 C9           	ret
 340  81EA
 341  81EA
 342  81EA
 343  81EA
 344  81EA              get_proc_total
 345  81EA              	;поиск и печать количества запущеных процессов
 346  81EA              	;вых: a - количество активных
 347  81EA 11 00 0E     	ld de,#0e00 ;координаты yx
 348  81ED              	OS_SET_XY
 348  81ED 0E 01       >    ld c,#01
 348  81EF E7          >    rst #20
 349  81F0 DD 21 00 2D  	ld ix,proc_table
 350  81F4 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 351  81F6 0E 00        	ld c,0 ;счётчик
 352  81F8              get_proc_total_cl
 353  81F8 DD 7E 00     	ld a,(ix)
 354  81FB B7           	or a ;свободен?
 355  81FC 28 1F        	jr z,get_proc_total_cl1
 356  81FE
 357  81FE C5           	push bc
 358  81FF C6 30        	add '0' ;печать id
 359  8201              	OS_PRINT_CHARF
 359  8201 D7          >	rst #10
 360  8202 3E 20        	ld a," "
 361  8204              	OS_PRINT_CHARF
 361  8204 D7          >	rst #10
 362  8205 DD 7E 01     	ld a,(ix+1)
 363  8208 C6 30        	add '0' ;печать id родительского
 364  820A              	OS_PRINT_CHARF
 364  820A D7          >	rst #10
 365  820B 3E 20        	ld a," "
 366  820D              	OS_PRINT_CHARF
 366  820D D7          >	rst #10
 367  820E
 368  820E DD E5        	push ix
 369  8210 E1           	pop hl
 370  8211 01 10 00     	ld bc,16
 371  8214 09           	add hl,bc
 372  8215              	OS_PRINTZ ;печать имени
 372  8215 0E 09       >    ld c,#09
 372  8217 E7          >    rst #20
 373  8218
 374  8218 3E 0D        	ld a,13
 375  821A              	OS_PRINT_CHARF
 375  821A D7          >	rst #10
 376  821B
 377  821B C1           	pop bc
 378  821C
 379  821C 0C           	inc c ;прибавить
 380  821D              get_proc_total_cl1
 381  821D DD 24        	inc ixh
 382  821F 10 D7        	djnz get_proc_total_cl
 383  8221 79           	ld a,c
 384  8222 32 45 82     	ld (get_proc_total_count),a
 385  8225
 386  8225              	;почистить пустые строки (надо оптимизировать по времени)
 387  8225 3E 08        	ld a,proc_max
 388  8227 91           	sub c ;сколько пустых стрк должно быть
 389  8228 28 17        	jr z,get_proc_total_ex
 390  822A 47           	ld b,a ;цикл
 391  822B 11 00 0E     	ld de,#0e00 ;координаты yx
 392  822E 79           	ld a,c
 393  822F 82           	add d
 394  8230 57           	ld d,a
 395  8231              get_proc_total_cl2
 396  8231 D5           	push de
 397  8232 C5           	push bc
 398  8233              	OS_SET_XY
 398  8233 0E 01       >    ld c,#01
 398  8235 E7          >    rst #20
 399  8236 21 46 82     	ld hl,get_proc_total_clear
 400  8239              	OS_PRINTZ ;очистить
 400  8239 0E 09       >    ld c,#09
 400  823B E7          >    rst #20
 401  823C C1           	pop bc
 402  823D D1           	pop de
 403  823E 14           	inc d
 404  823F 10 F0        	djnz get_proc_total_cl2
 405  8241
 406  8241              get_proc_total_ex
 407  8241 3A 45 82     	ld a,(get_proc_total_count)
 408  8244 C9           	ret
 409  8245 00           get_proc_total_count db 0 ;временно
 410  8246 20 20 20 20  get_proc_total_clear db "                ",0
 410  824A 20 20 20 20
 410  824E 20 20 20 20
 410  8252 20 20 20 20
 410  8256 00
 411  8257
 412  8257
 413  8257              get_free_ram
 414  8257              	;поиск количества свободных страниц памяти
 415  8257              	;вых: a - количество свободных
 416  8257 21 00 35     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 417  825A 06 6D        	ld b,page_max ;всего страниц
 418  825C 0E 00        	ld c,0 ;счётчик
 419  825E              get_free_ram_cl
 420  825E 7E           	ld a,(hl)
 421  825F B7           	or a ;свободен?
 422  8260 20 01        	jr nz,get_free_ram_cl1
 423  8262 0C           	inc c ;прибавить
 424  8263              get_free_ram_cl1
 425  8263 23           	inc hl
 426  8264 10 F8        	djnz get_free_ram_cl
 427  8266 79           	ld a,c
 428  8267 C9           	ret
 429  8268
 430  8268
 431  8268
 432  8268              print_active ;значёк активности
 433  8268 11 00 0A     	ld de,#0a00 ;координаты yx
 434  826B              	OS_SET_XY
 434  826B 0E 01       >    ld c,#01
 434  826D E7          >    rst #20
 435  826E 21 FA 82     	ld hl,msg_active
 436  8271              	OS_PRINTZ
 436  8271 0E 09       >    ld c,#09
 436  8273 E7          >    rst #20
 437  8274 3A 07 83     	ld a,(msg_active_cur)
 438  8277 3C           	inc a
 439  8278 FE 04        	cp 4
 440  827A 38 01        	jr c,print_active1
 441  827C AF           	xor a
 442  827D              print_active1
 443  827D 32 07 83     	ld (msg_active_cur),a
 444  8280 4F           	ld c,a
 445  8281 06 00        	ld b,0
 446  8283 21 02 83     	ld hl,msg_active1
 447  8286 09           	add hl,bc
 448  8287 7E           	ld a,(hl)
 449  8288              	OS_PRINT_CHARF
 449  8288 D7          >	rst #10
 450  8289 C9           	ret
 451  828A
 452  828A
 453  828A
 454  828A
 455  828A
 456  828A
 457  828A 6E 63 2E 61  proc_name_nc db "nc.apg",0
 457  828E 70 67 00
 458  8291
 459  8291              msg_files
 460  8291 46 69 6C 65  	db "Files: ",0
 460  8295 73 3A 20 00
 461  8299              msg_processes
 462  8299 50 72 6F 63  	db "Processes: ",0
 462  829D 65 73 73 65
 462  82A1 73 3A 20 00
 463  82A5              msg_free_ram
 464  82A5 46 72 65 65  	db "Free pages RAM: ",0
 464  82A9 20 70 61 67
 464  82AD 65 73 20 52
 464  82B1 41 4D 3A 20
 464  82B5 00
 465  82B6              msg_press_num_to_close
 466  82B6 53 53 2B 45  	db "SS+Enter - switch. 2-8 - close process. Ext+0 - Monitor. Ext+9 - NC",0
 466  82BA 6E 74 65 72
 466  82BE 20 2D 20 73
 466  82C2 77 69 74 63
 466  82C6 68 2E 20 32
 466  82CA 2D 38 20 2D
 466  82CE 20 63 6C 6F
 466  82D2 73 65 20 70
 466  82D6 72 6F 63 65
 466  82DA 73 73 2E 20
 466  82DE 45 78 74 2B
 466  82E2 30 20 2D 20
 466  82E6 4D 6F 6E 69
 466  82EA 74 6F 72 2E
 466  82EE 20 45 78 74
 466  82F2 2B 39 20 2D
 466  82F6 20 4E 43 00
 467  82FA 41 63 74 69  msg_active db "Active ",0
 467  82FE 76 65 20 00
 468  8302 7C 2F 2D 5C  msg_active1 db "|/-\\",0
 468  8306 00
 469  8307 00           msg_active_cur db 0 ;текущий значёк активности
 470  8308
 471  8308 00           sys_file_autorun_id_tmp db 0 ;временно
 472  8309 61 75 74 6F  sys_file_autorun_name	db "autorun.txt",0
 472  830D 72 75 6E 2E
 472  8311 74 78 74 00
 473  8315 00 00        sys_file_autorun_lenght dw 0 ;временно
 474  8317 00           sys_file_autorun_focus db 0 ;временно
 475  8318 00 00 00...  sys_file_autorun_name_tmp ds 256
 476  8418
 477  8418
 478  8418              end_sys
 479  8418              	savebin "sys.osg",start_sys,$-start_sys
 480  8418              ;------------------------------------------------------------------------
 481  8418
 482  8418
 483  8418
 484  8418
 485  8418
 486  8418
 487  8418
 488  8418
 489  8418
 490  8418
 491  8418
 492  8418
 493  8418
 494  8418
 495  8418
 496  8418
 497  8418
 498  8418
 499  8418
 500  8418
 501  8418
 502  8418
 503  8418
 504  8418
 505  8418
 506  8418              ;sys - сетевой процесс для OS
 507  8418              	org PROG_START
 508  8000              start_net
 509  8000
 510  8000 21 1B 85     	ld hl,msg_ver_net
 511  8003              	;печать приветствия
 512  8003 CD 50 0A     	call drvgmx.printZ
 513  8006
 514  8006              ;uart #EF (wifi)
 515  8006 AF           	xor a
 516  8007 32 02 2C     	ld (uart_enable),a ;флаг порт отсутствует
 517  800A              	; ld a,1
 518  800A              	; ld (esp_link_id_table),a ;временно занять порт
 519  800A CD CA 81     	call Uart.check
 520  800D FE FF        	cp 255
 521  800F              	;jr z,init_uart_no ;отключить проверку можно тут
 522  800F              	;нашли uart
 523  800F 3E 01        	ld a,1
 524  8011 32 02 2C     	ld (uart_enable),a ;порт есть
 525  8014 21 C8 35     	ld hl,msg_init_uart_found
 526  8017 CD 50 0A     	call drvgmx.printZ
 527  801A CD 3B 82     	call Wifi.init
 528  801D 18 06        	jr init_uart_yes
 529  801F              init_uart_no
 530  801F              	;печать
 531  801F 21 D9 35     	ld hl,msg_init_uart_not_found
 532  8022 CD 50 0A     	call drvgmx.printZ
 533  8025              init_uart_yes
 534  8025
 535  8025
 536  8025              net_loop
 537  8025              	OS_WAIT
 537  8025 DF          >	rst #18
 538  8026 CD 9A 81     	call print_active_net ;индикатор
 539  8029 CD 3C 80     	call esp_check_open ;проверить соединения
 540  802C CD A2 80     	call esp_check_send ;проверить пакеты на отправку
 541  802F CD C5 80     	call esp_check_get ;проверить пакеты на приём
 542  8032 3A 24 2C     	ld a,(sys_timer) ;иногда печатаем сетевую информацию
 543  8035 E6 0E        	and %00001110
 544  8037 CC 1C 81     	call z,print_esp_link
 545  803A
 546  803A 18 E9        	jr net_loop
 547  803C
 548  803C
 549  803C              esp_check_open ;проверка очереди соединений ESP
 550  803C DD 21 80 35  	ld ix,esp_link_id_table ;
 551  8040              	;push bc
 552  8040 DD 7E 01     	ld a,(ix+1)
 553  8043 B7           	or a ;запрос есть?
 554  8044 C8           	ret z
 555  8045              	;есть запрос
 556  8045
 557  8045 DD 7E 0E     	ld a,(ix+14) ;подставить тип соединения
 558  8048 B7           	or a
 559  8049 20 11        	jr nz,esp_check_open_type1
 560  804B 3E 54        	ld a,'T'
 561  804D 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 562  8050 3E 43        	ld a,'C'
 563  8052 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 564  8055 3E 50        	ld a,'P'
 565  8057 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 566  805A 18 2A        	jr esp_check_open_type_skip
 567  805C              esp_check_open_type1
 568  805C FE 01        	cp 1
 569  805E 20 11        	jr nz,esp_check_open_type2
 570  8060 3E 55        	ld a,'U'
 571  8062 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 572  8065 3E 44        	ld a,'D'
 573  8067 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 574  806A 3E 50        	ld a,'P'
 575  806C 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 576  806F 18 15        	jr esp_check_open_type_skip
 577  8071              esp_check_open_type2
 578  8071 FE 02        	cp 2
 579  8073 20 11        	jr nz,esp_check_open_type_skip
 580  8075 3E 53        	ld a,'S'
 581  8077 32 B9 84     	ld (Wifi.cmd_CIPSTART2+0),a
 582  807A 3E 53        	ld a,'S'
 583  807C 32 BA 84     	ld (Wifi.cmd_CIPSTART2+1),a
 584  807F 3E 4C        	ld a,'L'
 585  8081 32 BB 84     	ld (Wifi.cmd_CIPSTART2+2),a
 586  8084 18 00        	jr esp_check_open_type_skip
 587  8086
 588  8086              esp_check_open_type_skip
 589  8086 11 BB 35     	ld de,esp_link_id_table+59 ;номер порта
 590  8089 21 8F 35     	ld hl,esp_link_id_table+15 ;;адрес сервера
 591  808C CD DD 82     	call Wifi.openTCP
 592  808F 30 04        	jr nc,esp_check_open_res
 593  8091 3E FF        	ld a,255 ;ошибка
 594  8093 18 05        	jr esp_check_open_err
 595  8095              esp_check_open_res
 596  8095              	;результат запишем
 597  8095 3A 3A 82     	ld a,(Wifi.closed)
 598  8098 EE 01        	xor 1
 599  809A              esp_check_open_err
 600  809A DD 77 02     	ld (ix+2),a ;поставить флаг результата открытия
 601  809D DD 36 01 00  	ld (ix+1),0 ;сбросить флаг запроса
 602  80A1 C9           	ret
 603  80A2
 604  80A2
 605  80A2
 606  80A2
 607  80A2
 608  80A2              esp_check_send ;проверить пакеты на отправку
 609  80A2 DD 21 80 35  	ld ix,esp_link_id_table ;
 610  80A6 DD 7E 03     	ld a,(ix+3)
 611  80A9 B7           	or a ;запрос есть?
 612  80AA C8           	ret z
 613  80AB              	;есть запрос
 614  80AB DD 5E 09     	ld e,(ix+9) ;длина данных
 615  80AE DD 56 0A     	ld d,(ix+10)
 616  80B1 21 2D 36     	ld hl,esp_buffer ;адрес
 617  80B4 CD 9E 83     	call Wifi.tcpSend
 618  80B7 3E 01        	ld a,1 ;успех
 619  80B9 30 02        	jr nc,esp_check_send_res
 620  80BB 3E FF        	ld a,255 ;ошибка
 621  80BD              esp_check_send_res
 622  80BD DD 77 04     	ld (ix+4),a ;поставить флаг результата отправки
 623  80C0 DD 36 03 00  	ld (ix+3),0 ;сбросить флаг запроса
 624  80C4 C9           	ret
 625  80C5
 626  80C5
 627  80C5
 628  80C5
 629  80C5
 630  80C5              esp_check_get ;проверить пакеты на приём
 631  80C5 DD 21 80 35  	ld ix,esp_link_id_table ;
 632  80C9 DD 7E 05     	ld a,(ix+5)
 633  80CC B7           	or a ;запрос есть?
 634  80CD C8           	ret z
 635  80CE              	;есть запрос
 636  80CE 21 00 00     	ld hl,0
 637  80D1 22 36 82     	ld (Wifi.bytes_avail), hl ;длину сбросим
 638  80D4 21 2D 36     	ld hl,esp_buffer ;адрес
 639  80D7 22 38 82     	ld (Wifi.buffer_pointer),hl ;
 640  80DA CD E0 83     	call Wifi.getPacket
 641  80DD 30 0A        	jr nc,esp_check_get_res
 642  80DF 3E FF        	ld a,255 ;ошибка
 643  80E1 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 644  80E4 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 645  80E8 C9           	ret
 646  80E9              esp_check_get_res
 647  80E9              	;если что-то принято
 648  80E9 ED 4B 36 82  	ld bc,(Wifi.bytes_avail) ;длина
 649  80ED DD 71 09     	ld (ix+9),c ;длина принятых
 650  80F0 DD 70 0A     	ld (ix+10),b
 651  80F3
 652  80F3 78           	ld a,b
 653  80F4 B1           	or c
 654  80F5 28 0F        	jr z,esp_check_get_skip_copy2 ;защита от нулевой длины
 655  80F7
 656  80F7 DD 5E 07     	ld e,(ix+7) ;адрес назначения
 657  80FA DD 56 08     	ld d,(ix+8)
 658  80FD DD 7E 00     	ld a,(ix) ;id назначения
 659  8100 21 2D 36     	ld hl,esp_buffer ;откуда
 660  8103 CD C4 05     	call esp_buffer_copy ;перекинем данные силами ядра
 661  8106
 662  8106              esp_check_get_skip_copy2
 663  8106 DD 21 80 35  	ld ix,esp_link_id_table ;
 664  810A 3A 3A 82     	ld a,(Wifi.closed)
 665  810D EE 01        	xor 1
 666  810F DD 77 02     	ld (ix+2),a ;поставить текущий флаг открытия
 667  8112 3E 01        	ld a,1 ;успех
 668  8114 DD 77 06     	ld (ix+6),a ;поставить флаг результата приёма
 669  8117 DD 36 05 00  	ld (ix+5),0 ;сбросить флаг запроса
 670  811B C9           	ret
 671  811C
 672  811C
 673  811C              print_esp_link
 674  811C 26 0B        	ld h,#0b
 675  811E 3E 20        	ld a," "
 676  8120              	OS_FILL_LINE ;почистить строку
 676  8120 0E 03       >    ld c,#03
 676  8122 E7          >    rst #20
 677  8123 DD 21 80 35  	ld ix,esp_link_id_table
 678  8127
 679  8127 11 00 0B     	ld de,#0b00 ;координаты yx
 680  812A              	OS_SET_XY
 680  812A 0E 01       >    ld c,#01
 680  812C E7          >    rst #20
 681  812D 21 00 85     	ld hl,msg_esp_link
 682  8130              	OS_PRINTZ
 682  8130 0E 09       >    ld c,#09
 682  8132 E7          >    rst #20
 683  8133 DD 7E 00     	ld a,(ix)
 684  8136 C6 30        	add '0'
 685  8138              	OS_PRINT_CHARF ;id
 685  8138 D7          >	rst #10
 686  8139 3E 20        	ld a," "
 687  813B              	OS_PRINT_CHARF
 687  813B D7          >	rst #10
 688  813C
 689  813C DD 7E 00     	ld a,(ix)
 690  813F B7           	or a
 691  8140 C8           	ret z ;если нет соединений
 692  8141
 693  8141 21 09 85     	ld hl,msg_esp_transmit
 694  8144              	OS_PRINTZ
 694  8144 0E 09       >    ld c,#09
 694  8146 E7          >    rst #20
 695  8147 DD 7E 04     	ld a,(ix+4)
 696  814A B7           	or a
 697  814B 28 1C        	jr z,print_esp_link2
 698  814D DD 7E 05     	ld a,(ix+5) ;при этом не начался приём
 699  8150 4F           	ld c,a
 700  8151 DD 7E 06     	ld a,(ix+6)
 701  8154 B1           	or c
 702  8155 20 12        	jr nz,print_esp_link2
 703  8157 DD 6E 09     	ld l,(ix+9)
 704  815A DD 66 0A     	ld h,(ix+10)
 705  815D CD ED 05     	call toDecimal
 706  8160 21 43 06     	ld hl,decimalS
 707  8163              	OS_PRINTZ	;отправлено
 707  8163 0E 09       >    ld c,#09
 707  8165 E7          >    rst #20
 708  8166 3E 20        	ld a," "
 709  8168              	OS_PRINT_CHARF
 709  8168 D7          >	rst #10
 710  8169              print_esp_link2
 711  8169
 712  8169 21 0F 85     	ld hl,msg_esp_receive
 713  816C              	OS_PRINTZ
 713  816C 0E 09       >    ld c,#09
 713  816E E7          >    rst #20
 714  816F DD 7E 06     	ld a,(ix+6)
 715  8172 B7           	or a
 716  8173 28 12        	jr z,print_esp_link3
 717  8175 DD 6E 09     	ld l,(ix+9)
 718  8178 DD 66 0A     	ld h,(ix+10)
 719  817B CD ED 05     	call toDecimal
 720  817E 21 43 06     	ld hl,decimalS
 721  8181              	OS_PRINTZ	;принято
 721  8181 0E 09       >    ld c,#09
 721  8183 E7          >    rst #20
 722  8184 3E 20        	ld a," "
 723  8186              	OS_PRINT_CHARF
 723  8186 D7          >	rst #10
 724  8187              print_esp_link3
 725  8187
 726  8187 21 15 85     	ld hl,msg_esp_address
 727  818A              	OS_PRINTZ
 727  818A 0E 09       >    ld c,#09
 727  818C E7          >    rst #20
 728  818D DD 7E 02     	ld a,(ix+2) ;соединение установлено
 729  8190 B7           	or a
 730  8191 28 06        	jr z,print_esp_link4
 731  8193 21 8F 35     	ld hl,esp_link_id_table+15 ;сервер
 732  8196              	OS_PRINTZ
 732  8196 0E 09       >    ld c,#09
 732  8198 E7          >    rst #20
 733  8199              print_esp_link4
 734  8199 C9           	ret
 735  819A
 736  819A
 737  819A
 738  819A
 739  819A              print_active_net ;значёк активности
 740  819A 11 00 0A     	ld de,#0a00 ;координаты yx
 741  819D              	OS_SET_XY
 741  819D 0E 01       >    ld c,#01
 741  819F E7          >    rst #20
 742  81A0 21 BC 81     	ld hl,msg_active_net
 743  81A3              	OS_PRINTZ
 743  81A3 0E 09       >    ld c,#09
 743  81A5 E7          >    rst #20
 744  81A6 3A C9 81     	ld a,(msg_active_net_cur)
 745  81A9 3C           	inc a
 746  81AA FE 04        	cp 4
 747  81AC 38 01        	jr c,print_active_net1
 748  81AE AF           	xor a
 749  81AF              print_active_net1
 750  81AF 32 C9 81     	ld (msg_active_net_cur),a
 751  81B2 4F           	ld c,a
 752  81B3 06 00        	ld b,0
 753  81B5 21 C4 81     	ld hl,msg_active_net1
 754  81B8 09           	add hl,bc
 755  81B9 7E           	ld a,(hl)
 756  81BA              	OS_PRINT_CHARF
 756  81BA D7          >	rst #10
 757  81BB C9           	ret
 758  81BC
 759  81BC
 760  81BC
 761  81BC
 762  81BC
 763  81BC
 764  81BC 41 63 74 69  msg_active_net db "Active ",0
 764  81C0 76 65 20 00
 765  81C4 7C 2F 2D 5C  msg_active_net1 db "|/-\\",0
 765  81C8 00
 766  81C9 00           msg_active_net_cur db 0 ;текущий значёк активности
 767  81CA
 768  81CA              	include Drv/zx-wifi.asm ;драйвер сетевой карты ESP
# file opened: Drv/zx-wifi.asm
   1+ 81CA              ; This driver works with 16c550 uart that's support AFE
   2+ 81CA                  module Uart
   3+ 81CA              ; Make init shorter and readable:-)
   4+ 81CA                  macro outp port, value
   5+ 81CA ~            	ld b, port
   6+ 81CA ~            	ld c, #EF
   7+ 81CA ~                ld a, value
   8+ 81CA ~                out (c), a
   9+ 81CA                  endm
  10+ 81CA
  11+ 81CA              ; Internal port constants
  12+ 81CA              RBR_THR = #F8
  13+ 81CA              IER     = RBR_THR + 1
  14+ 81CA              IIR_FCR = RBR_THR + 2
  15+ 81CA              LCR     = RBR_THR + 3
  16+ 81CA              MCR     = RBR_THR + 4
  17+ 81CA              LSR     = RBR_THR + 5
  18+ 81CA              MSR     = RBR_THR + 6
  19+ 81CA              SR      = RBR_THR + 7
  20+ 81CA
  21+ 81CA
  22+ 81CA              ;out: a=255 - no UART
  23+ 81CA              check: ;проверка есть ли карта
  24+ 81CA 3E F8        	ld a, RBR_THR
  25+ 81CC DB FE            in a, (#fe)
  26+ 81CE FE FF        	cp #ff
  27+ 81D0 C0           	ret nz ;если читает 255, то нет карты
  28+ 81D1 3E F8        	ld a, RBR_THR
  29+ 81D3 DB FE            in a, (#fe) ;второй раз для надёжности
  30+ 81D5 FE FF        	cp #ff
  31+ 81D7 C9           	ret
  32+ 81D8
  33+ 81D8
  34+ 81D8              init:
  35+ 81D8                  outp MCR,     #0d  // Assert RTS
  35+ 81D8 06 FC       >	ld b, MCR
  35+ 81DA 0E EF       >	ld c, #EF
  35+ 81DC 3E 0D       >    ld a, #0d
  35+ 81DE ED 79       >    out (c), a
  36+ 81E0                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  36+ 81E0 06 FA       >	ld b, IIR_FCR
  36+ 81E2 0E EF       >	ld c, #EF
  36+ 81E4 3E 87       >    ld a, #87
  36+ 81E6 ED 79       >    out (c), a
  37+ 81E8                  outp LCR,     #83  // 8n1, DLAB=1
  37+ 81E8 06 FB       >	ld b, LCR
  37+ 81EA 0E EF       >	ld c, #EF
  37+ 81EC 3E 83       >    ld a, #83
  37+ 81EE ED 79       >    out (c), a
  38+ 81F0                  outp RBR_THR, #01  // 115200 (divider 1)
  38+ 81F0 06 F8       >	ld b, RBR_THR
  38+ 81F2 0E EF       >	ld c, #EF
  38+ 81F4 3E 01       >    ld a, #01
  38+ 81F6 ED 79       >    out (c), a
  39+ 81F8                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  39+ 81F8 06 F9       >	ld b, IER
  39+ 81FA 0E EF       >	ld c, #EF
  39+ 81FC 3E 00       >    ld a, #00
  39+ 81FE ED 79       >    out (c), a
  40+ 8200
  41+ 8200                  outp LCR,     #03 // 8n1, DLAB=0
  41+ 8200 06 FB       >	ld b, LCR
  41+ 8202 0E EF       >	ld c, #EF
  41+ 8204 3E 03       >    ld a, #03
  41+ 8206 ED 79       >    out (c), a
  42+ 8208                  outp IER,     #00 // Disable int
  42+ 8208 06 F9       >	ld b, IER
  42+ 820A 0E EF       >	ld c, #EF
  42+ 820C 3E 00       >    ld a, #00
  42+ 820E ED 79       >    out (c), a
  43+ 8210                  outp MCR,     #2f // Enable AFE
  43+ 8210 06 FC       >	ld b, MCR
  43+ 8212 0E EF       >	ld c, #EF
  43+ 8214 3E 2F       >    ld a, #2f
  43+ 8216 ED 79       >    out (c), a
  44+ 8218 C9               ret
  45+ 8219
  46+ 8219              ;retry_rec_count_max equ %00011111 ;ждать столько прерываний
  47+ 8219
  48+ 8219              ; Flag C <- Data available
  49+ 8219              ; isAvailable:
  50+ 8219                  ; ld a, LSR
  51+ 8219                  ; in a, (#EF)
  52+ 8219                  ; rrca
  53+ 8219                  ; ret
  54+ 8219
  55+ 8219              ; Non-blocking read
  56+ 8219              ; Flag C <- is byte was readen
  57+ 8219              ; A <- byte
  58+ 8219              ; read1:
  59+ 8219                  ; ld a, LSR
  60+ 8219                  ; in a, (#EF)
  61+ 8219                  ; rrca
  62+ 8219                  ; ret nc
  63+ 8219                  ; ld a, RBR_THR
  64+ 8219                  ; in a, (#EF)
  65+ 8219                  ; scf
  66+ 8219                  ; ret
  67+ 8219
  68+ 8219              ; Tries read byte with timeout
  69+ 8219              ; Flag C <- is byte read
  70+ 8219              ; A <- byte
  71+ 8219              read:
  72+ 8219              	;xor a ;4
  73+ 8219              	;ld (#5C78),a ;обнулить счётчик ожидания ;13
  74+ 8219              .wait
  75+ 8219 3E FD            ld a, LSR
  76+ 821B DB EF            in a, (#EF)
  77+ 821D 0F               rrca
  78+ 821E 30 F9        	jr nc, .wait
  79+ 8220 3E F8            ld a, RBR_THR
  80+ 8222 DB EF            in a, (#EF)
  81+ 8224 C9           	ret
  82+ 8225              ; .readW
  83+ 8225              	; OS_GETTIMER
  84+ 8225              	; ld a,e
  85+ 8225              	; and retry_rec_count_max
  86+ 8225              	; ;ld a,(#5C78)
  87+ 8225              	; ;cp retry_rec_count_max
  88+ 8225              	; jr nz, .wait ;ещё попытка
  89+ 8225              	; xor a ;выключим флаг переноса если время вышло
  90+ 8225              	; ret
  91+ 8225
  92+ 8225
  93+ 8225
  94+ 8225
  95+ 8225              ; Blocking read
  96+ 8225              ; A <- Byte
  97+ 8225              ; readB:
  98+ 8225                  ; ld a, LSR
  99+ 8225                  ; in a, (#EF)
 100+ 8225                  ; rrca
 101+ 8225                  ; jr nc, readB
 102+ 8225              	; ld a, RBR_THR
 103+ 8225                  ; in a, (#EF)
 104+ 8225                  ; ret
 105+ 8225
 106+ 8225              ; A -> byte to send
 107+ 8225              write:
 108+ 8225 F5               push af
 109+ 8226              .wait
 110+ 8226 3E FD        	ld a, LSR
 111+ 8228 DB EF            in a, (#EF)
 112+ 822A E6 20            and #20
 113+ 822C 28 F8            jr z, .wait
 114+ 822E F1               pop af
 115+ 822F 06 F8        	ld b, RBR_THR
 116+ 8231 0E EF        	ld c, #EF
 117+ 8233 ED 79            out (c), a
 118+ 8235 C9               ret
 119+ 8236
 120+ 8236                  endmodule
# file closed: Drv/zx-wifi.asm
 769  8236              	include Drv/wifi.asm ;работа с ESP
# file opened: Drv/wifi.asm
   1+ 8236                  MODULE Wifi
   2+ 8236 00 00        bytes_avail dw 0 ;байт для приёма
   3+ 8238 00 00        buffer_pointer dw 0 ;указатель на адрес буфера
   4+ 823A 01           closed db 1 ;флаг "соединение закрыто"
   5+ 823B              ;link_id db 0 ;текущий id соединения
   6+ 823B              buffer_end equ #40 ;ограничение буфера адрес #4000
   7+ 823B
   8+ 823B              ; Initialize Wifi chip to work
   9+ 823B              init:
  10+ 823B 21 B4 82         ld hl, .uartIniting
  10+ 823E CD 50 0A       call drvgmx.printZ
  11+ 8241 CD D8 81         call Uart.init ;
  12+ 8244 21 C5 82         ld hl, .chipIniting
  12+ 8247 CD 50 0A       call drvgmx.printZ
  13+ 824A                  ;EspCmdOkErr "ATE0"
  14+ 824A 21 94 84     	ld hl,cmd_ATE0
  15+ 824D CD 83 83     	call espSendZ
  16+ 8250 CD 1C 83     	call checkOkErr
  17+ 8253 38 3F            jr c, .initError
  18+ 8255
  19+ 8255                  ;EspCmdOkErr "AT+CIPSERVER=0"
  20+ 8255 21 9B 84     	ld hl,cmd_CIPSERVER
  21+ 8258 CD 83 83     	call espSendZ
  22+ 825B CD 1C 83     	call checkOkErr
  23+ 825E                  ;jr c, .initError ;не проверяем ошибку
  24+ 825E                  ;EspCmdOkErr "AT+CIPCLOSE" ;  Close if there some connection was. Don't care about result
  25+ 825E 21 CC 84     	ld hl,cmd_CIPCLOSE
  26+ 8261 CD 83 83     	call espSendZ
  27+ 8264 3E 35        	ld a,'5' ;закрыть все соединения
  28+ 8266 CD 25 82     	call Uart.write
  29+ 8269 3E 0D            ld a, 13
  29+ 826B CD 25 82       call Uart.write
  30+ 826E 3E 0A            ld a, 10
  30+ 8270 CD 25 82       call Uart.write
  31+ 8273 CD 1C 83     	call checkOkErr
  32+ 8276                  ;jr c, .initError ;не проверяем ошибку
  33+ 8276                  ;EspCmdOkErr "AT+CIPMUX=0" ; Single connection mode
  34+ 8276 21 D8 84     	ld hl,cmd_CIPMUX
  35+ 8279 CD 83 83     	call espSendZ
  36+ 827C CD 1C 83     	call checkOkErr
  37+ 827F 38 13            jr c, .initError
  38+ 8281
  39+ 8281                  ;EspCmdOkErr "AT+CIPDINFO=0" ; Disable additional info
  40+ 8281 21 E6 84     	ld hl,cmd_CIPDINFO
  41+ 8284 CD 83 83     	call espSendZ
  42+ 8287 CD 1C 83     	call checkOkErr
  43+ 828A 38 08            jr c, .initError
  44+ 828C
  45+ 828C 21 D6 82         ld hl, .doneInit
  45+ 828F CD 50 0A       call drvgmx.printZ
  46+ 8292
  47+ 8292 B7               or a
  48+ 8293 C9               ret
  49+ 8294              .initError
  50+ 8294 21 9C 82         ld hl, .errMsg
  50+ 8297 CD 50 0A       call drvgmx.printZ
  51+ 829A 37               scf
  52+ 829B C9               ret
  53+ 829C 57 69 46 69  .errMsg db "WiFi chip init failed!",13,0
  53+ 82A0 20 63 68 69
  53+ 82A4 70 20 69 6E
  53+ 82A8 69 74 20 66
  53+ 82AC 61 69 6C 65
  53+ 82B0 64 21 0D 00
  54+ 82B4 55 61 72 74  .uartIniting db "Uart initing...",13,0
  54+ 82B8 20 69 6E 69
  54+ 82BC 74 69 6E 67
  54+ 82C0 2E 2E 2E 0D
  54+ 82C4 00
  55+ 82C5 43 68 69 70  .chipIniting db "Chip initing...",13,0
  55+ 82C9 20 69 6E 69
  55+ 82CD 74 69 6E 67
  55+ 82D1 2E 2E 2E 0D
  55+ 82D5 00
  56+ 82D6 44 6F 6E 65  .doneInit    db "Done!",13,0
  56+ 82DA 21 0D 00
  57+ 82DD                  IFNDEF PROXY
  58+ 82DD              ; HL - host pointer in gopher row
  59+ 82DD              ; DE - port pointer in gopher row
  60+ 82DD              openTCP:
  61+ 82DD D5               push de
  62+ 82DE E5               push hl
  63+ 82DF                  ;EspCmdOkErr "AT+CIPCLOSE" ; Don't care about result. Just close if it didn't happens before
  64+ 82DF 21 CC 84     	ld hl,cmd_CIPCLOSE
  65+ 82E2 CD 83 83     	call espSendZ
  66+ 82E5              	; ld a,(link_id)
  67+ 82E5              	; call Uart.write
  68+ 82E5 3E 0D            ld a, 13
  68+ 82E7 CD 25 82       call Uart.write
  69+ 82EA 3E 0A            ld a, 10
  69+ 82EC CD 25 82       call Uart.write
  70+ 82EF CD 1C 83     	call checkOkErr
  71+ 82F2
  72+ 82F2                  ;EspSend 'AT+CIPSTART,"TCP","' ;
  73+ 82F2 21 AC 84     	ld hl,cmd_CIPSTART
  74+ 82F5 CD 83 83     	call espSendZ
  75+ 82F8              	; ld a,(link_id)
  76+ 82F8              	; call Uart.write
  77+ 82F8              	; ld hl,cmd_CIPSTART2
  78+ 82F8              	; call espSendZ
  79+ 82F8
  80+ 82F8
  81+ 82F8 E1               pop hl
  82+ 82F9 CD 8C 83         call espSendT
  83+ 82FC                  ;EspSend '",'
  84+ 82FC 3E 22            ld a, '"'
  84+ 82FE CD 25 82       call Uart.write
  85+ 8301 3E 2C            ld a, ','
  85+ 8303 CD 25 82       call Uart.write
  86+ 8306 E1               pop hl
  87+ 8307 CD 8C 83         call espSendT
  88+ 830A 3E 0D            ld a, 13
  88+ 830C CD 25 82       call Uart.write
  89+ 830F 3E 0A            ld a, 10
  89+ 8311 CD 25 82       call Uart.write
  90+ 8314 AF               xor a
  90+ 8315 32 3A 82       ld (closed), a
  91+ 8318 C3 1C 83         jp checkOkErr
  92+ 831B
  93+ 831B              continue:
  94+ 831B C9               ret
  95+ 831C                  ENDIF
  96+ 831C
  97+ 831C
  98+ 831C
  99+ 831C              checkOkErr:
 100+ 831C CD 19 82         call Uart.read
 101+ 831F FE 4F            cp 'O'
 101+ 8321 28 0A          jr z, .okStart ; OK
 102+ 8323 FE 45            cp 'E'
 102+ 8325 28 19          jr z, .errStart ; ERROR
 103+ 8327 FE 46            cp 'F'
 103+ 8329 28 36          jr z, .failStart ; FAIL
 104+ 832B 18 EF            jr checkOkErr
 105+ 832D              .okStart
 106+ 832D CD 19 82         call Uart.read
 106+ 8330 FE 4B          cp 'K'
 106+ 8332 20 E8          jr nz, checkOkErr
 107+ 8334 CD 19 82         call Uart.read
 107+ 8337 FE 0D          cp 13
 107+ 8339 20 E1          jr nz, checkOkErr
 108+ 833B CD 7B 83         call .flushToLF
 109+ 833E B7               or a
 110+ 833F C9               ret
 111+ 8340              .errStart
 112+ 8340 CD 19 82         call Uart.read
 112+ 8343 FE 52          cp 'R'
 112+ 8345 20 D5          jr nz, checkOkErr
 113+ 8347 CD 19 82         call Uart.read
 113+ 834A FE 52          cp 'R'
 113+ 834C 20 CE          jr nz, checkOkErr
 114+ 834E CD 19 82         call Uart.read
 114+ 8351 FE 4F          cp 'O'
 114+ 8353 20 C7          jr nz, checkOkErr
 115+ 8355 CD 19 82         call Uart.read
 115+ 8358 FE 52          cp 'R'
 115+ 835A 20 C0          jr nz, checkOkErr
 116+ 835C CD 7B 83         call .flushToLF
 117+ 835F 37               scf
 118+ 8360 C9               ret
 119+ 8361              .failStart
 120+ 8361 CD 19 82         call Uart.read
 120+ 8364 FE 41          cp 'A'
 120+ 8366 20 B4          jr nz, checkOkErr
 121+ 8368 CD 19 82         call Uart.read
 121+ 836B FE 49          cp 'I'
 121+ 836D 20 AD          jr nz, checkOkErr
 122+ 836F CD 19 82         call Uart.read
 122+ 8372 FE 4C          cp 'L'
 122+ 8374 20 A6          jr nz, checkOkErr
 123+ 8376 CD 7B 83         call .flushToLF
 124+ 8379 37               scf
 125+ 837A C9               ret
 126+ 837B              .flushToLF
 127+ 837B CD 19 82         call Uart.read
 128+ 837E FE 0A            cp 10
 128+ 8380 20 F9          jr nz, .flushToLF
 129+ 8382 C9               ret
 130+ 8383
 131+ 8383              ; Send buffer to UART
 132+ 8383              ; HL - buff
 133+ 8383              ; E - count
 134+ 8383              ; espSend:
 135+ 8383                  ; ld a, (hl) : call Uart.write
 136+ 8383                  ; inc hl
 137+ 8383                  ; dec e
 138+ 8383                  ; jr nz, espSend
 139+ 8383                  ; ret
 140+ 8383
 141+ 8383              ; Send buffer to UART
 142+ 8383              ; HL - buff (0 - end!)
 143+ 8383              espSendZ:
 144+ 8383 7E               ld a, (hl)
 145+ 8384 B7           	or a
 146+ 8385 C8           	ret z
 147+ 8386 CD 25 82     	call Uart.write
 148+ 8389 23               inc hl
 149+ 838A 18 F7            jr espSendZ
 150+ 838C
 151+ 838C
 152+ 838C              ; HL - string that ends with one of the terminator(CR/LF/TAB/NULL)
 153+ 838C              espSendT:
 154+ 838C 7E               ld a, (hl)
 155+ 838D
 156+ 838D A7               and a
 156+ 838E C8             ret z
 157+ 838F FE 09            cp 9
 157+ 8391 C8             ret z
 158+ 8392 FE 0D            cp 13
 158+ 8394 C8             ret z
 159+ 8395 FE 0A            cp 10
 159+ 8397 C8             ret z
 160+ 8398
 161+ 8398 CD 25 82         call Uart.write
 162+ 839B 23               inc hl
 163+ 839C 18 EE            jr espSendT
 164+ 839E
 165+ 839E              ; HL - stringZ to send
 166+ 839E              ; Adds CR LF
 167+ 839E              ; tcpSendZ:
 168+ 839E                  ; push hl
 169+ 839E                  ; ;EspSend "AT+CIPSEND=" ;
 170+ 839E              	; ld hl,cmd_CIPSEND
 171+ 839E              	; call espSendZ
 172+ 839E              	; ; ld a,(link_id)
 173+ 839E              	; ; call Uart.write
 174+ 839E                  ; ;ld a, ',' : call Uart.write
 175+ 839E
 176+ 839E                  ; pop de : push de
 177+ 839E                  ; call strLen
 178+ 839E                  ; inc hl : inc hl ; +CRLF
 179+ 839E                  ; call hlToNumEsp
 180+ 839E                  ; ld a, 13 : call Uart.write
 181+ 839E                  ; ld a, 10 : call Uart.write
 182+ 839E                  ; call checkOkErr : jr c,.exit_err
 183+ 839E              ; .wait
 184+ 839E                  ; call Uart.read : cp '>' : jr nz, .wait
 185+ 839E                  ; pop hl
 186+ 839E              ; .loop
 187+ 839E                  ; ld a, (hl) : and a : jr z, .exit
 188+ 839E                  ; call Uart.write
 189+ 839E                  ; inc hl
 190+ 839E                  ; jp .loop
 191+ 839E              ; .exit
 192+ 839E                  ; ld a, 13 : call Uart.write
 193+ 839E                  ; ld a, 10 : call Uart.write
 194+ 839E                  ; jp checkOkErr
 195+ 839E              ; .exit_err
 196+ 839E              	; pop hl
 197+ 839E              	; ret
 198+ 839E
 199+ 839E
 200+ 839E
 201+ 839E              ; HL - string to send
 202+ 839E              ; DE - lenght
 203+ 839E              ; Adds CR LF
 204+ 839E              tcpSend:
 205+ 839E E5               push hl
 206+ 839F D5           	push de ;
 207+ 83A0                  ;EspSend "AT+CIPSEND=" ;
 208+ 83A0 21 C0 84     	ld hl,cmd_CIPSEND
 209+ 83A3 CD 83 83     	call espSendZ
 210+ 83A6              	; ld a,(link_id)
 211+ 83A6              	; call Uart.write
 212+ 83A6                  ;ld a, ',' : call Uart.write
 213+ 83A6
 214+ 83A6 E1               pop hl
 214+ 83A7 E5             push hl ;длина
 215+ 83A8                  ;call strLen
 216+ 83A8 23               inc hl
 216+ 83A9 23             inc hl ; +CRLF
 217+ 83AA CD 6D 84         call hlToNumEsp
 218+ 83AD 3E 0D            ld a, 13
 218+ 83AF CD 25 82       call Uart.write
 219+ 83B2 3E 0A            ld a, 10
 219+ 83B4 CD 25 82       call Uart.write
 220+ 83B7 CD 1C 83         call checkOkErr
 220+ 83BA 38 21          jr c,.exit_err2
 221+ 83BC              .wait2
 222+ 83BC CD 19 82         call Uart.read
 222+ 83BF FE 3E          cp '>'
 222+ 83C1 20 F9          jr nz, .wait2
 223+ 83C3 D1           	pop de ;длина
 224+ 83C4 E1               pop hl
 225+ 83C5              .loop2
 226+ 83C5 7E               ld a, (hl)
 227+ 83C6 CD 25 82         call Uart.write
 228+ 83C9 23               inc hl
 229+ 83CA 1B           	dec de
 230+ 83CB 7A           	ld a,d
 231+ 83CC B3           	or e
 232+ 83CD C2 C5 83         jp nz, .loop2
 233+ 83D0              .exit2
 234+ 83D0 3E 0D            ld a, 13
 234+ 83D2 CD 25 82       call Uart.write
 235+ 83D5 3E 0A            ld a, 10
 235+ 83D7 CD 25 82       call Uart.write
 236+ 83DA C3 1C 83         jp checkOkErr
 237+ 83DD              .exit_err2
 238+ 83DD D1           	pop de
 239+ 83DE E1           	pop hl
 240+ 83DF C9           	ret
 241+ 83E0
 242+ 83E0
 243+ 83E0
 244+ 83E0
 245+ 83E0              getPacket:
 246+ 83E0 CD 19 82         call Uart.read
 247+ 83E3 FE 2B            cp '+'
 247+ 83E5 28 28          jr z, .ipdBegun    ; "+IPD," packet
 248+ 83E7 FE 4F            cp 'O'
 248+ 83E9 28 02          jr z, .closedBegun ; It enough to check "OSED\n" :-)
 249+ 83EB 18 F3            jr getPacket
 250+ 83ED              .closedBegun
 251+ 83ED CD 19 82         call Uart.read
 251+ 83F0 FE 53          cp 'S'
 251+ 83F2 20 EC          jr nz, getPacket
 252+ 83F4 CD 19 82         call Uart.read
 252+ 83F7 FE 45          cp 'E'
 252+ 83F9 20 E5          jr nz, getPacket
 253+ 83FB CD 19 82         call Uart.read
 253+ 83FE FE 44          cp 'D'
 253+ 8400 20 DE          jr nz, getPacket
 254+ 8402 CD 19 82         call Uart.read
 254+ 8405 FE 0D          cp 13
 254+ 8407 20 D7          jr nz, getPacket
 255+ 8409 3E 01 32 3A      ld a, 1, (closed), a
 255+ 840D 82
 256+ 840E C9               ret
 257+ 840F              .ipdBegun
 258+ 840F CD 19 82         call Uart.read
 258+ 8412 FE 49          cp 'I'
 258+ 8414 20 CA          jr nz, getPacket
 259+ 8416 CD 19 82         call Uart.read
 259+ 8419 FE 50          cp 'P'
 259+ 841B 20 C3          jr nz, getPacket
 260+ 841D CD 19 82         call Uart.read
 260+ 8420 FE 44          cp 'D'
 260+ 8422 20 BC          jr nz, getPacket
 261+ 8424 CD 19 82         call Uart.read ; Comma
 262+ 8427              	; call Uart.read ; link ID
 263+ 8427              	; ld (link_id),a ;запомнить
 264+ 8427              	;call Uart.read ; Comma
 265+ 8427 CD 54 84         call .count_ipd_lenght
 265+ 842A 22 36 82       ld (bytes_avail), hl
 266+ 842D 44 4D            ld bc, hl
 267+ 842F 2A 38 82         ld hl, (buffer_pointer)
 268+ 8432              .readp
 269+ 8432 7C               ld a, h
 269+ 8433 FE 40          cp buffer_end
 269+ 8435 30 12          jr nc, .skipbuff ;
 270+ 8437 C5 E5            push bc, hl
 271+ 8439 CD 19 82         call Uart.read
 272+ 843C E1 C1            pop hl, bc
 273+ 843E 77               ld (hl), a
 274+ 843F 0B               dec bc
 274+ 8440 23             inc hl
 275+ 8441 78               ld a, b
 275+ 8442 B1             or c
 275+ 8443 20 ED          jr nz, .readp
 276+ 8445 22 38 82         ld (buffer_pointer), hl
 277+ 8448 C9               ret
 278+ 8449              .skipbuff
 279+ 8449 C5               push bc
 280+ 844A CD 19 82         call Uart.read
 281+ 844D C1               pop bc
 282+ 844E 0B               dec bc
 282+ 844F 78             ld a, b
 282+ 8450 B1             or c
 282+ 8451 20 F6          jr nz, .skipbuff
 283+ 8453 C9               ret
 284+ 8454              .count_ipd_lenght
 285+ 8454 21 00 00     		ld hl,0			; count lenght
 286+ 8457 E5           .cil1	push  hl
 287+ 8458 CD 19 82             call Uart.read
 288+ 845B E1                   pop hl
 289+ 845C FE 3A        		cp ':'
 289+ 845E C8             ret z
 290+ 845F D6 30        		sub 0x30
 290+ 8461 4D             ld c,l
 290+ 8462 44             ld b,h
 290+ 8463 29             add hl,hl
 290+ 8464 29             add hl,hl
 290+ 8465 09             add hl,bc
 290+ 8466 29             add hl,hl
 290+ 8467 4F             ld c,a
 290+ 8468 06 00          ld b,0
 290+ 846A 09             add hl,bc
 291+ 846B 18 EA        		jr .cil1
 292+ 846D
 293+ 846D              ; Based on: https://wikiti.brandonw.net/index.php?title=Z80_Routines:Other:DispHL
 294+ 846D              ; HL - number
 295+ 846D              ; It will be written to UART
 296+ 846D              hlToNumEsp:
 297+ 846D 01 F0 D8     	ld	bc,-10000
 298+ 8470 CD 86 84     	call	.n1
 299+ 8473 01 18 FC     	ld	bc,-1000
 300+ 8476 CD 86 84     	call	.n1
 301+ 8479 01 9C FF     	ld	bc,-100
 302+ 847C CD 86 84     	call	.n1
 303+ 847F 0E F6        	ld	c,-10
 304+ 8481 CD 86 84     	call	.n1
 305+ 8484 0E FF        	ld	c,-1
 306+ 8486 3E 2F        .n1	ld	a,'0'-1
 307+ 8488 3C           .n2	inc	a
 308+ 8489 09           	add	hl,bc
 309+ 848A 38 FC        	jr	c, .n2
 310+ 848C ED 42        	sbc	hl,bc
 311+ 848E C5               push bc
 312+ 848F CD 25 82     	call Uart.write
 313+ 8492 C1               pop bc
 314+ 8493 C9               ret
 315+ 8494
 316+ 8494
 317+ 8494              ;команды
 318+ 8494 41 54 45 30  cmd_ATE0 db "ATE0",13,10,0 ;эхо?
 318+ 8498 0D 0A 00
 319+ 849B 41 54 2B 43  cmd_CIPSERVER db "AT+CIPSERVER=0",13,10,0 ;удалить сервер
 319+ 849F 49 50 53 45
 319+ 84A3 52 56 45 52
 319+ 84A7 3D 30 0D 0A
 319+ 84AB 00
 320+ 84AC 41 54 2B 43  cmd_CIPSTART db 'AT+CIPSTART="' ;продолжение
 320+ 84B0 49 50 53 54
 320+ 84B4 41 52 54 3D
 320+ 84B8 22
 321+ 84B9              	;тут тип
 322+ 84B9 54 43 50 22  cmd_CIPSTART2 db 'TCP","',0 ;продолжение
 322+ 84BD 2C 22 00
 323+ 84C0 41 54 2B 43  cmd_CIPSEND db "AT+CIPSEND=",0 ;отправить данные
 323+ 84C4 49 50 53 45
 323+ 84C8 4E 44 3D 00
 324+ 84CC              	;тут ID
 325+ 84CC 41 54 2B 43  cmd_CIPCLOSE db "AT+CIPCLOSE",0 ;закрыть соединение
 325+ 84D0 49 50 43 4C
 325+ 84D4 4F 53 45 00
 326+ 84D8              	;тут ID
 327+ 84D8 41 54 2B 43  cmd_CIPMUX db "AT+CIPMUX=0",13,10,0 ; Single connection mode
 327+ 84DC 49 50 4D 55
 327+ 84E0 58 3D 30 0D
 327+ 84E4 0A 00
 328+ 84E6 41 54 2B 43  cmd_CIPDINFO db "AT+CIPDINFO=0",13,10,0 ; Disable additional info
 328+ 84EA 49 50 44 49
 328+ 84EE 4E 46 4F 3D
 328+ 84F2 30 0D 0A 00
 329+ 84F6
 330+ 84F6                  ENDMODULE
# file closed: Drv/wifi.asm
 770  84F6              	include Drv/utils.asm ;работа с ESP
# file opened: Drv/utils.asm
   1+ 84F6              ;;; Macroses!!!!
   2+ 84F6                  ; MACRO EspSend Text
   3+ 84F6                  ; ld hl, .txtB
   4+ 84F6                  ; ld e, (.txtE - .txtB)
   5+ 84F6                  ; call espSend
   6+ 84F6                  ; jr .txtE
   7+ 84F6              ; .txtB
   8+ 84F6                  ; db Text
   9+ 84F6              ; .txtE
  10+ 84F6                  ; ENDM
  11+ 84F6
  12+ 84F6                  ; MACRO EspCmd Text
  13+ 84F6                  ; ld hl, .txtB
  14+ 84F6                  ; ld e, (.txtE - .txtB)
  15+ 84F6                  ; call espSend
  16+ 84F6                  ; jr .txtE
  17+ 84F6              ; .txtB
  18+ 84F6                  ; db Text
  19+ 84F6                  ; db 13, 10
  20+ 84F6              ; .txtE
  21+ 84F6                  ; ENDM
  22+ 84F6
  23+ 84F6                  ; MACRO EspCmdOkErr text
  24+ 84F6                  ; EspCmd text
  25+ 84F6                  ; call checkOkErr
  26+ 84F6                  ; ENDM
  27+ 84F6
  28+ 84F6              ; IN DE - string pointer
  29+ 84F6              ; OUT HL - string len
  30+ 84F6              strLen:
  31+ 84F6 21 00 00         ld hl, 0
  32+ 84F9              .loop
  33+ 84F9 1A               ld a, (de)
  33+ 84FA A7             and a
  33+ 84FB C8             ret z
  34+ 84FC 13 23            inc de, hl
  35+ 84FE 18 F9            jr .loop
# file closed: Drv/utils.asm
 771  8500
 772  8500              msg_esp_link
 773  8500 45 53 50 20  	db "ESP id: ",0
 773  8504 69 64 3A 20
 773  8508 00
 774  8509              msg_esp_transmit
 775  8509 54 72 6E 3A  	db "Trn: ",0
 775  850D 20 00
 776  850F              msg_esp_receive
 777  850F 52 63 76 3A  	db "Rcv: ",0
 777  8513 20 00
 778  8515              msg_esp_address
 779  8515 41 64 72 3A  	db "Adr: ",0
 779  8519 20 00
 780  851B
 781  851B              msg_ver_net
 782  851B 4E 45 54 20  	db "NET ver 2025.01.14",13,10,0
 782  851F 76 65 72 20
 782  8523 32 30 32 35
 782  8527 2E 30 31 2E
 782  852B 31 34 0D 0A
 782  852F 00
 783  8530
 784  8530              end_net
 785  8530              	savebin "net.apg",start_net,$-start_net
 786  8530
 787  8530              ;------------------------------------------------------------------------
 788  8530
 789  8530
 790  8530
 791  8530
 792  8530
 793  8530
 794  8530
 795  8530
 796  8530
 797  8530
 798  8530
 799  8530
 800  8530
 801  8530
 802  8530
 803  8530
 804  8530
 805  8530
 806  8530
 807  8530              ;ядро системы
 808  8530              	org #0000
 809  0000              	;bank 0
 810  0000              start_os_main
 811  0000
 812  0000 C3 01 C1     x0000	jp	InitProgramm + #c000	;RST #00	;+#C000 после запуска меняется
 813  0003 00 00 00...  	ds	#08-3
 814  0008
 815  0008 18 31        x0008	jr	x003B			;обработка RST #08
 816  000A 00           	nop
 817  000B 00           x000B	nop
 818  000C 00           	nop
 819  000D 18 75        x000D	jr	ExitMon
 820  000F 00           	ds	#01
 821  0010
 822  0010 C3 5B 0A     x0010	jp	drvgmx.putC  ;RST #10		;печать одного символа
 823  0013
 824  0013 ED 79        x0013	out	(c),a
 825  0015 00           	nop
 826  0016 00 00        	ds	#02
 827  0018
 828  0018 C3 49 06     x0018	jp os_wait ;передача управления ОС ;RST #18
 829  001B 00 00 00...  		ds #05 ;ds	#08
 830  0020
 831  0020 C3 F4 06     x0020	jp function  ;RST #20
 832  0023 00 00 00...  		ds	#05 ;#08
 833  0028
 834  0028 00 00 00...  x0028	ds	#08 ;RST #28
 835  0030
 836  0030 00 00 00     x0030	ds	#03 ;RST #30
 837  0033
 838  0033 ED 79        x0033	out	(c),a
 839  0035 00           	nop
 840  0036
 841  0036 00 24        x0036	dw	font
 842  0038
 843  0038              ;обработчик прерываний
 844  0038 C3 70 07     x0038	jp	Interrupts ;#RST 38
 845  003B
 846  003B              ;обработка RST 8
 847  003B F5           x003B	push	af
 848  003C ED 5F        	ld	a,r
 849  003E EA 43 00     	jp	pe,x0043
 850  0041 ED 5F        	ld	a,r
 851  0043 F5           x0043	push	af
 852  0044 3E 10        	ld	a,#10			;вход из ram 0
 853  0046 F5           	push	af
 854  0047 33           	inc	sp
 855  0048 C5           	push	bc
 856  0049 E5           	push	hl
 857  004A 01 00 00     	ld	bc,#0000
 858  004D 3E 02        	ld	a,#02
 859  004F ED 79        	out	(c),a
 860  0051 01 FD 7E     	ld	bc,#7EFD
 861  0054 ED 60        	in	h,(c)			;h=in #7EFD
 862  0056 06 7A        	ld	b,#7A
 863  0058 ED 68        	in	l,(c)			;l=in #7AFD
 864  005A 06 1F        	ld	b,#1F
 865  005C 3E 12        	ld	a,#12
 866  005E 18 B3        	jr	x0013
 867  0060 00 00 00...  	ds	#06			;=#0060
 868  0066
 869  0066              ;обработка NMI
 870  0066              ;
 871  0066 F5           x0066   push  af
 872  0067 ED 5F           ld  a,r
 873  0069 F3              di
 874  006A F5              push  af
 875  006B 3E 20           ld  a,#20
 876  006D F5              push  af
 877  006E 33              inc  sp
 878  006F C5              push  bc
 879  0070 E5              push  hl
 880  0071 01 FD 7E        ld  bc,#7EFD
 881  0074 ED 60           in  h,(c)    ;h=in #7EFD
 882  0076 06 7A           ld  b,#7A
 883  0078 ED 68           in  l,(c)    ;l=in #7AFD
 884  007A 06 1F           ld  b,#1F    ;18 байт
 885  007C 3E 12           ld  a,#12
 886  007E C3 33 00        jp  x0033
 887  0081
 888  0081 00           	nop
 889  0082 00           	nop
 890  0083 00           	nop
 891  0084              x0084
 892  0084              ;возврат из монитора =#0084
 893  0084 ED 51        ExitMon	out	(c),d			;#1FFD
 894  0086 06 7F        	ld	b,#7F
 895  0088 ED 59        	out	(c),e			;#7FFD
 896  008A 01 00 00     	ld	bc,#0000
 897  008D ED 79        	out	(c),a
 898  008F D1           	pop	de
 899  0090 C1           	pop	bc
 900  0091 33           	inc	sp
 901  0092 F1           	pop	af
 902  0093 ED 4F        	ld	r,a
 903  0095 E2 9B 00     	jp	po,x009B
 904  0098 F1           	pop	af
 905  0099 FB           	ei
 906  009A C9           	ret
 907  009B F1           x009B	pop	af
 908  009C F3           	di
 909  009D C9           	ret
 910  009E
 911  009E              x009E
 912  009E              ; StartWord
 913  009E              	; ldir
 914  009E              	; call	onPageTXT
 915  009E              	; jp	MainLoopEdit
 916  009E              	; INSERT	"Info/!version.txt"
 917  009E              	; INSERT	"Info/!build.txt"
 918  009E              	; db	"GMX"
 919  009E 00 00 00...  y009E	ds	#00FF-$
 920  00FF
 921  00FF 38 00        x00FF	dw	x0038
 922  0101
 923  0101
 924  0101
 925  0101              ;Первый запуск
 926  0101              InitProgramm
 927  0101 F3           	di
 928  0102 31 00 41     	ld sp,#4100 ;временный адрес стека
 929  0105 3E 01        	ld a, #01 ;включить ОЗУ вместо ПЗУ
 930  0107 01 FD 1F         ld   bc,#1ffd
 931  010A ED 79        	out (c),a
 932  010C 21 15 01     	ld hl,Start_warm ;заменить адрес старта
 933  010F 22 01 00     	ld (#0001),hl
 934  0112 C3 00 00     	jp 0
 935  0115
 936  0115
 937  0115              ; rst #08: db #8F установка/удаление резидента из памяти
 938  0115              ; при "теплой" перезагрузке, если резидент установлен в странице, то эта страница
 939  0115                ; будет впечатана в 3е окно и управление передано по заданному адресу
 940  0115              ; вх:  a - номер страницы для установки резидента
 941  0115                      ; =#08 - удаление резидента
 942  0115                      ; 7,a =1 однократный вызов
 943  0115                   ; hl - адрес старта в странице
 944  0115              ; вых: cy=1 резидент не установлен
 945  0115              ; сначала копируем в эту страницу то что надо
 946  0115              ; и только потом вызываем функцию
 947  0115              ; для гмх страницу 8 и #78 задавать нельзя
 948  0115              ; перед повторной установкой резидента, вызывать функцию удаления не нужно
 949  0115
 950  0115              ;Старт системы
 951  0115              Start_warm
 952  0115              	;di
 953  0115 ED 56        	im 1
 954  0117
 955  0117              ;------------------------------------------------------------------------------
 956  0117              ;вызов функции #00(00) (SetRam0) установка работы со страницей ram 0 вместо rom, требуется для
 957  0117              ;корректного выхода из монитора, при ресете отключается
 958  0117              ;вх:  c=#00(00)
 959  0117              ;     cy=1 - установка
 960  0117              ;     cy=0 - отключение
 961  0117              ;вых: регистры не меняются
 962  0117              ;   R8CONF
 963  0117 0E 00        	ld	c,#00
 964  0119 37           	scf
 965  011A CF           	rst	#08
 966  011B 8E           	db	#8E
 967  011C              ;
 968  011C
 969  011C
 970  011C
 971  011C              	;подготовить системный процесс
 972  011C 3E 01        	ld a,proc_id_system ;код системного процесса
 973  011E 32 22 2C     	ld (proc_id_cur),a ;запомнить как текущий
 974  0121 32 07 2C     	ld (proc_id_focus),a ;сразу в фокусе
 975  0124              	;ld (proc_run_prepar_id_tmp),a ;для правильного выделения памяти
 976  0124 AF           	xor a
 977  0125 32 1F 2C     	ld (proc_id_next),a ;для вычисления следующего процесса
 978  0128
 979  0128 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
 980  012A 32 1B 2C     	ld (con_scr_cur),a
 981  012D 3E 79        	ld a,con_atr_real ;атрибуты реальные
 982  012F 32 1C 2C     	ld (con_atr_cur),a
 983  0132 3E 39        	ld a,#39 ;видимый экран
 984  0134 32 06 2C     	ld (scr_cur),a
 985  0137 CD A6 09     	call drvgmx.init
 986  013A
 987  013A CD 35 0D     	call Dos.init_fs_fat ;выбор раздела (буквы диска)
 988  013D
 989  013D 21 C0 35     	ld hl,proc_name_sys		;строка с именем
 990  0140 CD DE 02     	call proc_run ;запуск
 991  0143 DA 77 01     	jp c,loop_idle ;не вышло
 992  0146
 993  0146
 994  0146              	; ;запустить системный процесс
 995  0146              ; ;proc_run_sys
 996  0146              ; ;запуск sys не с диска, а из состава ОС
 997  0146              	; ld hl,proc_sys_name
 998  0146              	; call proc_run_prepar
 999  0146              	; ret c
1000  0146
1001  0146              	;включить страницы
1002  0146              	;;ld ix,(proc_run_prepar_deskr_tmp)
1003  0146 DD 7E 02     	ld a,(ix+2)
1004  0149 32 17 2C     	ld (page_slot2_cur),a ;сделать страницы текущими
1005  014C CD 2D 0C     	call drvgmx.PageSlot2
1006  014F DD 7E 03     	ld a,(ix+3)
1007  0152 32 18 2C     	ld (page_slot3_cur),a
1008  0155 CD 4C 0B     	call drvgmx.PageSlot3
1009  0158              	;цвета
1010  0158 3E 07        	ld a,proc_color_def ;цвет
1011  015A 32 6B 0C     	ld (drvgmx.attr_screen),a
1012  015D DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1013  0160              	;
1014  0160 3E 0C        	ld a,proc_color2_def ;цвет 2
1015  0162 32 6C 0C     	ld (drvgmx.attr_screen2),a
1016  0165 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1017  0168              	; ;перенести код
1018  0168              	; ld hl,start_sys_incl
1019  0168              	; ld de,PROGSTART
1020  0168              	; ld bc,end_sys_incl-start_sys_incl
1021  0168              	; ldir
1022  0168              	;подготовить правильный старт
1023  0168 DD 6E 06     	ld l,(ix+6) ;стек нового процесса
1024  016B DD 66 07     	ld h,(ix+7) ;стек
1025  016E F9           	ld sp,hl
1026  016F
1027  016F 3E 01        	ld a,proc_id_system
1028  0171 DD 77 00     	ld (ix),a
1029  0174 C3 00 80     	jp PROG_START ;старт сначала на заглушку
1030  0177
1031  0177
1032  0177
1033  0177
1034  0177
1035  0177              loop_idle ;заглушка
1036  0177 18 FE        	jr loop_idle ;
1037  0179
1038  0179
1039  0179
1040  0179
1041  0179
1042  0179              ; proc_run_cmd
1043  0179              ; ; запуск cmd не с диска, а из состава ОС
1044  0179              	; ld hl,proc_cmd_name
1045  0179              	; call proc_run_prepar
1046  0179              	; ret c
1047  0179              	; ;включить страницы
1048  0179              	; ;ld ix,(proc_run_prepar_deskr_tmp)
1049  0179              	; ld a,(ix+2)
1050  0179              	; call drvgmx.PageSlot2
1051  0179              	; ld a,(ix+3)
1052  0179              	; call drvgmx.PageSlot3
1053  0179              	; ;перенести код
1054  0179              	; ld hl,start_cmd_incl
1055  0179              	; ld de,PROGSTART
1056  0179              	; ld bc,end_cmd_incl-start_cmd_incl
1057  0179              	; ldir
1058  0179
1059  0179              	; jp file_load_ok ;продолжить стандартно
1060  0179
1061  0179
1062  0179
1063  0179
1064  0179
1065  0179              proc_run_prepar
1066  0179              ;подготовка к запуску процесса
1067  0179              ;выделение памяти и прочее
1068  0179              ;вх: hl - имя процесса (файла) 8+3 символов
1069  0179              ;вых: a - номер процесса, IX - дескриптор
1070  0179
1071  0179 22 F8 01     	ld (proc_run_prepar_name_tmp),hl ;сохранить имя
1072  017C              	;поиск свободного дескриптора
1073  017C 21 00 2D     	ld hl,proc_table
1074  017F 11 00 01     	ld de,proc_descr_size
1075  0182 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
1076  0184 0E 01        	ld c,proc_id_system ;первый номер
1077  0186              proc_run_prepar_cl
1078  0186 7E           	ld a,(hl)
1079  0187 B7           	or a ;свободен?
1080  0188 28 0C        	jr z,proc_run_prepar_ok
1081  018A 19           	add hl,de
1082  018B 0C           	inc c
1083  018C 10 F8        	djnz proc_run_prepar_cl
1084  018E              	;не нашли свободного
1085  018E 21 EE 35     	ld hl,msg_proc_max
1086  0191 CD 50 0A     	call drvgmx.printZ ;сообщение
1087  0194 37           	scf
1088  0195 C9           	ret
1089  0196              proc_run_prepar_ok
1090  0196              	;есть свободный
1091  0196 E5           	push hl
1092  0197 DD E1        	pop ix ;дискриптор процесса
1093  0199 22 FC 01     	ld (proc_run_prepar_deskr_tmp),hl
1094  019C 79           	ld a,c ;присвоить номер
1095  019D 32 FA 01     	ld (proc_run_prepar_id_tmp),a
1096  01A0
1097  01A0
1098  01A0 3A 22 2C     	ld a,(proc_id_cur)
1099  01A3 DD 77 01     	ld (ix+1),a ;код родительского
1100  01A6
1101  01A6              	;скопировать имя
1102  01A6 11 10 00     	ld de,16 ;
1103  01A9 19           	add hl,de
1104  01AA EB           	ex de,hl
1105  01AB 2A F8 01     	ld hl,(proc_run_prepar_name_tmp)
1106  01AE 01 0C 00     	ld bc,8+3+1
1107  01B1 ED B0        	ldir
1108  01B3
1109  01B3
1110  01B3              	;выделение памяти стандартное количество окон
1111  01B3 CD 04 02     	call proc_find_ram
1112  01B6 38 1D        	jr c,proc_run_prepar_no_mem
1113  01B8 DD 77 02     	ld (ix+2),a ;страница 8000
1114  01BB CD 04 02     	call proc_find_ram
1115  01BE 38 15        	jr c,proc_run_prepar_no_mem
1116  01C0 DD 77 03     	ld (ix+3),a ;страница c000
1117  01C3 CD 04 02     	call proc_find_ram
1118  01C6 38 0D        	jr c,proc_run_prepar_no_mem
1119  01C8 DD 77 04     	ld (ix+4),a ;страница пиксели
1120  01CB CD 04 02     	call proc_find_ram
1121  01CE 38 05        	jr c,proc_run_prepar_no_mem
1122  01D0 DD 77 05     	ld (ix+5),a ;страница атрибуты
1123  01D3
1124  01D3 18 0E        	jr proc_run_prepar_mem_ok
1125  01D5
1126  01D5              proc_run_prepar_no_mem
1127  01D5 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1128  01D8 CD 1D 02     	call proc_clear_ram ;освободить память обратно
1129  01DB
1130  01DB 21 05 36     	ld hl,msg_mem_max
1131  01DE CD 50 0A     	call drvgmx.printZ ;сообщение
1132  01E1 37           	scf
1133  01E2 C9           	ret
1134  01E3
1135  01E3              proc_run_prepar_mem_ok ;памяти хватило
1136  01E3
1137  01E3              	;определить адрес стека
1138  01E3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1139  01E6 21 00 2C     	ld hl,proc_table-256
1140  01E9 84           	add h
1141  01EA 67           	ld h,a
1142  01EB 2E 80        	ld l,#80 ;на стек меньше 128 байт
1143  01ED              	; ld hl,proc_stack
1144  01ED              	; or a
1145  01ED              	; jr z,proc_run_prepar_ex
1146  01ED              	; ld b,a
1147  01ED              	; ld de,proc_stack_size
1148  01ED              ; proc_run_prepar_cl2 ;цикл
1149  01ED              	; add hl,de
1150  01ED              	; djnz proc_run_prepar_cl2
1151  01ED              ;proc_run_prepar_ex
1152  01ED DD 75 06     	ld (ix+6),l ;адрес стека
1153  01F0 DD 74 07     	ld (ix+7),h ;адрес стека
1154  01F3              	; ld a,(proc_run_prepar_id_tmp) ;id
1155  01F3              	; ld (ix+0),a
1156  01F3 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;id
1157  01F6 B7           	or a
1158  01F7 C9           	ret
1159  01F8
1160  01F8 00 00        proc_run_prepar_name_tmp dw 0 ;временно имя нового процесса
1161  01FA 00           proc_run_prepar_id_tmp db 0 ;временно id нового процесса
1162  01FB 00           proc_run_file_id_tmp db 0 ;временно id файла
1163  01FC 00 00        proc_run_prepar_deskr_tmp dw 0 ;временно дескриптор процесса
1164  01FE
1165  01FE
1166  01FE
1167  01FE
1168  01FE              proc_get_ram ;для вызова из процесса
1169  01FE 3A 22 2C     	ld a,(proc_id_cur)
1170  0201 32 FA 01     	ld (proc_run_prepar_id_tmp),a
1171  0204
1172  0204              proc_find_ram	;поиск свободной страницы памяти
1173  0204              ;вых: a - номер страницы, также записан id процесса в таблицу proc_page_table
1174  0204 11 AD 0B     	ld de,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
1175  0207 21 00 35     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
1176  020A 06 6D        	ld b,page_max
1177  020C              proc_find_ram_cl
1178  020C AF           	xor a
1179  020D B6           	or (hl)
1180  020E 28 06        	jr z,proc_find_ram_ok1 ;нашли
1181  0210              	;ищем дальше
1182  0210 23           	inc hl
1183  0211 13           	inc de
1184  0212 10 F8        	djnz proc_find_ram_cl
1185  0214              	;совсем не нашли
1186  0214 37           	scf
1187  0215 C9           	ret
1188  0216              proc_find_ram_ok1
1189  0216 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1190  0219 77           	ld (hl),a ;записать id процесса в таблицу
1191  021A 1A           	ld a,(de) ;вернуть номер страницы
1192  021B B7           	or a
1193  021C C9           	ret
1194  021D
1195  021D
1196  021D
1197  021D
1198  021D
1199  021D              proc_clear_ram ;освбождение всех страниц памяти процесса
1200  021D              ;вх: a - номер процесса
1201  021D 21 00 35     	ld hl,proc_page_table
1202  0220 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
1203  0222              proc_clear_ram_cl ;
1204  0222 BE           	cp (hl) ;совпадает с номером процесса?
1205  0223 20 02        	jr nz,proc_clear1
1206  0225 36 00        	ld (hl),0 ;освободить
1207  0227              proc_clear1
1208  0227 23           	inc hl
1209  0228 10 F8        	djnz proc_clear_ram_cl
1210  022A B7           	or a
1211  022B C9           	ret
1212  022C
1213  022C
1214  022C
1215  022C              proc_focus_next
1216  022C              	;переключение фокуса на следующий процесс
1217  022C 3E 01        	ld a,1
1218  022E 32 0D 2C     	ld (proc_next_find_skip_flag),a ;флаг пропустить лишние проверки
1219  0231 3A 07 2C     	ld a,(proc_id_focus)
1220  0234 CD 54 09     	call proc_next_find_skip ;узнать кто следующий
1221  0237 08           	ex af,af'
1222  0238 AF           	xor a
1223  0239 32 0D 2C     	ld (proc_next_find_skip_flag),a ;флаг убрать
1224  023C 08           	ex af,af'
1225  023D              	;ret c ;выернуться если один процесс
1226  023D              	;или сменить фокус, код ниже
1227  023D
1228  023D
1229  023D
1230  023D              ;передать фокус процессу
1231  023D              ;вх: a - id процесса
1232  023D              proc_set_focus
1233  023D 21 07 2C     	ld hl,proc_id_focus
1234  0240 BE           	cp (hl)
1235  0241 C8           	ret z ;если уже в фокусе, ничего не делаем
1236  0242 32 D0 02     	ld (proc_set_focus_id_tmp),a ;сохранить
1237  0245
1238  0245 21 00 2C     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1239  0248 84           	add h
1240  0249 67           	ld h,a
1241  024A AF           	xor a
1242  024B B6           	or (hl)
1243  024C C8           	ret z
1244  024D
1245  024D
1246  024D              	;сохранить в буфер процесса текущий экран
1247  024D 3A 07 2C     	ld a,(proc_id_focus) ;текущий в фокусе
1248  0250 21 00 2C     	ld hl,proc_table - 256
1249  0253 84           	add h
1250  0254 67           	ld h,a
1251  0255 E5           	push hl
1252  0256 DD E1        	pop ix ;дескриптор процесса предыдущего
1253  0258
1254  0258 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1255  025B CD 4C 0B     	call drvgmx.PageSlot3
1256  025E 3E 39        	ld a,con_scr_real ;настоящий экран
1257  0260 CD 2D 0C     	call drvgmx.PageSlot2
1258  0263 21 00 80     	ld hl,#8000 ;скопировать
1259  0266 11 00 C0     	ld de,#c000
1260  0269 01 00 40     	ld bc,#4000
1261  026C ED B0        	ldir
1262  026E
1263  026E DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1264  0271 CD 4C 0B     	call drvgmx.PageSlot3
1265  0274 3E 79        	ld a,con_atr_real
1266  0276 CD 2D 0C     	call drvgmx.PageSlot2
1267  0279 21 00 80     	ld hl,#8000 ;скопировать
1268  027C 11 00 C0     	ld de,#c000
1269  027F 01 00 40     	ld bc,#4000
1270  0282 ED B0        	ldir
1271  0284
1272  0284              	;сохранить позицию скрола
1273  0284              	;ld hl,(drvgmx.curscrl)
1274  0284              	;ld (ix+#08),hl ;позиция скрола
1275  0284
1276  0284
1277  0284              	;вернуть из буфера экран нужного процесса
1278  0284 3A D0 02     	ld a,(proc_set_focus_id_tmp)
1279  0287 21 00 2C     	ld hl,proc_table - 256
1280  028A 84           	add h
1281  028B 67           	ld h,a
1282  028C E5           	push hl
1283  028D DD E1        	pop ix ;дескриптор процесса который будет в фокусе
1284  028F
1285  028F DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
1286  0292 CD 4C 0B     	call drvgmx.PageSlot3
1287  0295 3E 39        	ld a,con_scr_real ;настоящий экран
1288  0297 CD 2D 0C     	call drvgmx.PageSlot2
1289  029A 21 00 C0     	ld hl,#c000 ;скопировать
1290  029D 11 00 80     	ld de,#8000
1291  02A0 01 00 40     	ld bc,#4000
1292  02A3 ED B0        	ldir
1293  02A5
1294  02A5 DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
1295  02A8 CD 4C 0B     	call drvgmx.PageSlot3
1296  02AB 3E 79        	ld a,con_atr_real
1297  02AD CD 2D 0C     	call drvgmx.PageSlot2
1298  02B0 21 00 C0     	ld hl,#c000 ;скопировать
1299  02B3 11 00 80     	ld de,#8000
1300  02B6 01 00 40     	ld bc,#4000
1301  02B9 ED B0        	ldir
1302  02BB
1303  02BB CD D1 02     	call page_cur_return
1304  02BE
1305  02BE
1306  02BE 3A D0 02     	ld a,(proc_set_focus_id_tmp)
1307  02C1              	;запомнить активный процесс
1308  02C1 32 07 2C     	ld (proc_id_focus),a
1309  02C4
1310  02C4              	;ld hl,(ix+#08) ;позиция скрола
1311  02C4              	;ld (drvgmx.curscrl),hl
1312  02C4              	;call drvgmx.gmxscroll ;обновить скролл
1313  02C4 DD 7E 1D     	ld a, (ix + #1d) ;активный экран
1314  02C7 B7           	or a
1315  02C8 28 03        	jr z,proc_set_focus_scr
1316  02CA CD A7 04     	call set_scr_no_txt ;включить
1317  02CD              proc_set_focus_scr
1318  02CD C3 70 07     	jp Interrupts ;сразу на другой процесс
1319  02D0              	;or a
1320  02D0              	;ret
1321  02D0 00           proc_set_focus_id_tmp db 0 ; временно
1322  02D1
1323  02D1
1324  02D1
1325  02D1              page_cur_return
1326  02D1              ;вернуть текущие страницы
1327  02D1 3A 17 2C     	ld a,(page_slot2_cur)
1328  02D4 CD 2D 0C     	call drvgmx.PageSlot2
1329  02D7 3A 18 2C     	ld a,(page_slot3_cur)
1330  02DA CD 4C 0B     	call drvgmx.PageSlot3
1331  02DD C9           	ret
1332  02DE
1333  02DE
1334  02DE              ;запустить процесс
1335  02DE              ;вх: hl - имя файла (заканчивается на 0)
1336  02DE              proc_run
1337  02DE CD 79 01     	call proc_run_prepar ;выделить память
1338  02E1 D8           	ret c
1339  02E2
1340  02E2 2A F8 01     	ld hl,(proc_run_prepar_name_tmp) ;имя
1341  02E5              	;ld b,Dos.FMODE_READ
1342  02E5 CD C0 0C     	call Dos.fopen_r ;откроем файл для чтения
1343  02E8 DC 2F 0E     	call c,Dos.file_error_print_file_open_error
1344  02EB DA D3 03     	jp c,file_load_err
1345  02EE 32 FB 01     	ld (proc_run_file_id_tmp),a ;запомнить id
1346  02F1
1347  02F1              	;проверка длины файла не больше #8000
1348  02F1 7A           	ld	a,d ;самые старшие байты длины
1349  02F2 B3           	or e
1350  02F3 28 09        	jr z,file_size_ok ;если не слищком большой
1351  02F5              file_too_big
1352  02F5 21 42 10     	ld hl,Dos.msg_file_too_big
1353  02F8 CD 50 0A     	call drvgmx.printZ
1354  02FB C3 D3 03     	jp file_load_err
1355  02FE
1356  02FE
1357  02FE              file_size_ok
1358  02FE 78           	ld	a,b ;младший старший байт длины
1359  02FF FE 81        	cp proc_size_max+1
1360  0301 30 F2        	jr nc,file_too_big
1361  0303              	;размер нормальный, прочитаем
1362  0303
1363  0303
1364  0303
1365  0303              	;включить страницы
1366  0303 DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp)
1367  0307 DD 7E 02     	ld a,(ix+2)
1368  030A CD 2D 0C     	call drvgmx.PageSlot2
1369  030D DD 7E 03     	ld a,(ix+3)
1370  0310 CD 4C 0B     	call drvgmx.PageSlot3
1371  0313
1372  0313 21 00 80     	ld hl,PROG_START
1373  0316 3A FB 01     	ld a,(proc_run_file_id_tmp)
1374  0319 50           	ld d,b ;размер
1375  031A 59           	ld e,c
1376  031B CD 79 0E     	call Dos.fread
1377  031E 30 0E        	jr nc,file_size_ok2
1378  0320              	;если ошибка вернуть страницы
1379  0320 CD 37 0E     	call Dos.file_error_print_file_read_error
1380  0323 CD D1 02     	call page_cur_return
1381  0326 3A FB 01     	ld a,(proc_run_file_id_tmp)
1382  0329 CD 3F 0E     	call Dos.fclose ;закрыть файл
1383  032C 37           	scf
1384  032D C9           	ret
1385  032E              file_size_ok2
1386  032E 3A FB 01     	ld a,(proc_run_file_id_tmp)
1387  0331 CD 3F 0E     	call Dos.fclose ;закрыть файл
1388  0334              	;jr file_load_ok
1389  0334
1390  0334              	;скопировать дескриптор системной папки, будет у приложения такая же папка по умолчанию
1391  0334 3A FA 01     	ld a,(proc_run_prepar_id_tmp) ;номер будущего процесса
1392  0337 CD FD 0E     	call Dos.calc_dir_deskr
1393  033A EB           	ex de,hl
1394  033B 21 B2 10     	ld hl,Dos.dir_fat_deskr
1395  033E 01 20 00     	ld bc,Dos.fcb_fat_size
1396  0341 ED B0        	ldir
1397  0343
1398  0343              file_load_ok ;загрузился нормально
1399  0343 DD 2A FC 01  	ld ix,(proc_run_prepar_deskr_tmp) ;вспомнить дескриптор
1400  0347              	;очистить экран
1401  0347              	;сначала запомнить как было
1402  0347 2A 6B 0C     	ld hl,(drvgmx.attr_screen)
1403  034A 22 D5 03     	ld (proc_run_attr_screen_tmp),hl
1404  034D              	; запомнить координаты экрана предыдущего
1405  034D 2A 69 0C     	ld hl,(drvgmx.col_screen)
1406  0350 22 D9 03     	ld (proc_run_col_screen_tmp),hl ;координаты
1407  0353              	;страницы буфера
1408  0353 3A 1B 2C     	ld a,(con_scr_cur)
1409  0356 32 D7 03     	ld (proc_run_con_scr_cur_tmp),a
1410  0359 3A 1C 2C     	ld a,(con_atr_cur)
1411  035C 32 D8 03     	ld (proc_run_con_atr_cur_tmp),a
1412  035F              	;скрола
1413  035F 2A 3D 0B     	ld hl,(drvgmx.curscrl)
1414  0362 22 DB 03     	ld (proc_run_curscrl_tmp),hl
1415  0365
1416  0365
1417  0365
1418  0365              	;чистить буфер экрана
1419  0365 3E 07        	ld a,proc_color_def ;цвет
1420  0367 32 6B 0C     	ld (drvgmx.attr_screen),a
1421  036A DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
1422  036D              	;
1423  036D 3E 0C        	ld a,proc_color2_def ;цвет 2
1424  036F 32 6C 0C     	ld (drvgmx.attr_screen2),a
1425  0372 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
1426  0375              	;
1427  0375 DD 7E 04     	ld a,(ix+4)
1428  0378 32 1B 2C     	ld (con_scr_cur),a
1429  037B DD 7E 05     	ld a,(ix+5)
1430  037E 32 1C 2C     	ld (con_atr_cur),a
1431  0381 CD A9 09     	call drvgmx.cls
1432  0384 21 00 00     	ld hl,0
1433  0387 DD 75 08 DD  	ld (ix+#08),hl ;позиция скрола
1433  038B 74 09
1434  038D DD 75 0A DD  	ld (ix+#0a),hl ;позиция курсора
1434  0391 74 0B
1435  0393              	;вернуть
1436  0393 2A D5 03     	ld hl,(proc_run_attr_screen_tmp)
1437  0396 22 6B 0C     	ld (drvgmx.attr_screen),hl
1438  0399 2A D9 03     	ld hl,(proc_run_col_screen_tmp) ;координаты
1439  039C 22 69 0C     	ld (drvgmx.col_screen),hl
1440  039F 3A D7 03     	ld a,(proc_run_con_scr_cur_tmp)
1441  03A2 32 1B 2C     	ld (con_scr_cur),a
1442  03A5 3A D8 03     	ld a,(proc_run_con_atr_cur_tmp)
1443  03A8 32 1C 2C     	ld (con_atr_cur),a
1444  03AB 2A DB 03     	ld hl,(proc_run_curscrl_tmp)
1445  03AE 22 3D 0B     	ld (drvgmx.curscrl),hl
1446  03B1
1447  03B1
1448  03B1
1449  03B1
1450  03B1              	;подготовить правильный старт
1451  03B1 DD 6E 06     	ld l,(ix+6) ;адрес стека
1452  03B4 DD 66 07     	ld h,(ix+7) ;адрес стека
1453  03B7 01 00 80     	ld bc,PROG_START ;возврат сюда
1454  03BA 2B           	dec hl
1455  03BB 70           	ld (hl),b
1456  03BC 2B           	dec hl
1457  03BD 71           	ld (hl),c
1458  03BE 01 EC FF     	ld bc,-20 ;возврат будет с восстановлением регистров
1459  03C1 09           	add hl,bc
1460  03C2
1461  03C2 DD 75 06     	ld (ix+6),l ;адрес стека
1462  03C5 DD 74 07     	ld (ix+7),h ;адрес стека
1463  03C8 3A FA 01     	ld a,(proc_run_prepar_id_tmp)
1464  03CB DD 77 00     	ld (ix),a ;в последнюю очередь код (флаг что процесс работает)
1465  03CE
1466  03CE CD D1 02     	call page_cur_return
1467  03D1 B7           	or a
1468  03D2 C9           	ret
1469  03D3
1470  03D3
1471  03D3              file_load_err
1472  03D3 37           	scf
1473  03D4 C9           	ret
1474  03D5
1475  03D5 00 00        proc_run_attr_screen_tmp dw 0 ;временно
1476  03D7 00           proc_run_con_scr_cur_tmp db 0 ;временно
1477  03D8 00           proc_run_con_atr_cur_tmp db 0 ;временно
1478  03D9 00 00        proc_run_col_screen_tmp dw 0 ;временно
1479  03DB 00 00        proc_run_curscrl_tmp dw 0 ;временно
1480  03DD
1481  03DD
1482  03DD
1483  03DD
1484  03DD
1485  03DD
1486  03DD
1487  03DD
1488  03DD              get_c ;функция получение кода нажатой клавиши
1489  03DD              	;вых: a - код последней клавиши, 255 - ничего не нажато
1490  03DD 3A 22 2C     	ld a,(proc_id_cur) ;сравнить если процесс в фокусе
1491  03E0 21 07 2C     	ld hl,proc_id_focus
1492  03E3 BE           	cp (hl)
1493  03E4 3E FF        	ld a,255 ;ничего не нажато если не в фокусе
1494  03E6 C0           	ret nz
1495  03E7 3A 1D 2C     	ld a,(key_cur) ;или вернуть клавишу
1496  03EA F5           	push af
1497  03EB 3E FF        	ld a,255
1498  03ED 32 1D 2C     	ld (key_cur),a ;очистить буфер
1499  03F0 F1           	pop af
1500  03F1 C9           	ret
1501  03F2
1502  03F2              get_timer ;функция получить значение системного таймера
1503  03F2 ED 5B 24 2C  	ld de,(sys_timer) ;младшие байты
1504  03F6 2A 26 2C     	ld hl,(sys_timer+2)
1505  03F9 C9           	ret
1506  03FA
1507  03FA
1508  03FA
1509  03FA              page_copy ;скопировать страницу в страницу
1510  03FA              ;скопировать данные из страницы в страницу
1511  03FA              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
1512  03FA ED 43 30 04  	ld (page_copy_tmp),bc
1513  03FE 32 30 04     	ld (page_copy_tmp),a
1514  0401 D9           	exx
1515  0402 CD 32 04     	call page_check_owner 	;проверка разрешений
1516  0405 D8           	ret c
1517  0406 3A 31 04     	ld a,(page_copy_tmp+1)
1518  0409 CD 32 04     	call page_check_owner 	;проверка разрешений
1519  040C D8           	ret c
1520  040D DD 7C        	ld a,ixh ;не больше размера страницы
1521  040F FE 41        	cp #41
1522  0411 30 1B        	jr nc,page_copy_err
1523  0413 DD B5        	or ixl
1524  0415 28 17        	jr z,page_copy_err ;и не 0 длина
1525  0417 3A 30 04     	ld a,(page_copy_tmp)
1526  041A CD 2D 0C     	call drvgmx.PageSlot2
1527  041D 3A 31 04     	ld a,(page_copy_tmp+1)
1528  0420 CD 4C 0B     	call drvgmx.PageSlot3
1529  0423 D9           	exx ;вспомнить регистры
1530  0424              	 ;скопировать
1531  0424 DD E5        	push ix
1532  0426 C1           	pop bc ;длина
1533  0427 ED B0        	ldir
1534  0429 CD D1 02     	call page_cur_return ;вернуть страницы
1535  042C AF           	xor a
1536  042D C9           	ret
1537  042E              page_copy_err
1538  042E 37           	scf
1539  042F C9           	ret
1540  0430
1541  0430
1542  0430 00 00        page_copy_tmp dw 0 ;временно
1543  0432
1544  0432              page_check_owner ;проверить разрешена ли страница для процесса
1545  0432 FE 05        	cp #05 ;видео страница
1546  0434 C8           	ret z
1547  0435 FE 07        	cp #07 ;видео страница
1548  0437 C8           	ret z
1549  0438 FE 39        	cp #39 ;видео страница
1550  043A C8           	ret z
1551  043B FE 3A        	cp #3a ;видео страница
1552  043D C8           	ret z
1553  043E FE 79        	cp #79 ;видео страница
1554  0440 C8           	ret z
1555  0441 FE 7A        	cp #7a ;видео страница
1556  0443 C8           	ret z
1557  0444 32 68 04     	ld (page_check_owner_tmp),a
1558  0447 21 AD 0B     	ld hl,drvgmx.page_table ;таблица памяти
1559  044A 06 6D        	ld b,page_max ;всего страниц
1560  044C 0E 00        	ld c,0 ;индекс
1561  044E              page_check_owner_cl ;найти такую страницу
1562  044E BE           	cp (hl)
1563  044F 28 06        	jr z,page_check_owner_ex
1564  0451 0C           	inc c
1565  0452 23           	inc hl
1566  0453 10 F9        	djnz page_check_owner_cl
1567  0455 37           	scf ;не нашли в списке страниц
1568  0456 C9           	ret
1569  0457              page_check_owner_ex
1570  0457              	;нашли
1571  0457 06 00        	ld b,0
1572  0459 21 00 35     	ld hl,proc_page_table ;сверить с кодом текущего процесса
1573  045C 09           	add hl,bc
1574  045D 3A 22 2C     	ld a,(proc_id_cur)
1575  0460 BE           	cp (hl)
1576  0461 37           	scf ;не совпадает владелец с процессом
1577  0462 3A 68 04     	ld a,(page_check_owner_tmp)
1578  0465 C0           	ret nz
1579  0466 B7           	or a
1580  0467 C9           	ret
1581  0468 00           page_check_owner_tmp db 0 ;временно
1582  0469
1583  0469
1584  0469              set_VTPL_PLAY ;запустить плеер AY. будет играть на прерываниях
1585  0469 3A 17 2C     	ld a,(page_slot2_cur)
1586  046C 32 04 2C     	ld (proc_play_ay_slot2),a ;запомнить страницы с музыкой
1587  046F 3A 18 2C     	ld a,(page_slot3_cur)
1588  0472 32 05 2C     	ld (proc_play_ay_slot3),a
1589  0475 3A 22 2C     	ld a,(proc_id_cur) ;код процесса, который играет музыку
1590  0478 32 03 2C     	ld (proc_play_ay),a
1591  047B C9           	ret
1592  047C
1593  047C              set_VTPL_MUTE ;остановить плеер AY
1594  047C AF           	xor a
1595  047D 32 03 2C     	ld (proc_play_ay),a
1596  0480 C3 3D 17     	jp VTPL.MUTE
1597  0483
1598  0483
1599  0483              get_VTPL_SETUP ;получить адрес переменной плеера
1600  0483 21 18 17     	ld hl,VTPL.SETUP
1601  0486 C9           	ret
1602  0487
1603  0487
1604  0487              get_proc_page ;получить номера страниц процесса
1605  0487              	;вых: BC - страницы в слоте 2, 3
1606  0487 3A 17 2C     	ld a,(page_slot2_cur)
1607  048A 47           	ld b,a
1608  048B 3A 18 2C     	ld a,(page_slot3_cur)
1609  048E 4F           	ld c,a
1610  048F C9           	ret
1611  0490
1612  0490
1613  0490              set_scr ;установить активный экран
1614  0490              	;проверки
1615  0490 08           	ex af,af'
1616  0491 3A 22 2C     	ld a,(proc_id_cur)
1617  0494 21 07 2C     	ld hl,proc_id_focus
1618  0497 BE           	cp (hl)
1619  0498 20 21        	jr nz,set_scr_err
1620  049A CD CB 06     	call get_proc_descr
1621  049D 08           	ex af,af'
1622  049E DD 77 1C     	ld (ix+#1c),a ;запомнить
1623  04A1 B7           	or a
1624  04A2 20 03        	jr nz,set_scr_no_txt
1625  04A4              	;включить текстовый
1626  04A4 C3 91 0B     	jp drvgmx.set_scr39	;основной экран
1627  04A7              set_scr_no_txt
1628  04A7 FE 05        	cp #05
1629  04A9 CA 75 0B     	jp z,drvgmx.set_scr5
1630  04AC FE 07        	cp #07
1631  04AE CA 83 0B     	jp z,drvgmx.set_scr7
1632  04B1 FE 39        	cp #39
1633  04B3 CA 91 0B     	jp z,drvgmx.set_scr39
1634  04B6 FE 3A        	cp #3a
1635  04B8 CA 9F 0B     	jp z,drvgmx.set_scr3a
1636  04BB              set_scr_err
1637  04BB 37           	scf
1638  04BC C9           	ret
1639  04BD
1640  04BD              set_page_slot2	;включить страницу в слот 2 (#8000);
1641  04BD CD 32 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1642  04C0 D8           	ret c
1643  04C1 08           	ex af,af'
1644  04C2 3A 22 2C     	ld a,(proc_id_cur)
1645  04C5 CD CB 06     	call get_proc_descr
1646  04C8 08           	ex af,af'
1647  04C9 DD 77 02     	ld (ix+#02),a ;запомнить текущую страницу процесса
1648  04CC 32 17 2C     	ld (page_slot2_cur),a
1649  04CF C3 2D 0C     	jp drvgmx.PageSlot2 ;включить
1650  04D2
1651  04D2
1652  04D2              set_page_slot3	;включить страницу в слот 3 (#c000);
1653  04D2 CD 32 04     	call page_check_owner ;проверить принадлежит ли страница процессу
1654  04D5 D8           	ret c
1655  04D6 08           	ex af,af'
1656  04D7 3A 22 2C     	ld a,(proc_id_cur)
1657  04DA CD CB 06     	call get_proc_descr
1658  04DD 08           	ex af,af'
1659  04DE DD 77 03     	ld (ix+#03),a ;запомнить текущую страницу процесса
1660  04E1 32 18 2C     	ld (page_slot3_cur),a
1661  04E4 C3 4C 0B     	jp drvgmx.PageSlot3
1662  04E7
1663  04E7
1664  04E7
1665  04E7              set_interrupt ;установка адреса обработчика прерываний процесса;
1666  04E7 EB           	ex de,hl
1667  04E8 3A 22 2C     	ld a,(proc_id_cur)
1668  04EB CD CB 06     	call get_proc_descr ;узнать адрес дескриптора
1669  04EE EB           	ex de,hl
1670  04EF DD 75 0E     	ld (ix+#0e),l ;адрес
1671  04F2 DD 74 0F     	ld (ix+#0f),h ;адрес
1672  04F5 C9           	ret
1673  04F6
1674  04F6
1675  04F6
1676  04F6
1677  04F6              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; hl - строка адрес, de - строка порт
1678  04F6              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1679  04F6              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто);
1680  04F6              esp_open ;установить соединение ESP (CIPSTART);
1681  04F6 08           	ex af,af'
1682  04F7 CD 7B 05     	call esp_check_err
1683  04FA D8           	ret c
1684  04FB 08           	ex af,af'
1685  04FC FE 03        	cp 3
1686  04FE 28 21        	jr z,esp_open_direct ;для терминала
1687  0500 DD 77 0E     	ld (ix+14),a ;тип
1688  0503 D5           	push de ;сохранить порт
1689  0504 11 8F 35     	ld de,esp_link_id_table+15 ;на имя сервера
1690  0507 CD E2 05     	call copyZ ;скопировать
1691  050A 11 BB 35     	ld de,esp_link_id_table+59 ;тут адрес порта
1692  050D E1           	pop hl
1693  050E CD E2 05     	call copyZ
1694  0511 3A 22 2C     	ld a,(proc_id_cur)
1695  0514 DD 77 00     	ld (ix),a ;флаг занято
1696  0517 DD 36 02 00  	ld (ix+2),0 ;флаг результат открытия
1697  051B DD 36 01 01  	ld (ix+1),1 ;флаг запрос на открытие
1698  051F AF           	xor a
1699  0520 C9           	ret
1700  0521
1701  0521              esp_open_direct ;прямая связь с портом
1702  0521 3A 22 2C     	ld a,(proc_id_cur)
1703  0524 DD 77 00     	ld (ix),a ;флаг занято
1704  0527 AF           	xor a
1705  0528 C9           	ret
1706  0529
1707  0529              esp_open_err
1708  0529 3E FF        	ld a,255
1709  052B 37           	scf
1710  052C C9           	ret
1711  052D
1712  052D
1713  052D
1714  052D              ;вх:
1715  052D              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1716  052D              esp_close ;закрыть соединение ESP
1717  052D CD 7B 05     	call esp_check_err
1718  0530 D8           	ret c
1719  0531 AF           	xor a
1720  0532 DD 77 00     	ld (ix),a ;закрыть
1721  0535 C9           	ret
1722  0536
1723  0536
1724  0536
1725  0536
1726  0536              ;вх: hl - адрес данных, de - длина данных
1727  0536              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1728  0536              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено)
1729  0536              esp_send ;послать запрос ESP (CIPSEND);
1730  0536 CD 7B 05     	call esp_check_err
1731  0539 D8           	ret c
1732  053A D5           	push de ; длина
1733  053B C1           	pop bc
1734  053C DD 73 09     	ld (ix+9),e  ;длина
1735  053F DD 72 0A     	ld (ix+10),d
1736  0542 11 2D 36     	ld de,esp_buffer ;перенести данные в буфер отправки
1737  0545 ED B0        	ldir
1738  0547
1739  0547 DD 36 04 00  	ld (ix+4),0 ;флаг результат отправки
1740  054B DD 36 03 01  	ld (ix+3),1 ;флаг запрос отправки
1741  054F AF           	xor a
1742  0550 DD 77 06     	ld (ix+6),a ;флаг результат приёма
1743  0553 DD 77 05     	ld (ix+5),a ;флаг запрос на приём
1744  0556 C9           	ret
1745  0557
1746  0557              esp_send_err
1747  0557 3E FF        	ld a,255
1748  0559 37           	scf
1749  055A C9           	ret
1750  055B
1751  055B
1752  055B
1753  055B
1754  055B              ;вх: hl - адрес для данных
1755  055B              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1756  055B              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято)
1757  055B              esp_get ;получить пакет ESP (+IPD);
1758  055B CD 7B 05     	call esp_check_err
1759  055E D8           	ret c
1760  055F DD 75 07     	ld (ix+7),l ;адрес данных
1761  0562 DD 74 08     	ld (ix+8),h ;адрес данных
1762  0565 DD 36 06 00  	ld (ix+6),0 ;флаг результат приёма
1763  0569 DD 36 05 01  	ld (ix+5),1 ;флаг запрос на приём
1764  056D AF           	xor a
1765  056E DD 77 04     	ld (ix+4),a ;флаг результат отправки
1766  0571 DD 77 03     	ld (ix+3),a ;флаг запрос отправки
1767  0574 DD 77 09     	ld (ix+9),a  ;длина
1768  0577 DD 77 0A     	ld (ix+10),a
1769  057A C9           	ret
1770  057B
1771  057B              ;проверка есть ли порт и кто владелец в данный момент
1772  057B              esp_check_err
1773  057B DD 21 80 35  	ld ix,esp_link_id_table
1774  057F 3A 02 2C     	ld a,(uart_enable)
1775  0582 B7           	or a
1776  0583 28 0F        	jr z,esp_check_err1 ;нет порта
1777  0585 DD 7E 00     	ld a,(ix)
1778  0588 B7           	or a
1779  0589 C8           	ret z ;выход без ошибки, если никем не занят
1780  058A 3A 22 2C     	ld a,(proc_id_cur) ;проверить кто владелец соединения
1781  058D DD BE 00     	cp (ix)
1782  0590 20 02        	jr nz,esp_check_err1 ;выйти с ошибкой, если буфер занят другим
1783  0592 AF           	xor a
1784  0593 C9           	ret
1785  0594              esp_check_err1
1786  0594 3E FF        	ld a,255
1787  0596 37           	scf
1788  0597 C9           	ret
1789  0598
1790  0598
1791  0598
1792  0598              ;прочитать байт из порта uart
1793  0598              ;вх:
1794  0598              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
1795  0598              ;вых: A - считанный байт
1796  0598              uart_read ;
1797  0598 CD 7B 05     	call esp_check_err
1798  059B D8           	ret c
1799  059C              	;прочитать сразу, не через сетевой процесс
1800  059C 3E FD            ld a, Uart.LSR
1801  059E DB EF            in a, (uart_port)
1802  05A0 0F               rrca
1803  05A1 30 06        	jr nc,uart_read_err
1804  05A3 3E F8            ld a, Uart.RBR_THR
1805  05A5 DB EF            in a, (uart_port)
1806  05A7 B7           	or a ;сбросить флаг
1807  05A8 C9           	ret
1808  05A9              uart_read_err
1809  05A9 AF           	xor a
1810  05AA 37           	scf
1811  05AB C9           	ret
1812  05AC
1813  05AC
1814  05AC              ;записать байт в порт uart
1815  05AC              ;вх: A -байт
1816  05AC              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
1817  05AC              uart_write ;
1818  05AC 08           	ex af,af'
1819  05AD CD 7B 05     	call esp_check_err
1820  05B0 D8           	ret c
1821  05B1              	;записать
1822  05B1 3E FD        	ld a, Uart.LSR
1823  05B3 DB EF            in a, (uart_port)
1824  05B5 E6 20            and #20
1825  05B7 28 09            jr z,uart_write_err ;порт не готов
1826  05B9 08               ex af,af'
1827  05BA 06 F8        	ld b, Uart.RBR_THR
1828  05BC 0E EF        	ld c, uart_port
1829  05BE ED 79            out (c), a
1830  05C0 B7           	or a ;сбросить флаг
1831  05C1 C9           	ret
1832  05C2              uart_write_err
1833  05C2 37           	scf
1834  05C3 C9           	ret
1835  05C4
1836  05C4
1837  05C4              ;вх: a - id процесса куда копировать, hl - откуда, de - куда, bc - длина
1838  05C4              esp_buffer_copy ;скопировать принятое из буфера ESP
1839  05C4 D9           	exx
1840  05C5 21 00 2C     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
1841  05C8 84           	add h
1842  05C9 67           	ld h,a
1843  05CA AF           	xor a
1844  05CB B6           	or (hl)
1845  05CC C8           	ret z
1846  05CD
1847  05CD E5           	push hl
1848  05CE DD E1        	pop ix ;дескриптор процесса
1849  05D0              	;включить страницы целевого процесса
1850  05D0 DD 7E 02     	ld a,(ix+2)
1851  05D3 CD 2D 0C     	call drvgmx.PageSlot2
1852  05D6 DD 7E 03     	ld a,(ix+3)
1853  05D9 CD 4C 0B     	call drvgmx.PageSlot3
1854  05DC D9           	exx
1855  05DD
1856  05DD ED B0        	ldir
1857  05DF
1858  05DF              	;вернуть страницы
1859  05DF C3 D1 02     	jp page_cur_return
1860  05E2
1861  05E2
1862  05E2
1863  05E2
1864  05E2              ;вх: hl - откуда de - куда
1865  05E2              copyZ ;копировать данные до кода 0
1866  05E2 7E           	ld a,(hl)
1867  05E3 B7           	or a
1868  05E4 28 04        	jr z,copyZ_ex
1869  05E6 ED A0        	ldi
1870  05E8 18 F8        	jr copyZ
1871  05EA              copyZ_ex
1872  05EA AF           	xor a
1873  05EB 12           	ld (de),a  ;в конце 0
1874  05EC C9           	ret
1875  05ED
1876  05ED
1877  05ED
1878  05ED              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
1879  05ED              				;на входе в HL число
1880  05ED 11 10 27     			ld de,10000 ;десятки тысяч
1881  05F0 3E FF        			ld a,255
1882  05F2              toDecimal10k
1883  05F2 A7           			and a
1884  05F3 ED 52        			sbc hl,de
1885  05F5 3C           			inc a
1886  05F6 30 FA        			jr nc,toDecimal10k
1887  05F8 19           			add hl,de
1888  05F9 C6 30        			add a,48
1889  05FB 32 43 06     			ld (decimalS),a
1890  05FE 11 E8 03     			ld de,1000 ;тысячи
1891  0601 3E FF        			ld a,255
1892  0603              toDecimal1k
1893  0603 A7           			and a
1894  0604 ED 52        			sbc hl,de
1895  0606 3C           			inc a
1896  0607 30 FA        			jr nc,toDecimal1k
1897  0609 19           			add hl,de
1898  060A C6 30        			add a,48
1899  060C 32 44 06     			ld (decimalS+1),a
1900  060F 11 64 00     			ld de,100 ;сотни
1901  0612 3E FF        			ld a,255
1902  0614              toDecimal01k
1903  0614 A7           			and a
1904  0615 ED 52        			sbc hl,de
1905  0617 3C           			inc a
1906  0618 30 FA        			jr nc,toDecimal01k
1907  061A 19           			add hl,de
1908  061B C6 30        			add a,48
1909  061D 32 45 06     			ld (decimalS+2),a
1910  0620 11 0A 00     			ld de,10 ;десятки
1911  0623 3E FF        			ld a,255
1912  0625              toDecimal001k
1913  0625 A7           			and a
1914  0626 ED 52        			sbc hl,de
1915  0628 3C           			inc a
1916  0629 30 FA        			jr nc,toDecimal001k
1917  062B 19           			add hl,de
1918  062C C6 30        			add a,48
1919  062E 32 46 06     			ld (decimalS+3),a
1920  0631 11 01 00     			ld de,1 ;единицы
1921  0634 3E FF        			ld a,255
1922  0636              toDecimal0001k
1923  0636 A7           			and a
1924  0637 ED 52        			sbc hl,de
1925  0639 3C           			inc a
1926  063A 30 FA        			jr nc,toDecimal0001k
1927  063C 19           			add hl,de
1928  063D C6 30        			add a,48
1929  063F 32 47 06     			ld (decimalS+4),a
1930  0642
1931  0642 C9           			ret
1932  0643 00 00 00...  decimalS ds 6 ;здесь будет цифра
1933  0649
1934  0649
1935  0649
1936  0649
1937  0649              ;передача управления ОС до следующего прерывания;
1938  0649              os_wait ;
1939  0649 F5           	push af
1940  064A C5           	push bc
1941  064B D5           	push de
1942  064C E5           	push hl
1943  064D D9           	exx
1944  064E 08           	ex af,af'
1945  064F F5           	push af
1946  0650 C5           	push bc
1947  0651 D5           	push de
1948  0652 E5           	push hl
1949  0653 DD E5        	push ix
1950  0655 FD E5        	push iy
1951  0657 ED 73 0A 2C  	ld (proc_stack_addr_tmp_wait),sp ;запомнить адрес стека
1952  065B 3E 01        	ld a,1
1953  065D 32 0C 2C     	ld (os_wait_flag),a ;флаг внеочередная смена процесса
1954  0660 3A 22 2C     	ld a,(proc_id_cur)
1955  0663 CD CB 06     	call get_proc_descr
1956  0666 DD 36 1D 01  	ld (ix+#1d),1 ;флаг что процесс запросил os_wait
1957  066A C3 82 08     	jp proc_next_wait ;на следующий процесс
1958  066D
1959  066D
1960  066D
1961  066D              ;закрыть процесс
1962  066D              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
1963  066D              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
1964  066D              proc_close
1965  066D B7           	or a
1966  066E 20 03        	jr nz,proc_close_skip
1967  0670 3A 22 2C     	ld a,(proc_id_cur) ;текущий
1968  0673              proc_close_skip
1969  0673 FE 09        	cp proc_max+1 ;защита
1970  0675 D0           	ret nc
1971  0676 32 CA 06     	ld (proc_close_id_tmp),a ;запомнить
1972  0679
1973  0679 21 07 2C     	ld hl,proc_id_focus ;если он был в фокусе
1974  067C BE           	cp (hl)
1975  067D 20 05        	jr nz,proc_close_skip3
1976  067F 3E 01        	ld a,1
1977  0681 CD 3D 02     	call proc_set_focus ;сменить фокус на системный процесс
1978  0684
1979  0684              proc_close_skip3
1980  0684              ;очистить таблицу процессов
1981  0684 3A CA 06     	ld a,(proc_close_id_tmp)
1982  0687 CD CB 06     	call get_proc_descr
1983  068A 54           	ld d,h
1984  068B 5D           	ld e,l
1985  068C 13           	inc de
1986  068D 36 00        	ld (hl),0
1987  068F 01 FF 00     	ld bc,proc_descr_size-1
1988  0692 ED B0        	ldir
1989  0694
1990  0694              ;очистить таблицу памяти
1991  0694 3A CA 06     	ld a,(proc_close_id_tmp)
1992  0697 CD 1D 02     	call proc_clear_ram
1993  069A
1994  069A              ;очистить таблицу файлов FAT
1995  069A 3A CA 06     	ld a,(proc_close_id_tmp)
1996  069D CD 62 0E     	call Dos.fclose_proc_all
1997  06A0
1998  06A0              ;очистить таблицу соединений ESP
1999  06A0 3A CA 06     	ld a,(proc_close_id_tmp)
2000  06A3 21 80 35     	ld hl,esp_link_id_table
2001  06A6 BE           	cp (hl) ;id процесса совпадает?
2002  06A7 20 0A        	jr nz,proc_close_skip2
2003  06A9 54           	ld d,h
2004  06AA 5D           	ld e,l
2005  06AB 13           	inc de
2006  06AC 01 3F 00     	ld bc,esp_link_id_table_size_item-1
2007  06AF 36 00        	ld (hl),0 ;очистить
2008  06B1 ED B0        	ldir
2009  06B3              proc_close_skip2
2010  06B3
2011  06B3              ;остановить плеер
2012  06B3 3A CA 06     	ld a,(proc_close_id_tmp)
2013  06B6 21 03 2C     	ld hl,proc_play_ay
2014  06B9 BE           	cp (hl)
2015  06BA 20 03        	jr nz,proc_close_skip4
2016  06BC CD 7C 04     	call set_VTPL_MUTE
2017  06BF
2018  06BF              proc_close_skip4
2019  06BF
2020  06BF              ;выход
2021  06BF 3A CA 06     	ld a,(proc_close_id_tmp)
2022  06C2 21 22 2C     	ld hl,proc_id_cur
2023  06C5 BE           	cp (hl)
2024  06C6 C0           	ret nz ;выйти если вызывал не сам процесс
2025  06C7
2026  06C7 C3 49 06     	jp os_wait ;если вызывал закрытие сам процесс, то сразу переключиться на следующий
2027  06CA 00           proc_close_id_tmp db 0 ;временно
2028  06CB
2029  06CB
2030  06CB
2031  06CB
2032  06CB
2033  06CB              ;получить дескриптор процесса (адрес в таблице процессов)
2034  06CB              ;вх: A - id процесса
2035  06CB              ;вых: HL, IX - дескриптор
2036  06CB              get_proc_descr
2037  06CB 21 00 2C     	ld hl,proc_table - 256
2038  06CE 84           	add h
2039  06CF 67           	ld h,a
2040  06D0 E5           	push hl
2041  06D1 DD E1        	pop ix ;дескриптор
2042  06D3 C9           	ret
2043  06D4
2044  06D4
2045  06D4              ;освободить страницу памяти
2046  06D4              ;вх: a - номер страницы
2047  06D4              proc_del_ram
2048  06D4 21 AD 0B     	ld hl,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
2049  06D7 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
2050  06D9 0E 00        	ld c,0 ;счётчик
2051  06DB              proc_del_ram_cl ;
2052  06DB BE           	cp (hl) ;совпадает с номером страницы?
2053  06DC 20 10        	jr nz,proc_del_ram1
2054  06DE 21 00 35     	ld hl,proc_page_table
2055  06E1 06 00        	ld b,0
2056  06E3 09           	add hl,bc ;адрес записи
2057  06E4 3A 22 2C     	ld a,(proc_id_cur)
2058  06E7 BE           	cp (hl)
2059  06E8 20 08        	jr nz,proc_del_ram_err ;если чужая страница
2060  06EA 36 00        	ld (hl),0 ;освободить
2061  06EC B7           	or a
2062  06ED C9           	ret
2063  06EE
2064  06EE              proc_del_ram1
2065  06EE 23           	inc hl
2066  06EF 0C           	inc c
2067  06F0 10 E9        	djnz proc_del_ram_cl
2068  06F2              proc_del_ram_err
2069  06F2 37           	scf ;не нашли страницы
2070  06F3 C9           	ret
2071  06F4
2072  06F4
2073  06F4
2074  06F4
2075  06F4              ;выбор функции (вызова)
2076  06F4              function
2077  06F4 08           	ex af,af'
2078  06F5 79           	ld a,c
2079  06F6 FE 2B        	cp function_max ;проверка на общее количество
2080  06F8 38 05        	jr c,function1
2081  06FA              function_no
2082  06FA 08           	ex af,af'
2083  06FB 3E FF        	ld a,255 ;??????
2084  06FD 37           	scf
2085  06FE C9           	ret
2086  06FF              function1
2087  06FF D9           	exx
2088  0700 6F           	ld l,a
2089  0701 26 00        	ld h,0
2090  0703 29           	add hl,hl ;*2
2091  0704 01 13 07     	ld bc,function_table
2092  0707 09           	add hl,bc
2093  0708 5E           	ld e,(hl)
2094  0709 23           	inc hl
2095  070A 56           	ld d,(hl)
2096  070B 7B           	ld a,e ;временно проверка есть ли такая функция
2097  070C B2           	or d
2098  070D 28 EB        	jr z,function_no ;-^
2099  070F D5           	push de
2100  0710 D9           	exx
2101  0711 08           	ex af,af'
2102  0712 C9           	ret ;перейти по адресу функции
2103  0713
2104  0713
2105  0713              function_table ;таблица функций
2106  0713 A9 09        	dw drvgmx.cls  ; #00 (0 dec) - очистить консоль;
2107  0715 E5 09        	dw drvgmx.gotoXY ; #01 (1 dec) - установить позицию курсора в консоли
2108  0717 5B 0A        	dw drvgmx.putC ; #02 (2 dec) - печать символа в консоль;
2109  0719 F6 09        	dw drvgmx.fillLine ; #03 (3 dec) - заполнение строки одним символом
2110  071B 10 0A        	dw drvgmx.paintLine ; #04 (4 dec) - покрасить строку цветом
2111  071D 00 00        	dw 0 ;#05 (5 dec) -
2112  071F 6D 0B        	dw drvgmx.set_color ;#06 (6 dec) - установить цвет текста в консоли
2113  0721 00 00        	dw 0 ;#07 (7 dec) - ;
2114  0723 00 00        	dw 0 ;#08 (8 dec) - ;
2115  0725 50 0A        	dw drvgmx.printZ ; #09 (9 dec) - печать в консоль до кода 0
2116  0727 98 05        	dw uart_read ;#0A (10 dec) - прочитать байт из порта uart
2117  0729 AC 05        	dw uart_write ;#0B (11 dec) - записать байт в порт uart
2118  072B 2D 05        	dw esp_close ;#0C (12 dec) - закрыть соединение ESP
2119  072D F6 04        	dw esp_open ;#0D (13 dec) - установить соединение ESP (CIPSTART);
2120  072F 36 05        	dw esp_send ;#0E (14 dec) - послать запрос ESP (CIPSEND);
2121  0731 5B 05        	dw esp_get ;#0F (15 dec) - получить пакет ESP (+IPD);
2122  0733 DD 03        	dw get_c ;#10 (16 dec) - получить код нажатой клавиши;
2123  0735 DE 02        	dw proc_run ;#11 (17 dec) - запустить процесс;
2124  0737 3D 02        	dw proc_set_focus ;#12 (18 dec) - установить фокус;
2125  0739 6D 06        	dw proc_close ;#13 (19 dec)-закрыть процесс;
2126  073B E7 04        	dw set_interrupt ;#14 (20 dec) - установка адреса обработчика прерываний процесса;
2127  073D 4F 17        	dw VTPL.INIT ;#15 (21 dec) - инициализация плеера AY;
2128  073F 69 04        	dw set_VTPL_PLAY ;#16 (22 dec) - запустить плеер AY;
2129  0741 7C 04        	dw set_VTPL_MUTE ;#17 (23 dec) - заглушить плеер AY;
2130  0743 83 04        	dw get_VTPL_SETUP ;#18 (24 dec) - получить значение переменной плеера;
2131  0745 FA 03        	dw page_copy ;#19 (25 dec) - скопировать данные из страницы в страницу
2132  0747 FE 01        	dw proc_get_ram ;#1A (26 dec) - получить дополнительную страницу памяти;
2133  0749 BD 04        	dw set_page_slot2 ;#1B (27 dec) - включить страницу в слот 2 (#8000);
2134  074B D2 04        	dw set_page_slot3 ;#1C (28 dec) - включить страницу в слот 3 (#c000);
2135  074D 90 04        	dw set_scr ;#1D (29 dec) - включить экран N;
2136  074F 87 04        	dw get_proc_page ;#1E (30 dec) - получить номера страниц процесса;
2137  0751 F2 03        	dw get_timer ;#1F (31 dec) - получить значение системного таймера
2138  0753 D4 06        	dw proc_del_ram ;#20 (32 dec) - освободить страницу памяти
2139  0755 C0 0C        	dw Dos.fopen_r ;#21 (33 dec) - открыть файл для чтения или записи;
2140  0757 E3 0C        	dw Dos.fopen_c ;#22 (34 dec) - создать файл;
2141  0759 79 0E        	dw Dos.fread ;#23 (35 dec) - прочитать из файла;
2142  075B 91 0E        	dw Dos.fwrite ;#24 (36 dec) - записать в файл;
2143  075D 3F 0E        	dw Dos.fclose ;#25 (37 dec) - закрыть файл;
2144  075F D3 0E        	dw Dos.read_dir ;#26 (38 dec) - чтение секторов текущего каталога
2145  0761 E8 0E        	dw Dos.open_dir ;#27 (39 dec) - вход в каталог/выход в родительский каталог
2146  0763 0F 0F        	dw Dos.file_position ;#28 (40 dec) - установка/чтение указателя в файле
2147  0765 3B 0F        	dw Dos.find_path ;#29 (41 dec) - ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
2148  0767 56 0F        	dw Dos.get_LFN ;#2a (42 dec) - ; получение длинного имени файла
2149  0769
2150  0769
2151  0769 00 00 00...  	align 16
2152  0770              ;обработчик прерываний
2153  0770              Interrupts
2154  0770 F3           	di
2155  0771 E3           	ex (sp),hl
2156  0772 22 0E 2C     	ld (proc_stack_addr_return_tmp),hl ;запомнить откуда вызвали прерывание
2157  0775 E3           	ex (sp),hl
2158  0776 F5           	push af
2159  0777 C5           	push bc
2160  0778 D5           	push de
2161  0779 E5           	push hl
2162  077A D9           	exx
2163  077B 08           	ex af,af'
2164  077C F5           	push af
2165  077D C5           	push bc
2166  077E D5           	push de
2167  077F E5           	push hl
2168  0780 DD E5        	push ix
2169  0782 FD E5        	push iy
2170  0784 ED 73 08 2C  	ld (proc_stack_addr_tmp),sp ;запомнить адрес стека
2171  0788              	; ld a,1
2172  0788              	; out (254),a
2173  0788
2174  0788 3E 01        	ld a,1
2175  078A 32 01 2C     	ld (Interrupt_new_flag),a ;флаг что было новое прерывание
2176  078D              	;сбросить флаги os_wait, потому что произошло обычное прерывание
2177  078D AF           	xor a
2178  078E 21 1D 2D     	ld hl,proc_table+#1d
2179  0791 77           	ld (hl),a
2180  0792 24           	inc h
2181  0793 77           	ld (hl),a
2182  0794 24           	inc h
2183  0795 77           	ld (hl),a
2184  0796 24           	inc h
2185  0797 77           	ld (hl),a
2186  0798 24           	inc h
2187  0799 77           	ld (hl),a
2188  079A 24           	inc h
2189  079B 77           	ld (hl),a
2190  079C 24           	inc h
2191  079D 77           	ld (hl),a
2192  079E 24           	inc h
2193  079F 77           	ld (hl),a
2194  07A0
2195  07A0
2196  07A0
2197  07A0              ;таймер
2198  07A0 2A 24 2C     	ld hl,(sys_timer)
2199  07A3 23           	inc hl
2200  07A4 22 24 2C     	ld (sys_timer),hl
2201  07A7 7C           	ld a,h
2202  07A8 B5           	or l
2203  07A9 20 07        	jr nz,Interrupts_timer
2204  07AB 2A 26 2C     	ld hl,(sys_timer+2)
2205  07AE 23           	inc hl
2206  07AF 22 26 2C     	ld (sys_timer+2),hl
2207  07B2              Interrupts_timer
2208  07B2
2209  07B2
2210  07B2              ;опрос клавиатуры
2211  07B2 CD 00 14     	call @DriverKeyboard
2212  07B5 22 15 2C     	ld (FlgScanKeys_addr),hl ;адрес переменной
2213  07B8 CB 76        	bit 6,(hl)
2214  07BA 20 03        	jr nz,Interrupts_key1 ;если не нажата ни одна
2215  07BC 32 1D 2C     	ld (key_cur),a ;запомнить клавишу
2216  07BF              Interrupts_key1
2217  07BF
2218  07BF FE 1B        	cp proc_switch_key ;если клавиша переключения задач
2219  07C1 20 03        	jr nz,Interrupts_key_switch_no
2220  07C3 32 10 2C     	ld (key_proc_switch_flag),a ;сохранить нажатие
2221  07C6              Interrupts_key_switch_no
2222  07C6
2223  07C6 FE 07        	cp DrvKey.keyEdit
2224  07C8 20 05        	jr nz,Interrupts_key2
2225  07CA              	;переключение языка
2226  07CA 32 11 2C     	ld (key_lang_flag),a
2227  07CD 18 17        	jr Interrupts_key_ex
2228  07CF              Interrupts_key2
2229  07CF FE 06        	cp DrvKey.keyCaps
2230  07D1 20 05        	jr nz,Interrupts_key3
2231  07D3              	;переключение заглавных
2232  07D3 32 12 2C     	ld (key_caps_lock_switch_flag),a
2233  07D6 18 0E        	jr Interrupts_key_ex
2234  07D8              Interrupts_key3
2235  07D8 FE 0F        	cp DrvKey.keyDelete
2236  07DA 20 03        	jr nz,Interrupts_key4
2237  07DC              	;графическая
2238  07DC 32 13 2C     	ld (key_graph_flag),a
2239  07DF
2240  07DF              Interrupts_key4
2241  07DF FE 12        	cp 18
2242  07E1 20 03        	jr nz,Interrupts_key_ex
2243  07E3              	;sys процесс в фокус
2244  07E3 32 14 2C     	ld (key_sys_focus),a
2245  07E6
2246  07E6
2247  07E6
2248  07E6              Interrupts_key_ex
2249  07E6              	;с клавиатурой всё
2250  07E6
2251  07E6
2252  07E6
2253  07E6
2254  07E6
2255  07E6              ;определить текущие страницы памяти
2256  07E6 01 FD 7A     	ld bc,#7AFD
2257  07E9 ED 78        	in a,(c)
2258  07EB E6 7F        	and %01111111
2259  07ED 32 A5 09     	ld (Interrupts_cur_page_slot3),a
2260  07F0 01 FD 78     	ld bc,#78fd
2261  07F3 ED 78        	in a,(c)
2262  07F5 EE 02        	xor %00000010
2263  07F7 32 A4 09     	ld (Interrupts_cur_page_slot2),a
2264  07FA
2265  07FA 3A 22 2C     	ld a,(proc_id_cur) ;сохранить текущий процесс
2266  07FD 32 23 2C     	ld (proc_id_cur_tmp),a
2267  0800 ED 4B 17 2C  	ld bc,(page_slot2_cur) ;две переменные текущие страницы
2268  0804 ED 43 19 2C  	ld (page_slot2_cur_tmp),bc
2269  0808
2270  0808
2271  0808
2272  0808
2273  0808              ;плеер музыки и прочие неотложные процессы
2274  0808 3A 03 2C     	ld a,(proc_play_ay)
2275  080B B7           	or a
2276  080C 28 0F        	jr z,Interrupts_ay_skip
2277  080E 3A 04 2C     	ld a,(proc_play_ay_slot2) ;страницы с музыкой
2278  0811 CD 2D 0C     	call drvgmx.PageSlot2
2279  0814 3A 05 2C     	ld a,(proc_play_ay_slot3) ;страницы с музыкой
2280  0817 CD 4C 0B     	call drvgmx.PageSlot3
2281  081A CD 72 1F     	call VTPL.PLAY ;играть
2282  081D
2283  081D
2284  081D              Interrupts_ay_skip
2285  081D
2286  081D              	;проверить обработчики прерываний всех процессов
2287  081D 3E 01        	ld a,1 ;первый
2288  081F CD CB 06     	call get_proc_descr ;узнать адрес дескриптора
2289  0822 06 08        	ld b,proc_max ;цикл всего процессов
2290  0824              Interrupts_proc_cl
2291  0824 AF           	xor a
2292  0825 DD B6 00     	or (ix+#00) ;рабочий процесс?
2293  0828 28 32        	jr z,Interrupts_proc_cl_skip
2294  082A
2295  082A DD 7E 0E     	ld a,(ix+#0e) ;адрес
2296  082D DD B6 0F     	or (ix+#0f) ;адрес
2297  0830              	;задан адрес прерываний?
2298  0830 28 2A        	jr z,Interrupts_proc_cl_skip
2299  0832
2300  0832              	;вызов обработчика
2301  0832 DD E5        	push ix
2302  0834 C5           	push bc
2303  0835
2304  0835 DD 7E 00     	ld a,(ix+#00)
2305  0838 32 22 2C     	ld (proc_id_cur),a ;временно установить номер процесса
2306  083B
2307  083B DD 7E 02     	ld a,(ix+#02) ;страницы процесса
2308  083E 32 17 2C     	ld (page_slot2_cur),a
2309  0841 CD 2D 0C     	call drvgmx.PageSlot2
2310  0844 DD 7E 03     	ld a,(ix+#03) ;страницы процесса
2311  0847 32 18 2C     	ld (page_slot3_cur),a
2312  084A CD 4C 0B     	call drvgmx.PageSlot3
2313  084D 21 59 08     	ld hl,Interrupts_proc_cl_ret
2314  0850 E5           	push hl ;адрес возврата
2315  0851 DD 6E 0E     	ld l,(ix+#0e) ;адрес
2316  0854 DD 66 0F     	ld h,(ix+#0f) ;адрес
2317  0857 E5           	push hl ;адрес очередного обработчика
2318  0858 C9           	ret ;запустить
2319  0859
2320  0859              Interrupts_proc_cl_ret
2321  0859 C1           	pop bc
2322  085A DD E1        	pop ix
2323  085C
2324  085C              Interrupts_proc_cl_skip
2325  085C DD 24        	inc ixh ;следующий
2326  085E 10 C4        	djnz Interrupts_proc_cl
2327  0860
2328  0860
2329  0860              ;вернуть страницы
2330  0860 3A A4 09     	ld a,(Interrupts_cur_page_slot2)
2331  0863 CD 2D 0C     	call drvgmx.PageSlot2
2332  0866 3A A5 09     	ld a,(Interrupts_cur_page_slot3)
2333  0869 CD 4C 0B     	call drvgmx.PageSlot3
2334  086C
2335  086C 3A 23 2C     	ld a,(proc_id_cur_tmp) ;вернуть текущий процесс
2336  086F 32 22 2C     	ld (proc_id_cur),a
2337  0872 ED 4B 19 2C  	ld bc,(page_slot2_cur_tmp) ;две переменные текущие страницы
2338  0876 ED 43 17 2C  	ld (page_slot2_cur),bc
2339  087A
2340  087A
2341  087A
2342  087A              ;многозадачность тут
2343  087A 3A 0F 2C     	ld a,(proc_stack_addr_return_tmp+1) ;узнать адрес откуда были прерывания
2344  087D FE 40        	cp #40 ;если прерывание было в области пзу, значит работала система
2345  087F DA 21 09     	jp c,Interrupts_ex ;пропустим переключения на другие задачи
2346  0882
2347  0882              proc_next_wait	;сюда приходит после вызова OS_WAIT, мимо обработки прерывания по INT
2348  0882 CD 37 09     	call proc_next_find
2349  0885              	;jp c,Interrupts_ex ;если процесс один, то на выход
2350  0885
2351  0885              	; push hl ;дескриптор следующего
2352  0885              	; pop ix
2353  0885
2354  0885
2355  0885              	;запомнить стек предыдущего (текущего) процесса
2356  0885 3A 22 2C     	ld a,(proc_id_cur)
2357  0888 21 00 2C     	ld hl,proc_table - 256
2358  088B 84           	add h
2359  088C 67           	ld h,a
2360  088D E5           	push hl
2361  088E FD E1        	pop iy ;дескриптор предыдущего
2362  0890
2363  0890 01 06 00     	ld bc,6
2364  0893 09           	add hl,bc
2365  0894 ED 4B 08 2C  	ld bc,(proc_stack_addr_tmp)
2366  0898 3A 0C 2C     	ld a,(os_wait_flag)
2367  089B B7           	or a
2368  089C 28 08        	jr z,proc_next_wait_no
2369  089E ED 4B 0A 2C  	ld bc,(proc_stack_addr_tmp_wait) ;если в режиме вызова os_wait
2370  08A2 AF           	xor a
2371  08A3 32 0C 2C     	ld (os_wait_flag),a
2372  08A6              proc_next_wait_no
2373  08A6 71           	ld (hl),c
2374  08A7 23           	inc hl
2375  08A8 70           	ld (hl),b
2376  08A9
2377  08A9              	;запомнить координаты экрана предыдущего
2378  08A9 2A 69 0C     	ld hl,(drvgmx.col_screen)
2379  08AC FD 75 0A FD  	ld (iy+#0a),hl ;координаты
2379  08B0 74 0B
2380  08B2
2381  08B2 2A 6B 0C     	ld hl,(drvgmx.attr_screen)
2382  08B5 FD 75 0C FD  	ld (iy+#0c),hl ;атрибуты (цвет текста)
2382  08B9 74 0D
2383  08BB
2384  08BB 2A 3D 0B     	ld hl,(drvgmx.curscrl)
2385  08BE FD 75 08 FD  	ld (iy+#08),hl ;позиция скрола
2385  08C2 74 09
2386  08C4
2387  08C4
2388  08C4
2389  08C4              	;следующий
2390  08C4 DD 7E 02     	ld a,(ix+2)
2391  08C7 32 17 2C     	ld (page_slot2_cur),a ;сделать страницы текущими
2392  08CA CD 2D 0C     	call drvgmx.PageSlot2
2393  08CD DD 7E 03     	ld a,(ix+3)
2394  08D0 32 18 2C     	ld (page_slot3_cur),a
2395  08D3 CD 4C 0B     	call drvgmx.PageSlot3
2396  08D6
2397  08D6
2398  08D6              	;параметры экрана (консоли)
2399  08D6 DD 6E 0A DD  	ld hl,(ix+#0a) ;координаты
2399  08DA 66 0B
2400  08DC 22 69 0C     	ld (drvgmx.col_screen),hl
2401  08DF
2402  08DF DD 6E 0C DD  	ld hl,(ix+#0c) ;атрибуты (цвет текста)
2402  08E3 66 0D
2403  08E5 22 6B 0C     	ld (drvgmx.attr_screen),hl
2404  08E8
2405  08E8 DD 6E 08 DD  	ld hl,(ix+#08) ;позиция скрола
2405  08EC 66 09
2406  08EE 22 3D 0B     	ld (drvgmx.curscrl),hl
2407  08F1
2408  08F1
2409  08F1
2410  08F1 3A 07 2C     	ld a,(proc_id_focus) ;если это процесс в фокусе
2411  08F4 DD BE 00     	cp (ix)
2412  08F7 20 0C        	jr nz,proc_next_no_focus
2413  08F9 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
2414  08FB 32 1B 2C     	ld (con_scr_cur),a
2415  08FE 3E 79        	ld a,con_atr_real ;атрибуты реальные
2416  0900 32 1C 2C     	ld (con_atr_cur),a
2417  0903 18 0C        	jr proc_next2
2418  0905              proc_next_no_focus
2419  0905              	;если не в фокусе
2420  0905 DD 7E 04     	ld a,(ix+4) ;пиксели
2421  0908 32 1B 2C     	ld (con_scr_cur),a
2422  090B DD 7E 05     	ld a,(ix+5) ;атрибуты
2423  090E 32 1C 2C     	ld (con_atr_cur),a
2424  0911              proc_next2
2425  0911 DD 6E 06     	ld l,(ix+6) ;стек
2426  0914 DD 66 07     	ld h,(ix+7) ;стек
2427  0917 F9           	ld sp,hl
2428  0918
2429  0918 3A 1F 2C     	ld a,(proc_id_next)
2430  091B 32 22 2C     	ld (proc_id_cur),a ;сменить текущий
2431  091E
2432  091E CD 34 0B     	call drvgmx.gmxscroll ;обновить скролл
2433  0921
2434  0921              Interrupts_ex
2435  0921 AF           	xor a
2436  0922 D3 FE        	out (254),a
2437  0924 32 01 2C     	ld (Interrupt_new_flag),a ;флаг что было прерывание убрать
2438  0927 FD E1        	pop iy
2439  0929 DD E1        	pop ix
2440  092B E1           	pop hl
2441  092C D1           	pop de
2442  092D C1           	pop bc
2443  092E F1           	pop af
2444  092F D9           	exx
2445  0930 08           	ex af,af
2446  0931 E1           	pop hl
2447  0932 D1           	pop de
2448  0933 C1           	pop bc
2449  0934 F1           	pop af
2450  0935 FB           	ei
2451  0936 C9           	ret
2452  0937
2453  0937
2454  0937              	;поиск следующей задачи
2455  0937              	;вых: hl, ix - дескриптор следующего процесса
2456  0937              proc_next_find
2457  0937 3A 01 2C     	ld a,(Interrupt_new_flag) ;флаг только что было прерывание
2458  093A B7           	or a
2459  093B 28 14        	jr z,proc_next_find_no_interrupt
2460  093D              	;тут попытка первым после прерывания запустить процесс в фокусе
2461  093D 3A 00 2C     	ld a,(proc_next_find_focus_flag)
2462  0940 B7           	or a
2463  0941 20 0E        	jr nz,proc_next_find_no_interrupt ;пропустить, если уже запускали недавно, по всем процессам не прошлись
2464  0943 3A 07 2C     	ld a,(proc_id_focus)
2465  0946 32 00 2C     	ld (proc_next_find_focus_flag),a ;флаг что процесс в фокусе уже запускали
2466  0949 32 1F 2C     	ld (proc_id_next),a
2467  094C CD CB 06     	call get_proc_descr ;получить дескриптор
2468  094F B7           	or a
2469  0950 C9           	ret ;запустить его
2470  0951
2471  0951              proc_next_find_no_interrupt
2472  0951 3A 1F 2C     	ld a,(proc_id_next) ;узнать следующий
2473  0954              proc_next_find_skip
2474  0954 3C           	inc a
2475  0955 FE 09        	cp proc_max+1
2476  0957 38 02        	jr c,proc_next_find1
2477  0959 3E 01        	ld a,proc_id_system
2478  095B              proc_next_find1
2479  095B 32 1F 2C     	ld (proc_id_next),a
2480  095E
2481  095E CD CB 06     	call get_proc_descr ;получить дескриптор
2482  0961
2483  0961 DD 7E 00     	ld a,(ix)
2484  0964 B7           	or a ;нет активного процесса?
2485  0965 28 D0        	jr z,proc_next_find ;искать дальше
2486  0967
2487  0967 3A 07 2C     	ld a,(proc_id_focus)
2488  096A DD BE 00     	cp (ix)
2489  096D 20 04        	jr nz,proc_next_find2 ;если не в фокусе
2490  096F AF           	xor a ;сбросить флаг, все процессы по кругу прошли
2491  0970 32 00 2C     	ld (proc_next_find_focus_flag),a
2492  0973
2493  0973              proc_next_find2
2494  0973 DD 7E 00     	ld a,(ix)
2495  0976 FE 01        	cp 1 ;системный процесс? для него исключение, можно вызывать всегда
2496  0978 C8           	ret z
2497  0979
2498  0979 3A 07 2C     	ld a,(proc_id_focus)
2499  097C DD BE 00     	cp (ix)	;если в фокусе
2500  097F 28 B6        	jr z,proc_next_find ;искать дальше. потому что для процесса в фокусе отдельный приоритет
2501  0981
2502  0981
2503  0981              	;дополнительные проверки
2504  0981 3A 0D 2C     	ld a,(proc_next_find_skip_flag)
2505  0984 B7           	or a
2506  0985 20 14        	jr nz,proc_next_find_skip_flag_yep ;пропустить дополнительные
2507  0987
2508  0987              	;проверить было ли прерывание, чтобы не вызвать процесс второй раз
2509  0987 DD 7E 1D     	ld a,(ix+#1d) ;флаг вызова os_wait этого процесса
2510  098A B7           	or a
2511  098B 20 AA        	jr nz,proc_next_find ;искать дальше
2512  098D
2513  098D
2514  098D              	;проверить графический режим
2515  098D DD 7E 1C     	ld a,(ix+#1c) ;режим
2516  0990 B7           	or a
2517  0991 28 08        	jr z,proc_next_find_no_graph ;не графический
2518  0993              	;графический
2519  0993 3A 07 2C     	ld a,(proc_id_focus)
2520  0996 DD BE 00     	cp (ix)
2521  0999 20 9C        	jr nz,proc_next_find ;искать дальше, если он не в фокусе
2522  099B
2523  099B              proc_next_find_no_graph
2524  099B
2525  099B              proc_next_find_skip_flag_yep
2526  099B              	;нашли следующий процесс
2527  099B 3A 22 2C     	ld a,(proc_id_cur)
2528  099E BE           	cp (hl) ;если это он и был (всего один процесс)
2529  099F 37           	scf
2530  09A0 C8           	ret z
2531  09A1 7E           	ld a,(hl) ;или вернуть id слудующего
2532  09A2 B7           	or a
2533  09A3 C9           	ret
2534  09A4
2535  09A4 00           Interrupts_cur_page_slot2 db 0 ;временно
2536  09A5 00           Interrupts_cur_page_slot3 db 0 ;временно
2537  09A6
2538  09A6
2539  09A6
2540  09A6
2541  09A6
2542  09A6              	include Drv/zsgmx.asm ;драйвер экрана и памяти
# file opened: Drv/zsgmx.asm
   1+ 09A6              COLOR=1
   2+ 09A6              ;; ZS GMX screen driver (izzx)
   3+ 09A6              	define LINE_LIMIT 80
   4+ 09A6                  module drvgmx
   5+ 09A6              hsize   equ 25 ;всего строк
   6+ 09A6              scraddr equ #c000 ;адрес экрана
   7+ 09A6              scrsize equ 16000  ;размер экрана
   8+ 09A6              scrline equ 80*8   ;размер строки в байтах
   9+ 09A6
  10+ 09A6              init:
  11+ 09A6                  ; ld hl, font_file, b, Dos.FMODE_READ
  12+ 09A6                  ; call Dos.fopen
  13+ 09A6                  ; push af
  14+ 09A6                  ; ld bc, 2048, hl, font
  15+ 09A6                  ; call Dos.fread
  16+ 09A6                  ; pop af
  17+ 09A6                  ; call Dos.fclose
  18+ 09A6              	; xor a : out (#fe), a
  19+ 09A6              	; call cls
  20+ 09A6              	; ret
  21+ 09A6 CD 91 0B     	call set_scr39 ;включить экран
  22+ 09A9              cls:
  23+ 09A9 11 00 00         ld de, 0
  23+ 09AC
  24+ 09AC ED 53 3D 0B  	ld (curscrl),de ;скролл выключить
  25+ 09B0 CD 34 0B     	call gmxscroll
  26+ 09B3 11 00 00         ld de, 0
  26+ 09B6
  27+ 09B6 CD E5 09     	call gotoXY
  28+ 09B9                  ;ld a, 7 : call Memory.setPage
  29+ 09B9 3A 1B 2C     	ld a,(con_scr_cur) ;пиксели
  30+ 09BC CD 4C 0B     	call PageSlot3 ;включить страницу пикселей
  31+ 09BF AF               xor a
  31+ 09C0               ; out (#fe), a
  32+ 09C0 21 00 C0 11      ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  32+ 09C4 01 C0 01 7F
  32+ 09C8 3E 77
  32+ 09CA ED B0          ldir ;очистить
  33+ 09CC 3A 1C 2C     	ld a,(con_atr_cur) ;атрибуты
  34+ 09CF CD 4C 0B     	call PageSlot3 ;включить страницу атрибутов
  35+ 09D2 AF           	xor a ;ld a,(attr_screen) ;цвет
  36+ 09D3 21 00 C0 11  	ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  36+ 09D7 01 C0 01 7F
  36+ 09DB 3E 77
  36+ 09DD ED B0          ldir ;очистить
  37+ 09DF              	;call gmxscron ;включить расширенный экран
  38+ 09DF 3A 18 2C     	ld a,(page_slot3_cur)
  39+ 09E2 C3 4C 0B     	jp PageSlot3 ;вернуть страницу
  40+ 09E5                  ;jp Memory.setPage
  41+ 09E5
  42+ 09E5
  43+ 09E5              ; Set console coordinates
  44+ 09E5              ; d = row(0..23), e = column (0..79)
  45+ 09E5              gotoXY:
  46+ 09E5              	;rr e
  47+ 09E5              	; ld a, 0
  48+ 09E5              	; ld (half_tile_screen), a
  49+ 09E5 7A           	ld a,d ;проверка координаты строки
  50+ 09E6 FE 19        	cp hsize
  51+ 09E8 D0           	ret nc
  52+ 09E9 7B           	ld a,e ;проверка координаты столбца
  53+ 09EA FE 50        	cp 80
  54+ 09EC D0           	ret nc
  55+ 09ED ED 53 69 0C      ld (col_screen), de
  56+ 09F1 C9               ret
  57+ 09F2
  58+ 09F2              disable:
  59+ 09F2                  ; Nothing to disable
  60+ 09F2 CD 0A 0B     	call gmxscroff ;выключить расширенный экран
  61+ 09F5 C9               ret
  62+ 09F6
  63+ 09F6              ; H - line
  64+ 09F6              ; A - char
  65+ 09F6              fillLine: ;заполнение строки одним символом
  66+ 09F6 F5               push af
  67+ 09F7 54 1E 00         ld d, h, e, 0
  67+ 09FA CD E5 09       call gotoXY
  68+ 09FD F1               pop af
  69+ 09FE 21 6F 0C 11      ld hl, fill_buff, de, fill_buff + 1, bc, 80-1, (hl), a
  69+ 0A02 70 0C 01 4F
  69+ 0A06 00 77
  69+ 0A08 ED B0          ldir
  70+ 0A0A 21 6F 0C         ld hl, fill_buff
  70+ 0A0D C3 50 0A       jp printZ
  71+ 0A10
  72+ 0A10              paintLine: ;на входе в A номер строки, которую надо покрасить, B - цвет
  73+ 0A10 C5           	push bc
  74+ 0A11 47               ld b, a
  75+ 0A12 0E 00            ld c, 0
  76+ 0A14 CD C0 0A         call bc_to_attr
  77+ 0A17 E5           	push hl
  78+ 0A18 3A 1C 2C     	ld a,(con_atr_cur) ;атрибуты
  79+ 0A1B CD 4C 0B     	call PageSlot3
  80+ 0A1E E1           	pop hl
  81+ 0A1F C1           	pop bc
  82+ 0A20 78           	ld a,b;цвет
  83+ 0A21 77               ld (hl), a
  84+ 0A22 54 5D            ld de, hl
  85+ 0A24 13               inc de
  86+ 0A25 01 7F 02         ld bc, (80*8)-1
  87+ 0A28 ED B0            ldir
  88+ 0A2A 3A 18 2C         ld a,(page_slot3_cur)
  89+ 0A2D C3 4C 0B     	jp PageSlot3 ;вернуть страницу
  90+ 0A30
  91+ 0A30
  92+ 0A30              mvCR ;каретка вниз (по коду 13)
  93+ 0A30 ED 5B 69 0C  	ld de, (col_screen)
  94+ 0A34 14           	inc d ;row++
  95+ 0A35 7A           	ld a,d
  96+ 0A36 FE 19        	cp hsize ;последняя строка
  97+ 0A38 38 11        	jr c,mvCR1
  98+ 0A3A 3A 1B 2C     	ld a,(con_scr_cur) ;пиксели
  99+ 0A3D CD 4C 0B     	call PageSlot3 ;включить страницу пикселей
 100+ 0A40 CD 12 0B     	call scroll
 101+ 0A43 3A 18 2C     	ld a,(page_slot3_cur)
 102+ 0A46 CD 4C 0B     	call PageSlot3 ;вернуть страницу
 103+ 0A49 16 18        	ld d,hsize-1 ;остаться на последне строке
 104+ 0A4B              mvCR1
 105+ 0A4B 1E 00        	ld e, 0
 106+ 0A4D              	; ld a, 0
 107+ 0A4D              	; ld (half_tile_screen), a
 108+ 0A4D C3 E5 09     	jp gotoXY
 109+ 0A50
 110+ 0A50              ; Print just one symbol
 111+ 0A50              ; A - symbol
 112+ 0A50              ; putC
 113+ 0A50               	; ld hl, single_symbol_print ;single_symbol
 114+ 0A50              	; ld (hl), a
 115+ 0A50              	; ;ld a, 7 : call Memory.setPage
 116+ 0A50              	; ; ld a,(con_scr_cur) ;пиксели
 117+ 0A50              	; ; call PageSlot3
 118+ 0A50                  ; ld hl, single_symbol_print
 119+ 0A50                  ; call printL
 120+ 0A50                  ; ld a,(page_slot3_cur)
 121+ 0A50              	; jp PageSlot3 ;вернуть страницу
 122+ 0A50
 123+ 0A50              ; Put string
 124+ 0A50              ; hl - string pointer that's begins from symbol count
 125+ 0A50              printZ
 126+ 0A50 7E               ld a, (hl)
 126+ 0A51 A7             and a
 126+ 0A52 C8             ret z
 127+ 0A53 E5               push hl
 128+ 0A54 CD 5B 0A         call putC
 129+ 0A57 E1               pop hl
 130+ 0A58 23               inc hl
 131+ 0A59 18 F5            jr printZ
 132+ 0A5B
 133+ 0A5B              ; printL
 134+ 0A5B                      ; ld	a, (hl)
 135+ 0A5B              		; and	a
 136+ 0A5B              		; ret	z
 137+ 0A5B              putC
 138+ 0A5B FE 0D        		cp 13
 138+ 0A5D CA 30 0A       jp z, mvCR
 139+ 0A60 FE 0A        		cp 10
 139+ 0A62 C8            ret z ;пропустить символ
 140+ 0A63
 141+ 0A63 CD BC 0A     		call calc_addr_scr
 142+ 0A66 54           		ld d,h ;координаты экрана в DE
 143+ 0A67 5D           		ld e,l
 144+ 0A68 6F           		ld	l,a
 145+ 0A69 26 00        		ld	h,0
 146+ 0A6B 29           		add	hl,hl
 147+ 0A6C 29           		add	hl,hl
 148+ 0A6D 29           		add	hl,hl
 149+ 0A6E 01 00 24             ld      bc,font
 150+ 0A71 09                   add     hl,bc ;hl - адрес шрифта буквы
 151+ 0A72
 152+ 0A72                      ;push    de
 153+ 0A72
 154+ 0A72 3A 1B 2C     	ld a,(con_scr_cur) ;страница пиксели
 155+ 0A75 D9           	exx
 156+ 0A76 CD 4C 0B     	call PageSlot3
 157+ 0A79 D9           	exx
 158+ 0A7A D5           	push de ;сохранить адрес символа на экране
 159+ 0A7B
 160+ 0A7B 01 FF 08         ld  bc,#08ff
 161+ 0A7E              print80_1
 162+ 0A7E ED A0        	ldi ;один байт
 163+ 0A80
 164+ 0A80 E5           	push hl ;на строку пикселей вниз
 165+ 0A81 21 4F 00     	ld hl,80-1
 166+ 0A84 19           	add hl,de
 167+ 0A85 EB           	ex de,hl
 168+ 0A86 E1           	pop hl
 169+ 0A87
 170+ 0A87 10 F5        	djnz    print80_1
 171+ 0A89
 172+ 0A89
 173+ 0A89 3A 1C 2C     	ld a,(con_atr_cur) ;страница атрибуты
 174+ 0A8C CD 4C 0B     	call PageSlot3
 175+ 0A8F
 176+ 0A8F E1           	pop hl ;адрес символа на экране
 177+ 0A90
 178+ 0A90 06 08            ld      b,8
 179+ 0A92 3A 6B 0C     	ld a,(attr_screen)
 180+ 0A95 11 50 00     	ld de,80
 181+ 0A98              print80_1_attr ;теперь так же атрибуты
 182+ 0A98
 183+ 0A98 77           	ld (hl),a
 184+ 0A99 19           	add hl,de
 185+ 0A9A
 186+ 0A9A 10 FC        	djnz    print80_1_attr
 187+ 0A9C
 188+ 0A9C
 189+ 0A9C
 190+ 0A9C              ; move cursor на одну позицию вперёд
 191+ 0A9C              move_cr80
 192+ 0A9C              	;inc	de
 193+ 0A9C
 194+ 0A9C 21 69 0C     	ld	hl,col_screen
 195+ 0A9F 34           	inc	(hl) ;увеличить столбец
 196+ 0AA0 7E           	ld	a,(hl)
 197+ 0AA1
 198+ 0AA1 FE 50        	cp	80
 199+ 0AA3 38 10        	jr	c,move_cr80_01 ;на выход
 200+ 0AA5
 201+ 0AA5 AF           	xor	a
 202+ 0AA6              	;ld	(half_tile_screen),a
 203+ 0AA6 77           	ld	(hl),a
 204+ 0AA7              	;ld	c,a
 205+ 0AA7
 206+ 0AA7 23           	inc	hl ;на переменную row
 207+ 0AA8 34           	inc	(hl)
 208+ 0AA9 7E           	ld	a,(hl)
 209+ 0AAA              	;ld	b,a
 210+ 0AAA
 211+ 0AAA FE 19        	cp	hsize ;всего строк
 212+ 0AAC DA B5 0A     	jp	c,move_cr80_01
 213+ 0AAF
 214+ 0AAF 3E 18        	ld	a,hsize-1
 215+ 0AB1 77           	ld	(hl),a
 216+ 0AB2              	;ld	b,a
 217+ 0AB2
 218+ 0AB2 CD 12 0B     	call scroll ;сдвиг вверх
 219+ 0AB5              	; push	bc
 220+ 0AB5              	; call	scroll_up8
 221+ 0AB5              	; pop	bc
 222+ 0AB5
 223+ 0AB5              move_cr80_01
 224+ 0AB5              	; call	calc_addr_scr
 225+ 0AB5 3A 18 2C     	ld a,(page_slot3_cur)
 226+ 0AB8 C3 4C 0B     	jp PageSlot3 ;вернуть страницу
 227+ 0ABB C9           	ret
 228+ 0ABC
 229+ 0ABC              calc_addr_scr	;определение адреса экрана по координатам символа
 230+ 0ABC ED 4B 69 0C  	ld	bc,(col_screen)
 231+ 0AC0              bc_to_attr:
 232+ 0AC0 26 00        	ld h,0
 233+ 0AC2 68           	ld l,b ;строка
 234+ 0AC3 29           	add hl,hl ;*2
 235+ 0AC4 11 35 0C     	ld de,table_addr_scr
 236+ 0AC7 19           	add hl,de
 237+ 0AC8 5E           	ld e,(hl)
 238+ 0AC9 23           	inc hl
 239+ 0ACA 56           	ld d,(hl) ;узнали координаты строки
 240+ 0ACB 26 00        	ld h,0
 241+ 0ACD 69           	ld l,c ;колонка
 242+ 0ACE 19           	add hl,de ;узнали адрес символа
 243+ 0ACF
 244+ 0ACF ED 5B 3D 0B  	ld de,(curscrl) ;добавить аппаратный скрол
 245+ 0AD3 19           	add hl,de
 246+ 0AD4 11 80 3E     	ld de,scrsize
 247+ 0AD7 A7           	and a		;check over
 248+ 0AD8 ED 52        	sbc hl,de
 249+ 0ADA 30 01        	jr nc,calc02
 250+ 0ADC 19           	add hl,de
 251+ 0ADD              calc02:
 252+ 0ADD 11 00 C0     	ld de,scraddr  ;screen
 253+ 0AE0 19           	add hl,de
 254+ 0AE1
 255+ 0AE1              	; ld      a,b
 256+ 0AE1              	; ld      d,a
 257+ 0AE1              	; rrca
 258+ 0AE1              	; rrca
 259+ 0AE1              	; rrca
 260+ 0AE1              	; and     a,224
 261+ 0AE1              	; add     a,c
 262+ 0AE1              	; ld      e,a
 263+ 0AE1              	; ld      a,d
 264+ 0AE1              	; and     24
 265+ 0AE1              	; or      #c0
 266+ 0AE1              	; ld      d,a
 267+ 0AE1 C9           	ret
 268+ 0AE2
 269+ 0AE2
 270+ 0AE2
 271+ 0AE2              clear_line ;очистить строку
 272+ 0AE2                  ;ld b, hsize-1 ;последняя
 273+ 0AE2                  ;ld c, 0
 274+ 0AE2 CD C0 0A         call bc_to_attr ;узнать адрес
 275+ 0AE5 E5           	push hl
 276+ 0AE6 54           	ld d,h
 277+ 0AE7 5D           	ld e,l
 278+ 0AE8 13           	inc de
 279+ 0AE9 01 7F 02     	ld bc,scrline-1
 280+ 0AEC 36 00        	ld (hl),0
 281+ 0AEE ED B0        	ldir
 282+ 0AF0 3A 1C 2C     	ld a,(con_atr_cur) ;теперь страница атрибутов
 283+ 0AF3 CD 4C 0B     	call PageSlot3 ;
 284+ 0AF6 E1           	pop hl
 285+ 0AF7 54           	ld d,h
 286+ 0AF8 5D           	ld e,l
 287+ 0AF9 13           	inc de
 288+ 0AFA 01 7F 02     	ld bc,scrline-1
 289+ 0AFD              	;ld a,(con_atr_cur) ;атрибуты
 290+ 0AFD 36 00        	ld (hl),0
 291+ 0AFF ED B0        	ldir
 292+ 0B01 C9           	ret
 293+ 0B02
 294+ 0B02              gmxscron
 295+ 0B02 01 FD 7E                 ld      bc,#7efd
 296+ 0B05 3E C8                    ld      a,#c8
 297+ 0B07 ED 79                    out     (c),a
 298+ 0B09                          ; ld      bc,#7ffd
 299+ 0B09                          ; ld      a,#10    ;5 screen
 300+ 0B09                          ; out     (c),a
 301+ 0B09 C9                       ret
 302+ 0B0A
 303+ 0B0A              ; gmxscron2
 304+ 0B0A                          ; ld      bc,#7efd
 305+ 0B0A                          ; ld      a,#c8
 306+ 0B0A                          ; out     (c),a
 307+ 0B0A                          ; ld      bc,#7ffd
 308+ 0B0A                          ; ld      a,#18    ;7 screen
 309+ 0B0A                          ; out     (c),a
 310+ 0B0A                          ; ret
 311+ 0B0A
 312+ 0B0A              gmxscroff
 313+ 0B0A 01 FD 7E                 ld      bc,#7efd
 314+ 0B0D 3E C0                    ld      a,#c0
 315+ 0B0F ED 79                    out     (c),a
 316+ 0B11                          ; ld      bc,#7ffd
 317+ 0B11                          ; ld      a,#10    ;5 screen
 318+ 0B11                          ; out     (c),a
 319+ 0B11 C9                       ret
 320+ 0B12
 321+ 0B12
 322+ 0B12
 323+ 0B12
 324+ 0B12
 325+ 0B12
 326+ 0B12              scroll: ;push hl         ; скpолл экpана на стpоку ввеpх
 327+ 0B12 2A 3D 0B     	ld hl,(curscrl)	;hard scroll
 328+ 0B15 11 80 02     	ld de,scrline
 329+ 0B18 19           	add hl,de	;next line
 330+ 0B19 11 80 3E     	ld de,scrsize	;chek over 16000
 331+ 0B1C A7           	and a
 332+ 0B1D ED 52        	sbc hl,de
 333+ 0B1F 30 03        	jr nc,scrollchek
 334+ 0B21 19           	add hl,de
 335+ 0B22 18 03        	jr scrollchek1
 336+ 0B24              scrollchek:
 337+ 0B24 21 00 00     	ld hl,0
 338+ 0B27              scrollchek1:
 339+ 0B27 22 3D 0B     	ld (curscrl),hl
 340+ 0B2A CD 34 0B     	call gmxscroll
 341+ 0B2D
 342+ 0B2D 06 18            ld b,hsize-1    ;last line
 343+ 0B2F 0E 00        	ld c,0
 344+ 0B31                  ;ld a,(attr_screen) ;цвет
 345+ 0B31 C3 E2 0A         jp clear_line      ; очистка последней стpоки
 346+ 0B34                  ;ret
 347+ 0B34               ;аппаратный скрол вверх
 348+ 0B34              gmxscroll:
 349+ 0B34              ;set hard scroll
 350+ 0B34              ;in:
 351+ 0B34              ;out:
 352+ 0B34              	;push af
 353+ 0B34              	;push bc
 354+ 0B34              	;push de
 355+ 0B34 21 22 2C     	ld hl,proc_id_cur
 356+ 0B37 3A 07 2C     	ld a,(proc_id_focus)
 357+ 0B3A BE           	cp (hl)
 358+ 0B3B C0           	ret nz ;скрол меняем только когда в фокусе
 359+ 0B3C
 360+ 0B3C 11 00 00     	ld de,0
 361+ 0B3F              curscrl equ $-2 ;current hard scroll (0-15999)
 362+ 0B3F 01 FD 7A     	ld bc,07AFDh
 363+ 0B42 7B           	ld a,e
 364+ 0B43 ED 79        	out (c),a
 365+ 0B45 01 FD 7C     	ld bc,07CFDh
 366+ 0B48 7A           	ld a,d
 367+ 0B49 ED 79        	out (c),a
 368+ 0B4B              	;pop de
 369+ 0B4B              	;pop bc
 370+ 0B4B              	;pop af
 371+ 0B4B C9           	ret
 372+ 0B4C
 373+ 0B4C
 374+ 0B4C
 375+ 0B4C
 376+ 0B4C
 377+ 0B4C              PageSlot3
 378+ 0B4C              ; драйвер памяти Scorpion GMX 2Mb
 379+ 0B4C
 380+ 0B4C                       ;push hl
 381+ 0B4C                       ; ld   hl,page_table
 382+ 0B4C                       ; add  a,l
 383+ 0B4C                       ; jr   nc,PageSlot3_1
 384+ 0B4C                       ; inc  h          ;коррекция
 385+ 0B4C              ; PageSlot3_1  ld   l,a
 386+ 0B4C                       ; ld   a,(hl)
 387+ 0B4C                       ;pop  hl
 388+ 0B4C                       ;cp   #ff
 389+ 0B4C                       ;scf
 390+ 0B4C                       ;ret  z
 391+ 0B4C                       ;push bc
 392+ 0B4C F5                    push af
 393+ 0B4D 07                    rlca
 394+ 0B4E E6 10        		 and #10
 395+ 0B50 F6 01                 or  #01  ;выбор ОЗУ вместо ПЗУ
 396+ 0B52 01 FD 1F              ld   bc,#1ffd
 397+ 0B55              PageSlot3DOS
 398+ 0B55              		 ;or #00 ; #04 тут выбор ПЗУ TRDOS
 399+ 0B55 ED 79                 out  (c),a
 400+ 0B57 F1                    pop  af
 401+ 0B58 F5                    push af
 402+ 0B59 E6 07                 and  #07
 403+ 0B5B              PageSlot3Scr ;тут выбор экрана и ПЗУ
 404+ 0B5B F6 10                 or   #10 ;#0 ;#18
 405+ 0B5D 06 7F                 ld   b,#7f
 406+ 0B5F ED 79                 out  (c),a
 407+ 0B61 F1                    pop  af
 408+ 0B62 0F                    rrca
 409+ 0B63 0F                    rrca
 410+ 0B64 0F                    rrca
 411+ 0B65 0F                    rrca
 412+ 0B66 E6 07                 and  #07
 413+ 0B68 06 DF                 ld   b,#df
 414+ 0B6A ED 79                 out  (c),a
 415+ 0B6C                       ;pop  hl
 416+ 0B6C C9                    ret
 417+ 0B6D
 418+ 0B6D              set_color
 419+ 0B6D 32 6B 0C     		ld (attr_screen),a
 420+ 0B70 78           		ld a,b
 421+ 0B71 32 6C 0C     		ld (attr_screen2),a
 422+ 0B74 C9           		ret
 423+ 0B75
 424+ 0B75              set_scr5 ;включить экран 5
 425+ 0B75 CD 0A 0B     		call gmxscroff ;выключить расширенный
 426+ 0B78 3E 10        		ld a,#10
 427+ 0B7A 32 5C 0B     		ld (PageSlot3Scr+1),a
 428+ 0B7D 3A 18 2C     		ld a,(page_slot3_cur)
 429+ 0B80 C3 4C 0B     		jp PageSlot3
 430+ 0B83
 431+ 0B83
 432+ 0B83              set_scr7 ;включить экран 7
 433+ 0B83 CD 0A 0B     		call gmxscroff ;выключить расширенный
 434+ 0B86 3E 18        		ld a,#18
 435+ 0B88 32 5C 0B     		ld (PageSlot3Scr+1),a
 436+ 0B8B 3A 18 2C     		ld a,(page_slot3_cur)
 437+ 0B8E C3 4C 0B     		jp PageSlot3
 438+ 0B91
 439+ 0B91
 440+ 0B91              set_scr39 ;включить экран 39
 441+ 0B91 CD 02 0B     		call gmxscron ;выключить расширенный
 442+ 0B94 3E 10        		ld a,#10
 443+ 0B96 32 5C 0B     		ld (PageSlot3Scr+1),a
 444+ 0B99 3A 18 2C     		ld a,(page_slot3_cur)
 445+ 0B9C C3 4C 0B     		jp PageSlot3
 446+ 0B9F
 447+ 0B9F
 448+ 0B9F              set_scr3a ;включить экран 3b
 449+ 0B9F CD 02 0B     		call gmxscron ;выключить расширенный
 450+ 0BA2 3E 18        		ld a,#18
 451+ 0BA4 32 5C 0B     		ld (PageSlot3Scr+1),a
 452+ 0BA7 3A 18 2C     		ld a,(page_slot3_cur)
 453+ 0BAA C3 4C 0B     		jp PageSlot3
 454+ 0BAD
 455+ 0BAD
 456+ 0BAD
 457+ 0BAD
 458+ 0BAD
 459+ 0BAD
 460+ 0BAD              ;Таблица страниц кроме #00-#07, #39, #3a, #77-7F
 461+ 0BAD              page_table    ;db   #00,#01,#02,#03,#04,#05,#06,#07,
 462+ 0BAD 08 09        		 db	  #08,#09
 463+ 0BAF 0A 0B 0C 0D           db   #0a,#0b,#0c,#0d,#0e
 463+ 0BB3 0E
 464+ 0BB4 0F 10 11 12           db   #0f,#10,#11,#12,#13,#14
 464+ 0BB8 13 14
 465+ 0BBA 15 16 17 18           db   #15,#16,#17,#18,#19,#1a
 465+ 0BBE 19 1A
 466+ 0BC0 1B 1C 1D 1E           db   #1b,#1c,#1d,#1e,#1f,#20
 466+ 0BC4 1F 20
 467+ 0BC6 21 22 23 24           db   #21,#22,#23,#24,#25,#26
 467+ 0BCA 25 26
 468+ 0BCC 27 28 29 2A           db   #27,#28,#29,#2a,#2b,#2c
 468+ 0BD0 2B 2C
 469+ 0BD2 2D 2E 2F 30           db   #2d,#2e,#2f,#30,#31,#32
 469+ 0BD6 31 32
 470+ 0BD8 33 34 35 36           db   #33,#34,#35,#36,#37,#38
 470+ 0BDC 37 38
 471+ 0BDE 3B 3C 3D 3E           db   #3b,#3c,#3d,#3e,#3f,#40
 471+ 0BE2 3F 40
 472+ 0BE4 41 42 43 44           db   #41,#42,#43,#44,#45,#46
 472+ 0BE8 45 46
 473+ 0BEA 47 48 49 4A           db   #47,#48,#49,#4a,#4b,#4c
 473+ 0BEE 4B 4C
 474+ 0BF0
 475+ 0BF0 4D 4E 4F 50           db   #4d,#4e,#4f,#50,#51,#52
 475+ 0BF4 51 52
 476+ 0BF6 53 54 55 56           db   #53,#54,#55,#56,#57,#58
 476+ 0BFA 57 58
 477+ 0BFC 59 5A 5B 5C           db   #59,#5a,#5b,#5c,#5d,#5e
 477+ 0C00 5D 5E
 478+ 0C02 5F 60 61 62           db   #5f,#60,#61,#62,#63,#64
 478+ 0C06 63 64
 479+ 0C08 65 66 67 68           db   #65,#66,#67,#68,#69,#6a
 479+ 0C0C 69 6A
 480+ 0C0E 6B 6C 6D 6E           db   #6b,#6c,#6d,#6e,#6f,#70
 480+ 0C12 6F 70
 481+ 0C14 71 72 73 74           db   #71,#72,#73,#74,#75,#76
 481+ 0C18 75 76
 482+ 0C1A                       ;db   #77,#78,#79,#7a,#7b,#7c,#7d,#7e
 483+ 0C1A                       ;db   #7f
 484+ 0C1A              page_table_end
 485+ 0C1A 00 00 00...           ds 128-(page_table_end-page_table) ;забить остаток нулями
 486+ 0C2D
 487+ 0C2D
 488+ 0C2D
 489+ 0C2D              ;font equ #4000 ; Using ZX-Spectrum screen as font buffer
 490+ 0C2D              ;font_file db "data/font.bin", 0
 491+ 0C2D
 492+ 0C2D              PageSlot2 ;включение банка из A в слот памяти 2
 493+ 0C2D EE 02        	xor 2
 494+ 0C2F 01 FD 78     	ld bc,#78fd
 495+ 0C32 ED 79        	out (c),a
 496+ 0C34 C9           	ret
 497+ 0C35
 498+ 0C35
 499+ 0C35              table_addr_scr	;адреса строк текста
 500+ 0C35 00 00        	defw	00000h ;0
 501+ 0C37 80 02        	defw	00280h
 502+ 0C39 00 05        	defw	00500h
 503+ 0C3B 80 07        	defw	00780h
 504+ 0C3D 00 0A        	defw	00a00h
 505+ 0C3F 80 0C        	defw	00c80h
 506+ 0C41 00 0F        	defw	00f00h
 507+ 0C43 80 11        	defw	01180h
 508+ 0C45
 509+ 0C45 00 14        	defw	01400h ;8
 510+ 0C47 80 16        	defw	01680h
 511+ 0C49 00 19        	defw	01900h
 512+ 0C4B 80 1B        	defw	01b80h
 513+ 0C4D 00 1E        	defw	01e00h
 514+ 0C4F 80 20        	defw	02080h
 515+ 0C51 00 23        	defw	02300h
 516+ 0C53 80 25        	defw	02580h
 517+ 0C55
 518+ 0C55 00 28        	defw	02800h ;16
 519+ 0C57 80 2A        	defw	02a80h
 520+ 0C59 00 2D        	defw	02d00h
 521+ 0C5B 80 2F        	defw	02f80h
 522+ 0C5D 00 32        	defw	03200h
 523+ 0C5F 80 34        	defw	03480h
 524+ 0C61 00 37        	defw	03700h
 525+ 0C63 80 39        	defw	03980h
 526+ 0C65
 527+ 0C65 00 3C        	defw	03c00h ;24
 528+ 0C67 80 3E        	defw	03e80h ;25 вне экрана
 529+ 0C69
 530+ 0C69
 531+ 0C69 00           col_screen			db	0	;столбец
 532+ 0C6A 00           row_screen			db	0	;строка
 533+ 0C6B              ;half_tile_screen	db	0
 534+ 0C6B 07           attr_screen			db	07	;основной цвет
 535+ 0C6C 0C           attr_screen2		db	#c	;второй цвет
 536+ 0C6D
 537+ 0C6D
 538+ 0C6D              ;col_screen_temp			dw	0
 539+ 0C6D              ;half_tile_screen_temp	db	0
 540+ 0C6D
 541+ 0C6D 01           single_symbol_print db 1
 542+ 0C6E 00           single_symbol 		db 0
 543+ 0C6F
 544+ 0C6F 00 00 00...  fill_buff ds 80+1
 545+ 0CC0
 546+ 0CC0                  endmodule
# file closed: Drv/zsgmx.asm
2543  0CC0              	include Drv/zsfat.asm ;драйвер диска
# file opened: Drv/zsfat.asm
   1+ 0CC0              ;trdos & fat32 driver (izzx)
   2+ 0CC0                  MODULE Dos
   3+ 0CC0              ; API methods - для всех процессов
   4+ 0CC0              ;ESX_GETSETDRV = #89
   5+ 0CC0              ;ESX_FOPEN = #9A
   6+ 0CC0              ;ESX_FCLOSE = #9B
   7+ 0CC0              ;ESX_FSYNC = #9C
   8+ 0CC0              ;ESX_FREAD = #9D
   9+ 0CC0              ;ESX_FWRITE = #9E
  10+ 0CC0
  11+ 0CC0              ; File modes
  12+ 0CC0              FMODE_READ = #01
  13+ 0CC0              ;FMODE_WRITE = #06
  14+ 0CC0              FMODE_CREATE = #0E
  15+ 0CC0
  16+ 0CC0                  ; MACRO esxCall func
  17+ 0CC0                  ; rst #8 : db func
  18+ 0CC0                  ; ENDM
  19+ 0CC0
  20+ 0CC0              ;макросы только для внутренней работы самого модуля через BIOS
  21+ 0CC0              ;
  22+ 0CC0              ;R8DOS			вызов функции R8DOS
  23+ 0CC0              ;R8FAT			вызов функции R8FAT
  24+ 0CC0              ;R8DOSc			вызов функции R8DOS
  25+ 0CC0              ;
  26+ 0CC0              ;------------------------------------------------------------------------------
  27+ 0CC0              ;вызов функции R8DOS
  28+ 0CC0              ;вх: =0 номер функции
  29+ 0CC0              ;
  30+ 0CC0              	MACRO	R8DOS nFunc
  31+ 0CC0 ~            	ld	c,nFunc
  32+ 0CC0 ~            	rst	#08
  33+ 0CC0 ~            	db	#81
  34+ 0CC0              	ENDM
  35+ 0CC0
  36+ 0CC0              ;------------------------------------------------------------------------------
  37+ 0CC0              ;вызов функции R8FAT
  38+ 0CC0              ;вх: =0 номер функции
  39+ 0CC0              ;
  40+ 0CC0              	MACRO	R8FAT nFunc
  41+ 0CC0 ~            	ld	c,nFunc
  42+ 0CC0 ~            	rst	#08
  43+ 0CC0 ~            	db	#91
  44+ 0CC0              	ENDM
  45+ 0CC0
  46+ 0CC0              ;------------------------------------------------------------------------------
  47+ 0CC0              ;вызов функции R8DOS
  48+ 0CC0              ;вх: c - номер функции
  49+ 0CC0              ;
  50+ 0CC0              	MACRO	R8DOSc
  51+ 0CC0 ~            	rst	#08
  52+ 0CC0 ~            	db	#81
  53+ 0CC0              	ENDM
  54+ 0CC0
  55+ 0CC0              ;------------------------------------------------------------------------------
  56+ 0CC0              ;вызов функции #02 (FileMan) R8CONF
  57+ 0CC0              ;вх: =#00 - номер функции файл менеджера
  58+ 0CC0              ;
  59+ 0CC0              	MACRO	R8C02FM nFunct
  60+ 0CC0 ~            	ld	bc,#100*nFunct+#02
  61+ 0CC0 ~            	rst	#08
  62+ 0CC0 ~            	db	#8E
  63+ 0CC0              	ENDM
  64+ 0CC0
  65+ 0CC0              ;==============================================================================
  66+ 0CC0              r8f00_DeinitFAT		equ #00 ;деинициализация переменных раздела FAT
  67+ 0CC0              r8f01_InitFAT		equ #01 ;инициализация переменных раздела FAT, если он еще не инициализирован
  68+ 0CC0              r8f02_ReadDIR		equ #02 ;чтение секторов текущего каталога
  69+ 0CC0              r8f03_SetRoot		equ #03 ;установка корневого каталога текущим
  70+ 0CC0              r8f04_FindPath		equ #04 ;поиск файла по заданному пути в текущем каталоге со входом в подкаталоги с проверкой синтаксиса (с установкой найденного каталога текущим)
  71+ 0CC0              r8f05_OpenDir		equ #05 ;вход в каталог/выход в родительский каталог
  72+ 0CC0
  73+ 0CC0              r8f07_FileOpen		equ #07 ;открыть файл для последующих операций с ним
  74+ 0CC0              r8f08_FileRead		equ #08	;чтение данных из файла в память
  75+ 0CC0              r8f09_FileWrite		equ #09	;запись данных из памяти в файл
  76+ 0CC0
  77+ 0CC0              r8f0E_CreateFileLFN	equ #0E ;создание файла с длинным именем в текущем каталоге
  78+ 0CC0              r8f0F_CreateFileSFN	equ #0F ;создание файла с именем 8+3 в текущем каталоге	в fcb должны быть установлены: fcbName, fcbExt, fcbSize
  79+ 0CC0              r8f13_GetPath 		equ #13 ;получение текущего пути
  80+ 0CC0              r8f14_GetLFN		equ #14 ;получение длинного имени файла
  81+ 0CC0
  82+ 0CC0              r8d2D_FindPart		equ #2D ;поиск разделов FAT32 и MFS на текущем винчестере
  83+ 0CC0              r8d2E_CngHDD		equ #2E ;смена текущего винчестера
  84+ 0CC0
  85+ 0CC0              ;конец макросов BIOS
  86+ 0CC0
  87+ 0CC0              files_fat_max equ 8 ;максимальное число открытых файлов fat
  88+ 0CC0              files_trd_max equ 8 ;максимальное число открытых файлов trd
  89+ 0CC0              fcb_fat_size equ 32 ;размер дискриптора fcb
  90+ 0CC0
  91+ 0CC0
  92+ 0CC0
  93+ 0CC0              ; Returns:
  94+ 0CC0              ;  A - current drive
  95+ 0CC0              ; getDefaultDrive: ;нигде не используется
  96+ 0CC0                  ; ld a, 0 : esxCall ESX_GETSETDRV
  97+ 0CC0                  ; ret
  98+ 0CC0
  99+ 0CC0
 100+ 0CC0
 101+ 0CC0              ; Opens file on default drive
 102+ 0CC0              ; B - File mode
 103+ 0CC0              ; HL - File name
 104+ 0CC0              ; Returns:
 105+ 0CC0              ;  A - file stream id
 106+ 0CC0              ; DE, BC - File size
 107+ 0CC0              ; IX - fcb
 108+ 0CC0              ; fopen:
 109+ 0CC0                  ; ; push bc : push hl
 110+ 0CC0                  ; ; call getDefaultDrive
 111+ 0CC0                  ; ; pop ix : pop bc
 112+ 0CC0                  ; ; esxCall ESX_FOPEN
 113+ 0CC0                  ; ; ret
 114+ 0CC0              	; ld a,b
 115+ 0CC0              	; cp FMODE_READ ;если режим открытие файла
 116+ 0CC0              	; jr z,fopen_r
 117+ 0CC0              	; cp FMODE_CREATE
 118+ 0CC0              	; jr z,fopen_c ;если режим создание файла
 119+ 0CC0              	; jp file_error ;иначе выход
 120+ 0CC0
 121+ 0CC0
 122+ 0CC0              fopen_r	;открытие существующего файла на чтение
 123+ 0CC0
 124+ 0CC0 CD 06 0D     	call fopen_prep
 125+ 0CC3 DA 07 0E     	jp 	c,file_error
 126+ 0CC6
 127+ 0CC6 32 F2 0F     	ld (file_fat_id_cur),a
 128+ 0CC9
 129+ 0CC9              	;сначала сделаем текущей папку активного приложения
 130+ 0CC9 D9           	exx
 131+ 0CCA 3A 22 2C     	ld a,(proc_id_cur)
 132+ 0CCD CD FD 0E     	call calc_dir_deskr
 133+ 0CD0 EB           	ex de,hl
 134+ 0CD1 21 00 00     	ld hl,0
 135+ 0CD4                  ; hl - адрес пути (=#0000 - путь отсутствует)
 136+ 0CD4                  ; de - адрес дескриптора директории/файла
 137+ 0CD4              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 137+ 0CD4 0E 05       >	ld	c,r8f05_OpenDir
 137+ 0CD6 CF          >	rst	#08
 137+ 0CD7 91          >	db	#91
 138+ 0CD8 D9           	exx
 139+ 0CD9
 140+ 0CD9              	;ld a,(file_fat_id_cur)
 141+ 0CD9              	R8FAT r8f07_FileOpen ;открыть
 141+ 0CD9 0E 07       >	ld	c,r8f07_FileOpen
 141+ 0CDB CF          >	rst	#08
 141+ 0CDC 91          >	db	#91
 142+ 0CDD DA 07 0E     	jp 	c,file_error
 143+ 0CE0
 144+ 0CE0
 145+ 0CE0 C3 13 0D     	jp fopen_ex
 146+ 0CE3
 147+ 0CE3
 148+ 0CE3              fopen_c	;создание нового файла
 149+ 0CE3
 150+ 0CE3 CD 06 0D     	call fopen_prep
 151+ 0CE6 DA 07 0E     	jp 	c,file_error
 152+ 0CE9
 153+ 0CE9
 154+ 0CE9 32 F2 0F     	ld (file_fat_id_cur),a
 155+ 0CEC
 156+ 0CEC              	;сначала сделаем текущей папку активного приложения
 157+ 0CEC D9           	exx
 158+ 0CED 3A 22 2C     	ld a,(proc_id_cur)
 159+ 0CF0 CD FD 0E     	call calc_dir_deskr
 160+ 0CF3 EB           	ex de,hl
 161+ 0CF4 21 00 00     	ld hl,0
 162+ 0CF7                  ; hl - адрес пути (=#0000 - путь отсутствует)
 163+ 0CF7                  ; de - адрес дескриптора директории/файла
 164+ 0CF7              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 164+ 0CF7 0E 05       >	ld	c,r8f05_OpenDir
 164+ 0CF9 CF          >	rst	#08
 164+ 0CFA 91          >	db	#91
 165+ 0CFB D9           	exx
 166+ 0CFC
 167+ 0CFC              	;ld a,(file_fat_id_cur)
 168+ 0CFC              	R8FAT	r8f0E_CreateFileLFN	;создание файла
 168+ 0CFC 0E 0E       >	ld	c,r8f0E_CreateFileLFN
 168+ 0CFE CF          >	rst	#08
 168+ 0CFF 91          >	db	#91
 169+ 0D00 DA 07 0E     	jp 	c,file_error
 170+ 0D03
 171+ 0D03 C3 13 0D     	jp fopen_ex
 172+ 0D06
 173+ 0D06
 174+ 0D06              fopen_prep ;проверка перед открытием файла
 175+ 0D06 3A 9E 10     	ld a,(fs_fat_init_flag)
 176+ 0D09 B7           	or a
 177+ 0D0A 37           	scf
 178+ 0D0B C8           	ret z
 179+ 0D0C
 180+ 0D0C E5           	push hl
 181+ 0D0D CD B8 0F     	call find_empty_fcb_fat ;какой fcb свободен?
 182+ 0D10 EB           	ex de,hl ;fcb in de
 183+ 0D11 E1           	pop hl
 184+ 0D12 C9           	ret ;выйти с флагом
 185+ 0D13
 186+ 0D13
 187+ 0D13              fopen_ex
 188+ 0D13              	;успешно создали/открыли
 189+ 0D13 D5           	push de
 190+ 0D14 DD E1        	pop ix ;вернуть fcb
 191+ 0D16 21 E2 11     	ld hl,fcb_fat_table
 192+ 0D19 3A F2 0F     	ld a,(file_fat_id_cur)
 193+ 0D1C 4F           	ld c,a
 194+ 0D1D 06 00        	ld b,0
 195+ 0D1F 09           	add hl,bc
 196+ 0D20 3A 22 2C     	ld a,(proc_id_cur)
 197+ 0D23 77           	ld (hl),a ;флаг что файл открыт (id текущего процесса)
 198+ 0D24
 199+ 0D24              	;вернуть размер файла
 200+ 0D24 DD 4E 14     	ld	c,(ix+#14) ;младшие байты длины
 201+ 0D27 DD 46 15     	ld	b,(ix+#15)
 202+ 0D2A
 203+ 0D2A DD 5E 16     	ld	e,(ix+#16) ;старшие байты длины
 204+ 0D2D DD 56 17     	ld  d,(ix+#17)
 205+ 0D30
 206+ 0D30 3A F2 0F     	ld a,(file_fat_id_cur) ;вернуть id
 207+ 0D33 B7           	or a
 208+ 0D34 C9           	ret
 209+ 0D35
 210+ 0D35
 211+ 0D35
 212+ 0D35
 213+ 0D35              init_fs_fat	;инициализация файловой системы
 214+ 0D35              	; ld a,(fs_fat_init_flag) ;если в первый раз
 215+ 0D35              	; or a
 216+ 0D35              	; jr nz,init_fs_fat2
 217+ 0D35 AF           	xor a
 218+ 0D36 32 9E 10     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 219+ 0D39 3E 04        	ld a,4 ;номер дисковода по умолчанию E
 220+ 0D3B 32 5B 0F     	ld (fs_drive_number_cur),a
 221+ 0D3E CD 6B 0F     	call GetNumPart ;узнаем какая буква последняя, сколько разделов FAT
 222+ 0D41 30 0B        	jr nc,init_fs_fat_prn2
 223+ 0D43 B7           	or a
 224+ 0D44 20 08        	jr nz,init_fs_fat_prn2
 225+ 0D46 21 14 10     	ld hl,msg_fat_not_found
 226+ 0D49 CD 50 0A     	call drvgmx.printZ
 227+ 0D4C 37           	scf ;ошибка
 228+ 0D4D C9           	ret
 229+ 0D4E
 230+ 0D4E
 231+ 0D4E              init_fs_fat_prn2
 232+ 0D4E              	;печать списка разделов
 233+ 0D4E 21 F4 0F     	ld hl,msg_fat_found
 234+ 0D51 CD 50 0A     	call drvgmx.printZ
 235+ 0D54 21 5C 0F     	ld hl,typeDrive
 236+ 0D57 3A 69 0F     	ld a,(numDrives)
 237+ 0D5A 47           	ld b,a ;цикл по количеству разделов
 238+ 0D5B 0E 45        	ld c,"E" ;первая буква диска FAT
 239+ 0D5D              init_fs_fat_prn1
 240+ 0D5D C5           	push bc
 241+ 0D5E E5           	push hl
 242+ 0D5F 79           	ld a,c ;имя диска
 243+ 0D60 CD 5B 0A     	call drvgmx.putC
 244+ 0D63 3E 3A        	ld a,":" ;
 245+ 0D65 CD 5B 0A     	call drvgmx.putC
 246+ 0D68              	;тип S или H
 247+ 0D68 3E 48        	ld a,"H"
 248+ 0D6A E1           	pop hl
 249+ 0D6B E5           	push hl
 250+ 0D6C CB 5E        	bit 3,(hl) ;SD?
 251+ 0D6E 28 02        	jr z,init_fs_fat_prn3
 252+ 0D70 3E 53        	ld a,"S"
 253+ 0D72              init_fs_fat_prn3
 254+ 0D72 CD 5B 0A     	call drvgmx.putC ;первая буква
 255+ 0D75 3E 44        	ld a,"D"
 256+ 0D77 CD 5B 0A     	call drvgmx.putC ;вторая буква
 257+ 0D7A              	;номер диска
 258+ 0D7A E1           	pop hl
 259+ 0D7B E5           	push hl
 260+ 0D7C 7E           	ld a,(hl)
 261+ 0D7D E6 04        	and %00000100
 262+ 0D7F 0F           	rrca
 263+ 0D80 0F           	rrca
 264+ 0D81 C6 30        	add "0"
 265+ 0D83 CD 5B 0A     	call drvgmx.putC ;номер диска
 266+ 0D86              	;номер раздела
 267+ 0D86 3E 2C        	ld a,","
 268+ 0D88 CD 5B 0A     	call drvgmx.putC ;разделитель
 269+ 0D8B E1           	pop hl
 270+ 0D8C E5           	push hl
 271+ 0D8D 7E           	ld a,(hl)
 272+ 0D8E E6 03        	and %00000011
 273+ 0D90 C6 30        	add "0"
 274+ 0D92 CD 5B 0A     	call drvgmx.putC ;номер раздела
 275+ 0D95 3E 0D        	ld a,13 ;новая строка
 276+ 0D97 CD 5B 0A     	call drvgmx.putC
 277+ 0D9A E1           	pop hl
 278+ 0D9B 23           	inc hl
 279+ 0D9C C1           	pop bc
 280+ 0D9D 0C           	inc c
 281+ 0D9E 10 BD        	djnz init_fs_fat_prn1
 282+ 0DA0
 283+ 0DA0
 284+ 0DA0              	;поиск системы и выбор диска
 285+ 0DA0 3A 69 0F     	ld a,(numDrives)
 286+ 0DA3 DD 6F        	ld ixl,a ;цикл по количеству разделов
 287+ 0DA5 3A 5B 0F     	ld a,(fs_drive_number_cur)
 288+ 0DA8              init_fs_fat_find_os_cl
 289+ 0DA8 01 58 0F     	ld bc,typeDrive-4
 290+ 0DAB 6F           	ld l,a
 291+ 0DAC 26 00        	ld h,0
 292+ 0DAE 09           	add hl,bc
 293+ 0DAF 7E           	ld a,(hl) ;получили код раздела из списка
 294+ 0DB0
 295+ 0DB0 CD E7 0D     	call init_fs_fat_warm ;выбрать раздел
 296+ 0DB3 D8           	ret c
 297+ 0DB4
 298+ 0DB4              	;поиск пути в разделе
 299+ 0DB4 21 9F 10     	ld	hl,OS_PathFAT		;путь к каталогу системы
 300+ 0DB7 11 B2 10     	ld	de,dir_fat_deskr ;будет дескриптор системной папки
 301+ 0DBA AF           	xor	a
 302+ 0DBB 3D           	dec	a ;установить текущим
 303+ 0DBC              	R8FAT	r8f04_FindPath
 303+ 0DBC 0E 04       >	ld	c,r8f04_FindPath
 303+ 0DBE CF          >	rst	#08
 303+ 0DBF 91          >	db	#91
 304+ 0DC0 30 10        	jr nc,init_fs_fat_find_os_ok
 305+ 0DC2
 306+ 0DC2 3A 5B 0F     	ld a,(fs_drive_number_cur)
 307+ 0DC5 3C           	inc a
 308+ 0DC6 32 5B 0F     	ld (fs_drive_number_cur),a
 309+ 0DC9 DD 2D        	dec ixl
 310+ 0DCB 20 DB        	jr nz,init_fs_fat_find_os_cl
 311+ 0DCD
 312+ 0DCD
 313+ 0DCD              	;не нашли ОС
 314+ 0DCD CD 17 0E         call   file_error_print_dir_not_found ;если не нашли, файл будет в корне
 315+ 0DD0 37           	scf
 316+ 0DD1 C9           	ret
 317+ 0DD2              init_fs_fat_find_os_ok
 318+ 0DD2              	;нашли раздел с ОС
 319+ 0DD2 21 01 10     	ld hl,msg_fat_found_os
 320+ 0DD5 CD 50 0A     	call drvgmx.printZ
 321+ 0DD8 3A 5B 0F     	ld a,(fs_drive_number_cur)
 322+ 0DDB C6 41        	add a,"A"
 323+ 0DDD CD 5B 0A     	call drvgmx.putC
 324+ 0DE0 3E 0D        	ld a,13
 325+ 0DE2 CD 5B 0A     	call drvgmx.putC
 326+ 0DE5 B7           	or a
 327+ 0DE6 C9           	ret
 328+ 0DE7
 329+ 0DE7
 330+ 0DE7              init_fs_fat_warm
 331+ 0DE7              ;переинициализация FAT раздела, когда разделы-диски уже найдены
 332+ 0DE7              ;вх: a - код раздела
 333+ 0DE7 32 F3 0F     	ld (fs_fat_part_code_cur),a ;запомнить текущий раздел
 334+ 0DEA AF           	xor a
 335+ 0DEB 32 9E 10     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 336+ 0DEE 3A F3 0F     	ld a,(fs_fat_part_code_cur)
 337+ 0DF1
 338+ 0DF1              	; R8FAT	r8f00_DeinitFAT
 339+ 0DF1              	; jp 		c,file_error
 340+ 0DF1
 341+ 0DF1
 342+ 0DF1              	R8FAT	r8f01_InitFAT ;инициализация
 342+ 0DF1 0E 01       >	ld	c,r8f01_InitFAT
 342+ 0DF3 CF          >	rst	#08
 342+ 0DF4 91          >	db	#91
 343+ 0DF5 D2 00 0E         jp      nc,init_fs_fat3
 344+ 0DF8 21 24 10     	ld hl,msg_fat_init_error
 345+ 0DFB CD 50 0A     	call drvgmx.printZ
 346+ 0DFE 37           	scf
 347+ 0DFF C9           	ret
 348+ 0E00
 349+ 0E00              init_fs_fat3
 350+ 0E00
 351+ 0E00
 352+ 0E00              ;получить текущий путь
 353+ 0E00              	; ld	hl,#4000		;адрес буфера для размещения текущего пути (256 байт)
 354+ 0E00              	; R8FAT	r8f13_GetPath ;получить путь
 355+ 0E00
 356+ 0E00              ;init_fs_fat_ex ;выход
 357+ 0E00 3E 01        	ld a,1
 358+ 0E02 32 9E 10     	ld (fs_fat_init_flag),a
 359+ 0E05 B7           	or a
 360+ 0E06 C9           	ret
 361+ 0E07
 362+ 0E07
 363+ 0E07
 364+ 0E07
 365+ 0E07
 366+ 0E07
 367+ 0E07              file_error ;выход с ошибкой
 368+ 0E07 11 00 00     	ld de,0
 369+ 0E0A 01 00 00     	ld bc,0 ;длина 0
 370+ 0E0D 37           	scf ;ошибка
 371+ 0E0E C9           	ret
 372+ 0E0F
 373+ 0E0F              file_error_general_print ;выход с общей ошибкой и сообщением
 374+ 0E0F 21 35 10     	ld hl,msg_file_error_general
 375+ 0E12 CD 50 0A     	call drvgmx.printZ
 376+ 0E15 37           	scf ;ошибка
 377+ 0E16 C9           	ret
 378+ 0E17
 379+ 0E17              file_error_print_dir_not_found ;выход с ошибкой и сообщением
 380+ 0E17 21 86 10     	ld hl,msg_dir_not_found
 381+ 0E1A CD 50 0A     	call drvgmx.printZ
 382+ 0E1D 37           	scf ;ошибка
 383+ 0E1E C9           	ret
 384+ 0E1F
 385+ 0E1F              file_error_print_file_too_big ;выход с ошибкой и сообщением
 386+ 0E1F 21 42 10     	ld hl,msg_file_too_big
 387+ 0E22 CD 50 0A     	call drvgmx.printZ
 388+ 0E25 37           	scf ;ошибка
 389+ 0E26 C9           	ret
 390+ 0E27
 391+ 0E27              file_error_print_file_not_found ;выход с ошибкой и сообщением
 392+ 0E27 21 51 10     	ld hl,msg_file_not_found
 393+ 0E2A CD 50 0A     	call drvgmx.printZ
 394+ 0E2D 37           	scf ;ошибка
 395+ 0E2E C9           	ret
 396+ 0E2F
 397+ 0E2F              file_error_print_file_open_error ;выход с ошибкой и сообщением
 398+ 0E2F 21 62 10     	ld hl,msg_file_open_error
 399+ 0E32 CD 50 0A     	call drvgmx.printZ
 400+ 0E35 37           	scf ;ошибка
 401+ 0E36 C9           	ret
 402+ 0E37
 403+ 0E37              file_error_print_file_read_error ;выход с ошибкой и сообщением
 404+ 0E37 21 74 10     	ld hl,msg_file_read_error
 405+ 0E3A CD 50 0A     	call drvgmx.printZ
 406+ 0E3D 37           	scf ;ошибка
 407+ 0E3E C9           	ret
 408+ 0E3F
 409+ 0E3F
 410+ 0E3F
 411+ 0E3F
 412+ 0E3F              ; A - file stream id
 413+ 0E3F              fclose:
 414+ 0E3F                  ;esxCall ESX_FCLOSE
 415+ 0E3F              	; push af
 416+ 0E3F              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 417+ 0E3F              	; pop af
 418+ 0E3F              	; cp 2 ;если обычный файл
 419+ 0E3F              	; jp nz,fclose_scl
 420+ 0E3F
 421+ 0E3F              close_fcb_fat ;закрытие fcb файла по номеру
 422+ 0E3F              ;вх: a - id файла
 423+ 0E3F              	;выход hl - fcb;
 424+ 0E3F 21 00 12     	ld hl,fcb_fat
 425+ 0E42 B7           	or a
 426+ 0E43 28 07        	jr z,close_fcb_fat_ex
 427+ 0E45 47           	ld b,a
 428+ 0E46 11 20 00     	ld de,fcb_fat_size
 429+ 0E49              close_fcb_fat_cl
 430+ 0E49              	;вычислить адрес fcb
 431+ 0E49 19           	add hl,de
 432+ 0E4A 10 FD        	djnz close_fcb_fat_cl
 433+ 0E4C              close_fcb_fat_ex
 434+ 0E4C E5           	push hl
 435+ 0E4D 54           	ld d,h ;почистить fcb
 436+ 0E4E 5D           	ld e,l
 437+ 0E4F 13           	inc de
 438+ 0E50 01 1F 00     	ld bc,fcb_fat_size-1
 439+ 0E53 36 00        	ld (hl),0
 440+ 0E55 ED B0        	ldir
 441+ 0E57 21 E2 11     	ld hl,fcb_fat_table
 442+ 0E5A 4F           	ld c,a
 443+ 0E5B 06 00        	ld b,0
 444+ 0E5D 09           	add hl,bc
 445+ 0E5E 36 00        	ld (hl),0 ;и флаг открытия fcb_fat_table
 446+ 0E60 E1           	pop hl
 447+ 0E61 C9           	ret
 448+ 0E62
 449+ 0E62
 450+ 0E62
 451+ 0E62              ;закрытие всех файлов процесса
 452+ 0E62              ;вх: A - id процесса
 453+ 0E62              fclose_proc_all
 454+ 0E62 21 E2 11     	ld hl,fcb_fat_table
 455+ 0E65 06 08        	ld b,files_fat_max
 456+ 0E67 0E 00        	ld c,0 ;id файла
 457+ 0E69              fclose_proc_all_cl
 458+ 0E69 BE           	cp (hl) ;совпадает с id процесса?
 459+ 0E6A 20 08        	jr nz,fclose_proc_all_skip
 460+ 0E6C F5           	push af
 461+ 0E6D 79           	ld a,c ;id файла
 462+ 0E6E D9           	exx
 463+ 0E6F CD 3F 0E     	call close_fcb_fat ;закрыть
 464+ 0E72 D9           	exx
 465+ 0E73 F1           	pop af
 466+ 0E74              fclose_proc_all_skip
 467+ 0E74 23           	inc hl
 468+ 0E75 0C           	inc c
 469+ 0E76 10 F1        	djnz fclose_proc_all_cl
 470+ 0E78 C9           	ret
 471+ 0E79
 472+ 0E79
 473+ 0E79
 474+ 0E79
 475+ 0E79
 476+ 0E79
 477+ 0E79              ; A - file stream id
 478+ 0E79              ; DE - length
 479+ 0E79              ; HL - buffer
 480+ 0E79              ; Returns
 481+ 0E79              ;  BC - length(how much was actually read)
 482+ 0E79              fread: ;(id=1)
 483+ 0E79                  ; push hl : pop ix
 484+ 0E79                  ; esxCall ESX_FREAD
 485+ 0E79
 486+ 0E79 ED 53 9C 10  	ld (file_size_tmp),de
 487+ 0E7D
 488+ 0E7D CD A9 0E     	call file_check_act ;проверка
 489+ 0E80 DA 07 0E     	jp c,file_error
 490+ 0E83
 491+ 0E83 ED 4B 9C 10  	ld bc,(file_size_tmp) ;размер
 492+ 0E87 79           	ld a,c ;ba - количество байт для чтения
 493+ 0E88
 494+ 0E88              	R8FAT r8f08_FileRead	;читать файл
 494+ 0E88 0E 08       >	ld	c,r8f08_FileRead
 494+ 0E8A CF          >	rst	#08
 494+ 0E8B 91          >	db	#91
 495+ 0E8C DA 07 0E     	jp c,file_error
 496+ 0E8F
 497+ 0E8F              	;ld bc,(file_size_tmp) ;размер
 498+ 0E8F B7           	or a
 499+ 0E90 C9           	ret
 500+ 0E91
 501+ 0E91
 502+ 0E91              ; A - file stream id
 503+ 0E91              ; DE - length
 504+ 0E91              ; HL - buffer
 505+ 0E91              ; Returns:
 506+ 0E91              ;   BC - actually written bytes
 507+ 0E91              fwrite: ;
 508+ 0E91                  ; push hl : pop ix
 509+ 0E91                  ; esxCall ESX_FWRITE
 510+ 0E91
 511+ 0E91               ;запись файла fat
 512+ 0E91 ED 53 9C 10   	ld (file_size_tmp),de
 513+ 0E95
 514+ 0E95 CD A9 0E     	call file_check_act ;проверка
 515+ 0E98 DA 07 0E     	jp c,file_error
 516+ 0E9B
 517+ 0E9B ED 4B 9C 10  	ld bc,(file_size_tmp) ;размер
 518+ 0E9F 79           	ld a,c ;ba - количество байт для записи
 519+ 0EA0
 520+ 0EA0              	R8FAT r8f09_FileWrite	;записать в файл
 520+ 0EA0 0E 09       >	ld	c,r8f09_FileWrite
 520+ 0EA2 CF          >	rst	#08
 520+ 0EA3 91          >	db	#91
 521+ 0EA4 DA 07 0E     	jp c,file_error
 522+ 0EA7
 523+ 0EA7              	;ld bc,(file_size_tmp) ;размер
 524+ 0EA7 B7           	or a
 525+ 0EA8 C9           	ret
 526+ 0EA9              ;---------------------------------------
 527+ 0EA9
 528+ 0EA9              file_check_act
 529+ 0EA9              ;проверка файла на актуальность
 530+ 0EA9              ;вых: A - id, DE - fcb
 531+ 0EA9 32 F2 0F     	ld (file_fat_id_cur),a ;сохранить id
 532+ 0EAC
 533+ 0EAC 3A 9E 10     	ld a,(fs_fat_init_flag)
 534+ 0EAF B7           	or a
 535+ 0EB0 37           	scf
 536+ 0EB1 C8           	ret z ;выход если не инициализирована ФС
 537+ 0EB2
 538+ 0EB2 E5           	push hl
 539+ 0EB3 C5           	push bc
 540+ 0EB4 3A F2 0F     	ld a,(file_fat_id_cur)
 541+ 0EB7 CD DA 0F     	call find_fcb_fat ;найти fcb
 542+ 0EBA EB           	ex de,hl ;fcb в de
 543+ 0EBB D5           	push de
 544+ 0EBC DD E1        	pop ix ;fcb
 545+ 0EBE C1           	pop bc
 546+ 0EBF 21 22 2C     	ld hl,proc_id_cur ;сравнить с кодом текущего процесса, чтобы имел доступ только к своему файлу
 547+ 0EC2 BE           	cp (hl)
 548+ 0EC3 E1           	pop hl
 549+ 0EC4 37           	scf
 550+ 0EC5 C0           	ret nz
 551+ 0EC6
 552+ 0EC6 B7           	or a
 553+ 0EC7 37           	scf
 554+ 0EC8 C8           	ret z ;выход если файл не открыт
 555+ 0EC9
 556+ 0EC9
 557+ 0EC9
 558+ 0EC9 3A F3 0F     	ld a,(fs_fat_part_code_cur) ;сравнить какой раздел у файла и какой активный
 559+ 0ECC DD BE 1F     	cp (ix+#1f)
 560+ 0ECF C4 E7 0D     	call nz,init_fs_fat_warm ;переинициировать
 561+ 0ED2 C9           	ret
 562+ 0ED3
 563+ 0ED3
 564+ 0ED3
 565+ 0ED3              ;чтение секторов текущего каталога
 566+ 0ED3              ; вх:
 567+ 0ED3                   ; hl - буфер для чтения
 568+ 0ED3                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 569+ 0ED3                   ; b - максимальное количество секторов для чтения
 570+ 0ED3              read_dir
 571+ 0ED3              	;сначала сделаем текущей папку активного приложения
 572+ 0ED3 D9           	exx
 573+ 0ED4 3A 22 2C     	ld a,(proc_id_cur)
 574+ 0ED7 CD FD 0E     	call calc_dir_deskr
 575+ 0EDA EB           	ex de,hl
 576+ 0EDB 21 00 00     	ld hl,0
 577+ 0EDE                  ; hl - адрес пути (=#0000 - путь отсутствует)
 578+ 0EDE                  ; de - адрес дескриптора директории/файла
 579+ 0EDE              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 579+ 0EDE 0E 05       >	ld	c,r8f05_OpenDir
 579+ 0EE0 CF          >	rst	#08
 579+ 0EE1 91          >	db	#91
 580+ 0EE2 D9           	exx
 581+ 0EE3
 582+ 0EE3              	;теперь запрос
 583+ 0EE3              	R8FAT r8f02_ReadDIR	;читать
 583+ 0EE3 0E 02       >	ld	c,r8f02_ReadDIR
 583+ 0EE5 CF          >	rst	#08
 583+ 0EE6 91          >	db	#91
 584+ 0EE7 C9               ret
 585+ 0EE8
 586+ 0EE8
 587+ 0EE8
 588+ 0EE8              ;вход в каталог/выход в родительский каталог
 589+ 0EE8              ; вх: hl - адрес пути (=#0000 - путь отсутствует)
 590+ 0EE8              ; de - адрес дескриптора директории/файла
 591+ 0EE8              ; вых: a - если путь был указан, новая длина пути
 592+ 0EE8              open_dir
 593+ 0EE8 D5           	push de ;дескриптор
 594+ 0EE9
 595+ 0EE9              	R8FAT r8f05_OpenDir	;открыть
 595+ 0EE9 0E 05       >	ld	c,r8f05_OpenDir
 595+ 0EEB CF          >	rst	#08
 595+ 0EEC 91          >	db	#91
 596+ 0EED
 597+ 0EED              	;скопировать дескриптор приложения
 598+ 0EED F5           	push af
 599+ 0EEE 3A 22 2C     	ld a,(proc_id_cur)
 600+ 0EF1 CD FD 0E     	call calc_dir_deskr ;узнать дескриптор
 601+ 0EF4 F1           	pop af
 602+ 0EF5 EB           	ex de,hl
 603+ 0EF6 E1           	pop hl ;дескриптор, отправленный приложеием
 604+ 0EF7 01 20 00     	ld bc,32
 605+ 0EFA ED B0        	ldir
 606+ 0EFC C9           	ret
 607+ 0EFD
 608+ 0EFD
 609+ 0EFD
 610+ 0EFD
 611+ 0EFD
 612+ 0EFD
 613+ 0EFD              calc_dir_deskr ;определяет адрес дескриптора каталога
 614+ 0EFD 21 B2 10     	ld hl,dir_fat_deskr
 615+ 0F00 B7           	or a
 616+ 0F01 28 0B        	jr z,calc_dir_deskr_ex ;на выход если 0
 617+ 0F03 FE 09        	cp proc_max+1
 618+ 0F05 30 07        	jr nc,calc_dir_deskr_ex ;защита
 619+ 0F07 11 20 00     	ld de,fcb_fat_size
 620+ 0F0A 47           	ld b,a
 621+ 0F0B              calc_dir_deskr_cl
 622+ 0F0B 19           	add hl,de
 623+ 0F0C 10 FD        	djnz calc_dir_deskr_cl
 624+ 0F0E              calc_dir_deskr_ex
 625+ 0F0E C9           	ret
 626+ 0F0F
 627+ 0F0F
 628+ 0F0F
 629+ 0F0F
 630+ 0F0F              ; A - file stream id
 631+ 0F0F              ; DE - position hi
 632+ 0F0F              ; HL - position low
 633+ 0F0F              ; Returns:
 634+ 0F0F              ;
 635+ 0F0F              file_position: ;
 636+ 0F0F              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 637+ 0F0F 38 14        	jr c,file_position_set
 638+ 0F11              	;чтение
 639+ 0F11 CD A9 0E     	call file_check_act ;проверка
 640+ 0F14 DA 07 0E     	jp c,file_error
 641+ 0F17              	;прочитаем позицию
 642+ 0F17 DD 6E 18     	ld l,(ix+#18)
 643+ 0F1A DD 66 19     	ld h,(ix+#19)
 644+ 0F1D DD 5E 1A     	ld e,(ix+#1a)
 645+ 0F20 DD 56 1B     	ld d,(ix+#1b)
 646+ 0F23 B7           	or a
 647+ 0F24 C9           	ret
 648+ 0F25
 649+ 0F25
 650+ 0F25              file_position_set
 651+ 0F25              	;установка
 652+ 0F25 D5           	push de
 653+ 0F26 CD A9 0E     	call file_check_act ;проверка
 654+ 0F29 D1           	pop de
 655+ 0F2A DA 07 0E     	jp c,file_error
 656+ 0F2D              	;установим позицию
 657+ 0F2D DD 75 18     	ld (ix+#18),l
 658+ 0F30 DD 74 19     	ld (ix+#19),h
 659+ 0F33 DD 73 1A     	ld (ix+#1a),e
 660+ 0F36 DD 72 1B     	ld (ix+#1b),d
 661+ 0F39 B7           	or a
 662+ 0F3A C9           	ret
 663+ 0F3B
 664+ 0F3B
 665+ 0F3B
 666+ 0F3B
 667+ 0F3B              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 668+ 0F3B              ;вх:   hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 669+ 0F3B              ;	  формат пути: \[DIR\DIR\..\DIR\]filename.ext
 670+ 0F3B              find_path
 671+ 0F3B              	;сначала сделаем текущей папку активного приложения
 672+ 0F3B F5           	push af
 673+ 0F3C E5           	push hl
 674+ 0F3D 3A 22 2C     	ld a,(proc_id_cur)
 675+ 0F40 CD FD 0E     	call calc_dir_deskr
 676+ 0F43 EB           	ex de,hl
 677+ 0F44 21 00 00     	ld hl,0
 678+ 0F47                  ; hl - адрес пути (=#0000 - путь отсутствует)
 679+ 0F47                  ; de - адрес дескриптора директории/файла
 680+ 0F47              	R8FAT r8f05_OpenDir	;открыть текущий каталог
 680+ 0F47 0E 05       >	ld	c,r8f05_OpenDir
 680+ 0F49 CF          >	rst	#08
 680+ 0F4A 91          >	db	#91
 681+ 0F4B
 682+ 0F4B              	R8FAT r8f03_SetRoot ;перейти в корень диска
 682+ 0F4B 0E 03       >	ld	c,r8f03_SetRoot
 682+ 0F4D CF          >	rst	#08
 682+ 0F4E 91          >	db	#91
 683+ 0F4F
 684+ 0F4F E1           	pop hl
 685+ 0F50 F1           	pop af
 686+ 0F51              	;поиск пути в разделе
 687+ 0F51              	; xor	a
 688+ 0F51              	; dec	a ;установить текущим
 689+ 0F51              	R8FAT	r8f04_FindPath
 689+ 0F51 0E 04       >	ld	c,r8f04_FindPath
 689+ 0F53 CF          >	rst	#08
 689+ 0F54 91          >	db	#91
 690+ 0F55
 691+ 0F55              ; #04(04) (FindPath) поиск файла по заданному пути в текущем каталоге со входом в
 692+ 0F55              	; подкаталоги с проверкой синтаксиса (с установкой найденного каталога
 693+ 0F55              	; текущим)
 694+ 0F55              ; вх:  c=#04(04)
 695+ 0F55                   ; hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 696+ 0F55              	  ; формат пути: \[DIR\DIR\..\DIR\]filename.ext
 697+ 0F55                   ; de - адрес буфера (#20 байт) для дескриптора найденного файла/каталога
 698+ 0F55                   ; a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 699+ 0F55
 700+ 0F55 C9           	ret
 701+ 0F56
 702+ 0F56
 703+ 0F56
 704+ 0F56
 705+ 0F56
 706+ 0F56
 707+ 0F56
 708+ 0F56
 709+ 0F56              ; получение длинного имени файла
 710+ 0F56              ;вх: hl - адрес буфера для имени
 711+ 0F56              ;    de - номер записи в текущем каталоге
 712+ 0F56              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 713+ 0F56              ; 	a - длина имени, с учетом нуля
 714+ 0F56              get_LFN
 715+ 0F56
 716+ 0F56
 717+ 0F56              	R8FAT r8f14_GetLFN
 717+ 0F56 0E 14       >	ld	c,r8f14_GetLFN
 717+ 0F58 CF          >	rst	#08
 717+ 0F59 91          >	db	#91
 718+ 0F5A              ; #14(20) (GetLFN) получение длинного имени файла
 719+ 0F5A              ; вх:  c=#14(20)
 720+ 0F5A                   ; hl - адрес буфера для имени
 721+ 0F5A                   ; de - номер записи в текущем каталоге
 722+ 0F5A              ; вых: cy=1 ошибка чтения -> a - код ошибки
 723+ 0F5A                   ; hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то
 724+ 0F5A                        ; возвращается короткое имя)
 725+ 0F5A                   ; a - длина имени, с учетом нуля
 726+ 0F5A                   ; de,bc - не определены
 727+ 0F5A
 728+ 0F5A C9           	 ret
 729+ 0F5B
 730+ 0F5B
 731+ 0F5B
 732+ 0F5B
 733+ 0F5B
 734+ 0F5B
 735+ 0F5B
 736+ 0F5B
 737+ 0F5B              ; A - file stream id
 738+ 0F5B              ; fsync:
 739+ 0F5B              ;     esxCall ESX_FSYNC
 740+ 0F5B                  ; ret
 741+ 0F5B
 742+ 0F5B
 743+ 0F5B              ; ; HL - name (name.ext)
 744+ 0F5B              ; ; Returns:
 745+ 0F5B              ; ; HL - name (name    e)
 746+ 0F5B              ; format_name ;подгоняет имя файла под стандарт trdos (8+1)
 747+ 0F5B
 748+ 0F5B              	; ;сначала попробуем убрать из пути подпапку, если она есть
 749+ 0F5B              	; ld (temp_hl),hl ;сохраним адрес исходного имени
 750+ 0F5B              	; ld b,#00 ;не больше 255 символов
 751+ 0F5B              ; format_name5
 752+ 0F5B              	; ld a,(hl)
 753+ 0F5B              	; cp "/" ;если есть подпапка
 754+ 0F5B              	; jr z,format_name_path_yep
 755+ 0F5B              	; ld a,(hl)
 756+ 0F5B              	; cp "." ;если ещё не дошли до расширения
 757+ 0F5B              	; jr nz,format_name6
 758+ 0F5B              	; ld hl,(temp_hl) ;если дошли до расширения, то путей нет, вернёмся на начало имени
 759+ 0F5B              	; jr format_name_7 ;на выход
 760+ 0F5B              ; format_name6
 761+ 0F5B              	; inc hl
 762+ 0F5B              	; djnz format_name5
 763+ 0F5B
 764+ 0F5B              ; format_name_path_yep ;нашли
 765+ 0F5B              	; inc hl ;пропустим знак "/"
 766+ 0F5B
 767+ 0F5B              ; format_name_7
 768+ 0F5B
 769+ 0F5B              	; push hl ;очистим место для нового имени
 770+ 0F5B              	; ld hl,f_name
 771+ 0F5B              	; ld de,f_name+1
 772+ 0F5B              	; ld (hl)," "
 773+ 0F5B              	; ld bc,8+1
 774+ 0F5B              	; ldir
 775+ 0F5B              	; ld (hl),0
 776+ 0F5B              	; ld bc,16-8-1-1
 777+ 0F5B              	; ldir
 778+ 0F5B              	; pop hl
 779+ 0F5B
 780+ 0F5B              	; ld bc,#09ff ;длина имени 9 символов
 781+ 0F5B              	; ld de,f_name ;куда
 782+ 0F5B              ; format_name2
 783+ 0F5B              	; ld a,(hl)
 784+ 0F5B              	; cp "."
 785+ 0F5B              	; jr nz,format_name1
 786+ 0F5B              	; ld de,f_name+8
 787+ 0F5B              	; inc hl
 788+ 0F5B              	; ldi ; и в конце расширение 3 буквы
 789+ 0F5B              	; ldi
 790+ 0F5B              	; ldi
 791+ 0F5B              	; ;ex de,hl ;сохраним адрес исходного расширения
 792+ 0F5B              	; jr format_name_e
 793+ 0F5B              ; format_name1
 794+ 0F5B              	; ldi
 795+ 0F5B              	; djnz format_name2
 796+ 0F5B
 797+ 0F5B              	; ;если имя длинное, пропустим лишнее до расширения
 798+ 0F5B              	; ld b,#00 ;не больше 255 символов
 799+ 0F5B              ; format_name3
 800+ 0F5B              	; ld a,(hl)
 801+ 0F5B              	; cp "."
 802+ 0F5B              	; jr nz,format_name4
 803+ 0F5B              	; ld de,f_name+8
 804+ 0F5B              	; inc hl
 805+ 0F5B              	; ldi ; и в конце расширение 3 буквы
 806+ 0F5B              	; ldi
 807+ 0F5B              	; ldi
 808+ 0F5B              	; ;ex de,hl ;сохраним адрес исходного расширения
 809+ 0F5B              	; jr format_name_e
 810+ 0F5B              ; format_name4
 811+ 0F5B              	; inc hl
 812+ 0F5B              	; djnz format_name3
 813+ 0F5B
 814+ 0F5B              ; format_name_e ;выход
 815+ 0F5B              	; ld hl,f_name ;вернём результат
 816+ 0F5B              	; ret
 817+ 0F5B
 818+ 0F5B              ; DE - trk/sec
 819+ 0F5B              ; B - sectors step
 820+ 0F5B              ; Returns:
 821+ 0F5B              ; DE - trk/sec
 822+ 0F5B              ; calc_next_pos		;вперёд на N секторов
 823+ 0F5B              			; ;ld b,4
 824+ 0F5B              			; ;ld  de,(#5ceb)
 825+ 0F5B              ; calc_next_pos2
 826+ 0F5B              			; inc e
 827+ 0F5B              			; ld a,e
 828+ 0F5B              			; cp 16
 829+ 0F5B              			; jr c,calc_next_pos1
 830+ 0F5B              			; inc d
 831+ 0F5B              			; ld e,0
 832+ 0F5B              ; calc_next_pos1
 833+ 0F5B              			; ;ld (#5ceb),de
 834+ 0F5B              			; djnz calc_next_pos2
 835+ 0F5B              			; ret
 836+ 0F5B
 837+ 0F5B
 838+ 0F5B              ;testt db "123.trd"
 839+ 0F5B              ; write_ima db "Select disk "
 840+ 0F5B              ; write_ima_d db "A: (E-" ;текущая буква
 841+ 0F5B              ; write_ima_e	db "D)> " ;последняя буква
 842+ 0F5B              		; db 13,10,0
 843+ 0F5B              ;prev_drive db 0 ;предыдущий номер дисковода
 844+ 0F5B 00           fs_drive_number_cur db 0 ;текущий диск/раздел
 845+ 0F5C
 846+ 0F5C              ; ; trdExt1 db ".trd", 0
 847+ 0F5C              ; ; trdExt2 db ".TRD", 0
 848+ 0F5C
 849+ 0F5C              ; ; sclExt1 db ".scl", 0
 850+ 0F5C              ; ; sclExt2 db ".SCL", 0
 851+ 0F5C
 852+ 0F5C              ; f_name ds 16 ;имя файла
 853+ 0F5C              ; f_r_cur_trk dw 	 0 ;текущие сектор-дорожка файла на чтение
 854+ 0F5C              ; f_r_len_sec db 0 ;длина файла на чтение в секторах
 855+ 0F5C              ; f_r_len dw 0;длина файла в байтах
 856+ 0F5C              ; f_r_flag db 0 ;флаг что открыт файл на чтение
 857+ 0F5C
 858+ 0F5C              ; f_w_cur_trk dw 	 0 ;текущие сектор-дорожка файла на запись
 859+ 0F5C              ; f_w_len_sec db 0 ;длина файла на запись в секторах
 860+ 0F5C              ; f_w_flag db 0 ;флаг что открыт файл на запись
 861+ 0F5C              ; f_w_len ds 4 ;длина записанных данных
 862+ 0F5C              ; write_end_flag db 0 ;флаг что нужно записать остаток
 863+ 0F5C
 864+ 0F5C              ; temp_bc dw 0 ;хранение регистра
 865+ 0F5C              ; temp_hl dw 0 ;хранение регистра
 866+ 0F5C              ; temp_hl2 dw 0 ;хранение регистра
 867+ 0F5C
 868+ 0F5C              ; sec_shift db 0 ;указатель на каком байте остановлена запись
 869+ 0F5C              ; sec_shift2 db 0 ;указатель на каком байте остановлена запись (остаток)
 870+ 0F5C              ; sec_part db 0 ;сколько секторов во второй порции для записи
 871+ 0F5C              ; sec_shift_flag db 0 ;флаг что буфер сектора не заполнен
 872+ 0F5C
 873+ 0F5C              ; ;секция scl
 874+ 0F5C              ; scl_sign db "SINCLAIR" ;метка
 875+ 0F5C              ; scl_que db 0 ;флаг запроса порции данных
 876+ 0F5C              ; scl_err db "SCL image error!",0
 877+ 0F5C              ; scl_parse_ret_adr dw 0; адрес возврата в цикл
 878+ 0F5C              ; scl_cat_cycl db 0 ;переменная цикла
 879+ 0F5C              ; scl_files db 0 ;всего файлов
 880+ 0F5C              ; scl_temp_hl dw 0;;хранение регистра
 881+ 0F5C              ; scl_temp_hl2 dw 0;
 882+ 0F5C              ; scl_temp_de dw 0;
 883+ 0F5C              ; scl_temp_bc dw 0;
 884+ 0F5C              ; cat_cur_adr dw 0;
 885+ 0F5C              ; ;scl end
 886+ 0F5C
 887+ 0F5C              ; ;секция сохранения любого файла
 888+ 0F5C              ; file_err db "Not enough space!",0
 889+ 0F5C              ; sec_cat db 0 ;сектор каталога
 890+ 0F5C              ; file_num db "0" ;номер части для больших файлов
 891+ 0F5C
 892+ 0F5C              	; ;по адресу #4000 шрифт
 893+ 0F5C              ; cat_buf equ #4800 ;буфер для кататога диска 9*256
 894+ 0F5C              ; sec_buf equ cat_buf + 9*256 ;буфер сектора для записи 256
 895+ 0F5C              ; scl_buf equ sec_buf + 512 ;промежуточный буфер 256
 896+ 0F5C              ; scl_buf2 equ scl_buf + 512 ;промежуточный буфер 256
 897+ 0F5C              ; ;общая ошибка с файлами
 898+ 0F5C              ; com_file_err db "File error!",0
 899+ 0F5C              ;com_file_err_flag db 0 ;общая ошибка
 900+ 0F5C
 901+ 0F5C
 902+ 0F5C
 903+ 0F5C
 904+ 0F5C              ;Раздел SMUC и SD ------------------------------------
 905+ 0F5C
 906+ 0F5C
 907+ 0F5C              ;список доступных разделов на винчестерах
 908+ 0F5C              ;7,=0/1 тип раздела MFS/FAT
 909+ 0F5C              ;6,=1 раздел есть
 910+ 0F5C              ;3,=0/1 Hdd/SD card
 911+ 0F5C              ;2,=0/1 для HDD master/slave
 912+ 0F5C              ;0..1,=?? номер раздела
 913+ 0F5C              ;
 914+ 0F5C 00 00 00...  typeDrive	ds 3*4+1
 915+ 0F69              ;typeDriveFAT	ds 3*4+1 ;список всех разделов FAT
 916+ 0F69 00           numDrives db 0 ;количество устройств
 917+ 0F6A              ;numDrivesFAT db 0 ;количество устройств FAT
 918+ 0F6A 00           next_lett db 0 ;следующая свободная буква диска
 919+ 0F6B
 920+ 0F6B              ;подсчет количества доступных разделов на всех устройствах
 921+ 0F6B              ;вых: hl,a - количество устройств
 922+ 0F6B              ;     typeDrives - сформированная таблица
 923+ 0F6B              ;     cy=1 не обнаружено ни одного устройства
 924+ 0F6B              ;
 925+ 0F6B              GetNumPart
 926+ 0F6B              ;
 927+ 0F6B D5           	push	de
 928+ 0F6C C5           	push	bc
 929+ 0F6D 21 5C 0F     	ld	hl,typeDrive
 930+ 0F70 E5           	push	hl
 931+ 0F71 AF           	xor	a
 932+ 0F72 CD 8C 0F     	call	proc_01			;HDD master
 933+ 0F75 3E 01        	ld	a,#01
 934+ 0F77 CD 8C 0F     	call	proc_01			;HDD slave
 935+ 0F7A 3E 02        	ld	a,#02
 936+ 0F7C CD 8C 0F     	call	proc_01			;SD card
 937+ 0F7F D1           	pop	de
 938+ 0F80 B7           	or	a
 939+ 0F81 ED 52        	sbc	hl,de			;количество разделов на HDD
 940+ 0F83              	IFDEF	useTRD
 941+ 0F83 ~            	 ld	a,l
 942+ 0F83 ~            	 add	a,#04
 943+ 0F83 ~            	 ld	l,a
 944+ 0F83              	ELSE
 945+ 0F83 7D           	 ld	a,l
 946+ 0F84              	ENDIF
 947+ 0F84 C1           	pop	bc
 948+ 0F85 D1           	pop	de
 949+ 0F86 32 69 0F     	ld	(numDrives),a
 950+ 0F89 FE 01        	cp	1
 951+ 0F8B C9           	ret
 952+ 0F8C
 953+ 0F8C              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 954+ 0F8C              ;формирование таблицы с доступными разделами на винчестере
 955+ 0F8C              ;вх:  a =#00 выбрать master
 956+ 0F8C              ;       =#01 выбрать slave
 957+ 0F8C              ;       =#02 выбрать SD card
 958+ 0F8C              ;     hl - адрес в таблице разделов typeDrives
 959+ 0F8C              ;вых: hl - новый адрес в таблице разделов typeDrives
 960+ 0F8C              ;
 961+ 0F8C 4F           proc_01	ld	c,a
 962+ 0F8D E5           	push	hl
 963+ 0F8E C5           	push	bc
 964+ 0F8F              	R8DOS	r8d2E_CngHDD
 964+ 0F8F 0E 2E       >	ld	c,r8d2E_CngHDD
 964+ 0F91 CF          >	rst	#08
 964+ 0F92 81          >	db	#81
 965+ 0F93 38 04        	jr	c,goto001		;на текущем канале нет винчестера
 966+ 0F95              	R8DOS	r8d2D_FindPart
 966+ 0F95 0E 2D       >	ld	c,r8d2D_FindPart
 966+ 0F97 CF          >	rst	#08
 966+ 0F98 81          >	db	#81
 967+ 0F99 C1           goto001	pop	bc
 968+ 0F9A E1           	pop	hl
 969+ 0F9B D8           	ret	c			;на текущем винчестере нет разделов
 970+ 0F9C 47           	ld	b,a
 971+ 0F9D 79           	ld	a,c
 972+ 0F9E 87           	add	a,a
 973+ 0F9F 87           	add	a,a
 974+ 0FA0 4F           	ld	c,a			;номер винчестера и первого раздела
 975+ 0FA1 78           	ld	a,b
 976+ 0FA2 06 04        	ld	b,#04
 977+ 0FA4 36 00        loop001	ld	(hl),#00
 978+ 0FA6 1F           	rra
 979+ 0FA7 30 0A        	jr	nc,goto002		;нет раздела
 980+ 0FA9              	IFDEF	useMFS
 981+ 0FA9 ~            	 ld	(hl),c
 982+ 0FA9 ~            	 set	6,(hl)			;=%01???hpp MFS
 983+ 0FA9 ~            	 rra
 984+ 0FA9 ~            	 jr	nc,goto003		;это MFS
 985+ 0FA9 ~            	 set	7,(hl)			;=%11???hpp это FAT
 986+ 0FA9              	ELSE
 987+ 0FA9 1F           	 rra
 988+ 0FAA 30 08        	 jr	nc,goto004		;это MFS
 989+ 0FAC 71           	 ld	(hl),c
 990+ 0FAD CB F6        	 set	6,(hl)			;раздел есть
 991+ 0FAF CB FE        	 set	7,(hl)			;=%11???hpp это FAT
 992+ 0FB1              	ENDIF
 993+ 0FB1 23           goto003	inc	hl
 994+ 0FB2 17           	rla
 995+ 0FB3 1F           goto002	rra
 996+ 0FB4 0C           goto004	inc	c
 997+ 0FB5 10 ED        	djnz	loop001
 998+ 0FB7 C9           	ret
 999+ 0FB8
1000+ 0FB8
1001+ 0FB8
1002+ 0FB8              ;конец секции SMUC и SD ----------------------------
1003+ 0FB8
1004+ 0FB8
1005+ 0FB8              find_empty_fcb_fat ;поиск свободного fcb для файла
1006+ 0FB8              	;выход hl - fcb; a - file_id
1007+ 0FB8 21 E2 11     	ld hl,fcb_fat_table
1008+ 0FBB 0E 00        	ld c,0 ;номер файла
1009+ 0FBD 06 08        	ld b,files_fat_max ;цикл
1010+ 0FBF              find_empty_fcb_fat_cl
1011+ 0FBF 7E           	ld a,(hl)
1012+ 0FC0 B7           	or a
1013+ 0FC1 28 06        	jr z,find_empty_fcb_fat_ex
1014+ 0FC3 23           	inc hl
1015+ 0FC4 0C           	inc c
1016+ 0FC5 10 F8        	djnz find_empty_fcb_fat_cl
1017+ 0FC7              	;не нашли свободного
1018+ 0FC7 37           	scf
1019+ 0FC8 C9           	ret
1020+ 0FC9              find_empty_fcb_fat_ex
1021+ 0FC9              	;вычислить адрес fcb
1022+ 0FC9 21 00 12     	ld hl,fcb_fat
1023+ 0FCC 0C           	inc c
1024+ 0FCD 0D           	dec c
1025+ 0FCE 28 07        	jr z,find_empty_fcb_fat_ex1
1026+ 0FD0 11 20 00     	ld de,fcb_fat_size
1027+ 0FD3 41           	ld b,c
1028+ 0FD4              find_empty_fcb_fat_cl2
1029+ 0FD4 19           	add hl,de
1030+ 0FD5 10 FD        	djnz find_empty_fcb_fat_cl2
1031+ 0FD7              find_empty_fcb_fat_ex1
1032+ 0FD7 79           	ld a,c ;file-id
1033+ 0FD8 B7           	or a
1034+ 0FD9 C9           	ret
1035+ 0FDA
1036+ 0FDA
1037+ 0FDA              find_fcb_fat ;поиск fcb файла по номеру
1038+ 0FDA              	;вх: a - id файла
1039+ 0FDA              	;вых: hl - fcb; a - значение из fcb_fat_table
1040+ 0FDA 21 00 12     	ld hl,fcb_fat
1041+ 0FDD B7           	or a
1042+ 0FDE 28 07        	jr z,find_fcb_fat_ex
1043+ 0FE0 47           	ld b,a
1044+ 0FE1 11 20 00     	ld de,fcb_fat_size
1045+ 0FE4              find_fcb_fat_cl
1046+ 0FE4              	;вычислить адрес fcb
1047+ 0FE4 19           	add hl,de
1048+ 0FE5 10 FD        	djnz find_fcb_fat_cl
1049+ 0FE7              find_fcb_fat_ex
1050+ 0FE7 E5           	push hl
1051+ 0FE8 21 E2 11     	ld hl,fcb_fat_table
1052+ 0FEB 4F           	ld c,a
1053+ 0FEC 06 00        	ld b,0
1054+ 0FEE 09           	add hl,bc
1055+ 0FEF 7E           	ld a,(hl) ;вернуть флаг
1056+ 0FF0 E1           	pop hl
1057+ 0FF1 C9           	ret
1058+ 0FF2
1059+ 0FF2
1060+ 0FF2
1061+ 0FF2
1062+ 0FF2
1063+ 0FF2 00           file_fat_id_cur db 0 ;текущий файл id
1064+ 0FF3 00           fs_fat_part_code_cur db 0 ;текущий раздел
1065+ 0FF4 46 6F 75 6E  msg_fat_found db "Found FAT:",13,10,0
1065+ 0FF8 64 20 46 41
1065+ 0FFC 54 3A 0D 0A
1065+ 1000 00
1066+ 1001 46 6F 75 6E  msg_fat_found_os db "Found OS on disk: ",0
1066+ 1005 64 20 4F 53
1066+ 1009 20 6F 6E 20
1066+ 100D 64 69 73 6B
1066+ 1011 3A 20 00
1067+ 1014 46 41 54 20  msg_fat_not_found db "FAT not found",13,10,0
1067+ 1018 6E 6F 74 20
1067+ 101C 66 6F 75 6E
1067+ 1020 64 0D 0A 00
1068+ 1024 46 41 54 20  msg_fat_init_error db "FAT init_error",13,10,0
1068+ 1028 69 6E 69 74
1068+ 102C 5F 65 72 72
1068+ 1030 6F 72 0D 0A
1068+ 1034 00
1069+ 1035 46 69 6C 65  msg_file_error_general db "File error",13,10,0
1069+ 1039 20 65 72 72
1069+ 103D 6F 72 0D 0A
1069+ 1041 00
1070+ 1042 46 69 6C 65  msg_file_too_big db "File too_big",13,10,0
1070+ 1046 20 74 6F 6F
1070+ 104A 5F 62 69 67
1070+ 104E 0D 0A 00
1071+ 1051 46 69 6C 65  msg_file_not_found db "File not found",13,10,0
1071+ 1055 20 6E 6F 74
1071+ 1059 20 66 6F 75
1071+ 105D 6E 64 0D 0A
1071+ 1061 00
1072+ 1062 46 69 6C 65  msg_file_open_error db "File open error",13,10,0
1072+ 1066 20 6F 70 65
1072+ 106A 6E 20 65 72
1072+ 106E 72 6F 72 0D
1072+ 1072 0A 00
1073+ 1074 46 69 6C 65  msg_file_read_error db "File read error",13,10,0
1073+ 1078 20 72 65 61
1073+ 107C 64 20 65 72
1073+ 1080 72 6F 72 0D
1073+ 1084 0A 00
1074+ 1086 44 69 72 65  msg_dir_not_found db "Directory not found",13,10,0
1074+ 108A 63 74 6F 72
1074+ 108E 79 20 6E 6F
1074+ 1092 74 20 66 6F
1074+ 1096 75 6E 64 0D
1074+ 109A 0A 00
1075+ 109C 00 00        file_size_tmp dw 0 ;временно
1076+ 109E
1077+ 109E 00           fs_fat_init_flag: db 0 ;флаг инициализации
1078+ 109F 5C 4F 53 5A  OS_PathFAT db "\\OSZ",0 ;папка ОС
1078+ 10A3 00
1079+ 10A4
1080+ 10A4 66 61 74 5F  	db "fat_dir_descr:" ;дескрипторы открытых папок fat по одной на приложение
1080+ 10A8 64 69 72 5F
1080+ 10AC 64 65 73 63
1080+ 10B0 72 3A
1081+ 10B2 00 00 00...  dir_fat_deskr ds fcb_fat_size*(proc_max+1)	;дескрипторы папок
1082+ 11D2
1083+ 11D2
1084+ 11D2 66 61 74 5F  	db "fat_files_table:"
1084+ 11D6 66 69 6C 65
1084+ 11DA 73 5F 74 61
1084+ 11DE 62 6C 65 3A
1085+ 11E2 00 00 00...  fcb_fat_table ds files_fat_max ;флаги открытия файлов
1086+ 11EA 00 00 00...  fcb_trd_table ds files_trd_max ;флаги открытия файлов
1087+ 11F2
1088+ 11F2 66 61 74 5F  	db "fat_files_fcb:"
1088+ 11F6 66 69 6C 65
1088+ 11FA 73 5F 66 63
1088+ 11FE 62 3A
1089+ 1200 00 00 00...  fcb_fat ds fcb_fat_size*files_fat_max ;для файлов fat
1090+ 1300 00 00 00...  fcb_trd ds fcb_fat_size*files_trd_max ;для файлов trd
1091+ 1400
1092+ 1400
1093+ 1400
1094+ 1400                  ENDMODULE
# file closed: Drv/zsfat.asm
2544  1400              	include Drv/DrvKey.main.a80 ;драйвер клавиатуры
# file opened: Drv/DrvKey.main.a80
   1+ 1400              ;ࠩ  
   2+ 1400              ;Driver Keyboard v2.10
   3+ 1400              ;(c) 2002-2024 LW aka PLM
   4+ 1400              ;
   5+ 1400              ;Date Creating: 10.07.2002
   6+ 1400              ;Last   Update: 17.01.2024
   7+ 1400              ;Last  Edition: 17.01.2024
   8+ 1400              ;
   9+ 1400              ;:
  10+ 1400              ;DrvKey.main.a80	-  䠩
  11+ 1400              ;DrvKey.asm.a80		- 楤
  12+ 1400              ;DrvKey.var.a80		- ६
  13+ 1400              ;DrvKey.info		- ଠ  ࠩ
  14+ 1400              ;DrvKey.lua.a80		- LUA
  15+ 1400              ;
  16+ 1400              ;------------------------------------------------------------------------------
  17+ 1400              ; 樨
  18+ 1400              ;	DEVICE 	ZXSPECTRUM128
  19+ 1400              ;	INCLUDE "DrvKey.lua.a80"
  20+ 1400              ;	PAGE	#XX
  21+ 1400              	MODULE	DrvKey
  22+ 1400
  23+ 1400              ;------------------------------------------------------------------------------
  24+ 1400              ;⠭ ࠩ
  25+ 1400
  26+ 1400              ; ᥬ஢:
  27+ 1400              AdrDrvKeyboard	equ $ ;#XXXX
  28+ 1400
  29+ 1400              ;   
  30+ 1400              keyLeft		equ #08
  31+ 1400              keyRight	equ #09
  32+ 1400              keyUp		equ #0B
  33+ 1400              keyDown		equ #0A
  34+ 1400
  35+ 1400              ;࠭ /
  36+ 1400              keyPageDown	equ #05
  37+ 1400              keyPageUp	equ #04
  38+ 1400
  39+ 1400              ;/砫 ப, insert
  40+ 1400              keyHome		equ #01
  41+ 1400              keyEnd		equ #03
  42+ 1400              keyInsert	equ #02
  43+ 1400
  44+ 1400              ;⥬ 
  45+ 1400              keyBreak	equ #18
  46+ 1400              keyEdit		equ #07
  47+ 1400              keyCaps		equ #06
  48+ 1400              keyBackSpace	equ #0C
  49+ 1400              keyDelete	equ #0F
  50+ 1400              keyEnter	equ #0D
  51+ 1400
  52+ 1400              ;CapsShift/SymbolShift   樨
  53+ 1400              keyCS		equ #1C
  54+ 1400              keySS		equ #1D
  55+ 1400              keyCsEnter	equ #19
  56+ 1400              keySsSpace	equ #1A		;tab
  57+ 1400              keySsEnter	equ #1B
  58+ 1400              keyExtMode	equ #0E
  59+ 1400
  60+ 1400              ;  ० EXT mode (cs+ss+key)
  61+ 1400              keyWordLeft	equ #10
  62+ 1400              keyWordRight	equ #11
  63+ 1400              keyGrf		equ #12
  64+ 1400              keyDelEnd	equ #13
  65+ 1400              keyDelBegin	equ #16
  66+ 1400              keyCsSsSpace	equ #14
  67+ 1400              keyCsSsEnter	equ #15
  68+ 1400              ;free code: #00,#17,#1E,#1F
  69+ 1400
  70+ 1400              ; 譨 ⠡  ᪫ 
  71+ 1400              ;OutsideGrfTable		equ #XXXX ;#0000
  72+ 1400              ;OutsideRus_jcuken	equ #XXXX ;#0000
  73+ 1400              ;OutsideRus_qwerty	equ #XXXX ;#0000
  74+ 1400
  75+ 1400              ;------------------------------------------------------------------------------
  76+ 1400              ;᫮ ࠭樨
  77+ 1400
  78+ 1400              ; ᯮ짮 /  48k
  79+ 1400              	;DEFINE	Used_ROM ;
  80+ 1400              	DEFINE	UseEXTkeys	;ᯮ짮 権 cs+ss+key
  81+ 1400              	DEFINE	CommandMode	;ᯮ짮  ०
  82+ 1400              	IFDEF	Used_ROM
  83+ 1400 ~            	UNDEFINE UseEXTkeys
  84+ 1400              	ENDIF
  85+ 1400
  86+ 1400              ;祭 ᪫ 
  87+ 1400              	DEFINE	GrfMode		;ᯮ짮 ᪫ grf
  88+ 1400              	DEFINE	RusMode		;ᯮ짮 ᪫ rus
  89+ 1400
  90+ 1400              ;祭 ⠡ ᪫
  91+ 1400              	DEFINE	TblKeyGrf_ver1
  92+ 1400              	DEFINE	Rus_jcuken
  93+ 1400              	DEFINE	Rus_qwerty
  94+ 1400
  95+ 1400              ;祭 ⠡ EXT+key (command mode)
  96+ 1400              ;  ᯮ짮 ⮫쪮 
  97+ 1400              	IFDEF	UseEXTkeys
  98+ 1400              	DEFINE	TblEXTkey_Test	;⮢ ᪫
  99+ 1400              ;	DEFINE	TblEXTkey_Word	; ZX-Word
 100+ 1400              	ENDIF
 101+ 1400
 102+ 1400              ;  ᯮ ७ ⠡ ᪫ 
 103+ 1400              	DEFINE	InsideGrfTable
 104+ 1400              	DEFINE	InsideRusTable
 105+ 1400
 106+ 1400              ;祭 㭪樨 ࠩ
 107+ 1400              ;	DEFINE  NoFuncDrvKey	; 楤 맮 㭪権 ࠩ
 108+ 1400              	DEFINE	NoCtlDrvKey	; ஢ન  ⢮ 㭪樨
 109+ 1400              	DEFINE	DrvKey_02	;⠭/祭 䫠 ࠩ
 110+ 1400              	DEFINE	DrvKey_03	;⠭ ਮ প  ⮯
 111+ 1400              	DEFINE	DrvKey_04	;祭 ਮ প  ⮯
 112+ 1400
 113+ 1400              ;------------------------------------------------------------------------------
 114+ 1400
 115+ 1400              	ORG	AdrDrvKeyboard
 116+ 1400              Start	INCLUDE	"DrvKey.asm.a80"
# file opened: Drv/DrvKey.asm.a80
   1++1400              ;楤  Keyboard Driver
   2++1400              ;䠩 DrvKey.asm.a80
   3++1400              ;
   4++1400              ;DriverKeyboard		맮 ࠩ 
   5++1400              ;FunctDrvKeyboard	맮 㭪樨 ࠩ 
   6++1400              ;GetCodesPressKey	祭  ⮩ 
   7++1400              ;GetRepeatDelays	祭 ਮ প  ⮯
   8++1400              ;SetRepeatDelays	⠭ ਮ প  ⮯
   9++1400              ;SetFlagsDriver		⠭/祭 䫠 ࠩ
  10++1400              ;ScanKeyboardDelay	   ⮬ ६ থ
  11++1400              ;ScanKeyboard		   
  12++1400              ;ScanAllKeys		   
  13++1400              ;
  14++1400              ;------------------------------------------------------------------------------
  15++1400              ;------------------------------------------------------------------------------
  16++1400              ;맮 ࠩ 
  17++1400              ;: 6,(FlgScanKeys) =1 -     
  18++1400              ;     hl=FlgScanKeys
  19++1400              ;     d - ᪠ ⮩ 
  20++1400              ;     a,e -   ⮩   ⥪饩 ᪫ 
  21++1400              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  22++1400              ;     bc -  ।
  23++1400              ;
  24++1400 C3 38 14     @DriverKeyboard		jp	ScanKeyboardDelay
  25++1403
  26++1403              ;------------------------------------------------------------------------------
  27++1403              	IFNDEF	NoFuncDrvKey
  28++1403              ;맮 㭪樨 ࠩ 
  29++1403              ;:  c -  㭪樨 [#00..#04]
  30++1403              ;     hl,de,b,a - ࠬ 㭪樨
  31++1403              ;: ॣ ⠭  ⢥⢨  뢠 㭪樥
  32++1403              ;
  33++1403              @FunctDrvKeyboard
  34++1403              ;
  35++1403              	IFDEF	NoCtlDrvKey
  36++1403 E5           	 push	hl
  37++1404 F5           	 push	af
  38++1405 78           	 ld	a,b
  39++1406 06 00        	 ld	b,#00
  40++1408 21 15 14     	 ld	hl,TableAdrFunct
  41++140B 09           	 add	hl,bc
  42++140C 09           	 add	hl,bc
  43++140D 47           	 ld	b,a
  44++140E 7E           	 ld	a,(hl)
  45++140F 23           	 inc	hl
  46++1410 66           	 ld	h,(hl)
  47++1411 6F           	 ld	l,a
  48++1412 F1           	 pop	af
  49++1413 E3           	 ex	(sp),hl
  50++1414 C9           	 ret
  51++1415              	ELSE
  52++1415 ~            	 push	hl
  53++1415 ~            	 push	af
  54++1415 ~            	 ld	a,c
  55++1415 ~            	 cp	#05
  56++1415 ~            	 jr	nc,goto017		;騩  㭪樨
  57++1415 ~            	 ld	a,b
  58++1415 ~            	 ld	hl,TableAdrFunct
  59++1415 ~            	 ld	b,#00
  60++1415 ~            	 add	hl,bc
  61++1415 ~            	 add	hl,bc
  62++1415 ~            	 ld	b,a
  63++1415 ~            	 ld	a,(hl)
  64++1415 ~            	 inc	hl
  65++1415 ~            	 ld	h,(hl)
  66++1415 ~            	 ld	l,a
  67++1415 ~            	 and	h
  68++1415 ~            	 inc	a
  69++1415 ~            	 jr	z,goto017		;㭪  
  70++1415 ~            	 pop	af
  71++1415 ~            	 ex	(sp),hl
  72++1415 ~            	 ret
  73++1415 ~            goto017	 pop	af
  74++1415 ~            	 pop	hl
  75++1415 ~            	 ret
  76++1415              	ENDIF
  77++1415
  78++1415              	ENDIF
  79++1415
  80++1415              ;------------------------------------------------------------------------------
  81++1415              TableAdrFunct	ifused
  82++1415              ;⠡ ᮢ 㭪権 ࠩ
  83++1415              ;TableAdrFunct
  84++1415              ;
  85++1415 74 14        		  dw ScanKeyboard
  86++1417 1F 14        		  dw GetCodesPressKey
  87++1419               IFDEF DrvKey_02
  87++1419 2F 14          dw SetFlagsDriver
  87++141B                 ELSE
  87++141B ~              dw #FFFF
  87++141B               ENDIF
  88++141B               IFDEF DrvKey_03
  88++141B 2A 14          dw SetRepeatDelays
  88++141D                ELSE
  88++141D ~              dw #FFFF
  88++141D               ENDIF
  89++141D               IFDEF DrvKey_04
  89++141D 25 14          dw GetRepeatDelays
  89++141F                ELSE
  89++141F ~              dw #FFFF
  89++141F               ENDIF
  90++141F              		endif
  91++141F
  92++141F              ;------------------------------------------------------------------------------
  93++141F              GetCodesPressKey	ifused
  94++141F              ;祭  ⮩ 
  95++141F              ;:  ----
  96++141F              ;: d - ᪠ ⮩ 
  97++141F              ;     a,e -   ⮩   ⥪饩 ᪫ 
  98++141F              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  99++141F              ;
 100++141F              ;GetCodesPressKey
 101++141F              ;
 102++141F ED 5B 0C 17  	ld	de,(PrintCodePresKey)
 103++1423 7B           	ld	a,e
 104++1424 C9           	ret
 105++1425
 106++1425              	endif
 107++1425
 108++1425              ;------------------------------------------------------------------------------
 109++1425              GetRepeatDelays	ifused
 110++1425              ;祭 ਮ প  ⮯
 111++1425              ;:  ----
 112++1425              ;: d - ਮ ⮯
 113++1425              ;     e - প । ⮯஬
 114++1425              ;
 115++1425              ;GetRepeatDelays
 116++1425              ;
 117++1425 ED 5B 0A 17  	ld      de,(KeyRepeatDelay)
 118++1429 C9           	ret
 119++142A
 120++142A              	endif
 121++142A
 122++142A              ;------------------------------------------------------------------------------
 123++142A              SetRepeatDelays	ifused
 124++142A              ;⠭ ਮ প  ⮯
 125++142A              ;:  d - ਮ ⮯
 126++142A              ;     e - প । ⮯஬
 127++142A              ;: ॣ  
 128++142A              ;
 129++142A              ;SetRepeatDelays
 130++142A              ;
 131++142A ED 53 0A 17  	ld	(KeyRepeatDelay),de
 132++142E C9           	ret
 133++142F
 134++142F              	endif
 135++142F
 136++142F              ;------------------------------------------------------------------------------
 137++142F              SetFlagsDriver	ifused
 138++142F              ;e⠭/祭 䫠 ࠩ
 139++142F              ;:  d - ᪠ 䫠
 140++142F              ;     e - 塞 䫠
 141++142F              ;: a - 䫠 ࠩ
 142++142F              ;
 143++142F              ;SetFlagsDriver
 144++142F              ;
 145++142F 3A 08 17     	ld	a,(FlgScanKeys)
 146++1432 A2           	and	d
 147++1433 B3           	or	e
 148++1434 32 08 17     	ld	(FlgScanKeys),a
 149++1437 C9           	ret
 150++1438
 151++1438              	endif
 152++1438
 153++1438              ;------------------------------------------------------------------------------
 154++1438              ;   ⮬ ६ থ
 155++1438              ;:  (PrintCodePresKey) -   ⮩ 
 156++1438              ;: 6,(FlgScanKeys) =1 -     
 157++1438              ;     hl=FlgScanKeys
 158++1438              ;     d - ᪠ ⮩ 
 159++1438              ;     a,e -   ⮩   ⥪饩 ᪫ 
 160++1438              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
 161++1438              ;     bc -  ।
 162++1438              ;
 163++1438              ScanKeyboardDelay
 164++1438              ;
 165++1438 CD 74 14     	call	ScanKeyboard		;a=(PrintCodePresKey)
 166++143B 21 08 17     	ld	hl,FlgScanKeys
 167++143E CB F6        	set	6,(hl)
 168++1440              ;	ld	a,(PrintCodePresKey)
 169++1440 FE FF        	cp	#FF
 170++1442 28 24        	jr	z,goto012		;  
 171++1444 FE 00        cng_01	cp	#00
 172++1446 20 1E        	jr	nz,goto013		; 㣠 
 173++1448 ED 4B 0A 17  	ld	bc,(KeyRepeatDelay)
 174++144C 11 00 00     cng_02	ld	de,#0000
 175++144F 1C           	inc	e
 176++1450 20 01        	jr	nz,goto014
 177++1452 1D           	dec	e
 178++1453 7B           goto014	ld	a,e
 179++1454 B9           	cp	c
 180++1455 20 17        	jr	nz,goto015		;প  ⮯
 181++1457 1D           	dec	e
 182++1458 14           	inc	d
 183++1459 20 01        	jr	nz,goto016
 184++145B 15           	dec	d
 185++145C 7A           goto016	ld	a,d
 186++145D B8           	cp	b
 187++145E 38 0E        	jr	c,goto015
 188++1460 16 00        	ld	d,#00
 189++1462 CB B6        	res	6,(hl)
 190++1464 18 08        	jr	goto015
 191++1466 CB B6        goto013 res     6,(hl)
 192++1468 32 45 14     goto012	ld	(cng_01+1),a
 193++146B 11 00 00     	ld	de,#0000
 194++146E ED 53 4D 14  goto015	ld	(cng_02+1),de
 195++1472 18 AB        	jr	GetCodesPressKey
 196++1474
 197++1474              ;------------------------------------------------------------------------------
 198++1474              ;     樥 ⭮ 
 199++1474              ;:  (FlgScanKeys) - 䫠
 200++1474              ;: (ScanCodePresKey) - ᪠ ⮩ 
 201++1474              ;     a -   ⮩ 
 202++1474              ;     (PrintCodePresKey) -   ⮩   ⥪饩 ᪫
 203++1474              ;        (Grf\Rus\Lat)  ⮬ ० CapsLock
 204++1474              ;     7,(FlgScanKeys) =1 ⨬ 
 205++1474              ;     hl,de,bc,a -  ।
 206++1474              ;
 207++1474              ScanKeyboard
 208++1474              ;
 209++1474              ; 
 210++1474              	IFDEF	Used_ROM
 211++1474 ~            	 call	#028E
 212++1474              	ELSE
 213++1474 CD 03 15     	 call	ScanAllKeys
 214++1477              	ENDIF
 215++1477 21 08 17     	ld	hl,FlgScanKeys
 216++147A CB AE        	res	5,(hl)
 217++147C CB BE        	res	7,(hl)
 218++147E 28 04        	jr	z,goto006		; - 
 219++1480 1E FF        goto021	ld	e,#FF
 220++1482 CB FE        	set	7,(hl)			;⨬ 
 221++1484
 222++1484              ;室, ᫨     
 223++1484 7B           goto006	ld	a,e
 224++1485 32 0D 17     	ld	(ScanCodePresKey),a
 225++1488 3C           	inc	a
 226++1489 28 73        	jr	z,goto011
 227++148B
 228++148B              ;  ० ⮫쪮  cs+ss
 229++148B E5           	push	hl
 230++148C 4E           	ld	c,(hl)			;c=(FlgScanKeys)
 231++148D              	IFDEF	CommandMode
 232++148D CB 41        	 bit	0,c
 233++148F 28 02        	 jr	z,goto018		;몫祭 Command Mode
 234++1491              	 IFDEF	Used_ROM
 235++1491 ~            	  ld	a,d
 236++1491 ~            	  cp	#18
 237++1491 ~            	  jr	z,goto019		; SS
 238++1491              	 ELSE
 239++1491 CB 8A        	  res	1,d			; SS
 240++1493              	 ENDIF
 241++1493              	ENDIF
 242++1493
 243++1493              ;塞    ⨭᪮ ᪫  ᪠ 
 244++1493 7A           goto018	ld	a,d
 245++1494              	IFDEF	Used_ROM
 246++1494 ~            	 ld	hl,tableSSkeys
 247++1494 ~            	 cp	#18
 248++1494 ~            	 jr	z,goto007		; ⮩ ss
 249++1494 ~            	 ld	hl,tableCSkeys
 250++1494 ~            	 cp	#27
 251++1494 ~            	 jr	z,goto007		; ⮩ cs
 252++1494 ~            goto019	 ld	hl,tablePrnKeys
 253++1494              	ELSE
 254++1494 21 98 15     	 ld	hl,tableSSkeys
 255++1497 FE 02        	 cp	#02
 256++1499 28 12        	 jr	z,goto007		; ⮩ ss
 257++149B              	 IFDEF	UseEXTkeys
 258++149B 21 C0 15     	  ld	hl,tableEXTKeys
 259++149E CB E9        	  set	5,c			;  cs+ss
 260++14A0 30 0B        	  jr	nc,goto007		; ⮩ cs+ss
 261++14A2 CB A9        	  res	5,c
 262++14A4              	 ENDIF
 263++14A4 21 70 15     	 ld	hl,tableCSkeys
 264++14A7 B7           	 or	a
 265++14A8 20 03        	 jr	nz,goto007		; ⮩ cs
 266++14AA 21 48 15     	 ld	hl,tablePrnKeys
 267++14AD              	ENDIF
 268++14AD 16 00        goto007	ld	d,#00
 269++14AF 19           	add	hl,de
 270++14B0 5E           	ld	e,(hl)			; 
 271++14B1 E1           	pop	hl
 272++14B2 71           	ld	(hl),c
 273++14B3 7B           	ld	a,e
 274++14B4 3C           	inc	a
 275++14B5 28 C9        	jr	z,goto021
 276++14B7              ;de -   ⮩   ⨭᪮ ᪫   ० Caps
 277++14B7
 278++14B7              ;᫨ 祭  ० ⠭ ᨬ  孨 ॣ
 279++14B7              	IFDEF	CommandMode
 280++14B7 79           	 ld	a,c
 281++14B8 E6 21        	 and	%00100001
 282++14BA 20 0D        	 jr	nz,goto020		;祭 Command Mode
 283++14BC              	ENDIF
 284++14BC
 285++14BC              ;४ ⭮   ⮬ ० CapsLock
 286++14BC 7B           	ld	a,e
 287++14BD CB 49        	bit	1,c
 288++14BF 28 13        	jr	z,goto008		;caps 몫祭
 289++14C1 FE 41        	cp	"A"
 290++14C3 38 0F        	jr	c,goto008
 291++14C5 FE 5B        	cp	"Z"+1
 292++14C7 38 09        	jr	c,goto009
 293++14C9              	IFDEF	CommandMode
 294++14C9 7B           goto020	 ld	a,e
 295++14CA              	ENDIF
 296++14CA FE 61        	cp	"a"
 297++14CC 38 06        	jr	c,goto008
 298++14CE FE 7B        	cp	"z"+1
 299++14D0 30 02        	jr	nc,goto008
 300++14D2 EE 20        goto009	xor	%00100000
 301++14D4 5F           goto008	ld	e,a
 302++14D5              ;de,a -   ⮩   ⨭᪮ ᪫
 303++14D5
 304++14D5              ; ८ࠧ, ᫨ 祭  ०
 305++14D5              	IFDEF	CommandMode
 306++14D5 79           	 ld	a,c
 307++14D6 E6 21        	 and	%00100001
 308++14D8 7B           	 ld	a,e
 309++14D9 20 23        	 jr	nz,goto011		;祭 Command Mode
 310++14DB              	ENDIF
 311++14DB
 312++14DB              ;⠭ ⭮   ᮮ⢥⢨  祭 ᪫: Grf\Rus\Lat
 313++14DB              ;  grf ᪫
 314++14DB              	IFDEF	GrfMode
 315++14DB              	 IFDEF	InsideGrfTable
 316++14DB FE 20        	  cp	#20
 317++14DD 38 1F        	  jr	c,goto011
 318++14DF              	 ENDIF
 319++14DF 21 C8 15     	 ld	hl,TblKeyGrf
 320++14E2 CB 51        	 bit	2,c
 321++14E4 20 16        	 jr	nz,goto010		;祭 Grf
 322++14E6              	ENDIF
 323++14E6              ;  rus ᪫
 324++14E6              	IFDEF	RusMode
 325++14E6 CB 59        	 bit	3,c
 326++14E8 28 14        	 jr	z,goto011		;᪫ rus 몫祭
 327++14EA              	 IFDEF	InsideRusTable
 328++14EA FE 20        	  cp	#20
 329++14EC 38 10        	  jr	c,goto011
 330++14EE              	 ENDIF
 331++14EE              	 IFDEF	Rus_jcuken
 332++14EE 21 88 16     	  ld	hl,TblKeyRus_jcuken
 333++14F1              	  IFDEF	Rus_qwerty
 334++14F1 CB 61        	   bit	4,c
 335++14F3 20 07        	   jr	nz,goto010		;祭 ᪫ Rus 㪥
 336++14F5              	  ENDIF
 337++14F5              	 ENDIF
 338++14F5              	 IFDEF	Rus_qwerty
 339++14F5 21 28 16     	  ld	hl,TblKeyRus_qwerty
 340++14F8              	 ENDIF
 341++14F8 18 02        	 jr	goto010
 342++14FA              	ENDIF
 343++14FA 18 02        	jr	goto011
 344++14FC 19           goto010	add	hl,de
 345++14FD 5E           	ld	e,(hl)
 346++14FE              ;e -   ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
 347++14FE              ;     ⮬ ० CapsLock
 348++14FE
 349++14FE 7B           goto011 ld      a,e
 350++14FF 32 0C 17             ld      (PrintCodePresKey),a
 351++1502 C9                   ret
 352++1503
 353++1503              ;------------------------------------------------------------------------------
 354++1503              ScanAllKeys	ifused
 355++1503              ;    ( /  48k #028E)
 356++1503              ;ਬ砭: ⠡ ScanCode
 357++1503              ;Ŀ
 358++1503              ; 1  2  3  4  5  6  7  8  9  0 
 359++1503              ;#24#1C#14#0C#04#03#0B#13#1B#23
 360++1503              ;Ĵ
 361++1503              ; Q  W  Q  R  T  Y  U  I  O  P 
 362++1503              ;#25#1D#15#0D#05#02#0A#12#1A#22
 363++1503              ;Ĵ
 364++1503              ; A  S  D  F  G  h  J  K  L ent
 365++1503              ;#26#1E#16#0E#06#01#09#11#19#21
 366++1503              ;Ĵ
 367++1503              ;s  Z  X  C  V  B  N  M ss sp 
 368++1503              ;#27#1F#17#0F#07#00#08#10#18#20
 369++1503              ;
 370++1503              ;:  ----
 371++1503              ;: nz - ⨬ 
 372++1503              ;       hl,de,bc,a -  ।
 373++1503              ;     z  -       CS/SS    
 374++1503              ;       e =#FF -   
 375++1503              ;       0,d/c=1   c CS
 376++1503              ;       1,d/c=1   c SS
 377++1503              ;       e - ScanCode  ⮩ 
 378++1503              ;       a=#00
 379++1503              ;       hl,b -  ।
 380++1503              ;
 381++1503              ;ScanAllKeys
 382++1503              ;
 383++1503 2E 2F        	ld	l,#27+#08
 384++1505 11 FF FF     	ld	de,#FFFF
 385++1508 01 FF FE     	ld	bc,#FEFF
 386++150B
 387++150B              ;  ⠭ ⮢   ॣ c,d,e
 388++150B 78           loop003	ld	a,b
 389++150C DB FE        	in	a,(#FE)
 390++150E 2F           	cpl
 391++150F E6 1F        	and	#1F
 392++1511 28 0F        	jr	z,goto001
 393++1513 67           	ld	h,a
 394++1514 7D           	ld	a,l
 395++1515 0C           loop002	inc	c
 396++1516 C0           	ret	nz			;   
 397++1517 D6 08        loop001	sub	#08
 398++1519 CB 3C        	srl	h
 399++151B 30 FA        	jr	nc,loop001
 400++151D 4A           	ld	c,d
 401++151E 53           	ld	d,e
 402++151F 5F           	ld	e,a			; ⮩ 
 403++1520 20 F3        	jr	nz,loop002
 404++1522 2D           goto001	dec	l
 405++1523 CB 00        	rlc	b
 406++1525 38 E4        	jr	c,loop003
 407++1527              ;=key 1, d=key 2, e=key 3
 408++1527              ;=#FF, d=key 1, e=key 2
 409++1527              ;=#FF, d=#FF, e=key 1
 410++1527
 411++1527              ;஢ઠ 権 
 412++1527 79           	ld	a,c
 413++1528 3C           	inc	a
 414++1529 28 04        	jr	z,goto002		;    
 415++152B D6 28        	sub	#27+1
 416++152D C0           	ret	nz			;ࢠ   cs
 417++152E 3C           	inc	a
 418++152F 4F           goto002	ld	c,a			;0,c=0/1   cs/ cs
 419++1530 7A           	ld	a,d
 420++1531 3C           	inc	a
 421++1532 28 11        	jr	z,goto004		;   -> e - ᪠/#FF
 422++1534 FE 28        	cp	#27+1
 423++1536 28 0C        	jr	z,goto003
 424++1538 FE 19        	cp	#18+1
 425++153A 28 05        	jr	z,goto005		; ss
 426++153C 7B           	ld	a,e
 427++153D 5A           	ld	e,d
 428++153E FE 18        	cp	#18
 429++1540 C0           	ret	nz			;⨬ 
 430++1541 CB C9        goto005	set	1,c			; ss
 431++1543 0D           	dec	c
 432++1544 0C           goto003	inc	c
 433++1545 51           goto004	ld	d,c			;0,d=0/1 cs  /
 434++1546 AF           	xor	a			;1,d=0/1 ss  /
 435++1547 C9           	ret
 436++1548
 437++1548                      endif
 438++1548
 439++1548              ;==============================================================================
 440++1548              		ifused	tablePrnKeys
 441++1548              ;⠡  
 442++1548              ;cs - off
 443++1548              ;ss - off
 444++1548              ;
 445++1548 62 68 79 36  tablePrnKeys	db "bhy65tgv"	;#00-#07
 445++154C 35 74 67 76
 446++1550 6E 6A 75 37  		db "nju74rfc"	;#08-#0F
 446++1554 34 72 66 63
 447++1558 6D 6B 69 38  		db "mki83edx"	;#10-#17
 447++155C 33 65 64 78
 448++1560 1D           		db keySS	;#18
 449++1561 6C 6F 39 32  		db "lo92wsz"	;#19-#1F
 449++1565 77 73 7A
 450++1568 20           		db " "		;#20
 451++1569 0D           		db keyEnter	;#21
 452++156A 70 30 31 71  		db "p01qa"	;#22-#26
 452++156E 61
 453++156F 1C           		db keyCS	;#27
 454++1570
 455++1570              		endif
 456++1570
 457++1570              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 458++1570              		ifused	tableCSkeys
 459++1570              ;⠡  
 460++1570              ;cs - on
 461++1570              ;ss - off
 462++1570              ;
 463++1570 42 48 59     tableCSkeys	db "BHY"	;#00-#02
 464++1573 0A           		db keyDown	;#03
 465++1574 08           		db keyLeft	;#04
 466++1575 54 47 56     		db "TGV"	;#05-#07
 467++1578 4E 4A 55     		db "NJU"	;#08-#0A
 468++157B 0B           		db keyUp	;#0B
 469++157C 05           		db keyPageDown	;#0C
 470++157D 52 46 43     		db "RFC"	;#0D-#0F
 471++1580 4D 4B 49     		db "MKI"	;#10-#12
 472++1583 09           		db keyRight	;#13
 473++1584 04           		db keyPageUp	;#14
 474++1585 45 44 58     		db "EDX"	;#15-#17
 475++1588 0E           		db keyExtMode	;#18
 476++1589 4C 4F        		db "LO"		;#19-#1A
 477++158B 0F           		db keyDelete	;#1B
 478++158C 06           		db keyCaps	;#1C
 479++158D 57 53 5A     		db "WSZ"	;#1D-#1F
 480++1590 18           		db keyBreak	;#20
 481++1591 19           		db keyCsEnter	;#21
 482++1592 50           		db "P"		;#22
 483++1593 0C           		db keyBackSpace	;#23
 484++1594 07           		db keyEdit	;#24
 485++1595 51 41        		db "QA"		;#25-#26
 486++1597 1C           		db keyCS	;#27
 487++1598
 488++1598              		endif
 489++1598
 490++1598              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 491++1598              		ifused	tableSSkeys
 492++1598              ;⠡  
 493++1598              ;cs - off
 494++1598              ;ss - on
 495++1598              ;
 496++1598 2A 5E 5B 26  tableSSkeys	db "*^[&%>}/"	;#00-#07
 496++159C 25 3E 7D 2F
 497++15A0 2C 2D 5D 27  		db ",-]'$<{?"	;#08-#0F
 497++15A4 24 3C 7B 3F
 498++15A8 2E 2B 7F 28  		db ".+(#"	;#10-#14
 498++15AC 23
 499++15AD 03           		db keyEnd	;#15
 500++15AE 5C 60        		db #5C,#60	;#16-#17 (\`)
 501++15B0 1D           		db keySS	;#18
 502++15B1 3D 3B 29 40  		db "=;)@"	;#19-#1C
 503++15B5 02           		db keyInsert	;#1D
 504++15B6 7C 3A        		db "|:"		;#1E-#1F
 505++15B8 1A           		db keySsSpace	;#20
 506++15B9 1B           		db keySsEnter	;#21
 507++15BA 22           		db #22		;#22 (")
 508++15BB 5F 21        		db "_!"		;#23-#24
 509++15BD 01           		db keyHome	;#25
 510++15BE 7E           		db "~"		;#26
 511++15BF 0E           		db keyExtMode	;#27
 512++15C0
 513++15C0              		endif
 514++15C0
 515++15C0              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 516++15C0              		ifused	tableEXTKeys
 517++15C0              ;⠡  , ᪫  ZX-Word
 518++15C0              ;cs - on
 519++15C0              ;ss - on
 520++15C0              ;
 521++15C0              tableEXTKeys
 522++15C0
 523++15C0              		IFDEF	TblEXTkey_Test	;⮢ ᪫
 524++15C0 42 48 59     		db "BHY"	;#00-#02
 525++15C3 03           		db keyEnd	;#03 key 6
 526++15C4 10           		db keyWordLeft	;#04 key 5
 527++15C5 54 47 56     		db "TGV"	;#05-#07
 528++15C8 4E 4A 55     		db "NJU"	;#08-#0A
 529++15CB 01           		db keyHome	;#0B key 7
 530++15CC FF           		db #FF		;#0C key 4
 531++15CD 52 46 43     		db "RFC"	;#0D-#0F
 532++15D0 4D 4B 49     		db "MKI"	;#10-#12
 533++15D3 11           		db keyWordRight	;#13 key 8
 534++15D4 FF           		db #FF		;#14 key 3
 535++15D5 45 44 58     		db "EDX"	;#15-#17
 536++15D8 FF           		db #FF		;#18 key SS
 537++15D9 4C 4F        		db "LO"		;#19-#1A
 538++15DB 13           		db keyDelEnd	;#1B key 9
 539++15DC FF           		db #FF		;#1C key 2
 540++15DD 57 53 5A     		db "WSZ"	;#1D-#1F
 541++15E0 14           		db keyCsSsSpace	;#20
 542++15E1 15           		db keyCsSsEnter	;#21
 543++15E2 50           		db "P"		;#22
 544++15E3 16           		db keyDelBegin	;#23 key 0
 545++15E4 12           		db keyGrf	;#24 key 1
 546++15E5 51 41        		db "QA"		;#25-#26
 547++15E7 FF           		db #FF		;#27 key CS
 548++15E8              		ENDIF
 549++15E8
 550++15E8              		IFDEF	TblEXTkey_Word	; ZX-Word
 551++15E8 ~            		db "BHY"	;#00-#02
 552++15E8 ~            		db keyEnd	;#03 key 6
 553++15E8 ~            		db keyWordLeft	;#04 key 5
 554++15E8 ~            		db "TG",#FF	;#05-#07
 555++15E8 ~            		db #FF,#FF,#FF	;#08-#0A
 556++15E8 ~            		db keyHome	;#0B key 7
 557++15E8 ~            		db #FF		;#0C key 4
 558++15E8 ~            		db "RFC"	;#0D-#0F
 559++15E8 ~            		db #FF,#FF,#FF	;#10-#12
 560++15E8 ~            		db keyWordRight	;#13 key 8
 561++15E8 ~            		db #FF		;#14 key 3
 562++15E8 ~            		db "EDX"	;#15-#17
 563++15E8 ~            		db #FF		;#18 key SS
 564++15E8 ~            		db #FF,"O"	;#19-#1A
 565++15E8 ~            		db keyDelete	;#1B key 9
 566++15E8 ~            		db keyInsert	;#1C key 2
 567++15E8 ~            		db #FF,#FF,"Z"	;#1D-#1F
 568++15E8 ~            		db #FF		;#20
 569++15E8 ~            		db #FF		;#21
 570++15E8 ~            		db "P"		;#22
 571++15E8 ~            		db keyBackSpace	;#23 key 0
 572++15E8 ~            		db keyEdit	;#24 key 1
 573++15E8 ~            		db "Q",#FF	;#25-#26
 574++15E8 ~            		db #FF		;#27 key CS
 575++15E8              		ENDIF
 576++15E8
 577++15E8              		endif
 578++15E8
 579++15E8              ;------------------------------------------------------------------------------
 580++15E8              	IFDEF	GrfMode
 581++15E8              	IFDEF	TblKeyGrf_ver1
 582++15E8              	IFDEF	InsideGrfTable
 583++15E8
 584++15E8              ;᪠ ᪫: version 01
 585++15E8              ;
 586++15E8              TblKeyGrf	equ $-#20
 587++15E8              ;
 588++15E8              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 589++15E8              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 590++15E8              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 591++15E8              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 592++15E8 20 21 22 23  	db " !",#22,"#$%&'"
 592++15EC 24 25 26 27
 593++15F0 28 29 2A 2B  	db "()*+,-./"
 593++15F4 2C 2D 2E 2F
 594++15F8 30 31 32 33  	db "01234567"
 594++15FC 34 35 36 37
 595++1600 38 39 3A 3B  	db "89:;<=>?"
 595++1604 3C 3D 3E 3F
 596++1608 40 C7 D4 BD  	db "@Խ"
 596++160C B6 B7 BA C6
 597++1610 D8 CD B5 B3  	db "͵۾"
 597++1614 DB BE CF DD
 598++1618 DE D6 C4 D7  	db "ո"
 598++161C D5 B8 F0 D2
 599++1620 D0 D1 D3 5B  	db "[",#5C,"]^_"
 599++1624 5C 5D 5E 5F
 600++1628 60 C3 C8 D9  	db "`ٴ"
 600++162C B4 BF B3 CC
 601++1630 CE CD B9 BA  	db "͹ʱ"
 601++1634 B0 BC CA B1
 602++1638 B2 DA C4 C5  	db "ɻ"
 602++163C C9 BB FB C2
 603++1640 C1 CB C0 7B  	db "{|}~"
 603++1644 7C 7D 7E 7F
 604++1648
 605++1648              	ELSE
 606++1648 ~            TblKeyGrf	equ	OutsideGrfTable
 607++1648              	ENDIF
 608++1648              	ENDIF
 609++1648              	ENDIF
 610++1648
 611++1648              ;------------------------------------------------------------------------------
 612++1648              	IFDEF	RusMode
 613++1648              	IFDEF	Rus_qwerty
 614++1648              	IFDEF	InsideRusTable
 615++1648
 616++1648              ;᪠ ᪫: 
 617++1648              ;
 618++1648              TblKeyRus_qwerty	equ $-#20
 619++1648              ;
 620++1648              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 621++1648              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 622++1648              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 623++1648              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 624++1648 20 21 22 23  	db " !",#22,"#$%&'"
 624++164C 24 25 26 27
 625++1650 28 29 2A 2B  	db "()*+,-./"
 625++1654 2C 2D 2E 2F
 626++1658 30 31 32 33  	db "01234567"
 626++165C 34 35 36 37
 627++1660 38 39 3A 3B  	db "89:;<=>?"
 627++1664 3C 3D 3E 3F
 628++1668 40 80 81 96  	db "@"
 628++166C 84 85 94 83
 629++1670 95 88 89 8A  	db ""
 629++1674 8B 8C 8D 8E
 630++1678 8F 9F 90 91  	db ""
 630++167C 92 93 86 82
 631++1680 9C 9B 87 5B  	db "[",#5C,"]^"
 631++1684 5C 5D 5E 9A
 632++1688 9E A0 A1 E6  	db "椥"
 632++168C A4 A5 E4 A3
 633++1690 E5 A8 A9 AA  	db "娩"
 633++1694 AB AC AD AE
 634++1698 AF EF E0 E1  	db "㦢"
 634++169C E2 E3 A6 A2
 635++16A0 EC EB A7 98  	db "맘"
 635++16A4 9D 99 97 7F
 636++16A8
 637++16A8              	ELSE
 638++16A8 ~            TblKeyRus_qwerty	equ	OutsideRus_qwerty
 639++16A8              	ENDIF
 640++16A8              	ENDIF
 641++16A8              	ENDIF
 642++16A8
 643++16A8              ;------------------------------------------------------------------------------
 644++16A8              	IFDEF	RusMode
 645++16A8              	IFDEF	Rus_jcuken
 646++16A8              	IFDEF	InsideRusTable
 647++16A8
 648++16A8              ;᪠ ᪫: 㪥
 649++16A8              ;
 650++16A8              TblKeyRus_jcuken	equ	$-#20
 651++16A8              ;
 652++16A8              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 653++16A8              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 654++16A8              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 655++16A8              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 656++16A8 20 21 22 23  	db " !",#22,"#$%&'"
 656++16AC 24 25 26 27
 657++16B0 28 29 2A 2B  	db "()*+,-./"
 657++16B4 2C 2D 2E 2F
 658++16B8 30 31 32 33  	db "01234567"
 658++16BC 34 35 36 37
 659++16C0 38 39 3A 3B  	db "89:;<=>?"
 659++16C4 3C 3D 3E 3F
 660++16C8 9E 94 88 91  	db ""
 660++16CC 82 93 80 8F
 661++16D0 90 98 8E 8B  	db ""
 661++16D4 84 9C 92 99
 662++16D8 87 89 8A 9B  	db ""
 662++16DC 85 83 8C 96
 663++16E0 97 8D 9F 95  	db ""
 663++16E4 9D 86 81 9A
 664++16E8 EE E4 A8 E1  	db "㠯"
 664++16EC A2 E3 A0 AF
 665++16F0 E0 E8 AE AB  	db "讫"
 665++16F4 A4 EC E2 E9
 666++16F8 A7 A9 AA EB  	db "륣"
 666++16FC A5 A3 AC E6
 667++1700 E7 AD EF E5  	db ""
 667++1704 ED A6 A1 7F
 668++1708
 669++1708              	ELSE
 670++1708 ~            TblKeyRus_jcuken	equ	OutsideRus_jcuken
 671++1708              	ENDIF
 672++1708              	ENDIF
 673++1708              	ENDIF
 674++1708
 675++1708              ;------------------------------------------------------------------------------
 676++1708              	ifused	TblKeyLat
 677++1708 ~            ;⠭⭠ ⨭᪠ ᪫
 678++1708 ~            ;
 679++1708 ~            TblKeyLat	equ	$-#20
 680++1708 ~            ;
 681++1708 ~            ;	db #00,#01,#02,#03,#04,#05,#06,#07
 682++1708 ~            ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 683++1708 ~            ;	db #10,#11,#12,#13,#14,#15,#16,#17
 684++1708 ~            ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 685++1708 ~            	db " !",""","#$%&'"
 686++1708 ~            	db "()*+,-./"
 687++1708 ~            	db "01234567"
 688++1708 ~            	db "89:;<=>?"
 689++1708 ~            	db "@ABCDEFG"
 690++1708 ~            	db "HIJKLMNO"
 691++1708 ~            	db "PQRSTUVW"
 692++1708 ~            	db "XYZ[\]^_"
 693++1708 ~            	db "`abcdefg"
 694++1708 ~            	db "hijklmno"
 695++1708 ~            	db "pqrstuvw"
 696++1708 ~            	db "xyz{|}~"
 697++1708 ~
 698++1708              	endif
 699++1708
 700++1708              ;==============================================================================
 701++1708
# file closed: Drv/DrvKey.asm.a80
 117+ 1708              	INCLUDE	"DrvKey.var.a80"
# file opened: Drv/DrvKey.var.a80
   1++1708              ;६ Keyboard Driver
   2++1708              ;䠩 DrvKey.var.a80
   3++1708              ;
   4++1708              ;䫠 ࠩ
   5++1708              ;7,=1     
   6++1708              ;6,=1     
   7++1708              ;5,=1 ᨬ  ० cs+ss+key
   8++1708              ;4,=1/0 Rus 㪥/Rus 
   9++1708              ;3,=1/0 Rus/Lat
  10++1708              ;2,=1/0 Grf on/off
  11++1708              ;1,=1/0 CapsLock on/off
  12++1708              ;0,=1/0 Command on/off
  13++1708 30           FlgScanKeys     db %00110000
  14++1709 00           		db %00000000	;१
  15++170A
  16++170A              ;稭 প  ⮯
  17++170A 0F           KeyRepeatDelay    db #0F
  18++170B              ;ਮ ⮯
  19++170B 05           KeyRepeatPeriod   db #05
  20++170C
  21++170C              ;  ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
  22++170C              ;   ⮬ ० CapsLock
  23++170C 00           PrintCodePresKey  db #00
  24++170D              ;᪠ ⮩ 
  25++170D 00           ScanCodePresKey   db #00
  26++170E
  27++170E
# file closed: Drv/DrvKey.var.a80
 118+ 170E              End	DISPLAY	"Lenght DrvKey = ",/A,End-Start
 119+ 170E              ;	SAVEBIN	"!bin/drvkeys.bin",Start,End-Start
 120+ 170E              	ENDMODULE
 121+ 170E
# file closed: Drv/DrvKey.main.a80
2545  170E              	include player.asm ;плеер AY, TS
# file opened: player.asm
   1+ 170E              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2+ 170E              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3+ 170E              ;Specially for AlCo
   4+ 170E              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5+ 170E              	MODULE VTPL
   6+ 170E              ;Release number
   7+ 170E              Release EQU "0"
   8+ 170E              ;Conditional assembly
   9+ 170E              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10+ 170E              CurPosCounter=0
  11+ 170E              ;2) Allow channels allocation bits at (START+10)
  12+ 170E              ACBBAC=0
  13+ 170E              ;3) Allow loop checking and disabling
  14+ 170E              LoopChecker=1
  15+ 170E              ;4) Insert official identificator
  16+ 170E              Id=0
  17+ 170E              ;5) Set IY for correct return to ZX Basic
  18+ 170E              Basic=1
  19+ 170E
  20+ 170E              ;Features
  21+ 170E              ;--------
  22+ 170E              ;-Can be compiled at any address (i.e. no need rounding ORG
  23+ 170E              ; address).
  24+ 170E              ;-Variables (VARS) can be located at any address (not only after
  25+ 170E              ; code block).
  26+ 170E              ;-INIT subprogram checks PT3-module version and rightly
  27+ 170E              ; generates both note and volume tables outside of code block
  28+ 170E              ; (in VARS).
  29+ 170E              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30+ 170E              ; PT3 module version).
  31+ 170E              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32+ 170E              ; and higher).
  33+ 170E              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34+ 170E              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35+ 170E              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36+ 170E              ;-See also notes at the end of this source code.
  37+ 170E
  38+ 170E              ;Limitations
  39+ 170E              ;-----------
  40+ 170E              ;-Can run in RAM only (self-modified code is used).
  41+ 170E              ;-PT2 position list must be end by #FF marker only.
  42+ 170E
  43+ 170E              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44+ 170E              ;into RAM or INIT subprogram was not called before.
  45+ 170E
  46+ 170E              ;Call MUTE or INIT one more time to mute sound after stopping
  47+ 170E              ;playing
  48+ 170E
  49+ 170E              ;Test codes (commented)
  50+ 170E              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51+ 170E              ;	LD (START+10),A
  52+ 170E              ;	LD HL,#8000 ;Mod1
  53+ 170E              ;	LD DE,#A000 ;Mod2 (optional)
  54+ 170E              ;	CALL START+3
  55+ 170E              ;	EI
  56+ 170E              ;_LP	HALT
  57+ 170E              ;	CALL START+5
  58+ 170E              ;	XOR A
  59+ 170E              ;	IN A,(#FE)
  60+ 170E              ;	CPL
  61+ 170E              ;	AND 15
  62+ 170E              ;	JR Z,_LP
  63+ 170E              ;	JR START+8
  64+ 170E
  65+ 170E              TonA	EQU 0
  66+ 170E              TonB	EQU 2
  67+ 170E              TonC	EQU 4
  68+ 170E              Noise	EQU 6
  69+ 170E              Mixer	EQU 7
  70+ 170E              AmplA	EQU 8
  71+ 170E              AmplB	EQU 9
  72+ 170E              AmplC	EQU 10
  73+ 170E              Env	EQU 11
  74+ 170E              EnvTp	EQU 13
  75+ 170E
  76+ 170E              ;Entry and other points
  77+ 170E              ;START initialize playing of modules at MDLADDR (single module)
  78+ 170E              ;START+3 initialization with module address in HL and DE (TS)
  79+ 170E              ;START+5 play one quark
  80+ 170E              ;START+8 mute
  81+ 170E              ;START+10 setup and status flags
  82+ 170E
  83+ 170E              START:
  84+ 170E 21 00 C0     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85+ 1711 18 3C        	JR INIT
  86+ 1713 C3 72 1F     	JP PLAY
  87+ 1716 18 25        	JR MUTE
  88+ 1718 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89+ 1719              	     ;(optional);
  90+ 1719              	     ;set bit1 for PT2 and reset for PT3 before
  91+ 1719              	     ;calling INIT;
  92+ 1719              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93+ 1719              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94+ 1719              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95+ 1719              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96+ 1719              	     ;documented and must be converted to new standard.
  97+ 1719              	     ;bit6 is set each time, when loop point of 2nd TS
  98+ 1719              	     ;module is passed (optional).
  99+ 1719              	     ;bit7 is set each time, when loop point of 1st TS
 100+ 1719              	     ;or of single module is passed (optional).
 101+ 1719
 102+ 1719              ;Identifier
 103+ 1719              	IF Id
 104+ 1719 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105+ 1719              	ENDIF
 106+ 1719
 107+ 1719              	IF LoopChecker
 108+ 1719 21 18 17     CHECKLP	LD HL,SETUP
 109+ 171C FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110+ 1720 28 04        	JR Z,CHL1
 111+ 1722 CB F6        	SET 6,(HL)
 112+ 1724 18 02        	JR CHL2
 113+ 1726 CB FE        CHL1	SET 7,(HL)
 114+ 1728 CB 46        CHL2	BIT 0,(HL)
 115+ 172A C8           	RET Z
 116+ 172B E1           	POP HL
 117+ 172C FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118+ 172F FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119+ 1732 AF           	XOR A
 120+ 1733 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121+ 1736 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122+ 1739 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123+ 173C C9           	RET
 124+ 173D              	ENDIF
 125+ 173D
 126+ 173D AF           MUTE: XOR A
 127+ 173E 67           	LD H,A
 128+ 173F 6F           	LD L,A
 129+ 1740 32 C7 20     	LD (VARS1+VRS.AYREGS+AmplA),A
 130+ 1743 22 C8 20     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131+ 1746 32 4E 21     	LD (VARS2+VRS.AYREGS+AmplA),A
 132+ 1749 22 4F 21     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133+ 174C C3 8A 1F     	JP ROUT
 134+ 174F
 135+ 174F              INIT:
 136+ 174F              ;HL - AddressOfModule
 137+ 174F              ;DE - AddresOf2ndModule
 138+ 174F D5           	PUSH DE
 139+ 1750 E5           	PUSH HL
 140+ 1751 21 45 20     	LD HL,VARS
 141+ 1754 36 00        	LD (HL),0
 142+ 1756 11 46 20     	LD DE,VARS+1
 143+ 1759 01 0E 01     	LD BC,VAR0END-VARS-1
 144+ 175C ED B0        	LDIR
 145+ 175E 23           	INC HL
 146+ 175F 22 A8 20     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147+ 1762 22 2F 21     	LD (VARS2+VRS.AdInPtA),HL
 148+ 1765
 149+ 1765 E1           	POP HL
 150+ 1766 FD 21 AA 20  	LD IY,VARS1+100
 151+ 176A 3A 18 17     	LD A,(START+10)
 152+ 176D E6 02        	AND 2
 153+ 176F C2 F8 17     	JP NZ,I_PT2
 154+ 1772
 155+ 1772 CD 45 19     	CALL INITPT3
 156+ 1775 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157+ 1778 22 18 1D     	LD (SamCnv),HL
 158+ 177B 3E BA        	LD A,#BA
 159+ 177D 32 E3 1C     	LD (OrnCP),A
 160+ 1780 32 0F 1D     	LD (SamCP),A
 161+ 1783 3E 7B        	LD A,#7B
 162+ 1785 32 E6 1C     	LD (OrnLD),A
 163+ 1788 32 12 1D     	LD (SamLD),A
 164+ 178B 3E 87        	LD A,#87
 165+ 178D 32 09 1D     	LD (SamClc2),A
 166+ 1790 E1           	POP HL
 167+ 1791              	;Use version and ton table of 1st module
 168+ 1791 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169+ 1794 D6 30        	SUB #30
 170+ 1796 38 04        	JR C,L20
 171+ 1798 FE 0A        	CP 10
 172+ 179A 38 02        	JR C,L21
 173+ 179C 3E 06        L20	LD A,6
 174+ 179E 32 B6 1B     L21	LD (Version),A
 175+ 17A1 F5           	PUSH AF ;VolTable version
 176+ 17A2 FE 04        	CP 4
 177+ 17A4 DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178+ 17A7 17           	RLA
 179+ 17A8 E6 07        	AND 7
 180+ 17AA F5           	PUSH AF ;NoteTable number
 181+ 17AB
 182+ 17AB FD 21 31 21  	LD IY,VARS2+100
 183+ 17AF 3A 18 17     	LD A,(START+10)
 184+ 17B2 E6 30        	AND 48
 185+ 17B4 28 37        	JR Z,NOTS
 186+ 17B6 FE 10        	CP 16
 187+ 17B8 28 27        	JR Z,TwoPT3s
 188+ 17BA 3A B6 1B     	LD A,(Version)
 189+ 17BD FE 07        	CP 7
 190+ 17BF 38 2C        	JR C,NOTS
 191+ 17C1 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192+ 17C4 FE 20        	CP #20
 193+ 17C6 28 25        	JR Z,NOTS
 194+ 17C8 21 46 20     	LD HL,VARS1
 195+ 17CB 11 CD 20     	LD DE,VARS2
 196+ 17CE 01 87 00     	LD BC,VRS
 197+ 17D1 ED B0        	LDIR
 198+ 17D3 FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199+ 17D7 4F           	LD C,A
 200+ 17D8 87           	ADD A,A
 201+ 17D9 81           	ADD A,C
 202+ 17DA D6 02        	SUB 2
 203+ 17DC 32 7D 1E     	LD (TSSub),A
 204+ 17DF 18 03        	JR AlCoTS_
 205+ 17E1 CD 45 19     TwoPT3s	CALL INITPT3
 206+ 17E4 3E 01        AlCoTS_	LD A,1
 207+ 17E6 32 45 20     	LD (is_ts),A
 208+ 17E9 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209+ 17ED
 210+ 17ED 01 02 1B     NOTS	LD BC,PT3PD
 211+ 17F0 21 00 00     	LD HL,0
 212+ 17F3 11 0D 20     	LD DE,PT3EMPTYORN
 213+ 17F6 18 48        	JR INITCOMMON
 214+ 17F8
 215+ 17F8 CD 7D 19     I_PT2	CALL INITPT2
 216+ 17FB 21 CB 51     	LD HL,#51CB
 217+ 17FE 22 18 1D     	LD (SamCnv),HL
 218+ 1801 3E BB        	LD A,#BB
 219+ 1803 32 E3 1C     	LD (OrnCP),A
 220+ 1806 32 0F 1D     	LD (SamCP),A
 221+ 1809 3E 7A        	LD A,#7A
 222+ 180B 32 E6 1C     	LD (OrnLD),A
 223+ 180E 32 12 1D     	LD (SamLD),A
 224+ 1811 3E 80        	LD A,#80
 225+ 1813 32 09 1D     	LD (SamClc2),A
 226+ 1816 E1           	POP HL
 227+ 1817 3E 05        	LD A,5
 228+ 1819 32 B6 1B     	LD (Version),A
 229+ 181C F5           	PUSH AF
 230+ 181D 3E 02        	LD A,2
 231+ 181F F5           	PUSH AF
 232+ 1820
 233+ 1820 3A 18 17     	LD A,(START+10)
 234+ 1823 E6 30        	AND 48
 235+ 1825 28 10        	JR Z,NOTS2
 236+ 1827
 237+ 1827 FD 21 31 21  	LD IY,VARS2+100
 238+ 182B 3E 01        	LD A,1
 239+ 182D 32 45 20     	LD (is_ts),A
 240+ 1830 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241+ 1834 CD 7D 19     	CALL INITPT2
 242+ 1837
 243+ 1837 01 3C 1A     NOTS2	LD BC,PT2PD
 244+ 183A 21 87 86     	LD HL,#8687
 245+ 183D 11 63 21     	LD DE,PT2EMPTYORN
 246+ 1840
 247+ 1840              INITCOMMON
 248+ 1840
 249+ 1840              	IF Basic
 250+ 1840 FD 21 3A 5C  	LD IY,#5C3A
 251+ 1844              	ENDIF
 252+ 1844
 253+ 1844 ED 43 ED 19  	LD (PTDEC),BC
 254+ 1848 22 7F 1E     	LD (PsCalc),HL
 255+ 184B D5           	PUSH DE
 256+ 184C
 257+ 184C              ;note table data depacker
 258+ 184C              ;(c) Ivan Roshin
 259+ 184C 11 10 20     	LD DE,T_PACK
 260+ 184F 01 B5 21     	LD BC,T1_+(2*49)-1
 261+ 1852 1A           TP_0	LD A,(DE)
 262+ 1853 13           	INC DE
 263+ 1854 FE 1E        	CP 15*2
 264+ 1856 30 06        	JR NC,TP_1
 265+ 1858 67           	LD H,A
 266+ 1859 1A           	LD A,(DE)
 267+ 185A 6F           	LD L,A
 268+ 185B 13           	INC DE
 269+ 185C 18 07        	JR TP_2
 270+ 185E D5           TP_1	PUSH DE
 271+ 185F 16 00        	LD D,0
 272+ 1861 5F           	LD E,A
 273+ 1862 19           	ADD HL,DE
 274+ 1863 19           	ADD HL,DE
 275+ 1864 D1           	POP DE
 276+ 1865 7C           TP_2	LD A,H
 277+ 1866 02           	LD (BC),A
 278+ 1867 0B           	DEC BC
 279+ 1868 7D           	LD A,L
 280+ 1869 02           	LD (BC),A
 281+ 186A 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282+ 186B D6 F0        	SUB #F8*2
 283+ 186D 20 E3        	JR NZ,TP_0
 284+ 186F
 285+ 186F 3C           	INC A
 286+ 1870 32 B3 20     	LD (VARS1+VRS.DelyCnt),A
 287+ 1873 32 3A 21     	LD (VARS2+VRS.DelyCnt),A
 288+ 1876 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289+ 1879 22 64 20     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290+ 187C 22 81 20     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291+ 187F 22 9E 20     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292+ 1882 22 EB 20     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293+ 1885 22 08 21     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294+ 1888 22 25 21     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295+ 188B E1           	POP HL
 296+ 188C 22 56 20     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297+ 188F 22 73 20     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298+ 1892 22 90 20     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299+ 1895 22 DD 20     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300+ 1898 22 FA 20     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301+ 189B 22 17 21     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302+ 189E
 303+ 189E F1           	POP AF
 304+ 189F
 305+ 189F              ;NoteTableCreator (c) Ivan Roshin
 306+ 189F              ;A - NoteTableNumber*2+VersionForNoteTable
 307+ 189F              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308+ 189F
 309+ 189F 21 BD 1F     	LD HL,NT_DATA
 310+ 18A2 16 00        	LD D,0
 311+ 18A4 87           	ADD A,A
 312+ 18A5 5F           	LD E,A
 313+ 18A6 19           	ADD HL,DE
 314+ 18A7 5E           	LD E,(HL)
 315+ 18A8 23           	INC HL
 316+ 18A9 CB 3B        	SRL E
 317+ 18AB 9F           	SBC A,A
 318+ 18AC E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319+ 18AE 32 D6 18     	LD (L3),A
 320+ 18B1 EB           	EX DE,HL
 321+ 18B2 01 54 21     	LD BC,T1_
 322+ 18B5 09           	ADD HL,BC
 323+ 18B6
 324+ 18B6 1A           	LD A,(DE)
player.asm(325): warning: value 0x1FCD is truncated to 8bit value: 0xCD
 325+ 18B7 C6 CD        	ADD A,T_
 326+ 18B9 4F           	LD C,A
 327+ 18BA CE 1F        	ADC A,T_/256
 328+ 18BC 91           	SUB C
 329+ 18BD 47           	LD B,A
 330+ 18BE C5           	PUSH BC
 331+ 18BF 11 44 22     	LD DE,NT_
 332+ 18C2 D5           	PUSH DE
 333+ 18C3
 334+ 18C3 06 0C        	LD B,12
 335+ 18C5 C5           L1	PUSH BC
 336+ 18C6 4E           	LD C,(HL)
 337+ 18C7 23           	INC HL
 338+ 18C8 E5           	PUSH HL
 339+ 18C9 46           	LD B,(HL)
 340+ 18CA
 341+ 18CA D5           	PUSH DE
 342+ 18CB EB           	EX DE,HL
 343+ 18CC 11 17 00     	LD DE,23
 344+ 18CF DD 26 08     	LD IXH,8
 345+ 18D2
 346+ 18D2 CB 38        L2	SRL B
 347+ 18D4 CB 19        	RR C
 348+ 18D6 19           L3	DB #19	;AND A or NOP
 349+ 18D7 79           	LD A,C
 350+ 18D8 8A           	ADC A,D	;=ADC 0
 351+ 18D9 77           	LD (HL),A
 352+ 18DA 23           	INC HL
 353+ 18DB 78           	LD A,B
 354+ 18DC 8A           	ADC A,D
 355+ 18DD 77           	LD (HL),A
 356+ 18DE 19           	ADD HL,DE
 357+ 18DF DD 25        	DEC IXH
 358+ 18E1 20 EF        	JR NZ,L2
 359+ 18E3
 360+ 18E3 D1           	POP DE
 361+ 18E4 13           	INC DE
 362+ 18E5 13           	INC DE
 363+ 18E6 E1           	POP HL
 364+ 18E7 23           	INC HL
 365+ 18E8 C1           	POP BC
 366+ 18E9 10 DA        	DJNZ L1
 367+ 18EB
 368+ 18EB E1           	POP HL
 369+ 18EC D1           	POP DE
 370+ 18ED
 371+ 18ED 7B           	LD A,E
player.asm(372): warning: value 0x1FD9 is truncated to 8bit value: 0xD9
 372+ 18EE FE D9        	CP TCOLD_1
 373+ 18F0 20 05        	JR NZ,CORR_1
 374+ 18F2 3E FD        	LD A,#FD
 375+ 18F4 32 72 22     	LD (NT_+#2E),A
 376+ 18F7
 377+ 18F7 1A           CORR_1	LD A,(DE)
 378+ 18F8 A7           	AND A
 379+ 18F9 28 11        	JR Z,TC_EXIT
 380+ 18FB 1F           	RRA
 381+ 18FC F5           	PUSH AF
 382+ 18FD 87           	ADD A,A
 383+ 18FE 4F           	LD C,A
 384+ 18FF 09           	ADD HL,BC
 385+ 1900 F1           	POP AF
 386+ 1901 30 02        	JR NC,CORR_2
 387+ 1903 35           	DEC (HL)
 388+ 1904 35           	DEC (HL)
 389+ 1905 34           CORR_2	INC (HL)
 390+ 1906 A7           	AND A
 391+ 1907 ED 42        	SBC HL,BC
 392+ 1909 13           	INC DE
 393+ 190A 18 EB        	JR CORR_1
 394+ 190C
 395+ 190C              TC_EXIT
 396+ 190C
 397+ 190C F1           	POP AF
 398+ 190D
 399+ 190D              ;VolTableCreator (c) Ivan Roshin
 400+ 190D              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401+ 190D              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402+ 190D
 403+ 190D FE 05        	CP 5
 404+ 190F 21 11 00     	LD HL,#11
 405+ 1912 54           	LD D,H
 406+ 1913 5C           	LD E,H
 407+ 1914 3E 17        	LD A,#17
 408+ 1916 30 03        	JR NC,M1
 409+ 1918 2D           	DEC L
 410+ 1919 5D           	LD E,L
 411+ 191A AF           	XOR A
 412+ 191B 32 2C 19     M1      LD (M2),A
 413+ 191E
 414+ 191E DD 21 54 21  	LD IX,VT_+16
 415+ 1922
 416+ 1922 0E 0F        	LD C,#F
 417+ 1924 E5           INITV2  PUSH HL
 418+ 1925
 419+ 1925 19           	ADD HL,DE
 420+ 1926 EB           	EX DE,HL
 421+ 1927 ED 62        	SBC HL,HL
 422+ 1929
 423+ 1929 06 10        	LD B,#10
 424+ 192B 7D           INITV1  LD A,L
 425+ 192C 7D           M2      DB #7D
 426+ 192D 7C           	LD A,H
 427+ 192E CE 00        	ADC A,0
 428+ 1930 DD 77 00     	LD (IX),A
 429+ 1933 DD 23        	INC IX
 430+ 1935 19           	ADD HL,DE
 431+ 1936 10 F3        	DJNZ INITV1
 432+ 1938
 433+ 1938 E1           	POP HL
 434+ 1939 7B           	LD A,E
 435+ 193A FE 77        	CP #77
 436+ 193C 20 01        	JR NZ,M3
 437+ 193E 1C           	INC E
 438+ 193F 0D           M3      DEC C
 439+ 1940 20 E2        	JR NZ,INITV2
 440+ 1942
 441+ 1942 C3 8A 1F     	JP ROUT
 442+ 1945
 443+ 1945 CD B8 19     INITPT3	CALL SETMDAD
 444+ 1948 E5           	PUSH HL
 445+ 1949 11 64 00     	LD DE,100
 446+ 194C 19           	ADD HL,DE
 447+ 194D 7E           	LD A,(HL)
 448+ 194E FD 77 08     	LD (IY-100+VRS.Delay),A
 449+ 1951 E5           	PUSH HL
 450+ 1952 DD E1        	POP IX
 451+ 1954 19           	ADD HL,DE
 452+ 1955 CD C6 19     	CALL SETCPPT
 453+ 1958 DD 5E 02     	LD E,(IX+102-100)
 454+ 195B 23           	INC HL
 455+ 195C
 456+ 195C              	IF CurPosCounter
 457+ 195C ~            	LD (IY-100+VRS.PosSub),L
 458+ 195C              	ENDIF
 459+ 195C
 460+ 195C 19           	ADD HL,DE
 461+ 195D CD CD 19     	CALL SETLPPT
 462+ 1960 D1           	POP DE
 463+ 1961 DD 6E 03     	LD L,(IX+103-100)
 464+ 1964 DD 66 04     	LD H,(IX+104-100)
 465+ 1967 19           	ADD HL,DE
 466+ 1968 CD B1 19     	CALL SETPTPT
 467+ 196B 21 A9 00     	LD HL,169
 468+ 196E 19           	ADD HL,DE
 469+ 196F CD BF 19     	CALL SETORPT
 470+ 1972 21 69 00     	LD HL,105
 471+ 1975 19           	ADD HL,DE
 472+ 1976
 473+ 1976 FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474+ 1979 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475+ 197C C9           	RET
 476+ 197D
 477+ 197D 7E           INITPT2	LD A,(HL)
 478+ 197E FD 77 08     	LD (IY-100+VRS.Delay),A
 479+ 1981 E5           	PUSH HL
 480+ 1982 E5           	PUSH HL
 481+ 1983 E5           	PUSH HL
 482+ 1984 23           	INC HL
 483+ 1985 23           	INC HL
 484+ 1986 7E           	LD A,(HL)
 485+ 1987 23           	INC HL
 486+ 1988 CD 76 19     	CALL SETSMPT
 487+ 198B 5E           	LD E,(HL)
 488+ 198C 23           	INC HL
 489+ 198D 56           	LD D,(HL)
 490+ 198E E1           	POP HL
 491+ 198F A7           	AND A
 492+ 1990 ED 52        	SBC HL,DE
 493+ 1992 CD B8 19     	CALL SETMDAD
 494+ 1995 E1           	POP HL
 495+ 1996 11 43 00     	LD DE,67
 496+ 1999 19           	ADD HL,DE
 497+ 199A CD BF 19     	CALL SETORPT
 498+ 199D 1E 20        	LD E,32
 499+ 199F 19           	ADD HL,DE
 500+ 19A0 4E           	LD C,(HL)
 501+ 19A1 23           	INC HL
 502+ 19A2 46           	LD B,(HL)
 503+ 19A3 1E 1E        	LD E,30
 504+ 19A5 19           	ADD HL,DE
 505+ 19A6 CD C6 19     	CALL SETCPPT
 506+ 19A9 5F           	LD E,A
 507+ 19AA 23           	INC HL
 508+ 19AB
 509+ 19AB              	IF CurPosCounter
 510+ 19AB ~            	LD (IY-100+VRS.PosSub),L
 511+ 19AB              	ENDIF
 512+ 19AB
 513+ 19AB 19           	ADD HL,DE
 514+ 19AC CD CD 19     	CALL SETLPPT
 515+ 19AF E1           	POP HL
 516+ 19B0 09           	ADD HL,BC
 517+ 19B1
 518+ 19B1 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519+ 19B4 FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520+ 19B7 C9           	RET
 521+ 19B8
 522+ 19B8 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523+ 19BB FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524+ 19BE C9           	RET
 525+ 19BF
 526+ 19BF FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527+ 19C2 FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528+ 19C5 C9           	RET
 529+ 19C6
 530+ 19C6 FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531+ 19C9 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532+ 19CC C9           	RET
 533+ 19CD
 534+ 19CD FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535+ 19D0 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536+ 19D3 C9           	RET
 537+ 19D4
 538+ 19D4 FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539+ 19D7 FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540+ 19DA C9           	RET
 541+ 19DB
 542+ 19DB FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543+ 19DE FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544+ 19E1 C9           	RET
 545+ 19E2
 546+ 19E2 FD E5        GETIX	PUSH IY
 547+ 19E4 DD E1        	POP IX
 548+ 19E6 DD 19        	ADD IX,DE
 549+ 19E8 C9           	RET
 550+ 19E9
 551+ 19E9 CD E2 19     PTDECOD CALL GETIX
 552+ 19EC              PTDEC	EQU $+1
 553+ 19EC C3 C3 C3     	JP #C3C3
 554+ 19EF
 555+ 19EF              ;PT2 pattern decoder
 556+ 19EF CD 85 1C     PD2_SAM	CALL SETSAM
 557+ 19F2 18 4A        	JR PD2_LOOP
 558+ 19F4
 559+ 19F4 DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560+ 19F7 18 45        	JR PD2_LOOP
 561+ 19F9
 562+ 19F9 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563+ 19FD FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564+ 1A00 0A           	LD A,(BC)
 565+ 1A01 03           	INC BC
 566+ 1A02 6F           	LD L,A
 567+ 1A03 0A           	LD A,(BC)
 568+ 1A04 03           	INC BC
 569+ 1A05 67           	LD H,A
 570+ 1A06 CD D4 19     	CALL SETENBS
 571+ 1A09 18 33        	JR PD2_LOOP
 572+ 1A0B
 573+ 1A0B CD 66 1C     PD2_ORN	CALL SETORN
 574+ 1A0E 18 2E        	JR PD2_LOOP
 575+ 1A10
 576+ 1A10 3C           PD2_SKIP INC A
 577+ 1A11 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578+ 1A14 18 28        	JR PD2_LOOP
 579+ 1A16
 580+ 1A16 0F           PD2_VOL	RRCA
 581+ 1A17 0F           	RRCA
 582+ 1A18 0F           	RRCA
 583+ 1A19 0F           	RRCA
 584+ 1A1A DD 77 10     	LD (IX-12+CHP.Volume),A
 585+ 1A1D 18 1F        	JR PD2_LOOP
 586+ 1A1F
 587+ 1A1F CD 36 1C     PD2_DEL	CALL C_DELAY
 588+ 1A22 18 1A        	JR PD2_LOOP
 589+ 1A24
 590+ 1A24 DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591+ 1A28 3C           	INC A
 592+ 1A29 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593+ 1A2C DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594+ 1A2F 0A           	LD A,(BC)
 595+ 1A30 03           	INC BC
 596+ 1A31 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597+ 1A34 87           	ADD A,A
 598+ 1A35 9F           	SBC A,A
 599+ 1A36 DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600+ 1A39 37           	SCF
 601+ 1A3A 18 01        	JR PD2_LP2
 602+ 1A3C
 603+ 1A3C A7           PT2PD	AND A
 604+ 1A3D
 605+ 1A3D 08           PD2_LP2	EX AF,AF'
 606+ 1A3E
 607+ 1A3E 0A           PD2_LOOP LD A,(BC)
 608+ 1A3F 03           	INC BC
 609+ 1A40 C6 20        	ADD A,#20
 610+ 1A42 28 3F        	JR Z,PD2_REL
 611+ 1A44 38 A9        	JR C,PD2_SAM
 612+ 1A46 C6 60        	ADD A,96
 613+ 1A48 38 3E        	JR C,PD2_NOTE
 614+ 1A4A 3C           	INC A
 615+ 1A4B 28 A7        	JR Z,PD2_EOff
 616+ 1A4D C6 0F        	ADD A,15
 617+ 1A4F CA 65 1B     	JP Z,PD_FIN
 618+ 1A52 38 A5        	JR C,PD2_ENV
 619+ 1A54 C6 10        	ADD A,#10
 620+ 1A56 38 B3        	JR C,PD2_ORN
 621+ 1A58 C6 40        	ADD A,#40
 622+ 1A5A 38 B4        	JR C,PD2_SKIP
 623+ 1A5C C6 10        	ADD A,#10
 624+ 1A5E 38 B6        	JR C,PD2_VOL
 625+ 1A60 3C           	INC A
 626+ 1A61 28 BC        	JR Z,PD2_DEL
 627+ 1A63 3C           	INC A
 628+ 1A64 28 BE        	JR Z,PD2_GLIS
 629+ 1A66 3C           	INC A
 630+ 1A67 28 0A        	JR Z,PD2_PORT
 631+ 1A69 3C           	INC A
 632+ 1A6A 28 12        	JR Z,PD2_STOP
 633+ 1A6C 0A           	LD A,(BC)
 634+ 1A6D 03           	INC BC
 635+ 1A6E DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636+ 1A71 18 CB        	JR PD2_LOOP
 637+ 1A73
 638+ 1A73 DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639+ 1A77 0A           	LD A,(BC)
 640+ 1A78 03           	INC BC
 641+ 1A79 03           	INC BC ;ignoring precalc delta to right sound
 642+ 1A7A 03           	INC BC
 643+ 1A7B 37           	SCF
 644+ 1A7C 18 BF        	JR PD2_LP2
 645+ 1A7E
 646+ 1A7E DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647+ 1A81 18 BB        	JR PD2_LOOP
 648+ 1A83
 649+ 1A83 DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650+ 1A86 18 2C        	JR PD2_EXIT
 651+ 1A88
 652+ 1A88 6F           PD2_NOTE LD L,A
 653+ 1A89 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654+ 1A8C 32 9F 1B     	LD (PrNote+1),A
 655+ 1A8F DD 75 06     	LD (IX-12+CHP.Note),L
 656+ 1A92 AF           	XOR A
 657+ 1A93 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658+ 1A96 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659+ 1A9A 08           	EX AF,AF'
 660+ 1A9B 30 16        	JR NC,NOGLIS2
 661+ 1A9D DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662+ 1AA1 20 0C        	JR NZ,NOPORT2
 663+ 1AA3 32 C5 1B     	LD (LoStep),A
 664+ 1AA6 87           	ADD A,A
 665+ 1AA7 9F           	SBC A,A
 666+ 1AA8 08           	EX AF,AF'
 667+ 1AA9 67           	LD H,A
 668+ 1AAA 6F           	LD L,A
 669+ 1AAB 3C           	INC A
 670+ 1AAC CD 80 1B     	CALL SETPORT
 671+ 1AAF DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672+ 1AB3 AF           NOGLIS2	XOR A
 673+ 1AB4
 674+ 1AB4
 675+ 1AB4 DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676+ 1AB7 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677+ 1ABA DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678+ 1ABD DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679+ 1AC0 C3 65 1B     	JP PD_FIN
 680+ 1AC3
 681+ 1AC3              ;PT3 pattern decoder
 682+ 1AC3 DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683+ 1AC7 CD 66 1C     	CALL SETORN
 684+ 1ACA 0A           PD_SAM_	LD A,(BC)
 685+ 1ACB 03           	INC BC
 686+ 1ACC 0F           	RRCA
 687+ 1ACD
 688+ 1ACD CD 85 1C     PD_SAM	CALL SETSAM
 689+ 1AD0 18 3F        	JR PD_LOOP
 690+ 1AD2
 691+ 1AD2 0F           PD_VOL	RRCA
 692+ 1AD3 0F           	RRCA
 693+ 1AD4 0F           	RRCA
 694+ 1AD5 0F           	RRCA
 695+ 1AD6 DD 77 10     	LD (IX-12+CHP.Volume),A
 696+ 1AD9 18 39        	JR PD_LP2
 697+ 1ADB
 698+ 1ADB DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699+ 1ADE DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700+ 1AE1 18 31        	JR PD_LP2
 701+ 1AE3
 702+ 1AE3 3D           PD_SorE	DEC A
 703+ 1AE4 20 07        	JR NZ,PD_ENV
 704+ 1AE6 0A           	LD A,(BC)
 705+ 1AE7 03           	INC BC
 706+ 1AE8 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707+ 1AEB 18 27        	JR PD_LP2
 708+ 1AED
 709+ 1AED CD 4B 1C     PD_ENV	CALL SETENV
 710+ 1AF0 18 22        	JR PD_LP2
 711+ 1AF2
 712+ 1AF2 CD 66 1C     PD_ORN	CALL SETORN
 713+ 1AF5 18 1A        	JR PD_LOOP
 714+ 1AF7
 715+ 1AF7 DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716+ 1AFA DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717+ 1AFD C4 4B 1C     	CALL NZ,SETENV
 718+ 1B00 18 C8        	JR PD_SAM_
 719+ 1B02
 720+ 1B02 DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721+ 1B05 32 9F 1B     	LD (PrNote+1),A
 722+ 1B08 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723+ 1B0B DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724+ 1B0E 22 BC 1B     	LD (PrSlide+1),HL
 725+ 1B11
 726+ 1B11 11 10 20     PD_LOOP	LD DE,#2010
 727+ 1B14 0A           PD_LP2	LD A,(BC)
 728+ 1B15 03           	INC BC
 729+ 1B16 83           	ADD A,E
 730+ 1B17 38 AA        	JR C,PD_OrSm
 731+ 1B19 82           	ADD A,D
 732+ 1B1A 28 49        	JR Z,PD_FIN
 733+ 1B1C 38 AF        	JR C,PD_SAM
 734+ 1B1E 83           	ADD A,E
 735+ 1B1F 28 25        	JR Z,PD_REL
 736+ 1B21 38 AF        	JR C,PD_VOL
 737+ 1B23 83           	ADD A,E
 738+ 1B24 28 B5        	JR Z,PD_EOff
 739+ 1B26 38 BB        	JR C,PD_SorE
 740+ 1B28 C6 60        	ADD A,96
 741+ 1B2A 38 20        	JR C,PD_NOTE
 742+ 1B2C 83           	ADD A,E
 743+ 1B2D 38 C3        	JR C,PD_ORN
 744+ 1B2F 82           	ADD A,D
 745+ 1B30 38 0F        	JR C,PD_NOIS
 746+ 1B32 83           	ADD A,E
 747+ 1B33 38 C2        	JR C,PD_ESAM
 748+ 1B35 87           	ADD A,A
 749+ 1B36 5F           	LD E,A
 750+ 1B37 21 C1 FB     	LD HL,SPCCOMS+#FF20-#2000
 751+ 1B3A 19           	ADD HL,DE
 752+ 1B3B 5E           	LD E,(HL)
 753+ 1B3C 23           	INC HL
 754+ 1B3D 56           	LD D,(HL)
 755+ 1B3E D5           	PUSH DE
 756+ 1B3F 18 D0        	JR PD_LOOP
 757+ 1B41
 758+ 1B41 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759+ 1B44 18 CE        	JR PD_LP2
 760+ 1B46
 761+ 1B46 DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762+ 1B4A 18 08        	JR PD_RES
 763+ 1B4C
 764+ 1B4C DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765+ 1B4F DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766+ 1B53 AF           	XOR A
 767+ 1B54
 768+ 1B54 ED 73 63 1B  PD_RES	LD (PDSP_+1),SP
 769+ 1B58 DD F9        	LD SP,IX
 770+ 1B5A 67           	LD H,A
 771+ 1B5B 6F           	LD L,A
 772+ 1B5C E5           	PUSH HL
 773+ 1B5D E5           	PUSH HL
 774+ 1B5E E5           	PUSH HL
 775+ 1B5F E5           	PUSH HL
 776+ 1B60 E5           	PUSH HL
 777+ 1B61 E5           	PUSH HL
 778+ 1B62 31 31 31     PDSP_	LD SP,#3131
 779+ 1B65
 780+ 1B65 DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781+ 1B68 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782+ 1B6B C9           	RET
 783+ 1B6C
 784+ 1B6C 0A           C_PORTM LD A,(BC)
 785+ 1B6D 03           	INC BC
 786+ 1B6E              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787+ 1B6E              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788+ 1B6E 03           	INC BC
 789+ 1B6F 03           	INC BC
 790+ 1B70 08           	EX AF,AF'
 791+ 1B71 0A           	LD A,(BC) ;SIGNED TONE STEP
 792+ 1B72 03           	INC BC
 793+ 1B73 32 C5 1B     	LD (LoStep),A
 794+ 1B76 0A           	LD A,(BC)
 795+ 1B77 03           	INC BC
 796+ 1B78 A7           	AND A
 797+ 1B79 08           	EX AF,AF'
 798+ 1B7A DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799+ 1B7D DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800+ 1B80
 801+ 1B80              ;Set portamento variables
 802+ 1B80              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803+ 1B80
 804+ 1B80 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805+ 1B84 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806+ 1B87 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807+ 1B8A E5           	PUSH HL
 808+ 1B8B 11 44 22     	LD DE,NT_
 809+ 1B8E DD 7E 06     	LD A,(IX-12+CHP.Note)
 810+ 1B91 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811+ 1B94 87           	ADD A,A
 812+ 1B95 6F           	LD L,A
 813+ 1B96 26 00        	LD H,0
 814+ 1B98 19           	ADD HL,DE
 815+ 1B99 7E           	LD A,(HL)
 816+ 1B9A 23           	INC HL
 817+ 1B9B 66           	LD H,(HL)
 818+ 1B9C 6F           	LD L,A
 819+ 1B9D E5           	PUSH HL
 820+ 1B9E 3E 3E        PrNote	LD A,#3E
 821+ 1BA0 DD 77 06     	LD (IX-12+CHP.Note),A
 822+ 1BA3 87           	ADD A,A
 823+ 1BA4 6F           	LD L,A
 824+ 1BA5 26 00        	LD H,0
 825+ 1BA7 19           	ADD HL,DE
 826+ 1BA8 5E           	LD E,(HL)
 827+ 1BA9 23           	INC HL
 828+ 1BAA 56           	LD D,(HL)
 829+ 1BAB E1           	POP HL
 830+ 1BAC ED 52        	SBC HL,DE
 831+ 1BAE DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832+ 1BB1 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833+ 1BB4 D1           	POP DE
 834+ 1BB5              Version EQU $+1
 835+ 1BB5 3E 3E        	LD A,#3E
 836+ 1BB7 FE 06        	CP 6
 837+ 1BB9 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838+ 1BBB 11 11 11     PrSlide	LD DE,#1111
 839+ 1BBE DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840+ 1BC1 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841+ 1BC4              LoStep	EQU $+1
 842+ 1BC4 3E 3E        OLDPRTM	LD A,#3E
 843+ 1BC6 08           	EX AF,AF'
 844+ 1BC7 28 01        	JR Z,NOSIG
 845+ 1BC9 EB           	EX DE,HL
 846+ 1BCA ED 52        NOSIG	SBC HL,DE
 847+ 1BCC F2 D4 1B     	JP P,SET_STP
 848+ 1BCF 2F           	CPL
 849+ 1BD0 08           	EX AF,AF'
 850+ 1BD1 ED 44        	NEG
 851+ 1BD3 08           	EX AF,AF'
 852+ 1BD4 DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853+ 1BD7 08           	EX AF,AF'
 854+ 1BD8 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855+ 1BDB DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856+ 1BDF C9           	RET
 857+ 1BE0
 858+ 1BE0 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859+ 1BE4 0A           	LD A,(BC)
 860+ 1BE5 03           	INC BC
 861+ 1BE6 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862+ 1BE9 A7           	AND A
 863+ 1BEA 20 07        	JR NZ,GL36
 864+ 1BEC 3A B6 1B     	LD A,(Version) ;AlCo PT3.7+
 865+ 1BEF FE 07        	CP 7
 866+ 1BF1 9F           	SBC A,A
 867+ 1BF2 3C           	INC A
 868+ 1BF3 DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869+ 1BF6 0A           	LD A,(BC)
 870+ 1BF7 03           	INC BC
 871+ 1BF8 08           	EX AF,AF'
 872+ 1BF9 0A           	LD A,(BC)
 873+ 1BFA 03           	INC BC
 874+ 1BFB 18 D7        	JR SET_STP
 875+ 1BFD
 876+ 1BFD 0A           C_SMPOS	LD A,(BC)
 877+ 1BFE 03           	INC BC
 878+ 1BFF DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879+ 1C02 C9           	RET
 880+ 1C03
 881+ 1C03 0A           C_ORPOS	LD A,(BC)
 882+ 1C04 03           	INC BC
 883+ 1C05 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884+ 1C08 C9           	RET
 885+ 1C09
 886+ 1C09 0A           C_VIBRT	LD A,(BC)
 887+ 1C0A 03           	INC BC
 888+ 1C0B DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889+ 1C0E DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890+ 1C11 0A           	LD A,(BC)
 891+ 1C12 03           	INC BC
 892+ 1C13 DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893+ 1C16 AF           	XOR A
 894+ 1C17 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895+ 1C1A DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896+ 1C1D DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897+ 1C20 C9           	RET
 898+ 1C21
 899+ 1C21 0A           C_ENGLS	LD A,(BC)
 900+ 1C22 03           	INC BC
 901+ 1C23 FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902+ 1C26 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903+ 1C29 0A           	LD A,(BC)
 904+ 1C2A 03           	INC BC
 905+ 1C2B 6F           	LD L,A
 906+ 1C2C 0A           	LD A,(BC)
 907+ 1C2D 03           	INC BC
 908+ 1C2E 67           	LD H,A
 909+ 1C2F FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910+ 1C32 FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911+ 1C35 C9           	RET
 912+ 1C36
 913+ 1C36 0A           C_DELAY	LD A,(BC)
 914+ 1C37 03           	INC BC
 915+ 1C38 FD 77 08     	LD (IY-100+VRS.Delay),A
 916+ 1C3B 21 CF 20     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917+ 1C3E CB 4E        	BIT 1,(HL)
 918+ 1C40 C8           	RET Z
 919+ 1C41 32 B2 20     	LD (VARS1+VRS.Delay),A
 920+ 1C44 32 B3 20     	LD (VARS1+VRS.DelyCnt),A
 921+ 1C47 32 39 21     	LD (VARS2+VRS.Delay),A
 922+ 1C4A C9           	RET
 923+ 1C4B
 924+ 1C4B DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925+ 1C4E FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926+ 1C51 0A           	LD A,(BC)
 927+ 1C52 03           	INC BC
 928+ 1C53 67           	LD H,A
 929+ 1C54 0A           	LD A,(BC)
 930+ 1C55 03           	INC BC
 931+ 1C56 6F           	LD L,A
 932+ 1C57 CD D4 19     	CALL SETENBS
 933+ 1C5A AF           	XOR A
 934+ 1C5B DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935+ 1C5E FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936+ 1C61 67           	LD H,A
 937+ 1C62 6F           	LD L,A
 938+ 1C63 C3 DB 19     	JP SETESLD
 939+ 1C66
 940+ 1C66 87           SETORN	ADD A,A
 941+ 1C67 5F           	LD E,A
 942+ 1C68 16 00        	LD D,0
 943+ 1C6A DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944+ 1C6D FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945+ 1C70 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946+ 1C73 19           	ADD HL,DE
 947+ 1C74 5E           	LD E,(HL)
 948+ 1C75 23           	INC HL
 949+ 1C76 56           	LD D,(HL)
 950+ 1C77 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951+ 1C7A FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952+ 1C7D 19           	ADD HL,DE
 953+ 1C7E DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954+ 1C81 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955+ 1C84 C9           C_NOP	RET
 956+ 1C85
 957+ 1C85 87           SETSAM	ADD A,A
 958+ 1C86 5F           	LD E,A
 959+ 1C87 16 00        	LD D,0
 960+ 1C89 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961+ 1C8C FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962+ 1C8F 19           	ADD HL,DE
 963+ 1C90 5E           	LD E,(HL)
 964+ 1C91 23           	INC HL
 965+ 1C92 56           	LD D,(HL)
 966+ 1C93 FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967+ 1C96 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968+ 1C99 19           	ADD HL,DE
 969+ 1C9A DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970+ 1C9D DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971+ 1CA0 C9           	RET
 972+ 1CA1
 973+ 1CA1              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974+ 1CA1 84 1C        SPCCOMS DW C_NOP
 975+ 1CA3 E0 1B        	DW C_GLISS
 976+ 1CA5 6C 1B        	DW C_PORTM
 977+ 1CA7 FD 1B        	DW C_SMPOS
 978+ 1CA9 03 1C        	DW C_ORPOS
 979+ 1CAB 09 1C        	DW C_VIBRT
 980+ 1CAD 84 1C        	DW C_NOP
 981+ 1CAF 84 1C        	DW C_NOP
 982+ 1CB1 21 1C        	DW C_ENGLS
 983+ 1CB3 36 1C        	DW C_DELAY
 984+ 1CB5 84 1C        	DW C_NOP
 985+ 1CB7 84 1C        	DW C_NOP
 986+ 1CB9 84 1C        	DW C_NOP
 987+ 1CBB 84 1C        	DW C_NOP
 988+ 1CBD 84 1C        	DW C_NOP
 989+ 1CBF 84 1C        	DW C_NOP
 990+ 1CC1
 991+ 1CC1 CD E2 19     CHREGS	CALL GETIX
 992+ 1CC4 AF           	XOR A
 993+ 1CC5 32 01 1F     	LD (Ampl),A
 994+ 1CC8 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995+ 1CCC E5           	PUSH HL
 996+ 1CCD CA 14 1E     	JP Z,CH_EXIT
 997+ 1CD0 ED 73 5E 1D  	LD (CSP_+1),SP
 998+ 1CD4 DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999+ 1CD7 DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000+ 1CDA F9           	LD SP,HL
1001+ 1CDB D1           	POP DE
1002+ 1CDC 67           	LD H,A
1003+ 1CDD DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004+ 1CE0 6F           	LD L,A
1005+ 1CE1 39           	ADD HL,SP
1006+ 1CE2 3C           	INC A
1007+ 1CE3              		;PT2	PT3
1008+ 1CE3 3C           OrnCP	INC A	;CP E	CP D
1009+ 1CE4 38 01        	JR C,CH_ORPS
1010+ 1CE6 01           OrnLD	DB 1	;LD A,D	LD A,E
1011+ 1CE7 DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012+ 1CEA DD 7E 12     	LD A,(IX+CHP.Note)
1013+ 1CED 86           	ADD A,(HL)
1014+ 1CEE F2 F2 1C     	JP P,CH_NTP
1015+ 1CF1 AF           	XOR A
1016+ 1CF2 FE 60        CH_NTP	CP 96
1017+ 1CF4 38 02        	JR C,CH_NOK
1018+ 1CF6 3E 5F        	LD A,95
1019+ 1CF8 87           CH_NOK	ADD A,A
1020+ 1CF9 08           	EX AF,AF'
1021+ 1CFA DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022+ 1CFD DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023+ 1D00 F9           	LD SP,HL
1024+ 1D01 D1           	POP DE
1025+ 1D02 26 00        	LD H,0
1026+ 1D04 DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027+ 1D07 47           	LD B,A
1028+ 1D08 87           	ADD A,A
1029+ 1D09 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030+ 1D0A 6F           	LD L,A
1031+ 1D0B 39           	ADD HL,SP
1032+ 1D0C F9           	LD SP,HL
1033+ 1D0D 78           	LD A,B
1034+ 1D0E 3C           	INC A
1035+ 1D0F              		;PT2	PT3
1036+ 1D0F 3C           SamCP	INC A	;CP E	CP D
1037+ 1D10 38 01        	JR C,CH_SMPS
1038+ 1D12 01           SamLD	DB 1	;LD A,D	LD A,E
1039+ 1D13 DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040+ 1D16 C1           	POP BC
1041+ 1D17 E1           	POP HL
1042+ 1D18
1043+ 1D18              ;Convert PT2 sample to PT3
1044+ 1D18              		;PT2		PT3
1045+ 1D18 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046+ 1D19 E1           	POP HL
1047+ 1D1A 60           	LD H,B
1048+ 1D1B 20 06        	JR NZ,$+8
1049+ 1D1D EB           	EX DE,HL
1050+ 1D1E A7           	AND A
1051+ 1D1F ED 62        	SBC HL,HL
1052+ 1D21 ED 52        	SBC HL,DE
1053+ 1D23 51           	LD D,C
1054+ 1D24 CB 19        	RR C
1055+ 1D26 9F           	SBC A,A
1056+ 1D27 2F           	CPL
1057+ 1D28 E6 3E        	AND #3E
1058+ 1D2A CB 19        	RR C
1059+ 1D2C CB 18        	RR B
1060+ 1D2E A1           	AND C
1061+ 1D2F 4F           	LD C,A
1062+ 1D30 78           	LD A,B
1063+ 1D31 1F           	RRA
1064+ 1D32 1F           	RRA
1065+ 1D33 CB 1A        	RR D
1066+ 1D35 1F           	RRA
1067+ 1D36 E6 9F        	AND #9F
1068+ 1D38 47           	LD B,A
1069+ 1D39
1070+ 1D39 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071+ 1D3C DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072+ 1D3F 19           	ADD HL,DE
1073+ 1D40 CB 70        	BIT 6,B
1074+ 1D42 28 06        	JR Z,CH_NOAC
1075+ 1D44 DD 75 08     	LD (IX+CHP.TnAcc),L
1076+ 1D47 DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077+ 1D4A EB           CH_NOAC EX DE,HL
1078+ 1D4B 08           	EX AF,AF'
player.asm(1079): warning: value 0x2244 is truncated to 8bit value: 0x44
1079+ 1D4C C6 44        	ADD A,NT_
1080+ 1D4E 6F           	LD L,A
1081+ 1D4F CE 22        	ADC A,NT_/256
1082+ 1D51 95           	SUB L
1083+ 1D52 67           	LD H,A
1084+ 1D53 F9           	LD SP,HL
1085+ 1D54 E1           	POP HL
1086+ 1D55 19           	ADD HL,DE
1087+ 1D56 DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088+ 1D59 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089+ 1D5C 19           	ADD HL,DE
1090+ 1D5D 31 31 31     CSP_	LD SP,#3131
1091+ 1D60 E3           	EX (SP),HL
1092+ 1D61 AF           	XOR A
1093+ 1D62 DD B6 05     	OR (IX+CHP.TSlCnt)
1094+ 1D65 28 3E        	JR Z,CH_AMP
1095+ 1D67 DD 35 05     	DEC (IX+CHP.TSlCnt)
1096+ 1D6A 20 39        	JR NZ,CH_AMP
1097+ 1D6C DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098+ 1D6F DD 77 05     	LD (IX+CHP.TSlCnt),A
1099+ 1D72 DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100+ 1D75 DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101+ 1D78 7C           	LD A,H
1102+ 1D79 19           	ADD HL,DE
1103+ 1D7A DD 75 06     	LD (IX+CHP.CrTnSl),L
1104+ 1D7D DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105+ 1D80 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106+ 1D84 20 1F        	JR NZ,CH_AMP
1107+ 1D86 DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108+ 1D89 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109+ 1D8C A7           	AND A
1110+ 1D8D 28 01        	JR Z,CH_STPP
1111+ 1D8F EB           	EX DE,HL
1112+ 1D90 ED 52        CH_STPP SBC HL,DE
1113+ 1D92 FA A5 1D     	JP M,CH_AMP
1114+ 1D95 DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115+ 1D98 DD 77 12     	LD (IX+CHP.Note),A
1116+ 1D9B AF           	XOR A
1117+ 1D9C DD 77 05     	LD (IX+CHP.TSlCnt),A
1118+ 1D9F DD 77 06     	LD (IX+CHP.CrTnSl),A
1119+ 1DA2 DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120+ 1DA5 DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121+ 1DA8 CB 79        	BIT 7,C
1122+ 1DAA 28 13        	JR Z,CH_NOAM
1123+ 1DAC CB 71        	BIT 6,C
1124+ 1DAE 28 07        	JR Z,CH_AMIN
1125+ 1DB0 FE 0F        	CP 15
1126+ 1DB2 28 0B        	JR Z,CH_NOAM
1127+ 1DB4 3C           	INC A
1128+ 1DB5 18 05        	JR CH_SVAM
1129+ 1DB7 FE F1        CH_AMIN	CP -15
1130+ 1DB9 28 04        	JR Z,CH_NOAM
1131+ 1DBB 3D           	DEC A
1132+ 1DBC DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133+ 1DBF 6F           CH_NOAM	LD L,A
1134+ 1DC0 78           	LD A,B
1135+ 1DC1 E6 0F        	AND 15
1136+ 1DC3 85           	ADD A,L
1137+ 1DC4 F2 C8 1D     	JP P,CH_APOS
1138+ 1DC7 AF           	XOR A
1139+ 1DC8 FE 10        CH_APOS	CP 16
1140+ 1DCA 38 02        	JR C,CH_VOL
1141+ 1DCC 3E 0F        	LD A,15
1142+ 1DCE DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x2144 is truncated to 8bit value: 0x44
1143+ 1DD1 C6 44        	ADD A,VT_
1144+ 1DD3 6F           	LD L,A
1145+ 1DD4 CE 21        	ADC A,VT_/256
1146+ 1DD6 95           	SUB L
1147+ 1DD7 67           	LD H,A
1148+ 1DD8 7E           	LD A,(HL)
1149+ 1DD9 CB 41        CH_ENV	BIT 0,C
1150+ 1DDB 20 03        	JR NZ,CH_NOEN
1151+ 1DDD DD B6 14     	OR (IX+CHP.Env_En)
1152+ 1DE0 32 01 1F     CH_NOEN	LD (Ampl),A
1153+ 1DE3 CB 78        	BIT 7,B
1154+ 1DE5 79           	LD A,C
1155+ 1DE6 28 1A        	JR Z,NO_ENSL
1156+ 1DE8 17           	RLA
1157+ 1DE9 17           	RLA
1158+ 1DEA CB 2F        	SRA A
1159+ 1DEC CB 2F        	SRA A
1160+ 1DEE CB 2F        	SRA A
1161+ 1DF0 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162+ 1DF3 CB 68        	BIT 5,B
1163+ 1DF5 28 03        	JR Z,NO_ENAC
1164+ 1DF7 DD 77 04     	LD (IX+CHP.CrEnSl),A
1165+ 1DFA FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166+ 1DFD FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167+ 1E00 18 0E        	JR CH_MIX
1168+ 1E02 1F           NO_ENSL RRA
1169+ 1E03 DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170+ 1E06 FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171+ 1E09 CB 68        	BIT 5,B
1172+ 1E0B 28 03        	JR Z,CH_MIX
1173+ 1E0D DD 77 03     	LD (IX+CHP.CrNsSl),A
1174+ 1E10 78           CH_MIX	LD A,B
1175+ 1E11 1F           	RRA
1176+ 1E12 E6 48        	AND #48
1177+ 1E14 FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178+ 1E17 0F           	RRCA
1179+ 1E18 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180+ 1E1B E1           	POP HL
1181+ 1E1C AF           	XOR A
1182+ 1E1D DD B6 0A     	OR (IX+CHP.COnOff)
1183+ 1E20 C8           	RET Z
1184+ 1E21 DD 35 0A     	DEC (IX+CHP.COnOff)
1185+ 1E24 C0           	RET NZ
1186+ 1E25 DD AE 15     	XOR (IX+CHP.Flags)
1187+ 1E28 DD 77 15     	LD (IX+CHP.Flags),A
1188+ 1E2B 1F           	RRA
1189+ 1E2C DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190+ 1E2F 38 03        	JR C,CH_ONDL
1191+ 1E31 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192+ 1E34 DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193+ 1E37 C9           	RET
1194+ 1E38
1195+ 1E38 AF           PLAY_	XOR A
1196+ 1E39 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197+ 1E3C FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198+ 1E3F 3D           	DEC A
1199+ 1E40 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200+ 1E43 FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201+ 1E46 C2 EE 1E     	JP NZ,PL2
1202+ 1E49 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203+ 1E4C 20 6C        	JR NZ,PL1B
1204+ 1E4E FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205+ 1E51 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206+ 1E54 0A           	LD A,(BC)
1207+ 1E55 A7           	AND A
1208+ 1E56 20 56        	JR NZ,PL1A
1209+ 1E58 57           	LD D,A
1210+ 1E59 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211+ 1E5C FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212+ 1E5F FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213+ 1E62 23           	INC HL
1214+ 1E63 7E           	LD A,(HL)
1215+ 1E64 3C           	INC A
1216+ 1E65 20 0B        	JR NZ,PLNLP
1217+ 1E67
1218+ 1E67              	IF LoopChecker
1219+ 1E67 CD 19 17     	CALL CHECKLP
1220+ 1E6A              	ENDIF
1221+ 1E6A
1222+ 1E6A FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223+ 1E6D FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224+ 1E70 7E           	LD A,(HL)
1225+ 1E71 3C           	INC A
1226+ 1E72 CD C6 19     PLNLP	CALL SETCPPT
1227+ 1E75 3D           	DEC A
1228+ 1E76 FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229+ 1E7A 28 03        	JR Z,NoAlCo
1230+ 1E7C              TSSub	EQU $+1
1231+ 1E7C D6 D6        	SUB #D6
1232+ 1E7E 2F           	CPL
1233+ 1E7F              NoAlCo
1234+ 1E7F              		;PT2		PT3
1235+ 1E7F 3D           PsCalc	DEC A	;ADD A,A	NOP
1236+ 1E80 3D           	DEC A	;ADD A,(HL)	NOP
1237+ 1E81 87           	ADD A,A
1238+ 1E82 5F           	LD E,A
1239+ 1E83 CB 12        	RL D
1240+ 1E85
1241+ 1E85              	IF CurPosCounter
1242+ 1E85 ~            	LD A,L
1243+ 1E85 ~            	SUB (IY-100+VRS.PosSub)
1244+ 1E85 ~            	LD (IY-100+VRS.CurPos),A
1245+ 1E85              	ENDIF
1246+ 1E85
1247+ 1E85 FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248+ 1E88 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249+ 1E8B 19           	ADD HL,DE
1250+ 1E8C FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251+ 1E8F FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252+ 1E92 ED 73 AC 1E  	LD (PSP_+1),SP
1253+ 1E96 F9           	LD SP,HL
1254+ 1E97 E1           	POP HL
1255+ 1E98 19           	ADD HL,DE
1256+ 1E99 44           	LD B,H
1257+ 1E9A 4D           	LD C,L
1258+ 1E9B E1           	POP HL
1259+ 1E9C 19           	ADD HL,DE
1260+ 1E9D FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261+ 1EA0 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262+ 1EA3 E1           	POP HL
1263+ 1EA4 19           	ADD HL,DE
1264+ 1EA5 FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265+ 1EA8 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266+ 1EAB 31 31 31     PSP_	LD SP,#3131
1267+ 1EAE 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268+ 1EB1 CD E9 19     	CALL PTDECOD
1269+ 1EB4 FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270+ 1EB7 FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271+ 1EBA
1272+ 1EBA FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273+ 1EBD 20 12        	JR NZ,PL1C
1274+ 1EBF 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275+ 1EC2 FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276+ 1EC5 FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277+ 1EC8 CD E9 19     	CALL PTDECOD
1278+ 1ECB FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279+ 1ECE FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280+ 1ED1
1281+ 1ED1 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282+ 1ED4 20 12        	JR NZ,PL1D
1283+ 1ED6 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284+ 1ED9 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285+ 1EDC FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286+ 1EDF CD E9 19     	CALL PTDECOD
1287+ 1EE2 FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288+ 1EE5 FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289+ 1EE8
1290+ 1EE8 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291+ 1EEB FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292+ 1EEE
1293+ 1EEE 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294+ 1EF1 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295+ 1EF4 FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296+ 1EF7 CD C1 1C     	CALL CHREGS
1297+ 1EFA FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298+ 1EFD FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299+ 1F00              Ampl	EQU $+1
1300+ 1F00 3E 3E        	LD A,#3E
1301+ 1F02 FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302+ 1F05 11 BC FF     	LD DE,VRS.ChanB-100
1303+ 1F08 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304+ 1F0B FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305+ 1F0E CD C1 1C     	CALL CHREGS
1306+ 1F11 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307+ 1F14 FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308+ 1F17 3A 01 1F     	LD A,(Ampl)
1309+ 1F1A FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310+ 1F1D 11 D9 FF     	LD DE,VRS.ChanC-100
1311+ 1F20 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312+ 1F23 FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313+ 1F26 CD C1 1C     	CALL CHREGS
1314+ 1F29 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315+ 1F2C FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316+ 1F2F 3A 01 1F     	LD A,(Ampl)
1317+ 1F32 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318+ 1F35
1319+ 1F35 FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320+ 1F38 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321+ 1F3B FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322+ 1F3E
1323+ 1F3E FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324+ 1F41 5F           	LD E,A
1325+ 1F42 87           	ADD A,A
1326+ 1F43 9F           	SBC A,A
1327+ 1F44 57           	LD D,A
1328+ 1F45 FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329+ 1F48 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330+ 1F4B 19           	ADD HL,DE
1331+ 1F4C FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332+ 1F4F FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333+ 1F52 19           	ADD HL,DE
1334+ 1F53 FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335+ 1F56 FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336+ 1F59
1337+ 1F59 AF           	XOR A
1338+ 1F5A FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339+ 1F5D C8           	RET Z
1340+ 1F5E FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341+ 1F61 C0           	RET NZ
1342+ 1F62 FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343+ 1F65 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344+ 1F68 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345+ 1F6B FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346+ 1F6E 19           	ADD HL,DE
1347+ 1F6F C3 DB 19     	JP SETESLD
1348+ 1F72
1349+ 1F72 FD 21 AA 20  PLAY    LD IY,VARS1+100
1350+ 1F76 CD 38 1E     	CALL PLAY_
1351+ 1F79 3A 45 20     	LD A,(is_ts)
1352+ 1F7C A7           	AND A
1353+ 1F7D 28 07        	JR Z,PL_nts
1354+ 1F7F FD 21 31 21  	LD IY,VARS2+100
1355+ 1F83 CD 38 1E     	CALL PLAY_
1356+ 1F86              PL_nts
1357+ 1F86              	IF Basic
1358+ 1F86 FD 21 3A 5C  	LD IY,#5C3A
1359+ 1F8A              	ENDIF
1360+ 1F8A
1361+ 1F8A 01 FD FF     ROUT	LD BC,#FFFD
1362+ 1F8D 3A 45 20     	LD A,(is_ts)
1363+ 1F90 A7           	AND A
1364+ 1F91 28 02        	JR Z,r_nts ;keep old standard
1365+ 1F93 ED 41        	OUT (C),B
1366+ 1F95 08           r_nts	EX AF,AF'
1367+ 1F96
1368+ 1F96              	IF ACBBAC
1369+ 1F96 ~            	LD IX,VARS1+VRS.AYREGS
1370+ 1F96              	ELSE
1371+ 1F96 21 BF 20     	LD HL,VARS1+VRS.AYREGS
1372+ 1F99              	ENDIF
1373+ 1F99
1374+ 1F99 CD A5 1F     	CALL ROUT_
1375+ 1F9C 08           	EX AF,AF'
1376+ 1F9D C8           	RET Z
1377+ 1F9E 42           	LD B,D
1378+ 1F9F 2F           	CPL
1379+ 1FA0 ED 79        	OUT (C),A
1380+ 1FA2
1381+ 1FA2              	IF ACBBAC
1382+ 1FA2 ~            	LD IX,VARS2+VRS.AYREGS
1383+ 1FA2              	ELSE
1384+ 1FA2 21 46 21     	LD HL,VARS2+VRS.AYREGS
1385+ 1FA5              	ENDIF
1386+ 1FA5
1387+ 1FA5              ROUT_
1388+ 1FA5              	IF ACBBAC
1389+ 1FA5 ~            	LD A,(SETUP)
1390+ 1FA5 ~            	AND 12
1391+ 1FA5 ~            	JR Z,ABC
1392+ 1FA5 ~            	ADD A,CHTABLE
1393+ 1FA5 ~            	LD E,A
1394+ 1FA5 ~            	ADC A,CHTABLE/256
1395+ 1FA5 ~            	SUB E
1396+ 1FA5 ~            	LD D,A
1397+ 1FA5 ~            	LD B,0
1398+ 1FA5 ~            	PUSH IX
1399+ 1FA5 ~            	POP HL
1400+ 1FA5 ~            	LD A,(DE)
1401+ 1FA5 ~            	INC DE
1402+ 1FA5 ~            	LD C,A
1403+ 1FA5 ~            	ADD HL,BC
1404+ 1FA5 ~            	LD A,(IX+TonB)
1405+ 1FA5 ~            	LD C,(HL)
1406+ 1FA5 ~            	LD (IX+TonB),C
1407+ 1FA5 ~            	LD (HL),A
1408+ 1FA5 ~            	INC HL
1409+ 1FA5 ~            	LD A,(IX+TonB+1)
1410+ 1FA5 ~            	LD C,(HL)
1411+ 1FA5 ~            	LD (IX+TonB+1),C
1412+ 1FA5 ~            	LD (HL),A
1413+ 1FA5 ~            	LD A,(DE)
1414+ 1FA5 ~            	INC DE
1415+ 1FA5 ~            	LD C,A
1416+ 1FA5 ~            	ADD HL,BC
1417+ 1FA5 ~            	LD A,(IX+AmplB)
1418+ 1FA5 ~            	LD C,(HL)
1419+ 1FA5 ~            	LD (IX+AmplB),C
1420+ 1FA5 ~            	LD (HL),A
1421+ 1FA5 ~            	LD A,(DE)
1422+ 1FA5 ~            	INC DE
1423+ 1FA5 ~            	LD (RxCA1),A
1424+ 1FA5 ~            	XOR 8
1425+ 1FA5 ~            	LD (RxCA2),A
1426+ 1FA5 ~            	LD A,(DE)
1427+ 1FA5 ~            	AND (IX+Mixer)
1428+ 1FA5 ~            	LD E,A
1429+ 1FA5 ~            	LD A,(IX+Mixer)
1430+ 1FA5 ~            RxCA1	DB #E6
1431+ 1FA5 ~            	AND %010010
1432+ 1FA5 ~            	OR E
1433+ 1FA5 ~            	LD E,A
1434+ 1FA5 ~            	LD A,(IX+Mixer)
1435+ 1FA5 ~            	AND %010010
1436+ 1FA5 ~            RxCA2	OR E
1437+ 1FA5 ~            	OR E
1438+ 1FA5 ~            	LD (IX+Mixer),A
1439+ 1FA5 ~            ABC
1440+ 1FA5              	ENDIF
1441+ 1FA5
1442+ 1FA5 AF           	XOR A
1443+ 1FA6 11 BF FF     	LD DE,#FFBF
1444+ 1FA9
1445+ 1FA9              	IF ACBBAC
1446+ 1FA9 ~            	LD BC,#FFFD
1447+ 1FA9 ~            	PUSH IX
1448+ 1FA9 ~            	POP HL
1449+ 1FA9              	ENDIF
1450+ 1FA9
1451+ 1FA9 ED 79        LOUT	OUT (C),A
1452+ 1FAB 43           	LD B,E
1453+ 1FAC ED A3        	OUTI
1454+ 1FAE 42           	LD B,D
1455+ 1FAF 3C           	INC A
1456+ 1FB0 FE 0D        	CP 13
1457+ 1FB2 20 F5        	JR NZ,LOUT
1458+ 1FB4 ED 79        	OUT (C),A
1459+ 1FB6 7E           	LD A,(HL)
1460+ 1FB7 A7           	AND A
1461+ 1FB8 F8           	RET M
1462+ 1FB9 43           	LD B,E
1463+ 1FBA ED 79        	OUT (C),A
1464+ 1FBC C9           	RET
1465+ 1FBD
1466+ 1FBD              	IF ACBBAC
1467+ 1FBD ~            CHTABLE	EQU $-4
1468+ 1FBD ~            	DB 4,5,15,%001001,0,7,7,%100100
1469+ 1FBD              	ENDIF
1470+ 1FBD
1471+ 1FBD 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472+ 1FBE 2A           	DB TCNEW_0-T_
1473+ 1FBF 65           	DB (T_OLD_0-T1_)*2+1
1474+ 1FC0 00           	DB TCOLD_0-T_
1475+ 1FC1 01           	DB (T_NEW_1-T1_)*2+1
1476+ 1FC2 0C           	DB TCNEW_1-T_
1477+ 1FC3 01           	DB (T_OLD_1-T1_)*2+1
1478+ 1FC4 0C           	DB TCOLD_1-T_
1479+ 1FC5 94           	DB (T_NEW_2-T1_)*2
1480+ 1FC6 35           	DB TCNEW_2-T_
1481+ 1FC7 30           	DB (T_OLD_2-T1_)*2
1482+ 1FC8 0E           	DB TCOLD_2-T_
1483+ 1FC9 60           	DB (T_NEW_3-T1_)*2
1484+ 1FCA 20           	DB TCNEW_3-T_
1485+ 1FCB 60           	DB (T_OLD_3-T1_)*2
1486+ 1FCC 21           	DB TCOLD_3-T_
1487+ 1FCD
1488+ 1FCD              T_
1489+ 1FCD
1490+ 1FCD 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490+ 1FD1 0D 0F 13 15
1491+ 1FD5 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492+ 1FD9 5D 00        TCOLD_1	DB #5C+1,0
1493+ 1FDB 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493+ 1FDF 5F 71 82 8C
1493+ 1FE3 9C
1494+ 1FE4 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494+ 1FE8 AA AC AE AE
1494+ 1FEC 00
1495+ 1FED 57           TCNEW_3	DB #56+1
1496+ 1FEE 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496+ 1FF2 2D 2F 33 BF
1496+ 1FF6 00
1497+ 1FF7 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497+ 1FFB 2B 2D 31 55
1498+ 1FFF BD BF 00     	DB #BC+1,#BE+1,0
1499+ 2002              TCNEW_1 EQU TCOLD_1
1500+ 2002 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500+ 2006 2B 3B 4D 5F
1501+ 200A BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502+ 200E
1503+ 200E              PT3EMPTYORN EQU $-1
1504+ 200E 01 00        	DB 1,0
1505+ 2010
1506+ 2010              ;first 12 values of tone tables (packed)
1507+ 2010
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508+ 2010 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509+ 2012 69           	DB #0755-#06EC
1510+ 2013 70           	DB #07C5-#0755
1511+ 2014 76           	DB #083B-#07C5
1512+ 2015 7D           	DB #08B8-#083B
1513+ 2016 85           	DB #093D-#08B8
1514+ 2017 8D           	DB #09CA-#093D
1515+ 2018 95           	DB #0A5F-#09CA
1516+ 2019 9D           	DB #0AFC-#0A5F
1517+ 201A A8           	DB #0BA4-#0AFC
1518+ 201B B1           	DB #0C55-#0BA4
1519+ 201C BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520+ 201D 0C DA        	DB #066D*2/256,#066D*2
1521+ 201F 62           	DB #06CF-#066D
1522+ 2020 68           	DB #0737-#06CF
1523+ 2021 6D           	DB #07A4-#0737
1524+ 2022 75           	DB #0819-#07A4
1525+ 2023 7B           	DB #0894-#0819
1526+ 2024 83           	DB #0917-#0894
1527+ 2025 8A           	DB #09A1-#0917
1528+ 2026 92           	DB #0A33-#09A1
1529+ 2027 9C           	DB #0ACF-#0A33
1530+ 2028 A4           	DB #0B73-#0ACF
1531+ 2029 AF           	DB #0C22-#0B73
1532+ 202A B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533+ 202B 0E 08        	DB #0704*2/256,#0704*2
1534+ 202D 6A           	DB #076E-#0704
1535+ 202E 72           	DB #07E0-#076E
1536+ 202F 78           	DB #0858-#07E0
1537+ 2030 7E           	DB #08D6-#0858
1538+ 2031 86           	DB #095C-#08D6
1539+ 2032 90           	DB #09EC-#095C
1540+ 2033 96           	DB #0A82-#09EC
1541+ 2034 A0           	DB #0B22-#0A82
1542+ 2035 AA           	DB #0BCC-#0B22
1543+ 2036 B4           	DB #0C80-#0BCC
1544+ 2037 BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545+ 2038 0F C0        	DB #07E0*2/256,#07E0*2
1546+ 203A 78           	DB #0858-#07E0
1547+ 203B 88           	DB #08E0-#0858
1548+ 203C 80           	DB #0960-#08E0
1549+ 203D 90           	DB #09F0-#0960
1550+ 203E 98           	DB #0A88-#09F0
1551+ 203F A0           	DB #0B28-#0A88
1552+ 2040 B0           	DB #0BD8-#0B28
1553+ 2041 A8           	DB #0C80-#0BD8
1554+ 2042 E0           	DB #0D60-#0C80
1555+ 2043 B0           	DB #0E10-#0D60
1556+ 2044 E8           	DB #0EF8-#0E10
1557+ 2045
1558+ 2045              ;vars from here can be stripped
1559+ 2045              ;you can move VARS to any other address
1560+ 2045
1561+ 2045              VARS
1562+ 2045
1563+ 2045 00           is_ts	DB 0
1564+ 2046
1565+ 2046              ;ChannelsVars
1566+ 2046              	STRUCT	CHP
1567+ 2046 ~            ;reset group
1568+ 2046 ~            PsInOr	DB 0
1569+ 2046 ~            PsInSm	DB 0
1570+ 2046 ~            CrAmSl	DB 0
1571+ 2046 ~            CrNsSl	DB 0
1572+ 2046 ~            CrEnSl	DB 0
1573+ 2046 ~            TSlCnt	DB 0
1574+ 2046 ~            CrTnSl	DW 0
1575+ 2046 ~            TnAcc	DW 0
1576+ 2046 ~            COnOff	DB 0
1577+ 2046 ~            ;reset group
1578+ 2046 ~
1579+ 2046 ~            OnOffD	DB 0
1580+ 2046 ~
1581+ 2046 ~            ;IX for PTDECOD here (+12)
1582+ 2046 ~            OffOnD	DB 0
1583+ 2046 ~            OrnPtr	DW 0
1584+ 2046 ~            SamPtr	DW 0
1585+ 2046 ~            NNtSkp	DB 0
1586+ 2046 ~            Note	DB 0
1587+ 2046 ~            SlToNt	DB 0
1588+ 2046 ~            Env_En	DB 0
1589+ 2046 ~            Flags	DB 0
1590+ 2046 ~             ;Enabled - 0, SimpleGliss - 2
1591+ 2046 ~            TnSlDl	DB 0
1592+ 2046 ~            TSlStp	DW 0
1593+ 2046 ~            TnDelt	DW 0
1594+ 2046 ~            NtSkCn	DB 0
1595+ 2046 ~            Volume	DB 0
1596+ 2046              	ENDS
1597+ 2046
1598+ 2046              	STRUCT	VRS
1599+ 2046 ~
1600+ 2046 ~            ;IF not works in STRUCT in SjASM :(
1601+ 2046 ~            ;	IF CurPosCounter
1602+ 2046 ~            CurPos	DB 0
1603+ 2046 ~            PosSub	DB 0
1604+ 2046 ~            ;	ENDIF
1605+ 2046 ~
1606+ 2046 ~            ModNum	DB 0 ;bit0: ChipNum
1607+ 2046 ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608+ 2046 ~
1609+ 2046 ~            ChanA	DS CHP
1610+ 2046 ~            ChanB	DS CHP
1611+ 2046 ~            ChanC	DS CHP
1612+ 2046 ~
1613+ 2046 ~            ;GlobalVars
1614+ 2046 ~            MODADDR	DW 0
1615+ 2046 ~            OrnPtrs	DW 0
1616+ 2046 ~            SamPtrs	DW 0
1617+ 2046 ~            PatsPtr	DW 0
1618+ 2046 ~            AdInPtA	DW 0
1619+ 2046 ~            AdInPtB	DW 0
1620+ 2046 ~            AdInPtC	DW 0
1621+ 2046 ~            CrPsPtr	DW 0
1622+ 2046 ~            LPosPtr	DW 0
1623+ 2046 ~            Delay	DB 0
1624+ 2046 ~            DelyCnt	DB 0
1625+ 2046 ~            ESldAdd	DW 0
1626+ 2046 ~            CurESld	DW 0
1627+ 2046 ~            Env_Del	DB 0
1628+ 2046 ~            CurEDel	DB 0
1629+ 2046 ~            Ns_Base	DB 0
1630+ 2046 ~            AddToNs	DB 0
1631+ 2046 ~            AddToEn	DB 0
1632+ 2046 ~            EnvBase	DW 0
1633+ 2046 ~            AYREGS	DS 14
1634+ 2046              	ENDS
1635+ 2046
1636+ 2046 00 00 00...  VARS1	DS VRS
1637+ 20CD 00 00 00...  VARS2	DS VRS
1638+ 2154
1639+ 2154              VT_	EQU $-16
1640+ 2154 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641+ 2244
1642+ 2244              T1_	EQU VT_+16 ;Tone tables data depacked here
1643+ 2244
1644+ 2244              T_OLD_1	EQU T1_
1645+ 2244              T_OLD_2	EQU T_OLD_1+24
1646+ 2244              T_OLD_3	EQU T_OLD_2+24
1647+ 2244              T_OLD_0	EQU T_OLD_3+2
1648+ 2244              T_NEW_0	EQU T_OLD_0
1649+ 2244              T_NEW_1	EQU T_OLD_1
1650+ 2244              T_NEW_2	EQU T_NEW_0+24
1651+ 2244              T_NEW_3	EQU T_OLD_3
1652+ 2244
1653+ 2244              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654+ 2244
1655+ 2244 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656+ 2304
1657+ 2304              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658+ 2304
1659+ 2304              VARSEND EQU $
1660+ 2304
1661+ 2304              MDLADDR EQU outputBuffer
1662+ 2304
1663+ 2304              ;Release 0 steps:
1664+ 2304              ;04/21/2007
1665+ 2304              ;Works start (PTxPlay adaptation); first beta.
1666+ 2304              ;04/22/2007
1667+ 2304              ;Job finished; beta-testing.
1668+ 2304              ;04/23/2007
1669+ 2304              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670+ 2304              ;04/29/2007
1671+ 2304              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672+ 2304              ;modules of v3.7+.
1673+ 2304
1674+ 2304              ;Size (minimal build for ZX Spectrum):
1675+ 2304              ;Code block #908 bytes
1676+ 2304              ;Variables #2BF bytes (can be stripped)
1677+ 2304              ;Total size #908+#2BF=#BC7 (3015) bytes
1678+ 2304              	ENDMODULE
# file closed: player.asm
2546  2304 00 00 00...  	align 256
2547  2400              font
2548  2400              	incbin fontV6.chr ;шрифт
2549  2C00
2550  2C00              ;Переменные
2551  2C00 00           proc_next_find_focus_flag db 0 ;флаг внеочередного вызова процесса в фокусе
2552  2C01 00           Interrupt_new_flag db 0 ;флаг только что было прерывание
2553  2C02 00           uart_enable db 0; флаг есть порт uart
2554  2C03 00           proc_play_ay db 0 ;код процесса с музыкой AY
2555  2C04 00           proc_play_ay_slot2 db 0 ;страница с музыкой AY
2556  2C05 00           proc_play_ay_slot3 db 0 ;страница с музыкой AY
2557  2C06 00           scr_cur db 0 ;текущий активный экран
2558  2C07 00           proc_id_focus db 0 ;процесс, у которого фокус (видимый экран и доступно управление)
2559  2C08 00 00        proc_stack_addr_tmp dw 0 ; временно адрес стека
2560  2C0A 00 00        proc_stack_addr_tmp_wait dw 0 ; временно адрес стека
2561  2C0C 00           os_wait_flag db 0; флаг вызова os_wait
2562  2C0D 00           proc_next_find_skip_flag db 0; флаг дополнительных проверок переключения задач
2563  2C0E 00 00        proc_stack_addr_return_tmp dw 0 ;временно адрес возврата из прерываний
2564  2C10 00           key_proc_switch_flag db 0 ;флаг что нажата клавиша переключения задач
2565  2C11 00           key_lang_flag db 0 ;флаг что нажата клавиша rus lat
2566  2C12 00           key_caps_lock_switch_flag db 0 ;флаг что нажата клавиша caps lock
2567  2C13 00           key_graph_flag db 0 ;флаг что нажата клавиша graph
2568  2C14 00           key_sys_focus db 0 ;кнопка sys процесс в фокус
2569  2C15 00 00        FlgScanKeys_addr dw 0 ;адрес флаги драйвера
2570  2C17              ;stack_adr_sys dw 0 ;адрес системного стека
2571  2C17 00           page_slot2_cur db 0 ;текущая страница в слоте 2
2572  2C18 00           page_slot3_cur db 0 ;текущая страница в слоте 3
2573  2C19 00           page_slot2_cur_tmp db 0 ;текущая страница в слоте 2 временно
2574  2C1A 00           page_slot3_cur_tmp db 0 ;текущая страница в слоте 3 временно
2575  2C1B 00           con_scr_cur db 0 ;страница активного экрана пиксели
2576  2C1C 00           con_atr_cur db 0 ;страница активного экрана атрибуты
2577  2C1D 00           key_cur db 0 ;печатный код нажатой клавиши
2578  2C1E 00           file_id_cur db 0 ;временно id файла
2579  2C1F
2580  2C1F 00           proc_id_next db 0 ;код следующего процесса
2581  2C20 00 00        proc_stack_adr_tmp dw 0 ;временно адрес стека
2582  2C22 00           proc_id_cur db 0 ;id текущего процесса
2583  2C23 00           proc_id_cur_tmp db 0 ;временно id процесса
2584  2C24              ;proc_sys_name db "SYS        ",0 ;имя системного процесса
2585  2C24              ;proc_cmd_name db "CMD        ",0 ;имя процесса консоль
2586  2C24 00 00 00 00  sys_timer ds 4 ;таймер - счётчик прерываний
2587  2C28
2588  2C28 00 00 00...  	align 256
2589  2D00              proc_table ;данные процессов и приложений
2590  2D00 00 00 00...  	ds proc_descr_size*proc_max ;на командную строку, список страниц и прочее
2591  3500              	;#00 - id процесса
2592  3500              	;#01 - id родительского
2593  3500              	;#02 - страница #8000
2594  3500              	;#03 - страница #c000
2595  3500              	;#04 - страница буфер экран пиксели
2596  3500              	;#05 - страница буфер экран атрибуты
2597  3500              	;#06-07 - адрес стека
2598  3500              	;#08-09 - позиция аппаратного скрола
2599  3500              	;#0a-0b - координаты курсора
2600  3500              	;#0c-0d - цвет текста основной, цвет второй
2601  3500              	;#0e-0f - адрес вызова по прерыванию
2602  3500              	;#10-1b - Имя
2603  3500              	;#1c - графический режим (номер страницы. 0 - текстовый)
2604  3500              	;#1d - флаг, что процесс запросил os_wait
2605  3500
2606  3500              	;..#80 - верх стека
2607  3500
2608  3500              proc_page_table	;таблица занятых процессами страниц
2609  3500 00 00 00...  	ds 128 ;у GMX всего 128
2610  3580
2611  3580
2612  3580              esp_link_id_table;_id_table ;таблица соединений ESP
2613  3580              	;0 - id процесса (одновременно флаг "соединение используется")
2614  3580              	;1 - запрос соединения (=1 - активен)
2615  3580              	;2 - результат соединения (=1 - успешно, =255 - ошибка)
2616  3580              	;3 - запрос на отправку (=1 - активен)
2617  3580              	;4 - результат отправки (=1 - успешно, =255 - ошибка)
2618  3580              	;5 - запрос на приём (=1 - активен)
2619  3580              	;6 - результат приёма (=1 - успешно, =255 - ошибка)
2620  3580              	;7-8 - адрес назначения данных (для принятых)
2621  3580              	;9-10 - длина данных
2622  3580              	;11-13 -
2623  3580              	;14 - тип (TCP, UDP, SSL)
2624  3580              	;15-58 - адрес сервера, в конце 0
2625  3580              	;59-63 - порт сервера, в конце 0
2626  3580
2627  3580 00 00 00...  	ds 1*esp_link_id_table_size_item ;1 соединение
2628  35C0
2629  35C0              ; esp_buffer_flag ;флаги управления буфером ESP
2630  35C0              	; ;0 - буфер занят системным процессом (=1 - идёт передача)
2631  35C0              	; ;1-2 - длина данных
2632  35C0              	; ds 1
2633  35C0
2634  35C0
2635  35C0              ; proc_name_01	db "radio.apg",0
2636  35C0              ; proc_name_02	db "moonr.apg",0
2637  35C0              ; proc_name_03	db "nc.apg",0
2638  35C0 73 79 73 2E  proc_name_sys	db "sys.osg",0
2638  35C4 6F 73 67 00
2639  35C8              ; proc_name_net	db "net.apg",0
2640  35C8
2641  35C8
2642  35C8              ;Константы
2643  35C8              uart_port equ #EF ;порт
2644  35C8              outputBuffer equ #c000 ;адрес файла для плеера AY
2645  35C8              proc_color_def equ 7 ;цвет текста консоли
2646  35C8              proc_color2_def equ #c ;цвет текста консоли 2 яркий
2647  35C8              function_max equ 42+1 ;всего функций
2648  35C8              proc_size_max equ #80 ;максимальный размер приложения старший байт
2649  35C8              proc_descr_size equ 256 ;область памяти на одно приложение
2650  35C8              proc_max equ 8 ;максимальное количество приложений
2651  35C8              page_max equ drvgmx.page_table_end-drvgmx.page_table ;всего доступных страниц из 128
2652  35C8              proc_id_system equ 1 ;код системного процесса
2653  35C8              ;proc_stack equ #4000;адрес стека для процессов
2654  35C8              ;proc_stack_size equ 128 ;размер стека для процесса
2655  35C8              con_scr_real equ #39 ;экран физический
2656  35C8              con_atr_real equ #79 ;атрибуты
2657  35C8              ;page_slot2_def equ 2 ;страница по умолчанию слот 2
2658  35C8              ;page_slot3_def equ 1 ;страница по умолчанию слот 3
2659  35C8              proc_switch_key equ #1b ;код перключения задач sh+Enter
2660  35C8              ;esp_max_link_id equ 5 ;всего соединений ESP
2661  35C8              esp_link_id_table_size_item equ 64 ;размер элемента в таблице соединений
2662  35C8
2663  35C8              ;Сообщения
2664  35C8              msg_init_uart_found
2665  35C8 55 41 52 54  	db "UART #EF found",13,10,0
2665  35CC 20 23 45 46
2665  35D0 20 66 6F 75
2665  35D4 6E 64 0D 0A
2665  35D8 00
2666  35D9              msg_init_uart_not_found
2667  35D9 55 41 52 54  	db "UART #EF not found",13,10,0
2667  35DD 20 23 45 46
2667  35E1 20 6E 6F 74
2667  35E5 20 66 6F 75
2667  35E9 6E 64 0D 0A
2667  35ED 00
2668  35EE              msg_proc_max
2669  35EE 4E 6F 74 20  	db "Not enough processes",13,10,0
2669  35F2 65 6E 6F 75
2669  35F6 67 68 20 70
2669  35FA 72 6F 63 65
2669  35FE 73 73 65 73
2669  3602 0D 0A 00
2670  3605              msg_mem_max
2671  3605 4E 6F 74 20  	db "Not enough memory",13,10,0
2671  3609 65 6E 6F 75
2671  360D 67 68 20 6D
2671  3611 65 6D 6F 72
2671  3615 79 0D 0A 00
2672  3619
2673  3619
2674  3619
2675  3619              msg_ver_os
2676  3619 4F 53 20 76  	db "OS ver 2025.07.25",13,10,0
2676  361D 65 72 20 32
2676  3621 30 32 35 2E
2676  3625 30 37 2E 32
2676  3629 35 0D 0A 00
2677  362D
2678  362D
2679  362D
2680  362D
2681  362D
2682  362D
2683  362D              ; start_sys_incl
2684  362D              	; incbin sys.apg ;
2685  362D              ; end_sys_incl
2686  362D
2687  362D              ; start_cmd_incl
2688  362D              	; incbin cmd.apg ;
2689  362D              ; end_cmd_incl
2690  362D
2691  362D              	;Последний перед #4000 буфер для данных от ESP
2692  362D 00 00 00...  esp_buffer ds 1500 ;буфер для обмена с ESP
2693  3C09
2694  3C09              end_os_main
2695  3C09              	SAVETRD "OS.TRD",|"OS.C",start_os_main,$-start_os_main ;сохранить в TRD
2696  3C09              	SAVEBIN "os.c",start_os_main,$-start_os_main ;сохранить для FAT
2697  3C09
2698  3C09              	;манипуляции для создания hobeta
2699  3C09              	org #c000
2700  C000              	incbin "os.c"
2701  FC09              	SAVEHOB "os.$c","os.C",#C000,end_os_main-start_os_main ;
2702  FC09
2703  FC09
2704  FC09
2705  FC09
2706  FC09
# file closed: os_main.asm
