# file opened: os_main.asm
   1  0000              ;OS GMX (izzx, 2024)
   2  0000
   3  0000
   4  0000              ;sys - системный процесс для OS
   5  0000                 device ZXSPECTRUM128
   6  0000              	include "os_defs.asm"
# file opened: os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;вывод в консоль --------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRCHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000              ;очистить консоль
  28+ 0000              	macro OS_CLS ;clear visible area of terminal
  29+ 0000 ~                ld c,#00
  30+ 0000 ~                rst #20
  31+ 0000                  endm
  32+ 0000
  33+ 0000              ;установить позицию курсора в консоли
  34+ 0000                  macro OS_SETXY ;de=yx ;SET CURSOR POSITION
  35+ 0000 ~                ld c,#01
  36+ 0000 ~                rst #20
  37+ 0000                  endm
  38+ 0000
  39+ 0000              ;печать символа в консоль
  40+ 0000                  macro OS_PRCHAR ;a=char
  41+ 0000 ~                ld c,#02
  42+ 0000 ~                rst #20
  43+ 0000                  endm
  44+ 0000
  45+ 0000              ;заполнение строки одним символом
  46+ 0000                  macro OS_FLINE ;; H - line ; A - char
  47+ 0000 ~                ld c,#03
  48+ 0000 ~                rst #20
  49+ 0000                  endm
  50+ 0000
  51+ 0000              ;покрасить строку цветом
  52+ 0000                  macro OS_PLINE ;a - line, b - color
  53+ 0000 ~                ld c,#04
  54+ 0000 ~                rst #20
  55+ 0000                  endm
  56+ 0000
  57+ 0000
  58+ 0000                  ; macro OS_ ;
  59+ 0000                  ; ld c,#05
  60+ 0000                  ; rst #20
  61+ 0000                  ; endm
  62+ 0000
  63+ 0000              ;установить цвет текста в консоли;
  64+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  65+ 0000 ~                ld c,#06
  66+ 0000 ~                rst #20
  67+ 0000                  endm
  68+ 0000
  69+ 0000                  ; macro OS_ ;
  70+ 0000                  ; ld c,#07
  71+ 0000                  ; rst #20
  72+ 0000                  ; endm
  73+ 0000
  74+ 0000                  ; macro OS_ ;
  75+ 0000                  ; ld c,#08
  76+ 0000                  ; rst #20
  77+ 0000                  ; endm
  78+ 0000
  79+ 0000
  80+ 0000
  81+ 0000              ;печать в консоль до кода 0
  82+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
  83+ 0000 ~                ld c,#09
  84+ 0000 ~                rst #20
  85+ 0000                  endm
  86+ 0000
  87+ 0000              ;прочитать байт из uart порта;
  88+ 0000                  macro OS_UART_READ ; A - byte (Out: CY=1 Not Readed)
  89+ 0000 ~                ld c,#0a
  90+ 0000 ~                rst #20
  91+ 0000                  endm
  92+ 0000
  93+ 0000              ;записать байт в uart порт;
  94+ 0000                  macro OS_UART_WRITE ; A - byte (Out: CY=1 Not Writed)
  95+ 0000 ~                ld c,#0b
  96+ 0000 ~                rst #20
  97+ 0000                  endm
  98+ 0000
  99+ 0000                  ; macro OS_ ;
 100+ 0000                  ; ld c,#0c
 101+ 0000                  ; rst #20
 102+ 0000                  ; endm
 103+ 0000
 104+ 0000                  ; macro OS_ ;
 105+ 0000                  ; ld c,#0d
 106+ 0000                  ; rst #20
 107+ 0000                  ; endm
 108+ 0000
 109+ 0000                  ; macro OS_ ;
 110+ 0000                  ; ld c,#0e
 111+ 0000                  ; rst #20
 112+ 0000                  ; endm
 113+ 0000
 114+ 0000                  ; macro OS_ ;
 115+ 0000                  ; ld c,#0f
 116+ 0000                  ; rst #20
 117+ 0000                  ; endm
 118+ 0000
 119+ 0000              ;ввод с консоли ----------------------
 120+ 0000
 121+ 0000              ;получить код нажатой клавиши
 122+ 0000                  macro OS_GETCHAR ;read char from stdin (out: A=char, 255-no char)
 123+ 0000 ~                ld c,#10
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000
 128+ 0000                  ; macro OS_ ;
 129+ 0000                  ; ld c,#11
 130+ 0000                  ; rst #20
 131+ 0000                  ; endm
 132+ 0000
 133+ 0000                  ; macro OS_ ;
 134+ 0000                  ; ld c,#12
 135+ 0000                  ; rst #20
 136+ 0000                  ; endm
 137+ 0000
 138+ 0000                  ; macro OS_ ;
 139+ 0000                  ; ld c,#13
 140+ 0000                  ; rst #20
 141+ 0000                  ; endm
 142+ 0000
 143+ 0000
 144+ 0000              ;прерывания --------------------------
 145+ 0000
 146+ 0000              ;установка адреса обработчика прерываний процесса;
 147+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 148+ 0000                  ; ld c,#14
 149+ 0000                  ; rst #20
 150+ 0000                  ; endm
 151+ 0000
 152+ 0000
 153+ 0000              ;плеер AY ----------------------------
 154+ 0000
 155+ 0000              ;инициализация плеера AY;
 156+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 157+ 0000 ~                ld c,#15
 158+ 0000 ~                rst #20
 159+ 0000                  endm
 160+ 0000
 161+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 162+ 0000                  macro OS_VTPL_PLAY ;()
 163+ 0000 ~                ld c,#16
 164+ 0000 ~                rst #20
 165+ 0000                  endm
 166+ 0000
 167+ 0000              ;заглушить плеер AY;
 168+ 0000                  macro OS_VTPL_MUTE ;()
 169+ 0000 ~                ld c,#17
 170+ 0000 ~                rst #20
 171+ 0000                  endm
 172+ 0000
 173+ 0000              ;получить значение переменной плеера;
 174+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 175+ 0000 ~                ld c,#18
 176+ 0000 ~                rst #20
 177+ 0000                  endm
 178+ 0000
 179+ 0000
 180+ 0000              ;прочие ------------------------------
 181+ 0000
 182+ 0000
 183+ 0000              ;скопировать страницу в страницу
 184+ 0000                  macro OS_PAGE_COPY ;(A- page from, B - page to)
 185+ 0000 ~                ld c,#19
 186+ 0000 ~                rst #20
 187+ 0000                  endm
 188+ 0000
 189+ 0000              ;получить дополнительную страницу памяти;
 190+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 191+ 0000 ~                ld c,#1a
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 196+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 197+ 0000 ~                ld c,#1b
 198+ 0000 ~                rst #20
 199+ 0000                  endm
 200+ 0000
 201+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 202+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 203+ 0000 ~                ld c,#1c
 204+ 0000 ~                rst #20
 205+ 0000                  endm
 206+ 0000
 207+ 0000              ;включить экран N;
 208+ 0000                  macro OS_SET_SCR ;(A - number screen 5, 7, 39, 3a)
 209+ 0000 ~                ld c,#1d
 210+ 0000 ~                rst #20
 211+ 0000                  endm
 212+ 0000
 213+ 0000
 214+ 0000              ;получить номера страниц процесса;
 215+ 0000                  macro OS_GET_MAIN_PAGES ;(b, c - pages in slot2, 3)
 216+ 0000 ~                ld c,#1e
 217+ 0000 ~                rst #20
 218+ 0000                  endm
 219+ 0000
 220+ 0000              ;получить значение системного таймера
 221+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 222+ 0000 ~                ld c,#1F
 223+ 0000 ~                rst #20
 224+ 0000                  endm
 225+ 0000
 226+ 0000
 227+ 0000
 228+ 0000                  ; macro OS_ ;
 229+ 0000                  ; ld c,#20
 230+ 0000                  ; rst #20
 231+ 0000                  ; endm
 232+ 0000
 233+ 0000
 234+ 0000              ;дисковые операции -------------------
 235+ 0000
 236+ 0000              ;открыть файл для чтения или записи
 237+ 0000                  macro OS_FOPENRW ;HL - File name (out: A - id file, bc, de - size)
 238+ 0000 ~                ld c,#21
 239+ 0000 ~                rst #20
 240+ 0000                  endm
 241+ 0000
 242+ 0000              ;создать файл
 243+ 0000                  macro OS_FOPENC ;HL - File name  (out: A - id file)
 244+ 0000 ~                ld c,#22
 245+ 0000 ~                rst #20
 246+ 0000                  endm
 247+ 0000
 248+ 0000              ;прочитать из файла
 249+ 0000                  macro OS_FREAD ;HL - address, A - id file, DE - length (out: bc - size readed)
 250+ 0000 ~                ld c,#23
 251+ 0000 ~                rst #20
 252+ 0000                  endm
 253+ 0000
 254+ 0000              ;записать в файл
 255+ 0000                  macro OS_FWRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 256+ 0000 ~                ld c,#24
 257+ 0000 ~                rst #20
 258+ 0000                  endm
 259+ 0000
 260+ 0000              ;закрыть файл
 261+ 0000                  macro OS_FCLOSE ;A - id file
 262+ 0000 ~                ld c,#25
 263+ 0000 ~                rst #20
 264+ 0000                  endm
 265+ 0000
 266+ 0000                  ; macro OS_ ;
 267+ 0000                  ; ld c,#26
 268+ 0000                  ; rst #20
 269+ 0000                  ; endm
 270+ 0000
 271+ 0000                  ; macro OS_ ;
 272+ 0000                  ; ld c,#27
 273+ 0000                  ; rst #20
 274+ 0000                  ; endm
 275+ 0000
 276+ 0000                  ; macro OS_ ;
 277+ 0000                  ; ld c,#28
 278+ 0000                  ; rst #20
 279+ 0000                  ; endm
 280+ 0000
 281+ 0000                  ; macro OS_ ;
 282+ 0000                  ; ld c,#29
 283+ 0000                  ; rst #20
 284+ 0000                  ; endm
 285+ 0000
 286+ 0000
# file closed: os_defs.asm
   7  0000              	org PROGSTART
   8  8000              start_sys
   9  8000 FB           	ei
  10  8001 76           	halt ;ожидание старта после прерывания
  11  8002 76           	halt
  12  8003 21 08 31     	ld hl,msg_ver_os
  13  8006              	;печать приветствия
  14  8006              	OS_PRINTZ
  14  8006 0E 09       >    ld c,#09
  14  8008 E7          >    rst #20
  15  8009
  16  8009
  17  8009              ;инициализация устройств
  18  8009              ;uart #EF (wifi)
  19  8009 CD 00 0A     	call Uart.chek
  20  800C 21 A5 30     	ld hl,msg_init_uart_not_found
  21  800F FE FF        	cp 255
  22  8011              	;jr z,init_uart_no ;отключена проверка
  23  8011 CD 0E 0A     	call Uart.init ;нашли uart
  24  8014 21 94 30     	ld hl,msg_init_uart_found
  25  8017              init_uart_no
  26  8017              	;печать
  27  8017              	OS_PRINTZ
  27  8017 0E 09       >    ld c,#09
  27  8019 E7          >    rst #20
  28  801A
  29  801A
  30  801A CD C9 0A     	call Dos.init_fs_fat ;выбор раздела (буквы диска)
  31  801D
  32  801D              	;call proc_run_cmd ;запустить консоль
  33  801D              	;call proc_run_cmd ;запустить консоль
  34  801D              	; call proc_run_cmd ;запустить консоль
  35  801D              	; call proc_run_cmd ;запустить консоль
  36  801D              	; call proc_run_cmd ;запустить консоль
  37  801D              	;call proc_run_cmd ;запустить консоль
  38  801D              	;call proc_run_cmd ;запустить консоль
  39  801D
  40  801D 21 80 30     	ld hl,proc_name_01		;строка с именем
  41  8020 CD EA 02     	call proc_run
  42  8023
  43  8023              	; ld hl,proc_name_02		;строка с именем
  44  8023              	; call proc_run
  45  8023
  46  8023
  47  8023 DD 7E 00     	ld a,(ix)
  48  8026 CD 52 02     	call proc_set_focus ;на передний план
  49  8029
  50  8029              sys_loop
  51  8029 76           	halt
  52  802A 3A 09 27     	ld a,(proc_switch_key_flag)
  53  802D B7           	or a
  54  802E 28 0F        	jr z,sys_loop1
  55  8030 CD 4C 02     	call proc_focus_next
  56  8033              sys_loop_switch
  57  8033 76           	halt
  58  8034              	OS_GETCHAR ;ждать пока отпустят
  58  8034 0E 10       >    ld c,#10
  58  8036 E7          >    rst #20
  59  8037 FE FF        	cp 255
  60  8039 20 F8        	jr nz,sys_loop_switch
  61  803B AF           	xor a
  62  803C 32 09 27     	ld (proc_switch_key_flag),a
  63  803F              sys_loop1
  64  803F 3A 2C 27     	ld a,(sys_timer) ;иногда печатаем системную информацию
  65  8042 E6 1F        	and %00011111
  66  8044 CC 49 80     	call z,sys_print_info
  67  8047
  68  8047              	; OS_GETCHAR ;получить нажатую клавишу
  69  8047              	; cp 255
  70  8047              	; jr z,sys_loop
  71  8047              	; OS_PRCHARF ;печать символа
  72  8047 18 E0        	jr sys_loop
  73  8049
  74  8049
  75  8049              sys_print_info
  76  8049              	;печать информации о памяти и процессах
  77  8049 11 00 10     	ld de,#1000 ;координаты yx
  78  804C              	OS_SETXY
  78  804C 0E 01       >    ld c,#01
  78  804E E7          >    rst #20
  79  804F 21 E5 30     	ld hl,msg_processes
  80  8052              	OS_PRINTZ
  80  8052 0E 09       >    ld c,#09
  80  8054 E7          >    rst #20
  81  8055 CD 86 80     	call get_proc_total ;процессов
  82  8058 6F           	ld l,a
  83  8059 26 00        	ld h,0
  84  805B CD A1 06     	call toDecimal
  85  805E 21 05 31     	ld hl,decimalS+3
  86  8061              	OS_PRINTZ
  86  8061 0E 09       >    ld c,#09
  86  8063 E7          >    rst #20
  87  8064
  88  8064 11 00 11     	ld de,#1100 ;координаты yx
  89  8067              	OS_SETXY
  89  8067 0E 01       >    ld c,#01
  89  8069 E7          >    rst #20
  90  806A 21 F1 30     	ld hl,msg_free_ram
  91  806D              	OS_PRINTZ
  91  806D 0E 09       >    ld c,#09
  91  806F E7          >    rst #20
  92  8070 CD 97 80     	call get_free_ram ;памяти
  93  8073 6F           	ld l,a
  94  8074 26 00        	ld h,0
  95  8076 CD A1 06     	call toDecimal
  96  8079 21 04 31     	ld hl,decimalS+2
  97  807C              	OS_PRINTZ
  97  807C 0E 09       >    ld c,#09
  97  807E E7          >    rst #20
  98  807F 3E 0D        	ld a,13
  99  8081              	OS_PRCHARF
  99  8081 D7          >	rst #10
 100  8082 3E 0D        	ld a,13
 101  8084              	OS_PRCHARF
 101  8084 D7          >	rst #10
 102  8085 C9           	ret
 103  8086
 104  8086
 105  8086              get_proc_total
 106  8086              	;поиск количества запущеных процессов
 107  8086              	;вых: a - количество активных
 108  8086 21 00 28     	ld hl,proc_table
 109  8089 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 110  808B 0E 00        	ld c,0 ;счётчик
 111  808D              get_proc_total_cl
 112  808D 7E           	ld a,(hl)
 113  808E B7           	or a ;свободен?
 114  808F 28 01        	jr z,get_proc_total_cl1
 115  8091 0C           	inc c ;прибавить
 116  8092              get_proc_total_cl1
 117  8092 24           	inc h
 118  8093 10 F8        	djnz get_proc_total_cl
 119  8095 79           	ld a,c
 120  8096 C9           	ret
 121  8097
 122  8097
 123  8097              get_free_ram
 124  8097              	;поиск количества свободных страниц памяти
 125  8097              	;вых: a - количество свободных
 126  8097 21 00 30     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 127  809A 06 6D        	ld b,page_max ;всего страниц
 128  809C 0E 00        	ld c,0 ;счётчик
 129  809E              get_free_ram_cl
 130  809E 7E           	ld a,(hl)
 131  809F B7           	or a ;свободен?
 132  80A0 20 01        	jr nz,get_free_ram_cl1
 133  80A2 0C           	inc c ;прибавить
 134  80A3              get_free_ram_cl1
 135  80A3 23           	inc hl
 136  80A4 10 F8        	djnz get_free_ram_cl
 137  80A6 79           	ld a,c
 138  80A7 C9           	ret
 139  80A8
 140  80A8
 141  80A8              end_sys
 142  80A8              	;SAVETRD "OS.TRD",|"cmd.C",start_cmd,$-start_cmd
 143  80A8              	savebin "sys.com",start_sys,$-start_sys
 144  80A8
 145  80A8
 146  80A8
 147  80A8
 148  80A8
 149  80A8
 150  80A8
 151  80A8
 152  80A8              ;ядро системы
 153  80A8                  ;device ZXSPECTRUM128
 154  80A8              	;include os_defs.asm ;список функций
 155  80A8
 156  80A8              	org #0000
 157  0000              start_os_main
 158  0000
 159  0000 C3 01 C1     x0000	jp	InitProgramm + #c000		;+#C000 после запуска меняется
 160  0003 00 00 00...  	ds	#08-3
 161  0008
 162  0008 18 31        x0008	jr	x003B			;обработка rst 8
 163  000A 00           	nop
 164  000B 00           x000B	nop
 165  000C 00           	nop
 166  000D 18 75        x000D	jr	ExitMon
 167  000F 00           	ds	#01
 168  0010
 169  0010 C3 AE 07     x0010	jp	drvgmx.putC  ;PrnSym_Rst10		;печать одного символа
 170  0013
 171  0013 ED 79        x0013	out	(c),a
 172  0015 00           	nop
 173  0016 00 00        	ds	#02
 174  0018
 175  0018 00 00 00...  x0018	ds	#08
 176  0020
 177  0020 C3 C0 04     x0020	jp function  ;rst #20
 178  0023 00 00 00...  		ds	#05 ;#08
 179  0028
 180  0028 00 00 00...  x0028	ds	#08 ;rst #28
 181  0030
 182  0030 00 00 00     x0030	ds	#03 ;rst #30
 183  0033
 184  0033 ED 79        x0033	out	(c),a
 185  0035 00           	nop
 186  0036
 187  0036 00 1F        x0036	dw	font
 188  0038
 189  0038              ;обработчик прерываний
 190  0038 C3 40 05     x0038	jp	Interrupts
 191  003B
 192  003B              ;обработка RST 8
 193  003B F5           x003B	push	af
 194  003C ED 5F        	ld	a,r
 195  003E EA 43 00     	jp	pe,x0043
 196  0041 ED 5F        	ld	a,r
 197  0043 F5           x0043	push	af
 198  0044 3E 10        	ld	a,#10			;вход из ram 0
 199  0046 F5           	push	af
 200  0047 33           	inc	sp
 201  0048 C5           	push	bc
 202  0049 E5           	push	hl
 203  004A 01 00 00     	ld	bc,#0000
 204  004D 3E 02        	ld	a,#02
 205  004F ED 79        	out	(c),a
 206  0051 01 FD 7E     	ld	bc,#7EFD
 207  0054 ED 60        	in	h,(c)			;h=in #7EFD
 208  0056 06 7A        	ld	b,#7A
 209  0058 ED 68        	in	l,(c)			;l=in #7AFD
 210  005A 06 1F        	ld	b,#1F
 211  005C 3E 12        	ld	a,#12
 212  005E 18 B3        	jr	x0013
 213  0060 00 00 00...  	ds	#06			;=#0060
 214  0066
 215  0066              ;обработка NMI
 216  0066              ;
 217  0066 F5           x0066	push	af
 218  0067 ED 5F        	ld	a,r
 219  0069 F5           	push	af
 220  006A 3E 20        	ld	a,#20			;вход из ram 0
 221  006C F5           	push	af
 222  006D 33           	inc	sp
 223  006E C5           	push	bc
 224  006F E5           	push	hl
 225  0070 2A 01 C0     	ld	hl,(#C001)
 226  0073 E3           	ex	(sp),hl
 227  0074 3E 55        	ld	a,#55
 228  0076 32 01 C0     	ld	(#C001),a
 229  0079 2F           	cpl
 230  007A 32 02 C0     	ld	(#C001+1),a
 231  007D 01 FD 1F     	ld	bc,#1FFD
 232  0080 3E 12        	ld	a,#12
 233  0082 18 AF        	jr	x0033
 234  0084
 235  0084              ;возврат из монитора =#0084
 236  0084 ED 51        ExitMon	out	(c),d			;#1FFD
 237  0086 06 7F        	ld	b,#7F
 238  0088 ED 59        	out	(c),e			;#7FFD
 239  008A 01 00 00     	ld	bc,#0000
 240  008D ED 79        	out	(c),a
 241  008F D1           	pop	de
 242  0090 C1           	pop	bc
 243  0091 33           	inc	sp
 244  0092 F1           	pop	af
 245  0093 ED 4F        	ld	r,a
 246  0095 E2 9B 00     	jp	po,x009B
 247  0098 F1           	pop	af
 248  0099 FB           	ei
 249  009A C9           	ret
 250  009B F1           x009B	pop	af
 251  009C F3           	di
 252  009D C9           	ret
 253  009E
 254  009E              x009E
 255  009E              ; StartWord
 256  009E              	; ldir
 257  009E              	; call	onPageTXT
 258  009E              	; jp	MainLoopEdit
 259  009E              	; INSERT	"Info/!version.txt"
 260  009E              	; INSERT	"Info/!build.txt"
 261  009E              	; db	"GMX"
 262  009E 00 00 00...  y009E	ds	#00FF-$
 263  00FF
 264  00FF 38 00        x00FF	dw	x0038
 265  0101
 266  0101
 267  0101
 268  0101              ;Первый запуск
 269  0101              InitProgramm
 270  0101 F3           	di
 271  0102 31 00 41     	ld sp,#4100 ;временный адрес стека
 272  0105 3E 01        	ld a, #01 ;включить ОЗУ вместо ПЗУ
 273  0107 01 FD 1F         ld   bc,#1ffd
 274  010A ED 79        	out (c),a
 275  010C 21 15 01     	ld hl,Start_warm ;заменить адрес старта
 276  010F 22 01 00     	ld (#0001),hl
 277  0112 C3 00 00     	jp 0
 278  0115
 279  0115
 280  0115              ; rst #08: db #8F установка/удаление резидента из памяти
 281  0115              ; при "теплой" перезагрузке, если резидент установлен в странице, то эта страница
 282  0115                ; будет впечатана в 3е окно и управление передано по заданному адресу
 283  0115              ; вх:  a - номер страницы для установки резидента
 284  0115                      ; =#08 - удаление резидента
 285  0115                      ; 7,a =1 однократный вызов
 286  0115                   ; hl - адрес старта в странице
 287  0115              ; вых: cy=1 резидент не установлен
 288  0115              ; сначала копируем в эту страницу то что надо
 289  0115              ; и только потом вызываем функцию
 290  0115              ; для гмх страницу 8 и #78 задавать нельзя
 291  0115              ; перед повторной установкой резидента, вызывать функцию удаления не нужно
 292  0115
 293  0115              ;Старт системы
 294  0115              Start_warm
 295  0115              	;di
 296  0115 ED 56        	im 1
 297  0117
 298  0117              ;------------------------------------------------------------------------------
 299  0117              ;вызов функции #00(00) (SetRam0) установка работы со страницей ram 0 вместо rom, требуется для
 300  0117              ;корректного выхода из монитора, при ресете отключается
 301  0117              ;вх:  c=#00(00)
 302  0117              ;     cy=1 - установка
 303  0117              ;     cy=0 - отключение
 304  0117              ;вых: регистры не меняются
 305  0117              ;   R8CONF
 306  0117 0E 00        	ld	c,#00
 307  0119 37           	scf
 308  011A CF           	rst	#08
 309  011B 8E           	db	#8E
 310  011C              ;
 311  011C              	;ei
 312  011C              	;подготовить системный процесс
 313  011C 3E 01        	ld a,proc_id_system ;код системного процесса
 314  011E 32 13 27     	ld (proc_id_cur),a ;запомнить как текущий
 315  0121 32 04 27     	ld (proc_id_focus),a ;сразу в фокусе
 316  0124              	;ld (proc_run_prepar_id_tmp),a ;для правильного выделения памяти
 317  0124 32 10 27     	ld (proc_id_next),a ;для вычисления следующего процесса
 318  0127
 319  0127 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
 320  0129 32 0C 27     	ld (con_scr_cur),a
 321  012C 3E 79        	ld a,con_atr_real ;атрибуты реальные
 322  012E 32 0D 27     	ld (con_atr_cur),a
 323  0131 3E 39        	ld a,#39 ;видимый экран
 324  0133 32 03 27     	ld (scr_cur),a
 325  0136 CD F7 06     	call drvgmx.init
 326  0139
 327  0139              	;запустить системный процесс
 328  0139              ;proc_run_sys
 329  0139              ;запуск sys не с диска, а из состава ОС
 330  0139 21 14 27     	ld hl,proc_sys_name
 331  013C CD 9F 01     	call proc_run_prepar
 332  013F D8           	ret c
 333  0140
 334  0140              	;включить страницы
 335  0140              	;ld ix,(proc_run_prepar_deskr_tmp)
 336  0140 DD 7E 02     	ld a,(ix+2)
 337  0143 32 0B 27     	ld (page_slot2_cur),a ;сделать страницы текущими
 338  0146 CD 6D 09     	call drvgmx.PageSlot2
 339  0149 DD 7E 03     	ld a,(ix+3)
 340  014C 32 0A 27     	ld (page_slot3_cur),a
 341  014F CD 8C 08     	call drvgmx.PageSlot3
 342  0152              	;цвета
 343  0152 3E 07        	ld a,proc_color_def ;цвет
 344  0154 32 AB 09     	ld (drvgmx.attr_screen),a
 345  0157 DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
 346  015A              	;
 347  015A 3E 0C        	ld a,proc_color2_def ;цвет 2
 348  015C 32 AC 09     	ld (drvgmx.attr_screen2),a
 349  015F DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
 350  0162              	;перенести код
 351  0162 21 1C 31     	ld hl,start_sys_incl
 352  0165 11 00 80     	ld de,PROGSTART
 353  0168 01 A8 00     	ld bc,end_sys_incl-start_sys_incl
 354  016B ED B0        	ldir
 355  016D              	;подготовить правильный старт
 356  016D DD 6E 06     	ld l,(ix+6) ;стек нового процесса
 357  0170 DD 66 07     	ld h,(ix+7) ;стек
 358  0173 F9           	ld sp,hl
 359  0174
 360  0174 3E 01        	ld a,proc_id_system
 361  0176 DD 77 00     	ld (ix),a
 362  0179 C3 00 80     	jp PROGSTART ;старт сначала на заглушку
 363  017C
 364  017C
 365  017C
 366  017C
 367  017C              ;запуск теста
 368  017C
 369  017C
 370  017C              	; ld hl,proc_name_01		;строка с именем
 371  017C              	; call proc_run
 372  017C              	;jr c,loop_idle
 373  017C
 374  017C
 375  017C               	; ld hl,proc_name_02		;строка с именем
 376  017C              	; call proc_run
 377  017C
 378  017C               	; ld hl,proc_name_03		;строка с именем
 379  017C              	; call proc_run
 380  017C
 381  017C               	; ld hl,proc_name_02		;строка с именем
 382  017C              	; call proc_run
 383  017C
 384  017C               	; ld hl,proc_name_02		;строка с именем
 385  017C              	; call proc_run
 386  017C
 387  017C              	; ld a,3
 388  017C              	; call Dos.fclose
 389  017C
 390  017C              	; ld hl,proc_name_01		;строка с именем
 391  017C              	; call proc_run
 392  017C
 393  017C
 394  017C
 395  017C
 396  017C
 397  017C              loop_idle ;заглушка
 398  017C 18 FE        	jr loop_idle ;
 399  017E
 400  017E
 401  017E
 402  017E
 403  017E
 404  017E              proc_run_cmd
 405  017E              ; запуск cmd не с диска, а из состава ОС
 406  017E 21 20 27     	ld hl,proc_cmd_name
 407  0181 CD 9F 01     	call proc_run_prepar
 408  0184 D8           	ret c
 409  0185              	;включить страницы
 410  0185              	;ld ix,(proc_run_prepar_deskr_tmp)
 411  0185 DD 7E 02     	ld a,(ix+2)
 412  0188 CD 6D 09     	call drvgmx.PageSlot2
 413  018B DD 7E 03     	ld a,(ix+3)
 414  018E CD 8C 08     	call drvgmx.PageSlot3
 415  0191              	;перенести код
 416  0191 21 C4 31     	ld hl,start_cmd_incl
 417  0194 11 00 80     	ld de,PROGSTART
 418  0197 01 3E 00     	ld bc,end_cmd_incl-start_cmd_incl
 419  019A ED B0        	ldir
 420  019C
 421  019C C3 3A 03     	jp file_load_ok ;продолжить стандартно
 422  019F
 423  019F
 424  019F
 425  019F
 426  019F
 427  019F              proc_run_prepar
 428  019F              ;подготовка к запуску процесса
 429  019F              ;выделение памяти и прочее
 430  019F              ;вх: hl - имя процесса (файла) 8+3 символов
 431  019F              ;вых: a - номер процесса, IX - дескриптор
 432  019F
 433  019F 22 1E 02     	ld (proc_run_prepar_name_tmp),hl ;сохранить имя
 434  01A2              	;поиск свободного дескриптора
 435  01A2 21 00 28     	ld hl,proc_table
 436  01A5 11 00 01     	ld de,proc_descr_size
 437  01A8 06 08        	ld b,proc_max ;цикл по максимальному количеству процессов
 438  01AA 0E 01        	ld c,proc_id_system ;первый номер
 439  01AC              proc_run_prepar_cl
 440  01AC 7E           	ld a,(hl)
 441  01AD B7           	or a ;свободен?
 442  01AE 28 0C        	jr z,proc_run_prepar_ok
 443  01B0 19           	add hl,de
 444  01B1 0C           	inc c
 445  01B2 10 F8        	djnz proc_run_prepar_cl
 446  01B4              	;не нашли свободного
 447  01B4 21 BA 30     	ld hl,msg_proc_max
 448  01B7 CD A3 07     	call drvgmx.printZ ;сообщение
 449  01BA 37           	scf
 450  01BB C9           	ret
 451  01BC              proc_run_prepar_ok
 452  01BC              	;есть свободный
 453  01BC E5           	push hl
 454  01BD DD E1        	pop ix ;дискриптор процесса
 455  01BF 22 22 02     	ld (proc_run_prepar_deskr_tmp),hl
 456  01C2 79           	ld a,c ;присвоить номер
 457  01C3 32 20 02     	ld (proc_run_prepar_id_tmp),a
 458  01C6
 459  01C6
 460  01C6 3A 13 27     	ld a,(proc_id_cur)
 461  01C9 DD 77 01     	ld (ix+1),a ;код родительского
 462  01CC
 463  01CC              	;скопировать имя
 464  01CC 11 10 00     	ld de,16 ;
 465  01CF 19           	add hl,de
 466  01D0 EB           	ex de,hl
 467  01D1 2A 1E 02     	ld hl,(proc_run_prepar_name_tmp)
 468  01D4 01 0B 00     	ld bc,8+3
 469  01D7 ED B0        	ldir
 470  01D9
 471  01D9
 472  01D9              	;выделение памяти стандартное количество окон
 473  01D9 CD 24 02     	call proc_find_ram
 474  01DC 38 1D        	jr c,proc_run_prepar_no_mem
 475  01DE DD 77 02     	ld (ix+2),a ;страница 8000
 476  01E1 CD 24 02     	call proc_find_ram
 477  01E4 38 15        	jr c,proc_run_prepar_no_mem
 478  01E6 DD 77 03     	ld (ix+3),a ;страница c000
 479  01E9 CD 24 02     	call proc_find_ram
 480  01EC 38 0D        	jr c,proc_run_prepar_no_mem
 481  01EE DD 77 04     	ld (ix+4),a ;страница пиксели
 482  01F1 CD 24 02     	call proc_find_ram
 483  01F4 38 05        	jr c,proc_run_prepar_no_mem
 484  01F6 DD 77 05     	ld (ix+5),a ;страница атрибуты
 485  01F9
 486  01F9 18 0E        	jr proc_run_prepar_mem_ok
 487  01FB
 488  01FB              proc_run_prepar_no_mem
 489  01FB 3A 20 02     	ld a,(proc_run_prepar_id_tmp)
 490  01FE CD 3D 02     	call proc_clear_ram ;освободить память обратно
 491  0201
 492  0201 21 D1 30     	ld hl,msg_mem_max
 493  0204 CD A3 07     	call drvgmx.printZ ;сообщение
 494  0207 37           	scf
 495  0208 C9           	ret
 496  0209
 497  0209              proc_run_prepar_mem_ok ;памяти хватило
 498  0209
 499  0209              	;определить адрес стека
 500  0209 3A 20 02     	ld a,(proc_run_prepar_id_tmp) ;id
 501  020C 21 00 27     	ld hl,proc_table-256
 502  020F 84           	add h
 503  0210 67           	ld h,a
 504  0211 2E 80        	ld l,#80 ;на стек меньше 128 байт
 505  0213              	; ld hl,proc_stack
 506  0213              	; or a
 507  0213              	; jr z,proc_run_prepar_ex
 508  0213              	; ld b,a
 509  0213              	; ld de,proc_stack_size
 510  0213              ; proc_run_prepar_cl2 ;цикл
 511  0213              	; add hl,de
 512  0213              	; djnz proc_run_prepar_cl2
 513  0213              ;proc_run_prepar_ex
 514  0213 DD 75 06     	ld (ix+6),l ;адрес стека
 515  0216 DD 74 07     	ld (ix+7),h ;адрес стека
 516  0219              	; ld a,(proc_run_prepar_id_tmp) ;id
 517  0219              	; ld (ix+0),a
 518  0219 3A 20 02     	ld a,(proc_run_prepar_id_tmp) ;id
 519  021C B7           	or a
 520  021D C9           	ret
 521  021E
 522  021E 00 00        proc_run_prepar_name_tmp dw 0 ;временно имя нового процесса
 523  0220 00           proc_run_prepar_id_tmp db 0 ;временно id нового процесса
 524  0221 00           proc_run_file_id_tmp db 0 ;временно id файла
 525  0222 00 00        proc_run_prepar_deskr_tmp dw 0 ;временно дескриптор процесса
 526  0224
 527  0224              proc_find_ram	;поиск свободной страницы памяти
 528  0224              ;вых: a - номер страницы, также записан id процесса в таблицу proc_page_table
 529  0224 11 ED 08     	ld de,drvgmx.page_table ;таблица возможных вариантов с номерами страниц
 530  0227 21 00 30     	ld hl,proc_page_table ;таблица памяти приложений с кодами процессов
 531  022A 06 6D        	ld b,page_max
 532  022C              proc_find_ram_cl
 533  022C AF           	xor a
 534  022D B6           	or (hl)
 535  022E 28 06        	jr z,proc_find_ram_ok1 ;нашли
 536  0230              	;ищем дальше
 537  0230 23           	inc hl
 538  0231 13           	inc de
 539  0232 10 F8        	djnz proc_find_ram_cl
 540  0234              	;совсем не нашли
 541  0234 37           	scf
 542  0235 C9           	ret
 543  0236              proc_find_ram_ok1
 544  0236 3A 20 02     	ld a,(proc_run_prepar_id_tmp)
 545  0239 77           	ld (hl),a ;записать id процесса в таблицу
 546  023A 1A           	ld a,(de) ;вернуть номер страницы
 547  023B B7           	or a
 548  023C C9           	ret
 549  023D
 550  023D
 551  023D              proc_clear_ram ;освбождение всех страниц памяти процесса
 552  023D              ;вх: a - номер процесса
 553  023D 21 00 30     	ld hl,proc_page_table
 554  0240 06 6D        	ld b,page_max ;цикл сколько всего страниц в таблице
 555  0242              proc_clear_ram_cl ;
 556  0242 BE           	cp (hl) ;совпадает с номером процесса?
 557  0243 20 02        	jr nz,proc_clear1
 558  0245 36 00        	ld (hl),0 ;освободить
 559  0247              proc_clear1
 560  0247 23           	inc hl
 561  0248 10 F8        	djnz proc_clear_ram_cl
 562  024A B7           	or a
 563  024B C9           	ret
 564  024C
 565  024C
 566  024C
 567  024C              proc_focus_next
 568  024C              	;переключение фокуса на следующий процесс
 569  024C 3A 04 27     	ld a,(proc_id_focus)
 570  024F CD 83 06     	call proc_next_skip
 571  0252              	;ret c ;выернуться если один процесс
 572  0252              	;или сменить фокус, код ниже
 573  0252
 574  0252
 575  0252              proc_set_focus ;получение фокуса процессом
 576  0252              ;вх: a - id процесса
 577  0252 21 04 27     	ld hl,proc_id_focus
 578  0255 BE           	cp (hl)
 579  0256 C8           	ret z ;если уже в фокусе, ничего не делаем
 580  0257 32 DC 02     	ld (proc_set_focus_id_tmp),a ;сохранить
 581  025A
 582  025A 21 00 27     	ld hl,proc_table-256 ;проверка активен ли заданный процесс
 583  025D 84           	add h
 584  025E 67           	ld h,a
 585  025F AF           	xor a
 586  0260 B6           	or (hl)
 587  0261 C8           	ret z
 588  0262
 589  0262
 590  0262              	;сохранить в буфер процесса текущий экран
 591  0262 3A 04 27     	ld a,(proc_id_focus) ;текущий в фокусе
 592  0265 21 00 27     	ld hl,proc_table - 256
 593  0268 84           	add h
 594  0269 67           	ld h,a
 595  026A E5           	push hl
 596  026B DD E1        	pop ix ;дескриптор процесса предыдущего
 597  026D
 598  026D DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
 599  0270 CD 8C 08     	call drvgmx.PageSlot3
 600  0273 3E 39        	ld a,con_scr_real ;настоящий экран
 601  0275 CD 6D 09     	call drvgmx.PageSlot2
 602  0278 21 00 80     	ld hl,#8000 ;скопировать
 603  027B 11 00 C0     	ld de,#c000
 604  027E 01 00 40     	ld bc,#4000
 605  0281 ED B0        	ldir
 606  0283
 607  0283 DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
 608  0286 CD 8C 08     	call drvgmx.PageSlot3
 609  0289 3E 79        	ld a,con_atr_real
 610  028B CD 6D 09     	call drvgmx.PageSlot2
 611  028E 21 00 80     	ld hl,#8000 ;скопировать
 612  0291 11 00 C0     	ld de,#c000
 613  0294 01 00 40     	ld bc,#4000
 614  0297 ED B0        	ldir
 615  0299
 616  0299              	;сохранить позицию скрола
 617  0299              	;ld hl,(drvgmx.curscrl)
 618  0299              	;ld (ix+#08),hl ;позиция скрола
 619  0299
 620  0299
 621  0299              	;вернуть из буфера экран нужного процесса
 622  0299 3A DC 02     	ld a,(proc_set_focus_id_tmp)
 623  029C 21 00 27     	ld hl,proc_table - 256
 624  029F 84           	add h
 625  02A0 67           	ld h,a
 626  02A1 E5           	push hl
 627  02A2 DD E1        	pop ix ;дескриптор процесса который будет в фокусе
 628  02A4
 629  02A4 DD 7E 04     	ld a,(ix + 04) ;буфер пиксели
 630  02A7 CD 8C 08     	call drvgmx.PageSlot3
 631  02AA 3E 39        	ld a,con_scr_real ;настоящий экран
 632  02AC CD 6D 09     	call drvgmx.PageSlot2
 633  02AF 21 00 C0     	ld hl,#c000 ;скопировать
 634  02B2 11 00 80     	ld de,#8000
 635  02B5 01 00 40     	ld bc,#4000
 636  02B8 ED B0        	ldir
 637  02BA
 638  02BA DD 7E 05     	ld a, (ix + 05) ;буфер атрибуты
 639  02BD CD 8C 08     	call drvgmx.PageSlot3
 640  02C0 3E 79        	ld a,con_atr_real
 641  02C2 CD 6D 09     	call drvgmx.PageSlot2
 642  02C5 21 00 C0     	ld hl,#c000 ;скопировать
 643  02C8 11 00 80     	ld de,#8000
 644  02CB 01 00 40     	ld bc,#4000
 645  02CE ED B0        	ldir
 646  02D0
 647  02D0 CD DD 02     	call page_cur_return
 648  02D3
 649  02D3
 650  02D3 3A DC 02     	ld a,(proc_set_focus_id_tmp)
 651  02D6              	;запомнить активный процесс
 652  02D6 32 04 27     	ld (proc_id_focus),a
 653  02D9
 654  02D9              	;ld hl,(ix+#08) ;позиция скрола
 655  02D9              	;ld (drvgmx.curscrl),hl
 656  02D9              	;call drvgmx.gmxscroll ;обновить скролл
 657  02D9 C3 40 05     	jp Interrupts ;сразу на другой процесс
 658  02DC              	;or a
 659  02DC              	;ret
 660  02DC 00           proc_set_focus_id_tmp db 0 ; временно
 661  02DD
 662  02DD
 663  02DD
 664  02DD              page_cur_return
 665  02DD              ;вернуть текущие страницы
 666  02DD 3A 0B 27     	ld a,(page_slot2_cur)
 667  02E0 CD 6D 09     	call drvgmx.PageSlot2
 668  02E3 3A 0A 27     	ld a,(page_slot3_cur)
 669  02E6 CD 8C 08     	call drvgmx.PageSlot3
 670  02E9 C9           	ret
 671  02EA
 672  02EA
 673  02EA              proc_run
 674  02EA              ;запуск процесса
 675  02EA              ;вх: hl - имя файла
 676  02EA CD 9F 01     	call proc_run_prepar ;выделить память
 677  02ED D8           	ret c
 678  02EE
 679  02EE 2A 1E 02     	ld hl,(proc_run_prepar_name_tmp) ;имя
 680  02F1              	;ld b,Dos.FMODE_READ
 681  02F1 CD 74 0A     	call Dos.fopen_r ;откроем файл для чтения
 682  02F4 DC C3 0B     	call c,Dos.file_error_print_file_open_error
 683  02F7 DA BB 03     	jp c,file_load_err
 684  02FA 32 21 02     	ld (proc_run_file_id_tmp),a ;запомнить id
 685  02FD
 686  02FD              	;проверка длины файла не больше #8000
 687  02FD 7A           	ld	a,d ;самые старшие байты длины
 688  02FE B3           	or e
 689  02FF 28 09        	jr z,file_size_ok ;если не слищком большой
 690  0301              file_too_big
 691  0301 21 66 0D     	ld hl,Dos.msg_file_too_big
 692  0304 CD A3 07     	call drvgmx.printZ
 693  0307 C3 BB 03     	jp file_load_err
 694  030A
 695  030A
 696  030A              file_size_ok
 697  030A 78           	ld	a,b ;младший старший байт длины
 698  030B FE 81        	cp proc_size_max+1
 699  030D 30 F2        	jr nc,file_too_big
 700  030F              	;размер нормальный, прочитаем
 701  030F              	; halt
 702  030F              	; halt
 703  030F              ; WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 704  030F
 705  030F              	;включить страницы
 706  030F DD 2A 22 02  	ld ix,(proc_run_prepar_deskr_tmp)
 707  0313 DD 7E 02     	ld a,(ix+2)
 708  0316 CD 6D 09     	call drvgmx.PageSlot2
 709  0319 DD 7E 03     	ld a,(ix+3)
 710  031C CD 8C 08     	call drvgmx.PageSlot3
 711  031F
 712  031F 21 00 80     	ld hl,PROGSTART
 713  0322 3A 21 02     	ld a,(proc_run_file_id_tmp)
 714  0325 50           	ld d,b ;размер
 715  0326 59           	ld e,c
 716  0327 CD F6 0B     	call Dos.fread
 717  032A 30 08        	jr nc,file_size_ok2
 718  032C              	;если ошибка вернуть страницы
 719  032C CD CB 0B     	call Dos.file_error_print_file_read_error
 720  032F CD DD 02     	call page_cur_return
 721  0332 37           	scf
 722  0333 C9           	ret
 723  0334              file_size_ok2
 724  0334 3A 21 02     	ld a,(proc_run_file_id_tmp)
 725  0337 CD D3 0B     	call Dos.fclose
 726  033A              	;jr file_load_ok
 727  033A
 728  033A
 729  033A              file_load_ok ;загрузился нормально
 730  033A DD 2A 22 02  	ld ix,(proc_run_prepar_deskr_tmp) ;вспомнить дескриптор
 731  033E              	;очистить экран
 732  033E              	;сначала запомнить как было
 733  033E 2A AB 09     	ld hl,(drvgmx.attr_screen)
 734  0341 22 BD 03     	ld (proc_run_attr_screen_tmp),hl
 735  0344              	; запомнить координаты экрана предыдущего
 736  0344 2A A9 09     	ld hl,(drvgmx.col_screen)
 737  0347 22 C1 03     	ld (proc_run_col_screen_tmp),hl ;координаты
 738  034A              	;страницы буфера
 739  034A 3A 0C 27     	ld a,(con_scr_cur)
 740  034D 32 BF 03     	ld (proc_run_con_scr_cur_tmp),a
 741  0350 3A 0D 27     	ld a,(con_atr_cur)
 742  0353 32 C0 03     	ld (proc_run_con_atr_cur_tmp),a
 743  0356              	;скрола
 744  0356 2A 7D 08     	ld hl,(drvgmx.curscrl)
 745  0359 22 C3 03     	ld (proc_run_curscrl_tmp),hl
 746  035C
 747  035C
 748  035C
 749  035C              	;чистить буфер экрана
 750  035C 3E 07        	ld a,proc_color_def ;цвет
 751  035E 32 AB 09     	ld (drvgmx.attr_screen),a
 752  0361 DD 77 0C     	ld (ix+#0c),a ;актрибуты (цвет текста)
 753  0364              	;
 754  0364 3E 0C        	ld a,proc_color2_def ;цвет 2
 755  0366 32 AC 09     	ld (drvgmx.attr_screen2),a
 756  0369 DD 77 0D     	ld (ix+#0d),a ;актрибуты (цвет текста)
 757  036C              	;
 758  036C DD 7E 04     	ld a,(ix+4)
 759  036F 32 0C 27     	ld (con_scr_cur),a
 760  0372 DD 7E 05     	ld a,(ix+5)
 761  0375 32 0D 27     	ld (con_atr_cur),a
 762  0378 CD FA 06     	call drvgmx.cls
 763  037B              	;вернуть
 764  037B 2A BD 03     	ld hl,(proc_run_attr_screen_tmp)
 765  037E 22 AB 09     	ld (drvgmx.attr_screen),hl
 766  0381 2A C1 03     	ld hl,(proc_run_col_screen_tmp) ;координаты
 767  0384 22 A9 09     	ld (drvgmx.col_screen),hl
 768  0387 3A BF 03     	ld a,(proc_run_con_scr_cur_tmp)
 769  038A 32 0C 27     	ld (con_scr_cur),a
 770  038D 3A C0 03     	ld a,(proc_run_con_atr_cur_tmp)
 771  0390 32 0D 27     	ld (con_atr_cur),a
 772  0393 2A C3 03     	ld hl,(proc_run_curscrl_tmp)
 773  0396 22 7D 08     	ld (drvgmx.curscrl),hl
 774  0399
 775  0399
 776  0399
 777  0399
 778  0399              	;подготовить правильный старт
 779  0399 DD 6E 06     	ld l,(ix+6) ;адрес стека
 780  039C DD 66 07     	ld h,(ix+7) ;адрес стека
 781  039F 01 00 80     	ld bc,PROGSTART ;возврат сюда
 782  03A2 2B           	dec hl
 783  03A3 70           	ld (hl),b
 784  03A4 2B           	dec hl
 785  03A5 71           	ld (hl),c
 786  03A6 01 EC FF     	ld bc,-20 ;возврат будет с восстановлением регистров
 787  03A9 09           	add hl,bc
 788  03AA
 789  03AA DD 75 06     	ld (ix+6),l ;адрес стека
 790  03AD DD 74 07     	ld (ix+7),h ;адрес стека
 791  03B0 3A 20 02     	ld a,(proc_run_prepar_id_tmp)
 792  03B3 DD 77 00     	ld (ix),a ;в последнюю очередь код (флаг что процесс работает)
 793  03B6
 794  03B6 CD DD 02     	call page_cur_return
 795  03B9 B7           	or a
 796  03BA C9           	ret
 797  03BB
 798  03BB
 799  03BB              file_load_err
 800  03BB 37           	scf
 801  03BC C9           	ret
 802  03BD
 803  03BD 00 00        proc_run_attr_screen_tmp dw 0 ;временно
 804  03BF 00           proc_run_con_scr_cur_tmp db 0 ;временно
 805  03C0 00           proc_run_con_atr_cur_tmp db 0 ;временно
 806  03C1 00 00        proc_run_col_screen_tmp dw 0 ;временно
 807  03C3 00 00        proc_run_curscrl_tmp dw 0 ;временно
 808  03C5
 809  03C5
 810  03C5
 811  03C5
 812  03C5
 813  03C5
 814  03C5
 815  03C5
 816  03C5              get_c ;функция получение кода нажатой клавиши
 817  03C5              	;вых: a - код последней клавиши, 255 - ничего не нажато
 818  03C5 3A 13 27     	ld a,(proc_id_cur) ;сравнить если процесс в фокусе
 819  03C8 21 04 27     	ld hl,proc_id_focus
 820  03CB BE           	cp (hl)
 821  03CC 3E FF        	ld a,255 ;ничего не нажато если не в фокусе
 822  03CE C0           	ret nz
 823  03CF 3A 0E 27     	ld a,(key_cur) ;или вернуть клавишу
 824  03D2 F5           	push af
 825  03D3 3E FF        	ld a,255
 826  03D5 32 0E 27     	ld (key_cur),a ;очистить буфер
 827  03D8 F1           	pop af
 828  03D9 C9           	ret
 829  03DA
 830  03DA              get_timer ;функция получить значение системного таймера
 831  03DA ED 5B 2C 27  	ld de,(sys_timer) ;младшие байты
 832  03DE 2A 2E 27     	ld hl,(sys_timer+2)
 833  03E1 C9           	ret
 834  03E2
 835  03E2
 836  03E2
 837  03E2              page_copy ;скопировать страницу в страницу
 838  03E2              	;вх: A - номер страницы откуда копировать, B - куда
 839  03E2 ED 43 0E 04  	ld (page_copy_tmp),bc
 840  03E6 32 0E 04     	ld (page_copy_tmp),a
 841  03E9 CD 10 04     	call page_check_owner 	;проверка разрешений
 842  03EC D8           	ret c
 843  03ED 3A 0F 04     	ld a,(page_copy_tmp+1)
 844  03F0 CD 10 04     	call page_check_owner 	;проверка разрешений
 845  03F3 D8           	ret c
 846  03F4 3A 0E 04     	ld a,(page_copy_tmp)
 847  03F7 CD 6D 09     	call drvgmx.PageSlot2
 848  03FA 3A 0F 04     	ld a,(page_copy_tmp+1)
 849  03FD CD 8C 08     	call drvgmx.PageSlot3
 850  0400 21 00 80     	ld hl,#8000 ;скопировать
 851  0403 11 00 C0     	ld de,#c000
 852  0406 01 00 40     	ld bc,#4000
 853  0409 ED B0        	ldir
 854  040B C3 DD 02     	jp page_cur_return ;вернуть страницы
 855  040E
 856  040E 00 00        page_copy_tmp dw 0 ;временно
 857  0410
 858  0410              page_check_owner ;проверить разрешена ли страница для процесса
 859  0410 FE 05        	cp #05 ;видео страница
 860  0412 C8           	ret z
 861  0413 FE 07        	cp #07 ;видео страница
 862  0415 C8           	ret z
 863  0416 FE 39        	cp #39 ;видео страница
 864  0418 C8           	ret z
 865  0419 FE 3A        	cp #3a ;видео страница
 866  041B C8           	ret z
 867  041C 32 40 04     	ld (page_check_owner_tmp),a
 868  041F 21 ED 08     	ld hl,drvgmx.page_table ;таблица памяти
 869  0422 06 6D        	ld b,page_max ;всего страниц
 870  0424 0E 00        	ld c,0 ;индекс
 871  0426              page_check_owner_cl ;найти такую страницу
 872  0426 BE           	cp (hl)
 873  0427 28 06        	jr z,page_check_owner_ex
 874  0429 0C           	inc c
 875  042A 23           	inc hl
 876  042B 10 F9        	djnz page_check_owner_cl
 877  042D 37           	scf ;не нашли в списке страниц
 878  042E C9           	ret
 879  042F              page_check_owner_ex
 880  042F              	;нашли
 881  042F 06 00        	ld b,0
 882  0431 21 00 30     	ld hl,proc_page_table ;сверить с кодом текущего процесса
 883  0434 09           	add hl,bc
 884  0435 3A 13 27     	ld a,(proc_id_cur)
 885  0438 BE           	cp (hl)
 886  0439 37           	scf ;не совпадает владелец с процессом
 887  043A 3A 40 04     	ld a,(page_check_owner_tmp)
 888  043D C0           	ret nz
 889  043E B7           	or a
 890  043F C9           	ret
 891  0440 00           page_check_owner_tmp db 0 ;временно
 892  0441
 893  0441
 894  0441              set_VTPL_PLAY ;запустить плеер AY. будет играть на прерываниях
 895  0441 3A 0B 27     	ld a,(page_slot2_cur)
 896  0444 32 01 27     	ld (proc_play_ay_slot2),a ;запомнить страницы с музыкой
 897  0447 3A 0A 27     	ld a,(page_slot3_cur)
 898  044A 32 02 27     	ld (proc_play_ay_slot3),a
 899  044D 3A 13 27     	ld a,(proc_id_cur) ;код процесса, который играет музыку
 900  0450 32 00 27     	ld (proc_play_ay),a
 901  0453 C9           	ret
 902  0454
 903  0454              set_VTPL_MUTE ;остановить плеер AY
 904  0454 AF           	xor a
 905  0455 32 00 27     	ld (proc_play_ay),a
 906  0458 C3 25 13     	jp VTPL.MUTE
 907  045B
 908  045B
 909  045B              get_VTPL_SETUP ;получить адрес переменной плеера
 910  045B 21 00 13     	ld hl,VTPL.SETUP
 911  045E C9           	ret
 912  045F
 913  045F
 914  045F              get_proc_page ;получить номера страниц процесса
 915  045F              	;вых: BC - страницы в слоте 2, 3
 916  045F 3A 0B 27     	ld a,(page_slot2_cur)
 917  0462 47           	ld b,a
 918  0463 3A 0A 27     	ld a,(page_slot3_cur)
 919  0466 4F           	ld c,a
 920  0467 C9           	ret
 921  0468
 922  0468
 923  0468              set_scr ;установить активный экран
 924  0468 FE 05        	cp #05
 925  046A CA B5 08     	jp z,drvgmx.set_scr5
 926  046D FE 07        	cp #07
 927  046F CA C3 08     	jp z,drvgmx.set_scr7
 928  0472 FE 39        	cp #39
 929  0474 CA D1 08     	jp z,drvgmx.set_scr39
 930  0477 FE 3A        	cp #3a
 931  0479 CA DF 08     	jp z,drvgmx.set_scr3a
 932  047C 37           	scf
 933  047D C9           	ret
 934  047E
 935  047E              set_page_slot2	;включить страницу в слот 2 (#8000);
 936  047E CD 10 04     	call page_check_owner ;проверить принадлежит ли страница процессу
 937  0481 D8           	ret c
 938  0482 08           	ex af,af'
 939  0483 3A 13 27     	ld a,(proc_id_cur)
 940  0486 21 00 27     	ld hl,proc_table - 256
 941  0489 84           	add h
 942  048A 67           	ld h,a
 943  048B E5           	push hl
 944  048C DD E1        	pop ix ;дескриптор
 945  048E 08           	ex af,af'
 946  048F DD 77 02     	ld (ix+#02),a ;запомнить текущую страницу процесса
 947  0492 C3 6D 09     	jp drvgmx.PageSlot2 ;включить
 948  0495
 949  0495
 950  0495              set_page_slot3	;включить страницу в слот 2 (#8000);
 951  0495 CD 10 04     	call page_check_owner ;проверить принадлежит ли страница процессу
 952  0498 D8           	ret c
 953  0499 08           	ex af,af'
 954  049A 3A 13 27     	ld a,(proc_id_cur)
 955  049D 21 00 27     	ld hl,proc_table - 256
 956  04A0 84           	add h
 957  04A1 67           	ld h,a
 958  04A2 E5           	push hl
 959  04A3 DD E1        	pop ix ;дескриптор
 960  04A5 08           	ex af,af'
 961  04A6 DD 77 03     	ld (ix+#03),a ;запомнить текущую страницу процесса
 962  04A9 C3 8C 08     	jp drvgmx.PageSlot3
 963  04AC
 964  04AC
 965  04AC
 966  04AC              set_interrupt ;установка адреса обработчика прерываний процесса;
 967  04AC EB           	ex de,hl
 968  04AD 3A 13 27     	ld a,(proc_id_cur)
 969  04B0 21 00 27     	ld hl,proc_table - 256
 970  04B3 84           	add h
 971  04B4 67           	ld h,a
 972  04B5 E5           	push hl
 973  04B6 DD E1        	pop ix ;дескриптор
 974  04B8 EB           	ex de,hl
 975  04B9 DD 75 0E     	ld (ix+#0e),l ;адрес
 976  04BC DD 74 0F     	ld (ix+#0f),h ;адрес
 977  04BF C9           	ret
 978  04C0
 979  04C0
 980  04C0
 981  04C0
 982  04C0              ;выбор функции (вызова)
 983  04C0              function
 984  04C0 08           	ex af,af'
 985  04C1 79           	ld a,c
 986  04C2 FE 2A        	cp function_max ;проверка на общее количество
 987  04C4 38 05        	jr c,function1
 988  04C6              function_no
 989  04C6 08           	ex af,af'
 990  04C7 3E FF        	ld a,255 ;??????
 991  04C9 37           	scf
 992  04CA C9           	ret
 993  04CB              function1
 994  04CB D9           	exx
 995  04CC 6F           	ld l,a
 996  04CD 26 00        	ld h,0
 997  04CF 29           	add hl,hl ;*2
 998  04D0 01 DF 04     	ld bc,function_table
 999  04D3 09           	add hl,bc
1000  04D4 5E           	ld e,(hl)
1001  04D5 23           	inc hl
1002  04D6 56           	ld d,(hl)
1003  04D7 7B           	ld a,e ;временно проверка есть ли такая функция
1004  04D8 B2           	or d
1005  04D9 28 EB        	jr z,function_no ;-^
1006  04DB D5           	push de
1007  04DC D9           	exx
1008  04DD 08           	ex af,af'
1009  04DE C9           	ret ;перейти по адресу функции
1010  04DF
1011  04DF
1012  04DF              function_table ;таблица функций
1013  04DF FA 06        	dw drvgmx.cls  ; #00 (0 dec) - очистить консоль;
1014  04E1 38 07        	dw drvgmx.gotoXY ; #01 (1 dec) - установить позицию курсора в консоли
1015  04E3 AE 07        	dw drvgmx.putC ; #02 (2 dec) - печать символа в консоль;
1016  04E5 49 07        	dw drvgmx.fillLine ; #03 (3 dec) - заполнение строки одним символом
1017  04E7 63 07        	dw drvgmx.paintLine ; #04 (4 dec) - покрасить строку цветом
1018  04E9 00 00        	dw 0 ;#05 (5 dec) -
1019  04EB AD 08        	dw drvgmx.set_color ;#06 (6 dec) - установить цвет текста в консоли;
1020  04ED 00 00        	dw 0 ;#07 (7 dec) - ???????? ???? ?????????? ????????? (???);
1021  04EF 00 00        	dw 0 ;#08 (8 dec) - ?????????? ???? ?????????? ????????? (???);
1022  04F1 A3 07        	dw drvgmx.printZ ; #09 (9 dec) - ????? ?????? ????????;
1023  04F3 4F 0A        	dw Uart.read ;#0A (10 dec) - прочитать байт из uart порта;
1024  04F5 5F 0A        	dw Uart.write ;#0B (11 dec) - записать байт в uart порт;
1025  04F7 00 00        	dw 0 ;#0C (12 dec) -
1026  04F9 00 00        	dw 0 ;#0D (13 dec) - ????? ???????? ???????;
1027  04FB 00 00        	dw 0 ;#0E (14 dec) - ??????????? ?????;
1028  04FD 00 00        	dw 0 ;#0F (15 dec) - ???????? ?????;
1029  04FF C5 03        	dw get_c ;#10 (16 dec) - получить код нажатой клавиши;
1030  0501 00 00        	dw 0 ;#11 (17 dec) - ????? ???????;
1031  0503 00 00        	dw 0 ;#12 (18 dec) - ????? ??????????;
1032  0505 00 00        	dw 0 ;#13 (19 dec)-???????? ?????;
1033  0507 AC 04        	dw set_interrupt ;#14 (20 dec) - установка адреса обработчика прерываний процесса;
1034  0509 37 13        	dw VTPL.INIT ;#15 (21 dec) - инициализация плеера AY;
1035  050B 41 04        	dw set_VTPL_PLAY ;#16 (22 dec) - запустить плеер AY;
1036  050D 54 04        	dw set_VTPL_MUTE ;#17 (23 dec) - заглушить плеер AY;
1037  050F 5B 04        	dw get_VTPL_SETUP ;#18 (24 dec) - получить значение переменной плеера;
1038  0511 E2 03        	dw page_copy ;#19 (25 dec) - скопировать страницу в страницу;
1039  0513 24 02        	dw proc_find_ram ;#1A (26 dec) - получить дополнительную страницу памяти;
1040  0515 7E 04        	dw set_page_slot2 ;#1B (27 dec) - включить страницу в слот 2 (#8000);
1041  0517 95 04        	dw set_page_slot3 ;#1C (28 dec) - включить страницу в слот 3 (#c000);
1042  0519 68 04        	dw set_scr ;#1D (29 dec) - включить экран N;
1043  051B 5F 04        	dw get_proc_page ;#1E (30 dec) - получить номера страниц процесса;
1044  051D DA 03        	dw get_timer ;#1F (31 dec) - получить значение системного таймера
1045  051F 00 00        	dw 0 ;#20 (32 dec) - ;инициализация?
1046  0521 74 0A        	dw Dos.fopen_r ;#21 (33 dec) - открыть файл для чтения или записи;
1047  0523 87 0A        	dw Dos.fopen_c ;#22 (34 dec) - создать файл;
1048  0525 F6 0B        	dw Dos.fread ;#23 (35 dec) - прочитать из файла;
1049  0527 12 0C        	dw Dos.fwrite ;#24 (36 dec) - записать в файл;
1050  0529 D3 0B        	dw Dos.fclose ;#25 (37 dec) - закрыть файл;
1051  052B 00 00        	dw 0 ;#26 (38 dec) -
1052  052D 00 00        	dw 0 ;#27 (39 dec) -
1053  052F 00 00        	dw 0 ;#28 (40 dec) - ?????? ?????? ?? ?????????? ????.
1054  0531 00 00        	dw 0 ;#29 (41 dec) - ??????? ??????;
1055  0533
1056  0533
1057  0533
1058  0533
1059  0533
1060  0533 00 00 00...  	align 16
1061  0540              ;обработчик прерываний
1062  0540              Interrupts
1063  0540 F3           	di
1064  0541 E3           	ex (sp),hl
1065  0542 22 07 27     	ld (proc_stack_addr_return_tmp),hl ;запомнить откуда вызвали прерывание
1066  0545 E3           	ex (sp),hl
1067  0546 F5           	push af
1068  0547 C5           	push bc
1069  0548 D5           	push de
1070  0549 E5           	push hl
1071  054A D9           	exx
1072  054B 08           	ex af,af'
1073  054C F5           	push af
1074  054D C5           	push bc
1075  054E D5           	push de
1076  054F E5           	push hl
1077  0550 DD E5        	push ix
1078  0552 FD E5        	push iy
1079  0554 ED 73 05 27  	ld (proc_stack_addr_tmp),sp ;запомнить адрес стека
1080  0558 3E 01        	ld a,1
1081  055A D3 FE        	out (254),a
1082  055C
1083  055C              	;таймер
1084  055C 2A 2C 27     	ld hl,(sys_timer)
1085  055F 23           	inc hl
1086  0560 22 2C 27     	ld (sys_timer),hl
1087  0563 7C           	ld a,h
1088  0564 B5           	or l
1089  0565 20 07        	jr nz,Interrupts_timer
1090  0567 2A 2E 27     	ld hl,(sys_timer+2)
1091  056A 23           	inc hl
1092  056B 22 2E 27     	ld (sys_timer+2),hl
1093  056E              Interrupts_timer
1094  056E
1095  056E
1096  056E              ;опрос клавиатуры
1097  056E CD E8 0F     	call @DriverKeyboard
1098  0571 FE 1B        	cp proc_switch_key ;если клавиша переключения задач
1099  0573 20 03        	jr nz,Interrupts_key_switch_no
1100  0575 32 09 27     	ld (proc_switch_key_flag),a ;сохранить нажатие
1101  0578              Interrupts_key_switch_no
1102  0578 CB 76        	bit 6,(hl)
1103  057A 20 03        	jr nz,Interrupts_key1 ;если не нажата ни одна
1104  057C
1105  057C 32 0E 27     	ld (key_cur),a ;запомнить клавишу
1106  057F              Interrupts_key1
1107  057F              	;
1108  057F FE 07        	cp DrvKey.keyEdit
1109  0581 20 06        	jr nz,Interrupts_key2
1110  0583              	;переключение языка
1111  0583 3E 08        	ld a,%00001000	;3,=1/0 Rus/Lat
1112  0585 AE           	xor (hl) ;флаг FlgScanKeys
1113  0586 77           	ld (hl),a
1114  0587 18 12        	jr Interrupts_key_ex
1115  0589              Interrupts_key2
1116  0589 FE 06        	cp DrvKey.keyCaps
1117  058B 20 06        	jr nz,Interrupts_key3
1118  058D              	;переключение заглавных
1119  058D 3E 02        	ld a,%00000010	;?1,=1/0 CapsLock on/off
1120  058F AE           	xor (hl)
1121  0590 77           	ld (hl),a
1122  0591 18 08        	jr Interrupts_key_ex
1123  0593              Interrupts_key3
1124  0593 FE 0F        	cp DrvKey.keyDelete
1125  0595 20 04        	jr nz,Interrupts_key_ex
1126  0597              	;графическая
1127  0597 3E 04        	ld a,%00000100	;2,=1/0 Grf on/off
1128  0599 AE           	xor (hl)
1129  059A 77           	ld (hl),a
1130  059B              Interrupts_key_ex
1131  059B              	;с клавиатурой всё
1132  059B
1133  059B
1134  059B
1135  059B
1136  059B
1137  059B              ;определить текущие страницы памяти
1138  059B 01 FD 7A     	ld bc,#7AFD
1139  059E ED 78        	in a,(c)
1140  05A0 E6 7F        	and %01111111
1141  05A2 32 A0 06     	ld (Interrupts_cur_page_slot3),a
1142  05A5 01 FD 78     	ld bc,#78fd
1143  05A8 ED 78        	in a,(c)
1144  05AA EE 02        	xor %00000010
1145  05AC 32 9F 06     	ld (Interrupts_cur_page_slot2),a
1146  05AF
1147  05AF
1148  05AF
1149  05AF
1150  05AF              ;плеер музыки и прочие неотложные процессы
1151  05AF 3A 00 27     	ld a,(proc_play_ay)
1152  05B2 B7           	or a
1153  05B3 28 1B        	jr z,Interrupts_ay_skip
1154  05B5 3A 01 27     	ld a,(proc_play_ay_slot2) ;страницы с музыкой
1155  05B8 CD 6D 09     	call drvgmx.PageSlot2
1156  05BB 3A 02 27     	ld a,(proc_play_ay_slot3) ;страницы с музыкой
1157  05BE CD 8C 08     	call drvgmx.PageSlot3
1158  05C1 CD 5A 1B     	call VTPL.PLAY ;играть
1159  05C4
1160  05C4
1161  05C4              ;вернуть страницы
1162  05C4 3A 9F 06     	ld a,(Interrupts_cur_page_slot2)
1163  05C7 CD 6D 09     	call drvgmx.PageSlot2
1164  05CA 3A A0 06     	ld a,(Interrupts_cur_page_slot3)
1165  05CD CD 8C 08     	call drvgmx.PageSlot3
1166  05D0
1167  05D0
1168  05D0              Interrupts_ay_skip
1169  05D0
1170  05D0
1171  05D0
1172  05D0
1173  05D0
1174  05D0
1175  05D0
1176  05D0
1177  05D0              ;многозадачность тут
1178  05D0 3A 08 27     	ld a,(proc_stack_addr_return_tmp+1) ;узнать адрес откуда были прерывания
1179  05D3 FE 40        	cp #40 ;если прерывание было в области пзу, значит работала система
1180  05D5 DA 6C 06     	jp c,Interrupts_ex ;пропустим переключения на другие задачи
1181  05D8
1182  05D8
1183  05D8 CD 80 06     	call proc_next
1184  05DB              	;jr c,Interrupts_ex ;если процесс один, то на выход
1185  05DB
1186  05DB E5           	push hl ;дескриптор следующего
1187  05DC DD E1        	pop ix
1188  05DE
1189  05DE
1190  05DE              	;запомнить стек предыдущего (текущего) процесса
1191  05DE 3A 13 27     	ld a,(proc_id_cur)
1192  05E1 21 00 27     	ld hl,proc_table - 256
1193  05E4 84           	add h
1194  05E5 67           	ld h,a
1195  05E6 E5           	push hl
1196  05E7 FD E1        	pop iy ;дескриптор предыдущего
1197  05E9
1198  05E9 01 06 00     	ld bc,6
1199  05EC 09           	add hl,bc
1200  05ED ED 4B 05 27  	ld bc,(proc_stack_addr_tmp)
1201  05F1 71           	ld (hl),c
1202  05F2 23           	inc hl
1203  05F3 70           	ld (hl),b
1204  05F4
1205  05F4              	;запомнить координаты экрана предыдущего
1206  05F4 2A A9 09     	ld hl,(drvgmx.col_screen)
1207  05F7 FD 75 0A FD  	ld (iy+#0a),hl ;координаты
1207  05FB 74 0B
1208  05FD
1209  05FD 2A AB 09     	ld hl,(drvgmx.attr_screen)
1210  0600 FD 75 0C FD  	ld (iy+#0c),hl ;атрибуты (цвет текста)
1210  0604 74 0D
1211  0606
1212  0606 2A 7D 08     	ld hl,(drvgmx.curscrl)
1213  0609 FD 75 08 FD  	ld (iy+#08),hl ;позиция скрола
1213  060D 74 09
1214  060F
1215  060F
1216  060F
1217  060F              	;следующий
1218  060F DD 7E 02     	ld a,(ix+2)
1219  0612 32 0B 27     	ld (page_slot2_cur),a ;сделать страницы текущими
1220  0615 CD 6D 09     	call drvgmx.PageSlot2
1221  0618 DD 7E 03     	ld a,(ix+3)
1222  061B 32 0A 27     	ld (page_slot3_cur),a
1223  061E CD 8C 08     	call drvgmx.PageSlot3
1224  0621
1225  0621
1226  0621              	;параметры экрана (консоли)
1227  0621 DD 6E 0A DD  	ld hl,(ix+#0a) ;координаты
1227  0625 66 0B
1228  0627 22 A9 09     	ld (drvgmx.col_screen),hl
1229  062A
1230  062A DD 6E 0C DD  	ld hl,(ix+#0c) ;атрибуты (цвет текста)
1230  062E 66 0D
1231  0630 22 AB 09     	ld (drvgmx.attr_screen),hl
1232  0633
1233  0633 DD 6E 08 DD  	ld hl,(ix+#08) ;позиция скрола
1233  0637 66 09
1234  0639 22 7D 08     	ld (drvgmx.curscrl),hl
1235  063C
1236  063C
1237  063C
1238  063C 3A 04 27     	ld a,(proc_id_focus) ;если это процесс в фокусе
1239  063F DD BE 00     	cp (ix)
1240  0642 20 0C        	jr nz,proc_next_no_focus
1241  0644 3E 39        	ld a,con_scr_real ;экран реальный для драйвера
1242  0646 32 0C 27     	ld (con_scr_cur),a
1243  0649 3E 79        	ld a,con_atr_real ;атрибуты реальные
1244  064B 32 0D 27     	ld (con_atr_cur),a
1245  064E 18 0C        	jr proc_next2
1246  0650              proc_next_no_focus
1247  0650              	;если не в фокусе
1248  0650 DD 7E 04     	ld a,(ix+4) ;пиксели
1249  0653 32 0C 27     	ld (con_scr_cur),a
1250  0656 DD 7E 05     	ld a,(ix+5) ;атрибуты
1251  0659 32 0D 27     	ld (con_atr_cur),a
1252  065C              proc_next2
1253  065C DD 6E 06     	ld l,(ix+6) ;стек
1254  065F DD 66 07     	ld h,(ix+7) ;стек
1255  0662 F9           	ld sp,hl
1256  0663
1257  0663 3A 10 27     	ld a,(proc_id_next)
1258  0666 32 13 27     	ld (proc_id_cur),a ;сменить текущий
1259  0669
1260  0669 CD 74 08     	call drvgmx.gmxscroll ;обновить скролл
1261  066C
1262  066C              Interrupts_ex
1263  066C 3E 00        	ld a,0
1264  066E D3 FE        	out (254),a
1265  0670 FD E1        	pop iy
1266  0672 DD E1        	pop ix
1267  0674 E1           	pop hl
1268  0675 D1           	pop de
1269  0676 C1           	pop bc
1270  0677 F1           	pop af
1271  0678 D9           	exx
1272  0679 08           	ex af,af
1273  067A E1           	pop hl
1274  067B D1           	pop de
1275  067C C1           	pop bc
1276  067D F1           	pop af
1277  067E FB           	ei
1278  067F C9           	ret
1279  0680
1280  0680              proc_next
1281  0680              	;переключение на следующую задачу
1282  0680              	;вых: hl - дескриптор следующего процесса
1283  0680 3A 10 27     	ld a,(proc_id_next) ;узнать следующий
1284  0683              proc_next_skip
1285  0683 3C           	inc a
1286  0684 FE 09        	cp proc_max+1
1287  0686 38 02        	jr c,proc_next1
1288  0688 3E 01        	ld a,proc_id_system
1289  068A              proc_next1
1290  068A 32 10 27     	ld (proc_id_next),a
1291  068D
1292  068D 21 00 27     	ld hl,proc_table-256 ;номера процессов начинаются с 1
1293  0690 84           	add h ;перейти на номер кратный 256
1294  0691 67           	ld h,a
1295  0692 7E           	ld a,(hl)
1296  0693 B7           	or a ;нет активного процесса?
1297  0694 28 EA        	jr z,proc_next ;искать дальше
1298  0696              	;нашли следующий процесс
1299  0696 3A 13 27     	ld a,(proc_id_cur)
1300  0699 BE           	cp (hl) ;если это он и был (всего один процесс)
1301  069A 37           	scf
1302  069B C8           	ret z
1303  069C 7E           	ld a,(hl) ;или вернуть id слудующего
1304  069D B7           	or a
1305  069E C9           	ret
1306  069F
1307  069F 00           Interrupts_cur_page_slot2 db 0 ;временно
1308  06A0 00           Interrupts_cur_page_slot3 db 0 ;временно
1309  06A1
1310  06A1
1311  06A1
1312  06A1              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
1313  06A1              				;на входе в HL число
1314  06A1 11 10 27     			ld de,10000 ;десятки тысяч
1315  06A4 3E FF        			ld a,255
1316  06A6              toDecimal10k
1317  06A6 A7           			and a
1318  06A7 ED 52        			sbc hl,de
1319  06A9 3C           			inc a
1320  06AA 30 FA        			jr nc,toDecimal10k
1321  06AC 19           			add hl,de
1322  06AD C6 30        			add a,48
1323  06AF 32 02 31     			ld (decimalS),a
1324  06B2 11 E8 03     			ld de,1000 ;тысячи
1325  06B5 3E FF        			ld a,255
1326  06B7              toDecimal1k
1327  06B7 A7           			and a
1328  06B8 ED 52        			sbc hl,de
1329  06BA 3C           			inc a
1330  06BB 30 FA        			jr nc,toDecimal1k
1331  06BD 19           			add hl,de
1332  06BE C6 30        			add a,48
1333  06C0 32 03 31     			ld (decimalS+1),a
1334  06C3 11 64 00     			ld de,100 ;сотни
1335  06C6 3E FF        			ld a,255
1336  06C8              toDecimal01k
1337  06C8 A7           			and a
1338  06C9 ED 52        			sbc hl,de
1339  06CB 3C           			inc a
1340  06CC 30 FA        			jr nc,toDecimal01k
1341  06CE 19           			add hl,de
1342  06CF C6 30        			add a,48
1343  06D1 32 04 31     			ld (decimalS+2),a
1344  06D4 11 0A 00     			ld de,10 ;десятки
1345  06D7 3E FF        			ld a,255
1346  06D9              toDecimal001k
1347  06D9 A7           			and a
1348  06DA ED 52        			sbc hl,de
1349  06DC 3C           			inc a
1350  06DD 30 FA        			jr nc,toDecimal001k
1351  06DF 19           			add hl,de
1352  06E0 C6 30        			add a,48
1353  06E2 32 05 31     			ld (decimalS+3),a
1354  06E5 11 01 00     			ld de,1 ;единицы
1355  06E8 3E FF        			ld a,255
1356  06EA              toDecimal0001k
1357  06EA A7           			and a
1358  06EB ED 52        			sbc hl,de
1359  06ED 3C           			inc a
1360  06EE 30 FA        			jr nc,toDecimal0001k
1361  06F0 19           			add hl,de
1362  06F1 C6 30        			add a,48
1363  06F3 32 06 31     			ld (decimalS+4),a
1364  06F6
1365  06F6 C9           			ret
1366  06F7
1367  06F7              	include Drv/zsgmx.asm ;драйвер экрана и памяти
# file opened: Drv/zsgmx.asm
   1+ 06F7              COLOR=1
   2+ 06F7              ;; ZS GMX screen driver (izzx)
   3+ 06F7              	define LINE_LIMIT 80
   4+ 06F7                  module drvgmx
   5+ 06F7              hsize   equ 25 ;всего строк
   6+ 06F7              scraddr equ #c000 ;адрес экрана
   7+ 06F7              scrsize equ 16000  ;размер экрана
   8+ 06F7              scrline equ 80*8   ;размер строки в байтах
   9+ 06F7
  10+ 06F7              init:
  11+ 06F7                  ; ld hl, font_file, b, Dos.FMODE_READ
  12+ 06F7                  ; call Dos.fopen
  13+ 06F7                  ; push af
  14+ 06F7                  ; ld bc, 2048, hl, font
  15+ 06F7                  ; call Dos.fread
  16+ 06F7                  ; pop af
  17+ 06F7                  ; call Dos.fclose
  18+ 06F7              	; xor a : out (#fe), a
  19+ 06F7              	; call cls
  20+ 06F7              	; ret
  21+ 06F7 CD D1 08     	call set_scr39 ;включить экран
  22+ 06FA              cls:
  23+ 06FA 11 00 00         ld de, 0
  23+ 06FD
  24+ 06FD ED 53 7D 08  	ld (curscrl),de ;скролл выключить
  25+ 0701 CD 74 08     	call gmxscroll
  26+ 0704 11 00 00         ld de, 0
  26+ 0707
  27+ 0707 CD 38 07     	call gotoXY
  28+ 070A                  ;ld a, 7 : call Memory.setPage
  29+ 070A 3A 0C 27     	ld a,(con_scr_cur) ;пиксели
  30+ 070D CD 8C 08     	call PageSlot3 ;включить страницу пикселей
  31+ 0710 AF               xor a
  31+ 0711               ; out (#fe), a
  32+ 0711 21 00 C0 11      ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  32+ 0715 01 C0 01 7F
  32+ 0719 3E 77
  32+ 071B ED B0          ldir ;очистить
  33+ 071D 3A 0D 27     	ld a,(con_atr_cur) ;атрибуты
  34+ 0720 CD 8C 08     	call PageSlot3 ;включить страницу атрибутов
  35+ 0723 3A AB 09     	ld a,(attr_screen) ;цвет
  36+ 0726 21 00 C0 11  	ld hl, #c000, de, #c001, bc, 16000-1, (hl), a
  36+ 072A 01 C0 01 7F
  36+ 072E 3E 77
  36+ 0730 ED B0          ldir ;очистить
  37+ 0732              	;call gmxscron ;включить расширенный экран
  38+ 0732 3A 0A 27     	ld a,(page_slot3_cur)
  39+ 0735 C3 8C 08     	jp PageSlot3 ;вернуть страницу
  40+ 0738                  ;jp Memory.setPage
  41+ 0738
  42+ 0738
  43+ 0738              ; Set console coordinates
  44+ 0738              ; d = row(0..23), e = column (0..79)
  45+ 0738              gotoXY:
  46+ 0738              	;rr e
  47+ 0738              	; ld a, 0
  48+ 0738              	; ld (half_tile_screen), a
  49+ 0738 7A           	ld a,d ;проверка координаты строки
  50+ 0739 FE 19        	cp hsize
  51+ 073B D0           	ret nc
  52+ 073C 7B           	ld a,e ;проверка координаты столбца
  53+ 073D FE 50        	cp 80
  54+ 073F D0           	ret nc
  55+ 0740 ED 53 A9 09      ld (col_screen), de
  56+ 0744 C9               ret
  57+ 0745
  58+ 0745              disable:
  59+ 0745                  ; Nothing to disable
  60+ 0745 CD 4A 08     	call gmxscroff ;выключить расширенный экран
  61+ 0748 C9               ret
  62+ 0749
  63+ 0749              ; H - line
  64+ 0749              ; A - char
  65+ 0749              fillLine: ;заполнение строки одним символом
  66+ 0749 F5               push af
  67+ 074A 54 1E 00         ld d, h, e, 0
  67+ 074D CD 38 07       call gotoXY
  68+ 0750 F1               pop af
  69+ 0751 21 AF 09 11      ld hl, fill_buff, de, fill_buff + 1, bc, 80-1, (hl), a
  69+ 0755 B0 09 01 4F
  69+ 0759 00 77
  69+ 075B ED B0          ldir
  70+ 075D 21 AF 09         ld hl, fill_buff
  70+ 0760 C3 A3 07       jp printZ
  71+ 0763
  72+ 0763              paintLine: ;на входе в A номер строки, которую надо покрасить, B - цвет
  73+ 0763 C5           	push bc
  74+ 0764 47               ld b, a
  75+ 0765 0E 00            ld c, 0
  76+ 0767 CD 12 08         call bc_to_attr
  77+ 076A E5           	push hl
  78+ 076B 3A 0D 27     	ld a,(con_atr_cur) ;атрибуты
  79+ 076E CD 8C 08     	call PageSlot3
  80+ 0771 E1           	pop hl
  81+ 0772 C1           	pop bc
  82+ 0773 78           	ld a,b;цвет
  83+ 0774 77               ld (hl), a
  84+ 0775 54 5D            ld de, hl
  85+ 0777 13               inc de
  86+ 0778 01 7F 02         ld bc, (80*8)-1
  87+ 077B ED B0            ldir
  88+ 077D 3A 0A 27         ld a,(page_slot3_cur)
  89+ 0780 C3 8C 08     	jp PageSlot3 ;вернуть страницу
  90+ 0783
  91+ 0783
  92+ 0783              mvCR ;каретка вниз (по коду 13)
  93+ 0783 ED 5B A9 09  	ld de, (col_screen)
  94+ 0787 14           	inc d ;row++
  95+ 0788 7A           	ld a,d
  96+ 0789 FE 19        	cp hsize ;последняя строка
  97+ 078B 38 11        	jr c,mvCR1
  98+ 078D 3A 0C 27     	ld a,(con_scr_cur) ;пиксели
  99+ 0790 CD 8C 08     	call PageSlot3 ;включить страницу пикселей
 100+ 0793 CD 52 08     	call scroll
 101+ 0796 3A 0A 27     	ld a,(page_slot3_cur)
 102+ 0799 CD 8C 08     	call PageSlot3 ;вернуть страницу
 103+ 079C 16 18        	ld d,hsize-1 ;остаться на последне строке
 104+ 079E              mvCR1
 105+ 079E 1E 00        	ld e, 0
 106+ 07A0              	; ld a, 0
 107+ 07A0              	; ld (half_tile_screen), a
 108+ 07A0 C3 38 07     	jp gotoXY
 109+ 07A3
 110+ 07A3              ; Print just one symbol
 111+ 07A3              ; A - symbol
 112+ 07A3              ; putC
 113+ 07A3               	; ld hl, single_symbol_print ;single_symbol
 114+ 07A3              	; ld (hl), a
 115+ 07A3              	; ;ld a, 7 : call Memory.setPage
 116+ 07A3              	; ; ld a,(con_scr_cur) ;пиксели
 117+ 07A3              	; ; call PageSlot3
 118+ 07A3                  ; ld hl, single_symbol_print
 119+ 07A3                  ; call printL
 120+ 07A3                  ; ld a,(page_slot3_cur)
 121+ 07A3              	; jp PageSlot3 ;вернуть страницу
 122+ 07A3
 123+ 07A3              ; Put string
 124+ 07A3              ; hl - string pointer that's begins from symbol count
 125+ 07A3              printZ
 126+ 07A3 7E               ld a, (hl)
 126+ 07A4 A7             and a
 126+ 07A5 C8             ret z
 127+ 07A6 E5               push hl
 128+ 07A7 CD AE 07         call putC
 129+ 07AA E1               pop hl
 130+ 07AB 23               inc hl
 131+ 07AC 18 F5            jr printZ
 132+ 07AE
 133+ 07AE              ; printL
 134+ 07AE                      ; ld	a, (hl)
 135+ 07AE              		; and	a
 136+ 07AE              		; ret	z
 137+ 07AE              putC
 138+ 07AE FE 0D        		cp 13
 138+ 07B0 CA 83 07       jp z, mvCR
 139+ 07B3 FE 0A        		cp 10
 139+ 07B5 C8            ret z ;пропустить символ
 140+ 07B6
 141+ 07B6 CD 0E 08     		call calc_addr_scr
 142+ 07B9 54           		ld d,h ;координаты экрана в DE
 143+ 07BA 5D           		ld e,l
 144+ 07BB 6F           		ld	l,a
 145+ 07BC 26 00        		ld	h,0
 146+ 07BE 29           		add	hl,hl
 147+ 07BF 29           		add	hl,hl
 148+ 07C0 29           		add	hl,hl
 149+ 07C1 01 00 1F             ld      bc,font
 150+ 07C4 09                   add     hl,bc ;hl - адрес шрифта буквы
 151+ 07C5
 152+ 07C5                      ;push    de
 153+ 07C5
 154+ 07C5 3A 0C 27     	ld a,(con_scr_cur) ;страница пиксели
 155+ 07C8 D9           	exx
 156+ 07C9 CD 8C 08     	call PageSlot3
 157+ 07CC D9           	exx
 158+ 07CD D5           	push de ;сохранить адрес символа на экране
 159+ 07CE
 160+ 07CE 01 FF 08         ld  bc,#08ff
 161+ 07D1              print80_1
 162+ 07D1 ED A0        	ldi ;один байт
 163+ 07D3
 164+ 07D3 E5           	push hl ;на строку пикселей вниз
 165+ 07D4 21 4F 00     	ld hl,80-1
 166+ 07D7 19           	add hl,de
 167+ 07D8 EB           	ex de,hl
 168+ 07D9 E1           	pop hl
 169+ 07DA
 170+ 07DA 10 F5        	djnz    print80_1
 171+ 07DC
 172+ 07DC
 173+ 07DC 3A 0D 27     	ld a,(con_atr_cur) ;страница атрибуты
 174+ 07DF CD 8C 08     	call PageSlot3
 175+ 07E2
 176+ 07E2 E1           	pop hl ;адрес символа на экране
 177+ 07E3
 178+ 07E3 06 08            ld      b,8
 179+ 07E5 3A AB 09     	ld a,(attr_screen)
 180+ 07E8 11 50 00     	ld de,80
 181+ 07EB              print80_1_attr ;теперь так же атрибуты
 182+ 07EB
 183+ 07EB 77           	ld (hl),a
 184+ 07EC 19           	add hl,de
 185+ 07ED
 186+ 07ED 10 FC        	djnz    print80_1_attr
 187+ 07EF
 188+ 07EF
 189+ 07EF
 190+ 07EF              ; move cursor на одну позицию вперёд
 191+ 07EF              move_cr80
 192+ 07EF              	;inc	de
 193+ 07EF
 194+ 07EF 21 A9 09     	ld	hl,col_screen
 195+ 07F2 34           	inc	(hl) ;увеличить столбец
 196+ 07F3 7E           	ld	a,(hl)
 197+ 07F4
 198+ 07F4 FE 50        	cp	80
 199+ 07F6 D8           	ret	c
 200+ 07F7
 201+ 07F7 AF           	xor	a
 202+ 07F8              	;ld	(half_tile_screen),a
 203+ 07F8 77           	ld	(hl),a
 204+ 07F9              	;ld	c,a
 205+ 07F9
 206+ 07F9 23           	inc	hl ;на переменную row
 207+ 07FA 34           	inc	(hl)
 208+ 07FB 7E           	ld	a,(hl)
 209+ 07FC              	;ld	b,a
 210+ 07FC
 211+ 07FC FE 19        	cp	hsize ;всего строк
 212+ 07FE DA 07 08     	jp	c,move_cr80_01
 213+ 0801
 214+ 0801 3E 18        	ld	a,hsize-1
 215+ 0803 77           	ld	(hl),a
 216+ 0804              	;ld	b,a
 217+ 0804
 218+ 0804 CD 52 08     	call scroll ;сдвиг вверх
 219+ 0807              	; push	bc
 220+ 0807              	; call	scroll_up8
 221+ 0807              	; pop	bc
 222+ 0807
 223+ 0807              move_cr80_01
 224+ 0807              	; call	calc_addr_scr
 225+ 0807 3A 0A 27     	ld a,(page_slot3_cur)
 226+ 080A C3 8C 08     	jp PageSlot3 ;вернуть страницу
 227+ 080D C9           	ret
 228+ 080E
 229+ 080E              calc_addr_scr	;определение адреса экрана по координатам символа
 230+ 080E ED 4B A9 09  	ld	bc,(col_screen)
 231+ 0812              bc_to_attr:
 232+ 0812 26 00        	ld h,0
 233+ 0814 68           	ld l,b ;строка
 234+ 0815 29           	add hl,hl ;*2
 235+ 0816 11 75 09     	ld de,table_addr_scr
 236+ 0819 19           	add hl,de
 237+ 081A 5E           	ld e,(hl)
 238+ 081B 23           	inc hl
 239+ 081C 56           	ld d,(hl) ;узнали координаты строки
 240+ 081D 26 00        	ld h,0
 241+ 081F 69           	ld l,c ;колонка
 242+ 0820 19           	add hl,de ;узнали адрес символа
 243+ 0821
 244+ 0821 ED 5B 7D 08  	ld de,(curscrl) ;добавить аппаратный скрол
 245+ 0825 19           	add hl,de
 246+ 0826 11 80 3E     	ld de,scrsize
 247+ 0829 A7           	and a		;check over
 248+ 082A ED 52        	sbc hl,de
 249+ 082C 30 01        	jr nc,calc02
 250+ 082E 19           	add hl,de
 251+ 082F              calc02:
 252+ 082F 11 00 C0     	ld de,scraddr  ;screen
 253+ 0832 19           	add hl,de
 254+ 0833
 255+ 0833              	; ld      a,b
 256+ 0833              	; ld      d,a
 257+ 0833              	; rrca
 258+ 0833              	; rrca
 259+ 0833              	; rrca
 260+ 0833              	; and     a,224
 261+ 0833              	; add     a,c
 262+ 0833              	; ld      e,a
 263+ 0833              	; ld      a,d
 264+ 0833              	; and     24
 265+ 0833              	; or      #c0
 266+ 0833              	; ld      d,a
 267+ 0833 C9           	ret
 268+ 0834
 269+ 0834
 270+ 0834
 271+ 0834              clear_line ;очистить строку
 272+ 0834                  ;ld b, hsize-1 ;последняя
 273+ 0834                  ;ld c, 0
 274+ 0834 CD 12 08         call bc_to_attr ;узнать адрес
 275+ 0837 54           	ld d,h
 276+ 0838 5D           	ld e,l
 277+ 0839 13           	inc de
 278+ 083A 01 7F 02     	ld bc,scrline-1
 279+ 083D 36 00        	ld (hl),0
 280+ 083F ED B0        	ldir
 281+ 0841 C9           	ret
 282+ 0842
 283+ 0842              gmxscron
 284+ 0842 01 FD 7E                 ld      bc,#7efd
 285+ 0845 3E C8                    ld      a,#c8
 286+ 0847 ED 79                    out     (c),a
 287+ 0849                          ; ld      bc,#7ffd
 288+ 0849                          ; ld      a,#10    ;5 screen
 289+ 0849                          ; out     (c),a
 290+ 0849 C9                       ret
 291+ 084A
 292+ 084A              ; gmxscron2
 293+ 084A                          ; ld      bc,#7efd
 294+ 084A                          ; ld      a,#c8
 295+ 084A                          ; out     (c),a
 296+ 084A                          ; ld      bc,#7ffd
 297+ 084A                          ; ld      a,#18    ;7 screen
 298+ 084A                          ; out     (c),a
 299+ 084A                          ; ret
 300+ 084A
 301+ 084A              gmxscroff
 302+ 084A 01 FD 7E                 ld      bc,#7efd
 303+ 084D 3E C0                    ld      a,#c0
 304+ 084F ED 79                    out     (c),a
 305+ 0851                          ; ld      bc,#7ffd
 306+ 0851                          ; ld      a,#10    ;5 screen
 307+ 0851                          ; out     (c),a
 308+ 0851 C9                       ret
 309+ 0852
 310+ 0852
 311+ 0852
 312+ 0852
 313+ 0852
 314+ 0852
 315+ 0852              scroll: ;push hl         ; скpолл экpана на стpоку ввеpх
 316+ 0852 2A 7D 08     	ld hl,(curscrl)	;hard scroll
 317+ 0855 11 80 02     	ld de,scrline
 318+ 0858 19           	add hl,de	;next line
 319+ 0859 11 80 3E     	ld de,scrsize	;chek over 16000
 320+ 085C A7           	and a
 321+ 085D ED 52        	sbc hl,de
 322+ 085F 30 03        	jr nc,scrollchek
 323+ 0861 19           	add hl,de
 324+ 0862 18 03        	jr scrollchek1
 325+ 0864              scrollchek:
 326+ 0864 21 00 00     	ld hl,0
 327+ 0867              scrollchek1:
 328+ 0867 22 7D 08     	ld (curscrl),hl
 329+ 086A CD 74 08     	call gmxscroll
 330+ 086D
 331+ 086D 06 18            ld b,hsize-1    ;last line
 332+ 086F 0E 00        	ld c,0
 333+ 0871                  ;ld a,(attr_screen) ;цвет
 334+ 0871 C3 34 08         jp clear_line      ; очистка последней стpоки
 335+ 0874                  ;ret
 336+ 0874               ;аппаратный скрол вверх
 337+ 0874              gmxscroll:
 338+ 0874              ;set hard scroll
 339+ 0874              ;in:
 340+ 0874              ;out:
 341+ 0874              	;push af
 342+ 0874              	;push bc
 343+ 0874              	;push de
 344+ 0874 21 13 27     	ld hl,proc_id_cur
 345+ 0877 3A 04 27     	ld a,(proc_id_focus)
 346+ 087A BE           	cp (hl)
 347+ 087B C0           	ret nz ;скрол меняем только когда в фокусе
 348+ 087C
 349+ 087C 11 00 00     	ld de,0
 350+ 087F              curscrl equ $-2 ;current hard scroll (0-15999)
 351+ 087F 01 FD 7A     	ld bc,07AFDh
 352+ 0882 7B           	ld a,e
 353+ 0883 ED 79        	out (c),a
 354+ 0885 01 FD 7C     	ld bc,07CFDh
 355+ 0888 7A           	ld a,d
 356+ 0889 ED 79        	out (c),a
 357+ 088B              	;pop de
 358+ 088B              	;pop bc
 359+ 088B              	;pop af
 360+ 088B C9           	ret
 361+ 088C
 362+ 088C
 363+ 088C
 364+ 088C
 365+ 088C
 366+ 088C              PageSlot3
 367+ 088C              ; драйвер памяти Scorpion GMX 2Mb
 368+ 088C
 369+ 088C                       ;push hl
 370+ 088C                       ; ld   hl,page_table
 371+ 088C                       ; add  a,l
 372+ 088C                       ; jr   nc,PageSlot3_1
 373+ 088C                       ; inc  h          ;коррекция
 374+ 088C              ; PageSlot3_1  ld   l,a
 375+ 088C                       ; ld   a,(hl)
 376+ 088C                       ;pop  hl
 377+ 088C                       ;cp   #ff
 378+ 088C                       ;scf
 379+ 088C                       ;ret  z
 380+ 088C                       ;push bc
 381+ 088C F5                    push af
 382+ 088D 07                    rlca
 383+ 088E E6 10        		 and #10
 384+ 0890 F6 01                 or  #01  ;выбор ОЗУ вместо ПЗУ
 385+ 0892 01 FD 1F              ld   bc,#1ffd
 386+ 0895              PageSlot3DOS
 387+ 0895              		 ;or #00 ; #04 тут выбор ПЗУ TRDOS
 388+ 0895 ED 79                 out  (c),a
 389+ 0897 F1                    pop  af
 390+ 0898 F5                    push af
 391+ 0899 E6 07                 and  #07
 392+ 089B              PageSlot3Scr ;тут выбор экрана и ПЗУ
 393+ 089B F6 10                 or   #10 ;#0 ;#18
 394+ 089D 06 7F                 ld   b,#7f
 395+ 089F ED 79                 out  (c),a
 396+ 08A1 F1                    pop  af
 397+ 08A2 0F                    rrca
 398+ 08A3 0F                    rrca
 399+ 08A4 0F                    rrca
 400+ 08A5 0F                    rrca
 401+ 08A6 E6 07                 and  #07
 402+ 08A8 06 DF                 ld   b,#df
 403+ 08AA ED 79                 out  (c),a
 404+ 08AC                       ;pop  hl
 405+ 08AC C9                    ret
 406+ 08AD
 407+ 08AD              set_color
 408+ 08AD 32 AB 09     		ld (attr_screen),a
 409+ 08B0 78           		ld a,b
 410+ 08B1 32 AC 09     		ld (attr_screen2),a
 411+ 08B4 C9           		ret
 412+ 08B5
 413+ 08B5              set_scr5 ;включить экран 5
 414+ 08B5 CD 4A 08     		call gmxscroff ;выключить расширенный
 415+ 08B8 3E 10        		ld a,#10
 416+ 08BA 32 9C 08     		ld (PageSlot3Scr+1),a
 417+ 08BD 3A 0A 27     		ld a,(page_slot3_cur)
 418+ 08C0 C3 8C 08     		jp PageSlot3
 419+ 08C3
 420+ 08C3
 421+ 08C3              set_scr7 ;включить экран 7
 422+ 08C3 CD 4A 08     		call gmxscroff ;выключить расширенный
 423+ 08C6 3E 18        		ld a,#18
 424+ 08C8 32 9C 08     		ld (PageSlot3Scr+1),a
 425+ 08CB 3A 0A 27     		ld a,(page_slot3_cur)
 426+ 08CE C3 8C 08     		jp PageSlot3
 427+ 08D1
 428+ 08D1
 429+ 08D1              set_scr39 ;включить экран 39
 430+ 08D1 CD 42 08     		call gmxscron ;выключить расширенный
 431+ 08D4 3E 10        		ld a,#10
 432+ 08D6 32 9C 08     		ld (PageSlot3Scr+1),a
 433+ 08D9 3A 0A 27     		ld a,(page_slot3_cur)
 434+ 08DC C3 8C 08     		jp PageSlot3
 435+ 08DF
 436+ 08DF
 437+ 08DF              set_scr3a ;включить экран 3b
 438+ 08DF CD 42 08     		call gmxscron ;выключить расширенный
 439+ 08E2 3E 18        		ld a,#18
 440+ 08E4 32 9C 08     		ld (PageSlot3Scr+1),a
 441+ 08E7 3A 0A 27     		ld a,(page_slot3_cur)
 442+ 08EA C3 8C 08     		jp PageSlot3
 443+ 08ED
 444+ 08ED
 445+ 08ED
 446+ 08ED
 447+ 08ED
 448+ 08ED
 449+ 08ED              ;Таблица страниц кроме #00-#07, #39, #3a, #77-7F
 450+ 08ED              page_table    ;db   #00,#01,#02,#03,#04,#05,#06,#07,
 451+ 08ED 08 09        		 db	  #08,#09
 452+ 08EF 0A 0B 0C 0D           db   #0a,#0b,#0c,#0d,#0e
 452+ 08F3 0E
 453+ 08F4 0F 10 11 12           db   #0f,#10,#11,#12,#13,#14
 453+ 08F8 13 14
 454+ 08FA 15 16 17 18           db   #15,#16,#17,#18,#19,#1a
 454+ 08FE 19 1A
 455+ 0900 1B 1C 1D 1E           db   #1b,#1c,#1d,#1e,#1f,#20
 455+ 0904 1F 20
 456+ 0906 21 22 23 24           db   #21,#22,#23,#24,#25,#26
 456+ 090A 25 26
 457+ 090C 27 28 29 2A           db   #27,#28,#29,#2a,#2b,#2c
 457+ 0910 2B 2C
 458+ 0912 2D 2E 2F 30           db   #2d,#2e,#2f,#30,#31,#32
 458+ 0916 31 32
 459+ 0918 33 34 35 36           db   #33,#34,#35,#36,#37,#38
 459+ 091C 37 38
 460+ 091E 3B 3C 3D 3E           db   #3b,#3c,#3d,#3e,#3f,#40
 460+ 0922 3F 40
 461+ 0924 41 42 43 44           db   #41,#42,#43,#44,#45,#46
 461+ 0928 45 46
 462+ 092A 47 48 49 4A           db   #47,#48,#49,#4a,#4b,#4c
 462+ 092E 4B 4C
 463+ 0930
 464+ 0930 4D 4E 4F 50           db   #4d,#4e,#4f,#50,#51,#52
 464+ 0934 51 52
 465+ 0936 53 54 55 56           db   #53,#54,#55,#56,#57,#58
 465+ 093A 57 58
 466+ 093C 59 5A 5B 5C           db   #59,#5a,#5b,#5c,#5d,#5e
 466+ 0940 5D 5E
 467+ 0942 5F 60 61 62           db   #5f,#60,#61,#62,#63,#64
 467+ 0946 63 64
 468+ 0948 65 66 67 68           db   #65,#66,#67,#68,#69,#6a
 468+ 094C 69 6A
 469+ 094E 6B 6C 6D 6E           db   #6b,#6c,#6d,#6e,#6f,#70
 469+ 0952 6F 70
 470+ 0954 71 72 73 74           db   #71,#72,#73,#74,#75,#76
 470+ 0958 75 76
 471+ 095A                       ;db   #77,#78,#79,#7a,#7b,#7c,#7d,#7e
 472+ 095A                       ;db   #7f
 473+ 095A              page_table_end
 474+ 095A 00 00 00...           ds 128-(page_table_end-page_table) ;забить остаток нулями
 475+ 096D
 476+ 096D
 477+ 096D
 478+ 096D              ;font equ #4000 ; Using ZX-Spectrum screen as font buffer
 479+ 096D              ;font_file db "data/font.bin", 0
 480+ 096D
 481+ 096D              PageSlot2 ;включение банка из A в слот памяти 2
 482+ 096D EE 02        	xor 2
 483+ 096F 01 FD 78     	ld bc,#78fd
 484+ 0972 ED 79        	out (c),a
 485+ 0974 C9           	ret
 486+ 0975
 487+ 0975
 488+ 0975              table_addr_scr	;адреса строк текста
 489+ 0975 00 00        	defw	00000h ;0
 490+ 0977 80 02        	defw	00280h
 491+ 0979 00 05        	defw	00500h
 492+ 097B 80 07        	defw	00780h
 493+ 097D 00 0A        	defw	00a00h
 494+ 097F 80 0C        	defw	00c80h
 495+ 0981 00 0F        	defw	00f00h
 496+ 0983 80 11        	defw	01180h
 497+ 0985
 498+ 0985 00 14        	defw	01400h ;8
 499+ 0987 80 16        	defw	01680h
 500+ 0989 00 19        	defw	01900h
 501+ 098B 80 1B        	defw	01b80h
 502+ 098D 00 1E        	defw	01e00h
 503+ 098F 80 20        	defw	02080h
 504+ 0991 00 23        	defw	02300h
 505+ 0993 80 25        	defw	02580h
 506+ 0995
 507+ 0995 00 28        	defw	02800h ;16
 508+ 0997 80 2A        	defw	02a80h
 509+ 0999 00 2D        	defw	02d00h
 510+ 099B 80 2F        	defw	02f80h
 511+ 099D 00 32        	defw	03200h
 512+ 099F 80 34        	defw	03480h
 513+ 09A1 00 37        	defw	03700h
 514+ 09A3 80 39        	defw	03980h
 515+ 09A5
 516+ 09A5 00 3C        	defw	03c00h ;24
 517+ 09A7 80 3E        	defw	03e80h ;25 вне экрана
 518+ 09A9
 519+ 09A9
 520+ 09A9 00           col_screen			db	0	;столбец
 521+ 09AA 00           row_screen			db	0	;строка
 522+ 09AB              ;half_tile_screen	db	0
 523+ 09AB 07           attr_screen			db	07	;основной цвет
 524+ 09AC 0C           attr_screen2		db	#c	;второй цвет
 525+ 09AD
 526+ 09AD
 527+ 09AD              ;col_screen_temp			dw	0
 528+ 09AD              ;half_tile_screen_temp	db	0
 529+ 09AD
 530+ 09AD 01           single_symbol_print db 1
 531+ 09AE 00           single_symbol 		db 0
 532+ 09AF
 533+ 09AF 00 00 00...  fill_buff ds 80+1
 534+ 0A00
 535+ 0A00                  endmodule
# file closed: Drv/zsgmx.asm
1368  0A00              	include Drv/zx-wifi.asm ;драйвер сетевой карты ESP
# file opened: Drv/zx-wifi.asm
   1+ 0A00              ; This driver works with 16c550 uart that's support AFE
   2+ 0A00                  module Uart
   3+ 0A00              ; Make init shorter and readable:-)
   4+ 0A00                  macro outp port, value
   5+ 0A00 ~            	ld b, port
   6+ 0A00 ~            	ld c, #ef
   7+ 0A00 ~                ld a, value
   8+ 0A00 ~                out (c), a
   9+ 0A00                  endm
  10+ 0A00
  11+ 0A00              ; Internal port constants
  12+ 0A00              RBR_THR = #F8
  13+ 0A00              IER     = RBR_THR + 1
  14+ 0A00              IIR_FCR = RBR_THR + 2
  15+ 0A00              LCR     = RBR_THR + 3
  16+ 0A00              MCR     = RBR_THR + 4
  17+ 0A00              LSR     = RBR_THR + 5
  18+ 0A00              MSR     = RBR_THR + 6
  19+ 0A00              SR      = RBR_THR + 7
  20+ 0A00
  21+ 0A00              chek: ;проверка есть ли карта
  22+ 0A00 3E F8        	ld a, RBR_THR
  23+ 0A02 DB FE            in a, (#fe)
  24+ 0A04 FE FF        	cp #ff
  25+ 0A06 C0           	ret nz ;если читает 255, то нет карты
  26+ 0A07 3E F8        	ld a, RBR_THR
  27+ 0A09 DB FE            in a, (#fe) ;второй раз для надёжности
  28+ 0A0B FE FF        	cp #ff
  29+ 0A0D C9           	ret
  30+ 0A0E
  31+ 0A0E              init:
  32+ 0A0E                  outp MCR,     #0d  // Assert RTS
  32+ 0A0E 06 FC       >	ld b, MCR
  32+ 0A10 0E EF       >	ld c, #ef
  32+ 0A12 3E 0D       >    ld a, #0d
  32+ 0A14 ED 79       >    out (c), a
  33+ 0A16                  outp IIR_FCR, #87  // Enable fifo 8 level, and clear it
  33+ 0A16 06 FA       >	ld b, IIR_FCR
  33+ 0A18 0E EF       >	ld c, #ef
  33+ 0A1A 3E 87       >    ld a, #87
  33+ 0A1C ED 79       >    out (c), a
  34+ 0A1E                  outp LCR,     #83  // 8n1, DLAB=1
  34+ 0A1E 06 FB       >	ld b, LCR
  34+ 0A20 0E EF       >	ld c, #ef
  34+ 0A22 3E 83       >    ld a, #83
  34+ 0A24 ED 79       >    out (c), a
  35+ 0A26                  outp RBR_THR, #01  // 115200 (divider 1)
  35+ 0A26 06 F8       >	ld b, RBR_THR
  35+ 0A28 0E EF       >	ld c, #ef
  35+ 0A2A 3E 01       >    ld a, #01
  35+ 0A2C ED 79       >    out (c), a
  36+ 0A2E                  outp IER,     #00  // (divider 0). Divider is 16 bit, so we get (#0002 divider)
  36+ 0A2E 06 F9       >	ld b, IER
  36+ 0A30 0E EF       >	ld c, #ef
  36+ 0A32 3E 00       >    ld a, #00
  36+ 0A34 ED 79       >    out (c), a
  37+ 0A36
  38+ 0A36                  outp LCR,     #03 // 8n1, DLAB=0
  38+ 0A36 06 FB       >	ld b, LCR
  38+ 0A38 0E EF       >	ld c, #ef
  38+ 0A3A 3E 03       >    ld a, #03
  38+ 0A3C ED 79       >    out (c), a
  39+ 0A3E                  outp IER,     #00 // Disable int
  39+ 0A3E 06 F9       >	ld b, IER
  39+ 0A40 0E EF       >	ld c, #ef
  39+ 0A42 3E 00       >    ld a, #00
  39+ 0A44 ED 79       >    out (c), a
  40+ 0A46                  outp MCR,     #2f // Enable AFE
  40+ 0A46 06 FC       >	ld b, MCR
  40+ 0A48 0E EF       >	ld c, #ef
  40+ 0A4A 3E 2F       >    ld a, #2f
  40+ 0A4C ED 79       >    out (c), a
  41+ 0A4E C9               ret
  42+ 0A4F
  43+ 0A4F              retry_rec_count_max equ 10 ;ждать данных максимум столько прерываний
  44+ 0A4F
  45+ 0A4F              ; Flag C <- Data available
  46+ 0A4F              ; isAvailable:
  47+ 0A4F                  ; ld a, LSR
  48+ 0A4F                  ; in a, (#ef)
  49+ 0A4F                  ; rrca
  50+ 0A4F                  ; ret
  51+ 0A4F
  52+ 0A4F              ; Non-blocking read
  53+ 0A4F              ; Flag C <- is byte was readen
  54+ 0A4F              ; A <- byte
  55+ 0A4F              ; read1:
  56+ 0A4F                  ; ld a, LSR
  57+ 0A4F                  ; in a, (#ef)
  58+ 0A4F                  ; rrca
  59+ 0A4F                  ; ret nc
  60+ 0A4F                  ; ld a, RBR_THR
  61+ 0A4F                  ; in a, (#ef)
  62+ 0A4F                  ; scf
  63+ 0A4F                  ; ret
  64+ 0A4F
  65+ 0A4F              ; Tries read byte with timeout
  66+ 0A4F              ; Flag C = 0 is byte read
  67+ 0A4F              ; A <- byte
  68+ 0A4F              read:
  69+ 0A4F              	;xor a ;4
  70+ 0A4F              	;ld (#5C78),a ;обнулить счётчик ожидания ;13
  71+ 0A4F              ;.wait
  72+ 0A4F 3E FD            ld a, LSR
  73+ 0A51 DB EF            in a, (#ef)
  74+ 0A53 0F               rrca
  75+ 0A54 30 06        	jr nc, .readNo
  76+ 0A56 3E F8            ld a, RBR_THR
  77+ 0A58 DB FE            in a, (#fe)
  78+ 0A5A B7           	or a ;есть данные
  79+ 0A5B C9           	ret
  80+ 0A5C              .readNo ;нет данных
  81+ 0A5C AF           	xor a
  82+ 0A5D 37           	scf
  83+ 0A5E C9           	ret
  84+ 0A5F              ; .readW
  85+ 0A5F              	; ;ld a,(#5C78)
  86+ 0A5F              	; cp retry_rec_count_max
  87+ 0A5F              	; jr c, .wait ;ещё попытка
  88+ 0A5F              	; xor a ;выключим флаг переноса если время вышло
  89+ 0A5F              	; ret
  90+ 0A5F
  91+ 0A5F
  92+ 0A5F
  93+ 0A5F
  94+ 0A5F              ; Blocking read
  95+ 0A5F              ; A <- Byte
  96+ 0A5F              ; readB:
  97+ 0A5F                  ; ld a, LSR
  98+ 0A5F                  ; in a, (#ef)
  99+ 0A5F                  ; rrca
 100+ 0A5F                  ; jr nc, readB
 101+ 0A5F              	; ld a, RBR_THR
 102+ 0A5F                  ; in a, (#ef)
 103+ 0A5F                  ; ret
 104+ 0A5F
 105+ 0A5F              ; A -> byte to send
 106+ 0A5F              ;Out: Flag C = 0 is byte writed
 107+ 0A5F              write:
 108+ 0A5F F5               push af
 109+ 0A60              ;.wait
 110+ 0A60 3E FD        	ld a, LSR
 111+ 0A62 DB EF            in a, (#ef)
 112+ 0A64 E6 20            and #20
 113+ 0A66 28 09            jr z, .writeNo
 114+ 0A68 F1               pop af
 115+ 0A69 06 F8        	ld b, RBR_THR
 116+ 0A6B 0E EF        	ld c, #ef
 117+ 0A6D ED 79            out (c), a
 118+ 0A6F B7           	or a ;отправили
 119+ 0A70 C9               ret
 120+ 0A71              .writeNo
 121+ 0A71 F1           	pop af
 122+ 0A72 37           	scf ;не отправили
 123+ 0A73 C9           	ret
 124+ 0A74                  endmodule
# file closed: Drv/zx-wifi.asm
1369  0A74              	include Drv/zsfat.asm ;драйвер диска
# file opened: Drv/zsfat.asm
   1+ 0A74              ;trdos & fat32 driver (izzx)
   2+ 0A74                  MODULE Dos
   3+ 0A74              ; API methods - для всех процессов
   4+ 0A74              ;ESX_GETSETDRV = #89
   5+ 0A74              ;ESX_FOPEN = #9A
   6+ 0A74              ;ESX_FCLOSE = #9B
   7+ 0A74              ;ESX_FSYNC = #9C
   8+ 0A74              ;ESX_FREAD = #9D
   9+ 0A74              ;ESX_FWRITE = #9E
  10+ 0A74
  11+ 0A74              ; File modes
  12+ 0A74              FMODE_READ = #01
  13+ 0A74              ;FMODE_WRITE = #06
  14+ 0A74              FMODE_CREATE = #0E
  15+ 0A74
  16+ 0A74                  ; MACRO esxCall func
  17+ 0A74                  ; rst #8 : db func
  18+ 0A74                  ; ENDM
  19+ 0A74
  20+ 0A74              ;макросы только для внутренней работы самого модуля через BIOS
  21+ 0A74              ;
  22+ 0A74              ;R8DOS			вызов функции R8DOS
  23+ 0A74              ;R8FAT			вызов функции R8FAT
  24+ 0A74              ;R8DOSc			вызов функции R8DOS
  25+ 0A74              ;
  26+ 0A74              ;------------------------------------------------------------------------------
  27+ 0A74              ;вызов функции R8DOS
  28+ 0A74              ;вх: =0 номер функции
  29+ 0A74              ;
  30+ 0A74              	MACRO	R8DOS nFunc
  31+ 0A74 ~            	ld	c,nFunc
  32+ 0A74 ~            	rst	#08
  33+ 0A74 ~            	db	#81
  34+ 0A74              	ENDM
  35+ 0A74
  36+ 0A74              ;------------------------------------------------------------------------------
  37+ 0A74              ;вызов функции R8FAT
  38+ 0A74              ;вх: =0 номер функции
  39+ 0A74              ;
  40+ 0A74              	MACRO	R8FAT nFunc
  41+ 0A74 ~            	ld	c,nFunc
  42+ 0A74 ~            	rst	#08
  43+ 0A74 ~            	db	#91
  44+ 0A74              	ENDM
  45+ 0A74
  46+ 0A74              ;------------------------------------------------------------------------------
  47+ 0A74              ;вызов функции R8DOS
  48+ 0A74              ;вх: c - номер функции
  49+ 0A74              ;
  50+ 0A74              	MACRO	R8DOSc
  51+ 0A74 ~            	rst	#08
  52+ 0A74 ~            	db	#81
  53+ 0A74              	ENDM
  54+ 0A74
  55+ 0A74              ;------------------------------------------------------------------------------
  56+ 0A74              ;вызов функции #02 (FileMan) R8CONF
  57+ 0A74              ;вх: =#00 - номер функции файл менеджера
  58+ 0A74              ;
  59+ 0A74              	MACRO	R8C02FM nFunct
  60+ 0A74 ~            	ld	bc,#100*nFunct+#02
  61+ 0A74 ~            	rst	#08
  62+ 0A74 ~            	db	#8E
  63+ 0A74              	ENDM
  64+ 0A74
  65+ 0A74              ;==============================================================================
  66+ 0A74              r8f00_DeinitFAT		equ #00
  67+ 0A74              r8f01_InitFAT		equ #01
  68+ 0A74              r8f04_FindPath		equ #04
  69+ 0A74              r8f07_FileOpen		equ #07 ;открыть файл для последующих операций с ним
  70+ 0A74              r8f08_FileRead		equ #08	;чтение данных из файла в память
  71+ 0A74              r8f09_FileWrite		equ #09	;запись данных из памяти в файл
  72+ 0A74              r8f0E_CreateFileLFN	equ #0E ;создание файла с длинным именем в текущем каталоге
  73+ 0A74              r8f0F_CreateFileSFN	equ #0F
  74+ 0A74
  75+ 0A74              r8f13_GetPath 		equ #13;(19) получение текущего пути
  76+ 0A74
  77+ 0A74              r8d2D_FindPart		equ #2D
  78+ 0A74              r8d2E_CngHDD		equ #2E
  79+ 0A74
  80+ 0A74              ;конец макросов BIOS
  81+ 0A74
  82+ 0A74              files_fat_max equ 8 ;максимальное число открытых файлов fat
  83+ 0A74              files_trd_max equ 8 ;максимальное число открытых файлов trd
  84+ 0A74              fcb_fat_size equ 32 ;размер дискриптора fcb
  85+ 0A74
  86+ 0A74
  87+ 0A74
  88+ 0A74              ; Returns:
  89+ 0A74              ;  A - current drive
  90+ 0A74              ; getDefaultDrive: ;нигде не используется
  91+ 0A74                  ; ld a, 0 : esxCall ESX_GETSETDRV
  92+ 0A74                  ; ret
  93+ 0A74
  94+ 0A74
  95+ 0A74
  96+ 0A74              ; Opens file on default drive
  97+ 0A74              ; B - File mode
  98+ 0A74              ; HL - File name
  99+ 0A74              ; Returns:
 100+ 0A74              ;  A - file stream id
 101+ 0A74              ; DE, BC - File size
 102+ 0A74              ; IX - fcb
 103+ 0A74              ; fopen:
 104+ 0A74                  ; ; push bc : push hl
 105+ 0A74                  ; ; call getDefaultDrive
 106+ 0A74                  ; ; pop ix : pop bc
 107+ 0A74                  ; ; esxCall ESX_FOPEN
 108+ 0A74                  ; ; ret
 109+ 0A74              	; ld a,b
 110+ 0A74              	; cp FMODE_READ ;если режим открытие файла
 111+ 0A74              	; jr z,fopen_r
 112+ 0A74              	; cp FMODE_CREATE
 113+ 0A74              	; jr z,fopen_c ;если режим создание файла
 114+ 0A74              	; jp file_error ;иначе выход
 115+ 0A74
 116+ 0A74
 117+ 0A74              fopen_r	;открытие существующего файла на чтение
 118+ 0A74
 119+ 0A74 CD 9A 0A     	call fopen_prep
 120+ 0A77 DA 9B 0B     	jp 	c,file_error
 121+ 0A7A
 122+ 0A7A 32 16 0D     	ld (file_fat_id_cur),a
 123+ 0A7D              	R8FAT r8f07_FileOpen ;открыть
 123+ 0A7D 0E 07       >	ld	c,r8f07_FileOpen
 123+ 0A7F CF          >	rst	#08
 123+ 0A80 91          >	db	#91
 124+ 0A81 DA 9B 0B     	jp 	c,file_error
 125+ 0A84
 126+ 0A84
 127+ 0A84 C3 A7 0A     	jp fopen_ex
 128+ 0A87
 129+ 0A87
 130+ 0A87              fopen_c	;создание нового файла
 131+ 0A87
 132+ 0A87 CD 9A 0A     	call fopen_prep
 133+ 0A8A DA 9B 0B     	jp 	c,file_error
 134+ 0A8D
 135+ 0A8D
 136+ 0A8D 32 16 0D     	ld (file_fat_id_cur),a
 137+ 0A90              	R8FAT	r8f0E_CreateFileLFN	;создание файла
 137+ 0A90 0E 0E       >	ld	c,r8f0E_CreateFileLFN
 137+ 0A92 CF          >	rst	#08
 137+ 0A93 91          >	db	#91
 138+ 0A94 DA 9B 0B     	jp 	c,file_error
 139+ 0A97
 140+ 0A97 C3 A7 0A     	jp fopen_ex
 141+ 0A9A
 142+ 0A9A
 143+ 0A9A              fopen_prep ;проверка перед открытием файла
 144+ 0A9A 3A B5 0C     	ld a,(fs_fat_init_flag)
 145+ 0A9D B7           	or a
 146+ 0A9E 37           	scf
 147+ 0A9F C8           	ret z
 148+ 0AA0
 149+ 0AA0 E5           	push hl
 150+ 0AA1 CD DC 0C     	call find_empty_fcb_fat ;какой fcb свободен?
 151+ 0AA4 EB           	ex de,hl ;fcb in de
 152+ 0AA5 E1           	pop hl
 153+ 0AA6 C9           	ret ;выйти с флагом
 154+ 0AA7
 155+ 0AA7
 156+ 0AA7              fopen_ex
 157+ 0AA7              	;успешно создали/открыли
 158+ 0AA7 D5           	push de
 159+ 0AA8 DD E1        	pop ix ;вернуть fcb
 160+ 0AAA 21 D0 0D     	ld hl,fcb_fat_table
 161+ 0AAD 3A 16 0D     	ld a,(file_fat_id_cur)
 162+ 0AB0 4F           	ld c,a
 163+ 0AB1 06 00        	ld b,0
 164+ 0AB3 09           	add hl,bc
 165+ 0AB4 3A 13 27     	ld a,(proc_id_cur)
 166+ 0AB7 77           	ld (hl),a ;флаг что файл открыт (id текущего процесса)
 167+ 0AB8
 168+ 0AB8              	;вернуть размер файла
 169+ 0AB8 DD 4E 14     	ld	c,(ix+#14) ;младшие байты длины
 170+ 0ABB DD 46 15     	ld	b,(ix+#15)
 171+ 0ABE
 172+ 0ABE DD 5E 16     	ld	e,(ix+#16) ;старшие байты длины
 173+ 0AC1 DD 56 17     	ld  d,(ix+#17)
 174+ 0AC4
 175+ 0AC4 3A 16 0D     	ld a,(file_fat_id_cur) ;вернуть id
 176+ 0AC7 B7           	or a
 177+ 0AC8 C9           	ret
 178+ 0AC9
 179+ 0AC9
 180+ 0AC9
 181+ 0AC9
 182+ 0AC9              init_fs_fat	;инициализация файловой системы
 183+ 0AC9              	; ld a,(fs_fat_init_flag) ;если в первый раз
 184+ 0AC9              	; or a
 185+ 0AC9              	; jr nz,init_fs_fat2
 186+ 0AC9 AF           	xor a
 187+ 0ACA 32 B5 0C     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 188+ 0ACD 3E 04        	ld a,4 ;номер дисковода по умолчанию E
 189+ 0ACF 32 58 0C     	ld (fs_drive_number_cur),a
 190+ 0AD2 CD 68 0C     	call GetNumPart ;узнаем какая буква последняя, сколько разделов FAT
 191+ 0AD5 30 0B        	jr nc,init_fs_fat_prn2
 192+ 0AD7 B7           	or a
 193+ 0AD8 20 08        	jr nz,init_fs_fat_prn2
 194+ 0ADA 21 38 0D     	ld hl,msg_fat_not_found
 195+ 0ADD CD A3 07     	call drvgmx.printZ
 196+ 0AE0 37           	scf ;ошибка
 197+ 0AE1 C9           	ret
 198+ 0AE2
 199+ 0AE2
 200+ 0AE2              init_fs_fat_prn2
 201+ 0AE2              	;печать списка разделов
 202+ 0AE2 21 18 0D     	ld hl,msg_fat_found
 203+ 0AE5 CD A3 07     	call drvgmx.printZ
 204+ 0AE8 21 59 0C     	ld hl,typeDrive
 205+ 0AEB 3A 66 0C     	ld a,(numDrives)
 206+ 0AEE 47           	ld b,a ;цикл по количеству разделов
 207+ 0AEF 0E 45        	ld c,"E" ;первая буква диска FAT
 208+ 0AF1              init_fs_fat_prn1
 209+ 0AF1 C5           	push bc
 210+ 0AF2 E5           	push hl
 211+ 0AF3 79           	ld a,c ;имя диска
 212+ 0AF4 CD AE 07     	call drvgmx.putC
 213+ 0AF7 3E 3A        	ld a,":" ;
 214+ 0AF9 CD AE 07     	call drvgmx.putC
 215+ 0AFC              	;тип S или H
 216+ 0AFC 3E 48        	ld a,"H"
 217+ 0AFE E1           	pop hl
 218+ 0AFF E5           	push hl
 219+ 0B00 CB 5E        	bit 3,(hl) ;SD?
 220+ 0B02 28 02        	jr z,init_fs_fat_prn3
 221+ 0B04 3E 53        	ld a,"S"
 222+ 0B06              init_fs_fat_prn3
 223+ 0B06 CD AE 07     	call drvgmx.putC ;первая буква
 224+ 0B09 3E 44        	ld a,"D"
 225+ 0B0B CD AE 07     	call drvgmx.putC ;вторая буква
 226+ 0B0E              	;номер диска
 227+ 0B0E E1           	pop hl
 228+ 0B0F E5           	push hl
 229+ 0B10 7E           	ld a,(hl)
 230+ 0B11 E6 04        	and %00000100
 231+ 0B13 0F           	rrca
 232+ 0B14 0F           	rrca
 233+ 0B15 C6 30        	add "0"
 234+ 0B17 CD AE 07     	call drvgmx.putC ;номер диска
 235+ 0B1A              	;номер раздела
 236+ 0B1A 3E 2C        	ld a,","
 237+ 0B1C CD AE 07     	call drvgmx.putC ;разделитель
 238+ 0B1F E1           	pop hl
 239+ 0B20 E5           	push hl
 240+ 0B21 7E           	ld a,(hl)
 241+ 0B22 E6 03        	and %00000011
 242+ 0B24 C6 30        	add "0"
 243+ 0B26 CD AE 07     	call drvgmx.putC ;номер раздела
 244+ 0B29 3E 0D        	ld a,13 ;новая строка
 245+ 0B2B CD AE 07     	call drvgmx.putC
 246+ 0B2E E1           	pop hl
 247+ 0B2F 23           	inc hl
 248+ 0B30 C1           	pop bc
 249+ 0B31 0C           	inc c
 250+ 0B32 10 BD        	djnz init_fs_fat_prn1
 251+ 0B34
 252+ 0B34
 253+ 0B34              	;поиск системы и выбор диска
 254+ 0B34 3A 66 0C     	ld a,(numDrives)
 255+ 0B37 DD 6F        	ld ixl,a ;цикл по количеству разделов
 256+ 0B39 3A 58 0C     	ld a,(fs_drive_number_cur)
 257+ 0B3C              init_fs_fat_find_os_cl
 258+ 0B3C 01 55 0C     	ld bc,typeDrive-4
 259+ 0B3F 6F           	ld l,a
 260+ 0B40 26 00        	ld h,0
 261+ 0B42 09           	add hl,bc
 262+ 0B43 7E           	ld a,(hl) ;получили код раздела из списка
 263+ 0B44
 264+ 0B44 CD 7B 0B     	call init_fs_fat_warm ;выбрать раздел
 265+ 0B47 D8           	ret c
 266+ 0B48
 267+ 0B48              	;поиск пути в разделе
 268+ 0B48 21 B6 0C     	ld	hl,OS_PathFAT		;путь к каталогу системы
 269+ 0B4B 11 BB 0C     	ld	de,fcb_OS_PathFAT
 270+ 0B4E AF           	xor	a
 271+ 0B4F 3D           	dec	a ;установить текущим
 272+ 0B50              	R8FAT	r8f04_FindPath
 272+ 0B50 0E 04       >	ld	c,r8f04_FindPath
 272+ 0B52 CF          >	rst	#08
 272+ 0B53 91          >	db	#91
 273+ 0B54 30 10        	jr nc,init_fs_fat_find_os_ok
 274+ 0B56
 275+ 0B56 3A 58 0C     	ld a,(fs_drive_number_cur)
 276+ 0B59 3C           	inc a
 277+ 0B5A 32 58 0C     	ld (fs_drive_number_cur),a
 278+ 0B5D DD 2D        	dec ixl
 279+ 0B5F 20 DB        	jr nz,init_fs_fat_find_os_cl
 280+ 0B61
 281+ 0B61
 282+ 0B61              	;не нашли ОС
 283+ 0B61 CD AB 0B         call   file_error_print_dir_not_found ;если не нашли, файл будет в корне
 284+ 0B64 37           	scf
 285+ 0B65 C9           	ret
 286+ 0B66              init_fs_fat_find_os_ok
 287+ 0B66              	;нашли раздел с ОС
 288+ 0B66 21 25 0D     	ld hl,msg_fat_found_os
 289+ 0B69 CD A3 07     	call drvgmx.printZ
 290+ 0B6C 3A 58 0C     	ld a,(fs_drive_number_cur)
 291+ 0B6F C6 41        	add a,"A"
 292+ 0B71 CD AE 07     	call drvgmx.putC
 293+ 0B74 3E 0D        	ld a,13
 294+ 0B76 CD AE 07     	call drvgmx.putC
 295+ 0B79 B7           	or a
 296+ 0B7A C9           	ret
 297+ 0B7B
 298+ 0B7B
 299+ 0B7B              init_fs_fat_warm
 300+ 0B7B              ;переинициализация FAT раздела, когда разделы-диски уже найдены
 301+ 0B7B              ;вх: a - код раздела
 302+ 0B7B 32 17 0D     	ld (fs_fat_part_code_cur),a ;запомнить текущий раздел
 303+ 0B7E AF           	xor a
 304+ 0B7F 32 B5 0C     	ld (fs_fat_init_flag),a ;сбросить флаг инициализации
 305+ 0B82 3A 17 0D     	ld a,(fs_fat_part_code_cur)
 306+ 0B85
 307+ 0B85              	; R8FAT	r8f00_DeinitFAT
 308+ 0B85              	; jp 		c,file_error
 309+ 0B85
 310+ 0B85
 311+ 0B85              	R8FAT	r8f01_InitFAT ;инициализация
 311+ 0B85 0E 01       >	ld	c,r8f01_InitFAT
 311+ 0B87 CF          >	rst	#08
 311+ 0B88 91          >	db	#91
 312+ 0B89 D2 94 0B         jp      nc,init_fs_fat3
 313+ 0B8C 21 48 0D     	ld hl,msg_fat_init_error
 314+ 0B8F CD A3 07     	call drvgmx.printZ
 315+ 0B92 37           	scf
 316+ 0B93 C9           	ret
 317+ 0B94
 318+ 0B94              init_fs_fat3
 319+ 0B94
 320+ 0B94
 321+ 0B94              ;получить текущий путь
 322+ 0B94              	; ld	hl,#4000		;адрес буфера для размещения текущего пути (256 байт)
 323+ 0B94              	; R8FAT	r8f13_GetPath ;получить путь
 324+ 0B94
 325+ 0B94              ;init_fs_fat_ex ;выход
 326+ 0B94 3E 01        	ld a,1
 327+ 0B96 32 B5 0C     	ld (fs_fat_init_flag),a
 328+ 0B99 B7           	or a
 329+ 0B9A C9           	ret
 330+ 0B9B
 331+ 0B9B
 332+ 0B9B
 333+ 0B9B
 334+ 0B9B
 335+ 0B9B
 336+ 0B9B              file_error ;выход с ошибкой
 337+ 0B9B 11 00 00     	ld de,0
 338+ 0B9E 01 00 00     	ld bc,0 ;длина 0
 339+ 0BA1 37           	scf ;ошибка
 340+ 0BA2 C9           	ret
 341+ 0BA3
 342+ 0BA3              file_error_general_print ;выход с общей ошибкой и сообщением
 343+ 0BA3 21 59 0D     	ld hl,msg_file_error_general
 344+ 0BA6 CD A3 07     	call drvgmx.printZ
 345+ 0BA9 37           	scf ;ошибка
 346+ 0BAA C9           	ret
 347+ 0BAB
 348+ 0BAB              file_error_print_dir_not_found ;выход с ошибкой и сообщением
 349+ 0BAB 21 AA 0D     	ld hl,msg_dir_not_found
 350+ 0BAE CD A3 07     	call drvgmx.printZ
 351+ 0BB1 37           	scf ;ошибка
 352+ 0BB2 C9           	ret
 353+ 0BB3
 354+ 0BB3              file_error_print_file_too_big ;выход с ошибкой и сообщением
 355+ 0BB3 21 66 0D     	ld hl,msg_file_too_big
 356+ 0BB6 CD A3 07     	call drvgmx.printZ
 357+ 0BB9 37           	scf ;ошибка
 358+ 0BBA C9           	ret
 359+ 0BBB
 360+ 0BBB              file_error_print_file_not_found ;выход с ошибкой и сообщением
 361+ 0BBB 21 75 0D     	ld hl,msg_file_not_found
 362+ 0BBE CD A3 07     	call drvgmx.printZ
 363+ 0BC1 37           	scf ;ошибка
 364+ 0BC2 C9           	ret
 365+ 0BC3
 366+ 0BC3              file_error_print_file_open_error ;выход с ошибкой и сообщением
 367+ 0BC3 21 86 0D     	ld hl,msg_file_open_error
 368+ 0BC6 CD A3 07     	call drvgmx.printZ
 369+ 0BC9 37           	scf ;ошибка
 370+ 0BCA C9           	ret
 371+ 0BCB
 372+ 0BCB              file_error_print_file_read_error ;выход с ошибкой и сообщением
 373+ 0BCB 21 98 0D     	ld hl,msg_file_read_error
 374+ 0BCE CD A3 07     	call drvgmx.printZ
 375+ 0BD1 37           	scf ;ошибка
 376+ 0BD2 C9           	ret
 377+ 0BD3
 378+ 0BD3
 379+ 0BD3
 380+ 0BD3
 381+ 0BD3              ; A - file stream id
 382+ 0BD3              fclose:
 383+ 0BD3                  ;esxCall ESX_FCLOSE
 384+ 0BD3              	; push af
 385+ 0BD3              ; WAITKEY2	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY2
 386+ 0BD3              	; pop af
 387+ 0BD3              	; cp 2 ;если обычный файл
 388+ 0BD3              	; jp nz,fclose_scl
 389+ 0BD3
 390+ 0BD3              close_fcb_fat ;закрытие fcb файла по номеру
 391+ 0BD3              ;вх: a - id файла
 392+ 0BD3              	;выход hl - fcb;
 393+ 0BD3 21 E8 0D     	ld hl,fcb_fat
 394+ 0BD6 B7           	or a
 395+ 0BD7 28 07        	jr z,close_fcb_fat_ex
 396+ 0BD9 47           	ld b,a
 397+ 0BDA 11 20 00     	ld de,fcb_fat_size
 398+ 0BDD              close_fcb_fat_cl
 399+ 0BDD              	;вычислить адрес fcb
 400+ 0BDD 19           	add hl,de
 401+ 0BDE 10 FD        	djnz close_fcb_fat_cl
 402+ 0BE0              close_fcb_fat_ex
 403+ 0BE0 E5           	push hl
 404+ 0BE1 54           	ld d,h ;почистить fcb
 405+ 0BE2 5D           	ld e,l
 406+ 0BE3 13           	inc de
 407+ 0BE4 01 1F 00     	ld bc,fcb_fat_size-1
 408+ 0BE7 36 00        	ld (hl),0
 409+ 0BE9 ED B0        	ldir
 410+ 0BEB 21 D0 0D     	ld hl,fcb_fat_table
 411+ 0BEE 4F           	ld c,a
 412+ 0BEF 06 00        	ld b,0
 413+ 0BF1 09           	add hl,bc
 414+ 0BF2 36 00        	ld (hl),0 ;и флаг открытия fcb_fat_table
 415+ 0BF4 E1           	pop hl
 416+ 0BF5 C9           	ret
 417+ 0BF6
 418+ 0BF6
 419+ 0BF6
 420+ 0BF6
 421+ 0BF6              ; A - file stream id
 422+ 0BF6              ; DE - length
 423+ 0BF6              ; HL - buffer
 424+ 0BF6              ; Returns
 425+ 0BF6              ;  BC - length(how much was actually read)
 426+ 0BF6              fread: ;(id=1)
 427+ 0BF6                  ; push hl : pop ix
 428+ 0BF6                  ; esxCall ESX_FREAD
 429+ 0BF6
 430+ 0BF6 ED 53 C0 0D  	ld (file_size_tmp),de
 431+ 0BFA
 432+ 0BFA CD 2E 0C     	call file_check_act ;проверка
 433+ 0BFD DA 9B 0B     	jp c,file_error
 434+ 0C00
 435+ 0C00 ED 4B C0 0D  	ld bc,(file_size_tmp) ;размер
 436+ 0C04 79           	ld a,c ;ba - количество байт для чтения
 437+ 0C05
 438+ 0C05              	R8FAT r8f08_FileRead	;читать файл
 438+ 0C05 0E 08       >	ld	c,r8f08_FileRead
 438+ 0C07 CF          >	rst	#08
 438+ 0C08 91          >	db	#91
 439+ 0C09 DA 9B 0B     	jp c,file_error
 440+ 0C0C
 441+ 0C0C ED 4B C0 0D  	ld bc,(file_size_tmp) ;размер
 442+ 0C10 B7           	or a
 443+ 0C11 C9           	ret
 444+ 0C12
 445+ 0C12
 446+ 0C12              ; A - file stream id
 447+ 0C12              ; BC - length
 448+ 0C12              ; HL - buffer
 449+ 0C12              ; Returns:
 450+ 0C12              ;   BC - actually written bytes
 451+ 0C12              fwrite: ;
 452+ 0C12                  ; push hl : pop ix
 453+ 0C12                  ; esxCall ESX_FWRITE
 454+ 0C12
 455+ 0C12               ;запись файла fat
 456+ 0C12 ED 53 C0 0D   	ld (file_size_tmp),de
 457+ 0C16
 458+ 0C16 CD 2E 0C     	call file_check_act ;проверка
 459+ 0C19 DA 9B 0B     	jp c,file_error
 460+ 0C1C
 461+ 0C1C ED 4B C0 0D  	ld bc,(file_size_tmp) ;размер
 462+ 0C20 79           	ld a,c ;ba - количество байт для записи
 463+ 0C21
 464+ 0C21              	R8FAT r8f09_FileWrite	;записать в файл
 464+ 0C21 0E 09       >	ld	c,r8f09_FileWrite
 464+ 0C23 CF          >	rst	#08
 464+ 0C24 91          >	db	#91
 465+ 0C25 DA 9B 0B     	jp c,file_error
 466+ 0C28
 467+ 0C28 ED 4B C0 0D  	ld bc,(file_size_tmp) ;размер
 468+ 0C2C B7           	or a
 469+ 0C2D C9           	ret
 470+ 0C2E              ;---------------------------------------
 471+ 0C2E
 472+ 0C2E              file_check_act
 473+ 0C2E              ;проверка файла на актуальность
 474+ 0C2E              ;вых: A - id, DE - fcb
 475+ 0C2E 32 16 0D     	ld (file_fat_id_cur),a ;сохранить id
 476+ 0C31
 477+ 0C31 3A B5 0C     	ld a,(fs_fat_init_flag)
 478+ 0C34 B7           	or a
 479+ 0C35 37           	scf
 480+ 0C36 C8           	ret z ;выход если не инициализирована ФС
 481+ 0C37
 482+ 0C37 E5           	push hl
 483+ 0C38 C5           	push bc
 484+ 0C39 3A 16 0D     	ld a,(file_fat_id_cur)
 485+ 0C3C CD FE 0C     	call find_fcb_fat ;найти fcb
 486+ 0C3F EB           	ex de,hl ;fcb в de
 487+ 0C40 D5           	push de
 488+ 0C41 DD E1        	pop ix ;fcb
 489+ 0C43 C1           	pop bc
 490+ 0C44 21 13 27     	ld hl,proc_id_cur ;сравнить с кодом текущего процесса, чтобы имел доступ только к своему файлу
 491+ 0C47 BE           	cp (hl)
 492+ 0C48 E1           	pop hl
 493+ 0C49 37           	scf
 494+ 0C4A C0           	ret nz
 495+ 0C4B
 496+ 0C4B B7           	or a
 497+ 0C4C 37           	scf
 498+ 0C4D C8           	ret z ;выход если файл не открыт
 499+ 0C4E
 500+ 0C4E
 501+ 0C4E
 502+ 0C4E 3A 17 0D     	ld a,(fs_fat_part_code_cur) ;сравнить какой раздел у файла и какой активный
 503+ 0C51 DD BE 1F     	cp (ix+#1f)
 504+ 0C54 C4 7B 0B     	call nz,init_fs_fat_warm ;переинициировать
 505+ 0C57 C9           	ret
 506+ 0C58
 507+ 0C58
 508+ 0C58
 509+ 0C58
 510+ 0C58              ; A - file stream id
 511+ 0C58              ; fsync:
 512+ 0C58              ;     esxCall ESX_FSYNC
 513+ 0C58                  ; ret
 514+ 0C58
 515+ 0C58
 516+ 0C58              ; ; HL - name (name.ext)
 517+ 0C58              ; ; Returns:
 518+ 0C58              ; ; HL - name (name    e)
 519+ 0C58              ; format_name ;подгоняет имя файла под стандарт trdos (8+1)
 520+ 0C58
 521+ 0C58              	; ;сначала попробуем убрать из пути подпапку, если она есть
 522+ 0C58              	; ld (temp_hl),hl ;сохраним адрес исходного имени
 523+ 0C58              	; ld b,#00 ;не больше 255 символов
 524+ 0C58              ; format_name5
 525+ 0C58              	; ld a,(hl)
 526+ 0C58              	; cp "/" ;если есть подпапка
 527+ 0C58              	; jr z,format_name_path_yep
 528+ 0C58              	; ld a,(hl)
 529+ 0C58              	; cp "." ;если ещё не дошли до расширения
 530+ 0C58              	; jr nz,format_name6
 531+ 0C58              	; ld hl,(temp_hl) ;если дошли до расширения, то путей нет, вернёмся на начало имени
 532+ 0C58              	; jr format_name_7 ;на выход
 533+ 0C58              ; format_name6
 534+ 0C58              	; inc hl
 535+ 0C58              	; djnz format_name5
 536+ 0C58
 537+ 0C58              ; format_name_path_yep ;нашли
 538+ 0C58              	; inc hl ;пропустим знак "/"
 539+ 0C58
 540+ 0C58              ; format_name_7
 541+ 0C58
 542+ 0C58              	; push hl ;очистим место для нового имени
 543+ 0C58              	; ld hl,f_name
 544+ 0C58              	; ld de,f_name+1
 545+ 0C58              	; ld (hl)," "
 546+ 0C58              	; ld bc,8+1
 547+ 0C58              	; ldir
 548+ 0C58              	; ld (hl),0
 549+ 0C58              	; ld bc,16-8-1-1
 550+ 0C58              	; ldir
 551+ 0C58              	; pop hl
 552+ 0C58
 553+ 0C58              	; ld bc,#09ff ;длина имени 9 символов
 554+ 0C58              	; ld de,f_name ;куда
 555+ 0C58              ; format_name2
 556+ 0C58              	; ld a,(hl)
 557+ 0C58              	; cp "."
 558+ 0C58              	; jr nz,format_name1
 559+ 0C58              	; ld de,f_name+8
 560+ 0C58              	; inc hl
 561+ 0C58              	; ldi ; и в конце расширение 3 буквы
 562+ 0C58              	; ldi
 563+ 0C58              	; ldi
 564+ 0C58              	; ;ex de,hl ;сохраним адрес исходного расширения
 565+ 0C58              	; jr format_name_e
 566+ 0C58              ; format_name1
 567+ 0C58              	; ldi
 568+ 0C58              	; djnz format_name2
 569+ 0C58
 570+ 0C58              	; ;если имя длинное, пропустим лишнее до расширения
 571+ 0C58              	; ld b,#00 ;не больше 255 символов
 572+ 0C58              ; format_name3
 573+ 0C58              	; ld a,(hl)
 574+ 0C58              	; cp "."
 575+ 0C58              	; jr nz,format_name4
 576+ 0C58              	; ld de,f_name+8
 577+ 0C58              	; inc hl
 578+ 0C58              	; ldi ; и в конце расширение 3 буквы
 579+ 0C58              	; ldi
 580+ 0C58              	; ldi
 581+ 0C58              	; ;ex de,hl ;сохраним адрес исходного расширения
 582+ 0C58              	; jr format_name_e
 583+ 0C58              ; format_name4
 584+ 0C58              	; inc hl
 585+ 0C58              	; djnz format_name3
 586+ 0C58
 587+ 0C58              ; format_name_e ;выход
 588+ 0C58              	; ld hl,f_name ;вернём результат
 589+ 0C58              	; ret
 590+ 0C58
 591+ 0C58              ; DE - trk/sec
 592+ 0C58              ; B - sectors step
 593+ 0C58              ; Returns:
 594+ 0C58              ; DE - trk/sec
 595+ 0C58              ; calc_next_pos		;вперёд на N секторов
 596+ 0C58              			; ;ld b,4
 597+ 0C58              			; ;ld  de,(#5ceb)
 598+ 0C58              ; calc_next_pos2
 599+ 0C58              			; inc e
 600+ 0C58              			; ld a,e
 601+ 0C58              			; cp 16
 602+ 0C58              			; jr c,calc_next_pos1
 603+ 0C58              			; inc d
 604+ 0C58              			; ld e,0
 605+ 0C58              ; calc_next_pos1
 606+ 0C58              			; ;ld (#5ceb),de
 607+ 0C58              			; djnz calc_next_pos2
 608+ 0C58              			; ret
 609+ 0C58
 610+ 0C58
 611+ 0C58              ;testt db "123.trd"
 612+ 0C58              ; write_ima db "Select disk "
 613+ 0C58              ; write_ima_d db "A: (E-" ;текущая буква
 614+ 0C58              ; write_ima_e	db "D)> " ;последняя буква
 615+ 0C58              		; db 13,10,0
 616+ 0C58              ;prev_drive db 0 ;предыдущий номер дисковода
 617+ 0C58 00           fs_drive_number_cur db 0 ;текущий диск/раздел
 618+ 0C59
 619+ 0C59              ; ; trdExt1 db ".trd", 0
 620+ 0C59              ; ; trdExt2 db ".TRD", 0
 621+ 0C59
 622+ 0C59              ; ; sclExt1 db ".scl", 0
 623+ 0C59              ; ; sclExt2 db ".SCL", 0
 624+ 0C59
 625+ 0C59              ; f_name ds 16 ;имя файла
 626+ 0C59              ; f_r_cur_trk dw 	 0 ;текущие сектор-дорожка файла на чтение
 627+ 0C59              ; f_r_len_sec db 0 ;длина файла на чтение в секторах
 628+ 0C59              ; f_r_len dw 0;длина файла в байтах
 629+ 0C59              ; f_r_flag db 0 ;флаг что открыт файл на чтение
 630+ 0C59
 631+ 0C59              ; f_w_cur_trk dw 	 0 ;текущие сектор-дорожка файла на запись
 632+ 0C59              ; f_w_len_sec db 0 ;длина файла на запись в секторах
 633+ 0C59              ; f_w_flag db 0 ;флаг что открыт файл на запись
 634+ 0C59              ; f_w_len ds 4 ;длина записанных данных
 635+ 0C59              ; write_end_flag db 0 ;флаг что нужно записать остаток
 636+ 0C59
 637+ 0C59              ; temp_bc dw 0 ;хранение регистра
 638+ 0C59              ; temp_hl dw 0 ;хранение регистра
 639+ 0C59              ; temp_hl2 dw 0 ;хранение регистра
 640+ 0C59
 641+ 0C59              ; sec_shift db 0 ;указатель на каком байте остановлена запись
 642+ 0C59              ; sec_shift2 db 0 ;указатель на каком байте остановлена запись (остаток)
 643+ 0C59              ; sec_part db 0 ;сколько секторов во второй порции для записи
 644+ 0C59              ; sec_shift_flag db 0 ;флаг что буфер сектора не заполнен
 645+ 0C59
 646+ 0C59              ; ;секция scl
 647+ 0C59              ; scl_sign db "SINCLAIR" ;метка
 648+ 0C59              ; scl_que db 0 ;флаг запроса порции данных
 649+ 0C59              ; scl_err db "SCL image error!",0
 650+ 0C59              ; scl_parse_ret_adr dw 0; адрес возврата в цикл
 651+ 0C59              ; scl_cat_cycl db 0 ;переменная цикла
 652+ 0C59              ; scl_files db 0 ;всего файлов
 653+ 0C59              ; scl_temp_hl dw 0;;хранение регистра
 654+ 0C59              ; scl_temp_hl2 dw 0;
 655+ 0C59              ; scl_temp_de dw 0;
 656+ 0C59              ; scl_temp_bc dw 0;
 657+ 0C59              ; cat_cur_adr dw 0;
 658+ 0C59              ; ;scl end
 659+ 0C59
 660+ 0C59              ; ;секция сохранения любого файла
 661+ 0C59              ; file_err db "Not enough space!",0
 662+ 0C59              ; sec_cat db 0 ;сектор каталога
 663+ 0C59              ; file_num db "0" ;номер части для больших файлов
 664+ 0C59
 665+ 0C59              	; ;по адресу #4000 шрифт
 666+ 0C59              ; cat_buf equ #4800 ;буфер для кататога диска 9*256
 667+ 0C59              ; sec_buf equ cat_buf + 9*256 ;буфер сектора для записи 256
 668+ 0C59              ; scl_buf equ sec_buf + 512 ;промежуточный буфер 256
 669+ 0C59              ; scl_buf2 equ scl_buf + 512 ;промежуточный буфер 256
 670+ 0C59              ; ;общая ошибка с файлами
 671+ 0C59              ; com_file_err db "File error!",0
 672+ 0C59              ;com_file_err_flag db 0 ;общая ошибка
 673+ 0C59
 674+ 0C59
 675+ 0C59
 676+ 0C59
 677+ 0C59              ;Раздел SMUC и SD ------------------------------------
 678+ 0C59
 679+ 0C59
 680+ 0C59              ;список доступных разделов на винчестерах
 681+ 0C59              ;7,=0/1 тип раздела MFS/FAT
 682+ 0C59              ;6,=1 раздел есть
 683+ 0C59              ;3,=0/1 Hdd/SD card
 684+ 0C59              ;2,=0/1 для HDD master/slave
 685+ 0C59              ;0..1,=?? номер раздела
 686+ 0C59              ;
 687+ 0C59 00 00 00...  typeDrive	ds 3*4+1
 688+ 0C66              ;typeDriveFAT	ds 3*4+1 ;список всех разделов FAT
 689+ 0C66 00           numDrives db 0 ;количество устройств
 690+ 0C67              ;numDrivesFAT db 0 ;количество устройств FAT
 691+ 0C67 00           next_lett db 0 ;следующая свободная буква диска
 692+ 0C68
 693+ 0C68              ;подсчет количества доступных разделов на всех устройствах
 694+ 0C68              ;вых: hl,a - количество устройств
 695+ 0C68              ;     typeDrives - сформированная таблица
 696+ 0C68              ;     cy=1 не обнаружено ни одного устройства
 697+ 0C68              ;
 698+ 0C68              GetNumPart
 699+ 0C68              ;
 700+ 0C68 D5           	push	de
 701+ 0C69 C5           	push	bc
 702+ 0C6A 21 59 0C     	ld	hl,typeDrive
 703+ 0C6D E5           	push	hl
 704+ 0C6E AF           	xor	a
 705+ 0C6F CD 89 0C     	call	proc_01			;HDD master
 706+ 0C72 3E 01        	ld	a,#01
 707+ 0C74 CD 89 0C     	call	proc_01			;HDD slave
 708+ 0C77 3E 02        	ld	a,#02
 709+ 0C79 CD 89 0C     	call	proc_01			;SD card
 710+ 0C7C D1           	pop	de
 711+ 0C7D B7           	or	a
 712+ 0C7E ED 52        	sbc	hl,de			;количество разделов на HDD
 713+ 0C80              	IFDEF	useTRD
 714+ 0C80 ~            	 ld	a,l
 715+ 0C80 ~            	 add	a,#04
 716+ 0C80 ~            	 ld	l,a
 717+ 0C80              	ELSE
 718+ 0C80 7D           	 ld	a,l
 719+ 0C81              	ENDIF
 720+ 0C81 C1           	pop	bc
 721+ 0C82 D1           	pop	de
 722+ 0C83 32 66 0C     	ld	(numDrives),a
 723+ 0C86 FE 01        	cp	1
 724+ 0C88 C9           	ret
 725+ 0C89
 726+ 0C89              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 727+ 0C89              ;формирование таблицы с доступными разделами на винчестере
 728+ 0C89              ;вх:  a =#00 выбрать master
 729+ 0C89              ;       =#01 выбрать slave
 730+ 0C89              ;       =#02 выбрать SD card
 731+ 0C89              ;     hl - адрес в таблице разделов typeDrives
 732+ 0C89              ;вых: hl - новый адрес в таблице разделов typeDrives
 733+ 0C89              ;
 734+ 0C89 4F           proc_01	ld	c,a
 735+ 0C8A E5           	push	hl
 736+ 0C8B C5           	push	bc
 737+ 0C8C              	R8DOS	r8d2E_CngHDD
 737+ 0C8C 0E 2E       >	ld	c,r8d2E_CngHDD
 737+ 0C8E CF          >	rst	#08
 737+ 0C8F 81          >	db	#81
 738+ 0C90 38 04        	jr	c,goto001		;на текущем канале нет винчестера
 739+ 0C92              	R8DOS	r8d2D_FindPart
 739+ 0C92 0E 2D       >	ld	c,r8d2D_FindPart
 739+ 0C94 CF          >	rst	#08
 739+ 0C95 81          >	db	#81
 740+ 0C96 C1           goto001	pop	bc
 741+ 0C97 E1           	pop	hl
 742+ 0C98 D8           	ret	c			;на текущем винчестере нет разделов
 743+ 0C99 47           	ld	b,a
 744+ 0C9A 79           	ld	a,c
 745+ 0C9B 87           	add	a,a
 746+ 0C9C 87           	add	a,a
 747+ 0C9D 4F           	ld	c,a			;номер винчестера и первого раздела
 748+ 0C9E 78           	ld	a,b
 749+ 0C9F 06 04        	ld	b,#04
 750+ 0CA1 36 00        loop001	ld	(hl),#00
 751+ 0CA3 1F           	rra
 752+ 0CA4 30 0A        	jr	nc,goto002		;нет раздела
 753+ 0CA6              	IFDEF	useMFS
 754+ 0CA6 ~            	 ld	(hl),c
 755+ 0CA6 ~            	 set	6,(hl)			;=%01???hpp MFS
 756+ 0CA6 ~            	 rra
 757+ 0CA6 ~            	 jr	nc,goto003		;это MFS
 758+ 0CA6 ~            	 set	7,(hl)			;=%11???hpp это FAT
 759+ 0CA6              	ELSE
 760+ 0CA6 1F           	 rra
 761+ 0CA7 30 08        	 jr	nc,goto004		;это MFS
 762+ 0CA9 71           	 ld	(hl),c
 763+ 0CAA CB F6        	 set	6,(hl)			;раздел есть
 764+ 0CAC CB FE        	 set	7,(hl)			;=%11???hpp это FAT
 765+ 0CAE              	ENDIF
 766+ 0CAE 23           goto003	inc	hl
 767+ 0CAF 17           	rla
 768+ 0CB0 1F           goto002	rra
 769+ 0CB1 0C           goto004	inc	c
 770+ 0CB2 10 ED        	djnz	loop001
 771+ 0CB4 C9           	ret
 772+ 0CB5
 773+ 0CB5
 774+ 0CB5
 775+ 0CB5 00           fs_fat_init_flag: db 0 ;флаг инициализации
 776+ 0CB6              ;fcb_tmp ds fcb_fat_size ;буфер fcb временно
 777+ 0CB6 5C 4F 53 5A  OS_PathFAT db "\\OSZ",0 ;папка ОС
 777+ 0CBA 00
 778+ 0CBB 00 00 00...  fcb_OS_PathFAT ds fcb_fat_size	;буфер fcb
 779+ 0CDB 00           	nop
 780+ 0CDC              ;конец секции SMUC и SD ----------------------------
 781+ 0CDC
 782+ 0CDC
 783+ 0CDC              find_empty_fcb_fat ;поиск свободного fcb для файла
 784+ 0CDC              	;выход hl - fcb; a - file_id
 785+ 0CDC 21 D0 0D     	ld hl,fcb_fat_table
 786+ 0CDF 0E 00        	ld c,0 ;номер файла
 787+ 0CE1 06 08        	ld b,files_fat_max ;цикл
 788+ 0CE3              find_empty_fcb_fat_cl
 789+ 0CE3 7E           	ld a,(hl)
 790+ 0CE4 B7           	or a
 791+ 0CE5 28 06        	jr z,find_empty_fcb_fat_ex
 792+ 0CE7 23           	inc hl
 793+ 0CE8 0C           	inc c
 794+ 0CE9 10 F8        	djnz find_empty_fcb_fat_cl
 795+ 0CEB              	;не нашли свободного
 796+ 0CEB 37           	scf
 797+ 0CEC C9           	ret
 798+ 0CED              find_empty_fcb_fat_ex
 799+ 0CED              	;вычислить адрес fcb
 800+ 0CED 21 E8 0D     	ld hl,fcb_fat
 801+ 0CF0 0C           	inc c
 802+ 0CF1 0D           	dec c
 803+ 0CF2 28 07        	jr z,find_empty_fcb_fat_ex1
 804+ 0CF4 11 20 00     	ld de,fcb_fat_size
 805+ 0CF7 41           	ld b,c
 806+ 0CF8              find_empty_fcb_fat_cl2
 807+ 0CF8 19           	add hl,de
 808+ 0CF9 10 FD        	djnz find_empty_fcb_fat_cl2
 809+ 0CFB              find_empty_fcb_fat_ex1
 810+ 0CFB 79           	ld a,c ;file-id
 811+ 0CFC B7           	or a
 812+ 0CFD C9           	ret
 813+ 0CFE
 814+ 0CFE
 815+ 0CFE              find_fcb_fat ;поиск fcb файла по номеру
 816+ 0CFE              	;вх: a - id файла
 817+ 0CFE              	;вых: hl - fcb; a - значение из fcb_fat_table
 818+ 0CFE 21 E8 0D     	ld hl,fcb_fat
 819+ 0D01 B7           	or a
 820+ 0D02 28 07        	jr z,find_fcb_fat_ex
 821+ 0D04 47           	ld b,a
 822+ 0D05 11 20 00     	ld de,fcb_fat_size
 823+ 0D08              find_fcb_fat_cl
 824+ 0D08              	;вычислить адрес fcb
 825+ 0D08 19           	add hl,de
 826+ 0D09 10 FD        	djnz find_fcb_fat_cl
 827+ 0D0B              find_fcb_fat_ex
 828+ 0D0B E5           	push hl
 829+ 0D0C 21 D0 0D     	ld hl,fcb_fat_table
 830+ 0D0F 4F           	ld c,a
 831+ 0D10 06 00        	ld b,0
 832+ 0D12 09           	add hl,bc
 833+ 0D13 7E           	ld a,(hl) ;вернуть флаг
 834+ 0D14 E1           	pop hl
 835+ 0D15 C9           	ret
 836+ 0D16
 837+ 0D16
 838+ 0D16
 839+ 0D16
 840+ 0D16
 841+ 0D16 00           file_fat_id_cur db 0 ;текущий файл id
 842+ 0D17 00           fs_fat_part_code_cur db 0 ;текущий раздел
 843+ 0D18 46 6F 75 6E  msg_fat_found db "Found FAT:",13,10,0
 843+ 0D1C 64 20 46 41
 843+ 0D20 54 3A 0D 0A
 843+ 0D24 00
 844+ 0D25 46 6F 75 6E  msg_fat_found_os db "Found OS on disk: ",0
 844+ 0D29 64 20 4F 53
 844+ 0D2D 20 6F 6E 20
 844+ 0D31 64 69 73 6B
 844+ 0D35 3A 20 00
 845+ 0D38 46 41 54 20  msg_fat_not_found db "FAT not found",13,10,0
 845+ 0D3C 6E 6F 74 20
 845+ 0D40 66 6F 75 6E
 845+ 0D44 64 0D 0A 00
 846+ 0D48 46 41 54 20  msg_fat_init_error db "FAT init_error",13,10,0
 846+ 0D4C 69 6E 69 74
 846+ 0D50 5F 65 72 72
 846+ 0D54 6F 72 0D 0A
 846+ 0D58 00
 847+ 0D59 46 69 6C 65  msg_file_error_general db "File error",13,10,0
 847+ 0D5D 20 65 72 72
 847+ 0D61 6F 72 0D 0A
 847+ 0D65 00
 848+ 0D66 46 69 6C 65  msg_file_too_big db "File too_big",13,10,0
 848+ 0D6A 20 74 6F 6F
 848+ 0D6E 5F 62 69 67
 848+ 0D72 0D 0A 00
 849+ 0D75 46 69 6C 65  msg_file_not_found db "File not found",13,10,0
 849+ 0D79 20 6E 6F 74
 849+ 0D7D 20 66 6F 75
 849+ 0D81 6E 64 0D 0A
 849+ 0D85 00
 850+ 0D86 46 69 6C 65  msg_file_open_error db "File open error",13,10,0
 850+ 0D8A 20 6F 70 65
 850+ 0D8E 6E 20 65 72
 850+ 0D92 72 6F 72 0D
 850+ 0D96 0A 00
 851+ 0D98 46 69 6C 65  msg_file_read_error db "File read error",13,10,0
 851+ 0D9C 20 72 65 61
 851+ 0DA0 64 20 65 72
 851+ 0DA4 72 6F 72 0D
 851+ 0DA8 0A 00
 852+ 0DAA 44 69 72 65  msg_dir_not_found db "Directory not found",13,10,0
 852+ 0DAE 63 74 6F 72
 852+ 0DB2 79 20 6E 6F
 852+ 0DB6 74 20 66 6F
 852+ 0DBA 75 6E 64 0D
 852+ 0DBE 0A 00
 853+ 0DC0 00 00        file_size_tmp dw 0 ;временно
 854+ 0DC2
 855+ 0DC2 66 63 62 5F  	db "fcb_fat_table:"
 855+ 0DC6 66 61 74 5F
 855+ 0DCA 74 61 62 6C
 855+ 0DCE 65 3A
 856+ 0DD0 00 00 00...  fcb_fat_table ds files_fat_max ;флаги открытия файлов
 857+ 0DD8 00 00 00...  fcb_trd_table ds files_trd_max ;флаги открытия файлов
 858+ 0DE0 66 63 62 5F  	db "fcb_fat:"
 858+ 0DE4 66 61 74 3A
 859+ 0DE8 00 00 00...  fcb_fat ds fcb_fat_size*files_fat_max ;для файлов fat
 860+ 0EE8 00 00 00...  fcb_trd ds fcb_fat_size*files_trd_max ;для файлов trd
 861+ 0FE8
 862+ 0FE8
 863+ 0FE8
 864+ 0FE8                  ENDMODULE
# file closed: Drv/zsfat.asm
1370  0FE8              	include Drv/DrvKey.main.a80 ;драйвер клавиатуры
# file opened: Drv/DrvKey.main.a80
   1+ 0FE8              ;ࠩ  
   2+ 0FE8              ;Driver Keyboard v2.10
   3+ 0FE8              ;(c) 2002-2024 LW aka PLM
   4+ 0FE8              ;
   5+ 0FE8              ;Date Creating: 10.07.2002
   6+ 0FE8              ;Last   Update: 17.01.2024
   7+ 0FE8              ;Last  Edition: 17.01.2024
   8+ 0FE8              ;
   9+ 0FE8              ;:
  10+ 0FE8              ;DrvKey.main.a80	-  䠩
  11+ 0FE8              ;DrvKey.asm.a80		- 楤
  12+ 0FE8              ;DrvKey.var.a80		- ६
  13+ 0FE8              ;DrvKey.info		- ଠ  ࠩ
  14+ 0FE8              ;DrvKey.lua.a80		- LUA
  15+ 0FE8              ;
  16+ 0FE8              ;------------------------------------------------------------------------------
  17+ 0FE8              ; 樨
  18+ 0FE8              ;	DEVICE 	ZXSPECTRUM128
  19+ 0FE8              ;	INCLUDE "DrvKey.lua.a80"
  20+ 0FE8              ;	PAGE	#XX
  21+ 0FE8              	MODULE	DrvKey
  22+ 0FE8
  23+ 0FE8              ;------------------------------------------------------------------------------
  24+ 0FE8              ;⠭ ࠩ
  25+ 0FE8
  26+ 0FE8              ; ᥬ஢:
  27+ 0FE8              AdrDrvKeyboard	equ $ ;#XXXX
  28+ 0FE8
  29+ 0FE8              ;   
  30+ 0FE8              keyLeft		equ #08
  31+ 0FE8              keyRight	equ #09
  32+ 0FE8              keyUp		equ #0B
  33+ 0FE8              keyDown		equ #0A
  34+ 0FE8
  35+ 0FE8              ;࠭ /
  36+ 0FE8              keyPageDown	equ #05
  37+ 0FE8              keyPageUp	equ #04
  38+ 0FE8
  39+ 0FE8              ;/砫 ப, insert
  40+ 0FE8              keyHome		equ #01
  41+ 0FE8              keyEnd		equ #03
  42+ 0FE8              keyInsert	equ #02
  43+ 0FE8
  44+ 0FE8              ;⥬ 
  45+ 0FE8              keyBreak	equ #18
  46+ 0FE8              keyEdit		equ #07
  47+ 0FE8              keyCaps		equ #06
  48+ 0FE8              keyBackSpace	equ #0C
  49+ 0FE8              keyDelete	equ #0F
  50+ 0FE8              keyEnter	equ #0D
  51+ 0FE8
  52+ 0FE8              ;CapsShift/SymbolShift   樨
  53+ 0FE8              keyCS		equ #1C
  54+ 0FE8              keySS		equ #1D
  55+ 0FE8              keyCsEnter	equ #19
  56+ 0FE8              keySsSpace	equ #1A		;tab
  57+ 0FE8              keySsEnter	equ #1B
  58+ 0FE8              keyExtMode	equ #0E
  59+ 0FE8
  60+ 0FE8              ;  ० EXT mode (cs+ss+key)
  61+ 0FE8              keyWordLeft	equ #10
  62+ 0FE8              keyWordRight	equ #11
  63+ 0FE8              keyGrf		equ #12
  64+ 0FE8              keyDelEnd	equ #13
  65+ 0FE8              keyDelBegin	equ #16
  66+ 0FE8              keyCsSsSpace	equ #14
  67+ 0FE8              keyCsSsEnter	equ #15
  68+ 0FE8              ;free code: #00,#17,#1E,#1F
  69+ 0FE8
  70+ 0FE8              ; 譨 ⠡  ᪫ 
  71+ 0FE8              ;OutsideGrfTable		equ #XXXX ;#0000
  72+ 0FE8              ;OutsideRus_jcuken	equ #XXXX ;#0000
  73+ 0FE8              ;OutsideRus_qwerty	equ #XXXX ;#0000
  74+ 0FE8
  75+ 0FE8              ;------------------------------------------------------------------------------
  76+ 0FE8              ;᫮ ࠭樨
  77+ 0FE8
  78+ 0FE8              ; ᯮ짮 /  48k
  79+ 0FE8              	;DEFINE	Used_ROM ;
  80+ 0FE8              	DEFINE	UseEXTkeys	;ᯮ짮 権 cs+ss+key
  81+ 0FE8              	DEFINE	CommandMode	;ᯮ짮  ०
  82+ 0FE8              	IFDEF	Used_ROM
  83+ 0FE8 ~            	UNDEFINE UseEXTkeys
  84+ 0FE8              	ENDIF
  85+ 0FE8
  86+ 0FE8              ;祭 ᪫ 
  87+ 0FE8              	DEFINE	GrfMode		;ᯮ짮 ᪫ grf
  88+ 0FE8              	DEFINE	RusMode		;ᯮ짮 ᪫ rus
  89+ 0FE8
  90+ 0FE8              ;祭 ⠡ ᪫
  91+ 0FE8              	DEFINE	TblKeyGrf_ver1
  92+ 0FE8              	DEFINE	Rus_jcuken
  93+ 0FE8              	DEFINE	Rus_qwerty
  94+ 0FE8
  95+ 0FE8              ;祭 ⠡ EXT+key (command mode)
  96+ 0FE8              ;  ᯮ짮 ⮫쪮 
  97+ 0FE8              	IFDEF	UseEXTkeys
  98+ 0FE8              	DEFINE	TblEXTkey_Test	;⮢ ᪫
  99+ 0FE8              ;	DEFINE	TblEXTkey_Word	; ZX-Word
 100+ 0FE8              	ENDIF
 101+ 0FE8
 102+ 0FE8              ;  ᯮ ७ ⠡ ᪫ 
 103+ 0FE8              	DEFINE	InsideGrfTable
 104+ 0FE8              	DEFINE	InsideRusTable
 105+ 0FE8
 106+ 0FE8              ;祭 㭪樨 ࠩ
 107+ 0FE8              ;	DEFINE  NoFuncDrvKey	; 楤 맮 㭪権 ࠩ
 108+ 0FE8              	DEFINE	NoCtlDrvKey	; ஢ન  ⢮ 㭪樨
 109+ 0FE8              	DEFINE	DrvKey_02	;⠭/祭 䫠 ࠩ
 110+ 0FE8              	DEFINE	DrvKey_03	;⠭ ਮ প  ⮯
 111+ 0FE8              	DEFINE	DrvKey_04	;祭 ਮ প  ⮯
 112+ 0FE8
 113+ 0FE8              ;------------------------------------------------------------------------------
 114+ 0FE8
 115+ 0FE8              	ORG	AdrDrvKeyboard
 116+ 0FE8              Start	INCLUDE	"DrvKey.asm.a80"
# file opened: Drv/DrvKey.asm.a80
   1++0FE8              ;楤  Keyboard Driver
   2++0FE8              ;䠩 DrvKey.asm.a80
   3++0FE8              ;
   4++0FE8              ;DriverKeyboard		맮 ࠩ 
   5++0FE8              ;FunctDrvKeyboard	맮 㭪樨 ࠩ 
   6++0FE8              ;GetCodesPressKey	祭  ⮩ 
   7++0FE8              ;GetRepeatDelays	祭 ਮ প  ⮯
   8++0FE8              ;SetRepeatDelays	⠭ ਮ প  ⮯
   9++0FE8              ;SetFlagsDriver		⠭/祭 䫠 ࠩ
  10++0FE8              ;ScanKeyboardDelay	   ⮬ ६ থ
  11++0FE8              ;ScanKeyboard		   
  12++0FE8              ;ScanAllKeys		   
  13++0FE8              ;
  14++0FE8              ;------------------------------------------------------------------------------
  15++0FE8              ;------------------------------------------------------------------------------
  16++0FE8              ;맮 ࠩ 
  17++0FE8              ;: 6,(FlgScanKeys) =1 -     
  18++0FE8              ;     hl=FlgScanKeys
  19++0FE8              ;     d - ᪠ ⮩ 
  20++0FE8              ;     a,e -   ⮩   ⥪饩 ᪫ 
  21++0FE8              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  22++0FE8              ;     bc -  ।
  23++0FE8              ;
  24++0FE8 C3 20 10     @DriverKeyboard		jp	ScanKeyboardDelay
  25++0FEB
  26++0FEB              ;------------------------------------------------------------------------------
  27++0FEB              	IFNDEF	NoFuncDrvKey
  28++0FEB              ;맮 㭪樨 ࠩ 
  29++0FEB              ;:  c -  㭪樨 [#00..#04]
  30++0FEB              ;     hl,de,b,a - ࠬ 㭪樨
  31++0FEB              ;: ॣ ⠭  ⢥⢨  뢠 㭪樥
  32++0FEB              ;
  33++0FEB              @FunctDrvKeyboard
  34++0FEB              ;
  35++0FEB              	IFDEF	NoCtlDrvKey
  36++0FEB E5           	 push	hl
  37++0FEC F5           	 push	af
  38++0FED 78           	 ld	a,b
  39++0FEE 06 00        	 ld	b,#00
  40++0FF0 21 FD 0F     	 ld	hl,TableAdrFunct
  41++0FF3 09           	 add	hl,bc
  42++0FF4 09           	 add	hl,bc
  43++0FF5 47           	 ld	b,a
  44++0FF6 7E           	 ld	a,(hl)
  45++0FF7 23           	 inc	hl
  46++0FF8 66           	 ld	h,(hl)
  47++0FF9 6F           	 ld	l,a
  48++0FFA F1           	 pop	af
  49++0FFB E3           	 ex	(sp),hl
  50++0FFC C9           	 ret
  51++0FFD              	ELSE
  52++0FFD ~            	 push	hl
  53++0FFD ~            	 push	af
  54++0FFD ~            	 ld	a,c
  55++0FFD ~            	 cp	#05
  56++0FFD ~            	 jr	nc,goto017		;騩  㭪樨
  57++0FFD ~            	 ld	a,b
  58++0FFD ~            	 ld	hl,TableAdrFunct
  59++0FFD ~            	 ld	b,#00
  60++0FFD ~            	 add	hl,bc
  61++0FFD ~            	 add	hl,bc
  62++0FFD ~            	 ld	b,a
  63++0FFD ~            	 ld	a,(hl)
  64++0FFD ~            	 inc	hl
  65++0FFD ~            	 ld	h,(hl)
  66++0FFD ~            	 ld	l,a
  67++0FFD ~            	 and	h
  68++0FFD ~            	 inc	a
  69++0FFD ~            	 jr	z,goto017		;㭪  
  70++0FFD ~            	 pop	af
  71++0FFD ~            	 ex	(sp),hl
  72++0FFD ~            	 ret
  73++0FFD ~            goto017	 pop	af
  74++0FFD ~            	 pop	hl
  75++0FFD ~            	 ret
  76++0FFD              	ENDIF
  77++0FFD
  78++0FFD              	ENDIF
  79++0FFD
  80++0FFD              ;------------------------------------------------------------------------------
  81++0FFD              TableAdrFunct	ifused
  82++0FFD              ;⠡ ᮢ 㭪権 ࠩ
  83++0FFD              ;TableAdrFunct
  84++0FFD              ;
  85++0FFD 5C 10        		  dw ScanKeyboard
  86++0FFF 07 10        		  dw GetCodesPressKey
  87++1001               IFDEF DrvKey_02
  87++1001 17 10          dw SetFlagsDriver
  87++1003                 ELSE
  87++1003 ~              dw #FFFF
  87++1003               ENDIF
  88++1003               IFDEF DrvKey_03
  88++1003 12 10          dw SetRepeatDelays
  88++1005                ELSE
  88++1005 ~              dw #FFFF
  88++1005               ENDIF
  89++1005               IFDEF DrvKey_04
  89++1005 0D 10          dw GetRepeatDelays
  89++1007                ELSE
  89++1007 ~              dw #FFFF
  89++1007               ENDIF
  90++1007              		endif
  91++1007
  92++1007              ;------------------------------------------------------------------------------
  93++1007              GetCodesPressKey	ifused
  94++1007              ;祭  ⮩ 
  95++1007              ;:  ----
  96++1007              ;: d - ᪠ ⮩ 
  97++1007              ;     a,e -   ⮩   ⥪饩 ᪫ 
  98++1007              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
  99++1007              ;
 100++1007              ;GetCodesPressKey
 101++1007              ;
 102++1007 ED 5B F4 12  	ld	de,(PrintCodePresKey)
 103++100B 7B           	ld	a,e
 104++100C C9           	ret
 105++100D
 106++100D              	endif
 107++100D
 108++100D              ;------------------------------------------------------------------------------
 109++100D              GetRepeatDelays	ifused
 110++100D              ;祭 ਮ প  ⮯
 111++100D              ;:  ----
 112++100D              ;: d - ਮ ⮯
 113++100D              ;     e - প । ⮯஬
 114++100D              ;
 115++100D              ;GetRepeatDelays
 116++100D              ;
 117++100D ED 5B F2 12  	ld      de,(KeyRepeatDelay)
 118++1011 C9           	ret
 119++1012
 120++1012              	endif
 121++1012
 122++1012              ;------------------------------------------------------------------------------
 123++1012              SetRepeatDelays	ifused
 124++1012              ;⠭ ਮ প  ⮯
 125++1012              ;:  d - ਮ ⮯
 126++1012              ;     e - প । ⮯஬
 127++1012              ;: ॣ  
 128++1012              ;
 129++1012              ;SetRepeatDelays
 130++1012              ;
 131++1012 ED 53 F2 12  	ld	(KeyRepeatDelay),de
 132++1016 C9           	ret
 133++1017
 134++1017              	endif
 135++1017
 136++1017              ;------------------------------------------------------------------------------
 137++1017              SetFlagsDriver	ifused
 138++1017              ;e⠭/祭 䫠 ࠩ
 139++1017              ;:  d - ᪠ 䫠
 140++1017              ;     e - 塞 䫠
 141++1017              ;: a - 䫠 ࠩ
 142++1017              ;
 143++1017              ;SetFlagsDriver
 144++1017              ;
 145++1017 3A F0 12     	ld	a,(FlgScanKeys)
 146++101A A2           	and	d
 147++101B B3           	or	e
 148++101C 32 F0 12     	ld	(FlgScanKeys),a
 149++101F C9           	ret
 150++1020
 151++1020              	endif
 152++1020
 153++1020              ;------------------------------------------------------------------------------
 154++1020              ;   ⮬ ६ থ
 155++1020              ;:  (PrintCodePresKey) -   ⮩ 
 156++1020              ;: 6,(FlgScanKeys) =1 -     
 157++1020              ;     hl=FlgScanKeys
 158++1020              ;     d - ᪠ ⮩ 
 159++1020              ;     a,e -   ⮩   ⥪饩 ᪫ 
 160++1020              ;       (Grf\Rus\Lat)  ⮬ ० CapsLock
 161++1020              ;     bc -  ।
 162++1020              ;
 163++1020              ScanKeyboardDelay
 164++1020              ;
 165++1020 CD 5C 10     	call	ScanKeyboard		;a=(PrintCodePresKey)
 166++1023 21 F0 12     	ld	hl,FlgScanKeys
 167++1026 CB F6        	set	6,(hl)
 168++1028              ;	ld	a,(PrintCodePresKey)
 169++1028 FE FF        	cp	#FF
 170++102A 28 24        	jr	z,goto012		;  
 171++102C FE 00        cng_01	cp	#00
 172++102E 20 1E        	jr	nz,goto013		; 㣠 
 173++1030 ED 4B F2 12  	ld	bc,(KeyRepeatDelay)
 174++1034 11 00 00     cng_02	ld	de,#0000
 175++1037 1C           	inc	e
 176++1038 20 01        	jr	nz,goto014
 177++103A 1D           	dec	e
 178++103B 7B           goto014	ld	a,e
 179++103C B9           	cp	c
 180++103D 20 17        	jr	nz,goto015		;প  ⮯
 181++103F 1D           	dec	e
 182++1040 14           	inc	d
 183++1041 20 01        	jr	nz,goto016
 184++1043 15           	dec	d
 185++1044 7A           goto016	ld	a,d
 186++1045 B8           	cp	b
 187++1046 38 0E        	jr	c,goto015
 188++1048 16 00        	ld	d,#00
 189++104A CB B6        	res	6,(hl)
 190++104C 18 08        	jr	goto015
 191++104E CB B6        goto013 res     6,(hl)
 192++1050 32 2D 10     goto012	ld	(cng_01+1),a
 193++1053 11 00 00     	ld	de,#0000
 194++1056 ED 53 35 10  goto015	ld	(cng_02+1),de
 195++105A 18 AB        	jr	GetCodesPressKey
 196++105C
 197++105C              ;------------------------------------------------------------------------------
 198++105C              ;     樥 ⭮ 
 199++105C              ;:  (FlgScanKeys) - 䫠
 200++105C              ;: (ScanCodePresKey) - ᪠ ⮩ 
 201++105C              ;     a -   ⮩ 
 202++105C              ;     (PrintCodePresKey) -   ⮩   ⥪饩 ᪫
 203++105C              ;        (Grf\Rus\Lat)  ⮬ ० CapsLock
 204++105C              ;     7,(FlgScanKeys) =1 ⨬ 
 205++105C              ;     hl,de,bc,a -  ।
 206++105C              ;
 207++105C              ScanKeyboard
 208++105C              ;
 209++105C              ; 
 210++105C              	IFDEF	Used_ROM
 211++105C ~            	 call	#028E
 212++105C              	ELSE
 213++105C CD EB 10     	 call	ScanAllKeys
 214++105F              	ENDIF
 215++105F 21 F0 12     	ld	hl,FlgScanKeys
 216++1062 CB AE        	res	5,(hl)
 217++1064 CB BE        	res	7,(hl)
 218++1066 28 04        	jr	z,goto006		; - 
 219++1068 1E FF        goto021	ld	e,#FF
 220++106A CB FE        	set	7,(hl)			;⨬ 
 221++106C
 222++106C              ;室, ᫨     
 223++106C 7B           goto006	ld	a,e
 224++106D 32 F5 12     	ld	(ScanCodePresKey),a
 225++1070 3C           	inc	a
 226++1071 28 73        	jr	z,goto011
 227++1073
 228++1073              ;  ० ⮫쪮  cs+ss
 229++1073 E5           	push	hl
 230++1074 4E           	ld	c,(hl)			;c=(FlgScanKeys)
 231++1075              	IFDEF	CommandMode
 232++1075 CB 41        	 bit	0,c
 233++1077 28 02        	 jr	z,goto018		;몫祭 Command Mode
 234++1079              	 IFDEF	Used_ROM
 235++1079 ~            	  ld	a,d
 236++1079 ~            	  cp	#18
 237++1079 ~            	  jr	z,goto019		; SS
 238++1079              	 ELSE
 239++1079 CB 8A        	  res	1,d			; SS
 240++107B              	 ENDIF
 241++107B              	ENDIF
 242++107B
 243++107B              ;塞    ⨭᪮ ᪫  ᪠ 
 244++107B 7A           goto018	ld	a,d
 245++107C              	IFDEF	Used_ROM
 246++107C ~            	 ld	hl,tableSSkeys
 247++107C ~            	 cp	#18
 248++107C ~            	 jr	z,goto007		; ⮩ ss
 249++107C ~            	 ld	hl,tableCSkeys
 250++107C ~            	 cp	#27
 251++107C ~            	 jr	z,goto007		; ⮩ cs
 252++107C ~            goto019	 ld	hl,tablePrnKeys
 253++107C              	ELSE
 254++107C 21 80 11     	 ld	hl,tableSSkeys
 255++107F FE 02        	 cp	#02
 256++1081 28 12        	 jr	z,goto007		; ⮩ ss
 257++1083              	 IFDEF	UseEXTkeys
 258++1083 21 A8 11     	  ld	hl,tableEXTKeys
 259++1086 CB E9        	  set	5,c			;  cs+ss
 260++1088 30 0B        	  jr	nc,goto007		; ⮩ cs+ss
 261++108A CB A9        	  res	5,c
 262++108C              	 ENDIF
 263++108C 21 58 11     	 ld	hl,tableCSkeys
 264++108F B7           	 or	a
 265++1090 20 03        	 jr	nz,goto007		; ⮩ cs
 266++1092 21 30 11     	 ld	hl,tablePrnKeys
 267++1095              	ENDIF
 268++1095 16 00        goto007	ld	d,#00
 269++1097 19           	add	hl,de
 270++1098 5E           	ld	e,(hl)			; 
 271++1099 E1           	pop	hl
 272++109A 71           	ld	(hl),c
 273++109B 7B           	ld	a,e
 274++109C 3C           	inc	a
 275++109D 28 C9        	jr	z,goto021
 276++109F              ;de -   ⮩   ⨭᪮ ᪫   ० Caps
 277++109F
 278++109F              ;᫨ 祭  ० ⠭ ᨬ  孨 ॣ
 279++109F              	IFDEF	CommandMode
 280++109F 79           	 ld	a,c
 281++10A0 E6 21        	 and	%00100001
 282++10A2 20 0D        	 jr	nz,goto020		;祭 Command Mode
 283++10A4              	ENDIF
 284++10A4
 285++10A4              ;४ ⭮   ⮬ ० CapsLock
 286++10A4 7B           	ld	a,e
 287++10A5 CB 49        	bit	1,c
 288++10A7 28 13        	jr	z,goto008		;caps 몫祭
 289++10A9 FE 41        	cp	"A"
 290++10AB 38 0F        	jr	c,goto008
 291++10AD FE 5B        	cp	"Z"+1
 292++10AF 38 09        	jr	c,goto009
 293++10B1              	IFDEF	CommandMode
 294++10B1 7B           goto020	 ld	a,e
 295++10B2              	ENDIF
 296++10B2 FE 61        	cp	"a"
 297++10B4 38 06        	jr	c,goto008
 298++10B6 FE 7B        	cp	"z"+1
 299++10B8 30 02        	jr	nc,goto008
 300++10BA EE 20        goto009	xor	%00100000
 301++10BC 5F           goto008	ld	e,a
 302++10BD              ;de,a -   ⮩   ⨭᪮ ᪫
 303++10BD
 304++10BD              ; ८ࠧ, ᫨ 祭  ०
 305++10BD              	IFDEF	CommandMode
 306++10BD 79           	 ld	a,c
 307++10BE E6 21        	 and	%00100001
 308++10C0 7B           	 ld	a,e
 309++10C1 20 23        	 jr	nz,goto011		;祭 Command Mode
 310++10C3              	ENDIF
 311++10C3
 312++10C3              ;⠭ ⭮   ᮮ⢥⢨  祭 ᪫: Grf\Rus\Lat
 313++10C3              ;  grf ᪫
 314++10C3              	IFDEF	GrfMode
 315++10C3              	 IFDEF	InsideGrfTable
 316++10C3 FE 20        	  cp	#20
 317++10C5 38 1F        	  jr	c,goto011
 318++10C7              	 ENDIF
 319++10C7 21 B0 11     	 ld	hl,TblKeyGrf
 320++10CA CB 51        	 bit	2,c
 321++10CC 20 16        	 jr	nz,goto010		;祭 Grf
 322++10CE              	ENDIF
 323++10CE              ;  rus ᪫
 324++10CE              	IFDEF	RusMode
 325++10CE CB 59        	 bit	3,c
 326++10D0 28 14        	 jr	z,goto011		;᪫ rus 몫祭
 327++10D2              	 IFDEF	InsideRusTable
 328++10D2 FE 20        	  cp	#20
 329++10D4 38 10        	  jr	c,goto011
 330++10D6              	 ENDIF
 331++10D6              	 IFDEF	Rus_jcuken
 332++10D6 21 70 12     	  ld	hl,TblKeyRus_jcuken
 333++10D9              	  IFDEF	Rus_qwerty
 334++10D9 CB 61        	   bit	4,c
 335++10DB 20 07        	   jr	nz,goto010		;祭 ᪫ Rus 㪥
 336++10DD              	  ENDIF
 337++10DD              	 ENDIF
 338++10DD              	 IFDEF	Rus_qwerty
 339++10DD 21 10 12     	  ld	hl,TblKeyRus_qwerty
 340++10E0              	 ENDIF
 341++10E0 18 02        	 jr	goto010
 342++10E2              	ENDIF
 343++10E2 18 02        	jr	goto011
 344++10E4 19           goto010	add	hl,de
 345++10E5 5E           	ld	e,(hl)
 346++10E6              ;e -   ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
 347++10E6              ;     ⮬ ० CapsLock
 348++10E6
 349++10E6 7B           goto011 ld      a,e
 350++10E7 32 F4 12             ld      (PrintCodePresKey),a
 351++10EA C9                   ret
 352++10EB
 353++10EB              ;------------------------------------------------------------------------------
 354++10EB              ScanAllKeys	ifused
 355++10EB              ;    ( /  48k #028E)
 356++10EB              ;ਬ砭: ⠡ ScanCode
 357++10EB              ;Ŀ
 358++10EB              ; 1  2  3  4  5  6  7  8  9  0 
 359++10EB              ;#24#1C#14#0C#04#03#0B#13#1B#23
 360++10EB              ;Ĵ
 361++10EB              ; Q  W  Q  R  T  Y  U  I  O  P 
 362++10EB              ;#25#1D#15#0D#05#02#0A#12#1A#22
 363++10EB              ;Ĵ
 364++10EB              ; A  S  D  F  G  h  J  K  L ent
 365++10EB              ;#26#1E#16#0E#06#01#09#11#19#21
 366++10EB              ;Ĵ
 367++10EB              ;s  Z  X  C  V  B  N  M ss sp 
 368++10EB              ;#27#1F#17#0F#07#00#08#10#18#20
 369++10EB              ;
 370++10EB              ;:  ----
 371++10EB              ;: nz - ⨬ 
 372++10EB              ;       hl,de,bc,a -  ।
 373++10EB              ;     z  -       CS/SS    
 374++10EB              ;       e =#FF -   
 375++10EB              ;       0,d/c=1   c CS
 376++10EB              ;       1,d/c=1   c SS
 377++10EB              ;       e - ScanCode  ⮩ 
 378++10EB              ;       a=#00
 379++10EB              ;       hl,b -  ।
 380++10EB              ;
 381++10EB              ;ScanAllKeys
 382++10EB              ;
 383++10EB 2E 2F        	ld	l,#27+#08
 384++10ED 11 FF FF     	ld	de,#FFFF
 385++10F0 01 FF FE     	ld	bc,#FEFF
 386++10F3
 387++10F3              ;  ⠭ ⮢   ॣ c,d,e
 388++10F3 78           loop003	ld	a,b
 389++10F4 DB FE        	in	a,(#FE)
 390++10F6 2F           	cpl
 391++10F7 E6 1F        	and	#1F
 392++10F9 28 0F        	jr	z,goto001
 393++10FB 67           	ld	h,a
 394++10FC 7D           	ld	a,l
 395++10FD 0C           loop002	inc	c
 396++10FE C0           	ret	nz			;   
 397++10FF D6 08        loop001	sub	#08
 398++1101 CB 3C        	srl	h
 399++1103 30 FA        	jr	nc,loop001
 400++1105 4A           	ld	c,d
 401++1106 53           	ld	d,e
 402++1107 5F           	ld	e,a			; ⮩ 
 403++1108 20 F3        	jr	nz,loop002
 404++110A 2D           goto001	dec	l
 405++110B CB 00        	rlc	b
 406++110D 38 E4        	jr	c,loop003
 407++110F              ;=key 1, d=key 2, e=key 3
 408++110F              ;=#FF, d=key 1, e=key 2
 409++110F              ;=#FF, d=#FF, e=key 1
 410++110F
 411++110F              ;஢ઠ 権 
 412++110F 79           	ld	a,c
 413++1110 3C           	inc	a
 414++1111 28 04        	jr	z,goto002		;    
 415++1113 D6 28        	sub	#27+1
 416++1115 C0           	ret	nz			;ࢠ   cs
 417++1116 3C           	inc	a
 418++1117 4F           goto002	ld	c,a			;0,c=0/1   cs/ cs
 419++1118 7A           	ld	a,d
 420++1119 3C           	inc	a
 421++111A 28 11        	jr	z,goto004		;   -> e - ᪠/#FF
 422++111C FE 28        	cp	#27+1
 423++111E 28 0C        	jr	z,goto003
 424++1120 FE 19        	cp	#18+1
 425++1122 28 05        	jr	z,goto005		; ss
 426++1124 7B           	ld	a,e
 427++1125 5A           	ld	e,d
 428++1126 FE 18        	cp	#18
 429++1128 C0           	ret	nz			;⨬ 
 430++1129 CB C9        goto005	set	1,c			; ss
 431++112B 0D           	dec	c
 432++112C 0C           goto003	inc	c
 433++112D 51           goto004	ld	d,c			;0,d=0/1 cs  /
 434++112E AF           	xor	a			;1,d=0/1 ss  /
 435++112F C9           	ret
 436++1130
 437++1130                      endif
 438++1130
 439++1130              ;==============================================================================
 440++1130              		ifused	tablePrnKeys
 441++1130              ;⠡  
 442++1130              ;cs - off
 443++1130              ;ss - off
 444++1130              ;
 445++1130 62 68 79 36  tablePrnKeys	db "bhy65tgv"	;#00-#07
 445++1134 35 74 67 76
 446++1138 6E 6A 75 37  		db "nju74rfc"	;#08-#0F
 446++113C 34 72 66 63
 447++1140 6D 6B 69 38  		db "mki83edx"	;#10-#17
 447++1144 33 65 64 78
 448++1148 1D           		db keySS	;#18
 449++1149 6C 6F 39 32  		db "lo92wsz"	;#19-#1F
 449++114D 77 73 7A
 450++1150 20           		db " "		;#20
 451++1151 0D           		db keyEnter	;#21
 452++1152 70 30 31 71  		db "p01qa"	;#22-#26
 452++1156 61
 453++1157 1C           		db keyCS	;#27
 454++1158
 455++1158              		endif
 456++1158
 457++1158              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 458++1158              		ifused	tableCSkeys
 459++1158              ;⠡  
 460++1158              ;cs - on
 461++1158              ;ss - off
 462++1158              ;
 463++1158 42 48 59     tableCSkeys	db "BHY"	;#00-#02
 464++115B 0A           		db keyDown	;#03
 465++115C 08           		db keyLeft	;#04
 466++115D 54 47 56     		db "TGV"	;#05-#07
 467++1160 4E 4A 55     		db "NJU"	;#08-#0A
 468++1163 0B           		db keyUp	;#0B
 469++1164 05           		db keyPageDown	;#0C
 470++1165 52 46 43     		db "RFC"	;#0D-#0F
 471++1168 4D 4B 49     		db "MKI"	;#10-#12
 472++116B 09           		db keyRight	;#13
 473++116C 04           		db keyPageUp	;#14
 474++116D 45 44 58     		db "EDX"	;#15-#17
 475++1170 0E           		db keyExtMode	;#18
 476++1171 4C 4F        		db "LO"		;#19-#1A
 477++1173 0F           		db keyDelete	;#1B
 478++1174 06           		db keyCaps	;#1C
 479++1175 57 53 5A     		db "WSZ"	;#1D-#1F
 480++1178 18           		db keyBreak	;#20
 481++1179 19           		db keyCsEnter	;#21
 482++117A 50           		db "P"		;#22
 483++117B 0C           		db keyBackSpace	;#23
 484++117C 07           		db keyEdit	;#24
 485++117D 51 41        		db "QA"		;#25-#26
 486++117F 1C           		db keyCS	;#27
 487++1180
 488++1180              		endif
 489++1180
 490++1180              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 491++1180              		ifused	tableSSkeys
 492++1180              ;⠡  
 493++1180              ;cs - off
 494++1180              ;ss - on
 495++1180              ;
 496++1180 2A 5E 5B 26  tableSSkeys	db "*^[&%>}/"	;#00-#07
 496++1184 25 3E 7D 2F
 497++1188 2C 2D 5D 27  		db ",-]'$<{?"	;#08-#0F
 497++118C 24 3C 7B 3F
 498++1190 2E 2B 7F 28  		db ".+(#"	;#10-#14
 498++1194 23
 499++1195 03           		db keyEnd	;#15
 500++1196 5C 60        		db #5C,#60	;#16-#17 (\`)
 501++1198 1D           		db keySS	;#18
 502++1199 3D 3B 29 40  		db "=;)@"	;#19-#1C
 503++119D 02           		db keyInsert	;#1D
 504++119E 7C 3A        		db "|:"		;#1E-#1F
 505++11A0 1A           		db keySsSpace	;#20
 506++11A1 1B           		db keySsEnter	;#21
 507++11A2 22           		db #22		;#22 (")
 508++11A3 5F 21        		db "_!"		;#23-#24
 509++11A5 01           		db keyHome	;#25
 510++11A6 7E           		db "~"		;#26
 511++11A7 0E           		db keyExtMode	;#27
 512++11A8
 513++11A8              		endif
 514++11A8
 515++11A8              ;- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
 516++11A8              		ifused	tableEXTKeys
 517++11A8              ;⠡  , ᪫  ZX-Word
 518++11A8              ;cs - on
 519++11A8              ;ss - on
 520++11A8              ;
 521++11A8              tableEXTKeys
 522++11A8
 523++11A8              		IFDEF	TblEXTkey_Test	;⮢ ᪫
 524++11A8 42 48 59     		db "BHY"	;#00-#02
 525++11AB 03           		db keyEnd	;#03 key 6
 526++11AC 10           		db keyWordLeft	;#04 key 5
 527++11AD 54 47 56     		db "TGV"	;#05-#07
 528++11B0 4E 4A 55     		db "NJU"	;#08-#0A
 529++11B3 01           		db keyHome	;#0B key 7
 530++11B4 FF           		db #FF		;#0C key 4
 531++11B5 52 46 43     		db "RFC"	;#0D-#0F
 532++11B8 4D 4B 49     		db "MKI"	;#10-#12
 533++11BB 11           		db keyWordRight	;#13 key 8
 534++11BC FF           		db #FF		;#14 key 3
 535++11BD 45 44 58     		db "EDX"	;#15-#17
 536++11C0 FF           		db #FF		;#18 key SS
 537++11C1 4C 4F        		db "LO"		;#19-#1A
 538++11C3 13           		db keyDelEnd	;#1B key 9
 539++11C4 FF           		db #FF		;#1C key 2
 540++11C5 57 53 5A     		db "WSZ"	;#1D-#1F
 541++11C8 14           		db keyCsSsSpace	;#20
 542++11C9 15           		db keyCsSsEnter	;#21
 543++11CA 50           		db "P"		;#22
 544++11CB 16           		db keyDelBegin	;#23 key 0
 545++11CC 12           		db keyGrf	;#24 key 1
 546++11CD 51 41        		db "QA"		;#25-#26
 547++11CF FF           		db #FF		;#27 key CS
 548++11D0              		ENDIF
 549++11D0
 550++11D0              		IFDEF	TblEXTkey_Word	; ZX-Word
 551++11D0 ~            		db "BHY"	;#00-#02
 552++11D0 ~            		db keyEnd	;#03 key 6
 553++11D0 ~            		db keyWordLeft	;#04 key 5
 554++11D0 ~            		db "TG",#FF	;#05-#07
 555++11D0 ~            		db #FF,#FF,#FF	;#08-#0A
 556++11D0 ~            		db keyHome	;#0B key 7
 557++11D0 ~            		db #FF		;#0C key 4
 558++11D0 ~            		db "RFC"	;#0D-#0F
 559++11D0 ~            		db #FF,#FF,#FF	;#10-#12
 560++11D0 ~            		db keyWordRight	;#13 key 8
 561++11D0 ~            		db #FF		;#14 key 3
 562++11D0 ~            		db "EDX"	;#15-#17
 563++11D0 ~            		db #FF		;#18 key SS
 564++11D0 ~            		db #FF,"O"	;#19-#1A
 565++11D0 ~            		db keyDelete	;#1B key 9
 566++11D0 ~            		db keyInsert	;#1C key 2
 567++11D0 ~            		db #FF,#FF,"Z"	;#1D-#1F
 568++11D0 ~            		db #FF		;#20
 569++11D0 ~            		db #FF		;#21
 570++11D0 ~            		db "P"		;#22
 571++11D0 ~            		db keyBackSpace	;#23 key 0
 572++11D0 ~            		db keyEdit	;#24 key 1
 573++11D0 ~            		db "Q",#FF	;#25-#26
 574++11D0 ~            		db #FF		;#27 key CS
 575++11D0              		ENDIF
 576++11D0
 577++11D0              		endif
 578++11D0
 579++11D0              ;------------------------------------------------------------------------------
 580++11D0              	IFDEF	GrfMode
 581++11D0              	IFDEF	TblKeyGrf_ver1
 582++11D0              	IFDEF	InsideGrfTable
 583++11D0
 584++11D0              ;᪠ ᪫: version 01
 585++11D0              ;
 586++11D0              TblKeyGrf	equ $-#20
 587++11D0              ;
 588++11D0              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 589++11D0              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 590++11D0              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 591++11D0              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 592++11D0 20 21 22 23  	db " !",#22,"#$%&'"
 592++11D4 24 25 26 27
 593++11D8 28 29 2A 2B  	db "()*+,-./"
 593++11DC 2C 2D 2E 2F
 594++11E0 30 31 32 33  	db "01234567"
 594++11E4 34 35 36 37
 595++11E8 38 39 3A 3B  	db "89:;<=>?"
 595++11EC 3C 3D 3E 3F
 596++11F0 40 C7 D4 BD  	db "@Խ"
 596++11F4 B6 B7 BA C6
 597++11F8 D8 CD B5 B3  	db "͵۾"
 597++11FC DB BE CF DD
 598++1200 DE D6 C4 D7  	db "ո"
 598++1204 D5 B8 F0 D2
 599++1208 D0 D1 D3 5B  	db "[",#5C,"]^_"
 599++120C 5C 5D 5E 5F
 600++1210 60 C3 C8 D9  	db "`ٴ"
 600++1214 B4 BF B3 CC
 601++1218 CE CD B9 BA  	db "͹ʱ"
 601++121C B0 BC CA B1
 602++1220 B2 DA C4 C5  	db "ɻ"
 602++1224 C9 BB FB C2
 603++1228 C1 CB C0 7B  	db "{|}~"
 603++122C 7C 7D 7E 7F
 604++1230
 605++1230              	ELSE
 606++1230 ~            TblKeyGrf	equ	OutsideGrfTable
 607++1230              	ENDIF
 608++1230              	ENDIF
 609++1230              	ENDIF
 610++1230
 611++1230              ;------------------------------------------------------------------------------
 612++1230              	IFDEF	RusMode
 613++1230              	IFDEF	Rus_qwerty
 614++1230              	IFDEF	InsideRusTable
 615++1230
 616++1230              ;᪠ ᪫: 
 617++1230              ;
 618++1230              TblKeyRus_qwerty	equ $-#20
 619++1230              ;
 620++1230              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 621++1230              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 622++1230              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 623++1230              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 624++1230 20 21 22 23  	db " !",#22,"#$%&'"
 624++1234 24 25 26 27
 625++1238 28 29 2A 2B  	db "()*+,-./"
 625++123C 2C 2D 2E 2F
 626++1240 30 31 32 33  	db "01234567"
 626++1244 34 35 36 37
 627++1248 38 39 3A 3B  	db "89:;<=>?"
 627++124C 3C 3D 3E 3F
 628++1250 40 80 81 96  	db "@"
 628++1254 84 85 94 83
 629++1258 95 88 89 8A  	db ""
 629++125C 8B 8C 8D 8E
 630++1260 8F 9F 90 91  	db ""
 630++1264 92 93 86 82
 631++1268 9C 9B 87 5B  	db "[",#5C,"]^"
 631++126C 5C 5D 5E 9A
 632++1270 9E A0 A1 E6  	db "椥"
 632++1274 A4 A5 E4 A3
 633++1278 E5 A8 A9 AA  	db "娩"
 633++127C AB AC AD AE
 634++1280 AF EF E0 E1  	db "㦢"
 634++1284 E2 E3 A6 A2
 635++1288 EC EB A7 98  	db "맘"
 635++128C 9D 99 97 7F
 636++1290
 637++1290              	ELSE
 638++1290 ~            TblKeyRus_qwerty	equ	OutsideRus_qwerty
 639++1290              	ENDIF
 640++1290              	ENDIF
 641++1290              	ENDIF
 642++1290
 643++1290              ;------------------------------------------------------------------------------
 644++1290              	IFDEF	RusMode
 645++1290              	IFDEF	Rus_jcuken
 646++1290              	IFDEF	InsideRusTable
 647++1290
 648++1290              ;᪠ ᪫: 㪥
 649++1290              ;
 650++1290              TblKeyRus_jcuken	equ	$-#20
 651++1290              ;
 652++1290              ;	db #00,#01,#02,#03,#04,#05,#06,#07
 653++1290              ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 654++1290              ;	db #10,#11,#12,#13,#14,#15,#16,#17
 655++1290              ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 656++1290 20 21 22 23  	db " !",#22,"#$%&'"
 656++1294 24 25 26 27
 657++1298 28 29 2A 2B  	db "()*+,-./"
 657++129C 2C 2D 2E 2F
 658++12A0 30 31 32 33  	db "01234567"
 658++12A4 34 35 36 37
 659++12A8 38 39 3A 3B  	db "89:;<=>?"
 659++12AC 3C 3D 3E 3F
 660++12B0 9E 94 88 91  	db ""
 660++12B4 82 93 80 8F
 661++12B8 90 98 8E 8B  	db ""
 661++12BC 84 9C 92 99
 662++12C0 87 89 8A 9B  	db ""
 662++12C4 85 83 8C 96
 663++12C8 97 8D 9F 95  	db ""
 663++12CC 9D 86 81 9A
 664++12D0 EE E4 A8 E1  	db "㠯"
 664++12D4 A2 E3 A0 AF
 665++12D8 E0 E8 AE AB  	db "讫"
 665++12DC A4 EC E2 E9
 666++12E0 A7 A9 AA EB  	db "륣"
 666++12E4 A5 A3 AC E6
 667++12E8 E7 AD EF E5  	db ""
 667++12EC ED A6 A1 7F
 668++12F0
 669++12F0              	ELSE
 670++12F0 ~            TblKeyRus_jcuken	equ	OutsideRus_jcuken
 671++12F0              	ENDIF
 672++12F0              	ENDIF
 673++12F0              	ENDIF
 674++12F0
 675++12F0              ;------------------------------------------------------------------------------
 676++12F0              	ifused	TblKeyLat
 677++12F0 ~            ;⠭⭠ ⨭᪠ ᪫
 678++12F0 ~            ;
 679++12F0 ~            TblKeyLat	equ	$-#20
 680++12F0 ~            ;
 681++12F0 ~            ;	db #00,#01,#02,#03,#04,#05,#06,#07
 682++12F0 ~            ;	db #08,#09,#0A,#0B,#0C,#0D,#0E,#0F
 683++12F0 ~            ;	db #10,#11,#12,#13,#14,#15,#16,#17
 684++12F0 ~            ;	db #18,#19,#1A,#1B,#1C,#1D,#1E,#1F
 685++12F0 ~            	db " !",""","#$%&'"
 686++12F0 ~            	db "()*+,-./"
 687++12F0 ~            	db "01234567"
 688++12F0 ~            	db "89:;<=>?"
 689++12F0 ~            	db "@ABCDEFG"
 690++12F0 ~            	db "HIJKLMNO"
 691++12F0 ~            	db "PQRSTUVW"
 692++12F0 ~            	db "XYZ[\]^_"
 693++12F0 ~            	db "`abcdefg"
 694++12F0 ~            	db "hijklmno"
 695++12F0 ~            	db "pqrstuvw"
 696++12F0 ~            	db "xyz{|}~"
 697++12F0 ~
 698++12F0              	endif
 699++12F0
 700++12F0              ;==============================================================================
 701++12F0
# file closed: Drv/DrvKey.asm.a80
 117+ 12F0              	INCLUDE	"DrvKey.var.a80"
# file opened: Drv/DrvKey.var.a80
   1++12F0              ;६ Keyboard Driver
   2++12F0              ;䠩 DrvKey.var.a80
   3++12F0              ;
   4++12F0              ;䫠 ࠩ
   5++12F0              ;7,=1     
   6++12F0              ;6,=1     
   7++12F0              ;5,=1 ᨬ  ० cs+ss+key
   8++12F0              ;4,=1/0 Rus 㪥/Rus 
   9++12F0              ;3,=1/0 Rus/Lat
  10++12F0              ;2,=1/0 Grf on/off
  11++12F0              ;1,=1/0 CapsLock on/off
  12++12F0              ;0,=1/0 Command on/off
  13++12F0 30           FlgScanKeys     db %00110000
  14++12F1 00           		db %00000000	;१
  15++12F2
  16++12F2              ;稭 প  ⮯
  17++12F2 0F           KeyRepeatDelay    db #0F
  18++12F3              ;ਮ ⮯
  19++12F3 05           KeyRepeatPeriod   db #05
  20++12F4
  21++12F4              ;  ⮩   ⥪饩 ᪫  (Grf\Rus\Lat)
  22++12F4              ;   ⮬ ० CapsLock
  23++12F4 00           PrintCodePresKey  db #00
  24++12F5              ;᪠ ⮩ 
  25++12F5 00           ScanCodePresKey   db #00
  26++12F6
  27++12F6
# file closed: Drv/DrvKey.var.a80
 118+ 12F6              End	DISPLAY	"Lenght DrvKey = ",/A,End-Start
 119+ 12F6              ;	SAVEBIN	"!bin/drvkeys.bin",Start,End-Start
 120+ 12F6              	ENDMODULE
 121+ 12F6
# file closed: Drv/DrvKey.main.a80
1371  12F6              	include player.asm ;плеер AY, TS
# file opened: player.asm
   1+ 12F6              ;Universal PT2'n'PT3 Turbo Sound player for ZX Spectrum
   2+ 12F6              ;(c)2004-2007 S.V.Bulba <vorobey@mail.khstu.ru>
   3+ 12F6              ;Specially for AlCo
   4+ 12F6              ;http://bulba.untergrund.net/ (http://bulba.at.kz/)
   5+ 12F6              	MODULE VTPL
   6+ 12F6              ;Release number
   7+ 12F6              Release EQU "0"
   8+ 12F6              ;Conditional assembly
   9+ 12F6              ;1) Current position counters at (Vars1+0) and (Vars2+0)
  10+ 12F6              CurPosCounter=0
  11+ 12F6              ;2) Allow channels allocation bits at (START+10)
  12+ 12F6              ACBBAC=0
  13+ 12F6              ;3) Allow loop checking and disabling
  14+ 12F6              LoopChecker=1
  15+ 12F6              ;4) Insert official identificator
  16+ 12F6              Id=0
  17+ 12F6              ;5) Set IY for correct return to ZX Basic
  18+ 12F6              Basic=1
  19+ 12F6
  20+ 12F6              ;Features
  21+ 12F6              ;--------
  22+ 12F6              ;-Can be compiled at any address (i.e. no need rounding ORG
  23+ 12F6              ; address).
  24+ 12F6              ;-Variables (VARS) can be located at any address (not only after
  25+ 12F6              ; code block).
  26+ 12F6              ;-INIT subprogram checks PT3-module version and rightly
  27+ 12F6              ; generates both note and volume tables outside of code block
  28+ 12F6              ; (in VARS).
  29+ 12F6              ;-Two portamento (spc. command 3xxx) algorithms (depending of
  30+ 12F6              ; PT3 module version).
  31+ 12F6              ;-New 1.XX and 2.XX special command behaviour (only for PT v3.7
  32+ 12F6              ; and higher).
  33+ 12F6              ;-Any Tempo value are accepted (including Tempo=1 and Tempo=2).
  34+ 12F6              ;-TS modes: 2xPT3, 2xPT2 and PT v3.7 TS standard.
  35+ 12F6              ;-Fully compatible with Ay_Emul PT3 and PT2 players codes.
  36+ 12F6              ;-See also notes at the end of this source code.
  37+ 12F6
  38+ 12F6              ;Limitations
  39+ 12F6              ;-----------
  40+ 12F6              ;-Can run in RAM only (self-modified code is used).
  41+ 12F6              ;-PT2 position list must be end by #FF marker only.
  42+ 12F6
  43+ 12F6              ;Warning!!! PLAY subprogram can crash if no module are loaded
  44+ 12F6              ;into RAM or INIT subprogram was not called before.
  45+ 12F6
  46+ 12F6              ;Call MUTE or INIT one more time to mute sound after stopping
  47+ 12F6              ;playing
  48+ 12F6
  49+ 12F6              ;Test codes (commented)
  50+ 12F6              ;	LD A,32 ;SinglePT3(TS if TSPT3.7),ABC,Looped
  51+ 12F6              ;	LD (START+10),A
  52+ 12F6              ;	LD HL,#8000 ;Mod1
  53+ 12F6              ;	LD DE,#A000 ;Mod2 (optional)
  54+ 12F6              ;	CALL START+3
  55+ 12F6              ;	EI
  56+ 12F6              ;_LP	HALT
  57+ 12F6              ;	CALL START+5
  58+ 12F6              ;	XOR A
  59+ 12F6              ;	IN A,(#FE)
  60+ 12F6              ;	CPL
  61+ 12F6              ;	AND 15
  62+ 12F6              ;	JR Z,_LP
  63+ 12F6              ;	JR START+8
  64+ 12F6
  65+ 12F6              TonA	EQU 0
  66+ 12F6              TonB	EQU 2
  67+ 12F6              TonC	EQU 4
  68+ 12F6              Noise	EQU 6
  69+ 12F6              Mixer	EQU 7
  70+ 12F6              AmplA	EQU 8
  71+ 12F6              AmplB	EQU 9
  72+ 12F6              AmplC	EQU 10
  73+ 12F6              Env	EQU 11
  74+ 12F6              EnvTp	EQU 13
  75+ 12F6
  76+ 12F6              ;Entry and other points
  77+ 12F6              ;START initialize playing of modules at MDLADDR (single module)
  78+ 12F6              ;START+3 initialization with module address in HL and DE (TS)
  79+ 12F6              ;START+5 play one quark
  80+ 12F6              ;START+8 mute
  81+ 12F6              ;START+10 setup and status flags
  82+ 12F6
  83+ 12F6              START:
  84+ 12F6 21 00 C0     	LD HL,outputBuffer ;DE - address of 2nd module for TS
  85+ 12F9 18 3C        	JR INIT
  86+ 12FB C3 5A 1B     	JP PLAY
  87+ 12FE 18 25        	JR MUTE
  88+ 1300 00           SETUP	DB 0 ;set bit0, if you want to play without looping
  89+ 1301              	     ;(optional);
  90+ 1301              	     ;set bit1 for PT2 and reset for PT3 before
  91+ 1301              	     ;calling INIT;
  92+ 1301              	     ;bits2-3: %00-ABC, %01-ACB, %10-BAC (optional);
  93+ 1301              	     ;bits4-5: %00-no TS, %01-2 modules TS, %10-
  94+ 1301              	     ;autodetect PT3 TS-format by AlCo (PT 3.7+);
  95+ 1301              	     ;Remark: old PT3 TS-format by AlCo (PT 3.6) is not
  96+ 1301              	     ;documented and must be converted to new standard.
  97+ 1301              	     ;bit6 is set each time, when loop point of 2nd TS
  98+ 1301              	     ;module is passed (optional).
  99+ 1301              	     ;bit7 is set each time, when loop point of 1st TS
 100+ 1301              	     ;or of single module is passed (optional).
 101+ 1301
 102+ 1301              ;Identifier
 103+ 1301              	IF Id
 104+ 1301 ~            	DB "=UniPT2/PT3/TS-Player r.",Release,"="
 105+ 1301              	ENDIF
 106+ 1301
 107+ 1301              	IF LoopChecker
 108+ 1301 21 00 13     CHECKLP	LD HL,SETUP
 109+ 1304 FD CB 9E 46  	BIT 0,(IY-100+VRS.ModNum)
 110+ 1308 28 04        	JR Z,CHL1
 111+ 130A CB F6        	SET 6,(HL)
 112+ 130C 18 02        	JR CHL2
 113+ 130E CB FE        CHL1	SET 7,(HL)
 114+ 1310 CB 46        CHL2	BIT 0,(HL)
 115+ 1312 C8           	RET Z
 116+ 1313 E1           	POP HL
 117+ 1314 FD 34 09     	INC (IY-100+VRS.DelyCnt)
 118+ 1317 FD 34 BA     	INC (IY-100+VRS.ChanA+CHP.NtSkCn)
 119+ 131A AF           	XOR A
 120+ 131B FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
 121+ 131E FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
 122+ 1321 FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
 123+ 1324 C9           	RET
 124+ 1325              	ENDIF
 125+ 1325
 126+ 1325 AF           MUTE: XOR A
 127+ 1326 67           	LD H,A
 128+ 1327 6F           	LD L,A
 129+ 1328 32 AF 1C     	LD (VARS1+VRS.AYREGS+AmplA),A
 130+ 132B 22 B0 1C     	LD (VARS1+VRS.AYREGS+AmplB),HL
 131+ 132E 32 36 1D     	LD (VARS2+VRS.AYREGS+AmplA),A
 132+ 1331 22 37 1D     	LD (VARS2+VRS.AYREGS+AmplB),HL
 133+ 1334 C3 72 1B     	JP ROUT
 134+ 1337
 135+ 1337              INIT:
 136+ 1337              ;HL - AddressOfModule
 137+ 1337              ;DE - AddresOf2ndModule
 138+ 1337 D5           	PUSH DE
 139+ 1338 E5           	PUSH HL
 140+ 1339 21 2D 1C     	LD HL,VARS
 141+ 133C 36 00        	LD (HL),0
 142+ 133E 11 2E 1C     	LD DE,VARS+1
 143+ 1341 01 0E 01     	LD BC,VAR0END-VARS-1
 144+ 1344 ED B0        	LDIR
 145+ 1346 23           	INC HL
 146+ 1347 22 90 1C     	LD (VARS1+VRS.AdInPtA),HL ;ptr to zero
 147+ 134A 22 17 1D     	LD (VARS2+VRS.AdInPtA),HL
 148+ 134D
 149+ 134D E1           	POP HL
 150+ 134E FD 21 92 1C  	LD IY,VARS1+100
 151+ 1352 3A 00 13     	LD A,(START+10)
 152+ 1355 E6 02        	AND 2
 153+ 1357 C2 E0 13     	JP NZ,I_PT2
 154+ 135A
 155+ 135A CD 2D 15     	CALL INITPT3
 156+ 135D 21 18 1F     	LD HL,(e_-SamCnv-2)*256+#18
 157+ 1360 22 00 19     	LD (SamCnv),HL
 158+ 1363 3E BA        	LD A,#BA
 159+ 1365 32 CB 18     	LD (OrnCP),A
 160+ 1368 32 F7 18     	LD (SamCP),A
 161+ 136B 3E 7B        	LD A,#7B
 162+ 136D 32 CE 18     	LD (OrnLD),A
 163+ 1370 32 FA 18     	LD (SamLD),A
 164+ 1373 3E 87        	LD A,#87
 165+ 1375 32 F1 18     	LD (SamClc2),A
 166+ 1378 E1           	POP HL
 167+ 1379              	;Use version and ton table of 1st module
 168+ 1379 DD 7E A9     	LD A,(IX+13-100) ;EXTRACT VERSION NUMBER
 169+ 137C D6 30        	SUB #30
 170+ 137E 38 04        	JR C,L20
 171+ 1380 FE 0A        	CP 10
 172+ 1382 38 02        	JR C,L21
 173+ 1384 3E 06        L20	LD A,6
 174+ 1386 32 9E 17     L21	LD (Version),A
 175+ 1389 F5           	PUSH AF ;VolTable version
 176+ 138A FE 04        	CP 4
 177+ 138C DD 7E FF     	LD A,(IX+99-100) ;TONE TABLE NUMBER
 178+ 138F 17           	RLA
 179+ 1390 E6 07        	AND 7
 180+ 1392 F5           	PUSH AF ;NoteTable number
 181+ 1393
 182+ 1393 FD 21 19 1D  	LD IY,VARS2+100
 183+ 1397 3A 00 13     	LD A,(START+10)
 184+ 139A E6 30        	AND 48
 185+ 139C 28 37        	JR Z,NOTS
 186+ 139E FE 10        	CP 16
 187+ 13A0 28 27        	JR Z,TwoPT3s
 188+ 13A2 3A 9E 17     	LD A,(Version)
 189+ 13A5 FE 07        	CP 7
 190+ 13A7 38 2C        	JR C,NOTS
 191+ 13A9 DD 7E FE     	LD A,(IX+98-100) ;ALCO TS MARKER
 192+ 13AC FE 20        	CP #20
 193+ 13AE 28 25        	JR Z,NOTS
 194+ 13B0 21 2E 1C     	LD HL,VARS1
 195+ 13B3 11 B5 1C     	LD DE,VARS2
 196+ 13B6 01 87 00     	LD BC,VRS
 197+ 13B9 ED B0        	LDIR
 198+ 13BB FD CB 9E CE  	SET 1,(IY-100+VRS.ModNum)
 199+ 13BF 4F           	LD C,A
 200+ 13C0 87           	ADD A,A
 201+ 13C1 81           	ADD A,C
 202+ 13C2 D6 02        	SUB 2
 203+ 13C4 32 65 1A     	LD (TSSub),A
 204+ 13C7 18 03        	JR AlCoTS_
 205+ 13C9 CD 2D 15     TwoPT3s	CALL INITPT3
 206+ 13CC 3E 01        AlCoTS_	LD A,1
 207+ 13CE 32 2D 1C     	LD (is_ts),A
 208+ 13D1 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 209+ 13D5
 210+ 13D5 01 EA 16     NOTS	LD BC,PT3PD
 211+ 13D8 21 00 00     	LD HL,0
 212+ 13DB 11 F5 1B     	LD DE,PT3EMPTYORN
 213+ 13DE 18 48        	JR INITCOMMON
 214+ 13E0
 215+ 13E0 CD 65 15     I_PT2	CALL INITPT2
 216+ 13E3 21 CB 51     	LD HL,#51CB
 217+ 13E6 22 00 19     	LD (SamCnv),HL
 218+ 13E9 3E BB        	LD A,#BB
 219+ 13EB 32 CB 18     	LD (OrnCP),A
 220+ 13EE 32 F7 18     	LD (SamCP),A
 221+ 13F1 3E 7A        	LD A,#7A
 222+ 13F3 32 CE 18     	LD (OrnLD),A
 223+ 13F6 32 FA 18     	LD (SamLD),A
 224+ 13F9 3E 80        	LD A,#80
 225+ 13FB 32 F1 18     	LD (SamClc2),A
 226+ 13FE E1           	POP HL
 227+ 13FF 3E 05        	LD A,5
 228+ 1401 32 9E 17     	LD (Version),A
 229+ 1404 F5           	PUSH AF
 230+ 1405 3E 02        	LD A,2
 231+ 1407 F5           	PUSH AF
 232+ 1408
 233+ 1408 3A 00 13     	LD A,(START+10)
 234+ 140B E6 30        	AND 48
 235+ 140D 28 10        	JR Z,NOTS2
 236+ 140F
 237+ 140F FD 21 19 1D  	LD IY,VARS2+100
 238+ 1413 3E 01        	LD A,1
 239+ 1415 32 2D 1C     	LD (is_ts),A
 240+ 1418 FD CB 9E C6  	SET 0,(IY-100+VRS.ModNum)
 241+ 141C CD 65 15     	CALL INITPT2
 242+ 141F
 243+ 141F 01 24 16     NOTS2	LD BC,PT2PD
 244+ 1422 21 87 86     	LD HL,#8687
 245+ 1425 11 4B 1D     	LD DE,PT2EMPTYORN
 246+ 1428
 247+ 1428              INITCOMMON
 248+ 1428
 249+ 1428              	IF Basic
 250+ 1428 FD 21 3A 5C  	LD IY,#5C3A
 251+ 142C              	ENDIF
 252+ 142C
 253+ 142C ED 43 D5 15  	LD (PTDEC),BC
 254+ 1430 22 67 1A     	LD (PsCalc),HL
 255+ 1433 D5           	PUSH DE
 256+ 1434
 257+ 1434              ;note table data depacker
 258+ 1434              ;(c) Ivan Roshin
 259+ 1434 11 F8 1B     	LD DE,T_PACK
 260+ 1437 01 9D 1D     	LD BC,T1_+(2*49)-1
 261+ 143A 1A           TP_0	LD A,(DE)
 262+ 143B 13           	INC DE
 263+ 143C FE 1E        	CP 15*2
 264+ 143E 30 06        	JR NC,TP_1
 265+ 1440 67           	LD H,A
 266+ 1441 1A           	LD A,(DE)
 267+ 1442 6F           	LD L,A
 268+ 1443 13           	INC DE
 269+ 1444 18 07        	JR TP_2
 270+ 1446 D5           TP_1	PUSH DE
 271+ 1447 16 00        	LD D,0
 272+ 1449 5F           	LD E,A
 273+ 144A 19           	ADD HL,DE
 274+ 144B 19           	ADD HL,DE
 275+ 144C D1           	POP DE
 276+ 144D 7C           TP_2	LD A,H
 277+ 144E 02           	LD (BC),A
 278+ 144F 0B           	DEC BC
 279+ 1450 7D           	LD A,L
 280+ 1451 02           	LD (BC),A
 281+ 1452 0B           	DEC BC
player.asm(282): warning: value 0x1F0 is truncated to 8bit value: 0xF0
 282+ 1453 D6 F0        	SUB #F8*2
 283+ 1455 20 E3        	JR NZ,TP_0
 284+ 1457
 285+ 1457 3C           	INC A
 286+ 1458 32 9B 1C     	LD (VARS1+VRS.DelyCnt),A
 287+ 145B 32 22 1D     	LD (VARS2+VRS.DelyCnt),A
 288+ 145E 21 01 F0     	LD HL,#F001 ;H - CHP.Volume, L - CHP.NtSkCn
 289+ 1461 22 4C 1C     	LD (VARS1+VRS.ChanA+CHP.NtSkCn),HL
 290+ 1464 22 69 1C     	LD (VARS1+VRS.ChanB+CHP.NtSkCn),HL
 291+ 1467 22 86 1C     	LD (VARS1+VRS.ChanC+CHP.NtSkCn),HL
 292+ 146A 22 D3 1C     	LD (VARS2+VRS.ChanA+CHP.NtSkCn),HL
 293+ 146D 22 F0 1C     	LD (VARS2+VRS.ChanB+CHP.NtSkCn),HL
 294+ 1470 22 0D 1D     	LD (VARS2+VRS.ChanC+CHP.NtSkCn),HL
 295+ 1473 E1           	POP HL
 296+ 1474 22 3E 1C     	LD (VARS1+VRS.ChanA+CHP.OrnPtr),HL
 297+ 1477 22 5B 1C     	LD (VARS1+VRS.ChanB+CHP.OrnPtr),HL
 298+ 147A 22 78 1C     	LD (VARS1+VRS.ChanC+CHP.OrnPtr),HL
 299+ 147D 22 C5 1C     	LD (VARS2+VRS.ChanA+CHP.OrnPtr),HL
 300+ 1480 22 E2 1C     	LD (VARS2+VRS.ChanB+CHP.OrnPtr),HL
 301+ 1483 22 FF 1C     	LD (VARS2+VRS.ChanC+CHP.OrnPtr),HL
 302+ 1486
 303+ 1486 F1           	POP AF
 304+ 1487
 305+ 1487              ;NoteTableCreator (c) Ivan Roshin
 306+ 1487              ;A - NoteTableNumber*2+VersionForNoteTable
 307+ 1487              ;(xx1b - 3.xx..3.4r, xx0b - 3.4x..3.6x..VTII1.0)
 308+ 1487
 309+ 1487 21 A5 1B     	LD HL,NT_DATA
 310+ 148A 16 00        	LD D,0
 311+ 148C 87           	ADD A,A
 312+ 148D 5F           	LD E,A
 313+ 148E 19           	ADD HL,DE
 314+ 148F 5E           	LD E,(HL)
 315+ 1490 23           	INC HL
 316+ 1491 CB 3B        	SRL E
 317+ 1493 9F           	SBC A,A
 318+ 1494 E6 A7        	AND #A7 ;#00 (NOP) or #A7 (AND A)
 319+ 1496 32 BE 14     	LD (L3),A
 320+ 1499 EB           	EX DE,HL
 321+ 149A 01 3C 1D     	LD BC,T1_
 322+ 149D 09           	ADD HL,BC
 323+ 149E
 324+ 149E 1A           	LD A,(DE)
player.asm(325): warning: value 0x1BB5 is truncated to 8bit value: 0xB5
 325+ 149F C6 B5        	ADD A,T_
 326+ 14A1 4F           	LD C,A
 327+ 14A2 CE 1B        	ADC A,T_/256
 328+ 14A4 91           	SUB C
 329+ 14A5 47           	LD B,A
 330+ 14A6 C5           	PUSH BC
 331+ 14A7 11 2C 1E     	LD DE,NT_
 332+ 14AA D5           	PUSH DE
 333+ 14AB
 334+ 14AB 06 0C        	LD B,12
 335+ 14AD C5           L1	PUSH BC
 336+ 14AE 4E           	LD C,(HL)
 337+ 14AF 23           	INC HL
 338+ 14B0 E5           	PUSH HL
 339+ 14B1 46           	LD B,(HL)
 340+ 14B2
 341+ 14B2 D5           	PUSH DE
 342+ 14B3 EB           	EX DE,HL
 343+ 14B4 11 17 00     	LD DE,23
 344+ 14B7 DD 26 08     	LD IXH,8
 345+ 14BA
 346+ 14BA CB 38        L2	SRL B
 347+ 14BC CB 19        	RR C
 348+ 14BE 19           L3	DB #19	;AND A or NOP
 349+ 14BF 79           	LD A,C
 350+ 14C0 8A           	ADC A,D	;=ADC 0
 351+ 14C1 77           	LD (HL),A
 352+ 14C2 23           	INC HL
 353+ 14C3 78           	LD A,B
 354+ 14C4 8A           	ADC A,D
 355+ 14C5 77           	LD (HL),A
 356+ 14C6 19           	ADD HL,DE
 357+ 14C7 DD 25        	DEC IXH
 358+ 14C9 20 EF        	JR NZ,L2
 359+ 14CB
 360+ 14CB D1           	POP DE
 361+ 14CC 13           	INC DE
 362+ 14CD 13           	INC DE
 363+ 14CE E1           	POP HL
 364+ 14CF 23           	INC HL
 365+ 14D0 C1           	POP BC
 366+ 14D1 10 DA        	DJNZ L1
 367+ 14D3
 368+ 14D3 E1           	POP HL
 369+ 14D4 D1           	POP DE
 370+ 14D5
 371+ 14D5 7B           	LD A,E
player.asm(372): warning: value 0x1BC1 is truncated to 8bit value: 0xC1
 372+ 14D6 FE C1        	CP TCOLD_1
 373+ 14D8 20 05        	JR NZ,CORR_1
 374+ 14DA 3E FD        	LD A,#FD
 375+ 14DC 32 5A 1E     	LD (NT_+#2E),A
 376+ 14DF
 377+ 14DF 1A           CORR_1	LD A,(DE)
 378+ 14E0 A7           	AND A
 379+ 14E1 28 11        	JR Z,TC_EXIT
 380+ 14E3 1F           	RRA
 381+ 14E4 F5           	PUSH AF
 382+ 14E5 87           	ADD A,A
 383+ 14E6 4F           	LD C,A
 384+ 14E7 09           	ADD HL,BC
 385+ 14E8 F1           	POP AF
 386+ 14E9 30 02        	JR NC,CORR_2
 387+ 14EB 35           	DEC (HL)
 388+ 14EC 35           	DEC (HL)
 389+ 14ED 34           CORR_2	INC (HL)
 390+ 14EE A7           	AND A
 391+ 14EF ED 42        	SBC HL,BC
 392+ 14F1 13           	INC DE
 393+ 14F2 18 EB        	JR CORR_1
 394+ 14F4
 395+ 14F4              TC_EXIT
 396+ 14F4
 397+ 14F4 F1           	POP AF
 398+ 14F5
 399+ 14F5              ;VolTableCreator (c) Ivan Roshin
 400+ 14F5              ;A - VersionForVolumeTable (0..4 - 3.xx..3.4x;
 401+ 14F5              			   ;5.. - 2.x,3.5x..3.6x..VTII1.0)
 402+ 14F5
 403+ 14F5 FE 05        	CP 5
 404+ 14F7 21 11 00     	LD HL,#11
 405+ 14FA 54           	LD D,H
 406+ 14FB 5C           	LD E,H
 407+ 14FC 3E 17        	LD A,#17
 408+ 14FE 30 03        	JR NC,M1
 409+ 1500 2D           	DEC L
 410+ 1501 5D           	LD E,L
 411+ 1502 AF           	XOR A
 412+ 1503 32 14 15     M1      LD (M2),A
 413+ 1506
 414+ 1506 DD 21 3C 1D  	LD IX,VT_+16
 415+ 150A
 416+ 150A 0E 0F        	LD C,#F
 417+ 150C E5           INITV2  PUSH HL
 418+ 150D
 419+ 150D 19           	ADD HL,DE
 420+ 150E EB           	EX DE,HL
 421+ 150F ED 62        	SBC HL,HL
 422+ 1511
 423+ 1511 06 10        	LD B,#10
 424+ 1513 7D           INITV1  LD A,L
 425+ 1514 7D           M2      DB #7D
 426+ 1515 7C           	LD A,H
 427+ 1516 CE 00        	ADC A,0
 428+ 1518 DD 77 00     	LD (IX),A
 429+ 151B DD 23        	INC IX
 430+ 151D 19           	ADD HL,DE
 431+ 151E 10 F3        	DJNZ INITV1
 432+ 1520
 433+ 1520 E1           	POP HL
 434+ 1521 7B           	LD A,E
 435+ 1522 FE 77        	CP #77
 436+ 1524 20 01        	JR NZ,M3
 437+ 1526 1C           	INC E
 438+ 1527 0D           M3      DEC C
 439+ 1528 20 E2        	JR NZ,INITV2
 440+ 152A
 441+ 152A C3 72 1B     	JP ROUT
 442+ 152D
 443+ 152D CD A0 15     INITPT3	CALL SETMDAD
 444+ 1530 E5           	PUSH HL
 445+ 1531 11 64 00     	LD DE,100
 446+ 1534 19           	ADD HL,DE
 447+ 1535 7E           	LD A,(HL)
 448+ 1536 FD 77 08     	LD (IY-100+VRS.Delay),A
 449+ 1539 E5           	PUSH HL
 450+ 153A DD E1        	POP IX
 451+ 153C 19           	ADD HL,DE
 452+ 153D CD AE 15     	CALL SETCPPT
 453+ 1540 DD 5E 02     	LD E,(IX+102-100)
 454+ 1543 23           	INC HL
 455+ 1544
 456+ 1544              	IF CurPosCounter
 457+ 1544 ~            	LD (IY-100+VRS.PosSub),L
 458+ 1544              	ENDIF
 459+ 1544
 460+ 1544 19           	ADD HL,DE
 461+ 1545 CD B5 15     	CALL SETLPPT
 462+ 1548 D1           	POP DE
 463+ 1549 DD 6E 03     	LD L,(IX+103-100)
 464+ 154C DD 66 04     	LD H,(IX+104-100)
 465+ 154F 19           	ADD HL,DE
 466+ 1550 CD 99 15     	CALL SETPTPT
 467+ 1553 21 A9 00     	LD HL,169
 468+ 1556 19           	ADD HL,DE
 469+ 1557 CD A7 15     	CALL SETORPT
 470+ 155A 21 69 00     	LD HL,105
 471+ 155D 19           	ADD HL,DE
 472+ 155E
 473+ 155E FD 75 FA     SETSMPT LD (IY-100+VRS.SamPtrs),L
 474+ 1561 FD 74 FB     	LD (IY-100+VRS.SamPtrs+1),H
 475+ 1564 C9           	RET
 476+ 1565
 477+ 1565 7E           INITPT2	LD A,(HL)
 478+ 1566 FD 77 08     	LD (IY-100+VRS.Delay),A
 479+ 1569 E5           	PUSH HL
 480+ 156A E5           	PUSH HL
 481+ 156B E5           	PUSH HL
 482+ 156C 23           	INC HL
 483+ 156D 23           	INC HL
 484+ 156E 7E           	LD A,(HL)
 485+ 156F 23           	INC HL
 486+ 1570 CD 5E 15     	CALL SETSMPT
 487+ 1573 5E           	LD E,(HL)
 488+ 1574 23           	INC HL
 489+ 1575 56           	LD D,(HL)
 490+ 1576 E1           	POP HL
 491+ 1577 A7           	AND A
 492+ 1578 ED 52        	SBC HL,DE
 493+ 157A CD A0 15     	CALL SETMDAD
 494+ 157D E1           	POP HL
 495+ 157E 11 43 00     	LD DE,67
 496+ 1581 19           	ADD HL,DE
 497+ 1582 CD A7 15     	CALL SETORPT
 498+ 1585 1E 20        	LD E,32
 499+ 1587 19           	ADD HL,DE
 500+ 1588 4E           	LD C,(HL)
 501+ 1589 23           	INC HL
 502+ 158A 46           	LD B,(HL)
 503+ 158B 1E 1E        	LD E,30
 504+ 158D 19           	ADD HL,DE
 505+ 158E CD AE 15     	CALL SETCPPT
 506+ 1591 5F           	LD E,A
 507+ 1592 23           	INC HL
 508+ 1593
 509+ 1593              	IF CurPosCounter
 510+ 1593 ~            	LD (IY-100+VRS.PosSub),L
 511+ 1593              	ENDIF
 512+ 1593
 513+ 1593 19           	ADD HL,DE
 514+ 1594 CD B5 15     	CALL SETLPPT
 515+ 1597 E1           	POP HL
 516+ 1598 09           	ADD HL,BC
 517+ 1599
 518+ 1599 FD 75 FC     SETPTPT	LD (IY-100+VRS.PatsPtr),L
 519+ 159C FD 74 FD     	LD (IY-100+VRS.PatsPtr+1),H
 520+ 159F C9           	RET
 521+ 15A0
 522+ 15A0 FD 75 F6     SETMDAD	LD (IY-100+VRS.MODADDR),L
 523+ 15A3 FD 74 F7     	LD (IY-100+VRS.MODADDR+1),H
 524+ 15A6 C9           	RET
 525+ 15A7
 526+ 15A7 FD 75 F8     SETORPT	LD (IY-100+VRS.OrnPtrs),L
 527+ 15AA FD 74 F9     	LD (IY-100+VRS.OrnPtrs+1),H
 528+ 15AD C9           	RET
 529+ 15AE
 530+ 15AE FD 75 04     SETCPPT	LD (IY-100+VRS.CrPsPtr),L
 531+ 15B1 FD 74 05     	LD (IY-100+VRS.CrPsPtr+1),H
 532+ 15B4 C9           	RET
 533+ 15B5
 534+ 15B5 FD 75 06     SETLPPT	LD (IY-100+VRS.LPosPtr),L
 535+ 15B8 FD 74 07     	LD (IY-100+VRS.LPosPtr+1),H
 536+ 15BB C9           	RET
 537+ 15BC
 538+ 15BC FD 75 13     SETENBS	LD (IY-100+VRS.EnvBase),L
 539+ 15BF FD 74 14     	LD (IY-100+VRS.EnvBase+1),H
 540+ 15C2 C9           	RET
 541+ 15C3
 542+ 15C3 FD 75 0C     SETESLD	LD (IY-100+VRS.CurESld),L
 543+ 15C6 FD 74 0D     	LD (IY-100+VRS.CurESld+1),H
 544+ 15C9 C9           	RET
 545+ 15CA
 546+ 15CA FD E5        GETIX	PUSH IY
 547+ 15CC DD E1        	POP IX
 548+ 15CE DD 19        	ADD IX,DE
 549+ 15D0 C9           	RET
 550+ 15D1
 551+ 15D1 CD CA 15     PTDECOD CALL GETIX
 552+ 15D4              PTDEC	EQU $+1
 553+ 15D4 C3 C3 C3     	JP #C3C3
 554+ 15D7
 555+ 15D7              ;PT2 pattern decoder
 556+ 15D7 CD 6D 18     PD2_SAM	CALL SETSAM
 557+ 15DA 18 4A        	JR PD2_LOOP
 558+ 15DC
 559+ 15DC DD 77 08     PD2_EOff LD (IX-12+CHP.Env_En),A
 560+ 15DF 18 45        	JR PD2_LOOP
 561+ 15E1
 562+ 15E1 DD 36 08 10  PD2_ENV	LD (IX-12+CHP.Env_En),16
 563+ 15E5 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 564+ 15E8 0A           	LD A,(BC)
 565+ 15E9 03           	INC BC
 566+ 15EA 6F           	LD L,A
 567+ 15EB 0A           	LD A,(BC)
 568+ 15EC 03           	INC BC
 569+ 15ED 67           	LD H,A
 570+ 15EE CD BC 15     	CALL SETENBS
 571+ 15F1 18 33        	JR PD2_LOOP
 572+ 15F3
 573+ 15F3 CD 4E 18     PD2_ORN	CALL SETORN
 574+ 15F6 18 2E        	JR PD2_LOOP
 575+ 15F8
 576+ 15F8 3C           PD2_SKIP INC A
 577+ 15F9 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 578+ 15FC 18 28        	JR PD2_LOOP
 579+ 15FE
 580+ 15FE 0F           PD2_VOL	RRCA
 581+ 15FF 0F           	RRCA
 582+ 1600 0F           	RRCA
 583+ 1601 0F           	RRCA
 584+ 1602 DD 77 10     	LD (IX-12+CHP.Volume),A
 585+ 1605 18 1F        	JR PD2_LOOP
 586+ 1607
 587+ 1607 CD 1E 18     PD2_DEL	CALL C_DELAY
 588+ 160A 18 1A        	JR PD2_LOOP
 589+ 160C
 590+ 160C DD CB 09 D6  PD2_GLIS SET 2,(IX-12+CHP.Flags)
 591+ 1610 3C           	INC A
 592+ 1611 DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 593+ 1614 DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 594+ 1617 0A           	LD A,(BC)
 595+ 1618 03           	INC BC
 596+ 1619 DD 77 0B             LD (IX-12+CHP.TSlStp),A
 597+ 161C 87           	ADD A,A
 598+ 161D 9F           	SBC A,A
 599+ 161E DD 77 0C             LD (IX-12+CHP.TSlStp+1),A
 600+ 1621 37           	SCF
 601+ 1622 18 01        	JR PD2_LP2
 602+ 1624
 603+ 1624 A7           PT2PD	AND A
 604+ 1625
 605+ 1625 08           PD2_LP2	EX AF,AF'
 606+ 1626
 607+ 1626 0A           PD2_LOOP LD A,(BC)
 608+ 1627 03           	INC BC
 609+ 1628 C6 20        	ADD A,#20
 610+ 162A 28 3F        	JR Z,PD2_REL
 611+ 162C 38 A9        	JR C,PD2_SAM
 612+ 162E C6 60        	ADD A,96
 613+ 1630 38 3E        	JR C,PD2_NOTE
 614+ 1632 3C           	INC A
 615+ 1633 28 A7        	JR Z,PD2_EOff
 616+ 1635 C6 0F        	ADD A,15
 617+ 1637 CA 4D 17     	JP Z,PD_FIN
 618+ 163A 38 A5        	JR C,PD2_ENV
 619+ 163C C6 10        	ADD A,#10
 620+ 163E 38 B3        	JR C,PD2_ORN
 621+ 1640 C6 40        	ADD A,#40
 622+ 1642 38 B4        	JR C,PD2_SKIP
 623+ 1644 C6 10        	ADD A,#10
 624+ 1646 38 B6        	JR C,PD2_VOL
 625+ 1648 3C           	INC A
 626+ 1649 28 BC        	JR Z,PD2_DEL
 627+ 164B 3C           	INC A
 628+ 164C 28 BE        	JR Z,PD2_GLIS
 629+ 164E 3C           	INC A
 630+ 164F 28 0A        	JR Z,PD2_PORT
 631+ 1651 3C           	INC A
 632+ 1652 28 12        	JR Z,PD2_STOP
 633+ 1654 0A           	LD A,(BC)
 634+ 1655 03           	INC BC
 635+ 1656 DD 77 F7     	LD (IX-12+CHP.CrNsSl),A
 636+ 1659 18 CB        	JR PD2_LOOP
 637+ 165B
 638+ 165B DD CB 09 96  PD2_PORT RES 2,(IX-12+CHP.Flags)
 639+ 165F 0A           	LD A,(BC)
 640+ 1660 03           	INC BC
 641+ 1661 03           	INC BC ;ignoring precalc delta to right sound
 642+ 1662 03           	INC BC
 643+ 1663 37           	SCF
 644+ 1664 18 BF        	JR PD2_LP2
 645+ 1666
 646+ 1666 DD 77 F9     PD2_STOP LD (IX-12+CHP.TSlCnt),A
 647+ 1669 18 BB        	JR PD2_LOOP
 648+ 166B
 649+ 166B DD 77 09     PD2_REL	LD (IX-12+CHP.Flags),A
 650+ 166E 18 2C        	JR PD2_EXIT
 651+ 1670
 652+ 1670 6F           PD2_NOTE LD L,A
 653+ 1671 DD 7E 06     	LD A,(IX-12+CHP.Note)
 654+ 1674 32 87 17     	LD (PrNote+1),A
 655+ 1677 DD 75 06     	LD (IX-12+CHP.Note),L
 656+ 167A AF           	XOR A
 657+ 167B DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 658+ 167E DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 659+ 1682 08           	EX AF,AF'
 660+ 1683 30 16        	JR NC,NOGLIS2
 661+ 1685 DD CB 09 56  	BIT 2,(IX-12+CHP.Flags)
 662+ 1689 20 0C        	JR NZ,NOPORT2
 663+ 168B 32 AD 17     	LD (LoStep),A
 664+ 168E 87           	ADD A,A
 665+ 168F 9F           	SBC A,A
 666+ 1690 08           	EX AF,AF'
 667+ 1691 67           	LD H,A
 668+ 1692 6F           	LD L,A
 669+ 1693 3C           	INC A
 670+ 1694 CD 68 17     	CALL SETPORT
 671+ 1697 DD 36 F9 01  NOPORT2	LD (IX-12+CHP.TSlCnt),1
 672+ 169B AF           NOGLIS2	XOR A
 673+ 169C
 674+ 169C
 675+ 169C DD 77 F5     PD2_EXIT LD (IX-12+CHP.PsInSm),A
 676+ 169F DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 677+ 16A2 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 678+ 16A5 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 679+ 16A8 C3 4D 17     	JP PD_FIN
 680+ 16AB
 681+ 16AB              ;PT3 pattern decoder
 682+ 16AB DD 36 08 00  PD_OrSm	LD (IX-12+CHP.Env_En),0
 683+ 16AF CD 4E 18     	CALL SETORN
 684+ 16B2 0A           PD_SAM_	LD A,(BC)
 685+ 16B3 03           	INC BC
 686+ 16B4 0F           	RRCA
 687+ 16B5
 688+ 16B5 CD 6D 18     PD_SAM	CALL SETSAM
 689+ 16B8 18 3F        	JR PD_LOOP
 690+ 16BA
 691+ 16BA 0F           PD_VOL	RRCA
 692+ 16BB 0F           	RRCA
 693+ 16BC 0F           	RRCA
 694+ 16BD 0F           	RRCA
 695+ 16BE DD 77 10     	LD (IX-12+CHP.Volume),A
 696+ 16C1 18 39        	JR PD_LP2
 697+ 16C3
 698+ 16C3 DD 77 08     PD_EOff	LD (IX-12+CHP.Env_En),A
 699+ 16C6 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 700+ 16C9 18 31        	JR PD_LP2
 701+ 16CB
 702+ 16CB 3D           PD_SorE	DEC A
 703+ 16CC 20 07        	JR NZ,PD_ENV
 704+ 16CE 0A           	LD A,(BC)
 705+ 16CF 03           	INC BC
 706+ 16D0 DD 77 05     	LD (IX-12+CHP.NNtSkp),A
 707+ 16D3 18 27        	JR PD_LP2
 708+ 16D5
 709+ 16D5 CD 33 18     PD_ENV	CALL SETENV
 710+ 16D8 18 22        	JR PD_LP2
 711+ 16DA
 712+ 16DA CD 4E 18     PD_ORN	CALL SETORN
 713+ 16DD 18 1A        	JR PD_LOOP
 714+ 16DF
 715+ 16DF DD 77 08     PD_ESAM	LD (IX-12+CHP.Env_En),A
 716+ 16E2 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 717+ 16E5 C4 33 18     	CALL NZ,SETENV
 718+ 16E8 18 C8        	JR PD_SAM_
 719+ 16EA
 720+ 16EA DD 7E 06     PT3PD	LD A,(IX-12+CHP.Note)
 721+ 16ED 32 87 17     	LD (PrNote+1),A
 722+ 16F0 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 723+ 16F3 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 724+ 16F6 22 A4 17     	LD (PrSlide+1),HL
 725+ 16F9
 726+ 16F9 11 10 20     PD_LOOP	LD DE,#2010
 727+ 16FC 0A           PD_LP2	LD A,(BC)
 728+ 16FD 03           	INC BC
 729+ 16FE 83           	ADD A,E
 730+ 16FF 38 AA        	JR C,PD_OrSm
 731+ 1701 82           	ADD A,D
 732+ 1702 28 49        	JR Z,PD_FIN
 733+ 1704 38 AF        	JR C,PD_SAM
 734+ 1706 83           	ADD A,E
 735+ 1707 28 25        	JR Z,PD_REL
 736+ 1709 38 AF        	JR C,PD_VOL
 737+ 170B 83           	ADD A,E
 738+ 170C 28 B5        	JR Z,PD_EOff
 739+ 170E 38 BB        	JR C,PD_SorE
 740+ 1710 C6 60        	ADD A,96
 741+ 1712 38 20        	JR C,PD_NOTE
 742+ 1714 83           	ADD A,E
 743+ 1715 38 C3        	JR C,PD_ORN
 744+ 1717 82           	ADD A,D
 745+ 1718 38 0F        	JR C,PD_NOIS
 746+ 171A 83           	ADD A,E
 747+ 171B 38 C2        	JR C,PD_ESAM
 748+ 171D 87           	ADD A,A
 749+ 171E 5F           	LD E,A
 750+ 171F 21 A9 F7     	LD HL,SPCCOMS+#FF20-#2000
 751+ 1722 19           	ADD HL,DE
 752+ 1723 5E           	LD E,(HL)
 753+ 1724 23           	INC HL
 754+ 1725 56           	LD D,(HL)
 755+ 1726 D5           	PUSH DE
 756+ 1727 18 D0        	JR PD_LOOP
 757+ 1729
 758+ 1729 FD 77 10     PD_NOIS	LD (IY-100+VRS.Ns_Base),A
 759+ 172C 18 CE        	JR PD_LP2
 760+ 172E
 761+ 172E DD CB 09 86  PD_REL	RES 0,(IX-12+CHP.Flags)
 762+ 1732 18 08        	JR PD_RES
 763+ 1734
 764+ 1734 DD 77 06     PD_NOTE	LD (IX-12+CHP.Note),A
 765+ 1737 DD CB 09 C6  	SET 0,(IX-12+CHP.Flags)
 766+ 173B AF           	XOR A
 767+ 173C
 768+ 173C ED 73 4B 17  PD_RES	LD (PDSP_+1),SP
 769+ 1740 DD F9        	LD SP,IX
 770+ 1742 67           	LD H,A
 771+ 1743 6F           	LD L,A
 772+ 1744 E5           	PUSH HL
 773+ 1745 E5           	PUSH HL
 774+ 1746 E5           	PUSH HL
 775+ 1747 E5           	PUSH HL
 776+ 1748 E5           	PUSH HL
 777+ 1749 E5           	PUSH HL
 778+ 174A 31 31 31     PDSP_	LD SP,#3131
 779+ 174D
 780+ 174D DD 7E 05     PD_FIN	LD A,(IX-12+CHP.NNtSkp)
 781+ 1750 DD 77 0F     	LD (IX-12+CHP.NtSkCn),A
 782+ 1753 C9           	RET
 783+ 1754
 784+ 1754 0A           C_PORTM LD A,(BC)
 785+ 1755 03           	INC BC
 786+ 1756              ;SKIP PRECALCULATED TONE DELTA (BECAUSE
 787+ 1756              ;CANNOT BE RIGHT AFTER PT3 COMPILATION)
 788+ 1756 03           	INC BC
 789+ 1757 03           	INC BC
 790+ 1758 08           	EX AF,AF'
 791+ 1759 0A           	LD A,(BC) ;SIGNED TONE STEP
 792+ 175A 03           	INC BC
 793+ 175B 32 AD 17     	LD (LoStep),A
 794+ 175E 0A           	LD A,(BC)
 795+ 175F 03           	INC BC
 796+ 1760 A7           	AND A
 797+ 1761 08           	EX AF,AF'
 798+ 1762 DD 6E FA     	LD L,(IX-12+CHP.CrTnSl)
 799+ 1765 DD 66 FB     	LD H,(IX-12+CHP.CrTnSl+1)
 800+ 1768
 801+ 1768              ;Set portamento variables
 802+ 1768              ;A - Delay; A' - Hi(Step); ZF' - (A'=0); HL - CrTnSl
 803+ 1768
 804+ 1768 DD CB 09 96  SETPORT	RES 2,(IX-12+CHP.Flags)
 805+ 176C DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 806+ 176F DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 807+ 1772 E5           	PUSH HL
 808+ 1773 11 2C 1E     	LD DE,NT_
 809+ 1776 DD 7E 06     	LD A,(IX-12+CHP.Note)
 810+ 1779 DD 77 07     	LD (IX-12+CHP.SlToNt),A
 811+ 177C 87           	ADD A,A
 812+ 177D 6F           	LD L,A
 813+ 177E 26 00        	LD H,0
 814+ 1780 19           	ADD HL,DE
 815+ 1781 7E           	LD A,(HL)
 816+ 1782 23           	INC HL
 817+ 1783 66           	LD H,(HL)
 818+ 1784 6F           	LD L,A
 819+ 1785 E5           	PUSH HL
 820+ 1786 3E 3E        PrNote	LD A,#3E
 821+ 1788 DD 77 06     	LD (IX-12+CHP.Note),A
 822+ 178B 87           	ADD A,A
 823+ 178C 6F           	LD L,A
 824+ 178D 26 00        	LD H,0
 825+ 178F 19           	ADD HL,DE
 826+ 1790 5E           	LD E,(HL)
 827+ 1791 23           	INC HL
 828+ 1792 56           	LD D,(HL)
 829+ 1793 E1           	POP HL
 830+ 1794 ED 52        	SBC HL,DE
 831+ 1796 DD 75 0D     	LD (IX-12+CHP.TnDelt),L
 832+ 1799 DD 74 0E     	LD (IX-12+CHP.TnDelt+1),H
 833+ 179C D1           	POP DE
 834+ 179D              Version EQU $+1
 835+ 179D 3E 3E        	LD A,#3E
 836+ 179F FE 06        	CP 6
 837+ 17A1 38 09        	JR C,OLDPRTM ;Old 3xxx for PT v3.5-
 838+ 17A3 11 11 11     PrSlide	LD DE,#1111
 839+ 17A6 DD 73 FA     	LD (IX-12+CHP.CrTnSl),E
 840+ 17A9 DD 72 FB     	LD (IX-12+CHP.CrTnSl+1),D
 841+ 17AC              LoStep	EQU $+1
 842+ 17AC 3E 3E        OLDPRTM	LD A,#3E
 843+ 17AE 08           	EX AF,AF'
 844+ 17AF 28 01        	JR Z,NOSIG
 845+ 17B1 EB           	EX DE,HL
 846+ 17B2 ED 52        NOSIG	SBC HL,DE
 847+ 17B4 F2 BC 17     	JP P,SET_STP
 848+ 17B7 2F           	CPL
 849+ 17B8 08           	EX AF,AF'
 850+ 17B9 ED 44        	NEG
 851+ 17BB 08           	EX AF,AF'
 852+ 17BC DD 77 0C     SET_STP	LD (IX-12+CHP.TSlStp+1),A
 853+ 17BF 08           	EX AF,AF'
 854+ 17C0 DD 77 0B     	LD (IX-12+CHP.TSlStp),A
 855+ 17C3 DD 36 FE 00  	LD (IX-12+CHP.COnOff),0
 856+ 17C7 C9           	RET
 857+ 17C8
 858+ 17C8 DD CB 09 D6  C_GLISS	SET 2,(IX-12+CHP.Flags)
 859+ 17CC 0A           	LD A,(BC)
 860+ 17CD 03           	INC BC
 861+ 17CE DD 77 0A     	LD (IX-12+CHP.TnSlDl),A
 862+ 17D1 A7           	AND A
 863+ 17D2 20 07        	JR NZ,GL36
 864+ 17D4 3A 9E 17     	LD A,(Version) ;AlCo PT3.7+
 865+ 17D7 FE 07        	CP 7
 866+ 17D9 9F           	SBC A,A
 867+ 17DA 3C           	INC A
 868+ 17DB DD 77 F9     GL36	LD (IX-12+CHP.TSlCnt),A
 869+ 17DE 0A           	LD A,(BC)
 870+ 17DF 03           	INC BC
 871+ 17E0 08           	EX AF,AF'
 872+ 17E1 0A           	LD A,(BC)
 873+ 17E2 03           	INC BC
 874+ 17E3 18 D7        	JR SET_STP
 875+ 17E5
 876+ 17E5 0A           C_SMPOS	LD A,(BC)
 877+ 17E6 03           	INC BC
 878+ 17E7 DD 77 F5     	LD (IX-12+CHP.PsInSm),A
 879+ 17EA C9           	RET
 880+ 17EB
 881+ 17EB 0A           C_ORPOS	LD A,(BC)
 882+ 17EC 03           	INC BC
 883+ 17ED DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 884+ 17F0 C9           	RET
 885+ 17F1
 886+ 17F1 0A           C_VIBRT	LD A,(BC)
 887+ 17F2 03           	INC BC
 888+ 17F3 DD 77 FF     	LD (IX-12+CHP.OnOffD),A
 889+ 17F6 DD 77 FE     	LD (IX-12+CHP.COnOff),A
 890+ 17F9 0A           	LD A,(BC)
 891+ 17FA 03           	INC BC
 892+ 17FB DD 77 00     	LD (IX-12+CHP.OffOnD),A
 893+ 17FE AF           	XOR A
 894+ 17FF DD 77 F9     	LD (IX-12+CHP.TSlCnt),A
 895+ 1802 DD 77 FA     	LD (IX-12+CHP.CrTnSl),A
 896+ 1805 DD 77 FB     	LD (IX-12+CHP.CrTnSl+1),A
 897+ 1808 C9           	RET
 898+ 1809
 899+ 1809 0A           C_ENGLS	LD A,(BC)
 900+ 180A 03           	INC BC
 901+ 180B FD 77 0E     	LD (IY-100+VRS.Env_Del),A
 902+ 180E FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 903+ 1811 0A           	LD A,(BC)
 904+ 1812 03           	INC BC
 905+ 1813 6F           	LD L,A
 906+ 1814 0A           	LD A,(BC)
 907+ 1815 03           	INC BC
 908+ 1816 67           	LD H,A
 909+ 1817 FD 75 0A     	LD (IY-100+VRS.ESldAdd),L
 910+ 181A FD 74 0B     	LD (IY-100+VRS.ESldAdd+1),H
 911+ 181D C9           	RET
 912+ 181E
 913+ 181E 0A           C_DELAY	LD A,(BC)
 914+ 181F 03           	INC BC
 915+ 1820 FD 77 08     	LD (IY-100+VRS.Delay),A
 916+ 1823 21 B7 1C     	LD HL,VARS2+VRS.ModNum ;if AlCo_TS
 917+ 1826 CB 4E        	BIT 1,(HL)
 918+ 1828 C8           	RET Z
 919+ 1829 32 9A 1C     	LD (VARS1+VRS.Delay),A
 920+ 182C 32 9B 1C     	LD (VARS1+VRS.DelyCnt),A
 921+ 182F 32 21 1D     	LD (VARS2+VRS.Delay),A
 922+ 1832 C9           	RET
 923+ 1833
 924+ 1833 DD 73 08     SETENV	LD (IX-12+CHP.Env_En),E
 925+ 1836 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
 926+ 1839 0A           	LD A,(BC)
 927+ 183A 03           	INC BC
 928+ 183B 67           	LD H,A
 929+ 183C 0A           	LD A,(BC)
 930+ 183D 03           	INC BC
 931+ 183E 6F           	LD L,A
 932+ 183F CD BC 15     	CALL SETENBS
 933+ 1842 AF           	XOR A
 934+ 1843 DD 77 F4     	LD (IX-12+CHP.PsInOr),A
 935+ 1846 FD 77 0F     	LD (IY-100+VRS.CurEDel),A
 936+ 1849 67           	LD H,A
 937+ 184A 6F           	LD L,A
 938+ 184B C3 C3 15     	JP SETESLD
 939+ 184E
 940+ 184E 87           SETORN	ADD A,A
 941+ 184F 5F           	LD E,A
 942+ 1850 16 00        	LD D,0
 943+ 1852 DD 72 F4     	LD (IX-12+CHP.PsInOr),D
 944+ 1855 FD 6E F8     	LD L,(IY-100+VRS.OrnPtrs)
 945+ 1858 FD 66 F9     	LD H,(IY-100+VRS.OrnPtrs+1)
 946+ 185B 19           	ADD HL,DE
 947+ 185C 5E           	LD E,(HL)
 948+ 185D 23           	INC HL
 949+ 185E 56           	LD D,(HL)
 950+ 185F FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 951+ 1862 FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 952+ 1865 19           	ADD HL,DE
 953+ 1866 DD 75 01     	LD (IX-12+CHP.OrnPtr),L
 954+ 1869 DD 74 02     	LD (IX-12+CHP.OrnPtr+1),H
 955+ 186C C9           C_NOP	RET
 956+ 186D
 957+ 186D 87           SETSAM	ADD A,A
 958+ 186E 5F           	LD E,A
 959+ 186F 16 00        	LD D,0
 960+ 1871 FD 6E FA     	LD L,(IY-100+VRS.SamPtrs);
 961+ 1874 FD 66 FB     	LD H,(IY-100+VRS.SamPtrs+1);
 962+ 1877 19           	ADD HL,DE
 963+ 1878 5E           	LD E,(HL)
 964+ 1879 23           	INC HL
 965+ 187A 56           	LD D,(HL)
 966+ 187B FD 6E F6     	LD L,(IY-100+VRS.MODADDR)
 967+ 187E FD 66 F7     	LD H,(IY-100+VRS.MODADDR+1)
 968+ 1881 19           	ADD HL,DE
 969+ 1882 DD 75 03     	LD (IX-12+CHP.SamPtr),L
 970+ 1885 DD 74 04     	LD (IX-12+CHP.SamPtr+1),H
 971+ 1888 C9           	RET
 972+ 1889
 973+ 1889              ;ALL 16 ADDRESSES TO PROTECT FROM BROKEN PT3 MODULES
 974+ 1889 6C 18        SPCCOMS DW C_NOP
 975+ 188B C8 17        	DW C_GLISS
 976+ 188D 54 17        	DW C_PORTM
 977+ 188F E5 17        	DW C_SMPOS
 978+ 1891 EB 17        	DW C_ORPOS
 979+ 1893 F1 17        	DW C_VIBRT
 980+ 1895 6C 18        	DW C_NOP
 981+ 1897 6C 18        	DW C_NOP
 982+ 1899 09 18        	DW C_ENGLS
 983+ 189B 1E 18        	DW C_DELAY
 984+ 189D 6C 18        	DW C_NOP
 985+ 189F 6C 18        	DW C_NOP
 986+ 18A1 6C 18        	DW C_NOP
 987+ 18A3 6C 18        	DW C_NOP
 988+ 18A5 6C 18        	DW C_NOP
 989+ 18A7 6C 18        	DW C_NOP
 990+ 18A9
 991+ 18A9 CD CA 15     CHREGS	CALL GETIX
 992+ 18AC AF           	XOR A
 993+ 18AD 32 E9 1A     	LD (Ampl),A
 994+ 18B0 DD CB 15 46  	BIT 0,(IX+CHP.Flags)
 995+ 18B4 E5           	PUSH HL
 996+ 18B5 CA FC 19     	JP Z,CH_EXIT
 997+ 18B8 ED 73 46 19  	LD (CSP_+1),SP
 998+ 18BC DD 6E 0D     	LD L,(IX+CHP.OrnPtr)
 999+ 18BF DD 66 0E     	LD H,(IX+CHP.OrnPtr+1)
1000+ 18C2 F9           	LD SP,HL
1001+ 18C3 D1           	POP DE
1002+ 18C4 67           	LD H,A
1003+ 18C5 DD 7E 00     	LD A,(IX+CHP.PsInOr)
1004+ 18C8 6F           	LD L,A
1005+ 18C9 39           	ADD HL,SP
1006+ 18CA 3C           	INC A
1007+ 18CB              		;PT2	PT3
1008+ 18CB 3C           OrnCP	INC A	;CP E	CP D
1009+ 18CC 38 01        	JR C,CH_ORPS
1010+ 18CE 01           OrnLD	DB 1	;LD A,D	LD A,E
1011+ 18CF DD 77 00     CH_ORPS	LD (IX+CHP.PsInOr),A
1012+ 18D2 DD 7E 12     	LD A,(IX+CHP.Note)
1013+ 18D5 86           	ADD A,(HL)
1014+ 18D6 F2 DA 18     	JP P,CH_NTP
1015+ 18D9 AF           	XOR A
1016+ 18DA FE 60        CH_NTP	CP 96
1017+ 18DC 38 02        	JR C,CH_NOK
1018+ 18DE 3E 5F        	LD A,95
1019+ 18E0 87           CH_NOK	ADD A,A
1020+ 18E1 08           	EX AF,AF'
1021+ 18E2 DD 6E 0F     	LD L,(IX+CHP.SamPtr)
1022+ 18E5 DD 66 10     	LD H,(IX+CHP.SamPtr+1)
1023+ 18E8 F9           	LD SP,HL
1024+ 18E9 D1           	POP DE
1025+ 18EA 26 00        	LD H,0
1026+ 18EC DD 7E 01     	LD A,(IX+CHP.PsInSm)
1027+ 18EF 47           	LD B,A
1028+ 18F0 87           	ADD A,A
1029+ 18F1 87           SamClc2	ADD A,A ;or ADD A,B for PT2
1030+ 18F2 6F           	LD L,A
1031+ 18F3 39           	ADD HL,SP
1032+ 18F4 F9           	LD SP,HL
1033+ 18F5 78           	LD A,B
1034+ 18F6 3C           	INC A
1035+ 18F7              		;PT2	PT3
1036+ 18F7 3C           SamCP	INC A	;CP E	CP D
1037+ 18F8 38 01        	JR C,CH_SMPS
1038+ 18FA 01           SamLD	DB 1	;LD A,D	LD A,E
1039+ 18FB DD 77 01     CH_SMPS	LD (IX+CHP.PsInSm),A
1040+ 18FE C1           	POP BC
1041+ 18FF E1           	POP HL
1042+ 1900
1043+ 1900              ;Convert PT2 sample to PT3
1044+ 1900              		;PT2		PT3
1045+ 1900 E1           SamCnv	POP HL  ;BIT 2,C	JR e_
1046+ 1901 E1           	POP HL
1047+ 1902 60           	LD H,B
1048+ 1903 20 06        	JR NZ,$+8
1049+ 1905 EB           	EX DE,HL
1050+ 1906 A7           	AND A
1051+ 1907 ED 62        	SBC HL,HL
1052+ 1909 ED 52        	SBC HL,DE
1053+ 190B 51           	LD D,C
1054+ 190C CB 19        	RR C
1055+ 190E 9F           	SBC A,A
1056+ 190F 2F           	CPL
1057+ 1910 E6 3E        	AND #3E
1058+ 1912 CB 19        	RR C
1059+ 1914 CB 18        	RR B
1060+ 1916 A1           	AND C
1061+ 1917 4F           	LD C,A
1062+ 1918 78           	LD A,B
1063+ 1919 1F           	RRA
1064+ 191A 1F           	RRA
1065+ 191B CB 1A        	RR D
1066+ 191D 1F           	RRA
1067+ 191E E6 9F        	AND #9F
1068+ 1920 47           	LD B,A
1069+ 1921
1070+ 1921 DD 5E 08     e_	LD E,(IX+CHP.TnAcc)
1071+ 1924 DD 56 09     	LD D,(IX+CHP.TnAcc+1)
1072+ 1927 19           	ADD HL,DE
1073+ 1928 CB 70        	BIT 6,B
1074+ 192A 28 06        	JR Z,CH_NOAC
1075+ 192C DD 75 08     	LD (IX+CHP.TnAcc),L
1076+ 192F DD 74 09     	LD (IX+CHP.TnAcc+1),H
1077+ 1932 EB           CH_NOAC EX DE,HL
1078+ 1933 08           	EX AF,AF'
player.asm(1079): warning: value 0x1E2C is truncated to 8bit value: 0x2C
1079+ 1934 C6 2C        	ADD A,NT_
1080+ 1936 6F           	LD L,A
1081+ 1937 CE 1E        	ADC A,NT_/256
1082+ 1939 95           	SUB L
1083+ 193A 67           	LD H,A
1084+ 193B F9           	LD SP,HL
1085+ 193C E1           	POP HL
1086+ 193D 19           	ADD HL,DE
1087+ 193E DD 5E 06     	LD E,(IX+CHP.CrTnSl)
1088+ 1941 DD 56 07     	LD D,(IX+CHP.CrTnSl+1)
1089+ 1944 19           	ADD HL,DE
1090+ 1945 31 31 31     CSP_	LD SP,#3131
1091+ 1948 E3           	EX (SP),HL
1092+ 1949 AF           	XOR A
1093+ 194A DD B6 05     	OR (IX+CHP.TSlCnt)
1094+ 194D 28 3E        	JR Z,CH_AMP
1095+ 194F DD 35 05     	DEC (IX+CHP.TSlCnt)
1096+ 1952 20 39        	JR NZ,CH_AMP
1097+ 1954 DD 7E 16     	LD A,(IX+CHP.TnSlDl)
1098+ 1957 DD 77 05     	LD (IX+CHP.TSlCnt),A
1099+ 195A DD 6E 17     	LD L,(IX+CHP.TSlStp)
1100+ 195D DD 66 18     	LD H,(IX+CHP.TSlStp+1)
1101+ 1960 7C           	LD A,H
1102+ 1961 19           	ADD HL,DE
1103+ 1962 DD 75 06     	LD (IX+CHP.CrTnSl),L
1104+ 1965 DD 74 07     	LD (IX+CHP.CrTnSl+1),H
1105+ 1968 DD CB 15 56  	BIT 2,(IX+CHP.Flags)
1106+ 196C 20 1F        	JR NZ,CH_AMP
1107+ 196E DD 5E 19     	LD E,(IX+CHP.TnDelt)
1108+ 1971 DD 56 1A     	LD D,(IX+CHP.TnDelt+1)
1109+ 1974 A7           	AND A
1110+ 1975 28 01        	JR Z,CH_STPP
1111+ 1977 EB           	EX DE,HL
1112+ 1978 ED 52        CH_STPP SBC HL,DE
1113+ 197A FA 8D 19     	JP M,CH_AMP
1114+ 197D DD 7E 13     	LD A,(IX+CHP.SlToNt)
1115+ 1980 DD 77 12     	LD (IX+CHP.Note),A
1116+ 1983 AF           	XOR A
1117+ 1984 DD 77 05     	LD (IX+CHP.TSlCnt),A
1118+ 1987 DD 77 06     	LD (IX+CHP.CrTnSl),A
1119+ 198A DD 77 07     	LD (IX+CHP.CrTnSl+1),A
1120+ 198D DD 7E 02     CH_AMP	LD A,(IX+CHP.CrAmSl)
1121+ 1990 CB 79        	BIT 7,C
1122+ 1992 28 13        	JR Z,CH_NOAM
1123+ 1994 CB 71        	BIT 6,C
1124+ 1996 28 07        	JR Z,CH_AMIN
1125+ 1998 FE 0F        	CP 15
1126+ 199A 28 0B        	JR Z,CH_NOAM
1127+ 199C 3C           	INC A
1128+ 199D 18 05        	JR CH_SVAM
1129+ 199F FE F1        CH_AMIN	CP -15
1130+ 19A1 28 04        	JR Z,CH_NOAM
1131+ 19A3 3D           	DEC A
1132+ 19A4 DD 77 02     CH_SVAM	LD (IX+CHP.CrAmSl),A
1133+ 19A7 6F           CH_NOAM	LD L,A
1134+ 19A8 78           	LD A,B
1135+ 19A9 E6 0F        	AND 15
1136+ 19AB 85           	ADD A,L
1137+ 19AC F2 B0 19     	JP P,CH_APOS
1138+ 19AF AF           	XOR A
1139+ 19B0 FE 10        CH_APOS	CP 16
1140+ 19B2 38 02        	JR C,CH_VOL
1141+ 19B4 3E 0F        	LD A,15
1142+ 19B6 DD B6 1C     CH_VOL	OR (IX+CHP.Volume)
player.asm(1143): warning: value 0x1D2C is truncated to 8bit value: 0x2C
1143+ 19B9 C6 2C        	ADD A,VT_
1144+ 19BB 6F           	LD L,A
1145+ 19BC CE 1D        	ADC A,VT_/256
1146+ 19BE 95           	SUB L
1147+ 19BF 67           	LD H,A
1148+ 19C0 7E           	LD A,(HL)
1149+ 19C1 CB 41        CH_ENV	BIT 0,C
1150+ 19C3 20 03        	JR NZ,CH_NOEN
1151+ 19C5 DD B6 14     	OR (IX+CHP.Env_En)
1152+ 19C8 32 E9 1A     CH_NOEN	LD (Ampl),A
1153+ 19CB CB 78        	BIT 7,B
1154+ 19CD 79           	LD A,C
1155+ 19CE 28 1A        	JR Z,NO_ENSL
1156+ 19D0 17           	RLA
1157+ 19D1 17           	RLA
1158+ 19D2 CB 2F        	SRA A
1159+ 19D4 CB 2F        	SRA A
1160+ 19D6 CB 2F        	SRA A
1161+ 19D8 DD 86 04     	ADD A,(IX+CHP.CrEnSl) ;SEE COMMENT BELOW
1162+ 19DB CB 68        	BIT 5,B
1163+ 19DD 28 03        	JR Z,NO_ENAC
1164+ 19DF DD 77 04     	LD (IX+CHP.CrEnSl),A
1165+ 19E2 FD 86 12     NO_ENAC	ADD A,(IY-100+VRS.AddToEn) ;BUG IN PT3 - NEED WORD HERE
1166+ 19E5 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1167+ 19E8 18 0E        	JR CH_MIX
1168+ 19EA 1F           NO_ENSL RRA
1169+ 19EB DD 86 03     	ADD A,(IX+CHP.CrNsSl)
1170+ 19EE FD 77 11     	LD (IY-100+VRS.AddToNs),A
1171+ 19F1 CB 68        	BIT 5,B
1172+ 19F3 28 03        	JR Z,CH_MIX
1173+ 19F5 DD 77 03     	LD (IX+CHP.CrNsSl),A
1174+ 19F8 78           CH_MIX	LD A,B
1175+ 19F9 1F           	RRA
1176+ 19FA E6 48        	AND #48
1177+ 19FC FD B6 1C     CH_EXIT	OR (IY-100+VRS.AYREGS+Mixer)
1178+ 19FF 0F           	RRCA
1179+ 1A00 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1180+ 1A03 E1           	POP HL
1181+ 1A04 AF           	XOR A
1182+ 1A05 DD B6 0A     	OR (IX+CHP.COnOff)
1183+ 1A08 C8           	RET Z
1184+ 1A09 DD 35 0A     	DEC (IX+CHP.COnOff)
1185+ 1A0C C0           	RET NZ
1186+ 1A0D DD AE 15     	XOR (IX+CHP.Flags)
1187+ 1A10 DD 77 15     	LD (IX+CHP.Flags),A
1188+ 1A13 1F           	RRA
1189+ 1A14 DD 7E 0B     	LD A,(IX+CHP.OnOffD)
1190+ 1A17 38 03        	JR C,CH_ONDL
1191+ 1A19 DD 7E 0C     	LD A,(IX+CHP.OffOnD)
1192+ 1A1C DD 77 0A     CH_ONDL	LD (IX+CHP.COnOff),A
1193+ 1A1F C9           	RET
1194+ 1A20
1195+ 1A20 AF           PLAY_	XOR A
1196+ 1A21 FD 77 12     	LD (IY-100+VRS.AddToEn),A
1197+ 1A24 FD 77 1C     	LD (IY-100+VRS.AYREGS+Mixer),A
1198+ 1A27 3D           	DEC A
1199+ 1A28 FD 77 22     	LD (IY-100+VRS.AYREGS+EnvTp),A
1200+ 1A2B FD 35 09     	DEC (IY-100+VRS.DelyCnt)
1201+ 1A2E C2 D6 1A     	JP NZ,PL2
1202+ 1A31 FD 35 BA     	DEC (IY-100+VRS.ChanA+CHP.NtSkCn)
1203+ 1A34 20 6C        	JR NZ,PL1B
1204+ 1A36 FD 4E FE     	LD C,(IY-100+VRS.AdInPtA)
1205+ 1A39 FD 46 FF     	LD B,(IY-100+VRS.AdInPtA+1)
1206+ 1A3C 0A           	LD A,(BC)
1207+ 1A3D A7           	AND A
1208+ 1A3E 20 56        	JR NZ,PL1A
1209+ 1A40 57           	LD D,A
1210+ 1A41 FD 77 10     	LD (IY-100+VRS.Ns_Base),A
1211+ 1A44 FD 6E 04     	LD L,(IY-100+VRS.CrPsPtr)
1212+ 1A47 FD 66 05     	LD H,(IY-100+VRS.CrPsPtr+1)
1213+ 1A4A 23           	INC HL
1214+ 1A4B 7E           	LD A,(HL)
1215+ 1A4C 3C           	INC A
1216+ 1A4D 20 0B        	JR NZ,PLNLP
1217+ 1A4F
1218+ 1A4F              	IF LoopChecker
1219+ 1A4F CD 01 13     	CALL CHECKLP
1220+ 1A52              	ENDIF
1221+ 1A52
1222+ 1A52 FD 6E 06     	LD L,(IY-100+VRS.LPosPtr)
1223+ 1A55 FD 66 07     	LD H,(IY-100+VRS.LPosPtr+1)
1224+ 1A58 7E           	LD A,(HL)
1225+ 1A59 3C           	INC A
1226+ 1A5A CD AE 15     PLNLP	CALL SETCPPT
1227+ 1A5D 3D           	DEC A
1228+ 1A5E FD CB 9E 4E  	BIT 1,(IY-100+VRS.ModNum)
1229+ 1A62 28 03        	JR Z,NoAlCo
1230+ 1A64              TSSub	EQU $+1
1231+ 1A64 D6 D6        	SUB #D6
1232+ 1A66 2F           	CPL
1233+ 1A67              NoAlCo
1234+ 1A67              		;PT2		PT3
1235+ 1A67 3D           PsCalc	DEC A	;ADD A,A	NOP
1236+ 1A68 3D           	DEC A	;ADD A,(HL)	NOP
1237+ 1A69 87           	ADD A,A
1238+ 1A6A 5F           	LD E,A
1239+ 1A6B CB 12        	RL D
1240+ 1A6D
1241+ 1A6D              	IF CurPosCounter
1242+ 1A6D ~            	LD A,L
1243+ 1A6D ~            	SUB (IY-100+VRS.PosSub)
1244+ 1A6D ~            	LD (IY-100+VRS.CurPos),A
1245+ 1A6D              	ENDIF
1246+ 1A6D
1247+ 1A6D FD 6E FC     	LD L,(IY-100+VRS.PatsPtr)
1248+ 1A70 FD 66 FD     	LD H,(IY-100+VRS.PatsPtr+1)
1249+ 1A73 19           	ADD HL,DE
1250+ 1A74 FD 5E F6     	LD E,(IY-100+VRS.MODADDR)
1251+ 1A77 FD 56 F7     	LD D,(IY-100+VRS.MODADDR+1)
1252+ 1A7A ED 73 94 1A  	LD (PSP_+1),SP
1253+ 1A7E F9           	LD SP,HL
1254+ 1A7F E1           	POP HL
1255+ 1A80 19           	ADD HL,DE
1256+ 1A81 44           	LD B,H
1257+ 1A82 4D           	LD C,L
1258+ 1A83 E1           	POP HL
1259+ 1A84 19           	ADD HL,DE
1260+ 1A85 FD 75 00     	LD (IY-100+VRS.AdInPtB),L
1261+ 1A88 FD 74 01     	LD (IY-100+VRS.AdInPtB+1),H
1262+ 1A8B E1           	POP HL
1263+ 1A8C 19           	ADD HL,DE
1264+ 1A8D FD 75 02     	LD (IY-100+VRS.AdInPtC),L
1265+ 1A90 FD 74 03     	LD (IY-100+VRS.AdInPtC+1),H
1266+ 1A93 31 31 31     PSP_	LD SP,#3131
1267+ 1A96 11 AB FF     PL1A	LD DE,VRS.ChanA+12-100
1268+ 1A99 CD D1 15     	CALL PTDECOD
1269+ 1A9C FD 71 FE     	LD (IY-100+VRS.AdInPtA),C
1270+ 1A9F FD 70 FF     	LD (IY-100+VRS.AdInPtA+1),B
1271+ 1AA2
1272+ 1AA2 FD 35 D7     PL1B	DEC (IY-100+VRS.ChanB+CHP.NtSkCn)
1273+ 1AA5 20 12        	JR NZ,PL1C
1274+ 1AA7 11 C8 FF     	LD DE,VRS.ChanB+12-100
1275+ 1AAA FD 4E 00     	LD C,(IY-100+VRS.AdInPtB)
1276+ 1AAD FD 46 01     	LD B,(IY-100+VRS.AdInPtB+1)
1277+ 1AB0 CD D1 15     	CALL PTDECOD
1278+ 1AB3 FD 71 00     	LD (IY-100+VRS.AdInPtB),C
1279+ 1AB6 FD 70 01     	LD (IY-100+VRS.AdInPtB+1),B
1280+ 1AB9
1281+ 1AB9 FD 35 F4     PL1C	DEC (IY-100+VRS.ChanC+CHP.NtSkCn)
1282+ 1ABC 20 12        	JR NZ,PL1D
1283+ 1ABE 11 E5 FF     	LD DE,VRS.ChanC+12-100
1284+ 1AC1 FD 4E 02     	LD C,(IY-100+VRS.AdInPtC)
1285+ 1AC4 FD 46 03     	LD B,(IY-100+VRS.AdInPtC+1)
1286+ 1AC7 CD D1 15     	CALL PTDECOD
1287+ 1ACA FD 71 02     	LD (IY-100+VRS.AdInPtC),C
1288+ 1ACD FD 70 03     	LD (IY-100+VRS.AdInPtC+1),B
1289+ 1AD0
1290+ 1AD0 FD 7E 08     PL1D	LD A,(IY-100+VRS.Delay)
1291+ 1AD3 FD 77 09     	LD (IY-100+VRS.DelyCnt),A
1292+ 1AD6
1293+ 1AD6 11 9F FF     PL2	LD DE,VRS.ChanA-100
1294+ 1AD9 FD 6E 15     	LD L,(IY-100+VRS.AYREGS+TonA)
1295+ 1ADC FD 66 16     	LD H,(IY-100+VRS.AYREGS+TonA+1)
1296+ 1ADF CD A9 18     	CALL CHREGS
1297+ 1AE2 FD 75 15     	LD (IY-100+VRS.AYREGS+TonA),L
1298+ 1AE5 FD 74 16     	LD (IY-100+VRS.AYREGS+TonA+1),H
1299+ 1AE8              Ampl	EQU $+1
1300+ 1AE8 3E 3E        	LD A,#3E
1301+ 1AEA FD 77 1D     	LD (IY-100+VRS.AYREGS+AmplA),A
1302+ 1AED 11 BC FF     	LD DE,VRS.ChanB-100
1303+ 1AF0 FD 6E 17     	LD L,(IY-100+VRS.AYREGS+TonB)
1304+ 1AF3 FD 66 18     	LD H,(IY-100+VRS.AYREGS+TonB+1)
1305+ 1AF6 CD A9 18     	CALL CHREGS
1306+ 1AF9 FD 75 17     	LD (IY-100+VRS.AYREGS+TonB),L
1307+ 1AFC FD 74 18     	LD (IY-100+VRS.AYREGS+TonB+1),H
1308+ 1AFF 3A E9 1A     	LD A,(Ampl)
1309+ 1B02 FD 77 1E     	LD (IY-100+VRS.AYREGS+AmplB),A
1310+ 1B05 11 D9 FF     	LD DE,VRS.ChanC-100
1311+ 1B08 FD 6E 19     	LD L,(IY-100+VRS.AYREGS+TonC)
1312+ 1B0B FD 66 1A     	LD H,(IY-100+VRS.AYREGS+TonC+1)
1313+ 1B0E CD A9 18     	CALL CHREGS
1314+ 1B11 FD 75 19     	LD (IY-100+VRS.AYREGS+TonC),L
1315+ 1B14 FD 74 1A     	LD (IY-100+VRS.AYREGS+TonC+1),H
1316+ 1B17 3A E9 1A     	LD A,(Ampl)
1317+ 1B1A FD 77 1F     	LD (IY-100+VRS.AYREGS+AmplC),A
1318+ 1B1D
1319+ 1B1D FD 7E 10     	LD A,(IY-100+VRS.Ns_Base)
1320+ 1B20 FD 86 11     	ADD (IY-100+VRS.AddToNs)
1321+ 1B23 FD 77 1B     	LD (IY-100+VRS.AYREGS+Noise),A
1322+ 1B26
1323+ 1B26 FD 7E 12     	LD A,(IY-100+VRS.AddToEn)
1324+ 1B29 5F           	LD E,A
1325+ 1B2A 87           	ADD A,A
1326+ 1B2B 9F           	SBC A,A
1327+ 1B2C 57           	LD D,A
1328+ 1B2D FD 6E 13     	LD L,(IY-100+VRS.EnvBase)
1329+ 1B30 FD 66 14     	LD H,(IY-100+VRS.EnvBase+1)
1330+ 1B33 19           	ADD HL,DE
1331+ 1B34 FD 5E 0C     	LD E,(IY-100+VRS.CurESld)
1332+ 1B37 FD 56 0D     	LD D,(IY-100+VRS.CurESld+1)
1333+ 1B3A 19           	ADD HL,DE
1334+ 1B3B FD 75 20     	LD (IY-100+VRS.AYREGS+Env),L
1335+ 1B3E FD 74 21     	LD (IY-100+VRS.AYREGS+Env+1),H
1336+ 1B41
1337+ 1B41 AF           	XOR A
1338+ 1B42 FD B6 0F     	OR (IY-100+VRS.CurEDel)
1339+ 1B45 C8           	RET Z
1340+ 1B46 FD 35 0F     	DEC (IY-100+VRS.CurEDel)
1341+ 1B49 C0           	RET NZ
1342+ 1B4A FD 7E 0E     	LD A,(IY-100+VRS.Env_Del)
1343+ 1B4D FD 77 0F     	LD (IY-100+VRS.CurEDel),A
1344+ 1B50 FD 6E 0A     	LD L,(IY-100+VRS.ESldAdd)
1345+ 1B53 FD 66 0B     	LD H,(IY-100+VRS.ESldAdd+1)
1346+ 1B56 19           	ADD HL,DE
1347+ 1B57 C3 C3 15     	JP SETESLD
1348+ 1B5A
1349+ 1B5A FD 21 92 1C  PLAY    LD IY,VARS1+100
1350+ 1B5E CD 20 1A     	CALL PLAY_
1351+ 1B61 3A 2D 1C     	LD A,(is_ts)
1352+ 1B64 A7           	AND A
1353+ 1B65 28 07        	JR Z,PL_nts
1354+ 1B67 FD 21 19 1D  	LD IY,VARS2+100
1355+ 1B6B CD 20 1A     	CALL PLAY_
1356+ 1B6E              PL_nts
1357+ 1B6E              	IF Basic
1358+ 1B6E FD 21 3A 5C  	LD IY,#5C3A
1359+ 1B72              	ENDIF
1360+ 1B72
1361+ 1B72 01 FD FF     ROUT	LD BC,#FFFD
1362+ 1B75 3A 2D 1C     	LD A,(is_ts)
1363+ 1B78 A7           	AND A
1364+ 1B79 28 02        	JR Z,r_nts ;keep old standard
1365+ 1B7B ED 41        	OUT (C),B
1366+ 1B7D 08           r_nts	EX AF,AF'
1367+ 1B7E
1368+ 1B7E              	IF ACBBAC
1369+ 1B7E ~            	LD IX,VARS1+VRS.AYREGS
1370+ 1B7E              	ELSE
1371+ 1B7E 21 A7 1C     	LD HL,VARS1+VRS.AYREGS
1372+ 1B81              	ENDIF
1373+ 1B81
1374+ 1B81 CD 8D 1B     	CALL ROUT_
1375+ 1B84 08           	EX AF,AF'
1376+ 1B85 C8           	RET Z
1377+ 1B86 42           	LD B,D
1378+ 1B87 2F           	CPL
1379+ 1B88 ED 79        	OUT (C),A
1380+ 1B8A
1381+ 1B8A              	IF ACBBAC
1382+ 1B8A ~            	LD IX,VARS2+VRS.AYREGS
1383+ 1B8A              	ELSE
1384+ 1B8A 21 2E 1D     	LD HL,VARS2+VRS.AYREGS
1385+ 1B8D              	ENDIF
1386+ 1B8D
1387+ 1B8D              ROUT_
1388+ 1B8D              	IF ACBBAC
1389+ 1B8D ~            	LD A,(SETUP)
1390+ 1B8D ~            	AND 12
1391+ 1B8D ~            	JR Z,ABC
1392+ 1B8D ~            	ADD A,CHTABLE
1393+ 1B8D ~            	LD E,A
1394+ 1B8D ~            	ADC A,CHTABLE/256
1395+ 1B8D ~            	SUB E
1396+ 1B8D ~            	LD D,A
1397+ 1B8D ~            	LD B,0
1398+ 1B8D ~            	PUSH IX
1399+ 1B8D ~            	POP HL
1400+ 1B8D ~            	LD A,(DE)
1401+ 1B8D ~            	INC DE
1402+ 1B8D ~            	LD C,A
1403+ 1B8D ~            	ADD HL,BC
1404+ 1B8D ~            	LD A,(IX+TonB)
1405+ 1B8D ~            	LD C,(HL)
1406+ 1B8D ~            	LD (IX+TonB),C
1407+ 1B8D ~            	LD (HL),A
1408+ 1B8D ~            	INC HL
1409+ 1B8D ~            	LD A,(IX+TonB+1)
1410+ 1B8D ~            	LD C,(HL)
1411+ 1B8D ~            	LD (IX+TonB+1),C
1412+ 1B8D ~            	LD (HL),A
1413+ 1B8D ~            	LD A,(DE)
1414+ 1B8D ~            	INC DE
1415+ 1B8D ~            	LD C,A
1416+ 1B8D ~            	ADD HL,BC
1417+ 1B8D ~            	LD A,(IX+AmplB)
1418+ 1B8D ~            	LD C,(HL)
1419+ 1B8D ~            	LD (IX+AmplB),C
1420+ 1B8D ~            	LD (HL),A
1421+ 1B8D ~            	LD A,(DE)
1422+ 1B8D ~            	INC DE
1423+ 1B8D ~            	LD (RxCA1),A
1424+ 1B8D ~            	XOR 8
1425+ 1B8D ~            	LD (RxCA2),A
1426+ 1B8D ~            	LD A,(DE)
1427+ 1B8D ~            	AND (IX+Mixer)
1428+ 1B8D ~            	LD E,A
1429+ 1B8D ~            	LD A,(IX+Mixer)
1430+ 1B8D ~            RxCA1	DB #E6
1431+ 1B8D ~            	AND %010010
1432+ 1B8D ~            	OR E
1433+ 1B8D ~            	LD E,A
1434+ 1B8D ~            	LD A,(IX+Mixer)
1435+ 1B8D ~            	AND %010010
1436+ 1B8D ~            RxCA2	OR E
1437+ 1B8D ~            	OR E
1438+ 1B8D ~            	LD (IX+Mixer),A
1439+ 1B8D ~            ABC
1440+ 1B8D              	ENDIF
1441+ 1B8D
1442+ 1B8D AF           	XOR A
1443+ 1B8E 11 BF FF     	LD DE,#FFBF
1444+ 1B91
1445+ 1B91              	IF ACBBAC
1446+ 1B91 ~            	LD BC,#FFFD
1447+ 1B91 ~            	PUSH IX
1448+ 1B91 ~            	POP HL
1449+ 1B91              	ENDIF
1450+ 1B91
1451+ 1B91 ED 79        LOUT	OUT (C),A
1452+ 1B93 43           	LD B,E
1453+ 1B94 ED A3        	OUTI
1454+ 1B96 42           	LD B,D
1455+ 1B97 3C           	INC A
1456+ 1B98 FE 0D        	CP 13
1457+ 1B9A 20 F5        	JR NZ,LOUT
1458+ 1B9C ED 79        	OUT (C),A
1459+ 1B9E 7E           	LD A,(HL)
1460+ 1B9F A7           	AND A
1461+ 1BA0 F8           	RET M
1462+ 1BA1 43           	LD B,E
1463+ 1BA2 ED 79        	OUT (C),A
1464+ 1BA4 C9           	RET
1465+ 1BA5
1466+ 1BA5              	IF ACBBAC
1467+ 1BA5 ~            CHTABLE	EQU $-4
1468+ 1BA5 ~            	DB 4,5,15,%001001,0,7,7,%100100
1469+ 1BA5              	ENDIF
1470+ 1BA5
1471+ 1BA5 64           NT_DATA	DB (T_NEW_0-T1_)*2
1472+ 1BA6 2A           	DB TCNEW_0-T_
1473+ 1BA7 65           	DB (T_OLD_0-T1_)*2+1
1474+ 1BA8 00           	DB TCOLD_0-T_
1475+ 1BA9 01           	DB (T_NEW_1-T1_)*2+1
1476+ 1BAA 0C           	DB TCNEW_1-T_
1477+ 1BAB 01           	DB (T_OLD_1-T1_)*2+1
1478+ 1BAC 0C           	DB TCOLD_1-T_
1479+ 1BAD 94           	DB (T_NEW_2-T1_)*2
1480+ 1BAE 35           	DB TCNEW_2-T_
1481+ 1BAF 30           	DB (T_OLD_2-T1_)*2
1482+ 1BB0 0E           	DB TCOLD_2-T_
1483+ 1BB1 60           	DB (T_NEW_3-T1_)*2
1484+ 1BB2 20           	DB TCNEW_3-T_
1485+ 1BB3 60           	DB (T_OLD_3-T1_)*2
1486+ 1BB4 21           	DB TCOLD_3-T_
1487+ 1BB5
1488+ 1BB5              T_
1489+ 1BB5
1490+ 1BB5 01 05 09 0B  TCOLD_0	DB #00+1,#04+1,#08+1,#0A+1,#0C+1,#0E+1,#12+1,#14+1
1490+ 1BB9 0D 0F 13 15
1491+ 1BBD 19 25 3D 00  	DB #18+1,#24+1,#3C+1,0
1492+ 1BC1 5D 00        TCOLD_1	DB #5C+1,0
1493+ 1BC3 31 37 4D 53  TCOLD_2	DB #30+1,#36+1,#4C+1,#52+1,#5E+1,#70+1,#82,#8C,#9C
1493+ 1BC7 5F 71 82 8C
1493+ 1BCB 9C
1494+ 1BCC 9E A0 A6 A8  	DB #9E,#A0,#A6,#A8,#AA,#AC,#AE,#AE,0
1494+ 1BD0 AA AC AE AE
1494+ 1BD4 00
1495+ 1BD5 57           TCNEW_3	DB #56+1
1496+ 1BD6 1F 23 25 29  TCOLD_3	DB #1E+1,#22+1,#24+1,#28+1,#2C+1,#2E+1,#32+1,#BE+1,0
1496+ 1BDA 2D 2F 33 BF
1496+ 1BDE 00
1497+ 1BDF 1D 21 23 27  TCNEW_0	DB #1C+1,#20+1,#22+1,#26+1,#2A+1,#2C+1,#30+1,#54+1
1497+ 1BE3 2B 2D 31 55
1498+ 1BE7 BD BF 00     	DB #BC+1,#BE+1,0
1499+ 1BEA              TCNEW_1 EQU TCOLD_1
1500+ 1BEA 1B 21 25 29  TCNEW_2	DB #1A+1,#20+1,#24+1,#28+1,#2A+1,#3A+1,#4C+1,#5E+1
1500+ 1BEE 2B 3B 4D 5F
1501+ 1BF2 BB BD BF 00  	DB #BA+1,#BC+1,#BE+1,0
1502+ 1BF6
1503+ 1BF6              PT3EMPTYORN EQU $-1
1504+ 1BF6 01 00        	DB 1,0
1505+ 1BF8
1506+ 1BF8              ;first 12 values of tone tables (packed)
1507+ 1BF8
player.asm(1508): warning: value 0xDD8 is truncated to 8bit value: 0xD8
1508+ 1BF8 0D D8        T_PACK	DB #06EC*2/256,#06EC*2
1509+ 1BFA 69           	DB #0755-#06EC
1510+ 1BFB 70           	DB #07C5-#0755
1511+ 1BFC 76           	DB #083B-#07C5
1512+ 1BFD 7D           	DB #08B8-#083B
1513+ 1BFE 85           	DB #093D-#08B8
1514+ 1BFF 8D           	DB #09CA-#093D
1515+ 1C00 95           	DB #0A5F-#09CA
1516+ 1C01 9D           	DB #0AFC-#0A5F
1517+ 1C02 A8           	DB #0BA4-#0AFC
1518+ 1C03 B1           	DB #0C55-#0BA4
1519+ 1C04 BB           	DB #0D10-#0C55
player.asm(1520): warning: value 0xCDA is truncated to 8bit value: 0xDA
1520+ 1C05 0C DA        	DB #066D*2/256,#066D*2
1521+ 1C07 62           	DB #06CF-#066D
1522+ 1C08 68           	DB #0737-#06CF
1523+ 1C09 6D           	DB #07A4-#0737
1524+ 1C0A 75           	DB #0819-#07A4
1525+ 1C0B 7B           	DB #0894-#0819
1526+ 1C0C 83           	DB #0917-#0894
1527+ 1C0D 8A           	DB #09A1-#0917
1528+ 1C0E 92           	DB #0A33-#09A1
1529+ 1C0F 9C           	DB #0ACF-#0A33
1530+ 1C10 A4           	DB #0B73-#0ACF
1531+ 1C11 AF           	DB #0C22-#0B73
1532+ 1C12 B8           	DB #0CDA-#0C22
player.asm(1533): warning: value 0xE08 is truncated to 8bit value: 0x08
1533+ 1C13 0E 08        	DB #0704*2/256,#0704*2
1534+ 1C15 6A           	DB #076E-#0704
1535+ 1C16 72           	DB #07E0-#076E
1536+ 1C17 78           	DB #0858-#07E0
1537+ 1C18 7E           	DB #08D6-#0858
1538+ 1C19 86           	DB #095C-#08D6
1539+ 1C1A 90           	DB #09EC-#095C
1540+ 1C1B 96           	DB #0A82-#09EC
1541+ 1C1C A0           	DB #0B22-#0A82
1542+ 1C1D AA           	DB #0BCC-#0B22
1543+ 1C1E B4           	DB #0C80-#0BCC
1544+ 1C1F BE           	DB #0D3E-#0C80
player.asm(1545): warning: value 0xFC0 is truncated to 8bit value: 0xC0
1545+ 1C20 0F C0        	DB #07E0*2/256,#07E0*2
1546+ 1C22 78           	DB #0858-#07E0
1547+ 1C23 88           	DB #08E0-#0858
1548+ 1C24 80           	DB #0960-#08E0
1549+ 1C25 90           	DB #09F0-#0960
1550+ 1C26 98           	DB #0A88-#09F0
1551+ 1C27 A0           	DB #0B28-#0A88
1552+ 1C28 B0           	DB #0BD8-#0B28
1553+ 1C29 A8           	DB #0C80-#0BD8
1554+ 1C2A E0           	DB #0D60-#0C80
1555+ 1C2B B0           	DB #0E10-#0D60
1556+ 1C2C E8           	DB #0EF8-#0E10
1557+ 1C2D
1558+ 1C2D              ;vars from here can be stripped
1559+ 1C2D              ;you can move VARS to any other address
1560+ 1C2D
1561+ 1C2D              VARS
1562+ 1C2D
1563+ 1C2D 00           is_ts	DB 0
1564+ 1C2E
1565+ 1C2E              ;ChannelsVars
1566+ 1C2E              	STRUCT	CHP
1567+ 1C2E ~            ;reset group
1568+ 1C2E ~            PsInOr	DB 0
1569+ 1C2E ~            PsInSm	DB 0
1570+ 1C2E ~            CrAmSl	DB 0
1571+ 1C2E ~            CrNsSl	DB 0
1572+ 1C2E ~            CrEnSl	DB 0
1573+ 1C2E ~            TSlCnt	DB 0
1574+ 1C2E ~            CrTnSl	DW 0
1575+ 1C2E ~            TnAcc	DW 0
1576+ 1C2E ~            COnOff	DB 0
1577+ 1C2E ~            ;reset group
1578+ 1C2E ~
1579+ 1C2E ~            OnOffD	DB 0
1580+ 1C2E ~
1581+ 1C2E ~            ;IX for PTDECOD here (+12)
1582+ 1C2E ~            OffOnD	DB 0
1583+ 1C2E ~            OrnPtr	DW 0
1584+ 1C2E ~            SamPtr	DW 0
1585+ 1C2E ~            NNtSkp	DB 0
1586+ 1C2E ~            Note	DB 0
1587+ 1C2E ~            SlToNt	DB 0
1588+ 1C2E ~            Env_En	DB 0
1589+ 1C2E ~            Flags	DB 0
1590+ 1C2E ~             ;Enabled - 0, SimpleGliss - 2
1591+ 1C2E ~            TnSlDl	DB 0
1592+ 1C2E ~            TSlStp	DW 0
1593+ 1C2E ~            TnDelt	DW 0
1594+ 1C2E ~            NtSkCn	DB 0
1595+ 1C2E ~            Volume	DB 0
1596+ 1C2E              	ENDS
1597+ 1C2E
1598+ 1C2E              	STRUCT	VRS
1599+ 1C2E ~
1600+ 1C2E ~            ;IF not works in STRUCT in SjASM :(
1601+ 1C2E ~            ;	IF CurPosCounter
1602+ 1C2E ~            CurPos	DB 0
1603+ 1C2E ~            PosSub	DB 0
1604+ 1C2E ~            ;	ENDIF
1605+ 1C2E ~
1606+ 1C2E ~            ModNum	DB 0 ;bit0: ChipNum
1607+ 1C2E ~            	     ;bit1: 1-reversed patterns order (AlCo TS)
1608+ 1C2E ~
1609+ 1C2E ~            ChanA	DS CHP
1610+ 1C2E ~            ChanB	DS CHP
1611+ 1C2E ~            ChanC	DS CHP
1612+ 1C2E ~
1613+ 1C2E ~            ;GlobalVars
1614+ 1C2E ~            MODADDR	DW 0
1615+ 1C2E ~            OrnPtrs	DW 0
1616+ 1C2E ~            SamPtrs	DW 0
1617+ 1C2E ~            PatsPtr	DW 0
1618+ 1C2E ~            AdInPtA	DW 0
1619+ 1C2E ~            AdInPtB	DW 0
1620+ 1C2E ~            AdInPtC	DW 0
1621+ 1C2E ~            CrPsPtr	DW 0
1622+ 1C2E ~            LPosPtr	DW 0
1623+ 1C2E ~            Delay	DB 0
1624+ 1C2E ~            DelyCnt	DB 0
1625+ 1C2E ~            ESldAdd	DW 0
1626+ 1C2E ~            CurESld	DW 0
1627+ 1C2E ~            Env_Del	DB 0
1628+ 1C2E ~            CurEDel	DB 0
1629+ 1C2E ~            Ns_Base	DB 0
1630+ 1C2E ~            AddToNs	DB 0
1631+ 1C2E ~            AddToEn	DB 0
1632+ 1C2E ~            EnvBase	DW 0
1633+ 1C2E ~            AYREGS	DS 14
1634+ 1C2E              	ENDS
1635+ 1C2E
1636+ 1C2E 00 00 00...  VARS1	DS VRS
1637+ 1CB5 00 00 00...  VARS2	DS VRS
1638+ 1D3C
1639+ 1D3C              VT_	EQU $-16
1640+ 1D3C 00 00 00...  	DS 256-16 ;CreatedVolumeTableAddress
1641+ 1E2C
1642+ 1E2C              T1_	EQU VT_+16 ;Tone tables data depacked here
1643+ 1E2C
1644+ 1E2C              T_OLD_1	EQU T1_
1645+ 1E2C              T_OLD_2	EQU T_OLD_1+24
1646+ 1E2C              T_OLD_3	EQU T_OLD_2+24
1647+ 1E2C              T_OLD_0	EQU T_OLD_3+2
1648+ 1E2C              T_NEW_0	EQU T_OLD_0
1649+ 1E2C              T_NEW_1	EQU T_OLD_1
1650+ 1E2C              T_NEW_2	EQU T_NEW_0+24
1651+ 1E2C              T_NEW_3	EQU T_OLD_3
1652+ 1E2C
1653+ 1E2C              PT2EMPTYORN EQU VT_+31 ;1,0,0 sequence
1654+ 1E2C
1655+ 1E2C 00 00 00...  NT_	DS 192 ;CreatedNoteTableAddress
1656+ 1EEC
1657+ 1EEC              VAR0END	EQU VT_+16 ;INIT zeroes from VARS to VAR0END-1
1658+ 1EEC
1659+ 1EEC              VARSEND EQU $
1660+ 1EEC
1661+ 1EEC              MDLADDR EQU outputBuffer
1662+ 1EEC
1663+ 1EEC              ;Release 0 steps:
1664+ 1EEC              ;04/21/2007
1665+ 1EEC              ;Works start (PTxPlay adaptation); first beta.
1666+ 1EEC              ;04/22/2007
1667+ 1EEC              ;Job finished; beta-testing.
1668+ 1EEC              ;04/23/2007
1669+ 1EEC              ;PT v3.7 TS mode corrected (after AlCo remarks).
1670+ 1EEC              ;04/29/2007
1671+ 1EEC              ;Added 1.XX and 2.XX special commands interpretation for PT3
1672+ 1EEC              ;modules of v3.7+.
1673+ 1EEC
1674+ 1EEC              ;Size (minimal build for ZX Spectrum):
1675+ 1EEC              ;Code block #908 bytes
1676+ 1EEC              ;Variables #2BF bytes (can be stripped)
1677+ 1EEC              ;Total size #908+#2BF=#BC7 (3015) bytes
1678+ 1EEC              	ENDMODULE
# file closed: player.asm
1372  1EEC 00 00 00...  	align 256
1373  1F00              font
1374  1F00              	incbin fontV6.chr ;шрифт
1375  2700
1376  2700              ;Переменные
1377  2700 00           proc_play_ay db 0 ;код процесса с музыкой AY
1378  2701 00           proc_play_ay_slot2 db 0 ;страница с музыкой AY
1379  2702 00           proc_play_ay_slot3 db 0 ;страница с музыкой AY
1380  2703 00           scr_cur db 0 ;текущий активный экран
1381  2704 00           proc_id_focus db 0 ;процесс, у которого фокус (видимый экран и доступно управление)
1382  2705 00 00        proc_stack_addr_tmp dw 0 ; временно адрес стека
1383  2707 00 00        proc_stack_addr_return_tmp dw 0 ;временно адрес возврата из прерываний
1384  2709 00           proc_switch_key_flag db 0 ;флаг что нажата клавиша переключения задач
1385  270A              ;stack_adr_sys dw 0 ;адрес системного стека
1386  270A 00           page_slot3_cur db 0 ;текущая страница вы слоте 3
1387  270B 00           page_slot2_cur db 0 ;текущая страница вы слоте 2
1388  270C 00           con_scr_cur db 0 ;страница активного экрана пиксели
1389  270D 00           con_atr_cur db 0 ;страница активного экрана атрибуты
1390  270E 00           key_cur db 0 ;печатный код нажатой клавиши
1391  270F 00           file_id_cur db 0 ;временно id файла
1392  2710
1393  2710 00           proc_id_next db 0 ;код следующего процесса
1394  2711 00 00        proc_stack_adr_tmp dw 0 ;временно адрес стека
1395  2713 00           proc_id_cur db 0 ;id текущего процесса
1396  2714              ;proc_id_cur_tmp db 0 ;временно id процесса
1397  2714 53 59 53 20  proc_sys_name db "SYS        ",0 ;имя системного процесса
1397  2718 20 20 20 20
1397  271C 20 20 20 00
1398  2720 43 4D 44 20  proc_cmd_name db "CMD        ",0 ;имя процесса консоль
1398  2724 20 20 20 20
1398  2728 20 20 20 00
1399  272C 00 00 00 00  sys_timer ds 4 ;таймер - счётчик прерываний
1400  2730
1401  2730 00 00 00...  	align 256
1402  2800              proc_table ;данные процессов и приложений
1403  2800 00 00 00...  	ds proc_descr_size*proc_max ;на командную строку, список страниц и прочее
1404  3000              	;#00 - id процесса
1405  3000              	;#01 - id родительского
1406  3000              	;#02 - страница #8000
1407  3000              	;#03 - страница #c000
1408  3000              	;#04 - страница буфер экран пиксели
1409  3000              	;#05 - страница буфер экран атрибуты
1410  3000              	;#06-07 - адрес стека
1411  3000              	;#08-09 - позиция аппаратного скрола
1412  3000              	;#0a-0b - координаты курсора
1413  3000              	;#0c-0d - цвет текста основной, цвет второй
1414  3000              	;#0e-0f - адрес вызова по прерыванию
1415  3000              	;#0f-1a - Имя
1416  3000
1417  3000
1418  3000
1419  3000              proc_page_table	;таблица занятых процессами страниц
1420  3000 00 00 00...  	ds 128 ;у GMX всего 128
1421  3080
1422  3080 72 61 64 69  proc_name_01	db "radio.com",0
1422  3084 6F 2E 63 6F
1422  3088 6D 00
1423  308A 6D 6F 6F 6E  proc_name_02	db "moonr.com",0
1423  308E 72 2E 63 6F
1423  3092 6D 00
1424  3094              ;proc_name_03	db "test.txt",0
1425  3094
1426  3094
1427  3094              ;Константы
1428  3094              outputBuffer equ #c000 ;адрес файла для плеера AY
1429  3094              proc_color_def equ 7 ;цвет текста консоли
1430  3094              proc_color2_def equ #c ;цвет текста консоли 2 яркий
1431  3094              function_max equ 41+1 ;всего функций
1432  3094              proc_size_max equ #80 ;максимальный размер приложения старший байт
1433  3094              proc_descr_size equ 256 ;область памяти на одно приложение
1434  3094              proc_max equ 8 ;максимальное количество приложений
1435  3094              page_max equ drvgmx.page_table_end-drvgmx.page_table ;всего доступных страниц из 128
1436  3094              proc_id_system equ 1 ;код системного процесса
1437  3094              ;proc_stack equ #4000;адрес стека для процессов
1438  3094              ;proc_stack_size equ 128 ;размер стека для процесса
1439  3094              con_scr_real equ #39 ;экран физический
1440  3094              con_atr_real equ #79 ;атрибуты
1441  3094              ;page_slot2_def equ 2 ;страница по умолчанию слот 2
1442  3094              ;page_slot3_def equ 1 ;страница по умолчанию слот 3
1443  3094              proc_switch_key equ #1b ;код перключения задач sh+Enter
1444  3094
1445  3094
1446  3094              ;Сообщения
1447  3094              msg_init_uart_found
1448  3094 55 41 52 54  	db "UART #EF found",13,10,0
1448  3098 20 23 45 46
1448  309C 20 66 6F 75
1448  30A0 6E 64 0D 0A
1448  30A4 00
1449  30A5              msg_init_uart_not_found
1450  30A5 55 41 52 54  	db "UART #EF not found",13,10,0
1450  30A9 20 23 45 46
1450  30AD 20 6E 6F 74
1450  30B1 20 66 6F 75
1450  30B5 6E 64 0D 0A
1450  30B9 00
1451  30BA              msg_proc_max
1452  30BA 4E 6F 74 20  	db "Not enough processes",13,10,0
1452  30BE 65 6E 6F 75
1452  30C2 67 68 20 70
1452  30C6 72 6F 63 65
1452  30CA 73 73 65 73
1452  30CE 0D 0A 00
1453  30D1              msg_mem_max
1454  30D1 4E 6F 74 20  	db "Not enough memory",13,10,0
1454  30D5 65 6E 6F 75
1454  30D9 67 68 20 6D
1454  30DD 65 6D 6F 72
1454  30E1 79 0D 0A 00
1455  30E5              msg_processes
1456  30E5 50 72 6F 63  	db "Processes: ",0
1456  30E9 65 73 73 65
1456  30ED 73 3A 20 00
1457  30F1              msg_free_ram
1458  30F1 46 72 65 65  	db "Free pages RAM: ",0
1458  30F5 20 70 61 67
1458  30F9 65 73 20 52
1458  30FD 41 4D 3A 20
1458  3101 00
1459  3102 00 00 00...  decimalS ds 6 ;здесь будет цифра
1460  3108
1461  3108
1462  3108              msg_ver_os
1463  3108 4F 53 20 76  	db "OS ver 2024.11.06",13,10,0
1463  310C 65 72 20 32
1463  3110 30 32 34 2E
1463  3114 31 31 2E 30
1463  3118 36 0D 0A 00
1464  311C
1465  311C
1466  311C
1467  311C
1468  311C
1469  311C
1470  311C              start_sys_incl
1471  311C              	incbin sys.com ;
1472  31C4              end_sys_incl
1473  31C4
1474  31C4              start_cmd_incl
1475  31C4              	incbin cmd.com ;
1476  3202              end_cmd_incl
1477  3202
1478  3202              end_os_main
1479  3202              	SAVETRD "OS.TRD",|"OS.C",start_os_main,$-start_os_main ;сохранить в TRD
1480  3202              	savebin "os.com",start_os_main,$-start_os_main ;сохранить для FAT
1481  3202
1482  3202              	;манипуляции для создания hobeta
1483  3202              	org #c000
1484  C000              	incbin os.com
1485  F202              	SAVEHOB "os.$c","os.C",#C000,end_os_main-start_os_main ;
1486  F202
1487  F202
1488  F202
1489  F202
1490  F202
# file closed: os_main.asm
