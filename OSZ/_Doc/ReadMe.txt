Многозадачная ОС для ZS GMX (ZX Spectrum - совместимый), 
izzx, 2024-2025
В процессе разрабоки...

Тема на форуме:
https://zx-pk.ru/threads/35996-os-dlya-zs-gmx.html

Поддерживается SMUC и ZC, FAT32 (то, что умеет монитор).
Прошивка нужна свежая от LW/PLM, версии примерно 40 и выше.
Одновременно может быть запущено до 8 процессов,
открыто до 8 файлов.
Используется ОЗУ 2 Мб и экран 640*200.
Встроена поддержка карты ZX WiFi (ESP-12).

Запуск:
Из папки "Release" скопировать папку "OSZ" на диск FAT32 и запустить файл hobeta "os.$c"
через навигатор.
Или через меню HDD boot (настроить в мониторе Disk utility - from drive = File - HDD file = os.$c).
Или запустить образ дискеты OS.TRD.

Управление:
Ss + Enter - Переключение задач
Cs + 1 - Rus/Lat
Cs + 2 - Caps Lock
Cs + 3 (Tr. Video) - Page Up
Cs + 4 (Inv. Video) - Page Down
Cs + 9 - Graphics
Ext + 0 - теневой монитор (только на экране системного процесса)
Ext + 1 - Перейти к системному процессу
Ext + 9 - запустить nc (только на экране системного процесса)
Break (CS + пробел) - выход из приложения (не для всех)

В теневой монитор желательно выходить по специальной клавише, иначе обратно не вернуться. 

Файлы:
Data - папка для гофер браузера.
Download - папка для загрузок. Внутри подпапки для приложений, с правильными именами. Иначе сохранят в корень.
Download\ArtView
Download\MoonR
Download\Radio
artview.apg - просмотр картинок scr (6912 байт) с сайта zxart.ee.
autorun.txt - список для автозапуска приложений. Через update этот файл не обновляется.
moonr.apg - гофер браузер. Умеет скачивать файлы, просматривать scr и проигрывать pt2, pt3, mod.
nc.apg - командер для запуска приложений. Открывает максимум 512 файлов в папке (первые 16к байт каталога). 
       Можно включить сортировку по первой букве, но это медленнее.
	   Можно включить длинные имена. Немного замедляет навигацию.
	   Текстовый просмотрщик открывает первые 16к файла (это временно).
	   Встроенный плеер умеет играть файлы:
		   VGM, VGZ (OPL2-3, нужна карта BomgeMoon с портом #24-#27)
		   MOD (нужна карта GS)
		   PT2, PT3 (чип AY)
	   Встроенный просмотрщик картинок scr (стандартный экран, 6912 байт).
net.apg - системное приложение для работы сети на ESP, без него сеть не работает. Должен быть запущен один раз.
os.$c - ядро системы для запуска (hobeta).
OS.TRD - диск с ядром системы для запуска через TR-DOS (через update этот файл не обновляется!)
radio.apg - плеер музыки с сайта zxart.ee.
ReadMe.txt - этот файл.
sys.osg - системный процесс, всегда работает.
terminal.apg - простой терминал для порта UART. Блокирует порт, сеть ESP не работает, пока он запущен.
tetris.apg - тетрис, работает в графическом режиме псевдо 160*200 (экран 640*200).
update.apg - обновление системы через интернет. Адрес сайта обновлений берёт из второй строчки в update.txt
	(временно ограничение для обновлений по размеру файлов около 30Кб, и без подпапок).




В планах (не известно, будет ли...):
Поддержка TR-DOS дисков (сейчас только FAT).
Монтирование TR-DOS образов и запуск  программ.
Возврат в ОС по кнопке сброс.
+ Портирование приложений (уже работает Moon Rabbit, Radio).
+ Монопольный режим для приложений
+ Работа процессов реального времени (каждое прерывание). Например, плеер AY (уже есть).
+ Многозадачная работа с сетью через ESP. (сделано, работа приложений с сетью в порядке очереди)
Удобная работа с большими объёмами информации в памяти (>2 страниц).
Удалённый терминал
Сетевые папки (наработки от АИ232К?)
Поддержка мыши
+ Файл автозапуска
+ Командер для запуска приложений NC
+- Вьювер в NC, в том числе больших файлов
Редактор текста в NC
+ Сохранение файлов в Radio и ArtView
+ Папка Download
+ Нормальная навигация в NC
+ Длинные имена и сортировка в NC
Просмотр картинок (внедрить GMX Pic View целиком?)
+- Плеер музыки (pt, mod)
+ Плеер OPL3
Выбор дисков (разделов)
Переход на внешнюю библиотеку FAT v2?
Плеер видео (внедрить Video Player?)
Поддержка NeoGS SD
Копирование файлов и прочие файловые операции в NC?
Поддержка часов СМУК (в NC и синхронизация с инетом)



------------------------------------
Информация для программиста.

Сборка ОС: Под Windows положить рядом папки OSZ, Release\OSZ и Unreal (не обязательно. настроенный для ГМХ эмулятор).
Запустить _Build_OS.bat. Автоматом свежие файлы скопируются в образ диска эмулятора wc.img.
Также запустить _Build_ххх для каждого приложения, если были изменения.
Эмулятор должен автоматически запуститься.
Все нужные файлы будут в Release\OSZ\. 




Системные вызовы описаны в "os_defs.asm".
Система использует вызовы теневого монитора для работы с дисками.
Система находится в странице 0, вместо ПЗУ.
Страницы 1-4, 6 - зарезервированы для монопольного режима одного приложения.
5, 7, #39, #3a, #79, #7a - видео страницы
#77-#7F - заняты теневым монитором
Обычные процессы используют окна памяти #8000 и #c000.
Каждому процессу даётся 4 страницы и можно запрашивать дополнительные.
Две страницы под буфер экрана. Экран по умолчанию расширенный 640*200.
Используется аппаратный скрол экрана.
В консоль процессы могут выводить текст в любое время. 
Получать коды нажатых клавиш может только процесс в фокусе.
Планируется монопольный режим для одного приложения, которому будет доступна
память от #4000 и страницы 0-7.
Доступ к открытым файлам по их ID имеет только тот процесс, который их открыл.
Но нет защиты от того, что этот же файл откроет другой процесс.
Процесс имеет доступ только к своим страницам памяти, 
а также к видео страницам 5, 7, #39, #3a, #79, #7a.

Процессам рекомендуется: 
использовать системные вызовы ОС.
отдавать лишнее время системе (следующему процессу) специальным вызовом. 

Процессам не рекомендуется:
Менять прерывания
Менять адрес стека
Переключать страницы памяти напрямую
Обращаться к дискам напрямую или через монитор
Загружать систему непрерывными вызовами. Лучше делать паузу.



Полезные ссылки:
Карта Bomge Moon
https://github.com/Kulicheg/BomgeMoon/tree/main
Музыка VGZ
https://opl.wafflenet.com/OPLArchive-full.zip
Карта ZX WiFi
https://github.com/izzx-git/ZX-WiFi
Группа Scorpion ПрофРом
https://t.me/ZS_ProfRom



Использован код авторства:
LW/PLM (новые функции монитора, опрос клавиатуры и др.)
S.V.Bulba (pt плеер)
Kulich (radio)
Nihirash (Moon Rabbit)
ZORBA, GALSTAFF (OPL плеер)
и прочие библиотеки/куски кода, какие удалось найти ).
Источник вдохновения NedoOS (Alone Coder).