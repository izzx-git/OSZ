# file opened: artview.asm
   1  0000              ;ArtView - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 200+ 0000                  ; ld c,#14
 201+ 0000                  ; rst #20
 202+ 0000                  ; endm
 203+ 0000
 204+ 0000
 205+ 0000              ;плеер AY ----------------------------
 206+ 0000
 207+ 0000              ;инициализация плеера AY;
 208+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 209+ 0000 ~                ld c,#15
 210+ 0000 ~                rst #20
 211+ 0000                  endm
 212+ 0000
 213+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 214+ 0000                  macro OS_VTPL_PLAY ;()
 215+ 0000 ~                ld c,#16
 216+ 0000 ~                rst #20
 217+ 0000                  endm
 218+ 0000
 219+ 0000              ;заглушить плеер AY;
 220+ 0000                  macro OS_VTPL_MUTE ;()
 221+ 0000 ~                ld c,#17
 222+ 0000 ~                rst #20
 223+ 0000                  endm
 224+ 0000
 225+ 0000              ;получить значение переменной плеера;
 226+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 227+ 0000 ~                ld c,#18
 228+ 0000 ~                rst #20
 229+ 0000                  endm
 230+ 0000
 231+ 0000
 232+ 0000              ;прочие ------------------------------
 233+ 0000
 234+ 0000
 235+ 0000              ;скопировать данные из страницы в страницу
 236+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 237+ 0000                  macro OS_RAM_COPY
 238+ 0000 ~                ld c,#19
 239+ 0000 ~                rst #20
 240+ 0000                  endm
 241+ 0000
 242+ 0000              ;получить дополнительную страницу памяти;
 243+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 244+ 0000 ~                ld c,#1a
 245+ 0000 ~                rst #20
 246+ 0000                  endm
 247+ 0000
 248+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 249+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 250+ 0000 ~                ld c,#1b
 251+ 0000 ~                rst #20
 252+ 0000                  endm
 253+ 0000
 254+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 255+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 256+ 0000 ~                ld c,#1c
 257+ 0000 ~                rst #20
 258+ 0000                  endm
 259+ 0000
 260+ 0000              ;включить экран N;
 261+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 262+ 0000              ;переключать может только приложение в фокусе
 263+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 264+ 0000              ;при переключении процессов сохраняется только экран #39
 265+ 0000                  macro OS_SET_SCREEN ;
 266+ 0000 ~                ld c,#1d
 267+ 0000 ~                rst #20
 268+ 0000                  endm
 269+ 0000
 270+ 0000
 271+ 0000              ;получить номера страниц процесса;
 272+ 0000              ;вх:
 273+ 0000              ;вых: b, c - страницы в слотах 2, 3
 274+ 0000                  macro OS_GET_MAIN_PAGES ;
 275+ 0000 ~                ld c,#1e
 276+ 0000 ~                rst #20
 277+ 0000                  endm
 278+ 0000
 279+ 0000              ;получить значение системного таймера
 280+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 281+ 0000 ~                ld c,#1F
 282+ 0000 ~                rst #20
 283+ 0000                  endm
 284+ 0000
 285+ 0000
 286+ 0000
 287+ 0000                  ; macro OS_ ;
 288+ 0000                  ; ld c,#20
 289+ 0000                  ; rst #20
 290+ 0000                  ; endm
 291+ 0000
 292+ 0000
 293+ 0000              ;дисковые операции -------------------
 294+ 0000
 295+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 296+ 0000
 297+ 0000              ; fcbFAT (из руководства к монитору)
 298+ 0000              ; формат fcb для работы с FAT
 299+ 0000
 300+ 0000              ; +#00 8 имя файла
 301+ 0000              ; +#08 3 расширение файла
 302+ 0000              ; +#0B 1 атрибуты файла
 303+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 304+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 305+ 0000              ; +#14 4 размер файла/каталога в байтах
 306+ 0000              ; +#18 4 указатель в файле
 307+ 0000              ; +#1C 1 для внутренних нужд
 308+ 0000              ; +#1D 1 для внутренних нужд
 309+ 0000              ; +#1E 1 резерв
 310+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 311+ 0000              	; 1-0,nn номер раздела
 312+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 313+ 0000              	    ; значение %11 недопустимо
 314+ 0000
 315+ 0000              ;открыть файл для чтения или записи
 316+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 317+ 0000 ~                ld c,#21
 318+ 0000 ~                rst #20
 319+ 0000                  endm
 320+ 0000
 321+ 0000              ;создать файл
 322+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 323+ 0000 ~                ld c,#22
 324+ 0000 ~                rst #20
 325+ 0000                  endm
 326+ 0000
 327+ 0000              ;прочитать из файла
 328+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
 329+ 0000 ~                ld c,#23
 330+ 0000 ~                rst #20
 331+ 0000                  endm
 332+ 0000
 333+ 0000              ;записать в файл
 334+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 335+ 0000 ~                ld c,#24
 336+ 0000 ~                rst #20
 337+ 0000                  endm
 338+ 0000
 339+ 0000              ;закрыть файл
 340+ 0000                  macro OS_FILE_CLOSE ;A - id file
 341+ 0000 ~                ld c,#25
 342+ 0000 ~                rst #20
 343+ 0000                  endm
 344+ 0000
 345+ 0000              ;чтение секторов текущего каталога
 346+ 0000              ; вх:
 347+ 0000                   ; hl - буфер для чтения
 348+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 349+ 0000                   ; b - максимальное количество секторов для чтения
 350+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 351+ 0000                     ; a=errRWnum
 352+ 0000                     ; a=errInvalidPart
 353+ 0000                     ; a=errFileEmpty
 354+ 0000                   ; cy=0, a=errEoF - каталог закончился
 355+ 0000                     ; hl - следующий адрес в буфере
 356+ 0000                     ; de - номер первого непрочитанного сектора
 357+ 0000                     ; b - не прочитано секторов
 358+ 0000                   ; cy=0 - считано успешно
 359+ 0000                     ; hl - следующий адрес в буфере
 360+ 0000                     ; de - номер первого непрочитанного сектора
 361+ 0000                     ; b=#00
 362+ 0000                  macro OS_DIR_READ ;
 363+ 0000 ~                ld c,#26
 364+ 0000 ~                rst #20
 365+ 0000                  endm
 366+ 0000
 367+ 0000              ;вход в каталог/выход в родительский каталог
 368+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 369+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 370+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 371+ 0000              	; переход в родительский, последнее имя в пути удалится).
 372+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 373+ 0000              	; добавится имя файла
 374+ 0000              ; вх:
 375+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 376+ 0000                   ; de - адрес дескриптора директории/файла
 377+ 0000              ; вых: a - если путь был указан, новая длина пути
 378+ 0000                  macro OS_DIR_OPEN ;
 379+ 0000 ~                ld c,#27
 380+ 0000 ~                rst #20
 381+ 0000                  endm
 382+ 0000
 383+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 384+ 0000              ;проверки на допустимость значений не производится
 385+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 386+ 0000              ;вх: A - id файла
 387+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 388+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 389+ 0000                  macro OS_FILE_POSITION ;
 390+ 0000 ~                ld c,#28
 391+ 0000 ~                rst #20
 392+ 0000                  endm
 393+ 0000
 394+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 395+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 396+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 397+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 398+ 0000                  macro OS_FIND_PATH ;
 399+ 0000 ~                ld c,#29
 400+ 0000 ~                rst #20
 401+ 0000                  endm
 402+ 0000
 403+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROGSTART
   5  8000
   6  8000              ;порядок работы:
   7  8000              ;открытие соединения
   8  8000              ;проверка результата
   9  8000              ;отправка запроса
  10  8000              ;проверка результата
  11  8000              ;принять ответ
  12  8000              ;проверка результата
  13  8000              ;принять ещё пакеты, если есть, до закрытия соединения, или до получения ожидаемой длины
  14  8000              ;закрыть соединение
  15  8000              ;при каждой возможности (в паузах) закрывать соединение, чтобы уступить очередь другим приложениям.
  16  8000
  17  8000              start_artview
  18  8000              	; ld a,13 ;новая строка
  19  8000              	; OS_PRINT_CHARF
  20  8000 21 08 8B     	ld hl,msg_title_artview ;имя приложения
  21  8003              	OS_PRINTZ ;печать
  21  8003 0E 09       >    ld c,#09
  21  8005 E7          >    rst #20
  22  8006
  23  8006
  24  8006              ; artview_get_link
  25  8006              	; ld hl,msg_get_link_id
  26  8006              	; OS_PRINTZ ;печать
  27  8006
  28  8006              	; xor a ;CY=0
  29  8006              	; OS_ESP_LINK_ID ;получить номер соединения
  30  8006              	; jr nc,artview_get_link_ok
  31  8006
  32  8006              	; call artview_main_error
  33  8006              	; jr artview_get_link
  34  8006
  35  8006              ; artview_get_link_ok ;ID получили
  36  8006              	; ld (link_id),a
  37  8006
  38  8006              start_artview_warm
  39  8006              	; ld hl,format_pt3 ;формат
  40  8006              	; ld de,request_format
  41  8006              	; ld bc,3
  42  8006              	; ldir
  43  8006
  44  8006              	;настроить плеер
  45  8006              	; ld a,%00100001 ;pt3 auto
  46  8006              	; ld (player_setup),a
  47  8006
  48  8006
  49  8006              start_artview_warm2
  50  8006
  51  8006 21 FB 88     	ld hl,start_request ;очистить номер первого арта
  52  8009 11 FC 88     	ld de,start_request+1
  53  800C 01 04 00     	ld bc,5-1
  54  800F 36 30        	ld (hl),"0"
  55  8011 ED B0        	ldir
  56  8013
  57  8013 21 00 00     	ld hl,0
  58  8016 22 C5 88     	ld (cur_art),hl ;первый арт
  59  8019 22 C1 88     	ld (total_art),hl ;всего
  60  801C
  61  801C ED 5F        	ld a,r
  62  801E 32 1C 85     	ld (seed+1),a ;элемент случайности
  63  8021
  64  8021              artview_main
  65  8021              ;основной цикл
  66  8021 AF           	xor a
  67  8022 32 C7 88     	ld (stopKey_flag),a ;флаг останова
  68  8025
  69  8025              	; OS_GET_CHAR
  70  8025              	; cp "r"
  71  8025              	; jp z,start_artview ;всё сначала
  72  8025              	; cp "R"
  73  8025              	; jp z,start_artview ;всё сначала
  74  8025
  75  8025              	; call artview_open_site ;открыть сайт
  76  8025
  77  8025              	; jr nc,artview_main_open_ok
  78  8025              	; call artview_main_error
  79  8025              	; jr artview_main
  80  8025
  81  8025              artview_main_open_ok
  82  8025              ;открыли нормально
  83  8025              	OS_GET_CHAR
  83  8025 0E 10       >    ld c,#10
  83  8027 E7          >    rst #20
  84  8028 FE 72        	cp "r"
  85  802A CA 00 80     	jp z,start_artview ;всё сначала
  86  802D FE 52        	cp "R"
  87  802F CA 00 80     	jp z,start_artview ;всё сначала
  88  8032 FE 18        	cp 24 ;break
  89  8034 CA FE 80     	jp z,exit
  90  8037
  91  8037
  92  8037 CD 3C 82     	call artview_request_info ;запрос информации
  93  803A
  94  803A 30 05        	jr nc,artview_request_info_ok
  95  803C CD F9 81     	call artview_main_error
  96  803F 18 E4        	jr artview_main_open_ok
  97  8041
  98  8041
  99  8041
 100  8041
 101  8041              artview_request_info_ok
 102  8041              ;запрос прошёл
 103  8041              	OS_GET_CHAR
 103  8041 0E 10       >    ld c,#10
 103  8043 E7          >    rst #20
 104  8044 FE 72        	cp "r"
 105  8046 CA 00 80     	jp z,start_artview ;всё сначала
 106  8049 FE 52        	cp "R"
 107  804B CA 00 80     	jp z,start_artview ;всё сначала
 108  804E FE 18        	cp 24 ;break
 109  8050 CA FE 80     	jp z,exit
 110  8053
 111  8053 CD 62 82     	call artview_download_info ;загрузка информации
 112  8056
 113  8056 30 05        	jr nc,artview_download_info_ok
 114  8058 CD F9 81     	call artview_main_error
 115  805B 18 C8        	jr artview_main_open_ok
 116  805D
 117  805D
 118  805D
 119  805D
 120  805D              artview_download_info_ok
 121  805D              ;загрузка инфы прошла
 122  805D
 123  805D
 124  805D
 125  805D              ;теперь выбранный арт
 126  805D
 127  805D              	OS_GET_CHAR
 127  805D 0E 10       >    ld c,#10
 127  805F E7          >    rst #20
 128  8060 FE 72        	cp "r"
 129  8062 CA 00 80     	jp z,start_artview ;всё сначала
 130  8065 FE 52        	cp "R"
 131  8067 CA 00 80     	jp z,start_artview ;всё сначала
 132  806A FE 18        	cp 24 ;break
 133  806C CA FE 80     	jp z,exit
 134  806F
 135  806F CD 1E 83     	call artview_request_art ;запрос арта
 136  8072
 137  8072 30 05        	jr nc,artview_request_art_ok
 138  8074 CD F9 81     	call artview_main_error
 139  8077 18 E4        	jr artview_download_info_ok
 140  8079
 141  8079              artview_request_art_ok
 142  8079              ;загрузка инфы о арте прошла
 143  8079              	OS_GET_CHAR
 143  8079 0E 10       >    ld c,#10
 143  807B E7          >    rst #20
 144  807C FE 72        	cp "r"
 145  807E CA 00 80     	jp z,start_artview ;всё сначала
 146  8081 FE 52        	cp "R"
 147  8083 CA 00 80     	jp z,start_artview ;всё сначала
 148  8086 FE 18        	cp 24 ;break
 149  8088 CA FE 80     	jp z,exit
 150  808B
 151  808B CD 44 83     	call artview_download_art ;загрузка арта
 152  808E
 153  808E 30 05        	jr nc,artview_download_art_ok
 154  8090 CD F9 81     	call artview_main_error
 155  8093 18 C8        	jr artview_download_info_ok
 156  8095
 157  8095              artview_download_art_ok
 158  8095
 159  8095
 160  8095              	;начать просмотр
 161  8095 22 C3 88     	ld (start_art),hl
 162  8098
 163  8098              	;ld hl, outputBuffer  :
 164  8098              	;OS_GET_VTPL_SETUP
 165  8098              	; ld a,(player_setup)
 166  8098              	; ld (hl),a ;настройки
 167  8098
 168  8098              	;ld hl,(start_art)
 169  8098              	; OS_VTPL_INIT
 170  8098              	; OS_VTPL_PLAY
 171  8098
 172  8098 21 12 88     	ld hl,msg_play_art
 173  809B              	OS_PRINTZ
 173  809B 0E 09       >    ld c,#09
 173  809D E7          >    rst #20
 174  809E CD EB 83     	call print_sys_info ;печать менюшки
 175  80A1
 176  80A1 2A C3 88     	ld hl,(start_art)
 177  80A4 CD C3 81     	call scr_view ;
 178  80A7 18 04        	jr loop_artview1
 179  80A9
 180  80A9              loop_artview
 181  80A9              	OS_WAIT
 181  80A9 DF          >	rst #18
 182  80AA              	OS_GET_CHAR
 182  80AA 0E 10       >    ld c,#10
 182  80AC E7          >    rst #20
 183  80AD              loop_artview1
 184  80AD FE 72        	cp "r"
 185  80AF CA F5 80     	jp z,restart ;всё сначала
 186  80B2 FE 52        	cp "R"
 187  80B4 CA F5 80     	jp z,restart ;всё сначала
 188  80B7 FE 73        	cp "s" ;останов
 189  80B9 CA E8 80     	jp z,stopKey
 190  80BC FE 53        	cp "S" ;останов
 191  80BE CA E8 80     	jp z,stopKey
 192  80C1              	; cp "n" ;следующий случайный
 193  80C1              	; jp z, next_art
 194  80C1 FE 20        	cp " " ;слудующий случайный
 195  80C3 CA 02 81     	jp z, next_art
 196  80C6              	; cp "1" ;формат
 197  80C6              	; jp z, select_pt2
 198  80C6              	; cp "2" ;формат
 199  80C6              	; jp z, select_pt3
 200  80C6              	; cp "3" ;формат
 201  80C6              	; jp z, select_ts
 202  80C6              	; cp "4" ;формат
 203  80C6              	; jp z, select_tfc
 204  80C6 FE 51        	cp "Q" ;порядок
 205  80C8 CA 7C 81     	jp z, select_order
 206  80CB FE 71        	cp "q" ;порядок
 207  80CD CA 7C 81     	jp z, select_order
 208  80D0 FE 44        	cp "D" ;сохранить в файл
 209  80D2 CA 9E 85     	jp z, save_file
 210  80D5 FE 64        	cp "d" ;сохранить в файл
 211  80D7 CA 9E 85     	jp z, save_file
 212  80DA FE 18        	cp 24 ;break
 213  80DC CA FE 80     	jp z,exit
 214  80DF              	; OS_GET_VTPL_SETUP
 215  80DF                  ; ld a, (hl) :
 216  80DF              	; rla : jr nc, loop_artview
 217  80DF              	; ld a,(time_view) ;пауза
 218  80DF              	; ld b,a
 219  80DF              	; call delay1
 220  80DF 3A C7 88     	ld a,(stopKey_flag)
 221  80E2 B7           	or a
 222  80E3 20 C4        	jr nz,loop_artview
 223  80E5
 224  80E5 C3 02 81     	jp next_art
 225  80E8              stopKey
 226  80E8              	;OS_VTPL_MUTE
 227  80E8 21 1F 88     	ld hl,msg_stop
 228  80EB              	OS_PRINTZ
 228  80EB 0E 09       >    ld c,#09
 228  80ED E7          >    rst #20
 229  80EE 3E 01        	ld a,1
 230  80F0 32 C7 88     	ld (stopKey_flag),a
 231  80F3 18 B4        	jr loop_artview
 232  80F5              ; loop_artview2
 233  80F5              	; jr loop_artview2
 234  80F5
 235  80F5              restart
 236  80F5              	;OS_VTPL_MUTE
 237  80F5 21 25 88     	ld hl,msg_restart
 238  80F8              	OS_PRINTZ
 238  80F8 0E 09       >    ld c,#09
 238  80FA E7          >    rst #20
 239  80FB C3 06 80     	jp start_artview_warm
 240  80FE
 241  80FE              exit ;выход в ДОС
 242  80FE AF           	xor a
 243  80FF              	OS_PROC_CLOSE
 243  80FF 0E 13       >    ld c,#13
 243  8101 E7          >    rst #20
 244  8102
 245  8102
 246  8102              ;следующий арт
 247  8102              next_art
 248  8102              	;получить случайный номер арта
 249  8102              	; nop
 250  8102              	; nop
 251  8102              	;OS_VTPL_MUTE
 252  8102
 253  8102 CD 2A 81     	call get_next ;узнать следующий
 254  8105 DA E8 80     	jp c,stopKey ;если 0, то останов
 255  8108              	;подставить номер
 256  8108 CD 3F 85     	call toDecimal
 257  810B              	;ld (start_art),hl
 258  810B 21 98 85     	ld hl,decimalS
 259  810E 11 FB 88     	ld de,start_request
 260  8111 01 05 00     	ld bc,5
 261  8114 ED B0        	ldir
 262  8116 C3 21 80     	jp artview_main ;на загрузку нового арта
 263  8119
 264  8119              ; select_pt2 ;выбор типа
 265  8119              	; ;OS_VTPL_MUTE
 266  8119              	; ld hl,format_pt2
 267  8119              	; call select_format_print
 268  8119              	; ld de,request_format
 269  8119              	; ld bc,3
 270  8119              	; ldir
 271  8119              	; ;настроить плеер
 272  8119              	; ld a,%00000011 ;pt2
 273  8119              	; ld (player_setup),a
 274  8119              	; jp start_artview_warm2
 275  8119
 276  8119              ; select_pt3 ;выбор типа
 277  8119              	; ;OS_VTPL_MUTE
 278  8119              	; ld hl,format_pt3
 279  8119              	; call select_format_print
 280  8119              	; ld de,request_format
 281  8119              	; ld bc,3
 282  8119              	; ldir
 283  8119              	; ;настроить плеер
 284  8119              	; ld a,%00100001 ;pt3
 285  8119              	; ld (player_setup),a
 286  8119              	; call artview_download_info ;загрузка информации сколько артов
 287  8119              	; jp start_artview_warm2
 288  8119
 289  8119              ; select_ts ;выбор типа
 290  8119              	; OS_VTPL_MUTE
 291  8119              	; ld hl,format_ts
 292  8119              	; call select_format_print
 293  8119              	; ld de,request_format
 294  8119              	; ld bc,3
 295  8119              	; ldir
 296  8119              	; OS_GET_VTPL_SETUP ;настроить плеер
 297  8119              	; ld a,%00100001 ;%00010001 ;2xPT3
 298  8119              	; ld (hl),a
 299  8119              	; jp loop_artview
 300  8119
 301  8119              ; select_tfc ;выбор типа
 302  8119              	; OS_VTPL_MUTE
 303  8119              	; ld hl,format_tfc
 304  8119              	; call select_format_print
 305  8119              	; ld de,request_format
 306  8119              	; ld bc,3
 307  8119              	; ldir
 308  8119              	; jp loop_artview
 309  8119
 310  8119              select_format_print
 311  8119 E5           	push hl
 312  811A 21 C5 87     	ld hl,msg_format
 313  811D              	OS_PRINTZ
 313  811D 0E 09       >    ld c,#09
 313  811F E7          >    rst #20
 314  8120 E1           	pop hl
 315  8121 E5           	push hl
 316  8122              	OS_PRINTZ
 316  8122 0E 09       >    ld c,#09
 316  8124 E7          >    rst #20
 317  8125 3E 0D        	ld a,13
 318  8127              	OS_PRINT_CHARF
 318  8127 D7          >	rst #10
 319  8128 E1           	pop hl
 320  8129 C9           	ret
 321  812A
 322  812A
 323  812A
 324  812A
 325  812A
 326  812A
 327  812A
 328  812A
 329  812A              get_next ;выбор следующего арта
 330  812A 2A C1 88     	ld hl,(total_art)
 331  812D 7D           	ld a,l
 332  812E B4           	or h
 333  812F 37           	scf ;ошибка
 334  8130 C8           	ret z ;если всего 0, то вернуть 0
 335  8131 3A C8 88     	ld a,(order_val)
 336  8134 B7           	or a
 337  8135 28 3A        	jr z,get_next_random
 338  8137 FE 01        	cp 1
 339  8139 28 1A        	jr z,get_next_from_new_to_old
 340  813B
 341  813B
 342  813B              get_next_from_old_to_new
 343  813B              	;от старых к новым
 344  813B 2A C5 88     	ld hl,(cur_art)
 345  813E 11 01 00     	ld de,1
 346  8141 A7           	and a
 347  8142 ED 52        	sbc hl,de
 348  8144 30 06        	jr nc,get_next_from_old_to_new1
 349  8146 2A C1 88     	ld hl,(total_art) ;с конца
 350  8149 2B           	dec hl ;фикс потому что счёт с 0
 351  814A 18 04        	jr get_next_from_old_to_new2
 352  814C              get_next_from_old_to_new1
 353  814C 2A C5 88     	ld hl,(cur_art)
 354  814F 2B           	dec hl
 355  8150              get_next_from_old_to_new2
 356  8150 22 C5 88     	ld (cur_art),hl ;запомним
 357  8153 AF           	xor a ;нет ошибок
 358  8154 C9           	ret
 359  8155
 360  8155
 361  8155              get_next_from_new_to_old
 362  8155              	;от новых к старым
 363  8155 ED 5B C5 88  	ld de,(cur_art)
 364  8159 13           	inc de
 365  815A 2A C1 88     	ld hl,(total_art)
 366  815D 2B           	dec hl ;фикс потому что счёт с 0
 367  815E A7           	and a
 368  815F ED 52        	sbc hl,de
 369  8161 30 05        	jr nc,get_next_from_new_to_old1
 370  8163 21 00 00     	ld hl,0 ;сначала
 371  8166 18 04        	jr get_next_from_new_to_old2
 372  8168              get_next_from_new_to_old1
 373  8168 2A C5 88     	ld hl,(cur_art)
 374  816B 23           	inc hl
 375  816C              get_next_from_new_to_old2
 376  816C 22 C5 88     	ld (cur_art),hl ;запомним
 377  816F AF           	xor a ;нет ошибок
 378  8170 C9           	ret
 379  8171
 380  8171
 381  8171
 382  8171              get_next_random
 383  8171              	;случайный
 384  8171 2A C1 88     	ld hl,(total_art)
 385  8174 CD EE 84     	call rnd
 386  8177 22 C5 88     	ld (cur_art),hl ;запомним
 387  817A AF           	xor a ;нет ошибок
 388  817B C9           	ret
 389  817C
 390  817C
 391  817C
 392  817C
 393  817C              select_order ;выбор порядка
 394  817C 3A C8 88     	ld a,(order_val)
 395  817F 3C           	inc a
 396  8180 FE 03        	cp 3 ;макс
 397  8182 38 01        	jr c,select_order1
 398  8184 AF           	xor a
 399  8185              select_order1
 400  8185 32 C8 88     	ld (order_val),a
 401  8188 CD 8E 81     	call print_order
 402  818B C3 A9 80     	jp loop_artview
 403  818E
 404  818E              print_order ;печать порядка
 405  818E 21 6F 88     	ld hl,msg_order
 406  8191              	OS_PRINTZ
 406  8191 0E 09       >    ld c,#09
 406  8193 E7          >    rst #20
 407  8194
 408  8194 3E 05        	ld a,5;цвет
 409  8196 06 0C        	ld b,#c
 410  8198              	OS_SET_COLOR
 410  8198 0E 06       >    ld c,#06
 410  819A E7          >    rst #20
 411  819B
 412  819B 3A C8 88     	ld a,(order_val)
 413  819E B7           	or a
 414  819F 20 08        	jr nz,select_order_from_new
 415  81A1 21 8D 88     	ld hl,msg_order_random
 416  81A4              	OS_PRINTZ
 416  81A4 0E 09       >    ld c,#09
 416  81A6 E7          >    rst #20
 417  81A7 18 12        	jr select_order_ex
 418  81A9              select_order_from_new
 419  81A9 FE 01        	cp 1
 420  81AB 20 08        	jr nz,select_order_from_old
 421  81AD 21 95 88     	ld hl,msg_order_from_new
 422  81B0              	OS_PRINTZ
 422  81B0 0E 09       >    ld c,#09
 422  81B2 E7          >    rst #20
 423  81B3 18 06        	jr select_order_ex
 424  81B5              select_order_from_old
 425  81B5 21 A6 88     	ld hl,msg_order_from_old
 426  81B8              	OS_PRINTZ
 426  81B8 0E 09       >    ld c,#09
 426  81BA E7          >    rst #20
 427  81BB              select_order_ex
 428  81BB 3E 07        	ld a,7 ;цвет
 429  81BD 06 0C        	ld b,#c
 430  81BF              	OS_SET_COLOR
 430  81BF 0E 06       >    ld c,#06
 430  81C1 E7          >    rst #20
 431  81C2 C9           	ret
 432  81C3
 433  81C3
 434  81C3
 435  81C3
 436  81C3
 437  81C3              scr_view ;просмотр картинки
 438  81C3              ;вх: HL - адрес картинки (scr 6912 байт)
 439  81C3 E5               push hl
 440  81C4              scr_view_wait
 441  81C4 3E 07        	ld a,7
 442  81C6              	OS_SET_SCREEN ;включить экран
 442  81C6 0E 1D       >    ld c,#1d
 442  81C8 E7          >    rst #20
 443  81C9 30 03        	jr nc,scr_view_ok
 444  81CB              	OS_WAIT
 444  81CB DF          >	rst #18
 445  81CC 18 F6        	jr scr_view_wait
 446  81CE              scr_view_ok
 447  81CE              	;если успешно включили экран, перекинем картинку
 448  81CE              	OS_GET_MAIN_PAGES
 448  81CE 0E 1E       >    ld c,#1e
 448  81D0 E7          >    rst #20
 449  81D1 78           	ld a,b ; страница с буфером
 450  81D2 06 07        	ld b,7 ;страница назначения
 451  81D4              	;ld hl,outputBuffer
 452  81D4 E1           	pop hl
 453  81D5 11 00 C0     	ld de,#c000
 454  81D8 DD 21 00 1B  	ld ix,6912
 455  81DC              	OS_RAM_COPY ;скопировать картинку на экран
 455  81DC 0E 19       >    ld c,#19
 455  81DE E7          >    rst #20
 456  81DF
 457  81DF 3A C9 88     	ld a,(time_view)
 458  81E2 47           	ld b,a
 459  81E3              scr_view_wait2 ;scr_view
 460  81E3 C5           	push bc
 461  81E4              	OS_WAIT
 461  81E4 DF          >	rst #18
 462  81E5              	OS_GET_CHAR
 462  81E5 0E 10       >    ld c,#10
 462  81E7 E7          >    rst #20
 463  81E8 FE FF        	cp 255
 464  81EA 20 05        	jr nz,scr_view_wait3
 465  81EC C1           	pop bc
 466  81ED 10 F4        	djnz scr_view_wait2
 467  81EF 18 01        	jr scr_view_wait_ex
 468  81F1              scr_view_wait3
 469  81F1 C1           	pop bc
 470  81F2
 471  81F2              scr_view_wait_ex
 472  81F2 F5           	push af ;сохраним клавишу
 473  81F3 AF           	xor a ;текстовый
 474  81F4              	OS_SET_SCREEN
 474  81F4 0E 1D       >    ld c,#1d
 474  81F6 E7          >    rst #20
 475  81F7 F1           	pop af
 476  81F8 C9               ret
 477  81F9
 478  81F9
 479  81F9
 480  81F9
 481  81F9
 482  81F9              artview_main_error ;печать ошибка
 483  81F9              	;какая-то ошибка
 484  81F9 3E 02        	ld a,2 ;цвет
 485  81FB 06 0C        	ld b,#c
 486  81FD              	OS_SET_COLOR
 486  81FD 0E 06       >    ld c,#06
 486  81FF E7          >    rst #20
 487  8200 21 BE 87     	ld hl,msg_error
 488  8203              	OS_PRINTZ
 488  8203 0E 09       >    ld c,#09
 488  8205 E7          >    rst #20
 489  8206 3E 07        	ld a,7 ;цвет
 490  8208 06 0C        	ld b,#c
 491  820A              	OS_SET_COLOR
 491  820A 0E 06       >    ld c,#06
 491  820C E7          >    rst #20
 492  820D CD 80 84     	call delay ;задержка
 493  8210 C9           	ret
 494  8211
 495  8211              artview_open_site ;открыть сайт
 496  8211              	OS_ESP_CLOSE ;на всякий случай сначала закрыть
 496  8211 0E 0C       >    ld c,#0c
 496  8213 E7          >    rst #20
 497  8214 21 B7 87     	ld hl,msg_open ;печать инфы
 498  8217              	OS_PRINTZ
 498  8217 0E 09       >    ld c,#09
 498  8219 E7          >    rst #20
 499  821A 21 3C 87     	ld hl,site_name
 500  821D              	OS_PRINTZ
 500  821D 0E 09       >    ld c,#09
 500  821F E7          >    rst #20
 501  8220 3E 0D        	ld a,13 ;новая строка
 502  8222              	OS_PRINT_CHARF
 502  8222 D7          >	rst #10
 503  8223 21 3C 87     	ld hl,site_name ;сайт
 504  8226 11 45 87     	ld de,port_number
 505  8229              	;call Wifi.openTCP ;открыть сайт
 506  8229 AF           	xor a ;открыть TCP
 507  822A              	OS_ESP_OPEN
 507  822A 0E 0D       >    ld c,#0d
 507  822C E7          >    rst #20
 508  822D D8           	ret c ;сразу не удалось (может, очередь)
 509  822E              	;или подождём открытия
 510  822E 06 64        	ld b,wait_count ;
 511  8230              artview_open_site_wait
 512  8230              	OS_WAIT
 512  8230 DF          >	rst #18
 513  8231 DD 7E 02     	ld a,(ix+2) ;флаг
 514  8234 07           	rlca
 515  8235 D8           	ret c ;если ошибка (=255)
 516  8236 B7           	or a ;если флаг !=0
 517  8237 C0           	ret nz
 518  8238 10 F6        	djnz artview_open_site_wait
 519  823A 37           	scf ;ощибка
 520  823B C9           	ret
 521  823C
 522  823C
 523  823C
 524  823C
 525  823C
 526  823C              artview_request_info ;запрос инфы
 527  823C CD 11 82     	call artview_open_site ;открыть сайт
 528  823F D8           	ret c
 529  8240
 530  8240 21 E0 87     	ld hl,msg_request_info ;
 531  8243              	OS_PRINTZ
 531  8243 0E 09       >    ld c,#09
 531  8245 E7          >    rst #20
 532  8246 11 D3 88     	ld de,requestbuffer
 533  8249 CD A3 84     	call strLen ;узнать длину
 534  824C EB           	ex de,hl
 535  824D 21 D3 88     	ld hl,requestbuffer
 536  8250              	;call Wifi.tcpSendZ ;послать запрос
 537  8250              	OS_ESP_SEND
 537  8250 0E 0E       >    ld c,#0e
 537  8252 E7          >    rst #20
 538  8253 D8           	ret c;сразу не удалось (может, очередь)
 539  8254              	;ждём когда запрос пройдёт
 540  8254 06 64        	ld b,wait_count ;
 541  8256              artview_request_info_wait2
 542  8256              	OS_WAIT
 542  8256 DF          >	rst #18
 543  8257 DD 7E 04     	ld a,(ix+4) ;флаг
 544  825A 07           	rlca
 545  825B D8           	ret c ;если ошибка (=255)
 546  825C B7           	or a
 547  825D C0           	ret nz
 548  825E 10 F6        	djnz artview_request_info_wait2
 549  8260 37           	scf ;ощибка
 550  8261 C9           	ret
 551  8262
 552  8262
 553  8262              artview_download_info ;загрузить инфо
 554  8262
 555  8262 21 CE 87     	ld hl,msg_download_info ;
 556  8265              	OS_PRINTZ
 556  8265 0E 09       >    ld c,#09
 556  8267 E7          >    rst #20
 557  8268
 558  8268 CD E0 84     	call clear_outputBuffer ;очистить
 559  826B
 560  826B 21 2B 8B     	ld hl,outputBuffer ;буфер для загрузки
 561  826E 22 35 87     	ld (buffer_pointer),hl
 562  8271              	;call Wifi.getPacket ;получить ответ
 563  8271              	OS_ESP_GET
 563  8271 0E 0F       >    ld c,#0f
 563  8273 E7          >    rst #20
 564  8274 D8           	ret c ;сразу не удалось (может, очередь)
 565  8275 06 64        	ld b,wait_count ;
 566  8277              artview_download_info_wait1
 567  8277              	OS_WAIT
 567  8277 DF          >	rst #18
 568  8278 DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 569  827B 07           	rlca
 570  827C D8           	ret c ;если ошибка (=255)
 571  827D B7           	or a
 572  827E 20 04        	jr nz,artview_download_info_wait1_skip
 573  8280 10 F5        	djnz artview_download_info_wait1
 574  8282 37           	scf ;ощибка
 575  8283 C9           	ret
 576  8284
 577  8284              artview_download_info_wait1_skip
 578  8284              	;подготовка к приёму дальше
 579  8284 2A 35 87     	ld hl,(buffer_pointer)
 580  8287 DD 4E 09     	ld c,(ix+9) ; длина принятого
 581  828A DD 46 0A     	ld b,(ix+10)
 582  828D 09           	add hl,bc
 583  828E 22 35 87     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 584  8291
 585  8291              	;попробуем найти начало данных
 586  8291 11 48 87     	ld de,Content_Length ;найти запись о длине данных
 587  8294 CD C6 84     	call search_str
 588  8297 D8           	ret c
 589  8298
 590  8298 EB           	ex de,hl
 591  8299 CD AD 84     	call text_to_digit ;преобразовать в число
 592  829C 22 33 87     	ld (data_length),hl ;длина данных
 593  829F
 594  829F 11 37 87     	ld de,rnrn ;найти конец заголовка
 595  82A2 CD C6 84     	call search_str
 596  82A5 D8           	ret c
 597  82A6 22 2F 87     	ld (data_start),hl ;начало данных
 598  82A9
 599  82A9 ED 5B 33 87  	ld de,(data_length)
 600  82AD 19           	add hl,de ;узнали ожидаемый конец данных
 601  82AE 22 31 87     	ld (data_end),hl
 602  82B1
 603  82B1              ;загрузка остальных частей, если есть
 604  82B1              artview_download_info1
 605  82B1 DD 7E 02     	ld a,(ix+2) ;!!! closed
 606  82B4 B7           	or a
 607  82B5 28 35        	jr z,artview_download_info1_skip ;если закрыто, больше не грузим
 608  82B7
 609  82B7 2A 35 87     	ld hl,(buffer_pointer)
 610  82BA ED 5B 31 87  	ld de,(data_end)
 611  82BE A7           	and a
 612  82BF ED 52        	sbc hl,de
 613  82C1 28 29        	jr z,artview_download_info1_skip ;если уже всё загружено
 614  82C3
 615  82C3
 616  82C3              	;ещё не всё
 617  82C3 2A 35 87     	ld hl,(buffer_pointer)
 618  82C6 7C           	ld a,h
 619  82C7 FE FA        	cp buffer_top ;ограничение
 620  82C9 30 21        	jr nc,artview_download_info1_skip
 621  82CB
 622  82CB              	;call Wifi.getPacket
 623  82CB              	OS_ESP_GET
 623  82CB 0E 0F       >    ld c,#0f
 623  82CD E7          >    rst #20
 624  82CE 06 64        	ld b,wait_count ;
 625  82D0              artview_download_info_wait2
 626  82D0              	OS_WAIT
 626  82D0 DF          >	rst #18
 627  82D1 DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 628  82D4 07           	rlca
 629  82D5 D8           	ret c ;если ошибка (=255)
 630  82D6 B7           	or a
 631  82D7 20 04        	jr nz,artview_download_info_wait2_skip
 632  82D9 10 F5        	djnz artview_download_info_wait2
 633  82DB 37           	scf
 634  82DC C9           	ret
 635  82DD
 636  82DD              artview_download_info_wait2_skip
 637  82DD 2A 35 87     	ld hl,(buffer_pointer)
 638  82E0 DD 4E 09     	ld c,(ix+9) ; длина принятого
 639  82E3 DD 46 0A     	ld b,(ix+10)
 640  82E6 09           	add hl,bc
 641  82E7 22 35 87     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 642  82EA
 643  82EA 18 C5        	jr artview_download_info1 ;получить ещё части до конца
 644  82EC
 645  82EC              artview_download_info1_skip
 646  82EC
 647  82EC              	OS_ESP_CLOSE ;закрыть соединение!
 647  82EC 0E 0C       >    ld c,#0c
 647  82EE E7          >    rst #20
 648  82EF
 649  82EF
 650  82EF 11 59 87     	ld de,Content_Sucesfully ;найти запись об успешном запросе
 651  82F2 CD C6 84     	call search_str
 652  82F5 D8           	ret c
 653  82F6
 654  82F6              	; ld de,Content_Length ;найти запись о длине
 655  82F6              	; call search_str
 656  82F6              	; ret c
 657  82F6
 658  82F6              	; ex de,hl
 659  82F6              	; call text_to_digit ;преобразовать в число
 660  82F6
 661  82F6              	; ex de,hl
 662  82F6              	; ld hl,(buffer_pointer) ;
 663  82F6              	; and a
 664  82F6              	; sbc hl,de
 665  82F6              	; ;узнали начало пакета
 666  82F6
 667  82F6 2A 2F 87     	ld hl,(data_start)
 668  82F9
 669  82F9 11 9F 87     	ld de,Content_ID ;найти запись об ID файла
 670  82FC CD C6 84     	call search_str
 671  82FF D8           	ret c
 672  8300
 673  8300
 674  8300              	;инфа получена
 675  8300
 676  8300 E5           	push hl
 677  8301 CD 03 84     	call print_info_art ;инфо
 678  8304 3E 0D        	ld a,13
 679  8306              	OS_PRINT_CHARF
 679  8306 D7          >	rst #10
 680  8307 E1           	pop hl
 681  8308 11 A6 89     	ld de,requestbuffer2_file_id
 682  830B
 683  830B              ;WAITKEY	XOR A:IN A,(#FE):CPL:AND #1F:JR Z,WAITKEY
 684  830B
 685  830B CD 86 84     	call id_copy ;скопировать в запрос id арта
 686  830E
 687  830E              	;запомнить сколько всего
 688  830E 11 60 87     	ld de,Content_Total_Amount ;всего таких артов
 689  8311 CD C6 84     	call search_str
 690  8314 D8           	ret c
 691  8315 EB           	ex de,hl
 692  8316 CD AD 84     	call text_to_digit
 693  8319 22 C1 88     	ld (total_art),hl
 694  831C B7           	or a
 695  831D C9           	ret
 696  831E
 697  831E
 698  831E
 699  831E
 700  831E
 701  831E
 702  831E              artview_request_art	;запрос арта
 703  831E CD 11 82     	call artview_open_site ;открыть сайт
 704  8321 D8           	ret c
 705  8322
 706  8322 21 F1 87     	ld hl,msg_request_art
 707  8325              	OS_PRINTZ
 707  8325 0E 09       >    ld c,#09
 707  8327 E7          >    rst #20
 708  8328
 709  8328              	;ld hl,requestbuffer2_title
 710  8328              	;OS_PRINTZ
 711  8328 11 99 89     	ld de,requestbuffer2
 712  832B CD A3 84     	call strLen ;узнать длину
 713  832E EB           	ex de,hl
 714  832F 21 99 89     	ld hl,requestbuffer2
 715  8332              	OS_ESP_SEND
 715  8332 0E 0E       >    ld c,#0e
 715  8334 E7          >    rst #20
 716  8335 D8           	ret c ;сразу не удалось (может, очередь)
 717  8336              	;ждём когда запрос пройдёт
 718  8336 06 64        	ld b,wait_count ;
 719  8338              artview_request_art_wait2
 720  8338              	OS_WAIT
 720  8338 DF          >	rst #18
 721  8339 DD 7E 04     	ld a,(ix+4) ;флаг
 722  833C 07           	rlca
 723  833D D8           	ret c ;если ошибка (=255)
 724  833E B7           	or a
 725  833F C0           	ret nz
 726  8340 10 F6        	djnz artview_request_art_wait2
 727  8342 37           	scf
 728  8343 C9           	ret
 729  8344
 730  8344
 731  8344
 732  8344
 733  8344              artview_download_art ;загрузить арт
 734  8344 21 01 88     	ld hl,msg_download_art
 735  8347              	OS_PRINTZ
 735  8347 0E 09       >    ld c,#09
 735  8349 E7          >    rst #20
 736  834A
 737  834A CD E0 84     	call clear_outputBuffer ;очистить
 738  834D
 739  834D 21 2B 8B     	ld hl,outputBuffer ;буфер для загрузки
 740  8350 22 35 87     	ld (buffer_pointer),hl
 741  8353              	;call Wifi.getPacket ;получить ответ
 742  8353              	OS_ESP_GET
 742  8353 0E 0F       >    ld c,#0f
 742  8355 E7          >    rst #20
 743  8356 D8           	ret c ;сразу не удалось (может, очередь)
 744  8357 06 64        	ld b,wait_count ;
 745  8359              artview_download_art_wait1
 746  8359              	OS_WAIT
 746  8359 DF          >	rst #18
 747  835A DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 748  835D 07           	rlca
 749  835E D8           	ret c ;если ошибка (=255)
 750  835F B7           	or a
 751  8360 20 04        	jr nz,artview_download_art_wait1_skip
 752  8362 10 F5        	djnz artview_download_art_wait1
 753  8364 37           	scf
 754  8365 C9           	ret
 755  8366
 756  8366              artview_download_art_wait1_skip
 757  8366              	;подготовка к приёму дальше
 758  8366 2A 35 87     	ld hl,(buffer_pointer)
 759  8369 DD 4E 09     	ld c,(ix+9) ; длина принятого
 760  836C DD 46 0A     	ld b,(ix+10)
 761  836F 09           	add hl,bc
 762  8370 22 35 87     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 763  8373
 764  8373              	;попробуем найти начало данных
 765  8373 11 48 87     	ld de,Content_Length ;найти запись о длине данных
 766  8376 CD C6 84     	call search_str
 767  8379 D8           	ret c
 768  837A
 769  837A EB           	ex de,hl
 770  837B CD AD 84     	call text_to_digit ;преобразовать в число
 771  837E 22 33 87     	ld (data_length),hl ;длина данных
 772  8381
 773  8381 11 37 87     	ld de,rnrn ;найти конец заголовка
 774  8384 CD C6 84     	call search_str
 775  8387 D8           	ret c
 776  8388 22 2F 87     	ld (data_start),hl ;начало данных
 777  838B
 778  838B ED 5B 33 87  	ld de,(data_length)
 779  838F 19           	add hl,de ;узнали ожидаемый конец данных
 780  8390 22 31 87     	ld (data_end),hl
 781  8393
 782  8393              	;загрузка остатка
 783  8393              artview_download_art1
 784  8393
 785  8393 DD 7E 02     	ld a,(ix+2) ;!!! closed
 786  8396 B7           	or a
 787  8397 28 35        	jr z,artview_download_art1_skip ;если закрыто, больше не грузим
 788  8399
 789  8399 2A 35 87     	ld hl,(buffer_pointer)
 790  839C ED 5B 31 87  	ld de,(data_end)
 791  83A0 A7           	and a
 792  83A1 ED 52        	sbc hl,de
 793  83A3 28 29        	jr z,artview_download_art1_skip ;если уже всё загружено
 794  83A5
 795  83A5
 796  83A5              	;ещё не всё
 797  83A5 2A 35 87     	ld hl,(buffer_pointer)
 798  83A8 7C           	ld a,h
 799  83A9 FE FA        	cp buffer_top ;ограничение
 800  83AB 30 21        	jr nc,artview_download_art1_skip
 801  83AD
 802  83AD              	;call Wifi.getPacket
 803  83AD              	OS_ESP_GET
 803  83AD 0E 0F       >    ld c,#0f
 803  83AF E7          >    rst #20
 804  83B0 06 64        	ld b,wait_count ;
 805  83B2              artview_download_art_wait2
 806  83B2              	OS_WAIT
 806  83B2 DF          >	rst #18
 807  83B3 DD 7E 06     	ld a,(ix+6) ;флаг результат приёма
 808  83B6 07           	rlca
 809  83B7 D8           	ret c ;если ошибка (=255)
 810  83B8 B7           	or a
 811  83B9 20 04        	jr nz,artview_download_art_wait2_skip
 812  83BB 10 F5        	djnz artview_download_art_wait2
 813  83BD 37           	scf
 814  83BE C9           	ret
 815  83BF
 816  83BF              artview_download_art_wait2_skip
 817  83BF 2A 35 87     	ld hl,(buffer_pointer)
 818  83C2 DD 4E 09     	ld c,(ix+9) ; длина принятого
 819  83C5 DD 46 0A     	ld b,(ix+10)
 820  83C8 09           	add hl,bc
 821  83C9 22 35 87     	ld (buffer_pointer),hl ;продолжить загружать с этого места
 822  83CC
 823  83CC 18 C5        	jr artview_download_art1 ;получить ещё части до конца
 824  83CE
 825  83CE              artview_download_art1_skip
 826  83CE              	OS_ESP_CLOSE ;закрыть!
 826  83CE 0E 0C       >    ld c,#0c
 826  83D0 E7          >    rst #20
 827  83D1
 828  83D1
 829  83D1              	; ;определить длину
 830  83D1              	; ld de,Content_Length ;найти запись о длине
 831  83D1              	; call search_str
 832  83D1              	; ret c
 833  83D1              	; ex de,hl
 834  83D1              	; call text_to_digit ;преобразовать в число
 835  83D1
 836  83D1              	; ex de,hl
 837  83D1              	; ld hl,(buffer_pointer) ;
 838  83D1              	; and a
 839  83D1              	; sbc hl,de
 840  83D1              	; ;узнали начало пакета
 841  83D1 21 B7 88     	ld hl,msg_download_size ;печать размера
 842  83D4              	OS_PRINTZ
 842  83D4 0E 09       >    ld c,#09
 842  83D6 E7          >    rst #20
 843  83D7 2A 33 87     	ld hl,(data_length)
 844  83DA CD 3F 85     	call toDecimal
 845  83DD              	OS_PRINTZ
 845  83DD 0E 09       >    ld c,#09
 845  83DF E7          >    rst #20
 846  83E0 21 BE 88     	ld hl,msg_B
 847  83E3              	OS_PRINTZ
 847  83E3 0E 09       >    ld c,#09
 847  83E5 E7          >    rst #20
 848  83E6
 849  83E6 2A 2F 87     	ld hl,(data_start) ;начало данных
 850  83E9 B7           	or a
 851  83EA C9           	ret
 852  83EB
 853  83EB
 854  83EB
 855  83EB
 856  83EB
 857  83EB
 858  83EB              print_sys_info ;печать меню управления
 859  83EB 3E 47        	ld a,7+64 ;цвет
 860  83ED 06 0C        	ld b,#c
 861  83EF              	OS_SET_COLOR
 861  83EF 0E 06       >    ld c,#06
 861  83F1 E7          >    rst #20
 862  83F2 21 31 88     	ld hl,msg_sys_info
 863  83F5              	OS_PRINTZ
 863  83F5 0E 09       >    ld c,#09
 863  83F7 E7          >    rst #20
 864  83F8
 865  83F8 CD 8E 81     	call print_order
 866  83FB
 867  83FB 3E 07        	ld a,7 ;цвет
 868  83FD 06 0C        	ld b,#c
 869  83FF              	OS_SET_COLOR
 869  83FF 0E 06       >    ld c,#06
 869  8401 E7          >    rst #20
 870  8402 C9           	ret
 871  8403
 872  8403
 873  8403              print_info_art ;печать инфо о арте
 874  8403 CD DF 85     	call save_file_prep_name ;запомнить имя файла
 875  8406
 876  8406 21 7B 88     	ld hl,msg_cur_number
 877  8409              	OS_PRINTZ
 877  8409 0E 09       >    ld c,#09
 877  840B E7          >    rst #20
 878  840C 2A C5 88     	ld hl,(cur_art)
 879  840F CD 3F 85     	call toDecimal
 880  8412              	OS_PRINTZ
 880  8412 0E 09       >    ld c,#09
 880  8414 E7          >    rst #20
 881  8415
 882  8415 21 60 87     	ld hl,Content_Total_Amount ;всего таких артов
 883  8418 CD 61 84     	call print_info_art_one
 884  841B D8           	ret c
 885  841C
 886  841C 21 9F 87     	ld hl,Content_ID ;id арта
 887  841F CD 61 84     	call print_info_art_one
 888  8422 D8           	ret c
 889  8423
 890  8423 21 A5 87     	ld hl,Content_Type ;формат арта
 891  8426 CD 61 84     	call print_info_art_one
 892  8429 D8           	ret c
 893  842A
 894  842A 3E 04        	ld a,4 ;цвет
 895  842C 06 0C        	ld b,#c
 896  842E              	OS_SET_COLOR
 896  842E 0E 06       >    ld c,#06
 896  8430 E7          >    rst #20
 897  8431 21 6F 87     	ld hl,Content_Title ;название арта
 898  8434 CD 61 84     	call print_info_art_one
 899  8437 F5           	push af
 900  8438 3E 07        	ld a,7 ;цвет
 901  843A 06 0C        	ld b,#c
 902  843C              	OS_SET_COLOR
 902  843C 0E 06       >    ld c,#06
 902  843E E7          >    rst #20
 903  843F F1           	pop af
 904  8440 D8           	ret c
 905  8441
 906  8441 21 8F 87     	ld hl,Content_Year ;год арта
 907  8444 CD 61 84     	call print_info_art_one
 908  8447 D8           	ret c
 909  8448
 910  8448 21 97 87     	ld hl,Content_Time ;длина арта
 911  844B CD 61 84     	call print_info_art_one
 912  844E D8           	ret c
 913  844F
 914  844F 21 85 87     	ld hl,Content_Rating ;рейтинг арта
 915  8452 CD 61 84     	call print_info_art_one
 916  8455 D8           	ret c
 917  8456
 918  8456 21 78 87     	ld hl,Content_AuthorIDs ;id автора арта
 919  8459 CD 61 84     	call print_info_art_one
 920  845C D8           	ret c
 921  845D
 922  845D 3E 0D        	ld a,13
 923  845F              	OS_PRINT_CHARF
 923  845F D7          >	rst #10
 924  8460 C9           	ret
 925  8461
 926  8461
 927  8461              print_info_art_one
 928  8461 E5           	push hl
 929  8462 3E 0D        	ld a,13
 930  8464              	OS_PRINT_CHARF
 930  8464 D7          >	rst #10
 931  8465 E1           	pop hl
 932  8466 E5           	push hl
 933  8467              	OS_PRINTZ
 933  8467 0E 09       >    ld c,#09
 933  8469 E7          >    rst #20
 934  846A D1           	pop de
 935  846B CD C6 84     	call search_str
 936  846E D8           	ret c
 937  846F CD 74 84     	call print_to_sym ;печать значения
 938  8472 B7           	or a
 939  8473 C9           	ret
 940  8474
 941  8474              print_to_sym ;печать до символа "," или 0
 942  8474 7E           	ld a,(hl)
 943  8475 FE 2C        	cp ","
 944  8477 C8           	ret z
 945  8478 B7           	or a
 946  8479 C8           	ret z
 947  847A E5           	push hl
 948  847B              	OS_PRINT_CHARF
 948  847B D7          >	rst #10
 949  847C E1           	pop hl
 950  847D 23           	inc hl
 951  847E 18 F4        	jr print_to_sym
 952  8480
 953  8480
 954  8480              delay ;задержка между запросами
 955  8480 06 32        	ld b,50*1 ;
 956  8482              delay1
 957  8482              	OS_WAIT
 957  8482 DF          >	rst #18
 958  8483 10 FD        	djnz delay1
 959  8485 C9           	ret
 960  8486
 961  8486              ;hl - from
 962  8486              ;de - to
 963  8486              id_copy ;скопировать текст id
 964  8486 7E           	ld a,(hl)
 965  8487 FE 30        	cp "0"
 966  8489 38 09        	jr c,id_copy2
 967  848B FE 3A        	cp "9"+1
 968  848D 30 05        	jr nc,id_copy2
 969  848F 12           	ld (de),a
 970  8490 13           	inc de
 971  8491 23           	inc hl
 972  8492 18 F2        	jr id_copy
 973  8494
 974  8494              id_copy2
 975  8494              	;скопировать остаток строки запроса
 976  8494 21 A6 8A     	ld hl,requestbuffer2_end
 977  8497              id_copy3
 978  8497 7E           	ld a,(hl)
 979  8498 B7           	or a
 980  8499 28 05        	jr z,id_copy_ex
 981  849B 12           	ld (de),a
 982  849C 13           	inc de
 983  849D 23           	inc hl
 984  849E 18 F7        	jr id_copy3
 985  84A0              id_copy_ex
 986  84A0 AF           	xor a
 987  84A1 12           	ld (de),a  ;в конце 0
 988  84A2 C9           	ret
 989  84A3
 990  84A3              strLen: ;посчитать длину строки до 0
 991  84A3 21 00 00         ld hl, 0
 992  84A6              .loop
 993  84A6 1A               ld a, (de)
 993  84A7 A7             and a
 993  84A8 C8             ret z
 994  84A9 13 23            inc de, hl
 995  84AB 18 F9            jr .loop
 996  84AD
 997  84AD              text_to_digit ;тест в цифру
 998  84AD              ;de - текст
 999  84AD              ;вых: hl - цифра
1000  84AD 21 00 00     		ld hl,0			; count lenght
1001  84B0 1A           .cil1	ld a,(de)
1002  84B1 13           		inc de
1003  84B2 FE 30        		cp "0"
1003  84B4 D8             ret c
1004  84B5 FE 3A        		cp "9"+1
1004  84B7 D0             ret nc
1005  84B8 D6 30        		sub 0x30
1005  84BA 4D             ld c,l
1005  84BB 44             ld b,h
1005  84BC 29             add hl,hl
1005  84BD 29             add hl,hl
1005  84BE 09             add hl,bc
1005  84BF 29             add hl,hl
1005  84C0 4F             ld c,a
1005  84C1 06 00          ld b,0
1005  84C3 09             add hl,bc
1006  84C4 18 EA        		jr .cil1
1007  84C6
1008  84C6              ;поиск строки
1009  84C6              ;de - образец, в конце 0
1010  84C6              ;вых: hl - адрес после найденного
1011  84C6              search_str
1012  84C6 21 2B 8B     	ld hl,outputBuffer
1013  84C9 42           	ld b,d
1014  84CA 4B           	ld c,e
1015  84CB              search_str2
1016  84CB 1A           	ld a,(de)
1017  84CC BE           	cp (hl)
1018  84CD 20 0A        	jr nz,search_str1
1019  84CF              	;нашли одну букву
1020  84CF              search_str3
1021  84CF 23           	inc hl
1022  84D0 13           	inc de
1023  84D1 1A           	ld a,(de)
1024  84D2 B7           	or a
1025  84D3 C8           	ret z ;нашли всю строку
1026  84D4 BE           	cp (hl)
1027  84D5 28 F8        	jr z,search_str3
1028  84D7              	;не вся строка совпала
1029  84D7 50           	ld d,b ;в начало образца
1030  84D8 59           	ld e,c
1031  84D9              search_str1
1032  84D9 23           	inc hl ;дальше
1033  84DA 24           	inc h
1034  84DB 25           	dec h
1035  84DC 20 ED        	jr nz,search_str2
1036  84DE 37           	scf ;не нашли
1037  84DF C9           	ret
1038  84E0
1039  84E0
1040  84E0              clear_outputBuffer ;почистить буфер приёма
1041  84E0 21 2B 8B     	ld hl,outputBuffer
1042  84E3 11 2C 8B     	ld de,outputBuffer+1
1043  84E6 01 D3 74     	ld bc,#ffff-outputBuffer-1
1044  84E9 36 00        	ld (hl),0
1045  84EB ED B0        	ldir
1046  84ED C9           	ret
1047  84EE
1048  84EE
1049  84EE              ;вх: HL - диапазон
1050  84EE              ;вых: HL - результат
1051  84EE              rnd ;генератор случайного числа в заданном диапазоне
1052  84EE 7C           	ld a,h
1053  84EF B5           	or l
1054  84F0 C8           	ret z
1055  84F1 AF           	xor a ;очистить переменную
1056  84F2 32 18 85     	ld (rnd_out),a
1057  84F5 32 19 85     	ld (rnd_out+1),a
1058  84F8 E5           	push hl
1059  84F9 CD 1A 85     	call random ;получить случайное
1060  84FC              	;умножить диапазон на случайное число и взять старшие два байта
1061  84FC C1           	pop bc ;счётчик
1062  84FD EB           	ex de,hl
1063  84FE 21 00 00     	ld hl,0
1064  8501              rnd_cl
1065  8501 19           	add hl,de
1066  8502 30 0B        	jr nc,rnd_cl1 ;если нет переполения
1067  8504 D9           	exx
1068  8505 ED 5B 18 85  	ld de,(rnd_out) ;увеличить старшие байты
1069  8509 13           	inc de
1070  850A ED 53 18 85  	ld (rnd_out),de
1071  850E D9           	exx
1072  850F              rnd_cl1
1073  850F 0B           	dec bc
1074  8510 78           	ld a,b
1075  8511 B1           	or c
1076  8512 20 ED        	jr nz,rnd_cl
1077  8514 2A 18 85     	ld hl,(rnd_out)
1078  8517 C9           	ret
1079  8518 00 00        rnd_out dw 0 ;ответ случайное число
1080  851A
1081  851A
1082  851A              random ;Переписанный генератор из ПЗУ бейсика
1083  851A 11 00 00     	ld	de,0
1084  851D              seed	equ	$-2
1085  851D AF           	xor	a
1086  851E 67 6F 47     	ld	h,a,l,a,b,a
1087  8521 19           	add	hl,de
1088  8522 88           	adc	a,b
1089  8523 29           	add	hl,hl
1090  8524 8F           	adc	a,a
1091  8525 29           	add	hl,hl
1092  8526 8F           	adc	a,a
1093  8527 29           	add	hl,hl
1094  8528 8F           	adc	a,a
1095  8529 19           	add	hl,de
1096  852A 88           	adc	a,b
1097  852B 29           	add	hl,hl
1098  852C 8F           	adc	a,a
1099  852D 29           	add	hl,hl
1100  852E 8F           	adc	a,a
1101  852F 19           	add	hl,de
1102  8530 88           	adc	a,b
1103  8531 29           	add	hl,hl
1104  8532 8F           	adc	a,a
1105  8533 19           	add	hl,de
1106  8534 88           	adc	a,b
1107  8535 D6 4A        	sub	#4a
1108  8537 ED 44        	neg
1109  8539 4F           	ld	c,a
1110  853A 09           	add	hl,bc
1111  853B 22 1B 85     	ld	(seed),hl
1112  853E C9           	ret
1113  853F
1114  853F              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
1115  853F              				;на входе в HL число
1116  853F 11 10 27     			ld de,10000 ;десятки тысяч
1117  8542 3E FF        			ld a,255
1118  8544              toDecimal10k
1119  8544 A7           			and a
1120  8545 ED 52        			sbc hl,de
1121  8547 3C           			inc a
1122  8548 30 FA        			jr nc,toDecimal10k
1123  854A 19           			add hl,de
1124  854B C6 30        			add a,48
1125  854D 32 98 85     			ld (decimalS),a
1126  8550 11 E8 03     			ld de,1000 ;тысячи
1127  8553 3E FF        			ld a,255
1128  8555              toDecimal1k
1129  8555 A7           			and a
1130  8556 ED 52        			sbc hl,de
1131  8558 3C           			inc a
1132  8559 30 FA        			jr nc,toDecimal1k
1133  855B 19           			add hl,de
1134  855C C6 30        			add a,48
1135  855E 32 99 85     			ld (decimalS+1),a
1136  8561 11 64 00     			ld de,100 ;сотни
1137  8564 3E FF        			ld a,255
1138  8566              toDecimal01k
1139  8566 A7           			and a
1140  8567 ED 52        			sbc hl,de
1141  8569 3C           			inc a
1142  856A 30 FA        			jr nc,toDecimal01k
1143  856C 19           			add hl,de
1144  856D C6 30        			add a,48
1145  856F 32 9A 85     			ld (decimalS+2),a
1146  8572 11 0A 00     			ld de,10 ;десятки
1147  8575 3E FF        			ld a,255
1148  8577              toDecimal001k
1149  8577 A7           			and a
1150  8578 ED 52        			sbc hl,de
1151  857A 3C           			inc a
1152  857B 30 FA        			jr nc,toDecimal001k
1153  857D 19           			add hl,de
1154  857E C6 30        			add a,48
1155  8580 32 9B 85     			ld (decimalS+3),a
1156  8583 11 01 00     			ld de,1 ;единицы
1157  8586 3E FF        			ld a,255
1158  8588              toDecimal0001k
1159  8588 A7           			and a
1160  8589 ED 52        			sbc hl,de
1161  858B 3C           			inc a
1162  858C 30 FA        			jr nc,toDecimal0001k
1163  858E 19           			add hl,de
1164  858F C6 30        			add a,48
1165  8591 32 9C 85     			ld (decimalS+4),a
1166  8594 21 98 85     			ld hl,decimalS
1167  8597 C9           			ret
1168  8598
1169  8598 00 00 00...  decimalS	ds 6 ;десятичные цифры
1170  859E
1171  859E
1172  859E
1173  859E              save_file ;сохранить на диск
1174  859E 3E 04        	ld a,4;цвет
1175  85A0 06 0C        	ld b,#c
1176  85A2              	OS_SET_COLOR
1176  85A2 0E 06       >    ld c,#06
1176  85A4 E7          >    rst #20
1177  85A5
1178  85A5 21 28 86     	ld hl,msg_save_file ;печать сообщения и имени файла
1179  85A8              	OS_PRINTZ
1179  85A8 0E 09       >    ld c,#09
1179  85AA E7          >    rst #20
1180  85AB
1181  85AB 3E 0D        	ld a,13
1182  85AD              	OS_PRINT_CHARF
1182  85AD D7          >	rst #10
1183  85AE
1184  85AE 3E 07        	ld a,7;цвет
1185  85B0 06 0C        	ld b,#c
1186  85B2              	OS_SET_COLOR
1186  85B2 0E 06       >    ld c,#06
1186  85B4 E7          >    rst #20
1187  85B5
1188  85B5 21 1A 86     	ld hl,path_download ;путь для сохранений
1189  85B8 AF           	xor	a
1190  85B9 3D           	dec	a ;установить текущим
1191  85BA              	OS_FIND_PATH ;найти папку
1191  85BA 0E 29       >    ld c,#29
1191  85BC E7          >    rst #20
1192  85BD
1193  85BD
1194  85BD 21 34 86     	ld hl,save_file_name ;имя
1195  85C0              	OS_FILE_OPEN ;если есть, откроем
1195  85C0 0E 21       >    ld c,#21
1195  85C2 E7          >    rst #20
1196  85C3 30 05        	jr nc,save_file_open_ok
1197  85C5
1198  85C5              	OS_FILE_CREATE ;или создадим
1198  85C5 0E 22       >    ld c,#22
1198  85C7 E7          >    rst #20
1199  85C8 38 0F        	jr c,save_file_ex_err
1200  85CA              save_file_open_ok
1201  85CA              	;файл открыт в A - id файла
1202  85CA
1203  85CA 2A 2F 87     	ld hl,(data_start)
1204  85CD ED 5B 33 87  	ld de,(data_length)
1205  85D1              	OS_FILE_WRITE ;записать
1205  85D1 0E 24       >    ld c,#24
1205  85D3 E7          >    rst #20
1206  85D4 38 03        	jr c,save_file_ex_err
1207  85D6
1208  85D6              save_file_ex_ok
1209  85D6 C3 A9 80     	jp loop_artview
1210  85D9
1211  85D9              save_file_ex_err
1212  85D9 CD F9 81     	call artview_main_error
1213  85DC C3 A9 80     	jp loop_artview
1214  85DF
1215  85DF
1216  85DF              save_file_prep_name
1217  85DF              	;найти и подготовить имя файла
1218  85DF 11 AD 87     	ld de,Content_filename
1219  85E2 CD C6 84     	call search_str
1220  85E5 38 13        	jr c,save_file_prep_name_no ;если не нашли имени
1221  85E7              	;перенести до символа "
1222  85E7 11 34 86     	ld de,save_file_name ;куда
1223  85EA 06 FA        	ld b,save_file_name_max_lenght ;макс длина
1224  85EC 0E FF        	ld c,#ff ;для цикла
1225  85EE              save_file_prep_name_cl ;цикл
1226  85EE 7E           	ld a,(hl)
1227  85EF FE 22        	cp '"'
1228  85F1 28 04        	jr z,save_file_prep_name_ex
1229  85F3 ED A0        	ldi
1230  85F5 18 F7        	jr save_file_prep_name_cl
1231  85F7
1232  85F7              save_file_prep_name_ex
1233  85F7 AF           	xor a
1234  85F8 12           	ld (de),a ;в конце 0
1235  85F9 C9           	ret
1236  85FA
1237  85FA              save_file_prep_name_no
1238  85FA 11 9F 87     	ld de,Content_ID ;id трека
1239  85FD CD C6 84     	call search_str
1240  8600 11 34 86     	ld de,save_file_name ;куда
1241  8603 01 05 00     	ld bc,5
1242  8606 ED B0        	ldir
1243  8608              	;теперь расширение
1244  8608 3E 2E        	ld a,'.'
1245  860A 12           	ld (de),a
1246  860B 13           	inc de
1247  860C 3E 73        	ld a,'s'
1248  860E 12           	ld (de),a
1249  860F 13           	inc de
1250  8610 3E 63        	ld a,'c'
1251  8612 12           	ld (de),a
1252  8613 13           	inc de
1253  8614 3E 72        	ld a,'r'
1254  8616 12           	ld (de),a
1255  8617 13           	inc de
1256  8618 18 DD        	jr save_file_prep_name_ex
1257  861A
1258  861A
1259  861A              save_file_name_max_lenght equ 250 ;максимальная длина имени
1260  861A 5C 4F 53 5A  path_download db "\\OSZ\\Download",0
1260  861E 5C 44 6F 77
1260  8622 6E 6C 6F 61
1260  8626 64 00
1261  8628 0D 53 61 76  msg_save_file db 13,"Save file: "
1261  862C 65 20 66 69
1261  8630 6C 65 3A 20
1262  8634              save_file_name  ;тут имя файла
1263  8634 00 00 00...  	ds save_file_name_max_lenght+1 ;буфер для имени файла
1264  872F
1265  872F
1266  872F
1267  872F                  ; include "drivers/utils.asm"
1268  872F                  ; include "drivers/wifi.asm"
1269  872F              	; include "drivers/zx-wifi.asm"
1270  872F
1271  872F
1272  872F              id_lenght equ 6 ;длина кода файла
1273  872F              wait_count equ 2*50 ;задержка в кадрах
1274  872F              buffer_top equ #fa;ограничение буфера сверху #ffff - 1500
1275  872F
1276  872F              ; ;ответы ESP
1277  872F              ; sendOk[] = "SEND OK";
1278  872F              ; const unsigned char gotWiFi[] = "WIFI GOT IP";
1279  872F              ; "CONNECT"
1280  872F
1281  872F              ; ;команды
1282  872F              ; ;<link ID> – ID соединения (0–4), используется при нескольких соединениях;
1283  872F              ; at_cipmux db "AT+CIPMUX=1",0 ;несколько соединений
1284  872F              ;at_cipstart db "AT+CIPSTART=1,\"TCP\",\"zxart.ee\",80",0
1285  872F              ; "AT+CIPSEND="
1286  872F              ; "AT+CIPCLOSE"
1287  872F              ;link_id db 0; номер соединения
1288  872F 00 00        data_start dw 0 ;начало данных
1289  8731 00 00        data_end dw 0 ;конец данных
1290  8733 00 00        data_length dw 0 ;длина данных
1291  8735 00 00        buffer_pointer dw 0 ;указатель на буфер
1292  8737 0D 0A 0D 0A  rnrn db 13,10,13,10,0 ;окончание заголовка
1292  873B 00
1293  873C 7A 78 61 72  site_name db "zxart.ee",0 ;имя сайта
1293  8740 74 2E 65 65
1293  8744 00
1294  8745 38 30 00     port_number db "80" ,0;
1295  8748 43 6F 6E 74  Content_Length db "Content-Length: ",0
1295  874C 65 6E 74 2D
1295  8750 4C 65 6E 67
1295  8754 74 68 3A 20
1295  8758 00
1296  8759 73 75 63 63  Content_Sucesfully db "succes",0
1296  875D 65 73 00
1297  8760 22 74 6F 74  Content_Total_Amount db "\"totalAmount\":",0
1297  8764 61 6C 41 6D
1297  8768 6F 75 6E 74
1297  876C 22 3A 00
1298  876F 22 74 69 74  Content_Title db "\"title\":",0
1298  8773 6C 65 22 3A
1298  8777 00
1299  8778 22 61 75 74  Content_AuthorIDs db "\"authorIds\":",0
1299  877C 68 6F 72 49
1299  8780 64 73 22 3A
1299  8784 00
1300  8785 22 72 61 74  Content_Rating db "\"rating\":",0
1300  8789 69 6E 67 22
1300  878D 3A 00
1301  878F 22 79 65 61  Content_Year db "\"year\":",0
1301  8793 72 22 3A 00
1302  8797 22 74 69 6D  Content_Time db "\"time\":",0
1302  879B 65 22 3A 00
1303  879F 22 69 64 22  Content_ID db "\"id\":",0
1303  87A3 3A 00
1304  87A5 22 74 79 70  Content_Type db "\"type\":",0
1304  87A9 65 22 3A 00
1305  87AD 66 69 6C 65  Content_filename db 'filename:',0
1305  87B1 6E 61 6D 65
1305  87B5 3A 00
1306  87B7              ;file_id db "000000",0 ;id файла
1307  87B7 4F 70 65 6E  msg_open db "Open: ",0
1307  87BB 3A 20 00
1308  87BE 45 72 72 6F  msg_error db "Error",13,0
1308  87C2 72 0D 00
1309  87C5 46 6F 72 6D  msg_format db "Format: ",0
1309  87C9 61 74 3A 20
1309  87CD 00
1310  87CE 44 6F 77 6E  msg_download_info db "Download info...",13,0
1310  87D2 6C 6F 61 64
1310  87D6 20 69 6E 66
1310  87DA 6F 2E 2E 2E
1310  87DE 0D 00
1311  87E0 52 65 71 75  msg_request_info db "Request info...",13,0
1311  87E4 65 73 74 20
1311  87E8 69 6E 66 6F
1311  87EC 2E 2E 2E 0D
1311  87F0 00
1312  87F1 52 65 71 75  msg_request_art db "Request art...",13,0
1312  87F5 65 73 74 20
1312  87F9 61 72 74 2E
1312  87FD 2E 2E 0D 00
1313  8801 44 6F 77 6E  msg_download_art db "Download art...",13,0
1313  8805 6C 6F 61 64
1313  8809 20 61 72 74
1313  880D 2E 2E 2E 0D
1313  8811 00
1314  8812 50 6C 61 79  msg_play_art db "Play art...",13,0
1314  8816 20 61 72 74
1314  881A 2E 2E 2E 0D
1314  881E 00
1315  881F 53 74 6F 70  msg_stop db "Stop",13,0
1315  8823 0D 00
1316  8825 52 65 73 74  msg_restart db "Restart...",13,0
1316  8829 61 72 74 2E
1316  882D 2E 2E 0D 00
1317  8831              ;msg_get_link_id db "Get link ID...",13,0
1318  8831 53 20 2D 20  msg_sys_info db "S - Stop, R - Restart",13
1318  8835 53 74 6F 70
1318  8839 2C 20 52 20
1318  883D 2D 20 52 65
1318  8841 73 74 61 72
1318  8845 74 0D
1319  8847 53 70 20 2D  	db "Sp - Next, Break - Exit, "
1319  884B 20 4E 65 78
1319  884F 74 2C 20 42
1319  8853 72 65 61 6B
1319  8857 20 2D 20 45
1319  885B 78 69 74 2C
1319  885F 20
1320  8860 44 20 2D 20  	db "D - Save file",13,0
1320  8864 53 61 76 65
1320  8868 20 66 69 6C
1320  886C 65 0D 00
1321  886F 51 20 2D 20  msg_order 	db "Q - Order: ",0
1321  8873 4F 72 64 65
1321  8877 72 3A 20 00
1322  887B 0D 43 75 72  msg_cur_number	db 13,"Current number: ",0
1322  887F 72 65 6E 74
1322  8883 20 6E 75 6D
1322  8887 62 65 72 3A
1322  888B 20 00
1323  888D
1324  888D 72 61 6E 64  msg_order_random db "random",13,0
1324  8891 6F 6D 0D 00
1325  8895 66 72 6F 6D  msg_order_from_new db "from new to old",13,0
1325  8899 20 6E 65 77
1325  889D 20 74 6F 20
1325  88A1 6F 6C 64 0D
1325  88A5 00
1326  88A6 66 72 6F 6D  msg_order_from_old db "from old to new",13,0
1326  88AA 20 6F 6C 64
1326  88AE 20 74 6F 20
1326  88B2 6E 65 77 0D
1326  88B6 00
1327  88B7 53 69 7A 65  msg_download_size db "Size: ",0
1327  88BB 3A 20 00
1328  88BE 42 0D 00     msg_B db "B",13,0
1329  88C1 00 00        total_art dw 0;
1330  88C3 00 00        start_art dw 0;
1331  88C5 00 00        cur_art dw 0;
1332  88C7 00           stopKey_flag db 0;
1333  88C8              ; format_pt2 db "pt2",0
1334  88C8              ; format_pt3 db "pt3",0
1335  88C8              ; format_ts db " ts",0
1336  88C8              ; format_tfc db "tfc",0
1337  88C8 01           order_val db 1 ;тип сортировки
1338  88C9
1339  88C9              ;player_setup db 0;настройки плеера
1340  88C9 96           time_view db 3*50 ;время на просмотр картинки
1341  88CA
1342  88CA              ;запрос списка
1343  88CA 52 65 71 75  requestbuffer_title db "Request:",13
1343  88CE 65 73 74 3A
1343  88D2 0D
1344  88D3              requestbuffer ;
1345  88D3 47 45 54 20  	db "GET /api/export:zxPicture/limit:1/start:"
1345  88D7 2F 61 70 69
1345  88DB 2F 65 78 70
1345  88DF 6F 72 74 3A
1345  88E3 7A 78 50 69
1345  88E7 63 74 75 72
1345  88EB 65 2F 6C 69
1345  88EF 6D 69 74 3A
1345  88F3 31 2F 73 74
1345  88F7 61 72 74 3A
1346  88FB              start_request ;тут подстановка порядкового номера арта
1347  88FB 30 30 30 30  	db "00000/filter:zxPictureType=standard/"
1347  88FF 30 2F 66 69
1347  8903 6C 74 65 72
1347  8907 3A 7A 78 50
1347  890B 69 63 74 75
1347  890F 72 65 54 79
1347  8913 70 65 3D 73
1347  8917 74 61 6E 64
1347  891B 61 72 64 2F
1348  891F              request_format
1349  891F 6F 72 64 65  	db "order:date,desc HTTP/1.1\r\n"
1349  8923 72 3A 64 61
1349  8927 74 65 2C 64
1349  892B 65 73 63 20
1349  892F 48 54 54 50
1349  8933 2F 31 2E 31
1349  8937 0D 0A
1350  8939              ;request_agent
1351  8939 48 6F 73 74  	db "Host: zxart.ee\r\n"
1351  893D 3A 20 7A 78
1351  8941 61 72 74 2E
1351  8945 65 65 0D 0A
1352  8949 55 73 65 72  	db "User-Agent: User-Agent: Mozilla/4.0 (compatible; MSIE5.01; GMX OS)\r\n\r\n",0
1352  894D 2D 41 67 65
1352  8951 6E 74 3A 20
1352  8955 55 73 65 72
1352  8959 2D 41 67 65
1352  895D 6E 74 3A 20
1352  8961 4D 6F 7A 69
1352  8965 6C 6C 61 2F
1352  8969 34 2E 30 20
1352  896D 28 63 6F 6D
1352  8971 70 61 74 69
1352  8975 62 6C 65 3B
1352  8979 20 4D 53 49
1352  897D 45 35 2E 30
1352  8981 31 3B 20 47
1352  8985 4D 58 20 4F
1352  8989 53 29 0D 0A
1352  898D 0D 0A 00
1353  8990
1354  8990              ;запрос закачки
1355  8990 52 65 71 75  requestbuffer2_title db "Request:",13
1355  8994 65 73 74 3A
1355  8998 0D
1356  8999              requestbuffer2 ;
1357  8999 47 45 54 20  	db "GET /file/id:"
1357  899D 2F 66 69 6C
1357  89A1 65 2F 69 64
1357  89A5 3A
1358  89A6              requestbuffer2_file_id ;тут подстановка id арта
1359  89A6              	;db "539319"
1360  89A6 00 00 00...  	ds #100 ;буфер для отправки
1361  8AA6              requestbuffer2_end ;окончание строки запроса
1362  8AA6 20 48 54 54  	db " HTTP/1.1\r\n"
1362  8AAA 50 2F 31 2E
1362  8AAE 31 0D 0A
1363  8AB1              ;request_agent
1364  8AB1 48 6F 73 74  	db "Host: zxart.ee\r\n"
1364  8AB5 3A 20 7A 78
1364  8AB9 61 72 74 2E
1364  8ABD 65 65 0D 0A
1365  8AC1 55 73 65 72  	db "User-Agent: User-Agent: Mozilla/4.0 (compatible; MSIE5.01; GMX OS)\r\n\r\n",0
1365  8AC5 2D 41 67 65
1365  8AC9 6E 74 3A 20
1365  8ACD 55 73 65 72
1365  8AD1 2D 41 67 65
1365  8AD5 6E 74 3A 20
1365  8AD9 4D 6F 7A 69
1365  8ADD 6C 6C 61 2F
1365  8AE1 34 2E 30 20
1365  8AE5 28 63 6F 6D
1365  8AE9 70 61 74 69
1365  8AED 62 6C 65 3B
1365  8AF1 20 4D 53 49
1365  8AF5 45 35 2E 30
1365  8AF9 31 3B 20 47
1365  8AFD 4D 58 20 4F
1365  8B01 53 29 0D 0A
1365  8B05 0D 0A 00
1366  8B08
1367  8B08
1368  8B08              ;примеры (может не правильные)
1369  8B08              	;db "http://zxart.ee/api/types:zxMusic/export:zxMusic/language:eng/start:0/limit:2/order:date,desc/filter:zxMusicAll=1;"
1370  8B08              	;https://zxart.ee/api/types:zxMusic/export:zxMusic/language:eng/start:0/limit:2/order:date,desc/filter:zxMusicAll=1;
1371  8B08
1372  8B08              	;db "GET /file/id:44816",0
1373  8B08              	;db "GET /api/export:zxMusic/limit:2/start:0/filter:zxMusicFormat=pt3/order:date,desc",0
1374  8B08
1375  8B08
1376  8B08              ;requestbuffer_end
1377  8B08
1378  8B08              msg_title_artview
1379  8B08 41 72 74 56  	db "ArtView ver 2025.06.18",10,13,0
1379  8B0C 69 65 77 20
1379  8B10 76 65 72 20
1379  8B14 32 30 32 35
1379  8B18 2E 30 36 2E
1379  8B1C 31 38 0A 0D
1379  8B20 00
1380  8B21
1381  8B21 52 65 73 70  outputBuffer_title db "Response:",13
1381  8B25 6F 6E 73 65
1381  8B29 3A 0D
1382  8B2B              outputBuffer equ $  ;буфер для загрузки
1383  8B2B
1384  8B2B              end_artview
1385  8B2B              	;SAVETRD "OS.TRD",|"artview.C",start_artview,$-start_artview
1386  8B2B              	savebin "artview.apg",start_artview,$-start_artview
# file closed: artview.asm
