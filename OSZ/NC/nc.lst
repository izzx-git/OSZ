# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000              ;например, плеера музыки
 200+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 201+ 0000              ;на время выполнения включаются обе страницы процесса
 202+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 203+ 0000 ~                ld c,#14
 204+ 0000 ~                rst #20
 205+ 0000                  endm
 206+ 0000
 207+ 0000
 208+ 0000              ;плеер AY ----------------------------
 209+ 0000
 210+ 0000              ;инициализация плеера AY;
 211+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 212+ 0000 ~                ld c,#15
 213+ 0000 ~                rst #20
 214+ 0000                  endm
 215+ 0000
 216+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 217+ 0000                  macro OS_VTPL_PLAY ;()
 218+ 0000 ~                ld c,#16
 219+ 0000 ~                rst #20
 220+ 0000                  endm
 221+ 0000
 222+ 0000              ;заглушить плеер AY;
 223+ 0000                  macro OS_VTPL_MUTE ;()
 224+ 0000 ~                ld c,#17
 225+ 0000 ~                rst #20
 226+ 0000                  endm
 227+ 0000
 228+ 0000              ;получить значение переменной плеера;
 229+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 230+ 0000 ~                ld c,#18
 231+ 0000 ~                rst #20
 232+ 0000                  endm
 233+ 0000
 234+ 0000
 235+ 0000              ;прочие ------------------------------
 236+ 0000
 237+ 0000
 238+ 0000              ;скопировать данные из страницы в страницу
 239+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 240+ 0000                  macro OS_RAM_COPY
 241+ 0000 ~                ld c,#19
 242+ 0000 ~                rst #20
 243+ 0000                  endm
 244+ 0000
 245+ 0000              ;получить дополнительную страницу памяти;
 246+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 247+ 0000 ~                ld c,#1a
 248+ 0000 ~                rst #20
 249+ 0000                  endm
 250+ 0000
 251+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 252+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 253+ 0000 ~                ld c,#1b
 254+ 0000 ~                rst #20
 255+ 0000                  endm
 256+ 0000
 257+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 258+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 259+ 0000 ~                ld c,#1c
 260+ 0000 ~                rst #20
 261+ 0000                  endm
 262+ 0000
 263+ 0000              ;включить экран N;
 264+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 265+ 0000              ;переключать может только приложение в фокусе
 266+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 267+ 0000              ;при переключении процессов сохраняется только экран #39
 268+ 0000                  macro OS_SET_SCREEN ;
 269+ 0000 ~                ld c,#1d
 270+ 0000 ~                rst #20
 271+ 0000                  endm
 272+ 0000
 273+ 0000
 274+ 0000              ;получить номера страниц процесса;
 275+ 0000              ;вх:
 276+ 0000              ;вых: b, c - страницы в слотах 2, 3
 277+ 0000                  macro OS_GET_MAIN_PAGES ;
 278+ 0000 ~                ld c,#1e
 279+ 0000 ~                rst #20
 280+ 0000                  endm
 281+ 0000
 282+ 0000              ;получить значение системного таймера
 283+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 284+ 0000 ~                ld c,#1F
 285+ 0000 ~                rst #20
 286+ 0000                  endm
 287+ 0000
 288+ 0000
 289+ 0000              ;освободить страницу памяти
 290+ 0000              ;вх: a - номер страницы
 291+ 0000                  macro OS_DEL_PAGE ;
 292+ 0000 ~                ld c,#20
 293+ 0000 ~                rst #20
 294+ 0000                  endm
 295+ 0000
 296+ 0000
 297+ 0000              ;дисковые операции -------------------
 298+ 0000
 299+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 300+ 0000
 301+ 0000              ; fcbFAT (из руководства к монитору)
 302+ 0000              ; формат fcb для работы с FAT
 303+ 0000
 304+ 0000              ; +#00 8 имя файла
 305+ 0000              ; +#08 3 расширение файла
 306+ 0000              ; +#0B 1 атрибуты файла
 307+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 308+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 309+ 0000              ; +#14 4 размер файла/каталога в байтах
 310+ 0000              ; +#18 4 указатель в файле
 311+ 0000              ; +#1C 1 для внутренних нужд
 312+ 0000              ; +#1D 1 для внутренних нужд
 313+ 0000              ; +#1E 1 резерв
 314+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 315+ 0000              	; 1-0,nn номер раздела
 316+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 317+ 0000              	    ; значение %11 недопустимо
 318+ 0000
 319+ 0000              ;открыть файл для чтения или записи
 320+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 321+ 0000 ~                ld c,#21
 322+ 0000 ~                rst #20
 323+ 0000                  endm
 324+ 0000
 325+ 0000              ;создать файл
 326+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 327+ 0000 ~                ld c,#22
 328+ 0000 ~                rst #20
 329+ 0000                  endm
 330+ 0000
 331+ 0000              ;прочитать из файла
 332+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 333+ 0000 ~                ld c,#23
 334+ 0000 ~                rst #20
 335+ 0000                  endm
 336+ 0000
 337+ 0000              ;записать в файл
 338+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 339+ 0000 ~                ld c,#24
 340+ 0000 ~                rst #20
 341+ 0000                  endm
 342+ 0000
 343+ 0000              ;закрыть файл
 344+ 0000                  macro OS_FILE_CLOSE ;A - id file
 345+ 0000 ~                ld c,#25
 346+ 0000 ~                rst #20
 347+ 0000                  endm
 348+ 0000
 349+ 0000              ;чтение секторов текущего каталога
 350+ 0000              ; вх:
 351+ 0000                   ; hl - буфер для чтения
 352+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 353+ 0000                   ; b - максимальное количество секторов для чтения
 354+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 355+ 0000                     ; a=errRWnum
 356+ 0000                     ; a=errInvalidPart
 357+ 0000                     ; a=errFileEmpty
 358+ 0000                   ; cy=0, a=errEoF - каталог закончился
 359+ 0000                     ; hl - следующий адрес в буфере
 360+ 0000                     ; de - номер первого непрочитанного сектора
 361+ 0000                     ; b - не прочитано секторов
 362+ 0000                   ; cy=0 - считано успешно
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b=#00
 366+ 0000                  macro OS_DIR_READ ;
 367+ 0000 ~                ld c,#26
 368+ 0000 ~                rst #20
 369+ 0000                  endm
 370+ 0000
 371+ 0000              ;вход в каталог/выход в родительский каталог
 372+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 373+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 374+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 375+ 0000              	; переход в родительский, последнее имя в пути удалится).
 376+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 377+ 0000              	; добавится имя файла
 378+ 0000              ; вх:
 379+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 380+ 0000                   ; de - адрес дескриптора директории/файла
 381+ 0000              ; вых: a - если путь был указан, новая длина пути
 382+ 0000                  macro OS_DIR_OPEN ;
 383+ 0000 ~                ld c,#27
 384+ 0000 ~                rst #20
 385+ 0000                  endm
 386+ 0000
 387+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 388+ 0000              ;проверки на допустимость значений не производится
 389+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 390+ 0000              ;вх: A - id файла
 391+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 392+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 393+ 0000                  macro OS_FILE_POSITION ;
 394+ 0000 ~                ld c,#28
 395+ 0000 ~                rst #20
 396+ 0000                  endm
 397+ 0000
 398+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 399+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 400+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 401+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 402+ 0000                  macro OS_FIND_PATH ;
 403+ 0000 ~                ld c,#29
 404+ 0000 ~                rst #20
 405+ 0000                  endm
 406+ 0000
 407+ 0000
 408+ 0000              ; получение длинного имени файла
 409+ 0000              ;вх: hl - адрес буфера для имени
 410+ 0000              ;    de - номер записи в текущем каталоге
 411+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 412+ 0000              ; 	a - длина имени, с учетом нуля
 413+ 0000                  macro OS_GET_LFN ;
 414+ 0000 ~                ld c,#2a
 415+ 0000 ~                rst #20
 416+ 0000                  endm
 417+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROG_START
   5  8000
   6  8000              start_nc
   7  8000 21 B0 9A     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 BF 99  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 9D 9A     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A
  24  801A CD AD 80     	call delay
  25  801D C3 AF 82     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 BE 99     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023
  32  8023              start_nc_warm ;тёплый старт
  33  8023
  34  8023              	;очистка буфера
  35  8023 CD B3 80     	call clear_buf
  36  8026
  37  8026              	;загрузка каталога
  38  8026 21 00 C0     	ld hl,buffer_cat ;куда
  39  8029 11 00 00     	ld de,0 ;начиная с 0 сектора
  40  802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  41  802E              	OS_DIR_READ
  41  802E 0E 26       >    ld c,#26
  41  8030 E7          >    rst #20
  42  8031
  43  8031 21 00 00     	ld hl,0 ;обнулить переменные
  44  8034 22 BA 99     	ld (file_r_num_cur),hl
  45  8037 22 A8 97     	ld (file_r_all),hl
  46  803A 22 AA 97     	ld (file_r_cur_focus),hl
  47  803D
  48  803D CD 08 84     	call sort_dir
  49  8040
  50  8040 3E 0F        	ld a,color_backgr
  51  8042 06 0C        	ld b,#c
  52  8044              	OS_SET_COLOR
  52  8044 0E 06       >    ld c,#06
  52  8046 E7          >    rst #20
  53  8047
  54  8047 CD 8D 85     	call print_rect_r ;рамка
  55  804A CD 10 83     	call print_panel_r
  56  804D CD C2 85     	call print_menu_main
  57  8050
  58  8050 11 00 01     	ld de,#0100
  59  8053              	OS_SET_XY
  59  8053 0E 01       >    ld c,#01
  59  8055 E7          >    rst #20
  60  8056
  61  8056 21 58 9A     	ld hl,msg_menu_info
  62  8059              	OS_PRINTZ
  62  8059 0E 09       >    ld c,#09
  62  805B E7          >    rst #20
  63  805C
  64  805C
  65  805C
  66  805C              nc_wait
  67  805C              	OS_WAIT ;ждать прерывание
  67  805C DF          >	rst #18
  68  805D
  69  805D              	OS_GET_CHAR ;клавиша
  69  805D 0E 10       >    ld c,#10
  69  805F E7          >    rst #20
  70  8060 32 BC 99     	ld (key_pressed),a ;запомнить
  71  8063 FE 0D        	cp 13
  72  8065 CA 14 81     	jp z,key_enter ;
  73  8068 FE 0A        	cp 10 ;вниз
  74  806A CC 1B 82     	call z,key_down
  75  806D FE 0B        	cp 11 ;вверх
  76  806F CC 58 82     	call z,key_up
  77  8072 FE 09        	cp 09 ;вправо
  78  8074 CC 9D 82     	call z,key_right
  79  8077 FE 08        	cp 08 ;влево
  80  8079 CC 8B 82     	call z,key_left
  81  807C FE 04        	cp 04 ;страница вверх
  82  807E CC 8B 82     	call z,key_left
  83  8081 FE 05        	cp 05 ;страница вниз
  84  8083 CC 9D 82     	call z,key_right
  85  8086 FE 31        	cp "1" ;переключение длинных имён (LFN)
  86  8088 CA 3B 85     	jp z,LFN_toggle
  87  808B FE 32        	cp "2" ;переключение сортировки
  88  808D CA 1B 85     	jp z,sort_toggle
  89  8090 FE 33        	cp "3" ;просмотр файла
  90  8092 CA 10 86     	jp z,view_file
  91  8095 FE 19        	cp 25 ;CS+Enter
  92  8097 CA A1 81     	jp z,nc_play_all
  93  809A FE 18        	cp 24 ;break
  94  809C CA AF 82     	jp z,exit
  95  809F
  96  809F
  97  809F 3A C1 99     	ld a,(print_panel_r_flag)
  98  80A2 B7           	or a
  99  80A3 C4 10 83     	call nz,print_panel_r ;обновить каталог
 100  80A6 AF           	xor a
 101  80A7 32 C1 99     	ld (print_panel_r_flag),a
 102  80AA
 103  80AA C3 5C 80     	jp nc_wait ;на цикл ожидания
 104  80AD
 105  80AD
 106  80AD              delay ;задержка
 107  80AD 06 96        	ld b,50*3 ;
 108  80AF              delay1
 109  80AF              	OS_WAIT
 109  80AF DF          >	rst #18
 110  80B0 10 FD        	djnz delay1
 111  80B2 C9           	ret
 112  80B3
 113  80B3
 114  80B3              clear_buf
 115  80B3 21 00 C0     	ld hl,buffer_cat
 116  80B6 11 01 C0     	ld de,buffer_cat+1
 117  80B9 01 FF 3F     	ld bc,#4000-1
 118  80BC 36 00        	ld (hl),0
 119  80BE ED B0        	ldir
 120  80C0 C9           	ret
 121  80C1
 122  80C1
 123  80C1              ;очистить левую панель
 124  80C1              clear_left_panel
 125  80C1 3E 0F        	ld a,color_backgr ;цвет
 126  80C3 06 0C        	ld b,#c
 127  80C5              	OS_SET_COLOR
 127  80C5 0E 06       >    ld c,#06
 127  80C7 E7          >    rst #20
 128  80C8 06 18        	ld b,panel_hight+2 ;высота
 129  80CA 11 00 00     	ld de,0
 130  80CD              	OS_SET_XY
 130  80CD 0E 01       >    ld c,#01
 130  80CF E7          >    rst #20
 131  80D0              clear_left_panel_cl
 132  80D0 C5           	push bc
 133  80D1 21 E1 80     	ld hl,txt_clear_panel
 134  80D4              	OS_PRINTZ
 134  80D4 0E 09       >    ld c,#09
 134  80D6 E7          >    rst #20
 135  80D7 C1           	pop bc
 136  80D8 10 F6        	djnz clear_left_panel_cl
 137  80DA 11 00 00     	ld de,0
 138  80DD              	OS_SET_XY
 138  80DD 0E 01       >    ld c,#01
 138  80DF E7          >    rst #20
 139  80E0 C9           	ret
 140  80E1 20 20 20 20  txt_clear_panel db "                                        ",13,0 ;40 пробелов
 140  80E5 20 20 20 20
 140  80E9 20 20 20 20
 140  80ED 20 20 20 20
 140  80F1 20 20 20 20
 140  80F5 20 20 20 20
 140  80F9 20 20 20 20
 140  80FD 20 20 20 20
 140  8101 20 20 20 20
 140  8105 20 20 20 20
 140  8109 0D 00
 141  810B
 142  810B
 143  810B              release_key ;ждать отпускания клавиши
 144  810B              	OS_WAIT
 144  810B DF          >	rst #18
 145  810C              	OS_GET_CHAR
 145  810C 0E 10       >    ld c,#10
 145  810E E7          >    rst #20
 146  810F FE FF        	cp 255
 147  8111 20 F8        	jr nz,release_key
 148  8113 C9           	ret
 149  8114
 150  8114
 151  8114              key_enter
 152  8114              	;нажата Enter
 153  8114 2A A8 97     	ld hl,(file_r_all)
 154  8117 7D           	ld a,l
 155  8118 B4           	or h
 156  8119 CA 9E 81     	jp z,key_enter_ex ;защита
 157  811C 2A BA 99     	ld hl,(file_r_num_cur)
 158  811F CD 0E 82     	call calc_deskr
 159  8122 DD 7E 0B     	ld a,(ix+#0b)
 160  8125 FE 10        	cp #10 ;признак каталога
 161  8127 CA 01 82     	jp z,key_enter_dir
 162  812A
 163  812A FE 30        	cp #30 ;признак каталога
 164  812C CA 01 82     	jp z,key_enter_dir
 165  812F
 166  812F
 167  812F CD 58 85     	call format_name
 168  8132
 169  8132              	;проверка расширения APG
 170  8132 CD B3 82     	call check_apg
 171  8135 C2 48 81     	jp nz,key_enter_1
 172  8138              	;тут запуск приложения
 173  8138 21 AC 97     	ld hl,file_name_cur		;строка с именем
 174  813B              	OS_PROC_RUN ;запустить прогу
 174  813B 0E 11       >    ld c,#11
 174  813D E7          >    rst #20
 175  813E              	;обработка ошибки
 176  813E 38 5E        	jr c,key_enter_ex
 177  8140
 178  8140 DD 7E 00     	ld a,(ix)
 179  8143              	OS_PROC_SET_FOCUS ;на передний план
 179  8143 0E 12       >    ld c,#12
 179  8145 E7          >    rst #20
 180  8146 18 56        	jr key_enter_ex
 181  8148
 182  8148
 183  8148
 184  8148              key_enter_1
 185  8148              	;проверка расширения VGM
 186  8148 CD D2 82     	call check_vgm
 187  814B C2 62 81     	jp nz,key_enter_2
 188  814E
 189  814E CD C1 80     	call clear_left_panel ;почистить часть экрана
 190  8151
 191  8151 3A BE 99     	ld a,(page_ext01) ;доп страница для данных плеера
 192  8154              	OS_SET_PAGE_SLOT3
 192  8154 0E 1C       >    ld c,#1c
 192  8156 E7          >    rst #20
 193  8157
 194  8157 CD 19 89     	call start_gplay
 195  815A
 196  815A 3A BF 99     	ld a,(page_main) ;основная страница
 197  815D              	OS_SET_PAGE_SLOT3
 197  815D 0E 1C       >    ld c,#1c
 197  815F E7          >    rst #20
 198  8160
 199  8160 18 3C        	jr key_enter_ex
 200  8162
 201  8162
 202  8162              key_enter_2
 203  8162              	;проверка расширения SCR
 204  8162 CD F1 82     	call check_scr
 205  8165 C2 9E 81     	jp nz,key_enter_3
 206  8168
 207  8168
 208  8168 3A BE 99     	ld a,(page_ext01) ;доп страница для данных плеера
 209  816B              	OS_SET_PAGE_SLOT3
 209  816B 0E 1C       >    ld c,#1c
 209  816D E7          >    rst #20
 210  816E
 211  816E 21 AC 97     	ld hl,file_name_cur		;строка с именем
 212  8171              	OS_FILE_OPEN
 212  8171 0E 21       >    ld c,#21
 212  8173 E7          >    rst #20
 213  8174 30 09        	jr nc,key_enter_2_file_open_ok
 214  8176              key_enter_2_file_error
 215  8176 21 81 9A     	ld hl,msg_file_error
 216  8179              	OS_PRINTZ
 216  8179 0E 09       >    ld c,#09
 216  817B E7          >    rst #20
 217  817C              	; ld b,2*50
 218  817C              	; call delay1
 219  817C C3 9E 81     	jp key_enter_ex
 220  817F
 221  817F              key_enter_2_file_open_ok
 222  817F 32 BD 99     	ld (file_id_cur_r),a
 223  8182 11 00 1B     	ld de,6912
 224  8185 21 00 C0     	ld hl,#c000
 225  8188              	;ld a,(file_id_cur_r)
 226  8188              	OS_FILE_READ ;загрузить
 226  8188 0E 23       >    ld c,#23
 226  818A E7          >    rst #20
 227  818B 38 E9        	jr c,key_enter_2_file_error
 228  818D 3A BD 99     	ld a,(file_id_cur_r)
 229  8190              	OS_FILE_CLOSE
 229  8190 0E 25       >    ld c,#25
 229  8192 E7          >    rst #20
 230  8193
 231  8193 CD 7F 97     	call display ;показать
 232  8196
 233  8196 3A BF 99     	ld a,(page_main) ;основная страница
 234  8199              	OS_SET_PAGE_SLOT3
 234  8199 0E 1C       >    ld c,#1c
 234  819B E7          >    rst #20
 235  819C
 236  819C 18 00        	jr key_enter_ex
 237  819E
 238  819E
 239  819E              key_enter_3
 240  819E
 241  819E
 242  819E
 243  819E
 244  819E              key_enter_ex
 245  819E C3 5C 80     	jp nc_wait
 246  81A1
 247  81A1
 248  81A1
 249  81A1
 250  81A1
 251  81A1
 252  81A1
 253  81A1              nc_play_all
 254  81A1              	;Воспроизведение всего по порядку
 255  81A1 2A A8 97     	ld hl,(file_r_all)
 256  81A4 7D           	ld a,l
 257  81A5 B4           	or h
 258  81A6 CA E7 81     	jp z,nc_play_ex ;защита
 259  81A9 2A BA 99     	ld hl,(file_r_num_cur)
 260  81AC CD 0E 82     	call calc_deskr
 261  81AF DD 7E 0B     	ld a,(ix+#0b)
 262  81B2 FE 10        	cp #10 ;признак каталога
 263  81B4 28 34        	jr z,nc_play_all_down
 264  81B6
 265  81B6 FE 30        	cp #30 ;признак каталога
 266  81B8 28 30        	jr z,nc_play_all_down
 267  81BA
 268  81BA
 269  81BA CD 58 85     	call format_name
 270  81BD
 271  81BD              nc_play_1
 272  81BD              	;проверка расширения ;VGM
 273  81BD CD D2 82     	call check_vgm
 274  81C0 C2 E5 81     	jp nz,nc_play_2
 275  81C3
 276  81C3 CD C1 80     	call clear_left_panel ;почистить часть экрана
 277  81C6
 278  81C6 3A BE 99     	ld a,(page_ext01) ;доп страница для данных плеера
 279  81C9              	OS_SET_PAGE_SLOT3
 279  81C9 0E 1C       >    ld c,#1c
 279  81CB E7          >    rst #20
 280  81CC
 281  81CC CD 19 89     	call start_gplay
 282  81CF
 283  81CF F5           	push af
 284  81D0 3A BF 99     	ld a,(page_main) ;основная страница
 285  81D3              	OS_SET_PAGE_SLOT3
 285  81D3 0E 1C       >    ld c,#1c
 285  81D5 E7          >    rst #20
 286  81D6 F1           	pop af
 287  81D7 FE 73        	cp "s"
 288  81D9 28 0C        	jr z,nc_play_ex
 289  81DB FE 53        	cp "S"
 290  81DD 28 08        	jr z,nc_play_ex
 291  81DF FE 18        	cp 24 ;break
 292  81E1 28 04        	jr z,nc_play_ex
 293  81E3
 294  81E3 18 05        	jr nc_play_all_down
 295  81E5
 296  81E5
 297  81E5              nc_play_2
 298  81E5 18 03        	jr nc_play_all_down
 299  81E7
 300  81E7
 301  81E7
 302  81E7              nc_play_ex
 303  81E7 C3 5C 80     	jp nc_wait
 304  81EA
 305  81EA
 306  81EA              nc_play_all_down ;вниз по списку
 307  81EA ED 4B BA 99  	ld bc,(file_r_num_cur)
 308  81EE C5           	push bc
 309  81EF CD 1B 82     	call key_down
 310  81F2 CD 10 83     	call print_panel_r ;обновить каталог
 311  81F5 C1           	pop bc
 312  81F6 2A BA 99     	ld hl,(file_r_num_cur)
 313  81F9 A7           	and a
 314  81FA ED 42        	sbc hl,bc ;если не сдвинулась позиция, то всё
 315  81FC 28 E9        	jr z,nc_play_ex
 316  81FE C3 A1 81     	jp nc_play_all
 317  8201
 318  8201
 319  8201
 320  8201
 321  8201
 322  8201
 323  8201
 324  8201
 325  8201              key_enter_dir
 326  8201              	;тут открытие папки
 327  8201
 328  8201              	;call format_name_dir
 329  8201 EB           	ex de,hl ;de - дескриптор для открытия
 330  8202 21 AC 98     	ld hl,dir_name_cur
 331  8205              	OS_DIR_OPEN
 331  8205 0E 27       >    ld c,#27
 331  8207 E7          >    rst #20
 332  8208 38 94        	jr c,key_enter_ex ;если ошибка, ничего не делаем
 333  820A
 334  820A E1           	pop hl ;отменить возврат
 335  820B C3 23 80     	jp start_nc_warm ;перезагрузить папку
 336  820E
 337  820E
 338  820E              ; format_name_dir
 339  820E              	; push hl
 340  820E              	; ld hl,file_name_cur
 341  820E              	; ld de,file_name_cur+1 ;почистить
 342  820E              	; ld bc,256-1
 343  820E              	; ld (hl),0
 344  820E              	; ldir
 345  820E
 346  820E              	; pop hl
 347  820E
 348  820E              	; ld de,file_name_cur ;куда
 349  820E              	; ld bc,#08ff
 350  820E              ; format_name_dir_cl
 351  820E              	; ld a,(hl)
 352  820E              	; cp " "+1
 353  820E              	; jr c,format_name_dir_skip
 354  820E              	; ldi
 355  820E              	; djnz format_name_dir_cl
 356  820E              ; format_name_dir_skip
 357  820E              	; ld a,'/'
 358  820E              	; ld (de),a
 359  820E              	; ret
 360  820E
 361  820E               ;вычислить дескриптор текущего элемента справа
 362  820E              calc_deskr
 363  820E 29           	add hl,hl ;*2
 364  820F 01 D0 9A     	ld bc,cat_index
 365  8212 09           	add hl,bc
 366  8213 5E           	ld e,(hl)
 367  8214 23           	inc hl
 368  8215 56           	ld d,(hl)
 369  8216 EB           	ex de,hl ;hl - адрес элемента
 370  8217 E5           	push hl
 371  8218 DD E1        	pop ix ;ix- адрес элемента
 372  821A C9           	ret
 373  821B
 374  821B
 375  821B
 376  821B
 377  821B              key_down
 378  821B 2A A8 97     	ld hl,(file_r_all)
 379  821E 7D           	ld a,l
 380  821F B4           	or h
 381  8220 CA 54 82     	jp z,key_down_ex ;защита
 382  8223
 383  8223 ED 4B BA 99  	ld bc,(file_r_num_cur)
 384  8227 03           	inc bc
 385  8228 2A A8 97     	ld hl,(file_r_all)
 386  822B              	;если не больше чем всего
 387  822B A7           	and a
 388  822C ED 42        	sbc hl,bc
 389  822E 38 24        	jr c,key_down_skip
 390  8230 28 22        	jr z,key_down_skip
 391  8232              	;прибавить
 392  8232 ED 43 BA 99  	ld (file_r_num_cur),bc
 393  8236
 394  8236              	;теперь передвинуть фокус, если надо
 395  8236 2A AA 97     	ld hl,(file_r_cur_focus)
 396  8239 01 16 00     	ld bc,panel_hight
 397  823C 09           	add hl,bc ;прибавить количество видимых
 398  823D ED 4B BA 99  	ld bc,(file_r_num_cur)
 399  8241 A7           	and a
 400  8242 ED 42        	sbc hl,bc ;вычесть положение курсора
 401  8244 28 02        	jr z,key_down_change_focus_yes
 402  8246 30 07        	jr nc,key_down_change_focus_no
 403  8248              key_down_change_focus_yes
 404  8248              	;передвинуть фокус
 405  8248 2A AA 97     	ld hl,(file_r_cur_focus)
 406  824B 23           	inc hl
 407  824C 22 AA 97     	ld (file_r_cur_focus),hl
 408  824F
 409  824F              key_down_change_focus_no
 410  824F 3E 01        	ld a,1
 411  8251 32 C1 99     	ld (print_panel_r_flag),a
 412  8254              	;call print_panel_r ;обновить каталог
 413  8254              key_down_skip
 414  8254
 415  8254              key_down_ex
 416  8254 3A BC 99     	ld a,(key_pressed)
 417  8257 C9           	ret
 418  8258
 419  8258
 420  8258
 421  8258              key_up ;вверх
 422  8258 2A A8 97     	ld hl,(file_r_all)
 423  825B 7D           	ld a,l
 424  825C B4           	or h
 425  825D CA 87 82     	jp z,key_up_ex ;защита
 426  8260
 427  8260 2A BA 99     	ld hl,(file_r_num_cur)
 428  8263 7D           	ld a,l
 429  8264 B4           	or h
 430  8265 28 20        	jr z,key_up_skip
 431  8267 2B           	dec hl
 432  8268 22 BA 99     	ld (file_r_num_cur),hl
 433  826B
 434  826B              	;теперь передвинуть фокус, если надо
 435  826B 2A BA 99     	ld hl,(file_r_num_cur)
 436  826E              	; ld bc,panel_hight
 437  826E              	; add hl,bc ;прибавить количество видимых
 438  826E ED 4B AA 97  	ld bc,(file_r_cur_focus)
 439  8272 A7           	and a
 440  8273 ED 42        	sbc hl,bc ;вычесть положение курсора
 441  8275              	;jr z,key_up_change_foces_yes
 442  8275 30 0B        	jr nc,key_up_change_foces_no
 443  8277              key_up_change_foces_yes
 444  8277              	;передвинуть фокус
 445  8277 2A AA 97     	ld hl,(file_r_cur_focus)
 446  827A 7C           	ld a,h
 447  827B B5           	or l
 448  827C 28 04        	jr z,key_up_change_foces_no ;защита
 449  827E 2B           	dec hl
 450  827F 22 AA 97     	ld (file_r_cur_focus),hl
 451  8282
 452  8282              key_up_change_foces_no
 453  8282
 454  8282 3E 01        	ld a,1
 455  8284 32 C1 99     	ld (print_panel_r_flag),a
 456  8287              	;call print_panel_r ;обновить каталог
 457  8287              key_up_skip
 458  8287
 459  8287              key_up_ex
 460  8287 3A BC 99     	ld a,(key_pressed)
 461  828A C9           	ret
 462  828B
 463  828B
 464  828B              key_left ;на страницу назад
 465  828B 06 15        	ld b,panel_hight-1
 466  828D              key_left_cl
 467  828D C5           	push bc
 468  828E CD 58 82     	call key_up
 469  8291 C1           	pop bc
 470  8292 10 F9        	djnz key_left_cl
 471  8294 3E 01        	ld a,1
 472  8296 32 C1 99     	ld (print_panel_r_flag),a
 473  8299 3A BC 99     	ld a,(key_pressed)
 474  829C C9           	ret
 475  829D
 476  829D
 477  829D
 478  829D              key_right ;на страницу вперёд
 479  829D 06 15        	ld b,panel_hight-1
 480  829F              key_right_cl
 481  829F C5           	push bc
 482  82A0 CD 1B 82     	call key_down
 483  82A3 C1           	pop bc
 484  82A4 10 F9        	djnz key_right_cl
 485  82A6 3E 01        	ld a,1
 486  82A8 32 C1 99     	ld (print_panel_r_flag),a
 487  82AB 3A BC 99     	ld a,(key_pressed)
 488  82AE C9           	ret
 489  82AF
 490  82AF
 491  82AF
 492  82AF              exit ;выход в DOS
 493  82AF AF           	xor a
 494  82B0              	OS_PROC_CLOSE
 494  82B0 0E 13       >    ld c,#13
 494  82B2 E7          >    rst #20
 495  82B3
 496  82B3
 497  82B3
 498  82B3              check_apg ;проверка на расширение APG
 499  82B3 DD 7E 08     	ld a,(ix+8)
 500  82B6 FE 61        	cp "a"
 501  82B8 28 03        	jr z,check_apg1
 502  82BA FE 41        	cp "A"
 503  82BC C0           	ret nz
 504  82BD              check_apg1
 505  82BD DD 7E 09     	ld a,(ix+9)
 506  82C0 FE 70        	cp "p"
 507  82C2 28 03        	jr z,check_apg2
 508  82C4 FE 50        	cp "P"
 509  82C6 C0           	ret nz
 510  82C7              check_apg2
 511  82C7 DD 7E 0A     	ld a,(ix+10)
 512  82CA FE 67        	cp "g"
 513  82CC C8           	ret z
 514  82CD FE 47        	cp "G"
 515  82CF C0           	ret nz
 516  82D0 AF           	xor a ;равен
 517  82D1 C9           	ret
 518  82D2
 519  82D2
 520  82D2              check_vgm ;проверка на расширение VGM
 521  82D2 DD 7E 08     	ld a,(ix+8)
 522  82D5 FE 76        	cp "v"
 523  82D7 28 03        	jr z,check_vgm1
 524  82D9 FE 56        	cp "V"
 525  82DB C0           	ret nz
 526  82DC              check_vgm1
 527  82DC DD 7E 09     	ld a,(ix+9)
 528  82DF FE 67        	cp "g"
 529  82E1 28 03        	jr z,check_vgm2
 530  82E3 FE 47        	cp "G"
 531  82E5 C0           	ret nz
 532  82E6              check_vgm2
 533  82E6 DD 7E 0A     	ld a,(ix+10)
 534  82E9 FE 6D        	cp "m"
 535  82EB C8           	ret z
 536  82EC FE 4D        	cp "M"
 537  82EE C0           	ret nz
 538  82EF AF           	xor a ;равен
 539  82F0 C9           	ret
 540  82F1
 541  82F1
 542  82F1              check_scr ;проверка на расширение SCR
 543  82F1 DD 7E 08     	ld a,(ix+8)
 544  82F4 FE 73        	cp "s"
 545  82F6 28 03        	jr z,check_scr1
 546  82F8 FE 53        	cp "S"
 547  82FA C0           	ret nz
 548  82FB              check_scr1
 549  82FB DD 7E 09     	ld a,(ix+9)
 550  82FE FE 63        	cp "c"
 551  8300 28 03        	jr z,check_scr2
 552  8302 FE 43        	cp "C"
 553  8304 C0           	ret nz
 554  8305              check_scr2
 555  8305 DD 7E 0A     	ld a,(ix+10)
 556  8308 FE 72        	cp "r"
 557  830A C8           	ret z
 558  830B FE 52        	cp "R"
 559  830D C0           	ret nz
 560  830E AF           	xor a ;равен
 561  830F C9           	ret
 562  8310
 563  8310
 564  8310
 565  8310              print_panel_r ;печать правой панели
 566  8310              	;ld ix,buffer_cat
 567  8310 FD 2A A8 97  	ld iy,(file_r_all) ;всего файлов
 568  8314 FD 7D        	ld a,iyl
 569  8316 FD B4        	or iyh
 570  8318 C8           	ret z ;защита если 0
 571  8319 11 29 01     	ld de,panel_r_xy ;координаты yx
 572  831C 06 16        	ld b,panel_hight ;высота панели
 573  831E FD 2A AA 97  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 574  8322              print_panel_r_cl ;цикл
 575  8322 C5           	push bc
 576  8323 D5           	push de ;xy
 577  8324              	OS_SET_XY
 577  8324 0E 01       >    ld c,#01
 577  8326 E7          >    rst #20
 578  8327
 579  8327              	;получить адрес элемента
 580  8327 FD E5        	push iy
 581  8329 E1           	pop hl
 582  832A CD 0E 82     	call calc_deskr
 583  832D
 584  832D CD 48 83     	call print_file_info ;напечатать строку
 585  8330              print_panel_r_skip
 586  8330 D1           	pop de
 587  8331 14           	inc d ;y++
 588  8332 FD 23        	inc iy ;текущий файл
 589  8334              	;проверка на конец каталога
 590  8334 2A A8 97     	ld hl,(file_r_all)
 591  8337 FD E5        	push iy
 592  8339 C1           	pop bc
 593  833A A7           	and a
 594  833B ED 42        	sbc hl,bc
 595  833D C1           	pop bc
 596  833E 38 07        	jr c,print_panel_r_ex2
 597  8340 28 05        	jr z,print_panel_r_ex2
 598  8342 10 DE        	djnz print_panel_r_cl
 599  8344 C9           	ret
 600  8345              print_panel_r_ex
 601  8345 D1           	pop de
 602  8346 C1           	pop bc
 603  8347              print_panel_r_ex2
 604  8347              	;тут, возможно, надо допечатать пустые строки
 605  8347 C9           	ret
 606  8348
 607  8348
 608  8348
 609  8348
 610  8348
 611  8348              print_file_info ;печать строки о файле
 612  8348 3A 57 85     	ld a,(LFN_enable_flag)
 613  834B B7           	or a
 614  834C 28 4D        	jr z,print_file_info_SFN
 615  834E
 616  834E
 617  834E
 618  834E              print_file_info_LFN ;печать длинного имени
 619  834E              	;узнать номер записи
 620  834E 01 00 C0     	ld bc,#c000
 621  8351 A7           	and a
 622  8352 ED 42        	sbc hl,bc
 623  8354              ;разделить на 32
 624  8354 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 625  8356 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 626  8358 CB 3C        	srl h ; /4
 627  835A CB 1D        	rr l ;
 628  835C CB 3C        	srl h ; /8
 629  835E CB 1D        	rr l ;
 630  8360 CB 3C        	srl h ; /16
 631  8362 CB 1D        	rr l ;
 632  8364 CB 3C        	srl h ; /32
 633  8366 CB 1D        	rr l ;
 634  8368
 635  8368
 636  8368 EB           	ex de,hl ;de - порядковый номер записи
 637  8369
 638  8369 21 D0 9E     	ld hl,file_info_string ;куда
 639  836C              	OS_GET_LFN ;получить длинное имя
 639  836C 0E 2A       >    ld c,#2a
 639  836E E7          >    rst #20
 640  836F
 641  836F CD C3 83     	call get_color_item
 642  8372
 643  8372 06 0C        	ld b,#c
 644  8374              	OS_SET_COLOR
 644  8374 0E 06       >    ld c,#06
 644  8376 E7          >    rst #20
 645  8377
 646  8377              	;печать не длиннее 80/2 символов
 647  8377 21 D0 9E     	ld hl,file_info_string
 648  837A 06 26        	ld b,80/2-2
 649  837C 0E 28        	ld c,40 ;колонка
 650  837E              print_file_info_LFN_cl
 651  837E E5           	push hl
 652  837F C5           	push bc
 653  8380 7E           	ld a,(hl)
 654  8381 B7           	or a
 655  8382 28 09        	jr z,print_file_info_LFN_cl_ex
 656  8384              	OS_PRINT_CHARF
 656  8384 D7          >	rst #10
 657  8385 C1           	pop bc
 658  8386 0C           	inc c
 659  8387 E1           	pop hl
 660  8388 23           	inc hl
 661  8389 10 F3        	djnz print_file_info_LFN_cl
 662  838B 18 02        	jr print_file_info_LFN_ex
 663  838D              print_file_info_LFN_cl_ex
 664  838D C1           	pop bc
 665  838E E1           	pop hl
 666  838F              print_file_info_LFN_ex
 667  838F              	;допечатать пробелы до правого края, зависит от длины имени
 668  838F              print_file_info_LFN_cl2
 669  838F 79           	ld a,c
 670  8390 FE 4E        	cp 80-2
 671  8392 D0           	ret nc
 672  8393 C5           	push bc
 673  8394 3E 20        	ld a,' '
 674  8396              	OS_PRINT_CHARF
 674  8396 D7          >	rst #10
 675  8397 C1           	pop bc
 676  8398 0C           	inc c
 677  8399 18 F4        	jr print_file_info_LFN_cl2
 678  839B
 679  839B
 680  839B
 681  839B              print_file_info_SFN ;печать короткого имени
 682  839B 11 D0 9E     	ld de,file_info_string ;скопировать
 683  839E 01 08 00     	ld bc,8 ;file_info_lenght
 684  83A1 ED B0        	ldir
 685  83A3 3E 20        	ld a,' '
 686  83A5 12           	ld (de),a
 687  83A6 13           	inc de
 688  83A7 01 03 00     	ld bc,3
 689  83AA ED B0        	ldir
 690  83AC AF           	xor a
 691  83AD 12           	ld (de),a
 692  83AE
 693  83AE CD C3 83     	call get_color_item
 694  83B1
 695  83B1 06 0C        	ld b,#c
 696  83B3              	OS_SET_COLOR
 696  83B3 0E 06       >    ld c,#06
 696  83B5 E7          >    rst #20
 697  83B6 21 D0 9E     	ld hl,file_info_string
 698  83B9              	OS_PRINTZ
 698  83B9 0E 09       >    ld c,#09
 698  83BB E7          >    rst #20
 699  83BC              	;допечатать пробелы до правого края, длина имени постоянная
 700  83BC 21 C2 99     	ld hl,file_info_string_SFN_end
 701  83BF              	OS_PRINTZ
 701  83BF 0E 09       >    ld c,#09
 701  83C1 E7          >    rst #20
 702  83C2 C9           	ret
 703  83C3
 704  83C3
 705  83C3
 706  83C3              get_color_item ;получить цвет элемента
 707  83C3              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 708  83C3              ;вых: A - цвет
 709  83C3 ED 4B BA 99  	ld bc,(file_r_num_cur) ;позиция курсора справа
 710  83C7 FD E5        	push iy
 711  83C9 E1           	pop hl
 712  83CA A7           	and a
 713  83CB ED 42        	sbc hl,bc ;сравнить
 714  83CD 28 11        	jr z,get_color_item_no_cursor
 715  83CF              	;цвета курсора
 716  83CF 3E 0E        	ld a,color_dir ;простая
 717  83D1 32 FB 83     	ld (get_color_item_dir+1),a
 718  83D4 3E 0C        	ld a,color_apg ;простая
 719  83D6 32 03 84     	ld (get_color_item_apg+1),a
 720  83D9 3E 0F        	ld a,color_backgr ;простая
 721  83DB 32 06 84     	ld (get_color_item_backgr+1),a
 722  83DE 18 0F        	jr get_color_item_set
 723  83E0
 724  83E0              get_color_item_no_cursor
 725  83E0              	;цвета обычные
 726  83E0 3E 28        	ld a,color_dir_hi ;под курсором
 727  83E2 32 FB 83     	ld (get_color_item_dir+1),a
 728  83E5 3E 28        	ld a,color_apg_hi ;под курсором
 729  83E7 32 03 84     	ld (get_color_item_apg+1),a
 730  83EA 3E 28        	ld a,color_backgr_hi ;под курсором
 731  83EC 32 06 84     	ld (get_color_item_backgr+1),a
 732  83EF
 733  83EF              get_color_item_set
 734  83EF              	;задать цвет
 735  83EF DD 7E 0B     	ld a,(ix+#0b)
 736  83F2 FE 10        	cp #10 ;признак каталога
 737  83F4 28 04        	jr z,get_color_item_dir
 738  83F6 FE 30        	cp #30 ;признак каталога
 739  83F8 20 03        	jr nz,get_color_item_no_dir
 740  83FA              	;если папка
 741  83FA              get_color_item_dir
 742  83FA 3E 00        	ld a,0
 743  83FC C9           	ret
 744  83FD
 745  83FD              get_color_item_no_dir
 746  83FD CD B3 82     	call check_apg ;расширение apg
 747  8400 20 03        	jr nz,get_color_item_no_apg
 748  8402              	;если приложение
 749  8402              get_color_item_apg
 750  8402 3E 00        	ld a,0
 751  8404 C9           	ret
 752  8405
 753  8405              get_color_item_no_apg
 754  8405              	;если обычный файл
 755  8405              get_color_item_backgr
 756  8405 3E 00        	ld a,0
 757  8407 C9           	ret
 758  8408
 759  8408
 760  8408
 761  8408              ; format_dir ;подготовить каталог, убрать лишнее
 762  8408              	; ; ld a,2
 763  8408              	; ; out (254),a
 764  8408              	; ld iy,0 ;счётчик файлов
 765  8408              	; ;найти конец каталога
 766  8408              	; ld hl,buffer_cat
 767  8408              	; ld a,(hl)
 768  8408              	; or a
 769  8408              	; ret z ;защита
 770  8408              	; ld bc,32
 771  8408              ; format_dir_prep_cl
 772  8408              	; ld a,(hl)
 773  8408              	; or a
 774  8408              	; jr z,format_dir_prep_ex
 775  8408              	; add hl,bc
 776  8408              	; ld a,h
 777  8408              	; or a ;если вышли за границу
 778  8408              	; jr z,format_dir_prep_ex
 779  8408              	; jr format_dir_prep_cl
 780  8408              ; format_dir_prep_ex
 781  8408              	; ld bc,32
 782  8408              	; and a
 783  8408              	; sbc hl,bc
 784  8408              	; ld (format_dir_top),hl ;конец каталога
 785  8408
 786  8408
 787  8408
 788  8408              	; ld ix,buffer_cat
 789  8408              	; ;ld b,panel_hight ;высота панели
 790  8408              ; format_dir_cl ;цикл
 791  8408              	; ld a,(ix)
 792  8408              	; or a ;конец каталога
 793  8408              	; jr z,format_dir_ex
 794  8408              	; cp #e5 ;удалённый
 795  8408              	; jr z,format_dir_skip
 796  8408              	; cp #05 ;удалённый
 797  8408              	; jr z,format_dir_skip
 798  8408              	; ld a,(ix+#0b)
 799  8408              	; cp #0f ;длинный
 800  8408              	; jr z,format_dir_skip
 801  8408
 802  8408              	; ;проверка на папку "." (этот же каталог)
 803  8408              	; ld a,(ix+#00)
 804  8408              	; cp "." ;
 805  8408              	; jr nz,format_dir_add
 806  8408              	; ld a,(ix+#01)
 807  8408              	; cp " " ;
 808  8408              	; jr z,format_dir_skip
 809  8408
 810  8408
 811  8408              ; format_dir_add
 812  8408              	; inc iy ;++
 813  8408              	; ld bc,32 ;на другой элемент каталога
 814  8408              	; add ix,bc
 815  8408              	; ld a,ixh
 816  8408              	; or a ;если вышли за границу
 817  8408              	; jr z,format_dir_ex
 818  8408              	; jr format_dir_cl
 819  8408              ; format_dir_skip
 820  8408              	; ;сдвинуть элементы вниз
 821  8408              	; push ix
 822  8408              	; push ix
 823  8408              	; pop hl
 824  8408              	; pop de ;куда
 825  8408              	; ld hl,(format_dir_top) ;0-32
 826  8408              	; and a
 827  8408              	; sbc hl,de
 828  8408              	; ld b,h
 829  8408              	; ld c,l ;длина
 830  8408              	; push bc
 831  8408
 832  8408              	; push ix
 833  8408              	; pop hl ;откуда
 834  8408              	; ld bc,32 ;на другой элемент каталога
 835  8408              	; add hl,bc ;откуда
 836  8408
 837  8408              	; pop bc
 838  8408              	; ldir
 839  8408
 840  8408              	; xor a
 841  8408              	; ld (de),a ;очистить ненужный элемент
 842  8408
 843  8408              	; jr format_dir_cl
 844  8408
 845  8408              ; format_dir_ex
 846  8408              	; ld (file_r_all),iy
 847  8408              	; ;здесь почистить остаток каталога
 848  8408              	; ; ld a,0
 849  8408              	; ; out (254),a
 850  8408              	; ret
 851  8408              ; format_dir_top	dw 0 ;временно конец гаталога
 852  8408
 853  8408
 854  8408
 855  8408
 856  8408
 857  8408              sort_dir ;сортировка каталога с помощью построения индекса
 858  8408 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 859  840C DD 7E 00     	ld a,(ix)
 860  840F B7           	or a
 861  8410 C8           	ret z ;если пусто, выход
 862  8411 FD 21 00 00  	ld iy,0 ;счётчик
 863  8415 21 D0 9A     	ld hl,cat_index ;таблица - индекс
 864  8418
 865  8418 3A 3A 85     	ld a,(sort_enable_flag)
 866  841B B7           	or a
 867  841C CA 3D 84     	jp z,sort_dir_no
 868  841F
 869  841F AF           	xor a
 870  8420 32 3C 84     	ld (sort_item),a ;образец для сравнения
 871  8423              sort_dir_cl
 872  8423 CD C5 84     	call sort_dir_one ;один проход по папкам
 873  8426 3A 3C 84     	ld a,(sort_item)
 874  8429 3C           	inc a ;следующий образец
 875  842A 32 3C 84     	ld (sort_item),a
 876  842D 20 F4        	jr nz,sort_dir_cl
 877  842F
 878  842F              	; xor a
 879  842F              	; ld (sort_item),a ;образец для сравнения
 880  842F              sort_file_cl
 881  842F CD 7D 84     	call sort_file_one ;один проход по файлам
 882  8432 3A 3C 84     	ld a,(sort_item)
 883  8435 3C           	inc a ;следующий образец
 884  8436 32 3C 84     	ld (sort_item),a
 885  8439 20 F4        	jr nz,sort_file_cl
 886  843B
 887  843B C9           	ret
 888  843C
 889  843C 00           sort_item db 0; текущий образец
 890  843D
 891  843D
 892  843D
 893  843D              ;без сортировки
 894  843D              sort_dir_no
 895  843D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 896  8441              sort_dir_no_cl ;цикл по каталогам
 897  8441 DD 7E 00     	ld a,(ix)
 898  8444 B7           	or a ;конец каталога
 899  8445 28 31        	jr z,sort_dir_no_ex
 900  8447 FE E5        	cp #e5 ;удалённый
 901  8449 28 22        	jr z,sort_dir_no_skip
 902  844B FE 05        	cp #05 ;удалённый
 903  844D 28 1E        	jr z,sort_dir_no_skip
 904  844F DD 7E 0B     	ld a,(ix+#0b)
 905  8452 FE 0F        	cp #0f ;длинный
 906  8454 28 17        	jr z,sort_dir_no_skip
 907  8456
 908  8456              	;проверка на папку "." (этот же каталог)
 909  8456 DD 7E 00     	ld a,(ix+#00)
 910  8459 FE 2E        	cp "." ;
 911  845B 20 07        	jr nz,sort_dir_no_add
 912  845D DD 7E 01     	ld a,(ix+#01)
 913  8460 FE 20        	cp " " ;
 914  8462 28 09        	jr z,sort_dir_no_skip
 915  8464
 916  8464              sort_dir_no_add
 917  8464 FD 23        	inc iy ;++
 918  8466              	;записать в таблицу (индекс)
 919  8466 DD E5        	push ix
 920  8468 C1           	pop bc
 921  8469 71           	ld (hl),c
 922  846A 23           	inc hl
 923  846B 70           	ld (hl),b
 924  846C 23           	inc hl
 925  846D
 926  846D
 927  846D              sort_dir_no_skip
 928  846D 01 20 00     	ld bc,32
 929  8470 DD 09        	add ix,bc ;на следующий
 930  8472 DD 7C        	ld a,ixh ;проверка на конец буфера
 931  8474 FE C0        	cp #c0
 932  8476 30 C9        	jr nc,sort_dir_no_cl
 933  8478
 934  8478              sort_dir_no_ex
 935  8478 FD 22 A8 97  	ld (file_r_all),iy
 936  847C C9           	ret
 937  847D
 938  847D
 939  847D              ;сортировка файлов
 940  847D              sort_file_one
 941  847D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 942  8481              sort_file_one_cl ;цикл по каталогам
 943  8481 DD 7E 00     	ld a,(ix)
 944  8484 B7           	or a ;конец каталога
 945  8485 28 39        	jr z,sort_file_one_ex
 946  8487 DD 7E 0B     	ld a,(ix+#0b)
 947  848A FE 10        	cp #10 ;признак каталога
 948  848C 28 27        	jr z,sort_file_one_skip
 949  848E FE 30        	cp #30 ;признак каталога
 950  8490 28 23        	jr z,sort_file_one_skip
 951  8492 DD 7E 00     	ld a,(ix)
 952  8495 FE E5        	cp #e5 ;удалённый
 953  8497 28 1C        	jr z,sort_file_one_skip
 954  8499 FE 05        	cp #05 ;удалённый
 955  849B 28 18        	jr z,sort_file_one_skip
 956  849D DD 7E 0B     	ld a,(ix+#0b)
 957  84A0 FE 0F        	cp #0f ;длинный
 958  84A2 28 11        	jr z,sort_file_one_skip
 959  84A4
 960  84A4              	; ;проверка на папку "." (этот же каталог)
 961  84A4              	; ld a,(ix+#00)
 962  84A4              	; cp "." ;
 963  84A4              	; jr nz,sort_file_one_add
 964  84A4              	; ld a,(ix+#01)
 965  84A4              	; cp " " ;
 966  84A4              	; jr z,sort_file_one_skip
 967  84A4
 968  84A4
 969  84A4              sort_file_one_add
 970  84A4 3A 3C 84     	ld a,(sort_item)
 971  84A7 DD BE 00     	cp (ix+#00) ;первая буква имени
 972  84AA 20 09        	jr nz,sort_file_one_skip ;пока не подошла
 973  84AC
 974  84AC FD 23        	inc iy ;++
 975  84AE              	;записать в таблицу (индекс)
 976  84AE DD E5        	push ix
 977  84B0 C1           	pop bc
 978  84B1 71           	ld (hl),c
 979  84B2 23           	inc hl
 980  84B3 70           	ld (hl),b
 981  84B4 23           	inc hl
 982  84B5
 983  84B5
 984  84B5              sort_file_one_skip
 985  84B5 01 20 00     	ld bc,32
 986  84B8 DD 09        	add ix,bc ;на следующий
 987  84BA DD 7C        	ld a,ixh ;проверка на конец буфера
 988  84BC FE C0        	cp #c0
 989  84BE 30 C1        	jr nc,sort_file_one_cl
 990  84C0
 991  84C0              sort_file_one_ex
 992  84C0 FD 22 A8 97  	ld (file_r_all),iy
 993  84C4 C9           	ret
 994  84C5
 995  84C5
 996  84C5
 997  84C5
 998  84C5
 999  84C5              ;сортировка папок
1000  84C5              sort_dir_one
1001  84C5 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1002  84C9              sort_dir_one_cl ;цикл по каталогам
1003  84C9 DD 7E 00     	ld a,(ix)
1004  84CC B7           	or a ;конец каталога
1005  84CD 28 47        	jr z,sort_dir_one_ex
1006  84CF DD 7E 0B     	ld a,(ix+#0b)
1007  84D2 FE 10        	cp #10 ;признак каталога
1008  84D4 28 04        	jr z,sort_dir_one_skip_no
1009  84D6 FE 30        	cp #30 ;признак каталога
1010  84D8 20 31        	jr nz,sort_dir_one_skip
1011  84DA              sort_dir_one_skip_no
1012  84DA DD 7E 00     	ld a,(ix)
1013  84DD FE E5        	cp #e5 ;удалённый
1014  84DF 28 2A        	jr z,sort_dir_one_skip
1015  84E1 FE 05        	cp #05 ;удалённый
1016  84E3 28 26        	jr z,sort_dir_one_skip
1017  84E5 DD 7E 0B     	ld a,(ix+#0b)
1018  84E8 FE 0F        	cp #0f ;длинный
1019  84EA 28 1F        	jr z,sort_dir_one_skip
1020  84EC
1021  84EC              	;проверка на папку "." (этот же каталог)
1022  84EC DD 7E 00     	ld a,(ix+#00)
1023  84EF FE 2E        	cp "." ;
1024  84F1 20 07        	jr nz,sort_dir_one_add
1025  84F3 DD 7E 01     	ld a,(ix+#01)
1026  84F6 FE 20        	cp " " ;
1027  84F8 28 11        	jr z,sort_dir_one_skip
1028  84FA
1029  84FA              sort_dir_one_add
1030  84FA 3A 3C 84     	ld a,(sort_item)
1031  84FD DD BE 00     	cp (ix+#00) ;первая буква имени
1032  8500 20 09        	jr nz,sort_dir_one_skip ;пока не подошла
1033  8502
1034  8502 FD 23        	inc iy ;++
1035  8504              	;записать в таблицу (индекс)
1036  8504 DD E5        	push ix
1037  8506 C1           	pop bc
1038  8507 71           	ld (hl),c
1039  8508 23           	inc hl
1040  8509 70           	ld (hl),b
1041  850A 23           	inc hl
1042  850B
1043  850B
1044  850B              sort_dir_one_skip
1045  850B 01 20 00     	ld bc,32
1046  850E DD 09        	add ix,bc ;на следующий
1047  8510 DD 7C        	ld a,ixh ;проверка на конец буфера
1048  8512 FE C0        	cp #c0
1049  8514 30 B3        	jr nc,sort_dir_one_cl
1050  8516
1051  8516              sort_dir_one_ex
1052  8516 FD 22 A8 97  	ld (file_r_all),iy
1053  851A C9           	ret
1054  851B
1055  851B
1056  851B
1057  851B
1058  851B
1059  851B
1060  851B
1061  851B              sort_toggle ;переключение сортировки
1062  851B 3A 3A 85     	ld a,(sort_enable_flag)
1063  851E EE 01        	xor 1
1064  8520 32 3A 85     	ld (sort_enable_flag),a
1065  8523 3E 66        	ld a,"f" ;вкл
1066  8525 20 02        	jr nz,sort_toggle1
1067  8527 3E 4E        	ld a,"N";выкл
1068  8529              sort_toggle1
1069  8529 32 79 9A     	ld (msg_menu_main2+5),a
1070  852C
1071  852C CD 08 84     	call sort_dir
1072  852F CD C2 85     	call print_menu_main
1073  8532 3E 01        	ld a,1
1074  8534 32 C1 99     	ld (print_panel_r_flag),a
1075  8537
1076  8537 C3 5C 80     	jp nc_wait
1077  853A 00           sort_enable_flag db 0 ;флаг сортировки
1078  853B
1079  853B
1080  853B
1081  853B
1082  853B              LFN_toggle ;переключение сортировки
1083  853B 3A 57 85     	ld a,(LFN_enable_flag)
1084  853E EE 01        	xor 1
1085  8540 32 57 85     	ld (LFN_enable_flag),a
1086  8543 3E 66        	ld a,"f" ;вкл
1087  8545 20 02        	jr nz,LFN_toggle1
1088  8547 3E 4E        	ld a,"N";выкл
1089  8549              LFN_toggle1
1090  8549 32 72 9A     	ld (msg_menu_main1+5),a
1091  854C
1092  854C              	;call sort_dir
1093  854C CD C2 85     	call print_menu_main
1094  854F 3E 01        	ld a,1
1095  8551 32 C1 99     	ld (print_panel_r_flag),a
1096  8554
1097  8554 C3 5C 80     	jp nc_wait
1098  8557 00           LFN_enable_flag db 0 ;флаг сортировки
1099  8558
1100  8558
1101  8558
1102  8558
1103  8558
1104  8558              format_name ;подогнать имя под стандарт filename.ext
1105  8558              ;вх: HL - имя в каталоге
1106  8558 E5           	push hl
1107  8559 21 AC 97     	ld hl,file_name_cur
1108  855C 11 AD 97     	ld de,file_name_cur+1 ;почистить
1109  855F 01 FF 00     	ld bc,256-1
1110  8562 36 00        	ld (hl),0
1111  8564 ED B0        	ldir
1112  8566
1113  8566 E1           	pop hl
1114  8567 E5           	push hl
1115  8568
1116  8568 11 AC 97     	ld de,file_name_cur ;куда
1117  856B 01 FF 08     	ld bc,#08ff
1118  856E              format_name_cl
1119  856E 7E           	ld a,(hl)
1120  856F FE 21        	cp " "+1
1121  8571 38 04        	jr c,format_name_skip
1122  8573 ED A0        	ldi
1123  8575 10 F7        	djnz format_name_cl
1124  8577              format_name_skip
1125  8577 3E 2E        	ld a,"."
1126  8579 12           	ld (de),a
1127  857A
1128  857A 13           	inc de
1129  857B E1           	pop hl
1130  857C 01 08 00     	ld bc,8 ;перейти на расширение
1131  857F 09           	add hl,bc
1132  8580
1133  8580 01 FF 03     	ld bc,#03ff
1134  8583              format_name_cl2
1135  8583 7E           	ld a,(hl)
1136  8584 FE 21        	cp " "+1
1137  8586 38 04        	jr c,format_name_skip2
1138  8588 ED A0        	ldi
1139  858A 10 F7        	djnz format_name_cl2
1140  858C              format_name_skip2
1141  858C C9           	ret
1142  858D
1143  858D              print_rect_r ;печать рамки правой
1144  858D 3E 0F        	ld a,color_backgr ;цвет
1145  858F 06 0C        	ld b,#c
1146  8591              	OS_SET_COLOR
1146  8591 0E 06       >    ld c,#06
1146  8593 E7          >    rst #20
1147  8594 11 28 00     	ld de,#0028 ;xy
1148  8597              	OS_SET_XY
1148  8597 0E 01       >    ld c,#01
1148  8599 E7          >    rst #20
1149  859A 21 DD 99     	ld hl,rect_1
1150  859D              	OS_PRINTZ
1150  859D 0E 09       >    ld c,#09
1150  859F E7          >    rst #20
1151  85A0
1152  85A0 11 28 01     	ld de,#0128 ;xy
1153  85A3 06 16        	ld b,24-2 ;цикл
1154  85A5              print_rect_r_cl
1155  85A5 C5           	push bc
1156  85A6 D5           	push de
1157  85A7              	OS_SET_XY
1157  85A7 0E 01       >    ld c,#01
1157  85A9 E7          >    rst #20
1158  85AA 21 06 9A     	ld hl,rect_2
1159  85AD              	OS_PRINTZ
1159  85AD 0E 09       >    ld c,#09
1159  85AF E7          >    rst #20
1160  85B0 D1           	pop de
1161  85B1 14           	inc d
1162  85B2 C1           	pop bc
1163  85B3 10 F0        	djnz print_rect_r_cl
1164  85B5
1165  85B5
1166  85B5 11 28 17     	ld de,#1728 ;xy
1167  85B8              	OS_SET_XY
1167  85B8 0E 01       >    ld c,#01
1167  85BA E7          >    rst #20
1168  85BB 21 2F 9A     	ld hl,rect_3
1169  85BE              	OS_PRINTZ
1169  85BE 0E 09       >    ld c,#09
1169  85C0 E7          >    rst #20
1170  85C1 C9           	ret
1171  85C2
1172  85C2              print_menu_main ;печать основного меню
1173  85C2 3E 07        	ld a,color_default ;цвет
1174  85C4 06 0C        	ld b,#c
1175  85C6              	OS_SET_COLOR
1175  85C6 0E 06       >    ld c,#06
1175  85C8 E7          >    rst #20
1176  85C9
1177  85C9 11 00 18     	ld de,#1800+0*8
1178  85CC              	OS_SET_XY
1178  85CC 0E 01       >    ld c,#01
1178  85CE E7          >    rst #20
1179  85CF 3E 31        	ld a,"1" ;пункт 1
1180  85D1              	OS_PRINT_CHARF
1180  85D1 D7          >	rst #10
1181  85D2 11 08 18     	ld de,#1800+1*8
1182  85D5              	OS_SET_XY
1182  85D5 0E 01       >    ld c,#01
1182  85D7 E7          >    rst #20
1183  85D8 3E 32        	ld a,"2" ;пункт 2
1184  85DA              	OS_PRINT_CHARF
1184  85DA D7          >	rst #10
1185  85DB 11 10 18     	ld de,#1800+2*8
1186  85DE              	OS_SET_XY
1186  85DE 0E 01       >    ld c,#01
1186  85E0 E7          >    rst #20
1187  85E1 3E 33        	ld a,"3" ;пункт 3
1188  85E3              	OS_PRINT_CHARF
1188  85E3 D7          >	rst #10
1189  85E4
1190  85E4
1191  85E4 3E 28        	ld a,color_backgr_hi ;цвет
1192  85E6 06 0C        	ld b,#c
1193  85E8              	OS_SET_COLOR
1193  85E8 0E 06       >    ld c,#06
1193  85EA E7          >    rst #20
1194  85EB
1195  85EB 11 01 18     	ld de,#1800+0*8+1
1196  85EE              	OS_SET_XY
1196  85EE 0E 01       >    ld c,#01
1196  85F0 E7          >    rst #20
1197  85F1 21 6D 9A     	ld hl,msg_menu_main1
1198  85F4              	OS_PRINTZ
1198  85F4 0E 09       >    ld c,#09
1198  85F6 E7          >    rst #20
1199  85F7 11 09 18     	ld de,#1800+1*8+1
1200  85FA              	OS_SET_XY
1200  85FA 0E 01       >    ld c,#01
1200  85FC E7          >    rst #20
1201  85FD 21 74 9A     	ld hl,msg_menu_main2
1202  8600              	OS_PRINTZ
1202  8600 0E 09       >    ld c,#09
1202  8602 E7          >    rst #20
1203  8603 11 11 18     	ld de,#1800+2*8+1
1204  8606              	OS_SET_XY
1204  8606 0E 01       >    ld c,#01
1204  8608 E7          >    rst #20
1205  8609 21 7B 9A     	ld hl,msg_menu_main3
1206  860C              	OS_PRINTZ
1206  860C 0E 09       >    ld c,#09
1206  860E E7          >    rst #20
1207  860F C9           	ret
1208  8610
1209  8610
1210  8610              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 8610              view_file
   2+ 8610              	;просмотр файла как текста
   3+ 8610
   4+ 8610 2A A8 97     	ld hl,(file_r_all)
   5+ 8613 7D           	ld a,l
   6+ 8614 B4           	or h
   7+ 8615 CA F1 86     	jp z,view_file_ex ;защита
   8+ 8618 2A BA 99     	ld hl,(file_r_num_cur)
   9+ 861B CD 0E 82     	call calc_deskr
  10+ 861E DD 7E 0B     	ld a,(ix+#0b)
  11+ 8621 FE 10        	cp #10 ;признак каталога
  12+ 8623 CA F1 86     	jp z,view_file_ex
  13+ 8626
  14+ 8626 CD 58 85     	call format_name ;обработать имя файла
  15+ 8629
  16+ 8629
  17+ 8629
  18+ 8629              	OS_CLS ;почистить экран
  18+ 8629 0E 00       >    ld c,#00
  18+ 862B E7          >    rst #20
  19+ 862C
  20+ 862C              	;обнулить переменные
  21+ 862C AF           	xor a
  22+ 862D 32 16 89     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  23+ 8630              	;ld (view_file_bot_flag),a  ;
  24+ 8630 21 FF FF     	ld hl,#ffff
  25+ 8633 22 17 89     	ld (view_file_end),hl ;конец файла тут
  26+ 8636 23           	inc hl
  27+ 8637 22 0E 89     	ld (view_move_right_val),hl
  28+ 863A
  29+ 863A C5           	push bc
  30+ 863B CD B3 80     	call clear_buf
  31+ 863E C1           	pop bc
  32+ 863F
  33+ 863F 3E FF        	ld a,255
  34+ 8641 32 BD 99     	ld (file_id_cur_r),a
  35+ 8644 21 AC 97     	ld hl,file_name_cur		;строка с именем
  36+ 8647              	OS_FILE_OPEN
  36+ 8647 0E 21       >    ld c,#21
  36+ 8649 E7          >    rst #20
  37+ 864A 30 0E        	jr nc,view_file_open_ok
  38+ 864C              view_file_file_error
  39+ 864C 21 81 9A     	ld hl,msg_file_error
  40+ 864F              	OS_PRINTZ
  40+ 864F 0E 09       >    ld c,#09
  40+ 8651 E7          >    rst #20
  41+ 8652 06 64        	ld b,2*50
  42+ 8654 CD AF 80     	call delay1
  43+ 8657 C3 E1 86     	jp view_file_wait_ex
  44+ 865A
  45+ 865A              view_file_open_ok
  46+ 865A 32 BD 99     	ld (file_id_cur_r),a
  47+ 865D              	;проверка длины файла не больше #4000
  48+ 865D 7A           	ld	a,d ;самые старшие байты длины
  49+ 865E B3           	or e
  50+ 865F 28 11        	jr z,view_file_size_ok ;если не слищком большой
  51+ 8661              view_file_too_big
  52+ 8661              	;файл больше буфера
  53+ 8661 11 00 40     	ld de,#4000 ;размер одной первой части
  54+ 8664 21 00 C0     	ld hl,buffer_cat
  55+ 8667 3A BD 99     	ld a,(file_id_cur_r)
  56+ 866A              	OS_FILE_READ ;загрузить
  56+ 866A 0E 23       >    ld c,#23
  56+ 866C E7          >    rst #20
  57+ 866D 38 DD        	jr c,view_file_file_error
  58+ 866F
  59+ 866F C3 9B 86     	jp view_file_readed
  60+ 8672
  61+ 8672              view_file_size_ok
  62+ 8672 78           	ld	a,b ;младший старший байт длины
  63+ 8673 FE 40        	cp #40
  64+ 8675 38 06        	jr c,view_file_size_ok_small
  65+ 8677 20 E8        	jr nz,view_file_too_big
  66+ 8679 0C           	inc c
  67+ 867A 0D           	dec c
  68+ 867B 20 E4        	jr nz,view_file_too_big
  69+ 867D
  70+ 867D
  71+ 867D              view_file_size_ok_small
  72+ 867D              	;проверка на 0
  73+ 867D 78           	ld a,b
  74+ 867E B1           	or c
  75+ 867F CA 4C 86     	jp z,view_file_file_error
  76+ 8682              	;узнать где конец файла
  77+ 8682 21 00 C0     	ld hl,buffer_cat
  78+ 8685 09           	add hl,bc
  79+ 8686 22 17 89     	ld (view_file_end),hl ;конец файла тут
  80+ 8689              	;размер не большой, прочитаем
  81+ 8689 50           	ld d,b ;размер
  82+ 868A 59           	ld e,c
  83+ 868B 21 00 C0     	ld hl,buffer_cat
  84+ 868E 3A BD 99     	ld a,(file_id_cur_r)
  85+ 8691              	OS_FILE_READ ;загрузить
  85+ 8691 0E 23       >    ld c,#23
  85+ 8693 E7          >    rst #20
  86+ 8694 38 B6        	jr c,view_file_file_error
  87+ 8696
  88+ 8696 3E 01        	ld a,1
  89+ 8698 32 16 89     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  90+ 869B
  91+ 869B              view_file_readed
  92+ 869B              	;файл прочитан
  93+ 869B
  94+ 869B 21 00 C0     	ld hl,buffer_cat
  95+ 869E 22 10 89     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  96+ 86A1 22 12 89     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  97+ 86A4
  98+ 86A4 CD BA 87     	call print_file_text
  99+ 86A7
 100+ 86A7
 101+ 86A7 CD 85 87     	call print_menu_view ;меню
 102+ 86AA CD A0 87     	call print_menu_view_top ;инфо
 103+ 86AD
 104+ 86AD CD 0B 81     	call release_key
 105+ 86B0
 106+ 86B0              view_file_wait ;цикл ожидания клавиши
 107+ 86B0              	OS_WAIT
 107+ 86B0 DF          >	rst #18
 108+ 86B1              	OS_GET_CHAR
 108+ 86B1 0E 10       >    ld c,#10
 108+ 86B3 E7          >    rst #20
 109+ 86B4 FE FF        	cp 255
 110+ 86B6 28 F8        	jr z,view_file_wait
 111+ 86B8 FE 33        	cp "3"
 112+ 86BA 28 25        	jr z,view_file_wait_ex
 113+ 86BC FE 0A        	cp 10 ;вниз
 114+ 86BE CA FE 86     	jp z,view_line_down
 115+ 86C1 FE 0B        	cp 11 ;вверх
 116+ 86C3 CA 14 87     	jp z,view_line_up
 117+ 86C6 FE 09        	cp 09 ;вправо
 118+ 86C8 CA 28 87     	jp z,view_right
 119+ 86CB FE 08        	cp 08 ;влево
 120+ 86CD CA 39 87     	jp z,view_left
 121+ 86D0 FE 04        	cp 04 ;страница вверх
 122+ 86D2 CA 4B 87     	jp z,view_page_up
 123+ 86D5 FE 05        	cp 05 ;страница вниз
 124+ 86D7 CA 68 87     	jp z,view_page_down
 125+ 86DA FE 18        	cp 24 ;break
 126+ 86DC CA AF 82     	jp z,exit
 127+ 86DF 18 CF        	jr view_file_wait
 128+ 86E1
 129+ 86E1              view_file_wait_ex
 130+ 86E1 3A BD 99     	ld a,(file_id_cur_r)
 131+ 86E4 FE FF        	cp 255
 132+ 86E6 28 03        	jr z,view_file_wait_ex1
 133+ 86E8              	OS_FILE_CLOSE ;A - id file
 133+ 86E8 0E 25       >    ld c,#25
 133+ 86EA E7          >    rst #20
 134+ 86EB              view_file_wait_ex1
 135+ 86EB              	;почистить экран
 136+ 86EB              	OS_CLS
 136+ 86EB 0E 00       >    ld c,#00
 136+ 86ED E7          >    rst #20
 137+ 86EE C3 23 80     	jp start_nc_warm ;перезагрузить папку
 138+ 86F1
 139+ 86F1              view_file_ex
 140+ 86F1 3A BD 99     	ld a,(file_id_cur_r)
 141+ 86F4 FE FF        	cp 255
 142+ 86F6 28 03        	jr z,view_file_ex1
 143+ 86F8              	OS_FILE_CLOSE ;A - id file
 143+ 86F8 0E 25       >    ld c,#25
 143+ 86FA E7          >    rst #20
 144+ 86FB              view_file_ex1
 145+ 86FB C3 5C 80     	jp nc_wait
 146+ 86FE
 147+ 86FE
 148+ 86FE
 149+ 86FE              view_line_down ;вниз на строчку
 150+ 86FE 2A 12 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 151+ 8701 22 10 89     	ld (view_file_pos_cur),hl
 152+ 8704 CD E1 88     	call next_line ;вперёд на строку
 153+ 8707 38 A7        	jr c,view_file_wait ;если не удачно
 154+ 8709 2A 10 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 155+ 870C 22 12 89     	ld (view_file_pos_cur_focus),hl
 156+ 870F CD BA 87     	call print_file_text ;напечатать всю страницу
 157+ 8712 18 9C        	jr view_file_wait
 158+ 8714
 159+ 8714              view_line_up ;вверх на строчку
 160+ 8714 2A 12 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 161+ 8717 22 10 89     	ld (view_file_pos_cur),hl
 162+ 871A CD EF 88     	call prev_line ;
 163+ 871D              	;jr c,view_file_wait ;если не удачно
 164+ 871D 2A 10 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 165+ 8720 22 12 89     	ld (view_file_pos_cur_focus),hl
 166+ 8723 CD BA 87     	call print_file_text ;напечатать всю страницу
 167+ 8726 18 88        	jr view_file_wait
 168+ 8728
 169+ 8728
 170+ 8728              view_right ;вправо
 171+ 8728 2A 0E 89     	ld hl,(view_move_right_val)
 172+ 872B 23           	inc hl
 173+ 872C 7C           	ld a,h
 174+ 872D B5           	or l
 175+ 872E 28 80        	jr z,view_file_wait
 176+ 8730 22 0E 89     	ld (view_move_right_val),hl
 177+ 8733 CD BA 87     	call print_file_text ;напечатать всю страницу
 178+ 8736 C3 B0 86     	jp view_file_wait
 179+ 8739
 180+ 8739              view_left ;влево
 181+ 8739 2A 0E 89     	ld hl,(view_move_right_val)
 182+ 873C 7C           	ld a,h
 183+ 873D B5           	or l
 184+ 873E CA B0 86     	jp z,view_file_wait
 185+ 8741 2B           	dec hl
 186+ 8742 22 0E 89     	ld (view_move_right_val),hl
 187+ 8745 CD BA 87     	call print_file_text ;напечатать всю страницу
 188+ 8748 C3 B0 86     	jp view_file_wait
 189+ 874B
 190+ 874B
 191+ 874B
 192+ 874B              view_page_up ;на страницу назад
 193+ 874B 2A 12 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 194+ 874E 22 10 89     	ld (view_file_pos_cur),hl
 195+ 8751 06 16        	ld b,view_text_bot-2
 196+ 8753              view_page_up_cl
 197+ 8753 CD EF 88     	call prev_line ;
 198+ 8756 38 04        	jr c,view_page_up_ex ;если не удачно
 199+ 8758 28 02        	jr z,view_page_up_ex
 200+ 875A 10 F7        	djnz view_page_up_cl
 201+ 875C              view_page_up_ex
 202+ 875C 2A 10 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 203+ 875F 22 12 89     	ld (view_file_pos_cur_focus),hl
 204+ 8762 CD BA 87     	call print_file_text ;напечатать всю страницу
 205+ 8765 C3 B0 86     	jp view_file_wait
 206+ 8768
 207+ 8768
 208+ 8768
 209+ 8768              view_page_down ;на страницу вперёд
 210+ 8768 2A 12 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 211+ 876B 22 10 89     	ld (view_file_pos_cur),hl
 212+ 876E 06 16        	ld b,view_text_bot-2
 213+ 8770              view_page_down_cl
 214+ 8770 CD E1 88     	call next_line ;
 215+ 8773 38 04        	jr c,view_page_down_ex ;если не удачно
 216+ 8775 28 02        	jr z,view_page_down_ex
 217+ 8777 10 F7        	djnz view_page_down_cl
 218+ 8779              view_page_down_ex
 219+ 8779 2A 10 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 220+ 877C 22 12 89     	ld (view_file_pos_cur_focus),hl
 221+ 877F CD BA 87     	call print_file_text ;напечатать всю страницу
 222+ 8782 C3 B0 86     	jp view_file_wait
 223+ 8785
 224+ 8785
 225+ 8785
 226+ 8785              print_menu_view ;печать меню просмотрщика
 227+ 8785 3E 18        	ld a,#18
 228+ 8787 06 28        	ld b,color_backgr_hi ;цвет
 229+ 8789              	OS_PAINT_LINE ;линия внизу
 229+ 8789 0E 04       >    ld c,#04
 229+ 878B E7          >    rst #20
 230+ 878C 3E 28        	ld a,color_backgr_hi ;цвет
 231+ 878E 06 0C        	ld b,#c
 232+ 8790              	OS_SET_COLOR
 232+ 8790 0E 06       >    ld c,#06
 232+ 8792 E7          >    rst #20
 233+ 8793 11 10 18     	ld de,#1800+2*8
 234+ 8796              	OS_SET_XY
 234+ 8796 0E 01       >    ld c,#01
 234+ 8798 E7          >    rst #20
 235+ 8799 21 07 89     	ld hl,msg_menu_view
 236+ 879C              	OS_PRINTZ
 236+ 879C 0E 09       >    ld c,#09
 236+ 879E E7          >    rst #20
 237+ 879F C9           	ret
 238+ 87A0
 239+ 87A0              print_menu_view_top ;печать меню просмотрщика верхнее
 240+ 87A0 AF           	xor a
 241+ 87A1 06 28        	ld b,color_backgr_hi ;цвет
 242+ 87A3              	OS_PAINT_LINE ;линия вверху
 242+ 87A3 0E 04       >    ld c,#04
 242+ 87A5 E7          >    rst #20
 243+ 87A6 3E 28        	ld a,color_backgr_hi ;цвет
 244+ 87A8 06 0C        	ld b,#c
 245+ 87AA              	OS_SET_COLOR
 245+ 87AA 0E 06       >    ld c,#06
 245+ 87AC E7          >    rst #20
 246+ 87AD 11 24 00     	ld de,#0024
 247+ 87B0              	OS_SET_XY
 247+ 87B0 0E 01       >    ld c,#01
 247+ 87B2 E7          >    rst #20
 248+ 87B3 21 AC 97     	ld hl,file_name_cur
 249+ 87B6              	OS_PRINTZ
 249+ 87B6 0E 09       >    ld c,#09
 249+ 87B8 E7          >    rst #20
 250+ 87B9 C9           	ret
 251+ 87BA
 252+ 87BA
 253+ 87BA
 254+ 87BA              print_file_text	;печать текущей части файла в консоль
 255+ 87BA 3E 04        	ld a,color_view_text ;цвет
 256+ 87BC 06 0C        	ld b,#c
 257+ 87BE              	OS_SET_COLOR
 257+ 87BE 0E 06       >    ld c,#06
 257+ 87C0 E7          >    rst #20
 258+ 87C1
 259+ 87C1 3E 01        	ld a,view_text_top ;первая строка
 260+ 87C3 32 14 89     	ld (view_file_y_cur),a
 261+ 87C6 2A 12 89     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 262+ 87C9 22 10 89     	ld (view_file_pos_cur),hl
 263+ 87CC              print_file_text_cl
 264+ 87CC 2A 10 89     	ld hl,(view_file_pos_cur)
 265+ 87CF CD F5 87     	call print_line_text
 266+ 87D2 38 0C        	jr c,print_file_text_ex
 267+ 87D4
 268+ 87D4              	; call next_line ;найти следующую строку
 269+ 87D4              	; ret c
 270+ 87D4
 271+ 87D4 3A 14 89     	ld a,(view_file_y_cur)
 272+ 87D7 3C           	inc a
 273+ 87D8 32 14 89     	ld (view_file_y_cur),a
 274+ 87DB FE 18        	cp view_text_bot
 275+ 87DD 38 ED        	jr c,print_file_text_cl
 276+ 87DF C9           	ret
 277+ 87E0
 278+ 87E0              print_file_text_ex
 279+ 87E0              	;тут очистить остальные строки
 280+ 87E0 3A 14 89     	ld a,(view_file_y_cur)
 281+ 87E3 3C           	inc a
 282+ 87E4 FE 18        	cp view_text_bot
 283+ 87E6 30 0B        	jr nc,print_file_text_ex2
 284+ 87E8 67           	ld h,a
 285+ 87E9 32 14 89     	ld (view_file_y_cur),a
 286+ 87EC 3E 20        	ld a," "
 287+ 87EE              	OS_FILL_LINE ;очистить строку
 287+ 87EE 0E 03       >    ld c,#03
 287+ 87F0 E7          >    rst #20
 288+ 87F1 18 ED        	jr print_file_text_ex
 289+ 87F3              print_file_text_ex2
 290+ 87F3 37           	scf
 291+ 87F4 C9           	ret
 292+ 87F5
 293+ 87F5
 294+ 87F5
 295+ 87F5              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 296+ 87F5              ;вх: hl - адрес строки
 297+ 87F5 CD 45 88     	call view_move_right ;промотать направо. если надо
 298+ 87F8              	;установить позицию
 299+ 87F8 3A 14 89     	ld a,(view_file_y_cur)
 300+ 87FB 57           	ld d,a
 301+ 87FC AF           	xor a
 302+ 87FD 32 15 89     	ld (view_file_x_cur),a
 303+ 8800 5F           	ld e,a
 304+ 8801              	OS_SET_XY 	;yx
 304+ 8801 0E 01       >    ld c,#01
 304+ 8803 E7          >    rst #20
 305+ 8804              print_line_text_cl ;цикл
 306+ 8804
 307+ 8804 7E           	ld a,(hl)
 308+ 8805 FE 0A        	cp 10 ;этот код не печатаем
 309+ 8807 28 14        	jr z,print_line_text_skip
 310+ 8809 FE FF        	cp #ff ;этот код не печатаем
 311+ 880B 28 10        	jr z,print_line_text_skip
 312+ 880D FE 0D        	cp 13
 313+ 880F 28 13        	jr z,print_line_text_ex_ok
 314+ 8811              	OS_PRINT_CHARF ;печать
 314+ 8811 D7          >	rst #10
 315+ 8812
 316+ 8812              	;на следующую позицию
 317+ 8812 3A 15 89     	ld a,(view_file_x_cur)
 318+ 8815 3C           	inc a
 319+ 8816 FE 50        	cp 80 ;правый край экрана
 320+ 8818 32 15 89     	ld (view_file_x_cur),a
 321+ 881B 30 15        	jr nc,print_line_text_right ;дошли до правого края
 322+ 881D
 323+ 881D              print_line_text_skip
 324+ 881D CD 7D 88     	call view_file_next_pos ;следующий
 325+ 8820 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 326+ 8822 18 E0        	jr print_line_text_cl
 327+ 8824
 328+ 8824              print_line_text_ex_ok ;выход норма по коду 13
 329+ 8824 3E 20        	ld a," "
 330+ 8826              	OS_PRINT_CHARF ;печать
 330+ 8826 D7          >	rst #10
 331+ 8827 CD 36 88     	call printe_clear_end ;добить до конца строки
 332+ 882A C3 7D 88     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 333+ 882D              	;ret
 334+ 882D
 335+ 882D              print_line_text_ex_end ;выход если кончился файл
 336+ 882D CD 36 88     	call printe_clear_end
 337+ 8830 37           	scf
 338+ 8831 C9           	ret
 339+ 8832
 340+ 8832              print_line_text_right
 341+ 8832 CD E1 88     	call next_line ;позицию  до конца строки
 342+ 8835 C9           	ret
 343+ 8836
 344+ 8836
 345+ 8836              printe_clear_end
 346+ 8836              	;добить строку пробелами
 347+ 8836 3A 15 89     	ld a,(view_file_x_cur)
 348+ 8839 3C           	inc a
 349+ 883A FE 50        	cp 80 ;правый край экрана
 350+ 883C 32 15 89     	ld (view_file_x_cur),a
 351+ 883F D0           	ret nc
 352+ 8840 3E 20        	ld a," "
 353+ 8842              	OS_PRINT_CHARF ;печать
 353+ 8842 D7          >	rst #10
 354+ 8843 18 F1        	jr printe_clear_end
 355+ 8845
 356+ 8845
 357+ 8845
 358+ 8845
 359+ 8845
 360+ 8845              view_move_right ;перемотка строки направо
 361+ 8845 ED 4B 0E 89  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 362+ 8849 78           	ld a,b
 363+ 884A B1           	or c
 364+ 884B C8           	ret z
 365+ 884C 2A 10 89     	ld hl,(view_file_pos_cur)
 366+ 884F              view_move_right1
 367+ 884F 7E           	ld a,(hl)
 368+ 8850 FE 0A        	cp 10 ;этот код пропускаем
 369+ 8852 20 07        	jr nz,view_move_right2
 370+ 8854 CD 7D 88     	call view_file_next_pos
 371+ 8857 D8           	ret c
 372+ 8858 C8           	ret z
 373+ 8859 18 F4        	jr view_move_right1
 374+ 885B              view_move_right2
 375+ 885B FE FF        	cp #ff ;этот код пропускаем
 376+ 885D 20 07        	jr nz,view_move_right3
 377+ 885F CD 7D 88     	call view_file_next_pos
 378+ 8862 D8           	ret c
 379+ 8863 C8           	ret z
 380+ 8864 18 E9        	jr view_move_right1
 381+ 8866              view_move_right3
 382+ 8866 7E           	ld a,(hl)
 383+ 8867 FE 0D        	cp 13 ;
 384+ 8869 C8           	ret z
 385+ 886A              view_move_right_cl
 386+ 886A CD 7D 88     	call view_file_next_pos
 387+ 886D D8           	ret c
 388+ 886E C8           	ret z
 389+ 886F 7E           	ld a,(hl)
 390+ 8870 FE 0D        	cp 13
 391+ 8872 C8           	ret z
 392+ 8873 FE 0A        	cp 10 ;этот код пропускаем
 393+ 8875 28 F3        	jr z,view_move_right_cl
 394+ 8877 0B           	dec bc
 395+ 8878 78           	ld a,b
 396+ 8879 B1           	or c
 397+ 887A 20 EE        	jr nz,view_move_right_cl
 398+ 887C              	;call view_file_next_pos ;следующий
 399+ 887C C9           	ret
 400+ 887D
 401+ 887D
 402+ 887D
 403+ 887D              ;получение следующей позиции
 404+ 887D              view_file_next_pos
 405+ 887D 3A 16 89     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 406+ 8880 B7           	or a
 407+ 8881 28 14        	jr z,view_file_next_pos_big
 408+ 8883              	;если текст не большой
 409+ 8883 2A 17 89     	ld hl,(view_file_end) ;конец текста известен
 410+ 8886 ED 5B 10 89  	ld de,(view_file_pos_cur)
 411+ 888A 13           	inc de ;вперёд
 412+ 888B A7           	and a
 413+ 888C ED 52        	sbc hl,de
 414+ 888E 38 15        	jr c,view_file_next_pos_end
 415+ 8890 ED 53 10 89  	ld (view_file_pos_cur),de
 416+ 8894 EB           	ex de,hl ;на выходе адрес в HL
 417+ 8895 B7           	or a
 418+ 8896 C9           	ret
 419+ 8897
 420+ 8897
 421+ 8897
 422+ 8897              view_file_next_pos_big
 423+ 8897              	;если текст большой
 424+ 8897 2A 10 89     	ld hl,(view_file_pos_cur)	;текущая позиция
 425+ 889A 23           	inc hl ;вперёд
 426+ 889B 7C           	ld a,h
 427+ 889C FE C0        	cp #c0 ;если вышли за пределы окна
 428+ 889E 38 05        	jr c,view_file_next_pos_end
 429+ 88A0 22 10 89     	ld (view_file_pos_cur),hl
 430+ 88A3 B7           	or a
 431+ 88A4 C9           	ret
 432+ 88A5
 433+ 88A5              view_file_next_pos_end
 434+ 88A5              	;не смогли шагнуть вперёд
 435+ 88A5              	; ld a,1 ;флаг что внизу
 436+ 88A5              	; ld (view_file_bot_flag),a
 437+ 88A5 37           	scf ;ошибка
 438+ 88A6 C9           	ret
 439+ 88A7
 440+ 88A7
 441+ 88A7
 442+ 88A7
 443+ 88A7
 444+ 88A7
 445+ 88A7              ;получение предыдущей позиции
 446+ 88A7              view_file_prev_pos
 447+ 88A7 3A 16 89     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 448+ 88AA B7           	or a
 449+ 88AB 28 1E        	jr z,view_file_prev_pos_big
 450+ 88AD              	;если текст не большой
 451+ 88AD 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 452+ 88B0 ED 5B 10 89  	ld de,(view_file_pos_cur) ;текущая позиция
 453+ 88B4 1B           	dec de ;назад
 454+ 88B5 A7           	and a
 455+ 88B6 ED 52        	sbc hl,de
 456+ 88B8 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 457+ 88BA 30 1D        	jr nc,view_file_prev_pos_end
 458+ 88BC              	;можно шагнуть назад
 459+ 88BC ED 53 10 89  	ld (view_file_pos_cur),de
 460+ 88C0 EB           	ex de,hl ;на выходе адрес в HL
 461+ 88C1 AF           	xor a
 462+ 88C2 3C           	inc a ;a=1
 463+ 88C3 C9           	ret
 464+ 88C4              view_file_prev_pos_top
 465+ 88C4              	;если в начале
 466+ 88C4 ED 53 10 89  	ld (view_file_pos_cur),de
 467+ 88C8 EB           	ex de,hl ;на выходе адрес в HL
 468+ 88C9 AF           	xor a ;a=0
 469+ 88CA C9           	ret
 470+ 88CB
 471+ 88CB
 472+ 88CB              view_file_prev_pos_big
 473+ 88CB              	;если текст большой
 474+ 88CB 2A 10 89     	ld hl,(view_file_pos_cur)	;текущая позиция
 475+ 88CE 2B           	dec hl ;назад
 476+ 88CF 7C           	ld a,h
 477+ 88D0 FE C0        	cp #c0 ;если вышли за пределы окна
 478+ 88D2 38 05        	jr c,view_file_prev_pos_end
 479+ 88D4 22 10 89     	ld (view_file_pos_cur),hl
 480+ 88D7 B7           	or a
 481+ 88D8 C9           	ret
 482+ 88D9
 483+ 88D9              view_file_prev_pos_end
 484+ 88D9              	;не смогли шагнуть назад
 485+ 88D9 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 486+ 88DC 22 10 89     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 487+ 88DF              	;вернулись в начало
 488+ 88DF AF           	xor a ;a=0
 489+ 88E0 C9           	ret
 490+ 88E1
 491+ 88E1
 492+ 88E1
 493+ 88E1
 494+ 88E1              next_line ;поиск следующей строки
 495+ 88E1 CD 7D 88     	call view_file_next_pos
 496+ 88E4 D8           	ret c
 497+ 88E5 C8           	ret z
 498+ 88E6 7E           	ld a,(hl)
 499+ 88E7 FE 0D        	cp 13
 500+ 88E9 20 F6        	jr nz,next_line
 501+ 88EB CD 7D 88     	call view_file_next_pos ;ещё на символ
 502+ 88EE C9           	ret
 503+ 88EF
 504+ 88EF
 505+ 88EF
 506+ 88EF              prev_line ;поиск предыдущей строки
 507+ 88EF              ;если достигнуто начало файла - вернёт адрес начальный
 508+ 88EF              	;сначала в конец предыдущей
 509+ 88EF CD A7 88     	call view_file_prev_pos
 510+ 88F2 C8           	ret z
 511+ 88F3 D8           	ret c
 512+ 88F4 7E           	ld a,(hl)
 513+ 88F5 FE 0D        	cp 13
 514+ 88F7 20 F6        	jr nz,prev_line
 515+ 88F9              	;теперь в начало предыдущей
 516+ 88F9              prev_line1
 517+ 88F9 CD A7 88     	call view_file_prev_pos
 518+ 88FC C8           	ret z
 519+ 88FD D8           	ret c
 520+ 88FE 7E           	ld a,(hl)
 521+ 88FF FE 0D        	cp 13
 522+ 8901 20 F6        	jr nz,prev_line1
 523+ 8903 CD 7D 88     	call view_file_next_pos ;ещё на символ обратно
 524+ 8906 C9           	ret
 525+ 8907
 526+ 8907
 527+ 8907
 528+ 8907              view_text_bot equ 24 ;последняя строка для печати
 529+ 8907              view_text_top equ 1 ;первая строка
 530+ 8907              view_text_lines equ 25-2 ;видимых строк на экране
 531+ 8907
 532+ 8907              msg_menu_view
 533+ 8907 33 20 45 78  	db "3 Exit",0
 533+ 890B 69 74 00
 534+ 890E
 535+ 890E              ;view_file_position ds 4 ;текущая позиция в файле
 536+ 890E              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 537+ 890E 00 00        view_move_right_val dw 0 ;сдвиг вправо
 538+ 8910 00 00        view_file_pos_cur dw 0;текущая позиция
 539+ 8912 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 540+ 8914 00           view_file_y_cur db 0;текущая строка
 541+ 8915 00           view_file_x_cur db 0;текущий столбец
 542+ 8916 00           view_file_load_all db 0 ;флаг что файл весь загружен
 543+ 8917 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 544+ 8919
 545+ 8919
# file closed: nc_view.asm
1211  8919              	include GPlay/gplay.asm ;плеер
# file opened: GPlay/gplay.asm
   1+ 8919              ;GPlay - приложение для OS GMX
   2+ 8919                 ; device ZXSPECTRUM128
   3+ 8919              	; include "../os_defs.asm"
   4+ 8919              	; org PROG_START
   5+ 8919
   6+ 8919
   7+ 8919              start_gplay
   8+ 8919 11 00 00     	ld de,0
   9+ 891C              	OS_SET_XY
   9+ 891C 0E 01       >    ld c,#01
   9+ 891E E7          >    rst #20
  10+ 891F 21 D3 8A     	ld hl,msg_title ;имя приложения
  11+ 8922              	OS_PRINTZ ;печать
  11+ 8922 0E 09       >    ld c,#09
  11+ 8924 E7          >    rst #20
  12+ 8925
  13+ 8925 3E 0D        	ld a,13 ;оставим место для шкалы прогресса
  14+ 8927              	OS_PRINT_CHARF
  14+ 8927 D7          >	rst #10
  15+ 8928 3E 0D        	ld a,13
  16+ 892A              	OS_PRINT_CHARF
  16+ 892A D7          >	rst #10
  17+ 892B 21 AC 97     	ld hl,file_name_cur
  18+ 892E              	OS_PRINTZ
  18+ 892E 0E 09       >    ld c,#09
  18+ 8930 E7          >    rst #20
  19+ 8931
  20+ 8931 21 9C 8A     	ld hl,txt_load
  21+ 8934              	OS_PRINTZ
  21+ 8934 0E 09       >    ld c,#09
  21+ 8936 E7          >    rst #20
  22+ 8937
  23+ 8937 3E FF        	ld a,255
  24+ 8939 32 BD 99     	ld (file_id_cur_r),a
  25+ 893C
  26+ 893C CD 1F 97     	call load_mus ;инициализация VGM
  27+ 893F DA 95 89     	jp c,exit_gplay
  28+ 8942
  29+ 8942 21 8C 8A     	ld hl,txt_play
  30+ 8945              	OS_PRINTZ
  30+ 8945 0E 09       >    ld c,#09
  30+ 8947 E7          >    rst #20
  31+ 8948
  32+ 8948 21 6F 8A     	ld hl,txt_gplay_menu
  33+ 894B              	OS_PRINTZ
  33+ 894B 0E 09       >    ld c,#09
  33+ 894D E7          >    rst #20
  34+ 894E
  35+ 894E              wait_play
  36+ 894E              	OS_WAIT
  36+ 894E DF          >	rst #18
  37+ 894F
  38+ 894F CD B6 89     	call gplay_progress_print
  39+ 8952
  40+ 8952 11 00 0A     	ld de,#0a00
  41+ 8955              	OS_SET_XY
  41+ 8955 0E 01       >    ld c,#01
  41+ 8957 E7          >    rst #20
  42+ 8958 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
  43+ 895B CD 10 8A     	call toDecimal
  44+ 895E              	OS_PRINTZ
  44+ 895E 0E 09       >    ld c,#09
  44+ 8960 E7          >    rst #20
  45+ 8961
  46+ 8961
  47+ 8961 11 00 0B     	ld de,#0b00
  48+ 8964              	OS_SET_XY
  48+ 8964 0E 01       >    ld c,#01
  48+ 8966 E7          >    rst #20
  49+ 8967 2A 0E 8C     	ld hl,(memorystreampageaddr)
  50+ 896A 01 00 8B     	ld bc,memorystreampages
  51+ 896D A7           	and a
  52+ 896E ED 42        	sbc hl,bc
  53+ 8970 CD 10 8A     	call toDecimal
  54+ 8973              	OS_PRINTZ
  54+ 8973 0E 09       >    ld c,#09
  54+ 8975 E7          >    rst #20
  55+ 8976
  56+ 8976 3A 7A 92     	ld a,(vgm_play_var)
  57+ 8979 B7           	or a
  58+ 897A 20 19        	jr nz,exit_gplay ; конец пенсни
  59+ 897C              	OS_GET_CHAR
  59+ 897C 0E 10       >    ld c,#10
  59+ 897E E7          >    rst #20
  60+ 897F FE 20        	cp " " ;space
  61+ 8981 CA 95 89     	jp z,exit_gplay
  62+ 8984 FE 73        	cp "s" ;stop
  63+ 8986 CA 95 89     	jp z,exit_gplay
  64+ 8989 FE 53        	cp "S" ;stop
  65+ 898B CA 95 89     	jp z,exit_gplay
  66+ 898E FE 18        	cp 24 ;break
  67+ 8990 CA 95 89     	jp z,exit_gplay
  68+ 8993 18 B9        	jr wait_play
  69+ 8995
  70+ 8995
  71+ 8995              exit_gplay ;выход
  72+ 8995 F5           	push af ;сохранить нажатую клавишу
  73+ 8996
  74+ 8996 21 96 8A     	ld hl,txt_exit
  75+ 8999              	OS_PRINTZ
  75+ 8999 0E 09       >    ld c,#09
  75+ 899B E7          >    rst #20
  76+ 899C
  77+ 899C 21 00 00     	ld hl,0 ;отключить обработчик прерываний
  78+ 899F              	OS_SET_INTER
  78+ 899F 0E 14       >    ld c,#14
  78+ 89A1 E7          >    rst #20
  79+ 89A2 CD F2 8A     	call PLR_MUTE ;выключить звук
  80+ 89A5
  81+ 89A5
  82+ 89A5              	;освободить страницы памяти
  83+ 89A5 21 FF 8B     	ld hl,memorystreampages+$FF
  84+ 89A8 6E               ld l,(hl)
  85+ 89A9              free_s98_loop
  86+ 89A9 2D               dec l
  87+ 89AA 7E               ld a,(hl)
  88+ 89AB
  89+ 89AB F5               push af
  90+ 89AC E5               push hl
  91+ 89AD                  ;OS_DELPAGE
  92+ 89AD              	OS_DEL_PAGE
  92+ 89AD 0E 20       >    ld c,#20
  92+ 89AF E7          >    rst #20
  93+ 89B0 E1               pop hl
  94+ 89B1 F1               pop af
  95+ 89B2
  96+ 89B2 20 F5            jr nz,free_s98_loop
  97+ 89B4
  98+ 89B4              	; call delay ;задержка
  99+ 89B4              	; xor a
 100+ 89B4              	; OS_PROC_CLOSE
 101+ 89B4 F1           	pop af ;a - код клавиши
 102+ 89B5 C9           	ret
 103+ 89B6
 104+ 89B6              ; delay ;задержка между запросами
 105+ 89B6              	; ld b,50*1 ;
 106+ 89B6              ; delay1
 107+ 89B6              	; OS_WAIT
 108+ 89B6              	; djnz delay1
 109+ 89B6              	; ret
 110+ 89B6
 111+ 89B6
 112+ 89B6              	;печать шкалы прогресса
 113+ 89B6              gplay_progress_print
 114+ 89B6 CD DF 89     	call gplay_progress_calc
 115+ 89B9 11 00 02     	ld de,#0200 ;прогресс тут
 116+ 89BC              	OS_SET_XY
 116+ 89BC 0E 01       >    ld c,#01
 116+ 89BE E7          >    rst #20
 117+ 89BF              	;печать закрашенных кубиков
 118+ 89BF 3A 0F 8A     	ld a,(gplay_progress_val)
 119+ 89C2 B7           	or a
 120+ 89C3 28 08        	jr z,gplay_progress_print1
 121+ 89C5 47           	ld b,a
 122+ 89C6              gplay_progress_print1_cl
 123+ 89C6 C5           	push bc
 124+ 89C7 3E B1        	ld a,177 ;псевдографика
 125+ 89C9              	OS_PRINT_CHARF
 125+ 89C9 D7          >	rst #10
 126+ 89CA C1           	pop bc
 127+ 89CB 10 F9        	djnz gplay_progress_print1_cl
 128+ 89CD              gplay_progress_print1
 129+ 89CD              	;печать пустых кубиков
 130+ 89CD 3A 0F 8A     	ld a,(gplay_progress_val)
 131+ 89D0 4F           	ld c,a
 132+ 89D1 3E 10        	ld a,gplay_progress_lenght
 133+ 89D3 91           	sub c
 134+ 89D4 28 08        	jr z,gplay_progress_print2
 135+ 89D6 47           	ld b,a
 136+ 89D7              gplay_progress_print1_c2
 137+ 89D7 C5           	push bc
 138+ 89D8 3E B0        	ld a,176 ;псевдографика
 139+ 89DA              	OS_PRINT_CHARF
 139+ 89DA D7          >	rst #10
 140+ 89DB C1           	pop bc
 141+ 89DC 10 F9        	djnz gplay_progress_print1_c2
 142+ 89DE
 143+ 89DE              gplay_progress_print2
 144+ 89DE C9           	ret
 145+ 89DF
 146+ 89DF
 147+ 89DF              gplay_progress_calc
 148+ 89DF 3A FF 8B     	ld a,(memorystreampages+255) ;всего страниц памяти занято
 149+ 89E2 67           	ld h,a
 150+ 89E3 2E 00        	ld l,0 ;всего страниц *256
 151+ 89E5
 152+ 89E5              	;разделить
 153+ 89E5 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 154+ 89E7 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 155+ 89E9 CB 3C        	srl h ; /4
 156+ 89EB CB 1D        	rr l ;
 157+ 89ED CB 3C        	srl h ; /8
 158+ 89EF CB 1D        	rr l ;
 159+ 89F1 CB 3C        	srl h ; /16
 160+ 89F3 CB 1D        	rr l ;
 161+ 89F5              	; srl h ; /32
 162+ 89F5              	; rr l ;
 163+ 89F5              	;узнали сколько страниц одно деление
 164+ 89F5 EB           	ex de,hl
 165+ 89F6
 166+ 89F6
 167+ 89F6 2A 0E 8C     	ld hl,(memorystreampageaddr)
 168+ 89F9 01 00 8B     	ld bc,memorystreampages
 169+ 89FC A7           	and a
 170+ 89FD ED 42        	sbc hl,bc ;какая по счёту страница сейчас
 171+ 89FF
 172+ 89FF 65           	ld h,l ;*256
 173+ 8A00 2E 00        	ld l,0
 174+ 8A02
 175+ 8A02              	;разделить на величину одного деления
 176+ 8A02 3E FF        	ld a,-1
 177+ 8A04              divide16
 178+ 8A04 3C           	inc a
 179+ 8A05 A7           	and a
 180+ 8A06 ED 52        	sbc hl,de
 181+ 8A08 30 FA        	jr nc,divide16
 182+ 8A0A 19           	add hl,de
 183+ 8A0B 32 0F 8A     	ld (gplay_progress_val),a
 184+ 8A0E C9           	ret
 185+ 8A0F
 186+ 8A0F              gplay_progress_lenght equ 16 ;длина шкалы
 187+ 8A0F 00           gplay_progress_val db 0;
 188+ 8A10
 189+ 8A10
 190+ 8A10
 191+ 8A10
 192+ 8A10              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 193+ 8A10              				;на входе в HL число
 194+ 8A10 11 10 27     			ld de,10000 ;десятки тысяч
 195+ 8A13 3E FF        			ld a,255
 196+ 8A15              toDecimal10k
 197+ 8A15 A7           			and a
 198+ 8A16 ED 52        			sbc hl,de
 199+ 8A18 3C           			inc a
 200+ 8A19 30 FA        			jr nc,toDecimal10k
 201+ 8A1B 19           			add hl,de
 202+ 8A1C C6 30        			add a,48
 203+ 8A1E 32 69 8A     			ld (decimalS),a
 204+ 8A21 11 E8 03     			ld de,1000 ;тысячи
 205+ 8A24 3E FF        			ld a,255
 206+ 8A26              toDecimal1k
 207+ 8A26 A7           			and a
 208+ 8A27 ED 52        			sbc hl,de
 209+ 8A29 3C           			inc a
 210+ 8A2A 30 FA        			jr nc,toDecimal1k
 211+ 8A2C 19           			add hl,de
 212+ 8A2D C6 30        			add a,48
 213+ 8A2F 32 6A 8A     			ld (decimalS+1),a
 214+ 8A32 11 64 00     			ld de,100 ;сотни
 215+ 8A35 3E FF        			ld a,255
 216+ 8A37              toDecimal01k
 217+ 8A37 A7           			and a
 218+ 8A38 ED 52        			sbc hl,de
 219+ 8A3A 3C           			inc a
 220+ 8A3B 30 FA        			jr nc,toDecimal01k
 221+ 8A3D 19           			add hl,de
 222+ 8A3E C6 30        			add a,48
 223+ 8A40 32 6B 8A     			ld (decimalS+2),a
 224+ 8A43 11 0A 00     			ld de,10 ;десятки
 225+ 8A46 3E FF        			ld a,255
 226+ 8A48              toDecimal001k
 227+ 8A48 A7           			and a
 228+ 8A49 ED 52        			sbc hl,de
 229+ 8A4B 3C           			inc a
 230+ 8A4C 30 FA        			jr nc,toDecimal001k
 231+ 8A4E 19           			add hl,de
 232+ 8A4F C6 30        			add a,48
 233+ 8A51 32 6C 8A     			ld (decimalS+3),a
 234+ 8A54 11 01 00     			ld de,1 ;единицы
 235+ 8A57 3E FF        			ld a,255
 236+ 8A59              toDecimal0001k
 237+ 8A59 A7           			and a
 238+ 8A5A ED 52        			sbc hl,de
 239+ 8A5C 3C           			inc a
 240+ 8A5D 30 FA        			jr nc,toDecimal0001k
 241+ 8A5F 19           			add hl,de
 242+ 8A60 C6 30        			add a,48
 243+ 8A62 32 6D 8A     			ld (decimalS+4),a
 244+ 8A65 21 69 8A     			ld hl,decimalS
 245+ 8A68 C9           			ret
 246+ 8A69
 247+ 8A69 00 00 00...  decimalS	ds 6 ;десятичные цифры
 248+ 8A6F
 249+ 8A6F
 250+ 8A6F
 251+ 8A6F
 252+ 8A6F              ;file_id_cur db 0; временно
 253+ 8A6F
 254+ 8A6F 0D 0D 42 72  txt_gplay_menu db 13,13,"Break, S - stop ",13,"Sp - Next",0
 254+ 8A73 65 61 6B 2C
 254+ 8A77 20 53 20 2D
 254+ 8A7B 20 73 74 6F
 254+ 8A7F 70 20 0D 53
 254+ 8A83 70 20 2D 20
 254+ 8A87 4E 65 78 74
 254+ 8A8B 00
 255+ 8A8C 0D 50 6C 61  txt_play db 13,"Play... ",0
 255+ 8A90 79 2E 2E 2E
 255+ 8A94 20 00
 256+ 8A96 0D 53 74 6F  txt_exit db 13,"Stop",0
 256+ 8A9A 70 00
 257+ 8A9C 0D 4C 6F 61  txt_load db 13,"Load...",0
 257+ 8AA0 64 2E 2E 2E
 257+ 8AA4 00
 258+ 8AA5 0D 4D 65 6D  txt_memoryerror:    db 13,"Memory allocation error!",0
 258+ 8AA9 6F 72 79 20
 258+ 8AAD 61 6C 6C 6F
 258+ 8AB1 63 61 74 69
 258+ 8AB5 6F 6E 20 65
 258+ 8AB9 72 72 6F 72
 258+ 8ABD 21 00
 259+ 8ABF 0D 43 61 6E  txt_fopenerror:     db 13,"Cannot open file: ",0
 259+ 8AC3 6E 6F 74 20
 259+ 8AC7 6F 70 65 6E
 259+ 8ACB 20 66 69 6C
 259+ 8ACF 65 3A 20 00
 260+ 8AD3
 261+ 8AD3              msg_title
 262+ 8AD3 47 50 6C 61  	db "GPlay ver 2025.07.31",10,13,0
 262+ 8AD7 79 20 76 65
 262+ 8ADB 72 20 32 30
 262+ 8ADF 32 35 2E 30
 262+ 8AE3 37 2E 33 31
 262+ 8AE7 0A 0D 00
 263+ 8AEA
 264+ 8AEA              vgm_plr
 265+ 8AEA
 266+ 8AEA              ;module equ 0xc000
 267+ 8AEA              ;player_load = 0x8000 ;0x4000
 268+ 8AEA
 269+ 8AEA              ;ovl_start = 0x8000 ;0x4000
 270+ 8AEA
 271+ 8AEA              PLR_INIT  = vgm_plr ;0x4000
 272+ 8AEA              PLR_PLAY  = vgm_plr+5 ;0x4005
 273+ 8AEA              PLR_MUTE  = vgm_plr+8 ;0x4008
 274+ 8AEA
 275+ 8AEA              	include vgm_plr.asm
# file opened: GPlay/vgm_plr.asm
   1++8AEA                      ;DEVICE ZXSPECTRUM48
   2++8AEA                      ;include "../../../_sdk/sys_h.asm"
   3++8AEA                      ;       ORG PROGSTART ;0x4000
   4++8AEA
   5++8AEA
   6++8AEA
   7++8AEA              ;memorystreamcurrentpage = 0x5100
   8++8AEA              ;current_ram_page = 0x5100
   9++8AEA
  10++8AEA
  11++8AEA              AREA_C000_FFFF   equ 1
  12++8AEA
  13++8AEA
  14++8AEA
  15++8AEA              module = $C000
  16++8AEA
  17++8AEA
  18++8AEA
  19++8AEA              begin
  20++8AEA              START
  21++8AEA 21 00 C0             	LD HL,module;MDLADDR ;DE - address of 2nd module for TS
  22++8AED 18 06                	JR INIT
  23++8AEF C3 7A 92             	JP PLAY
  24++8AF2 C3 6C 92             	JP MUTE
  25++8AF5              INIT:
  26++8AF5 C3 CF 91             jp init_
  27++8AF8
  28++8AF8              DEVICE_AY_BIT         = 0
  29++8AF8              DEVICE_TURBOSOUND_BIT = 1
  30++8AF8              DEVICE_TFM_BIT        = 2
  31++8AF8              DEVICE_MOONSOUND_BIT  = 3
  32++8AF8              DEVICE_GS_BIT         = 4
  33++8AF8              DEVICE_NEOGS_BIT      = 5
  34++8AF8              DEVICE_MIDI_UART_BIT  = 6
  35++8AF8
  36++8AF8              DEVICE_AY_MASK         = 1<<DEVICE_AY_BIT
  37++8AF8              DEVICE_TURBOSOUND_MASK = 1<<DEVICE_TURBOSOUND_BIT
  38++8AF8              DEVICE_TFM_MASK        = 1<<DEVICE_TFM_BIT
  39++8AF8              DEVICE_MOONSOUND_MASK  = 1<<DEVICE_MOONSOUND_BIT
  40++8AF8              DEVICE_GS_MASK         = 1<<DEVICE_GS_BIT
  41++8AF8              DEVICE_NEOGS_MASK      = 1<<DEVICE_NEOGS_BIT
  42++8AF8              DEVICE_MIDI_UART_MASK  = 1<<DEVICE_MIDI_UART_BIT
  43++8AF8
  44++8AF8
  45++8AF8
  46++8AF8
  47++8AF8
  48++8AF8              HEADER_DATA_OFFSET = module+0x34 ;0xC034
  49++8AF8              HEADER_LOOP_SAMPLES_COUNT = module+0x20 ;0xC020
  50++8AF8              HEADER_GD3_OFFSET = module+0x14 ;0xC014
  51++8AF8              HEADER_SAMPLES_COUNT = module+0x18 ;0xC018
  52++8AF8              HEADER_LOOP_OFFSET = module+0x1c ;0xC01c
  53++8AF8
  54++8AF8
  55++8AF8              HEADER_SIZE_MAX = 256
  56++8AF8              TITLELENGTH = 64
  57++8AF8              MEMORYSTREAMMAXPAGES = 210
  58++8AF8              MEMORYSTREAMERRORMASK = 255 ; TODO: do we need to enforce loading the entire file?
  59++8AF8              ENABLE_FM = 1
  60++8AF8
  61++8AF8
  62++8AF8
  63++8AF8
  64++8AF8
  65++8AF8
  66++8AF8
  67++8AF8 00 00 00...          align 256   ;0x8100 ;0x4100
  68++8B00                      display "s98_file00_pages_list ",$
  69++8B00
  70++8B00 00 00 00...  memorystreampages: ds 256,0
  71++8C00              memorystreampagecount = memorystreampages + 255
  72++8C00
  73++8C00              	include "common/memorystream.asm"
# file opened: GPlay/common/memorystream.asm
   1++8C00              memorystreamstart
   2++8C00                      IF AREA_C000_FFFF=1
   3++8C00 21 00 00     	ld hl,0x0000
   4++8C03                      ELSE
   5++8C03 ~                    ld hl,0xffff
   6++8C03                      ENDIF
   7++8C03 22 72 8C     	ld (memorystreamcurrentaddr),hl
   8++8C06 21 00 8B     	ld hl,memorystreampages
   9++8C09 22 0E 8C     	ld (memorystreampageaddr),hl
  10++8C0C C9           	ret
  11++8C0D
  12++8C0D              memorystreamnextpage
  13++8C0D              memorystreampageaddr=$+1
  14++8C0D 21 00 00     	ld hl,0
  15++8C10 F5           	push af
  16++8C11 7E           	ld a,(hl)
  17++8C12 23           	inc hl
  18++8C13 32 7C 92     	ld (memorystreamcurrentpage),a
  19++8C16 22 0E 8C     	ld (memorystreampageaddr),hl
  20++8C19 C5           	push bc
  21++8C1A                      IF AREA_C000_FFFF=1
  22++8C1A              	;SETPGC000
  23++8C1A              	OS_SET_PAGE_SLOT3
  23++8C1A 0E 1C       >    ld c,#1c
  23++8C1C E7          >    rst #20
  24++8C1D C1           	pop bc
  25++8C1E F1           	pop af
  26++8C1F 21 00 C0     	ld hl,0xC000
  27++8C22                      ELSE
  28++8C22 ~                    SETPG8000
  29++8C22 ~                    pop bc
  30++8C22 ~                    pop af
  31++8C22 ~                    ld hl,0x8000
  32++8C22                      ENDIF
  33++8C22 C9           	ret
  34++8C23
  35++8C23              memorystreamskip
  36++8C23              ;b = byte count
  37++8C23 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
  38++8C26              .loop
  39++8C26 CB 74        	bit 6,h
  40++8C28                      IF AREA_C000_FFFF=1
  41++8C28 CC 0D 8C     	call z,memorystreamnextpage
  42++8C2B                      ELSE
  43++8C2B ~             	call nz,memorystreamnextpage
  44++8C2B                      ENDIF
  45++8C2B 23           	inc hl
  46++8C2C 10 F8        	djnz .loop
  47++8C2E 22 72 8C     	ld (memorystreamcurrentaddr),hl
  48++8C31 C9           	ret
  49++8C32
  50++8C32              	macro memory_stream_write_byte src
  51++8C32 ~            	bit 6,h
  52++8C32 ~                    IF AREA_C000_FFFF=1
  53++8C32 ~            	call z,memorystreamnextpage
  54++8C32 ~                    ELSE
  55++8C32 ~             	call nz,memorystreamnextpage
  56++8C32 ~                    ENDIF
  57++8C32 ~            	ld (hl),src
  58++8C32 ~            	inc hl
  59++8C32              	endm
  60++8C32
  61++8C32              	macro memory_stream_read_byte dest
  62++8C32 ~            	bit 6,h
  63++8C32 ~                    IF AREA_C000_FFFF=1
  64++8C32 ~            	call z,memorystreamnextpage
  65++8C32 ~                    ELSE
  66++8C32 ~             	call nz,memorystreamnextpage
  67++8C32 ~                    ENDIF
  68++8C32 ~            	ld dest,(hl)
  69++8C32 ~            	inc hl
  70++8C32              	endm
  71++8C32
  72++8C32              	macro memory_stream_read_1 dst
  73++8C32 ~            	ld hl,(memorystreamcurrentaddr)
  74++8C32 ~            	memory_stream_read_byte dst
  75++8C32 ~            	ld (memorystreamcurrentaddr),hl
  76++8C32              	endm
  77++8C32
  78++8C32              	macro memory_stream_read_2 dst1,dst2
  79++8C32 ~            	ld hl,(memorystreamcurrentaddr)
  80++8C32 ~            	memory_stream_read_byte dst1
  81++8C32 ~            	memory_stream_read_byte dst2
  82++8C32 ~            	ld (memorystreamcurrentaddr),hl
  83++8C32              	endm
  84++8C32
  85++8C32              	macro memory_stream_read_3 dst1,dst2,dst3
  86++8C32 ~            	ld hl,(memorystreamcurrentaddr)
  87++8C32 ~            	memory_stream_read_byte dst1
  88++8C32 ~            	memory_stream_read_byte dst2
  89++8C32 ~            	memory_stream_read_byte dst3
  90++8C32 ~            	ld (memorystreamcurrentaddr),hl
  91++8C32              	endm
  92++8C32
  93++8C32              memorystreamread1
  94++8C32              ;out: a = byte
  95++8C32              	memory_stream_read_1 a
  95++8C32 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
  95++8C35             >	memory_stream_read_byte a
  95++8C35 CB 74       >	bit 6,h
  95++8C37             >        IF AREA_C000_FFFF=1
  95++8C37 CC 0D 8C    >	call z,memorystreamnextpage
  95++8C3A             >        ELSE
  95++8C3A ~           > 	call nz,memorystreamnextpage
  95++8C3A             >        ENDIF
  95++8C3A 7E          >	ld a,(hl)
  95++8C3B 23          >	inc hl
  95++8C3C 22 72 8C    >	ld (memorystreamcurrentaddr),hl
  96++8C3F C9           	ret
  97++8C40
  98++8C40              memorystreamread2
  99++8C40              ;out: de = word
 100++8C40              	memory_stream_read_2 e,d
 100++8C40 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 100++8C43             >	memory_stream_read_byte e
 100++8C43 CB 74       >	bit 6,h
 100++8C45             >        IF AREA_C000_FFFF=1
 100++8C45 CC 0D 8C    >	call z,memorystreamnextpage
 100++8C48             >        ELSE
 100++8C48 ~           > 	call nz,memorystreamnextpage
 100++8C48             >        ENDIF
 100++8C48 5E          >	ld e,(hl)
 100++8C49 23          >	inc hl
 100++8C4A             >	memory_stream_read_byte d
 100++8C4A CB 74       >	bit 6,h
 100++8C4C             >        IF AREA_C000_FFFF=1
 100++8C4C CC 0D 8C    >	call z,memorystreamnextpage
 100++8C4F             >        ELSE
 100++8C4F ~           > 	call nz,memorystreamnextpage
 100++8C4F             >        ENDIF
 100++8C4F 56          >	ld d,(hl)
 100++8C50 23          >	inc hl
 100++8C51 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 101++8C54 C9           	ret
 102++8C55
 103++8C55              memorystreamread3
 104++8C55              ;out: c = byte0, e = byte1, d = byte2
 105++8C55              	memory_stream_read_3 c,e,d
 105++8C55 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 105++8C58             >	memory_stream_read_byte c
 105++8C58 CB 74       >	bit 6,h
 105++8C5A             >        IF AREA_C000_FFFF=1
 105++8C5A CC 0D 8C    >	call z,memorystreamnextpage
 105++8C5D             >        ELSE
 105++8C5D ~           > 	call nz,memorystreamnextpage
 105++8C5D             >        ENDIF
 105++8C5D 4E          >	ld c,(hl)
 105++8C5E 23          >	inc hl
 105++8C5F             >	memory_stream_read_byte e
 105++8C5F CB 74       >	bit 6,h
 105++8C61             >        IF AREA_C000_FFFF=1
 105++8C61 CC 0D 8C    >	call z,memorystreamnextpage
 105++8C64             >        ELSE
 105++8C64 ~           > 	call nz,memorystreamnextpage
 105++8C64             >        ENDIF
 105++8C64 5E          >	ld e,(hl)
 105++8C65 23          >	inc hl
 105++8C66             >	memory_stream_read_byte d
 105++8C66 CB 74       >	bit 6,h
 105++8C68             >        IF AREA_C000_FFFF=1
 105++8C68 CC 0D 8C    >	call z,memorystreamnextpage
 105++8C6B             >        ELSE
 105++8C6B ~           > 	call nz,memorystreamnextpage
 105++8C6B             >        ENDIF
 105++8C6B 56          >	ld d,(hl)
 105++8C6C 23          >	inc hl
 105++8C6D 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 106++8C70 C9           	ret
 107++8C71
 108++8C71              memorystreamread4
 109++8C71              ;out: adbc = dword
 110++8C71              memorystreamcurrentaddr=$+1
 111++8C71 21 00 00     	ld hl,0
 112++8C74              	memory_stream_read_byte c
 112++8C74 CB 74       >	bit 6,h
 112++8C76             >        IF AREA_C000_FFFF=1
 112++8C76 CC 0D 8C    >	call z,memorystreamnextpage
 112++8C79             >        ELSE
 112++8C79 ~           > 	call nz,memorystreamnextpage
 112++8C79             >        ENDIF
 112++8C79 4E          >	ld c,(hl)
 112++8C7A 23          >	inc hl
 113++8C7B              	memory_stream_read_byte b
 113++8C7B CB 74       >	bit 6,h
 113++8C7D             >        IF AREA_C000_FFFF=1
 113++8C7D CC 0D 8C    >	call z,memorystreamnextpage
 113++8C80             >        ELSE
 113++8C80 ~           > 	call nz,memorystreamnextpage
 113++8C80             >        ENDIF
 113++8C80 46          >	ld b,(hl)
 113++8C81 23          >	inc hl
 114++8C82              	memory_stream_read_byte d
 114++8C82 CB 74       >	bit 6,h
 114++8C84             >        IF AREA_C000_FFFF=1
 114++8C84 CC 0D 8C    >	call z,memorystreamnextpage
 114++8C87             >        ELSE
 114++8C87 ~           > 	call nz,memorystreamnextpage
 114++8C87             >        ENDIF
 114++8C87 56          >	ld d,(hl)
 114++8C88 23          >	inc hl
 115++8C89              	memory_stream_read_byte a
 115++8C89 CB 74       >	bit 6,h
 115++8C8B             >        IF AREA_C000_FFFF=1
 115++8C8B CC 0D 8C    >	call z,memorystreamnextpage
 115++8C8E             >        ELSE
 115++8C8E ~           > 	call nz,memorystreamnextpage
 115++8C8E             >        ENDIF
 115++8C8E 7E          >	ld a,(hl)
 115++8C8F 23          >	inc hl
 116++8C90 22 72 8C     	ld (memorystreamcurrentaddr),hl
 117++8C93 C9           	ret
 118++8C94
 119++8C94              memorystreamread
 120++8C94              ;bc = number of bytes
 121++8C94              ;de = dest addr
 122++8C94 79           	ld a,c
 123++8C95 0B           	dec bc
 124++8C96 04           	inc b
 125++8C97 48           	ld c,b
 126++8C98 47           	ld b,a
 127++8C99 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 128++8C9C              .readloop
 129++8C9C              	memory_stream_read_byte a
 129++8C9C CB 74       >	bit 6,h
 129++8C9E             >        IF AREA_C000_FFFF=1
 129++8C9E CC 0D 8C    >	call z,memorystreamnextpage
 129++8CA1             >        ELSE
 129++8CA1 ~           > 	call nz,memorystreamnextpage
 129++8CA1             >        ENDIF
 129++8CA1 7E          >	ld a,(hl)
 129++8CA2 23          >	inc hl
 130++8CA3 12           	ld (de),a
 131++8CA4 13           	inc de
 132++8CA5 10 F5        	djnz .readloop
 133++8CA7 0D           	dec c
 134++8CA8 20 F2        	jr nz,.readloop
 135++8CAA 22 72 8C     	ld (memorystreamcurrentaddr),hl
 136++8CAD C9           	ret
 137++8CAE
 138++8CAE              memorystreamwrite
 139++8CAE              ;bc = number of bytes
 140++8CAE              ;de = src addr
 141++8CAE 79           	ld a,c
 142++8CAF 0B           	dec bc
 143++8CB0 04           	inc b
 144++8CB1 48           	ld c,b
 145++8CB2 47           	ld b,a
 146++8CB3 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 147++8CB6              .writeloop
 148++8CB6 1A           	ld a,(de)
 149++8CB7              	memory_stream_write_byte a
 149++8CB7 CB 74       >	bit 6,h
 149++8CB9             >        IF AREA_C000_FFFF=1
 149++8CB9 CC 0D 8C    >	call z,memorystreamnextpage
 149++8CBC             >        ELSE
 149++8CBC ~           > 	call nz,memorystreamnextpage
 149++8CBC             >        ENDIF
 149++8CBC 77          >	ld (hl),a
 149++8CBD 23          >	inc hl
 150++8CBE 13           	inc de
 151++8CBF 10 F5        	djnz .writeloop
 152++8CC1 0D           	dec c
 153++8CC2 20 F2        	jr nz,.writeloop
 154++8CC4 22 72 8C     	ld (memorystreamcurrentaddr),hl
 155++8CC7 C9           	ret
 156++8CC8
 157++8CC8              memorystreamseek
 158++8CC8              ;dehl = absolute position
 159++8CC8              ;out: hl = read address
 160++8CC8 7B           	ld a,e
 161++8CC9 44           	ld b,h
 162++8CCA CB 20        	sla b
 163++8CCC 17           	rla
 164++8CCD CB 20        	sla b
 165++8CCF 17           	rla
 166++8CD0 C6 00        	add a,memorystreampages%256
 167++8CD2 5F           	ld e,a
 168++8CD3 CE 8B        	adc a,memorystreampages/256
 169++8CD5 93           	sub e
 170++8CD6 57           	ld d,a
 171++8CD7 1A           	ld a,(de)
 172++8CD8 32 7C 92     	ld (memorystreamcurrentpage),a
 173++8CDB 13           	inc de
 174++8CDC ED 53 0E 8C  	ld (memorystreampageaddr),de
 175++8CE0                      IF AREA_C000_FFFF=1
 176++8CE0              	;SETPGC000
 177++8CE0 E5           	push hl ;*
 178++8CE1              	OS_SET_PAGE_SLOT3
 178++8CE1 0E 1C       >    ld c,#1c
 178++8CE3 E7          >    rst #20
 179++8CE4 E1           	pop hl ;*
 180++8CE5 CB F4                set 6,h
 181++8CE7                      ELSE
 182++8CE7 ~            	SETPG8000
 183++8CE7 ~            	res 6,h
 184++8CE7                      ENDIF
 185++8CE7 CB FC        	set 7,h
 186++8CE9 22 72 8C     	ld (memorystreamcurrentaddr),hl
 187++8CEC C9           	ret
 188++8CED
 189++8CED              memorystreamgetpos
 190++8CED              ;out: dehl = absolute position
 191++8CED 2A 0E 8C     	ld hl,(memorystreampageaddr)
 192++8CF0 11 FF 74     	ld de,-memorystreampages-1
 193++8CF3 19           	add hl,de
 194++8CF4 EB           	ex de,hl
 195++8CF5 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 196++8CF8
 197++8CF8                      IF AREA_C000_FFFF=1
 198++8CF8 CB 7C                bit 7,h
 199++8CFA CB BC                res 7,h
 200++8CFC CB B4                res 6,h
 201++8CFE 20 04        	jr nz,$+6
 202++8D00                      ELSE
 203++8D00 ~            	res 7,h
 204++8D00 ~            	bit 6,h
 205++8D00 ~            ;	jr z,$+6
 206++8D00                      ENDIF
 207++8D00 20 04        	jr nz,$+6
 208++8D02 13           	inc de
 209++8D03 21 00 00     	ld hl,0
 210++8D06 AF           	xor a
 211++8D07 CB 1B        	rr e
 212++8D09 1F           	rra
 213++8D0A CB 1B        	rr e
 214++8D0C 1F           	rra
 215++8D0D B4           	or h
 216++8D0E 67           	ld h,a
 217++8D0F C9           	ret
 218++8D10
 219++8D10              memorystreamsize
 220++8D10 00 00 00 00  	ds 4
 221++8D14
# file closed: GPlay/common/memorystream.asm
  74++8D14              	include "common/opl4.asm"
# file opened: GPlay/common/opl4.asm
   1++8D14              	include "moonsound.asm"
# file opened: GPlay/common/moonsound.asm
   1++8D14              MOON_BASE_HI = 0x00 ;старший байт
   2++8D14              MOON_BASE = 0x24 ;0xc4
   3++8D14              MOON_REG1 = MOON_BASE
   4++8D14              MOON_DAT1 = MOON_BASE+1  ;c5
   5++8D14              MOON_REG2 = MOON_BASE+2  ;c6
   6++8D14              MOON_DAT2 = MOON_BASE+3  ;c7
   7++8D14              MOON_STAT = MOON_BASE
   8++8D14              MOON_WREG = 0xc2
   9++8D14              MOON_WDAT = MOON_WREG+1
  10++8D14
  11++8D14              ;TODO: is this good enough for ATM2?
  12++8D14              	macro opl4_wait
  13++8D14 ~            	ld a,MOON_BASE_HI
  14++8D14 ~            	in a,(MOON_STAT)
  15++8D14 ~            	rrca
  16++8D14 ~            	jr c,$-3
  17++8D14              	endm
  18++8D14
  19++8D14              ;makes ZXM-Moonsound firmware 1.01 switch PCM ports from default 7E and 7F to C2 and C3
  20++8D14              	macro switch_to_pcm_ports_c2_c3
  21++8D14 ~            	ld a,MOON_BASE_HI
  22++8D14 ~            	in a,(MOON_REG2)
  23++8D14              	endm
  24++8D14
  25++8D14
  26++8D14
  27++8D14              NR_OF_MIDI_CHANNELS = 16
  28++8D14              NR_OF_WAVE_CHANNELS = 24
  29++8D14
  30++8D14
  31++8D14
  32++8D14              MOONSOUNDROMSIZE = 0x200000
  33++8D14              MOONWAVEHEADERSIZE = 12
  34++8D14              MOONRAMWAVETABLESIZE = 128
  35++8D14              OPL4MAXWAVECHANNELS = NR_OF_WAVE_CHANNELS
  36++8D14
  37++8D14              OPL4_TIMER1_COUNT   = 0x02
  38++8D14              OPL4_TIMER2_COUNT   = 0x03
  39++8D14              OPL4_TIMER_CONTROL  = 0x04
  40++8D14
  41++8D14
  42++8D14
  43++8D14
  44++8D14              OPL4_REG_TEST0               = 0x00
  45++8D14              OPL4_REG_TEST1               = 0x01
  46++8D14
  47++8D14              OPL4_REG_MEMORY_CONFIGURATION = 0x02
  48++8D14              OPL4_MODE_BIT                 = 0x01
  49++8D14              OPL4_MTYPE_BIT                = 0x02
  50++8D14              OPL4_TONE_HEADER_MASK         = 0x1C
  51++8D14              OPL4_DEVICE_ID_MASK           = 0xE0
  52++8D14
  53++8D14              OPL4_REG_MEMORY_ADDRESS_HIGH  = 0x03
  54++8D14              OPL4_REG_MEMORY_ADDRESS_MID   = 0x04
  55++8D14              OPL4_REG_MEMORY_ADDRESS_LOW   = 0x05
  56++8D14              OPL4_REG_MEMORY_DATA          = 0x06
  57++8D14
  58++8D14 ~            /*
  59++8D14 ~             * Offsets to the register banks for voices. To get the
  60++8D14 ~             * register number just add the voice number to the bank offset.
  61++8D14 ~             *
  62++8D14 ~             * Wave Table Number low bits (0x08 to 0x1F)
  63++8D14 ~             */
  64++8D14              OPL4_REG_TONE_NUMBER  = 0x08
  65++8D14
  66++8D14 ~            /* Wave Table Number high bit, F-Number low bits (0x20 to 0x37) */
  67++8D14              OPL4_REG_F_NUMBER      = 0x20
  68++8D14              OPL4_TONE_NUMBER_BIT8  = 0x01
  69++8D14              OPL4_F_NUMBER_LOW_MASK = 0xFE
  70++8D14
  71++8D14 ~            /* F-Number high bits, Octave, Pseudo-Reverb (0x38 to 0x4F) */
  72++8D14              OPL4_REG_OCTAVE         = 0x38
  73++8D14              OPL4_F_NUMBER_HIGH_MASK = 0x07
  74++8D14              OPL4_BLOCK_MASK         = 0xF0
  75++8D14              OPL4_PSEUDO_REVERB_BIT  = 0x08
  76++8D14
  77++8D14 ~            /* Total Level, Level Direct (0x50 to 0x67) */
  78++8D14              OPL4_REG_LEVEL        = 0x50
  79++8D14              OPL4_TOTAL_LEVEL_MASK = 0xFE
  80++8D14              OPL4_LEVEL_DIRECT_BIT = 0x01
  81++8D14
  82++8D14 ~            /* Key On, Damp, LFO RST, CH, Panpot (0x68 to 0x7F) */
  83++8D14              OPL4_REG_MISC           = 0x68
  84++8D14              OPL4_KEY_ON_BIT         = 0x80
  85++8D14              OPL4_DAMP_BIT           = 0x40
  86++8D14              OPL4_LFO_RESET_BIT      = 0x20
  87++8D14              OPL4_OUTPUT_CHANNEL_BIT = 0x10
  88++8D14              OPL4_PAN_POT_MASK       = 0x0F
  89++8D14
  90++8D14 ~            /* LFO, VIB (0x80 to 0x97) */
  91++8D14              OPL4_REG_LFO_VIBRATO    = 0x80
  92++8D14              OPL4_LFO_FREQUENCY_MASK = 0x38
  93++8D14              OPL4_VIBRATO_DEPTH_MASK = 0x07
  94++8D14              OPL4_CHORUS_SEND_MASK   = 0xC0
  95++8D14
  96++8D14 ~            /* Attack / Decay 1 rate (0x98 to 0xAF) */
  97++8D14              OPL4_REG_ATTACK_DECAY1  = 0x98
  98++8D14              OPL4_ATTACK_RATE_MASK   = 0xF0
  99++8D14              OPL4_DECAY1_RATE_MASK   = 0x0F
 100++8D14
 101++8D14 ~            /* Decay level / 2 rate (0xB0 to 0xC7) */
 102++8D14              OPL4_REG_LEVEL_DECAY2  = 0xB0
 103++8D14              OPL4_DECAY_LEVEL_MASK  = 0xF0
 104++8D14              OPL4_DECAY2_RATE_MASK  = 0x0F
 105++8D14
 106++8D14 ~            /* Release rate / Rate correction (0xC8 to 0xDF) */
 107++8D14              OPL4_REG_RELEASE_CORRECTION  = 0xC8
 108++8D14              OPL4_RELEASE_RATE_MASK       = 0x0F
 109++8D14              OPL4_RATE_INTERPOLATION_MASK = 0xF0
 110++8D14
 111++8D14 ~            /* AM (0xE0 to 0xF7) */
 112++8D14              OPL4_REG_TREMOLO        = 0xE0
 113++8D14              OPL4_TREMOLO_DEPTH_MASK = 0x07
 114++8D14              OPL4_REVERB_SEND_MASK   = 0xE0
 115++8D14
 116++8D14 ~            /* Mixer */
 117++8D14              OPL4_REG_MIX_CONTROL_FM  = 0xF8
 118++8D14              OPL4_REG_MIX_CONTROL_PCM = 0xF9
 119++8D14              OPL4_MIX_LEFT_MASK       = 0x07
 120++8D14              OPL4_MIX_RIGHT_MASK      = 0x38
 121++8D14
 122++8D14              OPL4_REG_ATC             = 0xFA
 123++8D14              OPL4_ATC_BIT             = 0x01
 124++8D14
 125++8D14 ~            /* Bits in the OPL4 Status register */
 126++8D14              OPL4_STATUS_BUSY = 0x01
 127++8D14              OPL4_STATUS_LOAD = 0x02
 128++8D14
# file closed: GPlay/common/moonsound.asm
   2++8D14
   3++8D14              opl4writefm1
   4++8D14              ;e = register
   5++8D14              ;d = value
   6++8D14              	opl4_wait
   6++8D14 3E 00       >	ld a,MOON_BASE_HI
   6++8D16 DB 24       >	in a,(MOON_STAT)
   6++8D18 0F          >	rrca
   6++8D19 38 FB       >	jr c,$-3
   7++8D1B 7B           	ld a,e
   8++8D1C C5           	push bc
   9++8D1D 06 00        	ld b,MOON_BASE_HI
  10++8D1F 0E 24        	ld c,MOON_REG1
  11++8D21 ED 79        	out (c),a
  12++8D23              	opl4_wait
  12++8D23 3E 00       >	ld a,MOON_BASE_HI
  12++8D25 DB 24       >	in a,(MOON_STAT)
  12++8D27 0F          >	rrca
  12++8D28 38 FB       >	jr c,$-3
  13++8D2A 7A           	ld a,d
  14++8D2B 06 00        	ld b,MOON_BASE_HI
  15++8D2D 0E 25        	ld c,MOON_DAT1
  16++8D2F ED 79        	out (c),a
  17++8D31 C1           	pop bc
  18++8D32 C9           	ret
  19++8D33
  20++8D33              opl4writefm2
  21++8D33              ;e = register
  22++8D33              ;d = value
  23++8D33              	opl4_wait
  23++8D33 3E 00       >	ld a,MOON_BASE_HI
  23++8D35 DB 24       >	in a,(MOON_STAT)
  23++8D37 0F          >	rrca
  23++8D38 38 FB       >	jr c,$-3
  24++8D3A 7B           	ld a,e
  25++8D3B C5           	push bc
  26++8D3C 06 00        	ld b,MOON_BASE_HI
  27++8D3E 0E 26        	ld c,MOON_REG2
  28++8D40 ED 79        	out (c),a
  29++8D42              	opl4_wait
  29++8D42 3E 00       >	ld a,MOON_BASE_HI
  29++8D44 DB 24       >	in a,(MOON_STAT)
  29++8D46 0F          >	rrca
  29++8D47 38 FB       >	jr c,$-3
  30++8D49 7A           	ld a,d
  31++8D4A 06 00        	ld b,MOON_BASE_HI
  32++8D4C 0E 27        	ld c,MOON_DAT2
  33++8D4E ED 79        	out (c),a
  34++8D50 C1           	pop bc
  35++8D51 C9           	ret
  36++8D52
  37++8D52              opl4writewave
  38++8D52              ;e = register
  39++8D52              ;d = value
  40++8D52              	opl4_wait
  40++8D52 3E 00       >	ld a,MOON_BASE_HI
  40++8D54 DB 24       >	in a,(MOON_STAT)
  40++8D56 0F          >	rrca
  40++8D57 38 FB       >	jr c,$-3
  41++8D59 7B           	ld a,e
  42++8D5A C5           	push bc
  43++8D5B 06 00        	ld b,MOON_BASE_HI
  44++8D5D 0E C2        	ld c,MOON_WREG
  45++8D5F ED 79        	out (c),a
  46++8D61              	opl4_wait
  46++8D61 3E 00       >	ld a,MOON_BASE_HI
  46++8D63 DB 24       >	in a,(MOON_STAT)
  46++8D65 0F          >	rrca
  46++8D66 38 FB       >	jr c,$-3
  47++8D68 7A           	ld a,d
  48++8D69 06 00        	ld b,MOON_BASE_HI
  49++8D6B 0E C3        	ld c,MOON_WDAT
  50++8D6D ED 79        	out (c),a
  51++8D6F C1           	pop bc
  52++8D70 C9           	ret
  53++8D71
  54++8D71              opl4readwave
  55++8D71              ;e = register
  56++8D71              	opl4_wait
  56++8D71 3E 00       >	ld a,MOON_BASE_HI
  56++8D73 DB 24       >	in a,(MOON_STAT)
  56++8D75 0F          >	rrca
  56++8D76 38 FB       >	jr c,$-3
  57++8D78 7B           	ld a,e
  58++8D79 C5           	push bc
  59++8D7A 06 00        	ld b,MOON_BASE_HI
  60++8D7C 0E C2        	ld c,MOON_WREG
  61++8D7E ED 79        	out (c),a
  62++8D80 C1           	pop bc
  63++8D81              	opl4_wait
  63++8D81 3E 00       >	ld a,MOON_BASE_HI
  63++8D83 DB 24       >	in a,(MOON_STAT)
  63++8D85 0F          >	rrca
  63++8D86 38 FB       >	jr c,$-3
  64++8D88 3E 00        	ld a,MOON_BASE_HI
  65++8D8A DB C3        	in a,(MOON_WDAT)
  66++8D8C C9           	ret
  67++8D8D
  68++8D8D              	macro opl4_write_fm_regs
  69++8D8D ~            ;e = base register
  70++8D8D ~            ;d = value
  71++8D8D ~            ;b = count
  72++8D8D ~            .loop
  73++8D8D ~            	call opl4writefm1
  74++8D8D ~            	call opl4writefm2
  75++8D8D ~            	inc e
  76++8D8D ~            	djnz .loop
  77++8D8D              	endm
  78++8D8D
  79++8D8D              	macro opl4_write_wave_regs
  80++8D8D ~            ;e = base register
  81++8D8D ~            ;d = value
  82++8D8D ~            ;b = count
  83++8D8D ~            .loop
  84++8D8D ~            	call opl4writewave
  85++8D8D ~            	inc e
  86++8D8D ~            	djnz .loop
  87++8D8D              	endm
  88++8D8D
  89++8D8D              opl4init
  90++8D8D 11 05 03     	ld de,0x0305
  91++8D90 CD 33 8D     	call opl4writefm2
  92++8D93 06 DA        	ld b,0xda
  93++8D95 11 20 00     	ld de,0x0020
  94++8D98              	opl4_write_wave_regs
  94++8D98             >;e = base register
  94++8D98             >;d = value
  94++8D98             >;b = count
  94++8D98             >.loop
  94++8D98 CD 52 8D    >	call opl4writewave
  94++8D9B 1C          >	inc e
  94++8D9C 10 FA       >	djnz .loop
  95++8D9E 11 F8 1B     	ld de,0x1bf8
  96++8DA1 CD 52 8D     	call opl4writewave
  97++8DA4 11 02 10     	ld de,0x1002
  98++8DA7 CD 52 8D     	call opl4writewave
  99++8DAA 06 D6        	ld b,0xd6
 100++8DAC 11 20 00     	ld de,0x0020
 101++8DAF              	opl4_write_fm_regs
 101++8DAF             >;e = base register
 101++8DAF             >;d = value
 101++8DAF             >;b = count
 101++8DAF             >.loop
 101++8DAF CD 14 8D    >	call opl4writefm1
 101++8DB2 CD 33 8D    >	call opl4writefm2
 101++8DB5 1C          >	inc e
 101++8DB6 10 F7       >	djnz .loop
 102++8DB8 11 01 00     	ld de,0x0001
 103++8DBB CD 14 8D     	call opl4writefm1
 104++8DBE 11 08 00     	ld de,0x0008
 105++8DC1 CD 14 8D     	call opl4writefm1
 106++8DC4 11 04 00     	ld de,0x0004
 107++8DC7 C3 33 8D     	jp opl4writefm2
 108++8DCA
 109++8DCA              opl4stoptimers
 110++8DCA 11 04 80     	ld de,0x8004
 111++8DCD CD 14 8D     	call opl4writefm1
 112++8DD0 11 04 00     	ld de,0x0004
 113++8DD3 C3 14 8D     	jp opl4writefm1
 114++8DD6
 115++8DD6              opl4mute
 116++8DD6 CD CA 8D     	call opl4stoptimers
 117++8DD9 11 04 00     	ld de,0x0004
 118++8DDC CD 33 8D     	call opl4writefm2
 119++8DDF 11 BD 00     	ld de,0x00bd
 120++8DE2 CD 14 8D     	call opl4writefm1 ;rhythm off
 121++8DE5 06 16        	ld b,0x16
 122++8DE7 11 80 0F     	ld de,0x0f80
 123++8DEA              	opl4_write_fm_regs ;max release rate
 123++8DEA             >;e = base register
 123++8DEA             >;d = value
 123++8DEA             >;b = count
 123++8DEA             >.loop
 123++8DEA CD 14 8D    >	call opl4writefm1
 123++8DED CD 33 8D    >	call opl4writefm2
 123++8DF0 1C          >	inc e
 123++8DF1 10 F7       >	djnz .loop
 124++8DF3 06 16        	ld b,0x16
 125++8DF5 11 40 3F     	ld de,0x3f40
 126++8DF8              	opl4_write_fm_regs ;min total level
 126++8DF8             >;e = base register
 126++8DF8             >;d = value
 126++8DF8             >;b = count
 126++8DF8             >.loop
 126++8DF8 CD 14 8D    >	call opl4writefm1
 126++8DFB CD 33 8D    >	call opl4writefm2
 126++8DFE 1C          >	inc e
 126++8DFF 10 F7       >	djnz .loop
 127++8E01 06 09        	ld b,0x09
 128++8E03 11 A0 00     	ld de,0x00a0
 129++8E06              	opl4_write_fm_regs ;frequency 0
 129++8E06             >;e = base register
 129++8E06             >;d = value
 129++8E06             >;b = count
 129++8E06             >.loop
 129++8E06 CD 14 8D    >	call opl4writefm1
 129++8E09 CD 33 8D    >	call opl4writefm2
 129++8E0C 1C          >	inc e
 129++8E0D 10 F7       >	djnz .loop
 130++8E0F 06 09        	ld b,0x09
 131++8E11 11 B0 00     	ld de,0x00b0
 132++8E14              	opl4_write_fm_regs ;key off
 132++8E14             >;e = base register
 132++8E14             >;d = value
 132++8E14             >;b = count
 132++8E14             >.loop
 132++8E14 CD 14 8D    >	call opl4writefm1
 132++8E17 CD 33 8D    >	call opl4writefm2
 132++8E1A 1C          >	inc e
 132++8E1B 10 F7       >	djnz .loop
 133++8E1D 06 18        	ld b,0x18
 134++8E1F 11 68 40     	ld de,0x4068
 135++8E22              	opl4_write_wave_regs ;key off, damp
 135++8E22             >;e = base register
 135++8E22             >;d = value
 135++8E22             >;b = count
 135++8E22             >.loop
 135++8E22 CD 52 8D    >	call opl4writewave
 135++8E25 1C          >	inc e
 135++8E26 10 FA       >	djnz .loop
 136++8E28 11 05 00     	ld de,0x0005
 137++8E2B C3 33 8D     	jp opl4writefm2
 138++8E2E
 139++8E2E              opl4setmemoryaddress
 140++8E2E              ;dhl = memory address
 141++8E2E 1E 03        	ld e,0x03
 142++8E30 CD 52 8D     	call opl4writewave
 143++8E33 54           	ld d,h
 144++8E34 1C           	inc e
 145++8E35 CD 52 8D     	call opl4writewave
 146++8E38 1C           	inc e
 147++8E39 55           	ld d,l
 148++8E3A C3 52 8D     	jp opl4writewave
 149++8E3D
 150++8E3D              opl4readmemory
 151++8E3D              ;bc = byte count
 152++8E3D              ;dhl = memory address
 153++8E3D              ;ix = buffer
 154++8E3D CD 2E 8E     	call opl4setmemoryaddress
 155++8E40 11 02 11     	ld de,0x1102
 156++8E43 CD 52 8D     	call opl4writewave
 157++8E46              	opl4_wait
 157++8E46 3E 00       >	ld a,MOON_BASE_HI
 157++8E48 DB 24       >	in a,(MOON_STAT)
 157++8E4A 0F          >	rrca
 157++8E4B 38 FB       >	jr c,$-3
 158++8E4D 3E 06        	ld a,6
 159++8E4F C5           	push bc
 160++8E50 06 00        	ld b,MOON_BASE_HI
 161++8E52 0E C2        	ld c,MOON_WREG
 162++8E54 ED 79        	out (c),a
 163++8E56 C1           	pop bc
 164++8E57 DD 54 DD 5D  	ld de,ix
 165++8E5B 79           	ld a,c
 166++8E5C 0B           	dec bc
 167++8E5D 04           	inc b
 168++8E5E 48           	ld c,b
 169++8E5F 47           	ld b,a
 170++8E60              .readloop
 171++8E60              	opl4_wait
 171++8E60 3E 00       >	ld a,MOON_BASE_HI
 171++8E62 DB 24       >	in a,(MOON_STAT)
 171++8E64 0F          >	rrca
 171++8E65 38 FB       >	jr c,$-3
 172++8E67 3E 00        	ld a,MOON_BASE_HI
 173++8E69 DB C3        	in a,(MOON_WDAT)
 174++8E6B 12           	ld (de),a
 175++8E6C 13           	inc de
 176++8E6D 10 F1        	djnz .readloop
 177++8E6F 0D           	dec c
 178++8E70 20 EE        	jr nz,.readloop
 179++8E72 11 02 10     	ld de,0x1002
 180++8E75 C3 52 8D     	jp opl4writewave
 181++8E78
 182++8E78              opl4writememory
 183++8E78              ;bc = number of bytes
 184++8E78              ;dhl = memory address
 185++8E78              ;ix = buffer
 186++8E78 CD 2E 8E     	call opl4setmemoryaddress
 187++8E7B 11 02 11     	ld de,0x1102
 188++8E7E CD 52 8D     	call opl4writewave
 189++8E81              	opl4_wait
 189++8E81 3E 00       >	ld a,MOON_BASE_HI
 189++8E83 DB 24       >	in a,(MOON_STAT)
 189++8E85 0F          >	rrca
 189++8E86 38 FB       >	jr c,$-3
 190++8E88 3E 06        	ld a,6
 191++8E8A C5           	push bc
 192++8E8B 06 00        	ld b,MOON_BASE_HI
 193++8E8D 0E C2        	ld c,MOON_WREG
 194++8E8F ED 79        	out (c),a
 195++8E91 C1           	pop bc
 196++8E92 DD 54 DD 5D  	ld de,ix
 197++8E96 79           	ld a,c
 198++8E97 0B           	dec bc
 199++8E98 04           	inc b
 200++8E99 48           	ld c,b
 201++8E9A 47           	ld b,a
 202++8E9B              .writeloop
 203++8E9B              	opl4_wait
 203++8E9B 3E 00       >	ld a,MOON_BASE_HI
 203++8E9D DB 24       >	in a,(MOON_STAT)
 203++8E9F 0F          >	rrca
 203++8EA0 38 FB       >	jr c,$-3
 204++8EA2 1A           	ld a,(de)
 205++8EA3 C5           	push bc
 206++8EA4 06 00        	ld b,MOON_BASE_HI
 207++8EA6 0E C3        	ld c,MOON_WDAT
 208++8EA8 ED 79        	out (c),a
 209++8EAA C1           	pop bc
 210++8EAB 13           	inc de
 211++8EAC 10 ED        	djnz .writeloop
 212++8EAE 0D           	dec c
 213++8EAF 20 EA        	jr nz,.writeloop
 214++8EB1 11 02 10     	ld de,0x1002
 215++8EB4 C3 52 8D     	jp opl4writewave
 216++8EB7
# file closed: GPlay/common/opl4.asm
  75++8EB7              	include "common/opm.asm"
# file opened: GPlay/common/opm.asm
   1++8EB7              ;Having chip 0 is mandatory for the player to detect YM2151,
   2++8EB7              ;chip 1 is an optional second chip.
   3++8EB7
   4++8EB7              OPM0_REG = 0xf0c1 ;write: chip 0 address
   5++8EB7              OPM0_DAT = 0xf1c1 ;write: chip 0 value, read: chip 0 status
   6++8EB7              OPM1_REG = 0xf2c1 ;write: chip 1 address
   7++8EB7              OPM1_DAT = 0xf3c1 ;write: chip 1 value, read: chip 1 status
   8++8EB7
   9++8EB7              	macro opm_write_reg reg,dat
  10++8EB7 ~            ;bc = data port
  11++8EB7 ~            ;e = register
  12++8EB7 ~            ;d = value
  13++8EB7 ~            	ld bc,dat
  14++8EB7 ~            	in f,(c)
  15++8EB7 ~            	jp m,$-2
  16++8EB7 ~            	ld bc,reg
  17++8EB7 ~            	out (c),e
  18++8EB7 ~            	ld bc,dat
  19++8EB7 ~            	in f,(c)
  20++8EB7 ~            	jp m,$-2
  21++8EB7 ~            	out (c),d
  22++8EB7              	endm
  23++8EB7
  24++8EB7              opmwriteall
  25++8EB7              ;e = register
  26++8EB7              ;d = value
  27++8EB7 CD D2 8E     	call opmwritechip1
  28++8EBA              opmwritechip0
  29++8EBA              ;e = register
  30++8EBA              ;d = value
  31++8EBA              	opm_write_reg OPM0_REG,OPM0_DAT
  31++8EBA             >;bc = data port
  31++8EBA             >;e = register
  31++8EBA             >;d = value
  31++8EBA 01 C1 F1    >	ld bc,OPM0_DAT
  31++8EBD ED 70       >	in f,(c)
  31++8EBF FA BD 8E    >	jp m,$-2
  31++8EC2 01 C1 F0    >	ld bc,OPM0_REG
  31++8EC5 ED 59       >	out (c),e
  31++8EC7 01 C1 F1    >	ld bc,OPM0_DAT
  31++8ECA ED 70       >	in f,(c)
  31++8ECC FA CA 8E    >	jp m,$-2
  31++8ECF ED 51       >	out (c),d
  32++8ED1 C9           	ret
  33++8ED2
  34++8ED2              opmwritechip1
  35++8ED2              ;e = register
  36++8ED2              ;d = value
  37++8ED2              	opm_write_reg OPM1_REG,OPM1_DAT
  37++8ED2             >;bc = data port
  37++8ED2             >;e = register
  37++8ED2             >;d = value
  37++8ED2 01 C1 F3    >	ld bc,OPM1_DAT
  37++8ED5 ED 70       >	in f,(c)
  37++8ED7 FA D5 8E    >	jp m,$-2
  37++8EDA 01 C1 F2    >	ld bc,OPM1_REG
  37++8EDD ED 59       >	out (c),e
  37++8EDF 01 C1 F3    >	ld bc,OPM1_DAT
  37++8EE2 ED 70       >	in f,(c)
  37++8EE4 FA E2 8E    >	jp m,$-2
  37++8EE7 ED 51       >	out (c),d
  38++8EE9 C9           	ret
  39++8EEA
  40++8EEA              opmdisablechip1
  41++8EEA 3E C9        	ld a,0xc9 ;ret opcode
  42++8EEC 32 D2 8E     	ld (opmwritechip1),a
  43++8EEF C9           	ret
  44++8EF0
  45++8EF0              	macro opm_write_regs incr,incd
  46++8EF0 ~            ;e = base register
  47++8EF0 ~            ;d = value
  48++8EF0 ~            ;l = count
  49++8EF0 ~            .loop	call opmwriteall
  50++8EF0 ~            	IF incr
  51++8EF0 ~            	inc e
  52++8EF0 ~            	ENDIF
  53++8EF0 ~            	IF incd
  54++8EF0 ~            	inc d
  55++8EF0 ~            	ENDIF
  56++8EF0 ~            	dec l
  57++8EF0 ~            	jr nz,.loop
  58++8EF0              	endm
  59++8EF0
  60++8EF0              opminit
  61++8EF0 2E 00        	ld l,0
  62++8EF2 11 00 00     	ld de,0
  63++8EF5              	opm_write_regs 1,0
  63++8EF5             >;e = base register
  63++8EF5             >;d = value
  63++8EF5             >;l = count
  63++8EF5 CD B7 8E    >.loop	call opmwriteall
  63++8EF8             >	IF 1
  63++8EF8 1C          >	inc e
  63++8EF9             >	ENDIF
  63++8EF9             >	IF 0
  63++8EF9 ~           >	inc d
  63++8EF9             >	ENDIF
  63++8EF9 2D          >	dec l
  63++8EFA 20 F9       >	jr nz,.loop
  64++8EFC C9           	ret
  65++8EFD
  66++8EFD              opmstoptimers
  67++8EFD 11 14 30     	ld de,0x3014
  68++8F00 CD B7 8E     	call opmwriteall
  69++8F03 11 14 00     	ld de,0x0014
  70++8F06 C3 B7 8E     	jp opmwriteall
  71++8F09
  72++8F09              opmmute
  73++8F09 CD FD 8E     	call opmstoptimers
  74++8F0C              ;max release rate
  75++8F0C 2E 20        	ld l,0x20
  76++8F0E 11 E0 0F     	ld de,0x0fe0
  77++8F11              	opm_write_regs 1,0
  77++8F11             >;e = base register
  77++8F11             >;d = value
  77++8F11             >;l = count
  77++8F11 CD B7 8E    >.loop	call opmwriteall
  77++8F14             >	IF 1
  77++8F14 1C          >	inc e
  77++8F15             >	ENDIF
  77++8F15             >	IF 0
  77++8F15 ~           >	inc d
  77++8F15             >	ENDIF
  77++8F15 2D          >	dec l
  77++8F16 20 F9       >	jr nz,.loop
  78++8F18              ;min total level
  79++8F18 2E 20        	ld l,0x20
  80++8F1A 11 60 7F     	ld de,0x7f60
  81++8F1D              	opm_write_regs 1,0
  81++8F1D             >;e = base register
  81++8F1D             >;d = value
  81++8F1D             >;l = count
  81++8F1D CD B7 8E    >.loop	call opmwriteall
  81++8F20             >	IF 1
  81++8F20 1C          >	inc e
  81++8F21             >	ENDIF
  81++8F21             >	IF 0
  81++8F21 ~           >	inc d
  81++8F21             >	ENDIF
  81++8F21 2D          >	dec l
  81++8F22 20 F9       >	jr nz,.loop
  82++8F24              ;key off
  83++8F24 2E 08        	ld l,0x08
  84++8F26 11 08 00     	ld de,0x0008
  85++8F29              	opm_write_regs 0,1
  85++8F29             >;e = base register
  85++8F29             >;d = value
  85++8F29             >;l = count
  85++8F29 CD B7 8E    >.loop	call opmwriteall
  85++8F2C             >	IF 0
  85++8F2C ~           >	inc e
  85++8F2C             >	ENDIF
  85++8F2C             >	IF 1
  85++8F2C 14          >	inc d
  85++8F2D             >	ENDIF
  85++8F2D 2D          >	dec l
  85++8F2E 20 F9       >	jr nz,.loop
  86++8F30 C9           	ret
  87++8F31
# file closed: GPlay/common/opm.asm
  76++8F31              	include "vgm/opl4.asm"
# file opened: GPlay/vgm/opl4.asm
   1++8F31              WAVEHEADERBUFFERSIZE = MOONRAMWAVETABLESIZE*MOONWAVEHEADERSIZE
   2++8F31
   3++8F31              opl4writemusiconlyfm1
   4++8F31              ;skips writes to control registers
   5++8F31              ;e = register
   6++8F31              ;d = value
   7++8F31 7B           	ld a,e
   8++8F32 FE 20        	cp 0x20
   9++8F34 D2 14 8D     	jp nc,opl4writefm1
  10++8F37 FE 08        	cp 0x08
  11++8F39 C0           	ret nz
  12++8F3A C3 14 8D     	jp opl4writefm1
  13++8F3D
  14++8F3D              opl4writemusiconlyfm2
  15++8F3D              ;skips writes to control registers
  16++8F3D              ;e = register
  17++8F3D              ;d = value
  18++8F3D 7B           	ld a,e
  19++8F3E FE 04        	cp 4
  20++8F40 D8               ret c
  21++8F41 FE 05        	cp 5
  22++8F43 C8           	ret z
  23++8F44 C3 33 8D     	jp opl4writefm2
  24++8F47
  25++8F47              opl4writewavemusiconly
  26++8F47              ;skips writes to control registers and handles ROM dumps
  27++8F47              ;e = register
  28++8F47              ;d = value
  29++8F47 7B           	ld a,e
  30++8F48 FE 38        	cp 0x38
  31++8F4A D2 52 8D     	jp nc,opl4writewave
  32++8F4D FE 08        	cp 0x08
  33++8F4F D8           	ret c
  34++8F50 FE 20        	cp 0x20
  35++8F52 38 07        	jr c,writewavetableindexlo
  36++8F54              ;force wave table index into 384--511 range if ROM data is loaded
  37++8F54              isromloaded=$+1
  38++8F54 3E 00        	ld a,0
  39++8F56 B2           	or d
  40++8F57 57           	ld d,a
  41++8F58 C3 52 8D     	jp opl4writewave
  42++8F5B              writewavetableindexlo
  43++8F5B 3A 55 8F     	ld a,(isromloaded)
  44++8F5E 0F           	rrca
  45++8F5F B2           	or d
  46++8F60 57           	ld d,a
  47++8F61 CD 52 8D     	call opl4writewave
  48++8F64              ;wait for the header to load
  49++8F64 3E 00        	ld a,MOON_BASE_HI
  50++8F66 DB 24        	in a,(MOON_STAT)
  51++8F68 E6 03        	and 3
  52++8F6A 20 FA        	jr nz,$-4
  53++8F6C C9           	ret
  54++8F6D
  55++8F6D              vgmopl4init
  56++8F6D AF           	xor a
  57++8F6E 32 55 8F     	ld (isromloaded),a
  58++8F71 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
  59++8F74 22 B3 8F     	ld (opl4loadramdatablockheader.romsize0),hl
  60++8F77 3E 20        	ld a,MOONSOUNDROMSIZE/65536
  61++8F79 32 B7 8F     	ld (opl4loadramdatablockheader.romsize2),a
  62++8F7C C3 8D 8D     	jp opl4init
  63++8F7F
  64++8F7F              sub24x16
  65++8F7F              ;dhl = minuend
  66++8F7F              ;bc = subtrahend
  67++8F7F              ;out: cf=1 if negative result, zf=1 if zero
  68++8F7F B7 ED 42     	sub hl,bc
  69++8F82 38 04        	jr c,.carry
  70++8F84 C0           	ret nz
  71++8F85 7A           	ld a,d
  72++8F86 B7           	or a
  73++8F87 C9           	ret
  74++8F88              .carry
  75++8F88 7A           	ld a,d
  76++8F89 DE 00        	sbc a,0
  77++8F8B 57           	ld d,a
  78++8F8C C0           	ret nz
  79++8F8D 7D           	ld a,l
  80++8F8E B4           	or h
  81++8F8F C9           	ret
  82++8F90
  83++8F90              opl4loadromdatablockheader
  84++8F90              ;dhl = header+data size
  85++8F90              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
  86++8F90 D9           	exx
  87++8F91 CD 71 8C     	call memorystreamread4 ;adbc = total rom size
  88++8F94 ED 43 B3 8F  	ld (opl4loadramdatablockheader.romsize0),bc
  89++8F98 7A           	ld a,d
  90++8F99 C6 20        	add 0x20 ;place in RAM
  91++8F9B 32 B7 8F     	ld (opl4loadramdatablockheader.romsize2),a
  92++8F9E CD 71 8C     	call memorystreamread4 ;adbc = start address
  93++8FA1 60 69        	ld hl,bc
  94++8FA3 CB EA        	set 5,d ;place in RAM
  95++8FA5 D9           	exx
  96++8FA6 01 08 00     	ld bc,8
  97++8FA9 18 D4        	jr sub24x16
  98++8FAB
  99++8FAB              opl4loadramdatablockheader
 100++8FAB              ;dhl = header+data size
 101++8FAB              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
 102++8FAB D9           	exx
 103++8FAC CD 71 8C     	call memorystreamread4 ;adbc = total ram size
 104++8FAF CD 71 8C     	call memorystreamread4 ;adbc = start address
 105++8FB2              .romsize0=$+1
 106++8FB2 21 00 00     	ld hl,0
 107++8FB5 09           	add hl,bc
 108++8FB6              .romsize2=$+1
 109++8FB6 3E 00        	ld a,0
 110++8FB8 8A           	adc a,d
 111++8FB9 E6 3F        	and 0x3f
 112++8FBB 57           	ld d,a
 113++8FBC D9           	exx
 114++8FBD 01 08 00     	ld bc,8
 115++8FC0 18 BD        	jr sub24x16
 116++8FC2
 117++8FC2              setup24bitscounterloop
 118++8FC2              ;dhl = counter
 119++8FC2              ;out: b = inner loop counter, de = outer loop counter
 120++8FC2 5D           	ld e,l
 121++8FC3 01 01 00     	ld bc,1
 122++8FC6 B7 ED 42     	sub hl,bc
 123++8FC9 30 01        	jr nc,$+3
 124++8FCB 15           	dec d
 125++8FCC 43           	ld b,e
 126++8FCD 5C           	ld e,h
 127++8FCE 13           	inc de
 128++8FCF C9           	ret
 129++8FD0
 130++8FD0              opl4loadsample
 131++8FD0              ;dhl = sample start address
 132++8FD0              ;dhl' = sample size
 133++8FD0 42           	ld b,d
 134++8FD1 11 05 03     	ld de,0x0305
 135++8FD4 CD 33 8D     	call opl4writefm2
 136++8FD7 50           	ld d,b
 137++8FD8 CD 2E 8E     	call opl4setmemoryaddress
 138++8FDB 11 02 11     	ld de,0x1102
 139++8FDE CD 52 8D     	call opl4writewave
 140++8FE1              	opl4_wait
 140++8FE1 3E 00       >	ld a,MOON_BASE_HI
 140++8FE3 DB 24       >	in a,(MOON_STAT)
 140++8FE5 0F          >	rrca
 140++8FE6 38 FB       >	jr c,$-3
 141++8FE8 3E 06        	ld a,6
 142++8FEA C5           	push bc
 143++8FEB 06 00        	ld b,MOON_BASE_HI
 144++8FED 0E C2        	ld c,MOON_WREG
 145++8FEF ED 79        	out (c),a
 146++8FF1 C1           	pop bc
 147++8FF2 D9           	exx
 148++8FF3 CD C2 8F     	call setup24bitscounterloop
 149++8FF6 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 150++8FF9              .loop
 151++8FF9              	memory_stream_read_byte c
 151++8FF9 CB 74       >	bit 6,h
 151++8FFB             >        IF AREA_C000_FFFF=1
 151++8FFB CC 0D 8C    >	call z,memorystreamnextpage
 151++8FFE             >        ELSE
 151++8FFE ~           > 	call nz,memorystreamnextpage
 151++8FFE             >        ENDIF
 151++8FFE 4E          >	ld c,(hl)
 151++8FFF 23          >	inc hl
 152++9000              	opl4_wait
 152++9000 3E 00       >	ld a,MOON_BASE_HI
 152++9002 DB 24       >	in a,(MOON_STAT)
 152++9004 0F          >	rrca
 152++9005 38 FB       >	jr c,$-3
 153++9007 79           	ld a,c
 154++9008 C5           	push bc
 155++9009 06 00        	ld b,MOON_BASE_HI
 156++900B 0E C3        	ld c,MOON_WDAT
 157++900D ED 79        	out (c),a
 158++900F C1           	pop bc
 159++9010 10 E7        	djnz .loop
 160++9012 1B           	dec de
 161++9013 7B           	ld a,e
 162++9014 B2           	or d
 163++9015 20 E2        	jr nz,.loop
 164++9017 22 72 8C     	ld (memorystreamcurrentaddr),hl
 165++901A 11 02 10     	ld de,0x1002
 166++901D C3 52 8D     	jp opl4writewave
 167++9020
 168++9020              opl4loadramdatablock
 169++9020              ;dhl = data+header size
 170++9020 CD AB 8F     	call opl4loadramdatablockheader
 171++9023 C8           	ret z
 172++9024 D9           	exx
 173++9025 18 A9        	jr opl4loadsample
 174++9027
 175++9027              opl4loadromdatablock
 176++9027              ;dhl = data+header size
 177++9027 CD 90 8F     	call opl4loadromdatablockheader
 178++902A C8           	ret z
 179++902B D9           	exx
 180++902C D5           	push de
 181++902D CD D0 8F     	call opl4loadsample
 182++9030 F1           	pop af
 183++9031              ;check if the address is within the first 64K of RAM
 184++9031 FE 21        	cp 0x21
 185++9033 D0           	ret nc
 186++9034              ;patch all 128 headers that LSI can read from RAM
 187++9034 3E 01        	ld a,1
 188++9036 32 55 8F     	ld (isromloaded),a
 189++9039 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 190++903C 16 20        	ld d,MOONSOUNDROMSIZE/65536
 191++903E 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 192++9041 DD 21 00 B8  	ld ix,waveheaderbuffer
 193++9045 CD 3D 8E     	call opl4readmemory
 194++9048 21 00 B8     	ld hl,waveheaderbuffer
 195++904B 11 0C 00     	ld de,MOONWAVEHEADERSIZE
 196++904E 06 80        	ld b,MOONRAMWAVETABLESIZE
 197++9050              .loop
 198++9050 CB EE        	set 5,(hl) ;set base address in RAM area
 199++9052 19           	add hl,de
 200++9053 10 FB        	djnz .loop
 201++9055 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 202++9058 16 20        	ld d,MOONSOUNDROMSIZE/65536
 203++905A 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 204++905D DD 21 00 B8  	ld ix,waveheaderbuffer
 205++9061 C3 78 8E     	jp opl4writememory
 206++9064
 207++9064              opl4inittimer60hz
 208++9064 11 02 2F     	ld de,0x2f02
 209++9067 CD 14 8D     	call opl4writefm1
 210++906A 11 04 21     	ld de,0x2104
 211++906D C3 14 8D     	jp opl4writefm1
 212++9070
 213++9070              opl4waittimer60hz
 214++9070 3E 00        	ld a,MOON_BASE_HI
 215++9072 DB 24        	in a,(MOON_STAT)
 216++9074 17           	rla
 217++9075 30 F9        	jr nc,opl4waittimer60hz
 218++9077 11 04 81     	ld de,0x8104
 219++907A C3 14 8D     	jp opl4writefm1
 220++907D
# file closed: GPlay/vgm/opl4.asm
  77++907D              	include "common/opn.asm"
# file opened: GPlay/common/opn.asm
   1++907D              ;Define ENABLE_FM to enable FM DACs
   2++907D
   3++907D              OPN_REG = 0xfffd
   4++907D              OPN_DAT = 0xbffd
   5++907D
   6++907D
   7++907D                      ifdef ENABLE_FM
   8++907D ~            CHIP0 = %11111000
   9++907D ~            CHIP1 = %11111001
  10++907D                      else
  11++907D              CHIP0 = %11111100
  12++907D              CHIP1 = %11111101
  13++907D                      endif
  14++907D
  15++907D
  16++907D              ;------------------------------------
  17++907D              opnwriteall
  18++907D CD A0 90     	call opnwritefm2
  19++9080              ;------------------------------------
  20++9080              opnwritefm1:
  21++9080              	;opn_write_fm_reg 0
  22++9080 3E FC              	ld a,CHIP0
  23++9082              opnwritefmx:
  24++9082              ;a = chipselect
  25++9082              ;e = register
  26++9082              ;d = value
  27++9082 01 FD FF     	ld bc,OPN_REG
  28++9085 ED 79        	out (c),a
  29++9087
  30++9087              1
  31++9087 00           	nop
  31++9088 00            nop
  32++9089              ;        nop:nop:nop
  33++9089 ED 70        	in f,(c)
  34++908B FA 87 90     	jp m, 1b ;$-6
  35++908E
  36++908E ED 59        	out (c),e
  37++9090
  38++9090              2
  39++9090 00             	nop
  39++9091 00            nop
  40++9092              ;        nop:nop:nop
  41++9092 ED 70        	in f,(c)
  42++9094 FA 90 90     	jp m,2b   ;$-6
  43++9097
  44++9097 06 BF        	ld b,HIGH OPN_DAT
  45++9099 ED 51        	out (c),d
  46++909B
  47++909B              .extradelay ;additional delay for FPGA systems
  48++909B 06 08        	ld b,8
  49++909D 10 FE        	djnz $
  50++909F C9           	ret
  51++90A0              ;------------------------------------
  52++90A0              opnwritefm2:
  53++90A0 3E FD               	ld a,CHIP1
  54++90A2 C3 82 90             jp opnwritefmx
  55++90A5              ;------------------------------------
  56++90A5
  57++90A5
  58++90A5              opndisableextradelay
  59++90A5 3E C9        	ld a,0xc9 ;ret opcode
  60++90A7 32 9B 90     	ld (opnwritefmx.extradelay),a
  61++90AA C9           	ret
  62++90AB
  63++90AB
  64++90AB              	macro opn_write_fm_regs incr,incd
  65++90AB ~            ;e = base register
  66++90AB ~            ;d = value
  67++90AB ~            ;l = count
  68++90AB ~            .loop	call opnwriteall
  69++90AB ~            	IF incr
  70++90AB ~            	inc e
  71++90AB ~            	ENDIF
  72++90AB ~            	IF incd
  73++90AB ~            	inc d
  74++90AB ~            	ENDIF
  75++90AB ~            	dec l
  76++90AB ~            	jr nz,.loop
  77++90AB              	endm
  78++90AB
  79++90AB
  80++90AB
  81++90AB              opninit
  82++90AB 2E B4        	ld l,0xb4
  83++90AD 11 00 00     	ld de,0x0000
  84++90B0              	opn_write_fm_regs 1,0
  84++90B0             >;e = base register
  84++90B0             >;d = value
  84++90B0             >;l = count
  84++90B0 CD 7D 90    >.loop	call opnwriteall
  84++90B3             >	IF 1
  84++90B3 1C          >	inc e
  84++90B4             >	ENDIF
  84++90B4             >	IF 0
  84++90B4 ~           >	inc d
  84++90B4             >	ENDIF
  84++90B4 2D          >	dec l
  84++90B5 20 F9       >	jr nz,.loop
  85++90B7              ;configure prescaler
  86++90B7 11 2F 00     	ld de,0x002f
  87++90BA CD 7D 90     	call opnwriteall
  88++90BD 11 2D 00     	ld de,0x002d
  89++90C0 C3 7D 90     	jp opnwriteall
  90++90C3
  91++90C3              opnstoptimers
  92++90C3 11 27 30     	ld de,0x3027
  93++90C6 CD 7D 90     	call opnwriteall
  94++90C9 11 27 00     	ld de,0x0027
  95++90CC C3 7D 90     	jp opnwriteall
  96++90CF
  97++90CF              opnmute
  98++90CF CD C3 90     	call opnstoptimers
  99++90D2              ;mute SSG
 100++90D2 2E 03        	ld l,3
 101++90D4 11 08 00     	ld de,0x0008
 102++90D7              	opn_write_fm_regs 1,0
 102++90D7             >;e = base register
 102++90D7             >;d = value
 102++90D7             >;l = count
 102++90D7 CD 7D 90    >.loop	call opnwriteall
 102++90DA             >	IF 1
 102++90DA 1C          >	inc e
 102++90DB             >	ENDIF
 102++90DB             >	IF 0
 102++90DB ~           >	inc d
 102++90DB             >	ENDIF
 102++90DB 2D          >	dec l
 102++90DC 20 F9       >	jr nz,.loop
 103++90DE 2E 0E        	ld l,14
 104++90E0 11 00 00     	ld de,0x0000
 105++90E3              	opn_write_fm_regs 1,0
 105++90E3             >;e = base register
 105++90E3             >;d = value
 105++90E3             >;l = count
 105++90E3 CD 7D 90    >.loop	call opnwriteall
 105++90E6             >	IF 1
 105++90E6 1C          >	inc e
 105++90E7             >	ENDIF
 105++90E7             >	IF 0
 105++90E7 ~           >	inc d
 105++90E7             >	ENDIF
 105++90E7 2D          >	dec l
 105++90E8 20 F9       >	jr nz,.loop
 106++90EA              ;max release rate
 107++90EA 2E 10        	ld l,0x10
 108++90EC 11 80 0F     	ld de,0x0f80
 109++90EF              	opn_write_fm_regs 1,0
 109++90EF             >;e = base register
 109++90EF             >;d = value
 109++90EF             >;l = count
 109++90EF CD 7D 90    >.loop	call opnwriteall
 109++90F2             >	IF 1
 109++90F2 1C          >	inc e
 109++90F3             >	ENDIF
 109++90F3             >	IF 0
 109++90F3 ~           >	inc d
 109++90F3             >	ENDIF
 109++90F3 2D          >	dec l
 109++90F4 20 F9       >	jr nz,.loop
 110++90F6              ;min total level
 111++90F6 2E 10        	ld l,0x10
 112++90F8 11 40 7F     	ld de,0x7f40
 113++90FB              	opn_write_fm_regs 1,0
 113++90FB             >;e = base register
 113++90FB             >;d = value
 113++90FB             >;l = count
 113++90FB CD 7D 90    >.loop	call opnwriteall
 113++90FE             >	IF 1
 113++90FE 1C          >	inc e
 113++90FF             >	ENDIF
 113++90FF             >	IF 0
 113++90FF ~           >	inc d
 113++90FF             >	ENDIF
 113++90FF 2D          >	dec l
 113++9100 20 F9       >	jr nz,.loop
 114++9102              ;key off
 115++9102 2E 04        	ld l,0x04
 116++9104 11 28 00     	ld de,0x0028
 117++9107              	opn_write_fm_regs 0,1
 117++9107             >;e = base register
 117++9107             >;d = value
 117++9107             >;l = count
 117++9107 CD 7D 90    >.loop	call opnwriteall
 117++910A             >	IF 0
 117++910A ~           >	inc e
 117++910A             >	ENDIF
 117++910A             >	IF 1
 117++910A 14          >	inc d
 117++910B             >	ENDIF
 117++910B 2D          >	dec l
 117++910C 20 F9       >	jr nz,.loop
 118++910E              ;default tfm state
 119++910E 01 FD FF     	ld bc,OPN_REG
 120++9111 3E FF        	ld a,%11111111
 121++9113 ED 79        	out (c),a
 122++9115 C9           	ret
 123++9116
# file closed: GPlay/common/opn.asm
  78++9116              	include "vgm/opn.asm"
# file opened: GPlay/vgm/opn.asm
   1++9116              opniscontrolregister
   2++9116              ;a = register
   3++9116              ;out: zf=1 if it's control register, zf=0 otherwise
   4++9116 FE 0E        	cp 0x0e ;IO port
   5++9118 C8           	ret z
   6++9119 FE 0F        	cp 0x0f ;IO port
   7++911B C8           	ret z
   8++911C FE 2D        	cp 0x2d ;prescaler
   9++911E C8           	ret z
  10++911F FE 2E        	cp 0x2e ;prescaler
  11++9121 C8           	ret z
  12++9122 FE 2F        	cp 0x2f ;prescaler
  13++9124 C9           	ret
  14++9125
  15++9125              opnwritemusiconlyfm1
  16++9125              ;skips writes to control registers
  17++9125              ;e = register
  18++9125              ;d = value
  19++9125 7B           	ld a,e
  20++9126 CD 16 91     	call opniscontrolregister
  21++9129 C8           	ret z
  22++912A FE 27        	cp 0x27 ;timers control
  23++912C C2 80 90     	jp nz,opnwritefm1
  24++912F 7A           	ld a,d
  25++9130 32 5E 91     	ld (opntimerctrl),a
  26++9133 F6 0A        	or %00001010 ;avoid altering timer B
  27++9135 57           	ld d,a
  28++9136 C3 80 90     	jp opnwritefm1
  29++9139
  30++9139              opnwritemusiconlyfm2
  31++9139              ;skips writes to control registers
  32++9139              ;e = register
  33++9139              ;d = value
  34++9139 7B           	ld a,e
  35++913A CD 16 91     	call opniscontrolregister
  36++913D C8           	ret z
  37++913E C3 A0 90     	jp opnwritefm2
  38++9141
  39++9141              opninittimer60hz
  40++9141              ;	ld de,0xc626
  41++9141              ;	ld de,0xca26
  42++9141 11 26 CD     	ld de,0xcd26
  43++9144 CD 80 90     	call opnwritefm1
  44++9147 11 27 2A     	ld de,0x2a27
  45++914A C3 80 90     	jp opnwritefm1
  46++914D
  47++914D              opnwaittimer60hz
  48++914D 01 FD FF     	ld bc,OPN_REG
  49++9150 3E F8        	ld a,%11111000
  50++9152 ED 79        	out (c),a
  51++9154              .waitloop
  52++9154 ED 78        	in a,(c)
  53++9156 E6 02        	and 2
  54++9158 28 FA        	jr z,.waitloop
  55++915A 11 27 2A     	ld de,0x2a27
  56++915D              opntimerctrl=$+1
  57++915D 3E 00        	ld a,0
  58++915F B2           	or d
  59++9160 57           	ld d,a
  60++9161 C3 80 90     	jp opnwritefm1
  61++9164
# file closed: GPlay/vgm/opn.asm
  79++9164              	include "vgm/opm.asm"
# file opened: GPlay/vgm/opm.asm
   1++9164              opmwritemusiconlychip0
   2++9164              ;e = register
   3++9164              ;d = value
   4++9164 7B           	ld a,e
   5++9165 FE 08        	cp 8
   6++9167 D8           	ret c
   7++9168 C3 BA 8E     	jp opmwritechip0
   8++916B
   9++916B              opmwritemusiconlychip1
  10++916B              ;e = register
  11++916B              ;d = value
  12++916B 7B           	ld a,e
  13++916C FE 08        	cp 8
  14++916E D8           	ret c
  15++916F C3 D2 8E     	jp opmwritechip1
  16++9172
  17++9172              vgmopminit
  18++9172 3E 02        	ld a,2
  19++9174 32 7B 91     	ld (opmwaittimer100hz.counter),a
  20++9177 C3 F0 8E     	jp opminit
  21++917A
  22++917A              opmwaittimer100hz
  23++917A              .counter=$+1
  24++917A 3E 00        	ld a,0
  25++917C 3D           	dec a
  26++917D 20 02        	jr nz,$+4
  27++917F 3E 02        	ld a,2
  28++9181 32 7B 91     	ld (.counter),a
  29++9184 C8           	ret z
  30++9185              	;YIELD
  31++9185              	OS_WAIT
  31++9185 DF          >	rst #18
  32++9186 C9           	ret
  33++9187
# file closed: GPlay/vgm/opm.asm
  80++9187              	include "vgm/ssg.asm"
# file opened: GPlay/vgm/ssg.asm
   1++9187              SSG_REG = 0xfffd
   2++9187              SSG_DAT = 0xbffd
   3++9187
   4++9187              	macro ssg_write_reg chip_n
   5++9187 ~            ;e = register
   6++9187 ~            ;d = value
   7++9187 ~            	ld bc,SSG_REG
   8++9187 ~            	ld a,chip_n+%11111110
   9++9187 ~            	out (c),a
  10++9187 ~            	out (c),e
  11++9187 ~            	ld bc,SSG_DAT
  12++9187 ~            	out (c),d
  13++9187              	endm
  14++9187
  15++9187              ssgwritemusiconlychip0
  16++9187 7B           	ld a,e
  17++9188 FE 0E        	cp 0x0e
  18++918A D0           	ret nc
  19++918B              ssgwrite0
  20++918B              ;e = register
  21++918B              ;d = value
  22++918B              	ssg_write_reg 0
  22++918B             >;e = register
  22++918B             >;d = value
  22++918B 01 FD FF    >	ld bc,SSG_REG
  22++918E 3E FE       >	ld a,0+%11111110
  22++9190 ED 79       >	out (c),a
  22++9192 ED 59       >	out (c),e
  22++9194 01 FD BF    >	ld bc,SSG_DAT
  22++9197 ED 51       >	out (c),d
  23++9199 C9           	ret
  24++919A
  25++919A              ssgwritemusiconlychip1
  26++919A 7B           	ld a,e
  27++919B FE 0E        	cp 0x0e
  28++919D D0           	ret nc
  29++919E              ssgwrite1
  30++919E              ;e = register
  31++919E              ;d = value
  32++919E              	ssg_write_reg 1
  32++919E             >;e = register
  32++919E             >;d = value
  32++919E 01 FD FF    >	ld bc,SSG_REG
  32++91A1 3E FF       >	ld a,1+%11111110
  32++91A3 ED 79       >	out (c),a
  32++91A5 ED 59       >	out (c),e
  32++91A7 01 FD BF    >	ld bc,SSG_DAT
  32++91AA ED 51       >	out (c),d
  33++91AC C9           	ret
  34++91AD
  35++91AD              ssginit
  36++91AD C9           	ret
  37++91AE
  38++91AE              	macro ssg_write_regs
  39++91AE ~            ;e = base register
  40++91AE ~            ;d = value
  41++91AE ~            ;l = count
  42++91AE ~            .loop
  43++91AE ~            	call ssgwrite0
  44++91AE ~            	call ssgwrite1
  45++91AE ~            	inc e
  46++91AE ~            	dec l
  47++91AE ~            	jr nz,.loop
  48++91AE              	endm
  49++91AE
  50++91AE              ssgmute
  51++91AE 2E 03        	ld l,3
  52++91B0 11 08 00     	ld de,8
  53++91B3              	ssg_write_regs
  53++91B3             >;e = base register
  53++91B3             >;d = value
  53++91B3             >;l = count
  53++91B3             >.loop
  53++91B3 CD 8B 91    >	call ssgwrite0
  53++91B6 CD 9E 91    >	call ssgwrite1
  53++91B9 1C          >	inc e
  53++91BA 2D          >	dec l
  53++91BB 20 F6       >	jr nz,.loop
  54++91BD 2E 0E        	ld l,14
  55++91BF 11 00 00     	ld de,0
  56++91C2              	ssg_write_regs
  56++91C2             >;e = base register
  56++91C2             >;d = value
  56++91C2             >;l = count
  56++91C2             >.loop
  56++91C2 CD 8B 91    >	call ssgwrite0
  56++91C5 CD 9E 91    >	call ssgwrite1
  56++91C8 1C          >	inc e
  56++91C9 2D          >	dec l
  56++91CA 20 F6       >	jr nz,.loop
  57++91CC C9           	ret
  58++91CD
# file closed: GPlay/vgm/ssg.asm
  81++91CD
  82++91CD
  83++91CD
  84++91CD
  85++91CD
  86++91CD
  87++91CD              waittimer50hz
  88++91CD              	;YIELD
  89++91CD              	OS_WAIT
  89++91CD DF          >	rst #18
  90++91CE C9           	ret
  91++91CF
  92++91CF
  93++91CF              waveheaderbuffer = 0xc000-2048 ;0x5400 ;текущий размер буфера 1536 (128*12)
  94++91CF              waveheaderbufferend = waveheaderbuffer+WAVEHEADERBUFFERSIZE
  95++91CF              vgmheadercopy = waveheaderbufferend
  96++91CF              vgmheadercopyend = vgmheadercopy+HEADER_SIZE_MAX ;(ещё 256)
  97++91CF
  98++91CF              titlestr = waveheaderbufferend
  99++91CF              titlestrend = titlestr+TITLELENGTH
 100++91CF
 101++91CF
 102++91CF              HEADER_CLOCK_YM2203 = vgmheadercopy+0x44
 103++91CF              HEADER_CLOCK_YM3812 = vgmheadercopy+0x50
 104++91CF              HEADER_CLOCK_YMF262 = vgmheadercopy+0x5c
 105++91CF              HEADER_CLOCK_YMF278B = vgmheadercopy+0x60
 106++91CF              HEADER_CLOCK_AY8910 = vgmheadercopy+0x74
 107++91CF
 108++91CF
 109++91CF              	macro a_or_dw addr
 110++91CF ~            	ld hl,(addr+0)
 111++91CF ~            	or h
 112++91CF ~            	or l
 113++91CF ~            	ld de,(addr+2)
 114++91CF ~            	or d
 115++91CF ~            	or e
 116++91CF              	endm
 117++91CF
 118++91CF              	macro set_timer wait,ticks
 119++91CF ~            	ld hl,ticks
 120++91CF ~            	ld (waittimerstep),hl
 121++91CF              	endm
 122++91CF
 123++91CF
 124++91CF              init_:
 125++91CF              	set_timer waittimer50hz,882
 125++91CF 21 72 03    >	ld hl,882
 125++91D2 22 86 92    >	ld (waittimerstep),hl
 126++91D5 21 00 00     	ld hl,0
 127++91D8 22 81 92     	ld (waitcounterlo),hl
 128++91DB AF           	xor a
 129++91DC 32 84 92     	ld (waitcounterhi),a
 130++91DF 32 66 92     	ld (devicemask),a
 131++91E2
 132++91E2 32 7A 92           	ld (vgm_play_var),a
 133++91E5              ;map header to 0x8000
 134++91E5                      ;first page (vgm_header) now in page_plr3
 135++91E5                      ;now do init.
 136++91E5
 137++91E5              ;copy header
 138++91E5 01 00 01     	ld bc,HEADER_SIZE_MAX
 139++91E8 21 00 BE     	ld hl,vgmheadercopy
 140++91EB 11 01 BE     	ld de,vgmheadercopy+1
 141++91EE 36 00        	ld (hl),0
 142++91F0 ED B0        	ldir
 143++91F2 2A 34 C0     	ld hl,(HEADER_DATA_OFFSET)  ;если HEADER_DATA_OFFSET == 0 to bc = 0x0040 иначе  bc = 0x0034
 144++91F5 7C           	ld a,h
 145++91F6 B5           	or l
 146++91F7 01 40 00     	ld bc,0x40
 147++91FA 28 02        	jr z,$+4
 148++91FC 0E 34        	ld c,0x34
 149++91FE 09           	add hl,bc
 150++91FF 22 5D 92     	ld (.dataoffset),hl
 151++9202                            ;определяем сколько данных заголовка vgm нужно перекинуть в буфер исходя из значения HEADER_DATA_OFFSET
 152++9202 44 4D        	ld bc,hl
 153++9204 21 FF FE     	ld hl,-HEADER_SIZE_MAX-1
 154++9207 09           	add hl,bc
 155++9208 30 03        	jr nc,$+5
 156++920A 01 00 01     	ld bc,HEADER_SIZE_MAX
 157++920D
 158++920D 21 00 C0     	ld hl,module
 159++9210 11 00 BE     	ld de,vgmheadercopy
 160++9213 ED B0        	ldir
 161++9215              ;setup loop
 162++9215 AF           	xor a
 163++9216              	a_or_dw HEADER_LOOP_OFFSET
 163++9216 2A 1C C0    >	ld hl,(HEADER_LOOP_OFFSET+0)
 163++9219 B4          >	or h
 163++921A B5          >	or l
 163++921B ED 5B 1E C0 >	ld de,(HEADER_LOOP_OFFSET+2)
 163++921F B2          >	or d
 163++9220 B3          >	or e
 164++9221 22 84 94     	ld (loopoffsetlo),hl
 165++9224 ED 53 81 94  	ld (loopoffsethi),de
 166++9228              ;init Moonsound
 167++9228 AF           	xor a
 168++9229              	a_or_dw HEADER_CLOCK_YM3812
 168++9229 2A 50 BE    >	ld hl,(HEADER_CLOCK_YM3812+0)
 168++922C B4          >	or h
 168++922D B5          >	or l
 168++922E ED 5B 52 BE >	ld de,(HEADER_CLOCK_YM3812+2)
 168++9232 B2          >	or d
 168++9233 B3          >	or e
 169++9234 32 E2 96     	ld (useYM3812),a
 170++9237              	a_or_dw HEADER_CLOCK_YMF262
 170++9237 2A 5C BE    >	ld hl,(HEADER_CLOCK_YMF262+0)
 170++923A B4          >	or h
 170++923B B5          >	or l
 170++923C ED 5B 5E BE >	ld de,(HEADER_CLOCK_YMF262+2)
 170++9240 B2          >	or d
 170++9241 B3          >	or e
 171++9242 20 14        	jr nz,.opl4notneeded
 172++9244              	a_or_dw HEADER_CLOCK_YMF278B
 172++9244 2A 60 BE    >	ld hl,(HEADER_CLOCK_YMF278B+0)
 172++9247 B4          >	or h
 172++9248 B5          >	or l
 172++9249 ED 5B 62 BE >	ld de,(HEADER_CLOCK_YMF278B+2)
 172++924D B2          >	or d
 172++924E B3          >	or e
 173++924F 28 07        	jr z,.opl4notneeded
 174++9251 3A D4 96     	ld a,(moonsoundstatus)
 175++9254 FE 02        	cp 2
 176++9256 C0           	ret nz ;jp nz,memorystreamfree ;sets zf=0
 177++9257 B7           	or a
 178++9258              .opl4notneeded
 179++9258 C4 D3 96     	call nz,initYMF278B
 180++925B C0           	ret nz  ;jp nz,memorystreamfree ;sets zf=0
 181++925C              .dataoffset=$+1
 182++925C 21 00 00     	ld hl,0
 183++925F 11 00 00     	ld de,0
 184++9262                      ;init music
 185++9262 CD C8 8C     	call memorystreamseek
 186++9265              devicemask=$+1
 187++9265 3E 00        	ld a,0
 188++9267              ;zf=0 if there isn't any supported device
 189++9267 3D           	dec a
 190++9268 F8           	ret m
 191++9269 3C           	inc a
 192++926A BF           	cp a
 193++926B C9           	ret
 194++926C
 195++926C
 196++926C
 197++926C
 198++926C
 199++926C
 200++926C
 201++926C
 202++926C              MUTE:
 203++926C 3E C9                        ld a,$C9			;ret	;stop playing
 204++926E 32 7A 92                     ld (vgm_play_var),a
 205++9271 3A 66 92     		ld a,(devicemask)
 206++9274 E6 08        		and DEVICE_MOONSOUND_MASK
 207++9276 C4 D6 8D     		call nz,opl4mute
 208++9279 C9                           ret
 209++927A
 210++927A
 211++927A
 212++927A
 213++927A
 214++927A
 215++927A
 216++927A              PLAY:
 217++927A              ;out: zf=0 if still playing, zf=1 otherwise
 218++927A              ;waittimercallback=$+1
 219++927A              ;	call 0
 220++927A
 221++927A              vgm_play_var = $
 221++927A 00             nop		;nop - play
 222++927B 3E 00                ld a,0                          ;(memorystreamcurrentpage)
 223++927D              memorystreamcurrentpage equ $-1
 224++927D                      IF AREA_C000_FFFF=1
 225++927D                          ;SETPGC000
 226++927D              			OS_SET_PAGE_SLOT3
 226++927D 0E 1C       >    ld c,#1c
 226++927F E7          >    rst #20
 227++9280                      ELSE
 228++9280 ~                        SETPG8000
 229++9280                      ENDIF
 230++9280              playloop
 231++9280              waitcounterlo=$+1
 232++9280 21 00 00     	ld hl,0
 233++9283              waitcounterhi=$+1
 234++9283 3E 00        	ld a,0
 235++9285              waittimerstep=$+1
 236++9285 01 00 00     	ld bc,0
 237++9288 B7 ED 42     	sub hl,bc
 238++928B 16 00        	ld d,0
 239++928D 9A           	sbc a,d
 240++928E 30 1A        	jr nc,exitplayloop
 241++9290              ;read command
 242++9290              	memory_stream_read_1 e
 242++9290 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 242++9293             >	memory_stream_read_byte e
 242++9293 CB 74       >	bit 6,h
 242++9295             >        IF AREA_C000_FFFF=1
 242++9295 CC 0D 8C    >	call z,memorystreamnextpage
 242++9298             >        ELSE
 242++9298 ~           > 	call nz,memorystreamnextpage
 242++9298             >        ENDIF
 242++9298 5E          >	ld e,(hl)
 242++9299 23          >	inc hl
 242++929A 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 243++929D 21 8E 94     	ld hl,cmdtable
 244++92A0 19           	add hl,de
 245++92A1 5E           	ld e,(hl)
 246++92A2 24           	inc h
 247++92A3 56           	ld d,(hl)
 248++92A4 21 80 92     	ld hl,playloop
 249++92A7 E5           	push hl
 250++92A8 EB           	ex hl,de
 251++92A9 E9           	jp (hl)
 252++92AA
 253++92AA              exitplayloop
 254++92AA 22 81 92     	ld (waitcounterlo),hl
 255++92AD 32 84 92     	ld (waitcounterhi),a
 256++92B0              ;continue playing
 257++92B0 F6 01        	or 1
 258++92B2 C9           	ret
 259++92B3
 260++92B3 21 81 92     wait1	ld hl,waitcounterlo
 261++92B6 34           	inc (hl)
 262++92B7 C0           	ret nz
 263++92B8 23           	inc hl
 264++92B9 34           	inc (hl)
 265++92BA C0           	ret nz
 266++92BB 21 84 92     	ld hl,waitcounterhi
 267++92BE 34           	inc (hl)
 268++92BF C9           	ret
 269++92C0
 270++92C0 3E 02        wait2	ld a,2
 271++92C2 21 81 92     waitn	ld hl,waitcounterlo
 272++92C5 86           	add a,(hl)
 273++92C6 77           	ld (hl),a
 274++92C7 D0           	ret nc
 275++92C8 23           	inc hl
 276++92C9 34           	inc (hl)
 277++92CA C0           	ret nz
 278++92CB 21 84 92     	ld hl,waitcounterhi
 279++92CE 34           	inc (hl)
 280++92CF C9           	ret
 281++92D0
 282++92D0 3E 03        wait3	ld a,3
 282++92D2 C3 C2 92       jp waitn
 283++92D5 3E 04        wait4	ld a,4
 283++92D7 C3 C2 92       jp waitn
 284++92DA 3E 05        wait5	ld a,5
 284++92DC C3 C2 92       jp waitn
 285++92DF 3E 06        wait6	ld a,6
 285++92E1 C3 C2 92       jp waitn
 286++92E4 3E 07        wait7	ld a,7
 286++92E6 C3 C2 92       jp waitn
 287++92E9 3E 08        wait8	ld a,8
 287++92EB C3 C2 92       jp waitn
 288++92EE 3E 09        wait9	ld a,9
 288++92F0 C3 C2 92       jp waitn
 289++92F3 3E 0A        wait10	ld a,10
 289++92F5 C3 C2 92       jp waitn
 290++92F8 3E 0B        wait11	ld a,11
 290++92FA C3 C2 92       jp waitn
 291++92FD 3E 0C        wait12	ld a,12
 291++92FF C3 C2 92       jp waitn
 292++9302 3E 0D        wait13	ld a,13
 292++9304 C3 C2 92       jp waitn
 293++9307 3E 0E        wait14	ld a,14
 293++9309 C3 C2 92       jp waitn
 294++930C 3E 0F        wait15	ld a,15
 294++930E C3 C2 92       jp waitn
 295++9311 3E 10        wait16	ld a,16
 295++9313 C3 C2 92       jp waitn
 296++9316
 297++9316 11 DF 02     wait735	ld de,735
 298++9319 2A 81 92     waitnn	ld hl,(waitcounterlo)
 299++931C 19           	add hl,de
 300++931D 22 81 92     	ld (waitcounterlo),hl
 301++9320 D0           	ret nc
 302++9321 21 84 92     	ld hl,waitcounterhi
 303++9324 34           	inc (hl)
 304++9325 C9           	ret
 305++9326
 306++9326 11 72 03     wait882	ld de,882
 307++9329 C3 19 93     	jp waitnn
 308++932C
 309++932C              waitvar	memory_stream_read_2 e,d
 309++932C 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 309++932F             >	memory_stream_read_byte e
 309++932F CB 74       >	bit 6,h
 309++9331             >        IF AREA_C000_FFFF=1
 309++9331 CC 0D 8C    >	call z,memorystreamnextpage
 309++9334             >        ELSE
 309++9334 ~           > 	call nz,memorystreamnextpage
 309++9334             >        ENDIF
 309++9334 5E          >	ld e,(hl)
 309++9335 23          >	inc hl
 309++9336             >	memory_stream_read_byte d
 309++9336 CB 74       >	bit 6,h
 309++9338             >        IF AREA_C000_FFFF=1
 309++9338 CC 0D 8C    >	call z,memorystreamnextpage
 309++933B             >        ELSE
 309++933B ~           > 	call nz,memorystreamnextpage
 309++933B             >        ENDIF
 309++933B 56          >	ld d,(hl)
 309++933C 23          >	inc hl
 309++933D 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 310++9340 2A 81 92     	ld hl,(waitcounterlo)
 311++9343 19           	add hl,de
 312++9344 22 81 92     	ld (waitcounterlo),hl
 313++9347 D0           	ret nc
 314++9348 21 84 92     	ld hl,waitcounterhi
 315++934B 34           	inc (hl)
 316++934C C9           	ret
 317++934D
 318++934D              	macro skip_n n
 319++934D ~            	ld b,n
 320++934D ~            	jp memorystreamskip
 321++934D              	endm
 322++934D
 323++934D C9           skip1	ret
 324++934E              skip2	skip_n 1
 324++934E 06 01       >	ld b,1
 324++9350 C3 23 8C    >	jp memorystreamskip
 325++9353              skip3	skip_n 2
 325++9353 06 02       >	ld b,2
 325++9355 C3 23 8C    >	jp memorystreamskip
 326++9358              skip4	skip_n 3
 326++9358 06 03       >	ld b,3
 326++935A C3 23 8C    >	jp memorystreamskip
 327++935D              skip5	skip_n 4
 327++935D 06 04       >	ld b,4
 327++935F C3 23 8C    >	jp memorystreamskip
 328++9362              skip6	skip_n 5
 328++9362 06 05       >	ld b,5
 328++9364 C3 23 8C    >	jp memorystreamskip
 329++9367              skip11	skip_n 10
 329++9367 06 0A       >	ld b,10
 329++9369 C3 23 8C    >	jp memorystreamskip
 330++936C              skip12	skip_n 11
 330++936C 06 0B       >	ld b,11
 330++936E C3 23 8C    >	jp memorystreamskip
 331++9371
 332++9371
 333++9371              endofsounddata
 334++9371                    ;  jp seektoloop ;здесь зацикливание, повтор
 335++9371 CD F2 8A     	  call PLR_MUTE ;выключить звук
 336++9374              cmdunsupported
 337++9374              ;stop playing
 338++9374 F1           	pop af
 339++9375 AF           	xor a
 340++9376 C9           	ret
 341++9377
 342++9377              cmdYM2203
 343++9377              	memory_stream_read_2 e,d
 343++9377 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 343++937A             >	memory_stream_read_byte e
 343++937A CB 74       >	bit 6,h
 343++937C             >        IF AREA_C000_FFFF=1
 343++937C CC 0D 8C    >	call z,memorystreamnextpage
 343++937F             >        ELSE
 343++937F ~           > 	call nz,memorystreamnextpage
 343++937F             >        ENDIF
 343++937F 5E          >	ld e,(hl)
 343++9380 23          >	inc hl
 343++9381             >	memory_stream_read_byte d
 343++9381 CB 74       >	bit 6,h
 343++9383             >        IF AREA_C000_FFFF=1
 343++9383 CC 0D 8C    >	call z,memorystreamnextpage
 343++9386             >        ELSE
 343++9386 ~           > 	call nz,memorystreamnextpage
 343++9386             >        ENDIF
 343++9386 56          >	ld d,(hl)
 343++9387 23          >	inc hl
 343++9388 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 344++938B C3 25 91     	jp opnwritemusiconlyfm1
 345++938E
 346++938E              cmdYM2203dp
 347++938E              	memory_stream_read_2 e,d
 347++938E 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 347++9391             >	memory_stream_read_byte e
 347++9391 CB 74       >	bit 6,h
 347++9393             >        IF AREA_C000_FFFF=1
 347++9393 CC 0D 8C    >	call z,memorystreamnextpage
 347++9396             >        ELSE
 347++9396 ~           > 	call nz,memorystreamnextpage
 347++9396             >        ENDIF
 347++9396 5E          >	ld e,(hl)
 347++9397 23          >	inc hl
 347++9398             >	memory_stream_read_byte d
 347++9398 CB 74       >	bit 6,h
 347++939A             >        IF AREA_C000_FFFF=1
 347++939A CC 0D 8C    >	call z,memorystreamnextpage
 347++939D             >        ELSE
 347++939D ~           > 	call nz,memorystreamnextpage
 347++939D             >        ENDIF
 347++939D 56          >	ld d,(hl)
 347++939E 23          >	inc hl
 347++939F 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 348++93A2 C3 39 91     	jp opnwritemusiconlyfm2
 349++93A5
 350++93A5              cmdYMF278B
 351++93A5              	memory_stream_read_3 c,e,d
 351++93A5 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 351++93A8             >	memory_stream_read_byte c
 351++93A8 CB 74       >	bit 6,h
 351++93AA             >        IF AREA_C000_FFFF=1
 351++93AA CC 0D 8C    >	call z,memorystreamnextpage
 351++93AD             >        ELSE
 351++93AD ~           > 	call nz,memorystreamnextpage
 351++93AD             >        ENDIF
 351++93AD 4E          >	ld c,(hl)
 351++93AE 23          >	inc hl
 351++93AF             >	memory_stream_read_byte e
 351++93AF CB 74       >	bit 6,h
 351++93B1             >        IF AREA_C000_FFFF=1
 351++93B1 CC 0D 8C    >	call z,memorystreamnextpage
 351++93B4             >        ELSE
 351++93B4 ~           > 	call nz,memorystreamnextpage
 351++93B4             >        ENDIF
 351++93B4 5E          >	ld e,(hl)
 351++93B5 23          >	inc hl
 351++93B6             >	memory_stream_read_byte d
 351++93B6 CB 74       >	bit 6,h
 351++93B8             >        IF AREA_C000_FFFF=1
 351++93B8 CC 0D 8C    >	call z,memorystreamnextpage
 351++93BB             >        ELSE
 351++93BB ~           > 	call nz,memorystreamnextpage
 351++93BB             >        ENDIF
 351++93BB 56          >	ld d,(hl)
 351++93BC 23          >	inc hl
 351++93BD 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 352++93C0 0D           	dec c
 353++93C1 CA 3D 8F     	jp z,opl4writemusiconlyfm2
 354++93C4 F2 47 8F     	jp p,opl4writewavemusiconly
 355++93C7 C3 31 8F     	jp opl4writemusiconlyfm1
 356++93CA
 357++93CA              cmdYMF262p0
 358++93CA              cmdYM3812
 359++93CA              cmdY8950
 360++93CA              cmdYM3526
 361++93CA              	memory_stream_read_2 e,d
 361++93CA 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 361++93CD             >	memory_stream_read_byte e
 361++93CD CB 74       >	bit 6,h
 361++93CF             >        IF AREA_C000_FFFF=1
 361++93CF CC 0D 8C    >	call z,memorystreamnextpage
 361++93D2             >        ELSE
 361++93D2 ~           > 	call nz,memorystreamnextpage
 361++93D2             >        ENDIF
 361++93D2 5E          >	ld e,(hl)
 361++93D3 23          >	inc hl
 361++93D4             >	memory_stream_read_byte d
 361++93D4 CB 74       >	bit 6,h
 361++93D6             >        IF AREA_C000_FFFF=1
 361++93D6 CC 0D 8C    >	call z,memorystreamnextpage
 361++93D9             >        ELSE
 361++93D9 ~           > 	call nz,memorystreamnextpage
 361++93D9             >        ENDIF
 361++93D9 56          >	ld d,(hl)
 361++93DA 23          >	inc hl
 361++93DB 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 362++93DE C3 31 8F     	jp opl4writemusiconlyfm1
 363++93E1
 364++93E1              cmdYMF262p1
 365++93E1              cmdYM3812dp
 366++93E1              cmdY8950dp
 367++93E1              cmdYM3526dp
 368++93E1              	memory_stream_read_2 e,d
 368++93E1 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 368++93E4             >	memory_stream_read_byte e
 368++93E4 CB 74       >	bit 6,h
 368++93E6             >        IF AREA_C000_FFFF=1
 368++93E6 CC 0D 8C    >	call z,memorystreamnextpage
 368++93E9             >        ELSE
 368++93E9 ~           > 	call nz,memorystreamnextpage
 368++93E9             >        ENDIF
 368++93E9 5E          >	ld e,(hl)
 368++93EA 23          >	inc hl
 368++93EB             >	memory_stream_read_byte d
 368++93EB CB 74       >	bit 6,h
 368++93ED             >        IF AREA_C000_FFFF=1
 368++93ED CC 0D 8C    >	call z,memorystreamnextpage
 368++93F0             >        ELSE
 368++93F0 ~           > 	call nz,memorystreamnextpage
 368++93F0             >        ENDIF
 368++93F0 56          >	ld d,(hl)
 368++93F1 23          >	inc hl
 368++93F2 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 369++93F5 C3 3D 8F     	jp opl4writemusiconlyfm2
 370++93F8
 371++93F8              cmdYM2151
 372++93F8              	memory_stream_read_2 e,d
 372++93F8 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 372++93FB             >	memory_stream_read_byte e
 372++93FB CB 74       >	bit 6,h
 372++93FD             >        IF AREA_C000_FFFF=1
 372++93FD CC 0D 8C    >	call z,memorystreamnextpage
 372++9400             >        ELSE
 372++9400 ~           > 	call nz,memorystreamnextpage
 372++9400             >        ENDIF
 372++9400 5E          >	ld e,(hl)
 372++9401 23          >	inc hl
 372++9402             >	memory_stream_read_byte d
 372++9402 CB 74       >	bit 6,h
 372++9404             >        IF AREA_C000_FFFF=1
 372++9404 CC 0D 8C    >	call z,memorystreamnextpage
 372++9407             >        ELSE
 372++9407 ~           > 	call nz,memorystreamnextpage
 372++9407             >        ENDIF
 372++9407 56          >	ld d,(hl)
 372++9408 23          >	inc hl
 372++9409 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 373++940C C3 64 91     	jp opmwritemusiconlychip0
 374++940F
 375++940F              cmdYM2151dp
 376++940F              	memory_stream_read_2 e,d
 376++940F 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 376++9412             >	memory_stream_read_byte e
 376++9412 CB 74       >	bit 6,h
 376++9414             >        IF AREA_C000_FFFF=1
 376++9414 CC 0D 8C    >	call z,memorystreamnextpage
 376++9417             >        ELSE
 376++9417 ~           > 	call nz,memorystreamnextpage
 376++9417             >        ENDIF
 376++9417 5E          >	ld e,(hl)
 376++9418 23          >	inc hl
 376++9419             >	memory_stream_read_byte d
 376++9419 CB 74       >	bit 6,h
 376++941B             >        IF AREA_C000_FFFF=1
 376++941B CC 0D 8C    >	call z,memorystreamnextpage
 376++941E             >        ELSE
 376++941E ~           > 	call nz,memorystreamnextpage
 376++941E             >        ENDIF
 376++941E 56          >	ld d,(hl)
 376++941F 23          >	inc hl
 376++9420 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 377++9423 C3 6B 91     	jp opmwritemusiconlychip1
 378++9426
 379++9426              cmdAY8910
 380++9426              	memory_stream_read_2 e,d
 380++9426 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 380++9429             >	memory_stream_read_byte e
 380++9429 CB 74       >	bit 6,h
 380++942B             >        IF AREA_C000_FFFF=1
 380++942B CC 0D 8C    >	call z,memorystreamnextpage
 380++942E             >        ELSE
 380++942E ~           > 	call nz,memorystreamnextpage
 380++942E             >        ENDIF
 380++942E 5E          >	ld e,(hl)
 380++942F 23          >	inc hl
 380++9430             >	memory_stream_read_byte d
 380++9430 CB 74       >	bit 6,h
 380++9432             >        IF AREA_C000_FFFF=1
 380++9432 CC 0D 8C    >	call z,memorystreamnextpage
 380++9435             >        ELSE
 380++9435 ~           > 	call nz,memorystreamnextpage
 380++9435             >        ENDIF
 380++9435 56          >	ld d,(hl)
 380++9436 23          >	inc hl
 380++9437 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 381++943A CB 7B        	bit 7,e
 382++943C CA 87 91     	jp z,ssgwritemusiconlychip0
 383++943F CB BB        	res 7,e
 384++9441 C3 9A 91     	jp ssgwritemusiconlychip1
 385++9444
 386++9444              cmdYMF262dp0 equ memorystreamread2
 387++9444              cmdYMF262dp1 equ memorystreamread2
 388++9444
 389++9444              cmddatablock
 390++9444              	memory_stream_read_2 a,e ;a = 0x66 guard, e = type
 390++9444 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 390++9447             >	memory_stream_read_byte a
 390++9447 CB 74       >	bit 6,h
 390++9449             >        IF AREA_C000_FFFF=1
 390++9449 CC 0D 8C    >	call z,memorystreamnextpage
 390++944C             >        ELSE
 390++944C ~           > 	call nz,memorystreamnextpage
 390++944C             >        ENDIF
 390++944C 7E          >	ld a,(hl)
 390++944D 23          >	inc hl
 390++944E             >	memory_stream_read_byte e
 390++944E CB 74       >	bit 6,h
 390++9450             >        IF AREA_C000_FFFF=1
 390++9450 CC 0D 8C    >	call z,memorystreamnextpage
 390++9453             >        ELSE
 390++9453 ~           > 	call nz,memorystreamnextpage
 390++9453             >        ENDIF
 390++9453 5E          >	ld e,(hl)
 390++9454 23          >	inc hl
 390++9455 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 391++9458 FE 66        	cp 0x66
 392++945A C2 74 93     	jp nz,cmdunsupported
 393++945D              processdatablock
 394++945D              ;e = data type
 395++945D CD 71 8C     	call memorystreamread4 ;adbc = data size
 396++9460 7B           	ld a,e
 397++9461 60 69        	ld hl,bc
 398++9463              ;	cp 0x81
 399++9463              ;	jp z,opnaloaddatablock
 400++9463 FE 84        	cp 0x84
 401++9465 CA 27 90     	jp z,opl4loadromdatablock
 402++9468 FE 87        	cp 0x87
 403++946A CA 20 90     	jp z,opl4loadramdatablock
 404++946D D5           	push de
 405++946E C5           	push bc
 406++946F CD ED 8C     	call memorystreamgetpos
 407++9472 C1           	pop bc
 408++9473 F1           	pop af
 409++9474 09           	add hl,bc
 410++9475 8B           	adc a,e
 411++9476 5F           	ld e,a
 412++9477 8A           	adc a,d
 413++9478 93           	sub e
 414++9479 57           	ld d,a
 415++947A C3 C8 8C     	jp memorystreamseek
 416++947D
 417++947D
 418++947D              seektoloop
 419++947D 01 1C 00     	ld bc,0x1c
 420++9480              loopoffsethi=$+1
 421++9480 11 00 00     	ld de,0
 422++9483              loopoffsetlo=$+1
 423++9483 21 00 00     	ld hl,0
 424++9486              seektopos
 425++9486              ;dehl + bc = position
 426++9486              ;out: hl = read address
 427++9486 09           	add hl,bc
 428++9487 D2 C8 8C     	jp nc,memorystreamseek
 429++948A 13           	inc de
 430++948B C3 C8 8C     	jp memorystreamseek
 431++948E
 432++948E
 433++948E
 434++948E
 435++948E              cmdtable
 436++948E 4D           	db skip1           %256 ; 00
 437++948F 4D           	db skip1           %256 ; 01
 438++9490 4D           	db skip1           %256 ; 02
 439++9491 4D           	db skip1           %256 ; 03
 440++9492 4D           	db skip1           %256 ; 04
 441++9493 4D           	db skip1           %256 ; 05
 442++9494 4D           	db skip1           %256 ; 06
 443++9495 4D           	db skip1           %256 ; 07
 444++9496 4D           	db skip1           %256 ; 08
 445++9497 4D           	db skip1           %256 ; 09
 446++9498 4D           	db skip1           %256 ; 0A
 447++9499 4D           	db skip1           %256 ; 0B
 448++949A 4D           	db skip1           %256 ; 0C
 449++949B 4D           	db skip1           %256 ; 0D
 450++949C 4D           	db skip1           %256 ; 0E
 451++949D 4D           	db skip1           %256 ; 0F
 452++949E 4D           	db skip1           %256 ; 10
 453++949F 4D           	db skip1           %256 ; 11
 454++94A0 4D           	db skip1           %256 ; 12
 455++94A1 4D           	db skip1           %256 ; 13
 456++94A2 4D           	db skip1           %256 ; 14
 457++94A3 4D           	db skip1           %256 ; 15
 458++94A4 4D           	db skip1           %256 ; 16
 459++94A5 4D           	db skip1           %256 ; 17
 460++94A6 4D           	db skip1           %256 ; 18
 461++94A7 4D           	db skip1           %256 ; 19
 462++94A8 4D           	db skip1           %256 ; 1A
 463++94A9 4D           	db skip1           %256 ; 1B
 464++94AA 4D           	db skip1           %256 ; 1C
 465++94AB 4D           	db skip1           %256 ; 1D
 466++94AC 4D           	db skip1           %256 ; 1E
 467++94AD 4D           	db skip1           %256 ; 1F
 468++94AE 4D           	db skip1           %256 ; 20
 469++94AF 4D           	db skip1           %256 ; 21
 470++94B0 4D           	db skip1           %256 ; 22
 471++94B1 4D           	db skip1           %256 ; 23
 472++94B2 4D           	db skip1           %256 ; 24
 473++94B3 4D           	db skip1           %256 ; 25
 474++94B4 4D           	db skip1           %256 ; 26
 475++94B5 4D           	db skip1           %256 ; 27
 476++94B6 4D           	db skip1           %256 ; 28
 477++94B7 4D           	db skip1           %256 ; 29
 478++94B8 4D           	db skip1           %256 ; 2A
 479++94B9 4D           	db skip1           %256 ; 2B
 480++94BA 4D           	db skip1           %256 ; 2C
 481++94BB 4D           	db skip1           %256 ; 2D
 482++94BC 4D           	db skip1           %256 ; 2E
 483++94BD 4D           	db skip1           %256 ; 2F
 484++94BE 74           	db cmdunsupported  %256 ; 30
 485++94BF 4E           	db skip2           %256 ; 31
 486++94C0 4E           	db skip2           %256 ; 32
 487++94C1 4E           	db skip2           %256 ; 33
 488++94C2 4E           	db skip2           %256 ; 34
 489++94C3 4E           	db skip2           %256 ; 35
 490++94C4 4E           	db skip2           %256 ; 36
 491++94C5 4E           	db skip2           %256 ; 37
 492++94C6 4E           	db skip2           %256 ; 38
 493++94C7 4E           	db skip2           %256 ; 39
 494++94C8 4E           	db skip2           %256 ; 3A
 495++94C9 4E           	db skip2           %256 ; 3B
 496++94CA 4E           	db skip2           %256 ; 3C
 497++94CB 4E           	db skip2           %256 ; 3D
 498++94CC 4E           	db skip2           %256 ; 3E
 499++94CD 4E           	db skip2           %256 ; 3F
 500++94CE 53           	db skip3           %256 ; 40
 501++94CF 53           	db skip3           %256 ; 41
 502++94D0 53           	db skip3           %256 ; 42
 503++94D1 53           	db skip3           %256 ; 43
 504++94D2 53           	db skip3           %256 ; 44
 505++94D3 53           	db skip3           %256 ; 45
 506++94D4 53           	db skip3           %256 ; 46
 507++94D5 53           	db skip3           %256 ; 47
 508++94D6 53           	db skip3           %256 ; 48
 509++94D7 53           	db skip3           %256 ; 49
 510++94D8 53           	db skip3           %256 ; 4A
 511++94D9 53           	db skip3           %256 ; 4B
 512++94DA 53           	db skip3           %256 ; 4C
 513++94DB 53           	db skip3           %256 ; 4D
 514++94DC 53           	db skip3           %256 ; 4E
 515++94DD 4E           	db skip2           %256 ; 4F
 516++94DE 74           	db cmdunsupported  %256 ; 50
 517++94DF 74           	db cmdunsupported  %256 ; 51
 518++94E0 74           	db cmdunsupported  %256 ; 52
 519++94E1 74           	db cmdunsupported  %256 ; 53
 520++94E2 F8           	db cmdYM2151       %256 ; 54
 521++94E3 77           	db cmdYM2203       %256 ; 55
 522++94E4 77           	db cmdYM2608p0     %256 ; 56
 523++94E5 8E           	db cmdYM2608p1     %256 ; 57
 524++94E6 74           	db cmdunsupported  %256 ; 58
 525++94E7 74           	db cmdunsupported  %256 ; 59
 526++94E8 CA           	db cmdYM3812       %256 ; 5A
 527++94E9 CA           	db cmdYM3526       %256 ; 5B
 528++94EA CA           	db cmdY8950        %256 ; 5C
 529++94EB 53           	db skip3           %256 ; 5D
 530++94EC CA           	db cmdYMF262p0     %256 ; 5E
 531++94ED E1           	db cmdYMF262p1     %256 ; 5F
 532++94EE 74           	db cmdunsupported  %256 ; 60
 533++94EF 2C           	db waitvar         %256 ; 61
 534++94F0 16           	db wait735         %256 ; 62
 535++94F1 26           	db wait882         %256 ; 63
 536++94F2 74           	db cmdunsupported  %256 ; 64
 537++94F3 74           	db cmdunsupported  %256 ; 65
 538++94F4 71           	db endofsounddata  %256 ; 66
 539++94F5 44           	db cmddatablock    %256 ; 67
 540++94F6 6C           	db skip12          %256 ; 68
 541++94F7 74           	db cmdunsupported  %256 ; 69
 542++94F8 74           	db cmdunsupported  %256 ; 6A
 543++94F9 74           	db cmdunsupported  %256 ; 6B
 544++94FA 74           	db cmdunsupported  %256 ; 6C
 545++94FB 74           	db cmdunsupported  %256 ; 6D
 546++94FC 74           	db cmdunsupported  %256 ; 6E
 547++94FD 74           	db cmdunsupported  %256 ; 6F
 548++94FE B3           	db wait1           %256 ; 70
 549++94FF C0           	db wait2           %256 ; 71
 550++9500 D0           	db wait3           %256 ; 72
 551++9501 D5           	db wait4           %256 ; 73
 552++9502 DA           	db wait5           %256 ; 74
 553++9503 DF           	db wait6           %256 ; 75
 554++9504 E4           	db wait7           %256 ; 76
 555++9505 E9           	db wait8           %256 ; 77
 556++9506 EE           	db wait9           %256 ; 78
 557++9507 F3           	db wait10          %256 ; 79
 558++9508 F8           	db wait11          %256 ; 7A
 559++9509 FD           	db wait12          %256 ; 7B
 560++950A 02           	db wait13          %256 ; 7C
 561++950B 07           	db wait14          %256 ; 7D
 562++950C 0C           	db wait15          %256 ; 7E
 563++950D 11           	db wait16          %256 ; 7F
 564++950E 4D           	db skip1           %256 ; 80
 565++950F B3           	db wait1           %256 ; 81
 566++9510 C0           	db wait2           %256 ; 82
 567++9511 D0           	db wait3           %256 ; 83
 568++9512 D5           	db wait4           %256 ; 84
 569++9513 DA           	db wait5           %256 ; 85
 570++9514 DF           	db wait6           %256 ; 86
 571++9515 E4           	db wait7           %256 ; 87
 572++9516 E9           	db wait8           %256 ; 88
 573++9517 EE           	db wait9           %256 ; 89
 574++9518 F3           	db wait10          %256 ; 8A
 575++9519 F8           	db wait11          %256 ; 8B
 576++951A FD           	db wait12          %256 ; 8C
 577++951B 02           	db wait13          %256 ; 8D
 578++951C 07           	db wait14          %256 ; 8E
 579++951D 0C           	db wait15          %256 ; 8F
 580++951E 5D           	db skip5           %256 ; 90
 581++951F 5D           	db skip5           %256 ; 91
 582++9520 62           	db skip6           %256 ; 92
 583++9521 67           	db skip11          %256 ; 93
 584++9522 4E           	db skip2           %256 ; 94
 585++9523 5D           	db skip5           %256 ; 95
 586++9524 74           	db cmdunsupported  %256 ; 96
 587++9525 74           	db cmdunsupported  %256 ; 97
 588++9526 74           	db cmdunsupported  %256 ; 98
 589++9527 74           	db cmdunsupported  %256 ; 99
 590++9528 74           	db cmdunsupported  %256 ; 9A
 591++9529 74           	db cmdunsupported  %256 ; 9B
 592++952A 74           	db cmdunsupported  %256 ; 9C
 593++952B 74           	db cmdunsupported  %256 ; 9D
 594++952C 74           	db cmdunsupported  %256 ; 9E
 595++952D 74           	db cmdunsupported  %256 ; 9F
 596++952E 26           	db cmdAY8910       %256 ; A0
 597++952F 53           	db skip3           %256 ; A1
 598++9530 74           	db cmdunsupported  %256 ; A2
 599++9531 74           	db cmdunsupported  %256 ; A3
 600++9532 0F           	db cmdYM2151dp     %256 ; A4
 601++9533 8E           	db cmdYM2203dp     %256 ; A5
 602++9534 53           	db skip3           %256 ; A6
 603++9535 53           	db skip3           %256 ; A7
 604++9536 53           	db skip3           %256 ; A8
 605++9537 53           	db skip3           %256 ; A9
 606++9538 E1           	db cmdYM3812dp     %256 ; AA
 607++9539 E1           	db cmdYM3526dp     %256 ; AB
 608++953A E1           	db cmdY8950dp      %256 ; AC
 609++953B 53           	db skip3           %256 ; AD
 610++953C 40           	db cmdYMF262dp0    %256 ; AE
 611++953D 40           	db cmdYMF262dp0    %256 ; AF
 612++953E 53           	db skip3           %256 ; B0
 613++953F 53           	db skip3           %256 ; B1
 614++9540 53           	db skip3           %256 ; B2
 615++9541 53           	db skip3           %256 ; B3
 616++9542 53           	db skip3           %256 ; B4
 617++9543 53           	db skip3           %256 ; B5
 618++9544 53           	db skip3           %256 ; B6
 619++9545 53           	db skip3           %256 ; B7
 620++9546 53           	db skip3           %256 ; B8
 621++9547 53           	db skip3           %256 ; B9
 622++9548 53           	db skip3           %256 ; BA
 623++9549 53           	db skip3           %256 ; BB
 624++954A 53           	db skip3           %256 ; BC
 625++954B 53           	db skip3           %256 ; BD
 626++954C 53           	db skip3           %256 ; BE
 627++954D 53           	db skip3           %256 ; BF
 628++954E 58           	db skip4           %256 ; C0
 629++954F 58           	db skip4           %256 ; C1
 630++9550 58           	db skip4           %256 ; C2
 631++9551 58           	db skip4           %256 ; C3
 632++9552 58           	db skip4           %256 ; C4
 633++9553 58           	db skip4           %256 ; C5
 634++9554 58           	db skip4           %256 ; C6
 635++9555 58           	db skip4           %256 ; C7
 636++9556 58           	db skip4           %256 ; C8
 637++9557 58           	db skip4           %256 ; C9
 638++9558 58           	db skip4           %256 ; CA
 639++9559 58           	db skip4           %256 ; CB
 640++955A 58           	db skip4           %256 ; CC
 641++955B 58           	db skip4           %256 ; CD
 642++955C 58           	db skip4           %256 ; CE
 643++955D 58           	db skip4           %256 ; CF
 644++955E A5           	db cmdYMF278B      %256 ; D0
 645++955F 58           	db skip4           %256 ; D1
 646++9560 74           	db cmdunsupported  %256 ; D2
 647++9561 58           	db skip4           %256 ; D3
 648++9562 58           	db skip4           %256 ; D4
 649++9563 58           	db skip4           %256 ; D5
 650++9564 58           	db skip4           %256 ; D6
 651++9565 58           	db skip4           %256 ; D7
 652++9566 58           	db skip4           %256 ; D8
 653++9567 58           	db skip4           %256 ; D9
 654++9568 58           	db skip4           %256 ; DA
 655++9569 58           	db skip4           %256 ; DB
 656++956A 58           	db skip4           %256 ; DC
 657++956B 58           	db skip4           %256 ; DD
 658++956C 58           	db skip4           %256 ; DE
 659++956D 58           	db skip4           %256 ; DF
 660++956E 74           	db cmdunsupported  %256 ; E0
 661++956F 5D           	db skip5           %256 ; E1
 662++9570 5D           	db skip5           %256 ; E2
 663++9571 5D           	db skip5           %256 ; E3
 664++9572 5D           	db skip5           %256 ; E4
 665++9573 5D           	db skip5           %256 ; E5
 666++9574 5D           	db skip5           %256 ; E6
 667++9575 5D           	db skip5           %256 ; E7
 668++9576 5D           	db skip5           %256 ; E8
 669++9577 5D           	db skip5           %256 ; E9
 670++9578 5D           	db skip5           %256 ; EA
 671++9579 5D           	db skip5           %256 ; EB
 672++957A 5D           	db skip5           %256 ; EC
 673++957B 5D           	db skip5           %256 ; ED
 674++957C 5D           	db skip5           %256 ; EE
 675++957D 5D           	db skip5           %256 ; EF
 676++957E 5D           	db skip5           %256 ; F0
 677++957F 5D           	db skip5           %256 ; F1
 678++9580 5D           	db skip5           %256 ; F2
 679++9581 5D           	db skip5           %256 ; F3
 680++9582 5D           	db skip5           %256 ; F4
 681++9583 5D           	db skip5           %256 ; F5
 682++9584 5D           	db skip5           %256 ; F6
 683++9585 5D           	db skip5           %256 ; F7
 684++9586 5D           	db skip5           %256 ; F8
 685++9587 5D           	db skip5           %256 ; F9
 686++9588 5D           	db skip5           %256 ; FA
 687++9589 5D           	db skip5           %256 ; FB
 688++958A 5D           	db skip5           %256 ; FC
 689++958B 5D           	db skip5           %256 ; FD
 690++958C 5D           	db skip5           %256 ; FE
 691++958D 5D           	db skip5           %256 ; FF
 692++958E 93           	db skip1           /256 ; 00
 693++958F 93           	db skip1           /256 ; 01
 694++9590 93           	db skip1           /256 ; 02
 695++9591 93           	db skip1           /256 ; 03
 696++9592 93           	db skip1           /256 ; 04
 697++9593 93           	db skip1           /256 ; 05
 698++9594 93           	db skip1           /256 ; 06
 699++9595 93           	db skip1           /256 ; 07
 700++9596 93           	db skip1           /256 ; 08
 701++9597 93           	db skip1           /256 ; 09
 702++9598 93           	db skip1           /256 ; 0A
 703++9599 93           	db skip1           /256 ; 0B
 704++959A 93           	db skip1           /256 ; 0C
 705++959B 93           	db skip1           /256 ; 0D
 706++959C 93           	db skip1           /256 ; 0E
 707++959D 93           	db skip1           /256 ; 0F
 708++959E 93           	db skip1           /256 ; 10
 709++959F 93           	db skip1           /256 ; 11
 710++95A0 93           	db skip1           /256 ; 12
 711++95A1 93           	db skip1           /256 ; 13
 712++95A2 93           	db skip1           /256 ; 14
 713++95A3 93           	db skip1           /256 ; 15
 714++95A4 93           	db skip1           /256 ; 16
 715++95A5 93           	db skip1           /256 ; 17
 716++95A6 93           	db skip1           /256 ; 18
 717++95A7 93           	db skip1           /256 ; 19
 718++95A8 93           	db skip1           /256 ; 1A
 719++95A9 93           	db skip1           /256 ; 1B
 720++95AA 93           	db skip1           /256 ; 1C
 721++95AB 93           	db skip1           /256 ; 1D
 722++95AC 93           	db skip1           /256 ; 1E
 723++95AD 93           	db skip1           /256 ; 1F
 724++95AE 93           	db skip1           /256 ; 20
 725++95AF 93           	db skip1           /256 ; 21
 726++95B0 93           	db skip1           /256 ; 22
 727++95B1 93           	db skip1           /256 ; 23
 728++95B2 93           	db skip1           /256 ; 24
 729++95B3 93           	db skip1           /256 ; 25
 730++95B4 93           	db skip1           /256 ; 26
 731++95B5 93           	db skip1           /256 ; 27
 732++95B6 93           	db skip1           /256 ; 28
 733++95B7 93           	db skip1           /256 ; 29
 734++95B8 93           	db skip1           /256 ; 2A
 735++95B9 93           	db skip1           /256 ; 2B
 736++95BA 93           	db skip1           /256 ; 2C
 737++95BB 93           	db skip1           /256 ; 2D
 738++95BC 93           	db skip1           /256 ; 2E
 739++95BD 93           	db skip1           /256 ; 2F
 740++95BE 93           	db cmdunsupported  /256 ; 30
 741++95BF 93           	db skip2           /256 ; 31
 742++95C0 93           	db skip2           /256 ; 32
 743++95C1 93           	db skip2           /256 ; 33
 744++95C2 93           	db skip2           /256 ; 34
 745++95C3 93           	db skip2           /256 ; 35
 746++95C4 93           	db skip2           /256 ; 36
 747++95C5 93           	db skip2           /256 ; 37
 748++95C6 93           	db skip2           /256 ; 38
 749++95C7 93           	db skip2           /256 ; 39
 750++95C8 93           	db skip2           /256 ; 3A
 751++95C9 93           	db skip2           /256 ; 3B
 752++95CA 93           	db skip2           /256 ; 3C
 753++95CB 93           	db skip2           /256 ; 3D
 754++95CC 93           	db skip2           /256 ; 3E
 755++95CD 93           	db skip2           /256 ; 3F
 756++95CE 93           	db skip3           /256 ; 40
 757++95CF 93           	db skip3           /256 ; 41
 758++95D0 93           	db skip3           /256 ; 42
 759++95D1 93           	db skip3           /256 ; 43
 760++95D2 93           	db skip3           /256 ; 44
 761++95D3 93           	db skip3           /256 ; 45
 762++95D4 93           	db skip3           /256 ; 46
 763++95D5 93           	db skip3           /256 ; 47
 764++95D6 93           	db skip3           /256 ; 48
 765++95D7 93           	db skip3           /256 ; 49
 766++95D8 93           	db skip3           /256 ; 4A
 767++95D9 93           	db skip3           /256 ; 4B
 768++95DA 93           	db skip3           /256 ; 4C
 769++95DB 93           	db skip3           /256 ; 4D
 770++95DC 93           	db skip3           /256 ; 4E
 771++95DD 93           	db skip2           /256 ; 4F
 772++95DE 93           	db cmdunsupported  /256 ; 50
 773++95DF 93           	db cmdunsupported  /256 ; 51
 774++95E0 93           	db cmdunsupported  /256 ; 52
 775++95E1 93           	db cmdunsupported  /256 ; 53
 776++95E2 93           	db cmdYM2151       /256 ; 54
 777++95E3 93           	db cmdYM2203       /256 ; 55
 778++95E4 93           	db cmdYM2608p0     /256 ; 56
 779++95E5 96           	db cmdYM2608p1     /256 ; 57
 780++95E6 93           	db cmdunsupported  /256 ; 58
 781++95E7 93           	db cmdunsupported  /256 ; 59
 782++95E8 93           	db cmdYM3812       /256 ; 5A
 783++95E9 93           	db cmdYM3526       /256 ; 5B
 784++95EA 93           	db cmdY8950        /256 ; 5C
 785++95EB 93           	db skip3           /256 ; 5D
 786++95EC 93           	db cmdYMF262p0     /256 ; 5E
 787++95ED 93           	db cmdYMF262p1     /256 ; 5F
 788++95EE 93           	db cmdunsupported  /256 ; 60
 789++95EF 93           	db waitvar         /256 ; 61
 790++95F0 93           	db wait735         /256 ; 62
 791++95F1 93           	db wait882         /256 ; 63
 792++95F2 93           	db cmdunsupported  /256 ; 64
 793++95F3 93           	db cmdunsupported  /256 ; 65
 794++95F4 93           	db endofsounddata  /256 ; 66
 795++95F5 94           	db cmddatablock    /256 ; 67
 796++95F6 93           	db skip12          /256 ; 68
 797++95F7 93           	db cmdunsupported  /256 ; 69
 798++95F8 93           	db cmdunsupported  /256 ; 6A
 799++95F9 93           	db cmdunsupported  /256 ; 6B
 800++95FA 93           	db cmdunsupported  /256 ; 6C
 801++95FB 93           	db cmdunsupported  /256 ; 6D
 802++95FC 93           	db cmdunsupported  /256 ; 6E
 803++95FD 93           	db cmdunsupported  /256 ; 6F
 804++95FE 92           	db wait1           /256 ; 70
 805++95FF 92           	db wait2           /256 ; 71
 806++9600 92           	db wait3           /256 ; 72
 807++9601 92           	db wait4           /256 ; 73
 808++9602 92           	db wait5           /256 ; 74
 809++9603 92           	db wait6           /256 ; 75
 810++9604 92           	db wait7           /256 ; 76
 811++9605 92           	db wait8           /256 ; 77
 812++9606 92           	db wait9           /256 ; 78
 813++9607 92           	db wait10          /256 ; 79
 814++9608 92           	db wait11          /256 ; 7A
 815++9609 92           	db wait12          /256 ; 7B
 816++960A 93           	db wait13          /256 ; 7C
 817++960B 93           	db wait14          /256 ; 7D
 818++960C 93           	db wait15          /256 ; 7E
 819++960D 93           	db wait16          /256 ; 7F
 820++960E 93           	db skip1           /256 ; 80
 821++960F 92           	db wait1           /256 ; 81
 822++9610 92           	db wait2           /256 ; 82
 823++9611 92           	db wait3           /256 ; 83
 824++9612 92           	db wait4           /256 ; 84
 825++9613 92           	db wait5           /256 ; 85
 826++9614 92           	db wait6           /256 ; 86
 827++9615 92           	db wait7           /256 ; 87
 828++9616 92           	db wait8           /256 ; 88
 829++9617 92           	db wait9           /256 ; 89
 830++9618 92           	db wait10          /256 ; 8A
 831++9619 92           	db wait11          /256 ; 8B
 832++961A 92           	db wait12          /256 ; 8C
 833++961B 93           	db wait13          /256 ; 8D
 834++961C 93           	db wait14          /256 ; 8E
 835++961D 93           	db wait15          /256 ; 8F
 836++961E 93           	db skip5           /256 ; 90
 837++961F 93           	db skip5           /256 ; 91
 838++9620 93           	db skip6           /256 ; 92
 839++9621 93           	db skip11          /256 ; 93
 840++9622 93           	db skip2           /256 ; 94
 841++9623 93           	db skip5           /256 ; 95
 842++9624 93           	db cmdunsupported  /256 ; 96
 843++9625 93           	db cmdunsupported  /256 ; 97
 844++9626 93           	db cmdunsupported  /256 ; 98
 845++9627 93           	db cmdunsupported  /256 ; 99
 846++9628 93           	db cmdunsupported  /256 ; 9A
 847++9629 93           	db cmdunsupported  /256 ; 9B
 848++962A 93           	db cmdunsupported  /256 ; 9C
 849++962B 93           	db cmdunsupported  /256 ; 9D
 850++962C 93           	db cmdunsupported  /256 ; 9E
 851++962D 93           	db cmdunsupported  /256 ; 9F
 852++962E 94           	db cmdAY8910       /256 ; A0
 853++962F 93           	db skip3           /256 ; A1
 854++9630 93           	db cmdunsupported  /256 ; A2
 855++9631 93           	db cmdunsupported  /256 ; A3
 856++9632 94           	db cmdYM2151dp     /256 ; A4
 857++9633 93           	db cmdYM2203dp     /256 ; A5
 858++9634 93           	db skip3           /256 ; A6
 859++9635 93           	db skip3           /256 ; A7
 860++9636 93           	db skip3           /256 ; A8
 861++9637 93           	db skip3           /256 ; A9
 862++9638 93           	db cmdYM3812dp     /256 ; AA
 863++9639 93           	db cmdYM3526dp     /256 ; AB
 864++963A 93           	db cmdY8950dp      /256 ; AC
 865++963B 93           	db skip3           /256 ; AD
 866++963C 8C           	db cmdYMF262dp0    /256 ; AE
 867++963D 8C           	db cmdYMF262dp0    /256 ; AF
 868++963E 93           	db skip3           /256 ; B0
 869++963F 93           	db skip3           /256 ; B1
 870++9640 93           	db skip3           /256 ; B2
 871++9641 93           	db skip3           /256 ; B3
 872++9642 93           	db skip3           /256 ; B4
 873++9643 93           	db skip3           /256 ; B5
 874++9644 93           	db skip3           /256 ; B6
 875++9645 93           	db skip3           /256 ; B7
 876++9646 93           	db skip3           /256 ; B8
 877++9647 93           	db skip3           /256 ; B9
 878++9648 93           	db skip3           /256 ; BA
 879++9649 93           	db skip3           /256 ; BB
 880++964A 93           	db skip3           /256 ; BC
 881++964B 93           	db skip3           /256 ; BD
 882++964C 93           	db skip3           /256 ; BE
 883++964D 93           	db skip3           /256 ; BF
 884++964E 93           	db skip4           /256 ; C0
 885++964F 93           	db skip4           /256 ; C1
 886++9650 93           	db skip4           /256 ; C2
 887++9651 93           	db skip4           /256 ; C3
 888++9652 93           	db skip4           /256 ; C4
 889++9653 93           	db skip4           /256 ; C5
 890++9654 93           	db skip4           /256 ; C6
 891++9655 93           	db skip4           /256 ; C7
 892++9656 93           	db skip4           /256 ; C8
 893++9657 93           	db skip4           /256 ; C9
 894++9658 93           	db skip4           /256 ; CA
 895++9659 93           	db skip4           /256 ; CB
 896++965A 93           	db skip4           /256 ; CC
 897++965B 93           	db skip4           /256 ; CD
 898++965C 93           	db skip4           /256 ; CE
 899++965D 93           	db skip4           /256 ; CF
 900++965E 93           	db cmdYMF278B      /256 ; D0
 901++965F 93           	db skip4           /256 ; D1
 902++9660 93           	db cmdunsupported  /256 ; D2
 903++9661 93           	db skip4           /256 ; D3
 904++9662 93           	db skip4           /256 ; D4
 905++9663 93           	db skip4           /256 ; D5
 906++9664 93           	db skip4           /256 ; D6
 907++9665 93           	db skip4           /256 ; D7
 908++9666 93           	db skip4           /256 ; D8
 909++9667 93           	db skip4           /256 ; D9
 910++9668 93           	db skip4           /256 ; DA
 911++9669 93           	db skip4           /256 ; DB
 912++966A 93           	db skip4           /256 ; DC
 913++966B 93           	db skip4           /256 ; DD
 914++966C 93           	db skip4           /256 ; DE
 915++966D 93           	db skip4           /256 ; DF
 916++966E 93           	db cmdunsupported  /256 ; E0
 917++966F 93           	db skip5           /256 ; E1
 918++9670 93           	db skip5           /256 ; E2
 919++9671 93           	db skip5           /256 ; E3
 920++9672 93           	db skip5           /256 ; E4
 921++9673 93           	db skip5           /256 ; E5
 922++9674 93           	db skip5           /256 ; E6
 923++9675 93           	db skip5           /256 ; E7
 924++9676 93           	db skip5           /256 ; E8
 925++9677 93           	db skip5           /256 ; E9
 926++9678 93           	db skip5           /256 ; EA
 927++9679 93           	db skip5           /256 ; EB
 928++967A 93           	db skip5           /256 ; EC
 929++967B 93           	db skip5           /256 ; ED
 930++967C 93           	db skip5           /256 ; EE
 931++967D 93           	db skip5           /256 ; EF
 932++967E 93           	db skip5           /256 ; F0
 933++967F 93           	db skip5           /256 ; F1
 934++9680 93           	db skip5           /256 ; F2
 935++9681 93           	db skip5           /256 ; F3
 936++9682 93           	db skip5           /256 ; F4
 937++9683 93           	db skip5           /256 ; F5
 938++9684 93           	db skip5           /256 ; F6
 939++9685 93           	db skip5           /256 ; F7
 940++9686 93           	db skip5           /256 ; F8
 941++9687 93           	db skip5           /256 ; F9
 942++9688 93           	db skip5           /256 ; FA
 943++9689 93           	db skip5           /256 ; FB
 944++968A 93           	db skip5           /256 ; FC
 945++968B 93           	db skip5           /256 ; FD
 946++968C 93           	db skip5           /256 ; FE
 947++968D 93           	db skip5           /256 ; FF
 948++968E
 949++968E
 950++968E
 951++968E              cmdYM2608p0 equ cmdYM2203
 952++968E
 953++968E              cmdYM2608p1
 954++968E              	memory_stream_read_2 e,d
 954++968E 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 954++9691             >	memory_stream_read_byte e
 954++9691 CB 74       >	bit 6,h
 954++9693             >        IF AREA_C000_FFFF=1
 954++9693 CC 0D 8C    >	call z,memorystreamnextpage
 954++9696             >        ELSE
 954++9696 ~           > 	call nz,memorystreamnextpage
 954++9696             >        ENDIF
 954++9696 5E          >	ld e,(hl)
 954++9697 23          >	inc hl
 954++9698             >	memory_stream_read_byte d
 954++9698 CB 74       >	bit 6,h
 954++969A             >        IF AREA_C000_FFFF=1
 954++969A CC 0D 8C    >	call z,memorystreamnextpage
 954++969D             >        ELSE
 954++969D ~           > 	call nz,memorystreamnextpage
 954++969D             >        ENDIF
 954++969D 56          >	ld d,(hl)
 954++969E 23          >	inc hl
 954++969F 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 955++96A2 7B           	ld a,e
 956++96A3 FE 30        	cp 0x30
 957++96A5 D8           	ret c
 958++96A6 C3 A0 90     	jp opnwritefm2
 959++96A9
 960++96A9
 961++96A9              initAY8910
 962++96A9 CD AD 91     	call ssginit
 963++96AC 21 66 92     	ld hl,devicemask
 964++96AF 3A 77 BE     	ld a,(HEADER_CLOCK_AY8910+3)
 965++96B2 E6 40        	and 0x40
 966++96B4 20 03        	jr nz,.dualchip
 967++96B6 CB C6        	set DEVICE_AY_BIT,(hl)
 968++96B8 C9           	ret
 969++96B9              .dualchip
 970++96B9 CB CE        	set DEVICE_TURBOSOUND_BIT,(hl)
 971++96BB C9           	ret
 972++96BC
 973++96BC              initYM2203
 974++96BC              tfmstatus=$+1
 975++96BC 3E 01        	ld a,1
 976++96BE 3D           	dec a
 977++96BF F8           	ret m
 978++96C0 CD AB 90     	call opninit
 979++96C3              	set_timer opnwaittimer60hz,735
 979++96C3 21 DF 02    >	ld hl,735
 979++96C6 22 86 92    >	ld (waittimerstep),hl
 980++96C9 CD 41 91     	call opninittimer60hz
 981++96CC 21 66 92     	ld hl,devicemask
 982++96CF CB D6        	set DEVICE_TFM_BIT,(hl)
 983++96D1 AF           	xor a
 984++96D2 C9           	ret
 985++96D3
 986++96D3              initYMF278B
 987++96D3              moonsoundstatus=$+1
 988++96D3 3E 02        	ld a,2
 989++96D5 3D           	dec a
 990++96D6 F8           	ret m
 991++96D7 CD 6D 8F     	call vgmopl4init
 992++96DA 3A 53 BE     	ld a,(HEADER_CLOCK_YM3812+3)
 993++96DD E6 40        	and 0x40
 994++96DF 20 08        	jr nz,notOPL2
 995++96E1              useYM3812=$+1
 996++96E1 F6 00        	or 0
 997++96E3 11 05 00     	ld de,0x0005
 998++96E6 C4 33 8D     	call nz,opl4writefm2
 999++96E9              notOPL2
1000++96E9 CD 64 90     	call opl4inittimer60hz
1001++96EC 21 66 92     	ld hl,devicemask
1002++96EF CB DE        	set DEVICE_MOONSOUND_BIT,(hl)
1003++96F1 AF           	xor a
1004++96F2 C9           	ret
1005++96F3
1006++96F3              end
1007++96F3
1008++96F3
1009++96F3
1010++96F3              ;        LABELSLIST "vgm_plr.l"
1011++96F3              ;	savebin "gplay.apg",begin,end-begin
# file closed: GPlay/vgm_plr.asm
 276+ 96F3              	include sub_func.asm
# file opened: GPlay/sub_func.asm
   1++96F3
   2++96F3              fileopenerror
   3++96F3 79           		ld a,c
   4++96F4 0E FF        		ld c,$FF
   5++96F6 02                   ld (bc),a ;   
   6++96F7
   7++96F7 21 BF 8A     		ld hl,txt_fopenerror
   8++96FA              		OS_PRINTZ
   8++96FA 0E 09       >    ld c,#09
   8++96FC E7          >    rst #20
   9++96FD
  10++96FD 3A BD 99     		ld a,(file_id_cur_r)
  11++9700 FE FF        		cp 255
  12++9702 28 03        		jr z,fileopenerror1
  13++9704              		OS_FILE_CLOSE ;A - id file
  13++9704 0E 25       >    ld c,#25
  13++9706 E7          >    rst #20
  14++9707              fileopenerror1
  15++9707 37           		scf ;
  16++9708 C9           		ret
  17++9709
  18++9709
  19++9709              ; memoryerror
  20++9709                      ; OS_CLOSEHANDLE
  21++9709                      ; ld e,6+0x80
  22++9709                      ; OS_SETGFX
  23++9709                      ; ld e,0
  24++9709                      ; OS_CLS
  25++9709                      ; ld hl,txt_memoryerror
  26++9709                      ; call print_hl
  27++9709                      ; YIELDGETKEYLOOP
  28++9709                      ; jp cmd_quit
  29++9709
  30++9709              memoryerror
  31++9709 79           		ld a,c
  32++970A 0E FF        		ld c,$FF
  33++970C 02                   ld (bc),a ;   
  34++970D
  35++970D 21 A5 8A     		ld hl,txt_memoryerror
  36++9710              		OS_PRINTZ
  36++9710 0E 09       >    ld c,#09
  36++9712 E7          >    rst #20
  37++9713
  38++9713 3A BD 99     		ld a,(file_id_cur_r)
  39++9716 FE FF        		cp 255
  40++9718 28 03        		jr z,memoryerror1
  41++971A              		OS_FILE_CLOSE ;A - id file
  41++971A 0E 25       >    ld c,#25
  41++971C E7          >    rst #20
  42++971D              memoryerror1
  43++971D 37           		scf ;
  44++971E C9           		ret
  45++971F
  46++971F
  47++971F
  48++971F              ;----------------------------------------
  49++971F              load_mus
  50++971F
  51++971F                      ; ld b,0
  52++971F              ; old_mus EQU $-1
  53++971F                      ; cp b
  54++971F                      ; ret z
  55++971F                      ; ld (old_mus),a
  56++971F
  57++971F                      ; and a
  58++971F                      ; jp z,no_mus
  59++971F
  60++971F
  61++971F                      ; call calc_mus
  62++971F
  63++971F                      ; call no_mus
  64++971F                      ; ld hl,t_s98_file00_pages_list+$FF
  65++971F                      ; call free_s98_file ; 
  66++971F
  67++971F                      ;generate path to music file in 'buf'
  68++971F                      ; ld hl,mus_path1
  69++971F                      ; ld de,buf
  70++971F                      ; call copystr_hlde ;'copy path  'mus/' '
  71++971F
  72++971F                      ; ld a,(mus_mode)
  73++971F                      ; ld hl,mus_modes
  74++971F                      ; call sel_word
  75++971F                      ; call copystr_hlde ;copy "aym / s98 path"
  76++971F                      ; ld hl,mus_path2
  77++971F                      ; call copystr_hlde ;copy name without ext
  78++971F
  79++971F                      ; ld a,(mus_mode)
  80++971F                      ; ld hl,plr_ext
  81++971F                      ; call sel_word
  82++971F                      ; call copystr_hlde  ;copy file ext
  83++971F                      ; xor a
  84++971F                      ; ld (de),a  ;string terminator
  85++971F
  86++971F                      ; ld de,buf ; 
  87++971F                      ; call openstream_file
  88++971F
  89++971F 21 AC 97     		ld hl,file_name_cur
  90++9722              		OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
  90++9722 0E 21       >    ld c,#21
  90++9724 E7          >    rst #20
  91++9725
  92++9725                      ;or a
  93++9725                      ;jp nz,fileopenerror
  94++9725 DA F3 96     		jp c,fileopenerror
  95++9728 32 BD 99     		ld (file_id_cur_r),a
  96++972B
  97++972B 21 00 8B             ld hl,memorystreampages ;t_s98_file00_pages_list
  98++972E 22 32 97             ld (load_s98_file_number),hl
  99++9731
 100++9731
 101++9731              /////------        call load_s98_file      ;de=drive/path/file
 102++9731
 103++9731              ;    
 104++9731              ;   
 105++9731
 106++9731                              ;   
 107++9731
 108++9731
 109++9731              load_s98_file_number_haddr = $+2
 109++9731
 110++9731              load_s98_file_number = $+1
 110++9731
 111++9731 01 00 8B                     ld bc,memorystreampages ;t_s98_file00_pages_list
 112++9734 C5                           push bc
 113++9735
 114++9735              read_file_loop:
 115++9735                              ;OS_NEWPAGE              ;out: a=0 (OK)/!=0 (fail), e=page
 116++9735              				OS_GET_PAGE ;*
 116++9735 0E 1A       >    ld c,#1a
 116++9737 E7          >    rst #20
 117++9738
 118++9738 C1                           pop bc ;file tab
 119++9739
 120++9739                              ;or a
 121++9739                              ;jp nz,memory_error
 122++9739 DA 7C 97     				jp c,memory_error
 123++973C                              ;ld a,e
 124++973C                                                      ;    !!!!
 125++973C                                                      ;    !!!!
 126++973C
 127++973C 02           1               ld (bc),a
 128++973D 0C                           inc c           ;      4 !!!!!
 129++973E
 130++973E C5                           push bc ;file tab
 131++973F                              ;SETPGC000
 132++973F              				OS_SET_PAGE_SLOT3
 132++973F 0E 1C       >    ld c,#1c
 132++9741 E7          >    rst #20
 133++9742
 134++9742                              ;ld de,$C000
 135++9742                              ;ld hl,$4000
 136++9742
 137++9742                              ;call readstream_file    ;DE = Buffer address, HL = Number of bytes to read
 138++9742                                              ;hl=actual size
 139++9742
 140++9742 3A BD 99     				ld a,(file_id_cur_r)
 141++9745 21 00 C0     				ld hl,$C000
 142++9748 11 00 40                     ld de,$4000
 143++974B              				OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl -    )
 143++974B 0E 23       >    ld c,#23
 143++974D E7          >    rst #20
 144++974E 30 04        				jr nc,read_file_loop1
 145++9750
 146++9750              				; 
 147++9750 C1                           pop bc ;file tab
 148++9751 C3 F3 96                     jp fileopenerror
 149++9754
 150++9754
 151++9754              read_file_loop1		;
 152++9754 7C                           ld a,h
 153++9755                              ; cp $40
 154++9755                              ; jr nc,read_file_loop    ;>= $40
 155++9755 FE C0        				cp $c0
 156++9757 38 DC                        jr c,read_file_loop    ;>= $c0,   
 157++9759
 158++9759
 159++9759              read_file_exit
 160++9759
 161++9759 C1                           pop bc ;file tab
 162++975A                              ;    
 163++975A 79                           ld a,c
 164++975B
 165++975B                             // sub 16   ; !!!!!       0  +16
 166++975B
 167++975B 0E FF                        ld c,$FF
 168++975D 02                           ld (bc),a
 169++975E
 170++975E              ;-------------------------------------------------------
 171++975E              ;    .
 172++975E              ;       plr_page3    
 173++975E              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 174++975E                              ;call closestream_file
 175++975E 3A BD 99     				ld a,(file_id_cur_r)
 176++9761              				OS_FILE_CLOSE ;A - id file
 176++9761 0E 25       >    ld c,#25
 176++9763 E7          >    rst #20
 177++9764
 178++9764
 179++9764                              ;call store8000c000 ;*
 180++9764              ;  8000     
 181++9764 21 00 8B                     ld hl,memorystreampages ;t_s98_file00_pages_list
 182++9767 7E                           ld a,(hl)
 183++9768                              ;SETPG8000
 184++9768              				OS_SET_PAGE_SLOT3
 184++9768 0E 1C       >    ld c,#1c
 184++976A E7          >    rst #20
 185++976B                              ; ld a,(plr_page3)
 186++976B                              ; SETPGC000
 187++976B
 188++976B              ;    plr_page3.      .
 189++976B                              ; ld hl,0x8000
 190++976B                              ; ld de,module
 191++976B                              ; ld bc,16384
 192++976B                              ; ldir
 193++976B
 194++976B              ;   plrpage      .
 195++976B                              ; ld a,(plr_page)
 196++976B                              ; SETPGC000
 197++976B                              ; ld hl,t_s98_file00_pages_list
 198++976B                              ; ld de,0xc100         ;0x5000
 199++976B                              ; ld bc,256
 200++976B                              ; ldir
 201++976B
 202++976B                       ;       DI
 203++976B
 204++976B              ;b .
 205++976B                              ;call restore8000c000
 206++976B
 207++976B                              ;call set_music_pages
 208++976B
 209++976B 21 00 C0                     ld hl,module
 210++976E                              ;ld (0x4001),hl *    
 211++976E 22 EB 8A     				ld (START+1),hl
 212++9771 CD EA 8A                     call PLR_INIT        ;init music
 213++9774
 214++9774                        ;      EI
 215++9774              ;----------------
 216++9774              ;eloop           halt ;YIELD
 217++9774              ;                call PLR_PLAY
 218++9774              ;                jr eloop
 219++9774              ;----------------
 220++9774
 221++9774
 222++9774              ;!!!!!!!!!!
 223++9774
 224++9774              ; .
 225++9774                              ;ld a,(plr_page)
 226++9774 21 EF 8A                     ld hl,PLR_PLAY
 227++9777                              ;OS_SETMUSIC         ;****     
 228++9777              				OS_SET_INTER
 228++9777 0E 14       >    ld c,#14
 228++9779 E7          >    rst #20
 229++977A AF           				xor a ;OK
 230++977B C9           				ret
 231++977C                              ;jp unset_music_pages
 232++977C
 233++977C
 234++977C              memory_error:
 235++977C C3 09 97             jp memoryerror
 236++977F
# file closed: GPlay/sub_func.asm
 277+ 977F              	;include common/muldiv.asm
 278+ 977F
 279+ 977F              end_gplay
 280+ 977F
 281+ 977F              ;ниже не включается в файл
 282+ 977F              ;waveheaderbuffer equ 0xc000-2048=0xb800 ;
 283+ 977F
 284+ 977F
 285+ 977F              	;savebin "gplay.apg",start_gplay,$-start_gplay
# file closed: GPlay/gplay.asm
1212  977F              	include nc_pic_view.asm ;просмотр картинок
# file opened: nc_pic_view.asm
   1+ 977F                  ; module ScreenViewer
   2+ 977F              display:
   3+ 977F                  ; call Console.waitForKeyUp
   4+ 977F
   5+ 977F              display_wait1
   6+ 977F 3E 07        	ld a,7
   7+ 9781              	OS_SET_SCREEN ;включить экран
   7+ 9781 0E 1D       >    ld c,#1d
   7+ 9783 E7          >    rst #20
   8+ 9784 30 03        	jr nc,display_wait1_ok
   9+ 9786              	OS_WAIT
   9+ 9786 DF          >	rst #18
  10+ 9787 18 F6        	jr display_wait1 ;пока не получилось, может не в фокусе приложение
  11+ 9789
  12+ 9789              display_wait1_ok
  13+ 9789
  14+ 9789 3A BE 99     	ld a,(page_ext01) ;доп страница для данных плеера
  15+ 978C 06 07        	ld b,7 ;страница назначения
  16+ 978E 21 00 80     	ld hl,#8000
  17+ 9791 11 00 C0     	ld de,#c000
  18+ 9794 DD 21 00 1B  	ld ix,6912
  19+ 9798              	OS_RAM_COPY
  19+ 9798 0E 19       >    ld c,#19
  19+ 979A E7          >    rst #20
  20+ 979B                  ;call TextMode.disable
  21+ 979B              .wait
  22+ 979B              	OS_WAIT
  22+ 979B DF          >	rst #18
  23+ 979C              	OS_GET_CHAR
  23+ 979C 0E 10       >    ld c,#10
  23+ 979E E7          >    rst #20
  24+ 979F FE FF        	cp 255
  25+ 97A1 28 F8        	jr z, .wait
  26+ 97A3 AF           	xor a ;текстовый экран
  27+ 97A4              	OS_SET_SCREEN
  27+ 97A4 0E 1D       >    ld c,#1d
  27+ 97A6 E7          >    rst #20
  28+ 97A7                  ;call TextMode.cls
  29+ 97A7 C9           	ret
  30+ 97A8                  ;jp History.back
  31+ 97A8
  32+ 97A8              ;    endmodule
  33+ 97A8
# file closed: nc_pic_view.asm
1213  97A8
1214  97A8              color_default equ 0*8+7 ;цвет обычный системный
1215  97A8              color_view_text equ 4 ;цвет текста в просмотрщике
1216  97A8
1217  97A8              color_backgr equ 1*8+7 ;цвет фона
1218  97A8              color_apg equ 1*8+4 ;цвет приложений
1219  97A8              color_dir equ 1*8+6 ;цвет папок
1220  97A8
1221  97A8              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1222  97A8              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1223  97A8              color_dir_hi equ 5*8+0 ;цвет папок курсор
1224  97A8
1225  97A8              file_info_lenght equ 255 ;длина инфо о файле
1226  97A8              panel_hight equ 22;высота панели
1227  97A8              panel_r_xy equ #0129
1228  97A8              buffer_cat equ #c000 ;адрес буфера каталога
1229  97A8
1230  97A8 00 00        file_r_all dw 0;всего файлов справа
1231  97AA 00 00        file_r_cur_focus dw 0;первый видимый
1232  97AC 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1233  98AC 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1234  99AC 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1234  99B0 20 20 20 20
1234  99B4 20 20 20 20
1234  99B8 00
1235  99B9 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1236  99BA
1237  99BA 00 00        file_r_num_cur dw 0 ;текущий файл справа
1238  99BC 00           key_pressed db 0 ;последняя клавиша
1239  99BD 00           file_id_cur_r db 0 ;id файла справа
1240  99BE
1241  99BE
1242  99BE 00           page_ext01 db 0 ;номер дополнительной страницы
1243  99BF 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1244  99C1 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1245  99C2 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1245  99C6 20 20 20 20
1245  99CA 20 20 20 20
1245  99CE 20 20 20 20
1245  99D2 20 20 20 20
1245  99D6 20 20 20 20
1245  99DA 20 20 00
1246  99DD
1247  99DD
1248  99DD              rect_1
1249  99DD C9           	db #c9
1250  99DE              	dup 40-2
1251  99DE CD          >	db #cd
1251  99DF CD          >	db #cd
1251  99E0 CD          >	db #cd
1251  99E1 CD          >	db #cd
1251  99E2 CD          >	db #cd
1251  99E3 CD          >	db #cd
1251  99E4 CD          >	db #cd
1251  99E5 CD          >	db #cd
1251  99E6 CD          >	db #cd
1251  99E7 CD          >	db #cd
1251  99E8 CD          >	db #cd
1251  99E9 CD          >	db #cd
1251  99EA CD          >	db #cd
1251  99EB CD          >	db #cd
1251  99EC CD          >	db #cd
1251  99ED CD          >	db #cd
1251  99EE CD          >	db #cd
1251  99EF CD          >	db #cd
1251  99F0 CD          >	db #cd
1251  99F1 CD          >	db #cd
1251  99F2 CD          >	db #cd
1251  99F3 CD          >	db #cd
1251  99F4 CD          >	db #cd
1251  99F5 CD          >	db #cd
1251  99F6 CD          >	db #cd
1251  99F7 CD          >	db #cd
1251  99F8 CD          >	db #cd
1251  99F9 CD          >	db #cd
1251  99FA CD          >	db #cd
1251  99FB CD          >	db #cd
1251  99FC CD          >	db #cd
1251  99FD CD          >	db #cd
1251  99FE CD          >	db #cd
1251  99FF CD          >	db #cd
1251  9A00 CD          >	db #cd
1251  9A01 CD          >	db #cd
1251  9A02 CD          >	db #cd
1251  9A03 CD          >	db #cd
1252  9A04              	edup
1253  9A04 BB 00        	db #bb,0
1254  9A06
1255  9A06              rect_2
1256  9A06 BA           	db #ba
1257  9A07              	dup 40-2
1258  9A07 20          >	db " "
1258  9A08 20          >	db " "
1258  9A09 20          >	db " "
1258  9A0A 20          >	db " "
1258  9A0B 20          >	db " "
1258  9A0C 20          >	db " "
1258  9A0D 20          >	db " "
1258  9A0E 20          >	db " "
1258  9A0F 20          >	db " "
1258  9A10 20          >	db " "
1258  9A11 20          >	db " "
1258  9A12 20          >	db " "
1258  9A13 20          >	db " "
1258  9A14 20          >	db " "
1258  9A15 20          >	db " "
1258  9A16 20          >	db " "
1258  9A17 20          >	db " "
1258  9A18 20          >	db " "
1258  9A19 20          >	db " "
1258  9A1A 20          >	db " "
1258  9A1B 20          >	db " "
1258  9A1C 20          >	db " "
1258  9A1D 20          >	db " "
1258  9A1E 20          >	db " "
1258  9A1F 20          >	db " "
1258  9A20 20          >	db " "
1258  9A21 20          >	db " "
1258  9A22 20          >	db " "
1258  9A23 20          >	db " "
1258  9A24 20          >	db " "
1258  9A25 20          >	db " "
1258  9A26 20          >	db " "
1258  9A27 20          >	db " "
1258  9A28 20          >	db " "
1258  9A29 20          >	db " "
1258  9A2A 20          >	db " "
1258  9A2B 20          >	db " "
1258  9A2C 20          >	db " "
1259  9A2D              	edup
1260  9A2D BA 00        	db #ba,0
1261  9A2F
1262  9A2F              rect_3
1263  9A2F C8           	db #c8
1264  9A30              	dup 40-2
1265  9A30 CD          >	db #cd
1265  9A31 CD          >	db #cd
1265  9A32 CD          >	db #cd
1265  9A33 CD          >	db #cd
1265  9A34 CD          >	db #cd
1265  9A35 CD          >	db #cd
1265  9A36 CD          >	db #cd
1265  9A37 CD          >	db #cd
1265  9A38 CD          >	db #cd
1265  9A39 CD          >	db #cd
1265  9A3A CD          >	db #cd
1265  9A3B CD          >	db #cd
1265  9A3C CD          >	db #cd
1265  9A3D CD          >	db #cd
1265  9A3E CD          >	db #cd
1265  9A3F CD          >	db #cd
1265  9A40 CD          >	db #cd
1265  9A41 CD          >	db #cd
1265  9A42 CD          >	db #cd
1265  9A43 CD          >	db #cd
1265  9A44 CD          >	db #cd
1265  9A45 CD          >	db #cd
1265  9A46 CD          >	db #cd
1265  9A47 CD          >	db #cd
1265  9A48 CD          >	db #cd
1265  9A49 CD          >	db #cd
1265  9A4A CD          >	db #cd
1265  9A4B CD          >	db #cd
1265  9A4C CD          >	db #cd
1265  9A4D CD          >	db #cd
1265  9A4E CD          >	db #cd
1265  9A4F CD          >	db #cd
1265  9A50 CD          >	db #cd
1265  9A51 CD          >	db #cd
1265  9A52 CD          >	db #cd
1265  9A53 CD          >	db #cd
1265  9A54 CD          >	db #cd
1265  9A55 CD          >	db #cd
1266  9A56              	edup
1267  9A56 BC 00        	db #bc,0
1268  9A58
1269  9A58              ;file_name_test db '486 HEART ON FIRE.vgm',0
1270  9A58              msg_menu_info
1271  9A58 0D 43 53 2B  	db 13,"CS+Enter - Play all",0
1271  9A5C 45 6E 74 65
1271  9A60 72 20 2D 20
1271  9A64 50 6C 61 79
1271  9A68 20 61 6C 6C
1271  9A6C 00
1272  9A6D              msg_menu_main1
1273  9A6D 20 4C 46 20  	db " LF On",0
1273  9A71 4F 6E 00
1274  9A74              msg_menu_main2
1275  9A74 20 41 5A 20  	db " AZ On",0
1275  9A78 4F 6E 00
1276  9A7B              msg_menu_main3
1277  9A7B 20 56 69 65  	db " View",0
1277  9A7F 77 00
1278  9A81              msg_file_error
1279  9A81 46 69 6C 65  	db "File error",10,13,0
1279  9A85 20 65 72 72
1279  9A89 6F 72 0A 0D
1279  9A8D 00
1280  9A8E              msg_file_too_big
1281  9A8E 46 69 6C 65  	db "File too big",10,13,0
1281  9A92 20 74 6F 6F
1281  9A96 20 62 69 67
1281  9A9A 0A 0D 00
1282  9A9D              msg_mem_err
1283  9A9D 47 65 74 20  	db "Get memory error",10,13,0
1283  9AA1 6D 65 6D 6F
1283  9AA5 72 79 20 65
1283  9AA9 72 72 6F 72
1283  9AAD 0A 0D 00
1284  9AB0              msg_title_nc
1285  9AB0 4E 6F 6E 65  	db "None Commander ver 2025.07.24",10,13,0
1285  9AB4 20 43 6F 6D
1285  9AB8 6D 61 6E 64
1285  9ABC 65 72 20 76
1285  9AC0 65 72 20 32
1285  9AC4 30 32 35 2E
1285  9AC8 30 37 2E 32
1285  9ACC 34 0A 0D 00
1286  9AD0
1287  9AD0              end_nc
1288  9AD0              ;ниже не включается в файл
1289  9AD0 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1290  9ED0 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1291  9FD0              ;ещё тут буферы плеера
1292  9FD0
1293  9FD0              	savebin "nc.apg",start_nc,$-start_nc
# file closed: nc.asm
