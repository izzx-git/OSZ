# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000
  97+ 0000              ;включить/выключить моно режим для приложения
  98+ 0000              ;при включенном режиме разрешена запись в диапазон памяти #4000-#7fff + страницы приложения
  99+ 0000              ;вх: a = 0 - включить; a = 255 - выключить
 100+ 0000                  macro OS_SET_MONO_MODE ;
 101+ 0000 ~                ld c,#08
 102+ 0000 ~                rst #20
 103+ 0000                  endm
 104+ 0000
 105+ 0000
 106+ 0000
 107+ 0000              ;печать в консоль до кода 0
 108+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 109+ 0000 ~                ld c,#09
 110+ 0000 ~                rst #20
 111+ 0000                  endm
 112+ 0000
 113+ 0000
 114+ 0000              ;прочитать байт из порта uart
 115+ 0000              ;вх:
 116+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 117+ 0000              ;вых: A - считанный байт
 118+ 0000                  macro OS_UART_READ
 119+ 0000 ~                ld c,#0a
 120+ 0000 ~                rst #20
 121+ 0000                  endm
 122+ 0000
 123+ 0000              ;записать байт в порт uart
 124+ 0000              ;вх: A -байт
 125+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 126+ 0000                  macro OS_UART_WRITE
 127+ 0000 ~                ld c,#0b
 128+ 0000 ~                rst #20
 129+ 0000                  endm
 130+ 0000
 131+ 0000              ;закрыть соединение ESP
 132+ 0000              ;вх:
 133+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 134+ 0000                  macro OS_ESP_CLOSE
 135+ 0000 ~                ld c,#0c
 136+ 0000 ~                rst #20
 137+ 0000                  endm
 138+ 0000
 139+ 0000              ;установить соединение ESP (CIPSTART);
 140+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 141+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 142+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 143+ 0000                  macro OS_ESP_OPEN
 144+ 0000 ~                ld c,#0d
 145+ 0000 ~                rst #20
 146+ 0000                  endm
 147+ 0000
 148+ 0000              ;послать запрос ESP (CIPSEND);
 149+ 0000              ;вх: hl - адрес данных, de - длина данных
 150+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 151+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 152+ 0000                  macro OS_ESP_SEND
 153+ 0000 ~                ld c,#0e
 154+ 0000 ~                rst #20
 155+ 0000                  endm
 156+ 0000
 157+ 0000              ;получить пакет ESP (+IPD);
 158+ 0000              ;вх: hl - адрес для данных
 159+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 160+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 161+ 0000                  macro OS_ESP_GET
 162+ 0000 ~                ld c,#0f
 163+ 0000 ~                rst #20
 164+ 0000                  endm
 165+ 0000
 166+ 0000              ;ввод с консоли ----------------------
 167+ 0000
 168+ 0000              ;получить код нажатой клавиши
 169+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 170+ 0000 ~                ld c,#10
 171+ 0000 ~                rst #20
 172+ 0000                  endm
 173+ 0000
 174+ 0000
 175+ 0000              ;процессы ----------------------------
 176+ 0000
 177+ 0000              ;запустить процесс
 178+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 179+ 0000                  macro OS_PROC_RUN ;
 180+ 0000 ~                ld c,#11
 181+ 0000 ~                rst #20
 182+ 0000                  endm
 183+ 0000
 184+ 0000              ;установить фокус
 185+ 0000              ;вх: a - id процесса
 186+ 0000                  macro OS_PROC_SET_FOCUS ;
 187+ 0000 ~                ld c,#12
 188+ 0000 ~                rst #20
 189+ 0000                  endm
 190+ 0000
 191+ 0000              ;закрыть процесс
 192+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 193+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 194+ 0000                  macro OS_PROC_CLOSE ;
 195+ 0000 ~                ld c,#13
 196+ 0000 ~                rst #20
 197+ 0000                  endm
 198+ 0000
 199+ 0000
 200+ 0000              ;прерывания --------------------------
 201+ 0000
 202+ 0000              ;установка адреса обработчика прерываний процесса;
 203+ 0000              ;например, плеера музыки
 204+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 205+ 0000              ;на время выполнения включаются обе страницы процесса
 206+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 207+ 0000 ~                ld c,#14
 208+ 0000 ~                rst #20
 209+ 0000                  endm
 210+ 0000
 211+ 0000
 212+ 0000              ;плеер AY ----------------------------
 213+ 0000
 214+ 0000              ;инициализация плеера AY;
 215+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 216+ 0000 ~                ld c,#15
 217+ 0000 ~                rst #20
 218+ 0000                  endm
 219+ 0000
 220+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 221+ 0000                  macro OS_VTPL_PLAY ;()
 222+ 0000 ~                ld c,#16
 223+ 0000 ~                rst #20
 224+ 0000                  endm
 225+ 0000
 226+ 0000              ;заглушить плеер AY;
 227+ 0000                  macro OS_VTPL_MUTE ;()
 228+ 0000 ~                ld c,#17
 229+ 0000 ~                rst #20
 230+ 0000                  endm
 231+ 0000
 232+ 0000              ;получить значение переменной плеера;
 233+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 234+ 0000 ~                ld c,#18
 235+ 0000 ~                rst #20
 236+ 0000                  endm
 237+ 0000
 238+ 0000
 239+ 0000              ;прочие ------------------------------
 240+ 0000
 241+ 0000
 242+ 0000              ;скопировать данные из страницы в страницу
 243+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 244+ 0000                  macro OS_RAM_COPY
 245+ 0000 ~                ld c,#19
 246+ 0000 ~                rst #20
 247+ 0000                  endm
 248+ 0000
 249+ 0000              ;получить дополнительную страницу памяти;
 250+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 251+ 0000 ~                ld c,#1a
 252+ 0000 ~                rst #20
 253+ 0000                  endm
 254+ 0000
 255+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 256+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 257+ 0000 ~                ld c,#1b
 258+ 0000 ~                rst #20
 259+ 0000                  endm
 260+ 0000
 261+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 262+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 263+ 0000 ~                ld c,#1c
 264+ 0000 ~                rst #20
 265+ 0000                  endm
 266+ 0000
 267+ 0000              ;включить экран N;
 268+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 269+ 0000              ;переключать может только приложение в фокусе
 270+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 271+ 0000              ;при переключении процессов сохраняется только экран #39
 272+ 0000                  macro OS_SET_SCREEN ;
 273+ 0000 ~                ld c,#1d
 274+ 0000 ~                rst #20
 275+ 0000                  endm
 276+ 0000
 277+ 0000
 278+ 0000              ;получить номера страниц процесса;
 279+ 0000              ;вх:
 280+ 0000              ;вых: b, c - страницы в слотах 2, 3
 281+ 0000                  macro OS_GET_MAIN_PAGES ;
 282+ 0000 ~                ld c,#1e
 283+ 0000 ~                rst #20
 284+ 0000                  endm
 285+ 0000
 286+ 0000              ;получить значение системного таймера
 287+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 288+ 0000 ~                ld c,#1F
 289+ 0000 ~                rst #20
 290+ 0000                  endm
 291+ 0000
 292+ 0000
 293+ 0000              ;освободить страницу памяти
 294+ 0000              ;вх: a - номер страницы
 295+ 0000                  macro OS_DEL_PAGE ;
 296+ 0000 ~                ld c,#20
 297+ 0000 ~                rst #20
 298+ 0000                  endm
 299+ 0000
 300+ 0000
 301+ 0000              ;дисковые операции -------------------
 302+ 0000
 303+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 304+ 0000
 305+ 0000              ; fcbFAT (из руководства к монитору)
 306+ 0000              ; формат fcb для работы с FAT
 307+ 0000
 308+ 0000              ; +#00 8 имя файла
 309+ 0000              ; +#08 3 расширение файла
 310+ 0000              ; +#0B 1 атрибуты файла
 311+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 312+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 313+ 0000              ; +#14 4 размер файла/каталога в байтах
 314+ 0000              ; +#18 4 указатель в файле
 315+ 0000              ; +#1C 1 для внутренних нужд
 316+ 0000              ; +#1D 1 для внутренних нужд
 317+ 0000              ; +#1E 1 резерв
 318+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 319+ 0000              	; 1-0,nn номер раздела
 320+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 321+ 0000              	    ; значение %11 недопустимо
 322+ 0000
 323+ 0000              ;открыть файл для чтения или записи
 324+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, de bc - size, IX - fcb)
 325+ 0000 ~                ld c,#21
 326+ 0000 ~                rst #20
 327+ 0000                  endm
 328+ 0000
 329+ 0000              ;создать файл
 330+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 331+ 0000 ~                ld c,#22
 332+ 0000 ~                rst #20
 333+ 0000                  endm
 334+ 0000
 335+ 0000              ;прочитать из файла
 336+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 337+ 0000 ~                ld c,#23
 338+ 0000 ~                rst #20
 339+ 0000                  endm
 340+ 0000
 341+ 0000              ;записать в файл
 342+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 343+ 0000 ~                ld c,#24
 344+ 0000 ~                rst #20
 345+ 0000                  endm
 346+ 0000
 347+ 0000              ;закрыть файл
 348+ 0000                  macro OS_FILE_CLOSE ;A - id file
 349+ 0000 ~                ld c,#25
 350+ 0000 ~                rst #20
 351+ 0000                  endm
 352+ 0000
 353+ 0000              ;чтение секторов текущего каталога
 354+ 0000              ; вх:
 355+ 0000                   ; hl - буфер для чтения
 356+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 357+ 0000                   ; b - максимальное количество секторов для чтения
 358+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 359+ 0000                     ; a=errRWnum
 360+ 0000                     ; a=errInvalidPart
 361+ 0000                     ; a=errFileEmpty
 362+ 0000                   ; cy=0, a=errEoF - каталог закончился
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b - не прочитано секторов
 366+ 0000                   ; cy=0 - считано успешно
 367+ 0000                     ; hl - следующий адрес в буфере
 368+ 0000                     ; de - номер первого непрочитанного сектора
 369+ 0000                     ; b=#00
 370+ 0000                  macro OS_DIR_READ ;
 371+ 0000 ~                ld c,#26
 372+ 0000 ~                rst #20
 373+ 0000                  endm
 374+ 0000
 375+ 0000              ;вход в каталог/выход в родительский каталог
 376+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 377+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 378+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 379+ 0000              	; переход в родительский, последнее имя в пути удалится).
 380+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 381+ 0000              	; добавится имя файла
 382+ 0000              ; вх:
 383+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 384+ 0000                   ; de - адрес дескриптора директории/файла
 385+ 0000              ; вых: a - если путь был указан, новая длина пути
 386+ 0000                  macro OS_DIR_OPEN ;
 387+ 0000 ~                ld c,#27
 388+ 0000 ~                rst #20
 389+ 0000                  endm
 390+ 0000
 391+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 392+ 0000              ;проверки на допустимость значений не производится
 393+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 394+ 0000              ;вх: A - id файла
 395+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 396+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 397+ 0000                  macro OS_FILE_POSITION ;
 398+ 0000 ~                ld c,#28
 399+ 0000 ~                rst #20
 400+ 0000                  endm
 401+ 0000
 402+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 403+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 404+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 405+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 406+ 0000                  macro OS_FIND_PATH ;
 407+ 0000 ~                ld c,#29
 408+ 0000 ~                rst #20
 409+ 0000                  endm
 410+ 0000
 411+ 0000
 412+ 0000              ; получение длинного имени файла
 413+ 0000              ;вх: hl - адрес буфера для имени
 414+ 0000              ;    de - номер записи в текущем каталоге
 415+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 416+ 0000              ; 	a - длина имени, с учетом нуля
 417+ 0000                  macro OS_GET_LFN ;
 418+ 0000 ~                ld c,#2a
 419+ 0000 ~                rst #20
 420+ 0000                  endm
 421+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROG_START
   5  8000
   6  8000              start_nc
   7  8000 21 CE 9B     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 CB 9A  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 A7 9B     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A
  24  801A CD AD 80     	call delay
  25  801D C3 A3 82     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 CA 9A     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023
  32  8023              start_nc_warm ;тёплый старт
  33  8023
  34  8023              	;очистка буфера
  35  8023 CD B3 80     	call clear_buf
  36  8026
  37  8026              	;загрузка каталога
  38  8026 21 00 C0     	ld hl,buffer_cat ;куда
  39  8029 11 00 00     	ld de,0 ;начиная с 0 сектора
  40  802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  41  802E              	OS_DIR_READ
  41  802E 0E 26       >    ld c,#26
  41  8030 E7          >    rst #20
  42  8031
  43  8031 21 00 00     	ld hl,0 ;обнулить переменные
  44  8034 22 C6 9A     	ld (file_r_num_cur),hl
  45  8037 22 B4 98     	ld (file_r_all),hl
  46  803A 22 B6 98     	ld (file_r_cur_focus),hl
  47  803D
  48  803D CD 1B 84     	call sort_dir
  49  8040
  50  8040 3E 0F        	ld a,color_backgr
  51  8042 06 0C        	ld b,#c
  52  8044              	OS_SET_COLOR
  52  8044 0E 06       >    ld c,#06
  52  8046 E7          >    rst #20
  53  8047
  54  8047 CD 11 86     	call print_rect_r ;рамка
  55  804A CD 23 83     	call print_panel_r
  56  804D CD 46 86     	call print_menu_main
  57  8050
  58  8050 11 00 01     	ld de,#0100
  59  8053              	OS_SET_XY
  59  8053 0E 01       >    ld c,#01
  59  8055 E7          >    rst #20
  60  8056
  61  8056 21 64 9B     	ld hl,msg_menu_info
  62  8059              	OS_PRINTZ
  62  8059 0E 09       >    ld c,#09
  62  805B E7          >    rst #20
  63  805C
  64  805C
  65  805C
  66  805C              nc_wait
  67  805C              	OS_WAIT ;ждать прерывание
  67  805C DF          >	rst #18
  68  805D
  69  805D              	OS_GET_CHAR ;клавиша
  69  805D 0E 10       >    ld c,#10
  69  805F E7          >    rst #20
  70  8060 32 C8 9A     	ld (key_pressed),a ;запомнить
  71  8063 FE 0D        	cp 13
  72  8065 CA 14 81     	jp z,key_enter ;
  73  8068 FE 0A        	cp 10 ;вниз
  74  806A CC 0F 82     	call z,key_down
  75  806D FE 0B        	cp 11 ;вверх
  76  806F CC 4C 82     	call z,key_up
  77  8072 FE 09        	cp 09 ;вправо
  78  8074 CC 91 82     	call z,key_right
  79  8077 FE 08        	cp 08 ;влево
  80  8079 CC 7F 82     	call z,key_left
  81  807C FE 04        	cp 04 ;страница вверх
  82  807E CC 7F 82     	call z,key_left
  83  8081 FE 05        	cp 05 ;страница вниз
  84  8083 CC 91 82     	call z,key_right
  85  8086 FE 31        	cp "1" ;переключение длинных имён (LFN)
  86  8088 CA BF 85     	jp z,LFN_toggle
  87  808B FE 32        	cp "2" ;переключение сортировки
  88  808D CA 9F 85     	jp z,sort_toggle
  89  8090 FE 33        	cp "3" ;просмотр файла
  90  8092 CA 94 86     	jp z,view_file
  91  8095 FE 19        	cp 25 ;CS+Enter
  92  8097 CA 97 81     	jp z,nc_play_all
  93  809A FE 18        	cp 24 ;break
  94  809C CA A3 82     	jp z,exit
  95  809F
  96  809F
  97  809F 3A CD 9A     	ld a,(print_panel_r_flag)
  98  80A2 B7           	or a
  99  80A3 C4 23 83     	call nz,print_panel_r ;обновить каталог
 100  80A6 AF           	xor a
 101  80A7 32 CD 9A     	ld (print_panel_r_flag),a
 102  80AA
 103  80AA C3 5C 80     	jp nc_wait ;на цикл ожидания
 104  80AD
 105  80AD
 106  80AD              delay ;задержка
 107  80AD 06 96        	ld b,50*3 ;
 108  80AF              delay1
 109  80AF              	OS_WAIT
 109  80AF DF          >	rst #18
 110  80B0 10 FD        	djnz delay1
 111  80B2 C9           	ret
 112  80B3
 113  80B3
 114  80B3              clear_buf
 115  80B3 21 00 C0     	ld hl,buffer_cat
 116  80B6 11 01 C0     	ld de,buffer_cat+1
 117  80B9 01 FF 3F     	ld bc,#4000-1
 118  80BC 36 00        	ld (hl),0
 119  80BE ED B0        	ldir
 120  80C0 C9           	ret
 121  80C1
 122  80C1
 123  80C1              ;очистить левую панель
 124  80C1              clear_left_panel
 125  80C1 3E 0F        	ld a,color_backgr ;цвет
 126  80C3 06 0C        	ld b,#c
 127  80C5              	OS_SET_COLOR
 127  80C5 0E 06       >    ld c,#06
 127  80C7 E7          >    rst #20
 128  80C8 06 18        	ld b,panel_hight+2 ;высота
 129  80CA 11 00 00     	ld de,0
 130  80CD              	OS_SET_XY
 130  80CD 0E 01       >    ld c,#01
 130  80CF E7          >    rst #20
 131  80D0              clear_left_panel_cl
 132  80D0 C5           	push bc
 133  80D1 21 E1 80     	ld hl,txt_clear_panel
 134  80D4              	OS_PRINTZ
 134  80D4 0E 09       >    ld c,#09
 134  80D6 E7          >    rst #20
 135  80D7 C1           	pop bc
 136  80D8 10 F6        	djnz clear_left_panel_cl
 137  80DA 11 00 00     	ld de,0
 138  80DD              	OS_SET_XY
 138  80DD 0E 01       >    ld c,#01
 138  80DF E7          >    rst #20
 139  80E0 C9           	ret
 140  80E1 20 20 20 20  txt_clear_panel db "                                        ",13,0 ;40 пробелов
 140  80E5 20 20 20 20
 140  80E9 20 20 20 20
 140  80ED 20 20 20 20
 140  80F1 20 20 20 20
 140  80F5 20 20 20 20
 140  80F9 20 20 20 20
 140  80FD 20 20 20 20
 140  8101 20 20 20 20
 140  8105 20 20 20 20
 140  8109 0D 00
 141  810B
 142  810B
 143  810B              release_key ;ждать отпускания клавиши
 144  810B              	OS_WAIT
 144  810B DF          >	rst #18
 145  810C              	OS_GET_CHAR
 145  810C 0E 10       >    ld c,#10
 145  810E E7          >    rst #20
 146  810F FE FF        	cp 255
 147  8111 20 F8        	jr nz,release_key
 148  8113 C9           	ret
 149  8114
 150  8114
 151  8114              key_enter
 152  8114              	;нажата Enter
 153  8114 2A B4 98     	ld hl,(file_r_all)
 154  8117 7D           	ld a,l
 155  8118 B4           	or h
 156  8119 CA 94 81     	jp z,key_enter_ex ;защита
 157  811C 2A C6 9A     	ld hl,(file_r_num_cur)
 158  811F CD 02 82     	call calc_deskr
 159  8122 DD 7E 0B     	ld a,(ix+#0b)
 160  8125 FE 10        	cp #10 ;признак каталога
 161  8127 CA F5 81     	jp z,key_enter_dir
 162  812A
 163  812A FE 30        	cp #30 ;признак каталога
 164  812C CA F5 81     	jp z,key_enter_dir
 165  812F
 166  812F
 167  812F CD DC 85     	call format_name
 168  8132
 169  8132              	;проверка расширения APG
 170  8132 CD A7 82     	call check_apg
 171  8135 C2 4A 81     	jp nz,key_enter_1
 172  8138              	;тут запуск приложения
 173  8138 21 B8 98     	ld hl,file_name_cur		;строка с именем
 174  813B              	OS_PROC_RUN ;запустить прогу
 174  813B 0E 11       >    ld c,#11
 174  813D E7          >    rst #20
 175  813E              	;обработка ошибки
 176  813E DA 94 81     	jp c,key_enter_ex
 177  8141
 178  8141 DD 7E 00     	ld a,(ix)
 179  8144              	OS_PROC_SET_FOCUS ;на передний план
 179  8144 0E 12       >    ld c,#12
 179  8146 E7          >    rst #20
 180  8147 C3 94 81     	jp key_enter_ex
 181  814A
 182  814A
 183  814A
 184  814A              key_enter_1
 185  814A              	;проверка расширения VGZ
 186  814A CD E5 82     	call check_vgz
 187  814D C2 57 81     	jp nz,key_enter_2_1
 188  8150
 189  8150 3E 7A        	ld a,"z" ;код формата
 190  8152 CD 9D 89     	call start_gplay
 191  8155
 192  8155 18 3D        	jr key_enter_ex
 193  8157
 194  8157
 195  8157              key_enter_2_1
 196  8157              	;проверка расширения VGM
 197  8157 CD C6 82     	call check_vgm
 198  815A C2 64 81     	jp nz,key_enter_2
 199  815D
 200  815D 3E 6D        	ld a,"m" ;код формата
 201  815F CD 9D 89     	call start_gplay
 202  8162
 203  8162 18 30        	jr key_enter_ex
 204  8164
 205  8164
 206  8164              key_enter_2
 207  8164              	;проверка расширения SCR
 208  8164 CD 04 83     	call check_scr
 209  8167 C2 94 81     	jp nz,key_enter_3
 210  816A
 211  816A
 212  816A 21 B8 98     	ld hl,file_name_cur		;строка с именем
 213  816D              	OS_FILE_OPEN
 213  816D 0E 21       >    ld c,#21
 213  816F E7          >    rst #20
 214  8170 30 09        	jr nc,key_enter_2_file_open_ok
 215  8172              key_enter_2_file_error
 216  8172 21 8D 9B     	ld hl,msg_file_error
 217  8175              	OS_PRINTZ
 217  8175 0E 09       >    ld c,#09
 217  8177 E7          >    rst #20
 218  8178              	; ld b,2*50
 219  8178              	; call delay1
 220  8178 C3 94 81     	jp key_enter_ex
 221  817B
 222  817B              key_enter_2_file_open_ok
 223  817B 32 C9 9A     	ld (file_id_cur_r),a
 224  817E 11 00 1B     	ld de,6912
 225  8181 21 00 C0     	ld hl,#c000
 226  8184              	;ld a,(file_id_cur_r)
 227  8184              	OS_FILE_READ ;загрузить
 227  8184 0E 23       >    ld c,#23
 227  8186 E7          >    rst #20
 228  8187 38 E9        	jr c,key_enter_2_file_error
 229  8189 3A C9 9A     	ld a,(file_id_cur_r)
 230  818C              	OS_FILE_CLOSE
 230  818C 0E 25       >    ld c,#25
 230  818E E7          >    rst #20
 231  818F
 232  818F CD 7F 98     	call display ;показать
 233  8192
 234  8192 18 00        	jr key_enter_ex
 235  8194
 236  8194
 237  8194              key_enter_3
 238  8194
 239  8194
 240  8194
 241  8194
 242  8194              key_enter_ex
 243  8194 C3 5C 80     	jp nc_wait
 244  8197
 245  8197
 246  8197
 247  8197
 248  8197
 249  8197
 250  8197
 251  8197              nc_play_all
 252  8197              	;Воспроизведение всего по порядку
 253  8197 2A B4 98     	ld hl,(file_r_all)
 254  819A 7D           	ld a,l
 255  819B B4           	or h
 256  819C CA DB 81     	jp z,nc_play_ex ;защита
 257  819F 2A C6 9A     	ld hl,(file_r_num_cur)
 258  81A2 CD 02 82     	call calc_deskr
 259  81A5 DD 7E 0B     	ld a,(ix+#0b)
 260  81A8 FE 10        	cp #10 ;признак каталога
 261  81AA 28 32        	jr z,nc_play_all_down
 262  81AC
 263  81AC FE 30        	cp #30 ;признак каталога
 264  81AE 28 2E        	jr z,nc_play_all_down
 265  81B0
 266  81B0
 267  81B0 CD DC 85     	call format_name
 268  81B3
 269  81B3              nc_play_1
 270  81B3              	;проверка расширения ;VGM
 271  81B3 CD C6 82     	call check_vgm
 272  81B6 C2 CC 81     	jp nz,nc_play_2
 273  81B9
 274  81B9 3E 6D        	ld a,"m"
 275  81BB CD 9D 89     	call start_gplay
 276  81BE
 277  81BE              nc_play_1_next
 278  81BE
 279  81BE FE 73        	cp "s"
 280  81C0 28 19        	jr z,nc_play_ex
 281  81C2 FE 53        	cp "S"
 282  81C4 28 15        	jr z,nc_play_ex
 283  81C6 FE 18        	cp 24 ;break
 284  81C8 28 11        	jr z,nc_play_ex
 285  81CA
 286  81CA 18 12        	jr nc_play_all_down
 287  81CC
 288  81CC              nc_play_2
 289  81CC              	;проверка расширения ;VGZ
 290  81CC CD E5 82     	call check_vgz
 291  81CF C2 D9 81     	jp nz,nc_play_3
 292  81D2
 293  81D2 3E 7A        	ld a,"z"
 294  81D4 CD 9D 89     	call start_gplay
 295  81D7
 296  81D7 18 E5        	jr nc_play_1_next
 297  81D9
 298  81D9
 299  81D9              nc_play_3
 300  81D9 18 03        	jr nc_play_all_down
 301  81DB
 302  81DB
 303  81DB
 304  81DB              nc_play_ex
 305  81DB C3 5C 80     	jp nc_wait
 306  81DE
 307  81DE
 308  81DE              nc_play_all_down ;вниз по списку
 309  81DE ED 4B C6 9A  	ld bc,(file_r_num_cur)
 310  81E2 C5           	push bc
 311  81E3 CD 0F 82     	call key_down
 312  81E6 CD 23 83     	call print_panel_r ;обновить каталог
 313  81E9 C1           	pop bc
 314  81EA 2A C6 9A     	ld hl,(file_r_num_cur)
 315  81ED A7           	and a
 316  81EE ED 42        	sbc hl,bc ;если не сдвинулась позиция, то всё
 317  81F0 28 E9        	jr z,nc_play_ex
 318  81F2 C3 97 81     	jp nc_play_all
 319  81F5
 320  81F5
 321  81F5
 322  81F5
 323  81F5
 324  81F5
 325  81F5
 326  81F5
 327  81F5              key_enter_dir
 328  81F5              	;тут открытие папки
 329  81F5
 330  81F5              	;call format_name_dir
 331  81F5 EB           	ex de,hl ;de - дескриптор для открытия
 332  81F6 21 B8 99     	ld hl,dir_name_cur
 333  81F9              	OS_DIR_OPEN
 333  81F9 0E 27       >    ld c,#27
 333  81FB E7          >    rst #20
 334  81FC 38 96        	jr c,key_enter_ex ;если ошибка, ничего не делаем
 335  81FE
 336  81FE E1           	pop hl ;отменить возврат
 337  81FF C3 23 80     	jp start_nc_warm ;перезагрузить папку
 338  8202
 339  8202
 340  8202              ; format_name_dir
 341  8202              	; push hl
 342  8202              	; ld hl,file_name_cur
 343  8202              	; ld de,file_name_cur+1 ;почистить
 344  8202              	; ld bc,256-1
 345  8202              	; ld (hl),0
 346  8202              	; ldir
 347  8202
 348  8202              	; pop hl
 349  8202
 350  8202              	; ld de,file_name_cur ;куда
 351  8202              	; ld bc,#08ff
 352  8202              ; format_name_dir_cl
 353  8202              	; ld a,(hl)
 354  8202              	; cp " "+1
 355  8202              	; jr c,format_name_dir_skip
 356  8202              	; ldi
 357  8202              	; djnz format_name_dir_cl
 358  8202              ; format_name_dir_skip
 359  8202              	; ld a,'/'
 360  8202              	; ld (de),a
 361  8202              	; ret
 362  8202
 363  8202               ;вычислить дескриптор текущего элемента справа
 364  8202              calc_deskr
 365  8202 29           	add hl,hl ;*2
 366  8203 01 ED B6     	ld bc,cat_index
 367  8206 09           	add hl,bc
 368  8207 5E           	ld e,(hl)
 369  8208 23           	inc hl
 370  8209 56           	ld d,(hl)
 371  820A EB           	ex de,hl ;hl - адрес элемента
 372  820B E5           	push hl
 373  820C DD E1        	pop ix ;ix- адрес элемента
 374  820E C9           	ret
 375  820F
 376  820F
 377  820F
 378  820F
 379  820F              key_down
 380  820F 2A B4 98     	ld hl,(file_r_all)
 381  8212 7D           	ld a,l
 382  8213 B4           	or h
 383  8214 CA 48 82     	jp z,key_down_ex ;защита
 384  8217
 385  8217 ED 4B C6 9A  	ld bc,(file_r_num_cur)
 386  821B 03           	inc bc
 387  821C 2A B4 98     	ld hl,(file_r_all)
 388  821F              	;если не больше чем всего
 389  821F A7           	and a
 390  8220 ED 42        	sbc hl,bc
 391  8222 38 24        	jr c,key_down_skip
 392  8224 28 22        	jr z,key_down_skip
 393  8226              	;прибавить
 394  8226 ED 43 C6 9A  	ld (file_r_num_cur),bc
 395  822A
 396  822A              	;теперь передвинуть фокус, если надо
 397  822A 2A B6 98     	ld hl,(file_r_cur_focus)
 398  822D 01 16 00     	ld bc,panel_hight
 399  8230 09           	add hl,bc ;прибавить количество видимых
 400  8231 ED 4B C6 9A  	ld bc,(file_r_num_cur)
 401  8235 A7           	and a
 402  8236 ED 42        	sbc hl,bc ;вычесть положение курсора
 403  8238 28 02        	jr z,key_down_change_focus_yes
 404  823A 30 07        	jr nc,key_down_change_focus_no
 405  823C              key_down_change_focus_yes
 406  823C              	;передвинуть фокус
 407  823C 2A B6 98     	ld hl,(file_r_cur_focus)
 408  823F 23           	inc hl
 409  8240 22 B6 98     	ld (file_r_cur_focus),hl
 410  8243
 411  8243              key_down_change_focus_no
 412  8243 3E 01        	ld a,1
 413  8245 32 CD 9A     	ld (print_panel_r_flag),a
 414  8248              	;call print_panel_r ;обновить каталог
 415  8248              key_down_skip
 416  8248
 417  8248              key_down_ex
 418  8248 3A C8 9A     	ld a,(key_pressed)
 419  824B C9           	ret
 420  824C
 421  824C
 422  824C
 423  824C              key_up ;вверх
 424  824C 2A B4 98     	ld hl,(file_r_all)
 425  824F 7D           	ld a,l
 426  8250 B4           	or h
 427  8251 CA 7B 82     	jp z,key_up_ex ;защита
 428  8254
 429  8254 2A C6 9A     	ld hl,(file_r_num_cur)
 430  8257 7D           	ld a,l
 431  8258 B4           	or h
 432  8259 28 20        	jr z,key_up_skip
 433  825B 2B           	dec hl
 434  825C 22 C6 9A     	ld (file_r_num_cur),hl
 435  825F
 436  825F              	;теперь передвинуть фокус, если надо
 437  825F 2A C6 9A     	ld hl,(file_r_num_cur)
 438  8262              	; ld bc,panel_hight
 439  8262              	; add hl,bc ;прибавить количество видимых
 440  8262 ED 4B B6 98  	ld bc,(file_r_cur_focus)
 441  8266 A7           	and a
 442  8267 ED 42        	sbc hl,bc ;вычесть положение курсора
 443  8269              	;jr z,key_up_change_foces_yes
 444  8269 30 0B        	jr nc,key_up_change_foces_no
 445  826B              key_up_change_foces_yes
 446  826B              	;передвинуть фокус
 447  826B 2A B6 98     	ld hl,(file_r_cur_focus)
 448  826E 7C           	ld a,h
 449  826F B5           	or l
 450  8270 28 04        	jr z,key_up_change_foces_no ;защита
 451  8272 2B           	dec hl
 452  8273 22 B6 98     	ld (file_r_cur_focus),hl
 453  8276
 454  8276              key_up_change_foces_no
 455  8276
 456  8276 3E 01        	ld a,1
 457  8278 32 CD 9A     	ld (print_panel_r_flag),a
 458  827B              	;call print_panel_r ;обновить каталог
 459  827B              key_up_skip
 460  827B
 461  827B              key_up_ex
 462  827B 3A C8 9A     	ld a,(key_pressed)
 463  827E C9           	ret
 464  827F
 465  827F
 466  827F              key_left ;на страницу назад
 467  827F 06 15        	ld b,panel_hight-1
 468  8281              key_left_cl
 469  8281 C5           	push bc
 470  8282 CD 4C 82     	call key_up
 471  8285 C1           	pop bc
 472  8286 10 F9        	djnz key_left_cl
 473  8288 3E 01        	ld a,1
 474  828A 32 CD 9A     	ld (print_panel_r_flag),a
 475  828D 3A C8 9A     	ld a,(key_pressed)
 476  8290 C9           	ret
 477  8291
 478  8291
 479  8291
 480  8291              key_right ;на страницу вперёд
 481  8291 06 15        	ld b,panel_hight-1
 482  8293              key_right_cl
 483  8293 C5           	push bc
 484  8294 CD 0F 82     	call key_down
 485  8297 C1           	pop bc
 486  8298 10 F9        	djnz key_right_cl
 487  829A 3E 01        	ld a,1
 488  829C 32 CD 9A     	ld (print_panel_r_flag),a
 489  829F 3A C8 9A     	ld a,(key_pressed)
 490  82A2 C9           	ret
 491  82A3
 492  82A3
 493  82A3
 494  82A3              exit ;выход в DOS
 495  82A3 AF           	xor a
 496  82A4              	OS_PROC_CLOSE
 496  82A4 0E 13       >    ld c,#13
 496  82A6 E7          >    rst #20
 497  82A7
 498  82A7
 499  82A7
 500  82A7              check_apg ;проверка на расширение APG
 501  82A7 DD 7E 08     	ld a,(ix+8)
 502  82AA FE 61        	cp "a"
 503  82AC 28 03        	jr z,check_apg1
 504  82AE FE 41        	cp "A"
 505  82B0 C0           	ret nz
 506  82B1              check_apg1
 507  82B1 DD 7E 09     	ld a,(ix+9)
 508  82B4 FE 70        	cp "p"
 509  82B6 28 03        	jr z,check_apg2
 510  82B8 FE 50        	cp "P"
 511  82BA C0           	ret nz
 512  82BB              check_apg2
 513  82BB DD 7E 0A     	ld a,(ix+10)
 514  82BE FE 67        	cp "g"
 515  82C0 C8           	ret z
 516  82C1 FE 47        	cp "G"
 517  82C3 C0           	ret nz
 518  82C4 AF           	xor a ;равен
 519  82C5 C9           	ret
 520  82C6
 521  82C6
 522  82C6              check_vgm ;проверка на расширение VGM
 523  82C6 DD 7E 08     	ld a,(ix+8)
 524  82C9 FE 76        	cp "v"
 525  82CB 28 03        	jr z,check_vgm1
 526  82CD FE 56        	cp "V"
 527  82CF C0           	ret nz
 528  82D0              check_vgm1
 529  82D0 DD 7E 09     	ld a,(ix+9)
 530  82D3 FE 67        	cp "g"
 531  82D5 28 03        	jr z,check_vgm2
 532  82D7 FE 47        	cp "G"
 533  82D9 C0           	ret nz
 534  82DA              check_vgm2
 535  82DA DD 7E 0A     	ld a,(ix+10)
 536  82DD FE 6D        	cp "m"
 537  82DF C8           	ret z
 538  82E0 FE 4D        	cp "M"
 539  82E2 C0           	ret nz
 540  82E3 AF           	xor a ;равен
 541  82E4 C9           	ret
 542  82E5
 543  82E5              check_vgz ;проверка на расширение VGZ
 544  82E5 DD 7E 08     	ld a,(ix+8)
 545  82E8 FE 76        	cp "v"
 546  82EA 28 03        	jr z,check_vgz1
 547  82EC FE 56        	cp "V"
 548  82EE C0           	ret nz
 549  82EF              check_vgz1
 550  82EF DD 7E 09     	ld a,(ix+9)
 551  82F2 FE 67        	cp "g"
 552  82F4 28 03        	jr z,check_vgz2
 553  82F6 FE 47        	cp "G"
 554  82F8 C0           	ret nz
 555  82F9              check_vgz2
 556  82F9 DD 7E 0A     	ld a,(ix+10)
 557  82FC FE 7A        	cp "z"
 558  82FE C8           	ret z
 559  82FF FE 5A        	cp "Z"
 560  8301 C0           	ret nz
 561  8302 AF           	xor a ;равен
 562  8303 C9           	ret
 563  8304
 564  8304
 565  8304              check_scr ;проверка на расширение SCR
 566  8304 DD 7E 08     	ld a,(ix+8)
 567  8307 FE 73        	cp "s"
 568  8309 28 03        	jr z,check_scr1
 569  830B FE 53        	cp "S"
 570  830D C0           	ret nz
 571  830E              check_scr1
 572  830E DD 7E 09     	ld a,(ix+9)
 573  8311 FE 63        	cp "c"
 574  8313 28 03        	jr z,check_scr2
 575  8315 FE 43        	cp "C"
 576  8317 C0           	ret nz
 577  8318              check_scr2
 578  8318 DD 7E 0A     	ld a,(ix+10)
 579  831B FE 72        	cp "r"
 580  831D C8           	ret z
 581  831E FE 52        	cp "R"
 582  8320 C0           	ret nz
 583  8321 AF           	xor a ;равен
 584  8322 C9           	ret
 585  8323
 586  8323
 587  8323
 588  8323              print_panel_r ;печать правой панели
 589  8323              	;ld ix,buffer_cat
 590  8323 FD 2A B4 98  	ld iy,(file_r_all) ;всего файлов
 591  8327 FD 7D        	ld a,iyl
 592  8329 FD B4        	or iyh
 593  832B C8           	ret z ;защита если 0
 594  832C 11 29 01     	ld de,panel_r_xy ;координаты yx
 595  832F 06 16        	ld b,panel_hight ;высота панели
 596  8331 FD 2A B6 98  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 597  8335              print_panel_r_cl ;цикл
 598  8335 C5           	push bc
 599  8336 D5           	push de ;xy
 600  8337              	OS_SET_XY
 600  8337 0E 01       >    ld c,#01
 600  8339 E7          >    rst #20
 601  833A
 602  833A              	;получить адрес элемента
 603  833A FD E5        	push iy
 604  833C E1           	pop hl
 605  833D CD 02 82     	call calc_deskr
 606  8340
 607  8340 CD 5B 83     	call print_file_info ;напечатать строку
 608  8343              print_panel_r_skip
 609  8343 D1           	pop de
 610  8344 14           	inc d ;y++
 611  8345 FD 23        	inc iy ;текущий файл
 612  8347              	;проверка на конец каталога
 613  8347 2A B4 98     	ld hl,(file_r_all)
 614  834A FD E5        	push iy
 615  834C C1           	pop bc
 616  834D A7           	and a
 617  834E ED 42        	sbc hl,bc
 618  8350 C1           	pop bc
 619  8351 38 07        	jr c,print_panel_r_ex2
 620  8353 28 05        	jr z,print_panel_r_ex2
 621  8355 10 DE        	djnz print_panel_r_cl
 622  8357 C9           	ret
 623  8358              print_panel_r_ex
 624  8358 D1           	pop de
 625  8359 C1           	pop bc
 626  835A              print_panel_r_ex2
 627  835A              	;тут, возможно, надо допечатать пустые строки
 628  835A C9           	ret
 629  835B
 630  835B
 631  835B
 632  835B
 633  835B
 634  835B              print_file_info ;печать строки о файле
 635  835B 3A DB 85     	ld a,(LFN_enable_flag)
 636  835E B7           	or a
 637  835F 28 4D        	jr z,print_file_info_SFN
 638  8361
 639  8361
 640  8361
 641  8361              print_file_info_LFN ;печать длинного имени
 642  8361              	;узнать номер записи
 643  8361 01 00 C0     	ld bc,#c000
 644  8364 A7           	and a
 645  8365 ED 42        	sbc hl,bc
 646  8367              ;разделить на 32
 647  8367 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 648  8369 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 649  836B CB 3C        	srl h ; /4
 650  836D CB 1D        	rr l ;
 651  836F CB 3C        	srl h ; /8
 652  8371 CB 1D        	rr l ;
 653  8373 CB 3C        	srl h ; /16
 654  8375 CB 1D        	rr l ;
 655  8377 CB 3C        	srl h ; /32
 656  8379 CB 1D        	rr l ;
 657  837B
 658  837B
 659  837B EB           	ex de,hl ;de - порядковый номер записи
 660  837C
 661  837C 21 ED BE     	ld hl,file_info_string ;куда
 662  837F              	OS_GET_LFN ;получить длинное имя
 662  837F 0E 2A       >    ld c,#2a
 662  8381 E7          >    rst #20
 663  8382
 664  8382 CD D6 83     	call get_color_item
 665  8385
 666  8385 06 0C        	ld b,#c
 667  8387              	OS_SET_COLOR
 667  8387 0E 06       >    ld c,#06
 667  8389 E7          >    rst #20
 668  838A
 669  838A              	;печать не длиннее 80/2 символов
 670  838A 21 ED BE     	ld hl,file_info_string
 671  838D 06 26        	ld b,80/2-2
 672  838F 0E 28        	ld c,40 ;колонка
 673  8391              print_file_info_LFN_cl
 674  8391 E5           	push hl
 675  8392 C5           	push bc
 676  8393 7E           	ld a,(hl)
 677  8394 B7           	or a
 678  8395 28 09        	jr z,print_file_info_LFN_cl_ex
 679  8397              	OS_PRINT_CHARF
 679  8397 D7          >	rst #10
 680  8398 C1           	pop bc
 681  8399 0C           	inc c
 682  839A E1           	pop hl
 683  839B 23           	inc hl
 684  839C 10 F3        	djnz print_file_info_LFN_cl
 685  839E 18 02        	jr print_file_info_LFN_ex
 686  83A0              print_file_info_LFN_cl_ex
 687  83A0 C1           	pop bc
 688  83A1 E1           	pop hl
 689  83A2              print_file_info_LFN_ex
 690  83A2              	;допечатать пробелы до правого края, зависит от длины имени
 691  83A2              print_file_info_LFN_cl2
 692  83A2 79           	ld a,c
 693  83A3 FE 4E        	cp 80-2
 694  83A5 D0           	ret nc
 695  83A6 C5           	push bc
 696  83A7 3E 20        	ld a,' '
 697  83A9              	OS_PRINT_CHARF
 697  83A9 D7          >	rst #10
 698  83AA C1           	pop bc
 699  83AB 0C           	inc c
 700  83AC 18 F4        	jr print_file_info_LFN_cl2
 701  83AE
 702  83AE
 703  83AE
 704  83AE              print_file_info_SFN ;печать короткого имени
 705  83AE 11 ED BE     	ld de,file_info_string ;скопировать
 706  83B1 01 08 00     	ld bc,8 ;file_info_lenght
 707  83B4 ED B0        	ldir
 708  83B6 3E 20        	ld a,' '
 709  83B8 12           	ld (de),a
 710  83B9 13           	inc de
 711  83BA 01 03 00     	ld bc,3
 712  83BD ED B0        	ldir
 713  83BF AF           	xor a
 714  83C0 12           	ld (de),a
 715  83C1
 716  83C1 CD D6 83     	call get_color_item
 717  83C4
 718  83C4 06 0C        	ld b,#c
 719  83C6              	OS_SET_COLOR
 719  83C6 0E 06       >    ld c,#06
 719  83C8 E7          >    rst #20
 720  83C9 21 ED BE     	ld hl,file_info_string
 721  83CC              	OS_PRINTZ
 721  83CC 0E 09       >    ld c,#09
 721  83CE E7          >    rst #20
 722  83CF              	;допечатать пробелы до правого края, длина имени постоянная
 723  83CF 21 CE 9A     	ld hl,file_info_string_SFN_end
 724  83D2              	OS_PRINTZ
 724  83D2 0E 09       >    ld c,#09
 724  83D4 E7          >    rst #20
 725  83D5 C9           	ret
 726  83D6
 727  83D6
 728  83D6
 729  83D6              get_color_item ;получить цвет элемента
 730  83D6              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 731  83D6              ;вых: A - цвет
 732  83D6 ED 4B C6 9A  	ld bc,(file_r_num_cur) ;позиция курсора справа
 733  83DA FD E5        	push iy
 734  83DC E1           	pop hl
 735  83DD A7           	and a
 736  83DE ED 42        	sbc hl,bc ;сравнить
 737  83E0 28 11        	jr z,get_color_item_no_cursor
 738  83E2              	;цвета курсора
 739  83E2 3E 0E        	ld a,color_dir ;простая
 740  83E4 32 0E 84     	ld (get_color_item_dir+1),a
 741  83E7 3E 0C        	ld a,color_apg ;простая
 742  83E9 32 16 84     	ld (get_color_item_apg+1),a
 743  83EC 3E 0F        	ld a,color_backgr ;простая
 744  83EE 32 19 84     	ld (get_color_item_backgr+1),a
 745  83F1 18 0F        	jr get_color_item_set
 746  83F3
 747  83F3              get_color_item_no_cursor
 748  83F3              	;цвета обычные
 749  83F3 3E 28        	ld a,color_dir_hi ;под курсором
 750  83F5 32 0E 84     	ld (get_color_item_dir+1),a
 751  83F8 3E 28        	ld a,color_apg_hi ;под курсором
 752  83FA 32 16 84     	ld (get_color_item_apg+1),a
 753  83FD 3E 28        	ld a,color_backgr_hi ;под курсором
 754  83FF 32 19 84     	ld (get_color_item_backgr+1),a
 755  8402
 756  8402              get_color_item_set
 757  8402              	;задать цвет
 758  8402 DD 7E 0B     	ld a,(ix+#0b)
 759  8405 FE 10        	cp #10 ;признак каталога
 760  8407 28 04        	jr z,get_color_item_dir
 761  8409 FE 30        	cp #30 ;признак каталога
 762  840B 20 03        	jr nz,get_color_item_no_dir
 763  840D              	;если папка
 764  840D              get_color_item_dir
 765  840D 3E 00        	ld a,0
 766  840F C9           	ret
 767  8410
 768  8410              get_color_item_no_dir
 769  8410 CD A7 82     	call check_apg ;расширение apg
 770  8413 20 03        	jr nz,get_color_item_no_apg
 771  8415              	;если приложение
 772  8415              get_color_item_apg
 773  8415 3E 00        	ld a,0
 774  8417 C9           	ret
 775  8418
 776  8418              get_color_item_no_apg
 777  8418              	;если обычный файл
 778  8418              get_color_item_backgr
 779  8418 3E 00        	ld a,0
 780  841A C9           	ret
 781  841B
 782  841B
 783  841B
 784  841B              ; format_dir ;подготовить каталог, убрать лишнее
 785  841B              	; ; ld a,2
 786  841B              	; ; out (254),a
 787  841B              	; ld iy,0 ;счётчик файлов
 788  841B              	; ;найти конец каталога
 789  841B              	; ld hl,buffer_cat
 790  841B              	; ld a,(hl)
 791  841B              	; or a
 792  841B              	; ret z ;защита
 793  841B              	; ld bc,32
 794  841B              ; format_dir_prep_cl
 795  841B              	; ld a,(hl)
 796  841B              	; or a
 797  841B              	; jr z,format_dir_prep_ex
 798  841B              	; add hl,bc
 799  841B              	; ld a,h
 800  841B              	; or a ;если вышли за границу
 801  841B              	; jr z,format_dir_prep_ex
 802  841B              	; jr format_dir_prep_cl
 803  841B              ; format_dir_prep_ex
 804  841B              	; ld bc,32
 805  841B              	; and a
 806  841B              	; sbc hl,bc
 807  841B              	; ld (format_dir_top),hl ;конец каталога
 808  841B
 809  841B
 810  841B
 811  841B              	; ld ix,buffer_cat
 812  841B              	; ;ld b,panel_hight ;высота панели
 813  841B              ; format_dir_cl ;цикл
 814  841B              	; ld a,(ix)
 815  841B              	; or a ;конец каталога
 816  841B              	; jr z,format_dir_ex
 817  841B              	; cp #e5 ;удалённый
 818  841B              	; jr z,format_dir_skip
 819  841B              	; cp #05 ;удалённый
 820  841B              	; jr z,format_dir_skip
 821  841B              	; ld a,(ix+#0b)
 822  841B              	; cp #0f ;длинный
 823  841B              	; jr z,format_dir_skip
 824  841B
 825  841B              	; ;проверка на папку "." (этот же каталог)
 826  841B              	; ld a,(ix+#00)
 827  841B              	; cp "." ;
 828  841B              	; jr nz,format_dir_add
 829  841B              	; ld a,(ix+#01)
 830  841B              	; cp " " ;
 831  841B              	; jr z,format_dir_skip
 832  841B
 833  841B
 834  841B              ; format_dir_add
 835  841B              	; inc iy ;++
 836  841B              	; ld bc,32 ;на другой элемент каталога
 837  841B              	; add ix,bc
 838  841B              	; ld a,ixh
 839  841B              	; or a ;если вышли за границу
 840  841B              	; jr z,format_dir_ex
 841  841B              	; jr format_dir_cl
 842  841B              ; format_dir_skip
 843  841B              	; ;сдвинуть элементы вниз
 844  841B              	; push ix
 845  841B              	; push ix
 846  841B              	; pop hl
 847  841B              	; pop de ;куда
 848  841B              	; ld hl,(format_dir_top) ;0-32
 849  841B              	; and a
 850  841B              	; sbc hl,de
 851  841B              	; ld b,h
 852  841B              	; ld c,l ;длина
 853  841B              	; push bc
 854  841B
 855  841B              	; push ix
 856  841B              	; pop hl ;откуда
 857  841B              	; ld bc,32 ;на другой элемент каталога
 858  841B              	; add hl,bc ;откуда
 859  841B
 860  841B              	; pop bc
 861  841B              	; ldir
 862  841B
 863  841B              	; xor a
 864  841B              	; ld (de),a ;очистить ненужный элемент
 865  841B
 866  841B              	; jr format_dir_cl
 867  841B
 868  841B              ; format_dir_ex
 869  841B              	; ld (file_r_all),iy
 870  841B              	; ;здесь почистить остаток каталога
 871  841B              	; ; ld a,0
 872  841B              	; ; out (254),a
 873  841B              	; ret
 874  841B              ; format_dir_top	dw 0 ;временно конец гаталога
 875  841B
 876  841B
 877  841B
 878  841B
 879  841B
 880  841B              sort_dir ;сортировка каталога с помощью построения индекса
 881  841B DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 882  841F DD 7E 00     	ld a,(ix)
 883  8422 B7           	or a
 884  8423 C8           	ret z ;если пусто, выход
 885  8424 FD 21 00 00  	ld iy,0 ;счётчик всего файлов
 886  8428
 887  8428
 888  8428 3A BE 85     	ld a,(sort_enable_flag)
 889  842B B7           	or a
 890  842C CA 93 84     	jp z,sort_dir_no ;если без сортировки
 891  842F
 892  842F 21 ED B6     	ld hl,cat_index
 893  8432 22 8F 84     	ld (sort_item_adr_end),hl
 894  8435
 895  8435 21 ED BA     	ld hl,cat_index_2 ;таблица - индекс 2
 896  8438 CD 12 85     	call sort_dir_one ;проход по папкам
 897  843B
 898  843B FD 7C        	ld a,iyh
 899  843D FD B5        	or iyl
 900  843F 28 19        	jr z,sort_dir_skip ;если не было папок
 901  8441
 902  8441 DD 21 ED BA  	ld ix,cat_index_2
 903  8445 CD 5C 85     	call sort_index ;отсортировать по алфавиту
 904  8448              	;перенести индекс в основной
 905  8448 FD E5        	push iy
 906  844A E1           	pop hl ;сколько
 907  844B 29           	add hl,hl ;*2 по 2 байта на элемент
 908  844C E5           	push hl
 909  844D C1           	pop bc
 910  844E 21 ED BA     	ld hl,cat_index_2
 911  8451 11 ED B6     	ld de,cat_index
 912  8454 ED B0        	ldir
 913  8456 ED 53 8F 84  	ld (sort_item_adr_end),de ;запомнить адрес последнего
 914  845A
 915  845A              sort_dir_skip
 916  845A FD 22 91 84  	ld (sort_item_count),iy
 917  845E FD 21 00 00  	ld iy,0 ;счётчик всего файлов
 918  8462 21 ED BA     	ld hl,cat_index_2 ;таблица - индекс 2
 919  8465 CD D6 84     	call sort_file_one ;проход по файлам
 920  8468 FD 7C        	ld a,iyh
 921  846A FD B5        	or iyl
 922  846C 28 16        	jr z,sort_file_skip ;если не было файлов
 923  846E
 924  846E DD 21 ED BA  	ld ix,cat_index_2
 925  8472 CD 5C 85     	call sort_index ;отсортировать по алфавиту
 926  8475              	;добавить индекс к основному
 927  8475 FD E5        	push iy
 928  8477 E1           	pop hl ;сколько
 929  8478 29           	add hl,hl ;*2 по 2 байта на элемент
 930  8479 E5           	push hl
 931  847A C1           	pop bc
 932  847B 21 ED BA     	ld hl,cat_index_2
 933  847E ED 5B 8F 84  	ld de,(sort_item_adr_end)
 934  8482 ED B0        	ldir
 935  8484
 936  8484              sort_file_skip
 937  8484              	;скорректировать количество
 938  8484 ED 4B 91 84  	ld bc,(sort_item_count)
 939  8488 FD 09        	add iy,bc
 940  848A FD 22 B4 98  	ld (file_r_all),iy
 941  848E C9           	ret
 942  848F
 943  848F 00 00        sort_item_adr_end dw 0; временно
 944  8491 00 00        sort_item_count dw 0; временно
 945  8493
 946  8493
 947  8493
 948  8493              ;без сортировки
 949  8493              sort_dir_no
 950  8493 21 ED B6     	ld hl,cat_index ;таблица - индекс
 951  8496 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 952  849A              sort_dir_no_cl ;цикл по каталогам
 953  849A DD 7E 00     	ld a,(ix)
 954  849D B7           	or a ;конец каталога
 955  849E 28 31        	jr z,sort_dir_no_ex
 956  84A0 FE E5        	cp #e5 ;удалённый
 957  84A2 28 22        	jr z,sort_dir_no_skip
 958  84A4 FE 05        	cp #05 ;удалённый
 959  84A6 28 1E        	jr z,sort_dir_no_skip
 960  84A8 DD 7E 0B     	ld a,(ix+#0b)
 961  84AB FE 0F        	cp #0f ;длинный
 962  84AD 28 17        	jr z,sort_dir_no_skip
 963  84AF
 964  84AF              	;проверка на папку "." (этот же каталог)
 965  84AF DD 7E 00     	ld a,(ix+#00)
 966  84B2 FE 2E        	cp "." ;
 967  84B4 20 07        	jr nz,sort_dir_no_add
 968  84B6 DD 7E 01     	ld a,(ix+#01)
 969  84B9 FE 20        	cp " " ;
 970  84BB 28 09        	jr z,sort_dir_no_skip
 971  84BD
 972  84BD              sort_dir_no_add
 973  84BD FD 23        	inc iy ;++
 974  84BF              	;записать в таблицу (индекс)
 975  84BF DD E5        	push ix
 976  84C1 C1           	pop bc
 977  84C2 71           	ld (hl),c
 978  84C3 23           	inc hl
 979  84C4 70           	ld (hl),b
 980  84C5 23           	inc hl
 981  84C6
 982  84C6
 983  84C6              sort_dir_no_skip
 984  84C6 01 20 00     	ld bc,32
 985  84C9 DD 09        	add ix,bc ;на следующий
 986  84CB DD 7C        	ld a,ixh ;проверка на конец буфера
 987  84CD FE C0        	cp #c0
 988  84CF 30 C9        	jr nc,sort_dir_no_cl
 989  84D1
 990  84D1              sort_dir_no_ex
 991  84D1 FD 22 B4 98  	ld (file_r_all),iy
 992  84D5 C9           	ret
 993  84D6
 994  84D6
 995  84D6              ;сортировка файлов
 996  84D6              sort_file_one
 997  84D6 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 998  84DA              sort_file_one_cl ;цикл по каталогам
 999  84DA DD 7E 00     	ld a,(ix)
1000  84DD B7           	or a ;конец каталога
1001  84DE 28 31        	jr z,sort_file_one_ex
1002  84E0 DD 7E 0B     	ld a,(ix+#0b)
1003  84E3 FE 10        	cp #10 ;признак каталога
1004  84E5 28 1F        	jr z,sort_file_one_skip
1005  84E7 FE 30        	cp #30 ;признак каталога
1006  84E9 28 1B        	jr z,sort_file_one_skip
1007  84EB DD 7E 00     	ld a,(ix)
1008  84EE FE E5        	cp #e5 ;удалённый
1009  84F0 28 14        	jr z,sort_file_one_skip
1010  84F2 FE 05        	cp #05 ;удалённый
1011  84F4 28 10        	jr z,sort_file_one_skip
1012  84F6 DD 7E 0B     	ld a,(ix+#0b)
1013  84F9 FE 0F        	cp #0f ;длинный
1014  84FB 28 09        	jr z,sort_file_one_skip
1015  84FD
1016  84FD              	; ;проверка на папку "." (этот же каталог)
1017  84FD              	; ld a,(ix+#00)
1018  84FD              	; cp "." ;
1019  84FD              	; jr nz,sort_file_one_add
1020  84FD              	; ld a,(ix+#01)
1021  84FD              	; cp " " ;
1022  84FD              	; jr z,sort_file_one_skip
1023  84FD
1024  84FD
1025  84FD              sort_file_one_add
1026  84FD FD 23        	inc iy ;++
1027  84FF              	;записать в таблицу (индекс)
1028  84FF DD E5        	push ix
1029  8501 C1           	pop bc
1030  8502 71           	ld (hl),c
1031  8503 23           	inc hl
1032  8504 70           	ld (hl),b
1033  8505 23           	inc hl
1034  8506
1035  8506
1036  8506              sort_file_one_skip
1037  8506 01 20 00     	ld bc,32
1038  8509 DD 09        	add ix,bc ;на следующий
1039  850B DD 7C        	ld a,ixh ;проверка на конец буфера
1040  850D FE C0        	cp #c0
1041  850F 30 C9        	jr nc,sort_file_one_cl
1042  8511
1043  8511              sort_file_one_ex
1044  8511              	;ld (file_r_all),iy
1045  8511 C9           	ret
1046  8512
1047  8512
1048  8512
1049  8512
1050  8512
1051  8512              ;сортировка папок
1052  8512              sort_dir_one
1053  8512 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1054  8516              sort_dir_one_cl ;цикл по каталогам
1055  8516 DD 7E 00     	ld a,(ix)
1056  8519 B7           	or a ;конец каталога
1057  851A 28 3F        	jr z,sort_dir_one_ex
1058  851C DD 7E 0B     	ld a,(ix+#0b)
1059  851F FE 10        	cp #10 ;признак каталога
1060  8521 28 04        	jr z,sort_dir_one_skip_no
1061  8523 FE 30        	cp #30 ;признак каталога
1062  8525 20 29        	jr nz,sort_dir_one_skip
1063  8527              sort_dir_one_skip_no
1064  8527 DD 7E 00     	ld a,(ix)
1065  852A FE E5        	cp #e5 ;удалённый
1066  852C 28 22        	jr z,sort_dir_one_skip
1067  852E FE 05        	cp #05 ;удалённый
1068  8530 28 1E        	jr z,sort_dir_one_skip
1069  8532 DD 7E 0B     	ld a,(ix+#0b)
1070  8535 FE 0F        	cp #0f ;длинный
1071  8537 28 17        	jr z,sort_dir_one_skip
1072  8539
1073  8539              	;проверка на папку "." (этот же каталог)
1074  8539 DD 7E 00     	ld a,(ix+#00)
1075  853C FE 2E        	cp "." ;
1076  853E 20 07        	jr nz,sort_dir_one_add
1077  8540 DD 7E 01     	ld a,(ix+#01)
1078  8543 FE 20        	cp " " ;
1079  8545 28 09        	jr z,sort_dir_one_skip
1080  8547
1081  8547              sort_dir_one_add
1082  8547 FD 23        	inc iy ;++
1083  8549              	;записать в таблицу (индекс)
1084  8549 DD E5        	push ix
1085  854B C1           	pop bc
1086  854C 71           	ld (hl),c
1087  854D 23           	inc hl
1088  854E 70           	ld (hl),b
1089  854F 23           	inc hl
1090  8550
1091  8550
1092  8550              sort_dir_one_skip
1093  8550 01 20 00     	ld bc,32
1094  8553 DD 09        	add ix,bc ;на следующий
1095  8555 DD 7C        	ld a,ixh ;проверка на конец буфера
1096  8557 FE C0        	cp #c0
1097  8559 30 BB        	jr nc,sort_dir_one_cl
1098  855B
1099  855B              sort_dir_one_ex
1100  855B              	;ld (file_r_all),iy
1101  855B C9           	ret
1102  855C
1103  855C
1104  855C
1105  855C              ;сортировка индекса методом пузырька
1106  855C              ;вх: iy - сколько (>1)
1107  855C              ;вх: ix - адрес таблицы
1108  855C              sort_index
1109  855C FD 7C        	ld a,iyh ;проверка, число элементов должно быть > 1
1110  855E B7           	or a
1111  855F 20 05        	jr nz,sort_index1
1112  8561 FD 7D        	ld a,iyl
1113  8563 FE 02        	cp 2
1114  8565 D8           	ret c
1115  8566              sort_index1
1116  8566 FD E5        	push iy
1117  8568 C1           	pop bc ;цикл проходов общий
1118  8569 0B           	dec bc ;-1
1119  856A
1120  856A              sort_index_cl_gen ;цикл основной
1121  856A C5           	push bc
1122  856B DD E5        	push ix
1123  856D
1124  856D FD E5        	push iy
1125  856F C1           	pop bc ;внутренний цикл столько же
1126  8570 0B           	dec bc ;-1
1127  8571              sort_index_cl ;цикл внутренний
1128  8571              	;первый элемент узнать адрес записи в каталоге
1129  8571 DD 5E 00     	ld e,(ix+00)
1130  8574 DD 56 01     	ld d,(ix+01)
1131  8577 1A           	ld a,(de) ;первая буква имени
1132  8578              	;второй элемент узнать адрес записи в каталоге
1133  8578 DD 6E 02     	ld l,(ix+02)
1134  857B DD 66 03     	ld h,(ix+03)
1135  857E              	;сравнить с другой первой буквой
1136  857E BE           	cp (hl)
1137  857F 38 0C        	jr c,sort_index_cl_skip
1138  8581              	;поменять местами элементы индекса
1139  8581 DD 75 00     	ld (ix+00),l
1140  8584 DD 74 01     	ld (ix+01),h
1141  8587 DD 73 02     	ld (ix+02),e
1142  858A DD 72 03     	ld (ix+03),d
1143  858D
1144  858D              sort_index_cl_skip
1145  858D              	;следующий
1146  858D DD 23        	inc ix
1147  858F DD 23        	inc ix
1148  8591
1149  8591 0B           	dec bc
1150  8592 78           	ld a,b
1151  8593 B1           	or c
1152  8594 20 DB        	jr nz,sort_index_cl
1153  8596
1154  8596 DD E1        	pop ix
1155  8598 C1           	pop bc
1156  8599 0B           	dec bc
1157  859A 78           	ld a,b
1158  859B B1           	or c
1159  859C 20 CC        	jr nz,sort_index_cl_gen
1160  859E
1161  859E C9           	ret
1162  859F
1163  859F
1164  859F
1165  859F
1166  859F              sort_toggle ;переключение сортировки
1167  859F 3A BE 85     	ld a,(sort_enable_flag)
1168  85A2 EE 01        	xor 1
1169  85A4 32 BE 85     	ld (sort_enable_flag),a
1170  85A7 3E 66        	ld a,"f" ;вкл
1171  85A9 20 02        	jr nz,sort_toggle1
1172  85AB 3E 4E        	ld a,"N";выкл
1173  85AD              sort_toggle1
1174  85AD 32 85 9B     	ld (msg_menu_main2+5),a
1175  85B0
1176  85B0 CD 1B 84     	call sort_dir
1177  85B3 CD 46 86     	call print_menu_main
1178  85B6 3E 01        	ld a,1
1179  85B8 32 CD 9A     	ld (print_panel_r_flag),a
1180  85BB
1181  85BB C3 5C 80     	jp nc_wait
1182  85BE 00           sort_enable_flag db 0 ;флаг сортировки
1183  85BF
1184  85BF
1185  85BF
1186  85BF
1187  85BF              LFN_toggle ;переключение сортировки
1188  85BF 3A DB 85     	ld a,(LFN_enable_flag)
1189  85C2 EE 01        	xor 1
1190  85C4 32 DB 85     	ld (LFN_enable_flag),a
1191  85C7 3E 66        	ld a,"f" ;вкл
1192  85C9 20 02        	jr nz,LFN_toggle1
1193  85CB 3E 4E        	ld a,"N";выкл
1194  85CD              LFN_toggle1
1195  85CD 32 7E 9B     	ld (msg_menu_main1+5),a
1196  85D0
1197  85D0              	;call sort_dir
1198  85D0 CD 46 86     	call print_menu_main
1199  85D3 3E 01        	ld a,1
1200  85D5 32 CD 9A     	ld (print_panel_r_flag),a
1201  85D8
1202  85D8 C3 5C 80     	jp nc_wait
1203  85DB 00           LFN_enable_flag db 0 ;флаг сортировки
1204  85DC
1205  85DC
1206  85DC
1207  85DC
1208  85DC
1209  85DC              format_name ;подогнать имя под стандарт filename.ext
1210  85DC              ;вх: HL - имя в каталоге
1211  85DC E5           	push hl
1212  85DD 21 B8 98     	ld hl,file_name_cur
1213  85E0 11 B9 98     	ld de,file_name_cur+1 ;почистить
1214  85E3 01 FF 00     	ld bc,256-1
1215  85E6 36 00        	ld (hl),0
1216  85E8 ED B0        	ldir
1217  85EA
1218  85EA E1           	pop hl
1219  85EB E5           	push hl
1220  85EC
1221  85EC 11 B8 98     	ld de,file_name_cur ;куда
1222  85EF 01 FF 08     	ld bc,#08ff
1223  85F2              format_name_cl
1224  85F2 7E           	ld a,(hl)
1225  85F3 FE 21        	cp " "+1
1226  85F5 38 04        	jr c,format_name_skip
1227  85F7 ED A0        	ldi
1228  85F9 10 F7        	djnz format_name_cl
1229  85FB              format_name_skip
1230  85FB 3E 2E        	ld a,"."
1231  85FD 12           	ld (de),a
1232  85FE
1233  85FE 13           	inc de
1234  85FF E1           	pop hl
1235  8600 01 08 00     	ld bc,8 ;перейти на расширение
1236  8603 09           	add hl,bc
1237  8604
1238  8604 01 FF 03     	ld bc,#03ff
1239  8607              format_name_cl2
1240  8607 7E           	ld a,(hl)
1241  8608 FE 21        	cp " "+1
1242  860A 38 04        	jr c,format_name_skip2
1243  860C ED A0        	ldi
1244  860E 10 F7        	djnz format_name_cl2
1245  8610              format_name_skip2
1246  8610 C9           	ret
1247  8611
1248  8611              print_rect_r ;печать рамки правой
1249  8611 3E 0F        	ld a,color_backgr ;цвет
1250  8613 06 0C        	ld b,#c
1251  8615              	OS_SET_COLOR
1251  8615 0E 06       >    ld c,#06
1251  8617 E7          >    rst #20
1252  8618 11 28 00     	ld de,#0028 ;xy
1253  861B              	OS_SET_XY
1253  861B 0E 01       >    ld c,#01
1253  861D E7          >    rst #20
1254  861E 21 E9 9A     	ld hl,rect_1
1255  8621              	OS_PRINTZ
1255  8621 0E 09       >    ld c,#09
1255  8623 E7          >    rst #20
1256  8624
1257  8624 11 28 01     	ld de,#0128 ;xy
1258  8627 06 16        	ld b,24-2 ;цикл
1259  8629              print_rect_r_cl
1260  8629 C5           	push bc
1261  862A D5           	push de
1262  862B              	OS_SET_XY
1262  862B 0E 01       >    ld c,#01
1262  862D E7          >    rst #20
1263  862E 21 12 9B     	ld hl,rect_2
1264  8631              	OS_PRINTZ
1264  8631 0E 09       >    ld c,#09
1264  8633 E7          >    rst #20
1265  8634 D1           	pop de
1266  8635 14           	inc d
1267  8636 C1           	pop bc
1268  8637 10 F0        	djnz print_rect_r_cl
1269  8639
1270  8639
1271  8639 11 28 17     	ld de,#1728 ;xy
1272  863C              	OS_SET_XY
1272  863C 0E 01       >    ld c,#01
1272  863E E7          >    rst #20
1273  863F 21 3B 9B     	ld hl,rect_3
1274  8642              	OS_PRINTZ
1274  8642 0E 09       >    ld c,#09
1274  8644 E7          >    rst #20
1275  8645 C9           	ret
1276  8646
1277  8646              print_menu_main ;печать основного меню
1278  8646 3E 07        	ld a,color_default ;цвет
1279  8648 06 0C        	ld b,#c
1280  864A              	OS_SET_COLOR
1280  864A 0E 06       >    ld c,#06
1280  864C E7          >    rst #20
1281  864D
1282  864D 11 00 18     	ld de,#1800+0*8
1283  8650              	OS_SET_XY
1283  8650 0E 01       >    ld c,#01
1283  8652 E7          >    rst #20
1284  8653 3E 31        	ld a,"1" ;пункт 1
1285  8655              	OS_PRINT_CHARF
1285  8655 D7          >	rst #10
1286  8656 11 08 18     	ld de,#1800+1*8
1287  8659              	OS_SET_XY
1287  8659 0E 01       >    ld c,#01
1287  865B E7          >    rst #20
1288  865C 3E 32        	ld a,"2" ;пункт 2
1289  865E              	OS_PRINT_CHARF
1289  865E D7          >	rst #10
1290  865F 11 10 18     	ld de,#1800+2*8
1291  8662              	OS_SET_XY
1291  8662 0E 01       >    ld c,#01
1291  8664 E7          >    rst #20
1292  8665 3E 33        	ld a,"3" ;пункт 3
1293  8667              	OS_PRINT_CHARF
1293  8667 D7          >	rst #10
1294  8668
1295  8668
1296  8668 3E 28        	ld a,color_backgr_hi ;цвет
1297  866A 06 0C        	ld b,#c
1298  866C              	OS_SET_COLOR
1298  866C 0E 06       >    ld c,#06
1298  866E E7          >    rst #20
1299  866F
1300  866F 11 01 18     	ld de,#1800+0*8+1
1301  8672              	OS_SET_XY
1301  8672 0E 01       >    ld c,#01
1301  8674 E7          >    rst #20
1302  8675 21 79 9B     	ld hl,msg_menu_main1
1303  8678              	OS_PRINTZ
1303  8678 0E 09       >    ld c,#09
1303  867A E7          >    rst #20
1304  867B 11 09 18     	ld de,#1800+1*8+1
1305  867E              	OS_SET_XY
1305  867E 0E 01       >    ld c,#01
1305  8680 E7          >    rst #20
1306  8681 21 80 9B     	ld hl,msg_menu_main2
1307  8684              	OS_PRINTZ
1307  8684 0E 09       >    ld c,#09
1307  8686 E7          >    rst #20
1308  8687 11 11 18     	ld de,#1800+2*8+1
1309  868A              	OS_SET_XY
1309  868A 0E 01       >    ld c,#01
1309  868C E7          >    rst #20
1310  868D 21 87 9B     	ld hl,msg_menu_main3
1311  8690              	OS_PRINTZ
1311  8690 0E 09       >    ld c,#09
1311  8692 E7          >    rst #20
1312  8693 C9           	ret
1313  8694
1314  8694
1315  8694              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 8694              view_file
   2+ 8694              	;просмотр файла как текста
   3+ 8694
   4+ 8694 2A B4 98     	ld hl,(file_r_all)
   5+ 8697 7D           	ld a,l
   6+ 8698 B4           	or h
   7+ 8699 CA 75 87     	jp z,view_file_ex ;защита
   8+ 869C 2A C6 9A     	ld hl,(file_r_num_cur)
   9+ 869F CD 02 82     	call calc_deskr
  10+ 86A2 DD 7E 0B     	ld a,(ix+#0b)
  11+ 86A5 FE 10        	cp #10 ;признак каталога
  12+ 86A7 CA 75 87     	jp z,view_file_ex
  13+ 86AA
  14+ 86AA CD DC 85     	call format_name ;обработать имя файла
  15+ 86AD
  16+ 86AD
  17+ 86AD
  18+ 86AD              	OS_CLS ;почистить экран
  18+ 86AD 0E 00       >    ld c,#00
  18+ 86AF E7          >    rst #20
  19+ 86B0
  20+ 86B0              	;обнулить переменные
  21+ 86B0 AF           	xor a
  22+ 86B1 32 9A 89     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  23+ 86B4              	;ld (view_file_bot_flag),a  ;
  24+ 86B4 21 FF FF     	ld hl,#ffff
  25+ 86B7 22 9B 89     	ld (view_file_end),hl ;конец файла тут
  26+ 86BA 23           	inc hl
  27+ 86BB 22 92 89     	ld (view_move_right_val),hl
  28+ 86BE
  29+ 86BE C5           	push bc
  30+ 86BF CD B3 80     	call clear_buf
  31+ 86C2 C1           	pop bc
  32+ 86C3
  33+ 86C3 3E FF        	ld a,255
  34+ 86C5 32 C9 9A     	ld (file_id_cur_r),a
  35+ 86C8 21 B8 98     	ld hl,file_name_cur		;строка с именем
  36+ 86CB              	OS_FILE_OPEN
  36+ 86CB 0E 21       >    ld c,#21
  36+ 86CD E7          >    rst #20
  37+ 86CE 30 0E        	jr nc,view_file_open_ok
  38+ 86D0              view_file_file_error
  39+ 86D0 21 8D 9B     	ld hl,msg_file_error
  40+ 86D3              	OS_PRINTZ
  40+ 86D3 0E 09       >    ld c,#09
  40+ 86D5 E7          >    rst #20
  41+ 86D6 06 64        	ld b,2*50
  42+ 86D8 CD AF 80     	call delay1
  43+ 86DB C3 65 87     	jp view_file_wait_ex
  44+ 86DE
  45+ 86DE              view_file_open_ok
  46+ 86DE 32 C9 9A     	ld (file_id_cur_r),a
  47+ 86E1              	;проверка длины файла не больше #4000
  48+ 86E1 7A           	ld	a,d ;самые старшие байты длины
  49+ 86E2 B3           	or e
  50+ 86E3 28 11        	jr z,view_file_size_ok ;если не слищком большой
  51+ 86E5              view_file_too_big
  52+ 86E5              	;файл больше буфера
  53+ 86E5 11 00 40     	ld de,#4000 ;размер одной первой части
  54+ 86E8 21 00 C0     	ld hl,buffer_cat
  55+ 86EB 3A C9 9A     	ld a,(file_id_cur_r)
  56+ 86EE              	OS_FILE_READ ;загрузить
  56+ 86EE 0E 23       >    ld c,#23
  56+ 86F0 E7          >    rst #20
  57+ 86F1 38 DD        	jr c,view_file_file_error
  58+ 86F3
  59+ 86F3 C3 1F 87     	jp view_file_readed
  60+ 86F6
  61+ 86F6              view_file_size_ok
  62+ 86F6 78           	ld	a,b ;младший старший байт длины
  63+ 86F7 FE 40        	cp #40
  64+ 86F9 38 06        	jr c,view_file_size_ok_small
  65+ 86FB 20 E8        	jr nz,view_file_too_big
  66+ 86FD 0C           	inc c
  67+ 86FE 0D           	dec c
  68+ 86FF 20 E4        	jr nz,view_file_too_big
  69+ 8701
  70+ 8701
  71+ 8701              view_file_size_ok_small
  72+ 8701              	;проверка на 0
  73+ 8701 78           	ld a,b
  74+ 8702 B1           	or c
  75+ 8703 CA D0 86     	jp z,view_file_file_error
  76+ 8706              	;узнать где конец файла
  77+ 8706 21 00 C0     	ld hl,buffer_cat
  78+ 8709 09           	add hl,bc
  79+ 870A 22 9B 89     	ld (view_file_end),hl ;конец файла тут
  80+ 870D              	;размер не большой, прочитаем
  81+ 870D 50           	ld d,b ;размер
  82+ 870E 59           	ld e,c
  83+ 870F 21 00 C0     	ld hl,buffer_cat
  84+ 8712 3A C9 9A     	ld a,(file_id_cur_r)
  85+ 8715              	OS_FILE_READ ;загрузить
  85+ 8715 0E 23       >    ld c,#23
  85+ 8717 E7          >    rst #20
  86+ 8718 38 B6        	jr c,view_file_file_error
  87+ 871A
  88+ 871A 3E 01        	ld a,1
  89+ 871C 32 9A 89     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  90+ 871F
  91+ 871F              view_file_readed
  92+ 871F              	;файл прочитан
  93+ 871F
  94+ 871F 21 00 C0     	ld hl,buffer_cat
  95+ 8722 22 94 89     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  96+ 8725 22 96 89     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  97+ 8728
  98+ 8728 CD 3E 88     	call print_file_text
  99+ 872B
 100+ 872B
 101+ 872B CD 09 88     	call print_menu_view ;меню
 102+ 872E CD 24 88     	call print_menu_view_top ;инфо
 103+ 8731
 104+ 8731 CD 0B 81     	call release_key
 105+ 8734
 106+ 8734              view_file_wait ;цикл ожидания клавиши
 107+ 8734              	OS_WAIT
 107+ 8734 DF          >	rst #18
 108+ 8735              	OS_GET_CHAR
 108+ 8735 0E 10       >    ld c,#10
 108+ 8737 E7          >    rst #20
 109+ 8738 FE FF        	cp 255
 110+ 873A 28 F8        	jr z,view_file_wait
 111+ 873C FE 33        	cp "3"
 112+ 873E 28 25        	jr z,view_file_wait_ex
 113+ 8740 FE 0A        	cp 10 ;вниз
 114+ 8742 CA 82 87     	jp z,view_line_down
 115+ 8745 FE 0B        	cp 11 ;вверх
 116+ 8747 CA 98 87     	jp z,view_line_up
 117+ 874A FE 09        	cp 09 ;вправо
 118+ 874C CA AC 87     	jp z,view_right
 119+ 874F FE 08        	cp 08 ;влево
 120+ 8751 CA BD 87     	jp z,view_left
 121+ 8754 FE 04        	cp 04 ;страница вверх
 122+ 8756 CA CF 87     	jp z,view_page_up
 123+ 8759 FE 05        	cp 05 ;страница вниз
 124+ 875B CA EC 87     	jp z,view_page_down
 125+ 875E FE 18        	cp 24 ;break
 126+ 8760 CA A3 82     	jp z,exit
 127+ 8763 18 CF        	jr view_file_wait
 128+ 8765
 129+ 8765              view_file_wait_ex
 130+ 8765 3A C9 9A     	ld a,(file_id_cur_r)
 131+ 8768 FE FF        	cp 255
 132+ 876A 28 03        	jr z,view_file_wait_ex1
 133+ 876C              	OS_FILE_CLOSE ;A - id file
 133+ 876C 0E 25       >    ld c,#25
 133+ 876E E7          >    rst #20
 134+ 876F              view_file_wait_ex1
 135+ 876F              	;почистить экран
 136+ 876F              	OS_CLS
 136+ 876F 0E 00       >    ld c,#00
 136+ 8771 E7          >    rst #20
 137+ 8772 C3 23 80     	jp start_nc_warm ;перезагрузить папку
 138+ 8775
 139+ 8775              view_file_ex
 140+ 8775 3A C9 9A     	ld a,(file_id_cur_r)
 141+ 8778 FE FF        	cp 255
 142+ 877A 28 03        	jr z,view_file_ex1
 143+ 877C              	OS_FILE_CLOSE ;A - id file
 143+ 877C 0E 25       >    ld c,#25
 143+ 877E E7          >    rst #20
 144+ 877F              view_file_ex1
 145+ 877F C3 5C 80     	jp nc_wait
 146+ 8782
 147+ 8782
 148+ 8782
 149+ 8782              view_line_down ;вниз на строчку
 150+ 8782 2A 96 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 151+ 8785 22 94 89     	ld (view_file_pos_cur),hl
 152+ 8788 CD 65 89     	call next_line ;вперёд на строку
 153+ 878B 38 A7        	jr c,view_file_wait ;если не удачно
 154+ 878D 2A 94 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 155+ 8790 22 96 89     	ld (view_file_pos_cur_focus),hl
 156+ 8793 CD 3E 88     	call print_file_text ;напечатать всю страницу
 157+ 8796 18 9C        	jr view_file_wait
 158+ 8798
 159+ 8798              view_line_up ;вверх на строчку
 160+ 8798 2A 96 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 161+ 879B 22 94 89     	ld (view_file_pos_cur),hl
 162+ 879E CD 73 89     	call prev_line ;
 163+ 87A1              	;jr c,view_file_wait ;если не удачно
 164+ 87A1 2A 94 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 165+ 87A4 22 96 89     	ld (view_file_pos_cur_focus),hl
 166+ 87A7 CD 3E 88     	call print_file_text ;напечатать всю страницу
 167+ 87AA 18 88        	jr view_file_wait
 168+ 87AC
 169+ 87AC
 170+ 87AC              view_right ;вправо
 171+ 87AC 2A 92 89     	ld hl,(view_move_right_val)
 172+ 87AF 23           	inc hl
 173+ 87B0 7C           	ld a,h
 174+ 87B1 B5           	or l
 175+ 87B2 28 80        	jr z,view_file_wait
 176+ 87B4 22 92 89     	ld (view_move_right_val),hl
 177+ 87B7 CD 3E 88     	call print_file_text ;напечатать всю страницу
 178+ 87BA C3 34 87     	jp view_file_wait
 179+ 87BD
 180+ 87BD              view_left ;влево
 181+ 87BD 2A 92 89     	ld hl,(view_move_right_val)
 182+ 87C0 7C           	ld a,h
 183+ 87C1 B5           	or l
 184+ 87C2 CA 34 87     	jp z,view_file_wait
 185+ 87C5 2B           	dec hl
 186+ 87C6 22 92 89     	ld (view_move_right_val),hl
 187+ 87C9 CD 3E 88     	call print_file_text ;напечатать всю страницу
 188+ 87CC C3 34 87     	jp view_file_wait
 189+ 87CF
 190+ 87CF
 191+ 87CF
 192+ 87CF              view_page_up ;на страницу назад
 193+ 87CF 2A 96 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 194+ 87D2 22 94 89     	ld (view_file_pos_cur),hl
 195+ 87D5 06 16        	ld b,view_text_bot-2
 196+ 87D7              view_page_up_cl
 197+ 87D7 CD 73 89     	call prev_line ;
 198+ 87DA 38 04        	jr c,view_page_up_ex ;если не удачно
 199+ 87DC 28 02        	jr z,view_page_up_ex
 200+ 87DE 10 F7        	djnz view_page_up_cl
 201+ 87E0              view_page_up_ex
 202+ 87E0 2A 94 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 203+ 87E3 22 96 89     	ld (view_file_pos_cur_focus),hl
 204+ 87E6 CD 3E 88     	call print_file_text ;напечатать всю страницу
 205+ 87E9 C3 34 87     	jp view_file_wait
 206+ 87EC
 207+ 87EC
 208+ 87EC
 209+ 87EC              view_page_down ;на страницу вперёд
 210+ 87EC 2A 96 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 211+ 87EF 22 94 89     	ld (view_file_pos_cur),hl
 212+ 87F2 06 16        	ld b,view_text_bot-2
 213+ 87F4              view_page_down_cl
 214+ 87F4 CD 65 89     	call next_line ;
 215+ 87F7 38 04        	jr c,view_page_down_ex ;если не удачно
 216+ 87F9 28 02        	jr z,view_page_down_ex
 217+ 87FB 10 F7        	djnz view_page_down_cl
 218+ 87FD              view_page_down_ex
 219+ 87FD 2A 94 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 220+ 8800 22 96 89     	ld (view_file_pos_cur_focus),hl
 221+ 8803 CD 3E 88     	call print_file_text ;напечатать всю страницу
 222+ 8806 C3 34 87     	jp view_file_wait
 223+ 8809
 224+ 8809
 225+ 8809
 226+ 8809              print_menu_view ;печать меню просмотрщика
 227+ 8809 3E 18        	ld a,#18
 228+ 880B 06 28        	ld b,color_backgr_hi ;цвет
 229+ 880D              	OS_PAINT_LINE ;линия внизу
 229+ 880D 0E 04       >    ld c,#04
 229+ 880F E7          >    rst #20
 230+ 8810 3E 28        	ld a,color_backgr_hi ;цвет
 231+ 8812 06 0C        	ld b,#c
 232+ 8814              	OS_SET_COLOR
 232+ 8814 0E 06       >    ld c,#06
 232+ 8816 E7          >    rst #20
 233+ 8817 11 10 18     	ld de,#1800+2*8
 234+ 881A              	OS_SET_XY
 234+ 881A 0E 01       >    ld c,#01
 234+ 881C E7          >    rst #20
 235+ 881D 21 8B 89     	ld hl,msg_menu_view
 236+ 8820              	OS_PRINTZ
 236+ 8820 0E 09       >    ld c,#09
 236+ 8822 E7          >    rst #20
 237+ 8823 C9           	ret
 238+ 8824
 239+ 8824              print_menu_view_top ;печать меню просмотрщика верхнее
 240+ 8824 AF           	xor a
 241+ 8825 06 28        	ld b,color_backgr_hi ;цвет
 242+ 8827              	OS_PAINT_LINE ;линия вверху
 242+ 8827 0E 04       >    ld c,#04
 242+ 8829 E7          >    rst #20
 243+ 882A 3E 28        	ld a,color_backgr_hi ;цвет
 244+ 882C 06 0C        	ld b,#c
 245+ 882E              	OS_SET_COLOR
 245+ 882E 0E 06       >    ld c,#06
 245+ 8830 E7          >    rst #20
 246+ 8831 11 24 00     	ld de,#0024
 247+ 8834              	OS_SET_XY
 247+ 8834 0E 01       >    ld c,#01
 247+ 8836 E7          >    rst #20
 248+ 8837 21 B8 98     	ld hl,file_name_cur
 249+ 883A              	OS_PRINTZ
 249+ 883A 0E 09       >    ld c,#09
 249+ 883C E7          >    rst #20
 250+ 883D C9           	ret
 251+ 883E
 252+ 883E
 253+ 883E
 254+ 883E              print_file_text	;печать текущей части файла в консоль
 255+ 883E 3E 04        	ld a,color_view_text ;цвет
 256+ 8840 06 0C        	ld b,#c
 257+ 8842              	OS_SET_COLOR
 257+ 8842 0E 06       >    ld c,#06
 257+ 8844 E7          >    rst #20
 258+ 8845
 259+ 8845 3E 01        	ld a,view_text_top ;первая строка
 260+ 8847 32 98 89     	ld (view_file_y_cur),a
 261+ 884A 2A 96 89     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 262+ 884D 22 94 89     	ld (view_file_pos_cur),hl
 263+ 8850              print_file_text_cl
 264+ 8850 2A 94 89     	ld hl,(view_file_pos_cur)
 265+ 8853 CD 79 88     	call print_line_text
 266+ 8856 38 0C        	jr c,print_file_text_ex
 267+ 8858
 268+ 8858              	; call next_line ;найти следующую строку
 269+ 8858              	; ret c
 270+ 8858
 271+ 8858 3A 98 89     	ld a,(view_file_y_cur)
 272+ 885B 3C           	inc a
 273+ 885C 32 98 89     	ld (view_file_y_cur),a
 274+ 885F FE 18        	cp view_text_bot
 275+ 8861 38 ED        	jr c,print_file_text_cl
 276+ 8863 C9           	ret
 277+ 8864
 278+ 8864              print_file_text_ex
 279+ 8864              	;тут очистить остальные строки
 280+ 8864 3A 98 89     	ld a,(view_file_y_cur)
 281+ 8867 3C           	inc a
 282+ 8868 FE 18        	cp view_text_bot
 283+ 886A 30 0B        	jr nc,print_file_text_ex2
 284+ 886C 67           	ld h,a
 285+ 886D 32 98 89     	ld (view_file_y_cur),a
 286+ 8870 3E 20        	ld a," "
 287+ 8872              	OS_FILL_LINE ;очистить строку
 287+ 8872 0E 03       >    ld c,#03
 287+ 8874 E7          >    rst #20
 288+ 8875 18 ED        	jr print_file_text_ex
 289+ 8877              print_file_text_ex2
 290+ 8877 37           	scf
 291+ 8878 C9           	ret
 292+ 8879
 293+ 8879
 294+ 8879
 295+ 8879              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 296+ 8879              ;вх: hl - адрес строки
 297+ 8879 CD C9 88     	call view_move_right ;промотать направо. если надо
 298+ 887C              	;установить позицию
 299+ 887C 3A 98 89     	ld a,(view_file_y_cur)
 300+ 887F 57           	ld d,a
 301+ 8880 AF           	xor a
 302+ 8881 32 99 89     	ld (view_file_x_cur),a
 303+ 8884 5F           	ld e,a
 304+ 8885              	OS_SET_XY 	;yx
 304+ 8885 0E 01       >    ld c,#01
 304+ 8887 E7          >    rst #20
 305+ 8888              print_line_text_cl ;цикл
 306+ 8888
 307+ 8888 7E           	ld a,(hl)
 308+ 8889 FE 0A        	cp 10 ;этот код не печатаем
 309+ 888B 28 14        	jr z,print_line_text_skip
 310+ 888D FE FF        	cp #ff ;этот код не печатаем
 311+ 888F 28 10        	jr z,print_line_text_skip
 312+ 8891 FE 0D        	cp 13
 313+ 8893 28 13        	jr z,print_line_text_ex_ok
 314+ 8895              	OS_PRINT_CHARF ;печать
 314+ 8895 D7          >	rst #10
 315+ 8896
 316+ 8896              	;на следующую позицию
 317+ 8896 3A 99 89     	ld a,(view_file_x_cur)
 318+ 8899 3C           	inc a
 319+ 889A FE 50        	cp 80 ;правый край экрана
 320+ 889C 32 99 89     	ld (view_file_x_cur),a
 321+ 889F 30 15        	jr nc,print_line_text_right ;дошли до правого края
 322+ 88A1
 323+ 88A1              print_line_text_skip
 324+ 88A1 CD 01 89     	call view_file_next_pos ;следующий
 325+ 88A4 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 326+ 88A6 18 E0        	jr print_line_text_cl
 327+ 88A8
 328+ 88A8              print_line_text_ex_ok ;выход норма по коду 13
 329+ 88A8 3E 20        	ld a," "
 330+ 88AA              	OS_PRINT_CHARF ;печать
 330+ 88AA D7          >	rst #10
 331+ 88AB CD BA 88     	call printe_clear_end ;добить до конца строки
 332+ 88AE C3 01 89     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 333+ 88B1              	;ret
 334+ 88B1
 335+ 88B1              print_line_text_ex_end ;выход если кончился файл
 336+ 88B1 CD BA 88     	call printe_clear_end
 337+ 88B4 37           	scf
 338+ 88B5 C9           	ret
 339+ 88B6
 340+ 88B6              print_line_text_right
 341+ 88B6 CD 65 89     	call next_line ;позицию  до конца строки
 342+ 88B9 C9           	ret
 343+ 88BA
 344+ 88BA
 345+ 88BA              printe_clear_end
 346+ 88BA              	;добить строку пробелами
 347+ 88BA 3A 99 89     	ld a,(view_file_x_cur)
 348+ 88BD 3C           	inc a
 349+ 88BE FE 50        	cp 80 ;правый край экрана
 350+ 88C0 32 99 89     	ld (view_file_x_cur),a
 351+ 88C3 D0           	ret nc
 352+ 88C4 3E 20        	ld a," "
 353+ 88C6              	OS_PRINT_CHARF ;печать
 353+ 88C6 D7          >	rst #10
 354+ 88C7 18 F1        	jr printe_clear_end
 355+ 88C9
 356+ 88C9
 357+ 88C9
 358+ 88C9
 359+ 88C9
 360+ 88C9              view_move_right ;перемотка строки направо
 361+ 88C9 ED 4B 92 89  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 362+ 88CD 78           	ld a,b
 363+ 88CE B1           	or c
 364+ 88CF C8           	ret z
 365+ 88D0 2A 94 89     	ld hl,(view_file_pos_cur)
 366+ 88D3              view_move_right1
 367+ 88D3 7E           	ld a,(hl)
 368+ 88D4 FE 0A        	cp 10 ;этот код пропускаем
 369+ 88D6 20 07        	jr nz,view_move_right2
 370+ 88D8 CD 01 89     	call view_file_next_pos
 371+ 88DB D8           	ret c
 372+ 88DC C8           	ret z
 373+ 88DD 18 F4        	jr view_move_right1
 374+ 88DF              view_move_right2
 375+ 88DF FE FF        	cp #ff ;этот код пропускаем
 376+ 88E1 20 07        	jr nz,view_move_right3
 377+ 88E3 CD 01 89     	call view_file_next_pos
 378+ 88E6 D8           	ret c
 379+ 88E7 C8           	ret z
 380+ 88E8 18 E9        	jr view_move_right1
 381+ 88EA              view_move_right3
 382+ 88EA 7E           	ld a,(hl)
 383+ 88EB FE 0D        	cp 13 ;
 384+ 88ED C8           	ret z
 385+ 88EE              view_move_right_cl
 386+ 88EE CD 01 89     	call view_file_next_pos
 387+ 88F1 D8           	ret c
 388+ 88F2 C8           	ret z
 389+ 88F3 7E           	ld a,(hl)
 390+ 88F4 FE 0D        	cp 13
 391+ 88F6 C8           	ret z
 392+ 88F7 FE 0A        	cp 10 ;этот код пропускаем
 393+ 88F9 28 F3        	jr z,view_move_right_cl
 394+ 88FB 0B           	dec bc
 395+ 88FC 78           	ld a,b
 396+ 88FD B1           	or c
 397+ 88FE 20 EE        	jr nz,view_move_right_cl
 398+ 8900              	;call view_file_next_pos ;следующий
 399+ 8900 C9           	ret
 400+ 8901
 401+ 8901
 402+ 8901
 403+ 8901              ;получение следующей позиции
 404+ 8901              view_file_next_pos
 405+ 8901 3A 9A 89     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 406+ 8904 B7           	or a
 407+ 8905 28 14        	jr z,view_file_next_pos_big
 408+ 8907              	;если текст не большой
 409+ 8907 2A 9B 89     	ld hl,(view_file_end) ;конец текста известен
 410+ 890A ED 5B 94 89  	ld de,(view_file_pos_cur)
 411+ 890E 13           	inc de ;вперёд
 412+ 890F A7           	and a
 413+ 8910 ED 52        	sbc hl,de
 414+ 8912 38 15        	jr c,view_file_next_pos_end
 415+ 8914 ED 53 94 89  	ld (view_file_pos_cur),de
 416+ 8918 EB           	ex de,hl ;на выходе адрес в HL
 417+ 8919 B7           	or a
 418+ 891A C9           	ret
 419+ 891B
 420+ 891B
 421+ 891B
 422+ 891B              view_file_next_pos_big
 423+ 891B              	;если текст большой
 424+ 891B 2A 94 89     	ld hl,(view_file_pos_cur)	;текущая позиция
 425+ 891E 23           	inc hl ;вперёд
 426+ 891F 7C           	ld a,h
 427+ 8920 FE C0        	cp #c0 ;если вышли за пределы окна
 428+ 8922 38 05        	jr c,view_file_next_pos_end
 429+ 8924 22 94 89     	ld (view_file_pos_cur),hl
 430+ 8927 B7           	or a
 431+ 8928 C9           	ret
 432+ 8929
 433+ 8929              view_file_next_pos_end
 434+ 8929              	;не смогли шагнуть вперёд
 435+ 8929              	; ld a,1 ;флаг что внизу
 436+ 8929              	; ld (view_file_bot_flag),a
 437+ 8929 37           	scf ;ошибка
 438+ 892A C9           	ret
 439+ 892B
 440+ 892B
 441+ 892B
 442+ 892B
 443+ 892B
 444+ 892B
 445+ 892B              ;получение предыдущей позиции
 446+ 892B              view_file_prev_pos
 447+ 892B 3A 9A 89     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 448+ 892E B7           	or a
 449+ 892F 28 1E        	jr z,view_file_prev_pos_big
 450+ 8931              	;если текст не большой
 451+ 8931 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 452+ 8934 ED 5B 94 89  	ld de,(view_file_pos_cur) ;текущая позиция
 453+ 8938 1B           	dec de ;назад
 454+ 8939 A7           	and a
 455+ 893A ED 52        	sbc hl,de
 456+ 893C 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 457+ 893E 30 1D        	jr nc,view_file_prev_pos_end
 458+ 8940              	;можно шагнуть назад
 459+ 8940 ED 53 94 89  	ld (view_file_pos_cur),de
 460+ 8944 EB           	ex de,hl ;на выходе адрес в HL
 461+ 8945 AF           	xor a
 462+ 8946 3C           	inc a ;a=1
 463+ 8947 C9           	ret
 464+ 8948              view_file_prev_pos_top
 465+ 8948              	;если в начале
 466+ 8948 ED 53 94 89  	ld (view_file_pos_cur),de
 467+ 894C EB           	ex de,hl ;на выходе адрес в HL
 468+ 894D AF           	xor a ;a=0
 469+ 894E C9           	ret
 470+ 894F
 471+ 894F
 472+ 894F              view_file_prev_pos_big
 473+ 894F              	;если текст большой
 474+ 894F 2A 94 89     	ld hl,(view_file_pos_cur)	;текущая позиция
 475+ 8952 2B           	dec hl ;назад
 476+ 8953 7C           	ld a,h
 477+ 8954 FE C0        	cp #c0 ;если вышли за пределы окна
 478+ 8956 38 05        	jr c,view_file_prev_pos_end
 479+ 8958 22 94 89     	ld (view_file_pos_cur),hl
 480+ 895B B7           	or a
 481+ 895C C9           	ret
 482+ 895D
 483+ 895D              view_file_prev_pos_end
 484+ 895D              	;не смогли шагнуть назад
 485+ 895D 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 486+ 8960 22 94 89     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 487+ 8963              	;вернулись в начало
 488+ 8963 AF           	xor a ;a=0
 489+ 8964 C9           	ret
 490+ 8965
 491+ 8965
 492+ 8965
 493+ 8965
 494+ 8965              next_line ;поиск следующей строки
 495+ 8965 CD 01 89     	call view_file_next_pos
 496+ 8968 D8           	ret c
 497+ 8969 C8           	ret z
 498+ 896A 7E           	ld a,(hl)
 499+ 896B FE 0D        	cp 13
 500+ 896D 20 F6        	jr nz,next_line
 501+ 896F CD 01 89     	call view_file_next_pos ;ещё на символ
 502+ 8972 C9           	ret
 503+ 8973
 504+ 8973
 505+ 8973
 506+ 8973              prev_line ;поиск предыдущей строки
 507+ 8973              ;если достигнуто начало файла - вернёт адрес начальный
 508+ 8973              	;сначала в конец предыдущей
 509+ 8973 CD 2B 89     	call view_file_prev_pos
 510+ 8976 C8           	ret z
 511+ 8977 D8           	ret c
 512+ 8978 7E           	ld a,(hl)
 513+ 8979 FE 0D        	cp 13
 514+ 897B 20 F6        	jr nz,prev_line
 515+ 897D              	;теперь в начало предыдущей
 516+ 897D              prev_line1
 517+ 897D CD 2B 89     	call view_file_prev_pos
 518+ 8980 C8           	ret z
 519+ 8981 D8           	ret c
 520+ 8982 7E           	ld a,(hl)
 521+ 8983 FE 0D        	cp 13
 522+ 8985 20 F6        	jr nz,prev_line1
 523+ 8987 CD 01 89     	call view_file_next_pos ;ещё на символ обратно
 524+ 898A C9           	ret
 525+ 898B
 526+ 898B
 527+ 898B
 528+ 898B              view_text_bot equ 24 ;последняя строка для печати
 529+ 898B              view_text_top equ 1 ;первая строка
 530+ 898B              view_text_lines equ 25-2 ;видимых строк на экране
 531+ 898B
 532+ 898B              msg_menu_view
 533+ 898B 33 20 45 78  	db "3 Exit",0
 533+ 898F 69 74 00
 534+ 8992
 535+ 8992              ;view_file_position ds 4 ;текущая позиция в файле
 536+ 8992              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 537+ 8992 00 00        view_move_right_val dw 0 ;сдвиг вправо
 538+ 8994 00 00        view_file_pos_cur dw 0;текущая позиция
 539+ 8996 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 540+ 8998 00           view_file_y_cur db 0;текущая строка
 541+ 8999 00           view_file_x_cur db 0;текущий столбец
 542+ 899A 00           view_file_load_all db 0 ;флаг что файл весь загружен
 543+ 899B 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 544+ 899D
 545+ 899D
# file closed: nc_view.asm
1316  899D              	include GPlay/gplay.asm ;плеер
# file opened: GPlay/gplay.asm
   1+ 899D              ;GPlay - приложение для OS GMX
   2+ 899D                 ; device ZXSPECTRUM128
   3+ 899D              	; include "../os_defs.asm"
   4+ 899D              	; org PROG_START
   5+ 899D
   6+ 899D
   7+ 899D              start_gplay
   8+ 899D F5           	push af
   9+ 899E
  10+ 899E CD C1 80     	call clear_left_panel ;почистить часть экрана
  11+ 89A1
  12+ 89A1 21 FF 8C     	ld hl,memorystreampages+$FF
  13+ 89A4 36 00        	ld (hl),0 ;количество занятых страниц
  14+ 89A6
  15+ 89A6 3A CA 9A     	ld a,(page_ext01) ;доп страница для данных плеера
  16+ 89A9              	OS_SET_PAGE_SLOT3
  16+ 89A9 0E 1C       >    ld c,#1c
  16+ 89AB E7          >    rst #20
  17+ 89AC
  18+ 89AC 11 00 00     	ld de,0
  19+ 89AF              	OS_SET_XY
  19+ 89AF 0E 01       >    ld c,#01
  19+ 89B1 E7          >    rst #20
  20+ 89B2 21 B8 8B     	ld hl,msg_title ;имя приложения
  21+ 89B5              	OS_PRINTZ ;печать
  21+ 89B5 0E 09       >    ld c,#09
  21+ 89B7 E7          >    rst #20
  22+ 89B8
  23+ 89B8 3E 0D        	ld a,13 ;оставим место для шкалы прогресса
  24+ 89BA              	OS_PRINT_CHARF
  24+ 89BA D7          >	rst #10
  25+ 89BB 3E 0D        	ld a,13
  26+ 89BD              	OS_PRINT_CHARF
  26+ 89BD D7          >	rst #10
  27+ 89BE 21 B8 98     	ld hl,file_name_cur
  28+ 89C1              	OS_PRINTZ
  28+ 89C1 0E 09       >    ld c,#09
  28+ 89C3 E7          >    rst #20
  29+ 89C4
  30+ 89C4 21 81 8B     	ld hl,txt_load
  31+ 89C7              	OS_PRINTZ
  31+ 89C7 0E 09       >    ld c,#09
  31+ 89C9 E7          >    rst #20
  32+ 89CA
  33+ 89CA 3E FF        	ld a,255
  34+ 89CC 32 C9 9A     	ld (file_id_cur_r),a
  35+ 89CF
  36+ 89CF F1           	pop af
  37+ 89D0 FE 7A        	cp "z"
  38+ 89D2 20 08        	jr nz,start_gplay_vgm
  39+ 89D4              	;если VGZ
  40+ 89D4 CD 60 8A     	call load_vgz
  41+ 89D7 DA 35 8A     	jp c,exit_gplay
  42+ 89DA 18 06        	jr start_gplay_ok
  43+ 89DC
  44+ 89DC              start_gplay_vgm
  45+ 89DC              	;если vgm
  46+ 89DC CD 1F 98     	call load_mus ;инициализация VGM
  47+ 89DF DA 35 8A     	jp c,exit_gplay
  48+ 89E2
  49+ 89E2              start_gplay_ok
  50+ 89E2              	;играет
  51+ 89E2 21 71 8B     	ld hl,txt_play
  52+ 89E5              	OS_PRINTZ
  52+ 89E5 0E 09       >    ld c,#09
  52+ 89E7 E7          >    rst #20
  53+ 89E8
  54+ 89E8 21 54 8B     	ld hl,txt_gplay_menu
  55+ 89EB              	OS_PRINTZ
  55+ 89EB 0E 09       >    ld c,#09
  55+ 89ED E7          >    rst #20
  56+ 89EE
  57+ 89EE              wait_play
  58+ 89EE              	OS_WAIT
  58+ 89EE DF          >	rst #18
  59+ 89EF
  60+ 89EF CD 9B 8A     	call gplay_progress_print
  61+ 89F2
  62+ 89F2 11 00 0A     	ld de,#0a00
  63+ 89F5              	OS_SET_XY
  63+ 89F5 0E 01       >    ld c,#01
  63+ 89F7 E7          >    rst #20
  64+ 89F8 2A 72 8D     	ld hl,(memorystreamcurrentaddr)
  65+ 89FB CD F5 8A     	call toDecimal
  66+ 89FE              	OS_PRINTZ
  66+ 89FE 0E 09       >    ld c,#09
  66+ 8A00 E7          >    rst #20
  67+ 8A01
  68+ 8A01
  69+ 8A01 11 00 0B     	ld de,#0b00
  70+ 8A04              	OS_SET_XY
  70+ 8A04 0E 01       >    ld c,#01
  70+ 8A06 E7          >    rst #20
  71+ 8A07 2A 0E 8D     	ld hl,(memorystreampageaddr)
  72+ 8A0A 01 00 8C     	ld bc,memorystreampages
  73+ 8A0D A7           	and a
  74+ 8A0E ED 42        	sbc hl,bc
  75+ 8A10 CD F5 8A     	call toDecimal
  76+ 8A13              	OS_PRINTZ
  76+ 8A13 0E 09       >    ld c,#09
  76+ 8A15 E7          >    rst #20
  77+ 8A16
  78+ 8A16 3A 7A 93     	ld a,(vgm_play_var)
  79+ 8A19 B7           	or a
  80+ 8A1A 20 19        	jr nz,exit_gplay ; конец пенсни
  81+ 8A1C              	OS_GET_CHAR
  81+ 8A1C 0E 10       >    ld c,#10
  81+ 8A1E E7          >    rst #20
  82+ 8A1F FE 20        	cp " " ;space
  83+ 8A21 CA 35 8A     	jp z,exit_gplay
  84+ 8A24 FE 73        	cp "s" ;stop
  85+ 8A26 CA 35 8A     	jp z,exit_gplay
  86+ 8A29 FE 53        	cp "S" ;stop
  87+ 8A2B CA 35 8A     	jp z,exit_gplay
  88+ 8A2E FE 18        	cp 24 ;break
  89+ 8A30 CA 35 8A     	jp z,exit_gplay
  90+ 8A33 18 B9        	jr wait_play
  91+ 8A35
  92+ 8A35
  93+ 8A35
  94+ 8A35
  95+ 8A35
  96+ 8A35              exit_gplay ;выход
  97+ 8A35 F5           	push af ;сохранить нажатую клавишу
  98+ 8A36
  99+ 8A36 21 7B 8B     	ld hl,txt_exit
 100+ 8A39              	OS_PRINTZ
 100+ 8A39 0E 09       >    ld c,#09
 100+ 8A3B E7          >    rst #20
 101+ 8A3C
 102+ 8A3C 21 00 00     	ld hl,0 ;отключить обработчик прерываний
 103+ 8A3F              	OS_SET_INTER
 103+ 8A3F 0E 14       >    ld c,#14
 103+ 8A41 E7          >    rst #20
 104+ 8A42 CD D7 8B     	call PLR_MUTE ;выключить звук
 105+ 8A45
 106+ 8A45
 107+ 8A45              	;освободить страницы памяти
 108+ 8A45 21 FF 8C     	ld hl,memorystreampages+$FF
 109+ 8A48 6E               ld l,(hl)
 110+ 8A49 2C           	inc l ;проверка на 0
 111+ 8A4A 2D           	dec l
 112+ 8A4B 28 0B        	jr z,free_s98_loop_skip
 113+ 8A4D
 114+ 8A4D              free_s98_loop
 115+ 8A4D 2D               dec l
 116+ 8A4E 7E               ld a,(hl)
 117+ 8A4F
 118+ 8A4F F5               push af
 119+ 8A50 E5               push hl
 120+ 8A51                  ;OS_DELPAGE
 121+ 8A51              	OS_DEL_PAGE
 121+ 8A51 0E 20       >    ld c,#20
 121+ 8A53 E7          >    rst #20
 122+ 8A54 E1               pop hl
 123+ 8A55 F1               pop af
 124+ 8A56
 125+ 8A56 20 F5            jr nz,free_s98_loop
 126+ 8A58
 127+ 8A58              free_s98_loop_skip
 128+ 8A58              	; call delay ;задержка
 129+ 8A58              	; xor a
 130+ 8A58              	; OS_PROC_CLOSE
 131+ 8A58
 132+ 8A58 3A CB 9A     	ld a,(page_main) ;основная страница
 133+ 8A5B              	OS_SET_PAGE_SLOT3
 133+ 8A5B 0E 1C       >    ld c,#1c
 133+ 8A5D E7          >    rst #20
 134+ 8A5E
 135+ 8A5E F1           	pop af ;a - код клавиши
 136+ 8A5F C9           	ret
 137+ 8A60
 138+ 8A60              ; delay ;задержка между запросами
 139+ 8A60              	; ld b,50*1 ;
 140+ 8A60              ; delay1
 141+ 8A60              	; OS_WAIT
 142+ 8A60              	; djnz delay1
 143+ 8A60              	; ret
 144+ 8A60
 145+ 8A60
 146+ 8A60
 147+ 8A60
 148+ 8A60
 149+ 8A60
 150+ 8A60
 151+ 8A60
 152+ 8A60
 153+ 8A60              load_vgz
 154+ 8A60              ;тут запуск VGZ
 155+ 8A60              	;тут надо сначала распаковать файл
 156+ 8A60 AF           	xor a
 157+ 8A61              	OS_SET_MONO_MODE ;запросить моно режим
 157+ 8A61 0E 08       >    ld c,#08
 157+ 8A63 E7          >    rst #20
 158+ 8A64 30 08        	jr nc,load_vgz1
 159+ 8A66
 160+ 8A66              load_vgz_err
 161+ 8A66              	;выход с ошибкой
 162+ 8A66
 163+ 8A66              	;напечатать ошибку, если не дали режима моно
 164+ 8A66 21 B9 9B     	ld hl,msg_mono_err
 165+ 8A69              	OS_PRINTZ
 165+ 8A69 0E 09       >    ld c,#09
 165+ 8A6B E7          >    rst #20
 166+ 8A6C
 167+ 8A6C 37           	scf ;ошибка
 168+ 8A6D C9           	ret
 169+ 8A6E
 170+ 8A6E              load_vgz1
 171+ 8A6E              	;перенести модуль распаковки на рабочий адрес
 172+ 8A6E 21 ED 9B     	ld hl,start_gp_gzip_tmp
 173+ 8A71 11 00 40     	ld de,start_gp_gzip
 174+ 8A74 01 00 1B     	ld bc,end_gp_gzip_tmp-start_gp_gzip_tmp
 175+ 8A77 ED B0        	ldir
 176+ 8A79
 177+ 8A79
 178+ 8A79              	;распаковать
 179+ 8A79 21 B8 98     	ld hl,file_name_cur ;имя файла
 180+ 8A7C CD 00 40     	call start_gp_gzip ;decompressfiletomemorystream
 181+ 8A7F
 182+ 8A7F              	;перенести таблицу страниц
 183+ 8A7F 11 00 8C     	ld de,memorystreampages
 184+ 8A82 01 00 01     	ld bc,256
 185+ 8A85 ED B0        	ldir
 186+ 8A87
 187+ 8A87 01 FF 8C     	ld bc,memorystreampages+$ff
 188+ 8A8A 02               ld (bc),a  ;количество страниц
 189+ 8A8B
 190+ 8A8B F5           	push af
 191+ 8A8C 3E FF        	ld a,255
 192+ 8A8E              	OS_SET_MONO_MODE ;выключить моно режим
 192+ 8A8E 0E 08       >    ld c,#08
 192+ 8A90 E7          >    rst #20
 193+ 8A91 F1           	pop af
 194+ 8A92
 195+ 8A92 30 02        	jr nc,load_vgz_ok
 196+ 8A94              	;если не распаковалос
 197+ 8A94 37           	scf ;ошибка
 198+ 8A95 C9           	ret
 199+ 8A96
 200+ 8A96              load_vgz_ok
 201+ 8A96              	;нормально распаковалось
 202+ 8A96
 203+ 8A96 CD 64 98     	call read_file_ok ;играть
 204+ 8A99              	;call start_gplay ;играть
 205+ 8A99
 206+ 8A99 AF           	xor a
 207+ 8A9A C9           	ret
 208+ 8A9B
 209+ 8A9B
 210+ 8A9B
 211+ 8A9B
 212+ 8A9B
 213+ 8A9B
 214+ 8A9B
 215+ 8A9B
 216+ 8A9B
 217+ 8A9B
 218+ 8A9B
 219+ 8A9B
 220+ 8A9B              	;печать шкалы прогресса
 221+ 8A9B              gplay_progress_print
 222+ 8A9B CD C4 8A     	call gplay_progress_calc
 223+ 8A9E 11 00 02     	ld de,#0200 ;прогресс тут
 224+ 8AA1              	OS_SET_XY
 224+ 8AA1 0E 01       >    ld c,#01
 224+ 8AA3 E7          >    rst #20
 225+ 8AA4              	;печать закрашенных кубиков
 226+ 8AA4 3A F4 8A     	ld a,(gplay_progress_val)
 227+ 8AA7 B7           	or a
 228+ 8AA8 28 08        	jr z,gplay_progress_print1
 229+ 8AAA 47           	ld b,a
 230+ 8AAB              gplay_progress_print1_cl
 231+ 8AAB C5           	push bc
 232+ 8AAC 3E B1        	ld a,177 ;псевдографика
 233+ 8AAE              	OS_PRINT_CHARF
 233+ 8AAE D7          >	rst #10
 234+ 8AAF C1           	pop bc
 235+ 8AB0 10 F9        	djnz gplay_progress_print1_cl
 236+ 8AB2              gplay_progress_print1
 237+ 8AB2              	;печать пустых кубиков
 238+ 8AB2 3A F4 8A     	ld a,(gplay_progress_val)
 239+ 8AB5 4F           	ld c,a
 240+ 8AB6 3E 10        	ld a,gplay_progress_lenght
 241+ 8AB8 91           	sub c
 242+ 8AB9 28 08        	jr z,gplay_progress_print2
 243+ 8ABB 47           	ld b,a
 244+ 8ABC              gplay_progress_print1_c2
 245+ 8ABC C5           	push bc
 246+ 8ABD 3E B0        	ld a,176 ;псевдографика
 247+ 8ABF              	OS_PRINT_CHARF
 247+ 8ABF D7          >	rst #10
 248+ 8AC0 C1           	pop bc
 249+ 8AC1 10 F9        	djnz gplay_progress_print1_c2
 250+ 8AC3
 251+ 8AC3              gplay_progress_print2
 252+ 8AC3 C9           	ret
 253+ 8AC4
 254+ 8AC4
 255+ 8AC4              gplay_progress_calc
 256+ 8AC4 3A FF 8C     	ld a,(memorystreampages+255) ;всего страниц памяти занято
 257+ 8AC7 67           	ld h,a
 258+ 8AC8 2E 00        	ld l,0 ;всего страниц *256
 259+ 8ACA
 260+ 8ACA              	;разделить
 261+ 8ACA CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 262+ 8ACC CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 263+ 8ACE CB 3C        	srl h ; /4
 264+ 8AD0 CB 1D        	rr l ;
 265+ 8AD2 CB 3C        	srl h ; /8
 266+ 8AD4 CB 1D        	rr l ;
 267+ 8AD6 CB 3C        	srl h ; /16
 268+ 8AD8 CB 1D        	rr l ;
 269+ 8ADA              	; srl h ; /32
 270+ 8ADA              	; rr l ;
 271+ 8ADA              	;узнали сколько страниц одно деление
 272+ 8ADA EB           	ex de,hl
 273+ 8ADB
 274+ 8ADB
 275+ 8ADB 2A 0E 8D     	ld hl,(memorystreampageaddr)
 276+ 8ADE 01 00 8C     	ld bc,memorystreampages
 277+ 8AE1 A7           	and a
 278+ 8AE2 ED 42        	sbc hl,bc ;какая по счёту страница сейчас
 279+ 8AE4
 280+ 8AE4 65           	ld h,l ;*256
 281+ 8AE5 2E 00        	ld l,0
 282+ 8AE7
 283+ 8AE7              	;разделить на величину одного деления
 284+ 8AE7 3E FF        	ld a,-1
 285+ 8AE9              divide16
 286+ 8AE9 3C           	inc a
 287+ 8AEA A7           	and a
 288+ 8AEB ED 52        	sbc hl,de
 289+ 8AED 30 FA        	jr nc,divide16
 290+ 8AEF 19           	add hl,de
 291+ 8AF0 32 F4 8A     	ld (gplay_progress_val),a
 292+ 8AF3 C9           	ret
 293+ 8AF4
 294+ 8AF4              gplay_progress_lenght equ 16 ;длина шкалы
 295+ 8AF4 00           gplay_progress_val db 0;
 296+ 8AF5
 297+ 8AF5
 298+ 8AF5
 299+ 8AF5
 300+ 8AF5              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 301+ 8AF5              				;на входе в HL число
 302+ 8AF5 11 10 27     			ld de,10000 ;десятки тысяч
 303+ 8AF8 3E FF        			ld a,255
 304+ 8AFA              toDecimal10k
 305+ 8AFA A7           			and a
 306+ 8AFB ED 52        			sbc hl,de
 307+ 8AFD 3C           			inc a
 308+ 8AFE 30 FA        			jr nc,toDecimal10k
 309+ 8B00 19           			add hl,de
 310+ 8B01 C6 30        			add a,48
 311+ 8B03 32 4E 8B     			ld (decimalS),a
 312+ 8B06 11 E8 03     			ld de,1000 ;тысячи
 313+ 8B09 3E FF        			ld a,255
 314+ 8B0B              toDecimal1k
 315+ 8B0B A7           			and a
 316+ 8B0C ED 52        			sbc hl,de
 317+ 8B0E 3C           			inc a
 318+ 8B0F 30 FA        			jr nc,toDecimal1k
 319+ 8B11 19           			add hl,de
 320+ 8B12 C6 30        			add a,48
 321+ 8B14 32 4F 8B     			ld (decimalS+1),a
 322+ 8B17 11 64 00     			ld de,100 ;сотни
 323+ 8B1A 3E FF        			ld a,255
 324+ 8B1C              toDecimal01k
 325+ 8B1C A7           			and a
 326+ 8B1D ED 52        			sbc hl,de
 327+ 8B1F 3C           			inc a
 328+ 8B20 30 FA        			jr nc,toDecimal01k
 329+ 8B22 19           			add hl,de
 330+ 8B23 C6 30        			add a,48
 331+ 8B25 32 50 8B     			ld (decimalS+2),a
 332+ 8B28 11 0A 00     			ld de,10 ;десятки
 333+ 8B2B 3E FF        			ld a,255
 334+ 8B2D              toDecimal001k
 335+ 8B2D A7           			and a
 336+ 8B2E ED 52        			sbc hl,de
 337+ 8B30 3C           			inc a
 338+ 8B31 30 FA        			jr nc,toDecimal001k
 339+ 8B33 19           			add hl,de
 340+ 8B34 C6 30        			add a,48
 341+ 8B36 32 51 8B     			ld (decimalS+3),a
 342+ 8B39 11 01 00     			ld de,1 ;единицы
 343+ 8B3C 3E FF        			ld a,255
 344+ 8B3E              toDecimal0001k
 345+ 8B3E A7           			and a
 346+ 8B3F ED 52        			sbc hl,de
 347+ 8B41 3C           			inc a
 348+ 8B42 30 FA        			jr nc,toDecimal0001k
 349+ 8B44 19           			add hl,de
 350+ 8B45 C6 30        			add a,48
 351+ 8B47 32 52 8B     			ld (decimalS+4),a
 352+ 8B4A 21 4E 8B     			ld hl,decimalS
 353+ 8B4D C9           			ret
 354+ 8B4E
 355+ 8B4E 00 00 00...  decimalS	ds 6 ;десятичные цифры
 356+ 8B54
 357+ 8B54
 358+ 8B54
 359+ 8B54
 360+ 8B54              ;file_id_cur db 0; временно
 361+ 8B54
 362+ 8B54 0D 0D 42 72  txt_gplay_menu db 13,13,"Break, S - stop ",13,"Sp - Next",0
 362+ 8B58 65 61 6B 2C
 362+ 8B5C 20 53 20 2D
 362+ 8B60 20 73 74 6F
 362+ 8B64 70 20 0D 53
 362+ 8B68 70 20 2D 20
 362+ 8B6C 4E 65 78 74
 362+ 8B70 00
 363+ 8B71 0D 50 6C 61  txt_play db 13,"Play... ",0
 363+ 8B75 79 2E 2E 2E
 363+ 8B79 20 00
 364+ 8B7B 0D 53 74 6F  txt_exit db 13,"Stop",0
 364+ 8B7F 70 00
 365+ 8B81 0D 4C 6F 61  txt_load db 13,"Load...",0
 365+ 8B85 64 2E 2E 2E
 365+ 8B89 00
 366+ 8B8A 0D 4D 65 6D  txt_memoryerror:    db 13,"Memory allocation error!",0
 366+ 8B8E 6F 72 79 20
 366+ 8B92 61 6C 6C 6F
 366+ 8B96 63 61 74 69
 366+ 8B9A 6F 6E 20 65
 366+ 8B9E 72 72 6F 72
 366+ 8BA2 21 00
 367+ 8BA4 0D 43 61 6E  txt_fopenerror:     db 13,"Cannot open file: ",0
 367+ 8BA8 6E 6F 74 20
 367+ 8BAC 6F 70 65 6E
 367+ 8BB0 20 66 69 6C
 367+ 8BB4 65 3A 20 00
 368+ 8BB8
 369+ 8BB8              msg_title
 370+ 8BB8 47 50 6C 61  	db "GPlay ver 2025.08.07",10,13,0
 370+ 8BBC 79 20 76 65
 370+ 8BC0 72 20 32 30
 370+ 8BC4 32 35 2E 30
 370+ 8BC8 38 2E 30 37
 370+ 8BCC 0A 0D 00
 371+ 8BCF
 372+ 8BCF              vgm_plr
 373+ 8BCF
 374+ 8BCF              ;module equ 0xc000
 375+ 8BCF              ;player_load = 0x8000 ;0x4000
 376+ 8BCF
 377+ 8BCF              ;ovl_start = 0x8000 ;0x4000
 378+ 8BCF
 379+ 8BCF              PLR_INIT  = vgm_plr ;0x4000
 380+ 8BCF              PLR_PLAY  = vgm_plr+5 ;0x4005
 381+ 8BCF              PLR_MUTE  = vgm_plr+8 ;0x4008
 382+ 8BCF
 383+ 8BCF              	include vgm.asm
# file opened: GPlay/vgm.asm
   1++8BCF                      ;DEVICE ZXSPECTRUM48
   2++8BCF                      ;include "../../../_sdk/sys_h.asm"
   3++8BCF                      ;       ORG PROGSTART ;0x4000
   4++8BCF
   5++8BCF
   6++8BCF
   7++8BCF              ;memorystreamcurrentpage = 0x5100
   8++8BCF              ;current_ram_page = 0x5100
   9++8BCF
  10++8BCF
  11++8BCF              AREA_C000_FFFF   equ 1
  12++8BCF
  13++8BCF
  14++8BCF
  15++8BCF              module = $C000
  16++8BCF
  17++8BCF
  18++8BCF
  19++8BCF              begin
  20++8BCF              START
  21++8BCF 21 00 C0             	LD HL,module;MDLADDR ;DE - address of 2nd module for TS
  22++8BD2 18 06                	JR INIT
  23++8BD4 C3 7A 93             	JP PLAY
  24++8BD7 C3 6C 93             	JP MUTE
  25++8BDA              INIT:
  26++8BDA C3 CF 92             jp init_
  27++8BDD
  28++8BDD              DEVICE_AY_BIT         = 0
  29++8BDD              DEVICE_TURBOSOUND_BIT = 1
  30++8BDD              DEVICE_TFM_BIT        = 2
  31++8BDD              DEVICE_MOONSOUND_BIT  = 3
  32++8BDD              DEVICE_GS_BIT         = 4
  33++8BDD              DEVICE_NEOGS_BIT      = 5
  34++8BDD              DEVICE_MIDI_UART_BIT  = 6
  35++8BDD
  36++8BDD              DEVICE_AY_MASK         = 1<<DEVICE_AY_BIT
  37++8BDD              DEVICE_TURBOSOUND_MASK = 1<<DEVICE_TURBOSOUND_BIT
  38++8BDD              DEVICE_TFM_MASK        = 1<<DEVICE_TFM_BIT
  39++8BDD              DEVICE_MOONSOUND_MASK  = 1<<DEVICE_MOONSOUND_BIT
  40++8BDD              DEVICE_GS_MASK         = 1<<DEVICE_GS_BIT
  41++8BDD              DEVICE_NEOGS_MASK      = 1<<DEVICE_NEOGS_BIT
  42++8BDD              DEVICE_MIDI_UART_MASK  = 1<<DEVICE_MIDI_UART_BIT
  43++8BDD
  44++8BDD
  45++8BDD
  46++8BDD
  47++8BDD
  48++8BDD              HEADER_DATA_OFFSET = module+0x34 ;0xC034
  49++8BDD              HEADER_LOOP_SAMPLES_COUNT = module+0x20 ;0xC020
  50++8BDD              HEADER_GD3_OFFSET = module+0x14 ;0xC014
  51++8BDD              HEADER_SAMPLES_COUNT = module+0x18 ;0xC018
  52++8BDD              HEADER_LOOP_OFFSET = module+0x1c ;0xC01c
  53++8BDD
  54++8BDD
  55++8BDD              HEADER_SIZE_MAX = 256
  56++8BDD              TITLELENGTH = 64
  57++8BDD              MEMORYSTREAMMAXPAGES = 210
  58++8BDD              MEMORYSTREAMERRORMASK = 255 ; TODO: do we need to enforce loading the entire file?
  59++8BDD              ENABLE_FM = 1
  60++8BDD
  61++8BDD
  62++8BDD
  63++8BDD
  64++8BDD
  65++8BDD
  66++8BDD
  67++8BDD 00 00 00...          align 256   ;0x8100 ;0x4100
  68++8C00                      display "s98_file00_pages_list ",$
  69++8C00
  70++8C00 00 00 00...  memorystreampages: ds 256,0
  71++8D00              memorystreampagecount = memorystreampages + 255
  72++8D00
  73++8D00              	include "common/memorystream.asm"
# file opened: GPlay/common/memorystream.asm
   1++8D00              memorystreamstart
   2++8D00                      IF AREA_C000_FFFF=1
   3++8D00 21 00 00     	ld hl,0x0000
   4++8D03                      ELSE
   5++8D03 ~                    ld hl,0xffff
   6++8D03                      ENDIF
   7++8D03 22 72 8D     	ld (memorystreamcurrentaddr),hl
   8++8D06 21 00 8C     	ld hl,memorystreampages
   9++8D09 22 0E 8D     	ld (memorystreampageaddr),hl
  10++8D0C C9           	ret
  11++8D0D
  12++8D0D              memorystreamnextpage
  13++8D0D              memorystreampageaddr=$+1
  14++8D0D 21 00 00     	ld hl,0
  15++8D10 F5           	push af
  16++8D11 7E           	ld a,(hl)
  17++8D12 23           	inc hl
  18++8D13 32 7C 93     	ld (memorystreamcurrentpage),a
  19++8D16 22 0E 8D     	ld (memorystreampageaddr),hl
  20++8D19 C5           	push bc
  21++8D1A                      IF AREA_C000_FFFF=1
  22++8D1A              	;SETPGC000
  23++8D1A              	OS_SET_PAGE_SLOT3
  23++8D1A 0E 1C       >    ld c,#1c
  23++8D1C E7          >    rst #20
  24++8D1D C1           	pop bc
  25++8D1E F1           	pop af
  26++8D1F 21 00 C0     	ld hl,0xC000
  27++8D22                      ELSE
  28++8D22 ~                    SETPG8000
  29++8D22 ~                    pop bc
  30++8D22 ~                    pop af
  31++8D22 ~                    ld hl,0x8000
  32++8D22                      ENDIF
  33++8D22 C9           	ret
  34++8D23
  35++8D23              memorystreamskip
  36++8D23              ;b = byte count
  37++8D23 2A 72 8D     	ld hl,(memorystreamcurrentaddr)
  38++8D26              .loop
  39++8D26 CB 74        	bit 6,h
  40++8D28                      IF AREA_C000_FFFF=1
  41++8D28 CC 0D 8D     	call z,memorystreamnextpage
  42++8D2B                      ELSE
  43++8D2B ~             	call nz,memorystreamnextpage
  44++8D2B                      ENDIF
  45++8D2B 23           	inc hl
  46++8D2C 10 F8        	djnz .loop
  47++8D2E 22 72 8D     	ld (memorystreamcurrentaddr),hl
  48++8D31 C9           	ret
  49++8D32
  50++8D32              	macro memory_stream_write_byte src
  51++8D32 ~            	bit 6,h
  52++8D32 ~                    IF AREA_C000_FFFF=1
  53++8D32 ~            	call z,memorystreamnextpage
  54++8D32 ~                    ELSE
  55++8D32 ~             	call nz,memorystreamnextpage
  56++8D32 ~                    ENDIF
  57++8D32 ~            	ld (hl),src
  58++8D32 ~            	inc hl
  59++8D32              	endm
  60++8D32
  61++8D32              	macro memory_stream_read_byte dest
  62++8D32 ~            	bit 6,h
  63++8D32 ~                    IF AREA_C000_FFFF=1
  64++8D32 ~            	call z,memorystreamnextpage
  65++8D32 ~                    ELSE
  66++8D32 ~             	call nz,memorystreamnextpage
  67++8D32 ~                    ENDIF
  68++8D32 ~            	ld dest,(hl)
  69++8D32 ~            	inc hl
  70++8D32              	endm
  71++8D32
  72++8D32              	macro memory_stream_read_1 dst
  73++8D32 ~            	ld hl,(memorystreamcurrentaddr)
  74++8D32 ~            	memory_stream_read_byte dst
  75++8D32 ~            	ld (memorystreamcurrentaddr),hl
  76++8D32              	endm
  77++8D32
  78++8D32              	macro memory_stream_read_2 dst1,dst2
  79++8D32 ~            	ld hl,(memorystreamcurrentaddr)
  80++8D32 ~            	memory_stream_read_byte dst1
  81++8D32 ~            	memory_stream_read_byte dst2
  82++8D32 ~            	ld (memorystreamcurrentaddr),hl
  83++8D32              	endm
  84++8D32
  85++8D32              	macro memory_stream_read_3 dst1,dst2,dst3
  86++8D32 ~            	ld hl,(memorystreamcurrentaddr)
  87++8D32 ~            	memory_stream_read_byte dst1
  88++8D32 ~            	memory_stream_read_byte dst2
  89++8D32 ~            	memory_stream_read_byte dst3
  90++8D32 ~            	ld (memorystreamcurrentaddr),hl
  91++8D32              	endm
  92++8D32
  93++8D32              memorystreamread1
  94++8D32              ;out: a = byte
  95++8D32              	memory_stream_read_1 a
  95++8D32 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
  95++8D35             >	memory_stream_read_byte a
  95++8D35 CB 74       >	bit 6,h
  95++8D37             >        IF AREA_C000_FFFF=1
  95++8D37 CC 0D 8D    >	call z,memorystreamnextpage
  95++8D3A             >        ELSE
  95++8D3A ~           > 	call nz,memorystreamnextpage
  95++8D3A             >        ENDIF
  95++8D3A 7E          >	ld a,(hl)
  95++8D3B 23          >	inc hl
  95++8D3C 22 72 8D    >	ld (memorystreamcurrentaddr),hl
  96++8D3F C9           	ret
  97++8D40
  98++8D40              memorystreamread2
  99++8D40              ;out: de = word
 100++8D40              	memory_stream_read_2 e,d
 100++8D40 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 100++8D43             >	memory_stream_read_byte e
 100++8D43 CB 74       >	bit 6,h
 100++8D45             >        IF AREA_C000_FFFF=1
 100++8D45 CC 0D 8D    >	call z,memorystreamnextpage
 100++8D48             >        ELSE
 100++8D48 ~           > 	call nz,memorystreamnextpage
 100++8D48             >        ENDIF
 100++8D48 5E          >	ld e,(hl)
 100++8D49 23          >	inc hl
 100++8D4A             >	memory_stream_read_byte d
 100++8D4A CB 74       >	bit 6,h
 100++8D4C             >        IF AREA_C000_FFFF=1
 100++8D4C CC 0D 8D    >	call z,memorystreamnextpage
 100++8D4F             >        ELSE
 100++8D4F ~           > 	call nz,memorystreamnextpage
 100++8D4F             >        ENDIF
 100++8D4F 56          >	ld d,(hl)
 100++8D50 23          >	inc hl
 100++8D51 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 101++8D54 C9           	ret
 102++8D55
 103++8D55              memorystreamread3
 104++8D55              ;out: c = byte0, e = byte1, d = byte2
 105++8D55              	memory_stream_read_3 c,e,d
 105++8D55 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 105++8D58             >	memory_stream_read_byte c
 105++8D58 CB 74       >	bit 6,h
 105++8D5A             >        IF AREA_C000_FFFF=1
 105++8D5A CC 0D 8D    >	call z,memorystreamnextpage
 105++8D5D             >        ELSE
 105++8D5D ~           > 	call nz,memorystreamnextpage
 105++8D5D             >        ENDIF
 105++8D5D 4E          >	ld c,(hl)
 105++8D5E 23          >	inc hl
 105++8D5F             >	memory_stream_read_byte e
 105++8D5F CB 74       >	bit 6,h
 105++8D61             >        IF AREA_C000_FFFF=1
 105++8D61 CC 0D 8D    >	call z,memorystreamnextpage
 105++8D64             >        ELSE
 105++8D64 ~           > 	call nz,memorystreamnextpage
 105++8D64             >        ENDIF
 105++8D64 5E          >	ld e,(hl)
 105++8D65 23          >	inc hl
 105++8D66             >	memory_stream_read_byte d
 105++8D66 CB 74       >	bit 6,h
 105++8D68             >        IF AREA_C000_FFFF=1
 105++8D68 CC 0D 8D    >	call z,memorystreamnextpage
 105++8D6B             >        ELSE
 105++8D6B ~           > 	call nz,memorystreamnextpage
 105++8D6B             >        ENDIF
 105++8D6B 56          >	ld d,(hl)
 105++8D6C 23          >	inc hl
 105++8D6D 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 106++8D70 C9           	ret
 107++8D71
 108++8D71              memorystreamread4
 109++8D71              ;out: adbc = dword
 110++8D71              memorystreamcurrentaddr=$+1
 111++8D71 21 00 00     	ld hl,0
 112++8D74              	memory_stream_read_byte c
 112++8D74 CB 74       >	bit 6,h
 112++8D76             >        IF AREA_C000_FFFF=1
 112++8D76 CC 0D 8D    >	call z,memorystreamnextpage
 112++8D79             >        ELSE
 112++8D79 ~           > 	call nz,memorystreamnextpage
 112++8D79             >        ENDIF
 112++8D79 4E          >	ld c,(hl)
 112++8D7A 23          >	inc hl
 113++8D7B              	memory_stream_read_byte b
 113++8D7B CB 74       >	bit 6,h
 113++8D7D             >        IF AREA_C000_FFFF=1
 113++8D7D CC 0D 8D    >	call z,memorystreamnextpage
 113++8D80             >        ELSE
 113++8D80 ~           > 	call nz,memorystreamnextpage
 113++8D80             >        ENDIF
 113++8D80 46          >	ld b,(hl)
 113++8D81 23          >	inc hl
 114++8D82              	memory_stream_read_byte d
 114++8D82 CB 74       >	bit 6,h
 114++8D84             >        IF AREA_C000_FFFF=1
 114++8D84 CC 0D 8D    >	call z,memorystreamnextpage
 114++8D87             >        ELSE
 114++8D87 ~           > 	call nz,memorystreamnextpage
 114++8D87             >        ENDIF
 114++8D87 56          >	ld d,(hl)
 114++8D88 23          >	inc hl
 115++8D89              	memory_stream_read_byte a
 115++8D89 CB 74       >	bit 6,h
 115++8D8B             >        IF AREA_C000_FFFF=1
 115++8D8B CC 0D 8D    >	call z,memorystreamnextpage
 115++8D8E             >        ELSE
 115++8D8E ~           > 	call nz,memorystreamnextpage
 115++8D8E             >        ENDIF
 115++8D8E 7E          >	ld a,(hl)
 115++8D8F 23          >	inc hl
 116++8D90 22 72 8D     	ld (memorystreamcurrentaddr),hl
 117++8D93 C9           	ret
 118++8D94
 119++8D94              memorystreamread
 120++8D94              ;bc = number of bytes
 121++8D94              ;de = dest addr
 122++8D94 79           	ld a,c
 123++8D95 0B           	dec bc
 124++8D96 04           	inc b
 125++8D97 48           	ld c,b
 126++8D98 47           	ld b,a
 127++8D99 2A 72 8D     	ld hl,(memorystreamcurrentaddr)
 128++8D9C              .readloop
 129++8D9C              	memory_stream_read_byte a
 129++8D9C CB 74       >	bit 6,h
 129++8D9E             >        IF AREA_C000_FFFF=1
 129++8D9E CC 0D 8D    >	call z,memorystreamnextpage
 129++8DA1             >        ELSE
 129++8DA1 ~           > 	call nz,memorystreamnextpage
 129++8DA1             >        ENDIF
 129++8DA1 7E          >	ld a,(hl)
 129++8DA2 23          >	inc hl
 130++8DA3 12           	ld (de),a
 131++8DA4 13           	inc de
 132++8DA5 10 F5        	djnz .readloop
 133++8DA7 0D           	dec c
 134++8DA8 20 F2        	jr nz,.readloop
 135++8DAA 22 72 8D     	ld (memorystreamcurrentaddr),hl
 136++8DAD C9           	ret
 137++8DAE
 138++8DAE              memorystreamwrite
 139++8DAE              ;bc = number of bytes
 140++8DAE              ;de = src addr
 141++8DAE 79           	ld a,c
 142++8DAF 0B           	dec bc
 143++8DB0 04           	inc b
 144++8DB1 48           	ld c,b
 145++8DB2 47           	ld b,a
 146++8DB3 2A 72 8D     	ld hl,(memorystreamcurrentaddr)
 147++8DB6              .writeloop
 148++8DB6 1A           	ld a,(de)
 149++8DB7              	memory_stream_write_byte a
 149++8DB7 CB 74       >	bit 6,h
 149++8DB9             >        IF AREA_C000_FFFF=1
 149++8DB9 CC 0D 8D    >	call z,memorystreamnextpage
 149++8DBC             >        ELSE
 149++8DBC ~           > 	call nz,memorystreamnextpage
 149++8DBC             >        ENDIF
 149++8DBC 77          >	ld (hl),a
 149++8DBD 23          >	inc hl
 150++8DBE 13           	inc de
 151++8DBF 10 F5        	djnz .writeloop
 152++8DC1 0D           	dec c
 153++8DC2 20 F2        	jr nz,.writeloop
 154++8DC4 22 72 8D     	ld (memorystreamcurrentaddr),hl
 155++8DC7 C9           	ret
 156++8DC8
 157++8DC8              memorystreamseek
 158++8DC8              ;dehl = absolute position
 159++8DC8              ;out: hl = read address
 160++8DC8 7B           	ld a,e
 161++8DC9 44           	ld b,h
 162++8DCA CB 20        	sla b
 163++8DCC 17           	rla
 164++8DCD CB 20        	sla b
 165++8DCF 17           	rla
 166++8DD0 C6 00        	add a,memorystreampages%256
 167++8DD2 5F           	ld e,a
 168++8DD3 CE 8C        	adc a,memorystreampages/256
 169++8DD5 93           	sub e
 170++8DD6 57           	ld d,a
 171++8DD7 1A           	ld a,(de)
 172++8DD8 32 7C 93     	ld (memorystreamcurrentpage),a
 173++8DDB 13           	inc de
 174++8DDC ED 53 0E 8D  	ld (memorystreampageaddr),de
 175++8DE0                      IF AREA_C000_FFFF=1
 176++8DE0              	;SETPGC000
 177++8DE0 E5           	push hl ;*
 178++8DE1              	OS_SET_PAGE_SLOT3
 178++8DE1 0E 1C       >    ld c,#1c
 178++8DE3 E7          >    rst #20
 179++8DE4 E1           	pop hl ;*
 180++8DE5 CB F4                set 6,h
 181++8DE7                      ELSE
 182++8DE7 ~            	SETPG8000
 183++8DE7 ~            	res 6,h
 184++8DE7                      ENDIF
 185++8DE7 CB FC        	set 7,h
 186++8DE9 22 72 8D     	ld (memorystreamcurrentaddr),hl
 187++8DEC C9           	ret
 188++8DED
 189++8DED              memorystreamgetpos
 190++8DED              ;out: dehl = absolute position
 191++8DED 2A 0E 8D     	ld hl,(memorystreampageaddr)
 192++8DF0 11 FF 73     	ld de,-memorystreampages-1
 193++8DF3 19           	add hl,de
 194++8DF4 EB           	ex de,hl
 195++8DF5 2A 72 8D     	ld hl,(memorystreamcurrentaddr)
 196++8DF8
 197++8DF8                      IF AREA_C000_FFFF=1
 198++8DF8 CB 7C                bit 7,h
 199++8DFA CB BC                res 7,h
 200++8DFC CB B4                res 6,h
 201++8DFE 20 04        	jr nz,$+6
 202++8E00                      ELSE
 203++8E00 ~            	res 7,h
 204++8E00 ~            	bit 6,h
 205++8E00 ~            ;	jr z,$+6
 206++8E00                      ENDIF
 207++8E00 20 04        	jr nz,$+6
 208++8E02 13           	inc de
 209++8E03 21 00 00     	ld hl,0
 210++8E06 AF           	xor a
 211++8E07 CB 1B        	rr e
 212++8E09 1F           	rra
 213++8E0A CB 1B        	rr e
 214++8E0C 1F           	rra
 215++8E0D B4           	or h
 216++8E0E 67           	ld h,a
 217++8E0F C9           	ret
 218++8E10
 219++8E10              memorystreamsize
 220++8E10 00 00 00 00  	ds 4
 221++8E14
# file closed: GPlay/common/memorystream.asm
  74++8E14              	include "common/opl4.asm"
# file opened: GPlay/common/opl4.asm
   1++8E14              	include "moonsound.asm"
# file opened: GPlay/common/moonsound.asm
   1++8E14              MOON_BASE_HI = 0x00 ;старший байт
   2++8E14              MOON_BASE = 0x24 ;0xc4
   3++8E14              MOON_REG1 = MOON_BASE
   4++8E14              MOON_DAT1 = MOON_BASE+1  ;c5
   5++8E14              MOON_REG2 = MOON_BASE+2  ;c6
   6++8E14              MOON_DAT2 = MOON_BASE+3  ;c7
   7++8E14              MOON_STAT = MOON_BASE
   8++8E14              MOON_WREG = 0xc2
   9++8E14              MOON_WDAT = MOON_WREG+1
  10++8E14
  11++8E14              ;TODO: is this good enough for ATM2?
  12++8E14              	macro opl4_wait
  13++8E14 ~            	ld a,MOON_BASE_HI
  14++8E14 ~            	in a,(MOON_STAT)
  15++8E14 ~            	rrca
  16++8E14 ~            	jr c,$-3
  17++8E14              	endm
  18++8E14
  19++8E14              ;makes ZXM-Moonsound firmware 1.01 switch PCM ports from default 7E and 7F to C2 and C3
  20++8E14              	macro switch_to_pcm_ports_c2_c3
  21++8E14 ~            	ld a,MOON_BASE_HI
  22++8E14 ~            	in a,(MOON_REG2)
  23++8E14              	endm
  24++8E14
  25++8E14
  26++8E14
  27++8E14              NR_OF_MIDI_CHANNELS = 16
  28++8E14              NR_OF_WAVE_CHANNELS = 24
  29++8E14
  30++8E14
  31++8E14
  32++8E14              MOONSOUNDROMSIZE = 0x200000
  33++8E14              MOONWAVEHEADERSIZE = 12
  34++8E14              MOONRAMWAVETABLESIZE = 128
  35++8E14              OPL4MAXWAVECHANNELS = NR_OF_WAVE_CHANNELS
  36++8E14
  37++8E14              OPL4_TIMER1_COUNT   = 0x02
  38++8E14              OPL4_TIMER2_COUNT   = 0x03
  39++8E14              OPL4_TIMER_CONTROL  = 0x04
  40++8E14
  41++8E14
  42++8E14
  43++8E14
  44++8E14              OPL4_REG_TEST0               = 0x00
  45++8E14              OPL4_REG_TEST1               = 0x01
  46++8E14
  47++8E14              OPL4_REG_MEMORY_CONFIGURATION = 0x02
  48++8E14              OPL4_MODE_BIT                 = 0x01
  49++8E14              OPL4_MTYPE_BIT                = 0x02
  50++8E14              OPL4_TONE_HEADER_MASK         = 0x1C
  51++8E14              OPL4_DEVICE_ID_MASK           = 0xE0
  52++8E14
  53++8E14              OPL4_REG_MEMORY_ADDRESS_HIGH  = 0x03
  54++8E14              OPL4_REG_MEMORY_ADDRESS_MID   = 0x04
  55++8E14              OPL4_REG_MEMORY_ADDRESS_LOW   = 0x05
  56++8E14              OPL4_REG_MEMORY_DATA          = 0x06
  57++8E14
  58++8E14 ~            /*
  59++8E14 ~             * Offsets to the register banks for voices. To get the
  60++8E14 ~             * register number just add the voice number to the bank offset.
  61++8E14 ~             *
  62++8E14 ~             * Wave Table Number low bits (0x08 to 0x1F)
  63++8E14 ~             */
  64++8E14              OPL4_REG_TONE_NUMBER  = 0x08
  65++8E14
  66++8E14 ~            /* Wave Table Number high bit, F-Number low bits (0x20 to 0x37) */
  67++8E14              OPL4_REG_F_NUMBER      = 0x20
  68++8E14              OPL4_TONE_NUMBER_BIT8  = 0x01
  69++8E14              OPL4_F_NUMBER_LOW_MASK = 0xFE
  70++8E14
  71++8E14 ~            /* F-Number high bits, Octave, Pseudo-Reverb (0x38 to 0x4F) */
  72++8E14              OPL4_REG_OCTAVE         = 0x38
  73++8E14              OPL4_F_NUMBER_HIGH_MASK = 0x07
  74++8E14              OPL4_BLOCK_MASK         = 0xF0
  75++8E14              OPL4_PSEUDO_REVERB_BIT  = 0x08
  76++8E14
  77++8E14 ~            /* Total Level, Level Direct (0x50 to 0x67) */
  78++8E14              OPL4_REG_LEVEL        = 0x50
  79++8E14              OPL4_TOTAL_LEVEL_MASK = 0xFE
  80++8E14              OPL4_LEVEL_DIRECT_BIT = 0x01
  81++8E14
  82++8E14 ~            /* Key On, Damp, LFO RST, CH, Panpot (0x68 to 0x7F) */
  83++8E14              OPL4_REG_MISC           = 0x68
  84++8E14              OPL4_KEY_ON_BIT         = 0x80
  85++8E14              OPL4_DAMP_BIT           = 0x40
  86++8E14              OPL4_LFO_RESET_BIT      = 0x20
  87++8E14              OPL4_OUTPUT_CHANNEL_BIT = 0x10
  88++8E14              OPL4_PAN_POT_MASK       = 0x0F
  89++8E14
  90++8E14 ~            /* LFO, VIB (0x80 to 0x97) */
  91++8E14              OPL4_REG_LFO_VIBRATO    = 0x80
  92++8E14              OPL4_LFO_FREQUENCY_MASK = 0x38
  93++8E14              OPL4_VIBRATO_DEPTH_MASK = 0x07
  94++8E14              OPL4_CHORUS_SEND_MASK   = 0xC0
  95++8E14
  96++8E14 ~            /* Attack / Decay 1 rate (0x98 to 0xAF) */
  97++8E14              OPL4_REG_ATTACK_DECAY1  = 0x98
  98++8E14              OPL4_ATTACK_RATE_MASK   = 0xF0
  99++8E14              OPL4_DECAY1_RATE_MASK   = 0x0F
 100++8E14
 101++8E14 ~            /* Decay level / 2 rate (0xB0 to 0xC7) */
 102++8E14              OPL4_REG_LEVEL_DECAY2  = 0xB0
 103++8E14              OPL4_DECAY_LEVEL_MASK  = 0xF0
 104++8E14              OPL4_DECAY2_RATE_MASK  = 0x0F
 105++8E14
 106++8E14 ~            /* Release rate / Rate correction (0xC8 to 0xDF) */
 107++8E14              OPL4_REG_RELEASE_CORRECTION  = 0xC8
 108++8E14              OPL4_RELEASE_RATE_MASK       = 0x0F
 109++8E14              OPL4_RATE_INTERPOLATION_MASK = 0xF0
 110++8E14
 111++8E14 ~            /* AM (0xE0 to 0xF7) */
 112++8E14              OPL4_REG_TREMOLO        = 0xE0
 113++8E14              OPL4_TREMOLO_DEPTH_MASK = 0x07
 114++8E14              OPL4_REVERB_SEND_MASK   = 0xE0
 115++8E14
 116++8E14 ~            /* Mixer */
 117++8E14              OPL4_REG_MIX_CONTROL_FM  = 0xF8
 118++8E14              OPL4_REG_MIX_CONTROL_PCM = 0xF9
 119++8E14              OPL4_MIX_LEFT_MASK       = 0x07
 120++8E14              OPL4_MIX_RIGHT_MASK      = 0x38
 121++8E14
 122++8E14              OPL4_REG_ATC             = 0xFA
 123++8E14              OPL4_ATC_BIT             = 0x01
 124++8E14
 125++8E14 ~            /* Bits in the OPL4 Status register */
 126++8E14              OPL4_STATUS_BUSY = 0x01
 127++8E14              OPL4_STATUS_LOAD = 0x02
 128++8E14
# file closed: GPlay/common/moonsound.asm
   2++8E14
   3++8E14              opl4writefm1
   4++8E14              ;e = register
   5++8E14              ;d = value
   6++8E14              	opl4_wait
   6++8E14 3E 00       >	ld a,MOON_BASE_HI
   6++8E16 DB 24       >	in a,(MOON_STAT)
   6++8E18 0F          >	rrca
   6++8E19 38 FB       >	jr c,$-3
   7++8E1B 7B           	ld a,e
   8++8E1C C5           	push bc
   9++8E1D 06 00        	ld b,MOON_BASE_HI
  10++8E1F 0E 24        	ld c,MOON_REG1
  11++8E21 ED 79        	out (c),a
  12++8E23              	opl4_wait
  12++8E23 3E 00       >	ld a,MOON_BASE_HI
  12++8E25 DB 24       >	in a,(MOON_STAT)
  12++8E27 0F          >	rrca
  12++8E28 38 FB       >	jr c,$-3
  13++8E2A 7A           	ld a,d
  14++8E2B 06 00        	ld b,MOON_BASE_HI
  15++8E2D 0E 25        	ld c,MOON_DAT1
  16++8E2F ED 79        	out (c),a
  17++8E31 C1           	pop bc
  18++8E32 C9           	ret
  19++8E33
  20++8E33              opl4writefm2
  21++8E33              ;e = register
  22++8E33              ;d = value
  23++8E33              	opl4_wait
  23++8E33 3E 00       >	ld a,MOON_BASE_HI
  23++8E35 DB 24       >	in a,(MOON_STAT)
  23++8E37 0F          >	rrca
  23++8E38 38 FB       >	jr c,$-3
  24++8E3A 7B           	ld a,e
  25++8E3B C5           	push bc
  26++8E3C 06 00        	ld b,MOON_BASE_HI
  27++8E3E 0E 26        	ld c,MOON_REG2
  28++8E40 ED 79        	out (c),a
  29++8E42              	opl4_wait
  29++8E42 3E 00       >	ld a,MOON_BASE_HI
  29++8E44 DB 24       >	in a,(MOON_STAT)
  29++8E46 0F          >	rrca
  29++8E47 38 FB       >	jr c,$-3
  30++8E49 7A           	ld a,d
  31++8E4A 06 00        	ld b,MOON_BASE_HI
  32++8E4C 0E 27        	ld c,MOON_DAT2
  33++8E4E ED 79        	out (c),a
  34++8E50 C1           	pop bc
  35++8E51 C9           	ret
  36++8E52
  37++8E52              opl4writewave
  38++8E52              ;e = register
  39++8E52              ;d = value
  40++8E52              	opl4_wait
  40++8E52 3E 00       >	ld a,MOON_BASE_HI
  40++8E54 DB 24       >	in a,(MOON_STAT)
  40++8E56 0F          >	rrca
  40++8E57 38 FB       >	jr c,$-3
  41++8E59 7B           	ld a,e
  42++8E5A C5           	push bc
  43++8E5B 06 00        	ld b,MOON_BASE_HI
  44++8E5D 0E C2        	ld c,MOON_WREG
  45++8E5F ED 79        	out (c),a
  46++8E61              	opl4_wait
  46++8E61 3E 00       >	ld a,MOON_BASE_HI
  46++8E63 DB 24       >	in a,(MOON_STAT)
  46++8E65 0F          >	rrca
  46++8E66 38 FB       >	jr c,$-3
  47++8E68 7A           	ld a,d
  48++8E69 06 00        	ld b,MOON_BASE_HI
  49++8E6B 0E C3        	ld c,MOON_WDAT
  50++8E6D ED 79        	out (c),a
  51++8E6F C1           	pop bc
  52++8E70 C9           	ret
  53++8E71
  54++8E71              opl4readwave
  55++8E71              ;e = register
  56++8E71              	opl4_wait
  56++8E71 3E 00       >	ld a,MOON_BASE_HI
  56++8E73 DB 24       >	in a,(MOON_STAT)
  56++8E75 0F          >	rrca
  56++8E76 38 FB       >	jr c,$-3
  57++8E78 7B           	ld a,e
  58++8E79 C5           	push bc
  59++8E7A 06 00        	ld b,MOON_BASE_HI
  60++8E7C 0E C2        	ld c,MOON_WREG
  61++8E7E ED 79        	out (c),a
  62++8E80 C1           	pop bc
  63++8E81              	opl4_wait
  63++8E81 3E 00       >	ld a,MOON_BASE_HI
  63++8E83 DB 24       >	in a,(MOON_STAT)
  63++8E85 0F          >	rrca
  63++8E86 38 FB       >	jr c,$-3
  64++8E88 3E 00        	ld a,MOON_BASE_HI
  65++8E8A DB C3        	in a,(MOON_WDAT)
  66++8E8C C9           	ret
  67++8E8D
  68++8E8D              	macro opl4_write_fm_regs
  69++8E8D ~            ;e = base register
  70++8E8D ~            ;d = value
  71++8E8D ~            ;b = count
  72++8E8D ~            .loop
  73++8E8D ~            	call opl4writefm1
  74++8E8D ~            	call opl4writefm2
  75++8E8D ~            	inc e
  76++8E8D ~            	djnz .loop
  77++8E8D              	endm
  78++8E8D
  79++8E8D              	macro opl4_write_wave_regs
  80++8E8D ~            ;e = base register
  81++8E8D ~            ;d = value
  82++8E8D ~            ;b = count
  83++8E8D ~            .loop
  84++8E8D ~            	call opl4writewave
  85++8E8D ~            	inc e
  86++8E8D ~            	djnz .loop
  87++8E8D              	endm
  88++8E8D
  89++8E8D              opl4init
  90++8E8D 11 05 03     	ld de,0x0305
  91++8E90 CD 33 8E     	call opl4writefm2
  92++8E93 06 DA        	ld b,0xda
  93++8E95 11 20 00     	ld de,0x0020
  94++8E98              	opl4_write_wave_regs
  94++8E98             >;e = base register
  94++8E98             >;d = value
  94++8E98             >;b = count
  94++8E98             >.loop
  94++8E98 CD 52 8E    >	call opl4writewave
  94++8E9B 1C          >	inc e
  94++8E9C 10 FA       >	djnz .loop
  95++8E9E 11 F8 1B     	ld de,0x1bf8
  96++8EA1 CD 52 8E     	call opl4writewave
  97++8EA4 11 02 10     	ld de,0x1002
  98++8EA7 CD 52 8E     	call opl4writewave
  99++8EAA 06 D6        	ld b,0xd6
 100++8EAC 11 20 00     	ld de,0x0020
 101++8EAF              	opl4_write_fm_regs
 101++8EAF             >;e = base register
 101++8EAF             >;d = value
 101++8EAF             >;b = count
 101++8EAF             >.loop
 101++8EAF CD 14 8E    >	call opl4writefm1
 101++8EB2 CD 33 8E    >	call opl4writefm2
 101++8EB5 1C          >	inc e
 101++8EB6 10 F7       >	djnz .loop
 102++8EB8 11 01 00     	ld de,0x0001
 103++8EBB CD 14 8E     	call opl4writefm1
 104++8EBE 11 08 00     	ld de,0x0008
 105++8EC1 CD 14 8E     	call opl4writefm1
 106++8EC4 11 04 00     	ld de,0x0004
 107++8EC7 C3 33 8E     	jp opl4writefm2
 108++8ECA
 109++8ECA              opl4stoptimers
 110++8ECA 11 04 80     	ld de,0x8004
 111++8ECD CD 14 8E     	call opl4writefm1
 112++8ED0 11 04 00     	ld de,0x0004
 113++8ED3 C3 14 8E     	jp opl4writefm1
 114++8ED6
 115++8ED6              opl4mute
 116++8ED6 CD CA 8E     	call opl4stoptimers
 117++8ED9 11 04 00     	ld de,0x0004
 118++8EDC CD 33 8E     	call opl4writefm2
 119++8EDF 11 BD 00     	ld de,0x00bd
 120++8EE2 CD 14 8E     	call opl4writefm1 ;rhythm off
 121++8EE5 06 16        	ld b,0x16
 122++8EE7 11 80 0F     	ld de,0x0f80
 123++8EEA              	opl4_write_fm_regs ;max release rate
 123++8EEA             >;e = base register
 123++8EEA             >;d = value
 123++8EEA             >;b = count
 123++8EEA             >.loop
 123++8EEA CD 14 8E    >	call opl4writefm1
 123++8EED CD 33 8E    >	call opl4writefm2
 123++8EF0 1C          >	inc e
 123++8EF1 10 F7       >	djnz .loop
 124++8EF3 06 16        	ld b,0x16
 125++8EF5 11 40 3F     	ld de,0x3f40
 126++8EF8              	opl4_write_fm_regs ;min total level
 126++8EF8             >;e = base register
 126++8EF8             >;d = value
 126++8EF8             >;b = count
 126++8EF8             >.loop
 126++8EF8 CD 14 8E    >	call opl4writefm1
 126++8EFB CD 33 8E    >	call opl4writefm2
 126++8EFE 1C          >	inc e
 126++8EFF 10 F7       >	djnz .loop
 127++8F01 06 09        	ld b,0x09
 128++8F03 11 A0 00     	ld de,0x00a0
 129++8F06              	opl4_write_fm_regs ;frequency 0
 129++8F06             >;e = base register
 129++8F06             >;d = value
 129++8F06             >;b = count
 129++8F06             >.loop
 129++8F06 CD 14 8E    >	call opl4writefm1
 129++8F09 CD 33 8E    >	call opl4writefm2
 129++8F0C 1C          >	inc e
 129++8F0D 10 F7       >	djnz .loop
 130++8F0F 06 09        	ld b,0x09
 131++8F11 11 B0 00     	ld de,0x00b0
 132++8F14              	opl4_write_fm_regs ;key off
 132++8F14             >;e = base register
 132++8F14             >;d = value
 132++8F14             >;b = count
 132++8F14             >.loop
 132++8F14 CD 14 8E    >	call opl4writefm1
 132++8F17 CD 33 8E    >	call opl4writefm2
 132++8F1A 1C          >	inc e
 132++8F1B 10 F7       >	djnz .loop
 133++8F1D 06 18        	ld b,0x18
 134++8F1F 11 68 40     	ld de,0x4068
 135++8F22              	opl4_write_wave_regs ;key off, damp
 135++8F22             >;e = base register
 135++8F22             >;d = value
 135++8F22             >;b = count
 135++8F22             >.loop
 135++8F22 CD 52 8E    >	call opl4writewave
 135++8F25 1C          >	inc e
 135++8F26 10 FA       >	djnz .loop
 136++8F28 11 05 00     	ld de,0x0005
 137++8F2B C3 33 8E     	jp opl4writefm2
 138++8F2E
 139++8F2E              opl4setmemoryaddress
 140++8F2E              ;dhl = memory address
 141++8F2E 1E 03        	ld e,0x03
 142++8F30 CD 52 8E     	call opl4writewave
 143++8F33 54           	ld d,h
 144++8F34 1C           	inc e
 145++8F35 CD 52 8E     	call opl4writewave
 146++8F38 1C           	inc e
 147++8F39 55           	ld d,l
 148++8F3A C3 52 8E     	jp opl4writewave
 149++8F3D
 150++8F3D              opl4readmemory
 151++8F3D              ;bc = byte count
 152++8F3D              ;dhl = memory address
 153++8F3D              ;ix = buffer
 154++8F3D CD 2E 8F     	call opl4setmemoryaddress
 155++8F40 11 02 11     	ld de,0x1102
 156++8F43 CD 52 8E     	call opl4writewave
 157++8F46              	opl4_wait
 157++8F46 3E 00       >	ld a,MOON_BASE_HI
 157++8F48 DB 24       >	in a,(MOON_STAT)
 157++8F4A 0F          >	rrca
 157++8F4B 38 FB       >	jr c,$-3
 158++8F4D 3E 06        	ld a,6
 159++8F4F C5           	push bc
 160++8F50 06 00        	ld b,MOON_BASE_HI
 161++8F52 0E C2        	ld c,MOON_WREG
 162++8F54 ED 79        	out (c),a
 163++8F56 C1           	pop bc
 164++8F57 DD 54 DD 5D  	ld de,ix
 165++8F5B 79           	ld a,c
 166++8F5C 0B           	dec bc
 167++8F5D 04           	inc b
 168++8F5E 48           	ld c,b
 169++8F5F 47           	ld b,a
 170++8F60              .readloop
 171++8F60              	opl4_wait
 171++8F60 3E 00       >	ld a,MOON_BASE_HI
 171++8F62 DB 24       >	in a,(MOON_STAT)
 171++8F64 0F          >	rrca
 171++8F65 38 FB       >	jr c,$-3
 172++8F67 3E 00        	ld a,MOON_BASE_HI
 173++8F69 DB C3        	in a,(MOON_WDAT)
 174++8F6B 12           	ld (de),a
 175++8F6C 13           	inc de
 176++8F6D 10 F1        	djnz .readloop
 177++8F6F 0D           	dec c
 178++8F70 20 EE        	jr nz,.readloop
 179++8F72 11 02 10     	ld de,0x1002
 180++8F75 C3 52 8E     	jp opl4writewave
 181++8F78
 182++8F78              opl4writememory
 183++8F78              ;bc = number of bytes
 184++8F78              ;dhl = memory address
 185++8F78              ;ix = buffer
 186++8F78 CD 2E 8F     	call opl4setmemoryaddress
 187++8F7B 11 02 11     	ld de,0x1102
 188++8F7E CD 52 8E     	call opl4writewave
 189++8F81              	opl4_wait
 189++8F81 3E 00       >	ld a,MOON_BASE_HI
 189++8F83 DB 24       >	in a,(MOON_STAT)
 189++8F85 0F          >	rrca
 189++8F86 38 FB       >	jr c,$-3
 190++8F88 3E 06        	ld a,6
 191++8F8A C5           	push bc
 192++8F8B 06 00        	ld b,MOON_BASE_HI
 193++8F8D 0E C2        	ld c,MOON_WREG
 194++8F8F ED 79        	out (c),a
 195++8F91 C1           	pop bc
 196++8F92 DD 54 DD 5D  	ld de,ix
 197++8F96 79           	ld a,c
 198++8F97 0B           	dec bc
 199++8F98 04           	inc b
 200++8F99 48           	ld c,b
 201++8F9A 47           	ld b,a
 202++8F9B              .writeloop
 203++8F9B              	opl4_wait
 203++8F9B 3E 00       >	ld a,MOON_BASE_HI
 203++8F9D DB 24       >	in a,(MOON_STAT)
 203++8F9F 0F          >	rrca
 203++8FA0 38 FB       >	jr c,$-3
 204++8FA2 1A           	ld a,(de)
 205++8FA3 C5           	push bc
 206++8FA4 06 00        	ld b,MOON_BASE_HI
 207++8FA6 0E C3        	ld c,MOON_WDAT
 208++8FA8 ED 79        	out (c),a
 209++8FAA C1           	pop bc
 210++8FAB 13           	inc de
 211++8FAC 10 ED        	djnz .writeloop
 212++8FAE 0D           	dec c
 213++8FAF 20 EA        	jr nz,.writeloop
 214++8FB1 11 02 10     	ld de,0x1002
 215++8FB4 C3 52 8E     	jp opl4writewave
 216++8FB7
# file closed: GPlay/common/opl4.asm
  75++8FB7              	include "common/opm.asm"
# file opened: GPlay/common/opm.asm
   1++8FB7              ;Having chip 0 is mandatory for the player to detect YM2151,
   2++8FB7              ;chip 1 is an optional second chip.
   3++8FB7
   4++8FB7              OPM0_REG = 0xf0c1 ;write: chip 0 address
   5++8FB7              OPM0_DAT = 0xf1c1 ;write: chip 0 value, read: chip 0 status
   6++8FB7              OPM1_REG = 0xf2c1 ;write: chip 1 address
   7++8FB7              OPM1_DAT = 0xf3c1 ;write: chip 1 value, read: chip 1 status
   8++8FB7
   9++8FB7              	macro opm_write_reg reg,dat
  10++8FB7 ~            ;bc = data port
  11++8FB7 ~            ;e = register
  12++8FB7 ~            ;d = value
  13++8FB7 ~            	ld bc,dat
  14++8FB7 ~            	in f,(c)
  15++8FB7 ~            	jp m,$-2
  16++8FB7 ~            	ld bc,reg
  17++8FB7 ~            	out (c),e
  18++8FB7 ~            	ld bc,dat
  19++8FB7 ~            	in f,(c)
  20++8FB7 ~            	jp m,$-2
  21++8FB7 ~            	out (c),d
  22++8FB7              	endm
  23++8FB7
  24++8FB7              opmwriteall
  25++8FB7              ;e = register
  26++8FB7              ;d = value
  27++8FB7 CD D2 8F     	call opmwritechip1
  28++8FBA              opmwritechip0
  29++8FBA              ;e = register
  30++8FBA              ;d = value
  31++8FBA              	opm_write_reg OPM0_REG,OPM0_DAT
  31++8FBA             >;bc = data port
  31++8FBA             >;e = register
  31++8FBA             >;d = value
  31++8FBA 01 C1 F1    >	ld bc,OPM0_DAT
  31++8FBD ED 70       >	in f,(c)
  31++8FBF FA BD 8F    >	jp m,$-2
  31++8FC2 01 C1 F0    >	ld bc,OPM0_REG
  31++8FC5 ED 59       >	out (c),e
  31++8FC7 01 C1 F1    >	ld bc,OPM0_DAT
  31++8FCA ED 70       >	in f,(c)
  31++8FCC FA CA 8F    >	jp m,$-2
  31++8FCF ED 51       >	out (c),d
  32++8FD1 C9           	ret
  33++8FD2
  34++8FD2              opmwritechip1
  35++8FD2              ;e = register
  36++8FD2              ;d = value
  37++8FD2              	opm_write_reg OPM1_REG,OPM1_DAT
  37++8FD2             >;bc = data port
  37++8FD2             >;e = register
  37++8FD2             >;d = value
  37++8FD2 01 C1 F3    >	ld bc,OPM1_DAT
  37++8FD5 ED 70       >	in f,(c)
  37++8FD7 FA D5 8F    >	jp m,$-2
  37++8FDA 01 C1 F2    >	ld bc,OPM1_REG
  37++8FDD ED 59       >	out (c),e
  37++8FDF 01 C1 F3    >	ld bc,OPM1_DAT
  37++8FE2 ED 70       >	in f,(c)
  37++8FE4 FA E2 8F    >	jp m,$-2
  37++8FE7 ED 51       >	out (c),d
  38++8FE9 C9           	ret
  39++8FEA
  40++8FEA              opmdisablechip1
  41++8FEA 3E C9        	ld a,0xc9 ;ret opcode
  42++8FEC 32 D2 8F     	ld (opmwritechip1),a
  43++8FEF C9           	ret
  44++8FF0
  45++8FF0              	macro opm_write_regs incr,incd
  46++8FF0 ~            ;e = base register
  47++8FF0 ~            ;d = value
  48++8FF0 ~            ;l = count
  49++8FF0 ~            .loop	call opmwriteall
  50++8FF0 ~            	IF incr
  51++8FF0 ~            	inc e
  52++8FF0 ~            	ENDIF
  53++8FF0 ~            	IF incd
  54++8FF0 ~            	inc d
  55++8FF0 ~            	ENDIF
  56++8FF0 ~            	dec l
  57++8FF0 ~            	jr nz,.loop
  58++8FF0              	endm
  59++8FF0
  60++8FF0              opminit
  61++8FF0 2E 00        	ld l,0
  62++8FF2 11 00 00     	ld de,0
  63++8FF5              	opm_write_regs 1,0
  63++8FF5             >;e = base register
  63++8FF5             >;d = value
  63++8FF5             >;l = count
  63++8FF5 CD B7 8F    >.loop	call opmwriteall
  63++8FF8             >	IF 1
  63++8FF8 1C          >	inc e
  63++8FF9             >	ENDIF
  63++8FF9             >	IF 0
  63++8FF9 ~           >	inc d
  63++8FF9             >	ENDIF
  63++8FF9 2D          >	dec l
  63++8FFA 20 F9       >	jr nz,.loop
  64++8FFC C9           	ret
  65++8FFD
  66++8FFD              opmstoptimers
  67++8FFD 11 14 30     	ld de,0x3014
  68++9000 CD B7 8F     	call opmwriteall
  69++9003 11 14 00     	ld de,0x0014
  70++9006 C3 B7 8F     	jp opmwriteall
  71++9009
  72++9009              opmmute
  73++9009 CD FD 8F     	call opmstoptimers
  74++900C              ;max release rate
  75++900C 2E 20        	ld l,0x20
  76++900E 11 E0 0F     	ld de,0x0fe0
  77++9011              	opm_write_regs 1,0
  77++9011             >;e = base register
  77++9011             >;d = value
  77++9011             >;l = count
  77++9011 CD B7 8F    >.loop	call opmwriteall
  77++9014             >	IF 1
  77++9014 1C          >	inc e
  77++9015             >	ENDIF
  77++9015             >	IF 0
  77++9015 ~           >	inc d
  77++9015             >	ENDIF
  77++9015 2D          >	dec l
  77++9016 20 F9       >	jr nz,.loop
  78++9018              ;min total level
  79++9018 2E 20        	ld l,0x20
  80++901A 11 60 7F     	ld de,0x7f60
  81++901D              	opm_write_regs 1,0
  81++901D             >;e = base register
  81++901D             >;d = value
  81++901D             >;l = count
  81++901D CD B7 8F    >.loop	call opmwriteall
  81++9020             >	IF 1
  81++9020 1C          >	inc e
  81++9021             >	ENDIF
  81++9021             >	IF 0
  81++9021 ~           >	inc d
  81++9021             >	ENDIF
  81++9021 2D          >	dec l
  81++9022 20 F9       >	jr nz,.loop
  82++9024              ;key off
  83++9024 2E 08        	ld l,0x08
  84++9026 11 08 00     	ld de,0x0008
  85++9029              	opm_write_regs 0,1
  85++9029             >;e = base register
  85++9029             >;d = value
  85++9029             >;l = count
  85++9029 CD B7 8F    >.loop	call opmwriteall
  85++902C             >	IF 0
  85++902C ~           >	inc e
  85++902C             >	ENDIF
  85++902C             >	IF 1
  85++902C 14          >	inc d
  85++902D             >	ENDIF
  85++902D 2D          >	dec l
  85++902E 20 F9       >	jr nz,.loop
  86++9030 C9           	ret
  87++9031
# file closed: GPlay/common/opm.asm
  76++9031              	include "vgm/opl4.asm"
# file opened: GPlay/vgm/opl4.asm
   1++9031              WAVEHEADERBUFFERSIZE = MOONRAMWAVETABLESIZE*MOONWAVEHEADERSIZE
   2++9031
   3++9031              opl4writemusiconlyfm1
   4++9031              ;skips writes to control registers
   5++9031              ;e = register
   6++9031              ;d = value
   7++9031 7B           	ld a,e
   8++9032 FE 20        	cp 0x20
   9++9034 D2 14 8E     	jp nc,opl4writefm1
  10++9037 FE 08        	cp 0x08
  11++9039 C0           	ret nz
  12++903A C3 14 8E     	jp opl4writefm1
  13++903D
  14++903D              opl4writemusiconlyfm2
  15++903D              ;skips writes to control registers
  16++903D              ;e = register
  17++903D              ;d = value
  18++903D 7B           	ld a,e
  19++903E FE 04        	cp 4
  20++9040 D8               ret c
  21++9041 FE 05        	cp 5
  22++9043 C8           	ret z
  23++9044 C3 33 8E     	jp opl4writefm2
  24++9047
  25++9047              opl4writewavemusiconly
  26++9047              ;skips writes to control registers and handles ROM dumps
  27++9047              ;e = register
  28++9047              ;d = value
  29++9047 7B           	ld a,e
  30++9048 FE 38        	cp 0x38
  31++904A D2 52 8E     	jp nc,opl4writewave
  32++904D FE 08        	cp 0x08
  33++904F D8           	ret c
  34++9050 FE 20        	cp 0x20
  35++9052 38 07        	jr c,writewavetableindexlo
  36++9054              ;force wave table index into 384--511 range if ROM data is loaded
  37++9054              isromloaded=$+1
  38++9054 3E 00        	ld a,0
  39++9056 B2           	or d
  40++9057 57           	ld d,a
  41++9058 C3 52 8E     	jp opl4writewave
  42++905B              writewavetableindexlo
  43++905B 3A 55 90     	ld a,(isromloaded)
  44++905E 0F           	rrca
  45++905F B2           	or d
  46++9060 57           	ld d,a
  47++9061 CD 52 8E     	call opl4writewave
  48++9064              ;wait for the header to load
  49++9064 3E 00        	ld a,MOON_BASE_HI
  50++9066 DB 24        	in a,(MOON_STAT)
  51++9068 E6 03        	and 3
  52++906A 20 FA        	jr nz,$-4
  53++906C C9           	ret
  54++906D
  55++906D              vgmopl4init
  56++906D AF           	xor a
  57++906E 32 55 90     	ld (isromloaded),a
  58++9071 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
  59++9074 22 B3 90     	ld (opl4loadramdatablockheader.romsize0),hl
  60++9077 3E 20        	ld a,MOONSOUNDROMSIZE/65536
  61++9079 32 B7 90     	ld (opl4loadramdatablockheader.romsize2),a
  62++907C C3 8D 8E     	jp opl4init
  63++907F
  64++907F              sub24x16
  65++907F              ;dhl = minuend
  66++907F              ;bc = subtrahend
  67++907F              ;out: cf=1 if negative result, zf=1 if zero
  68++907F B7 ED 42     	sub hl,bc
  69++9082 38 04        	jr c,.carry
  70++9084 C0           	ret nz
  71++9085 7A           	ld a,d
  72++9086 B7           	or a
  73++9087 C9           	ret
  74++9088              .carry
  75++9088 7A           	ld a,d
  76++9089 DE 00        	sbc a,0
  77++908B 57           	ld d,a
  78++908C C0           	ret nz
  79++908D 7D           	ld a,l
  80++908E B4           	or h
  81++908F C9           	ret
  82++9090
  83++9090              opl4loadromdatablockheader
  84++9090              ;dhl = header+data size
  85++9090              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
  86++9090 D9           	exx
  87++9091 CD 71 8D     	call memorystreamread4 ;adbc = total rom size
  88++9094 ED 43 B3 90  	ld (opl4loadramdatablockheader.romsize0),bc
  89++9098 7A           	ld a,d
  90++9099 C6 20        	add 0x20 ;place in RAM
  91++909B 32 B7 90     	ld (opl4loadramdatablockheader.romsize2),a
  92++909E CD 71 8D     	call memorystreamread4 ;adbc = start address
  93++90A1 60 69        	ld hl,bc
  94++90A3 CB EA        	set 5,d ;place in RAM
  95++90A5 D9           	exx
  96++90A6 01 08 00     	ld bc,8
  97++90A9 18 D4        	jr sub24x16
  98++90AB
  99++90AB              opl4loadramdatablockheader
 100++90AB              ;dhl = header+data size
 101++90AB              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
 102++90AB D9           	exx
 103++90AC CD 71 8D     	call memorystreamread4 ;adbc = total ram size
 104++90AF CD 71 8D     	call memorystreamread4 ;adbc = start address
 105++90B2              .romsize0=$+1
 106++90B2 21 00 00     	ld hl,0
 107++90B5 09           	add hl,bc
 108++90B6              .romsize2=$+1
 109++90B6 3E 00        	ld a,0
 110++90B8 8A           	adc a,d
 111++90B9 E6 3F        	and 0x3f
 112++90BB 57           	ld d,a
 113++90BC D9           	exx
 114++90BD 01 08 00     	ld bc,8
 115++90C0 18 BD        	jr sub24x16
 116++90C2
 117++90C2              setup24bitscounterloop
 118++90C2              ;dhl = counter
 119++90C2              ;out: b = inner loop counter, de = outer loop counter
 120++90C2 5D           	ld e,l
 121++90C3 01 01 00     	ld bc,1
 122++90C6 B7 ED 42     	sub hl,bc
 123++90C9 30 01        	jr nc,$+3
 124++90CB 15           	dec d
 125++90CC 43           	ld b,e
 126++90CD 5C           	ld e,h
 127++90CE 13           	inc de
 128++90CF C9           	ret
 129++90D0
 130++90D0              opl4loadsample
 131++90D0              ;dhl = sample start address
 132++90D0              ;dhl' = sample size
 133++90D0 42           	ld b,d
 134++90D1 11 05 03     	ld de,0x0305
 135++90D4 CD 33 8E     	call opl4writefm2
 136++90D7 50           	ld d,b
 137++90D8 CD 2E 8F     	call opl4setmemoryaddress
 138++90DB 11 02 11     	ld de,0x1102
 139++90DE CD 52 8E     	call opl4writewave
 140++90E1              	opl4_wait
 140++90E1 3E 00       >	ld a,MOON_BASE_HI
 140++90E3 DB 24       >	in a,(MOON_STAT)
 140++90E5 0F          >	rrca
 140++90E6 38 FB       >	jr c,$-3
 141++90E8 3E 06        	ld a,6
 142++90EA C5           	push bc
 143++90EB 06 00        	ld b,MOON_BASE_HI
 144++90ED 0E C2        	ld c,MOON_WREG
 145++90EF ED 79        	out (c),a
 146++90F1 C1           	pop bc
 147++90F2 D9           	exx
 148++90F3 CD C2 90     	call setup24bitscounterloop
 149++90F6 2A 72 8D     	ld hl,(memorystreamcurrentaddr)
 150++90F9              .loop
 151++90F9              	memory_stream_read_byte c
 151++90F9 CB 74       >	bit 6,h
 151++90FB             >        IF AREA_C000_FFFF=1
 151++90FB CC 0D 8D    >	call z,memorystreamnextpage
 151++90FE             >        ELSE
 151++90FE ~           > 	call nz,memorystreamnextpage
 151++90FE             >        ENDIF
 151++90FE 4E          >	ld c,(hl)
 151++90FF 23          >	inc hl
 152++9100              	opl4_wait
 152++9100 3E 00       >	ld a,MOON_BASE_HI
 152++9102 DB 24       >	in a,(MOON_STAT)
 152++9104 0F          >	rrca
 152++9105 38 FB       >	jr c,$-3
 153++9107 79           	ld a,c
 154++9108 C5           	push bc
 155++9109 06 00        	ld b,MOON_BASE_HI
 156++910B 0E C3        	ld c,MOON_WDAT
 157++910D ED 79        	out (c),a
 158++910F C1           	pop bc
 159++9110 10 E7        	djnz .loop
 160++9112 1B           	dec de
 161++9113 7B           	ld a,e
 162++9114 B2           	or d
 163++9115 20 E2        	jr nz,.loop
 164++9117 22 72 8D     	ld (memorystreamcurrentaddr),hl
 165++911A 11 02 10     	ld de,0x1002
 166++911D C3 52 8E     	jp opl4writewave
 167++9120
 168++9120              opl4loadramdatablock
 169++9120              ;dhl = data+header size
 170++9120 CD AB 90     	call opl4loadramdatablockheader
 171++9123 C8           	ret z
 172++9124 D9           	exx
 173++9125 18 A9        	jr opl4loadsample
 174++9127
 175++9127              opl4loadromdatablock
 176++9127              ;dhl = data+header size
 177++9127 CD 90 90     	call opl4loadromdatablockheader
 178++912A C8           	ret z
 179++912B D9           	exx
 180++912C D5           	push de
 181++912D CD D0 90     	call opl4loadsample
 182++9130 F1           	pop af
 183++9131              ;check if the address is within the first 64K of RAM
 184++9131 FE 21        	cp 0x21
 185++9133 D0           	ret nc
 186++9134              ;patch all 128 headers that LSI can read from RAM
 187++9134 3E 01        	ld a,1
 188++9136 32 55 90     	ld (isromloaded),a
 189++9139 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 190++913C 16 20        	ld d,MOONSOUNDROMSIZE/65536
 191++913E 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 192++9141 DD 21 00 B8  	ld ix,waveheaderbuffer
 193++9145 CD 3D 8F     	call opl4readmemory
 194++9148 21 00 B8     	ld hl,waveheaderbuffer
 195++914B 11 0C 00     	ld de,MOONWAVEHEADERSIZE
 196++914E 06 80        	ld b,MOONRAMWAVETABLESIZE
 197++9150              .loop
 198++9150 CB EE        	set 5,(hl) ;set base address in RAM area
 199++9152 19           	add hl,de
 200++9153 10 FB        	djnz .loop
 201++9155 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 202++9158 16 20        	ld d,MOONSOUNDROMSIZE/65536
 203++915A 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 204++915D DD 21 00 B8  	ld ix,waveheaderbuffer
 205++9161 C3 78 8F     	jp opl4writememory
 206++9164
 207++9164              opl4inittimer60hz
 208++9164 11 02 2F     	ld de,0x2f02
 209++9167 CD 14 8E     	call opl4writefm1
 210++916A 11 04 21     	ld de,0x2104
 211++916D C3 14 8E     	jp opl4writefm1
 212++9170
 213++9170              opl4waittimer60hz
 214++9170 3E 00        	ld a,MOON_BASE_HI
 215++9172 DB 24        	in a,(MOON_STAT)
 216++9174 17           	rla
 217++9175 30 F9        	jr nc,opl4waittimer60hz
 218++9177 11 04 81     	ld de,0x8104
 219++917A C3 14 8E     	jp opl4writefm1
 220++917D
# file closed: GPlay/vgm/opl4.asm
  77++917D              	include "common/opn.asm"
# file opened: GPlay/common/opn.asm
   1++917D              ;Define ENABLE_FM to enable FM DACs
   2++917D
   3++917D              OPN_REG = 0xfffd
   4++917D              OPN_DAT = 0xbffd
   5++917D
   6++917D
   7++917D                      ifdef ENABLE_FM
   8++917D ~            CHIP0 = %11111000
   9++917D ~            CHIP1 = %11111001
  10++917D                      else
  11++917D              CHIP0 = %11111100
  12++917D              CHIP1 = %11111101
  13++917D                      endif
  14++917D
  15++917D
  16++917D              ;------------------------------------
  17++917D              opnwriteall
  18++917D CD A0 91     	call opnwritefm2
  19++9180              ;------------------------------------
  20++9180              opnwritefm1:
  21++9180              	;opn_write_fm_reg 0
  22++9180 3E FC              	ld a,CHIP0
  23++9182              opnwritefmx:
  24++9182              ;a = chipselect
  25++9182              ;e = register
  26++9182              ;d = value
  27++9182 01 FD FF     	ld bc,OPN_REG
  28++9185 ED 79        	out (c),a
  29++9187
  30++9187              1
  31++9187 00           	nop
  31++9188 00            nop
  32++9189              ;        nop:nop:nop
  33++9189 ED 70        	in f,(c)
  34++918B FA 87 91     	jp m, 1b ;$-6
  35++918E
  36++918E ED 59        	out (c),e
  37++9190
  38++9190              2
  39++9190 00             	nop
  39++9191 00            nop
  40++9192              ;        nop:nop:nop
  41++9192 ED 70        	in f,(c)
  42++9194 FA 90 91     	jp m,2b   ;$-6
  43++9197
  44++9197 06 BF        	ld b,HIGH OPN_DAT
  45++9199 ED 51        	out (c),d
  46++919B
  47++919B              .extradelay ;additional delay for FPGA systems
  48++919B 06 08        	ld b,8
  49++919D 10 FE        	djnz $
  50++919F C9           	ret
  51++91A0              ;------------------------------------
  52++91A0              opnwritefm2:
  53++91A0 3E FD               	ld a,CHIP1
  54++91A2 C3 82 91             jp opnwritefmx
  55++91A5              ;------------------------------------
  56++91A5
  57++91A5
  58++91A5              opndisableextradelay
  59++91A5 3E C9        	ld a,0xc9 ;ret opcode
  60++91A7 32 9B 91     	ld (opnwritefmx.extradelay),a
  61++91AA C9           	ret
  62++91AB
  63++91AB
  64++91AB              	macro opn_write_fm_regs incr,incd
  65++91AB ~            ;e = base register
  66++91AB ~            ;d = value
  67++91AB ~            ;l = count
  68++91AB ~            .loop	call opnwriteall
  69++91AB ~            	IF incr
  70++91AB ~            	inc e
  71++91AB ~            	ENDIF
  72++91AB ~            	IF incd
  73++91AB ~            	inc d
  74++91AB ~            	ENDIF
  75++91AB ~            	dec l
  76++91AB ~            	jr nz,.loop
  77++91AB              	endm
  78++91AB
  79++91AB
  80++91AB
  81++91AB              opninit
  82++91AB 2E B4        	ld l,0xb4
  83++91AD 11 00 00     	ld de,0x0000
  84++91B0              	opn_write_fm_regs 1,0
  84++91B0             >;e = base register
  84++91B0             >;d = value
  84++91B0             >;l = count
  84++91B0 CD 7D 91    >.loop	call opnwriteall
  84++91B3             >	IF 1
  84++91B3 1C          >	inc e
  84++91B4             >	ENDIF
  84++91B4             >	IF 0
  84++91B4 ~           >	inc d
  84++91B4             >	ENDIF
  84++91B4 2D          >	dec l
  84++91B5 20 F9       >	jr nz,.loop
  85++91B7              ;configure prescaler
  86++91B7 11 2F 00     	ld de,0x002f
  87++91BA CD 7D 91     	call opnwriteall
  88++91BD 11 2D 00     	ld de,0x002d
  89++91C0 C3 7D 91     	jp opnwriteall
  90++91C3
  91++91C3              opnstoptimers
  92++91C3 11 27 30     	ld de,0x3027
  93++91C6 CD 7D 91     	call opnwriteall
  94++91C9 11 27 00     	ld de,0x0027
  95++91CC C3 7D 91     	jp opnwriteall
  96++91CF
  97++91CF              opnmute
  98++91CF CD C3 91     	call opnstoptimers
  99++91D2              ;mute SSG
 100++91D2 2E 03        	ld l,3
 101++91D4 11 08 00     	ld de,0x0008
 102++91D7              	opn_write_fm_regs 1,0
 102++91D7             >;e = base register
 102++91D7             >;d = value
 102++91D7             >;l = count
 102++91D7 CD 7D 91    >.loop	call opnwriteall
 102++91DA             >	IF 1
 102++91DA 1C          >	inc e
 102++91DB             >	ENDIF
 102++91DB             >	IF 0
 102++91DB ~           >	inc d
 102++91DB             >	ENDIF
 102++91DB 2D          >	dec l
 102++91DC 20 F9       >	jr nz,.loop
 103++91DE 2E 0E        	ld l,14
 104++91E0 11 00 00     	ld de,0x0000
 105++91E3              	opn_write_fm_regs 1,0
 105++91E3             >;e = base register
 105++91E3             >;d = value
 105++91E3             >;l = count
 105++91E3 CD 7D 91    >.loop	call opnwriteall
 105++91E6             >	IF 1
 105++91E6 1C          >	inc e
 105++91E7             >	ENDIF
 105++91E7             >	IF 0
 105++91E7 ~           >	inc d
 105++91E7             >	ENDIF
 105++91E7 2D          >	dec l
 105++91E8 20 F9       >	jr nz,.loop
 106++91EA              ;max release rate
 107++91EA 2E 10        	ld l,0x10
 108++91EC 11 80 0F     	ld de,0x0f80
 109++91EF              	opn_write_fm_regs 1,0
 109++91EF             >;e = base register
 109++91EF             >;d = value
 109++91EF             >;l = count
 109++91EF CD 7D 91    >.loop	call opnwriteall
 109++91F2             >	IF 1
 109++91F2 1C          >	inc e
 109++91F3             >	ENDIF
 109++91F3             >	IF 0
 109++91F3 ~           >	inc d
 109++91F3             >	ENDIF
 109++91F3 2D          >	dec l
 109++91F4 20 F9       >	jr nz,.loop
 110++91F6              ;min total level
 111++91F6 2E 10        	ld l,0x10
 112++91F8 11 40 7F     	ld de,0x7f40
 113++91FB              	opn_write_fm_regs 1,0
 113++91FB             >;e = base register
 113++91FB             >;d = value
 113++91FB             >;l = count
 113++91FB CD 7D 91    >.loop	call opnwriteall
 113++91FE             >	IF 1
 113++91FE 1C          >	inc e
 113++91FF             >	ENDIF
 113++91FF             >	IF 0
 113++91FF ~           >	inc d
 113++91FF             >	ENDIF
 113++91FF 2D          >	dec l
 113++9200 20 F9       >	jr nz,.loop
 114++9202              ;key off
 115++9202 2E 04        	ld l,0x04
 116++9204 11 28 00     	ld de,0x0028
 117++9207              	opn_write_fm_regs 0,1
 117++9207             >;e = base register
 117++9207             >;d = value
 117++9207             >;l = count
 117++9207 CD 7D 91    >.loop	call opnwriteall
 117++920A             >	IF 0
 117++920A ~           >	inc e
 117++920A             >	ENDIF
 117++920A             >	IF 1
 117++920A 14          >	inc d
 117++920B             >	ENDIF
 117++920B 2D          >	dec l
 117++920C 20 F9       >	jr nz,.loop
 118++920E              ;default tfm state
 119++920E 01 FD FF     	ld bc,OPN_REG
 120++9211 3E FF        	ld a,%11111111
 121++9213 ED 79        	out (c),a
 122++9215 C9           	ret
 123++9216
# file closed: GPlay/common/opn.asm
  78++9216              	include "vgm/opn.asm"
# file opened: GPlay/vgm/opn.asm
   1++9216              opniscontrolregister
   2++9216              ;a = register
   3++9216              ;out: zf=1 if it's control register, zf=0 otherwise
   4++9216 FE 0E        	cp 0x0e ;IO port
   5++9218 C8           	ret z
   6++9219 FE 0F        	cp 0x0f ;IO port
   7++921B C8           	ret z
   8++921C FE 2D        	cp 0x2d ;prescaler
   9++921E C8           	ret z
  10++921F FE 2E        	cp 0x2e ;prescaler
  11++9221 C8           	ret z
  12++9222 FE 2F        	cp 0x2f ;prescaler
  13++9224 C9           	ret
  14++9225
  15++9225              opnwritemusiconlyfm1
  16++9225              ;skips writes to control registers
  17++9225              ;e = register
  18++9225              ;d = value
  19++9225 7B           	ld a,e
  20++9226 CD 16 92     	call opniscontrolregister
  21++9229 C8           	ret z
  22++922A FE 27        	cp 0x27 ;timers control
  23++922C C2 80 91     	jp nz,opnwritefm1
  24++922F 7A           	ld a,d
  25++9230 32 5E 92     	ld (opntimerctrl),a
  26++9233 F6 0A        	or %00001010 ;avoid altering timer B
  27++9235 57           	ld d,a
  28++9236 C3 80 91     	jp opnwritefm1
  29++9239
  30++9239              opnwritemusiconlyfm2
  31++9239              ;skips writes to control registers
  32++9239              ;e = register
  33++9239              ;d = value
  34++9239 7B           	ld a,e
  35++923A CD 16 92     	call opniscontrolregister
  36++923D C8           	ret z
  37++923E C3 A0 91     	jp opnwritefm2
  38++9241
  39++9241              opninittimer60hz
  40++9241              ;	ld de,0xc626
  41++9241              ;	ld de,0xca26
  42++9241 11 26 CD     	ld de,0xcd26
  43++9244 CD 80 91     	call opnwritefm1
  44++9247 11 27 2A     	ld de,0x2a27
  45++924A C3 80 91     	jp opnwritefm1
  46++924D
  47++924D              opnwaittimer60hz
  48++924D 01 FD FF     	ld bc,OPN_REG
  49++9250 3E F8        	ld a,%11111000
  50++9252 ED 79        	out (c),a
  51++9254              .waitloop
  52++9254 ED 78        	in a,(c)
  53++9256 E6 02        	and 2
  54++9258 28 FA        	jr z,.waitloop
  55++925A 11 27 2A     	ld de,0x2a27
  56++925D              opntimerctrl=$+1
  57++925D 3E 00        	ld a,0
  58++925F B2           	or d
  59++9260 57           	ld d,a
  60++9261 C3 80 91     	jp opnwritefm1
  61++9264
# file closed: GPlay/vgm/opn.asm
  79++9264              	include "vgm/opm.asm"
# file opened: GPlay/vgm/opm.asm
   1++9264              opmwritemusiconlychip0
   2++9264              ;e = register
   3++9264              ;d = value
   4++9264 7B           	ld a,e
   5++9265 FE 08        	cp 8
   6++9267 D8           	ret c
   7++9268 C3 BA 8F     	jp opmwritechip0
   8++926B
   9++926B              opmwritemusiconlychip1
  10++926B              ;e = register
  11++926B              ;d = value
  12++926B 7B           	ld a,e
  13++926C FE 08        	cp 8
  14++926E D8           	ret c
  15++926F C3 D2 8F     	jp opmwritechip1
  16++9272
  17++9272              vgmopminit
  18++9272 3E 02        	ld a,2
  19++9274 32 7B 92     	ld (opmwaittimer100hz.counter),a
  20++9277 C3 F0 8F     	jp opminit
  21++927A
  22++927A              opmwaittimer100hz
  23++927A              .counter=$+1
  24++927A 3E 00        	ld a,0
  25++927C 3D           	dec a
  26++927D 20 02        	jr nz,$+4
  27++927F 3E 02        	ld a,2
  28++9281 32 7B 92     	ld (.counter),a
  29++9284 C8           	ret z
  30++9285              	;YIELD
  31++9285              	OS_WAIT
  31++9285 DF          >	rst #18
  32++9286 C9           	ret
  33++9287
# file closed: GPlay/vgm/opm.asm
  80++9287              	include "vgm/ssg.asm"
# file opened: GPlay/vgm/ssg.asm
   1++9287              SSG_REG = 0xfffd
   2++9287              SSG_DAT = 0xbffd
   3++9287
   4++9287              	macro ssg_write_reg chip_n
   5++9287 ~            ;e = register
   6++9287 ~            ;d = value
   7++9287 ~            	ld bc,SSG_REG
   8++9287 ~            	ld a,chip_n+%11111110
   9++9287 ~            	out (c),a
  10++9287 ~            	out (c),e
  11++9287 ~            	ld bc,SSG_DAT
  12++9287 ~            	out (c),d
  13++9287              	endm
  14++9287
  15++9287              ssgwritemusiconlychip0
  16++9287 7B           	ld a,e
  17++9288 FE 0E        	cp 0x0e
  18++928A D0           	ret nc
  19++928B              ssgwrite0
  20++928B              ;e = register
  21++928B              ;d = value
  22++928B              	ssg_write_reg 0
  22++928B             >;e = register
  22++928B             >;d = value
  22++928B 01 FD FF    >	ld bc,SSG_REG
  22++928E 3E FE       >	ld a,0+%11111110
  22++9290 ED 79       >	out (c),a
  22++9292 ED 59       >	out (c),e
  22++9294 01 FD BF    >	ld bc,SSG_DAT
  22++9297 ED 51       >	out (c),d
  23++9299 C9           	ret
  24++929A
  25++929A              ssgwritemusiconlychip1
  26++929A 7B           	ld a,e
  27++929B FE 0E        	cp 0x0e
  28++929D D0           	ret nc
  29++929E              ssgwrite1
  30++929E              ;e = register
  31++929E              ;d = value
  32++929E              	ssg_write_reg 1
  32++929E             >;e = register
  32++929E             >;d = value
  32++929E 01 FD FF    >	ld bc,SSG_REG
  32++92A1 3E FF       >	ld a,1+%11111110
  32++92A3 ED 79       >	out (c),a
  32++92A5 ED 59       >	out (c),e
  32++92A7 01 FD BF    >	ld bc,SSG_DAT
  32++92AA ED 51       >	out (c),d
  33++92AC C9           	ret
  34++92AD
  35++92AD              ssginit
  36++92AD C9           	ret
  37++92AE
  38++92AE              	macro ssg_write_regs
  39++92AE ~            ;e = base register
  40++92AE ~            ;d = value
  41++92AE ~            ;l = count
  42++92AE ~            .loop
  43++92AE ~            	call ssgwrite0
  44++92AE ~            	call ssgwrite1
  45++92AE ~            	inc e
  46++92AE ~            	dec l
  47++92AE ~            	jr nz,.loop
  48++92AE              	endm
  49++92AE
  50++92AE              ssgmute
  51++92AE 2E 03        	ld l,3
  52++92B0 11 08 00     	ld de,8
  53++92B3              	ssg_write_regs
  53++92B3             >;e = base register
  53++92B3             >;d = value
  53++92B3             >;l = count
  53++92B3             >.loop
  53++92B3 CD 8B 92    >	call ssgwrite0
  53++92B6 CD 9E 92    >	call ssgwrite1
  53++92B9 1C          >	inc e
  53++92BA 2D          >	dec l
  53++92BB 20 F6       >	jr nz,.loop
  54++92BD 2E 0E        	ld l,14
  55++92BF 11 00 00     	ld de,0
  56++92C2              	ssg_write_regs
  56++92C2             >;e = base register
  56++92C2             >;d = value
  56++92C2             >;l = count
  56++92C2             >.loop
  56++92C2 CD 8B 92    >	call ssgwrite0
  56++92C5 CD 9E 92    >	call ssgwrite1
  56++92C8 1C          >	inc e
  56++92C9 2D          >	dec l
  56++92CA 20 F6       >	jr nz,.loop
  57++92CC C9           	ret
  58++92CD
# file closed: GPlay/vgm/ssg.asm
  81++92CD
  82++92CD
  83++92CD
  84++92CD
  85++92CD
  86++92CD
  87++92CD              waittimer50hz
  88++92CD              	;YIELD
  89++92CD              	OS_WAIT
  89++92CD DF          >	rst #18
  90++92CE C9           	ret
  91++92CF
  92++92CF
  93++92CF              waveheaderbuffer = 0xc000-2048 ;0x5400 ;текущий размер буфера 1536 (128*12)
  94++92CF              waveheaderbufferend = waveheaderbuffer+WAVEHEADERBUFFERSIZE
  95++92CF              vgmheadercopy = waveheaderbufferend
  96++92CF              vgmheadercopyend = vgmheadercopy+HEADER_SIZE_MAX ;(ещё 256)
  97++92CF
  98++92CF              titlestr = waveheaderbufferend
  99++92CF              titlestrend = titlestr+TITLELENGTH
 100++92CF
 101++92CF
 102++92CF              HEADER_CLOCK_YM2203 = vgmheadercopy+0x44
 103++92CF              HEADER_CLOCK_YM3812 = vgmheadercopy+0x50
 104++92CF              HEADER_CLOCK_YMF262 = vgmheadercopy+0x5c
 105++92CF              HEADER_CLOCK_YMF278B = vgmheadercopy+0x60
 106++92CF              HEADER_CLOCK_AY8910 = vgmheadercopy+0x74
 107++92CF
 108++92CF
 109++92CF              	macro a_or_dw addr
 110++92CF ~            	ld hl,(addr+0)
 111++92CF ~            	or h
 112++92CF ~            	or l
 113++92CF ~            	ld de,(addr+2)
 114++92CF ~            	or d
 115++92CF ~            	or e
 116++92CF              	endm
 117++92CF
 118++92CF              	macro set_timer wait,ticks
 119++92CF ~            	ld hl,ticks
 120++92CF ~            	ld (waittimerstep),hl
 121++92CF              	endm
 122++92CF
 123++92CF
 124++92CF              init_:
 125++92CF              	set_timer waittimer50hz,882
 125++92CF 21 72 03    >	ld hl,882
 125++92D2 22 86 93    >	ld (waittimerstep),hl
 126++92D5 21 00 00     	ld hl,0
 127++92D8 22 81 93     	ld (waitcounterlo),hl
 128++92DB AF           	xor a
 129++92DC 32 84 93     	ld (waitcounterhi),a
 130++92DF 32 66 93     	ld (devicemask),a
 131++92E2
 132++92E2 32 7A 93           	ld (vgm_play_var),a
 133++92E5              ;map header to 0x8000
 134++92E5                      ;first page (vgm_header) now in page_plr3
 135++92E5                      ;now do init.
 136++92E5
 137++92E5              ;copy header
 138++92E5 01 00 01     	ld bc,HEADER_SIZE_MAX
 139++92E8 21 00 BE     	ld hl,vgmheadercopy
 140++92EB 11 01 BE     	ld de,vgmheadercopy+1
 141++92EE 36 00        	ld (hl),0
 142++92F0 ED B0        	ldir
 143++92F2 2A 34 C0     	ld hl,(HEADER_DATA_OFFSET)  ;если HEADER_DATA_OFFSET == 0 to bc = 0x0040 иначе  bc = 0x0034
 144++92F5 7C           	ld a,h
 145++92F6 B5           	or l
 146++92F7 01 40 00     	ld bc,0x40
 147++92FA 28 02        	jr z,$+4
 148++92FC 0E 34        	ld c,0x34
 149++92FE 09           	add hl,bc
 150++92FF 22 5D 93     	ld (.dataoffset),hl
 151++9302                            ;определяем сколько данных заголовка vgm нужно перекинуть в буфер исходя из значения HEADER_DATA_OFFSET
 152++9302 44 4D        	ld bc,hl
 153++9304 21 FF FE     	ld hl,-HEADER_SIZE_MAX-1
 154++9307 09           	add hl,bc
 155++9308 30 03        	jr nc,$+5
 156++930A 01 00 01     	ld bc,HEADER_SIZE_MAX
 157++930D
 158++930D 21 00 C0     	ld hl,module
 159++9310 11 00 BE     	ld de,vgmheadercopy
 160++9313 ED B0        	ldir
 161++9315              ;setup loop
 162++9315 AF           	xor a
 163++9316              	a_or_dw HEADER_LOOP_OFFSET
 163++9316 2A 1C C0    >	ld hl,(HEADER_LOOP_OFFSET+0)
 163++9319 B4          >	or h
 163++931A B5          >	or l
 163++931B ED 5B 1E C0 >	ld de,(HEADER_LOOP_OFFSET+2)
 163++931F B2          >	or d
 163++9320 B3          >	or e
 164++9321 22 84 95     	ld (loopoffsetlo),hl
 165++9324 ED 53 81 95  	ld (loopoffsethi),de
 166++9328              ;init Moonsound
 167++9328 AF           	xor a
 168++9329              	a_or_dw HEADER_CLOCK_YM3812
 168++9329 2A 50 BE    >	ld hl,(HEADER_CLOCK_YM3812+0)
 168++932C B4          >	or h
 168++932D B5          >	or l
 168++932E ED 5B 52 BE >	ld de,(HEADER_CLOCK_YM3812+2)
 168++9332 B2          >	or d
 168++9333 B3          >	or e
 169++9334 32 E2 97     	ld (useYM3812),a
 170++9337              	a_or_dw HEADER_CLOCK_YMF262
 170++9337 2A 5C BE    >	ld hl,(HEADER_CLOCK_YMF262+0)
 170++933A B4          >	or h
 170++933B B5          >	or l
 170++933C ED 5B 5E BE >	ld de,(HEADER_CLOCK_YMF262+2)
 170++9340 B2          >	or d
 170++9341 B3          >	or e
 171++9342 20 14        	jr nz,.opl4notneeded
 172++9344              	a_or_dw HEADER_CLOCK_YMF278B
 172++9344 2A 60 BE    >	ld hl,(HEADER_CLOCK_YMF278B+0)
 172++9347 B4          >	or h
 172++9348 B5          >	or l
 172++9349 ED 5B 62 BE >	ld de,(HEADER_CLOCK_YMF278B+2)
 172++934D B2          >	or d
 172++934E B3          >	or e
 173++934F 28 07        	jr z,.opl4notneeded
 174++9351 3A D4 97     	ld a,(moonsoundstatus)
 175++9354 FE 02        	cp 2
 176++9356 C0           	ret nz ;jp nz,memorystreamfree ;sets zf=0
 177++9357 B7           	or a
 178++9358              .opl4notneeded
 179++9358 C4 D3 97     	call nz,initYMF278B
 180++935B C0           	ret nz  ;jp nz,memorystreamfree ;sets zf=0
 181++935C              .dataoffset=$+1
 182++935C 21 00 00     	ld hl,0
 183++935F 11 00 00     	ld de,0
 184++9362                      ;init music
 185++9362 CD C8 8D     	call memorystreamseek
 186++9365              devicemask=$+1
 187++9365 3E 00        	ld a,0
 188++9367              ;zf=0 if there isn't any supported device
 189++9367 3D           	dec a
 190++9368 F8           	ret m
 191++9369 3C           	inc a
 192++936A BF           	cp a
 193++936B C9           	ret
 194++936C
 195++936C
 196++936C
 197++936C
 198++936C
 199++936C
 200++936C
 201++936C
 202++936C              MUTE:
 203++936C 3E C9                        ld a,$C9			;ret	;stop playing
 204++936E 32 7A 93                     ld (vgm_play_var),a
 205++9371 3A 66 93     		ld a,(devicemask)
 206++9374 E6 08        		and DEVICE_MOONSOUND_MASK
 207++9376 C4 D6 8E     		call nz,opl4mute
 208++9379 C9                           ret
 209++937A
 210++937A
 211++937A
 212++937A
 213++937A
 214++937A
 215++937A
 216++937A              PLAY:
 217++937A              ;out: zf=0 if still playing, zf=1 otherwise
 218++937A              ;waittimercallback=$+1
 219++937A              ;	call 0
 220++937A
 221++937A              vgm_play_var = $
 221++937A 00             nop		;nop - play
 222++937B 3E 00                ld a,0                          ;(memorystreamcurrentpage)
 223++937D              memorystreamcurrentpage equ $-1
 224++937D                      IF AREA_C000_FFFF=1
 225++937D                          ;SETPGC000
 226++937D              			OS_SET_PAGE_SLOT3
 226++937D 0E 1C       >    ld c,#1c
 226++937F E7          >    rst #20
 227++9380                      ELSE
 228++9380 ~                        SETPG8000
 229++9380                      ENDIF
 230++9380              playloop
 231++9380              waitcounterlo=$+1
 232++9380 21 00 00     	ld hl,0
 233++9383              waitcounterhi=$+1
 234++9383 3E 00        	ld a,0
 235++9385              waittimerstep=$+1
 236++9385 01 00 00     	ld bc,0
 237++9388 B7 ED 42     	sub hl,bc
 238++938B 16 00        	ld d,0
 239++938D 9A           	sbc a,d
 240++938E 30 1A        	jr nc,exitplayloop
 241++9390              ;read command
 242++9390              	memory_stream_read_1 e
 242++9390 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 242++9393             >	memory_stream_read_byte e
 242++9393 CB 74       >	bit 6,h
 242++9395             >        IF AREA_C000_FFFF=1
 242++9395 CC 0D 8D    >	call z,memorystreamnextpage
 242++9398             >        ELSE
 242++9398 ~           > 	call nz,memorystreamnextpage
 242++9398             >        ENDIF
 242++9398 5E          >	ld e,(hl)
 242++9399 23          >	inc hl
 242++939A 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 243++939D 21 8E 95     	ld hl,cmdtable
 244++93A0 19           	add hl,de
 245++93A1 5E           	ld e,(hl)
 246++93A2 24           	inc h
 247++93A3 56           	ld d,(hl)
 248++93A4 21 80 93     	ld hl,playloop
 249++93A7 E5           	push hl
 250++93A8 EB           	ex hl,de
 251++93A9 E9           	jp (hl)
 252++93AA
 253++93AA              exitplayloop
 254++93AA 22 81 93     	ld (waitcounterlo),hl
 255++93AD 32 84 93     	ld (waitcounterhi),a
 256++93B0              ;continue playing
 257++93B0 F6 01        	or 1
 258++93B2 C9           	ret
 259++93B3
 260++93B3 21 81 93     wait1	ld hl,waitcounterlo
 261++93B6 34           	inc (hl)
 262++93B7 C0           	ret nz
 263++93B8 23           	inc hl
 264++93B9 34           	inc (hl)
 265++93BA C0           	ret nz
 266++93BB 21 84 93     	ld hl,waitcounterhi
 267++93BE 34           	inc (hl)
 268++93BF C9           	ret
 269++93C0
 270++93C0 3E 02        wait2	ld a,2
 271++93C2 21 81 93     waitn	ld hl,waitcounterlo
 272++93C5 86           	add a,(hl)
 273++93C6 77           	ld (hl),a
 274++93C7 D0           	ret nc
 275++93C8 23           	inc hl
 276++93C9 34           	inc (hl)
 277++93CA C0           	ret nz
 278++93CB 21 84 93     	ld hl,waitcounterhi
 279++93CE 34           	inc (hl)
 280++93CF C9           	ret
 281++93D0
 282++93D0 3E 03        wait3	ld a,3
 282++93D2 C3 C2 93       jp waitn
 283++93D5 3E 04        wait4	ld a,4
 283++93D7 C3 C2 93       jp waitn
 284++93DA 3E 05        wait5	ld a,5
 284++93DC C3 C2 93       jp waitn
 285++93DF 3E 06        wait6	ld a,6
 285++93E1 C3 C2 93       jp waitn
 286++93E4 3E 07        wait7	ld a,7
 286++93E6 C3 C2 93       jp waitn
 287++93E9 3E 08        wait8	ld a,8
 287++93EB C3 C2 93       jp waitn
 288++93EE 3E 09        wait9	ld a,9
 288++93F0 C3 C2 93       jp waitn
 289++93F3 3E 0A        wait10	ld a,10
 289++93F5 C3 C2 93       jp waitn
 290++93F8 3E 0B        wait11	ld a,11
 290++93FA C3 C2 93       jp waitn
 291++93FD 3E 0C        wait12	ld a,12
 291++93FF C3 C2 93       jp waitn
 292++9402 3E 0D        wait13	ld a,13
 292++9404 C3 C2 93       jp waitn
 293++9407 3E 0E        wait14	ld a,14
 293++9409 C3 C2 93       jp waitn
 294++940C 3E 0F        wait15	ld a,15
 294++940E C3 C2 93       jp waitn
 295++9411 3E 10        wait16	ld a,16
 295++9413 C3 C2 93       jp waitn
 296++9416
 297++9416 11 DF 02     wait735	ld de,735
 298++9419 2A 81 93     waitnn	ld hl,(waitcounterlo)
 299++941C 19           	add hl,de
 300++941D 22 81 93     	ld (waitcounterlo),hl
 301++9420 D0           	ret nc
 302++9421 21 84 93     	ld hl,waitcounterhi
 303++9424 34           	inc (hl)
 304++9425 C9           	ret
 305++9426
 306++9426 11 72 03     wait882	ld de,882
 307++9429 C3 19 94     	jp waitnn
 308++942C
 309++942C              waitvar	memory_stream_read_2 e,d
 309++942C 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 309++942F             >	memory_stream_read_byte e
 309++942F CB 74       >	bit 6,h
 309++9431             >        IF AREA_C000_FFFF=1
 309++9431 CC 0D 8D    >	call z,memorystreamnextpage
 309++9434             >        ELSE
 309++9434 ~           > 	call nz,memorystreamnextpage
 309++9434             >        ENDIF
 309++9434 5E          >	ld e,(hl)
 309++9435 23          >	inc hl
 309++9436             >	memory_stream_read_byte d
 309++9436 CB 74       >	bit 6,h
 309++9438             >        IF AREA_C000_FFFF=1
 309++9438 CC 0D 8D    >	call z,memorystreamnextpage
 309++943B             >        ELSE
 309++943B ~           > 	call nz,memorystreamnextpage
 309++943B             >        ENDIF
 309++943B 56          >	ld d,(hl)
 309++943C 23          >	inc hl
 309++943D 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 310++9440 2A 81 93     	ld hl,(waitcounterlo)
 311++9443 19           	add hl,de
 312++9444 22 81 93     	ld (waitcounterlo),hl
 313++9447 D0           	ret nc
 314++9448 21 84 93     	ld hl,waitcounterhi
 315++944B 34           	inc (hl)
 316++944C C9           	ret
 317++944D
 318++944D              	macro skip_n n
 319++944D ~            	ld b,n
 320++944D ~            	jp memorystreamskip
 321++944D              	endm
 322++944D
 323++944D C9           skip1	ret
 324++944E              skip2	skip_n 1
 324++944E 06 01       >	ld b,1
 324++9450 C3 23 8D    >	jp memorystreamskip
 325++9453              skip3	skip_n 2
 325++9453 06 02       >	ld b,2
 325++9455 C3 23 8D    >	jp memorystreamskip
 326++9458              skip4	skip_n 3
 326++9458 06 03       >	ld b,3
 326++945A C3 23 8D    >	jp memorystreamskip
 327++945D              skip5	skip_n 4
 327++945D 06 04       >	ld b,4
 327++945F C3 23 8D    >	jp memorystreamskip
 328++9462              skip6	skip_n 5
 328++9462 06 05       >	ld b,5
 328++9464 C3 23 8D    >	jp memorystreamskip
 329++9467              skip11	skip_n 10
 329++9467 06 0A       >	ld b,10
 329++9469 C3 23 8D    >	jp memorystreamskip
 330++946C              skip12	skip_n 11
 330++946C 06 0B       >	ld b,11
 330++946E C3 23 8D    >	jp memorystreamskip
 331++9471
 332++9471
 333++9471              endofsounddata
 334++9471                    ;  jp seektoloop ;здесь зацикливание, повтор
 335++9471 CD D7 8B     	  call PLR_MUTE ;выключить звук
 336++9474              cmdunsupported
 337++9474              ;stop playing
 338++9474 F1           	pop af
 339++9475 AF           	xor a
 340++9476 C9           	ret
 341++9477
 342++9477              cmdYM2203
 343++9477              	memory_stream_read_2 e,d
 343++9477 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 343++947A             >	memory_stream_read_byte e
 343++947A CB 74       >	bit 6,h
 343++947C             >        IF AREA_C000_FFFF=1
 343++947C CC 0D 8D    >	call z,memorystreamnextpage
 343++947F             >        ELSE
 343++947F ~           > 	call nz,memorystreamnextpage
 343++947F             >        ENDIF
 343++947F 5E          >	ld e,(hl)
 343++9480 23          >	inc hl
 343++9481             >	memory_stream_read_byte d
 343++9481 CB 74       >	bit 6,h
 343++9483             >        IF AREA_C000_FFFF=1
 343++9483 CC 0D 8D    >	call z,memorystreamnextpage
 343++9486             >        ELSE
 343++9486 ~           > 	call nz,memorystreamnextpage
 343++9486             >        ENDIF
 343++9486 56          >	ld d,(hl)
 343++9487 23          >	inc hl
 343++9488 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 344++948B C3 25 92     	jp opnwritemusiconlyfm1
 345++948E
 346++948E              cmdYM2203dp
 347++948E              	memory_stream_read_2 e,d
 347++948E 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 347++9491             >	memory_stream_read_byte e
 347++9491 CB 74       >	bit 6,h
 347++9493             >        IF AREA_C000_FFFF=1
 347++9493 CC 0D 8D    >	call z,memorystreamnextpage
 347++9496             >        ELSE
 347++9496 ~           > 	call nz,memorystreamnextpage
 347++9496             >        ENDIF
 347++9496 5E          >	ld e,(hl)
 347++9497 23          >	inc hl
 347++9498             >	memory_stream_read_byte d
 347++9498 CB 74       >	bit 6,h
 347++949A             >        IF AREA_C000_FFFF=1
 347++949A CC 0D 8D    >	call z,memorystreamnextpage
 347++949D             >        ELSE
 347++949D ~           > 	call nz,memorystreamnextpage
 347++949D             >        ENDIF
 347++949D 56          >	ld d,(hl)
 347++949E 23          >	inc hl
 347++949F 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 348++94A2 C3 39 92     	jp opnwritemusiconlyfm2
 349++94A5
 350++94A5              cmdYMF278B
 351++94A5              	memory_stream_read_3 c,e,d
 351++94A5 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 351++94A8             >	memory_stream_read_byte c
 351++94A8 CB 74       >	bit 6,h
 351++94AA             >        IF AREA_C000_FFFF=1
 351++94AA CC 0D 8D    >	call z,memorystreamnextpage
 351++94AD             >        ELSE
 351++94AD ~           > 	call nz,memorystreamnextpage
 351++94AD             >        ENDIF
 351++94AD 4E          >	ld c,(hl)
 351++94AE 23          >	inc hl
 351++94AF             >	memory_stream_read_byte e
 351++94AF CB 74       >	bit 6,h
 351++94B1             >        IF AREA_C000_FFFF=1
 351++94B1 CC 0D 8D    >	call z,memorystreamnextpage
 351++94B4             >        ELSE
 351++94B4 ~           > 	call nz,memorystreamnextpage
 351++94B4             >        ENDIF
 351++94B4 5E          >	ld e,(hl)
 351++94B5 23          >	inc hl
 351++94B6             >	memory_stream_read_byte d
 351++94B6 CB 74       >	bit 6,h
 351++94B8             >        IF AREA_C000_FFFF=1
 351++94B8 CC 0D 8D    >	call z,memorystreamnextpage
 351++94BB             >        ELSE
 351++94BB ~           > 	call nz,memorystreamnextpage
 351++94BB             >        ENDIF
 351++94BB 56          >	ld d,(hl)
 351++94BC 23          >	inc hl
 351++94BD 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 352++94C0 0D           	dec c
 353++94C1 CA 3D 90     	jp z,opl4writemusiconlyfm2
 354++94C4 F2 47 90     	jp p,opl4writewavemusiconly
 355++94C7 C3 31 90     	jp opl4writemusiconlyfm1
 356++94CA
 357++94CA              cmdYMF262p0
 358++94CA              cmdYM3812
 359++94CA              cmdY8950
 360++94CA              cmdYM3526
 361++94CA              	memory_stream_read_2 e,d
 361++94CA 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 361++94CD             >	memory_stream_read_byte e
 361++94CD CB 74       >	bit 6,h
 361++94CF             >        IF AREA_C000_FFFF=1
 361++94CF CC 0D 8D    >	call z,memorystreamnextpage
 361++94D2             >        ELSE
 361++94D2 ~           > 	call nz,memorystreamnextpage
 361++94D2             >        ENDIF
 361++94D2 5E          >	ld e,(hl)
 361++94D3 23          >	inc hl
 361++94D4             >	memory_stream_read_byte d
 361++94D4 CB 74       >	bit 6,h
 361++94D6             >        IF AREA_C000_FFFF=1
 361++94D6 CC 0D 8D    >	call z,memorystreamnextpage
 361++94D9             >        ELSE
 361++94D9 ~           > 	call nz,memorystreamnextpage
 361++94D9             >        ENDIF
 361++94D9 56          >	ld d,(hl)
 361++94DA 23          >	inc hl
 361++94DB 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 362++94DE C3 31 90     	jp opl4writemusiconlyfm1
 363++94E1
 364++94E1              cmdYMF262p1
 365++94E1              cmdYM3812dp
 366++94E1              cmdY8950dp
 367++94E1              cmdYM3526dp
 368++94E1              	memory_stream_read_2 e,d
 368++94E1 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 368++94E4             >	memory_stream_read_byte e
 368++94E4 CB 74       >	bit 6,h
 368++94E6             >        IF AREA_C000_FFFF=1
 368++94E6 CC 0D 8D    >	call z,memorystreamnextpage
 368++94E9             >        ELSE
 368++94E9 ~           > 	call nz,memorystreamnextpage
 368++94E9             >        ENDIF
 368++94E9 5E          >	ld e,(hl)
 368++94EA 23          >	inc hl
 368++94EB             >	memory_stream_read_byte d
 368++94EB CB 74       >	bit 6,h
 368++94ED             >        IF AREA_C000_FFFF=1
 368++94ED CC 0D 8D    >	call z,memorystreamnextpage
 368++94F0             >        ELSE
 368++94F0 ~           > 	call nz,memorystreamnextpage
 368++94F0             >        ENDIF
 368++94F0 56          >	ld d,(hl)
 368++94F1 23          >	inc hl
 368++94F2 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 369++94F5 C3 3D 90     	jp opl4writemusiconlyfm2
 370++94F8
 371++94F8              cmdYM2151
 372++94F8              	memory_stream_read_2 e,d
 372++94F8 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 372++94FB             >	memory_stream_read_byte e
 372++94FB CB 74       >	bit 6,h
 372++94FD             >        IF AREA_C000_FFFF=1
 372++94FD CC 0D 8D    >	call z,memorystreamnextpage
 372++9500             >        ELSE
 372++9500 ~           > 	call nz,memorystreamnextpage
 372++9500             >        ENDIF
 372++9500 5E          >	ld e,(hl)
 372++9501 23          >	inc hl
 372++9502             >	memory_stream_read_byte d
 372++9502 CB 74       >	bit 6,h
 372++9504             >        IF AREA_C000_FFFF=1
 372++9504 CC 0D 8D    >	call z,memorystreamnextpage
 372++9507             >        ELSE
 372++9507 ~           > 	call nz,memorystreamnextpage
 372++9507             >        ENDIF
 372++9507 56          >	ld d,(hl)
 372++9508 23          >	inc hl
 372++9509 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 373++950C C3 64 92     	jp opmwritemusiconlychip0
 374++950F
 375++950F              cmdYM2151dp
 376++950F              	memory_stream_read_2 e,d
 376++950F 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 376++9512             >	memory_stream_read_byte e
 376++9512 CB 74       >	bit 6,h
 376++9514             >        IF AREA_C000_FFFF=1
 376++9514 CC 0D 8D    >	call z,memorystreamnextpage
 376++9517             >        ELSE
 376++9517 ~           > 	call nz,memorystreamnextpage
 376++9517             >        ENDIF
 376++9517 5E          >	ld e,(hl)
 376++9518 23          >	inc hl
 376++9519             >	memory_stream_read_byte d
 376++9519 CB 74       >	bit 6,h
 376++951B             >        IF AREA_C000_FFFF=1
 376++951B CC 0D 8D    >	call z,memorystreamnextpage
 376++951E             >        ELSE
 376++951E ~           > 	call nz,memorystreamnextpage
 376++951E             >        ENDIF
 376++951E 56          >	ld d,(hl)
 376++951F 23          >	inc hl
 376++9520 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 377++9523 C3 6B 92     	jp opmwritemusiconlychip1
 378++9526
 379++9526              cmdAY8910
 380++9526              	memory_stream_read_2 e,d
 380++9526 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 380++9529             >	memory_stream_read_byte e
 380++9529 CB 74       >	bit 6,h
 380++952B             >        IF AREA_C000_FFFF=1
 380++952B CC 0D 8D    >	call z,memorystreamnextpage
 380++952E             >        ELSE
 380++952E ~           > 	call nz,memorystreamnextpage
 380++952E             >        ENDIF
 380++952E 5E          >	ld e,(hl)
 380++952F 23          >	inc hl
 380++9530             >	memory_stream_read_byte d
 380++9530 CB 74       >	bit 6,h
 380++9532             >        IF AREA_C000_FFFF=1
 380++9532 CC 0D 8D    >	call z,memorystreamnextpage
 380++9535             >        ELSE
 380++9535 ~           > 	call nz,memorystreamnextpage
 380++9535             >        ENDIF
 380++9535 56          >	ld d,(hl)
 380++9536 23          >	inc hl
 380++9537 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 381++953A CB 7B        	bit 7,e
 382++953C CA 87 92     	jp z,ssgwritemusiconlychip0
 383++953F CB BB        	res 7,e
 384++9541 C3 9A 92     	jp ssgwritemusiconlychip1
 385++9544
 386++9544              cmdYMF262dp0 equ memorystreamread2
 387++9544              cmdYMF262dp1 equ memorystreamread2
 388++9544
 389++9544              cmddatablock
 390++9544              	memory_stream_read_2 a,e ;a = 0x66 guard, e = type
 390++9544 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 390++9547             >	memory_stream_read_byte a
 390++9547 CB 74       >	bit 6,h
 390++9549             >        IF AREA_C000_FFFF=1
 390++9549 CC 0D 8D    >	call z,memorystreamnextpage
 390++954C             >        ELSE
 390++954C ~           > 	call nz,memorystreamnextpage
 390++954C             >        ENDIF
 390++954C 7E          >	ld a,(hl)
 390++954D 23          >	inc hl
 390++954E             >	memory_stream_read_byte e
 390++954E CB 74       >	bit 6,h
 390++9550             >        IF AREA_C000_FFFF=1
 390++9550 CC 0D 8D    >	call z,memorystreamnextpage
 390++9553             >        ELSE
 390++9553 ~           > 	call nz,memorystreamnextpage
 390++9553             >        ENDIF
 390++9553 5E          >	ld e,(hl)
 390++9554 23          >	inc hl
 390++9555 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 391++9558 FE 66        	cp 0x66
 392++955A C2 74 94     	jp nz,cmdunsupported
 393++955D              processdatablock
 394++955D              ;e = data type
 395++955D CD 71 8D     	call memorystreamread4 ;adbc = data size
 396++9560 7B           	ld a,e
 397++9561 60 69        	ld hl,bc
 398++9563              ;	cp 0x81
 399++9563              ;	jp z,opnaloaddatablock
 400++9563 FE 84        	cp 0x84
 401++9565 CA 27 91     	jp z,opl4loadromdatablock
 402++9568 FE 87        	cp 0x87
 403++956A CA 20 91     	jp z,opl4loadramdatablock
 404++956D D5           	push de
 405++956E C5           	push bc
 406++956F CD ED 8D     	call memorystreamgetpos
 407++9572 C1           	pop bc
 408++9573 F1           	pop af
 409++9574 09           	add hl,bc
 410++9575 8B           	adc a,e
 411++9576 5F           	ld e,a
 412++9577 8A           	adc a,d
 413++9578 93           	sub e
 414++9579 57           	ld d,a
 415++957A C3 C8 8D     	jp memorystreamseek
 416++957D
 417++957D
 418++957D              seektoloop
 419++957D 01 1C 00     	ld bc,0x1c
 420++9580              loopoffsethi=$+1
 421++9580 11 00 00     	ld de,0
 422++9583              loopoffsetlo=$+1
 423++9583 21 00 00     	ld hl,0
 424++9586              seektopos
 425++9586              ;dehl + bc = position
 426++9586              ;out: hl = read address
 427++9586 09           	add hl,bc
 428++9587 D2 C8 8D     	jp nc,memorystreamseek
 429++958A 13           	inc de
 430++958B C3 C8 8D     	jp memorystreamseek
 431++958E
 432++958E
 433++958E
 434++958E
 435++958E              cmdtable
 436++958E 4D           	db skip1           %256 ; 00
 437++958F 4D           	db skip1           %256 ; 01
 438++9590 4D           	db skip1           %256 ; 02
 439++9591 4D           	db skip1           %256 ; 03
 440++9592 4D           	db skip1           %256 ; 04
 441++9593 4D           	db skip1           %256 ; 05
 442++9594 4D           	db skip1           %256 ; 06
 443++9595 4D           	db skip1           %256 ; 07
 444++9596 4D           	db skip1           %256 ; 08
 445++9597 4D           	db skip1           %256 ; 09
 446++9598 4D           	db skip1           %256 ; 0A
 447++9599 4D           	db skip1           %256 ; 0B
 448++959A 4D           	db skip1           %256 ; 0C
 449++959B 4D           	db skip1           %256 ; 0D
 450++959C 4D           	db skip1           %256 ; 0E
 451++959D 4D           	db skip1           %256 ; 0F
 452++959E 4D           	db skip1           %256 ; 10
 453++959F 4D           	db skip1           %256 ; 11
 454++95A0 4D           	db skip1           %256 ; 12
 455++95A1 4D           	db skip1           %256 ; 13
 456++95A2 4D           	db skip1           %256 ; 14
 457++95A3 4D           	db skip1           %256 ; 15
 458++95A4 4D           	db skip1           %256 ; 16
 459++95A5 4D           	db skip1           %256 ; 17
 460++95A6 4D           	db skip1           %256 ; 18
 461++95A7 4D           	db skip1           %256 ; 19
 462++95A8 4D           	db skip1           %256 ; 1A
 463++95A9 4D           	db skip1           %256 ; 1B
 464++95AA 4D           	db skip1           %256 ; 1C
 465++95AB 4D           	db skip1           %256 ; 1D
 466++95AC 4D           	db skip1           %256 ; 1E
 467++95AD 4D           	db skip1           %256 ; 1F
 468++95AE 4D           	db skip1           %256 ; 20
 469++95AF 4D           	db skip1           %256 ; 21
 470++95B0 4D           	db skip1           %256 ; 22
 471++95B1 4D           	db skip1           %256 ; 23
 472++95B2 4D           	db skip1           %256 ; 24
 473++95B3 4D           	db skip1           %256 ; 25
 474++95B4 4D           	db skip1           %256 ; 26
 475++95B5 4D           	db skip1           %256 ; 27
 476++95B6 4D           	db skip1           %256 ; 28
 477++95B7 4D           	db skip1           %256 ; 29
 478++95B8 4D           	db skip1           %256 ; 2A
 479++95B9 4D           	db skip1           %256 ; 2B
 480++95BA 4D           	db skip1           %256 ; 2C
 481++95BB 4D           	db skip1           %256 ; 2D
 482++95BC 4D           	db skip1           %256 ; 2E
 483++95BD 4D           	db skip1           %256 ; 2F
 484++95BE 74           	db cmdunsupported  %256 ; 30
 485++95BF 4E           	db skip2           %256 ; 31
 486++95C0 4E           	db skip2           %256 ; 32
 487++95C1 4E           	db skip2           %256 ; 33
 488++95C2 4E           	db skip2           %256 ; 34
 489++95C3 4E           	db skip2           %256 ; 35
 490++95C4 4E           	db skip2           %256 ; 36
 491++95C5 4E           	db skip2           %256 ; 37
 492++95C6 4E           	db skip2           %256 ; 38
 493++95C7 4E           	db skip2           %256 ; 39
 494++95C8 4E           	db skip2           %256 ; 3A
 495++95C9 4E           	db skip2           %256 ; 3B
 496++95CA 4E           	db skip2           %256 ; 3C
 497++95CB 4E           	db skip2           %256 ; 3D
 498++95CC 4E           	db skip2           %256 ; 3E
 499++95CD 4E           	db skip2           %256 ; 3F
 500++95CE 53           	db skip3           %256 ; 40
 501++95CF 53           	db skip3           %256 ; 41
 502++95D0 53           	db skip3           %256 ; 42
 503++95D1 53           	db skip3           %256 ; 43
 504++95D2 53           	db skip3           %256 ; 44
 505++95D3 53           	db skip3           %256 ; 45
 506++95D4 53           	db skip3           %256 ; 46
 507++95D5 53           	db skip3           %256 ; 47
 508++95D6 53           	db skip3           %256 ; 48
 509++95D7 53           	db skip3           %256 ; 49
 510++95D8 53           	db skip3           %256 ; 4A
 511++95D9 53           	db skip3           %256 ; 4B
 512++95DA 53           	db skip3           %256 ; 4C
 513++95DB 53           	db skip3           %256 ; 4D
 514++95DC 53           	db skip3           %256 ; 4E
 515++95DD 4E           	db skip2           %256 ; 4F
 516++95DE 74           	db cmdunsupported  %256 ; 50
 517++95DF 74           	db cmdunsupported  %256 ; 51
 518++95E0 74           	db cmdunsupported  %256 ; 52
 519++95E1 74           	db cmdunsupported  %256 ; 53
 520++95E2 F8           	db cmdYM2151       %256 ; 54
 521++95E3 77           	db cmdYM2203       %256 ; 55
 522++95E4 77           	db cmdYM2608p0     %256 ; 56
 523++95E5 8E           	db cmdYM2608p1     %256 ; 57
 524++95E6 74           	db cmdunsupported  %256 ; 58
 525++95E7 74           	db cmdunsupported  %256 ; 59
 526++95E8 CA           	db cmdYM3812       %256 ; 5A
 527++95E9 CA           	db cmdYM3526       %256 ; 5B
 528++95EA CA           	db cmdY8950        %256 ; 5C
 529++95EB 53           	db skip3           %256 ; 5D
 530++95EC CA           	db cmdYMF262p0     %256 ; 5E
 531++95ED E1           	db cmdYMF262p1     %256 ; 5F
 532++95EE 74           	db cmdunsupported  %256 ; 60
 533++95EF 2C           	db waitvar         %256 ; 61
 534++95F0 16           	db wait735         %256 ; 62
 535++95F1 26           	db wait882         %256 ; 63
 536++95F2 74           	db cmdunsupported  %256 ; 64
 537++95F3 74           	db cmdunsupported  %256 ; 65
 538++95F4 71           	db endofsounddata  %256 ; 66
 539++95F5 44           	db cmddatablock    %256 ; 67
 540++95F6 6C           	db skip12          %256 ; 68
 541++95F7 74           	db cmdunsupported  %256 ; 69
 542++95F8 74           	db cmdunsupported  %256 ; 6A
 543++95F9 74           	db cmdunsupported  %256 ; 6B
 544++95FA 74           	db cmdunsupported  %256 ; 6C
 545++95FB 74           	db cmdunsupported  %256 ; 6D
 546++95FC 74           	db cmdunsupported  %256 ; 6E
 547++95FD 74           	db cmdunsupported  %256 ; 6F
 548++95FE B3           	db wait1           %256 ; 70
 549++95FF C0           	db wait2           %256 ; 71
 550++9600 D0           	db wait3           %256 ; 72
 551++9601 D5           	db wait4           %256 ; 73
 552++9602 DA           	db wait5           %256 ; 74
 553++9603 DF           	db wait6           %256 ; 75
 554++9604 E4           	db wait7           %256 ; 76
 555++9605 E9           	db wait8           %256 ; 77
 556++9606 EE           	db wait9           %256 ; 78
 557++9607 F3           	db wait10          %256 ; 79
 558++9608 F8           	db wait11          %256 ; 7A
 559++9609 FD           	db wait12          %256 ; 7B
 560++960A 02           	db wait13          %256 ; 7C
 561++960B 07           	db wait14          %256 ; 7D
 562++960C 0C           	db wait15          %256 ; 7E
 563++960D 11           	db wait16          %256 ; 7F
 564++960E 4D           	db skip1           %256 ; 80
 565++960F B3           	db wait1           %256 ; 81
 566++9610 C0           	db wait2           %256 ; 82
 567++9611 D0           	db wait3           %256 ; 83
 568++9612 D5           	db wait4           %256 ; 84
 569++9613 DA           	db wait5           %256 ; 85
 570++9614 DF           	db wait6           %256 ; 86
 571++9615 E4           	db wait7           %256 ; 87
 572++9616 E9           	db wait8           %256 ; 88
 573++9617 EE           	db wait9           %256 ; 89
 574++9618 F3           	db wait10          %256 ; 8A
 575++9619 F8           	db wait11          %256 ; 8B
 576++961A FD           	db wait12          %256 ; 8C
 577++961B 02           	db wait13          %256 ; 8D
 578++961C 07           	db wait14          %256 ; 8E
 579++961D 0C           	db wait15          %256 ; 8F
 580++961E 5D           	db skip5           %256 ; 90
 581++961F 5D           	db skip5           %256 ; 91
 582++9620 62           	db skip6           %256 ; 92
 583++9621 67           	db skip11          %256 ; 93
 584++9622 4E           	db skip2           %256 ; 94
 585++9623 5D           	db skip5           %256 ; 95
 586++9624 74           	db cmdunsupported  %256 ; 96
 587++9625 74           	db cmdunsupported  %256 ; 97
 588++9626 74           	db cmdunsupported  %256 ; 98
 589++9627 74           	db cmdunsupported  %256 ; 99
 590++9628 74           	db cmdunsupported  %256 ; 9A
 591++9629 74           	db cmdunsupported  %256 ; 9B
 592++962A 74           	db cmdunsupported  %256 ; 9C
 593++962B 74           	db cmdunsupported  %256 ; 9D
 594++962C 74           	db cmdunsupported  %256 ; 9E
 595++962D 74           	db cmdunsupported  %256 ; 9F
 596++962E 26           	db cmdAY8910       %256 ; A0
 597++962F 53           	db skip3           %256 ; A1
 598++9630 74           	db cmdunsupported  %256 ; A2
 599++9631 74           	db cmdunsupported  %256 ; A3
 600++9632 0F           	db cmdYM2151dp     %256 ; A4
 601++9633 8E           	db cmdYM2203dp     %256 ; A5
 602++9634 53           	db skip3           %256 ; A6
 603++9635 53           	db skip3           %256 ; A7
 604++9636 53           	db skip3           %256 ; A8
 605++9637 53           	db skip3           %256 ; A9
 606++9638 E1           	db cmdYM3812dp     %256 ; AA
 607++9639 E1           	db cmdYM3526dp     %256 ; AB
 608++963A E1           	db cmdY8950dp      %256 ; AC
 609++963B 53           	db skip3           %256 ; AD
 610++963C 40           	db cmdYMF262dp0    %256 ; AE
 611++963D 40           	db cmdYMF262dp0    %256 ; AF
 612++963E 53           	db skip3           %256 ; B0
 613++963F 53           	db skip3           %256 ; B1
 614++9640 53           	db skip3           %256 ; B2
 615++9641 53           	db skip3           %256 ; B3
 616++9642 53           	db skip3           %256 ; B4
 617++9643 53           	db skip3           %256 ; B5
 618++9644 53           	db skip3           %256 ; B6
 619++9645 53           	db skip3           %256 ; B7
 620++9646 53           	db skip3           %256 ; B8
 621++9647 53           	db skip3           %256 ; B9
 622++9648 53           	db skip3           %256 ; BA
 623++9649 53           	db skip3           %256 ; BB
 624++964A 53           	db skip3           %256 ; BC
 625++964B 53           	db skip3           %256 ; BD
 626++964C 53           	db skip3           %256 ; BE
 627++964D 53           	db skip3           %256 ; BF
 628++964E 58           	db skip4           %256 ; C0
 629++964F 58           	db skip4           %256 ; C1
 630++9650 58           	db skip4           %256 ; C2
 631++9651 58           	db skip4           %256 ; C3
 632++9652 58           	db skip4           %256 ; C4
 633++9653 58           	db skip4           %256 ; C5
 634++9654 58           	db skip4           %256 ; C6
 635++9655 58           	db skip4           %256 ; C7
 636++9656 58           	db skip4           %256 ; C8
 637++9657 58           	db skip4           %256 ; C9
 638++9658 58           	db skip4           %256 ; CA
 639++9659 58           	db skip4           %256 ; CB
 640++965A 58           	db skip4           %256 ; CC
 641++965B 58           	db skip4           %256 ; CD
 642++965C 58           	db skip4           %256 ; CE
 643++965D 58           	db skip4           %256 ; CF
 644++965E A5           	db cmdYMF278B      %256 ; D0
 645++965F 58           	db skip4           %256 ; D1
 646++9660 74           	db cmdunsupported  %256 ; D2
 647++9661 58           	db skip4           %256 ; D3
 648++9662 58           	db skip4           %256 ; D4
 649++9663 58           	db skip4           %256 ; D5
 650++9664 58           	db skip4           %256 ; D6
 651++9665 58           	db skip4           %256 ; D7
 652++9666 58           	db skip4           %256 ; D8
 653++9667 58           	db skip4           %256 ; D9
 654++9668 58           	db skip4           %256 ; DA
 655++9669 58           	db skip4           %256 ; DB
 656++966A 58           	db skip4           %256 ; DC
 657++966B 58           	db skip4           %256 ; DD
 658++966C 58           	db skip4           %256 ; DE
 659++966D 58           	db skip4           %256 ; DF
 660++966E 74           	db cmdunsupported  %256 ; E0
 661++966F 5D           	db skip5           %256 ; E1
 662++9670 5D           	db skip5           %256 ; E2
 663++9671 5D           	db skip5           %256 ; E3
 664++9672 5D           	db skip5           %256 ; E4
 665++9673 5D           	db skip5           %256 ; E5
 666++9674 5D           	db skip5           %256 ; E6
 667++9675 5D           	db skip5           %256 ; E7
 668++9676 5D           	db skip5           %256 ; E8
 669++9677 5D           	db skip5           %256 ; E9
 670++9678 5D           	db skip5           %256 ; EA
 671++9679 5D           	db skip5           %256 ; EB
 672++967A 5D           	db skip5           %256 ; EC
 673++967B 5D           	db skip5           %256 ; ED
 674++967C 5D           	db skip5           %256 ; EE
 675++967D 5D           	db skip5           %256 ; EF
 676++967E 5D           	db skip5           %256 ; F0
 677++967F 5D           	db skip5           %256 ; F1
 678++9680 5D           	db skip5           %256 ; F2
 679++9681 5D           	db skip5           %256 ; F3
 680++9682 5D           	db skip5           %256 ; F4
 681++9683 5D           	db skip5           %256 ; F5
 682++9684 5D           	db skip5           %256 ; F6
 683++9685 5D           	db skip5           %256 ; F7
 684++9686 5D           	db skip5           %256 ; F8
 685++9687 5D           	db skip5           %256 ; F9
 686++9688 5D           	db skip5           %256 ; FA
 687++9689 5D           	db skip5           %256 ; FB
 688++968A 5D           	db skip5           %256 ; FC
 689++968B 5D           	db skip5           %256 ; FD
 690++968C 5D           	db skip5           %256 ; FE
 691++968D 5D           	db skip5           %256 ; FF
 692++968E 94           	db skip1           /256 ; 00
 693++968F 94           	db skip1           /256 ; 01
 694++9690 94           	db skip1           /256 ; 02
 695++9691 94           	db skip1           /256 ; 03
 696++9692 94           	db skip1           /256 ; 04
 697++9693 94           	db skip1           /256 ; 05
 698++9694 94           	db skip1           /256 ; 06
 699++9695 94           	db skip1           /256 ; 07
 700++9696 94           	db skip1           /256 ; 08
 701++9697 94           	db skip1           /256 ; 09
 702++9698 94           	db skip1           /256 ; 0A
 703++9699 94           	db skip1           /256 ; 0B
 704++969A 94           	db skip1           /256 ; 0C
 705++969B 94           	db skip1           /256 ; 0D
 706++969C 94           	db skip1           /256 ; 0E
 707++969D 94           	db skip1           /256 ; 0F
 708++969E 94           	db skip1           /256 ; 10
 709++969F 94           	db skip1           /256 ; 11
 710++96A0 94           	db skip1           /256 ; 12
 711++96A1 94           	db skip1           /256 ; 13
 712++96A2 94           	db skip1           /256 ; 14
 713++96A3 94           	db skip1           /256 ; 15
 714++96A4 94           	db skip1           /256 ; 16
 715++96A5 94           	db skip1           /256 ; 17
 716++96A6 94           	db skip1           /256 ; 18
 717++96A7 94           	db skip1           /256 ; 19
 718++96A8 94           	db skip1           /256 ; 1A
 719++96A9 94           	db skip1           /256 ; 1B
 720++96AA 94           	db skip1           /256 ; 1C
 721++96AB 94           	db skip1           /256 ; 1D
 722++96AC 94           	db skip1           /256 ; 1E
 723++96AD 94           	db skip1           /256 ; 1F
 724++96AE 94           	db skip1           /256 ; 20
 725++96AF 94           	db skip1           /256 ; 21
 726++96B0 94           	db skip1           /256 ; 22
 727++96B1 94           	db skip1           /256 ; 23
 728++96B2 94           	db skip1           /256 ; 24
 729++96B3 94           	db skip1           /256 ; 25
 730++96B4 94           	db skip1           /256 ; 26
 731++96B5 94           	db skip1           /256 ; 27
 732++96B6 94           	db skip1           /256 ; 28
 733++96B7 94           	db skip1           /256 ; 29
 734++96B8 94           	db skip1           /256 ; 2A
 735++96B9 94           	db skip1           /256 ; 2B
 736++96BA 94           	db skip1           /256 ; 2C
 737++96BB 94           	db skip1           /256 ; 2D
 738++96BC 94           	db skip1           /256 ; 2E
 739++96BD 94           	db skip1           /256 ; 2F
 740++96BE 94           	db cmdunsupported  /256 ; 30
 741++96BF 94           	db skip2           /256 ; 31
 742++96C0 94           	db skip2           /256 ; 32
 743++96C1 94           	db skip2           /256 ; 33
 744++96C2 94           	db skip2           /256 ; 34
 745++96C3 94           	db skip2           /256 ; 35
 746++96C4 94           	db skip2           /256 ; 36
 747++96C5 94           	db skip2           /256 ; 37
 748++96C6 94           	db skip2           /256 ; 38
 749++96C7 94           	db skip2           /256 ; 39
 750++96C8 94           	db skip2           /256 ; 3A
 751++96C9 94           	db skip2           /256 ; 3B
 752++96CA 94           	db skip2           /256 ; 3C
 753++96CB 94           	db skip2           /256 ; 3D
 754++96CC 94           	db skip2           /256 ; 3E
 755++96CD 94           	db skip2           /256 ; 3F
 756++96CE 94           	db skip3           /256 ; 40
 757++96CF 94           	db skip3           /256 ; 41
 758++96D0 94           	db skip3           /256 ; 42
 759++96D1 94           	db skip3           /256 ; 43
 760++96D2 94           	db skip3           /256 ; 44
 761++96D3 94           	db skip3           /256 ; 45
 762++96D4 94           	db skip3           /256 ; 46
 763++96D5 94           	db skip3           /256 ; 47
 764++96D6 94           	db skip3           /256 ; 48
 765++96D7 94           	db skip3           /256 ; 49
 766++96D8 94           	db skip3           /256 ; 4A
 767++96D9 94           	db skip3           /256 ; 4B
 768++96DA 94           	db skip3           /256 ; 4C
 769++96DB 94           	db skip3           /256 ; 4D
 770++96DC 94           	db skip3           /256 ; 4E
 771++96DD 94           	db skip2           /256 ; 4F
 772++96DE 94           	db cmdunsupported  /256 ; 50
 773++96DF 94           	db cmdunsupported  /256 ; 51
 774++96E0 94           	db cmdunsupported  /256 ; 52
 775++96E1 94           	db cmdunsupported  /256 ; 53
 776++96E2 94           	db cmdYM2151       /256 ; 54
 777++96E3 94           	db cmdYM2203       /256 ; 55
 778++96E4 94           	db cmdYM2608p0     /256 ; 56
 779++96E5 97           	db cmdYM2608p1     /256 ; 57
 780++96E6 94           	db cmdunsupported  /256 ; 58
 781++96E7 94           	db cmdunsupported  /256 ; 59
 782++96E8 94           	db cmdYM3812       /256 ; 5A
 783++96E9 94           	db cmdYM3526       /256 ; 5B
 784++96EA 94           	db cmdY8950        /256 ; 5C
 785++96EB 94           	db skip3           /256 ; 5D
 786++96EC 94           	db cmdYMF262p0     /256 ; 5E
 787++96ED 94           	db cmdYMF262p1     /256 ; 5F
 788++96EE 94           	db cmdunsupported  /256 ; 60
 789++96EF 94           	db waitvar         /256 ; 61
 790++96F0 94           	db wait735         /256 ; 62
 791++96F1 94           	db wait882         /256 ; 63
 792++96F2 94           	db cmdunsupported  /256 ; 64
 793++96F3 94           	db cmdunsupported  /256 ; 65
 794++96F4 94           	db endofsounddata  /256 ; 66
 795++96F5 95           	db cmddatablock    /256 ; 67
 796++96F6 94           	db skip12          /256 ; 68
 797++96F7 94           	db cmdunsupported  /256 ; 69
 798++96F8 94           	db cmdunsupported  /256 ; 6A
 799++96F9 94           	db cmdunsupported  /256 ; 6B
 800++96FA 94           	db cmdunsupported  /256 ; 6C
 801++96FB 94           	db cmdunsupported  /256 ; 6D
 802++96FC 94           	db cmdunsupported  /256 ; 6E
 803++96FD 94           	db cmdunsupported  /256 ; 6F
 804++96FE 93           	db wait1           /256 ; 70
 805++96FF 93           	db wait2           /256 ; 71
 806++9700 93           	db wait3           /256 ; 72
 807++9701 93           	db wait4           /256 ; 73
 808++9702 93           	db wait5           /256 ; 74
 809++9703 93           	db wait6           /256 ; 75
 810++9704 93           	db wait7           /256 ; 76
 811++9705 93           	db wait8           /256 ; 77
 812++9706 93           	db wait9           /256 ; 78
 813++9707 93           	db wait10          /256 ; 79
 814++9708 93           	db wait11          /256 ; 7A
 815++9709 93           	db wait12          /256 ; 7B
 816++970A 94           	db wait13          /256 ; 7C
 817++970B 94           	db wait14          /256 ; 7D
 818++970C 94           	db wait15          /256 ; 7E
 819++970D 94           	db wait16          /256 ; 7F
 820++970E 94           	db skip1           /256 ; 80
 821++970F 93           	db wait1           /256 ; 81
 822++9710 93           	db wait2           /256 ; 82
 823++9711 93           	db wait3           /256 ; 83
 824++9712 93           	db wait4           /256 ; 84
 825++9713 93           	db wait5           /256 ; 85
 826++9714 93           	db wait6           /256 ; 86
 827++9715 93           	db wait7           /256 ; 87
 828++9716 93           	db wait8           /256 ; 88
 829++9717 93           	db wait9           /256 ; 89
 830++9718 93           	db wait10          /256 ; 8A
 831++9719 93           	db wait11          /256 ; 8B
 832++971A 93           	db wait12          /256 ; 8C
 833++971B 94           	db wait13          /256 ; 8D
 834++971C 94           	db wait14          /256 ; 8E
 835++971D 94           	db wait15          /256 ; 8F
 836++971E 94           	db skip5           /256 ; 90
 837++971F 94           	db skip5           /256 ; 91
 838++9720 94           	db skip6           /256 ; 92
 839++9721 94           	db skip11          /256 ; 93
 840++9722 94           	db skip2           /256 ; 94
 841++9723 94           	db skip5           /256 ; 95
 842++9724 94           	db cmdunsupported  /256 ; 96
 843++9725 94           	db cmdunsupported  /256 ; 97
 844++9726 94           	db cmdunsupported  /256 ; 98
 845++9727 94           	db cmdunsupported  /256 ; 99
 846++9728 94           	db cmdunsupported  /256 ; 9A
 847++9729 94           	db cmdunsupported  /256 ; 9B
 848++972A 94           	db cmdunsupported  /256 ; 9C
 849++972B 94           	db cmdunsupported  /256 ; 9D
 850++972C 94           	db cmdunsupported  /256 ; 9E
 851++972D 94           	db cmdunsupported  /256 ; 9F
 852++972E 95           	db cmdAY8910       /256 ; A0
 853++972F 94           	db skip3           /256 ; A1
 854++9730 94           	db cmdunsupported  /256 ; A2
 855++9731 94           	db cmdunsupported  /256 ; A3
 856++9732 95           	db cmdYM2151dp     /256 ; A4
 857++9733 94           	db cmdYM2203dp     /256 ; A5
 858++9734 94           	db skip3           /256 ; A6
 859++9735 94           	db skip3           /256 ; A7
 860++9736 94           	db skip3           /256 ; A8
 861++9737 94           	db skip3           /256 ; A9
 862++9738 94           	db cmdYM3812dp     /256 ; AA
 863++9739 94           	db cmdYM3526dp     /256 ; AB
 864++973A 94           	db cmdY8950dp      /256 ; AC
 865++973B 94           	db skip3           /256 ; AD
 866++973C 8D           	db cmdYMF262dp0    /256 ; AE
 867++973D 8D           	db cmdYMF262dp0    /256 ; AF
 868++973E 94           	db skip3           /256 ; B0
 869++973F 94           	db skip3           /256 ; B1
 870++9740 94           	db skip3           /256 ; B2
 871++9741 94           	db skip3           /256 ; B3
 872++9742 94           	db skip3           /256 ; B4
 873++9743 94           	db skip3           /256 ; B5
 874++9744 94           	db skip3           /256 ; B6
 875++9745 94           	db skip3           /256 ; B7
 876++9746 94           	db skip3           /256 ; B8
 877++9747 94           	db skip3           /256 ; B9
 878++9748 94           	db skip3           /256 ; BA
 879++9749 94           	db skip3           /256 ; BB
 880++974A 94           	db skip3           /256 ; BC
 881++974B 94           	db skip3           /256 ; BD
 882++974C 94           	db skip3           /256 ; BE
 883++974D 94           	db skip3           /256 ; BF
 884++974E 94           	db skip4           /256 ; C0
 885++974F 94           	db skip4           /256 ; C1
 886++9750 94           	db skip4           /256 ; C2
 887++9751 94           	db skip4           /256 ; C3
 888++9752 94           	db skip4           /256 ; C4
 889++9753 94           	db skip4           /256 ; C5
 890++9754 94           	db skip4           /256 ; C6
 891++9755 94           	db skip4           /256 ; C7
 892++9756 94           	db skip4           /256 ; C8
 893++9757 94           	db skip4           /256 ; C9
 894++9758 94           	db skip4           /256 ; CA
 895++9759 94           	db skip4           /256 ; CB
 896++975A 94           	db skip4           /256 ; CC
 897++975B 94           	db skip4           /256 ; CD
 898++975C 94           	db skip4           /256 ; CE
 899++975D 94           	db skip4           /256 ; CF
 900++975E 94           	db cmdYMF278B      /256 ; D0
 901++975F 94           	db skip4           /256 ; D1
 902++9760 94           	db cmdunsupported  /256 ; D2
 903++9761 94           	db skip4           /256 ; D3
 904++9762 94           	db skip4           /256 ; D4
 905++9763 94           	db skip4           /256 ; D5
 906++9764 94           	db skip4           /256 ; D6
 907++9765 94           	db skip4           /256 ; D7
 908++9766 94           	db skip4           /256 ; D8
 909++9767 94           	db skip4           /256 ; D9
 910++9768 94           	db skip4           /256 ; DA
 911++9769 94           	db skip4           /256 ; DB
 912++976A 94           	db skip4           /256 ; DC
 913++976B 94           	db skip4           /256 ; DD
 914++976C 94           	db skip4           /256 ; DE
 915++976D 94           	db skip4           /256 ; DF
 916++976E 94           	db cmdunsupported  /256 ; E0
 917++976F 94           	db skip5           /256 ; E1
 918++9770 94           	db skip5           /256 ; E2
 919++9771 94           	db skip5           /256 ; E3
 920++9772 94           	db skip5           /256 ; E4
 921++9773 94           	db skip5           /256 ; E5
 922++9774 94           	db skip5           /256 ; E6
 923++9775 94           	db skip5           /256 ; E7
 924++9776 94           	db skip5           /256 ; E8
 925++9777 94           	db skip5           /256 ; E9
 926++9778 94           	db skip5           /256 ; EA
 927++9779 94           	db skip5           /256 ; EB
 928++977A 94           	db skip5           /256 ; EC
 929++977B 94           	db skip5           /256 ; ED
 930++977C 94           	db skip5           /256 ; EE
 931++977D 94           	db skip5           /256 ; EF
 932++977E 94           	db skip5           /256 ; F0
 933++977F 94           	db skip5           /256 ; F1
 934++9780 94           	db skip5           /256 ; F2
 935++9781 94           	db skip5           /256 ; F3
 936++9782 94           	db skip5           /256 ; F4
 937++9783 94           	db skip5           /256 ; F5
 938++9784 94           	db skip5           /256 ; F6
 939++9785 94           	db skip5           /256 ; F7
 940++9786 94           	db skip5           /256 ; F8
 941++9787 94           	db skip5           /256 ; F9
 942++9788 94           	db skip5           /256 ; FA
 943++9789 94           	db skip5           /256 ; FB
 944++978A 94           	db skip5           /256 ; FC
 945++978B 94           	db skip5           /256 ; FD
 946++978C 94           	db skip5           /256 ; FE
 947++978D 94           	db skip5           /256 ; FF
 948++978E
 949++978E
 950++978E
 951++978E              cmdYM2608p0 equ cmdYM2203
 952++978E
 953++978E              cmdYM2608p1
 954++978E              	memory_stream_read_2 e,d
 954++978E 2A 72 8D    >	ld hl,(memorystreamcurrentaddr)
 954++9791             >	memory_stream_read_byte e
 954++9791 CB 74       >	bit 6,h
 954++9793             >        IF AREA_C000_FFFF=1
 954++9793 CC 0D 8D    >	call z,memorystreamnextpage
 954++9796             >        ELSE
 954++9796 ~           > 	call nz,memorystreamnextpage
 954++9796             >        ENDIF
 954++9796 5E          >	ld e,(hl)
 954++9797 23          >	inc hl
 954++9798             >	memory_stream_read_byte d
 954++9798 CB 74       >	bit 6,h
 954++979A             >        IF AREA_C000_FFFF=1
 954++979A CC 0D 8D    >	call z,memorystreamnextpage
 954++979D             >        ELSE
 954++979D ~           > 	call nz,memorystreamnextpage
 954++979D             >        ENDIF
 954++979D 56          >	ld d,(hl)
 954++979E 23          >	inc hl
 954++979F 22 72 8D    >	ld (memorystreamcurrentaddr),hl
 955++97A2 7B           	ld a,e
 956++97A3 FE 30        	cp 0x30
 957++97A5 D8           	ret c
 958++97A6 C3 A0 91     	jp opnwritefm2
 959++97A9
 960++97A9
 961++97A9              initAY8910
 962++97A9 CD AD 92     	call ssginit
 963++97AC 21 66 93     	ld hl,devicemask
 964++97AF 3A 77 BE     	ld a,(HEADER_CLOCK_AY8910+3)
 965++97B2 E6 40        	and 0x40
 966++97B4 20 03        	jr nz,.dualchip
 967++97B6 CB C6        	set DEVICE_AY_BIT,(hl)
 968++97B8 C9           	ret
 969++97B9              .dualchip
 970++97B9 CB CE        	set DEVICE_TURBOSOUND_BIT,(hl)
 971++97BB C9           	ret
 972++97BC
 973++97BC              initYM2203
 974++97BC              tfmstatus=$+1
 975++97BC 3E 01        	ld a,1
 976++97BE 3D           	dec a
 977++97BF F8           	ret m
 978++97C0 CD AB 91     	call opninit
 979++97C3              	set_timer opnwaittimer60hz,735
 979++97C3 21 DF 02    >	ld hl,735
 979++97C6 22 86 93    >	ld (waittimerstep),hl
 980++97C9 CD 41 92     	call opninittimer60hz
 981++97CC 21 66 93     	ld hl,devicemask
 982++97CF CB D6        	set DEVICE_TFM_BIT,(hl)
 983++97D1 AF           	xor a
 984++97D2 C9           	ret
 985++97D3
 986++97D3              initYMF278B
 987++97D3              moonsoundstatus=$+1
 988++97D3 3E 02        	ld a,2
 989++97D5 3D           	dec a
 990++97D6 F8           	ret m
 991++97D7 CD 6D 90     	call vgmopl4init
 992++97DA 3A 53 BE     	ld a,(HEADER_CLOCK_YM3812+3)
 993++97DD E6 40        	and 0x40
 994++97DF 20 08        	jr nz,notOPL2
 995++97E1              useYM3812=$+1
 996++97E1 F6 00        	or 0
 997++97E3 11 05 00     	ld de,0x0005
 998++97E6 C4 33 8E     	call nz,opl4writefm2
 999++97E9              notOPL2
1000++97E9 CD 64 91     	call opl4inittimer60hz
1001++97EC 21 66 93     	ld hl,devicemask
1002++97EF CB DE        	set DEVICE_MOONSOUND_BIT,(hl)
1003++97F1 AF           	xor a
1004++97F2 C9           	ret
1005++97F3
1006++97F3              end
1007++97F3
1008++97F3
1009++97F3
1010++97F3              ;        LABELSLIST "vgm_plr.l"
1011++97F3              ;	savebin "gplay.apg",begin,end-begin
# file closed: GPlay/vgm.asm
 384+ 97F3              	include sub_func.asm
# file opened: GPlay/sub_func.asm
   1++97F3
   2++97F3              fileopenerror
   3++97F3 79           		ld a,c
   4++97F4 0E FF        		ld c,$FF
   5++97F6 02                   ld (bc),a ;   
   6++97F7
   7++97F7 21 A4 8B     		ld hl,txt_fopenerror
   8++97FA              		OS_PRINTZ
   8++97FA 0E 09       >    ld c,#09
   8++97FC E7          >    rst #20
   9++97FD
  10++97FD 3A C9 9A     		ld a,(file_id_cur_r)
  11++9800 FE FF        		cp 255
  12++9802 28 03        		jr z,fileopenerror1
  13++9804              		OS_FILE_CLOSE ;A - id file
  13++9804 0E 25       >    ld c,#25
  13++9806 E7          >    rst #20
  14++9807              fileopenerror1
  15++9807 37           		scf ;
  16++9808 C9           		ret
  17++9809
  18++9809
  19++9809              ; memoryerror
  20++9809                      ; OS_CLOSEHANDLE
  21++9809                      ; ld e,6+0x80
  22++9809                      ; OS_SETGFX
  23++9809                      ; ld e,0
  24++9809                      ; OS_CLS
  25++9809                      ; ld hl,txt_memoryerror
  26++9809                      ; call print_hl
  27++9809                      ; YIELDGETKEYLOOP
  28++9809                      ; jp cmd_quit
  29++9809
  30++9809              memoryerror
  31++9809 79           		ld a,c
  32++980A 0E FF        		ld c,$FF
  33++980C 02                   ld (bc),a ;   
  34++980D
  35++980D 21 8A 8B     		ld hl,txt_memoryerror
  36++9810              		OS_PRINTZ
  36++9810 0E 09       >    ld c,#09
  36++9812 E7          >    rst #20
  37++9813
  38++9813 3A C9 9A     		ld a,(file_id_cur_r)
  39++9816 FE FF        		cp 255
  40++9818 28 03        		jr z,memoryerror1
  41++981A              		OS_FILE_CLOSE ;A - id file
  41++981A 0E 25       >    ld c,#25
  41++981C E7          >    rst #20
  42++981D              memoryerror1
  43++981D 37           		scf ;
  44++981E C9           		ret
  45++981F
  46++981F
  47++981F
  48++981F              ;----------------------------------------
  49++981F              load_mus
  50++981F
  51++981F                      ; ld b,0
  52++981F              ; old_mus EQU $-1
  53++981F                      ; cp b
  54++981F                      ; ret z
  55++981F                      ; ld (old_mus),a
  56++981F
  57++981F                      ; and a
  58++981F                      ; jp z,no_mus
  59++981F
  60++981F
  61++981F                      ; call calc_mus
  62++981F
  63++981F                      ; call no_mus
  64++981F                      ; ld hl,t_s98_file00_pages_list+$FF
  65++981F                      ; call free_s98_file ; 
  66++981F
  67++981F                      ;generate path to music file in 'buf'
  68++981F                      ; ld hl,mus_path1
  69++981F                      ; ld de,buf
  70++981F                      ; call copystr_hlde ;'copy path  'mus/' '
  71++981F
  72++981F                      ; ld a,(mus_mode)
  73++981F                      ; ld hl,mus_modes
  74++981F                      ; call sel_word
  75++981F                      ; call copystr_hlde ;copy "aym / s98 path"
  76++981F                      ; ld hl,mus_path2
  77++981F                      ; call copystr_hlde ;copy name without ext
  78++981F
  79++981F                      ; ld a,(mus_mode)
  80++981F                      ; ld hl,plr_ext
  81++981F                      ; call sel_word
  82++981F                      ; call copystr_hlde  ;copy file ext
  83++981F                      ; xor a
  84++981F                      ; ld (de),a  ;string terminator
  85++981F
  86++981F                      ; ld de,buf ; 
  87++981F                      ; call openstream_file
  88++981F
  89++981F 21 B8 98     		ld hl,file_name_cur
  90++9822              		OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
  90++9822 0E 21       >    ld c,#21
  90++9824 E7          >    rst #20
  91++9825
  92++9825                      ;or a
  93++9825                      ;jp nz,fileopenerror
  94++9825 DA F3 97     		jp c,fileopenerror
  95++9828 32 C9 9A     		ld (file_id_cur_r),a
  96++982B
  97++982B 21 00 8C             ld hl,memorystreampages ;t_s98_file00_pages_list
  98++982E 22 32 98             ld (load_s98_file_number),hl
  99++9831
 100++9831
 101++9831              /////------        call load_s98_file      ;de=drive/path/file
 102++9831
 103++9831              ;    
 104++9831              ;   
 105++9831
 106++9831                              ;   
 107++9831
 108++9831
 109++9831              load_s98_file_number_haddr = $+2
 109++9831
 110++9831              load_s98_file_number = $+1
 110++9831
 111++9831 01 00 8C                     ld bc,memorystreampages ;t_s98_file00_pages_list
 112++9834 C5                           push bc
 113++9835
 114++9835              read_file_loop:
 115++9835                              ;OS_NEWPAGE              ;out: a=0 (OK)/!=0 (fail), e=page
 116++9835              				OS_GET_PAGE ;*
 116++9835 0E 1A       >    ld c,#1a
 116++9837 E7          >    rst #20
 117++9838
 118++9838 C1                           pop bc ;file tab
 119++9839
 120++9839                              ;or a
 121++9839                              ;jp nz,memory_error
 122++9839 DA 7C 98     				jp c,memory_error
 123++983C                              ;ld a,e
 124++983C                                                      ;    !!!!
 125++983C                                                      ;    !!!!
 126++983C
 127++983C 02           1               ld (bc),a
 128++983D 0C                           inc c           ;      4 !!!!!
 129++983E
 130++983E C5                           push bc ;file tab
 131++983F                              ;SETPGC000
 132++983F              				OS_SET_PAGE_SLOT3
 132++983F 0E 1C       >    ld c,#1c
 132++9841 E7          >    rst #20
 133++9842
 134++9842                              ;ld de,$C000
 135++9842                              ;ld hl,$4000
 136++9842
 137++9842                              ;call readstream_file    ;DE = Buffer address, HL = Number of bytes to read
 138++9842                                              ;hl=actual size
 139++9842
 140++9842 3A C9 9A     				ld a,(file_id_cur_r)
 141++9845 21 00 C0     				ld hl,$C000
 142++9848 11 00 40                     ld de,$4000
 143++984B              				OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl -    )
 143++984B 0E 23       >    ld c,#23
 143++984D E7          >    rst #20
 144++984E 30 04        				jr nc,read_file_loop1
 145++9850
 146++9850              				; 
 147++9850 C1                           pop bc ;file tab
 148++9851 C3 F3 97                     jp fileopenerror
 149++9854
 150++9854
 151++9854              read_file_loop1		;
 152++9854 7C                           ld a,h
 153++9855                              ; cp $40
 154++9855                              ; jr nc,read_file_loop    ;>= $40
 155++9855 FE C0        				cp $c0
 156++9857 38 DC                        jr c,read_file_loop    ;>= $c0,   
 157++9859
 158++9859
 159++9859              read_file_exit
 160++9859
 161++9859 C1                           pop bc ;file tab
 162++985A                              ;    
 163++985A 79                           ld a,c
 164++985B
 165++985B                             // sub 16   ; !!!!!       0  +16
 166++985B
 167++985B 0E FF                        ld c,$FF
 168++985D 02                           ld (bc),a
 169++985E
 170++985E              ;-------------------------------------------------------
 171++985E              ;    .
 172++985E              ;       plr_page3    
 173++985E              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 174++985E                              ;call closestream_file
 175++985E 3A C9 9A     				ld a,(file_id_cur_r)
 176++9861              				OS_FILE_CLOSE ;A - id file
 176++9861 0E 25       >    ld c,#25
 176++9863 E7          >    rst #20
 177++9864
 178++9864              read_file_ok
 179++9864                              ;call store8000c000 ;*
 180++9864              ;  8000     
 181++9864 21 00 8C                     ld hl,memorystreampages ;t_s98_file00_pages_list
 182++9867 7E                           ld a,(hl)
 183++9868                              ;SETPG8000
 184++9868              				OS_SET_PAGE_SLOT3
 184++9868 0E 1C       >    ld c,#1c
 184++986A E7          >    rst #20
 185++986B                              ; ld a,(plr_page3)
 186++986B                              ; SETPGC000
 187++986B
 188++986B              ;    plr_page3.      .
 189++986B                              ; ld hl,0x8000
 190++986B                              ; ld de,module
 191++986B                              ; ld bc,16384
 192++986B                              ; ldir
 193++986B
 194++986B              ;   plrpage      .
 195++986B                              ; ld a,(plr_page)
 196++986B                              ; SETPGC000
 197++986B                              ; ld hl,t_s98_file00_pages_list
 198++986B                              ; ld de,0xc100         ;0x5000
 199++986B                              ; ld bc,256
 200++986B                              ; ldir
 201++986B
 202++986B                       ;       DI
 203++986B
 204++986B              ;b .
 205++986B                              ;call restore8000c000
 206++986B
 207++986B                              ;call set_music_pages
 208++986B
 209++986B 21 00 C0                     ld hl,module
 210++986E                              ;ld (0x4001),hl *    
 211++986E 22 D0 8B     				ld (START+1),hl
 212++9871 CD CF 8B                     call PLR_INIT        ;init music
 213++9874
 214++9874                        ;      EI
 215++9874              ;----------------
 216++9874              ;eloop           halt ;YIELD
 217++9874              ;                call PLR_PLAY
 218++9874              ;                jr eloop
 219++9874              ;----------------
 220++9874
 221++9874
 222++9874              ;!!!!!!!!!!
 223++9874
 224++9874              ; .
 225++9874                              ;ld a,(plr_page)
 226++9874 21 D4 8B                     ld hl,PLR_PLAY
 227++9877                              ;OS_SETMUSIC         ;****     
 228++9877              				OS_SET_INTER
 228++9877 0E 14       >    ld c,#14
 228++9879 E7          >    rst #20
 229++987A AF           				xor a ;OK
 230++987B C9           				ret
 231++987C                              ;jp unset_music_pages
 232++987C
 233++987C
 234++987C              memory_error:
 235++987C C3 09 98             jp memoryerror
 236++987F
# file closed: GPlay/sub_func.asm
 385+ 987F              	;include common/muldiv.asm
 386+ 987F
 387+ 987F              end_gplay
 388+ 987F
 389+ 987F
 390+ 987F
 391+ 987F              ;ниже не включается в файл
 392+ 987F              ;waveheaderbuffer equ 0xc000-2048=0xb800 ;
 393+ 987F
 394+ 987F
 395+ 987F              	;savebin "gplay.apg",start_gplay,$-start_gplay
# file closed: GPlay/gplay.asm
1317  987F              	include nc_pic_view.asm ;просмотр картинок
# file opened: nc_pic_view.asm
   1+ 987F                  ; module ScreenViewer
   2+ 987F              display:
   3+ 987F                  ; call Console.waitForKeyUp
   4+ 987F
   5+ 987F 3A CA 9A     	ld a,(page_ext01) ;доп страница
   6+ 9882              	OS_SET_PAGE_SLOT3
   6+ 9882 0E 1C       >    ld c,#1c
   6+ 9884 E7          >    rst #20
   7+ 9885
   8+ 9885              display_wait1
   9+ 9885 3E 07        	ld a,7
  10+ 9887              	OS_SET_SCREEN ;включить экран
  10+ 9887 0E 1D       >    ld c,#1d
  10+ 9889 E7          >    rst #20
  11+ 988A 30 03        	jr nc,display_wait1_ok
  12+ 988C              	OS_WAIT
  12+ 988C DF          >	rst #18
  13+ 988D 18 F6        	jr display_wait1 ;пока не получилось, может не в фокусе приложение
  14+ 988F
  15+ 988F              display_wait1_ok
  16+ 988F
  17+ 988F 3A CA 9A     	ld a,(page_ext01) ;доп страница для данных плеера
  18+ 9892 06 07        	ld b,7 ;страница назначения
  19+ 9894 21 00 80     	ld hl,#8000
  20+ 9897 11 00 C0     	ld de,#c000
  21+ 989A DD 21 00 1B  	ld ix,6912
  22+ 989E              	OS_RAM_COPY
  22+ 989E 0E 19       >    ld c,#19
  22+ 98A0 E7          >    rst #20
  23+ 98A1                  ;call TextMode.disable
  24+ 98A1              .wait
  25+ 98A1              	OS_WAIT
  25+ 98A1 DF          >	rst #18
  26+ 98A2              	OS_GET_CHAR
  26+ 98A2 0E 10       >    ld c,#10
  26+ 98A4 E7          >    rst #20
  27+ 98A5 FE FF        	cp 255
  28+ 98A7 28 F8        	jr z, .wait
  29+ 98A9 AF           	xor a ;текстовый экран
  30+ 98AA              	OS_SET_SCREEN
  30+ 98AA 0E 1D       >    ld c,#1d
  30+ 98AC E7          >    rst #20
  31+ 98AD                  ;call TextMode.cls
  32+ 98AD
  33+ 98AD 3A CB 9A     	ld a,(page_main) ;основная страница
  34+ 98B0              	OS_SET_PAGE_SLOT3
  34+ 98B0 0E 1C       >    ld c,#1c
  34+ 98B2 E7          >    rst #20
  35+ 98B3
  36+ 98B3 C9           	ret
  37+ 98B4                  ;jp History.back
  38+ 98B4
  39+ 98B4              ;    endmodule
  40+ 98B4
# file closed: nc_pic_view.asm
1318  98B4
1319  98B4              color_default equ 0*8+7 ;цвет обычный системный
1320  98B4              color_view_text equ 4 ;цвет текста в просмотрщике
1321  98B4
1322  98B4              color_backgr equ 1*8+7 ;цвет фона
1323  98B4              color_apg equ 1*8+4 ;цвет приложений
1324  98B4              color_dir equ 1*8+6 ;цвет папок
1325  98B4
1326  98B4              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1327  98B4              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1328  98B4              color_dir_hi equ 5*8+0 ;цвет папок курсор
1329  98B4
1330  98B4              file_info_lenght equ 255 ;длина инфо о файле
1331  98B4              panel_hight equ 22;высота панели
1332  98B4              panel_r_xy equ #0129
1333  98B4              buffer_cat equ #c000 ;адрес буфера каталога
1334  98B4
1335  98B4 00 00        file_r_all dw 0;всего файлов справа
1336  98B6 00 00        file_r_cur_focus dw 0;первый видимый
1337  98B8 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1338  99B8 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1339  9AB8 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1339  9ABC 20 20 20 20
1339  9AC0 20 20 20 20
1339  9AC4 00
1340  9AC5 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1341  9AC6
1342  9AC6 00 00        file_r_num_cur dw 0 ;текущий файл справа
1343  9AC8 00           key_pressed db 0 ;последняя клавиша
1344  9AC9 00           file_id_cur_r db 0 ;id файла справа
1345  9ACA
1346  9ACA
1347  9ACA 00           page_ext01 db 0 ;номер дополнительной страницы
1348  9ACB 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1349  9ACD 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1350  9ACE 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1350  9AD2 20 20 20 20
1350  9AD6 20 20 20 20
1350  9ADA 20 20 20 20
1350  9ADE 20 20 20 20
1350  9AE2 20 20 20 20
1350  9AE6 20 20 00
1351  9AE9
1352  9AE9
1353  9AE9              rect_1
1354  9AE9 C9           	db #c9
1355  9AEA              	dup 40-2
1356  9AEA CD          >	db #cd
1356  9AEB CD          >	db #cd
1356  9AEC CD          >	db #cd
1356  9AED CD          >	db #cd
1356  9AEE CD          >	db #cd
1356  9AEF CD          >	db #cd
1356  9AF0 CD          >	db #cd
1356  9AF1 CD          >	db #cd
1356  9AF2 CD          >	db #cd
1356  9AF3 CD          >	db #cd
1356  9AF4 CD          >	db #cd
1356  9AF5 CD          >	db #cd
1356  9AF6 CD          >	db #cd
1356  9AF7 CD          >	db #cd
1356  9AF8 CD          >	db #cd
1356  9AF9 CD          >	db #cd
1356  9AFA CD          >	db #cd
1356  9AFB CD          >	db #cd
1356  9AFC CD          >	db #cd
1356  9AFD CD          >	db #cd
1356  9AFE CD          >	db #cd
1356  9AFF CD          >	db #cd
1356  9B00 CD          >	db #cd
1356  9B01 CD          >	db #cd
1356  9B02 CD          >	db #cd
1356  9B03 CD          >	db #cd
1356  9B04 CD          >	db #cd
1356  9B05 CD          >	db #cd
1356  9B06 CD          >	db #cd
1356  9B07 CD          >	db #cd
1356  9B08 CD          >	db #cd
1356  9B09 CD          >	db #cd
1356  9B0A CD          >	db #cd
1356  9B0B CD          >	db #cd
1356  9B0C CD          >	db #cd
1356  9B0D CD          >	db #cd
1356  9B0E CD          >	db #cd
1356  9B0F CD          >	db #cd
1357  9B10              	edup
1358  9B10 BB 00        	db #bb,0
1359  9B12
1360  9B12              rect_2
1361  9B12 BA           	db #ba
1362  9B13              	dup 40-2
1363  9B13 20          >	db " "
1363  9B14 20          >	db " "
1363  9B15 20          >	db " "
1363  9B16 20          >	db " "
1363  9B17 20          >	db " "
1363  9B18 20          >	db " "
1363  9B19 20          >	db " "
1363  9B1A 20          >	db " "
1363  9B1B 20          >	db " "
1363  9B1C 20          >	db " "
1363  9B1D 20          >	db " "
1363  9B1E 20          >	db " "
1363  9B1F 20          >	db " "
1363  9B20 20          >	db " "
1363  9B21 20          >	db " "
1363  9B22 20          >	db " "
1363  9B23 20          >	db " "
1363  9B24 20          >	db " "
1363  9B25 20          >	db " "
1363  9B26 20          >	db " "
1363  9B27 20          >	db " "
1363  9B28 20          >	db " "
1363  9B29 20          >	db " "
1363  9B2A 20          >	db " "
1363  9B2B 20          >	db " "
1363  9B2C 20          >	db " "
1363  9B2D 20          >	db " "
1363  9B2E 20          >	db " "
1363  9B2F 20          >	db " "
1363  9B30 20          >	db " "
1363  9B31 20          >	db " "
1363  9B32 20          >	db " "
1363  9B33 20          >	db " "
1363  9B34 20          >	db " "
1363  9B35 20          >	db " "
1363  9B36 20          >	db " "
1363  9B37 20          >	db " "
1363  9B38 20          >	db " "
1364  9B39              	edup
1365  9B39 BA 00        	db #ba,0
1366  9B3B
1367  9B3B              rect_3
1368  9B3B C8           	db #c8
1369  9B3C              	dup 40-2
1370  9B3C CD          >	db #cd
1370  9B3D CD          >	db #cd
1370  9B3E CD          >	db #cd
1370  9B3F CD          >	db #cd
1370  9B40 CD          >	db #cd
1370  9B41 CD          >	db #cd
1370  9B42 CD          >	db #cd
1370  9B43 CD          >	db #cd
1370  9B44 CD          >	db #cd
1370  9B45 CD          >	db #cd
1370  9B46 CD          >	db #cd
1370  9B47 CD          >	db #cd
1370  9B48 CD          >	db #cd
1370  9B49 CD          >	db #cd
1370  9B4A CD          >	db #cd
1370  9B4B CD          >	db #cd
1370  9B4C CD          >	db #cd
1370  9B4D CD          >	db #cd
1370  9B4E CD          >	db #cd
1370  9B4F CD          >	db #cd
1370  9B50 CD          >	db #cd
1370  9B51 CD          >	db #cd
1370  9B52 CD          >	db #cd
1370  9B53 CD          >	db #cd
1370  9B54 CD          >	db #cd
1370  9B55 CD          >	db #cd
1370  9B56 CD          >	db #cd
1370  9B57 CD          >	db #cd
1370  9B58 CD          >	db #cd
1370  9B59 CD          >	db #cd
1370  9B5A CD          >	db #cd
1370  9B5B CD          >	db #cd
1370  9B5C CD          >	db #cd
1370  9B5D CD          >	db #cd
1370  9B5E CD          >	db #cd
1370  9B5F CD          >	db #cd
1370  9B60 CD          >	db #cd
1370  9B61 CD          >	db #cd
1371  9B62              	edup
1372  9B62 BC 00        	db #bc,0
1373  9B64
1374  9B64              ;file_name_test db '486 HEART ON FIRE.vgm',0
1375  9B64              msg_menu_info
1376  9B64 0D 43 53 2B  	db 13,"CS+Enter - Play all",0
1376  9B68 45 6E 74 65
1376  9B6C 72 20 2D 20
1376  9B70 50 6C 61 79
1376  9B74 20 61 6C 6C
1376  9B78 00
1377  9B79              msg_menu_main1
1378  9B79 20 4C 46 20  	db " LF On",0
1378  9B7D 4F 6E 00
1379  9B80              msg_menu_main2
1380  9B80 20 41 5A 20  	db " AZ On",0
1380  9B84 4F 6E 00
1381  9B87              msg_menu_main3
1382  9B87 20 56 69 65  	db " View",0
1382  9B8B 77 00
1383  9B8D              msg_file_error
1384  9B8D 46 69 6C 65  	db "File error",13,0
1384  9B91 20 65 72 72
1384  9B95 6F 72 0D 00
1385  9B99              msg_file_too_big
1386  9B99 46 69 6C 65  	db "File too big",13,0
1386  9B9D 20 74 6F 6F
1386  9BA1 20 62 69 67
1386  9BA5 0D 00
1387  9BA7              msg_mem_err
1388  9BA7 47 65 74 20  	db "Get memory error",13,0
1388  9BAB 6D 65 6D 6F
1388  9BAF 72 79 20 65
1388  9BB3 72 72 6F 72
1388  9BB7 0D 00
1389  9BB9              msg_mono_err
1390  9BB9 47 65 74 20  	db "Get mono mode error",13,0
1390  9BBD 6D 6F 6E 6F
1390  9BC1 20 6D 6F 64
1390  9BC5 65 20 65 72
1390  9BC9 72 6F 72 0D
1390  9BCD 00
1391  9BCE              msg_title_nc
1392  9BCE 4E 6F 6E 65  	db "None Commander ver 2025.08.07",13,0
1392  9BD2 20 43 6F 6D
1392  9BD6 6D 61 6E 64
1392  9BDA 65 72 20 76
1392  9BDE 65 72 20 32
1392  9BE2 30 32 35 2E
1392  9BE6 30 38 2E 30
1392  9BEA 37 0D 00
1393  9BED
1394  9BED
1395  9BED
1396  9BED              start_gp_gzip equ #4000 ;рабочий адрес модуля для распаковки
1397  9BED
1398  9BED              start_gp_gzip_tmp
1399  9BED              	incbin "gp_gzip.bin" ; часть плеера для режима моно
1400  B6ED              end_gp_gzip_tmp
1401  B6ED
1402  B6ED
1403  B6ED
1404  B6ED              end_nc
1405  B6ED              	savebin "nc.apg",start_nc,$-start_nc
1406  B6ED
1407  B6ED              ;ниже не включается в файл
1408  B6ED 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1409  BAED 00 00 00...  cat_index_2 ds 1024 ;буфер для индекса (вектора) сортировки 2
1410  BEED 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1411  BFED
1412  BFED              end_nc_all
1413  BFED
1414  BFED
1415  BFED
1416  BFED              	org 0xb800 ;
1417  B800              ;ещё тут буферы плеера VGM до адреса #bf00
1418  B800
1419  B800
# file closed: nc.asm
