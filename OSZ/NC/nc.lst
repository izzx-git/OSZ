# file opened: nc.asm
  1   0000              ;None Commander - приложение для OS GMX
  2   0000                 device ZXSPECTRUM128
  3   0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
  1+  0000              ;Список всех вызовов (функций) ОС GMX
  2+  0000
  3+  0000              ;Включить в свой код (в начале файла):
  4+  0000              	; include os_defs.asm
  5+  0000
  6+  0000              ;Использовать только имена функций, коды могут поменяться
  7+  0000
  8+  0000              ;например:
  9+  0000              	; org PROGSTART
 10+  0000              	; ../include os_defs.asm
 11+  0000              	; ld hl,text
 12+  0000              	; OS_PRINTZ ;печать	до кода 0
 13+  0000
 14+  0000              ;сохранность регистров не гарантируется
 15+  0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
 16+  0000
 17+  0000              PROGSTART equ #8000 ;адрес старта приложений
 18+  0000
 19+  0000
 20+  0000              ;короткие вызовы (именные RST) -------------------------
 21+  0000
 22+  0000              ;печать символа в консоль (ускоренная)
 23+  0000              	MACRO OS_PRINT_CHARF ;a=char
 24+  0000 ~            	rst #10
 25+  0000              	ENDM
 26+  0000
 27+  0000
 28+  0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
 29+  0000              ;все регистры сохраняются
 30+  0000              ;рекомендуется использовать вместо обычного halt
 31+  0000              	MACRO OS_WAIT
 32+  0000 ~            	rst #18
 33+  0000              	ENDM
 34+  0000
 35+  0000              	; MACRO OS_
 36+  0000              	; rst #28
 37+  0000              	; ENDM
 38+  0000
 39+  0000              	; MACRO OS_
 40+  0000              	; rst #30
 41+  0000              	; ENDM
 42+  0000
 43+  0000
 44+  0000
 45+  0000              ;вызовы через единую точку входа RST #20 ----------------
 46+  0000
 47+  0000              ;вывод в консоль --------------------
 48+  0000
 49+  0000              ;очистить консоль
 50+  0000              	macro OS_CLS ;clear visible area of terminal
 51+  0000 ~                ld c,#00
 52+  0000 ~                rst #20
 53+  0000                  endm
 54+  0000
 55+  0000              ;установить позицию курсора в консоли
 56+  0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
 57+  0000 ~                ld c,#01
 58+  0000 ~                rst #20
 59+  0000                  endm
 60+  0000
 61+  0000              ;печать символа в консоль
 62+  0000                  macro OS_PRINT_CHAR ;a=char
 63+  0000 ~                ld c,#02
 64+  0000 ~                rst #20
 65+  0000                  endm
 66+  0000
 67+  0000              ;заполнение строки одним символом
 68+  0000                  macro OS_FILL_LINE ;; H - line ; A - char
 69+  0000 ~                ld c,#03
 70+  0000 ~                rst #20
 71+  0000                  endm
 72+  0000
 73+  0000              ;покрасить строку цветом
 74+  0000                  macro OS_PAINT_LINE ;a - line, b - color
 75+  0000 ~                ld c,#04
 76+  0000 ~                rst #20
 77+  0000                  endm
 78+  0000
 79+  0000
 80+  0000                  ; macro OS_ ;
 81+  0000                  ; ld c,#05
 82+  0000                  ; rst #20
 83+  0000                  ; endm
 84+  0000
 85+  0000              ;установить цвет текста в консоли;
 86+  0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
 87+  0000 ~                ld c,#06
 88+  0000 ~                rst #20
 89+  0000                  endm
 90+  0000
 91+  0000                  ; macro OS_ ;
 92+  0000                  ; ld c,#07
 93+  0000                  ; rst #20
 94+  0000                  ; endm
 95+  0000
 96+  0000                  ; macro OS_ ;
 97+  0000                  ; ld c,#08
 98+  0000                  ; rst #20
 99+  0000                  ; endm
100+  0000
101+  0000
102+  0000
103+  0000              ;печать в консоль до кода 0
104+  0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
105+  0000 ~                ld c,#09
106+  0000 ~                rst #20
107+  0000                  endm
108+  0000
109+  0000
110+  0000              ;прочитать байт из порта uart
111+  0000              ;вх:
112+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
113+  0000              ;вых: A - считанный байт
114+  0000                  macro OS_UART_READ
115+  0000 ~                ld c,#0a
116+  0000 ~                rst #20
117+  0000                  endm
118+  0000
119+  0000              ;записать байт в порт uart
120+  0000              ;вх: A -байт
121+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
122+  0000                  macro OS_UART_WRITE
123+  0000 ~                ld c,#0b
124+  0000 ~                rst #20
125+  0000                  endm
126+  0000
127+  0000              ;закрыть соединение ESP
128+  0000              ;вх:
129+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
130+  0000                  macro OS_ESP_CLOSE
131+  0000 ~                ld c,#0c
132+  0000 ~                rst #20
133+  0000                  endm
134+  0000
135+  0000              ;установить соединение ESP (CIPSTART);
136+  0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
137+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
138+  0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
139+  0000                  macro OS_ESP_OPEN
140+  0000 ~                ld c,#0d
141+  0000 ~                rst #20
142+  0000                  endm
143+  0000
144+  0000              ;послать запрос ESP (CIPSEND);
145+  0000              ;вх: hl - адрес данных, de - длина данных
146+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
147+  0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
148+  0000                  macro OS_ESP_SEND
149+  0000 ~                ld c,#0e
150+  0000 ~                rst #20
151+  0000                  endm
152+  0000
153+  0000              ;получить пакет ESP (+IPD);
154+  0000              ;вх: hl - адрес для данных
155+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
156+  0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
157+  0000                  macro OS_ESP_GET
158+  0000 ~                ld c,#0f
159+  0000 ~                rst #20
160+  0000                  endm
161+  0000
162+  0000              ;ввод с консоли ----------------------
163+  0000
164+  0000              ;получить код нажатой клавиши
165+  0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
166+  0000 ~                ld c,#10
167+  0000 ~                rst #20
168+  0000                  endm
169+  0000
170+  0000
171+  0000              ;процессы ----------------------------
172+  0000
173+  0000              ;запустить процесс
174+  0000              ;вх: hl - имя файла (заканчивается на 0)
175+  0000                  macro OS_PROC_RUN ;
176+  0000 ~                ld c,#11
177+  0000 ~                rst #20
178+  0000                  endm
179+  0000
180+  0000              ;установить фокус
181+  0000              ;вх: a - id процесса
182+  0000                  macro OS_PROC_SET_FOCUS ;
183+  0000 ~                ld c,#12
184+  0000 ~                rst #20
185+  0000                  endm
186+  0000
187+  0000              ;закрыть процесс
188+  0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
189+  0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
190+  0000                  macro OS_PROC_CLOSE ;
191+  0000 ~                ld c,#13
192+  0000 ~                rst #20
193+  0000                  endm
194+  0000
195+  0000
196+  0000              ;прерывания --------------------------
197+  0000
198+  0000              ;установка адреса обработчика прерываний процесса;
199+  0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
200+  0000                  ; ld c,#14
201+  0000                  ; rst #20
202+  0000                  ; endm
203+  0000
204+  0000
205+  0000              ;плеер AY ----------------------------
206+  0000
207+  0000              ;инициализация плеера AY;
208+  0000                  macro OS_VTPL_INIT ;(HL - address music)
209+  0000 ~                ld c,#15
210+  0000 ~                rst #20
211+  0000                  endm
212+  0000
213+  0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
214+  0000                  macro OS_VTPL_PLAY ;()
215+  0000 ~                ld c,#16
216+  0000 ~                rst #20
217+  0000                  endm
218+  0000
219+  0000              ;заглушить плеер AY;
220+  0000                  macro OS_VTPL_MUTE ;()
221+  0000 ~                ld c,#17
222+  0000 ~                rst #20
223+  0000                  endm
224+  0000
225+  0000              ;получить значение переменной плеера;
226+  0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
227+  0000 ~                ld c,#18
228+  0000 ~                rst #20
229+  0000                  endm
230+  0000
231+  0000
232+  0000              ;прочие ------------------------------
233+  0000
234+  0000
235+  0000              ;скопировать данные из страницы в страницу
236+  0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
237+  0000                  macro OS_RAM_COPY
238+  0000 ~                ld c,#19
239+  0000 ~                rst #20
240+  0000                  endm
241+  0000
242+  0000              ;получить дополнительную страницу памяти;
243+  0000                  macro OS_GET_PAGE ;(out A - number page)
244+  0000 ~                ld c,#1a
245+  0000 ~                rst #20
246+  0000                  endm
247+  0000
248+  0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
249+  0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
250+  0000 ~                ld c,#1b
251+  0000 ~                rst #20
252+  0000                  endm
253+  0000
254+  0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
255+  0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
256+  0000 ~                ld c,#1c
257+  0000 ~                rst #20
258+  0000                  endm
259+  0000
260+  0000              ;включить экран N;
261+  0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
262+  0000              ;переключать может только приложение в фокусе
263+  0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
264+  0000              ;при переключении процессов сохраняется только экран #39
265+  0000                  macro OS_SET_SCREEN ;
266+  0000 ~                ld c,#1d
267+  0000 ~                rst #20
268+  0000                  endm
269+  0000
270+  0000
271+  0000              ;получить номера страниц процесса;
272+  0000              ;вх:
273+  0000              ;вых: b, c - страницы в слотах 2, 3
274+  0000                  macro OS_GET_MAIN_PAGES ;
275+  0000 ~                ld c,#1e
276+  0000 ~                rst #20
277+  0000                  endm
278+  0000
279+  0000              ;получить значение системного таймера
280+  0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
281+  0000 ~                ld c,#1F
282+  0000 ~                rst #20
283+  0000                  endm
284+  0000
285+  0000
286+  0000
287+  0000                  ; macro OS_ ;
288+  0000                  ; ld c,#20
289+  0000                  ; rst #20
290+  0000                  ; endm
291+  0000
292+  0000
293+  0000              ;дисковые операции -------------------
294+  0000
295+  0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
296+  0000
297+  0000              ; fcbFAT (из руководства к монитору)
298+  0000              ; формат fcb для работы с FAT
299+  0000
300+  0000              ; +#00 8 имя файла
301+  0000              ; +#08 3 расширение файла
302+  0000              ; +#0B 1 атрибуты файла
303+  0000              ; +#0C 4 номер первого кластера файла/каталога
304+  0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
305+  0000              ; +#14 4 размер файла/каталога в байтах
306+  0000              ; +#18 4 указатель в файле
307+  0000              ; +#1C 1 для внутренних нужд
308+  0000              ; +#1D 1 для внутренних нужд
309+  0000              ; +#1E 1 резерв
310+  0000              ; +#1F 1 номер винчестера и раздела на нем
311+  0000              	; 1-0,nn номер раздела
312+  0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
313+  0000              	    ; значение %11 недопустимо
314+  0000
315+  0000              ;открыть файл для чтения или записи
316+  0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
317+  0000 ~                ld c,#21
318+  0000 ~                rst #20
319+  0000                  endm
320+  0000
321+  0000              ;создать файл
322+  0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
323+  0000 ~                ld c,#22
324+  0000 ~                rst #20
325+  0000                  endm
326+  0000
327+  0000              ;прочитать из файла
328+  0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
329+  0000 ~                ld c,#23
330+  0000 ~                rst #20
331+  0000                  endm
332+  0000
333+  0000              ;записать в файл
334+  0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
335+  0000 ~                ld c,#24
336+  0000 ~                rst #20
337+  0000                  endm
338+  0000
339+  0000              ;закрыть файл
340+  0000                  macro OS_FILE_CLOSE ;A - id file
341+  0000 ~                ld c,#25
342+  0000 ~                rst #20
343+  0000                  endm
344+  0000
345+  0000              ;чтение секторов текущего каталога
346+  0000              ; вх:
347+  0000                   ; hl - буфер для чтения
348+  0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
349+  0000                   ; b - максимальное количество секторов для чтения
350+  0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
351+  0000                     ; a=errRWnum
352+  0000                     ; a=errInvalidPart
353+  0000                     ; a=errFileEmpty
354+  0000                   ; cy=0, a=errEoF - каталог закончился
355+  0000                     ; hl - следующий адрес в буфере
356+  0000                     ; de - номер первого непрочитанного сектора
357+  0000                     ; b - не прочитано секторов
358+  0000                   ; cy=0 - считано успешно
359+  0000                     ; hl - следующий адрес в буфере
360+  0000                     ; de - номер первого непрочитанного сектора
361+  0000                     ; b=#00
362+  0000                  macro OS_DIR_READ ;
363+  0000 ~                ld c,#26
364+  0000 ~                rst #20
365+  0000                  endm
366+  0000
367+  0000              ;вход в каталог/выход в родительский каталог
368+  0000              	; Если путь не указан производится только настройка переменных драйвера,
369+  0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
370+  0000              	; Если пусть указан, в конец пути добавится название каталога (если это
371+  0000              	; переход в родительский, последнее имя в пути удалится).
372+  0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
373+  0000              	; добавится имя файла
374+  0000              ; вх:
375+  0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
376+  0000                   ; de - адрес дескриптора директории/файла
377+  0000              ; вых: a - если путь был указан, новая длина пути
378+  0000                  macro OS_DIR_OPEN ;
379+  0000 ~                ld c,#27
380+  0000 ~                rst #20
381+  0000                  endm
382+  0000
383+  0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
384+  0000              ;проверки на допустимость значений не производится
385+  0000              ;вх: CY = 1 - установка; CY = 0 - чтение
386+  0000              ;вх: A - id файла
387+  0000              ;вх: de, hl - значения старшие быйты, младшие
388+  0000              ;вых: de, hl - значения старшие быйты, младшие
389+  0000                  macro OS_FILE_POSITION ;
390+  0000 ~                ld c,#28
391+  0000 ~                rst #20
392+  0000                  endm
393+  0000
394+  0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
395+  0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
396+  0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
397+  0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
398+  0000                  macro OS_FIND_PATH ;
399+  0000 ~                ld c,#29
400+  0000 ~                rst #20
401+  0000                  endm
402+  0000
403+  0000
# file closed: ../os_defs.asm
  4   0000              	org PROGSTART
  5   8000
  6   8000              start_nc
  7   8000 21 C8 89     	ld hl,msg_title_nc ;имя приложения
  8   8003              	OS_PRINTZ ;печать
  8   8003 0E 09       >    ld c,#09
  8   8005 E7          >    rst #20
  9   8006
 10   8006
 11   8006              	;узнать свои страницы
 12   8006              	OS_GET_MAIN_PAGES
 12   8006 0E 1E       >    ld c,#1e
 12   8008 E7          >    rst #20
 13   8009 38 09        	jr c,get_page_error
 14   800B
 15   800B ED 43 0C 89  	ld (page_main),bc
 16   800F
 17   800F
 18   800F              	OS_GET_PAGE ;получить лишнюю страницу
 18   800F 0E 1A       >    ld c,#1a
 18   8011 E7          >    rst #20
 19   8012 30 0C        	jr nc,get_page_ok
 20   8014              get_page_error
 21   8014 21 B5 89     	ld hl,msg_mem_err ;нет памяти
 22   8017              	OS_PRINTZ ;печать
 22   8017 0E 09       >    ld c,#09
 22   8019 E7          >    rst #20
 23   801A
 24   801A CD 9D 80     	call delay
 25   801D C3 9B 81     	jp exit
 26   8020
 27   8020              get_page_ok
 28   8020 32 0B 89     	ld (page_ext01),a ;запомнить
 29   8023
 30   8023
 31   8023
 32   8023              start_nc_warm ;тёплый старт
 33   8023
 34   8023              	;очистка буфера
 35   8023 CD A3 80     	call clear_buf
 36   8026
 37   8026              	;загрузка каталога
 38   8026 21 00 C0     	ld hl,buffer_cat ;куда
 39   8029 11 00 00     	ld de,0 ;начиная с 0 сектора
 40   802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
 41   802E              	OS_DIR_READ
 41   802E 0E 26       >    ld c,#26
 41   8030 E7          >    rst #20
 42   8031
 43   8031 21 00 00     	ld hl,0 ;обнулить переменные
 44   8034 22 07 89     	ld (file_r_num_cur),hl
 45   8037 22 E9 86     	ld (file_r_all),hl
 46   803A 22 EB 86     	ld (file_r_cur_focus),hl
 47   803D
 48   803D CD 50 82     	call sort_dir
 49   8040
 50   8040 3E 0F        	ld a,color_backgr
 51   8042 06 0C        	ld b,#c
 52   8044              	OS_SET_COLOR
 52   8044 0E 06       >    ld c,#06
 52   8046 E7          >    rst #20
 53   8047
 54   8047 CD B6 83     	call print_rect_r ;рамка
 55   804A CD B3 81     	call print_panel_r
 56   804D CD EB 83     	call print_menu_main
 57   8050
 58   8050 11 00 01     	ld de,#0100
 59   8053              	OS_SET_XY
 59   8053 0E 01       >    ld c,#01
 59   8055 E7          >    rst #20
 60   8056
 61   8056
 62   8056
 63   8056              nc_wait
 64   8056              	OS_WAIT ;ждать прерывание
 64   8056 DF          >	rst #18
 65   8057
 66   8057              	OS_GET_CHAR ;клавиша
 66   8057 0E 10       >    ld c,#10
 66   8059 E7          >    rst #20
 67   805A 32 09 89     	ld (key_pressed),a ;запомнить
 68   805D FE 0D        	cp 13
 69   805F CA BA 80     	jp z,key_enter ;
 70   8062 FE 0A        	cp 10 ;вниз
 71   8064 CC 07 81     	call z,key_down
 72   8067 FE 0B        	cp 11 ;вверх
 73   8069 CC 44 81     	call z,key_up
 74   806C FE 09        	cp 09 ;вправо
 75   806E CC 89 81     	call z,key_right
 76   8071 FE 08        	cp 08 ;влево
 77   8073 CC 77 81     	call z,key_left
 78   8076 FE 04        	cp 04 ;страница вверх
 79   8078 CC 77 81     	call z,key_left
 80   807B FE 05        	cp 05 ;страница вниз
 81   807D CC 89 81     	call z,key_right
 82   8080 FE 32        	cp "2" ;переключение сортировки
 83   8082 CA 63 83     	jp z,sort_toggle
 84   8085 FE 33        	cp "3" ;просмотр файла
 85   8087 CA 0B 84     	jp z,view_file
 86   808A FE 18        	cp 24 ;break
 87   808C CA 9B 81     	jp z,exit
 88   808F
 89   808F
 90   808F 3A 0E 89     	ld a,(print_panel_r_flag)
 91   8092 B7           	or a
 92   8093 C4 B3 81     	call nz,print_panel_r ;обновить каталог
 93   8096 AF           	xor a
 94   8097 32 0E 89     	ld (print_panel_r_flag),a
 95   809A
 96   809A C3 56 80     	jp nc_wait ;на цикл ожидания
 97   809D
 98   809D
 99   809D              delay ;задержка
100   809D 06 96        	ld b,50*3 ;
101   809F              delay1
102   809F              	OS_WAIT
102   809F DF          >	rst #18
103   80A0 10 FD        	djnz delay1
104   80A2 C9           	ret
105   80A3
106   80A3
107   80A3              clear_buf
108   80A3 21 00 C0     	ld hl,buffer_cat
109   80A6 11 01 C0     	ld de,buffer_cat+1
110   80A9 01 FF 3F     	ld bc,#4000-1
111   80AC 36 00        	ld (hl),0
112   80AE ED B0        	ldir
113   80B0 C9           	ret
114   80B1
115   80B1
116   80B1
117   80B1
118   80B1              release_key ;ждать отпускания клавиши
119   80B1              	OS_WAIT
119   80B1 DF          >	rst #18
120   80B2              	OS_GET_CHAR
120   80B2 0E 10       >    ld c,#10
120   80B4 E7          >    rst #20
121   80B5 FE FF        	cp 255
122   80B7 20 F8        	jr nz,release_key
123   80B9 C9           	ret
124   80BA
125   80BA
126   80BA              key_enter
127   80BA              	;нажата Enter
128   80BA 2A E9 86     	ld hl,(file_r_all)
129   80BD 7D           	ld a,l
130   80BE B4           	or h
131   80BF CA EA 80     	jp z,key_enter_ex ;защита
132   80C2 2A 07 89     	ld hl,(file_r_num_cur)
133   80C5 CD FA 80     	call calc_deskr
134   80C8 DD 7E 0B     	ld a,(ix+#0b)
135   80CB FE 10        	cp #10 ;признак каталога
136   80CD 28 1E        	jr z,key_enter_dir
137   80CF
138   80CF FE 30        	cp #30 ;признак каталога
139   80D1 28 1A        	jr z,key_enter_dir
140   80D3
141   80D3              	;проверка расширения ;APG
142   80D3 CD 9F 81     	call check_apg
143   80D6 C2 EA 80     	jp nz,key_enter_ex
144   80D9              	;тут запуск приложения
145   80D9 CD 81 83     	call format_name
146   80DC
147   80DC 21 ED 86     	ld hl,file_name_cur		;строка с именем
148   80DF              	OS_PROC_RUN ;запустить прогу
148   80DF 0E 11       >    ld c,#11
148   80E1 E7          >    rst #20
149   80E2              	;обработка ошибки
150   80E2 38 06        	jr c,key_enter_ex
151   80E4
152   80E4 DD 7E 00     	ld a,(ix)
153   80E7              	OS_PROC_SET_FOCUS ;на передний план
153   80E7 0E 12       >    ld c,#12
153   80E9 E7          >    rst #20
154   80EA
155   80EA              key_enter_ex
156   80EA C3 56 80     	jp nc_wait
157   80ED
158   80ED              key_enter_dir
159   80ED              	;тут открытие папки
160   80ED
161   80ED              	;call format_name_dir
162   80ED EB           	ex de,hl ;de - дескриптор для открытия
163   80EE 21 ED 87     	ld hl,dir_name_cur
164   80F1              	OS_DIR_OPEN
164   80F1 0E 27       >    ld c,#27
164   80F3 E7          >    rst #20
165   80F4 38 F4        	jr c,key_enter_ex ;если ошибка, ничего не делаем
166   80F6
167   80F6 E1           	pop hl ;отменить возврат
168   80F7 C3 23 80     	jp start_nc_warm ;перезагрузить папку
169   80FA
170   80FA
171   80FA              ; format_name_dir
172   80FA              	; push hl
173   80FA              	; ld hl,file_name_cur
174   80FA              	; ld de,file_name_cur+1 ;почистить
175   80FA              	; ld bc,256-1
176   80FA              	; ld (hl),0
177   80FA              	; ldir
178   80FA
179   80FA              	; pop hl
180   80FA
181   80FA              	; ld de,file_name_cur ;куда
182   80FA              	; ld bc,#08ff
183   80FA              ; format_name_dir_cl
184   80FA              	; ld a,(hl)
185   80FA              	; cp " "+1
186   80FA              	; jr c,format_name_dir_skip
187   80FA              	; ldi
188   80FA              	; djnz format_name_dir_cl
189   80FA              ; format_name_dir_skip
190   80FA              	; ld a,'/'
191   80FA              	; ld (de),a
192   80FA              	; ret
193   80FA
194   80FA               ;вычислить дескриптор текущего элемента справа
195   80FA              calc_deskr
196   80FA 29           	add hl,hl ;*2
197   80FB 01 E8 89     	ld bc,cat_index
198   80FE 09           	add hl,bc
199   80FF 5E           	ld e,(hl)
200   8100 23           	inc hl
201   8101 56           	ld d,(hl)
202   8102 EB           	ex de,hl ;hl - адрес элемента
203   8103 E5           	push hl
204   8104 DD E1        	pop ix ;ix- адрес элемента
205   8106 C9           	ret
206   8107
207   8107
208   8107
209   8107
210   8107              key_down
211   8107 2A E9 86     	ld hl,(file_r_all)
212   810A 7D           	ld a,l
213   810B B4           	or h
214   810C CA 40 81     	jp z,key_down_ex ;защита
215   810F
216   810F ED 4B 07 89  	ld bc,(file_r_num_cur)
217   8113 03           	inc bc
218   8114 2A E9 86     	ld hl,(file_r_all)
219   8117              	;если не больше чем всего
220   8117 A7           	and a
221   8118 ED 42        	sbc hl,bc
222   811A 38 24        	jr c,key_down_skip
223   811C 28 22        	jr z,key_down_skip
224   811E              	;прибавить
225   811E ED 43 07 89  	ld (file_r_num_cur),bc
226   8122
227   8122              	;теперь передвинуть фокус, если надо
228   8122 2A EB 86     	ld hl,(file_r_cur_focus)
229   8125 01 16 00     	ld bc,panel_hight
230   8128 09           	add hl,bc ;прибавить количество видимых
231   8129 ED 4B 07 89  	ld bc,(file_r_num_cur)
232   812D A7           	and a
233   812E ED 42        	sbc hl,bc ;вычесть положение курсора
234   8130 28 02        	jr z,key_down_change_focus_yes
235   8132 30 07        	jr nc,key_down_change_focus_no
236   8134              key_down_change_focus_yes
237   8134              	;передвинуть фокус
238   8134 2A EB 86     	ld hl,(file_r_cur_focus)
239   8137 23           	inc hl
240   8138 22 EB 86     	ld (file_r_cur_focus),hl
241   813B
242   813B              key_down_change_focus_no
243   813B 3E 01        	ld a,1
244   813D 32 0E 89     	ld (print_panel_r_flag),a
245   8140              	;call print_panel_r ;обновить каталог
246   8140              key_down_skip
247   8140
248   8140              key_down_ex
249   8140 3A 09 89     	ld a,(key_pressed)
250   8143 C9           	ret
251   8144
252   8144
253   8144
254   8144              key_up ;вверх
255   8144 2A E9 86     	ld hl,(file_r_all)
256   8147 7D           	ld a,l
257   8148 B4           	or h
258   8149 CA 73 81     	jp z,key_up_ex ;защита
259   814C
260   814C 2A 07 89     	ld hl,(file_r_num_cur)
261   814F 7D           	ld a,l
262   8150 B4           	or h
263   8151 28 20        	jr z,key_up_skip
264   8153 2B           	dec hl
265   8154 22 07 89     	ld (file_r_num_cur),hl
266   8157
267   8157              	;теперь передвинуть фокус, если надо
268   8157 2A 07 89     	ld hl,(file_r_num_cur)
269   815A              	; ld bc,panel_hight
270   815A              	; add hl,bc ;прибавить количество видимых
271   815A ED 4B EB 86  	ld bc,(file_r_cur_focus)
272   815E A7           	and a
273   815F ED 42        	sbc hl,bc ;вычесть положение курсора
274   8161              	;jr z,key_up_change_foces_yes
275   8161 30 0B        	jr nc,key_up_change_foces_no
276   8163              key_up_change_foces_yes
277   8163              	;передвинуть фокус
278   8163 2A EB 86     	ld hl,(file_r_cur_focus)
279   8166 7C           	ld a,h
280   8167 B5           	or l
281   8168 28 04        	jr z,key_up_change_foces_no ;защита
282   816A 2B           	dec hl
283   816B 22 EB 86     	ld (file_r_cur_focus),hl
284   816E
285   816E              key_up_change_foces_no
286   816E
287   816E 3E 01        	ld a,1
288   8170 32 0E 89     	ld (print_panel_r_flag),a
289   8173              	;call print_panel_r ;обновить каталог
290   8173              key_up_skip
291   8173
292   8173              key_up_ex
293   8173 3A 09 89     	ld a,(key_pressed)
294   8176 C9           	ret
295   8177
296   8177
297   8177              key_left ;на страницу назад
298   8177 06 15        	ld b,panel_hight-1
299   8179              key_left_cl
300   8179 C5           	push bc
301   817A CD 44 81     	call key_up
302   817D C1           	pop bc
303   817E 10 F9        	djnz key_left_cl
304   8180 3E 01        	ld a,1
305   8182 32 0E 89     	ld (print_panel_r_flag),a
306   8185 3A 09 89     	ld a,(key_pressed)
307   8188 C9           	ret
308   8189
309   8189
310   8189
311   8189              key_right ;на страницу вперёд
312   8189 06 15        	ld b,panel_hight-1
313   818B              key_right_cl
314   818B C5           	push bc
315   818C CD 07 81     	call key_down
316   818F C1           	pop bc
317   8190 10 F9        	djnz key_right_cl
318   8192 3E 01        	ld a,1
319   8194 32 0E 89     	ld (print_panel_r_flag),a
320   8197 3A 09 89     	ld a,(key_pressed)
321   819A C9           	ret
322   819B
323   819B
324   819B
325   819B              exit ;выход в DOS
326   819B AF           	xor a
327   819C              	OS_PROC_CLOSE
327   819C 0E 13       >    ld c,#13
327   819E E7          >    rst #20
328   819F
329   819F
330   819F
331   819F              check_apg ;проверка на расширение APG
332   819F DD 7E 08     	ld a,(ix+8)
333   81A2 FE 41        	cp "A"
334   81A4 C0           	ret nz
335   81A5 DD 7E 09     	ld a,(ix+9)
336   81A8 FE 50        	cp "P"
337   81AA C0           	ret nz
338   81AB DD 7E 0A     	ld a,(ix+10)
339   81AE FE 47        	cp "G"
340   81B0 C0           	ret nz
341   81B1 AF           	xor a ;равен
342   81B2 C9           	ret
343   81B3
344   81B3
345   81B3
346   81B3              print_panel_r ;печать правой панели
347   81B3              	;ld ix,buffer_cat
348   81B3 FD 2A E9 86  	ld iy,(file_r_all) ;всего файлов
349   81B7 FD 7D        	ld a,iyl
350   81B9 FD B4        	or iyh
351   81BB C8           	ret z ;защита если 0
352   81BC 11 29 01     	ld de,panel_r_xy ;координаты yx
353   81BF 06 16        	ld b,panel_hight ;высота панели
354   81C1 FD 2A EB 86  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
355   81C5              print_panel_r_cl ;цикл
356   81C5 C5           	push bc
357   81C6 D5           	push de ;xy
358   81C7              	OS_SET_XY
358   81C7 0E 01       >    ld c,#01
358   81C9 E7          >    rst #20
359   81CA
360   81CA              	;получить адрес элемента
361   81CA FD E5        	push iy
362   81CC E1           	pop hl
363   81CD CD FA 80     	call calc_deskr
364   81D0
365   81D0 CD EB 81     	call print_file_info ;напечатать строку
366   81D3              print_panel_r_skip
367   81D3 D1           	pop de
368   81D4 14           	inc d ;y++
369   81D5 FD 23        	inc iy ;текущий файл
370   81D7              	;проверка на конец каталога
371   81D7 2A E9 86     	ld hl,(file_r_all)
372   81DA FD E5        	push iy
373   81DC C1           	pop bc
374   81DD A7           	and a
375   81DE ED 42        	sbc hl,bc
376   81E0 C1           	pop bc
377   81E1 38 07        	jr c,print_panel_r_ex2
378   81E3 28 05        	jr z,print_panel_r_ex2
379   81E5 10 DE        	djnz print_panel_r_cl
380   81E7 C9           	ret
381   81E8              print_panel_r_ex
382   81E8 D1           	pop de
383   81E9 C1           	pop bc
384   81EA              print_panel_r_ex2
385   81EA              	;тут, возможно, надо допечатать пустые строки
386   81EA C9           	ret
387   81EB
388   81EB
389   81EB
390   81EB              print_file_info ;печать строчки о файле
391   81EB 11 ED 88     	ld de,file_info_string ;скопировать
392   81EE 01 08 00     	ld bc,8 ;file_info_lenght
393   81F1 ED B0        	ldir
394   81F3 3E 20        	ld a,' '
395   81F5 12           	ld (de),a
396   81F6 13           	inc de
397   81F7 01 03 00     	ld bc,3
398   81FA ED B0        	ldir
399   81FC
400   81FC CD 0B 82     	call get_color_item
401   81FF
402   81FF 06 0C        	ld b,#c
403   8201              	OS_SET_COLOR
403   8201 0E 06       >    ld c,#06
403   8203 E7          >    rst #20
404   8204 21 ED 88     	ld hl,file_info_string
405   8207              	OS_PRINTZ
405   8207 0E 09       >    ld c,#09
405   8209 E7          >    rst #20
406   820A C9           	ret
407   820B
408   820B
409   820B
410   820B              get_color_item ;получить цвет элемента
411   820B              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
412   820B              ;вых: A - цвет
413   820B ED 4B 07 89  	ld bc,(file_r_num_cur) ;позиция курсора справа
414   820F FD E5        	push iy
415   8211 E1           	pop hl
416   8212 A7           	and a
417   8213 ED 42        	sbc hl,bc ;сравнить
418   8215 28 11        	jr z,get_color_item_no_cursor
419   8217              	;цвета курсора
420   8217 3E 0E        	ld a,color_dir ;простая
421   8219 32 43 82     	ld (get_color_item_dir+1),a
422   821C 3E 0C        	ld a,color_apg ;простая
423   821E 32 4B 82     	ld (get_color_item_apg+1),a
424   8221 3E 0F        	ld a,color_backgr ;простая
425   8223 32 4E 82     	ld (get_color_item_backgr+1),a
426   8226 18 0F        	jr get_color_item_set
427   8228
428   8228              get_color_item_no_cursor
429   8228              	;цвета обычные
430   8228 3E 28        	ld a,color_dir_hi ;под курсором
431   822A 32 43 82     	ld (get_color_item_dir+1),a
432   822D 3E 28        	ld a,color_apg_hi ;под курсором
433   822F 32 4B 82     	ld (get_color_item_apg+1),a
434   8232 3E 28        	ld a,color_backgr_hi ;под курсором
435   8234 32 4E 82     	ld (get_color_item_backgr+1),a
436   8237
437   8237              get_color_item_set
438   8237              	;задать цвет
439   8237 DD 7E 0B     	ld a,(ix+#0b)
440   823A FE 10        	cp #10 ;признак каталога
441   823C 28 04        	jr z,get_color_item_dir
442   823E FE 30        	cp #30 ;признак каталога
443   8240 20 03        	jr nz,get_color_item_no_dir
444   8242              	;если папка
445   8242              get_color_item_dir
446   8242 3E 00        	ld a,0
447   8244 C9           	ret
448   8245
449   8245              get_color_item_no_dir
450   8245 CD 9F 81     	call check_apg ;расширение apg
451   8248 20 03        	jr nz,get_color_item_no_apg
452   824A              	;если приложение
453   824A              get_color_item_apg
454   824A 3E 00        	ld a,0
455   824C C9           	ret
456   824D
457   824D              get_color_item_no_apg
458   824D              	;если обычный файл
459   824D              get_color_item_backgr
460   824D 3E 00        	ld a,0
461   824F C9           	ret
462   8250
463   8250
464   8250
465   8250              ; format_dir ;подготовить каталог, убрать лишнее
466   8250              	; ; ld a,2
467   8250              	; ; out (254),a
468   8250              	; ld iy,0 ;счётчик файлов
469   8250              	; ;найти конец каталога
470   8250              	; ld hl,buffer_cat
471   8250              	; ld a,(hl)
472   8250              	; or a
473   8250              	; ret z ;защита
474   8250              	; ld bc,32
475   8250              ; format_dir_prep_cl
476   8250              	; ld a,(hl)
477   8250              	; or a
478   8250              	; jr z,format_dir_prep_ex
479   8250              	; add hl,bc
480   8250              	; ld a,h
481   8250              	; or a ;если вышли за границу
482   8250              	; jr z,format_dir_prep_ex
483   8250              	; jr format_dir_prep_cl
484   8250              ; format_dir_prep_ex
485   8250              	; ld bc,32
486   8250              	; and a
487   8250              	; sbc hl,bc
488   8250              	; ld (format_dir_top),hl ;конец каталога
489   8250
490   8250
491   8250
492   8250              	; ld ix,buffer_cat
493   8250              	; ;ld b,panel_hight ;высота панели
494   8250              ; format_dir_cl ;цикл
495   8250              	; ld a,(ix)
496   8250              	; or a ;конец каталога
497   8250              	; jr z,format_dir_ex
498   8250              	; cp #e5 ;удалённый
499   8250              	; jr z,format_dir_skip
500   8250              	; cp #05 ;удалённый
501   8250              	; jr z,format_dir_skip
502   8250              	; ld a,(ix+#0b)
503   8250              	; cp #0f ;длинный
504   8250              	; jr z,format_dir_skip
505   8250
506   8250              	; ;проверка на папку "." (этот же каталог)
507   8250              	; ld a,(ix+#00)
508   8250              	; cp "." ;
509   8250              	; jr nz,format_dir_add
510   8250              	; ld a,(ix+#01)
511   8250              	; cp " " ;
512   8250              	; jr z,format_dir_skip
513   8250
514   8250
515   8250              ; format_dir_add
516   8250              	; inc iy ;++
517   8250              	; ld bc,32 ;на другой элемент каталога
518   8250              	; add ix,bc
519   8250              	; ld a,ixh
520   8250              	; or a ;если вышли за границу
521   8250              	; jr z,format_dir_ex
522   8250              	; jr format_dir_cl
523   8250              ; format_dir_skip
524   8250              	; ;сдвинуть элементы вниз
525   8250              	; push ix
526   8250              	; push ix
527   8250              	; pop hl
528   8250              	; pop de ;куда
529   8250              	; ld hl,(format_dir_top) ;0-32
530   8250              	; and a
531   8250              	; sbc hl,de
532   8250              	; ld b,h
533   8250              	; ld c,l ;длина
534   8250              	; push bc
535   8250
536   8250              	; push ix
537   8250              	; pop hl ;откуда
538   8250              	; ld bc,32 ;на другой элемент каталога
539   8250              	; add hl,bc ;откуда
540   8250
541   8250              	; pop bc
542   8250              	; ldir
543   8250
544   8250              	; xor a
545   8250              	; ld (de),a ;очистить ненужный элемент
546   8250
547   8250              	; jr format_dir_cl
548   8250
549   8250              ; format_dir_ex
550   8250              	; ld (file_r_all),iy
551   8250              	; ;здесь почистить остаток каталога
552   8250              	; ; ld a,0
553   8250              	; ; out (254),a
554   8250              	; ret
555   8250              ; format_dir_top	dw 0 ;временно конец гаталога
556   8250
557   8250
558   8250
559   8250
560   8250
561   8250              sort_dir ;сортировка каталога с помощью построения индекса
562   8250 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
563   8254 DD 7E 00     	ld a,(ix)
564   8257 B7           	or a
565   8258 C8           	ret z ;если пусто, выход
566   8259 FD 21 00 00  	ld iy,0 ;счётчик
567   825D 21 E8 89     	ld hl,cat_index ;таблица - индекс
568   8260
569   8260 3A 80 83     	ld a,(sort_enable_flag)
570   8263 B7           	or a
571   8264 CA 85 82     	jp z,sort_dir_no
572   8267
573   8267 AF           	xor a
574   8268 32 84 82     	ld (sort_item),a ;образец для сравнения
575   826B              sort_dir_cl
576   826B CD 0D 83     	call sort_dir_one ;один проход по папкам
577   826E 3A 84 82     	ld a,(sort_item)
578   8271 3C           	inc a ;следующий образец
579   8272 32 84 82     	ld (sort_item),a
580   8275 20 F4        	jr nz,sort_dir_cl
581   8277
582   8277              	; xor a
583   8277              	; ld (sort_item),a ;образец для сравнения
584   8277              sort_file_cl
585   8277 CD C5 82     	call sort_file_one ;один проход по файлам
586   827A 3A 84 82     	ld a,(sort_item)
587   827D 3C           	inc a ;следующий образец
588   827E 32 84 82     	ld (sort_item),a
589   8281 20 F4        	jr nz,sort_file_cl
590   8283
591   8283 C9           	ret
592   8284
593   8284 00           sort_item db 0; текущий образец
594   8285
595   8285
596   8285
597   8285              ;без сортировки
598   8285              sort_dir_no
599   8285 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
600   8289              sort_dir_no_cl ;цикл по каталогам
601   8289 DD 7E 00     	ld a,(ix)
602   828C B7           	or a ;конец каталога
603   828D 28 31        	jr z,sort_dir_no_ex
604   828F FE E5        	cp #e5 ;удалённый
605   8291 28 22        	jr z,sort_dir_no_skip
606   8293 FE 05        	cp #05 ;удалённый
607   8295 28 1E        	jr z,sort_dir_no_skip
608   8297 DD 7E 0B     	ld a,(ix+#0b)
609   829A FE 0F        	cp #0f ;длинный
610   829C 28 17        	jr z,sort_dir_no_skip
611   829E
612   829E              	;проверка на папку "." (этот же каталог)
613   829E DD 7E 00     	ld a,(ix+#00)
614   82A1 FE 2E        	cp "." ;
615   82A3 20 07        	jr nz,sort_dir_no_add
616   82A5 DD 7E 01     	ld a,(ix+#01)
617   82A8 FE 20        	cp " " ;
618   82AA 28 09        	jr z,sort_dir_no_skip
619   82AC
620   82AC              sort_dir_no_add
621   82AC FD 23        	inc iy ;++
622   82AE              	;записать в таблицу (индекс)
623   82AE DD E5        	push ix
624   82B0 C1           	pop bc
625   82B1 71           	ld (hl),c
626   82B2 23           	inc hl
627   82B3 70           	ld (hl),b
628   82B4 23           	inc hl
629   82B5
630   82B5
631   82B5              sort_dir_no_skip
632   82B5 01 20 00     	ld bc,32
633   82B8 DD 09        	add ix,bc ;на следующий
634   82BA DD 7C        	ld a,ixh ;проверка на конец буфера
635   82BC FE C0        	cp #c0
636   82BE 30 C9        	jr nc,sort_dir_no_cl
637   82C0
638   82C0              sort_dir_no_ex
639   82C0 FD 22 E9 86  	ld (file_r_all),iy
640   82C4 C9           	ret
641   82C5
642   82C5
643   82C5              ;сортировка файлов
644   82C5              sort_file_one
645   82C5 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
646   82C9              sort_file_one_cl ;цикл по каталогам
647   82C9 DD 7E 00     	ld a,(ix)
648   82CC B7           	or a ;конец каталога
649   82CD 28 39        	jr z,sort_file_one_ex
650   82CF DD 7E 0B     	ld a,(ix+#0b)
651   82D2 FE 10        	cp #10 ;признак каталога
652   82D4 28 27        	jr z,sort_file_one_skip
653   82D6 FE 30        	cp #30 ;признак каталога
654   82D8 28 23        	jr z,sort_file_one_skip
655   82DA DD 7E 00     	ld a,(ix)
656   82DD FE E5        	cp #e5 ;удалённый
657   82DF 28 1C        	jr z,sort_file_one_skip
658   82E1 FE 05        	cp #05 ;удалённый
659   82E3 28 18        	jr z,sort_file_one_skip
660   82E5 DD 7E 0B     	ld a,(ix+#0b)
661   82E8 FE 0F        	cp #0f ;длинный
662   82EA 28 11        	jr z,sort_file_one_skip
663   82EC
664   82EC              	; ;проверка на папку "." (этот же каталог)
665   82EC              	; ld a,(ix+#00)
666   82EC              	; cp "." ;
667   82EC              	; jr nz,sort_file_one_add
668   82EC              	; ld a,(ix+#01)
669   82EC              	; cp " " ;
670   82EC              	; jr z,sort_file_one_skip
671   82EC
672   82EC
673   82EC              sort_file_one_add
674   82EC 3A 84 82     	ld a,(sort_item)
675   82EF DD BE 00     	cp (ix+#00) ;первая буква имени
676   82F2 20 09        	jr nz,sort_file_one_skip ;пока не подошла
677   82F4
678   82F4 FD 23        	inc iy ;++
679   82F6              	;записать в таблицу (индекс)
680   82F6 DD E5        	push ix
681   82F8 C1           	pop bc
682   82F9 71           	ld (hl),c
683   82FA 23           	inc hl
684   82FB 70           	ld (hl),b
685   82FC 23           	inc hl
686   82FD
687   82FD
688   82FD              sort_file_one_skip
689   82FD 01 20 00     	ld bc,32
690   8300 DD 09        	add ix,bc ;на следующий
691   8302 DD 7C        	ld a,ixh ;проверка на конец буфера
692   8304 FE C0        	cp #c0
693   8306 30 C1        	jr nc,sort_file_one_cl
694   8308
695   8308              sort_file_one_ex
696   8308 FD 22 E9 86  	ld (file_r_all),iy
697   830C C9           	ret
698   830D
699   830D
700   830D
701   830D
702   830D
703   830D              ;сортировка папок
704   830D              sort_dir_one
705   830D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
706   8311              sort_dir_one_cl ;цикл по каталогам
707   8311 DD 7E 00     	ld a,(ix)
708   8314 B7           	or a ;конец каталога
709   8315 28 47        	jr z,sort_dir_one_ex
710   8317 DD 7E 0B     	ld a,(ix+#0b)
711   831A FE 10        	cp #10 ;признак каталога
712   831C 28 04        	jr z,sort_dir_one_skip_no
713   831E FE 30        	cp #30 ;признак каталога
714   8320 20 31        	jr nz,sort_dir_one_skip
715   8322              sort_dir_one_skip_no
716   8322 DD 7E 00     	ld a,(ix)
717   8325 FE E5        	cp #e5 ;удалённый
718   8327 28 2A        	jr z,sort_dir_one_skip
719   8329 FE 05        	cp #05 ;удалённый
720   832B 28 26        	jr z,sort_dir_one_skip
721   832D DD 7E 0B     	ld a,(ix+#0b)
722   8330 FE 0F        	cp #0f ;длинный
723   8332 28 1F        	jr z,sort_dir_one_skip
724   8334
725   8334              	;проверка на папку "." (этот же каталог)
726   8334 DD 7E 00     	ld a,(ix+#00)
727   8337 FE 2E        	cp "." ;
728   8339 20 07        	jr nz,sort_dir_one_add
729   833B DD 7E 01     	ld a,(ix+#01)
730   833E FE 20        	cp " " ;
731   8340 28 11        	jr z,sort_dir_one_skip
732   8342
733   8342              sort_dir_one_add
734   8342 3A 84 82     	ld a,(sort_item)
735   8345 DD BE 00     	cp (ix+#00) ;первая буква имени
736   8348 20 09        	jr nz,sort_dir_one_skip ;пока не подошла
737   834A
738   834A FD 23        	inc iy ;++
739   834C              	;записать в таблицу (индекс)
740   834C DD E5        	push ix
741   834E C1           	pop bc
742   834F 71           	ld (hl),c
743   8350 23           	inc hl
744   8351 70           	ld (hl),b
745   8352 23           	inc hl
746   8353
747   8353
748   8353              sort_dir_one_skip
749   8353 01 20 00     	ld bc,32
750   8356 DD 09        	add ix,bc ;на следующий
751   8358 DD 7C        	ld a,ixh ;проверка на конец буфера
752   835A FE C0        	cp #c0
753   835C 30 B3        	jr nc,sort_dir_one_cl
754   835E
755   835E              sort_dir_one_ex
756   835E FD 22 E9 86  	ld (file_r_all),iy
757   8362 C9           	ret
758   8363
759   8363
760   8363
761   8363
762   8363
763   8363
764   8363
765   8363              sort_toggle ;переключение сортировки
766   8363 3A 80 83     	ld a,(sort_enable_flag)
767   8366 EE 01        	xor 1
768   8368 32 80 83     	ld (sort_enable_flag),a
769   836B 3E 4E        	ld a,"N" ;вкл
770   836D 20 02        	jr nz,sort_toggle1
771   836F 3E 66        	ld a,"f";выкл
772   8371              sort_toggle1
773   8371 32 90 89     	ld (msg_menu_main2+6),a
774   8374
775   8374 CD 50 82     	call sort_dir
776   8377 CD EB 83     	call print_menu_main
777   837A CD B3 81     	call print_panel_r
778   837D
779   837D C3 56 80     	jp nc_wait
780   8380 00           sort_enable_flag db 0 ;флаг сортировки
781   8381
782   8381
783   8381
784   8381              format_name ;подогнать имя под стандарт filename.ext
785   8381              ;вх: HL - имя в каталоге
786   8381 E5           	push hl
787   8382 21 ED 86     	ld hl,file_name_cur
788   8385 11 EE 86     	ld de,file_name_cur+1 ;почистить
789   8388 01 FF 00     	ld bc,256-1
790   838B 36 00        	ld (hl),0
791   838D ED B0        	ldir
792   838F
793   838F E1           	pop hl
794   8390 E5           	push hl
795   8391
796   8391 11 ED 86     	ld de,file_name_cur ;куда
797   8394 01 FF 08     	ld bc,#08ff
798   8397              format_name_cl
799   8397 7E           	ld a,(hl)
800   8398 FE 21        	cp " "+1
801   839A 38 04        	jr c,format_name_skip
802   839C ED A0        	ldi
803   839E 10 F7        	djnz format_name_cl
804   83A0              format_name_skip
805   83A0 3E 2E        	ld a,"."
806   83A2 12           	ld (de),a
807   83A3
808   83A3 13           	inc de
809   83A4 E1           	pop hl
810   83A5 01 08 00     	ld bc,8 ;перейти на расширение
811   83A8 09           	add hl,bc
812   83A9
813   83A9 01 FF 03     	ld bc,#03ff
814   83AC              format_name_cl2
815   83AC 7E           	ld a,(hl)
816   83AD FE 21        	cp " "+1
817   83AF 38 04        	jr c,format_name_skip2
818   83B1 ED A0        	ldi
819   83B3 10 F7        	djnz format_name_cl2
820   83B5              format_name_skip2
821   83B5 C9           	ret
822   83B6
823   83B6              print_rect_r ;печать рамки правой
824   83B6 3E 0F        	ld a,color_backgr ;цвет
825   83B8 06 0C        	ld b,#c
826   83BA              	OS_SET_COLOR
826   83BA 0E 06       >    ld c,#06
826   83BC E7          >    rst #20
827   83BD 11 28 00     	ld de,#0028 ;xy
828   83C0              	OS_SET_XY
828   83C0 0E 01       >    ld c,#01
828   83C2 E7          >    rst #20
829   83C3 21 0F 89     	ld hl,rect_1
830   83C6              	OS_PRINTZ
830   83C6 0E 09       >    ld c,#09
830   83C8 E7          >    rst #20
831   83C9
832   83C9 11 28 01     	ld de,#0128 ;xy
833   83CC 06 16        	ld b,24-2 ;цикл
834   83CE              print_rect_r_cl
835   83CE C5           	push bc
836   83CF D5           	push de
837   83D0              	OS_SET_XY
837   83D0 0E 01       >    ld c,#01
837   83D2 E7          >    rst #20
838   83D3 21 38 89     	ld hl,rect_2
839   83D6              	OS_PRINTZ
839   83D6 0E 09       >    ld c,#09
839   83D8 E7          >    rst #20
840   83D9 D1           	pop de
841   83DA 14           	inc d
842   83DB C1           	pop bc
843   83DC 10 F0        	djnz print_rect_r_cl
844   83DE
845   83DE
846   83DE 11 28 17     	ld de,#1728 ;xy
847   83E1              	OS_SET_XY
847   83E1 0E 01       >    ld c,#01
847   83E3 E7          >    rst #20
848   83E4 21 61 89     	ld hl,rect_3
849   83E7              	OS_PRINTZ
849   83E7 0E 09       >    ld c,#09
849   83E9 E7          >    rst #20
850   83EA C9           	ret
851   83EB
852   83EB              print_menu_main ;печать основного меню
853   83EB 3E 28        	ld a,color_backgr_hi ;цвет
854   83ED 06 0C        	ld b,#c
855   83EF              	OS_SET_COLOR
855   83EF 0E 06       >    ld c,#06
855   83F1 E7          >    rst #20
856   83F2 11 10 18     	ld de,#1800+2*8
857   83F5              	OS_SET_XY
857   83F5 0E 01       >    ld c,#01
857   83F7 E7          >    rst #20
858   83F8 21 8A 89     	ld hl,msg_menu_main2
859   83FB              	OS_PRINTZ
859   83FB 0E 09       >    ld c,#09
859   83FD E7          >    rst #20
860   83FE 11 18 18     	ld de,#1800+3*8
861   8401              	OS_SET_XY
861   8401 0E 01       >    ld c,#01
861   8403 E7          >    rst #20
862   8404 21 92 89     	ld hl,msg_menu_main3
863   8407              	OS_PRINTZ
863   8407 0E 09       >    ld c,#09
863   8409 E7          >    rst #20
864   840A C9           	ret
865   840B
866   840B
867   840B              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
  1+  840B              view_file
  2+  840B              	;просмотр файла как текста
  3+  840B
  4+  840B 2A E9 86     	ld hl,(file_r_all)
  5+  840E 7D           	ld a,l
  6+  840F B4           	or h
  7+  8410 CA DD 84     	jp z,view_file_ex ;защита
  8+  8413 2A 07 89     	ld hl,(file_r_num_cur)
  9+  8416 CD FA 80     	call calc_deskr
 10+  8419 DD 7E 0B     	ld a,(ix+#0b)
 11+  841C FE 10        	cp #10 ;признак каталога
 12+  841E CA DD 84     	jp z,view_file_ex
 13+  8421
 14+  8421 CD 81 83     	call format_name ;обработать имя файла
 15+  8424
 16+  8424
 17+  8424
 18+  8424              	OS_CLS ;почистить экран
 18+  8424 0E 00       >    ld c,#00
 18+  8426 E7          >    rst #20
 19+  8427
 20+  8427              	;обнулить переменные
 21+  8427 AF           	xor a
 22+  8428 32 E6 86     	ld (view_file_load_all),a ;флаг что файл весь прочитан
 23+  842B              	;ld (view_file_bot_flag),a  ;
 24+  842B 21 FF FF     	ld hl,#ffff
 25+  842E 22 E7 86     	ld (view_file_end),hl ;конец файла тут
 26+  8431 23           	inc hl
 27+  8432 22 DE 86     	ld (view_move_right_val),hl
 28+  8435
 29+  8435 C5           	push bc
 30+  8436 CD A3 80     	call clear_buf
 31+  8439 C1           	pop bc
 32+  843A
 33+  843A 21 ED 86     	ld hl,file_name_cur		;строка с именем
 34+  843D              	OS_FILE_OPEN
 34+  843D 0E 21       >    ld c,#21
 34+  843F E7          >    rst #20
 35+  8440 30 0E        	jr nc,view_file_open_ok
 36+  8442              view_file_file_error
 37+  8442 21 99 89     	ld hl,msg_file_error
 38+  8445              	OS_PRINTZ
 38+  8445 0E 09       >    ld c,#09
 38+  8447 E7          >    rst #20
 39+  8448 06 64        	ld b,2*50
 40+  844A CD 9F 80     	call delay1
 41+  844D C3 D7 84     	jp view_file_wait_ex
 42+  8450
 43+  8450              view_file_open_ok
 44+  8450 32 0A 89     	ld (file_id_cur_r),a
 45+  8453              	;проверка длины файла не больше #4000
 46+  8453 7A           	ld	a,d ;самые старшие байты длины
 47+  8454 B3           	or e
 48+  8455 28 11        	jr z,view_file_size_ok ;если не слищком большой
 49+  8457              view_file_too_big
 50+  8457              	;файл больше буфера
 51+  8457 11 00 40     	ld de,#4000 ;размер одной первой части
 52+  845A 21 00 C0     	ld hl,buffer_cat
 53+  845D 3A 0A 89     	ld a,(file_id_cur_r)
 54+  8460              	OS_FILE_READ ;загрузить
 54+  8460 0E 23       >    ld c,#23
 54+  8462 E7          >    rst #20
 55+  8463 38 DD        	jr c,view_file_file_error
 56+  8465
 57+  8465 C3 91 84     	jp view_file_readed
 58+  8468
 59+  8468              view_file_size_ok
 60+  8468 78           	ld	a,b ;младший старший байт длины
 61+  8469 FE 40        	cp #40
 62+  846B 38 06        	jr c,view_file_size_ok_small
 63+  846D 20 E8        	jr nz,view_file_too_big
 64+  846F 0C           	inc c
 65+  8470 0D           	dec c
 66+  8471 20 E4        	jr nz,view_file_too_big
 67+  8473
 68+  8473
 69+  8473              view_file_size_ok_small
 70+  8473              	;проверка на 0
 71+  8473 78           	ld a,b
 72+  8474 B1           	or c
 73+  8475 CA 42 84     	jp z,view_file_file_error
 74+  8478              	;узнать где конец файла
 75+  8478 21 00 C0     	ld hl,buffer_cat
 76+  847B 09           	add hl,bc
 77+  847C 22 E7 86     	ld (view_file_end),hl ;конец файла тут
 78+  847F              	;размер не большой, прочитаем
 79+  847F 50           	ld d,b ;размер
 80+  8480 59           	ld e,c
 81+  8481 21 00 C0     	ld hl,buffer_cat
 82+  8484 3A 0A 89     	ld a,(file_id_cur_r)
 83+  8487              	OS_FILE_READ ;загрузить
 83+  8487 0E 23       >    ld c,#23
 83+  8489 E7          >    rst #20
 84+  848A 38 B6        	jr c,view_file_file_error
 85+  848C
 86+  848C 3E 01        	ld a,1
 87+  848E 32 E6 86     	ld (view_file_load_all),a ;флаг что файл весь прочитан
 88+  8491
 89+  8491              view_file_readed
 90+  8491              	;файл прочитан
 91+  8491
 92+  8491 21 00 C0     	ld hl,buffer_cat
 93+  8494 22 E0 86     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
 94+  8497 22 E2 86     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
 95+  849A
 96+  849A CD 9C 85     	call print_file_text
 97+  849D
 98+  849D
 99+  849D CD 67 85     	call print_menu_view ;меню
100+  84A0 CD 82 85     	call print_menu_view_top ;инфо
101+  84A3
102+  84A3 CD B1 80     	call release_key
103+  84A6
104+  84A6              view_file_wait ;цикл ожидания клавиши
105+  84A6              	OS_WAIT
105+  84A6 DF          >	rst #18
106+  84A7              	OS_GET_CHAR
106+  84A7 0E 10       >    ld c,#10
106+  84A9 E7          >    rst #20
107+  84AA FE FF        	cp 255
108+  84AC 28 F8        	jr z,view_file_wait
109+  84AE FE 33        	cp "3"
110+  84B0 28 25        	jr z,view_file_wait_ex
111+  84B2 FE 0A        	cp 10 ;вниз
112+  84B4 CA E0 84     	jp z,view_line_down
113+  84B7 FE 0B        	cp 11 ;вверх
114+  84B9 CA F6 84     	jp z,view_line_up
115+  84BC FE 09        	cp 09 ;вправо
116+  84BE CA 0C 85     	jp z,view_right
117+  84C1 FE 08        	cp 08 ;влево
118+  84C3 CA 1C 85     	jp z,view_left
119+  84C6 FE 04        	cp 04 ;страница вверх
120+  84C8 CA 2D 85     	jp z,view_page_up
121+  84CB FE 05        	cp 05 ;страница вниз
122+  84CD CA 4A 85     	jp z,view_page_down
123+  84D0 FE 18        	cp 24 ;break
124+  84D2 CA 9B 81     	jp z,exit
125+  84D5 18 CF        	jr view_file_wait
126+  84D7
127+  84D7              view_file_wait_ex
128+  84D7              	;почистить экран
129+  84D7              	OS_CLS
129+  84D7 0E 00       >    ld c,#00
129+  84D9 E7          >    rst #20
130+  84DA C3 23 80     	jp start_nc_warm ;перезагрузить папку
131+  84DD
132+  84DD              view_file_ex
133+  84DD C3 56 80     	jp nc_wait
134+  84E0
135+  84E0
136+  84E0
137+  84E0              view_line_down ;вниз на строчку
138+  84E0 2A E2 86     	ld hl,(view_file_pos_cur_focus) ;фокус
139+  84E3 22 E0 86     	ld (view_file_pos_cur),hl
140+  84E6 CD B1 86     	call next_line ;вперёд на строку
141+  84E9 38 BB        	jr c,view_file_wait ;если не удачно
142+  84EB 2A E0 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
143+  84EE 22 E2 86     	ld (view_file_pos_cur_focus),hl
144+  84F1 CD 9C 85     	call print_file_text ;напечатать всю страницу
145+  84F4 18 B0        	jr view_file_wait
146+  84F6
147+  84F6              view_line_up ;вверх на строчку
148+  84F6 2A E2 86     	ld hl,(view_file_pos_cur_focus) ;фокус
149+  84F9 22 E0 86     	ld (view_file_pos_cur),hl
150+  84FC CD BF 86     	call prev_line ;
151+  84FF 38 A5        	jr c,view_file_wait ;если не удачно
152+  8501 2A E0 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
153+  8504 22 E2 86     	ld (view_file_pos_cur_focus),hl
154+  8507 CD 9C 85     	call print_file_text ;напечатать всю страницу
155+  850A 18 9A        	jr view_file_wait
156+  850C
157+  850C
158+  850C              view_right ;вправо
159+  850C 2A DE 86     	ld hl,(view_move_right_val)
160+  850F 23           	inc hl
161+  8510 7C           	ld a,h
162+  8511 B5           	or l
163+  8512 28 92        	jr z,view_file_wait
164+  8514 22 DE 86     	ld (view_move_right_val),hl
165+  8517 CD 9C 85     	call print_file_text ;напечатать всю страницу
166+  851A 18 8A        	jr view_file_wait
167+  851C
168+  851C              view_left ;влево
169+  851C 2A DE 86     	ld hl,(view_move_right_val)
170+  851F 7C           	ld a,h
171+  8520 B5           	or l
172+  8521 28 83        	jr z,view_file_wait
173+  8523 2B           	dec hl
174+  8524 22 DE 86     	ld (view_move_right_val),hl
175+  8527 CD 9C 85     	call print_file_text ;напечатать всю страницу
176+  852A C3 A6 84     	jp view_file_wait
177+  852D
178+  852D
179+  852D
180+  852D              view_page_up ;на страницу назад
181+  852D 2A E2 86     	ld hl,(view_file_pos_cur_focus) ;фокус
182+  8530 22 E0 86     	ld (view_file_pos_cur),hl
183+  8533 06 16        	ld b,view_text_bot-2
184+  8535              view_page_up_cl
185+  8535 CD BF 86     	call prev_line ;
186+  8538 38 04        	jr c,view_page_up_ex ;если не удачно
187+  853A 28 02        	jr z,view_page_up_ex
188+  853C 10 F7        	djnz view_page_up_cl
189+  853E              view_page_up_ex
190+  853E 2A E0 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
191+  8541 22 E2 86     	ld (view_file_pos_cur_focus),hl
192+  8544 CD 9C 85     	call print_file_text ;напечатать всю страницу
193+  8547 C3 A6 84     	jp view_file_wait
194+  854A
195+  854A
196+  854A
197+  854A              view_page_down ;на страницу вперёд
198+  854A 2A E2 86     	ld hl,(view_file_pos_cur_focus) ;фокус
199+  854D 22 E0 86     	ld (view_file_pos_cur),hl
200+  8550 06 16        	ld b,view_text_bot-2
201+  8552              view_page_down_cl
202+  8552 CD B1 86     	call next_line ;
203+  8555 38 04        	jr c,view_page_down_ex ;если не удачно
204+  8557 28 02        	jr z,view_page_down_ex
205+  8559 10 F7        	djnz view_page_down_cl
206+  855B              view_page_down_ex
207+  855B 2A E0 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
208+  855E 22 E2 86     	ld (view_file_pos_cur_focus),hl
209+  8561 CD 9C 85     	call print_file_text ;напечатать всю страницу
210+  8564 C3 A6 84     	jp view_file_wait
211+  8567
212+  8567
213+  8567
214+  8567              print_menu_view ;печать меню просмотрщика
215+  8567 3E 18        	ld a,#18
216+  8569 06 28        	ld b,color_backgr_hi ;цвет
217+  856B              	OS_PAINT_LINE ;линия внизу
217+  856B 0E 04       >    ld c,#04
217+  856D E7          >    rst #20
218+  856E 3E 28        	ld a,color_backgr_hi ;цвет
219+  8570 06 0C        	ld b,#c
220+  8572              	OS_SET_COLOR
220+  8572 0E 06       >    ld c,#06
220+  8574 E7          >    rst #20
221+  8575 11 18 18     	ld de,#1800+3*8
222+  8578              	OS_SET_XY
222+  8578 0E 01       >    ld c,#01
222+  857A E7          >    rst #20
223+  857B 21 D7 86     	ld hl,msg_menu_view
224+  857E              	OS_PRINTZ
224+  857E 0E 09       >    ld c,#09
224+  8580 E7          >    rst #20
225+  8581 C9           	ret
226+  8582
227+  8582              print_menu_view_top ;печать меню просмотрщика верхнее
228+  8582 AF           	xor a
229+  8583 06 28        	ld b,color_backgr_hi ;цвет
230+  8585              	OS_PAINT_LINE ;линия вверху
230+  8585 0E 04       >    ld c,#04
230+  8587 E7          >    rst #20
231+  8588 3E 28        	ld a,color_backgr_hi ;цвет
232+  858A 06 0C        	ld b,#c
233+  858C              	OS_SET_COLOR
233+  858C 0E 06       >    ld c,#06
233+  858E E7          >    rst #20
234+  858F 11 24 00     	ld de,#0024
235+  8592              	OS_SET_XY
235+  8592 0E 01       >    ld c,#01
235+  8594 E7          >    rst #20
236+  8595 21 ED 86     	ld hl,file_name_cur
237+  8598              	OS_PRINTZ
237+  8598 0E 09       >    ld c,#09
237+  859A E7          >    rst #20
238+  859B C9           	ret
239+  859C
240+  859C
241+  859C
242+  859C              print_file_text	;печать текущей части файла в консоль
243+  859C 3E 04        	ld a,4 ;цвет
244+  859E 06 0C        	ld b,#c
245+  85A0              	OS_SET_COLOR
245+  85A0 0E 06       >    ld c,#06
245+  85A2 E7          >    rst #20
246+  85A3
247+  85A3 3E 01        	ld a,view_text_top ;первая строка
248+  85A5 32 E4 86     	ld (view_file_y_cur),a
249+  85A8 2A E2 86     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
250+  85AB 22 E0 86     	ld (view_file_pos_cur),hl
251+  85AE              print_file_text_cl
252+  85AE 2A E0 86     	ld hl,(view_file_pos_cur)
253+  85B1 CD D7 85     	call print_line_text
254+  85B4 38 0C        	jr c,print_file_text_ex
255+  85B6
256+  85B6              	; call next_line ;найти следующую строку
257+  85B6              	; ret c
258+  85B6
259+  85B6 3A E4 86     	ld a,(view_file_y_cur)
260+  85B9 3C           	inc a
261+  85BA 32 E4 86     	ld (view_file_y_cur),a
262+  85BD FE 18        	cp view_text_bot
263+  85BF 38 ED        	jr c,print_file_text_cl
264+  85C1 C9           	ret
265+  85C2
266+  85C2              print_file_text_ex
267+  85C2              	;тут очистить остальные строки
268+  85C2 3A E4 86     	ld a,(view_file_y_cur)
269+  85C5 FE 18        	cp view_text_bot
270+  85C7 30 0C        	jr nc,print_file_text_ex2
271+  85C9 67           	ld h,a
272+  85CA 3C           	inc a
273+  85CB 32 E4 86     	ld (view_file_y_cur),a
274+  85CE 3E 20        	ld a," "
275+  85D0              	OS_FILL_LINE ;очистить строку
275+  85D0 0E 03       >    ld c,#03
275+  85D2 E7          >    rst #20
276+  85D3 18 ED        	jr print_file_text_ex
277+  85D5              print_file_text_ex2
278+  85D5 37           	scf
279+  85D6 C9           	ret
280+  85D7
281+  85D7
282+  85D7
283+  85D7              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
284+  85D7              ;вх: hl - адрес строки
285+  85D7 CD 1B 86     	call view_move_right ;промотать направо. если надо
286+  85DA              	;установить позицию
287+  85DA 3A E4 86     	ld a,(view_file_y_cur)
288+  85DD 57           	ld d,a
289+  85DE AF           	xor a
290+  85DF 32 E5 86     	ld (view_file_x_cur),a
291+  85E2 5F           	ld e,a
292+  85E3              	OS_SET_XY 	;yx
292+  85E3 0E 01       >    ld c,#01
292+  85E5 E7          >    rst #20
293+  85E6              print_line_text_cl ;цикл
294+  85E6
295+  85E6 7E           	ld a,(hl)
296+  85E7 FE 0A        	cp 10 ;этот код не печатаем
297+  85E9 28 14        	jr z,print_line_text_skip
298+  85EB FE FF        	cp #ff ;этот код не печатаем
299+  85ED 28 10        	jr z,print_line_text_skip
300+  85EF FE 0D        	cp 13
301+  85F1 28 12        	jr z,print_line_text_ex_ok
302+  85F3              	OS_PRINT_CHARF ;печать
302+  85F3 D7          >	rst #10
303+  85F4
304+  85F4              	;на следующую позицию
305+  85F4 3A E5 86     	ld a,(view_file_x_cur)
306+  85F7 3C           	inc a
307+  85F8 FE 50        	cp 80 ;правый край экрана
308+  85FA 32 E5 86     	ld (view_file_x_cur),a
309+  85FD 30 18        	jr nc,print_line_text_right ;дошли до правого края
310+  85FF
311+  85FF              print_line_text_skip
312+  85FF CD 53 86     	call view_file_next_pos ;следующий
313+  8602 30 E2        	jr nc,print_line_text_cl ;на следующий символ
314+  8604 C9           	ret
315+  8605
316+  8605
317+  8605              print_line_text_ex_ok ;выход норма
318+  8605              	;тут надо добить строку пробелами
319+  8605 3E 20        	ld a," "
320+  8607              	OS_PRINT_CHARF ;печать
320+  8607 D7          >	rst #10
321+  8608 3A E5 86     	ld a,(view_file_x_cur)
322+  860B 3C           	inc a
323+  860C FE 50        	cp 80 ;правый край экрана
324+  860E 32 E5 86     	ld (view_file_x_cur),a
325+  8611 38 F2        	jr c,print_line_text_ex_ok
326+  8613
327+  8613
328+  8613 CD 53 86     	call view_file_next_pos ;следующий
329+  8616
330+  8616 C9           	ret
331+  8617              ; print_line_text_ex_end ;выход если кончился файл
332+  8617              	; scf
333+  8617              	; ret
334+  8617
335+  8617              print_line_text_right
336+  8617 CD B1 86     	call next_line ;позицию  до конца строки
337+  861A C9           	ret
338+  861B
339+  861B
340+  861B
341+  861B              view_move_right ;перемотка строки направо
342+  861B ED 4B DE 86  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
343+  861F 78           	ld a,b
344+  8620 B1           	or c
345+  8621 C8           	ret z
346+  8622 2A E0 86     	ld hl,(view_file_pos_cur)
347+  8625              view_move_right1
348+  8625 7E           	ld a,(hl)
349+  8626 FE 0A        	cp 10 ;этот код пропускаем
350+  8628 20 07        	jr nz,view_move_right2
351+  862A CD 53 86     	call view_file_next_pos
352+  862D D8           	ret c
353+  862E C8           	ret z
354+  862F 18 F4        	jr view_move_right1
355+  8631              view_move_right2
356+  8631 FE FF        	cp #ff ;этот код пропускаем
357+  8633 20 07        	jr nz,view_move_right3
358+  8635 CD 53 86     	call view_file_next_pos
359+  8638 D8           	ret c
360+  8639 C8           	ret z
361+  863A 18 E9        	jr view_move_right1
362+  863C              view_move_right3
363+  863C 7E           	ld a,(hl)
364+  863D FE 0D        	cp 13 ;
365+  863F C8           	ret z
366+  8640              view_move_right_cl
367+  8640 CD 53 86     	call view_file_next_pos
368+  8643 D8           	ret c
369+  8644 C8           	ret z
370+  8645 7E           	ld a,(hl)
371+  8646 FE 0D        	cp 13
372+  8648 C8           	ret z
373+  8649 FE 0A        	cp 10 ;этот код пропускаем
374+  864B 28 F3        	jr z,view_move_right_cl
375+  864D 0B           	dec bc
376+  864E 78           	ld a,b
377+  864F B1           	or c
378+  8650 20 EE        	jr nz,view_move_right_cl
379+  8652              	;call view_file_next_pos ;следующий
380+  8652 C9           	ret
381+  8653
382+  8653
383+  8653
384+  8653              ;получение следующей позиции
385+  8653              view_file_next_pos
386+  8653 3A E6 86     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
387+  8656 B7           	or a
388+  8657 28 14        	jr z,view_file_next_pos_big
389+  8659              	;если текст не большой
390+  8659 2A E7 86     	ld hl,(view_file_end) ;конец текста известен
391+  865C ED 5B E0 86  	ld de,(view_file_pos_cur)
392+  8660 13           	inc de ;вперёд
393+  8661 A7           	and a
394+  8662 ED 52        	sbc hl,de
395+  8664 38 15        	jr c,view_file_next_pos_end
396+  8666 ED 53 E0 86  	ld (view_file_pos_cur),de
397+  866A EB           	ex de,hl ;на выходе адрес в HL
398+  866B B7           	or a
399+  866C C9           	ret
400+  866D
401+  866D
402+  866D
403+  866D              view_file_next_pos_big
404+  866D              	;если текст большой
405+  866D 2A E0 86     	ld hl,(view_file_pos_cur)	;текущая позиция
406+  8670 23           	inc hl ;вперёд
407+  8671 7C           	ld a,h
408+  8672 FE C0        	cp #c0 ;если вышли за пределы окна
409+  8674 38 05        	jr c,view_file_next_pos_end
410+  8676 22 E0 86     	ld (view_file_pos_cur),hl
411+  8679 B7           	or a
412+  867A C9           	ret
413+  867B
414+  867B              view_file_next_pos_end
415+  867B              	;не смогли шагнуть вперёд
416+  867B              	; ld a,1 ;флаг что внизу
417+  867B              	; ld (view_file_bot_flag),a
418+  867B 37           	scf ;ошибка
419+  867C C9           	ret
420+  867D
421+  867D
422+  867D
423+  867D
424+  867D
425+  867D
426+  867D              ;получение предыдущей позиции
427+  867D              view_file_prev_pos
428+  867D 3A E6 86     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
429+  8680 B7           	or a
430+  8681 28 1E        	jr z,view_file_prev_pos_big
431+  8683              	;если текст не большой
432+  8683 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
433+  8686 ED 5B E0 86  	ld de,(view_file_pos_cur) ;текущая позиция
434+  868A 1B           	dec de ;назад
435+  868B A7           	and a
436+  868C ED 52        	sbc hl,de
437+  868E 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
438+  8690 30 1D        	jr nc,view_file_prev_pos_end
439+  8692              	;можно шагнуть назад
440+  8692 ED 53 E0 86  	ld (view_file_pos_cur),de
441+  8696 EB           	ex de,hl ;на выходе адрес в HL
442+  8697 AF           	xor a
443+  8698 3C           	inc a ;a=1
444+  8699 C9           	ret
445+  869A              view_file_prev_pos_top
446+  869A              	;если в начале
447+  869A ED 53 E0 86  	ld (view_file_pos_cur),de
448+  869E EB           	ex de,hl ;на выходе адрес в HL
449+  869F AF           	xor a ;a=0
450+  86A0 C9           	ret
451+  86A1
452+  86A1
453+  86A1              view_file_prev_pos_big
454+  86A1              	;если текст большой
455+  86A1 2A E0 86     	ld hl,(view_file_pos_cur)	;текущая позиция
456+  86A4 2B           	dec hl ;назад
457+  86A5 7C           	ld a,h
458+  86A6 FE C0        	cp #c0 ;если вышли за пределы окна
459+  86A8 38 05        	jr c,view_file_prev_pos_end
460+  86AA 22 E0 86     	ld (view_file_pos_cur),hl
461+  86AD B7           	or a
462+  86AE C9           	ret
463+  86AF
464+  86AF              view_file_prev_pos_end
465+  86AF              	;не смогли шагнуть назад
466+  86AF              	; ld hl,buffer_cat ;тут лежит текст
467+  86AF              	; ld (view_file_pos_cur),hl ;текущая позиция в самом начале
468+  86AF 37           	scf ;ошибка
469+  86B0 C9           	ret
470+  86B1
471+  86B1
472+  86B1
473+  86B1
474+  86B1              next_line ;поиск следующей строки
475+  86B1 CD 53 86     	call view_file_next_pos
476+  86B4 D8           	ret c
477+  86B5 C8           	ret z
478+  86B6 7E           	ld a,(hl)
479+  86B7 FE 0D        	cp 13
480+  86B9 20 F6        	jr nz,next_line
481+  86BB CD 53 86     	call view_file_next_pos ;ещё на символ
482+  86BE C9           	ret
483+  86BF
484+  86BF
485+  86BF
486+  86BF              prev_line ;поиск предыдущей строки
487+  86BF              	;сначала в конец предыдущей
488+  86BF CD 7D 86     	call view_file_prev_pos
489+  86C2 C8           	ret z
490+  86C3 D8           	ret c
491+  86C4 7E           	ld a,(hl)
492+  86C5 FE 0D        	cp 13
493+  86C7 20 F6        	jr nz,prev_line
494+  86C9              	;теперь в начало предыдущей
495+  86C9              prev_line1
496+  86C9 CD 7D 86     	call view_file_prev_pos
497+  86CC C8           	ret z
498+  86CD D8           	ret c
499+  86CE 7E           	ld a,(hl)
500+  86CF FE 0D        	cp 13
501+  86D1 20 F6        	jr nz,prev_line1
502+  86D3 CD 53 86     	call view_file_next_pos ;ещё на символ обратно
503+  86D6 C9           	ret
504+  86D7
505+  86D7
506+  86D7
507+  86D7              view_text_bot equ 24 ;последняя строка для печати
508+  86D7              view_text_top equ 1 ;первая строка
509+  86D7              view_text_lines equ 25-2 ;видимых строк на экране
510+  86D7
511+  86D7              msg_menu_view
512+  86D7 33 20 45 78  	db "3 Exit",0
512+  86DB 69 74 00
513+  86DE
514+  86DE              ;view_file_position ds 4 ;текущая позиция в файле
515+  86DE              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
516+  86DE 00 00        view_move_right_val dw 0 ;сдвиг вправо
517+  86E0 00 00        view_file_pos_cur dw 0;текущая позиция
518+  86E2 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
519+  86E4 00           view_file_y_cur db 0;текущая строка
520+  86E5 00           view_file_x_cur db 0;текущий столбец
521+  86E6 00           view_file_load_all db 0 ;флаг что файл весь загружен
522+  86E7 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
523+  86E9
524+  86E9
# file closed: nc_view.asm
868   86E9
869   86E9
870   86E9              color_backgr equ 1*8+7 ;цвет фона
871   86E9              color_apg equ 1*8+4 ;цвет приложений
872   86E9              color_dir equ 1*8+6 ;цвет папок
873   86E9
874   86E9              color_backgr_hi equ 5*8+0 ;цвет фона курсор
875   86E9              color_apg_hi equ 5*8+0 ;цвет приложений курсор
876   86E9              color_dir_hi equ 5*8+0 ;цвет папок курсор
877   86E9
878   86E9              file_info_lenght equ 11 ;длина инфо о файле
879   86E9              panel_hight equ 22;высота панели
880   86E9              panel_r_xy equ #0129
881   86E9              buffer_cat equ #c000 ;адрес буфера каталога
882   86E9
883   86E9 00 00        file_r_all dw 0;всего файлов справа
884   86EB 00 00        file_r_cur_focus dw 0;первый видимый
885   86ED 00 00 00...  file_name_cur ds 256 ;имя файла текущее
886   87ED 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
887   88ED 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
888   88F9 20 20 20 20  file_info_clear db "            ",0 ;для очистки
888   88FD 20 20 20 20
888   8901 20 20 20 20
888   8905 00
889   8906 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
890   8907
891   8907 00 00        file_r_num_cur dw 0 ;текущий файл справа
892   8909 00           key_pressed db 0 ;последняя клавиша
893   890A 00           file_id_cur_r db 0 ;id файла справа
894   890B
895   890B
896   890B 00           page_ext01 db 0 ;номер дополнительной страницы
897   890C 00 00        page_main dw 0 ;основные номера страниц слота 2,3
898   890E 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
899   890F
900   890F              rect_1
901   890F C9           	db #c9
902   8910              	dup 40-2
903   8910 CD          >	db #cd
903   8911 CD          >	db #cd
903   8912 CD          >	db #cd
903   8913 CD          >	db #cd
903   8914 CD          >	db #cd
903   8915 CD          >	db #cd
903   8916 CD          >	db #cd
903   8917 CD          >	db #cd
903   8918 CD          >	db #cd
903   8919 CD          >	db #cd
903   891A CD          >	db #cd
903   891B CD          >	db #cd
903   891C CD          >	db #cd
903   891D CD          >	db #cd
903   891E CD          >	db #cd
903   891F CD          >	db #cd
903   8920 CD          >	db #cd
903   8921 CD          >	db #cd
903   8922 CD          >	db #cd
903   8923 CD          >	db #cd
903   8924 CD          >	db #cd
903   8925 CD          >	db #cd
903   8926 CD          >	db #cd
903   8927 CD          >	db #cd
903   8928 CD          >	db #cd
903   8929 CD          >	db #cd
903   892A CD          >	db #cd
903   892B CD          >	db #cd
903   892C CD          >	db #cd
903   892D CD          >	db #cd
903   892E CD          >	db #cd
903   892F CD          >	db #cd
903   8930 CD          >	db #cd
903   8931 CD          >	db #cd
903   8932 CD          >	db #cd
903   8933 CD          >	db #cd
903   8934 CD          >	db #cd
903   8935 CD          >	db #cd
904   8936              	edup
905   8936 BB 00        	db #bb,0
906   8938
907   8938              rect_2
908   8938 BA           	db #ba
909   8939              	dup 40-2
910   8939 20          >	db " "
910   893A 20          >	db " "
910   893B 20          >	db " "
910   893C 20          >	db " "
910   893D 20          >	db " "
910   893E 20          >	db " "
910   893F 20          >	db " "
910   8940 20          >	db " "
910   8941 20          >	db " "
910   8942 20          >	db " "
910   8943 20          >	db " "
910   8944 20          >	db " "
910   8945 20          >	db " "
910   8946 20          >	db " "
910   8947 20          >	db " "
910   8948 20          >	db " "
910   8949 20          >	db " "
910   894A 20          >	db " "
910   894B 20          >	db " "
910   894C 20          >	db " "
910   894D 20          >	db " "
910   894E 20          >	db " "
910   894F 20          >	db " "
910   8950 20          >	db " "
910   8951 20          >	db " "
910   8952 20          >	db " "
910   8953 20          >	db " "
910   8954 20          >	db " "
910   8955 20          >	db " "
910   8956 20          >	db " "
910   8957 20          >	db " "
910   8958 20          >	db " "
910   8959 20          >	db " "
910   895A 20          >	db " "
910   895B 20          >	db " "
910   895C 20          >	db " "
910   895D 20          >	db " "
910   895E 20          >	db " "
911   895F              	edup
912   895F BA 00        	db #ba,0
913   8961
914   8961              rect_3
915   8961 C8           	db #c8
916   8962              	dup 40-2
917   8962 CD          >	db #cd
917   8963 CD          >	db #cd
917   8964 CD          >	db #cd
917   8965 CD          >	db #cd
917   8966 CD          >	db #cd
917   8967 CD          >	db #cd
917   8968 CD          >	db #cd
917   8969 CD          >	db #cd
917   896A CD          >	db #cd
917   896B CD          >	db #cd
917   896C CD          >	db #cd
917   896D CD          >	db #cd
917   896E CD          >	db #cd
917   896F CD          >	db #cd
917   8970 CD          >	db #cd
917   8971 CD          >	db #cd
917   8972 CD          >	db #cd
917   8973 CD          >	db #cd
917   8974 CD          >	db #cd
917   8975 CD          >	db #cd
917   8976 CD          >	db #cd
917   8977 CD          >	db #cd
917   8978 CD          >	db #cd
917   8979 CD          >	db #cd
917   897A CD          >	db #cd
917   897B CD          >	db #cd
917   897C CD          >	db #cd
917   897D CD          >	db #cd
917   897E CD          >	db #cd
917   897F CD          >	db #cd
917   8980 CD          >	db #cd
917   8981 CD          >	db #cd
917   8982 CD          >	db #cd
917   8983 CD          >	db #cd
917   8984 CD          >	db #cd
917   8985 CD          >	db #cd
917   8986 CD          >	db #cd
917   8987 CD          >	db #cd
918   8988              	edup
919   8988 BC 00        	db #bc,0
920   898A
921   898A              msg_menu_main2
922   898A 32 20 41 5A  	db "2 AZ Of",0
922   898E 20 4F 66 00
923   8992              msg_menu_main3
924   8992 33 20 56 69  	db "3 View",0
924   8996 65 77 00
925   8999              msg_file_error
926   8999 46 69 6C 65  	db "File error",10,13,0
926   899D 20 65 72 72
926   89A1 6F 72 0A 0D
926   89A5 00
927   89A6              msg_file_too_big
928   89A6 46 69 6C 65  	db "File too big",10,13,0
928   89AA 20 74 6F 6F
928   89AE 20 62 69 67
928   89B2 0A 0D 00
929   89B5              msg_mem_err
930   89B5 47 65 74 20  	db "Get memory error",10,13,0
930   89B9 6D 65 6D 6F
930   89BD 72 79 20 65
930   89C1 72 72 6F 72
930   89C5 0A 0D 00
931   89C8              msg_title_nc
932   89C8 4E 6F 6E 65  	db "None Commander ver 2025.06.19",10,13,0
932   89CC 20 43 6F 6D
932   89D0 6D 61 6E 64
932   89D4 65 72 20 76
932   89D8 65 72 20 32
932   89DC 30 32 35 2E
932   89E0 30 36 2E 31
932   89E4 39 0A 0D 00
933   89E8
934   89E8              end_nc
935   89E8              ;ниже не включается в файл
936   89E8 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
937   8DE8
938   8DE8              	savebin "nc.apg",start_nc,$-start_nc
# file closed: nc.asm
