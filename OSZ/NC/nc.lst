# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000
  97+ 0000              ;включить/выключить моно режим для приложения
  98+ 0000              ;при включенном режиме разрешена запись в диапазон памяти #4000-#7fff + страницы приложения
  99+ 0000              ;вх: a = 0 - включить; a = 255 - выключить
 100+ 0000                  macro OS_SET_MONO_MODE ;
 101+ 0000 ~                ld c,#08
 102+ 0000 ~                rst #20
 103+ 0000                  endm
 104+ 0000
 105+ 0000
 106+ 0000
 107+ 0000              ;печать в консоль до кода 0
 108+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 109+ 0000 ~                ld c,#09
 110+ 0000 ~                rst #20
 111+ 0000                  endm
 112+ 0000
 113+ 0000
 114+ 0000              ;прочитать байт из порта uart
 115+ 0000              ;вх:
 116+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 117+ 0000              ;вых: A - считанный байт
 118+ 0000                  macro OS_UART_READ
 119+ 0000 ~                ld c,#0a
 120+ 0000 ~                rst #20
 121+ 0000                  endm
 122+ 0000
 123+ 0000              ;записать байт в порт uart
 124+ 0000              ;вх: A -байт
 125+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 126+ 0000                  macro OS_UART_WRITE
 127+ 0000 ~                ld c,#0b
 128+ 0000 ~                rst #20
 129+ 0000                  endm
 130+ 0000
 131+ 0000              ;закрыть соединение ESP
 132+ 0000              ;вх:
 133+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 134+ 0000                  macro OS_ESP_CLOSE
 135+ 0000 ~                ld c,#0c
 136+ 0000 ~                rst #20
 137+ 0000                  endm
 138+ 0000
 139+ 0000              ;установить соединение ESP (CIPSTART);
 140+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 141+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 142+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 143+ 0000                  macro OS_ESP_OPEN
 144+ 0000 ~                ld c,#0d
 145+ 0000 ~                rst #20
 146+ 0000                  endm
 147+ 0000
 148+ 0000              ;послать запрос ESP (CIPSEND);
 149+ 0000              ;вх: hl - адрес данных, de - длина данных
 150+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 151+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 152+ 0000                  macro OS_ESP_SEND
 153+ 0000 ~                ld c,#0e
 154+ 0000 ~                rst #20
 155+ 0000                  endm
 156+ 0000
 157+ 0000              ;получить пакет ESP (+IPD);
 158+ 0000              ;вх: hl - адрес для данных
 159+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 160+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 161+ 0000                  macro OS_ESP_GET
 162+ 0000 ~                ld c,#0f
 163+ 0000 ~                rst #20
 164+ 0000                  endm
 165+ 0000
 166+ 0000              ;ввод с консоли ----------------------
 167+ 0000
 168+ 0000              ;получить код нажатой клавиши
 169+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 170+ 0000 ~                ld c,#10
 171+ 0000 ~                rst #20
 172+ 0000                  endm
 173+ 0000
 174+ 0000
 175+ 0000              ;процессы ----------------------------
 176+ 0000
 177+ 0000              ;запустить процесс
 178+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 179+ 0000                  macro OS_PROC_RUN ;
 180+ 0000 ~                ld c,#11
 181+ 0000 ~                rst #20
 182+ 0000                  endm
 183+ 0000
 184+ 0000              ;установить фокус
 185+ 0000              ;вх: a - id процесса
 186+ 0000                  macro OS_PROC_SET_FOCUS ;
 187+ 0000 ~                ld c,#12
 188+ 0000 ~                rst #20
 189+ 0000                  endm
 190+ 0000
 191+ 0000              ;закрыть процесс
 192+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 193+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 194+ 0000                  macro OS_PROC_CLOSE ;
 195+ 0000 ~                ld c,#13
 196+ 0000 ~                rst #20
 197+ 0000                  endm
 198+ 0000
 199+ 0000
 200+ 0000              ;прерывания --------------------------
 201+ 0000
 202+ 0000              ;установка адреса обработчика прерываний процесса;
 203+ 0000              ;например, плеера музыки
 204+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 205+ 0000              ;на время выполнения включаются обе страницы процесса
 206+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 207+ 0000 ~                ld c,#14
 208+ 0000 ~                rst #20
 209+ 0000                  endm
 210+ 0000
 211+ 0000
 212+ 0000              ;плеер AY ----------------------------
 213+ 0000
 214+ 0000              ;инициализация плеера AY;
 215+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 216+ 0000 ~                ld c,#15
 217+ 0000 ~                rst #20
 218+ 0000                  endm
 219+ 0000
 220+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 221+ 0000                  macro OS_VTPL_PLAY ;()
 222+ 0000 ~                ld c,#16
 223+ 0000 ~                rst #20
 224+ 0000                  endm
 225+ 0000
 226+ 0000              ;заглушить плеер AY;
 227+ 0000                  macro OS_VTPL_MUTE ;()
 228+ 0000 ~                ld c,#17
 229+ 0000 ~                rst #20
 230+ 0000                  endm
 231+ 0000
 232+ 0000              ;получить значение переменной плеера;
 233+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 234+ 0000 ~                ld c,#18
 235+ 0000 ~                rst #20
 236+ 0000                  endm
 237+ 0000
 238+ 0000
 239+ 0000              ;прочие ------------------------------
 240+ 0000
 241+ 0000
 242+ 0000              ;скопировать данные из страницы в страницу
 243+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 244+ 0000                  macro OS_RAM_COPY
 245+ 0000 ~                ld c,#19
 246+ 0000 ~                rst #20
 247+ 0000                  endm
 248+ 0000
 249+ 0000              ;получить дополнительную страницу памяти;
 250+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 251+ 0000 ~                ld c,#1a
 252+ 0000 ~                rst #20
 253+ 0000                  endm
 254+ 0000
 255+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 256+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 257+ 0000 ~                ld c,#1b
 258+ 0000 ~                rst #20
 259+ 0000                  endm
 260+ 0000
 261+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 262+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 263+ 0000 ~                ld c,#1c
 264+ 0000 ~                rst #20
 265+ 0000                  endm
 266+ 0000
 267+ 0000              ;включить экран N;
 268+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 269+ 0000              ;переключать может только приложение в фокусе
 270+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 271+ 0000              ;при переключении процессов сохраняется только экран #39
 272+ 0000                  macro OS_SET_SCREEN ;
 273+ 0000 ~                ld c,#1d
 274+ 0000 ~                rst #20
 275+ 0000                  endm
 276+ 0000
 277+ 0000
 278+ 0000              ;получить номера страниц процесса;
 279+ 0000              ;вх:
 280+ 0000              ;вых: b, c - страницы в слотах 2, 3
 281+ 0000                  macro OS_GET_MAIN_PAGES ;
 282+ 0000 ~                ld c,#1e
 283+ 0000 ~                rst #20
 284+ 0000                  endm
 285+ 0000
 286+ 0000              ;получить значение системного таймера
 287+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 288+ 0000 ~                ld c,#1F
 289+ 0000 ~                rst #20
 290+ 0000                  endm
 291+ 0000
 292+ 0000
 293+ 0000              ;освободить страницу памяти
 294+ 0000              ;вх: a - номер страницы
 295+ 0000                  macro OS_DEL_PAGE ;
 296+ 0000 ~                ld c,#20
 297+ 0000 ~                rst #20
 298+ 0000                  endm
 299+ 0000
 300+ 0000
 301+ 0000              ;дисковые операции -------------------
 302+ 0000
 303+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 304+ 0000
 305+ 0000              ; fcbFAT (из руководства к монитору)
 306+ 0000              ; формат fcb для работы с FAT
 307+ 0000
 308+ 0000              ; +#00 8 имя файла
 309+ 0000              ; +#08 3 расширение файла
 310+ 0000              ; +#0B 1 атрибуты файла
 311+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 312+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 313+ 0000              ; +#14 4 размер файла/каталога в байтах
 314+ 0000              ; +#18 4 указатель в файле
 315+ 0000              ; +#1C 1 для внутренних нужд
 316+ 0000              ; +#1D 1 для внутренних нужд
 317+ 0000              ; +#1E 1 резерв
 318+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 319+ 0000              	; 1-0,nn номер раздела
 320+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 321+ 0000              	    ; значение %11 недопустимо
 322+ 0000
 323+ 0000              ;открыть файл для чтения или записи
 324+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 325+ 0000 ~                ld c,#21
 326+ 0000 ~                rst #20
 327+ 0000                  endm
 328+ 0000
 329+ 0000              ;создать файл
 330+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 331+ 0000 ~                ld c,#22
 332+ 0000 ~                rst #20
 333+ 0000                  endm
 334+ 0000
 335+ 0000              ;прочитать из файла
 336+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 337+ 0000 ~                ld c,#23
 338+ 0000 ~                rst #20
 339+ 0000                  endm
 340+ 0000
 341+ 0000              ;записать в файл
 342+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 343+ 0000 ~                ld c,#24
 344+ 0000 ~                rst #20
 345+ 0000                  endm
 346+ 0000
 347+ 0000              ;закрыть файл
 348+ 0000                  macro OS_FILE_CLOSE ;A - id file
 349+ 0000 ~                ld c,#25
 350+ 0000 ~                rst #20
 351+ 0000                  endm
 352+ 0000
 353+ 0000              ;чтение секторов текущего каталога
 354+ 0000              ; вх:
 355+ 0000                   ; hl - буфер для чтения
 356+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 357+ 0000                   ; b - максимальное количество секторов для чтения
 358+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 359+ 0000                     ; a=errRWnum
 360+ 0000                     ; a=errInvalidPart
 361+ 0000                     ; a=errFileEmpty
 362+ 0000                   ; cy=0, a=errEoF - каталог закончился
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b - не прочитано секторов
 366+ 0000                   ; cy=0 - считано успешно
 367+ 0000                     ; hl - следующий адрес в буфере
 368+ 0000                     ; de - номер первого непрочитанного сектора
 369+ 0000                     ; b=#00
 370+ 0000                  macro OS_DIR_READ ;
 371+ 0000 ~                ld c,#26
 372+ 0000 ~                rst #20
 373+ 0000                  endm
 374+ 0000
 375+ 0000              ;вход в каталог/выход в родительский каталог
 376+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 377+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 378+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 379+ 0000              	; переход в родительский, последнее имя в пути удалится).
 380+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 381+ 0000              	; добавится имя файла
 382+ 0000              ; вх:
 383+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 384+ 0000                   ; de - адрес дескриптора директории/файла
 385+ 0000              ; вых: a - если путь был указан, новая длина пути
 386+ 0000                  macro OS_DIR_OPEN ;
 387+ 0000 ~                ld c,#27
 388+ 0000 ~                rst #20
 389+ 0000                  endm
 390+ 0000
 391+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 392+ 0000              ;проверки на допустимость значений не производится
 393+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 394+ 0000              ;вх: A - id файла
 395+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 396+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 397+ 0000                  macro OS_FILE_POSITION ;
 398+ 0000 ~                ld c,#28
 399+ 0000 ~                rst #20
 400+ 0000                  endm
 401+ 0000
 402+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 403+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 404+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 405+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 406+ 0000                  macro OS_FIND_PATH ;
 407+ 0000 ~                ld c,#29
 408+ 0000 ~                rst #20
 409+ 0000                  endm
 410+ 0000
 411+ 0000
 412+ 0000              ; получение длинного имени файла
 413+ 0000              ;вх: hl - адрес буфера для имени
 414+ 0000              ;    de - номер записи в текущем каталоге
 415+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 416+ 0000              ; 	a - длина имени, с учетом нуля
 417+ 0000                  macro OS_GET_LFN ;
 418+ 0000 ~                ld c,#2a
 419+ 0000 ~                rst #20
 420+ 0000                  endm
 421+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROG_START
   5  8000
   6  8000              start_nc
   7  8000 21 87 A5     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 71 A4  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 55 A5     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A              get_page_error1
  24  801A CD EC 80     	call delay
  25  801D C3 46 83     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 61 A4     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023              	OS_GET_PAGE ;получить лишнюю страницу для gzip
  31  8023 0E 1A       >    ld c,#1a
  31  8025 E7          >    rst #20
  32  8026 38 EC        	jr c,get_page_error
  33  8028 32 62 A4     	ld (page_ext02_gzip),a ;запомнить
  34  802B
  35  802B 21 7C A5     	ld hl,msg_load_gzip
  36  802E              	OS_PRINTZ
  36  802E 0E 09       >    ld c,#09
  36  8030 E7          >    rst #20
  37  8031
  38  8031 3A 62 A4     	ld a,(page_ext02_gzip) ;доп страница для данных плеера
  39  8034              	OS_SET_PAGE_SLOT3
  39  8034 0E 1C       >    ld c,#1c
  39  8036 E7          >    rst #20
  40  8037
  41  8037 21 63 A4     	ld hl,gp_gzip_file_name
  42  803A CD 13 88     	call load_file
  43  803D 38 DB        	jr c,get_page_error1
  44  803F 22 6F A4     	ld (gp_gzip_file_size),hl ;запомнить размер
  45  8042
  46  8042
  47  8042 3A 71 A4     	ld a,(page_main) ;основная страница с каталогом
  48  8045              	OS_SET_PAGE_SLOT3
  48  8045 0E 1C       >    ld c,#1c
  48  8047 E7          >    rst #20
  49  8048
  50  8048              	;почистить начало истории
  51  8048 AF           	xor a ;в историю курсора , начинаем не с корневой папки
  52  8049              	; ld (file_r_num_hyst_cur),a
  53  8049 67           	ld h,a
  54  804A 6F           	ld l,a
  55  804B 22 A6 AE     	ld (file_r_num_hyst_tabl),hl
  56  804E 22 A8 AE     	ld (file_r_num_hyst_tabl+2),hl ;для корневой папки почистим
  57  8051
  58  8051 CD 83 88     	call file_r_num_hyst_add ;запись в историю с номером 1
  59  8054
  60  8054              start_nc_warm ;тёплый старт
  61  8054
  62  8054              	;очистка буфера
  63  8054 CD F2 80     	call clear_buf
  64  8057
  65  8057              	;загрузка каталога
  66  8057 21 00 C0     	ld hl,buffer_cat ;куда
  67  805A 11 00 00     	ld de,0 ;начиная с 0 сектора
  68  805D 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  69  805F              	OS_DIR_READ
  69  805F 0E 26       >    ld c,#26
  69  8061 E7          >    rst #20
  70  8062
  71  8062 21 00 00     	ld hl,0 ;обнулить переменные
  72  8065 22 46 A2     	ld (file_r_all),hl
  73  8068
  74  8068 3A 80 82     	ld a,(key_enter_dir_flag) ;надо ли обнулять позицию курсора?
  75  806B B7           	or a
  76  806C 20 09        	jr nz,start_nc_warm1
  77  806E
  78  806E 22 58 A4     	ld (file_r_num_cur),hl
  79  8071 22 5A A4     	ld (file_r_num_old),hl
  80  8074 22 48 A2     	ld (file_r_cur_focus),hl
  81  8077              start_nc_warm1
  82  8077
  83  8077
  84  8077 CD 76 85     	call sort_dir
  85  807A
  86  807A 3E 0F        	ld a,color_backgr
  87  807C 06 0C        	ld b,#c
  88  807E              	OS_SET_COLOR
  88  807E 0E 06       >    ld c,#06
  88  8080 E7          >    rst #20
  89  8081
  90  8081 CD 7B 87     	call print_rect_r ;рамка
  91  8084 CD 23 84     	call print_panel_r
  92  8087 CD B0 87     	call print_menu_main
  93  808A
  94  808A 11 00 01     	ld de,#0100
  95  808D              	OS_SET_XY
  95  808D 0E 01       >    ld c,#01
  95  808F E7          >    rst #20
  96  8090
  97  8090 21 0A A5     	ld hl,msg_menu_info
  98  8093              	OS_PRINTZ
  98  8093 0E 09       >    ld c,#09
  98  8095 E7          >    rst #20
  99  8096
 100  8096
 101  8096
 102  8096              nc_wait
 103  8096              	OS_WAIT ;ждать прерывание
 103  8096 DF          >	rst #18
 104  8097
 105  8097              	OS_GET_CHAR ;клавиша
 105  8097 0E 10       >    ld c,#10
 105  8099 E7          >    rst #20
 106  809A 32 5E A4     	ld (key_pressed),a ;запомнить
 107  809D FE 0D        	cp 13
 108  809F CA 53 81     	jp z,key_enter ;
 109  80A2 FE 0A        	cp 10 ;вниз
 110  80A4 CC 9D 82     	call z,key_down
 111  80A7 FE 0B        	cp 11 ;вверх
 112  80A9 CC E5 82     	call z,key_up
 113  80AC FE 09        	cp 09 ;вправо
 114  80AE CC 34 83     	call z,key_right
 115  80B1 FE 08        	cp 08 ;влево
 116  80B3 CC 22 83     	call z,key_left
 117  80B6 FE 04        	cp 04 ;страница вверх
 118  80B8 CC 22 83     	call z,key_left
 119  80BB FE 05        	cp 05 ;страница вниз
 120  80BD CC 34 83     	call z,key_right
 121  80C0 FE 31        	cp "1" ;переключение длинных имён (LFN)
 122  80C2 CA 29 87     	jp z,LFN_toggle
 123  80C5 FE 32        	cp "2" ;переключение сортировки
 124  80C7 CA 09 87     	jp z,sort_toggle
 125  80CA FE 33        	cp "3" ;просмотр файла
 126  80CC CA E1 88     	jp z,view_file
 127  80CF FE 34        	cp "4" ;редактор файла
 128  80D1 CA 0C 8C     	jp z,edit_file
 129  80D4 FE 19        	cp 25 ;CS+Enter
 130  80D6 CA D8 81     	jp z,nc_play_all
 131  80D9 FE 18        	cp 24 ;break
 132  80DB CA 46 83     	jp z,exit
 133  80DE
 134  80DE
 135  80DE 3A 73 A4     	ld a,(print_panel_r_flag)
 136  80E1 B7           	or a
 137  80E2 C4 23 84     	call nz,print_panel_r ;обновить каталог
 138  80E5 AF           	xor a
 139  80E6 32 73 A4     	ld (print_panel_r_flag),a
 140  80E9
 141  80E9 C3 96 80     	jp nc_wait ;на цикл ожидания
 142  80EC
 143  80EC
 144  80EC              delay ;задержка
 145  80EC 06 64        	ld b,50*2 ;
 146  80EE              delay1
 147  80EE              	OS_WAIT
 147  80EE DF          >	rst #18
 148  80EF 10 FD        	djnz delay1
 149  80F1 C9           	ret
 150  80F2
 151  80F2
 152  80F2              clear_buf
 153  80F2 21 00 C0     	ld hl,buffer_cat
 154  80F5 11 01 C0     	ld de,buffer_cat+1
 155  80F8 01 FF 3F     	ld bc,#4000-1
 156  80FB 36 00        	ld (hl),0
 157  80FD ED B0        	ldir
 158  80FF C9           	ret
 159  8100
 160  8100
 161  8100              ;очистить левую панель
 162  8100              clear_left_panel
 163  8100 3E 0F        	ld a,color_backgr ;цвет
 164  8102 06 0C        	ld b,#c
 165  8104              	OS_SET_COLOR
 165  8104 0E 06       >    ld c,#06
 165  8106 E7          >    rst #20
 166  8107 06 18        	ld b,panel_hight+2 ;высота
 167  8109 11 00 00     	ld de,0
 168  810C              	OS_SET_XY
 168  810C 0E 01       >    ld c,#01
 168  810E E7          >    rst #20
 169  810F              clear_left_panel_cl
 170  810F C5           	push bc
 171  8110 21 20 81     	ld hl,txt_clear_panel
 172  8113              	OS_PRINTZ
 172  8113 0E 09       >    ld c,#09
 172  8115 E7          >    rst #20
 173  8116 C1           	pop bc
 174  8117 10 F6        	djnz clear_left_panel_cl
 175  8119 11 00 00     	ld de,0
 176  811C              	OS_SET_XY
 176  811C 0E 01       >    ld c,#01
 176  811E E7          >    rst #20
 177  811F C9           	ret
 178  8120 20 20 20 20  txt_clear_panel db "                                        ",13,0 ;40 пробелов
 178  8124 20 20 20 20
 178  8128 20 20 20 20
 178  812C 20 20 20 20
 178  8130 20 20 20 20
 178  8134 20 20 20 20
 178  8138 20 20 20 20
 178  813C 20 20 20 20
 178  8140 20 20 20 20
 178  8144 20 20 20 20
 178  8148 0D 00
 179  814A
 180  814A
 181  814A              release_key ;ждать отпускания клавиши
 182  814A              	OS_WAIT
 182  814A DF          >	rst #18
 183  814B              	OS_GET_CHAR
 183  814B 0E 10       >    ld c,#10
 183  814D E7          >    rst #20
 184  814E FE FF        	cp 255
 185  8150 20 F8        	jr nz,release_key
 186  8152 C9           	ret
 187  8153
 188  8153
 189  8153              key_enter
 190  8153              	;нажата Enter
 191  8153 2A 46 A2     	ld hl,(file_r_all)
 192  8156 7D           	ld a,l
 193  8157 B4           	or h
 194  8158 CA D5 81     	jp z,key_enter_ex ;защита
 195  815B 2A 58 A4     	ld hl,(file_r_num_cur)
 196  815E CD 90 82     	call calc_deskr
 197  8161 DD 7E 0B     	ld a,(ix+#0b)
 198  8164 FE 10        	cp #10 ;признак каталога
 199  8166 CA 5D 82     	jp z,key_enter_dir
 200  8169
 201  8169 FE 30        	cp #30 ;признак каталога
 202  816B CA 5D 82     	jp z,key_enter_dir
 203  816E
 204  816E
 205  816E CD 46 87     	call format_name
 206  8171
 207  8171              	;проверка расширения APG
 208  8171 CD 4A 83     	call check_apg
 209  8174 C2 89 81     	jp nz,key_enter_1
 210  8177              	;тут запуск приложения
 211  8177 21 4A A2     	ld hl,file_name_cur		;строка с именем
 212  817A              	OS_PROC_RUN ;запустить прогу
 212  817A 0E 11       >    ld c,#11
 212  817C E7          >    rst #20
 213  817D              	;обработка ошибки
 214  817D DA D5 81     	jp c,key_enter_ex
 215  8180
 216  8180 DD 7E 00     	ld a,(ix)
 217  8183              	OS_PROC_SET_FOCUS ;на передний план
 217  8183 0E 12       >    ld c,#12
 217  8185 E7          >    rst #20
 218  8186 C3 D5 81     	jp key_enter_ex
 219  8189
 220  8189
 221  8189
 222  8189              key_enter_1
 223  8189              	;проверка расширения VGZ
 224  8189 CD 88 83     	call check_vgz
 225  818C C2 96 81     	jp nz,key_enter_2_1
 226  818F
 227  818F 3E 7A        	ld a,"z" ;код формата
 228  8191 CD 96 90     	call start_gplay
 229  8194
 230  8194 18 3F        	jr key_enter_ex
 231  8196
 232  8196
 233  8196              key_enter_2_1
 234  8196              	;проверка расширения VGM
 235  8196 CD 69 83     	call check_vgm
 236  8199 C2 A3 81     	jp nz,key_enter_2
 237  819C
 238  819C 3E 76        	ld a,"v" ;код формата
 239  819E CD 96 90     	call start_gplay
 240  81A1
 241  81A1 18 32        	jr key_enter_ex
 242  81A3
 243  81A3
 244  81A3              key_enter_2
 245  81A3              	;проверка расширения SCR
 246  81A3 CD A7 83     	call check_scr
 247  81A6 C2 AE 81     	jp nz,key_enter_3
 248  81A9
 249  81A9 CD E9 A1     	call display ;показать
 250  81AC
 251  81AC 18 27        	jr key_enter_ex
 252  81AE
 253  81AE
 254  81AE              key_enter_3
 255  81AE              	;проверка расширения MOD
 256  81AE CD C6 83     	call check_mod
 257  81B1 C2 BB 81     	jp nz,key_enter_4
 258  81B4
 259  81B4 3E 6D        	ld a,"m" ;код формата
 260  81B6 CD 96 90     	call start_gplay
 261  81B9
 262  81B9 18 1A        	jr key_enter_ex
 263  81BB
 264  81BB
 265  81BB              key_enter_4
 266  81BB              	;проверка расширения PT2
 267  81BB CD E5 83     	call check_pt2
 268  81BE C2 C8 81     	jp nz,key_enter_5
 269  81C1
 270  81C1 3E 32        	ld a,"2" ;код формата
 271  81C3 CD 96 90     	call start_gplay
 272  81C6
 273  81C6 18 0D        	jr key_enter_ex
 274  81C8
 275  81C8
 276  81C8              key_enter_5
 277  81C8              	;проверка расширения PT3
 278  81C8 CD 04 84     	call check_pt3
 279  81CB C2 D5 81     	jp nz,key_enter_6
 280  81CE
 281  81CE 3E 33        	ld a,"3" ;код формата
 282  81D0 CD 96 90     	call start_gplay
 283  81D3
 284  81D3 18 00        	jr key_enter_ex
 285  81D5
 286  81D5
 287  81D5
 288  81D5              key_enter_6
 289  81D5
 290  81D5
 291  81D5
 292  81D5
 293  81D5              key_enter_ex
 294  81D5 C3 96 80     	jp nc_wait
 295  81D8
 296  81D8
 297  81D8
 298  81D8
 299  81D8
 300  81D8
 301  81D8
 302  81D8              nc_play_all
 303  81D8              	;Воспроизведение всего по порядку
 304  81D8 2A 46 A2     	ld hl,(file_r_all)
 305  81DB 7D           	ld a,l
 306  81DC B4           	or h
 307  81DD CA 43 82     	jp z,nc_play_ex ;защита
 308  81E0 2A 58 A4     	ld hl,(file_r_num_cur)
 309  81E3 CD 90 82     	call calc_deskr
 310  81E6 DD 7E 0B     	ld a,(ix+#0b)
 311  81E9 FE 10        	cp #10 ;признак каталога
 312  81EB 28 59        	jr z,nc_play_all_down
 313  81ED
 314  81ED FE 30        	cp #30 ;признак каталога
 315  81EF 28 55        	jr z,nc_play_all_down
 316  81F1
 317  81F1
 318  81F1 CD 46 87     	call format_name
 319  81F4
 320  81F4              nc_play_1
 321  81F4              	;проверка расширения ;VGM
 322  81F4 CD 69 83     	call check_vgm
 323  81F7 C2 0D 82     	jp nz,nc_play_2
 324  81FA
 325  81FA 3E 76        	ld a,"v"
 326  81FC CD 96 90     	call start_gplay
 327  81FF
 328  81FF              nc_play_1_next
 329  81FF
 330  81FF FE 73        	cp "s"
 331  8201 28 40        	jr z,nc_play_ex
 332  8203 FE 53        	cp "S"
 333  8205 28 3C        	jr z,nc_play_ex
 334  8207 FE 18        	cp 24 ;break
 335  8209 28 38        	jr z,nc_play_ex
 336  820B
 337  820B 18 39        	jr nc_play_all_down
 338  820D
 339  820D              nc_play_2
 340  820D              	;проверка расширения ;VGZ
 341  820D CD 88 83     	call check_vgz
 342  8210 C2 1A 82     	jp nz,nc_play_3
 343  8213
 344  8213 3E 7A        	ld a,"z"
 345  8215 CD 96 90     	call start_gplay
 346  8218
 347  8218 18 E5        	jr nc_play_1_next
 348  821A
 349  821A
 350  821A              nc_play_3
 351  821A              	;проверка расширения MOD
 352  821A CD C6 83     	call check_mod
 353  821D C2 27 82     	jp nz,nc_play_4
 354  8220
 355  8220 3E 6D        	ld a,"m"
 356  8222 CD 96 90     	call start_gplay
 357  8225
 358  8225 18 D8        	jr nc_play_1_next
 359  8227
 360  8227
 361  8227              nc_play_4
 362  8227              	;проверка расширения pt2
 363  8227 CD E5 83     	call check_pt2
 364  822A C2 34 82     	jp nz,nc_play_5
 365  822D
 366  822D 3E 32        	ld a,"2"
 367  822F CD 96 90     	call start_gplay
 368  8232
 369  8232 18 CB        	jr nc_play_1_next
 370  8234
 371  8234              nc_play_5
 372  8234              	;проверка расширения pt3
 373  8234 CD 04 84     	call check_pt3
 374  8237 C2 41 82     	jp nz,nc_play_6
 375  823A
 376  823A 3E 33        	ld a,"3"
 377  823C CD 96 90     	call start_gplay
 378  823F
 379  823F 18 BE        	jr nc_play_1_next
 380  8241
 381  8241
 382  8241              nc_play_6
 383  8241 18 03        	jr nc_play_all_down
 384  8243
 385  8243
 386  8243
 387  8243              nc_play_ex
 388  8243 C3 96 80     	jp nc_wait
 389  8246
 390  8246
 391  8246              nc_play_all_down ;вниз по списку
 392  8246 ED 4B 58 A4  	ld bc,(file_r_num_cur)
 393  824A C5           	push bc
 394  824B CD 9D 82     	call key_down
 395  824E CD 23 84     	call print_panel_r ;обновить каталог
 396  8251 C1           	pop bc
 397  8252 2A 58 A4     	ld hl,(file_r_num_cur)
 398  8255 A7           	and a
 399  8256 ED 42        	sbc hl,bc ;если не сдвинулась позиция, то всё
 400  8258 28 E9        	jr z,nc_play_ex
 401  825A C3 D8 81     	jp nc_play_all
 402  825D
 403  825D
 404  825D
 405  825D
 406  825D
 407  825D
 408  825D
 409  825D
 410  825D              key_enter_dir
 411  825D              	;тут открытие папки
 412  825D
 413  825D              	;определить идём вглубь (вперёд) или наверх (назад)
 414  825D AF           	xor a
 415  825E 32 80 82     	ld (key_enter_dir_flag),a
 416  8261
 417  8261 DD 7E 00     	ld a,(ix+#00)
 418  8264 FE 2E        	cp "."
 419  8266 20 0C        	jr nz,key_enter_dir1
 420  8268 DD 7E 01     	ld a,(ix+#01)
 421  826B FE 2E        	cp "."
 422  826D 20 05        	jr nz,key_enter_dir1
 423  826F              	;идём назад
 424  826F 3E 01        	ld a,1
 425  8271 32 80 82     	ld (key_enter_dir_flag),a
 426  8274
 427  8274              key_enter_dir1
 428  8274              	;call format_name_dir
 429  8274 EB           	ex de,hl ;de - дескриптор для открытия
 430  8275 21 4A A3     	ld hl,dir_name_cur
 431  8278              	OS_DIR_OPEN
 431  8278 0E 27       >    ld c,#27
 431  827A E7          >    rst #20
 432  827B DA D5 81     	jp c,key_enter_ex ;если ошибка, ничего не делаем
 433  827E
 434  827E E1           	pop hl ;отменить возврат
 435  827F 3E 00        	ld a,0
 436  8281              key_enter_dir_flag equ $-1
 437  8281 B7           	or a
 438  8282 20 06        	jr nz,key_enter_dir_back
 439  8284 CD 83 88     	call file_r_num_hyst_add ;запомнить позицию курсора в истории
 440  8287 C3 54 80     	jp start_nc_warm ;перезагрузить папку
 441  828A
 442  828A              key_enter_dir_back
 443  828A              	;если в предыдущую папку
 444  828A CD A8 88     	call file_r_num_hyst_get ;вспомнить позицию курсора
 445  828D C3 54 80     	jp start_nc_warm ;перезагрузить папку
 446  8290
 447  8290
 448  8290              ; format_name_dir
 449  8290              	; push hl
 450  8290              	; ld hl,file_name_cur
 451  8290              	; ld de,file_name_cur+1 ;почистить
 452  8290              	; ld bc,256-1
 453  8290              	; ld (hl),0
 454  8290              	; ldir
 455  8290
 456  8290              	; pop hl
 457  8290
 458  8290              	; ld de,file_name_cur ;куда
 459  8290              	; ld bc,#08ff
 460  8290              ; format_name_dir_cl
 461  8290              	; ld a,(hl)
 462  8290              	; cp " "+1
 463  8290              	; jr c,format_name_dir_skip
 464  8290              	; ldi
 465  8290              	; djnz format_name_dir_cl
 466  8290              ; format_name_dir_skip
 467  8290              	; ld a,'/'
 468  8290              	; ld (de),a
 469  8290              	; ret
 470  8290
 471  8290               ;вычислить дескриптор текущего элемента справа
 472  8290              calc_deskr
 473  8290 29           	add hl,hl ;*2
 474  8291 01 A6 A5     	ld bc,cat_index
 475  8294 09           	add hl,bc
 476  8295 5E           	ld e,(hl)
 477  8296 23           	inc hl
 478  8297 56           	ld d,(hl)
 479  8298 EB           	ex de,hl ;hl - адрес элемента
 480  8299 E5           	push hl
 481  829A DD E1        	pop ix ;ix- адрес элемента
 482  829C C9           	ret
 483  829D
 484  829D
 485  829D
 486  829D
 487  829D              key_down
 488  829D 2A 46 A2     	ld hl,(file_r_all)
 489  82A0 7D           	ld a,l
 490  82A1 B4           	or h
 491  82A2 CA E1 82     	jp z,key_down_ex ;защита
 492  82A5
 493  82A5 ED 4B 58 A4  	ld bc,(file_r_num_cur)
 494  82A9 ED 43 5A A4  	ld (file_r_num_old),bc ;запомнить что было
 495  82AD 03           	inc bc
 496  82AE 2A 46 A2     	ld hl,(file_r_all)
 497  82B1              	;если не больше чем всего
 498  82B1 A7           	and a
 499  82B2 ED 42        	sbc hl,bc
 500  82B4 38 2B        	jr c,key_down_skip
 501  82B6 28 29        	jr z,key_down_skip
 502  82B8              	;прибавить
 503  82B8 ED 43 58 A4  	ld (file_r_num_cur),bc
 504  82BC
 505  82BC              	;теперь передвинуть фокус, если надо
 506  82BC 2A 48 A2     	ld hl,(file_r_cur_focus)
 507  82BF 01 16 00     	ld bc,panel_hight
 508  82C2 09           	add hl,bc ;прибавить количество видимых
 509  82C3 ED 4B 58 A4  	ld bc,(file_r_num_cur)
 510  82C7 A7           	and a
 511  82C8 ED 42        	sbc hl,bc ;вычесть положение курсора
 512  82CA 28 02        	jr z,key_down_change_focus_yes
 513  82CC 30 10        	jr nc,key_down_change_focus_no
 514  82CE              key_down_change_focus_yes
 515  82CE              	;передвинуть фокус
 516  82CE 2A 48 A2     	ld hl,(file_r_cur_focus)
 517  82D1 23           	inc hl
 518  82D2 22 48 A2     	ld (file_r_cur_focus),hl
 519  82D5
 520  82D5 3E 01        	ld a,1
 521  82D7 32 73 A4     	ld (print_panel_r_flag),a ;напечатать всё снова
 522  82DA
 523  82DA 3A 5E A4     	ld a,(key_pressed)
 524  82DD C9           	ret
 525  82DE
 526  82DE              key_down_change_focus_no
 527  82DE
 528  82DE              	;call print_panel_r ;обновить каталог
 529  82DE
 530  82DE CD 5B 84     	call print_panel_r_cursor ;обновить только курсор
 531  82E1
 532  82E1              key_down_ex
 533  82E1
 534  82E1              key_down_skip
 535  82E1 3A 5E A4     	ld a,(key_pressed)
 536  82E4 C9           	ret
 537  82E5
 538  82E5
 539  82E5
 540  82E5              key_up ;вверх
 541  82E5 2A 46 A2     	ld hl,(file_r_all)
 542  82E8 7D           	ld a,l
 543  82E9 B4           	or h
 544  82EA CA 1E 83     	jp z,key_up_ex ;защита
 545  82ED
 546  82ED 2A 58 A4     	ld hl,(file_r_num_cur)
 547  82F0 22 5A A4     	ld (file_r_num_old),hl
 548  82F3 7D           	ld a,l
 549  82F4 B4           	or h
 550  82F5 28 27        	jr z,key_up_skip
 551  82F7 2B           	dec hl
 552  82F8 22 58 A4     	ld (file_r_num_cur),hl
 553  82FB
 554  82FB              	;теперь передвинуть фокус, если надо
 555  82FB 2A 58 A4     	ld hl,(file_r_num_cur)
 556  82FE              	; ld bc,panel_hight
 557  82FE              	; add hl,bc ;прибавить количество видимых
 558  82FE ED 4B 48 A2  	ld bc,(file_r_cur_focus)
 559  8302 A7           	and a
 560  8303 ED 42        	sbc hl,bc ;вычесть положение курсора
 561  8305              	;jr z,key_up_change_foces_yes
 562  8305 30 14        	jr nc,key_up_change_foces_no
 563  8307              key_up_change_foces_yes
 564  8307              	;передвинуть фокус
 565  8307 2A 48 A2     	ld hl,(file_r_cur_focus)
 566  830A 7C           	ld a,h
 567  830B B5           	or l
 568  830C 28 0D        	jr z,key_up_change_foces_no ;защита
 569  830E 2B           	dec hl
 570  830F 22 48 A2     	ld (file_r_cur_focus),hl
 571  8312
 572  8312 3E 01        	ld a,1
 573  8314 32 73 A4     	ld (print_panel_r_flag),a	;напечатать снова всё
 574  8317
 575  8317 3A 5E A4     	ld a,(key_pressed)
 576  831A C9           	ret
 577  831B
 578  831B              key_up_change_foces_no
 579  831B
 580  831B              	;call print_panel_r ;обновить каталог
 581  831B CD 5B 84     	call print_panel_r_cursor ;обновить только курсор
 582  831E
 583  831E              key_up_skip
 584  831E
 585  831E              key_up_ex
 586  831E
 587  831E 3A 5E A4     	ld a,(key_pressed)
 588  8321 C9           	ret
 589  8322
 590  8322
 591  8322              key_left ;на страницу назад
 592  8322 06 15        	ld b,panel_hight-1
 593  8324              key_left_cl
 594  8324 C5           	push bc
 595  8325 CD E5 82     	call key_up
 596  8328 C1           	pop bc
 597  8329 10 F9        	djnz key_left_cl
 598  832B 3E 01        	ld a,1
 599  832D 32 73 A4     	ld (print_panel_r_flag),a
 600  8330 3A 5E A4     	ld a,(key_pressed)
 601  8333 C9           	ret
 602  8334
 603  8334
 604  8334
 605  8334              key_right ;на страницу вперёд
 606  8334 06 15        	ld b,panel_hight-1
 607  8336              key_right_cl
 608  8336 C5           	push bc
 609  8337 CD 9D 82     	call key_down
 610  833A C1           	pop bc
 611  833B 10 F9        	djnz key_right_cl
 612  833D 3E 01        	ld a,1
 613  833F 32 73 A4     	ld (print_panel_r_flag),a
 614  8342 3A 5E A4     	ld a,(key_pressed)
 615  8345 C9           	ret
 616  8346
 617  8346
 618  8346
 619  8346              exit ;выход в DOS
 620  8346 AF           	xor a
 621  8347              	OS_PROC_CLOSE
 621  8347 0E 13       >    ld c,#13
 621  8349 E7          >    rst #20
 622  834A
 623  834A
 624  834A
 625  834A              check_apg ;проверка на расширение APG
 626  834A DD 7E 08     	ld a,(ix+8)
 627  834D FE 61        	cp "a"
 628  834F 28 03        	jr z,check_apg1
 629  8351 FE 41        	cp "A"
 630  8353 C0           	ret nz
 631  8354              check_apg1
 632  8354 DD 7E 09     	ld a,(ix+9)
 633  8357 FE 70        	cp "p"
 634  8359 28 03        	jr z,check_apg2
 635  835B FE 50        	cp "P"
 636  835D C0           	ret nz
 637  835E              check_apg2
 638  835E DD 7E 0A     	ld a,(ix+10)
 639  8361 FE 67        	cp "g"
 640  8363 C8           	ret z
 641  8364 FE 47        	cp "G"
 642  8366 C0           	ret nz
 643  8367 AF           	xor a ;равен
 644  8368 C9           	ret
 645  8369
 646  8369
 647  8369              check_vgm ;проверка на расширение VGM
 648  8369 DD 7E 08     	ld a,(ix+8)
 649  836C FE 76        	cp "v"
 650  836E 28 03        	jr z,check_vgm1
 651  8370 FE 56        	cp "V"
 652  8372 C0           	ret nz
 653  8373              check_vgm1
 654  8373 DD 7E 09     	ld a,(ix+9)
 655  8376 FE 67        	cp "g"
 656  8378 28 03        	jr z,check_vgm2
 657  837A FE 47        	cp "G"
 658  837C C0           	ret nz
 659  837D              check_vgm2
 660  837D DD 7E 0A     	ld a,(ix+10)
 661  8380 FE 6D        	cp "m"
 662  8382 C8           	ret z
 663  8383 FE 4D        	cp "M"
 664  8385 C0           	ret nz
 665  8386 AF           	xor a ;равен
 666  8387 C9           	ret
 667  8388
 668  8388              check_vgz ;проверка на расширение VGZ
 669  8388 DD 7E 08     	ld a,(ix+8)
 670  838B FE 76        	cp "v"
 671  838D 28 03        	jr z,check_vgz1
 672  838F FE 56        	cp "V"
 673  8391 C0           	ret nz
 674  8392              check_vgz1
 675  8392 DD 7E 09     	ld a,(ix+9)
 676  8395 FE 67        	cp "g"
 677  8397 28 03        	jr z,check_vgz2
 678  8399 FE 47        	cp "G"
 679  839B C0           	ret nz
 680  839C              check_vgz2
 681  839C DD 7E 0A     	ld a,(ix+10)
 682  839F FE 7A        	cp "z"
 683  83A1 C8           	ret z
 684  83A2 FE 5A        	cp "Z"
 685  83A4 C0           	ret nz
 686  83A5 AF           	xor a ;равен
 687  83A6 C9           	ret
 688  83A7
 689  83A7
 690  83A7              check_scr ;проверка на расширение SCR
 691  83A7 DD 7E 08     	ld a,(ix+8)
 692  83AA FE 73        	cp "s"
 693  83AC 28 03        	jr z,check_scr1
 694  83AE FE 53        	cp "S"
 695  83B0 C0           	ret nz
 696  83B1              check_scr1
 697  83B1 DD 7E 09     	ld a,(ix+9)
 698  83B4 FE 63        	cp "c"
 699  83B6 28 03        	jr z,check_scr2
 700  83B8 FE 43        	cp "C"
 701  83BA C0           	ret nz
 702  83BB              check_scr2
 703  83BB DD 7E 0A     	ld a,(ix+10)
 704  83BE FE 72        	cp "r"
 705  83C0 C8           	ret z
 706  83C1 FE 52        	cp "R"
 707  83C3 C0           	ret nz
 708  83C4 AF           	xor a ;равен
 709  83C5 C9           	ret
 710  83C6
 711  83C6              check_mod ;проверка на расширение MOD
 712  83C6 DD 7E 08     	ld a,(ix+8)
 713  83C9 FE 6D        	cp "m"
 714  83CB 28 03        	jr z,check_mod1
 715  83CD FE 4D        	cp "M"
 716  83CF C0           	ret nz
 717  83D0              check_mod1
 718  83D0 DD 7E 09     	ld a,(ix+9)
 719  83D3 FE 6F        	cp "o"
 720  83D5 28 03        	jr z,check_mod2
 721  83D7 FE 4F        	cp "O"
 722  83D9 C0           	ret nz
 723  83DA              check_mod2
 724  83DA DD 7E 0A     	ld a,(ix+10)
 725  83DD FE 64        	cp "d"
 726  83DF C8           	ret z
 727  83E0 FE 44        	cp "D"
 728  83E2 C0           	ret nz
 729  83E3 AF           	xor a ;равен
 730  83E4 C9           	ret
 731  83E5
 732  83E5
 733  83E5              check_pt2 ;проверка на расширение pt2
 734  83E5 DD 7E 08     	ld a,(ix+8)
 735  83E8 FE 70        	cp "p"
 736  83EA 28 03        	jr z,check_pt21
 737  83EC FE 50        	cp "P"
 738  83EE C0           	ret nz
 739  83EF              check_pt21
 740  83EF DD 7E 09     	ld a,(ix+9)
 741  83F2 FE 74        	cp "t"
 742  83F4 28 03        	jr z,check_pt22
 743  83F6 FE 54        	cp "T"
 744  83F8 C0           	ret nz
 745  83F9              check_pt22
 746  83F9 DD 7E 0A     	ld a,(ix+10)
 747  83FC FE 32        	cp "2"
 748  83FE C8           	ret z
 749  83FF FE 32        	cp "2"
 750  8401 C0           	ret nz
 751  8402 AF           	xor a ;равен
 752  8403 C9           	ret
 753  8404
 754  8404              check_pt3 ;проверка на расширение pt3
 755  8404 DD 7E 08     	ld a,(ix+8)
 756  8407 FE 70        	cp "p"
 757  8409 28 03        	jr z,check_pt31
 758  840B FE 50        	cp "P"
 759  840D C0           	ret nz
 760  840E              check_pt31
 761  840E DD 7E 09     	ld a,(ix+9)
 762  8411 FE 74        	cp "t"
 763  8413 28 03        	jr z,check_pt32
 764  8415 FE 54        	cp "T"
 765  8417 C0           	ret nz
 766  8418              check_pt32
 767  8418 DD 7E 0A     	ld a,(ix+10)
 768  841B FE 33        	cp "3"
 769  841D C8           	ret z
 770  841E FE 33        	cp "3"
 771  8420 C0           	ret nz
 772  8421 AF           	xor a ;равен
 773  8422 C9           	ret
 774  8423
 775  8423
 776  8423
 777  8423
 778  8423              print_panel_r ;печать правой панели
 779  8423              	;ld ix,buffer_cat
 780  8423 FD 2A 46 A2  	ld iy,(file_r_all) ;всего файлов
 781  8427 FD 7D        	ld a,iyl
 782  8429 FD B4        	or iyh
 783  842B C8           	ret z ;защита если 0
 784  842C 11 29 01     	ld de,panel_r_xy ;координаты yx
 785  842F 06 16        	ld b,panel_hight ;высота панели
 786  8431 FD 2A 48 A2  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 787  8435              print_panel_r_cl ;цикл
 788  8435 C5           	push bc
 789  8436 D5           	push de ;xy
 790  8437              	OS_SET_XY
 790  8437 0E 01       >    ld c,#01
 790  8439 E7          >    rst #20
 791  843A
 792  843A              	;получить адрес элемента
 793  843A FD E5        	push iy
 794  843C E1           	pop hl
 795  843D CD 90 82     	call calc_deskr
 796  8440
 797  8440 CD B6 84     	call print_file_info ;напечатать строку
 798  8443              ;print_panel_r_skip
 799  8443 D1           	pop de
 800  8444 14           	inc d ;y++
 801  8445 FD 23        	inc iy ;текущий файл
 802  8447              	;проверка на конец каталога
 803  8447 2A 46 A2     	ld hl,(file_r_all)
 804  844A FD E5        	push iy
 805  844C C1           	pop bc
 806  844D A7           	and a
 807  844E ED 42        	sbc hl,bc
 808  8450 C1           	pop bc
 809  8451 38 07        	jr c,print_panel_r_ex2
 810  8453 28 05        	jr z,print_panel_r_ex2
 811  8455 10 DE        	djnz print_panel_r_cl
 812  8457 C9           	ret
 813  8458              print_panel_r_ex
 814  8458 D1           	pop de
 815  8459 C1           	pop bc
 816  845A              print_panel_r_ex2
 817  845A              	;тут, возможно, надо допечатать пустые строки
 818  845A C9           	ret
 819  845B
 820  845B
 821  845B
 822  845B
 823  845B
 824  845B
 825  845B
 826  845B
 827  845B              print_panel_r_cursor ;печать только строки с курсором в правой панели, для скорости навигации
 828  845B ED 4B 5A A4  	ld bc,(file_r_num_old) ;старая позиция
 829  845F ED 43 5C A4  	ld (file_r_num_tmp),bc ;позиция курсора для печати
 830  8463 CD 72 84     	call print_panel_r_cursor_one ;"стереть" предыдущее
 831  8466 ED 4B 58 A4  	ld bc,(file_r_num_cur) ;позиция текущая
 832  846A ED 43 5C A4  	ld (file_r_num_tmp),bc ;позиция курсора для печати
 833  846E CD 72 84     	call print_panel_r_cursor_one ;напечатать новое
 834  8471 C9           	ret
 835  8472
 836  8472
 837  8472              print_panel_r_cursor_one
 838  8472              	;ld ix,buffer_cat
 839  8472 FD 2A 46 A2  	ld iy,(file_r_all) ;всего файлов
 840  8476 FD 7D        	ld a,iyl
 841  8478 FD B4        	or iyh
 842  847A C8           	ret z ;защита если 0
 843  847B 11 29 01     	ld de,panel_r_xy ;координаты yx
 844  847E 06 16        	ld b,panel_hight ;высота панели
 845  8480 FD 2A 48 A2  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 846  8484              print_panel_r_cursor_cl ;цикл
 847  8484 C5           	push bc
 848  8485 D5           	push de
 849  8486              	;проверить дошли ли до курсора
 850  8486 ED 4B 5C A4  	ld bc,(file_r_num_tmp) ;позиция курсора справа
 851  848A FD E5        	push iy
 852  848C E1           	pop hl
 853  848D A7           	and a
 854  848E ED 42        	sbc hl,bc ;сравнить
 855  8490 20 0C        	jr nz,print_panel_r_cursor_skip
 856  8492              	;напечатать курсор
 857  8492              	;push bc
 858  8492              	;push de ;xy
 859  8492              	OS_SET_XY
 859  8492 0E 01       >    ld c,#01
 859  8494 E7          >    rst #20
 860  8495
 861  8495              	;получить адрес элемента
 862  8495 FD E5        	push iy
 863  8497 E1           	pop hl
 864  8498 CD 90 82     	call calc_deskr
 865  849B
 866  849B CD B6 84     	call print_file_info ;напечатать строку
 867  849E              print_panel_r_cursor_skip
 868  849E D1           	pop de
 869  849F 14           	inc d ;y++
 870  84A0 FD 23        	inc iy ;текущий файл
 871  84A2              	;проверка на конец каталога
 872  84A2 2A 46 A2     	ld hl,(file_r_all)
 873  84A5 FD E5        	push iy
 874  84A7 C1           	pop bc
 875  84A8 A7           	and a
 876  84A9 ED 42        	sbc hl,bc
 877  84AB C1           	pop bc
 878  84AC 38 07        	jr c,print_panel_r_cursor_ex2
 879  84AE 28 05        	jr z,print_panel_r_cursor_ex2
 880  84B0 10 D2        	djnz print_panel_r_cursor_cl
 881  84B2 C9           	ret
 882  84B3              print_panel_r_cursor_ex
 883  84B3 D1           	pop de
 884  84B4 C1           	pop bc
 885  84B5              print_panel_r_cursor_ex2
 886  84B5              	;тут, возможно, надо допечатать пустые строки
 887  84B5 C9           	ret
 888  84B6
 889  84B6
 890  84B6
 891  84B6
 892  84B6
 893  84B6
 894  84B6
 895  84B6
 896  84B6
 897  84B6              print_file_info ;печать строки о файле
 898  84B6 3A 45 87     	ld a,(LFN_enable_flag)
 899  84B9 B7           	or a
 900  84BA 28 4D        	jr z,print_file_info_SFN
 901  84BC
 902  84BC
 903  84BC
 904  84BC              print_file_info_LFN ;печать длинного имени
 905  84BC              	;узнать номер записи
 906  84BC 01 00 C0     	ld bc,#c000
 907  84BF A7           	and a
 908  84C0 ED 42        	sbc hl,bc
 909  84C2              ;разделить на 32
 910  84C2 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 911  84C4 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 912  84C6 CB 3C        	srl h ; /4
 913  84C8 CB 1D        	rr l ;
 914  84CA CB 3C        	srl h ; /8
 915  84CC CB 1D        	rr l ;
 916  84CE CB 3C        	srl h ; /16
 917  84D0 CB 1D        	rr l ;
 918  84D2 CB 3C        	srl h ; /32
 919  84D4 CB 1D        	rr l ;
 920  84D6
 921  84D6
 922  84D6 EB           	ex de,hl ;de - порядковый номер записи
 923  84D7
 924  84D7 21 A6 AD     	ld hl,file_info_string ;куда
 925  84DA              	OS_GET_LFN ;получить длинное имя
 925  84DA 0E 2A       >    ld c,#2a
 925  84DC E7          >    rst #20
 926  84DD
 927  84DD CD 31 85     	call get_color_item
 928  84E0
 929  84E0 06 0C        	ld b,#c
 930  84E2              	OS_SET_COLOR
 930  84E2 0E 06       >    ld c,#06
 930  84E4 E7          >    rst #20
 931  84E5
 932  84E5              	;печать не длиннее 80/2 символов
 933  84E5 21 A6 AD     	ld hl,file_info_string
 934  84E8 06 26        	ld b,80/2-2
 935  84EA 0E 28        	ld c,40 ;колонка
 936  84EC              print_file_info_LFN_cl
 937  84EC E5           	push hl
 938  84ED C5           	push bc
 939  84EE 7E           	ld a,(hl)
 940  84EF B7           	or a
 941  84F0 28 09        	jr z,print_file_info_LFN_cl_ex
 942  84F2              	OS_PRINT_CHARF
 942  84F2 D7          >	rst #10
 943  84F3 C1           	pop bc
 944  84F4 0C           	inc c
 945  84F5 E1           	pop hl
 946  84F6 23           	inc hl
 947  84F7 10 F3        	djnz print_file_info_LFN_cl
 948  84F9 18 02        	jr print_file_info_LFN_ex
 949  84FB              print_file_info_LFN_cl_ex
 950  84FB C1           	pop bc
 951  84FC E1           	pop hl
 952  84FD              print_file_info_LFN_ex
 953  84FD              	;допечатать пробелы до правого края, зависит от длины имени
 954  84FD              print_file_info_LFN_cl2
 955  84FD 79           	ld a,c
 956  84FE FE 4E        	cp 80-2
 957  8500 D0           	ret nc
 958  8501 C5           	push bc
 959  8502 3E 20        	ld a,' '
 960  8504              	OS_PRINT_CHARF
 960  8504 D7          >	rst #10
 961  8505 C1           	pop bc
 962  8506 0C           	inc c
 963  8507 18 F4        	jr print_file_info_LFN_cl2
 964  8509
 965  8509
 966  8509
 967  8509              print_file_info_SFN ;печать короткого имени
 968  8509 11 A6 AD     	ld de,file_info_string ;скопировать
 969  850C 01 08 00     	ld bc,8 ;file_info_lenght
 970  850F ED B0        	ldir
 971  8511 3E 20        	ld a,' '
 972  8513 12           	ld (de),a
 973  8514 13           	inc de
 974  8515 01 03 00     	ld bc,3
 975  8518 ED B0        	ldir
 976  851A AF           	xor a
 977  851B 12           	ld (de),a
 978  851C
 979  851C CD 31 85     	call get_color_item
 980  851F
 981  851F 06 0C        	ld b,#c
 982  8521              	OS_SET_COLOR
 982  8521 0E 06       >    ld c,#06
 982  8523 E7          >    rst #20
 983  8524 21 A6 AD     	ld hl,file_info_string
 984  8527              	OS_PRINTZ
 984  8527 0E 09       >    ld c,#09
 984  8529 E7          >    rst #20
 985  852A              	;допечатать пробелы до правого края, длина имени постоянная
 986  852A 21 74 A4     	ld hl,file_info_string_SFN_end
 987  852D              	OS_PRINTZ
 987  852D 0E 09       >    ld c,#09
 987  852F E7          >    rst #20
 988  8530 C9           	ret
 989  8531
 990  8531
 991  8531
 992  8531              get_color_item ;получить цвет элемента
 993  8531              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 994  8531              ;вых: A - цвет
 995  8531 ED 4B 58 A4  	ld bc,(file_r_num_cur) ;позиция курсора справа
 996  8535 FD E5        	push iy
 997  8537 E1           	pop hl
 998  8538 A7           	and a
 999  8539 ED 42        	sbc hl,bc ;сравнить
1000  853B 28 11        	jr z,get_color_item_no_cursor
1001  853D              	;цвета курсора
1002  853D 3E 0E        	ld a,color_dir ;простая
1003  853F 32 69 85     	ld (get_color_item_dir+1),a
1004  8542 3E 0C        	ld a,color_apg ;простая
1005  8544 32 71 85     	ld (get_color_item_apg+1),a
1006  8547 3E 0F        	ld a,color_backgr ;простая
1007  8549 32 74 85     	ld (get_color_item_backgr+1),a
1008  854C 18 0F        	jr get_color_item_set
1009  854E
1010  854E              get_color_item_no_cursor
1011  854E              	;цвета обычные
1012  854E 3E 28        	ld a,color_dir_hi ;под курсором
1013  8550 32 69 85     	ld (get_color_item_dir+1),a
1014  8553 3E 28        	ld a,color_apg_hi ;под курсором
1015  8555 32 71 85     	ld (get_color_item_apg+1),a
1016  8558 3E 28        	ld a,color_backgr_hi ;под курсором
1017  855A 32 74 85     	ld (get_color_item_backgr+1),a
1018  855D
1019  855D              get_color_item_set
1020  855D              	;задать цвет
1021  855D DD 7E 0B     	ld a,(ix+#0b)
1022  8560 FE 10        	cp #10 ;признак каталога
1023  8562 28 04        	jr z,get_color_item_dir
1024  8564 FE 30        	cp #30 ;признак каталога
1025  8566 20 03        	jr nz,get_color_item_no_dir
1026  8568              	;если папка
1027  8568              get_color_item_dir
1028  8568 3E 00        	ld a,0
1029  856A C9           	ret
1030  856B
1031  856B              get_color_item_no_dir
1032  856B CD 4A 83     	call check_apg ;расширение apg
1033  856E 20 03        	jr nz,get_color_item_no_apg
1034  8570              	;если приложение
1035  8570              get_color_item_apg
1036  8570 3E 00        	ld a,0
1037  8572 C9           	ret
1038  8573
1039  8573              get_color_item_no_apg
1040  8573              	;если обычный файл
1041  8573              get_color_item_backgr
1042  8573 3E 00        	ld a,0
1043  8575 C9           	ret
1044  8576
1045  8576
1046  8576
1047  8576              ; format_dir ;подготовить каталог, убрать лишнее
1048  8576              	; ; ld a,2
1049  8576              	; ; out (254),a
1050  8576              	; ld iy,0 ;счётчик файлов
1051  8576              	; ;найти конец каталога
1052  8576              	; ld hl,buffer_cat
1053  8576              	; ld a,(hl)
1054  8576              	; or a
1055  8576              	; ret z ;защита
1056  8576              	; ld bc,32
1057  8576              ; format_dir_prep_cl
1058  8576              	; ld a,(hl)
1059  8576              	; or a
1060  8576              	; jr z,format_dir_prep_ex
1061  8576              	; add hl,bc
1062  8576              	; ld a,h
1063  8576              	; or a ;если вышли за границу
1064  8576              	; jr z,format_dir_prep_ex
1065  8576              	; jr format_dir_prep_cl
1066  8576              ; format_dir_prep_ex
1067  8576              	; ld bc,32
1068  8576              	; and a
1069  8576              	; sbc hl,bc
1070  8576              	; ld (format_dir_top),hl ;конец каталога
1071  8576
1072  8576
1073  8576
1074  8576              	; ld ix,buffer_cat
1075  8576              	; ;ld b,panel_hight ;высота панели
1076  8576              ; format_dir_cl ;цикл
1077  8576              	; ld a,(ix)
1078  8576              	; or a ;конец каталога
1079  8576              	; jr z,format_dir_ex
1080  8576              	; cp #e5 ;удалённый
1081  8576              	; jr z,format_dir_skip
1082  8576              	; cp #05 ;удалённый
1083  8576              	; jr z,format_dir_skip
1084  8576              	; ld a,(ix+#0b)
1085  8576              	; cp #0f ;длинный
1086  8576              	; jr z,format_dir_skip
1087  8576
1088  8576              	; ;проверка на папку "." (этот же каталог)
1089  8576              	; ld a,(ix+#00)
1090  8576              	; cp "." ;
1091  8576              	; jr nz,format_dir_add
1092  8576              	; ld a,(ix+#01)
1093  8576              	; cp " " ;
1094  8576              	; jr z,format_dir_skip
1095  8576
1096  8576
1097  8576              ; format_dir_add
1098  8576              	; inc iy ;++
1099  8576              	; ld bc,32 ;на другой элемент каталога
1100  8576              	; add ix,bc
1101  8576              	; ld a,ixh
1102  8576              	; or a ;если вышли за границу
1103  8576              	; jr z,format_dir_ex
1104  8576              	; jr format_dir_cl
1105  8576              ; format_dir_skip
1106  8576              	; ;сдвинуть элементы вниз
1107  8576              	; push ix
1108  8576              	; push ix
1109  8576              	; pop hl
1110  8576              	; pop de ;куда
1111  8576              	; ld hl,(format_dir_top) ;0-32
1112  8576              	; and a
1113  8576              	; sbc hl,de
1114  8576              	; ld b,h
1115  8576              	; ld c,l ;длина
1116  8576              	; push bc
1117  8576
1118  8576              	; push ix
1119  8576              	; pop hl ;откуда
1120  8576              	; ld bc,32 ;на другой элемент каталога
1121  8576              	; add hl,bc ;откуда
1122  8576
1123  8576              	; pop bc
1124  8576              	; ldir
1125  8576
1126  8576              	; xor a
1127  8576              	; ld (de),a ;очистить ненужный элемент
1128  8576
1129  8576              	; jr format_dir_cl
1130  8576
1131  8576              ; format_dir_ex
1132  8576              	; ld (file_r_all),iy
1133  8576              	; ;здесь почистить остаток каталога
1134  8576              	; ; ld a,0
1135  8576              	; ; out (254),a
1136  8576              	; ret
1137  8576              ; format_dir_top	dw 0 ;временно конец гаталога
1138  8576
1139  8576
1140  8576
1141  8576
1142  8576
1143  8576              sort_dir ;сортировка каталога с помощью построения индекса
1144  8576 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1145  857A DD 7E 00     	ld a,(ix)
1146  857D B7           	or a
1147  857E C8           	ret z ;если пусто, выход
1148  857F FD 21 00 00  	ld iy,0 ;счётчик всего файлов
1149  8583
1150  8583
1151  8583 3A 28 87     	ld a,(sort_enable_flag)
1152  8586 B7           	or a
1153  8587 CA EE 85     	jp z,sort_dir_no ;если без сортировки
1154  858A
1155  858A 21 A6 A5     	ld hl,cat_index
1156  858D 22 EA 85     	ld (sort_item_adr_end),hl
1157  8590
1158  8590 21 A6 A9     	ld hl,cat_index_2 ;таблица - индекс 2
1159  8593 CD 6D 86     	call sort_dir_one ;проход по папкам
1160  8596
1161  8596 FD 7C        	ld a,iyh
1162  8598 FD B5        	or iyl
1163  859A 28 19        	jr z,sort_dir_skip ;если не было папок
1164  859C
1165  859C DD 21 A6 A9  	ld ix,cat_index_2
1166  85A0 CD B7 86     	call sort_index ;отсортировать по алфавиту
1167  85A3              	;перенести индекс в основной
1168  85A3 FD E5        	push iy
1169  85A5 E1           	pop hl ;сколько
1170  85A6 29           	add hl,hl ;*2 по 2 байта на элемент
1171  85A7 E5           	push hl
1172  85A8 C1           	pop bc
1173  85A9 21 A6 A9     	ld hl,cat_index_2
1174  85AC 11 A6 A5     	ld de,cat_index
1175  85AF ED B0        	ldir
1176  85B1 ED 53 EA 85  	ld (sort_item_adr_end),de ;запомнить адрес последнего
1177  85B5
1178  85B5              sort_dir_skip
1179  85B5 FD 22 EC 85  	ld (sort_item_count),iy
1180  85B9 FD 21 00 00  	ld iy,0 ;счётчик всего файлов
1181  85BD 21 A6 A9     	ld hl,cat_index_2 ;таблица - индекс 2
1182  85C0 CD 31 86     	call sort_file_one ;проход по файлам
1183  85C3 FD 7C        	ld a,iyh
1184  85C5 FD B5        	or iyl
1185  85C7 28 16        	jr z,sort_file_skip ;если не было файлов
1186  85C9
1187  85C9 DD 21 A6 A9  	ld ix,cat_index_2
1188  85CD CD B7 86     	call sort_index ;отсортировать по алфавиту
1189  85D0              	;добавить индекс к основному
1190  85D0 FD E5        	push iy
1191  85D2 E1           	pop hl ;сколько
1192  85D3 29           	add hl,hl ;*2 по 2 байта на элемент
1193  85D4 E5           	push hl
1194  85D5 C1           	pop bc
1195  85D6 21 A6 A9     	ld hl,cat_index_2
1196  85D9 ED 5B EA 85  	ld de,(sort_item_adr_end)
1197  85DD ED B0        	ldir
1198  85DF
1199  85DF              sort_file_skip
1200  85DF              	;скорректировать количество
1201  85DF ED 4B EC 85  	ld bc,(sort_item_count)
1202  85E3 FD 09        	add iy,bc
1203  85E5 FD 22 46 A2  	ld (file_r_all),iy
1204  85E9 C9           	ret
1205  85EA
1206  85EA 00 00        sort_item_adr_end dw 0; временно
1207  85EC 00 00        sort_item_count dw 0; временно
1208  85EE
1209  85EE
1210  85EE
1211  85EE              ;без сортировки
1212  85EE              sort_dir_no
1213  85EE 21 A6 A5     	ld hl,cat_index ;таблица - индекс
1214  85F1 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1215  85F5              sort_dir_no_cl ;цикл по каталогам
1216  85F5 DD 7E 00     	ld a,(ix)
1217  85F8 B7           	or a ;конец каталога
1218  85F9 28 31        	jr z,sort_dir_no_ex
1219  85FB FE E5        	cp #e5 ;удалённый
1220  85FD 28 22        	jr z,sort_dir_no_skip
1221  85FF FE 05        	cp #05 ;удалённый
1222  8601 28 1E        	jr z,sort_dir_no_skip
1223  8603 DD 7E 0B     	ld a,(ix+#0b)
1224  8606 FE 0F        	cp #0f ;длинный
1225  8608 28 17        	jr z,sort_dir_no_skip
1226  860A
1227  860A              	;проверка на папку "." (этот же каталог)
1228  860A DD 7E 00     	ld a,(ix+#00)
1229  860D FE 2E        	cp "." ;
1230  860F 20 07        	jr nz,sort_dir_no_add
1231  8611 DD 7E 01     	ld a,(ix+#01)
1232  8614 FE 20        	cp " " ;
1233  8616 28 09        	jr z,sort_dir_no_skip
1234  8618
1235  8618              sort_dir_no_add
1236  8618 FD 23        	inc iy ;++
1237  861A              	;записать в таблицу (индекс)
1238  861A DD E5        	push ix
1239  861C C1           	pop bc
1240  861D 71           	ld (hl),c
1241  861E 23           	inc hl
1242  861F 70           	ld (hl),b
1243  8620 23           	inc hl
1244  8621
1245  8621
1246  8621              sort_dir_no_skip
1247  8621 01 20 00     	ld bc,32
1248  8624 DD 09        	add ix,bc ;на следующий
1249  8626 DD 7C        	ld a,ixh ;проверка на конец буфера
1250  8628 FE C0        	cp #c0
1251  862A 30 C9        	jr nc,sort_dir_no_cl
1252  862C
1253  862C              sort_dir_no_ex
1254  862C FD 22 46 A2  	ld (file_r_all),iy
1255  8630 C9           	ret
1256  8631
1257  8631
1258  8631              ;сортировка файлов
1259  8631              sort_file_one
1260  8631 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1261  8635              sort_file_one_cl ;цикл по каталогам
1262  8635 DD 7E 00     	ld a,(ix)
1263  8638 B7           	or a ;конец каталога
1264  8639 28 31        	jr z,sort_file_one_ex
1265  863B DD 7E 0B     	ld a,(ix+#0b)
1266  863E FE 10        	cp #10 ;признак каталога
1267  8640 28 1F        	jr z,sort_file_one_skip
1268  8642 FE 30        	cp #30 ;признак каталога
1269  8644 28 1B        	jr z,sort_file_one_skip
1270  8646 DD 7E 00     	ld a,(ix)
1271  8649 FE E5        	cp #e5 ;удалённый
1272  864B 28 14        	jr z,sort_file_one_skip
1273  864D FE 05        	cp #05 ;удалённый
1274  864F 28 10        	jr z,sort_file_one_skip
1275  8651 DD 7E 0B     	ld a,(ix+#0b)
1276  8654 FE 0F        	cp #0f ;длинный
1277  8656 28 09        	jr z,sort_file_one_skip
1278  8658
1279  8658              	; ;проверка на папку "." (этот же каталог)
1280  8658              	; ld a,(ix+#00)
1281  8658              	; cp "." ;
1282  8658              	; jr nz,sort_file_one_add
1283  8658              	; ld a,(ix+#01)
1284  8658              	; cp " " ;
1285  8658              	; jr z,sort_file_one_skip
1286  8658
1287  8658
1288  8658              sort_file_one_add
1289  8658 FD 23        	inc iy ;++
1290  865A              	;записать в таблицу (индекс)
1291  865A DD E5        	push ix
1292  865C C1           	pop bc
1293  865D 71           	ld (hl),c
1294  865E 23           	inc hl
1295  865F 70           	ld (hl),b
1296  8660 23           	inc hl
1297  8661
1298  8661
1299  8661              sort_file_one_skip
1300  8661 01 20 00     	ld bc,32
1301  8664 DD 09        	add ix,bc ;на следующий
1302  8666 DD 7C        	ld a,ixh ;проверка на конец буфера
1303  8668 FE C0        	cp #c0
1304  866A 30 C9        	jr nc,sort_file_one_cl
1305  866C
1306  866C              sort_file_one_ex
1307  866C              	;ld (file_r_all),iy
1308  866C C9           	ret
1309  866D
1310  866D
1311  866D
1312  866D
1313  866D
1314  866D              ;сортировка папок
1315  866D              sort_dir_one
1316  866D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1317  8671              sort_dir_one_cl ;цикл по каталогам
1318  8671 DD 7E 00     	ld a,(ix)
1319  8674 B7           	or a ;конец каталога
1320  8675 28 3F        	jr z,sort_dir_one_ex
1321  8677 DD 7E 0B     	ld a,(ix+#0b)
1322  867A FE 10        	cp #10 ;признак каталога
1323  867C 28 04        	jr z,sort_dir_one_skip_no
1324  867E FE 30        	cp #30 ;признак каталога
1325  8680 20 29        	jr nz,sort_dir_one_skip
1326  8682              sort_dir_one_skip_no
1327  8682 DD 7E 00     	ld a,(ix)
1328  8685 FE E5        	cp #e5 ;удалённый
1329  8687 28 22        	jr z,sort_dir_one_skip
1330  8689 FE 05        	cp #05 ;удалённый
1331  868B 28 1E        	jr z,sort_dir_one_skip
1332  868D DD 7E 0B     	ld a,(ix+#0b)
1333  8690 FE 0F        	cp #0f ;длинный
1334  8692 28 17        	jr z,sort_dir_one_skip
1335  8694
1336  8694              	;проверка на папку "." (этот же каталог)
1337  8694 DD 7E 00     	ld a,(ix+#00)
1338  8697 FE 2E        	cp "." ;
1339  8699 20 07        	jr nz,sort_dir_one_add
1340  869B DD 7E 01     	ld a,(ix+#01)
1341  869E FE 20        	cp " " ;
1342  86A0 28 09        	jr z,sort_dir_one_skip
1343  86A2
1344  86A2              sort_dir_one_add
1345  86A2 FD 23        	inc iy ;++
1346  86A4              	;записать в таблицу (индекс)
1347  86A4 DD E5        	push ix
1348  86A6 C1           	pop bc
1349  86A7 71           	ld (hl),c
1350  86A8 23           	inc hl
1351  86A9 70           	ld (hl),b
1352  86AA 23           	inc hl
1353  86AB
1354  86AB
1355  86AB              sort_dir_one_skip
1356  86AB 01 20 00     	ld bc,32
1357  86AE DD 09        	add ix,bc ;на следующий
1358  86B0 DD 7C        	ld a,ixh ;проверка на конец буфера
1359  86B2 FE C0        	cp #c0
1360  86B4 30 BB        	jr nc,sort_dir_one_cl
1361  86B6
1362  86B6              sort_dir_one_ex
1363  86B6              	;ld (file_r_all),iy
1364  86B6 C9           	ret
1365  86B7
1366  86B7
1367  86B7
1368  86B7              ;сортировка индекса методом пузырька
1369  86B7              ;вх: iy - сколько (>1)
1370  86B7              ;вх: ix - адрес таблицы
1371  86B7              sort_index
1372  86B7 FD 7C        	ld a,iyh ;проверка, число элементов должно быть > 1
1373  86B9 B7           	or a
1374  86BA 20 05        	jr nz,sort_index1
1375  86BC FD 7D        	ld a,iyl
1376  86BE FE 02        	cp 2
1377  86C0 D8           	ret c
1378  86C1              sort_index1
1379  86C1 FD E5        	push iy
1380  86C3 C1           	pop bc ;цикл проходов общий
1381  86C4 0B           	dec bc ;-1
1382  86C5
1383  86C5              sort_index_cl_gen ;цикл основной
1384  86C5 C5           	push bc
1385  86C6 DD E5        	push ix
1386  86C8
1387  86C8 FD E5        	push iy
1388  86CA C1           	pop bc ;внутренний цикл столько же
1389  86CB 0B           	dec bc ;-1
1390  86CC
1391  86CC AF           	xor a ;флаг
1392  86CD 32 08 87     	ld (sort_index_flag),a
1393  86D0
1394  86D0              sort_index_cl ;цикл внутренний
1395  86D0              	;первый элемент узнать адрес записи в каталоге
1396  86D0 DD 5E 00     	ld e,(ix+00)
1397  86D3 DD 56 01     	ld d,(ix+01)
1398  86D6 1A           	ld a,(de) ;первая буква имени
1399  86D7              	;второй элемент узнать адрес записи в каталоге
1400  86D7 DD 6E 02     	ld l,(ix+02)
1401  86DA DD 66 03     	ld h,(ix+03)
1402  86DD              	;сравнить с другой первой буквой
1403  86DD BE           	cp (hl)
1404  86DE 38 11        	jr c,sort_index_cl_skip
1405  86E0
1406  86E0 3E 01        	ld a,1
1407  86E2 32 08 87     	ld (sort_index_flag),a ;флаг были изменения
1408  86E5              	;поменять местами элементы индекса
1409  86E5 DD 75 00     	ld (ix+00),l
1410  86E8 DD 74 01     	ld (ix+01),h
1411  86EB DD 73 02     	ld (ix+02),e
1412  86EE DD 72 03     	ld (ix+03),d
1413  86F1
1414  86F1              sort_index_cl_skip
1415  86F1              	;следующий
1416  86F1 DD 23        	inc ix
1417  86F3 DD 23        	inc ix
1418  86F5
1419  86F5 0B           	dec bc
1420  86F6 78           	ld a,b
1421  86F7 B1           	or c
1422  86F8 20 D6        	jr nz,sort_index_cl
1423  86FA
1424  86FA DD E1        	pop ix
1425  86FC C1           	pop bc
1426  86FD 0B           	dec bc
1427  86FE
1428  86FE 3A 08 87     	ld a,(sort_index_flag)
1429  8701 B7           	or a
1430  8702 C8           	ret z ;если не было изменений за проход, можно выходить
1431  8703
1432  8703 78           	ld a,b
1433  8704 B1           	or c
1434  8705 20 BE        	jr nz,sort_index_cl_gen
1435  8707
1436  8707 C9           	ret
1437  8708
1438  8708 00           sort_index_flag db 0;
1439  8709
1440  8709
1441  8709              sort_toggle ;переключение сортировки
1442  8709 3A 28 87     	ld a,(sort_enable_flag)
1443  870C EE 01        	xor 1
1444  870E 32 28 87     	ld (sort_enable_flag),a
1445  8711 3E 66        	ld a,"f" ;вкл
1446  8713 20 02        	jr nz,sort_toggle1
1447  8715 3E 4E        	ld a,"N";выкл
1448  8717              sort_toggle1
1449  8717 32 2B A5     	ld (msg_menu_main2+5),a
1450  871A
1451  871A CD 76 85     	call sort_dir
1452  871D CD B0 87     	call print_menu_main
1453  8720 3E 01        	ld a,1
1454  8722 32 73 A4     	ld (print_panel_r_flag),a
1455  8725
1456  8725 C3 96 80     	jp nc_wait
1457  8728 00           sort_enable_flag db 0 ;флаг сортировки
1458  8729
1459  8729
1460  8729
1461  8729
1462  8729              LFN_toggle ;переключение сортировки
1463  8729 3A 45 87     	ld a,(LFN_enable_flag)
1464  872C EE 01        	xor 1
1465  872E 32 45 87     	ld (LFN_enable_flag),a
1466  8731 3E 66        	ld a,"f" ;вкл
1467  8733 20 02        	jr nz,LFN_toggle1
1468  8735 3E 4E        	ld a,"N";выкл
1469  8737              LFN_toggle1
1470  8737 32 24 A5     	ld (msg_menu_main1+5),a
1471  873A
1472  873A              	;call sort_dir
1473  873A CD B0 87     	call print_menu_main
1474  873D 3E 01        	ld a,1
1475  873F 32 73 A4     	ld (print_panel_r_flag),a
1476  8742
1477  8742 C3 96 80     	jp nc_wait
1478  8745 00           LFN_enable_flag db 0 ;флаг сортировки
1479  8746
1480  8746
1481  8746
1482  8746
1483  8746
1484  8746              format_name ;подогнать имя под стандарт filename.ext
1485  8746              ;вх: HL - имя в каталоге
1486  8746 E5           	push hl
1487  8747 21 4A A2     	ld hl,file_name_cur
1488  874A 11 4B A2     	ld de,file_name_cur+1 ;почистить
1489  874D 01 FF 00     	ld bc,256-1
1490  8750 36 00        	ld (hl),0
1491  8752 ED B0        	ldir
1492  8754
1493  8754 E1           	pop hl
1494  8755 E5           	push hl
1495  8756
1496  8756 11 4A A2     	ld de,file_name_cur ;куда
1497  8759 01 FF 08     	ld bc,#08ff
1498  875C              format_name_cl
1499  875C 7E           	ld a,(hl)
1500  875D FE 21        	cp " "+1
1501  875F 38 04        	jr c,format_name_skip
1502  8761 ED A0        	ldi
1503  8763 10 F7        	djnz format_name_cl
1504  8765              format_name_skip
1505  8765 3E 2E        	ld a,"."
1506  8767 12           	ld (de),a
1507  8768
1508  8768 13           	inc de
1509  8769 E1           	pop hl
1510  876A 01 08 00     	ld bc,8 ;перейти на расширение
1511  876D 09           	add hl,bc
1512  876E
1513  876E 01 FF 03     	ld bc,#03ff
1514  8771              format_name_cl2
1515  8771 7E           	ld a,(hl)
1516  8772 FE 21        	cp " "+1
1517  8774 38 04        	jr c,format_name_skip2
1518  8776 ED A0        	ldi
1519  8778 10 F7        	djnz format_name_cl2
1520  877A              format_name_skip2
1521  877A C9           	ret
1522  877B
1523  877B              print_rect_r ;печать рамки правой
1524  877B 3E 0F        	ld a,color_backgr ;цвет
1525  877D 06 0C        	ld b,#c
1526  877F              	OS_SET_COLOR
1526  877F 0E 06       >    ld c,#06
1526  8781 E7          >    rst #20
1527  8782 11 28 00     	ld de,#0028 ;xy
1528  8785              	OS_SET_XY
1528  8785 0E 01       >    ld c,#01
1528  8787 E7          >    rst #20
1529  8788 21 8F A4     	ld hl,rect_1
1530  878B              	OS_PRINTZ
1530  878B 0E 09       >    ld c,#09
1530  878D E7          >    rst #20
1531  878E
1532  878E 11 28 01     	ld de,#0128 ;xy
1533  8791 06 16        	ld b,24-2 ;цикл
1534  8793              print_rect_r_cl
1535  8793 C5           	push bc
1536  8794 D5           	push de
1537  8795              	OS_SET_XY
1537  8795 0E 01       >    ld c,#01
1537  8797 E7          >    rst #20
1538  8798 21 B8 A4     	ld hl,rect_2
1539  879B              	OS_PRINTZ
1539  879B 0E 09       >    ld c,#09
1539  879D E7          >    rst #20
1540  879E D1           	pop de
1541  879F 14           	inc d
1542  87A0 C1           	pop bc
1543  87A1 10 F0        	djnz print_rect_r_cl
1544  87A3
1545  87A3
1546  87A3 11 28 17     	ld de,#1728 ;xy
1547  87A6              	OS_SET_XY
1547  87A6 0E 01       >    ld c,#01
1547  87A8 E7          >    rst #20
1548  87A9 21 E1 A4     	ld hl,rect_3
1549  87AC              	OS_PRINTZ
1549  87AC 0E 09       >    ld c,#09
1549  87AE E7          >    rst #20
1550  87AF C9           	ret
1551  87B0
1552  87B0              print_menu_main ;печать основного меню
1553  87B0 3E 07        	ld a,color_default ;цвет
1554  87B2 06 0C        	ld b,#c
1555  87B4              	OS_SET_COLOR
1555  87B4 0E 06       >    ld c,#06
1555  87B6 E7          >    rst #20
1556  87B7
1557  87B7 11 00 18     	ld de,#1800+0*8
1558  87BA              	OS_SET_XY
1558  87BA 0E 01       >    ld c,#01
1558  87BC E7          >    rst #20
1559  87BD 3E 31        	ld a,"1" ;пункт 1
1560  87BF              	OS_PRINT_CHARF
1560  87BF D7          >	rst #10
1561  87C0 11 08 18     	ld de,#1800+1*8
1562  87C3              	OS_SET_XY
1562  87C3 0E 01       >    ld c,#01
1562  87C5 E7          >    rst #20
1563  87C6 3E 32        	ld a,"2" ;пункт 2
1564  87C8              	OS_PRINT_CHARF
1564  87C8 D7          >	rst #10
1565  87C9 11 10 18     	ld de,#1800+2*8
1566  87CC              	OS_SET_XY
1566  87CC 0E 01       >    ld c,#01
1566  87CE E7          >    rst #20
1567  87CF 3E 33        	ld a,"3" ;пункт 3
1568  87D1              	OS_PRINT_CHARF
1568  87D1 D7          >	rst #10
1569  87D2 11 18 18     	ld de,#1800+3*8
1570  87D5              	OS_SET_XY
1570  87D5 0E 01       >    ld c,#01
1570  87D7 E7          >    rst #20
1571  87D8 3E 34        	ld a,"4" ;пункт 4
1572  87DA              	OS_PRINT_CHARF
1572  87DA D7          >	rst #10
1573  87DB
1574  87DB
1575  87DB 3E 28        	ld a,color_backgr_hi ;цвет
1576  87DD 06 0C        	ld b,#c
1577  87DF              	OS_SET_COLOR
1577  87DF 0E 06       >    ld c,#06
1577  87E1 E7          >    rst #20
1578  87E2
1579  87E2 11 01 18     	ld de,#1800+0*8+1
1580  87E5              	OS_SET_XY
1580  87E5 0E 01       >    ld c,#01
1580  87E7 E7          >    rst #20
1581  87E8 21 1F A5     	ld hl,msg_menu_main1
1582  87EB              	OS_PRINTZ
1582  87EB 0E 09       >    ld c,#09
1582  87ED E7          >    rst #20
1583  87EE 11 09 18     	ld de,#1800+1*8+1
1584  87F1              	OS_SET_XY
1584  87F1 0E 01       >    ld c,#01
1584  87F3 E7          >    rst #20
1585  87F4 21 26 A5     	ld hl,msg_menu_main2
1586  87F7              	OS_PRINTZ
1586  87F7 0E 09       >    ld c,#09
1586  87F9 E7          >    rst #20
1587  87FA 11 11 18     	ld de,#1800+2*8+1
1588  87FD              	OS_SET_XY
1588  87FD 0E 01       >    ld c,#01
1588  87FF E7          >    rst #20
1589  8800 21 2D A5     	ld hl,msg_menu_main3
1590  8803              	OS_PRINTZ
1590  8803 0E 09       >    ld c,#09
1590  8805 E7          >    rst #20
1591  8806 11 19 18     	ld de,#1800+3*8+1
1592  8809              	OS_SET_XY
1592  8809 0E 01       >    ld c,#01
1592  880B E7          >    rst #20
1593  880C 21 34 A5     	ld hl,msg_menu_main4
1594  880F              	OS_PRINTZ
1594  880F 0E 09       >    ld c,#09
1594  8811 E7          >    rst #20
1595  8812 C9           	ret
1596  8813
1597  8813
1598  8813
1599  8813              ;прочитать файл не больше #4000 байт
1600  8813              ;вх: hl - имя файла
1601  8813              ;вых: CY = 1 = ошибка, hl - размер прочитанного
1602  8813              load_file
1603  8813              	;ld hl,file_name_cur
1604  8813              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
1604  8813 0E 21       >    ld c,#21
1604  8815 E7          >    rst #20
1605  8816 DA 61 88     	jp c,load_file_error
1606  8819 22 81 88     	ld (load_file_size),hl ;размер
1607  881C              ;load_file_ok
1608  881C 32 5F A4     	ld (file_id_cur_r),a
1609  881F              	;проверка длины файла не больше #4000
1610  881F 7A           	ld	a,d ;самые старшие байты длины
1611  8820 B3           	or e
1612  8821 28 16        	jr z,load_file_size_ok ;если не слищком большой
1613  8823              load_file_too_big
1614  8823              	;файл больше буфера
1615  8823 3E 0A        	ld a,color_error ;цвет ошибки
1616  8825 06 0C        	ld b,#c
1617  8827              	OS_SET_COLOR
1617  8827 0E 06       >    ld c,#06
1617  8829 E7          >    rst #20
1618  882A
1619  882A 21 47 A5     	ld hl,msg_file_too_big
1620  882D              	OS_PRINTZ
1620  882D 0E 09       >    ld c,#09
1620  882F E7          >    rst #20
1621  8830
1622  8830 3E 0F        	ld a,color_backgr ;цвет основной
1623  8832 06 0C        	ld b,#c
1624  8834              	OS_SET_COLOR
1624  8834 0E 06       >    ld c,#06
1624  8836 E7          >    rst #20
1625  8837
1626  8837              	;call delay
1627  8837 37           	scf
1628  8838 C9           	ret
1629  8839
1630  8839
1631  8839              load_file_size_ok
1632  8839 7C           	ld	a,h ;младший старший байт длины
1633  883A FE 40        	cp #40
1634  883C 38 06        	jr c,load_file_size_ok_small
1635  883E 20 E3        	jr nz,load_file_too_big
1636  8840 2C           	inc l
1637  8841 2D           	dec l
1638  8842 20 DF        	jr nz,load_file_too_big
1639  8844
1640  8844
1641  8844              load_file_size_ok_small
1642  8844              	;проверка на 0
1643  8844 7C           	ld a,h
1644  8845 B5           	or l
1645  8846 CA 61 88     	jp z,load_file_error
1646  8849 54           	ld d,h ;размер
1647  884A 5D           	ld e,l
1648  884B 21 00 C0     	ld hl,buffer_cat ;куда
1649  884E 3A 5F A4     	ld a,(file_id_cur_r)
1650  8851              	OS_FILE_READ ;загрузить
1650  8851 0E 23       >    ld c,#23
1650  8853 E7          >    rst #20
1651  8854 38 0B        	jr c,load_file_error
1652  8856
1653  8856 3A 5F A4     	ld a,(file_id_cur_r)
1654  8859              	OS_FILE_CLOSE ;A - id file
1654  8859 0E 25       >    ld c,#25
1654  885B E7          >    rst #20
1655  885C
1656  885C 2A 81 88     	ld hl,(load_file_size)
1657  885F AF           	xor a
1658  8860 C9           	ret
1659  8861
1660  8861
1661  8861
1662  8861              load_file_error
1663  8861 3E 0A        	ld a,color_error ;цвет ошибки
1664  8863 06 0C        	ld b,#c
1665  8865              	OS_SET_COLOR
1665  8865 0E 06       >    ld c,#06
1665  8867 E7          >    rst #20
1666  8868 21 3B A5     		ld hl,msg_file_error
1667  886B              		OS_PRINTZ
1667  886B 0E 09       >    ld c,#09
1667  886D E7          >    rst #20
1668  886E 3E 0F        	ld a,color_backgr ;цвет основной
1669  8870 06 0C        	ld b,#c
1670  8872              	OS_SET_COLOR
1670  8872 0E 06       >    ld c,#06
1670  8874 E7          >    rst #20
1671  8875
1672  8875 3A 5F A4     		ld a,(file_id_cur_r)
1673  8878 FE FF        		cp 255
1674  887A 28 03        		jr z,load_file_error1
1675  887C              		OS_FILE_CLOSE ;A - id file
1675  887C 0E 25       >    ld c,#25
1675  887E E7          >    rst #20
1676  887F              load_file_error1
1677  887F
1678  887F              	;call delay
1679  887F 37           		scf ;ошибка
1680  8880 C9           		ret
1681  8881 00 00        load_file_size dw 0 ;временно
1682  8883
1683  8883
1684  8883
1685  8883
1686  8883
1687  8883
1688  8883
1689  8883              ;добавить в историю положение курсора
1690  8883              file_r_num_hyst_add
1691  8883 3A 60 A4     	ld a,(file_r_num_hyst_cur)
1692  8886 3C           	inc a
1693  8887 32 60 A4     	ld (file_r_num_hyst_cur),a
1694  888A FE 0A        	cp file_r_num_hyst_tabl_max
1695  888C 30 19        	jr nc,file_r_num_hyst_add_err
1696  888E              	;узнать адрес в таблице
1697  888E 6F           	ld l,a
1698  888F 26 00        	ld h,0
1699  8891 29           	add hl,hl ;по 4 байта на запись
1700  8892 29           	add hl,hl
1701  8893 01 A6 AE     	ld bc,file_r_num_hyst_tabl
1702  8896 09           	add hl,bc
1703  8897              	;записать
1704  8897 ED 4B 58 A4  	ld bc,(file_r_num_cur)
1705  889B 71           	ld (hl),c
1706  889C 23           	inc hl
1707  889D 70           	ld (hl),b
1708  889E 23           	inc hl
1709  889F ED 4B 48 A2  	ld bc,(file_r_cur_focus)
1710  88A3 71           	ld (hl),c
1711  88A4 23           	inc hl
1712  88A5 70           	ld (hl),b
1713  88A6              	; ld (file_r_num_old),hl
1714  88A6 C9           	ret
1715  88A7
1716  88A7              file_r_num_hyst_add_err
1717  88A7              	;место для истории кончилось
1718  88A7 C9           	ret
1719  88A8
1720  88A8
1721  88A8
1722  88A8              ;взять из истории положение курсора
1723  88A8              file_r_num_hyst_get
1724  88A8 3A 60 A4     	ld a,(file_r_num_hyst_cur)
1725  88AB B7           	or a
1726  88AC 28 26        	jr z,file_r_num_hyst_get_err
1727  88AE 3D           	dec a
1728  88AF 32 60 A4     	ld (file_r_num_hyst_cur),a ;будет следующий
1729  88B2 3C           	inc a
1730  88B3 FE 0A        	cp file_r_num_hyst_tabl_max
1731  88B5 30 1D        	jr nc,file_r_num_hyst_get_err
1732  88B7              	;узнать адрес в таблице
1733  88B7 6F           	ld l,a
1734  88B8 26 00        	ld h,0
1735  88BA 29           	add hl,hl ;по 4 байта на запись
1736  88BB 29           	add hl,hl
1737  88BC 01 A6 AE     	ld bc,file_r_num_hyst_tabl
1738  88BF 09           	add hl,bc
1739  88C0              	;считать
1740  88C0              	;ld bc,(file_r_num_cur)
1741  88C0 4E           	ld c,(hl)
1742  88C1 23           	inc hl
1743  88C2 46           	ld b,(hl)
1744  88C3 23           	inc hl
1745  88C4              	;ld bc,(file_r_cur_focus)
1746  88C4 5E           	ld e,(hl)
1747  88C5 23           	inc hl
1748  88C6 56           	ld d,(hl)
1749  88C7              	;сравнить. а вдруг в этой папке уже нет столько файлов
1750  88C7              	; ld hl,(file_r_all)
1751  88C7              	; and a
1752  88C7              	; sbc hl,bc
1753  88C7              	; jr c,file_r_num_hyst_get_err
1754  88C7              	;восстановить
1755  88C7 ED 43 58 A4  	ld (file_r_num_cur),bc
1756  88CB ED 43 5A A4  	ld (file_r_num_old),bc
1757  88CF ED 53 48 A2  	ld (file_r_cur_focus),de
1758  88D3 C9           	ret
1759  88D4
1760  88D4
1761  88D4
1762  88D4              file_r_num_hyst_get_err
1763  88D4              	;если в истории не нашли
1764  88D4 21 00 00     	ld hl,0
1765  88D7 22 58 A4     	ld (file_r_num_cur),hl
1766  88DA 22 5A A4     	ld (file_r_num_old),hl
1767  88DD 22 48 A2     	ld (file_r_cur_focus),hl
1768  88E0 C9           	ret
1769  88E1
1770  88E1
1771  88E1
1772  88E1
1773  88E1
1774  88E1              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 88E1              view_file
   2+ 88E1              	;просмотр файла как текста
   3+ 88E1
   4+ 88E1 2A 46 A2     	ld hl,(file_r_all)
   5+ 88E4 7D           	ld a,l
   6+ 88E5 B4           	or h
   7+ 88E6 CA DC 89     	jp z,view_file_ex ;защита
   8+ 88E9 2A 58 A4     	ld hl,(file_r_num_cur)
   9+ 88EC CD 90 82     	call calc_deskr
  10+ 88EF DD 7E 0B     	ld a,(ix+#0b)
  11+ 88F2 FE 10        	cp #10 ;признак каталога
  12+ 88F4 CA DC 89     	jp z,view_file_ex
  13+ 88F7 FE 30        	cp #30 ;признак каталога
  14+ 88F9 CA DC 89     	jp z,view_file_ex
  15+ 88FC
  16+ 88FC CD 46 87     	call format_name ;обработать имя файла
  17+ 88FF
  18+ 88FF
  19+ 88FF
  20+ 88FF 3A 61 A4     	ld a,(page_ext01) ;доп страница для данных
  21+ 8902              	OS_SET_PAGE_SLOT3
  21+ 8902 0E 1C       >    ld c,#1c
  21+ 8904 E7          >    rst #20
  22+ 8905
  23+ 8905 11 00 00     	ld de,#0000
  24+ 8908              	OS_SET_XY
  24+ 8908 0E 01       >    ld c,#01
  24+ 890A E7          >    rst #20
  25+ 890B
  26+ 890B              	;обнулить переменные
  27+ 890B AF           	xor a
  28+ 890C 32 09 8C     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  29+ 890F              	;ld (view_file_bot_flag),a  ;
  30+ 890F 21 FF FF     	ld hl,#ffff
  31+ 8912 22 0A 8C     	ld (view_file_end),hl ;конец файла тут
  32+ 8915 23           	inc hl
  33+ 8916 22 01 8C     	ld (view_move_right_val),hl
  34+ 8919
  35+ 8919              	;push bc
  36+ 8919 CD F2 80     	call clear_buf
  37+ 891C              	;pop bc
  38+ 891C
  39+ 891C 3E FF        	ld a,255
  40+ 891E 32 5F A4     	ld (file_id_cur_r),a
  41+ 8921 21 4A A2     	ld hl,file_name_cur		;строка с именем
  42+ 8924              	OS_FILE_OPEN
  42+ 8924 0E 21       >    ld c,#21
  42+ 8926 E7          >    rst #20
  43+ 8927 30 0E        	jr nc,view_file_open_ok
  44+ 8929              view_file_file_error
  45+ 8929 21 3B A5     	ld hl,msg_file_error
  46+ 892C              	OS_PRINTZ
  46+ 892C 0E 09       >    ld c,#09
  46+ 892E E7          >    rst #20
  47+ 892F 06 64        	ld b,2*50
  48+ 8931 CD EE 80     	call delay1
  49+ 8934 C3 C1 89     	jp view_file_wait_ex
  50+ 8937
  51+ 8937              view_file_open_ok
  52+ 8937 32 5F A4     	ld (file_id_cur_r),a
  53+ 893A              	;проверка длины файла не больше #4000
  54+ 893A 7A           	ld	a,d ;самые старшие байты длины
  55+ 893B B3           	or e
  56+ 893C 28 11        	jr z,view_file_size_ok ;если не слищком большой
  57+ 893E              view_file_too_big
  58+ 893E              	;файл больше буфера
  59+ 893E 11 00 40     	ld de,#4000 ;размер одной первой части
  60+ 8941 21 00 C0     	ld hl,buffer_cat
  61+ 8944 3A 5F A4     	ld a,(file_id_cur_r)
  62+ 8947              	OS_FILE_READ ;загрузить
  62+ 8947 0E 23       >    ld c,#23
  62+ 8949 E7          >    rst #20
  63+ 894A 38 DD        	jr c,view_file_file_error
  64+ 894C
  65+ 894C C3 78 89     	jp view_file_readed
  66+ 894F
  67+ 894F              view_file_size_ok
  68+ 894F 7C           	ld	a,h ;младший старший байт длины
  69+ 8950 FE 40        	cp #40
  70+ 8952 38 06        	jr c,view_file_size_ok_small
  71+ 8954 20 E8        	jr nz,view_file_too_big
  72+ 8956 2C           	inc l
  73+ 8957 2D           	dec l
  74+ 8958 20 E4        	jr nz,view_file_too_big
  75+ 895A
  76+ 895A
  77+ 895A              view_file_size_ok_small
  78+ 895A              	;проверка на 0
  79+ 895A 7C           	ld a,h
  80+ 895B B5           	or l
  81+ 895C CA 29 89     	jp z,view_file_file_error
  82+ 895F 54           	ld d,h ;размер
  83+ 8960 5D           	ld e,l
  84+ 8961              	;узнать где конец файла
  85+ 8961 01 00 C0     	ld bc,buffer_cat
  86+ 8964 09           	add hl,bc
  87+ 8965 22 0A 8C     	ld (view_file_end),hl ;конец файла тут
  88+ 8968              	;размер не большой, прочитаем
  89+ 8968 21 00 C0     	ld hl,buffer_cat
  90+ 896B 3A 5F A4     	ld a,(file_id_cur_r)
  91+ 896E              	OS_FILE_READ ;загрузить
  91+ 896E 0E 23       >    ld c,#23
  91+ 8970 E7          >    rst #20
  92+ 8971 38 B6        	jr c,view_file_file_error
  93+ 8973
  94+ 8973 3E 01        	ld a,1
  95+ 8975 32 09 8C     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  96+ 8978
  97+ 8978              view_file_readed
  98+ 8978              	;файл прочитан
  99+ 8978              	OS_CLS ;почистить экран
  99+ 8978 0E 00       >    ld c,#00
  99+ 897A E7          >    rst #20
 100+ 897B
 101+ 897B 21 00 C0     	ld hl,buffer_cat
 102+ 897E 22 03 8C     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
 103+ 8981 22 05 8C     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
 104+ 8984
 105+ 8984 CD AD 8A     	call print_file_text
 106+ 8987
 107+ 8987
 108+ 8987 CD 78 8A     	call print_menu_view ;меню
 109+ 898A CD 93 8A     	call print_menu_view_top ;инфо
 110+ 898D
 111+ 898D CD 4A 81     	call release_key
 112+ 8990
 113+ 8990              view_file_wait ;цикл ожидания клавиши
 114+ 8990              	OS_WAIT
 114+ 8990 DF          >	rst #18
 115+ 8991              	OS_GET_CHAR
 115+ 8991 0E 10       >    ld c,#10
 115+ 8993 E7          >    rst #20
 116+ 8994 FE FF        	cp 255
 117+ 8996 28 F8        	jr z,view_file_wait
 118+ 8998 FE 33        	cp "3"
 119+ 899A 28 25        	jr z,view_file_wait_ex
 120+ 899C FE 0A        	cp 10 ;вниз
 121+ 899E CA EF 89     	jp z,view_line_down
 122+ 89A1 FE 0B        	cp 11 ;вверх
 123+ 89A3 CA 05 8A     	jp z,view_line_up
 124+ 89A6 FE 09        	cp 09 ;вправо
 125+ 89A8 CA 1A 8A     	jp z,view_right
 126+ 89AB FE 08        	cp 08 ;влево
 127+ 89AD CA 2C 8A     	jp z,view_left
 128+ 89B0 FE 04        	cp 04 ;страница вверх
 129+ 89B2 CA 3E 8A     	jp z,view_page_up
 130+ 89B5 FE 05        	cp 05 ;страница вниз
 131+ 89B7 CA 5B 8A     	jp z,view_page_down
 132+ 89BA FE 18        	cp 24 ;break
 133+ 89BC CA 46 83     	jp z,exit
 134+ 89BF 18 CF        	jr view_file_wait
 135+ 89C1
 136+ 89C1              view_file_wait_ex
 137+ 89C1 3A 5F A4     	ld a,(file_id_cur_r)
 138+ 89C4 FE FF        	cp 255
 139+ 89C6 28 03        	jr z,view_file_wait_ex1
 140+ 89C8              	OS_FILE_CLOSE ;A - id file
 140+ 89C8 0E 25       >    ld c,#25
 140+ 89CA E7          >    rst #20
 141+ 89CB              view_file_wait_ex1
 142+ 89CB 3A 71 A4     	ld a,(page_main) ;основная страница с каталогом
 143+ 89CE              	OS_SET_PAGE_SLOT3
 143+ 89CE 0E 1C       >    ld c,#1c
 143+ 89D0 E7          >    rst #20
 144+ 89D1              	;почистить экран
 145+ 89D1              	OS_CLS
 145+ 89D1 0E 00       >    ld c,#00
 145+ 89D3 E7          >    rst #20
 146+ 89D4
 147+ 89D4 3E 01        	ld a,1 ;флаг чтобы вернуть позицию курсора
 148+ 89D6 32 80 82     	ld (key_enter_dir_flag),a
 149+ 89D9 C3 54 80     	jp start_nc_warm ;перезагрузить папку
 150+ 89DC
 151+ 89DC              view_file_ex
 152+ 89DC 3A 5F A4     	ld a,(file_id_cur_r)
 153+ 89DF FE FF        	cp 255
 154+ 89E1 28 03        	jr z,view_file_ex1
 155+ 89E3              	OS_FILE_CLOSE ;A - id file
 155+ 89E3 0E 25       >    ld c,#25
 155+ 89E5 E7          >    rst #20
 156+ 89E6              view_file_ex1
 157+ 89E6 3A 71 A4     	ld a,(page_main) ;основная страница с каталогом
 158+ 89E9              	OS_SET_PAGE_SLOT3
 158+ 89E9 0E 1C       >    ld c,#1c
 158+ 89EB E7          >    rst #20
 159+ 89EC C3 96 80     	jp nc_wait
 160+ 89EF
 161+ 89EF
 162+ 89EF
 163+ 89EF              view_line_down ;вниз на строчку
 164+ 89EF 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 165+ 89F2 22 03 8C     	ld (view_file_pos_cur),hl
 166+ 89F5 CD D4 8B     	call next_line ;вперёд на строку
 167+ 89F8 38 96        	jr c,view_file_wait ;если не удачно
 168+ 89FA 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 169+ 89FD 22 05 8C     	ld (view_file_pos_cur_focus),hl
 170+ 8A00 CD AD 8A     	call print_file_text ;напечатать всю страницу
 171+ 8A03 18 8B        	jr view_file_wait
 172+ 8A05
 173+ 8A05              view_line_up ;вверх на строчку
 174+ 8A05 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 175+ 8A08 22 03 8C     	ld (view_file_pos_cur),hl
 176+ 8A0B CD E2 8B     	call prev_line ;
 177+ 8A0E              	;jr c,view_file_wait ;если не удачно
 178+ 8A0E 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 179+ 8A11 22 05 8C     	ld (view_file_pos_cur_focus),hl
 180+ 8A14 CD AD 8A     	call print_file_text ;напечатать всю страницу
 181+ 8A17 C3 90 89     	jp view_file_wait
 182+ 8A1A
 183+ 8A1A
 184+ 8A1A              view_right ;вправо
 185+ 8A1A 2A 01 8C     	ld hl,(view_move_right_val)
 186+ 8A1D 23           	inc hl
 187+ 8A1E 7C           	ld a,h
 188+ 8A1F B5           	or l
 189+ 8A20 CA 90 89     	jp z,view_file_wait
 190+ 8A23 22 01 8C     	ld (view_move_right_val),hl
 191+ 8A26 CD AD 8A     	call print_file_text ;напечатать всю страницу
 192+ 8A29 C3 90 89     	jp view_file_wait
 193+ 8A2C
 194+ 8A2C              view_left ;влево
 195+ 8A2C 2A 01 8C     	ld hl,(view_move_right_val)
 196+ 8A2F 7C           	ld a,h
 197+ 8A30 B5           	or l
 198+ 8A31 CA 90 89     	jp z,view_file_wait
 199+ 8A34 2B           	dec hl
 200+ 8A35 22 01 8C     	ld (view_move_right_val),hl
 201+ 8A38 CD AD 8A     	call print_file_text ;напечатать всю страницу
 202+ 8A3B C3 90 89     	jp view_file_wait
 203+ 8A3E
 204+ 8A3E
 205+ 8A3E
 206+ 8A3E              view_page_up ;на страницу назад
 207+ 8A3E 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 208+ 8A41 22 03 8C     	ld (view_file_pos_cur),hl
 209+ 8A44 06 16        	ld b,view_text_bot-2
 210+ 8A46              view_page_up_cl
 211+ 8A46 CD E2 8B     	call prev_line ;
 212+ 8A49 38 04        	jr c,view_page_up_ex ;если не удачно
 213+ 8A4B 28 02        	jr z,view_page_up_ex
 214+ 8A4D 10 F7        	djnz view_page_up_cl
 215+ 8A4F              view_page_up_ex
 216+ 8A4F 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 217+ 8A52 22 05 8C     	ld (view_file_pos_cur_focus),hl
 218+ 8A55 CD AD 8A     	call print_file_text ;напечатать всю страницу
 219+ 8A58 C3 90 89     	jp view_file_wait
 220+ 8A5B
 221+ 8A5B
 222+ 8A5B
 223+ 8A5B              view_page_down ;на страницу вперёд
 224+ 8A5B 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 225+ 8A5E 22 03 8C     	ld (view_file_pos_cur),hl
 226+ 8A61 06 16        	ld b,view_text_bot-2
 227+ 8A63              view_page_down_cl
 228+ 8A63 CD D4 8B     	call next_line ;
 229+ 8A66 38 04        	jr c,view_page_down_ex ;если не удачно
 230+ 8A68 28 02        	jr z,view_page_down_ex
 231+ 8A6A 10 F7        	djnz view_page_down_cl
 232+ 8A6C              view_page_down_ex
 233+ 8A6C 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 234+ 8A6F 22 05 8C     	ld (view_file_pos_cur_focus),hl
 235+ 8A72 CD AD 8A     	call print_file_text ;напечатать всю страницу
 236+ 8A75 C3 90 89     	jp view_file_wait
 237+ 8A78
 238+ 8A78
 239+ 8A78
 240+ 8A78              print_menu_view ;печать меню просмотрщика
 241+ 8A78 3E 18        	ld a,#18
 242+ 8A7A 06 28        	ld b,color_backgr_hi ;цвет
 243+ 8A7C              	OS_PAINT_LINE ;линия внизу
 243+ 8A7C 0E 04       >    ld c,#04
 243+ 8A7E E7          >    rst #20
 244+ 8A7F 3E 28        	ld a,color_backgr_hi ;цвет
 245+ 8A81 06 0C        	ld b,#c
 246+ 8A83              	OS_SET_COLOR
 246+ 8A83 0E 06       >    ld c,#06
 246+ 8A85 E7          >    rst #20
 247+ 8A86 11 10 18     	ld de,#1800+2*8
 248+ 8A89              	OS_SET_XY
 248+ 8A89 0E 01       >    ld c,#01
 248+ 8A8B E7          >    rst #20
 249+ 8A8C 21 FA 8B     	ld hl,msg_menu_view
 250+ 8A8F              	OS_PRINTZ
 250+ 8A8F 0E 09       >    ld c,#09
 250+ 8A91 E7          >    rst #20
 251+ 8A92 C9           	ret
 252+ 8A93
 253+ 8A93              print_menu_view_top ;печать меню просмотрщика верхнее
 254+ 8A93 AF           	xor a
 255+ 8A94 06 28        	ld b,color_backgr_hi ;цвет
 256+ 8A96              	OS_PAINT_LINE ;линия вверху
 256+ 8A96 0E 04       >    ld c,#04
 256+ 8A98 E7          >    rst #20
 257+ 8A99 3E 28        	ld a,color_backgr_hi ;цвет
 258+ 8A9B 06 0C        	ld b,#c
 259+ 8A9D              	OS_SET_COLOR
 259+ 8A9D 0E 06       >    ld c,#06
 259+ 8A9F E7          >    rst #20
 260+ 8AA0 11 24 00     	ld de,#0024
 261+ 8AA3              	OS_SET_XY
 261+ 8AA3 0E 01       >    ld c,#01
 261+ 8AA5 E7          >    rst #20
 262+ 8AA6 21 4A A2     	ld hl,file_name_cur
 263+ 8AA9              	OS_PRINTZ
 263+ 8AA9 0E 09       >    ld c,#09
 263+ 8AAB E7          >    rst #20
 264+ 8AAC C9           	ret
 265+ 8AAD
 266+ 8AAD
 267+ 8AAD
 268+ 8AAD              print_file_text	;печать текущей части файла в консоль
 269+ 8AAD 3E 04        	ld a,color_view_text ;цвет
 270+ 8AAF 06 0C        	ld b,#c
 271+ 8AB1              	OS_SET_COLOR
 271+ 8AB1 0E 06       >    ld c,#06
 271+ 8AB3 E7          >    rst #20
 272+ 8AB4
 273+ 8AB4 3E 01        	ld a,view_text_top ;первая строка
 274+ 8AB6 32 07 8C     	ld (view_file_y_cur),a
 275+ 8AB9 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 276+ 8ABC 22 03 8C     	ld (view_file_pos_cur),hl
 277+ 8ABF              print_file_text_cl
 278+ 8ABF 2A 03 8C     	ld hl,(view_file_pos_cur)
 279+ 8AC2 CD E8 8A     	call print_line_text
 280+ 8AC5 38 0C        	jr c,print_file_text_ex
 281+ 8AC7
 282+ 8AC7              	; call next_line ;найти следующую строку
 283+ 8AC7              	; ret c
 284+ 8AC7
 285+ 8AC7 3A 07 8C     	ld a,(view_file_y_cur)
 286+ 8ACA 3C           	inc a
 287+ 8ACB 32 07 8C     	ld (view_file_y_cur),a
 288+ 8ACE FE 18        	cp view_text_bot
 289+ 8AD0 38 ED        	jr c,print_file_text_cl
 290+ 8AD2 C9           	ret
 291+ 8AD3
 292+ 8AD3              print_file_text_ex
 293+ 8AD3              	;тут очистить остальные строки
 294+ 8AD3 3A 07 8C     	ld a,(view_file_y_cur)
 295+ 8AD6 3C           	inc a
 296+ 8AD7 FE 18        	cp view_text_bot
 297+ 8AD9 30 0B        	jr nc,print_file_text_ex2
 298+ 8ADB 67           	ld h,a
 299+ 8ADC 32 07 8C     	ld (view_file_y_cur),a
 300+ 8ADF 3E 20        	ld a," "
 301+ 8AE1              	OS_FILL_LINE ;очистить строку
 301+ 8AE1 0E 03       >    ld c,#03
 301+ 8AE3 E7          >    rst #20
 302+ 8AE4 18 ED        	jr print_file_text_ex
 303+ 8AE6              print_file_text_ex2
 304+ 8AE6 37           	scf
 305+ 8AE7 C9           	ret
 306+ 8AE8
 307+ 8AE8
 308+ 8AE8
 309+ 8AE8              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 310+ 8AE8              ;вх: hl - адрес строки
 311+ 8AE8 CD 38 8B     	call view_move_right ;промотать направо. если надо
 312+ 8AEB              	;установить позицию
 313+ 8AEB 3A 07 8C     	ld a,(view_file_y_cur)
 314+ 8AEE 57           	ld d,a
 315+ 8AEF AF           	xor a
 316+ 8AF0 32 08 8C     	ld (view_file_x_cur),a
 317+ 8AF3 5F           	ld e,a
 318+ 8AF4              	OS_SET_XY 	;yx
 318+ 8AF4 0E 01       >    ld c,#01
 318+ 8AF6 E7          >    rst #20
 319+ 8AF7              print_line_text_cl ;цикл
 320+ 8AF7
 321+ 8AF7 7E           	ld a,(hl)
 322+ 8AF8 FE 0A        	cp 10 ;этот код не печатаем
 323+ 8AFA 28 14        	jr z,print_line_text_skip
 324+ 8AFC FE FF        	cp #ff ;этот код не печатаем
 325+ 8AFE 28 10        	jr z,print_line_text_skip
 326+ 8B00 FE 0D        	cp 13
 327+ 8B02 28 13        	jr z,print_line_text_ex_ok
 328+ 8B04              	OS_PRINT_CHARF ;печать
 328+ 8B04 D7          >	rst #10
 329+ 8B05
 330+ 8B05              	;на следующую позицию
 331+ 8B05 3A 08 8C     	ld a,(view_file_x_cur)
 332+ 8B08 3C           	inc a
 333+ 8B09 FE 50        	cp 80 ;правый край экрана
 334+ 8B0B 32 08 8C     	ld (view_file_x_cur),a
 335+ 8B0E 30 15        	jr nc,print_line_text_right ;дошли до правого края
 336+ 8B10
 337+ 8B10              print_line_text_skip
 338+ 8B10 CD 70 8B     	call view_file_next_pos ;следующий
 339+ 8B13 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 340+ 8B15 18 E0        	jr print_line_text_cl
 341+ 8B17
 342+ 8B17              print_line_text_ex_ok ;выход норма по коду 13
 343+ 8B17 3E 20        	ld a," "
 344+ 8B19              	OS_PRINT_CHARF ;печать
 344+ 8B19 D7          >	rst #10
 345+ 8B1A CD 29 8B     	call printe_clear_end ;добить до конца строки
 346+ 8B1D C3 70 8B     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 347+ 8B20              	;ret
 348+ 8B20
 349+ 8B20              print_line_text_ex_end ;выход если кончился файл
 350+ 8B20 CD 29 8B     	call printe_clear_end
 351+ 8B23 37           	scf
 352+ 8B24 C9           	ret
 353+ 8B25
 354+ 8B25              print_line_text_right
 355+ 8B25 CD D4 8B     	call next_line ;позицию  до конца строки
 356+ 8B28 C9           	ret
 357+ 8B29
 358+ 8B29
 359+ 8B29              printe_clear_end
 360+ 8B29              	;добить строку пробелами
 361+ 8B29 3A 08 8C     	ld a,(view_file_x_cur)
 362+ 8B2C 3C           	inc a
 363+ 8B2D FE 50        	cp 80 ;правый край экрана
 364+ 8B2F 32 08 8C     	ld (view_file_x_cur),a
 365+ 8B32 D0           	ret nc
 366+ 8B33 3E 20        	ld a," "
 367+ 8B35              	OS_PRINT_CHARF ;печать
 367+ 8B35 D7          >	rst #10
 368+ 8B36 18 F1        	jr printe_clear_end
 369+ 8B38
 370+ 8B38
 371+ 8B38
 372+ 8B38
 373+ 8B38
 374+ 8B38              view_move_right ;перемотка строки направо
 375+ 8B38 ED 4B 01 8C  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 376+ 8B3C 78           	ld a,b
 377+ 8B3D B1           	or c
 378+ 8B3E C8           	ret z
 379+ 8B3F 2A 03 8C     	ld hl,(view_file_pos_cur)
 380+ 8B42              view_move_right1
 381+ 8B42 7E           	ld a,(hl)
 382+ 8B43 FE 0A        	cp 10 ;этот код пропускаем
 383+ 8B45 20 07        	jr nz,view_move_right2
 384+ 8B47 CD 70 8B     	call view_file_next_pos
 385+ 8B4A D8           	ret c
 386+ 8B4B C8           	ret z
 387+ 8B4C 18 F4        	jr view_move_right1
 388+ 8B4E              view_move_right2
 389+ 8B4E FE FF        	cp #ff ;этот код пропускаем
 390+ 8B50 20 07        	jr nz,view_move_right3
 391+ 8B52 CD 70 8B     	call view_file_next_pos
 392+ 8B55 D8           	ret c
 393+ 8B56 C8           	ret z
 394+ 8B57 18 E9        	jr view_move_right1
 395+ 8B59              view_move_right3
 396+ 8B59 7E           	ld a,(hl)
 397+ 8B5A FE 0D        	cp 13 ;
 398+ 8B5C C8           	ret z
 399+ 8B5D              view_move_right_cl
 400+ 8B5D CD 70 8B     	call view_file_next_pos
 401+ 8B60 D8           	ret c
 402+ 8B61 C8           	ret z
 403+ 8B62 7E           	ld a,(hl)
 404+ 8B63 FE 0D        	cp 13
 405+ 8B65 C8           	ret z
 406+ 8B66 FE 0A        	cp 10 ;этот код пропускаем
 407+ 8B68 28 F3        	jr z,view_move_right_cl
 408+ 8B6A 0B           	dec bc
 409+ 8B6B 78           	ld a,b
 410+ 8B6C B1           	or c
 411+ 8B6D 20 EE        	jr nz,view_move_right_cl
 412+ 8B6F              	;call view_file_next_pos ;следующий
 413+ 8B6F C9           	ret
 414+ 8B70
 415+ 8B70
 416+ 8B70
 417+ 8B70              ;получение следующей позиции
 418+ 8B70              view_file_next_pos
 419+ 8B70 3A 09 8C     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 420+ 8B73 B7           	or a
 421+ 8B74 28 14        	jr z,view_file_next_pos_big
 422+ 8B76              	;если текст не большой
 423+ 8B76 2A 0A 8C     	ld hl,(view_file_end) ;конец текста известен
 424+ 8B79 ED 5B 03 8C  	ld de,(view_file_pos_cur)
 425+ 8B7D 13           	inc de ;вперёд
 426+ 8B7E A7           	and a
 427+ 8B7F ED 52        	sbc hl,de
 428+ 8B81 38 15        	jr c,view_file_next_pos_end
 429+ 8B83 ED 53 03 8C  	ld (view_file_pos_cur),de
 430+ 8B87 EB           	ex de,hl ;на выходе адрес в HL
 431+ 8B88 B7           	or a
 432+ 8B89 C9           	ret
 433+ 8B8A
 434+ 8B8A
 435+ 8B8A
 436+ 8B8A              view_file_next_pos_big
 437+ 8B8A              	;если текст большой
 438+ 8B8A 2A 03 8C     	ld hl,(view_file_pos_cur)	;текущая позиция
 439+ 8B8D 23           	inc hl ;вперёд
 440+ 8B8E 7C           	ld a,h
 441+ 8B8F FE C0        	cp #c0 ;если вышли за пределы окна
 442+ 8B91 38 05        	jr c,view_file_next_pos_end
 443+ 8B93 22 03 8C     	ld (view_file_pos_cur),hl
 444+ 8B96 B7           	or a
 445+ 8B97 C9           	ret
 446+ 8B98
 447+ 8B98              view_file_next_pos_end
 448+ 8B98              	;не смогли шагнуть вперёд
 449+ 8B98              	; ld a,1 ;флаг что внизу
 450+ 8B98              	; ld (view_file_bot_flag),a
 451+ 8B98 37           	scf ;ошибка
 452+ 8B99 C9           	ret
 453+ 8B9A
 454+ 8B9A
 455+ 8B9A
 456+ 8B9A
 457+ 8B9A
 458+ 8B9A
 459+ 8B9A              ;получение предыдущей позиции
 460+ 8B9A              view_file_prev_pos
 461+ 8B9A 3A 09 8C     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 462+ 8B9D B7           	or a
 463+ 8B9E 28 1E        	jr z,view_file_prev_pos_big
 464+ 8BA0              	;если текст не большой
 465+ 8BA0 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 466+ 8BA3 ED 5B 03 8C  	ld de,(view_file_pos_cur) ;текущая позиция
 467+ 8BA7 1B           	dec de ;назад
 468+ 8BA8 A7           	and a
 469+ 8BA9 ED 52        	sbc hl,de
 470+ 8BAB 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 471+ 8BAD 30 1D        	jr nc,view_file_prev_pos_end
 472+ 8BAF              	;можно шагнуть назад
 473+ 8BAF ED 53 03 8C  	ld (view_file_pos_cur),de
 474+ 8BB3 EB           	ex de,hl ;на выходе адрес в HL
 475+ 8BB4 AF           	xor a
 476+ 8BB5 3C           	inc a ;a=1
 477+ 8BB6 C9           	ret
 478+ 8BB7              view_file_prev_pos_top
 479+ 8BB7              	;если в начале
 480+ 8BB7 ED 53 03 8C  	ld (view_file_pos_cur),de
 481+ 8BBB EB           	ex de,hl ;на выходе адрес в HL
 482+ 8BBC AF           	xor a ;a=0
 483+ 8BBD C9           	ret
 484+ 8BBE
 485+ 8BBE
 486+ 8BBE              view_file_prev_pos_big
 487+ 8BBE              	;если текст большой
 488+ 8BBE 2A 03 8C     	ld hl,(view_file_pos_cur)	;текущая позиция
 489+ 8BC1 2B           	dec hl ;назад
 490+ 8BC2 7C           	ld a,h
 491+ 8BC3 FE C0        	cp #c0 ;если вышли за пределы окна
 492+ 8BC5 38 05        	jr c,view_file_prev_pos_end
 493+ 8BC7 22 03 8C     	ld (view_file_pos_cur),hl
 494+ 8BCA B7           	or a
 495+ 8BCB C9           	ret
 496+ 8BCC
 497+ 8BCC              view_file_prev_pos_end
 498+ 8BCC              	;не смогли шагнуть назад
 499+ 8BCC 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 500+ 8BCF 22 03 8C     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 501+ 8BD2              	;вернулись в начало
 502+ 8BD2 AF           	xor a ;a=0
 503+ 8BD3 C9           	ret
 504+ 8BD4
 505+ 8BD4
 506+ 8BD4
 507+ 8BD4
 508+ 8BD4              next_line ;поиск следующей строки
 509+ 8BD4 CD 70 8B     	call view_file_next_pos
 510+ 8BD7 D8           	ret c
 511+ 8BD8 C8           	ret z
 512+ 8BD9 7E           	ld a,(hl)
 513+ 8BDA FE 0D        	cp 13
 514+ 8BDC 20 F6        	jr nz,next_line
 515+ 8BDE CD 70 8B     	call view_file_next_pos ;ещё на символ
 516+ 8BE1 C9           	ret
 517+ 8BE2
 518+ 8BE2
 519+ 8BE2
 520+ 8BE2              prev_line ;поиск предыдущей строки
 521+ 8BE2              ;если достигнуто начало файла - вернёт адрес начальный
 522+ 8BE2              	;сначала в конец предыдущей
 523+ 8BE2 CD 9A 8B     	call view_file_prev_pos
 524+ 8BE5 C8           	ret z
 525+ 8BE6 D8           	ret c
 526+ 8BE7 7E           	ld a,(hl)
 527+ 8BE8 FE 0D        	cp 13
 528+ 8BEA 20 F6        	jr nz,prev_line
 529+ 8BEC              	;теперь в начало предыдущей
 530+ 8BEC              prev_line1
 531+ 8BEC CD 9A 8B     	call view_file_prev_pos
 532+ 8BEF C8           	ret z
 533+ 8BF0 D8           	ret c
 534+ 8BF1 7E           	ld a,(hl)
 535+ 8BF2 FE 0D        	cp 13
 536+ 8BF4 20 F6        	jr nz,prev_line1
 537+ 8BF6 CD 70 8B     	call view_file_next_pos ;ещё на символ обратно
 538+ 8BF9 C9           	ret
 539+ 8BFA
 540+ 8BFA
 541+ 8BFA
 542+ 8BFA              view_text_bot equ 24 ;последняя строка для печати
 543+ 8BFA              view_text_top equ 1 ;первая строка
 544+ 8BFA              view_text_lines equ 25-2 ;видимых строк на экране
 545+ 8BFA
 546+ 8BFA              msg_menu_view
 547+ 8BFA 33 20 45 78  	db "3 Exit",0
 547+ 8BFE 69 74 00
 548+ 8C01
 549+ 8C01              ;view_file_position ds 4 ;текущая позиция в файле
 550+ 8C01              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 551+ 8C01 00 00        view_move_right_val dw 0 ;сдвиг вправо
 552+ 8C03 00 00        view_file_pos_cur dw 0;текущая позиция
 553+ 8C05 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 554+ 8C07 00           view_file_y_cur db 0;текущая строка
 555+ 8C08 00           view_file_x_cur db 0;текущий столбец
 556+ 8C09 00           view_file_load_all db 0 ;флаг что файл весь загружен
 557+ 8C0A 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 558+ 8C0C
 559+ 8C0C
# file closed: nc_view.asm
1775  8C0C              	include nc_edit.asm ;редактор
# file opened: nc_edit.asm
   1+ 8C0C              edit_file
   2+ 8C0C              	;редактирование файла как текста, размер не больше #4000
   3+ 8C0C
   4+ 8C0C 2A 46 A2     	ld hl,(file_r_all)
   5+ 8C0F 7D           	ld a,l
   6+ 8C10 B4           	or h
   7+ 8C11 CA 00 8D     	jp z,edit_file_ex ;защита
   8+ 8C14 2A 58 A4     	ld hl,(file_r_num_cur)
   9+ 8C17 CD 90 82     	call calc_deskr
  10+ 8C1A DD 7E 0B     	ld a,(ix+#0b)
  11+ 8C1D FE 10        	cp #10 ;признак каталога
  12+ 8C1F CA 00 8D     	jp z,edit_file_ex
  13+ 8C22 FE 30        	cp #30 ;признак каталога
  14+ 8C24 CA 00 8D     	jp z,edit_file_ex
  15+ 8C27
  16+ 8C27 CD 46 87     	call format_name ;обработать имя файла
  17+ 8C2A
  18+ 8C2A
  19+ 8C2A 3A 61 A4     	ld a,(page_ext01) ;доп страница для данных
  20+ 8C2D              	OS_SET_PAGE_SLOT3
  20+ 8C2D 0E 1C       >    ld c,#1c
  20+ 8C2F E7          >    rst #20
  21+ 8C30
  22+ 8C30 11 00 00     	ld de,#0000
  23+ 8C33              	OS_SET_XY
  23+ 8C33 0E 01       >    ld c,#01
  23+ 8C35 E7          >    rst #20
  24+ 8C36
  25+ 8C36              	;обнулить переменные
  26+ 8C36              	;ld (edit_file_bot_flag),a  ;
  27+ 8C36              	;ld hl,#ffff
  28+ 8C36 3E 01        	ld a,1
  29+ 8C38 32 09 8C     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  30+ 8C3B 21 00 00     	ld hl,0
  31+ 8C3E 22 01 8C     	ld (view_move_right_val),hl ;сдвиг вправо 0
  32+ 8C41
  33+ 8C41 AF           	xor a
  34+ 8C42 32 8D 90     	ld (edit_file_save_flag),a ;флаг для сохранения
  35+ 8C45
  36+ 8C45 21 00 C0     	ld hl,buffer_cat
  37+ 8C48 22 03 8C     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  38+ 8C4B 22 05 8C     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  39+ 8C4E 22 8E 90     	ld (edit_file_pos_cur),hl ;позиция курсора
  40+ 8C51 22 90 90     	ld (edit_file_pos_old),hl ;позиция курсора
  41+ 8C54
  42+ 8C54              	;push bc
  43+ 8C54 CD F2 80     	call clear_buf
  44+ 8C57              	;pop bc
  45+ 8C57
  46+ 8C57 3E FF        	ld a,255
  47+ 8C59 32 5F A4     	ld (file_id_cur_r),a
  48+ 8C5C 21 4A A2     	ld hl,file_name_cur		;строка с именем
  49+ 8C5F CD 13 88     	call load_file ;загрузить целиком
  50+ 8C62 DA 00 8D     	jp c,edit_file_ex
  51+ 8C65
  52+ 8C65 22 8B 90     	ld (edit_file_size),hl ;размер
  53+ 8C68 01 00 C0     	ld bc,buffer_cat
  54+ 8C6B 09           	add hl,bc
  55+ 8C6C 22 0A 8C     	ld (view_file_end),hl ;конец файла тут
  56+ 8C6F
  57+ 8C6F              	;файл прочитан
  58+ 8C6F              	OS_CLS ;почистить экран
  58+ 8C6F 0E 00       >    ld c,#00
  58+ 8C71 E7          >    rst #20
  59+ 8C72
  60+ 8C72 CD AD 8A     	call print_file_text
  61+ 8C75 CD F7 8E     	call print_file_cursor
  62+ 8C78
  63+ 8C78
  64+ 8C78 CD DC 8E     	call print_menu_edit ;меню
  65+ 8C7B CD 93 8A     	call print_menu_view_top ;инфо
  66+ 8C7E
  67+ 8C7E CD 4A 81     	call release_key
  68+ 8C81
  69+ 8C81              edit_file_wait ;цикл ожидания клавиши
  70+ 8C81              	OS_WAIT
  70+ 8C81 DF          >	rst #18
  71+ 8C82              	OS_GET_CHAR
  71+ 8C82 0E 10       >    ld c,#10
  71+ 8C84 E7          >    rst #20
  72+ 8C85 FE FF        	cp 255
  73+ 8C87 28 F8        	jr z,edit_file_wait
  74+ 8C89 32 5E A4     	ld (key_pressed),a ;запомнить
  75+ 8C8C              	; cp "3"
  76+ 8C8C              	; jr z,edit_file_wait_ex
  77+ 8C8C FE 0A        	cp 10 ;вниз
  78+ 8C8E CA D5 8D     	jp z,edit_file_down
  79+ 8C91 FE 0B        	cp 11 ;вверх
  80+ 8C93 CA 04 8E     	jp z,edit_file_up
  81+ 8C96 FE 09        	cp 09 ;вправо
  82+ 8C98 CA 34 8E     	jp z,edit_right
  83+ 8C9B FE 08        	cp 08 ;влево
  84+ 8C9D CA 5C 8E     	jp z,edit_left
  85+ 8CA0 FE 04        	cp 04 ;страница вверх
  86+ 8CA2 CA 84 8E     	jp z,edit_page_up
  87+ 8CA5 FE 05        	cp 05 ;страница вниз
  88+ 8CA7 CA B0 8E     	jp z,edit_page_down
  89+ 8CAA FE 0C        	cp 12 ;backspace
  90+ 8CAC CA 21 8D     	jp z,edit_file_backspace
  91+ 8CAF FE 18        	cp 24 ;break
  92+ 8CB1 CA C0 8C     	jp z,edit_file_wait_ex
  93+ 8CB4 FE 20        	cp " " ;печатаем сиволы от пробела и выше
  94+ 8CB6 D4 6C 8D     	call nc,edit_file_insert_sym ;вставить символ
  95+ 8CB9 FE 0D        	cp 13 ;enter
  96+ 8CBB CC 6C 8D     	call z,edit_file_insert_sym ;вставить символ
  97+ 8CBE 18 C1        	jr edit_file_wait
  98+ 8CC0
  99+ 8CC0              edit_file_wait_ex
 100+ 8CC0 CD 4A 81     	call release_key
 101+ 8CC3
 102+ 8CC3 3A 8D 90     	ld a,(edit_file_save_flag)
 103+ 8CC6 B7           	or a
 104+ 8CC7 28 26        	jr z,edit_file_wait_ex1
 105+ 8CC9              	;запрос на сохранение
 106+ 8CC9
 107+ 8CC9 11 00 00     	ld de,0
 108+ 8CCC              	OS_SET_XY
 108+ 8CCC 0E 01       >    ld c,#01
 108+ 8CCE E7          >    rst #20
 109+ 8CCF 21 7C 90     	ld hl,msg_menu_edit_save
 110+ 8CD2              	OS_PRINTZ
 110+ 8CD2 0E 09       >    ld c,#09
 110+ 8CD4 E7          >    rst #20
 111+ 8CD5
 112+ 8CD5              edit_file_wait_ex_wait
 113+ 8CD5              	OS_WAIT
 113+ 8CD5 DF          >	rst #18
 114+ 8CD6              	OS_GET_CHAR
 114+ 8CD6 0E 10       >    ld c,#10
 114+ 8CD8 E7          >    rst #20
 115+ 8CD9 FE FF        	cp 255
 116+ 8CDB 28 F8        	jr z,edit_file_wait_ex_wait
 117+ 8CDD FE 79        	cp "y" ;да
 118+ 8CDF 28 28        	jr z,edit_file_save
 119+ 8CE1 FE 59        	cp "Y" ;да
 120+ 8CE3 28 24        	jr z,edit_file_save
 121+ 8CE5              	; cp "н" ;да
 122+ 8CE5              	; jr z,edit_file_save
 123+ 8CE5              	; cp "Н" ;да
 124+ 8CE5              	; jr z,edit_file_save
 125+ 8CE5 FE 6E        	cp "n" ;нет
 126+ 8CE7 28 06        	jr z,edit_file_wait_ex1
 127+ 8CE9 FE 4E        	cp "N" ;нет
 128+ 8CEB 28 02        	jr z,edit_file_wait_ex1
 129+ 8CED              	; cp "т" ;нет
 130+ 8CED              	; jr z,edit_file_wait_ex1
 131+ 8CED              	; cp "Т" ;нет
 132+ 8CED              	; jr z,edit_file_wait_ex1
 133+ 8CED 18 E6        	jr edit_file_wait_ex_wait
 134+ 8CEF
 135+ 8CEF              edit_file_wait_ex1
 136+ 8CEF 3A 71 A4     	ld a,(page_main) ;основная страница с каталогом
 137+ 8CF2              	OS_SET_PAGE_SLOT3
 137+ 8CF2 0E 1C       >    ld c,#1c
 137+ 8CF4 E7          >    rst #20
 138+ 8CF5              	;почистить экран
 139+ 8CF5              	OS_CLS
 139+ 8CF5 0E 00       >    ld c,#00
 139+ 8CF7 E7          >    rst #20
 140+ 8CF8
 141+ 8CF8 3E 01        	ld a,1 ;флаг чтобы вернуть позицию курсора
 142+ 8CFA 32 80 82     	ld (key_enter_dir_flag),a
 143+ 8CFD C3 54 80     	jp start_nc_warm ;перезагрузить папку
 144+ 8D00
 145+ 8D00
 146+ 8D00
 147+ 8D00              edit_file_ex
 148+ 8D00 3A 71 A4     	ld a,(page_main) ;основная страница с каталогом
 149+ 8D03              	OS_SET_PAGE_SLOT3
 149+ 8D03 0E 1C       >    ld c,#1c
 149+ 8D05 E7          >    rst #20
 150+ 8D06 C3 96 80     	jp nc_wait
 151+ 8D09
 152+ 8D09
 153+ 8D09
 154+ 8D09              ;сохранить файл
 155+ 8D09              edit_file_save
 156+ 8D09 21 4A A2     	ld hl,file_name_cur		;строка с именем
 157+ 8D0C              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 157+ 8D0C 0E 21       >    ld c,#21
 157+ 8D0E E7          >    rst #20
 158+ 8D0F DA 61 88     	jp c,load_file_error
 159+ 8D12
 160+ 8D12 21 00 C0     	ld hl,buffer_cat
 161+ 8D15 ED 5B 8B 90  	ld de,(edit_file_size)
 162+ 8D19              	;ld a,(file_id_cur_r)
 163+ 8D19              	OS_FILE_WRITE
 163+ 8D19 0E 24       >    ld c,#24
 163+ 8D1B E7          >    rst #20
 164+ 8D1C DA 61 88     	jp c,load_file_error
 165+ 8D1F 18 CE        	jr edit_file_wait_ex1
 166+ 8D21
 167+ 8D21
 168+ 8D21
 169+ 8D21
 170+ 8D21
 171+ 8D21
 172+ 8D21              ;удалить символ слева
 173+ 8D21              edit_file_backspace
 174+ 8D21              	;проверить на начало
 175+ 8D21 2A 8E 90     	ld hl,(edit_file_pos_cur)
 176+ 8D24 01 00 C0     	ld bc,buffer_cat
 177+ 8D27 A7           	and a
 178+ 8D28 ED 42        	sbc hl,bc
 179+ 8D2A 28 3D        	jr z,edit_file_backspace_err
 180+ 8D2C              	;сдвинуть текст
 181+ 8D2C 2A 0A 8C     	ld hl,(view_file_end)
 182+ 8D2F ED 4B 8E 90  	ld bc,(edit_file_pos_cur) ;позиция курсора
 183+ 8D33 A7           	and a
 184+ 8D34 ED 42        	sbc hl,bc
 185+ 8D36 28 31        	jr z,edit_file_backspace_err
 186+ 8D38 44 4D        	ld bc,hl ;сколько сдвигать
 187+ 8D3A 2A 8E 90     	ld hl,(edit_file_pos_cur) ;позиция курсора
 188+ 8D3D 54 5D        	ld de,hl
 189+ 8D3F 1B           	dec de
 190+ 8D40 ED B0        	ldir
 191+ 8D42 AF           	xor a
 192+ 8D43              	;dec de
 193+ 8D43 12           	ld (de),a ;в конце 0
 194+ 8D44
 195+ 8D44
 196+ 8D44
 197+ 8D44              	;уменьшить размер и изменить окончание
 198+ 8D44 2A 8B 90     	ld hl,(edit_file_size)
 199+ 8D47 2B           	dec hl
 200+ 8D48 22 8B 90     	ld (edit_file_size),hl
 201+ 8D4B
 202+ 8D4B 2A 0A 8C     	ld hl,(view_file_end)
 203+ 8D4E 2B           	dec hl
 204+ 8D4F 22 0A 8C     	ld (view_file_end),hl ;
 205+ 8D52
 206+ 8D52              	;флаг что изменён
 207+ 8D52 3E 01        	ld a,1
 208+ 8D54 32 8D 90     	ld (edit_file_save_flag),a ;флаг для сохранения
 209+ 8D57
 210+ 8D57 CD EF 8F     	call edit_move_left_cursor ;курсор влево
 211+ 8D5A 2A 8E 90     	ld hl,(edit_file_pos_cur)
 212+ 8D5D 22 90 90     	ld (edit_file_pos_old),hl
 213+ 8D60
 214+ 8D60 CD AD 8A     	call print_file_text ;напечатать всё
 215+ 8D63 CD F7 8E     	call print_file_cursor ;курсор
 216+ 8D66
 217+ 8D66 C3 81 8C     	jp edit_file_wait
 218+ 8D69
 219+ 8D69
 220+ 8D69              edit_file_backspace_err
 221+ 8D69
 222+ 8D69 C3 81 8C     	jp edit_file_wait
 223+ 8D6C
 224+ 8D6C
 225+ 8D6C
 226+ 8D6C
 227+ 8D6C
 228+ 8D6C
 229+ 8D6C
 230+ 8D6C
 231+ 8D6C
 232+ 8D6C
 233+ 8D6C
 234+ 8D6C
 235+ 8D6C              ;вставка символа
 236+ 8D6C              edit_file_insert_sym
 237+ 8D6C              	;проверить есть ли место
 238+ 8D6C 2A 0A 8C     	ld hl,(view_file_end)
 239+ 8D6F 23           	inc hl ;ffff?
 240+ 8D70 7C           	ld a,h
 241+ 8D71 B5           	or l
 242+ 8D72 28 45        	jr z,edit_file_insert_sym_err
 243+ 8D74 23           	inc hl ;fffe?
 244+ 8D75 7C           	ld a,h
 245+ 8D76 B5           	or l
 246+ 8D77 28 40        	jr z,edit_file_insert_sym_err
 247+ 8D79              	;сдвинуть текст
 248+ 8D79 2B           	dec hl
 249+ 8D7A 2B           	dec hl
 250+ 8D7B ED 4B 8E 90  	ld bc,(edit_file_pos_cur) ;позиция курсора
 251+ 8D7F A7           	and a
 252+ 8D80 ED 42        	sbc hl,bc
 253+ 8D82 28 35        	jr z,edit_file_insert_sym_err
 254+ 8D84 44 4D        	ld bc,hl ;сколько сдвигать
 255+ 8D86 ED 5B 0A 8C  	ld de,(view_file_end) ;позиция курсора
 256+ 8D8A 62 6B        	ld hl,de
 257+ 8D8C 2B           	dec hl
 258+ 8D8D ED B8        	lddr
 259+ 8D8F
 260+ 8D8F              	;увеличить размер и изменить окончание
 261+ 8D8F 2A 8B 90     	ld hl,(edit_file_size)
 262+ 8D92 23           	inc hl
 263+ 8D93 22 8B 90     	ld (edit_file_size),hl
 264+ 8D96
 265+ 8D96 2A 0A 8C     	ld hl,(view_file_end)
 266+ 8D99 23           	inc hl
 267+ 8D9A 22 0A 8C     	ld (view_file_end),hl ;увеличить
 268+ 8D9D
 269+ 8D9D              	;флаг что изменён
 270+ 8D9D 3E 01        	ld a,1
 271+ 8D9F 32 8D 90     	ld (edit_file_save_flag),a ;флаг для сохранения
 272+ 8DA2
 273+ 8DA2 2A 8E 90     	ld hl,(edit_file_pos_cur) ;позиция курсора
 274+ 8DA5 3A 5E A4     	ld a,(key_pressed)
 275+ 8DA8 77           	ld (hl),a
 276+ 8DA9
 277+ 8DA9 CD BB 8F     	call edit_move_right_cursor ;курсор вправо
 278+ 8DAC 2A 8E 90     	ld hl,(edit_file_pos_cur)
 279+ 8DAF 22 90 90     	ld (edit_file_pos_old),hl
 280+ 8DB2
 281+ 8DB2 CD AD 8A     	call print_file_text ;напечатать всё
 282+ 8DB5 CD F7 8E     	call print_file_cursor ;курсор
 283+ 8DB8
 284+ 8DB8              	;
 285+ 8DB8 C9           	ret
 286+ 8DB9
 287+ 8DB9              edit_file_insert_sym_err
 288+ 8DB9 11 00 00     	ld de,0
 289+ 8DBC              	OS_SET_XY
 289+ 8DBC 0E 01       >    ld c,#01
 289+ 8DBE E7          >    rst #20
 290+ 8DBF
 291+ 8DBF 3E 0A        	ld a,color_error ;цвет ошибки
 292+ 8DC1 06 0C        	ld b,#c
 293+ 8DC3              	OS_SET_COLOR
 293+ 8DC3 0E 06       >    ld c,#06
 293+ 8DC5 E7          >    rst #20
 294+ 8DC6
 295+ 8DC6 21 55 A5     	ld hl,msg_mem_err ;нет памяти
 296+ 8DC9              	OS_PRINTZ ;печать
 296+ 8DC9 0E 09       >    ld c,#09
 296+ 8DCB E7          >    rst #20
 297+ 8DCC
 298+ 8DCC 3E 0F        	ld a,color_backgr ;цвет основной
 299+ 8DCE 06 0C        	ld b,#c
 300+ 8DD0              	OS_SET_COLOR
 300+ 8DD0 0E 06       >    ld c,#06
 300+ 8DD2 E7          >    rst #20
 301+ 8DD3 37           	scf
 302+ 8DD4 C9           	ret
 303+ 8DD5
 304+ 8DD5
 305+ 8DD5
 306+ 8DD5
 307+ 8DD5
 308+ 8DD5
 309+ 8DD5
 310+ 8DD5
 311+ 8DD5
 312+ 8DD5
 313+ 8DD5              edit_file_down ;вниз на строчку
 314+ 8DD5 CD 1D 90     	call next_line_cursor ;курсор вниз
 315+ 8DD8 DA F8 8D     	jp c,edit_file_down1
 316+ 8DDB
 317+ 8DDB 3A 95 90     	ld a,(edit_file_pos_cur_xy+1) ;y
 318+ 8DDE 3C           	inc a
 319+ 8DDF FE 18        	cp view_text_bot
 320+ 8DE1 38 15        	jr c,edit_file_down1
 321+ 8DE3
 322+ 8DE3              	;сдвинуть фокус
 323+ 8DE3 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 324+ 8DE6 22 03 8C     	ld (view_file_pos_cur),hl
 325+ 8DE9 CD D4 8B     	call next_line ;вперёд на строку
 326+ 8DEC DA F8 8D     	jp c,edit_file_down1 ;если не удачно
 327+ 8DEF 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 328+ 8DF2 22 05 8C     	ld (view_file_pos_cur_focus),hl
 329+ 8DF5 CD AD 8A     	call print_file_text ;напечатать всю страницу
 330+ 8DF8
 331+ 8DF8              edit_file_down1
 332+ 8DF8 CD F7 8E     	call print_file_cursor ;напечатать курсор
 333+ 8DFB 2A 8E 90     	ld hl,(edit_file_pos_cur)
 334+ 8DFE 22 90 90     	ld (edit_file_pos_old),hl
 335+ 8E01
 336+ 8E01 C3 81 8C     	jp edit_file_wait
 337+ 8E04
 338+ 8E04
 339+ 8E04
 340+ 8E04
 341+ 8E04
 342+ 8E04
 343+ 8E04
 344+ 8E04              edit_file_up ;вверх на строчку
 345+ 8E04 CD 45 90     	call prev_line_cursor ;
 346+ 8E07 28 03        	jr z,edit_file_up2
 347+ 8E09 DA 28 8E     	jp c,edit_file_up1 ;если не удачно
 348+ 8E0C              edit_file_up2
 349+ 8E0C 3A 95 90     	ld a,(edit_file_pos_cur_xy+1) ;y
 350+ 8E0F FE 01        	cp view_text_top
 351+ 8E11 20 15        	jr nz,edit_file_up1
 352+ 8E13
 353+ 8E13              	;сдвинуть фокус
 354+ 8E13 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 355+ 8E16 22 03 8C     	ld (view_file_pos_cur),hl
 356+ 8E19 CD E2 8B     	call prev_line ;
 357+ 8E1C DA 28 8E     	jp c,edit_file_up1
 358+ 8E1F
 359+ 8E1F 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 360+ 8E22 22 05 8C     	ld (view_file_pos_cur_focus),hl
 361+ 8E25 CD AD 8A     	call print_file_text ;напечатать всю страницу
 362+ 8E28
 363+ 8E28              edit_file_up1
 364+ 8E28 CD F7 8E     	call print_file_cursor ;напечатать курсор
 365+ 8E2B 2A 8E 90     	ld hl,(edit_file_pos_cur)
 366+ 8E2E 22 90 90     	ld (edit_file_pos_old),hl
 367+ 8E31 C3 81 8C     	jp edit_file_wait
 368+ 8E34
 369+ 8E34
 370+ 8E34
 371+ 8E34
 372+ 8E34
 373+ 8E34              edit_right ;вправо
 374+ 8E34 CD BB 8F     	call edit_move_right_cursor
 375+ 8E37 38 17        	jr c,edit_right_ex
 376+ 8E39              	;jr z,edit_right_ex
 377+ 8E39 3A 94 90     	ld a,(edit_file_pos_cur_xy) ;x
 378+ 8E3C 3C           	inc a
 379+ 8E3D FE 50        	cp 80 ;ограничение справа
 380+ 8E3F 38 0F        	jr c,edit_right1
 381+ 8E41              	;тут надо промотать вправо весь текст
 382+ 8E41
 383+ 8E41 2A 01 8C     	ld hl,(view_move_right_val)
 384+ 8E44 23           	inc hl
 385+ 8E45 7C           	ld a,h ;сдвиг вправо не больше 65535
 386+ 8E46 B5           	or l
 387+ 8E47 CA 50 8E     	jp z,edit_right2
 388+ 8E4A 22 01 8C     	ld (view_move_right_val),hl
 389+ 8E4D CD AD 8A     	call print_file_text ;напечатать всю страницу
 390+ 8E50              edit_right2
 391+ 8E50              	;ld a,80-1 ;курсор остаётся на краю
 392+ 8E50              edit_right1
 393+ 8E50              	;ld (edit_file_pos_cur_xy),a ;x
 394+ 8E50
 395+ 8E50              edit_right_ex
 396+ 8E50 CD F7 8E     	call print_file_cursor ;напечатать курсор
 397+ 8E53 2A 8E 90     	ld hl,(edit_file_pos_cur)
 398+ 8E56 22 90 90     	ld (edit_file_pos_old),hl
 399+ 8E59 C3 81 8C     	jp edit_file_wait
 400+ 8E5C
 401+ 8E5C
 402+ 8E5C
 403+ 8E5C
 404+ 8E5C
 405+ 8E5C
 406+ 8E5C
 407+ 8E5C              edit_left ;влево
 408+ 8E5C CD EF 8F     	call edit_move_left_cursor
 409+ 8E5F 38 17        	jr c,edit_left_ex
 410+ 8E61              	;jr z,edit_left_ex
 411+ 8E61 3A 94 90     	ld a,(edit_file_pos_cur_xy) ;x
 412+ 8E64 B7           	or a ;ограничение слева
 413+ 8E65 28 11        	jr z,edit_left1
 414+ 8E67              	;тут надо промотать влево весь текст
 415+ 8E67 2A 01 8C     	ld hl,(view_move_right_val)
 416+ 8E6A 7C           	ld a,h
 417+ 8E6B B5           	or l
 418+ 8E6C CA 76 8E     	jp z,edit_left2
 419+ 8E6F 2B           	dec hl
 420+ 8E70 22 01 8C     	ld (view_move_right_val),hl
 421+ 8E73 CD AD 8A     	call print_file_text ;напечатать всю страницу
 422+ 8E76              edit_left2
 423+ 8E76 3E 01        	ld a,1 ;курсор остаётся на краю
 424+ 8E78              edit_left1
 425+ 8E78              	;dec a
 426+ 8E78              	;ld (edit_file_pos_cur_xy),a ;x
 427+ 8E78
 428+ 8E78              edit_left_ex
 429+ 8E78 CD F7 8E     	call print_file_cursor ;напечатать курсор
 430+ 8E7B 2A 8E 90     	ld hl,(edit_file_pos_cur)
 431+ 8E7E 22 90 90     	ld (edit_file_pos_old),hl
 432+ 8E81 C3 81 8C     	jp edit_file_wait
 433+ 8E84
 434+ 8E84
 435+ 8E84
 436+ 8E84
 437+ 8E84
 438+ 8E84
 439+ 8E84
 440+ 8E84
 441+ 8E84              edit_page_up ;на страницу назад
 442+ 8E84 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 443+ 8E87 22 03 8C     	ld (view_file_pos_cur),hl
 444+ 8E8A 06 16        	ld b,view_text_bot-2
 445+ 8E8C              edit_page_up_cl
 446+ 8E8C CD E2 8B     	call prev_line ;
 447+ 8E8F              	;call prev_line_cursor ;
 448+ 8E8F 38 04        	jr c,edit_page_up_ex ;если не удачно
 449+ 8E91 28 02        	jr z,edit_page_up_ex
 450+ 8E93 10 F7        	djnz edit_page_up_cl
 451+ 8E95              edit_page_up_ex
 452+ 8E95 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 453+ 8E98 22 05 8C     	ld (view_file_pos_cur_focus),hl
 454+ 8E9B 22 8E 90     	ld (edit_file_pos_cur),hl ;курсор будет там же где фокус
 455+ 8E9E              	;ld (edit_file_pos_old),hl
 456+ 8E9E CD BB 8F     	call edit_move_right_cursor ;ещё на символ
 457+ 8EA1
 458+ 8EA1 CD AD 8A     	call print_file_text ;напечатать всю страницу
 459+ 8EA4
 460+ 8EA4 CD F7 8E     	call print_file_cursor ;напечатать курсор
 461+ 8EA7 2A 8E 90     	ld hl,(edit_file_pos_cur)
 462+ 8EAA 22 90 90     	ld (edit_file_pos_old),hl
 463+ 8EAD C3 81 8C     	jp edit_file_wait
 464+ 8EB0
 465+ 8EB0
 466+ 8EB0
 467+ 8EB0              edit_page_down ;на страницу вперёд
 468+ 8EB0 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;фокус
 469+ 8EB3 22 03 8C     	ld (view_file_pos_cur),hl
 470+ 8EB6 06 16        	ld b,view_text_bot-2
 471+ 8EB8              edit_page_down_cl
 472+ 8EB8 CD D4 8B     	call next_line ;
 473+ 8EBB              	;call next_line_cursor ;
 474+ 8EBB 38 04        	jr c,edit_page_down_ex ;если не удачно
 475+ 8EBD 28 02        	jr z,edit_page_down_ex
 476+ 8EBF 10 F7        	djnz edit_page_down_cl
 477+ 8EC1              edit_page_down_ex
 478+ 8EC1 2A 03 8C     	ld hl,(view_file_pos_cur) ;запомнить фокус
 479+ 8EC4 22 05 8C     	ld (view_file_pos_cur_focus),hl
 480+ 8EC7 22 8E 90     	ld (edit_file_pos_cur),hl ;курсор будет там же где фокус
 481+ 8ECA              	;ld (edit_file_pos_old),hl
 482+ 8ECA
 483+ 8ECA CD BB 8F     	call edit_move_right_cursor ;ещё на символ
 484+ 8ECD
 485+ 8ECD CD AD 8A     	call print_file_text ;напечатать всю страницу
 486+ 8ED0 CD F7 8E     	call print_file_cursor ;напечатать курсор
 487+ 8ED3 2A 8E 90     	ld hl,(edit_file_pos_cur)
 488+ 8ED6 22 90 90     	ld (edit_file_pos_old),hl
 489+ 8ED9 C3 81 8C     	jp edit_file_wait
 490+ 8EDC
 491+ 8EDC
 492+ 8EDC
 493+ 8EDC              print_menu_edit ;печать меню редактора
 494+ 8EDC 3E 18        	ld a,#18
 495+ 8EDE 06 28        	ld b,color_backgr_hi ;цвет
 496+ 8EE0              	OS_PAINT_LINE ;линия внизу
 496+ 8EE0 0E 04       >    ld c,#04
 496+ 8EE2 E7          >    rst #20
 497+ 8EE3 3E 28        	ld a,color_backgr_hi ;цвет
 498+ 8EE5 06 0C        	ld b,#c
 499+ 8EE7              	OS_SET_COLOR
 499+ 8EE7 0E 06       >    ld c,#06
 499+ 8EE9 E7          >    rst #20
 500+ 8EEA 11 00 18     	ld de,#1800+0*8
 501+ 8EED              	OS_SET_XY
 501+ 8EED 0E 01       >    ld c,#01
 501+ 8EEF E7          >    rst #20
 502+ 8EF0 21 6F 90     	ld hl,msg_menu_edit
 503+ 8EF3              	OS_PRINTZ
 503+ 8EF3 0E 09       >    ld c,#09
 503+ 8EF5 E7          >    rst #20
 504+ 8EF6 C9           	ret
 505+ 8EF7
 506+ 8EF7              ; print_menu_edit_top ;печать меню просмотрщика верхнее
 507+ 8EF7              	; xor a
 508+ 8EF7              	; ld b,color_backgr_hi ;цвет
 509+ 8EF7              	; OS_PAINT_LINE ;линия вверху
 510+ 8EF7              	; ld a,color_backgr_hi ;цвет
 511+ 8EF7              	; ld b,#c
 512+ 8EF7              	; OS_SET_COLOR
 513+ 8EF7              	; ld de,#0024
 514+ 8EF7              	; OS_SET_XY
 515+ 8EF7              	; ld hl,file_name_cur
 516+ 8EF7              	; OS_PRINTZ
 517+ 8EF7              	; ret
 518+ 8EF7
 519+ 8EF7
 520+ 8EF7
 521+ 8EF7              print_file_cursor	;печать только курсора, в основном пустой цикл по тексту
 522+ 8EF7 AF           	xor a ;флаг выхода из цикла
 523+ 8EF8 32 BA 8F     	ld (print_line_cursor_flag),a
 524+ 8EFB 3E 04        	ld a,color_edit_text ;цвет обычный
 525+ 8EFD 06 0C        	ld b,#c
 526+ 8EFF              	OS_SET_COLOR
 526+ 8EFF 0E 06       >    ld c,#06
 526+ 8F01 E7          >    rst #20
 527+ 8F02 2A 90 90     	ld hl,(edit_file_pos_old)
 528+ 8F05 22 92 90     	ld (edit_file_pos_tmp),hl
 529+ 8F08 CD 20 8F     	call print_file_cursor_one ;"стереть" старый курсор
 530+ 8F0B
 531+ 8F0B AF           	xor a ;флаг выхода из цикла
 532+ 8F0C 32 BA 8F     	ld (print_line_cursor_flag),a
 533+ 8F0F 3E 20        	ld a,color_edit_cursor ;цвет курсор
 534+ 8F11 06 0C        	ld b,#c
 535+ 8F13              	OS_SET_COLOR
 535+ 8F13 0E 06       >    ld c,#06
 535+ 8F15 E7          >    rst #20
 536+ 8F16 2A 8E 90     	ld hl,(edit_file_pos_cur)
 537+ 8F19 22 92 90     	ld (edit_file_pos_tmp),hl
 538+ 8F1C CD 20 8F     	call print_file_cursor_one ;напечатать новый
 539+ 8F1F C9           	ret
 540+ 8F20
 541+ 8F20              print_file_cursor_one
 542+ 8F20
 543+ 8F20 3E 01        	ld a,view_text_top ;первая строка
 544+ 8F22 32 07 8C     	ld (view_file_y_cur),a
 545+ 8F25 2A 05 8C     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 546+ 8F28 22 03 8C     	ld (view_file_pos_cur),hl
 547+ 8F2B              print_file_cursor_cl
 548+ 8F2B 2A 03 8C     	ld hl,(view_file_pos_cur)
 549+ 8F2E CD 46 8F     	call print_line_cursor
 550+ 8F31 38 11        	jr c,print_file_cursor_ex
 551+ 8F33              	;если уже напечатали курсор
 552+ 8F33 3A BA 8F     	ld a,(print_line_cursor_flag)
 553+ 8F36 B7           	or a
 554+ 8F37 C0           	ret nz
 555+ 8F38              	; call next_line ;найти следующую строку
 556+ 8F38              	; ret c
 557+ 8F38
 558+ 8F38 3A 07 8C     	ld a,(view_file_y_cur)
 559+ 8F3B 3C           	inc a
 560+ 8F3C 32 07 8C     	ld (view_file_y_cur),a
 561+ 8F3F FE 18        	cp view_text_bot
 562+ 8F41 38 E8        	jr c,print_file_cursor_cl
 563+ 8F43 C9           	ret
 564+ 8F44
 565+ 8F44              print_file_cursor_ex
 566+ 8F44              	;тут очистить остальные строки
 567+ 8F44              	; ld a,(view_file_y_cur)
 568+ 8F44              	; inc a
 569+ 8F44              	; cp edit_text_bot
 570+ 8F44              	; jr nc,print_file_cursor_ex2
 571+ 8F44              	; ld h,a
 572+ 8F44              	; ld (view_file_y_cur),a
 573+ 8F44              	; ld a," "
 574+ 8F44              	; OS_FILL_LINE ;очистить строку
 575+ 8F44              	; jr print_file_cursor_ex
 576+ 8F44              ; print_file_cursor_ex2
 577+ 8F44 37           	scf
 578+ 8F45 C9           	ret
 579+ 8F46
 580+ 8F46
 581+ 8F46
 582+ 8F46              print_line_cursor ;печать только курсора в цикле одной строки до кода 13, или до правого края экрана, или до конца файла
 583+ 8F46              ;вх: hl - адрес строки
 584+ 8F46 CD 38 8B     	call view_move_right ;промотать направо. если надо
 585+ 8F49              	;установить позицию
 586+ 8F49              	; ld a,(view_file_y_cur)
 587+ 8F49              	; ld d,a
 588+ 8F49 AF           	xor a
 589+ 8F4A 32 08 8C     	ld (view_file_x_cur),a
 590+ 8F4D              	; ld e,a
 591+ 8F4D              	; OS_SET_XY 	;yx
 592+ 8F4D              print_line_cursor_cl ;цикл
 593+ 8F4D 7E           	ld a,(hl)
 594+ 8F4E FE 0A        	cp 10 ;этот код не печатаем
 595+ 8F50 28 35        	jr z,print_line_cursor_skip
 596+ 8F52 FE FF        	cp #ff ;этот код не печатаем
 597+ 8F54 28 31        	jr z,print_line_cursor_skip
 598+ 8F56 FE 0D        	cp 13
 599+ 8F58 28 34        	jr z,print_line_cursor_ex_ok
 600+ 8F5A
 601+ 8F5A              	;push hl
 602+ 8F5A ED 4B 92 90  	ld bc,(edit_file_pos_tmp)
 603+ 8F5E A7           	and a
 604+ 8F5F ED 42        	sbc hl,bc
 605+ 8F61              	;pop hl
 606+ 8F61 20 19        	jr nz,print_line_cursor_skip1
 607+ 8F63              	;запомнить координаты
 608+ 8F63 F5           	push af
 609+ 8F64 3A 07 8C     	ld a,(view_file_y_cur)
 610+ 8F67 32 95 90     	ld (edit_file_pos_cur_xy+1),a
 611+ 8F6A 57           	ld d,a
 612+ 8F6B 3A 08 8C     	ld a,(view_file_x_cur)
 613+ 8F6E 32 94 90     	ld (edit_file_pos_cur_xy),a
 614+ 8F71 5F           	ld e,a
 615+ 8F72              	OS_SET_XY 	;yx
 615+ 8F72 0E 01       >    ld c,#01
 615+ 8F74 E7          >    rst #20
 616+ 8F75 F1           	pop af
 617+ 8F76              	OS_PRINT_CHARF ;печать только курсора
 617+ 8F76 D7          >	rst #10
 618+ 8F77              	;флаг на выход цикла
 619+ 8F77 3E 01        	ld a,1
 620+ 8F79 32 BA 8F     	ld (print_line_cursor_flag),a
 621+ 8F7C
 622+ 8F7C              print_line_cursor_skip1
 623+ 8F7C              	;на следующую позицию
 624+ 8F7C 3A 08 8C     	ld a,(view_file_x_cur)
 625+ 8F7F 3C           	inc a
 626+ 8F80 FE 50        	cp 80 ;правый край экрана
 627+ 8F82 32 08 8C     	ld (view_file_x_cur),a
 628+ 8F85 30 2F        	jr nc,print_line_cursor_right ;дошли до правого края
 629+ 8F87
 630+ 8F87              print_line_cursor_skip
 631+ 8F87 CD 70 8B     	call view_file_next_pos ;следующий
 632+ 8F8A 38 28        	jr c,print_line_cursor_ex_end ;на следующий символ
 633+ 8F8C 18 BF        	jr print_line_cursor_cl
 634+ 8F8E
 635+ 8F8E              print_line_cursor_ex_ok ;выход норма по коду 13
 636+ 8F8E              	;ещё раз проверить курсор, когда он на коде 13
 637+ 8F8E ED 4B 92 90  	ld bc,(edit_file_pos_tmp)
 638+ 8F92 A7           	and a
 639+ 8F93 ED 42        	sbc hl,bc
 640+ 8F95              	;pop hl
 641+ 8F95 C2 70 8B     	jp nz,view_file_next_pos
 642+ 8F98              	;запомнить координаты
 643+ 8F98 3A 07 8C     	ld a,(view_file_y_cur)
 644+ 8F9B 32 95 90     	ld (edit_file_pos_cur_xy+1),a
 645+ 8F9E 57           	ld d,a
 646+ 8F9F 3A 08 8C     	ld a,(view_file_x_cur)
 647+ 8FA2 32 94 90     	ld (edit_file_pos_cur_xy),a
 648+ 8FA5 5F           	ld e,a
 649+ 8FA6              	OS_SET_XY 	;yx
 649+ 8FA6 0E 01       >    ld c,#01
 649+ 8FA8 E7          >    rst #20
 650+ 8FA9 3E 20        	ld a," " ;печатать пробел вместо 13
 651+ 8FAB              	OS_PRINT_CHARF ;печать только курсора
 651+ 8FAB D7          >	rst #10
 652+ 8FAC              	;флаг на выход цикла
 653+ 8FAC 3E 01        	ld a,1
 654+ 8FAE 32 BA 8F     	ld (print_line_cursor_flag),a
 655+ 8FB1
 656+ 8FB1              	;ld a," "
 657+ 8FB1              	;OS_PRINT_CHARF ;печать
 658+ 8FB1              	;call printe_clear_end ;добить до конца строки
 659+ 8FB1 C3 70 8B     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 660+ 8FB4              	;ret
 661+ 8FB4
 662+ 8FB4              print_line_cursor_ex_end ;выход если кончился файл
 663+ 8FB4              	;call printe_clear_end
 664+ 8FB4 37           	scf
 665+ 8FB5 C9           	ret
 666+ 8FB6
 667+ 8FB6              print_line_cursor_right
 668+ 8FB6 CD D4 8B     	call next_line ;позицию  до конца строки
 669+ 8FB9 C9           	ret
 670+ 8FBA
 671+ 8FBA
 672+ 8FBA              ; printe_clear_end
 673+ 8FBA              	; ;добить строку пробелами
 674+ 8FBA              	; ld a,(edit_file_x_cur)
 675+ 8FBA              	; inc a
 676+ 8FBA              	; cp 80 ;правый край экрана
 677+ 8FBA              	; ld (edit_file_x_cur),a
 678+ 8FBA              	; ret nc
 679+ 8FBA              	; ;ld a," "
 680+ 8FBA              	; ;OS_PRINT_CHARF ;печать
 681+ 8FBA              	; jr printe_clear_end
 682+ 8FBA
 683+ 8FBA 00           print_line_cursor_flag db 0;флаг прерывания цикла
 684+ 8FBB
 685+ 8FBB
 686+ 8FBB
 687+ 8FBB
 688+ 8FBB
 689+ 8FBB
 690+ 8FBB              edit_move_right_cursor ;перемотка курсор направо
 691+ 8FBB 2A 8E 90     	ld hl,(edit_file_pos_cur)
 692+ 8FBE 22 92 90     	ld (edit_file_pos_tmp),hl ;сохранить позицию
 693+ 8FC1              edit_move_right_cursor_cl
 694+ 8FC1 CD D9 8F     	call edit_file_next_pos_cursor
 695+ 8FC4 38 0B        	jr c,edit_move_right_cursor_err
 696+ 8FC6 7E           	ld a,(hl)
 697+ 8FC7 FE 0A        	cp 10 ;этот код пропускаем
 698+ 8FC9 28 F6        	jr z,edit_move_right_cursor_cl
 699+ 8FCB FE FF        	cp #ff ;этот код пропускаем
 700+ 8FCD 28 F2        	jr z,edit_move_right_cursor_cl
 701+ 8FCF              	; cp 13 ;
 702+ 8FCF              	; jr z,edit_move_right_cursor_cl
 703+ 8FCF              edit_move_right_cursor_ok
 704+ 8FCF AF           	xor a ;ok
 705+ 8FD0 C9           	ret
 706+ 8FD1              edit_move_right_cursor_err
 707+ 8FD1 2A 92 90     	ld hl,(edit_file_pos_tmp) ;вернуть, если попали на непечатный символ
 708+ 8FD4 22 8E 90     	ld (edit_file_pos_cur),hl
 709+ 8FD7 37           	scf
 710+ 8FD8 C9           	ret
 711+ 8FD9
 712+ 8FD9
 713+ 8FD9              ;получение следующей позиции для курсора
 714+ 8FD9              edit_file_next_pos_cursor
 715+ 8FD9              	; ld a,(edit_file_load_all) ;флаг что файл весь в памяти
 716+ 8FD9              	; or a
 717+ 8FD9              	; jr z,edit_file_next_pos_cursor_big
 718+ 8FD9              	;если текст не большой
 719+ 8FD9 2A 0A 8C     	ld hl,(view_file_end) ;конец текста известен
 720+ 8FDC ED 5B 8E 90  	ld de,(edit_file_pos_cur)
 721+ 8FE0 13           	inc de ;вперёд
 722+ 8FE1 A7           	and a
 723+ 8FE2 ED 52        	sbc hl,de
 724+ 8FE4 38 07        	jr c,edit_file_next_pos_cursor_end
 725+ 8FE6 ED 53 8E 90  	ld (edit_file_pos_cur),de
 726+ 8FEA EB           	ex de,hl ;на выходе адрес в HL
 727+ 8FEB B7           	or a
 728+ 8FEC C9           	ret
 729+ 8FED
 730+ 8FED
 731+ 8FED
 732+ 8FED              ; edit_file_next_pos_cursor_big
 733+ 8FED              	; ;если текст большой
 734+ 8FED              	; ld hl,(edit_file_pos_cur)	;текущая позиция
 735+ 8FED              	; inc hl ;вперёд
 736+ 8FED              	; ld a,h
 737+ 8FED              	; cp #c0 ;если вышли за пределы окна
 738+ 8FED              	; jr c,edit_file_next_pos_cursor_end
 739+ 8FED              	; ld (edit_file_pos_cur),hl
 740+ 8FED              	; or a
 741+ 8FED              	; ret
 742+ 8FED
 743+ 8FED              edit_file_next_pos_cursor_end
 744+ 8FED              	;не смогли шагнуть вперёд
 745+ 8FED              	; ; ld a,1 ;флаг что внизу
 746+ 8FED              	; ; ld (edit_file_bot_flag),a
 747+ 8FED 37           	scf ;ошибка
 748+ 8FEE C9           	ret
 749+ 8FEF
 750+ 8FEF
 751+ 8FEF
 752+ 8FEF
 753+ 8FEF
 754+ 8FEF
 755+ 8FEF
 756+ 8FEF              edit_move_left_cursor ;перемотка курсор направо
 757+ 8FEF              	; ld bc,(edit_move_left_cursor_val) ;на сколько символов вправо промотать
 758+ 8FEF              	; ld a,b
 759+ 8FEF              	; or c
 760+ 8FEF              	; ret z
 761+ 8FEF              	; ld hl,(edit_file_pos_cur)
 762+ 8FEF              	; ld (edit_file_pos_tmp),hl
 763+ 8FEF              edit_move_left_cursor_cl
 764+ 8FEF CD 07 90     	call edit_file_prev_pos_cursor
 765+ 8FF2 38 0B        	jr c,edit_move_left_cursor_err
 766+ 8FF4              	;jr z,edit_move_left_cursor_ok ;если пришли в начало
 767+ 8FF4 7E           	ld a,(hl)
 768+ 8FF5 FE 0A        	cp 10 ;этот код пропускаем
 769+ 8FF7 28 F6        	jr z,edit_move_left_cursor_cl
 770+ 8FF9 FE FF        	cp #ff ;этот код пропускаем
 771+ 8FFB 28 F2        	jr z,edit_move_left_cursor_cl
 772+ 8FFD              	; cp 13 ;
 773+ 8FFD              	; jr z,edit_move_left_cursor_cl
 774+ 8FFD              edit_move_left_cursor_ok
 775+ 8FFD AF           	xor a ;ok
 776+ 8FFE C9           	ret
 777+ 8FFF              edit_move_left_cursor_err
 778+ 8FFF              	;ld hl,(edit_file_pos_tmp) ;вернуть, если попали на непечатный символ
 779+ 8FFF 21 00 C0     	ld hl,buffer_cat ;в начало
 780+ 9002 22 8E 90     	ld (edit_file_pos_cur),hl
 781+ 9005 37           	scf
 782+ 9006 C9           	ret
 783+ 9007
 784+ 9007
 785+ 9007
 786+ 9007
 787+ 9007
 788+ 9007              ;получение предыдущей позиции
 789+ 9007              edit_file_prev_pos_cursor
 790+ 9007              	; ld a,(edit_file_load_all) ;флаг что файл весь в памяти
 791+ 9007              	; or a
 792+ 9007              	; jr z,edit_file_prev_pos_cursor_big
 793+ 9007              	;если текст не большой
 794+ 9007 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 795+ 900A ED 5B 8E 90  	ld de,(edit_file_pos_cur) ;текущая позиция
 796+ 900E 1B           	dec de ;назад
 797+ 900F A7           	and a
 798+ 9010 ED 52        	sbc hl,de
 799+ 9012              	;jr z,edit_file_prev_pos_cursor_top ;если пришли в начало
 800+ 9012 30 07        	jr nc,edit_file_prev_pos_cursor_end
 801+ 9014              	;можно шагнуть назад
 802+ 9014 ED 53 8E 90  	ld (edit_file_pos_cur),de
 803+ 9018 EB           	ex de,hl ;на выходе адрес в HL
 804+ 9019 AF           	xor a
 805+ 901A              	;inc a ;a=1
 806+ 901A C9           	ret
 807+ 901B              ; edit_file_prev_pos_cursor_top
 808+ 901B              	; ;если в начале
 809+ 901B              	; ld (edit_file_pos_cur),de
 810+ 901B              	; ex de,hl ;на выходе адрес в HL
 811+ 901B              	; xor a ;a=0
 812+ 901B              	; ret
 813+ 901B
 814+ 901B
 815+ 901B              ; edit_file_prev_pos_cursor_big
 816+ 901B              	; ;если текст большой
 817+ 901B              	; ld hl,(edit_file_pos_cur)	;текущая позиция
 818+ 901B              	; dec hl ;назад
 819+ 901B              	; ld a,h
 820+ 901B              	; cp #c0 ;если вышли за пределы окна
 821+ 901B              	; jr c,edit_file_prev_pos_cursor_end
 822+ 901B              	; ld (edit_file_pos_cur),hl
 823+ 901B              	; or a
 824+ 901B              	; ret
 825+ 901B
 826+ 901B              edit_file_prev_pos_cursor_end
 827+ 901B              	;не смогли шагнуть назад
 828+ 901B              	;ld hl,buffer_cat ;тут лежит текст
 829+ 901B              	;ld (edit_file_pos_cur),hl ;текущая позиция в самом начале
 830+ 901B              	;вернулись в начало
 831+ 901B 37           	scf ;
 832+ 901C C9           	ret
 833+ 901D
 834+ 901D
 835+ 901D
 836+ 901D
 837+ 901D              next_line_cursor ;поиск следующей строки для курсора
 838+ 901D 2A 8E 90     	ld hl,(edit_file_pos_cur)
 839+ 9020 22 92 90     	ld (edit_file_pos_tmp),hl ;сохранить позицию
 840+ 9023              next_line_cursor_cl
 841+ 9023 CD D9 8F     	call edit_file_next_pos_cursor
 842+ 9026 38 15        	jr c,next_line_cursor_err
 843+ 9028              	;ret z
 844+ 9028 7E           	ld a,(hl)
 845+ 9029 FE 0D        	cp 13
 846+ 902B 20 F6        	jr nz,next_line_cursor_cl
 847+ 902D              	;тут нашли конец строки
 848+ 902D              next_line_cursor_cl1
 849+ 902D              	;ещё пропустить лишнее
 850+ 902D CD D9 8F     	call edit_file_next_pos_cursor
 851+ 9030 38 0B        	jr c,next_line_cursor_err
 852+ 9032 7E           	ld a,(hl)
 853+ 9033 FE 0A        	cp 10
 854+ 9035 28 F6        	jr z,next_line_cursor_cl1
 855+ 9037 FE FF        	cp #ff
 856+ 9039 28 F2        	jr z,next_line_cursor_cl1
 857+ 903B              next_line_cursor_ok
 858+ 903B AF           	xor a
 859+ 903C C9           	ret
 860+ 903D              next_line_cursor_err
 861+ 903D 2A 92 90     	ld hl,(edit_file_pos_tmp)
 862+ 9040 22 8E 90     	ld (edit_file_pos_cur),hl ;восстановить позицию
 863+ 9043 37           	scf
 864+ 9044 C9           	ret
 865+ 9045
 866+ 9045
 867+ 9045
 868+ 9045
 869+ 9045
 870+ 9045
 871+ 9045              prev_line_cursor ;поиск предыдущей строки для курсора
 872+ 9045              ;если достигнуто начало файла - вернёт адрес начальный
 873+ 9045              	;сначала в конец предыдущей
 874+ 9045              	; ld hl,(edit_file_pos_cur)
 875+ 9045              	; ld (edit_file_pos_tmp),hl ;сохранить позицию
 876+ 9045              prev_line_cursor_cl
 877+ 9045 CD 07 90     	call edit_file_prev_pos_cursor
 878+ 9048              	;jr z,prev_line_cursor_ok
 879+ 9048 38 1D        	jr c,prev_line_cursor_err
 880+ 904A 7E           	ld a,(hl)
 881+ 904B FE 0D        	cp 13
 882+ 904D 20 F6        	jr nz,prev_line_cursor_cl
 883+ 904F              	;теперь в начало предыдущей
 884+ 904F              prev_line_cursor_cl1
 885+ 904F CD 07 90     	call edit_file_prev_pos_cursor
 886+ 9052              	;jr z,prev_line_cursor_ok
 887+ 9052 38 13        	jr c,prev_line_cursor_err
 888+ 9054 7E           	ld a,(hl)
 889+ 9055 FE 0D        	cp 13
 890+ 9057 20 F6        	jr nz,prev_line_cursor_cl1
 891+ 9059              prev_line_cursor_cl2
 892+ 9059 CD D9 8F     	call edit_file_next_pos_cursor ;ещё на символ обратно
 893+ 905C 7E           	ld a,(hl)
 894+ 905D FE 0A        	cp 10
 895+ 905F 28 F8        	jr z,prev_line_cursor_cl2
 896+ 9061 FE FF        	cp #ff
 897+ 9063 28 F4        	jr z,prev_line_cursor_cl2
 898+ 9065
 899+ 9065              prev_line_cursor_ok
 900+ 9065 AF           	xor a
 901+ 9066 C9           	ret
 902+ 9067              prev_line_cursor_err
 903+ 9067              	; ld hl,(edit_file_pos_tmp)
 904+ 9067 21 00 C0     	ld hl,buffer_cat ;в начало
 905+ 906A 22 8E 90     	ld (edit_file_pos_cur),hl
 906+ 906D 37           	scf
 907+ 906E C9           	ret
 908+ 906F
 909+ 906F              ; edit_text_bot equ 24 ;последняя строка для печати
 910+ 906F              ; edit_text_top equ 1 ;первая строка
 911+ 906F              ; edit_text_lines equ 25-2 ;видимых строк на экране
 912+ 906F
 913+ 906F
 914+ 906F              msg_menu_edit
 915+ 906F 42 72 65 61  	db "Break - Exit",0
 915+ 9073 6B 20 2D 20
 915+ 9077 45 78 69 74
 915+ 907B 00
 916+ 907C
 917+ 907C              msg_menu_edit_save
 918+ 907C 53 61 76 65  	db "Save file? Y/N",0
 918+ 9080 20 66 69 6C
 918+ 9084 65 3F 20 59
 918+ 9088 2F 4E 00
 919+ 908B
 920+ 908B 00 00        edit_file_size dw 0 ;размер текстак
 921+ 908D 00           edit_file_save_flag db 0 ;флаг что файл изменён
 922+ 908E 00 00        edit_file_pos_cur dw 0 ;текущая позиция в файле
 923+ 9090 00 00        edit_file_pos_old dw 0 ;текущая позиция в файле
 924+ 9092 00 00        edit_file_pos_tmp dw 0 ;временно
 925+ 9094 00 00        edit_file_pos_cur_xy dw 0 ;текущая позиция координаты на экране
 926+ 9096              ; ;edit_file_bot_flag db 0 ;флаг что домотали вниз до конца
 927+ 9096              ; edit_move_right_val dw 0 ;сдвиг вправо
 928+ 9096              ;edit_file_pos_cur dw 0;текущая позиция
 929+ 9096              ;edit_file_pos_cur_focus dw 0 ;позиция фокуса
 930+ 9096              ;edit_file_y_cur db 0;текущая строка
 931+ 9096              ;edit_file_x_cur db 0;текущий столбец
 932+ 9096              ; ;edit_file_load_all db 0 ;флаг что файл весь загружен
 933+ 9096              ; edit_file_end dw 0 ;конец файлв, или текущего куска
 934+ 9096
 935+ 9096
# file closed: nc_edit.asm
1776  9096              	include GPlay/gplay.asm ;плеер
# file opened: GPlay/gplay.asm
   1+ 9096              ;GPlay - приложение для OS GMX
   2+ 9096                 ; device ZXSPECTRUM128
   3+ 9096              	; include "../os_defs.asm"
   4+ 9096              	; org PROG_START
   5+ 9096
   6+ 9096
   7+ 9096              start_gplay
   8+ 9096 32 42 94     	ld (gplay_type),a ;тип формата
   9+ 9099
  10+ 9099 CD 00 81     	call clear_left_panel ;почистить часть экрана
  11+ 909C
  12+ 909C              	;call release_key
  13+ 909C
  14+ 909C 21 FF 95     	ld hl,memorystreampages+$FF
  15+ 909F 36 00        	ld (hl),0 ;количество занятых страниц
  16+ 90A1
  17+ 90A1 3A 61 A4     	ld a,(page_ext01) ;доп страница для данных плеера
  18+ 90A4              	OS_SET_PAGE_SLOT3
  18+ 90A4 0E 1C       >    ld c,#1c
  18+ 90A6 E7          >    rst #20
  19+ 90A7
  20+ 90A7 11 00 00     	ld de,0
  21+ 90AA              	OS_SET_XY
  21+ 90AA 0E 01       >    ld c,#01
  21+ 90AC E7          >    rst #20
  22+ 90AD 21 B1 94     	ld hl,msg_title ;имя приложения
  23+ 90B0              	OS_PRINTZ ;печать
  23+ 90B0 0E 09       >    ld c,#09
  23+ 90B2 E7          >    rst #20
  24+ 90B3
  25+ 90B3 3E 0D        	ld a,13 ;оставим место для шкалы прогресса
  26+ 90B5              	OS_PRINT_CHARF
  26+ 90B5 D7          >	rst #10
  27+ 90B6 3E 0D        	ld a,13
  28+ 90B8              	OS_PRINT_CHARF
  28+ 90B8 D7          >	rst #10
  29+ 90B9 21 4A A2     	ld hl,file_name_cur
  30+ 90BC              	OS_PRINTZ
  30+ 90BC 0E 09       >    ld c,#09
  30+ 90BE E7          >    rst #20
  31+ 90BF
  32+ 90BF 21 70 94     	ld hl,txt_load
  33+ 90C2              	OS_PRINTZ
  33+ 90C2 0E 09       >    ld c,#09
  33+ 90C4 E7          >    rst #20
  34+ 90C5
  35+ 90C5 3E FF        	ld a,255
  36+ 90C7 32 5F A4     	ld (file_id_cur_r),a
  37+ 90CA
  38+ 90CA 3A 42 94     	ld a,(gplay_type)
  39+ 90CD              	;переход в на нужный раздел
  40+ 90CD
  41+ 90CD              start_gplay_pt2
  42+ 90CD FE 32        	cp "2"
  43+ 90CF 20 06        	jr nz,start_gplay_pt3
  44+ 90D1              	;если PT2
  45+ 90D1 CD 1F 93     	call load_pt2
  46+ 90D4 C3 54 91     	jp exit_gplay
  47+ 90D7              	;jp start_gplay_ok
  48+ 90D7
  49+ 90D7              start_gplay_pt3
  50+ 90D7 FE 33        	cp "3"
  51+ 90D9 20 06        	jr nz,start_gplay_mod
  52+ 90DB              	;если PT3
  53+ 90DB CD 26 93     	call load_pt3
  54+ 90DE C3 54 91     	jp exit_gplay
  55+ 90E1              	;jp start_gplay_ok
  56+ 90E1
  57+ 90E1              start_gplay_mod
  58+ 90E1 FE 6D        	cp "m"
  59+ 90E3 20 06        	jr nz,start_gplay_vgz
  60+ 90E5              	;если MOD
  61+ 90E5 CD 19 92     	call load_mod
  62+ 90E8 C3 54 91     	jp exit_gplay
  63+ 90EB              	;jp start_gplay_ok
  64+ 90EB
  65+ 90EB
  66+ 90EB              start_gplay_vgz
  67+ 90EB FE 7A        	cp "z"
  68+ 90ED 20 08        	jr nz,start_gplay_vgm
  69+ 90EF              	;если VGZ
  70+ 90EF CD A9 91     	call load_vgz
  71+ 90F2 DA 54 91     	jp c,exit_gplay
  72+ 90F5 18 0A        	jr start_gplay_ok
  73+ 90F7
  74+ 90F7              start_gplay_vgm
  75+ 90F7 FE 76        	cp "v"
  76+ 90F9 20 59        	jr nz,exit_gplay
  77+ 90FB              	;если vgm
  78+ 90FB CD A2 91     	call load_vgm
  79+ 90FE DA 54 91     	jp c,exit_gplay
  80+ 9101
  81+ 9101
  82+ 9101              start_gplay_ok
  83+ 9101              	;играет
  84+ 9101 21 60 94     	ld hl,txt_play
  85+ 9104              	OS_PRINTZ
  85+ 9104 0E 09       >    ld c,#09
  85+ 9106 E7          >    rst #20
  86+ 9107
  87+ 9107 21 43 94     	ld hl,txt_gplay_menu
  88+ 910A              	OS_PRINTZ
  88+ 910A 0E 09       >    ld c,#09
  88+ 910C E7          >    rst #20
  89+ 910D
  90+ 910D              wait_play
  91+ 910D              	OS_WAIT
  91+ 910D DF          >	rst #18
  92+ 910E
  93+ 910E CD 89 93     	call gplay_progress_print
  94+ 9111
  95+ 9111 11 00 0A     	ld de,#0a00
  96+ 9114              	OS_SET_XY
  96+ 9114 0E 01       >    ld c,#01
  96+ 9116 E7          >    rst #20
  97+ 9117 2A 72 96     	ld hl,(memorystreamcurrentaddr)
  98+ 911A CD E3 93     	call toDecimal
  99+ 911D              	OS_PRINTZ
  99+ 911D 0E 09       >    ld c,#09
  99+ 911F E7          >    rst #20
 100+ 9120
 101+ 9120
 102+ 9120 11 00 0B     	ld de,#0b00
 103+ 9123              	OS_SET_XY
 103+ 9123 0E 01       >    ld c,#01
 103+ 9125 E7          >    rst #20
 104+ 9126 2A 0E 96     	ld hl,(memorystreampageaddr)
 105+ 9129 01 00 95     	ld bc,memorystreampages
 106+ 912C A7           	and a
 107+ 912D ED 42        	sbc hl,bc
 108+ 912F CD E3 93     	call toDecimal
 109+ 9132              	OS_PRINTZ
 109+ 9132 0E 09       >    ld c,#09
 109+ 9134 E7          >    rst #20
 110+ 9135
 111+ 9135 3A 7A 9C     	ld a,(vgm_play_var)
 112+ 9138 B7           	or a
 113+ 9139 20 19        	jr nz,exit_gplay ; конец пенсни
 114+ 913B              	OS_GET_CHAR
 114+ 913B 0E 10       >    ld c,#10
 114+ 913D E7          >    rst #20
 115+ 913E FE 20        	cp " " ;space
 116+ 9140 CA 54 91     	jp z,exit_gplay
 117+ 9143 FE 73        	cp "s" ;stop
 118+ 9145 CA 54 91     	jp z,exit_gplay
 119+ 9148 FE 53        	cp "S" ;stop
 120+ 914A CA 54 91     	jp z,exit_gplay
 121+ 914D FE 18        	cp 24 ;break
 122+ 914F CA 54 91     	jp z,exit_gplay
 123+ 9152 18 B9        	jr wait_play
 124+ 9154
 125+ 9154
 126+ 9154
 127+ 9154
 128+ 9154
 129+ 9154              exit_gplay ;выход
 130+ 9154 F5           	push af ;сохранить нажатую клавишу
 131+ 9155
 132+ 9155 21 6A 94     	ld hl,txt_stop
 133+ 9158              	OS_PRINTZ
 133+ 9158 0E 09       >    ld c,#09
 133+ 915A E7          >    rst #20
 134+ 915B
 135+ 915B CD 66 91     	call gplay_stop
 136+ 915E
 137+ 915E 3A 71 A4     	ld a,(page_main) ;основная страница
 138+ 9161              	OS_SET_PAGE_SLOT3
 138+ 9161 0E 1C       >    ld c,#1c
 138+ 9163 E7          >    rst #20
 139+ 9164
 140+ 9164 F1           	pop af ;a - код клавиши
 141+ 9165 C9           	ret
 142+ 9166
 143+ 9166
 144+ 9166              ;заглушить звук
 145+ 9166              gplay_stop
 146+ 9166 3A 42 94     	ld a,(gplay_type)
 147+ 9169 FE 32        	cp "2"
 148+ 916B CA 11 92     	jp z,gplay_stop_ptx
 149+ 916E FE 33        	cp "3"
 150+ 9170 CA 11 92     	jp z,gplay_stop_ptx
 151+ 9173 FE 76        	cp "v"
 152+ 9175 CA F4 91     	jp z,gplay_stop_vgm_vgz
 153+ 9178 FE 7A        	cp "z"
 154+ 917A CA F4 91     	jp z,gplay_stop_vgm_vgz
 155+ 917D FE 6D        	cp "m"
 156+ 917F CA 15 92     	jp z,gplay_stop_mod
 157+ 9182 C9           	ret
 158+ 9183
 159+ 9183
 160+ 9183
 161+ 9183              ; delay ;задержка между запросами
 162+ 9183              	; ld b,50*1 ;
 163+ 9183              ; delay1
 164+ 9183              	; OS_WAIT
 165+ 9183              	; djnz delay1
 166+ 9183              	; ret
 167+ 9183
 168+ 9183
 169+ 9183              check_BM
 170+ 9183              	;определение наличия BomgeMoon
 171+ 9183 AF           	xor a
 172+ 9184 DB 24        	in a,(MOON_BASE)
 173+ 9186 FE FF        	cp 255
 174+ 9188 28 02        	jr z,check_BM1
 175+ 918A B7           	or a
 176+ 918B C9           	ret
 177+ 918C
 178+ 918C              check_BM1
 179+ 918C 3E 0A        	ld a,color_error ;цвет ошибки
 180+ 918E 06 0C        	ld b,#c
 181+ 9190              	OS_SET_COLOR
 181+ 9190 0E 06       >    ld c,#06
 181+ 9192 E7          >    rst #20
 182+ 9193
 183+ 9193 21 88 94     	ld hl,txt_no_BM
 184+ 9196              	OS_PRINTZ
 184+ 9196 0E 09       >    ld c,#09
 184+ 9198 E7          >    rst #20
 185+ 9199
 186+ 9199 3E 0F        	ld a,color_backgr ;цвет основной
 187+ 919B 06 0C        	ld b,#c
 188+ 919D              	OS_SET_COLOR
 188+ 919D 0E 06       >    ld c,#06
 188+ 919F E7          >    rst #20
 189+ 91A0 37           	scf ;ошибка
 190+ 91A1 C9           	ret
 191+ 91A2
 192+ 91A2
 193+ 91A2
 194+ 91A2
 195+ 91A2
 196+ 91A2              load_vgm
 197+ 91A2 CD 83 91     	call check_BM
 198+ 91A5 D8           	ret c
 199+ 91A6 C3 1F A1     	jp load_mus ;инициализация и загрузка VGM
 200+ 91A9
 201+ 91A9
 202+ 91A9
 203+ 91A9
 204+ 91A9
 205+ 91A9
 206+ 91A9              load_vgz
 207+ 91A9              ;тут запуск VGZ
 208+ 91A9 CD 83 91     	call check_BM
 209+ 91AC D8           	ret c
 210+ 91AD              	;тут надо сначала распаковать файл
 211+ 91AD AF           	xor a
 212+ 91AE              	OS_SET_MONO_MODE ;запросить моно режим
 212+ 91AE 0E 08       >    ld c,#08
 212+ 91B0 E7          >    rst #20
 213+ 91B1 30 08        	jr nc,load_vgz1
 214+ 91B3
 215+ 91B3              load_vgz_err
 216+ 91B3              	;выход с ошибкой
 217+ 91B3
 218+ 91B3              	;напечатать ошибку, если не дали режима моно
 219+ 91B3 21 67 A5     	ld hl,msg_mono_err
 220+ 91B6              	OS_PRINTZ
 220+ 91B6 0E 09       >    ld c,#09
 220+ 91B8 E7          >    rst #20
 221+ 91B9
 222+ 91B9 37           	scf ;ошибка
 223+ 91BA C9           	ret
 224+ 91BB
 225+ 91BB              load_vgz1
 226+ 91BB              	;перенести модуль распаковки на рабочий адрес
 227+ 91BB
 228+ 91BB 3A 62 A4     	ld a,(page_ext02_gzip) ;доп страница для данных плеера
 229+ 91BE              	OS_SET_PAGE_SLOT3
 229+ 91BE 0E 1C       >    ld c,#1c
 229+ 91C0 E7          >    rst #20
 230+ 91C1
 231+ 91C1 21 00 C0     	ld hl,start_gp_gzip_ext
 232+ 91C4 11 00 40     	ld de,start_gp_gzip
 233+ 91C7 ED 4B 6F A4  	ld bc,(gp_gzip_file_size)
 234+ 91CB ED B0        	ldir
 235+ 91CD
 236+ 91CD 3A 61 A4     	ld a,(page_ext01) ;доп страница для данных плеера
 237+ 91D0              	OS_SET_PAGE_SLOT3
 237+ 91D0 0E 1C       >    ld c,#1c
 237+ 91D2 E7          >    rst #20
 238+ 91D3
 239+ 91D3              	;распаковать
 240+ 91D3 21 4A A2     	ld hl,file_name_cur ;имя файла
 241+ 91D6 CD 00 40     	call start_gp_gzip ;decompressfiletomemorystream
 242+ 91D9
 243+ 91D9              	;перенести таблицу страниц
 244+ 91D9 11 00 95     	ld de,memorystreampages
 245+ 91DC 01 00 01     	ld bc,256
 246+ 91DF ED B0        	ldir
 247+ 91E1
 248+ 91E1 01 FF 95     	ld bc,memorystreampages+$ff
 249+ 91E4 02               ld (bc),a  ;количество страниц
 250+ 91E5
 251+ 91E5 F5           	push af
 252+ 91E6 3E FF        	ld a,255
 253+ 91E8              	OS_SET_MONO_MODE ;выключить моно режим
 253+ 91E8 0E 08       >    ld c,#08
 253+ 91EA E7          >    rst #20
 254+ 91EB F1           	pop af
 255+ 91EC
 256+ 91EC 30 01        	jr nc,load_vgz_ok
 257+ 91EE              	;если не распаковалос
 258+ 91EE              	;scf ;ошибка
 259+ 91EE C9           	ret
 260+ 91EF
 261+ 91EF              load_vgz_ok
 262+ 91EF              	;нормально распаковалось
 263+ 91EF
 264+ 91EF CD 64 A1     	call read_file_ok ;играть
 265+ 91F2              	;call start_gplay ;играть
 266+ 91F2
 267+ 91F2 AF           	xor a
 268+ 91F3 C9           	ret
 269+ 91F4
 270+ 91F4
 271+ 91F4              ;стоп игра
 272+ 91F4              gplay_stop_vgm_vgz
 273+ 91F4 21 00 00     	ld hl,0 ;отключить обработчик прерываний
 274+ 91F7              	OS_SET_INTER
 274+ 91F7 0E 14       >    ld c,#14
 274+ 91F9 E7          >    rst #20
 275+ 91FA CD D0 94     	call PLR_MUTE ;выключить звук
 276+ 91FD
 277+ 91FD
 278+ 91FD              	;освободить страницы памяти
 279+ 91FD 21 FF 95     	ld hl,memorystreampages+$FF
 280+ 9200 6E               ld l,(hl)
 281+ 9201 2C           	inc l ;проверка на 0
 282+ 9202 2D           	dec l
 283+ 9203 28 0B        	jr z,free_s98_loop_skip
 284+ 9205
 285+ 9205              free_s98_loop
 286+ 9205 2D               dec l
 287+ 9206 7E               ld a,(hl)
 288+ 9207
 289+ 9207 F5               push af
 290+ 9208 E5               push hl
 291+ 9209                  ;OS_DELPAGE
 292+ 9209              	OS_DEL_PAGE
 292+ 9209 0E 20       >    ld c,#20
 292+ 920B E7          >    rst #20
 293+ 920C E1               pop hl
 294+ 920D F1               pop af
 295+ 920E
 296+ 920E 20 F5            jr nz,free_s98_loop
 297+ 9210
 298+ 9210              free_s98_loop_skip
 299+ 9210 C9           	ret
 300+ 9211
 301+ 9211              ;стоп игра
 302+ 9211              gplay_stop_ptx
 303+ 9211                  OS_VTPL_MUTE
 303+ 9211 0E 17       >    ld c,#17
 303+ 9213 E7          >    rst #20
 304+ 9214 C9           	ret
 305+ 9215
 306+ 9215
 307+ 9215
 308+ 9215              ;стоп игра
 309+ 9215              gplay_stop_mod
 310+ 9215 CD CD A1         call GeneralSound.stopModule
 311+ 9218 C9           	ret
 312+ 9219
 313+ 9219
 314+ 9219              load_mod
 315+ 9219              ;загрузка и игра mod
 316+ 9219
 317+ 9219              	;определение наличия GS
 318+ 9219              	; xor a ;флаг что не нашли
 319+ 9219              	; ld (gs_yep),a
 320+ 9219              	; ld (gs_on),a
 321+ 9219 3E 23        	LD A,#23
 322+ 921B D3 BB        	OUT (CMD), A
 323+ 921D 06 32        	ld b,50
 324+ 921F              WAITCOM2: ;это WC
 325+ 921F              	OS_WAIT
 325+ 921F DF          >	rst #18
 326+ 9220 DB BB        	IN A,(CMD)
 327+ 9222 0F           	RRCA
 328+ 9223 30 18        	JR NC,WAITCOM3
 329+ 9225 10 F8        	djnz WAITCOM2
 330+ 9227              gs_no
 331+ 9227 3E 0A        	ld a,color_error ;цвет ошибки
 332+ 9229 06 0C        	ld b,#c
 333+ 922B              	OS_SET_COLOR
 333+ 922B 0E 06       >    ld c,#06
 333+ 922D E7          >    rst #20
 334+ 922E
 335+ 922E 21 79 94     	ld hl,txt_no_GS
 336+ 9231              	OS_PRINTZ
 336+ 9231 0E 09       >    ld c,#09
 336+ 9233 E7          >    rst #20
 337+ 9234
 338+ 9234 3E 0F        	ld a,color_backgr ;цвет основной
 339+ 9236 06 0C        	ld b,#c
 340+ 9238              	OS_SET_COLOR
 340+ 9238 0E 06       >    ld c,#06
 340+ 923A E7          >    rst #20
 341+ 923B
 342+ 923B 37           	scf ;ошибка
 343+ 923C C9           	ret
 344+ 923D              	;jr gs_no
 345+ 923D              WAITCOM3
 346+ 923D DB B3        	in a,(DATA) ;количество страниц памяти?
 347+ 923F FE FF        	cp 255
 348+ 9241 20 02        	jr nz,gs_yes
 349+ 9243              	; ld hl,txt_err_GS
 350+ 9243              	; call loader_print
 351+ 9243 18 E2        	jr gs_no
 352+ 9245              gs_yes
 353+ 9245
 354+ 9245 21 4A A2     	ld hl,file_name_cur
 355+ 9248              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 355+ 9248 0E 21       >    ld c,#21
 355+ 924A E7          >    rst #20
 356+ 924B
 357+ 924B DA 61 88     	jp c,load_file_error
 358+ 924E 32 5F A4     	ld (file_id_cur_r),a
 359+ 9251
 360+ 9251 AF               xor a
 360+ 9252 CD 7F A1       call GeneralSound.init
 361+ 9255                  ; ld hl, .progress : call DialogBox.msgNoWait
 362+ 9255                  ; call makeRequest : jp c, Fetcher.fetchFromNet.error
 363+ 9255 CD 96 A1         call GeneralSound.loadModule
 364+ 9258
 365+ 9258
 366+ 9258              loadMod_loop
 367+ 9258                  ;ld hl, buffer_cat, ;(buffer_pointer), hl
 368+ 9258                  ; call Wifi.getPacket
 369+ 9258                  ; ld a, (Wifi.closed) : and a : jr nz, .exit
 370+ 9258                  ; ld hl, buffer_cat, bc, (Wifi.bytes_avail)
 371+ 9258
 372+ 9258 3A 5F A4     		ld a,(file_id_cur_r)
 373+ 925B 21 00 C0     		ld hl,buffer_cat
 374+ 925E 11 00 40             ld de,$4000
 375+ 9261              		OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес дл¤ чтени¤)
 375+ 9261 0E 23       >    ld c,#23
 375+ 9263 E7          >    rst #20
 376+ 9264 DA 61 88     		jp c,load_file_error
 377+ 9267
 378+ 9267 7C                   ld a,h
 379+ 9268 FE C0        		cp $c0
 380+ 926A 38 1A                jr c,loadMod_loadLoop_4000    ;>= $c0, значит остаток файла
 381+ 926C              		;остаток
 382+ 926C 01 00 C0     		ld bc,#c000
 383+ 926F A7           		and a
 384+ 9270 ED 42        		sbc hl,bc
 385+ 9272 28 29        		jr z,loadMod_exit ;если ничего больше не считалось
 386+ 9274 44 4D        		ld bc,hl
 387+ 9276 21 00 C0     		ld hl,buffer_cat
 388+ 9279              load_mod_loadLoop2
 389+ 9279 78               ld a, b
 389+ 927A B1             or c
 389+ 927B A7             and a
 389+ 927C 28 1F          jr z, loadMod_exit
 390+ 927E 7E               ld a, (hl)
 390+ 927F CD A9 A1       call GeneralSound.sendByte
 391+ 9282 0B               dec bc
 392+ 9283 23               inc hl
 393+ 9284 18 F3            jr load_mod_loadLoop2
 394+ 9286
 395+ 9286
 396+ 9286              loadMod_loadLoop_4000
 397+ 9286 21 00 C0     	ld hl,buffer_cat
 398+ 9289 01 00 40     	ld bc,$4000 ;большой кусок для загрузки
 399+ 928C
 400+ 928C              load_mod_loadLoop
 401+ 928C 78               ld a, b
 401+ 928D B1             or c
 401+ 928E A7             and a
 401+ 928F CA 58 92       jp z,loadMod_loop
 402+ 9292 7E               ld a, (hl)
 402+ 9293 CD A9 A1       call GeneralSound.sendByte
 403+ 9296 0B               dec bc
 404+ 9297 23               inc hl
 405+ 9298 18 F2            jr load_mod_loadLoop
 406+ 929A              ;.nextFrame
 407+ 929A                  ;call Wifi.continue
 408+ 929A C3 58 92         jp loadMod_loop
 409+ 929D              loadMod_exit
 410+ 929D CD B1 A1         call GeneralSound.finishLoadingModule
 411+ 92A0
 412+ 92A0 3A 5F A4     	ld a,(file_id_cur_r)
 413+ 92A3              	OS_FILE_CLOSE ;A - id file
 413+ 92A3 0E 25       >    ld c,#25
 413+ 92A5 E7          >    rst #20
 414+ 92A6                  ;jp History.back
 415+ 92A6              	;jp play ;MediaProcessor.processResource
 416+ 92A6              ;.progress db "MOD downloading directly to GS!", 0
 417+ 92A6
 418+ 92A6                  macro GS_WaitCommand2
 419+ 92A6 ~            .wait
 420+ 92A6 ~                in a, (CMD)
 421+ 92A6 ~                rrca
 422+ 92A6 ~                jr c, .wait
 423+ 92A6                  endm
 424+ 92A6
 425+ 92A6                  macro GS_SendCommand2 nn
 426+ 92A6 ~                ld a, nn
 426+ 92A6 ~              out (CMD), a
 427+ 92A6                  endm
 428+ 92A6
 429+ 92A6              loadMod_play
 430+ 92A6
 431+ 92A6 21 60 94     	ld hl,txt_play
 432+ 92A9              	OS_PRINTZ
 432+ 92A9 0E 09       >    ld c,#09
 432+ 92AB E7          >    rst #20
 433+ 92AC
 434+ 92AC 21 43 94         ld hl,txt_gplay_menu
 435+ 92AF              	OS_PRINTZ
 435+ 92AF 0E 09       >    ld c,#09
 435+ 92B1 E7          >    rst #20
 436+ 92B2
 437+ 92B2                  ; call Console.waitForKeyUp
 438+ 92B2
 439+ 92B2                  ; ld hl, Gopher.requestbuffer : call DialogBox.msgNoWait
 440+ 92B2
 441+ 92B2                  ; ;ld a, 1, (Render.play_next), a
 442+ 92B2 AF           	xor a
 443+ 92B3 32 1A 93     	ld (last_song_position),a
 444+ 92B6
 445+ 92B6              load_mod_loop
 446+ 92B6                  OS_WAIT
 446+ 92B6 DF          >	rst #18
 446+ 92B7
 447+ 92B7                  OS_GET_CHAR
 447+ 92B7 0E 10       >    ld c,#10
 447+ 92B9 E7          >    rst #20
 448+ 92BA FE 20        	cp " " ;пробел
 449+ 92BC CA 19 93     	jp z, load_mod_stop
 450+ 92BF FE 73        	cp "s" ;стоп
 451+ 92C1 CA 19 93     	jp z, load_mod_stop
 452+ 92C4 FE 53        	cp "S" ;чтоп
 453+ 92C6 CA 19 93     	jp z, load_mod_stop
 454+ 92C9 FE 18        	cp 24 ;break
 455+ 92CB CA 19 93     	jp z, load_mod_stop
 456+ 92CE              	;call printRTC
 457+ 92CE                  ;проверка что MOD начал играть сначала
 458+ 92CE                  GS_SendCommand2 CMD_GET_SONG_POSITION
 458+ 92CE 3E 60       >    ld a, CMD_GET_SONG_POSITION
 458+ 92D0 D3 BB       >  out (CMD), a
 459+ 92D2                  GS_WaitCommand2
 459+ 92D2             >.wait
 459+ 92D2 DB BB       >    in a, (CMD)
 459+ 92D4 0F          >    rrca
 459+ 92D5 38 FB       >    jr c, .wait
 460+ 92D7 DB B3        	in a,(DATA) ;текущая позиция
 461+ 92D9 32 1B 93     	ld (cur_song_position),a
 462+ 92DC              	;печатать позицию song
 463+ 92DC 11 00 0A     	ld de,#0a00
 464+ 92DF              	OS_SET_XY
 464+ 92DF 0E 01       >    ld c,#01
 464+ 92E1 E7          >    rst #20
 465+ 92E2 2A 1B 93     	ld hl,(cur_song_position)
 466+ 92E5 26 00        	ld h,0
 467+ 92E7 CD E3 93     	call toDecimal
 468+ 92EA              	OS_PRINTZ
 468+ 92EA 0E 09       >    ld c,#09
 468+ 92EC E7          >    rst #20
 469+ 92ED
 470+ 92ED                  GS_SendCommand2 CMD_GET_PATTERN_POSITION
 470+ 92ED 3E 61       >    ld a, CMD_GET_PATTERN_POSITION
 470+ 92EF D3 BB       >  out (CMD), a
 471+ 92F1                  GS_WaitCommand2
 471+ 92F1             >.wait
 471+ 92F1 DB BB       >    in a, (CMD)
 471+ 92F3 0F          >    rrca
 471+ 92F4 38 FB       >    jr c, .wait
 472+ 92F6 DB B3        	in a,(DATA) ;текущая позиция паттерна
 473+ 92F8 32 1C 93     	ld (cur_pattern_position),a
 474+ 92FB 11 00 0B     	ld de,#0b00
 475+ 92FE              	OS_SET_XY
 475+ 92FE 0E 01       >    ld c,#01
 475+ 9300 E7          >    rst #20
 476+ 9301 2A 1C 93     	ld hl,(cur_pattern_position)
 477+ 9304 26 00        	ld h,0
 478+ 9306 CD E3 93     	call toDecimal
 479+ 9309              	OS_PRINTZ
 479+ 9309 0E 09       >    ld c,#09
 479+ 930B E7          >    rst #20
 480+ 930C
 481+ 930C
 482+ 930C 3A 1A 93     	ld a,(last_song_position) ;предыдущая позиция
 483+ 930F 4F           	ld c,a
 484+ 9310 3A 1B 93     	ld a,(cur_song_position) ;текущая
 485+ 9313 32 1A 93     	ld (last_song_position),a
 486+ 9316 B9           	cp c
 487+ 9317 30 9D        	jr nc,load_mod_loop ;если не меньше, продолжаем играть
 488+ 9319                  ;ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
 489+ 9319              load_mod_stop
 490+ 9319                  ;call Console.waitForKeyUp
 491+ 9319 C9               ret
 492+ 931A              ; .stopKey
 493+ 931A                  ; ;xor a : ld (Render.play_next), a ;флаг что не надо играть следующий файл
 494+ 931A                  ; jr .stop
 495+ 931A
 496+ 931A
 497+ 931A              ;message db "Press key to stop...", 0
 498+ 931A
 499+ 931A
 500+ 931A              CMD_GET_SONG_POSITION     = #60
 501+ 931A              CMD_GET_PATTERN_POSITION  = #61
 502+ 931A 00           last_song_position db 0
 503+ 931B 00           cur_song_position db 0
 504+ 931C 00           cur_pattern_position db 0
 505+ 931D
 506+ 931D              ;; Control ports
 507+ 931D              CMD  = 187
 508+ 931D              DATA = 179
 509+ 931D
 510+ 931D 00 00        buffer_pointer dw 0;
 511+ 931F
 512+ 931F
 513+ 931F
 514+ 931F
 515+ 931F
 516+ 931F
 517+ 931F              ;загрузка PTx
 518+ 931F              load_pt2
 519+ 931F 3E 03        	ld a,%00000011 ;pt2
 520+ 9321 32 88 93     	ld (ptplayer_setup),a
 521+ 9324 18 05        	jr load_pt
 522+ 9326              load_pt3
 523+ 9326 3E 21        	ld a,%00100001 ;pt3
 524+ 9328 32 88 93     	ld (ptplayer_setup),a
 525+ 932B
 526+ 932B              load_pt
 527+ 932B
 528+ 932B 21 4A A2     	ld hl,file_name_cur
 529+ 932E CD 13 88     	call load_file
 530+ 9331 D8           	ret c
 531+ 9332
 532+ 9332              	;начать игру
 533+ 9332 21 00 C0     	ld hl,buffer_cat
 534+ 9335              	OS_GET_VTPL_SETUP
 534+ 9335 0E 18       >    ld c,#18
 534+ 9337 E7          >    rst #20
 535+ 9338 3A 88 93     	ld a,(ptplayer_setup)
 536+ 933B 77           	ld (hl),a ;настройки
 537+ 933C
 538+ 933C 21 00 C0     	ld hl,buffer_cat
 539+ 933F              	OS_VTPL_INIT
 539+ 933F 0E 15       >    ld c,#15
 539+ 9341 E7          >    rst #20
 540+ 9342              	OS_VTPL_PLAY
 540+ 9342 0E 16       >    ld c,#16
 540+ 9344 E7          >    rst #20
 541+ 9345
 542+ 9345 21 60 94     	ld hl,txt_play
 543+ 9348              	OS_PRINTZ
 543+ 9348 0E 09       >    ld c,#09
 543+ 934A E7          >    rst #20
 544+ 934B
 545+ 934B 21 43 94     	ld hl,txt_gplay_menu
 546+ 934E              	OS_PRINTZ
 546+ 934E 0E 09       >    ld c,#09
 546+ 9350 E7          >    rst #20
 547+ 9351
 548+ 9351              load_pt_loop
 549+ 9351                  OS_WAIT
 549+ 9351 DF          >	rst #18
 549+ 9352
 550+ 9352                  OS_GET_CHAR
 550+ 9352 0E 10       >    ld c,#10
 550+ 9354 E7          >    rst #20
 551+ 9355 FE 20        	cp " " ;пробел
 552+ 9357 CA 86 93     	jp z, load_pt_stop
 553+ 935A FE 73        	cp "s" ;стоп
 554+ 935C CA 86 93     	jp z, load_pt_stop
 555+ 935F FE 53        	cp "S" ;чтоп
 556+ 9361 CA 86 93     	jp z, load_pt_stop
 557+ 9364 FE 18        	cp 24 ;break
 558+ 9366 CA 86 93     	jp z, load_pt_stop
 559+ 9369              	;call printRTC
 560+ 9369
 561+ 9369              	;печать инфо
 562+ 9369 11 00 0A     	ld de,#0a00
 563+ 936C              	OS_SET_XY
 563+ 936C 0E 01       >    ld c,#01
 563+ 936E E7          >    rst #20
 564+ 936F
 565+ 936F              	OS_GET_VTPL_SETUP
 565+ 936F 0E 18       >    ld c,#18
 565+ 9371 E7          >    rst #20
 566+ 9372 01 3B 09     	ld bc,#93b ;нужная переменная плеера
 567+ 9375 09           	add hl,bc
 568+ 9376 6E               ld l,(hl)
 568+ 9377
 569+ 9377 26 00        	ld h,0
 570+ 9379 CD E3 93     	call toDecimal
 571+ 937C              	OS_PRINTZ
 571+ 937C 0E 09       >    ld c,#09
 571+ 937E E7          >    rst #20
 572+ 937F
 573+ 937F              	;проверка на конец песни
 574+ 937F              	OS_GET_VTPL_SETUP
 574+ 937F 0E 18       >    ld c,#18
 574+ 9381 E7          >    rst #20
 575+ 9382 7E           	ld a, (hl)
 576+ 9383 17           	rla
 577+ 9384 30 CB        	jr nc,load_pt_loop ;если не меньше, продолжаем играть
 578+ 9386                  ;ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
 579+ 9386              load_pt_stop
 580+ 9386                  ;call Console.waitForKeyUp
 581+ 9386 B7           	or a
 582+ 9387 C9               ret
 583+ 9388
 584+ 9388 00           ptplayer_setup db 0;
 585+ 9389
 586+ 9389
 587+ 9389
 588+ 9389
 589+ 9389
 590+ 9389
 591+ 9389
 592+ 9389
 593+ 9389
 594+ 9389
 595+ 9389              	;печать шкалы прогресса
 596+ 9389              gplay_progress_print
 597+ 9389 CD B2 93     	call gplay_progress_calc
 598+ 938C 11 00 02     	ld de,#0200 ;прогресс тут
 599+ 938F              	OS_SET_XY
 599+ 938F 0E 01       >    ld c,#01
 599+ 9391 E7          >    rst #20
 600+ 9392              	;печать закрашенных кубиков
 601+ 9392 3A E2 93     	ld a,(gplay_progress_val)
 602+ 9395 B7           	or a
 603+ 9396 28 08        	jr z,gplay_progress_print1
 604+ 9398 47           	ld b,a
 605+ 9399              gplay_progress_print1_cl
 606+ 9399 C5           	push bc
 607+ 939A 3E B1        	ld a,177 ;псевдографика
 608+ 939C              	OS_PRINT_CHARF
 608+ 939C D7          >	rst #10
 609+ 939D C1           	pop bc
 610+ 939E 10 F9        	djnz gplay_progress_print1_cl
 611+ 93A0              gplay_progress_print1
 612+ 93A0              	;печать пустых кубиков
 613+ 93A0 3A E2 93     	ld a,(gplay_progress_val)
 614+ 93A3 4F           	ld c,a
 615+ 93A4 3E 10        	ld a,gplay_progress_lenght
 616+ 93A6 91           	sub c
 617+ 93A7 28 08        	jr z,gplay_progress_print2
 618+ 93A9 47           	ld b,a
 619+ 93AA              gplay_progress_print1_c2
 620+ 93AA C5           	push bc
 621+ 93AB 3E B0        	ld a,176 ;псевдографика
 622+ 93AD              	OS_PRINT_CHARF
 622+ 93AD D7          >	rst #10
 623+ 93AE C1           	pop bc
 624+ 93AF 10 F9        	djnz gplay_progress_print1_c2
 625+ 93B1
 626+ 93B1              gplay_progress_print2
 627+ 93B1 C9           	ret
 628+ 93B2
 629+ 93B2
 630+ 93B2              gplay_progress_calc
 631+ 93B2 3A FF 95     	ld a,(memorystreampages+255) ;всего страниц памяти занято
 632+ 93B5 67           	ld h,a
 633+ 93B6 2E 00        	ld l,0 ;всего страниц *256
 634+ 93B8
 635+ 93B8              	;разделить
 636+ 93B8 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 637+ 93BA CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 638+ 93BC CB 3C        	srl h ; /4
 639+ 93BE CB 1D        	rr l ;
 640+ 93C0 CB 3C        	srl h ; /8
 641+ 93C2 CB 1D        	rr l ;
 642+ 93C4 CB 3C        	srl h ; /16
 643+ 93C6 CB 1D        	rr l ;
 644+ 93C8              	; srl h ; /32
 645+ 93C8              	; rr l ;
 646+ 93C8              	;узнали сколько страниц одно деление
 647+ 93C8 EB           	ex de,hl
 648+ 93C9
 649+ 93C9
 650+ 93C9 2A 0E 96     	ld hl,(memorystreampageaddr)
 651+ 93CC 01 00 95     	ld bc,memorystreampages
 652+ 93CF A7           	and a
 653+ 93D0 ED 42        	sbc hl,bc ;какая по счёту страница сейчас
 654+ 93D2
 655+ 93D2 65           	ld h,l ;*256
 656+ 93D3 2E 00        	ld l,0
 657+ 93D5
 658+ 93D5              	;разделить на величину одного деления
 659+ 93D5 3E FF        	ld a,-1
 660+ 93D7              divide16
 661+ 93D7 3C           	inc a
 662+ 93D8 A7           	and a
 663+ 93D9 ED 52        	sbc hl,de
 664+ 93DB 30 FA        	jr nc,divide16
 665+ 93DD 19           	add hl,de
 666+ 93DE 32 E2 93     	ld (gplay_progress_val),a
 667+ 93E1 C9           	ret
 668+ 93E2
 669+ 93E2              gplay_progress_lenght equ 16 ;длина шкалы
 670+ 93E2 00           gplay_progress_val db 0;
 671+ 93E3
 672+ 93E3
 673+ 93E3
 674+ 93E3
 675+ 93E3              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 676+ 93E3              				;на входе в HL число
 677+ 93E3 11 10 27     			ld de,10000 ;десятки тысяч
 678+ 93E6 3E FF        			ld a,255
 679+ 93E8              toDecimal10k
 680+ 93E8 A7           			and a
 681+ 93E9 ED 52        			sbc hl,de
 682+ 93EB 3C           			inc a
 683+ 93EC 30 FA        			jr nc,toDecimal10k
 684+ 93EE 19           			add hl,de
 685+ 93EF C6 30        			add a,48
 686+ 93F1 32 3C 94     			ld (decimalS),a
 687+ 93F4 11 E8 03     			ld de,1000 ;тысячи
 688+ 93F7 3E FF        			ld a,255
 689+ 93F9              toDecimal1k
 690+ 93F9 A7           			and a
 691+ 93FA ED 52        			sbc hl,de
 692+ 93FC 3C           			inc a
 693+ 93FD 30 FA        			jr nc,toDecimal1k
 694+ 93FF 19           			add hl,de
 695+ 9400 C6 30        			add a,48
 696+ 9402 32 3D 94     			ld (decimalS+1),a
 697+ 9405 11 64 00     			ld de,100 ;сотни
 698+ 9408 3E FF        			ld a,255
 699+ 940A              toDecimal01k
 700+ 940A A7           			and a
 701+ 940B ED 52        			sbc hl,de
 702+ 940D 3C           			inc a
 703+ 940E 30 FA        			jr nc,toDecimal01k
 704+ 9410 19           			add hl,de
 705+ 9411 C6 30        			add a,48
 706+ 9413 32 3E 94     			ld (decimalS+2),a
 707+ 9416 11 0A 00     			ld de,10 ;десятки
 708+ 9419 3E FF        			ld a,255
 709+ 941B              toDecimal001k
 710+ 941B A7           			and a
 711+ 941C ED 52        			sbc hl,de
 712+ 941E 3C           			inc a
 713+ 941F 30 FA        			jr nc,toDecimal001k
 714+ 9421 19           			add hl,de
 715+ 9422 C6 30        			add a,48
 716+ 9424 32 3F 94     			ld (decimalS+3),a
 717+ 9427 11 01 00     			ld de,1 ;единицы
 718+ 942A 3E FF        			ld a,255
 719+ 942C              toDecimal0001k
 720+ 942C A7           			and a
 721+ 942D ED 52        			sbc hl,de
 722+ 942F 3C           			inc a
 723+ 9430 30 FA        			jr nc,toDecimal0001k
 724+ 9432 19           			add hl,de
 725+ 9433 C6 30        			add a,48
 726+ 9435 32 40 94     			ld (decimalS+4),a
 727+ 9438 21 3C 94     			ld hl,decimalS
 728+ 943B C9           			ret
 729+ 943C
 730+ 943C 00 00 00...  decimalS	ds 6 ;десятичные цифры
 731+ 9442
 732+ 9442
 733+ 9442
 734+ 9442 00           gplay_type db 0 ;тип музыки
 735+ 9443              ;file_id_cur db 0; временно
 736+ 9443
 737+ 9443 0D 0D 42 72  txt_gplay_menu db 13,13,"Break, S - stop ",13,"Sp - Next",0
 737+ 9447 65 61 6B 2C
 737+ 944B 20 53 20 2D
 737+ 944F 20 73 74 6F
 737+ 9453 70 20 0D 53
 737+ 9457 70 20 2D 20
 737+ 945B 4E 65 78 74
 737+ 945F 00
 738+ 9460 0D 50 6C 61  txt_play db 13,"Play... ",0
 738+ 9464 79 2E 2E 2E
 738+ 9468 20 00
 739+ 946A 0D 53 74 6F  txt_stop db 13,"Stop",0
 739+ 946E 70 00
 740+ 9470 0D 4C 6F 61  txt_load db 13,"Load...",0
 740+ 9474 64 2E 2E 2E
 740+ 9478 00
 741+ 9479 0D 47 53 20  txt_no_GS db 13,"GS not found!",0
 741+ 947D 6E 6F 74 20
 741+ 9481 66 6F 75 6E
 741+ 9485 64 21 00
 742+ 9488 0D 42 4D 20  txt_no_BM db 13,"BM not found!",0
 742+ 948C 6E 6F 74 20
 742+ 9490 66 6F 75 6E
 742+ 9494 64 21 00
 743+ 9497 0D 4D 65 6D  txt_memoryerror:    db 13,"Memory allocation error!",0
 743+ 949B 6F 72 79 20
 743+ 949F 61 6C 6C 6F
 743+ 94A3 63 61 74 69
 743+ 94A7 6F 6E 20 65
 743+ 94AB 72 72 6F 72
 743+ 94AF 21 00
 744+ 94B1              ;txt_fopenerror:     db 13,"Cannot open file: ",0
 745+ 94B1
 746+ 94B1              msg_title
 747+ 94B1 47 50 6C 61  	db "GPlay ver 2025.08.18",10,13,0
 747+ 94B5 79 20 76 65
 747+ 94B9 72 20 32 30
 747+ 94BD 32 35 2E 30
 747+ 94C1 38 2E 31 38
 747+ 94C5 0A 0D 00
 748+ 94C8
 749+ 94C8              vgm_plr
 750+ 94C8
 751+ 94C8              ;module equ 0xc000
 752+ 94C8              ;player_load = 0x8000 ;0x4000
 753+ 94C8
 754+ 94C8              ;ovl_start = 0x8000 ;0x4000
 755+ 94C8
 756+ 94C8              PLR_INIT  = vgm_plr ;0x4000
 757+ 94C8              PLR_PLAY  = vgm_plr+5 ;0x4005
 758+ 94C8              PLR_MUTE  = vgm_plr+8 ;0x4008
 759+ 94C8
 760+ 94C8              	include vgm.asm
# file opened: GPlay/vgm.asm
   1++94C8                      ;DEVICE ZXSPECTRUM48
   2++94C8                      ;include "../../../_sdk/sys_h.asm"
   3++94C8                      ;       ORG PROGSTART ;0x4000
   4++94C8
   5++94C8
   6++94C8
   7++94C8              ;memorystreamcurrentpage = 0x5100
   8++94C8              ;current_ram_page = 0x5100
   9++94C8
  10++94C8
  11++94C8              AREA_C000_FFFF   equ 1
  12++94C8
  13++94C8
  14++94C8
  15++94C8              module = $C000
  16++94C8
  17++94C8
  18++94C8
  19++94C8              begin
  20++94C8              START
  21++94C8 21 00 C0             	LD HL,module;MDLADDR ;DE - address of 2nd module for TS
  22++94CB 18 06                	JR INIT
  23++94CD C3 7A 9C             	JP PLAY
  24++94D0 C3 6C 9C             	JP MUTE
  25++94D3              INIT:
  26++94D3 C3 CF 9B             jp init_
  27++94D6
  28++94D6              DEVICE_AY_BIT         = 0
  29++94D6              DEVICE_TURBOSOUND_BIT = 1
  30++94D6              DEVICE_TFM_BIT        = 2
  31++94D6              DEVICE_MOONSOUND_BIT  = 3
  32++94D6              DEVICE_GS_BIT         = 4
  33++94D6              DEVICE_NEOGS_BIT      = 5
  34++94D6              DEVICE_MIDI_UART_BIT  = 6
  35++94D6
  36++94D6              DEVICE_AY_MASK         = 1<<DEVICE_AY_BIT
  37++94D6              DEVICE_TURBOSOUND_MASK = 1<<DEVICE_TURBOSOUND_BIT
  38++94D6              DEVICE_TFM_MASK        = 1<<DEVICE_TFM_BIT
  39++94D6              DEVICE_MOONSOUND_MASK  = 1<<DEVICE_MOONSOUND_BIT
  40++94D6              DEVICE_GS_MASK         = 1<<DEVICE_GS_BIT
  41++94D6              DEVICE_NEOGS_MASK      = 1<<DEVICE_NEOGS_BIT
  42++94D6              DEVICE_MIDI_UART_MASK  = 1<<DEVICE_MIDI_UART_BIT
  43++94D6
  44++94D6
  45++94D6
  46++94D6
  47++94D6
  48++94D6              HEADER_DATA_OFFSET = module+0x34 ;0xC034
  49++94D6              HEADER_LOOP_SAMPLES_COUNT = module+0x20 ;0xC020
  50++94D6              HEADER_GD3_OFFSET = module+0x14 ;0xC014
  51++94D6              HEADER_SAMPLES_COUNT = module+0x18 ;0xC018
  52++94D6              HEADER_LOOP_OFFSET = module+0x1c ;0xC01c
  53++94D6
  54++94D6
  55++94D6              HEADER_SIZE_MAX = 256
  56++94D6              TITLELENGTH = 64
  57++94D6              MEMORYSTREAMMAXPAGES = 210
  58++94D6              MEMORYSTREAMERRORMASK = 255 ; TODO: do we need to enforce loading the entire file?
  59++94D6              ENABLE_FM = 1
  60++94D6
  61++94D6
  62++94D6
  63++94D6
  64++94D6
  65++94D6
  66++94D6
  67++94D6 00 00 00...          align 256   ;0x8100 ;0x4100
  68++9500                      display "s98_file00_pages_list ",$
  69++9500
  70++9500 00 00 00...  memorystreampages: ds 256,0
  71++9600              memorystreampagecount = memorystreampages + 255
  72++9600
  73++9600              	include "common/memorystream.asm"
# file opened: GPlay/common/memorystream.asm
   1++9600              memorystreamstart
   2++9600                      IF AREA_C000_FFFF=1
   3++9600 21 00 00     	ld hl,0x0000
   4++9603                      ELSE
   5++9603 ~                    ld hl,0xffff
   6++9603                      ENDIF
   7++9603 22 72 96     	ld (memorystreamcurrentaddr),hl
   8++9606 21 00 95     	ld hl,memorystreampages
   9++9609 22 0E 96     	ld (memorystreampageaddr),hl
  10++960C C9           	ret
  11++960D
  12++960D              memorystreamnextpage
  13++960D              memorystreampageaddr=$+1
  14++960D 21 00 00     	ld hl,0
  15++9610 F5           	push af
  16++9611 7E           	ld a,(hl)
  17++9612 23           	inc hl
  18++9613 32 7C 9C     	ld (memorystreamcurrentpage),a
  19++9616 22 0E 96     	ld (memorystreampageaddr),hl
  20++9619 C5           	push bc
  21++961A                      IF AREA_C000_FFFF=1
  22++961A              	;SETPGC000
  23++961A              	OS_SET_PAGE_SLOT3
  23++961A 0E 1C       >    ld c,#1c
  23++961C E7          >    rst #20
  24++961D C1           	pop bc
  25++961E F1           	pop af
  26++961F 21 00 C0     	ld hl,0xC000
  27++9622                      ELSE
  28++9622 ~                    SETPG8000
  29++9622 ~                    pop bc
  30++9622 ~                    pop af
  31++9622 ~                    ld hl,0x8000
  32++9622                      ENDIF
  33++9622 C9           	ret
  34++9623
  35++9623              memorystreamskip
  36++9623              ;b = byte count
  37++9623 2A 72 96     	ld hl,(memorystreamcurrentaddr)
  38++9626              .loop
  39++9626 CB 74        	bit 6,h
  40++9628                      IF AREA_C000_FFFF=1
  41++9628 CC 0D 96     	call z,memorystreamnextpage
  42++962B                      ELSE
  43++962B ~             	call nz,memorystreamnextpage
  44++962B                      ENDIF
  45++962B 23           	inc hl
  46++962C 10 F8        	djnz .loop
  47++962E 22 72 96     	ld (memorystreamcurrentaddr),hl
  48++9631 C9           	ret
  49++9632
  50++9632              	macro memory_stream_write_byte src
  51++9632 ~            	bit 6,h
  52++9632 ~                    IF AREA_C000_FFFF=1
  53++9632 ~            	call z,memorystreamnextpage
  54++9632 ~                    ELSE
  55++9632 ~             	call nz,memorystreamnextpage
  56++9632 ~                    ENDIF
  57++9632 ~            	ld (hl),src
  58++9632 ~            	inc hl
  59++9632              	endm
  60++9632
  61++9632              	macro memory_stream_read_byte dest
  62++9632 ~            	bit 6,h
  63++9632 ~                    IF AREA_C000_FFFF=1
  64++9632 ~            	call z,memorystreamnextpage
  65++9632 ~                    ELSE
  66++9632 ~             	call nz,memorystreamnextpage
  67++9632 ~                    ENDIF
  68++9632 ~            	ld dest,(hl)
  69++9632 ~            	inc hl
  70++9632              	endm
  71++9632
  72++9632              	macro memory_stream_read_1 dst
  73++9632 ~            	ld hl,(memorystreamcurrentaddr)
  74++9632 ~            	memory_stream_read_byte dst
  75++9632 ~            	ld (memorystreamcurrentaddr),hl
  76++9632              	endm
  77++9632
  78++9632              	macro memory_stream_read_2 dst1,dst2
  79++9632 ~            	ld hl,(memorystreamcurrentaddr)
  80++9632 ~            	memory_stream_read_byte dst1
  81++9632 ~            	memory_stream_read_byte dst2
  82++9632 ~            	ld (memorystreamcurrentaddr),hl
  83++9632              	endm
  84++9632
  85++9632              	macro memory_stream_read_3 dst1,dst2,dst3
  86++9632 ~            	ld hl,(memorystreamcurrentaddr)
  87++9632 ~            	memory_stream_read_byte dst1
  88++9632 ~            	memory_stream_read_byte dst2
  89++9632 ~            	memory_stream_read_byte dst3
  90++9632 ~            	ld (memorystreamcurrentaddr),hl
  91++9632              	endm
  92++9632
  93++9632              memorystreamread1
  94++9632              ;out: a = byte
  95++9632              	memory_stream_read_1 a
  95++9632 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
  95++9635             >	memory_stream_read_byte a
  95++9635 CB 74       >	bit 6,h
  95++9637             >        IF AREA_C000_FFFF=1
  95++9637 CC 0D 96    >	call z,memorystreamnextpage
  95++963A             >        ELSE
  95++963A ~           > 	call nz,memorystreamnextpage
  95++963A             >        ENDIF
  95++963A 7E          >	ld a,(hl)
  95++963B 23          >	inc hl
  95++963C 22 72 96    >	ld (memorystreamcurrentaddr),hl
  96++963F C9           	ret
  97++9640
  98++9640              memorystreamread2
  99++9640              ;out: de = word
 100++9640              	memory_stream_read_2 e,d
 100++9640 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 100++9643             >	memory_stream_read_byte e
 100++9643 CB 74       >	bit 6,h
 100++9645             >        IF AREA_C000_FFFF=1
 100++9645 CC 0D 96    >	call z,memorystreamnextpage
 100++9648             >        ELSE
 100++9648 ~           > 	call nz,memorystreamnextpage
 100++9648             >        ENDIF
 100++9648 5E          >	ld e,(hl)
 100++9649 23          >	inc hl
 100++964A             >	memory_stream_read_byte d
 100++964A CB 74       >	bit 6,h
 100++964C             >        IF AREA_C000_FFFF=1
 100++964C CC 0D 96    >	call z,memorystreamnextpage
 100++964F             >        ELSE
 100++964F ~           > 	call nz,memorystreamnextpage
 100++964F             >        ENDIF
 100++964F 56          >	ld d,(hl)
 100++9650 23          >	inc hl
 100++9651 22 72 96    >	ld (memorystreamcurrentaddr),hl
 101++9654 C9           	ret
 102++9655
 103++9655              memorystreamread3
 104++9655              ;out: c = byte0, e = byte1, d = byte2
 105++9655              	memory_stream_read_3 c,e,d
 105++9655 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 105++9658             >	memory_stream_read_byte c
 105++9658 CB 74       >	bit 6,h
 105++965A             >        IF AREA_C000_FFFF=1
 105++965A CC 0D 96    >	call z,memorystreamnextpage
 105++965D             >        ELSE
 105++965D ~           > 	call nz,memorystreamnextpage
 105++965D             >        ENDIF
 105++965D 4E          >	ld c,(hl)
 105++965E 23          >	inc hl
 105++965F             >	memory_stream_read_byte e
 105++965F CB 74       >	bit 6,h
 105++9661             >        IF AREA_C000_FFFF=1
 105++9661 CC 0D 96    >	call z,memorystreamnextpage
 105++9664             >        ELSE
 105++9664 ~           > 	call nz,memorystreamnextpage
 105++9664             >        ENDIF
 105++9664 5E          >	ld e,(hl)
 105++9665 23          >	inc hl
 105++9666             >	memory_stream_read_byte d
 105++9666 CB 74       >	bit 6,h
 105++9668             >        IF AREA_C000_FFFF=1
 105++9668 CC 0D 96    >	call z,memorystreamnextpage
 105++966B             >        ELSE
 105++966B ~           > 	call nz,memorystreamnextpage
 105++966B             >        ENDIF
 105++966B 56          >	ld d,(hl)
 105++966C 23          >	inc hl
 105++966D 22 72 96    >	ld (memorystreamcurrentaddr),hl
 106++9670 C9           	ret
 107++9671
 108++9671              memorystreamread4
 109++9671              ;out: adbc = dword
 110++9671              memorystreamcurrentaddr=$+1
 111++9671 21 00 00     	ld hl,0
 112++9674              	memory_stream_read_byte c
 112++9674 CB 74       >	bit 6,h
 112++9676             >        IF AREA_C000_FFFF=1
 112++9676 CC 0D 96    >	call z,memorystreamnextpage
 112++9679             >        ELSE
 112++9679 ~           > 	call nz,memorystreamnextpage
 112++9679             >        ENDIF
 112++9679 4E          >	ld c,(hl)
 112++967A 23          >	inc hl
 113++967B              	memory_stream_read_byte b
 113++967B CB 74       >	bit 6,h
 113++967D             >        IF AREA_C000_FFFF=1
 113++967D CC 0D 96    >	call z,memorystreamnextpage
 113++9680             >        ELSE
 113++9680 ~           > 	call nz,memorystreamnextpage
 113++9680             >        ENDIF
 113++9680 46          >	ld b,(hl)
 113++9681 23          >	inc hl
 114++9682              	memory_stream_read_byte d
 114++9682 CB 74       >	bit 6,h
 114++9684             >        IF AREA_C000_FFFF=1
 114++9684 CC 0D 96    >	call z,memorystreamnextpage
 114++9687             >        ELSE
 114++9687 ~           > 	call nz,memorystreamnextpage
 114++9687             >        ENDIF
 114++9687 56          >	ld d,(hl)
 114++9688 23          >	inc hl
 115++9689              	memory_stream_read_byte a
 115++9689 CB 74       >	bit 6,h
 115++968B             >        IF AREA_C000_FFFF=1
 115++968B CC 0D 96    >	call z,memorystreamnextpage
 115++968E             >        ELSE
 115++968E ~           > 	call nz,memorystreamnextpage
 115++968E             >        ENDIF
 115++968E 7E          >	ld a,(hl)
 115++968F 23          >	inc hl
 116++9690 22 72 96     	ld (memorystreamcurrentaddr),hl
 117++9693 C9           	ret
 118++9694
 119++9694              memorystreamread
 120++9694              ;bc = number of bytes
 121++9694              ;de = dest addr
 122++9694 79           	ld a,c
 123++9695 0B           	dec bc
 124++9696 04           	inc b
 125++9697 48           	ld c,b
 126++9698 47           	ld b,a
 127++9699 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 128++969C              .readloop
 129++969C              	memory_stream_read_byte a
 129++969C CB 74       >	bit 6,h
 129++969E             >        IF AREA_C000_FFFF=1
 129++969E CC 0D 96    >	call z,memorystreamnextpage
 129++96A1             >        ELSE
 129++96A1 ~           > 	call nz,memorystreamnextpage
 129++96A1             >        ENDIF
 129++96A1 7E          >	ld a,(hl)
 129++96A2 23          >	inc hl
 130++96A3 12           	ld (de),a
 131++96A4 13           	inc de
 132++96A5 10 F5        	djnz .readloop
 133++96A7 0D           	dec c
 134++96A8 20 F2        	jr nz,.readloop
 135++96AA 22 72 96     	ld (memorystreamcurrentaddr),hl
 136++96AD C9           	ret
 137++96AE
 138++96AE              memorystreamwrite
 139++96AE              ;bc = number of bytes
 140++96AE              ;de = src addr
 141++96AE 79           	ld a,c
 142++96AF 0B           	dec bc
 143++96B0 04           	inc b
 144++96B1 48           	ld c,b
 145++96B2 47           	ld b,a
 146++96B3 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 147++96B6              .writeloop
 148++96B6 1A           	ld a,(de)
 149++96B7              	memory_stream_write_byte a
 149++96B7 CB 74       >	bit 6,h
 149++96B9             >        IF AREA_C000_FFFF=1
 149++96B9 CC 0D 96    >	call z,memorystreamnextpage
 149++96BC             >        ELSE
 149++96BC ~           > 	call nz,memorystreamnextpage
 149++96BC             >        ENDIF
 149++96BC 77          >	ld (hl),a
 149++96BD 23          >	inc hl
 150++96BE 13           	inc de
 151++96BF 10 F5        	djnz .writeloop
 152++96C1 0D           	dec c
 153++96C2 20 F2        	jr nz,.writeloop
 154++96C4 22 72 96     	ld (memorystreamcurrentaddr),hl
 155++96C7 C9           	ret
 156++96C8
 157++96C8              memorystreamseek
 158++96C8              ;dehl = absolute position
 159++96C8              ;out: hl = read address
 160++96C8 7B           	ld a,e
 161++96C9 44           	ld b,h
 162++96CA CB 20        	sla b
 163++96CC 17           	rla
 164++96CD CB 20        	sla b
 165++96CF 17           	rla
 166++96D0 C6 00        	add a,memorystreampages%256
 167++96D2 5F           	ld e,a
 168++96D3 CE 95        	adc a,memorystreampages/256
 169++96D5 93           	sub e
 170++96D6 57           	ld d,a
 171++96D7 1A           	ld a,(de)
 172++96D8 32 7C 9C     	ld (memorystreamcurrentpage),a
 173++96DB 13           	inc de
 174++96DC ED 53 0E 96  	ld (memorystreampageaddr),de
 175++96E0                      IF AREA_C000_FFFF=1
 176++96E0              	;SETPGC000
 177++96E0 E5           	push hl ;*
 178++96E1              	OS_SET_PAGE_SLOT3
 178++96E1 0E 1C       >    ld c,#1c
 178++96E3 E7          >    rst #20
 179++96E4 E1           	pop hl ;*
 180++96E5 CB F4                set 6,h
 181++96E7                      ELSE
 182++96E7 ~            	SETPG8000
 183++96E7 ~            	res 6,h
 184++96E7                      ENDIF
 185++96E7 CB FC        	set 7,h
 186++96E9 22 72 96     	ld (memorystreamcurrentaddr),hl
 187++96EC C9           	ret
 188++96ED
 189++96ED              memorystreamgetpos
 190++96ED              ;out: dehl = absolute position
 191++96ED 2A 0E 96     	ld hl,(memorystreampageaddr)
 192++96F0 11 FF 6A     	ld de,-memorystreampages-1
 193++96F3 19           	add hl,de
 194++96F4 EB           	ex de,hl
 195++96F5 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 196++96F8
 197++96F8                      IF AREA_C000_FFFF=1
 198++96F8 CB 7C                bit 7,h
 199++96FA CB BC                res 7,h
 200++96FC CB B4                res 6,h
 201++96FE 20 04        	jr nz,$+6
 202++9700                      ELSE
 203++9700 ~            	res 7,h
 204++9700 ~            	bit 6,h
 205++9700 ~            ;	jr z,$+6
 206++9700                      ENDIF
 207++9700 20 04        	jr nz,$+6
 208++9702 13           	inc de
 209++9703 21 00 00     	ld hl,0
 210++9706 AF           	xor a
 211++9707 CB 1B        	rr e
 212++9709 1F           	rra
 213++970A CB 1B        	rr e
 214++970C 1F           	rra
 215++970D B4           	or h
 216++970E 67           	ld h,a
 217++970F C9           	ret
 218++9710
 219++9710              memorystreamsize
 220++9710 00 00 00 00  	ds 4
 221++9714
# file closed: GPlay/common/memorystream.asm
  74++9714              	include "common/opl4.asm"
# file opened: GPlay/common/opl4.asm
   1++9714              	include "moonsound.asm"
# file opened: GPlay/common/moonsound.asm
   1++9714              MOON_BASE_HI = 0x00 ;старший байт
   2++9714              MOON_BASE = 0x24 ;0xc4
   3++9714              MOON_REG1 = MOON_BASE
   4++9714              MOON_DAT1 = MOON_BASE+1  ;c5
   5++9714              MOON_REG2 = MOON_BASE+2  ;c6
   6++9714              MOON_DAT2 = MOON_BASE+3  ;c7
   7++9714              MOON_STAT = MOON_BASE
   8++9714              MOON_WREG = 0xc2
   9++9714              MOON_WDAT = MOON_WREG+1
  10++9714
  11++9714              ;TODO: is this good enough for ATM2?
  12++9714              	macro opl4_wait
  13++9714 ~            	ld a,MOON_BASE_HI
  14++9714 ~            	in a,(MOON_STAT)
  15++9714 ~            	rrca
  16++9714 ~            	jr c,$-3
  17++9714              	endm
  18++9714
  19++9714              ;makes ZXM-Moonsound firmware 1.01 switch PCM ports from default 7E and 7F to C2 and C3
  20++9714              	macro switch_to_pcm_ports_c2_c3
  21++9714 ~            	ld a,MOON_BASE_HI
  22++9714 ~            	in a,(MOON_REG2)
  23++9714              	endm
  24++9714
  25++9714
  26++9714
  27++9714              NR_OF_MIDI_CHANNELS = 16
  28++9714              NR_OF_WAVE_CHANNELS = 24
  29++9714
  30++9714
  31++9714
  32++9714              MOONSOUNDROMSIZE = 0x200000
  33++9714              MOONWAVEHEADERSIZE = 12
  34++9714              MOONRAMWAVETABLESIZE = 128
  35++9714              OPL4MAXWAVECHANNELS = NR_OF_WAVE_CHANNELS
  36++9714
  37++9714              OPL4_TIMER1_COUNT   = 0x02
  38++9714              OPL4_TIMER2_COUNT   = 0x03
  39++9714              OPL4_TIMER_CONTROL  = 0x04
  40++9714
  41++9714
  42++9714
  43++9714
  44++9714              OPL4_REG_TEST0               = 0x00
  45++9714              OPL4_REG_TEST1               = 0x01
  46++9714
  47++9714              OPL4_REG_MEMORY_CONFIGURATION = 0x02
  48++9714              OPL4_MODE_BIT                 = 0x01
  49++9714              OPL4_MTYPE_BIT                = 0x02
  50++9714              OPL4_TONE_HEADER_MASK         = 0x1C
  51++9714              OPL4_DEVICE_ID_MASK           = 0xE0
  52++9714
  53++9714              OPL4_REG_MEMORY_ADDRESS_HIGH  = 0x03
  54++9714              OPL4_REG_MEMORY_ADDRESS_MID   = 0x04
  55++9714              OPL4_REG_MEMORY_ADDRESS_LOW   = 0x05
  56++9714              OPL4_REG_MEMORY_DATA          = 0x06
  57++9714
  58++9714 ~            /*
  59++9714 ~             * Offsets to the register banks for voices. To get the
  60++9714 ~             * register number just add the voice number to the bank offset.
  61++9714 ~             *
  62++9714 ~             * Wave Table Number low bits (0x08 to 0x1F)
  63++9714 ~             */
  64++9714              OPL4_REG_TONE_NUMBER  = 0x08
  65++9714
  66++9714 ~            /* Wave Table Number high bit, F-Number low bits (0x20 to 0x37) */
  67++9714              OPL4_REG_F_NUMBER      = 0x20
  68++9714              OPL4_TONE_NUMBER_BIT8  = 0x01
  69++9714              OPL4_F_NUMBER_LOW_MASK = 0xFE
  70++9714
  71++9714 ~            /* F-Number high bits, Octave, Pseudo-Reverb (0x38 to 0x4F) */
  72++9714              OPL4_REG_OCTAVE         = 0x38
  73++9714              OPL4_F_NUMBER_HIGH_MASK = 0x07
  74++9714              OPL4_BLOCK_MASK         = 0xF0
  75++9714              OPL4_PSEUDO_REVERB_BIT  = 0x08
  76++9714
  77++9714 ~            /* Total Level, Level Direct (0x50 to 0x67) */
  78++9714              OPL4_REG_LEVEL        = 0x50
  79++9714              OPL4_TOTAL_LEVEL_MASK = 0xFE
  80++9714              OPL4_LEVEL_DIRECT_BIT = 0x01
  81++9714
  82++9714 ~            /* Key On, Damp, LFO RST, CH, Panpot (0x68 to 0x7F) */
  83++9714              OPL4_REG_MISC           = 0x68
  84++9714              OPL4_KEY_ON_BIT         = 0x80
  85++9714              OPL4_DAMP_BIT           = 0x40
  86++9714              OPL4_LFO_RESET_BIT      = 0x20
  87++9714              OPL4_OUTPUT_CHANNEL_BIT = 0x10
  88++9714              OPL4_PAN_POT_MASK       = 0x0F
  89++9714
  90++9714 ~            /* LFO, VIB (0x80 to 0x97) */
  91++9714              OPL4_REG_LFO_VIBRATO    = 0x80
  92++9714              OPL4_LFO_FREQUENCY_MASK = 0x38
  93++9714              OPL4_VIBRATO_DEPTH_MASK = 0x07
  94++9714              OPL4_CHORUS_SEND_MASK   = 0xC0
  95++9714
  96++9714 ~            /* Attack / Decay 1 rate (0x98 to 0xAF) */
  97++9714              OPL4_REG_ATTACK_DECAY1  = 0x98
  98++9714              OPL4_ATTACK_RATE_MASK   = 0xF0
  99++9714              OPL4_DECAY1_RATE_MASK   = 0x0F
 100++9714
 101++9714 ~            /* Decay level / 2 rate (0xB0 to 0xC7) */
 102++9714              OPL4_REG_LEVEL_DECAY2  = 0xB0
 103++9714              OPL4_DECAY_LEVEL_MASK  = 0xF0
 104++9714              OPL4_DECAY2_RATE_MASK  = 0x0F
 105++9714
 106++9714 ~            /* Release rate / Rate correction (0xC8 to 0xDF) */
 107++9714              OPL4_REG_RELEASE_CORRECTION  = 0xC8
 108++9714              OPL4_RELEASE_RATE_MASK       = 0x0F
 109++9714              OPL4_RATE_INTERPOLATION_MASK = 0xF0
 110++9714
 111++9714 ~            /* AM (0xE0 to 0xF7) */
 112++9714              OPL4_REG_TREMOLO        = 0xE0
 113++9714              OPL4_TREMOLO_DEPTH_MASK = 0x07
 114++9714              OPL4_REVERB_SEND_MASK   = 0xE0
 115++9714
 116++9714 ~            /* Mixer */
 117++9714              OPL4_REG_MIX_CONTROL_FM  = 0xF8
 118++9714              OPL4_REG_MIX_CONTROL_PCM = 0xF9
 119++9714              OPL4_MIX_LEFT_MASK       = 0x07
 120++9714              OPL4_MIX_RIGHT_MASK      = 0x38
 121++9714
 122++9714              OPL4_REG_ATC             = 0xFA
 123++9714              OPL4_ATC_BIT             = 0x01
 124++9714
 125++9714 ~            /* Bits in the OPL4 Status register */
 126++9714              OPL4_STATUS_BUSY = 0x01
 127++9714              OPL4_STATUS_LOAD = 0x02
 128++9714
# file closed: GPlay/common/moonsound.asm
   2++9714
   3++9714              opl4writefm1
   4++9714              ;e = register
   5++9714              ;d = value
   6++9714              	opl4_wait
   6++9714 3E 00       >	ld a,MOON_BASE_HI
   6++9716 DB 24       >	in a,(MOON_STAT)
   6++9718 0F          >	rrca
   6++9719 38 FB       >	jr c,$-3
   7++971B 7B           	ld a,e
   8++971C C5           	push bc
   9++971D 06 00        	ld b,MOON_BASE_HI
  10++971F 0E 24        	ld c,MOON_REG1
  11++9721 ED 79        	out (c),a
  12++9723              	opl4_wait
  12++9723 3E 00       >	ld a,MOON_BASE_HI
  12++9725 DB 24       >	in a,(MOON_STAT)
  12++9727 0F          >	rrca
  12++9728 38 FB       >	jr c,$-3
  13++972A 7A           	ld a,d
  14++972B 06 00        	ld b,MOON_BASE_HI
  15++972D 0E 25        	ld c,MOON_DAT1
  16++972F ED 79        	out (c),a
  17++9731 C1           	pop bc
  18++9732 C9           	ret
  19++9733
  20++9733              opl4writefm2
  21++9733              ;e = register
  22++9733              ;d = value
  23++9733              	opl4_wait
  23++9733 3E 00       >	ld a,MOON_BASE_HI
  23++9735 DB 24       >	in a,(MOON_STAT)
  23++9737 0F          >	rrca
  23++9738 38 FB       >	jr c,$-3
  24++973A 7B           	ld a,e
  25++973B C5           	push bc
  26++973C 06 00        	ld b,MOON_BASE_HI
  27++973E 0E 26        	ld c,MOON_REG2
  28++9740 ED 79        	out (c),a
  29++9742              	opl4_wait
  29++9742 3E 00       >	ld a,MOON_BASE_HI
  29++9744 DB 24       >	in a,(MOON_STAT)
  29++9746 0F          >	rrca
  29++9747 38 FB       >	jr c,$-3
  30++9749 7A           	ld a,d
  31++974A 06 00        	ld b,MOON_BASE_HI
  32++974C 0E 27        	ld c,MOON_DAT2
  33++974E ED 79        	out (c),a
  34++9750 C1           	pop bc
  35++9751 C9           	ret
  36++9752
  37++9752              opl4writewave
  38++9752              ;e = register
  39++9752              ;d = value
  40++9752              	opl4_wait
  40++9752 3E 00       >	ld a,MOON_BASE_HI
  40++9754 DB 24       >	in a,(MOON_STAT)
  40++9756 0F          >	rrca
  40++9757 38 FB       >	jr c,$-3
  41++9759 7B           	ld a,e
  42++975A C5           	push bc
  43++975B 06 00        	ld b,MOON_BASE_HI
  44++975D 0E C2        	ld c,MOON_WREG
  45++975F ED 79        	out (c),a
  46++9761              	opl4_wait
  46++9761 3E 00       >	ld a,MOON_BASE_HI
  46++9763 DB 24       >	in a,(MOON_STAT)
  46++9765 0F          >	rrca
  46++9766 38 FB       >	jr c,$-3
  47++9768 7A           	ld a,d
  48++9769 06 00        	ld b,MOON_BASE_HI
  49++976B 0E C3        	ld c,MOON_WDAT
  50++976D ED 79        	out (c),a
  51++976F C1           	pop bc
  52++9770 C9           	ret
  53++9771
  54++9771              opl4readwave
  55++9771              ;e = register
  56++9771              	opl4_wait
  56++9771 3E 00       >	ld a,MOON_BASE_HI
  56++9773 DB 24       >	in a,(MOON_STAT)
  56++9775 0F          >	rrca
  56++9776 38 FB       >	jr c,$-3
  57++9778 7B           	ld a,e
  58++9779 C5           	push bc
  59++977A 06 00        	ld b,MOON_BASE_HI
  60++977C 0E C2        	ld c,MOON_WREG
  61++977E ED 79        	out (c),a
  62++9780 C1           	pop bc
  63++9781              	opl4_wait
  63++9781 3E 00       >	ld a,MOON_BASE_HI
  63++9783 DB 24       >	in a,(MOON_STAT)
  63++9785 0F          >	rrca
  63++9786 38 FB       >	jr c,$-3
  64++9788 3E 00        	ld a,MOON_BASE_HI
  65++978A DB C3        	in a,(MOON_WDAT)
  66++978C C9           	ret
  67++978D
  68++978D              	macro opl4_write_fm_regs
  69++978D ~            ;e = base register
  70++978D ~            ;d = value
  71++978D ~            ;b = count
  72++978D ~            .loop
  73++978D ~            	call opl4writefm1
  74++978D ~            	call opl4writefm2
  75++978D ~            	inc e
  76++978D ~            	djnz .loop
  77++978D              	endm
  78++978D
  79++978D              	macro opl4_write_wave_regs
  80++978D ~            ;e = base register
  81++978D ~            ;d = value
  82++978D ~            ;b = count
  83++978D ~            .loop
  84++978D ~            	call opl4writewave
  85++978D ~            	inc e
  86++978D ~            	djnz .loop
  87++978D              	endm
  88++978D
  89++978D              opl4init
  90++978D 11 05 03     	ld de,0x0305
  91++9790 CD 33 97     	call opl4writefm2
  92++9793 06 DA        	ld b,0xda
  93++9795 11 20 00     	ld de,0x0020
  94++9798              	opl4_write_wave_regs
  94++9798             >;e = base register
  94++9798             >;d = value
  94++9798             >;b = count
  94++9798             >.loop
  94++9798 CD 52 97    >	call opl4writewave
  94++979B 1C          >	inc e
  94++979C 10 FA       >	djnz .loop
  95++979E 11 F8 1B     	ld de,0x1bf8
  96++97A1 CD 52 97     	call opl4writewave
  97++97A4 11 02 10     	ld de,0x1002
  98++97A7 CD 52 97     	call opl4writewave
  99++97AA 06 D6        	ld b,0xd6
 100++97AC 11 20 00     	ld de,0x0020
 101++97AF              	opl4_write_fm_regs
 101++97AF             >;e = base register
 101++97AF             >;d = value
 101++97AF             >;b = count
 101++97AF             >.loop
 101++97AF CD 14 97    >	call opl4writefm1
 101++97B2 CD 33 97    >	call opl4writefm2
 101++97B5 1C          >	inc e
 101++97B6 10 F7       >	djnz .loop
 102++97B8 11 01 00     	ld de,0x0001
 103++97BB CD 14 97     	call opl4writefm1
 104++97BE 11 08 00     	ld de,0x0008
 105++97C1 CD 14 97     	call opl4writefm1
 106++97C4 11 04 00     	ld de,0x0004
 107++97C7 C3 33 97     	jp opl4writefm2
 108++97CA
 109++97CA              opl4stoptimers
 110++97CA 11 04 80     	ld de,0x8004
 111++97CD CD 14 97     	call opl4writefm1
 112++97D0 11 04 00     	ld de,0x0004
 113++97D3 C3 14 97     	jp opl4writefm1
 114++97D6
 115++97D6              opl4mute
 116++97D6 CD CA 97     	call opl4stoptimers
 117++97D9 11 04 00     	ld de,0x0004
 118++97DC CD 33 97     	call opl4writefm2
 119++97DF 11 BD 00     	ld de,0x00bd
 120++97E2 CD 14 97     	call opl4writefm1 ;rhythm off
 121++97E5 06 16        	ld b,0x16
 122++97E7 11 80 0F     	ld de,0x0f80
 123++97EA              	opl4_write_fm_regs ;max release rate
 123++97EA             >;e = base register
 123++97EA             >;d = value
 123++97EA             >;b = count
 123++97EA             >.loop
 123++97EA CD 14 97    >	call opl4writefm1
 123++97ED CD 33 97    >	call opl4writefm2
 123++97F0 1C          >	inc e
 123++97F1 10 F7       >	djnz .loop
 124++97F3 06 16        	ld b,0x16
 125++97F5 11 40 3F     	ld de,0x3f40
 126++97F8              	opl4_write_fm_regs ;min total level
 126++97F8             >;e = base register
 126++97F8             >;d = value
 126++97F8             >;b = count
 126++97F8             >.loop
 126++97F8 CD 14 97    >	call opl4writefm1
 126++97FB CD 33 97    >	call opl4writefm2
 126++97FE 1C          >	inc e
 126++97FF 10 F7       >	djnz .loop
 127++9801 06 09        	ld b,0x09
 128++9803 11 A0 00     	ld de,0x00a0
 129++9806              	opl4_write_fm_regs ;frequency 0
 129++9806             >;e = base register
 129++9806             >;d = value
 129++9806             >;b = count
 129++9806             >.loop
 129++9806 CD 14 97    >	call opl4writefm1
 129++9809 CD 33 97    >	call opl4writefm2
 129++980C 1C          >	inc e
 129++980D 10 F7       >	djnz .loop
 130++980F 06 09        	ld b,0x09
 131++9811 11 B0 00     	ld de,0x00b0
 132++9814              	opl4_write_fm_regs ;key off
 132++9814             >;e = base register
 132++9814             >;d = value
 132++9814             >;b = count
 132++9814             >.loop
 132++9814 CD 14 97    >	call opl4writefm1
 132++9817 CD 33 97    >	call opl4writefm2
 132++981A 1C          >	inc e
 132++981B 10 F7       >	djnz .loop
 133++981D 06 18        	ld b,0x18
 134++981F 11 68 40     	ld de,0x4068
 135++9822              	opl4_write_wave_regs ;key off, damp
 135++9822             >;e = base register
 135++9822             >;d = value
 135++9822             >;b = count
 135++9822             >.loop
 135++9822 CD 52 97    >	call opl4writewave
 135++9825 1C          >	inc e
 135++9826 10 FA       >	djnz .loop
 136++9828 11 05 00     	ld de,0x0005
 137++982B C3 33 97     	jp opl4writefm2
 138++982E
 139++982E              opl4setmemoryaddress
 140++982E              ;dhl = memory address
 141++982E 1E 03        	ld e,0x03
 142++9830 CD 52 97     	call opl4writewave
 143++9833 54           	ld d,h
 144++9834 1C           	inc e
 145++9835 CD 52 97     	call opl4writewave
 146++9838 1C           	inc e
 147++9839 55           	ld d,l
 148++983A C3 52 97     	jp opl4writewave
 149++983D
 150++983D              opl4readmemory
 151++983D              ;bc = byte count
 152++983D              ;dhl = memory address
 153++983D              ;ix = buffer
 154++983D CD 2E 98     	call opl4setmemoryaddress
 155++9840 11 02 11     	ld de,0x1102
 156++9843 CD 52 97     	call opl4writewave
 157++9846              	opl4_wait
 157++9846 3E 00       >	ld a,MOON_BASE_HI
 157++9848 DB 24       >	in a,(MOON_STAT)
 157++984A 0F          >	rrca
 157++984B 38 FB       >	jr c,$-3
 158++984D 3E 06        	ld a,6
 159++984F C5           	push bc
 160++9850 06 00        	ld b,MOON_BASE_HI
 161++9852 0E C2        	ld c,MOON_WREG
 162++9854 ED 79        	out (c),a
 163++9856 C1           	pop bc
 164++9857 DD 54 DD 5D  	ld de,ix
 165++985B 79           	ld a,c
 166++985C 0B           	dec bc
 167++985D 04           	inc b
 168++985E 48           	ld c,b
 169++985F 47           	ld b,a
 170++9860              .readloop
 171++9860              	opl4_wait
 171++9860 3E 00       >	ld a,MOON_BASE_HI
 171++9862 DB 24       >	in a,(MOON_STAT)
 171++9864 0F          >	rrca
 171++9865 38 FB       >	jr c,$-3
 172++9867 3E 00        	ld a,MOON_BASE_HI
 173++9869 DB C3        	in a,(MOON_WDAT)
 174++986B 12           	ld (de),a
 175++986C 13           	inc de
 176++986D 10 F1        	djnz .readloop
 177++986F 0D           	dec c
 178++9870 20 EE        	jr nz,.readloop
 179++9872 11 02 10     	ld de,0x1002
 180++9875 C3 52 97     	jp opl4writewave
 181++9878
 182++9878              opl4writememory
 183++9878              ;bc = number of bytes
 184++9878              ;dhl = memory address
 185++9878              ;ix = buffer
 186++9878 CD 2E 98     	call opl4setmemoryaddress
 187++987B 11 02 11     	ld de,0x1102
 188++987E CD 52 97     	call opl4writewave
 189++9881              	opl4_wait
 189++9881 3E 00       >	ld a,MOON_BASE_HI
 189++9883 DB 24       >	in a,(MOON_STAT)
 189++9885 0F          >	rrca
 189++9886 38 FB       >	jr c,$-3
 190++9888 3E 06        	ld a,6
 191++988A C5           	push bc
 192++988B 06 00        	ld b,MOON_BASE_HI
 193++988D 0E C2        	ld c,MOON_WREG
 194++988F ED 79        	out (c),a
 195++9891 C1           	pop bc
 196++9892 DD 54 DD 5D  	ld de,ix
 197++9896 79           	ld a,c
 198++9897 0B           	dec bc
 199++9898 04           	inc b
 200++9899 48           	ld c,b
 201++989A 47           	ld b,a
 202++989B              .writeloop
 203++989B              	opl4_wait
 203++989B 3E 00       >	ld a,MOON_BASE_HI
 203++989D DB 24       >	in a,(MOON_STAT)
 203++989F 0F          >	rrca
 203++98A0 38 FB       >	jr c,$-3
 204++98A2 1A           	ld a,(de)
 205++98A3 C5           	push bc
 206++98A4 06 00        	ld b,MOON_BASE_HI
 207++98A6 0E C3        	ld c,MOON_WDAT
 208++98A8 ED 79        	out (c),a
 209++98AA C1           	pop bc
 210++98AB 13           	inc de
 211++98AC 10 ED        	djnz .writeloop
 212++98AE 0D           	dec c
 213++98AF 20 EA        	jr nz,.writeloop
 214++98B1 11 02 10     	ld de,0x1002
 215++98B4 C3 52 97     	jp opl4writewave
 216++98B7
# file closed: GPlay/common/opl4.asm
  75++98B7              	include "common/opm.asm"
# file opened: GPlay/common/opm.asm
   1++98B7              ;Having chip 0 is mandatory for the player to detect YM2151,
   2++98B7              ;chip 1 is an optional second chip.
   3++98B7
   4++98B7              OPM0_REG = 0xf0c1 ;write: chip 0 address
   5++98B7              OPM0_DAT = 0xf1c1 ;write: chip 0 value, read: chip 0 status
   6++98B7              OPM1_REG = 0xf2c1 ;write: chip 1 address
   7++98B7              OPM1_DAT = 0xf3c1 ;write: chip 1 value, read: chip 1 status
   8++98B7
   9++98B7              	macro opm_write_reg reg,dat
  10++98B7 ~            ;bc = data port
  11++98B7 ~            ;e = register
  12++98B7 ~            ;d = value
  13++98B7 ~            	ld bc,dat
  14++98B7 ~            	in f,(c)
  15++98B7 ~            	jp m,$-2
  16++98B7 ~            	ld bc,reg
  17++98B7 ~            	out (c),e
  18++98B7 ~            	ld bc,dat
  19++98B7 ~            	in f,(c)
  20++98B7 ~            	jp m,$-2
  21++98B7 ~            	out (c),d
  22++98B7              	endm
  23++98B7
  24++98B7              opmwriteall
  25++98B7              ;e = register
  26++98B7              ;d = value
  27++98B7 CD D2 98     	call opmwritechip1
  28++98BA              opmwritechip0
  29++98BA              ;e = register
  30++98BA              ;d = value
  31++98BA              	opm_write_reg OPM0_REG,OPM0_DAT
  31++98BA             >;bc = data port
  31++98BA             >;e = register
  31++98BA             >;d = value
  31++98BA 01 C1 F1    >	ld bc,OPM0_DAT
  31++98BD ED 70       >	in f,(c)
  31++98BF FA BD 98    >	jp m,$-2
  31++98C2 01 C1 F0    >	ld bc,OPM0_REG
  31++98C5 ED 59       >	out (c),e
  31++98C7 01 C1 F1    >	ld bc,OPM0_DAT
  31++98CA ED 70       >	in f,(c)
  31++98CC FA CA 98    >	jp m,$-2
  31++98CF ED 51       >	out (c),d
  32++98D1 C9           	ret
  33++98D2
  34++98D2              opmwritechip1
  35++98D2              ;e = register
  36++98D2              ;d = value
  37++98D2              	opm_write_reg OPM1_REG,OPM1_DAT
  37++98D2             >;bc = data port
  37++98D2             >;e = register
  37++98D2             >;d = value
  37++98D2 01 C1 F3    >	ld bc,OPM1_DAT
  37++98D5 ED 70       >	in f,(c)
  37++98D7 FA D5 98    >	jp m,$-2
  37++98DA 01 C1 F2    >	ld bc,OPM1_REG
  37++98DD ED 59       >	out (c),e
  37++98DF 01 C1 F3    >	ld bc,OPM1_DAT
  37++98E2 ED 70       >	in f,(c)
  37++98E4 FA E2 98    >	jp m,$-2
  37++98E7 ED 51       >	out (c),d
  38++98E9 C9           	ret
  39++98EA
  40++98EA              opmdisablechip1
  41++98EA 3E C9        	ld a,0xc9 ;ret opcode
  42++98EC 32 D2 98     	ld (opmwritechip1),a
  43++98EF C9           	ret
  44++98F0
  45++98F0              	macro opm_write_regs incr,incd
  46++98F0 ~            ;e = base register
  47++98F0 ~            ;d = value
  48++98F0 ~            ;l = count
  49++98F0 ~            .loop	call opmwriteall
  50++98F0 ~            	IF incr
  51++98F0 ~            	inc e
  52++98F0 ~            	ENDIF
  53++98F0 ~            	IF incd
  54++98F0 ~            	inc d
  55++98F0 ~            	ENDIF
  56++98F0 ~            	dec l
  57++98F0 ~            	jr nz,.loop
  58++98F0              	endm
  59++98F0
  60++98F0              opminit
  61++98F0 2E 00        	ld l,0
  62++98F2 11 00 00     	ld de,0
  63++98F5              	opm_write_regs 1,0
  63++98F5             >;e = base register
  63++98F5             >;d = value
  63++98F5             >;l = count
  63++98F5 CD B7 98    >.loop	call opmwriteall
  63++98F8             >	IF 1
  63++98F8 1C          >	inc e
  63++98F9             >	ENDIF
  63++98F9             >	IF 0
  63++98F9 ~           >	inc d
  63++98F9             >	ENDIF
  63++98F9 2D          >	dec l
  63++98FA 20 F9       >	jr nz,.loop
  64++98FC C9           	ret
  65++98FD
  66++98FD              opmstoptimers
  67++98FD 11 14 30     	ld de,0x3014
  68++9900 CD B7 98     	call opmwriteall
  69++9903 11 14 00     	ld de,0x0014
  70++9906 C3 B7 98     	jp opmwriteall
  71++9909
  72++9909              opmmute
  73++9909 CD FD 98     	call opmstoptimers
  74++990C              ;max release rate
  75++990C 2E 20        	ld l,0x20
  76++990E 11 E0 0F     	ld de,0x0fe0
  77++9911              	opm_write_regs 1,0
  77++9911             >;e = base register
  77++9911             >;d = value
  77++9911             >;l = count
  77++9911 CD B7 98    >.loop	call opmwriteall
  77++9914             >	IF 1
  77++9914 1C          >	inc e
  77++9915             >	ENDIF
  77++9915             >	IF 0
  77++9915 ~           >	inc d
  77++9915             >	ENDIF
  77++9915 2D          >	dec l
  77++9916 20 F9       >	jr nz,.loop
  78++9918              ;min total level
  79++9918 2E 20        	ld l,0x20
  80++991A 11 60 7F     	ld de,0x7f60
  81++991D              	opm_write_regs 1,0
  81++991D             >;e = base register
  81++991D             >;d = value
  81++991D             >;l = count
  81++991D CD B7 98    >.loop	call opmwriteall
  81++9920             >	IF 1
  81++9920 1C          >	inc e
  81++9921             >	ENDIF
  81++9921             >	IF 0
  81++9921 ~           >	inc d
  81++9921             >	ENDIF
  81++9921 2D          >	dec l
  81++9922 20 F9       >	jr nz,.loop
  82++9924              ;key off
  83++9924 2E 08        	ld l,0x08
  84++9926 11 08 00     	ld de,0x0008
  85++9929              	opm_write_regs 0,1
  85++9929             >;e = base register
  85++9929             >;d = value
  85++9929             >;l = count
  85++9929 CD B7 98    >.loop	call opmwriteall
  85++992C             >	IF 0
  85++992C ~           >	inc e
  85++992C             >	ENDIF
  85++992C             >	IF 1
  85++992C 14          >	inc d
  85++992D             >	ENDIF
  85++992D 2D          >	dec l
  85++992E 20 F9       >	jr nz,.loop
  86++9930 C9           	ret
  87++9931
# file closed: GPlay/common/opm.asm
  76++9931              	include "vgm/opl4.asm"
# file opened: GPlay/vgm/opl4.asm
   1++9931              WAVEHEADERBUFFERSIZE = MOONRAMWAVETABLESIZE*MOONWAVEHEADERSIZE
   2++9931
   3++9931              opl4writemusiconlyfm1
   4++9931              ;skips writes to control registers
   5++9931              ;e = register
   6++9931              ;d = value
   7++9931 7B           	ld a,e
   8++9932 FE 20        	cp 0x20
   9++9934 D2 14 97     	jp nc,opl4writefm1
  10++9937 FE 08        	cp 0x08
  11++9939 C0           	ret nz
  12++993A C3 14 97     	jp opl4writefm1
  13++993D
  14++993D              opl4writemusiconlyfm2
  15++993D              ;skips writes to control registers
  16++993D              ;e = register
  17++993D              ;d = value
  18++993D 7B           	ld a,e
  19++993E FE 04        	cp 4
  20++9940 D8               ret c
  21++9941 FE 05        	cp 5
  22++9943 C8           	ret z
  23++9944 C3 33 97     	jp opl4writefm2
  24++9947
  25++9947              opl4writewavemusiconly
  26++9947              ;skips writes to control registers and handles ROM dumps
  27++9947              ;e = register
  28++9947              ;d = value
  29++9947 7B           	ld a,e
  30++9948 FE 38        	cp 0x38
  31++994A D2 52 97     	jp nc,opl4writewave
  32++994D FE 08        	cp 0x08
  33++994F D8           	ret c
  34++9950 FE 20        	cp 0x20
  35++9952 38 07        	jr c,writewavetableindexlo
  36++9954              ;force wave table index into 384--511 range if ROM data is loaded
  37++9954              isromloaded=$+1
  38++9954 3E 00        	ld a,0
  39++9956 B2           	or d
  40++9957 57           	ld d,a
  41++9958 C3 52 97     	jp opl4writewave
  42++995B              writewavetableindexlo
  43++995B 3A 55 99     	ld a,(isromloaded)
  44++995E 0F           	rrca
  45++995F B2           	or d
  46++9960 57           	ld d,a
  47++9961 CD 52 97     	call opl4writewave
  48++9964              ;wait for the header to load
  49++9964 3E 00        	ld a,MOON_BASE_HI
  50++9966 DB 24        	in a,(MOON_STAT)
  51++9968 E6 03        	and 3
  52++996A 20 FA        	jr nz,$-4
  53++996C C9           	ret
  54++996D
  55++996D              vgmopl4init
  56++996D AF           	xor a
  57++996E 32 55 99     	ld (isromloaded),a
  58++9971 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
  59++9974 22 B3 99     	ld (opl4loadramdatablockheader.romsize0),hl
  60++9977 3E 20        	ld a,MOONSOUNDROMSIZE/65536
  61++9979 32 B7 99     	ld (opl4loadramdatablockheader.romsize2),a
  62++997C C3 8D 97     	jp opl4init
  63++997F
  64++997F              sub24x16
  65++997F              ;dhl = minuend
  66++997F              ;bc = subtrahend
  67++997F              ;out: cf=1 if negative result, zf=1 if zero
  68++997F B7 ED 42     	sub hl,bc
  69++9982 38 04        	jr c,.carry
  70++9984 C0           	ret nz
  71++9985 7A           	ld a,d
  72++9986 B7           	or a
  73++9987 C9           	ret
  74++9988              .carry
  75++9988 7A           	ld a,d
  76++9989 DE 00        	sbc a,0
  77++998B 57           	ld d,a
  78++998C C0           	ret nz
  79++998D 7D           	ld a,l
  80++998E B4           	or h
  81++998F C9           	ret
  82++9990
  83++9990              opl4loadromdatablockheader
  84++9990              ;dhl = header+data size
  85++9990              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
  86++9990 D9           	exx
  87++9991 CD 71 96     	call memorystreamread4 ;adbc = total rom size
  88++9994 ED 43 B3 99  	ld (opl4loadramdatablockheader.romsize0),bc
  89++9998 7A           	ld a,d
  90++9999 C6 20        	add 0x20 ;place in RAM
  91++999B 32 B7 99     	ld (opl4loadramdatablockheader.romsize2),a
  92++999E CD 71 96     	call memorystreamread4 ;adbc = start address
  93++99A1 60 69        	ld hl,bc
  94++99A3 CB EA        	set 5,d ;place in RAM
  95++99A5 D9           	exx
  96++99A6 01 08 00     	ld bc,8
  97++99A9 18 D4        	jr sub24x16
  98++99AB
  99++99AB              opl4loadramdatablockheader
 100++99AB              ;dhl = header+data size
 101++99AB              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
 102++99AB D9           	exx
 103++99AC CD 71 96     	call memorystreamread4 ;adbc = total ram size
 104++99AF CD 71 96     	call memorystreamread4 ;adbc = start address
 105++99B2              .romsize0=$+1
 106++99B2 21 00 00     	ld hl,0
 107++99B5 09           	add hl,bc
 108++99B6              .romsize2=$+1
 109++99B6 3E 00        	ld a,0
 110++99B8 8A           	adc a,d
 111++99B9 E6 3F        	and 0x3f
 112++99BB 57           	ld d,a
 113++99BC D9           	exx
 114++99BD 01 08 00     	ld bc,8
 115++99C0 18 BD        	jr sub24x16
 116++99C2
 117++99C2              setup24bitscounterloop
 118++99C2              ;dhl = counter
 119++99C2              ;out: b = inner loop counter, de = outer loop counter
 120++99C2 5D           	ld e,l
 121++99C3 01 01 00     	ld bc,1
 122++99C6 B7 ED 42     	sub hl,bc
 123++99C9 30 01        	jr nc,$+3
 124++99CB 15           	dec d
 125++99CC 43           	ld b,e
 126++99CD 5C           	ld e,h
 127++99CE 13           	inc de
 128++99CF C9           	ret
 129++99D0
 130++99D0              opl4loadsample
 131++99D0              ;dhl = sample start address
 132++99D0              ;dhl' = sample size
 133++99D0 42           	ld b,d
 134++99D1 11 05 03     	ld de,0x0305
 135++99D4 CD 33 97     	call opl4writefm2
 136++99D7 50           	ld d,b
 137++99D8 CD 2E 98     	call opl4setmemoryaddress
 138++99DB 11 02 11     	ld de,0x1102
 139++99DE CD 52 97     	call opl4writewave
 140++99E1              	opl4_wait
 140++99E1 3E 00       >	ld a,MOON_BASE_HI
 140++99E3 DB 24       >	in a,(MOON_STAT)
 140++99E5 0F          >	rrca
 140++99E6 38 FB       >	jr c,$-3
 141++99E8 3E 06        	ld a,6
 142++99EA C5           	push bc
 143++99EB 06 00        	ld b,MOON_BASE_HI
 144++99ED 0E C2        	ld c,MOON_WREG
 145++99EF ED 79        	out (c),a
 146++99F1 C1           	pop bc
 147++99F2 D9           	exx
 148++99F3 CD C2 99     	call setup24bitscounterloop
 149++99F6 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 150++99F9              .loop
 151++99F9              	memory_stream_read_byte c
 151++99F9 CB 74       >	bit 6,h
 151++99FB             >        IF AREA_C000_FFFF=1
 151++99FB CC 0D 96    >	call z,memorystreamnextpage
 151++99FE             >        ELSE
 151++99FE ~           > 	call nz,memorystreamnextpage
 151++99FE             >        ENDIF
 151++99FE 4E          >	ld c,(hl)
 151++99FF 23          >	inc hl
 152++9A00              	opl4_wait
 152++9A00 3E 00       >	ld a,MOON_BASE_HI
 152++9A02 DB 24       >	in a,(MOON_STAT)
 152++9A04 0F          >	rrca
 152++9A05 38 FB       >	jr c,$-3
 153++9A07 79           	ld a,c
 154++9A08 C5           	push bc
 155++9A09 06 00        	ld b,MOON_BASE_HI
 156++9A0B 0E C3        	ld c,MOON_WDAT
 157++9A0D ED 79        	out (c),a
 158++9A0F C1           	pop bc
 159++9A10 10 E7        	djnz .loop
 160++9A12 1B           	dec de
 161++9A13 7B           	ld a,e
 162++9A14 B2           	or d
 163++9A15 20 E2        	jr nz,.loop
 164++9A17 22 72 96     	ld (memorystreamcurrentaddr),hl
 165++9A1A 11 02 10     	ld de,0x1002
 166++9A1D C3 52 97     	jp opl4writewave
 167++9A20
 168++9A20              opl4loadramdatablock
 169++9A20              ;dhl = data+header size
 170++9A20 CD AB 99     	call opl4loadramdatablockheader
 171++9A23 C8           	ret z
 172++9A24 D9           	exx
 173++9A25 18 A9        	jr opl4loadsample
 174++9A27
 175++9A27              opl4loadromdatablock
 176++9A27              ;dhl = data+header size
 177++9A27 CD 90 99     	call opl4loadromdatablockheader
 178++9A2A C8           	ret z
 179++9A2B D9           	exx
 180++9A2C D5           	push de
 181++9A2D CD D0 99     	call opl4loadsample
 182++9A30 F1           	pop af
 183++9A31              ;check if the address is within the first 64K of RAM
 184++9A31 FE 21        	cp 0x21
 185++9A33 D0           	ret nc
 186++9A34              ;patch all 128 headers that LSI can read from RAM
 187++9A34 3E 01        	ld a,1
 188++9A36 32 55 99     	ld (isromloaded),a
 189++9A39 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 190++9A3C 16 20        	ld d,MOONSOUNDROMSIZE/65536
 191++9A3E 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 192++9A41 DD 21 00 B8  	ld ix,waveheaderbuffer
 193++9A45 CD 3D 98     	call opl4readmemory
 194++9A48 21 00 B8     	ld hl,waveheaderbuffer
 195++9A4B 11 0C 00     	ld de,MOONWAVEHEADERSIZE
 196++9A4E 06 80        	ld b,MOONRAMWAVETABLESIZE
 197++9A50              .loop
 198++9A50 CB EE        	set 5,(hl) ;set base address in RAM area
 199++9A52 19           	add hl,de
 200++9A53 10 FB        	djnz .loop
 201++9A55 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 202++9A58 16 20        	ld d,MOONSOUNDROMSIZE/65536
 203++9A5A 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 204++9A5D DD 21 00 B8  	ld ix,waveheaderbuffer
 205++9A61 C3 78 98     	jp opl4writememory
 206++9A64
 207++9A64              opl4inittimer60hz
 208++9A64 11 02 2F     	ld de,0x2f02
 209++9A67 CD 14 97     	call opl4writefm1
 210++9A6A 11 04 21     	ld de,0x2104
 211++9A6D C3 14 97     	jp opl4writefm1
 212++9A70
 213++9A70              opl4waittimer60hz
 214++9A70 3E 00        	ld a,MOON_BASE_HI
 215++9A72 DB 24        	in a,(MOON_STAT)
 216++9A74 17           	rla
 217++9A75 30 F9        	jr nc,opl4waittimer60hz
 218++9A77 11 04 81     	ld de,0x8104
 219++9A7A C3 14 97     	jp opl4writefm1
 220++9A7D
# file closed: GPlay/vgm/opl4.asm
  77++9A7D              	include "common/opn.asm"
# file opened: GPlay/common/opn.asm
   1++9A7D              ;Define ENABLE_FM to enable FM DACs
   2++9A7D
   3++9A7D              OPN_REG = 0xfffd
   4++9A7D              OPN_DAT = 0xbffd
   5++9A7D
   6++9A7D
   7++9A7D                      ifdef ENABLE_FM
   8++9A7D ~            CHIP0 = %11111000
   9++9A7D ~            CHIP1 = %11111001
  10++9A7D                      else
  11++9A7D              CHIP0 = %11111100
  12++9A7D              CHIP1 = %11111101
  13++9A7D                      endif
  14++9A7D
  15++9A7D
  16++9A7D              ;------------------------------------
  17++9A7D              opnwriteall
  18++9A7D CD A0 9A     	call opnwritefm2
  19++9A80              ;------------------------------------
  20++9A80              opnwritefm1:
  21++9A80              	;opn_write_fm_reg 0
  22++9A80 3E FC              	ld a,CHIP0
  23++9A82              opnwritefmx:
  24++9A82              ;a = chipselect
  25++9A82              ;e = register
  26++9A82              ;d = value
  27++9A82 01 FD FF     	ld bc,OPN_REG
  28++9A85 ED 79        	out (c),a
  29++9A87
  30++9A87              1
  31++9A87 00           	nop
  31++9A88 00            nop
  32++9A89              ;        nop:nop:nop
  33++9A89 ED 70        	in f,(c)
  34++9A8B FA 87 9A     	jp m, 1b ;$-6
  35++9A8E
  36++9A8E ED 59        	out (c),e
  37++9A90
  38++9A90              2
  39++9A90 00             	nop
  39++9A91 00            nop
  40++9A92              ;        nop:nop:nop
  41++9A92 ED 70        	in f,(c)
  42++9A94 FA 90 9A     	jp m,2b   ;$-6
  43++9A97
  44++9A97 06 BF        	ld b,HIGH OPN_DAT
  45++9A99 ED 51        	out (c),d
  46++9A9B
  47++9A9B              .extradelay ;additional delay for FPGA systems
  48++9A9B 06 08        	ld b,8
  49++9A9D 10 FE        	djnz $
  50++9A9F C9           	ret
  51++9AA0              ;------------------------------------
  52++9AA0              opnwritefm2:
  53++9AA0 3E FD               	ld a,CHIP1
  54++9AA2 C3 82 9A             jp opnwritefmx
  55++9AA5              ;------------------------------------
  56++9AA5
  57++9AA5
  58++9AA5              opndisableextradelay
  59++9AA5 3E C9        	ld a,0xc9 ;ret opcode
  60++9AA7 32 9B 9A     	ld (opnwritefmx.extradelay),a
  61++9AAA C9           	ret
  62++9AAB
  63++9AAB
  64++9AAB              	macro opn_write_fm_regs incr,incd
  65++9AAB ~            ;e = base register
  66++9AAB ~            ;d = value
  67++9AAB ~            ;l = count
  68++9AAB ~            .loop	call opnwriteall
  69++9AAB ~            	IF incr
  70++9AAB ~            	inc e
  71++9AAB ~            	ENDIF
  72++9AAB ~            	IF incd
  73++9AAB ~            	inc d
  74++9AAB ~            	ENDIF
  75++9AAB ~            	dec l
  76++9AAB ~            	jr nz,.loop
  77++9AAB              	endm
  78++9AAB
  79++9AAB
  80++9AAB
  81++9AAB              opninit
  82++9AAB 2E B4        	ld l,0xb4
  83++9AAD 11 00 00     	ld de,0x0000
  84++9AB0              	opn_write_fm_regs 1,0
  84++9AB0             >;e = base register
  84++9AB0             >;d = value
  84++9AB0             >;l = count
  84++9AB0 CD 7D 9A    >.loop	call opnwriteall
  84++9AB3             >	IF 1
  84++9AB3 1C          >	inc e
  84++9AB4             >	ENDIF
  84++9AB4             >	IF 0
  84++9AB4 ~           >	inc d
  84++9AB4             >	ENDIF
  84++9AB4 2D          >	dec l
  84++9AB5 20 F9       >	jr nz,.loop
  85++9AB7              ;configure prescaler
  86++9AB7 11 2F 00     	ld de,0x002f
  87++9ABA CD 7D 9A     	call opnwriteall
  88++9ABD 11 2D 00     	ld de,0x002d
  89++9AC0 C3 7D 9A     	jp opnwriteall
  90++9AC3
  91++9AC3              opnstoptimers
  92++9AC3 11 27 30     	ld de,0x3027
  93++9AC6 CD 7D 9A     	call opnwriteall
  94++9AC9 11 27 00     	ld de,0x0027
  95++9ACC C3 7D 9A     	jp opnwriteall
  96++9ACF
  97++9ACF              opnmute
  98++9ACF CD C3 9A     	call opnstoptimers
  99++9AD2              ;mute SSG
 100++9AD2 2E 03        	ld l,3
 101++9AD4 11 08 00     	ld de,0x0008
 102++9AD7              	opn_write_fm_regs 1,0
 102++9AD7             >;e = base register
 102++9AD7             >;d = value
 102++9AD7             >;l = count
 102++9AD7 CD 7D 9A    >.loop	call opnwriteall
 102++9ADA             >	IF 1
 102++9ADA 1C          >	inc e
 102++9ADB             >	ENDIF
 102++9ADB             >	IF 0
 102++9ADB ~           >	inc d
 102++9ADB             >	ENDIF
 102++9ADB 2D          >	dec l
 102++9ADC 20 F9       >	jr nz,.loop
 103++9ADE 2E 0E        	ld l,14
 104++9AE0 11 00 00     	ld de,0x0000
 105++9AE3              	opn_write_fm_regs 1,0
 105++9AE3             >;e = base register
 105++9AE3             >;d = value
 105++9AE3             >;l = count
 105++9AE3 CD 7D 9A    >.loop	call opnwriteall
 105++9AE6             >	IF 1
 105++9AE6 1C          >	inc e
 105++9AE7             >	ENDIF
 105++9AE7             >	IF 0
 105++9AE7 ~           >	inc d
 105++9AE7             >	ENDIF
 105++9AE7 2D          >	dec l
 105++9AE8 20 F9       >	jr nz,.loop
 106++9AEA              ;max release rate
 107++9AEA 2E 10        	ld l,0x10
 108++9AEC 11 80 0F     	ld de,0x0f80
 109++9AEF              	opn_write_fm_regs 1,0
 109++9AEF             >;e = base register
 109++9AEF             >;d = value
 109++9AEF             >;l = count
 109++9AEF CD 7D 9A    >.loop	call opnwriteall
 109++9AF2             >	IF 1
 109++9AF2 1C          >	inc e
 109++9AF3             >	ENDIF
 109++9AF3             >	IF 0
 109++9AF3 ~           >	inc d
 109++9AF3             >	ENDIF
 109++9AF3 2D          >	dec l
 109++9AF4 20 F9       >	jr nz,.loop
 110++9AF6              ;min total level
 111++9AF6 2E 10        	ld l,0x10
 112++9AF8 11 40 7F     	ld de,0x7f40
 113++9AFB              	opn_write_fm_regs 1,0
 113++9AFB             >;e = base register
 113++9AFB             >;d = value
 113++9AFB             >;l = count
 113++9AFB CD 7D 9A    >.loop	call opnwriteall
 113++9AFE             >	IF 1
 113++9AFE 1C          >	inc e
 113++9AFF             >	ENDIF
 113++9AFF             >	IF 0
 113++9AFF ~           >	inc d
 113++9AFF             >	ENDIF
 113++9AFF 2D          >	dec l
 113++9B00 20 F9       >	jr nz,.loop
 114++9B02              ;key off
 115++9B02 2E 04        	ld l,0x04
 116++9B04 11 28 00     	ld de,0x0028
 117++9B07              	opn_write_fm_regs 0,1
 117++9B07             >;e = base register
 117++9B07             >;d = value
 117++9B07             >;l = count
 117++9B07 CD 7D 9A    >.loop	call opnwriteall
 117++9B0A             >	IF 0
 117++9B0A ~           >	inc e
 117++9B0A             >	ENDIF
 117++9B0A             >	IF 1
 117++9B0A 14          >	inc d
 117++9B0B             >	ENDIF
 117++9B0B 2D          >	dec l
 117++9B0C 20 F9       >	jr nz,.loop
 118++9B0E              ;default tfm state
 119++9B0E 01 FD FF     	ld bc,OPN_REG
 120++9B11 3E FF        	ld a,%11111111
 121++9B13 ED 79        	out (c),a
 122++9B15 C9           	ret
 123++9B16
# file closed: GPlay/common/opn.asm
  78++9B16              	include "vgm/opn.asm"
# file opened: GPlay/vgm/opn.asm
   1++9B16              opniscontrolregister
   2++9B16              ;a = register
   3++9B16              ;out: zf=1 if it's control register, zf=0 otherwise
   4++9B16 FE 0E        	cp 0x0e ;IO port
   5++9B18 C8           	ret z
   6++9B19 FE 0F        	cp 0x0f ;IO port
   7++9B1B C8           	ret z
   8++9B1C FE 2D        	cp 0x2d ;prescaler
   9++9B1E C8           	ret z
  10++9B1F FE 2E        	cp 0x2e ;prescaler
  11++9B21 C8           	ret z
  12++9B22 FE 2F        	cp 0x2f ;prescaler
  13++9B24 C9           	ret
  14++9B25
  15++9B25              opnwritemusiconlyfm1
  16++9B25              ;skips writes to control registers
  17++9B25              ;e = register
  18++9B25              ;d = value
  19++9B25 7B           	ld a,e
  20++9B26 CD 16 9B     	call opniscontrolregister
  21++9B29 C8           	ret z
  22++9B2A FE 27        	cp 0x27 ;timers control
  23++9B2C C2 80 9A     	jp nz,opnwritefm1
  24++9B2F 7A           	ld a,d
  25++9B30 32 5E 9B     	ld (opntimerctrl),a
  26++9B33 F6 0A        	or %00001010 ;avoid altering timer B
  27++9B35 57           	ld d,a
  28++9B36 C3 80 9A     	jp opnwritefm1
  29++9B39
  30++9B39              opnwritemusiconlyfm2
  31++9B39              ;skips writes to control registers
  32++9B39              ;e = register
  33++9B39              ;d = value
  34++9B39 7B           	ld a,e
  35++9B3A CD 16 9B     	call opniscontrolregister
  36++9B3D C8           	ret z
  37++9B3E C3 A0 9A     	jp opnwritefm2
  38++9B41
  39++9B41              opninittimer60hz
  40++9B41              ;	ld de,0xc626
  41++9B41              ;	ld de,0xca26
  42++9B41 11 26 CD     	ld de,0xcd26
  43++9B44 CD 80 9A     	call opnwritefm1
  44++9B47 11 27 2A     	ld de,0x2a27
  45++9B4A C3 80 9A     	jp opnwritefm1
  46++9B4D
  47++9B4D              opnwaittimer60hz
  48++9B4D 01 FD FF     	ld bc,OPN_REG
  49++9B50 3E F8        	ld a,%11111000
  50++9B52 ED 79        	out (c),a
  51++9B54              .waitloop
  52++9B54 ED 78        	in a,(c)
  53++9B56 E6 02        	and 2
  54++9B58 28 FA        	jr z,.waitloop
  55++9B5A 11 27 2A     	ld de,0x2a27
  56++9B5D              opntimerctrl=$+1
  57++9B5D 3E 00        	ld a,0
  58++9B5F B2           	or d
  59++9B60 57           	ld d,a
  60++9B61 C3 80 9A     	jp opnwritefm1
  61++9B64
# file closed: GPlay/vgm/opn.asm
  79++9B64              	include "vgm/opm.asm"
# file opened: GPlay/vgm/opm.asm
   1++9B64              opmwritemusiconlychip0
   2++9B64              ;e = register
   3++9B64              ;d = value
   4++9B64 7B           	ld a,e
   5++9B65 FE 08        	cp 8
   6++9B67 D8           	ret c
   7++9B68 C3 BA 98     	jp opmwritechip0
   8++9B6B
   9++9B6B              opmwritemusiconlychip1
  10++9B6B              ;e = register
  11++9B6B              ;d = value
  12++9B6B 7B           	ld a,e
  13++9B6C FE 08        	cp 8
  14++9B6E D8           	ret c
  15++9B6F C3 D2 98     	jp opmwritechip1
  16++9B72
  17++9B72              vgmopminit
  18++9B72 3E 02        	ld a,2
  19++9B74 32 7B 9B     	ld (opmwaittimer100hz.counter),a
  20++9B77 C3 F0 98     	jp opminit
  21++9B7A
  22++9B7A              opmwaittimer100hz
  23++9B7A              .counter=$+1
  24++9B7A 3E 00        	ld a,0
  25++9B7C 3D           	dec a
  26++9B7D 20 02        	jr nz,$+4
  27++9B7F 3E 02        	ld a,2
  28++9B81 32 7B 9B     	ld (.counter),a
  29++9B84 C8           	ret z
  30++9B85              	;YIELD
  31++9B85              	OS_WAIT
  31++9B85 DF          >	rst #18
  32++9B86 C9           	ret
  33++9B87
# file closed: GPlay/vgm/opm.asm
  80++9B87              	include "vgm/ssg.asm"
# file opened: GPlay/vgm/ssg.asm
   1++9B87              SSG_REG = 0xfffd
   2++9B87              SSG_DAT = 0xbffd
   3++9B87
   4++9B87              	macro ssg_write_reg chip_n
   5++9B87 ~            ;e = register
   6++9B87 ~            ;d = value
   7++9B87 ~            	ld bc,SSG_REG
   8++9B87 ~            	ld a,chip_n+%11111110
   9++9B87 ~            	out (c),a
  10++9B87 ~            	out (c),e
  11++9B87 ~            	ld bc,SSG_DAT
  12++9B87 ~            	out (c),d
  13++9B87              	endm
  14++9B87
  15++9B87              ssgwritemusiconlychip0
  16++9B87 7B           	ld a,e
  17++9B88 FE 0E        	cp 0x0e
  18++9B8A D0           	ret nc
  19++9B8B              ssgwrite0
  20++9B8B              ;e = register
  21++9B8B              ;d = value
  22++9B8B              	ssg_write_reg 0
  22++9B8B             >;e = register
  22++9B8B             >;d = value
  22++9B8B 01 FD FF    >	ld bc,SSG_REG
  22++9B8E 3E FE       >	ld a,0+%11111110
  22++9B90 ED 79       >	out (c),a
  22++9B92 ED 59       >	out (c),e
  22++9B94 01 FD BF    >	ld bc,SSG_DAT
  22++9B97 ED 51       >	out (c),d
  23++9B99 C9           	ret
  24++9B9A
  25++9B9A              ssgwritemusiconlychip1
  26++9B9A 7B           	ld a,e
  27++9B9B FE 0E        	cp 0x0e
  28++9B9D D0           	ret nc
  29++9B9E              ssgwrite1
  30++9B9E              ;e = register
  31++9B9E              ;d = value
  32++9B9E              	ssg_write_reg 1
  32++9B9E             >;e = register
  32++9B9E             >;d = value
  32++9B9E 01 FD FF    >	ld bc,SSG_REG
  32++9BA1 3E FF       >	ld a,1+%11111110
  32++9BA3 ED 79       >	out (c),a
  32++9BA5 ED 59       >	out (c),e
  32++9BA7 01 FD BF    >	ld bc,SSG_DAT
  32++9BAA ED 51       >	out (c),d
  33++9BAC C9           	ret
  34++9BAD
  35++9BAD              ssginit
  36++9BAD C9           	ret
  37++9BAE
  38++9BAE              	macro ssg_write_regs
  39++9BAE ~            ;e = base register
  40++9BAE ~            ;d = value
  41++9BAE ~            ;l = count
  42++9BAE ~            .loop
  43++9BAE ~            	call ssgwrite0
  44++9BAE ~            	call ssgwrite1
  45++9BAE ~            	inc e
  46++9BAE ~            	dec l
  47++9BAE ~            	jr nz,.loop
  48++9BAE              	endm
  49++9BAE
  50++9BAE              ssgmute
  51++9BAE 2E 03        	ld l,3
  52++9BB0 11 08 00     	ld de,8
  53++9BB3              	ssg_write_regs
  53++9BB3             >;e = base register
  53++9BB3             >;d = value
  53++9BB3             >;l = count
  53++9BB3             >.loop
  53++9BB3 CD 8B 9B    >	call ssgwrite0
  53++9BB6 CD 9E 9B    >	call ssgwrite1
  53++9BB9 1C          >	inc e
  53++9BBA 2D          >	dec l
  53++9BBB 20 F6       >	jr nz,.loop
  54++9BBD 2E 0E        	ld l,14
  55++9BBF 11 00 00     	ld de,0
  56++9BC2              	ssg_write_regs
  56++9BC2             >;e = base register
  56++9BC2             >;d = value
  56++9BC2             >;l = count
  56++9BC2             >.loop
  56++9BC2 CD 8B 9B    >	call ssgwrite0
  56++9BC5 CD 9E 9B    >	call ssgwrite1
  56++9BC8 1C          >	inc e
  56++9BC9 2D          >	dec l
  56++9BCA 20 F6       >	jr nz,.loop
  57++9BCC C9           	ret
  58++9BCD
# file closed: GPlay/vgm/ssg.asm
  81++9BCD
  82++9BCD
  83++9BCD
  84++9BCD
  85++9BCD
  86++9BCD
  87++9BCD              waittimer50hz
  88++9BCD              	;YIELD
  89++9BCD              	OS_WAIT
  89++9BCD DF          >	rst #18
  90++9BCE C9           	ret
  91++9BCF
  92++9BCF
  93++9BCF              waveheaderbuffer = 0xc000-2048 ;0x5400 ;текущий размер буфера 1536 (128*12)
  94++9BCF              waveheaderbufferend = waveheaderbuffer+WAVEHEADERBUFFERSIZE
  95++9BCF              vgmheadercopy = waveheaderbufferend
  96++9BCF              vgmheadercopyend = vgmheadercopy+HEADER_SIZE_MAX ;(ещё 256)
  97++9BCF
  98++9BCF              titlestr = waveheaderbufferend
  99++9BCF              titlestrend = titlestr+TITLELENGTH
 100++9BCF
 101++9BCF
 102++9BCF              HEADER_CLOCK_YM2203 = vgmheadercopy+0x44
 103++9BCF              HEADER_CLOCK_YM3812 = vgmheadercopy+0x50
 104++9BCF              HEADER_CLOCK_YMF262 = vgmheadercopy+0x5c
 105++9BCF              HEADER_CLOCK_YMF278B = vgmheadercopy+0x60
 106++9BCF              HEADER_CLOCK_AY8910 = vgmheadercopy+0x74
 107++9BCF
 108++9BCF
 109++9BCF              	macro a_or_dw addr
 110++9BCF ~            	ld hl,(addr+0)
 111++9BCF ~            	or h
 112++9BCF ~            	or l
 113++9BCF ~            	ld de,(addr+2)
 114++9BCF ~            	or d
 115++9BCF ~            	or e
 116++9BCF              	endm
 117++9BCF
 118++9BCF              	macro set_timer wait,ticks
 119++9BCF ~            	ld hl,ticks
 120++9BCF ~            	ld (waittimerstep),hl
 121++9BCF              	endm
 122++9BCF
 123++9BCF
 124++9BCF              init_:
 125++9BCF              	set_timer waittimer50hz,882
 125++9BCF 21 72 03    >	ld hl,882
 125++9BD2 22 86 9C    >	ld (waittimerstep),hl
 126++9BD5 21 00 00     	ld hl,0
 127++9BD8 22 81 9C     	ld (waitcounterlo),hl
 128++9BDB AF           	xor a
 129++9BDC 32 84 9C     	ld (waitcounterhi),a
 130++9BDF 32 66 9C     	ld (devicemask),a
 131++9BE2
 132++9BE2 32 7A 9C           	ld (vgm_play_var),a
 133++9BE5              ;map header to 0x8000
 134++9BE5                      ;first page (vgm_header) now in page_plr3
 135++9BE5                      ;now do init.
 136++9BE5
 137++9BE5              ;copy header
 138++9BE5 01 00 01     	ld bc,HEADER_SIZE_MAX
 139++9BE8 21 00 BE     	ld hl,vgmheadercopy
 140++9BEB 11 01 BE     	ld de,vgmheadercopy+1
 141++9BEE 36 00        	ld (hl),0
 142++9BF0 ED B0        	ldir
 143++9BF2 2A 34 C0     	ld hl,(HEADER_DATA_OFFSET)  ;если HEADER_DATA_OFFSET == 0 to bc = 0x0040 иначе  bc = 0x0034
 144++9BF5 7C           	ld a,h
 145++9BF6 B5           	or l
 146++9BF7 01 40 00     	ld bc,0x40
 147++9BFA 28 02        	jr z,$+4
 148++9BFC 0E 34        	ld c,0x34
 149++9BFE 09           	add hl,bc
 150++9BFF 22 5D 9C     	ld (.dataoffset),hl
 151++9C02                            ;определяем сколько данных заголовка vgm нужно перекинуть в буфер исходя из значения HEADER_DATA_OFFSET
 152++9C02 44 4D        	ld bc,hl
 153++9C04 21 FF FE     	ld hl,-HEADER_SIZE_MAX-1
 154++9C07 09           	add hl,bc
 155++9C08 30 03        	jr nc,$+5
 156++9C0A 01 00 01     	ld bc,HEADER_SIZE_MAX
 157++9C0D
 158++9C0D 21 00 C0     	ld hl,module
 159++9C10 11 00 BE     	ld de,vgmheadercopy
 160++9C13 ED B0        	ldir
 161++9C15              ;setup loop
 162++9C15 AF           	xor a
 163++9C16              	a_or_dw HEADER_LOOP_OFFSET
 163++9C16 2A 1C C0    >	ld hl,(HEADER_LOOP_OFFSET+0)
 163++9C19 B4          >	or h
 163++9C1A B5          >	or l
 163++9C1B ED 5B 1E C0 >	ld de,(HEADER_LOOP_OFFSET+2)
 163++9C1F B2          >	or d
 163++9C20 B3          >	or e
 164++9C21 22 84 9E     	ld (loopoffsetlo),hl
 165++9C24 ED 53 81 9E  	ld (loopoffsethi),de
 166++9C28              ;init Moonsound
 167++9C28 AF           	xor a
 168++9C29              	a_or_dw HEADER_CLOCK_YM3812
 168++9C29 2A 50 BE    >	ld hl,(HEADER_CLOCK_YM3812+0)
 168++9C2C B4          >	or h
 168++9C2D B5          >	or l
 168++9C2E ED 5B 52 BE >	ld de,(HEADER_CLOCK_YM3812+2)
 168++9C32 B2          >	or d
 168++9C33 B3          >	or e
 169++9C34 32 E2 A0     	ld (useYM3812),a
 170++9C37              	a_or_dw HEADER_CLOCK_YMF262
 170++9C37 2A 5C BE    >	ld hl,(HEADER_CLOCK_YMF262+0)
 170++9C3A B4          >	or h
 170++9C3B B5          >	or l
 170++9C3C ED 5B 5E BE >	ld de,(HEADER_CLOCK_YMF262+2)
 170++9C40 B2          >	or d
 170++9C41 B3          >	or e
 171++9C42 20 14        	jr nz,.opl4notneeded
 172++9C44              	a_or_dw HEADER_CLOCK_YMF278B
 172++9C44 2A 60 BE    >	ld hl,(HEADER_CLOCK_YMF278B+0)
 172++9C47 B4          >	or h
 172++9C48 B5          >	or l
 172++9C49 ED 5B 62 BE >	ld de,(HEADER_CLOCK_YMF278B+2)
 172++9C4D B2          >	or d
 172++9C4E B3          >	or e
 173++9C4F 28 07        	jr z,.opl4notneeded
 174++9C51 3A D4 A0     	ld a,(moonsoundstatus)
 175++9C54 FE 02        	cp 2
 176++9C56 C0           	ret nz ;jp nz,memorystreamfree ;sets zf=0
 177++9C57 B7           	or a
 178++9C58              .opl4notneeded
 179++9C58 C4 D3 A0     	call nz,initYMF278B
 180++9C5B C0           	ret nz  ;jp nz,memorystreamfree ;sets zf=0
 181++9C5C              .dataoffset=$+1
 182++9C5C 21 00 00     	ld hl,0
 183++9C5F 11 00 00     	ld de,0
 184++9C62                      ;init music
 185++9C62 CD C8 96     	call memorystreamseek
 186++9C65              devicemask=$+1
 187++9C65 3E 00        	ld a,0
 188++9C67              ;zf=0 if there isn't any supported device
 189++9C67 3D           	dec a
 190++9C68 F8           	ret m
 191++9C69 3C           	inc a
 192++9C6A BF           	cp a
 193++9C6B C9           	ret
 194++9C6C
 195++9C6C
 196++9C6C
 197++9C6C
 198++9C6C
 199++9C6C
 200++9C6C
 201++9C6C
 202++9C6C              MUTE:
 203++9C6C 3E C9                        ld a,$C9			;ret	;stop playing
 204++9C6E 32 7A 9C                     ld (vgm_play_var),a
 205++9C71 3A 66 9C     		ld a,(devicemask)
 206++9C74 E6 08        		and DEVICE_MOONSOUND_MASK
 207++9C76 C4 D6 97     		call nz,opl4mute
 208++9C79 C9                           ret
 209++9C7A
 210++9C7A
 211++9C7A
 212++9C7A
 213++9C7A
 214++9C7A
 215++9C7A
 216++9C7A              PLAY:
 217++9C7A              ;out: zf=0 if still playing, zf=1 otherwise
 218++9C7A              ;waittimercallback=$+1
 219++9C7A              ;	call 0
 220++9C7A
 221++9C7A              vgm_play_var = $
 221++9C7A 00             nop		;nop - play
 222++9C7B 3E 00                ld a,0                          ;(memorystreamcurrentpage)
 223++9C7D              memorystreamcurrentpage equ $-1
 224++9C7D                      IF AREA_C000_FFFF=1
 225++9C7D                          ;SETPGC000
 226++9C7D              			OS_SET_PAGE_SLOT3
 226++9C7D 0E 1C       >    ld c,#1c
 226++9C7F E7          >    rst #20
 227++9C80                      ELSE
 228++9C80 ~                        SETPG8000
 229++9C80                      ENDIF
 230++9C80              playloop
 231++9C80              waitcounterlo=$+1
 232++9C80 21 00 00     	ld hl,0
 233++9C83              waitcounterhi=$+1
 234++9C83 3E 00        	ld a,0
 235++9C85              waittimerstep=$+1
 236++9C85 01 00 00     	ld bc,0
 237++9C88 B7 ED 42     	sub hl,bc
 238++9C8B 16 00        	ld d,0
 239++9C8D 9A           	sbc a,d
 240++9C8E 30 1A        	jr nc,exitplayloop
 241++9C90              ;read command
 242++9C90              	memory_stream_read_1 e
 242++9C90 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 242++9C93             >	memory_stream_read_byte e
 242++9C93 CB 74       >	bit 6,h
 242++9C95             >        IF AREA_C000_FFFF=1
 242++9C95 CC 0D 96    >	call z,memorystreamnextpage
 242++9C98             >        ELSE
 242++9C98 ~           > 	call nz,memorystreamnextpage
 242++9C98             >        ENDIF
 242++9C98 5E          >	ld e,(hl)
 242++9C99 23          >	inc hl
 242++9C9A 22 72 96    >	ld (memorystreamcurrentaddr),hl
 243++9C9D 21 8E 9E     	ld hl,cmdtable
 244++9CA0 19           	add hl,de
 245++9CA1 5E           	ld e,(hl)
 246++9CA2 24           	inc h
 247++9CA3 56           	ld d,(hl)
 248++9CA4 21 80 9C     	ld hl,playloop
 249++9CA7 E5           	push hl
 250++9CA8 EB           	ex hl,de
 251++9CA9 E9           	jp (hl)
 252++9CAA
 253++9CAA              exitplayloop
 254++9CAA 22 81 9C     	ld (waitcounterlo),hl
 255++9CAD 32 84 9C     	ld (waitcounterhi),a
 256++9CB0              ;continue playing
 257++9CB0 F6 01        	or 1
 258++9CB2 C9           	ret
 259++9CB3
 260++9CB3 21 81 9C     wait1	ld hl,waitcounterlo
 261++9CB6 34           	inc (hl)
 262++9CB7 C0           	ret nz
 263++9CB8 23           	inc hl
 264++9CB9 34           	inc (hl)
 265++9CBA C0           	ret nz
 266++9CBB 21 84 9C     	ld hl,waitcounterhi
 267++9CBE 34           	inc (hl)
 268++9CBF C9           	ret
 269++9CC0
 270++9CC0 3E 02        wait2	ld a,2
 271++9CC2 21 81 9C     waitn	ld hl,waitcounterlo
 272++9CC5 86           	add a,(hl)
 273++9CC6 77           	ld (hl),a
 274++9CC7 D0           	ret nc
 275++9CC8 23           	inc hl
 276++9CC9 34           	inc (hl)
 277++9CCA C0           	ret nz
 278++9CCB 21 84 9C     	ld hl,waitcounterhi
 279++9CCE 34           	inc (hl)
 280++9CCF C9           	ret
 281++9CD0
 282++9CD0 3E 03        wait3	ld a,3
 282++9CD2 C3 C2 9C       jp waitn
 283++9CD5 3E 04        wait4	ld a,4
 283++9CD7 C3 C2 9C       jp waitn
 284++9CDA 3E 05        wait5	ld a,5
 284++9CDC C3 C2 9C       jp waitn
 285++9CDF 3E 06        wait6	ld a,6
 285++9CE1 C3 C2 9C       jp waitn
 286++9CE4 3E 07        wait7	ld a,7
 286++9CE6 C3 C2 9C       jp waitn
 287++9CE9 3E 08        wait8	ld a,8
 287++9CEB C3 C2 9C       jp waitn
 288++9CEE 3E 09        wait9	ld a,9
 288++9CF0 C3 C2 9C       jp waitn
 289++9CF3 3E 0A        wait10	ld a,10
 289++9CF5 C3 C2 9C       jp waitn
 290++9CF8 3E 0B        wait11	ld a,11
 290++9CFA C3 C2 9C       jp waitn
 291++9CFD 3E 0C        wait12	ld a,12
 291++9CFF C3 C2 9C       jp waitn
 292++9D02 3E 0D        wait13	ld a,13
 292++9D04 C3 C2 9C       jp waitn
 293++9D07 3E 0E        wait14	ld a,14
 293++9D09 C3 C2 9C       jp waitn
 294++9D0C 3E 0F        wait15	ld a,15
 294++9D0E C3 C2 9C       jp waitn
 295++9D11 3E 10        wait16	ld a,16
 295++9D13 C3 C2 9C       jp waitn
 296++9D16
 297++9D16 11 DF 02     wait735	ld de,735
 298++9D19 2A 81 9C     waitnn	ld hl,(waitcounterlo)
 299++9D1C 19           	add hl,de
 300++9D1D 22 81 9C     	ld (waitcounterlo),hl
 301++9D20 D0           	ret nc
 302++9D21 21 84 9C     	ld hl,waitcounterhi
 303++9D24 34           	inc (hl)
 304++9D25 C9           	ret
 305++9D26
 306++9D26 11 72 03     wait882	ld de,882
 307++9D29 C3 19 9D     	jp waitnn
 308++9D2C
 309++9D2C              waitvar	memory_stream_read_2 e,d
 309++9D2C 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 309++9D2F             >	memory_stream_read_byte e
 309++9D2F CB 74       >	bit 6,h
 309++9D31             >        IF AREA_C000_FFFF=1
 309++9D31 CC 0D 96    >	call z,memorystreamnextpage
 309++9D34             >        ELSE
 309++9D34 ~           > 	call nz,memorystreamnextpage
 309++9D34             >        ENDIF
 309++9D34 5E          >	ld e,(hl)
 309++9D35 23          >	inc hl
 309++9D36             >	memory_stream_read_byte d
 309++9D36 CB 74       >	bit 6,h
 309++9D38             >        IF AREA_C000_FFFF=1
 309++9D38 CC 0D 96    >	call z,memorystreamnextpage
 309++9D3B             >        ELSE
 309++9D3B ~           > 	call nz,memorystreamnextpage
 309++9D3B             >        ENDIF
 309++9D3B 56          >	ld d,(hl)
 309++9D3C 23          >	inc hl
 309++9D3D 22 72 96    >	ld (memorystreamcurrentaddr),hl
 310++9D40 2A 81 9C     	ld hl,(waitcounterlo)
 311++9D43 19           	add hl,de
 312++9D44 22 81 9C     	ld (waitcounterlo),hl
 313++9D47 D0           	ret nc
 314++9D48 21 84 9C     	ld hl,waitcounterhi
 315++9D4B 34           	inc (hl)
 316++9D4C C9           	ret
 317++9D4D
 318++9D4D              	macro skip_n n
 319++9D4D ~            	ld b,n
 320++9D4D ~            	jp memorystreamskip
 321++9D4D              	endm
 322++9D4D
 323++9D4D C9           skip1	ret
 324++9D4E              skip2	skip_n 1
 324++9D4E 06 01       >	ld b,1
 324++9D50 C3 23 96    >	jp memorystreamskip
 325++9D53              skip3	skip_n 2
 325++9D53 06 02       >	ld b,2
 325++9D55 C3 23 96    >	jp memorystreamskip
 326++9D58              skip4	skip_n 3
 326++9D58 06 03       >	ld b,3
 326++9D5A C3 23 96    >	jp memorystreamskip
 327++9D5D              skip5	skip_n 4
 327++9D5D 06 04       >	ld b,4
 327++9D5F C3 23 96    >	jp memorystreamskip
 328++9D62              skip6	skip_n 5
 328++9D62 06 05       >	ld b,5
 328++9D64 C3 23 96    >	jp memorystreamskip
 329++9D67              skip11	skip_n 10
 329++9D67 06 0A       >	ld b,10
 329++9D69 C3 23 96    >	jp memorystreamskip
 330++9D6C              skip12	skip_n 11
 330++9D6C 06 0B       >	ld b,11
 330++9D6E C3 23 96    >	jp memorystreamskip
 331++9D71
 332++9D71
 333++9D71              endofsounddata
 334++9D71                    ;  jp seektoloop ;здесь зацикливание, повтор
 335++9D71 CD D0 94     	  call PLR_MUTE ;выключить звук
 336++9D74              cmdunsupported
 337++9D74              ;stop playing
 338++9D74 F1           	pop af
 339++9D75 AF           	xor a
 340++9D76 C9           	ret
 341++9D77
 342++9D77              cmdYM2203
 343++9D77              	memory_stream_read_2 e,d
 343++9D77 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 343++9D7A             >	memory_stream_read_byte e
 343++9D7A CB 74       >	bit 6,h
 343++9D7C             >        IF AREA_C000_FFFF=1
 343++9D7C CC 0D 96    >	call z,memorystreamnextpage
 343++9D7F             >        ELSE
 343++9D7F ~           > 	call nz,memorystreamnextpage
 343++9D7F             >        ENDIF
 343++9D7F 5E          >	ld e,(hl)
 343++9D80 23          >	inc hl
 343++9D81             >	memory_stream_read_byte d
 343++9D81 CB 74       >	bit 6,h
 343++9D83             >        IF AREA_C000_FFFF=1
 343++9D83 CC 0D 96    >	call z,memorystreamnextpage
 343++9D86             >        ELSE
 343++9D86 ~           > 	call nz,memorystreamnextpage
 343++9D86             >        ENDIF
 343++9D86 56          >	ld d,(hl)
 343++9D87 23          >	inc hl
 343++9D88 22 72 96    >	ld (memorystreamcurrentaddr),hl
 344++9D8B C3 25 9B     	jp opnwritemusiconlyfm1
 345++9D8E
 346++9D8E              cmdYM2203dp
 347++9D8E              	memory_stream_read_2 e,d
 347++9D8E 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 347++9D91             >	memory_stream_read_byte e
 347++9D91 CB 74       >	bit 6,h
 347++9D93             >        IF AREA_C000_FFFF=1
 347++9D93 CC 0D 96    >	call z,memorystreamnextpage
 347++9D96             >        ELSE
 347++9D96 ~           > 	call nz,memorystreamnextpage
 347++9D96             >        ENDIF
 347++9D96 5E          >	ld e,(hl)
 347++9D97 23          >	inc hl
 347++9D98             >	memory_stream_read_byte d
 347++9D98 CB 74       >	bit 6,h
 347++9D9A             >        IF AREA_C000_FFFF=1
 347++9D9A CC 0D 96    >	call z,memorystreamnextpage
 347++9D9D             >        ELSE
 347++9D9D ~           > 	call nz,memorystreamnextpage
 347++9D9D             >        ENDIF
 347++9D9D 56          >	ld d,(hl)
 347++9D9E 23          >	inc hl
 347++9D9F 22 72 96    >	ld (memorystreamcurrentaddr),hl
 348++9DA2 C3 39 9B     	jp opnwritemusiconlyfm2
 349++9DA5
 350++9DA5              cmdYMF278B
 351++9DA5              	memory_stream_read_3 c,e,d
 351++9DA5 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 351++9DA8             >	memory_stream_read_byte c
 351++9DA8 CB 74       >	bit 6,h
 351++9DAA             >        IF AREA_C000_FFFF=1
 351++9DAA CC 0D 96    >	call z,memorystreamnextpage
 351++9DAD             >        ELSE
 351++9DAD ~           > 	call nz,memorystreamnextpage
 351++9DAD             >        ENDIF
 351++9DAD 4E          >	ld c,(hl)
 351++9DAE 23          >	inc hl
 351++9DAF             >	memory_stream_read_byte e
 351++9DAF CB 74       >	bit 6,h
 351++9DB1             >        IF AREA_C000_FFFF=1
 351++9DB1 CC 0D 96    >	call z,memorystreamnextpage
 351++9DB4             >        ELSE
 351++9DB4 ~           > 	call nz,memorystreamnextpage
 351++9DB4             >        ENDIF
 351++9DB4 5E          >	ld e,(hl)
 351++9DB5 23          >	inc hl
 351++9DB6             >	memory_stream_read_byte d
 351++9DB6 CB 74       >	bit 6,h
 351++9DB8             >        IF AREA_C000_FFFF=1
 351++9DB8 CC 0D 96    >	call z,memorystreamnextpage
 351++9DBB             >        ELSE
 351++9DBB ~           > 	call nz,memorystreamnextpage
 351++9DBB             >        ENDIF
 351++9DBB 56          >	ld d,(hl)
 351++9DBC 23          >	inc hl
 351++9DBD 22 72 96    >	ld (memorystreamcurrentaddr),hl
 352++9DC0 0D           	dec c
 353++9DC1 CA 3D 99     	jp z,opl4writemusiconlyfm2
 354++9DC4 F2 47 99     	jp p,opl4writewavemusiconly
 355++9DC7 C3 31 99     	jp opl4writemusiconlyfm1
 356++9DCA
 357++9DCA              cmdYMF262p0
 358++9DCA              cmdYM3812
 359++9DCA              cmdY8950
 360++9DCA              cmdYM3526
 361++9DCA              	memory_stream_read_2 e,d
 361++9DCA 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 361++9DCD             >	memory_stream_read_byte e
 361++9DCD CB 74       >	bit 6,h
 361++9DCF             >        IF AREA_C000_FFFF=1
 361++9DCF CC 0D 96    >	call z,memorystreamnextpage
 361++9DD2             >        ELSE
 361++9DD2 ~           > 	call nz,memorystreamnextpage
 361++9DD2             >        ENDIF
 361++9DD2 5E          >	ld e,(hl)
 361++9DD3 23          >	inc hl
 361++9DD4             >	memory_stream_read_byte d
 361++9DD4 CB 74       >	bit 6,h
 361++9DD6             >        IF AREA_C000_FFFF=1
 361++9DD6 CC 0D 96    >	call z,memorystreamnextpage
 361++9DD9             >        ELSE
 361++9DD9 ~           > 	call nz,memorystreamnextpage
 361++9DD9             >        ENDIF
 361++9DD9 56          >	ld d,(hl)
 361++9DDA 23          >	inc hl
 361++9DDB 22 72 96    >	ld (memorystreamcurrentaddr),hl
 362++9DDE C3 31 99     	jp opl4writemusiconlyfm1
 363++9DE1
 364++9DE1              cmdYMF262p1
 365++9DE1              cmdYM3812dp
 366++9DE1              cmdY8950dp
 367++9DE1              cmdYM3526dp
 368++9DE1              	memory_stream_read_2 e,d
 368++9DE1 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 368++9DE4             >	memory_stream_read_byte e
 368++9DE4 CB 74       >	bit 6,h
 368++9DE6             >        IF AREA_C000_FFFF=1
 368++9DE6 CC 0D 96    >	call z,memorystreamnextpage
 368++9DE9             >        ELSE
 368++9DE9 ~           > 	call nz,memorystreamnextpage
 368++9DE9             >        ENDIF
 368++9DE9 5E          >	ld e,(hl)
 368++9DEA 23          >	inc hl
 368++9DEB             >	memory_stream_read_byte d
 368++9DEB CB 74       >	bit 6,h
 368++9DED             >        IF AREA_C000_FFFF=1
 368++9DED CC 0D 96    >	call z,memorystreamnextpage
 368++9DF0             >        ELSE
 368++9DF0 ~           > 	call nz,memorystreamnextpage
 368++9DF0             >        ENDIF
 368++9DF0 56          >	ld d,(hl)
 368++9DF1 23          >	inc hl
 368++9DF2 22 72 96    >	ld (memorystreamcurrentaddr),hl
 369++9DF5 C3 3D 99     	jp opl4writemusiconlyfm2
 370++9DF8
 371++9DF8              cmdYM2151
 372++9DF8              	memory_stream_read_2 e,d
 372++9DF8 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 372++9DFB             >	memory_stream_read_byte e
 372++9DFB CB 74       >	bit 6,h
 372++9DFD             >        IF AREA_C000_FFFF=1
 372++9DFD CC 0D 96    >	call z,memorystreamnextpage
 372++9E00             >        ELSE
 372++9E00 ~           > 	call nz,memorystreamnextpage
 372++9E00             >        ENDIF
 372++9E00 5E          >	ld e,(hl)
 372++9E01 23          >	inc hl
 372++9E02             >	memory_stream_read_byte d
 372++9E02 CB 74       >	bit 6,h
 372++9E04             >        IF AREA_C000_FFFF=1
 372++9E04 CC 0D 96    >	call z,memorystreamnextpage
 372++9E07             >        ELSE
 372++9E07 ~           > 	call nz,memorystreamnextpage
 372++9E07             >        ENDIF
 372++9E07 56          >	ld d,(hl)
 372++9E08 23          >	inc hl
 372++9E09 22 72 96    >	ld (memorystreamcurrentaddr),hl
 373++9E0C C3 64 9B     	jp opmwritemusiconlychip0
 374++9E0F
 375++9E0F              cmdYM2151dp
 376++9E0F              	memory_stream_read_2 e,d
 376++9E0F 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 376++9E12             >	memory_stream_read_byte e
 376++9E12 CB 74       >	bit 6,h
 376++9E14             >        IF AREA_C000_FFFF=1
 376++9E14 CC 0D 96    >	call z,memorystreamnextpage
 376++9E17             >        ELSE
 376++9E17 ~           > 	call nz,memorystreamnextpage
 376++9E17             >        ENDIF
 376++9E17 5E          >	ld e,(hl)
 376++9E18 23          >	inc hl
 376++9E19             >	memory_stream_read_byte d
 376++9E19 CB 74       >	bit 6,h
 376++9E1B             >        IF AREA_C000_FFFF=1
 376++9E1B CC 0D 96    >	call z,memorystreamnextpage
 376++9E1E             >        ELSE
 376++9E1E ~           > 	call nz,memorystreamnextpage
 376++9E1E             >        ENDIF
 376++9E1E 56          >	ld d,(hl)
 376++9E1F 23          >	inc hl
 376++9E20 22 72 96    >	ld (memorystreamcurrentaddr),hl
 377++9E23 C3 6B 9B     	jp opmwritemusiconlychip1
 378++9E26
 379++9E26              cmdAY8910
 380++9E26              	memory_stream_read_2 e,d
 380++9E26 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 380++9E29             >	memory_stream_read_byte e
 380++9E29 CB 74       >	bit 6,h
 380++9E2B             >        IF AREA_C000_FFFF=1
 380++9E2B CC 0D 96    >	call z,memorystreamnextpage
 380++9E2E             >        ELSE
 380++9E2E ~           > 	call nz,memorystreamnextpage
 380++9E2E             >        ENDIF
 380++9E2E 5E          >	ld e,(hl)
 380++9E2F 23          >	inc hl
 380++9E30             >	memory_stream_read_byte d
 380++9E30 CB 74       >	bit 6,h
 380++9E32             >        IF AREA_C000_FFFF=1
 380++9E32 CC 0D 96    >	call z,memorystreamnextpage
 380++9E35             >        ELSE
 380++9E35 ~           > 	call nz,memorystreamnextpage
 380++9E35             >        ENDIF
 380++9E35 56          >	ld d,(hl)
 380++9E36 23          >	inc hl
 380++9E37 22 72 96    >	ld (memorystreamcurrentaddr),hl
 381++9E3A CB 7B        	bit 7,e
 382++9E3C CA 87 9B     	jp z,ssgwritemusiconlychip0
 383++9E3F CB BB        	res 7,e
 384++9E41 C3 9A 9B     	jp ssgwritemusiconlychip1
 385++9E44
 386++9E44              cmdYMF262dp0 equ memorystreamread2
 387++9E44              cmdYMF262dp1 equ memorystreamread2
 388++9E44
 389++9E44              cmddatablock
 390++9E44              	memory_stream_read_2 a,e ;a = 0x66 guard, e = type
 390++9E44 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 390++9E47             >	memory_stream_read_byte a
 390++9E47 CB 74       >	bit 6,h
 390++9E49             >        IF AREA_C000_FFFF=1
 390++9E49 CC 0D 96    >	call z,memorystreamnextpage
 390++9E4C             >        ELSE
 390++9E4C ~           > 	call nz,memorystreamnextpage
 390++9E4C             >        ENDIF
 390++9E4C 7E          >	ld a,(hl)
 390++9E4D 23          >	inc hl
 390++9E4E             >	memory_stream_read_byte e
 390++9E4E CB 74       >	bit 6,h
 390++9E50             >        IF AREA_C000_FFFF=1
 390++9E50 CC 0D 96    >	call z,memorystreamnextpage
 390++9E53             >        ELSE
 390++9E53 ~           > 	call nz,memorystreamnextpage
 390++9E53             >        ENDIF
 390++9E53 5E          >	ld e,(hl)
 390++9E54 23          >	inc hl
 390++9E55 22 72 96    >	ld (memorystreamcurrentaddr),hl
 391++9E58 FE 66        	cp 0x66
 392++9E5A C2 74 9D     	jp nz,cmdunsupported
 393++9E5D              processdatablock
 394++9E5D              ;e = data type
 395++9E5D CD 71 96     	call memorystreamread4 ;adbc = data size
 396++9E60 7B           	ld a,e
 397++9E61 60 69        	ld hl,bc
 398++9E63              ;	cp 0x81
 399++9E63              ;	jp z,opnaloaddatablock
 400++9E63 FE 84        	cp 0x84
 401++9E65 CA 27 9A     	jp z,opl4loadromdatablock
 402++9E68 FE 87        	cp 0x87
 403++9E6A CA 20 9A     	jp z,opl4loadramdatablock
 404++9E6D D5           	push de
 405++9E6E C5           	push bc
 406++9E6F CD ED 96     	call memorystreamgetpos
 407++9E72 C1           	pop bc
 408++9E73 F1           	pop af
 409++9E74 09           	add hl,bc
 410++9E75 8B           	adc a,e
 411++9E76 5F           	ld e,a
 412++9E77 8A           	adc a,d
 413++9E78 93           	sub e
 414++9E79 57           	ld d,a
 415++9E7A C3 C8 96     	jp memorystreamseek
 416++9E7D
 417++9E7D
 418++9E7D              seektoloop
 419++9E7D 01 1C 00     	ld bc,0x1c
 420++9E80              loopoffsethi=$+1
 421++9E80 11 00 00     	ld de,0
 422++9E83              loopoffsetlo=$+1
 423++9E83 21 00 00     	ld hl,0
 424++9E86              seektopos
 425++9E86              ;dehl + bc = position
 426++9E86              ;out: hl = read address
 427++9E86 09           	add hl,bc
 428++9E87 D2 C8 96     	jp nc,memorystreamseek
 429++9E8A 13           	inc de
 430++9E8B C3 C8 96     	jp memorystreamseek
 431++9E8E
 432++9E8E
 433++9E8E
 434++9E8E
 435++9E8E              cmdtable
 436++9E8E 4D           	db skip1           %256 ; 00
 437++9E8F 4D           	db skip1           %256 ; 01
 438++9E90 4D           	db skip1           %256 ; 02
 439++9E91 4D           	db skip1           %256 ; 03
 440++9E92 4D           	db skip1           %256 ; 04
 441++9E93 4D           	db skip1           %256 ; 05
 442++9E94 4D           	db skip1           %256 ; 06
 443++9E95 4D           	db skip1           %256 ; 07
 444++9E96 4D           	db skip1           %256 ; 08
 445++9E97 4D           	db skip1           %256 ; 09
 446++9E98 4D           	db skip1           %256 ; 0A
 447++9E99 4D           	db skip1           %256 ; 0B
 448++9E9A 4D           	db skip1           %256 ; 0C
 449++9E9B 4D           	db skip1           %256 ; 0D
 450++9E9C 4D           	db skip1           %256 ; 0E
 451++9E9D 4D           	db skip1           %256 ; 0F
 452++9E9E 4D           	db skip1           %256 ; 10
 453++9E9F 4D           	db skip1           %256 ; 11
 454++9EA0 4D           	db skip1           %256 ; 12
 455++9EA1 4D           	db skip1           %256 ; 13
 456++9EA2 4D           	db skip1           %256 ; 14
 457++9EA3 4D           	db skip1           %256 ; 15
 458++9EA4 4D           	db skip1           %256 ; 16
 459++9EA5 4D           	db skip1           %256 ; 17
 460++9EA6 4D           	db skip1           %256 ; 18
 461++9EA7 4D           	db skip1           %256 ; 19
 462++9EA8 4D           	db skip1           %256 ; 1A
 463++9EA9 4D           	db skip1           %256 ; 1B
 464++9EAA 4D           	db skip1           %256 ; 1C
 465++9EAB 4D           	db skip1           %256 ; 1D
 466++9EAC 4D           	db skip1           %256 ; 1E
 467++9EAD 4D           	db skip1           %256 ; 1F
 468++9EAE 4D           	db skip1           %256 ; 20
 469++9EAF 4D           	db skip1           %256 ; 21
 470++9EB0 4D           	db skip1           %256 ; 22
 471++9EB1 4D           	db skip1           %256 ; 23
 472++9EB2 4D           	db skip1           %256 ; 24
 473++9EB3 4D           	db skip1           %256 ; 25
 474++9EB4 4D           	db skip1           %256 ; 26
 475++9EB5 4D           	db skip1           %256 ; 27
 476++9EB6 4D           	db skip1           %256 ; 28
 477++9EB7 4D           	db skip1           %256 ; 29
 478++9EB8 4D           	db skip1           %256 ; 2A
 479++9EB9 4D           	db skip1           %256 ; 2B
 480++9EBA 4D           	db skip1           %256 ; 2C
 481++9EBB 4D           	db skip1           %256 ; 2D
 482++9EBC 4D           	db skip1           %256 ; 2E
 483++9EBD 4D           	db skip1           %256 ; 2F
 484++9EBE 74           	db cmdunsupported  %256 ; 30
 485++9EBF 4E           	db skip2           %256 ; 31
 486++9EC0 4E           	db skip2           %256 ; 32
 487++9EC1 4E           	db skip2           %256 ; 33
 488++9EC2 4E           	db skip2           %256 ; 34
 489++9EC3 4E           	db skip2           %256 ; 35
 490++9EC4 4E           	db skip2           %256 ; 36
 491++9EC5 4E           	db skip2           %256 ; 37
 492++9EC6 4E           	db skip2           %256 ; 38
 493++9EC7 4E           	db skip2           %256 ; 39
 494++9EC8 4E           	db skip2           %256 ; 3A
 495++9EC9 4E           	db skip2           %256 ; 3B
 496++9ECA 4E           	db skip2           %256 ; 3C
 497++9ECB 4E           	db skip2           %256 ; 3D
 498++9ECC 4E           	db skip2           %256 ; 3E
 499++9ECD 4E           	db skip2           %256 ; 3F
 500++9ECE 53           	db skip3           %256 ; 40
 501++9ECF 53           	db skip3           %256 ; 41
 502++9ED0 53           	db skip3           %256 ; 42
 503++9ED1 53           	db skip3           %256 ; 43
 504++9ED2 53           	db skip3           %256 ; 44
 505++9ED3 53           	db skip3           %256 ; 45
 506++9ED4 53           	db skip3           %256 ; 46
 507++9ED5 53           	db skip3           %256 ; 47
 508++9ED6 53           	db skip3           %256 ; 48
 509++9ED7 53           	db skip3           %256 ; 49
 510++9ED8 53           	db skip3           %256 ; 4A
 511++9ED9 53           	db skip3           %256 ; 4B
 512++9EDA 53           	db skip3           %256 ; 4C
 513++9EDB 53           	db skip3           %256 ; 4D
 514++9EDC 53           	db skip3           %256 ; 4E
 515++9EDD 4E           	db skip2           %256 ; 4F
 516++9EDE 74           	db cmdunsupported  %256 ; 50
 517++9EDF 74           	db cmdunsupported  %256 ; 51
 518++9EE0 74           	db cmdunsupported  %256 ; 52
 519++9EE1 74           	db cmdunsupported  %256 ; 53
 520++9EE2 F8           	db cmdYM2151       %256 ; 54
 521++9EE3 77           	db cmdYM2203       %256 ; 55
 522++9EE4 77           	db cmdYM2608p0     %256 ; 56
 523++9EE5 8E           	db cmdYM2608p1     %256 ; 57
 524++9EE6 74           	db cmdunsupported  %256 ; 58
 525++9EE7 74           	db cmdunsupported  %256 ; 59
 526++9EE8 CA           	db cmdYM3812       %256 ; 5A
 527++9EE9 CA           	db cmdYM3526       %256 ; 5B
 528++9EEA CA           	db cmdY8950        %256 ; 5C
 529++9EEB 53           	db skip3           %256 ; 5D
 530++9EEC CA           	db cmdYMF262p0     %256 ; 5E
 531++9EED E1           	db cmdYMF262p1     %256 ; 5F
 532++9EEE 74           	db cmdunsupported  %256 ; 60
 533++9EEF 2C           	db waitvar         %256 ; 61
 534++9EF0 16           	db wait735         %256 ; 62
 535++9EF1 26           	db wait882         %256 ; 63
 536++9EF2 74           	db cmdunsupported  %256 ; 64
 537++9EF3 74           	db cmdunsupported  %256 ; 65
 538++9EF4 71           	db endofsounddata  %256 ; 66
 539++9EF5 44           	db cmddatablock    %256 ; 67
 540++9EF6 6C           	db skip12          %256 ; 68
 541++9EF7 74           	db cmdunsupported  %256 ; 69
 542++9EF8 74           	db cmdunsupported  %256 ; 6A
 543++9EF9 74           	db cmdunsupported  %256 ; 6B
 544++9EFA 74           	db cmdunsupported  %256 ; 6C
 545++9EFB 74           	db cmdunsupported  %256 ; 6D
 546++9EFC 74           	db cmdunsupported  %256 ; 6E
 547++9EFD 74           	db cmdunsupported  %256 ; 6F
 548++9EFE B3           	db wait1           %256 ; 70
 549++9EFF C0           	db wait2           %256 ; 71
 550++9F00 D0           	db wait3           %256 ; 72
 551++9F01 D5           	db wait4           %256 ; 73
 552++9F02 DA           	db wait5           %256 ; 74
 553++9F03 DF           	db wait6           %256 ; 75
 554++9F04 E4           	db wait7           %256 ; 76
 555++9F05 E9           	db wait8           %256 ; 77
 556++9F06 EE           	db wait9           %256 ; 78
 557++9F07 F3           	db wait10          %256 ; 79
 558++9F08 F8           	db wait11          %256 ; 7A
 559++9F09 FD           	db wait12          %256 ; 7B
 560++9F0A 02           	db wait13          %256 ; 7C
 561++9F0B 07           	db wait14          %256 ; 7D
 562++9F0C 0C           	db wait15          %256 ; 7E
 563++9F0D 11           	db wait16          %256 ; 7F
 564++9F0E 4D           	db skip1           %256 ; 80
 565++9F0F B3           	db wait1           %256 ; 81
 566++9F10 C0           	db wait2           %256 ; 82
 567++9F11 D0           	db wait3           %256 ; 83
 568++9F12 D5           	db wait4           %256 ; 84
 569++9F13 DA           	db wait5           %256 ; 85
 570++9F14 DF           	db wait6           %256 ; 86
 571++9F15 E4           	db wait7           %256 ; 87
 572++9F16 E9           	db wait8           %256 ; 88
 573++9F17 EE           	db wait9           %256 ; 89
 574++9F18 F3           	db wait10          %256 ; 8A
 575++9F19 F8           	db wait11          %256 ; 8B
 576++9F1A FD           	db wait12          %256 ; 8C
 577++9F1B 02           	db wait13          %256 ; 8D
 578++9F1C 07           	db wait14          %256 ; 8E
 579++9F1D 0C           	db wait15          %256 ; 8F
 580++9F1E 5D           	db skip5           %256 ; 90
 581++9F1F 5D           	db skip5           %256 ; 91
 582++9F20 62           	db skip6           %256 ; 92
 583++9F21 67           	db skip11          %256 ; 93
 584++9F22 4E           	db skip2           %256 ; 94
 585++9F23 5D           	db skip5           %256 ; 95
 586++9F24 74           	db cmdunsupported  %256 ; 96
 587++9F25 74           	db cmdunsupported  %256 ; 97
 588++9F26 74           	db cmdunsupported  %256 ; 98
 589++9F27 74           	db cmdunsupported  %256 ; 99
 590++9F28 74           	db cmdunsupported  %256 ; 9A
 591++9F29 74           	db cmdunsupported  %256 ; 9B
 592++9F2A 74           	db cmdunsupported  %256 ; 9C
 593++9F2B 74           	db cmdunsupported  %256 ; 9D
 594++9F2C 74           	db cmdunsupported  %256 ; 9E
 595++9F2D 74           	db cmdunsupported  %256 ; 9F
 596++9F2E 26           	db cmdAY8910       %256 ; A0
 597++9F2F 53           	db skip3           %256 ; A1
 598++9F30 74           	db cmdunsupported  %256 ; A2
 599++9F31 74           	db cmdunsupported  %256 ; A3
 600++9F32 0F           	db cmdYM2151dp     %256 ; A4
 601++9F33 8E           	db cmdYM2203dp     %256 ; A5
 602++9F34 53           	db skip3           %256 ; A6
 603++9F35 53           	db skip3           %256 ; A7
 604++9F36 53           	db skip3           %256 ; A8
 605++9F37 53           	db skip3           %256 ; A9
 606++9F38 E1           	db cmdYM3812dp     %256 ; AA
 607++9F39 E1           	db cmdYM3526dp     %256 ; AB
 608++9F3A E1           	db cmdY8950dp      %256 ; AC
 609++9F3B 53           	db skip3           %256 ; AD
 610++9F3C 40           	db cmdYMF262dp0    %256 ; AE
 611++9F3D 40           	db cmdYMF262dp0    %256 ; AF
 612++9F3E 53           	db skip3           %256 ; B0
 613++9F3F 53           	db skip3           %256 ; B1
 614++9F40 53           	db skip3           %256 ; B2
 615++9F41 53           	db skip3           %256 ; B3
 616++9F42 53           	db skip3           %256 ; B4
 617++9F43 53           	db skip3           %256 ; B5
 618++9F44 53           	db skip3           %256 ; B6
 619++9F45 53           	db skip3           %256 ; B7
 620++9F46 53           	db skip3           %256 ; B8
 621++9F47 53           	db skip3           %256 ; B9
 622++9F48 53           	db skip3           %256 ; BA
 623++9F49 53           	db skip3           %256 ; BB
 624++9F4A 53           	db skip3           %256 ; BC
 625++9F4B 53           	db skip3           %256 ; BD
 626++9F4C 53           	db skip3           %256 ; BE
 627++9F4D 53           	db skip3           %256 ; BF
 628++9F4E 58           	db skip4           %256 ; C0
 629++9F4F 58           	db skip4           %256 ; C1
 630++9F50 58           	db skip4           %256 ; C2
 631++9F51 58           	db skip4           %256 ; C3
 632++9F52 58           	db skip4           %256 ; C4
 633++9F53 58           	db skip4           %256 ; C5
 634++9F54 58           	db skip4           %256 ; C6
 635++9F55 58           	db skip4           %256 ; C7
 636++9F56 58           	db skip4           %256 ; C8
 637++9F57 58           	db skip4           %256 ; C9
 638++9F58 58           	db skip4           %256 ; CA
 639++9F59 58           	db skip4           %256 ; CB
 640++9F5A 58           	db skip4           %256 ; CC
 641++9F5B 58           	db skip4           %256 ; CD
 642++9F5C 58           	db skip4           %256 ; CE
 643++9F5D 58           	db skip4           %256 ; CF
 644++9F5E A5           	db cmdYMF278B      %256 ; D0
 645++9F5F 58           	db skip4           %256 ; D1
 646++9F60 74           	db cmdunsupported  %256 ; D2
 647++9F61 58           	db skip4           %256 ; D3
 648++9F62 58           	db skip4           %256 ; D4
 649++9F63 58           	db skip4           %256 ; D5
 650++9F64 58           	db skip4           %256 ; D6
 651++9F65 58           	db skip4           %256 ; D7
 652++9F66 58           	db skip4           %256 ; D8
 653++9F67 58           	db skip4           %256 ; D9
 654++9F68 58           	db skip4           %256 ; DA
 655++9F69 58           	db skip4           %256 ; DB
 656++9F6A 58           	db skip4           %256 ; DC
 657++9F6B 58           	db skip4           %256 ; DD
 658++9F6C 58           	db skip4           %256 ; DE
 659++9F6D 58           	db skip4           %256 ; DF
 660++9F6E 74           	db cmdunsupported  %256 ; E0
 661++9F6F 5D           	db skip5           %256 ; E1
 662++9F70 5D           	db skip5           %256 ; E2
 663++9F71 5D           	db skip5           %256 ; E3
 664++9F72 5D           	db skip5           %256 ; E4
 665++9F73 5D           	db skip5           %256 ; E5
 666++9F74 5D           	db skip5           %256 ; E6
 667++9F75 5D           	db skip5           %256 ; E7
 668++9F76 5D           	db skip5           %256 ; E8
 669++9F77 5D           	db skip5           %256 ; E9
 670++9F78 5D           	db skip5           %256 ; EA
 671++9F79 5D           	db skip5           %256 ; EB
 672++9F7A 5D           	db skip5           %256 ; EC
 673++9F7B 5D           	db skip5           %256 ; ED
 674++9F7C 5D           	db skip5           %256 ; EE
 675++9F7D 5D           	db skip5           %256 ; EF
 676++9F7E 5D           	db skip5           %256 ; F0
 677++9F7F 5D           	db skip5           %256 ; F1
 678++9F80 5D           	db skip5           %256 ; F2
 679++9F81 5D           	db skip5           %256 ; F3
 680++9F82 5D           	db skip5           %256 ; F4
 681++9F83 5D           	db skip5           %256 ; F5
 682++9F84 5D           	db skip5           %256 ; F6
 683++9F85 5D           	db skip5           %256 ; F7
 684++9F86 5D           	db skip5           %256 ; F8
 685++9F87 5D           	db skip5           %256 ; F9
 686++9F88 5D           	db skip5           %256 ; FA
 687++9F89 5D           	db skip5           %256 ; FB
 688++9F8A 5D           	db skip5           %256 ; FC
 689++9F8B 5D           	db skip5           %256 ; FD
 690++9F8C 5D           	db skip5           %256 ; FE
 691++9F8D 5D           	db skip5           %256 ; FF
 692++9F8E 9D           	db skip1           /256 ; 00
 693++9F8F 9D           	db skip1           /256 ; 01
 694++9F90 9D           	db skip1           /256 ; 02
 695++9F91 9D           	db skip1           /256 ; 03
 696++9F92 9D           	db skip1           /256 ; 04
 697++9F93 9D           	db skip1           /256 ; 05
 698++9F94 9D           	db skip1           /256 ; 06
 699++9F95 9D           	db skip1           /256 ; 07
 700++9F96 9D           	db skip1           /256 ; 08
 701++9F97 9D           	db skip1           /256 ; 09
 702++9F98 9D           	db skip1           /256 ; 0A
 703++9F99 9D           	db skip1           /256 ; 0B
 704++9F9A 9D           	db skip1           /256 ; 0C
 705++9F9B 9D           	db skip1           /256 ; 0D
 706++9F9C 9D           	db skip1           /256 ; 0E
 707++9F9D 9D           	db skip1           /256 ; 0F
 708++9F9E 9D           	db skip1           /256 ; 10
 709++9F9F 9D           	db skip1           /256 ; 11
 710++9FA0 9D           	db skip1           /256 ; 12
 711++9FA1 9D           	db skip1           /256 ; 13
 712++9FA2 9D           	db skip1           /256 ; 14
 713++9FA3 9D           	db skip1           /256 ; 15
 714++9FA4 9D           	db skip1           /256 ; 16
 715++9FA5 9D           	db skip1           /256 ; 17
 716++9FA6 9D           	db skip1           /256 ; 18
 717++9FA7 9D           	db skip1           /256 ; 19
 718++9FA8 9D           	db skip1           /256 ; 1A
 719++9FA9 9D           	db skip1           /256 ; 1B
 720++9FAA 9D           	db skip1           /256 ; 1C
 721++9FAB 9D           	db skip1           /256 ; 1D
 722++9FAC 9D           	db skip1           /256 ; 1E
 723++9FAD 9D           	db skip1           /256 ; 1F
 724++9FAE 9D           	db skip1           /256 ; 20
 725++9FAF 9D           	db skip1           /256 ; 21
 726++9FB0 9D           	db skip1           /256 ; 22
 727++9FB1 9D           	db skip1           /256 ; 23
 728++9FB2 9D           	db skip1           /256 ; 24
 729++9FB3 9D           	db skip1           /256 ; 25
 730++9FB4 9D           	db skip1           /256 ; 26
 731++9FB5 9D           	db skip1           /256 ; 27
 732++9FB6 9D           	db skip1           /256 ; 28
 733++9FB7 9D           	db skip1           /256 ; 29
 734++9FB8 9D           	db skip1           /256 ; 2A
 735++9FB9 9D           	db skip1           /256 ; 2B
 736++9FBA 9D           	db skip1           /256 ; 2C
 737++9FBB 9D           	db skip1           /256 ; 2D
 738++9FBC 9D           	db skip1           /256 ; 2E
 739++9FBD 9D           	db skip1           /256 ; 2F
 740++9FBE 9D           	db cmdunsupported  /256 ; 30
 741++9FBF 9D           	db skip2           /256 ; 31
 742++9FC0 9D           	db skip2           /256 ; 32
 743++9FC1 9D           	db skip2           /256 ; 33
 744++9FC2 9D           	db skip2           /256 ; 34
 745++9FC3 9D           	db skip2           /256 ; 35
 746++9FC4 9D           	db skip2           /256 ; 36
 747++9FC5 9D           	db skip2           /256 ; 37
 748++9FC6 9D           	db skip2           /256 ; 38
 749++9FC7 9D           	db skip2           /256 ; 39
 750++9FC8 9D           	db skip2           /256 ; 3A
 751++9FC9 9D           	db skip2           /256 ; 3B
 752++9FCA 9D           	db skip2           /256 ; 3C
 753++9FCB 9D           	db skip2           /256 ; 3D
 754++9FCC 9D           	db skip2           /256 ; 3E
 755++9FCD 9D           	db skip2           /256 ; 3F
 756++9FCE 9D           	db skip3           /256 ; 40
 757++9FCF 9D           	db skip3           /256 ; 41
 758++9FD0 9D           	db skip3           /256 ; 42
 759++9FD1 9D           	db skip3           /256 ; 43
 760++9FD2 9D           	db skip3           /256 ; 44
 761++9FD3 9D           	db skip3           /256 ; 45
 762++9FD4 9D           	db skip3           /256 ; 46
 763++9FD5 9D           	db skip3           /256 ; 47
 764++9FD6 9D           	db skip3           /256 ; 48
 765++9FD7 9D           	db skip3           /256 ; 49
 766++9FD8 9D           	db skip3           /256 ; 4A
 767++9FD9 9D           	db skip3           /256 ; 4B
 768++9FDA 9D           	db skip3           /256 ; 4C
 769++9FDB 9D           	db skip3           /256 ; 4D
 770++9FDC 9D           	db skip3           /256 ; 4E
 771++9FDD 9D           	db skip2           /256 ; 4F
 772++9FDE 9D           	db cmdunsupported  /256 ; 50
 773++9FDF 9D           	db cmdunsupported  /256 ; 51
 774++9FE0 9D           	db cmdunsupported  /256 ; 52
 775++9FE1 9D           	db cmdunsupported  /256 ; 53
 776++9FE2 9D           	db cmdYM2151       /256 ; 54
 777++9FE3 9D           	db cmdYM2203       /256 ; 55
 778++9FE4 9D           	db cmdYM2608p0     /256 ; 56
 779++9FE5 A0           	db cmdYM2608p1     /256 ; 57
 780++9FE6 9D           	db cmdunsupported  /256 ; 58
 781++9FE7 9D           	db cmdunsupported  /256 ; 59
 782++9FE8 9D           	db cmdYM3812       /256 ; 5A
 783++9FE9 9D           	db cmdYM3526       /256 ; 5B
 784++9FEA 9D           	db cmdY8950        /256 ; 5C
 785++9FEB 9D           	db skip3           /256 ; 5D
 786++9FEC 9D           	db cmdYMF262p0     /256 ; 5E
 787++9FED 9D           	db cmdYMF262p1     /256 ; 5F
 788++9FEE 9D           	db cmdunsupported  /256 ; 60
 789++9FEF 9D           	db waitvar         /256 ; 61
 790++9FF0 9D           	db wait735         /256 ; 62
 791++9FF1 9D           	db wait882         /256 ; 63
 792++9FF2 9D           	db cmdunsupported  /256 ; 64
 793++9FF3 9D           	db cmdunsupported  /256 ; 65
 794++9FF4 9D           	db endofsounddata  /256 ; 66
 795++9FF5 9E           	db cmddatablock    /256 ; 67
 796++9FF6 9D           	db skip12          /256 ; 68
 797++9FF7 9D           	db cmdunsupported  /256 ; 69
 798++9FF8 9D           	db cmdunsupported  /256 ; 6A
 799++9FF9 9D           	db cmdunsupported  /256 ; 6B
 800++9FFA 9D           	db cmdunsupported  /256 ; 6C
 801++9FFB 9D           	db cmdunsupported  /256 ; 6D
 802++9FFC 9D           	db cmdunsupported  /256 ; 6E
 803++9FFD 9D           	db cmdunsupported  /256 ; 6F
 804++9FFE 9C           	db wait1           /256 ; 70
 805++9FFF 9C           	db wait2           /256 ; 71
 806++A000 9C           	db wait3           /256 ; 72
 807++A001 9C           	db wait4           /256 ; 73
 808++A002 9C           	db wait5           /256 ; 74
 809++A003 9C           	db wait6           /256 ; 75
 810++A004 9C           	db wait7           /256 ; 76
 811++A005 9C           	db wait8           /256 ; 77
 812++A006 9C           	db wait9           /256 ; 78
 813++A007 9C           	db wait10          /256 ; 79
 814++A008 9C           	db wait11          /256 ; 7A
 815++A009 9C           	db wait12          /256 ; 7B
 816++A00A 9D           	db wait13          /256 ; 7C
 817++A00B 9D           	db wait14          /256 ; 7D
 818++A00C 9D           	db wait15          /256 ; 7E
 819++A00D 9D           	db wait16          /256 ; 7F
 820++A00E 9D           	db skip1           /256 ; 80
 821++A00F 9C           	db wait1           /256 ; 81
 822++A010 9C           	db wait2           /256 ; 82
 823++A011 9C           	db wait3           /256 ; 83
 824++A012 9C           	db wait4           /256 ; 84
 825++A013 9C           	db wait5           /256 ; 85
 826++A014 9C           	db wait6           /256 ; 86
 827++A015 9C           	db wait7           /256 ; 87
 828++A016 9C           	db wait8           /256 ; 88
 829++A017 9C           	db wait9           /256 ; 89
 830++A018 9C           	db wait10          /256 ; 8A
 831++A019 9C           	db wait11          /256 ; 8B
 832++A01A 9C           	db wait12          /256 ; 8C
 833++A01B 9D           	db wait13          /256 ; 8D
 834++A01C 9D           	db wait14          /256 ; 8E
 835++A01D 9D           	db wait15          /256 ; 8F
 836++A01E 9D           	db skip5           /256 ; 90
 837++A01F 9D           	db skip5           /256 ; 91
 838++A020 9D           	db skip6           /256 ; 92
 839++A021 9D           	db skip11          /256 ; 93
 840++A022 9D           	db skip2           /256 ; 94
 841++A023 9D           	db skip5           /256 ; 95
 842++A024 9D           	db cmdunsupported  /256 ; 96
 843++A025 9D           	db cmdunsupported  /256 ; 97
 844++A026 9D           	db cmdunsupported  /256 ; 98
 845++A027 9D           	db cmdunsupported  /256 ; 99
 846++A028 9D           	db cmdunsupported  /256 ; 9A
 847++A029 9D           	db cmdunsupported  /256 ; 9B
 848++A02A 9D           	db cmdunsupported  /256 ; 9C
 849++A02B 9D           	db cmdunsupported  /256 ; 9D
 850++A02C 9D           	db cmdunsupported  /256 ; 9E
 851++A02D 9D           	db cmdunsupported  /256 ; 9F
 852++A02E 9E           	db cmdAY8910       /256 ; A0
 853++A02F 9D           	db skip3           /256 ; A1
 854++A030 9D           	db cmdunsupported  /256 ; A2
 855++A031 9D           	db cmdunsupported  /256 ; A3
 856++A032 9E           	db cmdYM2151dp     /256 ; A4
 857++A033 9D           	db cmdYM2203dp     /256 ; A5
 858++A034 9D           	db skip3           /256 ; A6
 859++A035 9D           	db skip3           /256 ; A7
 860++A036 9D           	db skip3           /256 ; A8
 861++A037 9D           	db skip3           /256 ; A9
 862++A038 9D           	db cmdYM3812dp     /256 ; AA
 863++A039 9D           	db cmdYM3526dp     /256 ; AB
 864++A03A 9D           	db cmdY8950dp      /256 ; AC
 865++A03B 9D           	db skip3           /256 ; AD
 866++A03C 96           	db cmdYMF262dp0    /256 ; AE
 867++A03D 96           	db cmdYMF262dp0    /256 ; AF
 868++A03E 9D           	db skip3           /256 ; B0
 869++A03F 9D           	db skip3           /256 ; B1
 870++A040 9D           	db skip3           /256 ; B2
 871++A041 9D           	db skip3           /256 ; B3
 872++A042 9D           	db skip3           /256 ; B4
 873++A043 9D           	db skip3           /256 ; B5
 874++A044 9D           	db skip3           /256 ; B6
 875++A045 9D           	db skip3           /256 ; B7
 876++A046 9D           	db skip3           /256 ; B8
 877++A047 9D           	db skip3           /256 ; B9
 878++A048 9D           	db skip3           /256 ; BA
 879++A049 9D           	db skip3           /256 ; BB
 880++A04A 9D           	db skip3           /256 ; BC
 881++A04B 9D           	db skip3           /256 ; BD
 882++A04C 9D           	db skip3           /256 ; BE
 883++A04D 9D           	db skip3           /256 ; BF
 884++A04E 9D           	db skip4           /256 ; C0
 885++A04F 9D           	db skip4           /256 ; C1
 886++A050 9D           	db skip4           /256 ; C2
 887++A051 9D           	db skip4           /256 ; C3
 888++A052 9D           	db skip4           /256 ; C4
 889++A053 9D           	db skip4           /256 ; C5
 890++A054 9D           	db skip4           /256 ; C6
 891++A055 9D           	db skip4           /256 ; C7
 892++A056 9D           	db skip4           /256 ; C8
 893++A057 9D           	db skip4           /256 ; C9
 894++A058 9D           	db skip4           /256 ; CA
 895++A059 9D           	db skip4           /256 ; CB
 896++A05A 9D           	db skip4           /256 ; CC
 897++A05B 9D           	db skip4           /256 ; CD
 898++A05C 9D           	db skip4           /256 ; CE
 899++A05D 9D           	db skip4           /256 ; CF
 900++A05E 9D           	db cmdYMF278B      /256 ; D0
 901++A05F 9D           	db skip4           /256 ; D1
 902++A060 9D           	db cmdunsupported  /256 ; D2
 903++A061 9D           	db skip4           /256 ; D3
 904++A062 9D           	db skip4           /256 ; D4
 905++A063 9D           	db skip4           /256 ; D5
 906++A064 9D           	db skip4           /256 ; D6
 907++A065 9D           	db skip4           /256 ; D7
 908++A066 9D           	db skip4           /256 ; D8
 909++A067 9D           	db skip4           /256 ; D9
 910++A068 9D           	db skip4           /256 ; DA
 911++A069 9D           	db skip4           /256 ; DB
 912++A06A 9D           	db skip4           /256 ; DC
 913++A06B 9D           	db skip4           /256 ; DD
 914++A06C 9D           	db skip4           /256 ; DE
 915++A06D 9D           	db skip4           /256 ; DF
 916++A06E 9D           	db cmdunsupported  /256 ; E0
 917++A06F 9D           	db skip5           /256 ; E1
 918++A070 9D           	db skip5           /256 ; E2
 919++A071 9D           	db skip5           /256 ; E3
 920++A072 9D           	db skip5           /256 ; E4
 921++A073 9D           	db skip5           /256 ; E5
 922++A074 9D           	db skip5           /256 ; E6
 923++A075 9D           	db skip5           /256 ; E7
 924++A076 9D           	db skip5           /256 ; E8
 925++A077 9D           	db skip5           /256 ; E9
 926++A078 9D           	db skip5           /256 ; EA
 927++A079 9D           	db skip5           /256 ; EB
 928++A07A 9D           	db skip5           /256 ; EC
 929++A07B 9D           	db skip5           /256 ; ED
 930++A07C 9D           	db skip5           /256 ; EE
 931++A07D 9D           	db skip5           /256 ; EF
 932++A07E 9D           	db skip5           /256 ; F0
 933++A07F 9D           	db skip5           /256 ; F1
 934++A080 9D           	db skip5           /256 ; F2
 935++A081 9D           	db skip5           /256 ; F3
 936++A082 9D           	db skip5           /256 ; F4
 937++A083 9D           	db skip5           /256 ; F5
 938++A084 9D           	db skip5           /256 ; F6
 939++A085 9D           	db skip5           /256 ; F7
 940++A086 9D           	db skip5           /256 ; F8
 941++A087 9D           	db skip5           /256 ; F9
 942++A088 9D           	db skip5           /256 ; FA
 943++A089 9D           	db skip5           /256 ; FB
 944++A08A 9D           	db skip5           /256 ; FC
 945++A08B 9D           	db skip5           /256 ; FD
 946++A08C 9D           	db skip5           /256 ; FE
 947++A08D 9D           	db skip5           /256 ; FF
 948++A08E
 949++A08E
 950++A08E
 951++A08E              cmdYM2608p0 equ cmdYM2203
 952++A08E
 953++A08E              cmdYM2608p1
 954++A08E              	memory_stream_read_2 e,d
 954++A08E 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 954++A091             >	memory_stream_read_byte e
 954++A091 CB 74       >	bit 6,h
 954++A093             >        IF AREA_C000_FFFF=1
 954++A093 CC 0D 96    >	call z,memorystreamnextpage
 954++A096             >        ELSE
 954++A096 ~           > 	call nz,memorystreamnextpage
 954++A096             >        ENDIF
 954++A096 5E          >	ld e,(hl)
 954++A097 23          >	inc hl
 954++A098             >	memory_stream_read_byte d
 954++A098 CB 74       >	bit 6,h
 954++A09A             >        IF AREA_C000_FFFF=1
 954++A09A CC 0D 96    >	call z,memorystreamnextpage
 954++A09D             >        ELSE
 954++A09D ~           > 	call nz,memorystreamnextpage
 954++A09D             >        ENDIF
 954++A09D 56          >	ld d,(hl)
 954++A09E 23          >	inc hl
 954++A09F 22 72 96    >	ld (memorystreamcurrentaddr),hl
 955++A0A2 7B           	ld a,e
 956++A0A3 FE 30        	cp 0x30
 957++A0A5 D8           	ret c
 958++A0A6 C3 A0 9A     	jp opnwritefm2
 959++A0A9
 960++A0A9
 961++A0A9              initAY8910
 962++A0A9 CD AD 9B     	call ssginit
 963++A0AC 21 66 9C     	ld hl,devicemask
 964++A0AF 3A 77 BE     	ld a,(HEADER_CLOCK_AY8910+3)
 965++A0B2 E6 40        	and 0x40
 966++A0B4 20 03        	jr nz,.dualchip
 967++A0B6 CB C6        	set DEVICE_AY_BIT,(hl)
 968++A0B8 C9           	ret
 969++A0B9              .dualchip
 970++A0B9 CB CE        	set DEVICE_TURBOSOUND_BIT,(hl)
 971++A0BB C9           	ret
 972++A0BC
 973++A0BC              initYM2203
 974++A0BC              tfmstatus=$+1
 975++A0BC 3E 01        	ld a,1
 976++A0BE 3D           	dec a
 977++A0BF F8           	ret m
 978++A0C0 CD AB 9A     	call opninit
 979++A0C3              	set_timer opnwaittimer60hz,735
 979++A0C3 21 DF 02    >	ld hl,735
 979++A0C6 22 86 9C    >	ld (waittimerstep),hl
 980++A0C9 CD 41 9B     	call opninittimer60hz
 981++A0CC 21 66 9C     	ld hl,devicemask
 982++A0CF CB D6        	set DEVICE_TFM_BIT,(hl)
 983++A0D1 AF           	xor a
 984++A0D2 C9           	ret
 985++A0D3
 986++A0D3              initYMF278B
 987++A0D3              moonsoundstatus=$+1
 988++A0D3 3E 02        	ld a,2
 989++A0D5 3D           	dec a
 990++A0D6 F8           	ret m
 991++A0D7 CD 6D 99     	call vgmopl4init
 992++A0DA 3A 53 BE     	ld a,(HEADER_CLOCK_YM3812+3)
 993++A0DD E6 40        	and 0x40
 994++A0DF 20 08        	jr nz,notOPL2
 995++A0E1              useYM3812=$+1
 996++A0E1 F6 00        	or 0
 997++A0E3 11 05 00     	ld de,0x0005
 998++A0E6 C4 33 97     	call nz,opl4writefm2
 999++A0E9              notOPL2
1000++A0E9 CD 64 9A     	call opl4inittimer60hz
1001++A0EC 21 66 9C     	ld hl,devicemask
1002++A0EF CB DE        	set DEVICE_MOONSOUND_BIT,(hl)
1003++A0F1 AF           	xor a
1004++A0F2 C9           	ret
1005++A0F3
1006++A0F3              end
1007++A0F3
1008++A0F3
1009++A0F3
1010++A0F3              ;        LABELSLIST "vgm_plr.l"
1011++A0F3              ;	savebin "gplay.apg",begin,end-begin
# file closed: GPlay/vgm.asm
 761+ A0F3              	include sub_func.asm
# file opened: GPlay/sub_func.asm
   1++A0F3
   2++A0F3              fileopenerror
   3++A0F3 79           		ld a,c
   4++A0F4 0E FF        		ld c,$FF
   5++A0F6 02                   ld (bc),a ;   
   6++A0F7
   7++A0F7 21 3B A5     		ld hl,msg_file_error
   8++A0FA              		OS_PRINTZ
   8++A0FA 0E 09       >    ld c,#09
   8++A0FC E7          >    rst #20
   9++A0FD
  10++A0FD 3A 5F A4     		ld a,(file_id_cur_r)
  11++A100 FE FF        		cp 255
  12++A102 28 03        		jr z,fileopenerror1
  13++A104              		OS_FILE_CLOSE ;A - id file
  13++A104 0E 25       >    ld c,#25
  13++A106 E7          >    rst #20
  14++A107              fileopenerror1
  15++A107 37           		scf ;
  16++A108 C9           		ret
  17++A109
  18++A109
  19++A109              ; memoryerror
  20++A109                      ; OS_CLOSEHANDLE
  21++A109                      ; ld e,6+0x80
  22++A109                      ; OS_SETGFX
  23++A109                      ; ld e,0
  24++A109                      ; OS_CLS
  25++A109                      ; ld hl,txt_memoryerror
  26++A109                      ; call print_hl
  27++A109                      ; YIELDGETKEYLOOP
  28++A109                      ; jp cmd_quit
  29++A109
  30++A109              memoryerror
  31++A109 79           		ld a,c
  32++A10A 0E FF        		ld c,$FF
  33++A10C 02                   ld (bc),a ;   
  34++A10D
  35++A10D 21 97 94     		ld hl,txt_memoryerror
  36++A110              		OS_PRINTZ
  36++A110 0E 09       >    ld c,#09
  36++A112 E7          >    rst #20
  37++A113
  38++A113 3A 5F A4     		ld a,(file_id_cur_r)
  39++A116 FE FF        		cp 255
  40++A118 28 03        		jr z,memoryerror1
  41++A11A              		OS_FILE_CLOSE ;A - id file
  41++A11A 0E 25       >    ld c,#25
  41++A11C E7          >    rst #20
  42++A11D              memoryerror1
  43++A11D 37           		scf ;
  44++A11E C9           		ret
  45++A11F
  46++A11F
  47++A11F
  48++A11F              ;----------------------------------------
  49++A11F              load_mus
  50++A11F
  51++A11F                      ; ld b,0
  52++A11F              ; old_mus EQU $-1
  53++A11F                      ; cp b
  54++A11F                      ; ret z
  55++A11F                      ; ld (old_mus),a
  56++A11F
  57++A11F                      ; and a
  58++A11F                      ; jp z,no_mus
  59++A11F
  60++A11F
  61++A11F                      ; call calc_mus
  62++A11F
  63++A11F                      ; call no_mus
  64++A11F                      ; ld hl,t_s98_file00_pages_list+$FF
  65++A11F                      ; call free_s98_file ; 
  66++A11F
  67++A11F                      ;generate path to music file in 'buf'
  68++A11F                      ; ld hl,mus_path1
  69++A11F                      ; ld de,buf
  70++A11F                      ; call copystr_hlde ;'copy path  'mus/' '
  71++A11F
  72++A11F                      ; ld a,(mus_mode)
  73++A11F                      ; ld hl,mus_modes
  74++A11F                      ; call sel_word
  75++A11F                      ; call copystr_hlde ;copy "aym / s98 path"
  76++A11F                      ; ld hl,mus_path2
  77++A11F                      ; call copystr_hlde ;copy name without ext
  78++A11F
  79++A11F                      ; ld a,(mus_mode)
  80++A11F                      ; ld hl,plr_ext
  81++A11F                      ; call sel_word
  82++A11F                      ; call copystr_hlde  ;copy file ext
  83++A11F                      ; xor a
  84++A11F                      ; ld (de),a  ;string terminator
  85++A11F
  86++A11F                      ; ld de,buf ; 
  87++A11F                      ; call openstream_file
  88++A11F
  89++A11F 21 4A A2     		ld hl,file_name_cur
  90++A122              		OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
  90++A122 0E 21       >    ld c,#21
  90++A124 E7          >    rst #20
  91++A125
  92++A125                      ;or a
  93++A125                      ;jp nz,fileopenerror
  94++A125 DA F3 A0     		jp c,fileopenerror
  95++A128 32 5F A4     		ld (file_id_cur_r),a
  96++A12B
  97++A12B 21 00 95             ld hl,memorystreampages ;t_s98_file00_pages_list
  98++A12E 22 32 A1             ld (load_s98_file_number),hl
  99++A131
 100++A131
 101++A131              /////------        call load_s98_file      ;de=drive/path/file
 102++A131
 103++A131              ;    
 104++A131              ;   
 105++A131
 106++A131                              ;   
 107++A131
 108++A131
 109++A131              load_s98_file_number_haddr = $+2
 109++A131
 110++A131              load_s98_file_number = $+1
 110++A131
 111++A131 01 00 95                     ld bc,memorystreampages ;t_s98_file00_pages_list
 112++A134 C5                           push bc
 113++A135
 114++A135              read_file_loop:
 115++A135                              ;OS_NEWPAGE              ;out: a=0 (OK)/!=0 (fail), e=page
 116++A135              				OS_GET_PAGE ;*
 116++A135 0E 1A       >    ld c,#1a
 116++A137 E7          >    rst #20
 117++A138
 118++A138 C1                           pop bc ;file tab
 119++A139
 120++A139                              ;or a
 121++A139                              ;jp nz,memory_error
 122++A139 DA 7C A1     				jp c,memory_error
 123++A13C                              ;ld a,e
 124++A13C                                                      ;    !!!!
 125++A13C                                                      ;    !!!!
 126++A13C
 127++A13C 02           1               ld (bc),a
 128++A13D 0C                           inc c           ;      4 !!!!!
 129++A13E
 130++A13E C5                           push bc ;file tab
 131++A13F                              ;SETPGC000
 132++A13F              				OS_SET_PAGE_SLOT3
 132++A13F 0E 1C       >    ld c,#1c
 132++A141 E7          >    rst #20
 133++A142
 134++A142                              ;ld de,$C000
 135++A142                              ;ld hl,$4000
 136++A142
 137++A142                              ;call readstream_file    ;DE = Buffer address, HL = Number of bytes to read
 138++A142                                              ;hl=actual size
 139++A142
 140++A142 3A 5F A4     				ld a,(file_id_cur_r)
 141++A145 21 00 C0     				ld hl,$C000
 142++A148 11 00 40                     ld de,$4000
 143++A14B              				OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl -    )
 143++A14B 0E 23       >    ld c,#23
 143++A14D E7          >    rst #20
 144++A14E 30 04        				jr nc,read_file_loop1
 145++A150
 146++A150              				; 
 147++A150 C1                           pop bc ;file tab
 148++A151 C3 F3 A0                     jp fileopenerror
 149++A154
 150++A154
 151++A154              read_file_loop1		;
 152++A154 7C                           ld a,h
 153++A155                              ; cp $40
 154++A155                              ; jr nc,read_file_loop    ;>= $40
 155++A155 FE C0        				cp $c0
 156++A157 38 DC                        jr c,read_file_loop    ;>= $c0,   
 157++A159
 158++A159
 159++A159              read_file_exit
 160++A159
 161++A159 C1                           pop bc ;file tab
 162++A15A                              ;    
 163++A15A 79                           ld a,c
 164++A15B
 165++A15B                             // sub 16   ; !!!!!       0  +16
 166++A15B
 167++A15B 0E FF                        ld c,$FF
 168++A15D 02                           ld (bc),a
 169++A15E
 170++A15E              ;-------------------------------------------------------
 171++A15E              ;    .
 172++A15E              ;       plr_page3    
 173++A15E              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 174++A15E                              ;call closestream_file
 175++A15E 3A 5F A4     				ld a,(file_id_cur_r)
 176++A161              				OS_FILE_CLOSE ;A - id file
 176++A161 0E 25       >    ld c,#25
 176++A163 E7          >    rst #20
 177++A164
 178++A164              read_file_ok
 179++A164                              ;call store8000c000 ;*
 180++A164              ;  8000     
 181++A164 21 00 95                     ld hl,memorystreampages ;t_s98_file00_pages_list
 182++A167 7E                           ld a,(hl)
 183++A168                              ;SETPG8000
 184++A168              				OS_SET_PAGE_SLOT3
 184++A168 0E 1C       >    ld c,#1c
 184++A16A E7          >    rst #20
 185++A16B                              ; ld a,(plr_page3)
 186++A16B                              ; SETPGC000
 187++A16B
 188++A16B              ;    plr_page3.      .
 189++A16B                              ; ld hl,0x8000
 190++A16B                              ; ld de,module
 191++A16B                              ; ld bc,16384
 192++A16B                              ; ldir
 193++A16B
 194++A16B              ;   plrpage      .
 195++A16B                              ; ld a,(plr_page)
 196++A16B                              ; SETPGC000
 197++A16B                              ; ld hl,t_s98_file00_pages_list
 198++A16B                              ; ld de,0xc100         ;0x5000
 199++A16B                              ; ld bc,256
 200++A16B                              ; ldir
 201++A16B
 202++A16B                       ;       DI
 203++A16B
 204++A16B              ;b .
 205++A16B                              ;call restore8000c000
 206++A16B
 207++A16B                              ;call set_music_pages
 208++A16B
 209++A16B 21 00 C0                     ld hl,module
 210++A16E                              ;ld (0x4001),hl *    
 211++A16E 22 C9 94     				ld (START+1),hl
 212++A171 CD C8 94                     call PLR_INIT        ;init music
 213++A174
 214++A174                        ;      EI
 215++A174              ;----------------
 216++A174              ;eloop           halt ;YIELD
 217++A174              ;                call PLR_PLAY
 218++A174              ;                jr eloop
 219++A174              ;----------------
 220++A174
 221++A174
 222++A174              ;!!!!!!!!!!
 223++A174
 224++A174              ; .
 225++A174                              ;ld a,(plr_page)
 226++A174 21 CD 94                     ld hl,PLR_PLAY
 227++A177                              ;OS_SETMUSIC         ;****     
 228++A177              				OS_SET_INTER
 228++A177 0E 14       >    ld c,#14
 228++A179 E7          >    rst #20
 229++A17A AF           				xor a ;OK
 230++A17B C9           				ret
 231++A17C                              ;jp unset_music_pages
 232++A17C
 233++A17C
 234++A17C              memory_error:
 235++A17C C3 09 A1             jp memoryerror
 236++A17F
# file closed: GPlay/sub_func.asm
 762+ A17F              	include common/general-sound.asm
# file opened: GPlay/common/general-sound.asm
   1++A17F                  ;ifdef GS
   2++A17F                  macro GS_WaitCommand
   3++A17F ~            .wait
   4++A17F ~                in a, (GeneralSound.CMD)
   5++A17F ~                rrca
   6++A17F ~                jr c, .wait
   7++A17F                  endm
   8++A17F
   9++A17F                  macro GS_WaitData
  10++A17F ~            .wait
  11++A17F ~                in a, (GeneralSound.CMD)
  12++A17F ~                rlca
  13++A17F ~                jr c, .wait
  14++A17F                  endm
  15++A17F
  16++A17F                  macro GS_SendCommand nn
  17++A17F ~                ld a, nn
  17++A17F ~              out (GeneralSound.CMD), a
  18++A17F                  endm
  19++A17F
  20++A17F                  module GeneralSound
  21++A17F              ;; Control ports
  22++A17F              CMD  = 187
  23++A17F              DATA = 179
  24++A17F
  25++A17F              ;; Commands
  26++A17F              CMD_WARM_RESET      = #F3
  27++A17F              CMD_COLD_RESET      = #F4
  28++A17F              CMD_LOAD_MODULE     = #30
  29++A17F              CMD_PLAY_MODULE     = #31
  30++A17F              CMD_STOP_MODULE     = #32
  31++A17F              CMD_CONTINUE_MODULE = #33
  32++A17F              CMD_OPEN_STREAM     = #D1
  33++A17F              CMD_CLOSE_STREAM    = #D2
  34++A17F
  35++A17F              ; A - 0 warm reset, other - cold
  36++A17F              init:
  37++A17F A7               and a
  37++A180 20 0A          jr nz, .cold
  38++A182                  GS_SendCommand CMD_WARM_RESET
  38++A182 3E F3       >    ld a, CMD_WARM_RESET
  38++A184 D3 BB       >  out (GeneralSound.CMD), a
  39++A186              	GS_WaitCommand
  39++A186             >.wait
  39++A186 DB BB       >    in a, (GeneralSound.CMD)
  39++A188 0F          >    rrca
  39++A189 38 FB       >    jr c, .wait
  40++A18B C9               ret
  41++A18C              .cold
  42++A18C                  GS_SendCommand CMD_COLD_RESET
  42++A18C 3E F4       >    ld a, CMD_COLD_RESET
  42++A18E D3 BB       >  out (GeneralSound.CMD), a
  43++A190              	GS_WaitCommand
  43++A190             >.wait
  43++A190 DB BB       >    in a, (GeneralSound.CMD)
  43++A192 0F          >    rrca
  43++A193 38 FB       >    jr c, .wait
  44++A195 C9               ret
  45++A196
  46++A196              ;; Initializes loading module
  47++A196              loadModule:
  48++A196                  GS_SendCommand CMD_LOAD_MODULE
  48++A196 3E 30       >    ld a, CMD_LOAD_MODULE
  48++A198 D3 BB       >  out (GeneralSound.CMD), a
  49++A19A                  GS_WaitCommand
  49++A19A             >.wait
  49++A19A DB BB       >    in a, (GeneralSound.CMD)
  49++A19C 0F          >    rrca
  49++A19D 38 FB       >    jr c, .wait
  50++A19F                  GS_SendCommand CMD_OPEN_STREAM
  50++A19F 3E D1       >    ld a, CMD_OPEN_STREAM
  50++A1A1 D3 BB       >  out (GeneralSound.CMD), a
  51++A1A3                  GS_WaitCommand
  51++A1A3             >.wait
  51++A1A3 DB BB       >    in a, (GeneralSound.CMD)
  51++A1A5 0F          >    rrca
  51++A1A6 38 FB       >    jr c, .wait
  52++A1A8 C9               ret
  53++A1A9
  54++A1A9              ;; Use it for streaming mod file
  55++A1A9              sendByte:
  56++A1A9 D3 B3            out (DATA), a
  57++A1AB                  GS_WaitData
  57++A1AB             >.wait
  57++A1AB DB BB       >    in a, (GeneralSound.CMD)
  57++A1AD 07          >    rlca
  57++A1AE 38 FB       >    jr c, .wait
  58++A1B0 C9               ret
  59++A1B1
  60++A1B1              ;; Call it when module was loaded
  61++A1B1              finishLoadingModule:
  62++A1B1                  GS_SendCommand CMD_CLOSE_STREAM
  62++A1B1 3E D2       >    ld a, CMD_CLOSE_STREAM
  62++A1B3 D3 BB       >  out (GeneralSound.CMD), a
  63++A1B5                  GS_WaitCommand
  63++A1B5             >.wait
  63++A1B5 DB BB       >    in a, (GeneralSound.CMD)
  63++A1B7 0F          >    rrca
  63++A1B8 38 FB       >    jr c, .wait
  64++A1BA              rewind:
  65++A1BA 3E 01            ld a, 1
  65++A1BC D3 B3          out (DATA), a
  66++A1BE                  GS_SendCommand CMD_PLAY_MODULE
  66++A1BE 3E 31       >    ld a, CMD_PLAY_MODULE
  66++A1C0 D3 BB       >  out (GeneralSound.CMD), a
  67++A1C2                  GS_WaitCommand
  67++A1C2             >.wait
  67++A1C2 DB BB       >    in a, (GeneralSound.CMD)
  67++A1C4 0F          >    rrca
  67++A1C5 38 FB       >    jr c, .wait
  68++A1C7 3E 01 32 E8      ld a, 1, (state),a
  68++A1CB A1
  69++A1CC C9               ret
  70++A1CD
  71++A1CD              ;; Works like pause too
  72++A1CD              stopModule:
  73++A1CD AF               xor a
  73++A1CE 32 E8 A1       ld (state), a
  74++A1D1                  GS_SendCommand CMD_STOP_MODULE
  74++A1D1 3E 32       >    ld a, CMD_STOP_MODULE
  74++A1D3 D3 BB       >  out (GeneralSound.CMD), a
  75++A1D5 C9               ret
  76++A1D6
  77++A1D6              continueModule:
  78++A1D6 3E 01            ld a, 1
  78++A1D8 32 E8 A1       ld (state), a
  79++A1DB                  GS_SendCommand CMD_CONTINUE_MODULE
  79++A1DB 3E 33       >    ld a, CMD_CONTINUE_MODULE
  79++A1DD D3 BB       >  out (GeneralSound.CMD), a
  80++A1DF C9               ret
  81++A1E0
  82++A1E0              ; Pauses resumes
  83++A1E0              toggleModule:
  84++A1E0                  ;call Console.waitForKeyUp
  85++A1E0 3A E8 A1         ld a, (state)
  85++A1E3 A7             and a
  86++A1E4 28 F0            jr z, continueModule
  87++A1E6 18 E5            jr stopModule
  88++A1E8
  89++A1E8 00           state db 0
  90++A1E9                  endmodule
  91++A1E9
  92++A1E9                  ;endif
# file closed: GPlay/common/general-sound.asm
 763+ A1E9              	;include common/muldiv.asm
 764+ A1E9
 765+ A1E9              end_gplay
 766+ A1E9
 767+ A1E9
 768+ A1E9
 769+ A1E9              ;ниже не включается в файл
 770+ A1E9              ;waveheaderbuffer equ 0xc000-2048=0xb800 ;
 771+ A1E9
 772+ A1E9
 773+ A1E9              	;savebin "gplay.apg",start_gplay,$-start_gplay
# file closed: GPlay/gplay.asm
1777  A1E9              	include nc_pic_view.asm ;просмотр картинок
# file opened: nc_pic_view.asm
   1+ A1E9                  ; module ScreenViewer
   2+ A1E9              display:
   3+ A1E9                  ; call Console.waitForKeyUp
   4+ A1E9
   5+ A1E9 21 4A A2     	ld hl,file_name_cur		;строка с именем
   6+ A1EC              	OS_FILE_OPEN
   6+ A1EC 0E 21       >    ld c,#21
   6+ A1EE E7          >    rst #20
   7+ A1EF 30 08        	jr nc,display_file_open_ok
   8+ A1F1              display_file_error
   9+ A1F1 21 3B A5     	ld hl,msg_file_error
  10+ A1F4              	OS_PRINTZ
  10+ A1F4 0E 09       >    ld c,#09
  10+ A1F6 E7          >    rst #20
  11+ A1F7              	; ld b,2*50
  12+ A1F7              	; call delay1
  13+ A1F7 37           	scf ;ошибка
  14+ A1F8 C9           	ret
  15+ A1F9
  16+ A1F9              display_file_open_ok
  17+ A1F9 32 5F A4     	ld (file_id_cur_r),a
  18+ A1FC
  19+ A1FC 3A 61 A4     	ld a,(page_ext01) ;доп страница
  20+ A1FF              	OS_SET_PAGE_SLOT3
  20+ A1FF 0E 1C       >    ld c,#1c
  20+ A201 E7          >    rst #20
  21+ A202
  22+ A202 3A 5F A4     	ld a,(file_id_cur_r)
  23+ A205 11 00 1B     	ld de,6912
  24+ A208 21 00 C0     	ld hl,#c000
  25+ A20B              	;ld a,(file_id_cur_r)
  26+ A20B              	OS_FILE_READ ;загрузить
  26+ A20B 0E 23       >    ld c,#23
  26+ A20D E7          >    rst #20
  27+ A20E 38 E1        	jr c,display_file_error
  28+ A210 3A 5F A4     	ld a,(file_id_cur_r)
  29+ A213              	OS_FILE_CLOSE
  29+ A213 0E 25       >    ld c,#25
  29+ A215 E7          >    rst #20
  30+ A216
  31+ A216              display_wait1
  32+ A216 3E 07        	ld a,7
  33+ A218              	OS_SET_SCREEN ;включить экран
  33+ A218 0E 1D       >    ld c,#1d
  33+ A21A E7          >    rst #20
  34+ A21B 30 03        	jr nc,display_wait1_ok
  35+ A21D              	OS_WAIT
  35+ A21D DF          >	rst #18
  36+ A21E 18 F6        	jr display_wait1 ;пока не получилось, может не в фокусе приложение
  37+ A220
  38+ A220              display_wait1_ok
  39+ A220
  40+ A220 3A 61 A4     	ld a,(page_ext01) ;доп страница для данных плеера
  41+ A223 06 07        	ld b,7 ;страница назначения
  42+ A225 21 00 80     	ld hl,#8000
  43+ A228 11 00 C0     	ld de,#c000
  44+ A22B DD 21 00 1B  	ld ix,6912
  45+ A22F              	OS_RAM_COPY
  45+ A22F 0E 19       >    ld c,#19
  45+ A231 E7          >    rst #20
  46+ A232                  ;call TextMode.disable
  47+ A232              .wait
  48+ A232              	OS_WAIT
  48+ A232 DF          >	rst #18
  49+ A233              	OS_GET_CHAR
  49+ A233 0E 10       >    ld c,#10
  49+ A235 E7          >    rst #20
  50+ A236 FE FF        	cp 255
  51+ A238 28 F8        	jr z, .wait
  52+ A23A AF           	xor a ;текстовый экран
  53+ A23B              	OS_SET_SCREEN
  53+ A23B 0E 1D       >    ld c,#1d
  53+ A23D E7          >    rst #20
  54+ A23E                  ;call TextMode.cls
  55+ A23E
  56+ A23E
  57+ A23E 3A 71 A4     	ld a,(page_main) ;основная страница
  58+ A241              	OS_SET_PAGE_SLOT3
  58+ A241 0E 1C       >    ld c,#1c
  58+ A243 E7          >    rst #20
  59+ A244
  60+ A244 AF           	xor a ;ok
  61+ A245 C9           	ret
  62+ A246                  ;jp History.back
  63+ A246
  64+ A246              ;    endmodule
  65+ A246
# file closed: nc_pic_view.asm
1778  A246
1779  A246              color_error equ 1*8+2 ;цвет ошибка
1780  A246              color_default equ 0*8+7 ;цвет обычный системный
1781  A246              color_view_text equ 4 ;цвет текста в просмотрщике
1782  A246              color_edit_text equ 4 ;цвет текста в редакторе
1783  A246              color_edit_cursor equ 4*8+0 ;цвет курсора в редакторе текста
1784  A246
1785  A246              color_backgr equ 1*8+7 ;цвет фона
1786  A246              color_apg equ 1*8+4 ;цвет приложений
1787  A246              color_dir equ 1*8+6 ;цвет папок
1788  A246
1789  A246              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1790  A246              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1791  A246              color_dir_hi equ 5*8+0 ;цвет папок курсор
1792  A246
1793  A246              file_info_lenght equ 255 ;длина инфо о файле
1794  A246              panel_hight equ 22;высота панели
1795  A246              panel_r_xy equ #0129
1796  A246              buffer_cat equ #c000 ;адрес буфера каталога
1797  A246
1798  A246              file_r_num_hyst_tabl_max equ 10 ;максимальная глубина истории положения курсора
1799  A246
1800  A246 00 00        file_r_all dw 0;всего файлов справа
1801  A248 00 00        file_r_cur_focus dw 0;первый видимый
1802  A24A 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1803  A34A 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1804  A44A 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1804  A44E 20 20 20 20
1804  A452 20 20 20 20
1804  A456 00
1805  A457 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1806  A458
1807  A458 00 00        file_r_num_cur dw 0 ;текущий файл справа
1808  A45A 00 00        file_r_num_old dw 0 ;текущий файл справа
1809  A45C 00 00        file_r_num_tmp dw 0 ;временно
1810  A45E 00           key_pressed db 0 ;последняя клавиша
1811  A45F 00           file_id_cur_r db 0 ;id файла справа
1812  A460 00           file_r_num_hyst_cur db 0 ;позиция в истории о номере текущего файла
1813  A461
1814  A461
1815  A461 00           page_ext01 db 0 ;номер дополнительной страницы
1816  A462 00           page_ext02_gzip db 0 ;номер дополнительной страницы
1817  A463
1818  A463 67 70 5F 67  gp_gzip_file_name db "gp_gzip.bin",0 ;часть плеера для режима моно, переносится в резервную страницу
1818  A467 7A 69 70 2E
1818  A46B 62 69 6E 00
1819  A46F 00 00        gp_gzip_file_size dw 0 ;размер части плеера
1820  A471
1821  A471 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1822  A473 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1823  A474 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1823  A478 20 20 20 20
1823  A47C 20 20 20 20
1823  A480 20 20 20 20
1823  A484 20 20 20 20
1823  A488 20 20 20 20
1823  A48C 20 20 00
1824  A48F
1825  A48F
1826  A48F              rect_1
1827  A48F C9           	db #c9
1828  A490              	dup 40-2
1829  A490 CD          >	db #cd
1829  A491 CD          >	db #cd
1829  A492 CD          >	db #cd
1829  A493 CD          >	db #cd
1829  A494 CD          >	db #cd
1829  A495 CD          >	db #cd
1829  A496 CD          >	db #cd
1829  A497 CD          >	db #cd
1829  A498 CD          >	db #cd
1829  A499 CD          >	db #cd
1829  A49A CD          >	db #cd
1829  A49B CD          >	db #cd
1829  A49C CD          >	db #cd
1829  A49D CD          >	db #cd
1829  A49E CD          >	db #cd
1829  A49F CD          >	db #cd
1829  A4A0 CD          >	db #cd
1829  A4A1 CD          >	db #cd
1829  A4A2 CD          >	db #cd
1829  A4A3 CD          >	db #cd
1829  A4A4 CD          >	db #cd
1829  A4A5 CD          >	db #cd
1829  A4A6 CD          >	db #cd
1829  A4A7 CD          >	db #cd
1829  A4A8 CD          >	db #cd
1829  A4A9 CD          >	db #cd
1829  A4AA CD          >	db #cd
1829  A4AB CD          >	db #cd
1829  A4AC CD          >	db #cd
1829  A4AD CD          >	db #cd
1829  A4AE CD          >	db #cd
1829  A4AF CD          >	db #cd
1829  A4B0 CD          >	db #cd
1829  A4B1 CD          >	db #cd
1829  A4B2 CD          >	db #cd
1829  A4B3 CD          >	db #cd
1829  A4B4 CD          >	db #cd
1829  A4B5 CD          >	db #cd
1830  A4B6              	edup
1831  A4B6 BB 00        	db #bb,0
1832  A4B8
1833  A4B8              rect_2
1834  A4B8 BA           	db #ba
1835  A4B9              	dup 40-2
1836  A4B9 20          >	db " "
1836  A4BA 20          >	db " "
1836  A4BB 20          >	db " "
1836  A4BC 20          >	db " "
1836  A4BD 20          >	db " "
1836  A4BE 20          >	db " "
1836  A4BF 20          >	db " "
1836  A4C0 20          >	db " "
1836  A4C1 20          >	db " "
1836  A4C2 20          >	db " "
1836  A4C3 20          >	db " "
1836  A4C4 20          >	db " "
1836  A4C5 20          >	db " "
1836  A4C6 20          >	db " "
1836  A4C7 20          >	db " "
1836  A4C8 20          >	db " "
1836  A4C9 20          >	db " "
1836  A4CA 20          >	db " "
1836  A4CB 20          >	db " "
1836  A4CC 20          >	db " "
1836  A4CD 20          >	db " "
1836  A4CE 20          >	db " "
1836  A4CF 20          >	db " "
1836  A4D0 20          >	db " "
1836  A4D1 20          >	db " "
1836  A4D2 20          >	db " "
1836  A4D3 20          >	db " "
1836  A4D4 20          >	db " "
1836  A4D5 20          >	db " "
1836  A4D6 20          >	db " "
1836  A4D7 20          >	db " "
1836  A4D8 20          >	db " "
1836  A4D9 20          >	db " "
1836  A4DA 20          >	db " "
1836  A4DB 20          >	db " "
1836  A4DC 20          >	db " "
1836  A4DD 20          >	db " "
1836  A4DE 20          >	db " "
1837  A4DF              	edup
1838  A4DF BA 00        	db #ba,0
1839  A4E1
1840  A4E1              rect_3
1841  A4E1 C8           	db #c8
1842  A4E2              	dup 40-2
1843  A4E2 CD          >	db #cd
1843  A4E3 CD          >	db #cd
1843  A4E4 CD          >	db #cd
1843  A4E5 CD          >	db #cd
1843  A4E6 CD          >	db #cd
1843  A4E7 CD          >	db #cd
1843  A4E8 CD          >	db #cd
1843  A4E9 CD          >	db #cd
1843  A4EA CD          >	db #cd
1843  A4EB CD          >	db #cd
1843  A4EC CD          >	db #cd
1843  A4ED CD          >	db #cd
1843  A4EE CD          >	db #cd
1843  A4EF CD          >	db #cd
1843  A4F0 CD          >	db #cd
1843  A4F1 CD          >	db #cd
1843  A4F2 CD          >	db #cd
1843  A4F3 CD          >	db #cd
1843  A4F4 CD          >	db #cd
1843  A4F5 CD          >	db #cd
1843  A4F6 CD          >	db #cd
1843  A4F7 CD          >	db #cd
1843  A4F8 CD          >	db #cd
1843  A4F9 CD          >	db #cd
1843  A4FA CD          >	db #cd
1843  A4FB CD          >	db #cd
1843  A4FC CD          >	db #cd
1843  A4FD CD          >	db #cd
1843  A4FE CD          >	db #cd
1843  A4FF CD          >	db #cd
1843  A500 CD          >	db #cd
1843  A501 CD          >	db #cd
1843  A502 CD          >	db #cd
1843  A503 CD          >	db #cd
1843  A504 CD          >	db #cd
1843  A505 CD          >	db #cd
1843  A506 CD          >	db #cd
1843  A507 CD          >	db #cd
1844  A508              	edup
1845  A508 BC 00        	db #bc,0
1846  A50A
1847  A50A              ;file_name_test db '486 HEART ON FIRE.vgm',0
1848  A50A              msg_menu_info
1849  A50A 0D 43 53 2B  	db 13,"CS+Enter - Play all",0
1849  A50E 45 6E 74 65
1849  A512 72 20 2D 20
1849  A516 50 6C 61 79
1849  A51A 20 61 6C 6C
1849  A51E 00
1850  A51F              msg_menu_main1
1851  A51F 20 4C 46 20  	db " LF On",0
1851  A523 4F 6E 00
1852  A526              msg_menu_main2
1853  A526 20 41 5A 20  	db " AZ On",0
1853  A52A 4F 6E 00
1854  A52D              msg_menu_main3
1855  A52D 20 56 69 65  	db " View ",0
1855  A531 77 20 00
1856  A534              msg_menu_main4
1857  A534 20 45 64 69  	db " Edit ",0
1857  A538 74 20 00
1858  A53B              msg_file_error
1859  A53B 46 69 6C 65  	db "File error",13,0
1859  A53F 20 65 72 72
1859  A543 6F 72 0D 00
1860  A547              msg_file_too_big
1861  A547 46 69 6C 65  	db "File too big",13,0
1861  A54B 20 74 6F 6F
1861  A54F 20 62 69 67
1861  A553 0D 00
1862  A555              msg_mem_err
1863  A555 47 65 74 20  	db "Get memory error",13,0
1863  A559 6D 65 6D 6F
1863  A55D 72 79 20 65
1863  A561 72 72 6F 72
1863  A565 0D 00
1864  A567              msg_mono_err
1865  A567 47 65 74 20  	db "Get mono mode error",13,0
1865  A56B 6D 6F 6E 6F
1865  A56F 20 6D 6F 64
1865  A573 65 20 65 72
1865  A577 72 6F 72 0D
1865  A57B 00
1866  A57C              msg_load_gzip
1867  A57C 4C 6F 61 64  	db "Load gzip",13,0
1867  A580 20 67 7A 69
1867  A584 70 0D 00
1868  A587
1869  A587              msg_title_nc
1870  A587 4E 6F 6E 65  	db "None Commander ver 2025.09.09",13,0
1870  A58B 20 43 6F 6D
1870  A58F 6D 61 6E 64
1870  A593 65 72 20 76
1870  A597 65 72 20 32
1870  A59B 30 32 35 2E
1870  A59F 30 39 2E 30
1870  A5A3 39 0D 00
1871  A5A6
1872  A5A6
1873  A5A6              start_gp_gzip equ #4000 ;рабочий адрес модуля для распаковки
1874  A5A6              start_gp_gzip_ext equ #c000 ;временный адрес модуля для распаковки
1875  A5A6
1876  A5A6
1877  A5A6
1878  A5A6              end_nc
1879  A5A6              	savebin "nc.apg",start_nc,$-start_nc
1880  A5A6
1881  A5A6              ;ниже не включается в файл
1882  A5A6
1883  A5A6 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1884  A9A6 00 00 00...  cat_index_2 ds 1024 ;буфер для индекса (вектора) сортировки 2
1885  ADA6 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1886  AEA6 00 00 00...  file_r_num_hyst_tabl ds file_r_num_hyst_tabl_max*4 ;таблица истории положения курсора справа
1887  AECE 00 00 00 00  	ds 4
1888  AED2
1889  AED2              free equ $ ;тут условно свободно
1890  AED2
1891  AED2
1892  AED2
1893  AED2              end_nc_all
1894  AED2
1895  AED2
1896  AED2
1897  AED2              	org 0xb800 ;
1898  B800              ;ещё тут буферы плеера VGM до адреса #bf00
1899  B800
1900  B800
# file closed: nc.asm
