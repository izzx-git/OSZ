# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000              ;например, плеера музыки
 200+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 201+ 0000              ;на время выполнения включаются обе страницы процесса
 202+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 203+ 0000 ~                ld c,#14
 204+ 0000 ~                rst #20
 205+ 0000                  endm
 206+ 0000
 207+ 0000
 208+ 0000              ;плеер AY ----------------------------
 209+ 0000
 210+ 0000              ;инициализация плеера AY;
 211+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 212+ 0000 ~                ld c,#15
 213+ 0000 ~                rst #20
 214+ 0000                  endm
 215+ 0000
 216+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 217+ 0000                  macro OS_VTPL_PLAY ;()
 218+ 0000 ~                ld c,#16
 219+ 0000 ~                rst #20
 220+ 0000                  endm
 221+ 0000
 222+ 0000              ;заглушить плеер AY;
 223+ 0000                  macro OS_VTPL_MUTE ;()
 224+ 0000 ~                ld c,#17
 225+ 0000 ~                rst #20
 226+ 0000                  endm
 227+ 0000
 228+ 0000              ;получить значение переменной плеера;
 229+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 230+ 0000 ~                ld c,#18
 231+ 0000 ~                rst #20
 232+ 0000                  endm
 233+ 0000
 234+ 0000
 235+ 0000              ;прочие ------------------------------
 236+ 0000
 237+ 0000
 238+ 0000              ;скопировать данные из страницы в страницу
 239+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 240+ 0000                  macro OS_RAM_COPY
 241+ 0000 ~                ld c,#19
 242+ 0000 ~                rst #20
 243+ 0000                  endm
 244+ 0000
 245+ 0000              ;получить дополнительную страницу памяти;
 246+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 247+ 0000 ~                ld c,#1a
 248+ 0000 ~                rst #20
 249+ 0000                  endm
 250+ 0000
 251+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 252+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 253+ 0000 ~                ld c,#1b
 254+ 0000 ~                rst #20
 255+ 0000                  endm
 256+ 0000
 257+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 258+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 259+ 0000 ~                ld c,#1c
 260+ 0000 ~                rst #20
 261+ 0000                  endm
 262+ 0000
 263+ 0000              ;включить экран N;
 264+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 265+ 0000              ;переключать может только приложение в фокусе
 266+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 267+ 0000              ;при переключении процессов сохраняется только экран #39
 268+ 0000                  macro OS_SET_SCREEN ;
 269+ 0000 ~                ld c,#1d
 270+ 0000 ~                rst #20
 271+ 0000                  endm
 272+ 0000
 273+ 0000
 274+ 0000              ;получить номера страниц процесса;
 275+ 0000              ;вх:
 276+ 0000              ;вых: b, c - страницы в слотах 2, 3
 277+ 0000                  macro OS_GET_MAIN_PAGES ;
 278+ 0000 ~                ld c,#1e
 279+ 0000 ~                rst #20
 280+ 0000                  endm
 281+ 0000
 282+ 0000              ;получить значение системного таймера
 283+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 284+ 0000 ~                ld c,#1F
 285+ 0000 ~                rst #20
 286+ 0000                  endm
 287+ 0000
 288+ 0000
 289+ 0000              ;освободить страницу памяти
 290+ 0000              ;вх: a - номер страницы
 291+ 0000                  macro OS_DEL_PAGE ;
 292+ 0000 ~                ld c,#20
 293+ 0000 ~                rst #20
 294+ 0000                  endm
 295+ 0000
 296+ 0000
 297+ 0000              ;дисковые операции -------------------
 298+ 0000
 299+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 300+ 0000
 301+ 0000              ; fcbFAT (из руководства к монитору)
 302+ 0000              ; формат fcb для работы с FAT
 303+ 0000
 304+ 0000              ; +#00 8 имя файла
 305+ 0000              ; +#08 3 расширение файла
 306+ 0000              ; +#0B 1 атрибуты файла
 307+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 308+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 309+ 0000              ; +#14 4 размер файла/каталога в байтах
 310+ 0000              ; +#18 4 указатель в файле
 311+ 0000              ; +#1C 1 для внутренних нужд
 312+ 0000              ; +#1D 1 для внутренних нужд
 313+ 0000              ; +#1E 1 резерв
 314+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 315+ 0000              	; 1-0,nn номер раздела
 316+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 317+ 0000              	    ; значение %11 недопустимо
 318+ 0000
 319+ 0000              ;открыть файл для чтения или записи
 320+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 321+ 0000 ~                ld c,#21
 322+ 0000 ~                rst #20
 323+ 0000                  endm
 324+ 0000
 325+ 0000              ;создать файл
 326+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 327+ 0000 ~                ld c,#22
 328+ 0000 ~                rst #20
 329+ 0000                  endm
 330+ 0000
 331+ 0000              ;прочитать из файла
 332+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 333+ 0000 ~                ld c,#23
 334+ 0000 ~                rst #20
 335+ 0000                  endm
 336+ 0000
 337+ 0000              ;записать в файл
 338+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 339+ 0000 ~                ld c,#24
 340+ 0000 ~                rst #20
 341+ 0000                  endm
 342+ 0000
 343+ 0000              ;закрыть файл
 344+ 0000                  macro OS_FILE_CLOSE ;A - id file
 345+ 0000 ~                ld c,#25
 346+ 0000 ~                rst #20
 347+ 0000                  endm
 348+ 0000
 349+ 0000              ;чтение секторов текущего каталога
 350+ 0000              ; вх:
 351+ 0000                   ; hl - буфер для чтения
 352+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 353+ 0000                   ; b - максимальное количество секторов для чтения
 354+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 355+ 0000                     ; a=errRWnum
 356+ 0000                     ; a=errInvalidPart
 357+ 0000                     ; a=errFileEmpty
 358+ 0000                   ; cy=0, a=errEoF - каталог закончился
 359+ 0000                     ; hl - следующий адрес в буфере
 360+ 0000                     ; de - номер первого непрочитанного сектора
 361+ 0000                     ; b - не прочитано секторов
 362+ 0000                   ; cy=0 - считано успешно
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b=#00
 366+ 0000                  macro OS_DIR_READ ;
 367+ 0000 ~                ld c,#26
 368+ 0000 ~                rst #20
 369+ 0000                  endm
 370+ 0000
 371+ 0000              ;вход в каталог/выход в родительский каталог
 372+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 373+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 374+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 375+ 0000              	; переход в родительский, последнее имя в пути удалится).
 376+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 377+ 0000              	; добавится имя файла
 378+ 0000              ; вх:
 379+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 380+ 0000                   ; de - адрес дескриптора директории/файла
 381+ 0000              ; вых: a - если путь был указан, новая длина пути
 382+ 0000                  macro OS_DIR_OPEN ;
 383+ 0000 ~                ld c,#27
 384+ 0000 ~                rst #20
 385+ 0000                  endm
 386+ 0000
 387+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 388+ 0000              ;проверки на допустимость значений не производится
 389+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 390+ 0000              ;вх: A - id файла
 391+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 392+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 393+ 0000                  macro OS_FILE_POSITION ;
 394+ 0000 ~                ld c,#28
 395+ 0000 ~                rst #20
 396+ 0000                  endm
 397+ 0000
 398+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 399+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 400+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 401+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 402+ 0000                  macro OS_FIND_PATH ;
 403+ 0000 ~                ld c,#29
 404+ 0000 ~                rst #20
 405+ 0000                  endm
 406+ 0000
 407+ 0000
 408+ 0000              ; получение длинного имени файла
 409+ 0000              ;вх: hl - адрес буфера для имени
 410+ 0000              ;    de - номер записи в текущем каталоге
 411+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 412+ 0000              ; 	a - длина имени, с учетом нуля
 413+ 0000                  macro OS_GET_LFN ;
 414+ 0000 ~                ld c,#2a
 415+ 0000 ~                rst #20
 416+ 0000                  endm
 417+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROG_START
   5  8000
   6  8000              start_nc
   7  8000 21 4A 9A     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 59 99  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 37 9A     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A
  24  801A CD AD 80     	call delay
  25  801D C3 AF 82     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 58 99     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023
  32  8023              start_nc_warm ;тёплый старт
  33  8023
  34  8023              	;очистка буфера
  35  8023 CD B3 80     	call clear_buf
  36  8026
  37  8026              	;загрузка каталога
  38  8026 21 00 C0     	ld hl,buffer_cat ;куда
  39  8029 11 00 00     	ld de,0 ;начиная с 0 сектора
  40  802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  41  802E              	OS_DIR_READ
  41  802E 0E 26       >    ld c,#26
  41  8030 E7          >    rst #20
  42  8031
  43  8031 21 00 00     	ld hl,0 ;обнулить переменные
  44  8034 22 54 99     	ld (file_r_num_cur),hl
  45  8037 22 42 97     	ld (file_r_all),hl
  46  803A 22 44 97     	ld (file_r_cur_focus),hl
  47  803D
  48  803D CD 08 84     	call sort_dir
  49  8040
  50  8040 3E 0F        	ld a,color_backgr
  51  8042 06 0C        	ld b,#c
  52  8044              	OS_SET_COLOR
  52  8044 0E 06       >    ld c,#06
  52  8046 E7          >    rst #20
  53  8047
  54  8047 CD 8D 85     	call print_rect_r ;рамка
  55  804A CD 10 83     	call print_panel_r
  56  804D CD C2 85     	call print_menu_main
  57  8050
  58  8050 11 00 01     	ld de,#0100
  59  8053              	OS_SET_XY
  59  8053 0E 01       >    ld c,#01
  59  8055 E7          >    rst #20
  60  8056
  61  8056 21 F2 99     	ld hl,msg_menu_info
  62  8059              	OS_PRINTZ
  62  8059 0E 09       >    ld c,#09
  62  805B E7          >    rst #20
  63  805C
  64  805C
  65  805C
  66  805C              nc_wait
  67  805C              	OS_WAIT ;ждать прерывание
  67  805C DF          >	rst #18
  68  805D
  69  805D              	OS_GET_CHAR ;клавиша
  69  805D 0E 10       >    ld c,#10
  69  805F E7          >    rst #20
  70  8060 32 56 99     	ld (key_pressed),a ;запомнить
  71  8063 FE 0D        	cp 13
  72  8065 CA 14 81     	jp z,key_enter ;
  73  8068 FE 0A        	cp 10 ;вниз
  74  806A CC 1B 82     	call z,key_down
  75  806D FE 0B        	cp 11 ;вверх
  76  806F CC 58 82     	call z,key_up
  77  8072 FE 09        	cp 09 ;вправо
  78  8074 CC 9D 82     	call z,key_right
  79  8077 FE 08        	cp 08 ;влево
  80  8079 CC 8B 82     	call z,key_left
  81  807C FE 04        	cp 04 ;страница вверх
  82  807E CC 8B 82     	call z,key_left
  83  8081 FE 05        	cp 05 ;страница вниз
  84  8083 CC 9D 82     	call z,key_right
  85  8086 FE 31        	cp "1" ;переключение длинных имён (LFN)
  86  8088 CA 3B 85     	jp z,LFN_toggle
  87  808B FE 32        	cp "2" ;переключение сортировки
  88  808D CA 1B 85     	jp z,sort_toggle
  89  8090 FE 33        	cp "3" ;просмотр файла
  90  8092 CA 10 86     	jp z,view_file
  91  8095 FE 19        	cp 25 ;CS+Enter
  92  8097 CA A1 81     	jp z,nc_play_all
  93  809A FE 18        	cp 24 ;break
  94  809C CA AF 82     	jp z,exit
  95  809F
  96  809F
  97  809F 3A 5B 99     	ld a,(print_panel_r_flag)
  98  80A2 B7           	or a
  99  80A3 C4 10 83     	call nz,print_panel_r ;обновить каталог
 100  80A6 AF           	xor a
 101  80A7 32 5B 99     	ld (print_panel_r_flag),a
 102  80AA
 103  80AA C3 5C 80     	jp nc_wait ;на цикл ожидания
 104  80AD
 105  80AD
 106  80AD              delay ;задержка
 107  80AD 06 96        	ld b,50*3 ;
 108  80AF              delay1
 109  80AF              	OS_WAIT
 109  80AF DF          >	rst #18
 110  80B0 10 FD        	djnz delay1
 111  80B2 C9           	ret
 112  80B3
 113  80B3
 114  80B3              clear_buf
 115  80B3 21 00 C0     	ld hl,buffer_cat
 116  80B6 11 01 C0     	ld de,buffer_cat+1
 117  80B9 01 FF 3F     	ld bc,#4000-1
 118  80BC 36 00        	ld (hl),0
 119  80BE ED B0        	ldir
 120  80C0 C9           	ret
 121  80C1
 122  80C1
 123  80C1              ;очистить левую панель
 124  80C1              clear_left_panel
 125  80C1 3E 0F        	ld a,color_backgr ;цвет
 126  80C3 06 0C        	ld b,#c
 127  80C5              	OS_SET_COLOR
 127  80C5 0E 06       >    ld c,#06
 127  80C7 E7          >    rst #20
 128  80C8 06 18        	ld b,panel_hight+2 ;высота
 129  80CA 11 00 00     	ld de,0
 130  80CD              	OS_SET_XY
 130  80CD 0E 01       >    ld c,#01
 130  80CF E7          >    rst #20
 131  80D0              clear_left_panel_cl
 132  80D0 C5           	push bc
 133  80D1 21 E1 80     	ld hl,txt_clear_panel
 134  80D4              	OS_PRINTZ
 134  80D4 0E 09       >    ld c,#09
 134  80D6 E7          >    rst #20
 135  80D7 C1           	pop bc
 136  80D8 10 F6        	djnz clear_left_panel_cl
 137  80DA 11 00 00     	ld de,0
 138  80DD              	OS_SET_XY
 138  80DD 0E 01       >    ld c,#01
 138  80DF E7          >    rst #20
 139  80E0 C9           	ret
 140  80E1 20 20 20 20  txt_clear_panel db "                                        ",13,0 ;40 пробелов
 140  80E5 20 20 20 20
 140  80E9 20 20 20 20
 140  80ED 20 20 20 20
 140  80F1 20 20 20 20
 140  80F5 20 20 20 20
 140  80F9 20 20 20 20
 140  80FD 20 20 20 20
 140  8101 20 20 20 20
 140  8105 20 20 20 20
 140  8109 0D 00
 141  810B
 142  810B
 143  810B              release_key ;ждать отпускания клавиши
 144  810B              	OS_WAIT
 144  810B DF          >	rst #18
 145  810C              	OS_GET_CHAR
 145  810C 0E 10       >    ld c,#10
 145  810E E7          >    rst #20
 146  810F FE FF        	cp 255
 147  8111 20 F8        	jr nz,release_key
 148  8113 C9           	ret
 149  8114
 150  8114
 151  8114              key_enter
 152  8114              	;нажата Enter
 153  8114 2A 42 97     	ld hl,(file_r_all)
 154  8117 7D           	ld a,l
 155  8118 B4           	or h
 156  8119 CA 9E 81     	jp z,key_enter_ex ;защита
 157  811C 2A 54 99     	ld hl,(file_r_num_cur)
 158  811F CD 0E 82     	call calc_deskr
 159  8122 DD 7E 0B     	ld a,(ix+#0b)
 160  8125 FE 10        	cp #10 ;признак каталога
 161  8127 CA 01 82     	jp z,key_enter_dir
 162  812A
 163  812A FE 30        	cp #30 ;признак каталога
 164  812C CA 01 82     	jp z,key_enter_dir
 165  812F
 166  812F
 167  812F CD 58 85     	call format_name
 168  8132
 169  8132              	;проверка расширения APG
 170  8132 CD B3 82     	call check_apg
 171  8135 C2 48 81     	jp nz,key_enter_1
 172  8138              	;тут запуск приложения
 173  8138 21 46 97     	ld hl,file_name_cur		;строка с именем
 174  813B              	OS_PROC_RUN ;запустить прогу
 174  813B 0E 11       >    ld c,#11
 174  813D E7          >    rst #20
 175  813E              	;обработка ошибки
 176  813E 38 5E        	jr c,key_enter_ex
 177  8140
 178  8140 DD 7E 00     	ld a,(ix)
 179  8143              	OS_PROC_SET_FOCUS ;на передний план
 179  8143 0E 12       >    ld c,#12
 179  8145 E7          >    rst #20
 180  8146 18 56        	jr key_enter_ex
 181  8148
 182  8148
 183  8148
 184  8148              key_enter_1
 185  8148              	;проверка расширения VGM
 186  8148 CD D2 82     	call check_vgm
 187  814B C2 62 81     	jp nz,key_enter_2
 188  814E
 189  814E CD C1 80     	call clear_left_panel ;почистить часть экрана
 190  8151
 191  8151 3A 58 99     	ld a,(page_ext01) ;доп страница для данных плеера
 192  8154              	OS_SET_PAGE_SLOT3
 192  8154 0E 1C       >    ld c,#1c
 192  8156 E7          >    rst #20
 193  8157
 194  8157 CD FE 88     	call start_gplay
 195  815A
 196  815A 3A 59 99     	ld a,(page_main) ;основная страница
 197  815D              	OS_SET_PAGE_SLOT3
 197  815D 0E 1C       >    ld c,#1c
 197  815F E7          >    rst #20
 198  8160
 199  8160 18 3C        	jr key_enter_ex
 200  8162
 201  8162
 202  8162              key_enter_2
 203  8162              	;проверка расширения SCR
 204  8162 CD F1 82     	call check_scr
 205  8165 C2 9E 81     	jp nz,key_enter_3
 206  8168
 207  8168
 208  8168 3A 58 99     	ld a,(page_ext01) ;доп страница для данных плеера
 209  816B              	OS_SET_PAGE_SLOT3
 209  816B 0E 1C       >    ld c,#1c
 209  816D E7          >    rst #20
 210  816E
 211  816E 21 46 97     	ld hl,file_name_cur		;строка с именем
 212  8171              	OS_FILE_OPEN
 212  8171 0E 21       >    ld c,#21
 212  8173 E7          >    rst #20
 213  8174 30 09        	jr nc,key_enter_2_file_open_ok
 214  8176              key_enter_2_file_error
 215  8176 21 1B 9A     	ld hl,msg_file_error
 216  8179              	OS_PRINTZ
 216  8179 0E 09       >    ld c,#09
 216  817B E7          >    rst #20
 217  817C              	; ld b,2*50
 218  817C              	; call delay1
 219  817C C3 9E 81     	jp key_enter_ex
 220  817F
 221  817F              key_enter_2_file_open_ok
 222  817F 32 57 99     	ld (file_id_cur_r),a
 223  8182 11 00 1B     	ld de,6912
 224  8185 21 00 C0     	ld hl,#c000
 225  8188              	;ld a,(file_id_cur_r)
 226  8188              	OS_FILE_READ ;загрузить
 226  8188 0E 23       >    ld c,#23
 226  818A E7          >    rst #20
 227  818B 38 E9        	jr c,key_enter_2_file_error
 228  818D 3A 57 99     	ld a,(file_id_cur_r)
 229  8190              	OS_FILE_CLOSE
 229  8190 0E 25       >    ld c,#25
 229  8192 E7          >    rst #20
 230  8193
 231  8193 CD 19 97     	call display ;показать
 232  8196
 233  8196 3A 59 99     	ld a,(page_main) ;основная страница
 234  8199              	OS_SET_PAGE_SLOT3
 234  8199 0E 1C       >    ld c,#1c
 234  819B E7          >    rst #20
 235  819C
 236  819C 18 00        	jr key_enter_ex
 237  819E
 238  819E
 239  819E              key_enter_3
 240  819E
 241  819E
 242  819E
 243  819E
 244  819E              key_enter_ex
 245  819E C3 5C 80     	jp nc_wait
 246  81A1
 247  81A1
 248  81A1
 249  81A1
 250  81A1
 251  81A1
 252  81A1
 253  81A1              nc_play_all
 254  81A1              	;Воспроизведение всего по порядку
 255  81A1 2A 42 97     	ld hl,(file_r_all)
 256  81A4 7D           	ld a,l
 257  81A5 B4           	or h
 258  81A6 CA E7 81     	jp z,nc_play_ex ;защита
 259  81A9 2A 54 99     	ld hl,(file_r_num_cur)
 260  81AC CD 0E 82     	call calc_deskr
 261  81AF DD 7E 0B     	ld a,(ix+#0b)
 262  81B2 FE 10        	cp #10 ;признак каталога
 263  81B4 28 34        	jr z,nc_play_all_down
 264  81B6
 265  81B6 FE 30        	cp #30 ;признак каталога
 266  81B8 28 30        	jr z,nc_play_all_down
 267  81BA
 268  81BA
 269  81BA CD 58 85     	call format_name
 270  81BD
 271  81BD              nc_play_1
 272  81BD              	;проверка расширения ;VGM
 273  81BD CD D2 82     	call check_vgm
 274  81C0 C2 E5 81     	jp nz,nc_play_2
 275  81C3
 276  81C3 CD C1 80     	call clear_left_panel ;почистить часть экрана
 277  81C6
 278  81C6 3A 58 99     	ld a,(page_ext01) ;доп страница для данных плеера
 279  81C9              	OS_SET_PAGE_SLOT3
 279  81C9 0E 1C       >    ld c,#1c
 279  81CB E7          >    rst #20
 280  81CC
 281  81CC CD FE 88     	call start_gplay
 282  81CF
 283  81CF F5           	push af
 284  81D0 3A 59 99     	ld a,(page_main) ;основная страница
 285  81D3              	OS_SET_PAGE_SLOT3
 285  81D3 0E 1C       >    ld c,#1c
 285  81D5 E7          >    rst #20
 286  81D6 F1           	pop af
 287  81D7 FE 73        	cp "s"
 288  81D9 28 0C        	jr z,nc_play_ex
 289  81DB FE 53        	cp "S"
 290  81DD 28 08        	jr z,nc_play_ex
 291  81DF FE 18        	cp 24 ;break
 292  81E1 28 04        	jr z,nc_play_ex
 293  81E3
 294  81E3 18 05        	jr nc_play_all_down
 295  81E5
 296  81E5
 297  81E5              nc_play_2
 298  81E5 18 03        	jr nc_play_all_down
 299  81E7
 300  81E7
 301  81E7
 302  81E7              nc_play_ex
 303  81E7 C3 5C 80     	jp nc_wait
 304  81EA
 305  81EA
 306  81EA              nc_play_all_down ;вниз по списку
 307  81EA ED 4B 54 99  	ld bc,(file_r_num_cur)
 308  81EE C5           	push bc
 309  81EF CD 1B 82     	call key_down
 310  81F2 CD 10 83     	call print_panel_r ;обновить каталог
 311  81F5 C1           	pop bc
 312  81F6 2A 54 99     	ld hl,(file_r_num_cur)
 313  81F9 A7           	and a
 314  81FA ED 42        	sbc hl,bc ;если не сдвинулась позиция, то всё
 315  81FC 28 E9        	jr z,nc_play_ex
 316  81FE C3 A1 81     	jp nc_play_all
 317  8201
 318  8201
 319  8201
 320  8201
 321  8201
 322  8201
 323  8201
 324  8201
 325  8201              key_enter_dir
 326  8201              	;тут открытие папки
 327  8201
 328  8201              	;call format_name_dir
 329  8201 EB           	ex de,hl ;de - дескриптор для открытия
 330  8202 21 46 98     	ld hl,dir_name_cur
 331  8205              	OS_DIR_OPEN
 331  8205 0E 27       >    ld c,#27
 331  8207 E7          >    rst #20
 332  8208 38 94        	jr c,key_enter_ex ;если ошибка, ничего не делаем
 333  820A
 334  820A E1           	pop hl ;отменить возврат
 335  820B C3 23 80     	jp start_nc_warm ;перезагрузить папку
 336  820E
 337  820E
 338  820E              ; format_name_dir
 339  820E              	; push hl
 340  820E              	; ld hl,file_name_cur
 341  820E              	; ld de,file_name_cur+1 ;почистить
 342  820E              	; ld bc,256-1
 343  820E              	; ld (hl),0
 344  820E              	; ldir
 345  820E
 346  820E              	; pop hl
 347  820E
 348  820E              	; ld de,file_name_cur ;куда
 349  820E              	; ld bc,#08ff
 350  820E              ; format_name_dir_cl
 351  820E              	; ld a,(hl)
 352  820E              	; cp " "+1
 353  820E              	; jr c,format_name_dir_skip
 354  820E              	; ldi
 355  820E              	; djnz format_name_dir_cl
 356  820E              ; format_name_dir_skip
 357  820E              	; ld a,'/'
 358  820E              	; ld (de),a
 359  820E              	; ret
 360  820E
 361  820E               ;вычислить дескриптор текущего элемента справа
 362  820E              calc_deskr
 363  820E 29           	add hl,hl ;*2
 364  820F 01 6A 9A     	ld bc,cat_index
 365  8212 09           	add hl,bc
 366  8213 5E           	ld e,(hl)
 367  8214 23           	inc hl
 368  8215 56           	ld d,(hl)
 369  8216 EB           	ex de,hl ;hl - адрес элемента
 370  8217 E5           	push hl
 371  8218 DD E1        	pop ix ;ix- адрес элемента
 372  821A C9           	ret
 373  821B
 374  821B
 375  821B
 376  821B
 377  821B              key_down
 378  821B 2A 42 97     	ld hl,(file_r_all)
 379  821E 7D           	ld a,l
 380  821F B4           	or h
 381  8220 CA 54 82     	jp z,key_down_ex ;защита
 382  8223
 383  8223 ED 4B 54 99  	ld bc,(file_r_num_cur)
 384  8227 03           	inc bc
 385  8228 2A 42 97     	ld hl,(file_r_all)
 386  822B              	;если не больше чем всего
 387  822B A7           	and a
 388  822C ED 42        	sbc hl,bc
 389  822E 38 24        	jr c,key_down_skip
 390  8230 28 22        	jr z,key_down_skip
 391  8232              	;прибавить
 392  8232 ED 43 54 99  	ld (file_r_num_cur),bc
 393  8236
 394  8236              	;теперь передвинуть фокус, если надо
 395  8236 2A 44 97     	ld hl,(file_r_cur_focus)
 396  8239 01 16 00     	ld bc,panel_hight
 397  823C 09           	add hl,bc ;прибавить количество видимых
 398  823D ED 4B 54 99  	ld bc,(file_r_num_cur)
 399  8241 A7           	and a
 400  8242 ED 42        	sbc hl,bc ;вычесть положение курсора
 401  8244 28 02        	jr z,key_down_change_focus_yes
 402  8246 30 07        	jr nc,key_down_change_focus_no
 403  8248              key_down_change_focus_yes
 404  8248              	;передвинуть фокус
 405  8248 2A 44 97     	ld hl,(file_r_cur_focus)
 406  824B 23           	inc hl
 407  824C 22 44 97     	ld (file_r_cur_focus),hl
 408  824F
 409  824F              key_down_change_focus_no
 410  824F 3E 01        	ld a,1
 411  8251 32 5B 99     	ld (print_panel_r_flag),a
 412  8254              	;call print_panel_r ;обновить каталог
 413  8254              key_down_skip
 414  8254
 415  8254              key_down_ex
 416  8254 3A 56 99     	ld a,(key_pressed)
 417  8257 C9           	ret
 418  8258
 419  8258
 420  8258
 421  8258              key_up ;вверх
 422  8258 2A 42 97     	ld hl,(file_r_all)
 423  825B 7D           	ld a,l
 424  825C B4           	or h
 425  825D CA 87 82     	jp z,key_up_ex ;защита
 426  8260
 427  8260 2A 54 99     	ld hl,(file_r_num_cur)
 428  8263 7D           	ld a,l
 429  8264 B4           	or h
 430  8265 28 20        	jr z,key_up_skip
 431  8267 2B           	dec hl
 432  8268 22 54 99     	ld (file_r_num_cur),hl
 433  826B
 434  826B              	;теперь передвинуть фокус, если надо
 435  826B 2A 54 99     	ld hl,(file_r_num_cur)
 436  826E              	; ld bc,panel_hight
 437  826E              	; add hl,bc ;прибавить количество видимых
 438  826E ED 4B 44 97  	ld bc,(file_r_cur_focus)
 439  8272 A7           	and a
 440  8273 ED 42        	sbc hl,bc ;вычесть положение курсора
 441  8275              	;jr z,key_up_change_foces_yes
 442  8275 30 0B        	jr nc,key_up_change_foces_no
 443  8277              key_up_change_foces_yes
 444  8277              	;передвинуть фокус
 445  8277 2A 44 97     	ld hl,(file_r_cur_focus)
 446  827A 7C           	ld a,h
 447  827B B5           	or l
 448  827C 28 04        	jr z,key_up_change_foces_no ;защита
 449  827E 2B           	dec hl
 450  827F 22 44 97     	ld (file_r_cur_focus),hl
 451  8282
 452  8282              key_up_change_foces_no
 453  8282
 454  8282 3E 01        	ld a,1
 455  8284 32 5B 99     	ld (print_panel_r_flag),a
 456  8287              	;call print_panel_r ;обновить каталог
 457  8287              key_up_skip
 458  8287
 459  8287              key_up_ex
 460  8287 3A 56 99     	ld a,(key_pressed)
 461  828A C9           	ret
 462  828B
 463  828B
 464  828B              key_left ;на страницу назад
 465  828B 06 15        	ld b,panel_hight-1
 466  828D              key_left_cl
 467  828D C5           	push bc
 468  828E CD 58 82     	call key_up
 469  8291 C1           	pop bc
 470  8292 10 F9        	djnz key_left_cl
 471  8294 3E 01        	ld a,1
 472  8296 32 5B 99     	ld (print_panel_r_flag),a
 473  8299 3A 56 99     	ld a,(key_pressed)
 474  829C C9           	ret
 475  829D
 476  829D
 477  829D
 478  829D              key_right ;на страницу вперёд
 479  829D 06 15        	ld b,panel_hight-1
 480  829F              key_right_cl
 481  829F C5           	push bc
 482  82A0 CD 1B 82     	call key_down
 483  82A3 C1           	pop bc
 484  82A4 10 F9        	djnz key_right_cl
 485  82A6 3E 01        	ld a,1
 486  82A8 32 5B 99     	ld (print_panel_r_flag),a
 487  82AB 3A 56 99     	ld a,(key_pressed)
 488  82AE C9           	ret
 489  82AF
 490  82AF
 491  82AF
 492  82AF              exit ;выход в DOS
 493  82AF AF           	xor a
 494  82B0              	OS_PROC_CLOSE
 494  82B0 0E 13       >    ld c,#13
 494  82B2 E7          >    rst #20
 495  82B3
 496  82B3
 497  82B3
 498  82B3              check_apg ;проверка на расширение APG
 499  82B3 DD 7E 08     	ld a,(ix+8)
 500  82B6 FE 61        	cp "a"
 501  82B8 28 03        	jr z,check_apg1
 502  82BA FE 41        	cp "A"
 503  82BC C0           	ret nz
 504  82BD              check_apg1
 505  82BD DD 7E 09     	ld a,(ix+9)
 506  82C0 FE 70        	cp "p"
 507  82C2 28 03        	jr z,check_apg2
 508  82C4 FE 50        	cp "P"
 509  82C6 C0           	ret nz
 510  82C7              check_apg2
 511  82C7 DD 7E 0A     	ld a,(ix+10)
 512  82CA FE 67        	cp "g"
 513  82CC C8           	ret z
 514  82CD FE 47        	cp "G"
 515  82CF C0           	ret nz
 516  82D0 AF           	xor a ;равен
 517  82D1 C9           	ret
 518  82D2
 519  82D2
 520  82D2              check_vgm ;проверка на расширение VGM
 521  82D2 DD 7E 08     	ld a,(ix+8)
 522  82D5 FE 76        	cp "v"
 523  82D7 28 03        	jr z,check_vgm1
 524  82D9 FE 56        	cp "V"
 525  82DB C0           	ret nz
 526  82DC              check_vgm1
 527  82DC DD 7E 09     	ld a,(ix+9)
 528  82DF FE 67        	cp "g"
 529  82E1 28 03        	jr z,check_vgm2
 530  82E3 FE 47        	cp "G"
 531  82E5 C0           	ret nz
 532  82E6              check_vgm2
 533  82E6 DD 7E 0A     	ld a,(ix+10)
 534  82E9 FE 6D        	cp "m"
 535  82EB C8           	ret z
 536  82EC FE 4D        	cp "M"
 537  82EE C0           	ret nz
 538  82EF AF           	xor a ;равен
 539  82F0 C9           	ret
 540  82F1
 541  82F1
 542  82F1              check_scr ;проверка на расширение SCR
 543  82F1 DD 7E 08     	ld a,(ix+8)
 544  82F4 FE 73        	cp "s"
 545  82F6 28 03        	jr z,check_scr1
 546  82F8 FE 53        	cp "S"
 547  82FA C0           	ret nz
 548  82FB              check_scr1
 549  82FB DD 7E 09     	ld a,(ix+9)
 550  82FE FE 63        	cp "c"
 551  8300 28 03        	jr z,check_scr2
 552  8302 FE 43        	cp "C"
 553  8304 C0           	ret nz
 554  8305              check_scr2
 555  8305 DD 7E 0A     	ld a,(ix+10)
 556  8308 FE 72        	cp "r"
 557  830A C8           	ret z
 558  830B FE 52        	cp "R"
 559  830D C0           	ret nz
 560  830E AF           	xor a ;равен
 561  830F C9           	ret
 562  8310
 563  8310
 564  8310
 565  8310              print_panel_r ;печать правой панели
 566  8310              	;ld ix,buffer_cat
 567  8310 FD 2A 42 97  	ld iy,(file_r_all) ;всего файлов
 568  8314 FD 7D        	ld a,iyl
 569  8316 FD B4        	or iyh
 570  8318 C8           	ret z ;защита если 0
 571  8319 11 29 01     	ld de,panel_r_xy ;координаты yx
 572  831C 06 16        	ld b,panel_hight ;высота панели
 573  831E FD 2A 44 97  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 574  8322              print_panel_r_cl ;цикл
 575  8322 C5           	push bc
 576  8323 D5           	push de ;xy
 577  8324              	OS_SET_XY
 577  8324 0E 01       >    ld c,#01
 577  8326 E7          >    rst #20
 578  8327
 579  8327              	;получить адрес элемента
 580  8327 FD E5        	push iy
 581  8329 E1           	pop hl
 582  832A CD 0E 82     	call calc_deskr
 583  832D
 584  832D CD 48 83     	call print_file_info ;напечатать строку
 585  8330              print_panel_r_skip
 586  8330 D1           	pop de
 587  8331 14           	inc d ;y++
 588  8332 FD 23        	inc iy ;текущий файл
 589  8334              	;проверка на конец каталога
 590  8334 2A 42 97     	ld hl,(file_r_all)
 591  8337 FD E5        	push iy
 592  8339 C1           	pop bc
 593  833A A7           	and a
 594  833B ED 42        	sbc hl,bc
 595  833D C1           	pop bc
 596  833E 38 07        	jr c,print_panel_r_ex2
 597  8340 28 05        	jr z,print_panel_r_ex2
 598  8342 10 DE        	djnz print_panel_r_cl
 599  8344 C9           	ret
 600  8345              print_panel_r_ex
 601  8345 D1           	pop de
 602  8346 C1           	pop bc
 603  8347              print_panel_r_ex2
 604  8347              	;тут, возможно, надо допечатать пустые строки
 605  8347 C9           	ret
 606  8348
 607  8348
 608  8348
 609  8348
 610  8348
 611  8348              print_file_info ;печать строки о файле
 612  8348 3A 57 85     	ld a,(LFN_enable_flag)
 613  834B B7           	or a
 614  834C 28 4D        	jr z,print_file_info_SFN
 615  834E
 616  834E
 617  834E
 618  834E              print_file_info_LFN ;печать длинного имени
 619  834E              	;узнать номер записи
 620  834E 01 00 C0     	ld bc,#c000
 621  8351 A7           	and a
 622  8352 ED 42        	sbc hl,bc
 623  8354              ;разделить на 32
 624  8354 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 625  8356 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 626  8358 CB 3C        	srl h ; /4
 627  835A CB 1D        	rr l ;
 628  835C CB 3C        	srl h ; /8
 629  835E CB 1D        	rr l ;
 630  8360 CB 3C        	srl h ; /16
 631  8362 CB 1D        	rr l ;
 632  8364 CB 3C        	srl h ; /32
 633  8366 CB 1D        	rr l ;
 634  8368
 635  8368
 636  8368 EB           	ex de,hl ;de - порядковый номер записи
 637  8369
 638  8369 21 6A 9E     	ld hl,file_info_string ;куда
 639  836C              	OS_GET_LFN ;получить длинное имя
 639  836C 0E 2A       >    ld c,#2a
 639  836E E7          >    rst #20
 640  836F
 641  836F CD C3 83     	call get_color_item
 642  8372
 643  8372 06 0C        	ld b,#c
 644  8374              	OS_SET_COLOR
 644  8374 0E 06       >    ld c,#06
 644  8376 E7          >    rst #20
 645  8377
 646  8377              	;печать не длиннее 80/2 символов
 647  8377 21 6A 9E     	ld hl,file_info_string
 648  837A 06 26        	ld b,80/2-2
 649  837C 0E 28        	ld c,40 ;колонка
 650  837E              print_file_info_LFN_cl
 651  837E E5           	push hl
 652  837F C5           	push bc
 653  8380 7E           	ld a,(hl)
 654  8381 B7           	or a
 655  8382 28 09        	jr z,print_file_info_LFN_cl_ex
 656  8384              	OS_PRINT_CHARF
 656  8384 D7          >	rst #10
 657  8385 C1           	pop bc
 658  8386 0C           	inc c
 659  8387 E1           	pop hl
 660  8388 23           	inc hl
 661  8389 10 F3        	djnz print_file_info_LFN_cl
 662  838B 18 02        	jr print_file_info_LFN_ex
 663  838D              print_file_info_LFN_cl_ex
 664  838D C1           	pop bc
 665  838E E1           	pop hl
 666  838F              print_file_info_LFN_ex
 667  838F              	;допечатать пробелы до правого края, зависит от длины имени
 668  838F              print_file_info_LFN_cl2
 669  838F 79           	ld a,c
 670  8390 FE 4E        	cp 80-2
 671  8392 D0           	ret nc
 672  8393 C5           	push bc
 673  8394 3E 20        	ld a,' '
 674  8396              	OS_PRINT_CHARF
 674  8396 D7          >	rst #10
 675  8397 C1           	pop bc
 676  8398 0C           	inc c
 677  8399 18 F4        	jr print_file_info_LFN_cl2
 678  839B
 679  839B
 680  839B
 681  839B              print_file_info_SFN ;печать короткого имени
 682  839B 11 6A 9E     	ld de,file_info_string ;скопировать
 683  839E 01 08 00     	ld bc,8 ;file_info_lenght
 684  83A1 ED B0        	ldir
 685  83A3 3E 20        	ld a,' '
 686  83A5 12           	ld (de),a
 687  83A6 13           	inc de
 688  83A7 01 03 00     	ld bc,3
 689  83AA ED B0        	ldir
 690  83AC AF           	xor a
 691  83AD 12           	ld (de),a
 692  83AE
 693  83AE CD C3 83     	call get_color_item
 694  83B1
 695  83B1 06 0C        	ld b,#c
 696  83B3              	OS_SET_COLOR
 696  83B3 0E 06       >    ld c,#06
 696  83B5 E7          >    rst #20
 697  83B6 21 6A 9E     	ld hl,file_info_string
 698  83B9              	OS_PRINTZ
 698  83B9 0E 09       >    ld c,#09
 698  83BB E7          >    rst #20
 699  83BC              	;допечатать пробелы до правого края, длина имени постоянная
 700  83BC 21 5C 99     	ld hl,file_info_string_SFN_end
 701  83BF              	OS_PRINTZ
 701  83BF 0E 09       >    ld c,#09
 701  83C1 E7          >    rst #20
 702  83C2 C9           	ret
 703  83C3
 704  83C3
 705  83C3
 706  83C3              get_color_item ;получить цвет элемента
 707  83C3              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 708  83C3              ;вых: A - цвет
 709  83C3 ED 4B 54 99  	ld bc,(file_r_num_cur) ;позиция курсора справа
 710  83C7 FD E5        	push iy
 711  83C9 E1           	pop hl
 712  83CA A7           	and a
 713  83CB ED 42        	sbc hl,bc ;сравнить
 714  83CD 28 11        	jr z,get_color_item_no_cursor
 715  83CF              	;цвета курсора
 716  83CF 3E 0E        	ld a,color_dir ;простая
 717  83D1 32 FB 83     	ld (get_color_item_dir+1),a
 718  83D4 3E 0C        	ld a,color_apg ;простая
 719  83D6 32 03 84     	ld (get_color_item_apg+1),a
 720  83D9 3E 0F        	ld a,color_backgr ;простая
 721  83DB 32 06 84     	ld (get_color_item_backgr+1),a
 722  83DE 18 0F        	jr get_color_item_set
 723  83E0
 724  83E0              get_color_item_no_cursor
 725  83E0              	;цвета обычные
 726  83E0 3E 28        	ld a,color_dir_hi ;под курсором
 727  83E2 32 FB 83     	ld (get_color_item_dir+1),a
 728  83E5 3E 28        	ld a,color_apg_hi ;под курсором
 729  83E7 32 03 84     	ld (get_color_item_apg+1),a
 730  83EA 3E 28        	ld a,color_backgr_hi ;под курсором
 731  83EC 32 06 84     	ld (get_color_item_backgr+1),a
 732  83EF
 733  83EF              get_color_item_set
 734  83EF              	;задать цвет
 735  83EF DD 7E 0B     	ld a,(ix+#0b)
 736  83F2 FE 10        	cp #10 ;признак каталога
 737  83F4 28 04        	jr z,get_color_item_dir
 738  83F6 FE 30        	cp #30 ;признак каталога
 739  83F8 20 03        	jr nz,get_color_item_no_dir
 740  83FA              	;если папка
 741  83FA              get_color_item_dir
 742  83FA 3E 00        	ld a,0
 743  83FC C9           	ret
 744  83FD
 745  83FD              get_color_item_no_dir
 746  83FD CD B3 82     	call check_apg ;расширение apg
 747  8400 20 03        	jr nz,get_color_item_no_apg
 748  8402              	;если приложение
 749  8402              get_color_item_apg
 750  8402 3E 00        	ld a,0
 751  8404 C9           	ret
 752  8405
 753  8405              get_color_item_no_apg
 754  8405              	;если обычный файл
 755  8405              get_color_item_backgr
 756  8405 3E 00        	ld a,0
 757  8407 C9           	ret
 758  8408
 759  8408
 760  8408
 761  8408              ; format_dir ;подготовить каталог, убрать лишнее
 762  8408              	; ; ld a,2
 763  8408              	; ; out (254),a
 764  8408              	; ld iy,0 ;счётчик файлов
 765  8408              	; ;найти конец каталога
 766  8408              	; ld hl,buffer_cat
 767  8408              	; ld a,(hl)
 768  8408              	; or a
 769  8408              	; ret z ;защита
 770  8408              	; ld bc,32
 771  8408              ; format_dir_prep_cl
 772  8408              	; ld a,(hl)
 773  8408              	; or a
 774  8408              	; jr z,format_dir_prep_ex
 775  8408              	; add hl,bc
 776  8408              	; ld a,h
 777  8408              	; or a ;если вышли за границу
 778  8408              	; jr z,format_dir_prep_ex
 779  8408              	; jr format_dir_prep_cl
 780  8408              ; format_dir_prep_ex
 781  8408              	; ld bc,32
 782  8408              	; and a
 783  8408              	; sbc hl,bc
 784  8408              	; ld (format_dir_top),hl ;конец каталога
 785  8408
 786  8408
 787  8408
 788  8408              	; ld ix,buffer_cat
 789  8408              	; ;ld b,panel_hight ;высота панели
 790  8408              ; format_dir_cl ;цикл
 791  8408              	; ld a,(ix)
 792  8408              	; or a ;конец каталога
 793  8408              	; jr z,format_dir_ex
 794  8408              	; cp #e5 ;удалённый
 795  8408              	; jr z,format_dir_skip
 796  8408              	; cp #05 ;удалённый
 797  8408              	; jr z,format_dir_skip
 798  8408              	; ld a,(ix+#0b)
 799  8408              	; cp #0f ;длинный
 800  8408              	; jr z,format_dir_skip
 801  8408
 802  8408              	; ;проверка на папку "." (этот же каталог)
 803  8408              	; ld a,(ix+#00)
 804  8408              	; cp "." ;
 805  8408              	; jr nz,format_dir_add
 806  8408              	; ld a,(ix+#01)
 807  8408              	; cp " " ;
 808  8408              	; jr z,format_dir_skip
 809  8408
 810  8408
 811  8408              ; format_dir_add
 812  8408              	; inc iy ;++
 813  8408              	; ld bc,32 ;на другой элемент каталога
 814  8408              	; add ix,bc
 815  8408              	; ld a,ixh
 816  8408              	; or a ;если вышли за границу
 817  8408              	; jr z,format_dir_ex
 818  8408              	; jr format_dir_cl
 819  8408              ; format_dir_skip
 820  8408              	; ;сдвинуть элементы вниз
 821  8408              	; push ix
 822  8408              	; push ix
 823  8408              	; pop hl
 824  8408              	; pop de ;куда
 825  8408              	; ld hl,(format_dir_top) ;0-32
 826  8408              	; and a
 827  8408              	; sbc hl,de
 828  8408              	; ld b,h
 829  8408              	; ld c,l ;длина
 830  8408              	; push bc
 831  8408
 832  8408              	; push ix
 833  8408              	; pop hl ;откуда
 834  8408              	; ld bc,32 ;на другой элемент каталога
 835  8408              	; add hl,bc ;откуда
 836  8408
 837  8408              	; pop bc
 838  8408              	; ldir
 839  8408
 840  8408              	; xor a
 841  8408              	; ld (de),a ;очистить ненужный элемент
 842  8408
 843  8408              	; jr format_dir_cl
 844  8408
 845  8408              ; format_dir_ex
 846  8408              	; ld (file_r_all),iy
 847  8408              	; ;здесь почистить остаток каталога
 848  8408              	; ; ld a,0
 849  8408              	; ; out (254),a
 850  8408              	; ret
 851  8408              ; format_dir_top	dw 0 ;временно конец гаталога
 852  8408
 853  8408
 854  8408
 855  8408
 856  8408
 857  8408              sort_dir ;сортировка каталога с помощью построения индекса
 858  8408 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 859  840C DD 7E 00     	ld a,(ix)
 860  840F B7           	or a
 861  8410 C8           	ret z ;если пусто, выход
 862  8411 FD 21 00 00  	ld iy,0 ;счётчик
 863  8415 21 6A 9A     	ld hl,cat_index ;таблица - индекс
 864  8418
 865  8418 3A 3A 85     	ld a,(sort_enable_flag)
 866  841B B7           	or a
 867  841C CA 3D 84     	jp z,sort_dir_no
 868  841F
 869  841F AF           	xor a
 870  8420 32 3C 84     	ld (sort_item),a ;образец для сравнения
 871  8423              sort_dir_cl
 872  8423 CD C5 84     	call sort_dir_one ;один проход по папкам
 873  8426 3A 3C 84     	ld a,(sort_item)
 874  8429 3C           	inc a ;следующий образец
 875  842A 32 3C 84     	ld (sort_item),a
 876  842D 20 F4        	jr nz,sort_dir_cl
 877  842F
 878  842F              	; xor a
 879  842F              	; ld (sort_item),a ;образец для сравнения
 880  842F              sort_file_cl
 881  842F CD 7D 84     	call sort_file_one ;один проход по файлам
 882  8432 3A 3C 84     	ld a,(sort_item)
 883  8435 3C           	inc a ;следующий образец
 884  8436 32 3C 84     	ld (sort_item),a
 885  8439 20 F4        	jr nz,sort_file_cl
 886  843B
 887  843B C9           	ret
 888  843C
 889  843C 00           sort_item db 0; текущий образец
 890  843D
 891  843D
 892  843D
 893  843D              ;без сортировки
 894  843D              sort_dir_no
 895  843D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 896  8441              sort_dir_no_cl ;цикл по каталогам
 897  8441 DD 7E 00     	ld a,(ix)
 898  8444 B7           	or a ;конец каталога
 899  8445 28 31        	jr z,sort_dir_no_ex
 900  8447 FE E5        	cp #e5 ;удалённый
 901  8449 28 22        	jr z,sort_dir_no_skip
 902  844B FE 05        	cp #05 ;удалённый
 903  844D 28 1E        	jr z,sort_dir_no_skip
 904  844F DD 7E 0B     	ld a,(ix+#0b)
 905  8452 FE 0F        	cp #0f ;длинный
 906  8454 28 17        	jr z,sort_dir_no_skip
 907  8456
 908  8456              	;проверка на папку "." (этот же каталог)
 909  8456 DD 7E 00     	ld a,(ix+#00)
 910  8459 FE 2E        	cp "." ;
 911  845B 20 07        	jr nz,sort_dir_no_add
 912  845D DD 7E 01     	ld a,(ix+#01)
 913  8460 FE 20        	cp " " ;
 914  8462 28 09        	jr z,sort_dir_no_skip
 915  8464
 916  8464              sort_dir_no_add
 917  8464 FD 23        	inc iy ;++
 918  8466              	;записать в таблицу (индекс)
 919  8466 DD E5        	push ix
 920  8468 C1           	pop bc
 921  8469 71           	ld (hl),c
 922  846A 23           	inc hl
 923  846B 70           	ld (hl),b
 924  846C 23           	inc hl
 925  846D
 926  846D
 927  846D              sort_dir_no_skip
 928  846D 01 20 00     	ld bc,32
 929  8470 DD 09        	add ix,bc ;на следующий
 930  8472 DD 7C        	ld a,ixh ;проверка на конец буфера
 931  8474 FE C0        	cp #c0
 932  8476 30 C9        	jr nc,sort_dir_no_cl
 933  8478
 934  8478              sort_dir_no_ex
 935  8478 FD 22 42 97  	ld (file_r_all),iy
 936  847C C9           	ret
 937  847D
 938  847D
 939  847D              ;сортировка файлов
 940  847D              sort_file_one
 941  847D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 942  8481              sort_file_one_cl ;цикл по каталогам
 943  8481 DD 7E 00     	ld a,(ix)
 944  8484 B7           	or a ;конец каталога
 945  8485 28 39        	jr z,sort_file_one_ex
 946  8487 DD 7E 0B     	ld a,(ix+#0b)
 947  848A FE 10        	cp #10 ;признак каталога
 948  848C 28 27        	jr z,sort_file_one_skip
 949  848E FE 30        	cp #30 ;признак каталога
 950  8490 28 23        	jr z,sort_file_one_skip
 951  8492 DD 7E 00     	ld a,(ix)
 952  8495 FE E5        	cp #e5 ;удалённый
 953  8497 28 1C        	jr z,sort_file_one_skip
 954  8499 FE 05        	cp #05 ;удалённый
 955  849B 28 18        	jr z,sort_file_one_skip
 956  849D DD 7E 0B     	ld a,(ix+#0b)
 957  84A0 FE 0F        	cp #0f ;длинный
 958  84A2 28 11        	jr z,sort_file_one_skip
 959  84A4
 960  84A4              	; ;проверка на папку "." (этот же каталог)
 961  84A4              	; ld a,(ix+#00)
 962  84A4              	; cp "." ;
 963  84A4              	; jr nz,sort_file_one_add
 964  84A4              	; ld a,(ix+#01)
 965  84A4              	; cp " " ;
 966  84A4              	; jr z,sort_file_one_skip
 967  84A4
 968  84A4
 969  84A4              sort_file_one_add
 970  84A4 3A 3C 84     	ld a,(sort_item)
 971  84A7 DD BE 00     	cp (ix+#00) ;первая буква имени
 972  84AA 20 09        	jr nz,sort_file_one_skip ;пока не подошла
 973  84AC
 974  84AC FD 23        	inc iy ;++
 975  84AE              	;записать в таблицу (индекс)
 976  84AE DD E5        	push ix
 977  84B0 C1           	pop bc
 978  84B1 71           	ld (hl),c
 979  84B2 23           	inc hl
 980  84B3 70           	ld (hl),b
 981  84B4 23           	inc hl
 982  84B5
 983  84B5
 984  84B5              sort_file_one_skip
 985  84B5 01 20 00     	ld bc,32
 986  84B8 DD 09        	add ix,bc ;на следующий
 987  84BA DD 7C        	ld a,ixh ;проверка на конец буфера
 988  84BC FE C0        	cp #c0
 989  84BE 30 C1        	jr nc,sort_file_one_cl
 990  84C0
 991  84C0              sort_file_one_ex
 992  84C0 FD 22 42 97  	ld (file_r_all),iy
 993  84C4 C9           	ret
 994  84C5
 995  84C5
 996  84C5
 997  84C5
 998  84C5
 999  84C5              ;сортировка папок
1000  84C5              sort_dir_one
1001  84C5 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1002  84C9              sort_dir_one_cl ;цикл по каталогам
1003  84C9 DD 7E 00     	ld a,(ix)
1004  84CC B7           	or a ;конец каталога
1005  84CD 28 47        	jr z,sort_dir_one_ex
1006  84CF DD 7E 0B     	ld a,(ix+#0b)
1007  84D2 FE 10        	cp #10 ;признак каталога
1008  84D4 28 04        	jr z,sort_dir_one_skip_no
1009  84D6 FE 30        	cp #30 ;признак каталога
1010  84D8 20 31        	jr nz,sort_dir_one_skip
1011  84DA              sort_dir_one_skip_no
1012  84DA DD 7E 00     	ld a,(ix)
1013  84DD FE E5        	cp #e5 ;удалённый
1014  84DF 28 2A        	jr z,sort_dir_one_skip
1015  84E1 FE 05        	cp #05 ;удалённый
1016  84E3 28 26        	jr z,sort_dir_one_skip
1017  84E5 DD 7E 0B     	ld a,(ix+#0b)
1018  84E8 FE 0F        	cp #0f ;длинный
1019  84EA 28 1F        	jr z,sort_dir_one_skip
1020  84EC
1021  84EC              	;проверка на папку "." (этот же каталог)
1022  84EC DD 7E 00     	ld a,(ix+#00)
1023  84EF FE 2E        	cp "." ;
1024  84F1 20 07        	jr nz,sort_dir_one_add
1025  84F3 DD 7E 01     	ld a,(ix+#01)
1026  84F6 FE 20        	cp " " ;
1027  84F8 28 11        	jr z,sort_dir_one_skip
1028  84FA
1029  84FA              sort_dir_one_add
1030  84FA 3A 3C 84     	ld a,(sort_item)
1031  84FD DD BE 00     	cp (ix+#00) ;первая буква имени
1032  8500 20 09        	jr nz,sort_dir_one_skip ;пока не подошла
1033  8502
1034  8502 FD 23        	inc iy ;++
1035  8504              	;записать в таблицу (индекс)
1036  8504 DD E5        	push ix
1037  8506 C1           	pop bc
1038  8507 71           	ld (hl),c
1039  8508 23           	inc hl
1040  8509 70           	ld (hl),b
1041  850A 23           	inc hl
1042  850B
1043  850B
1044  850B              sort_dir_one_skip
1045  850B 01 20 00     	ld bc,32
1046  850E DD 09        	add ix,bc ;на следующий
1047  8510 DD 7C        	ld a,ixh ;проверка на конец буфера
1048  8512 FE C0        	cp #c0
1049  8514 30 B3        	jr nc,sort_dir_one_cl
1050  8516
1051  8516              sort_dir_one_ex
1052  8516 FD 22 42 97  	ld (file_r_all),iy
1053  851A C9           	ret
1054  851B
1055  851B
1056  851B
1057  851B
1058  851B
1059  851B
1060  851B
1061  851B              sort_toggle ;переключение сортировки
1062  851B 3A 3A 85     	ld a,(sort_enable_flag)
1063  851E EE 01        	xor 1
1064  8520 32 3A 85     	ld (sort_enable_flag),a
1065  8523 3E 66        	ld a,"f" ;вкл
1066  8525 20 02        	jr nz,sort_toggle1
1067  8527 3E 4E        	ld a,"N";выкл
1068  8529              sort_toggle1
1069  8529 32 13 9A     	ld (msg_menu_main2+5),a
1070  852C
1071  852C CD 08 84     	call sort_dir
1072  852F CD C2 85     	call print_menu_main
1073  8532 3E 01        	ld a,1
1074  8534 32 5B 99     	ld (print_panel_r_flag),a
1075  8537
1076  8537 C3 5C 80     	jp nc_wait
1077  853A 00           sort_enable_flag db 0 ;флаг сортировки
1078  853B
1079  853B
1080  853B
1081  853B
1082  853B              LFN_toggle ;переключение сортировки
1083  853B 3A 57 85     	ld a,(LFN_enable_flag)
1084  853E EE 01        	xor 1
1085  8540 32 57 85     	ld (LFN_enable_flag),a
1086  8543 3E 66        	ld a,"f" ;вкл
1087  8545 20 02        	jr nz,LFN_toggle1
1088  8547 3E 4E        	ld a,"N";выкл
1089  8549              LFN_toggle1
1090  8549 32 0C 9A     	ld (msg_menu_main1+5),a
1091  854C
1092  854C              	;call sort_dir
1093  854C CD C2 85     	call print_menu_main
1094  854F 3E 01        	ld a,1
1095  8551 32 5B 99     	ld (print_panel_r_flag),a
1096  8554
1097  8554 C3 5C 80     	jp nc_wait
1098  8557 00           LFN_enable_flag db 0 ;флаг сортировки
1099  8558
1100  8558
1101  8558
1102  8558
1103  8558
1104  8558              format_name ;подогнать имя под стандарт filename.ext
1105  8558              ;вх: HL - имя в каталоге
1106  8558 E5           	push hl
1107  8559 21 46 97     	ld hl,file_name_cur
1108  855C 11 47 97     	ld de,file_name_cur+1 ;почистить
1109  855F 01 FF 00     	ld bc,256-1
1110  8562 36 00        	ld (hl),0
1111  8564 ED B0        	ldir
1112  8566
1113  8566 E1           	pop hl
1114  8567 E5           	push hl
1115  8568
1116  8568 11 46 97     	ld de,file_name_cur ;куда
1117  856B 01 FF 08     	ld bc,#08ff
1118  856E              format_name_cl
1119  856E 7E           	ld a,(hl)
1120  856F FE 21        	cp " "+1
1121  8571 38 04        	jr c,format_name_skip
1122  8573 ED A0        	ldi
1123  8575 10 F7        	djnz format_name_cl
1124  8577              format_name_skip
1125  8577 3E 2E        	ld a,"."
1126  8579 12           	ld (de),a
1127  857A
1128  857A 13           	inc de
1129  857B E1           	pop hl
1130  857C 01 08 00     	ld bc,8 ;перейти на расширение
1131  857F 09           	add hl,bc
1132  8580
1133  8580 01 FF 03     	ld bc,#03ff
1134  8583              format_name_cl2
1135  8583 7E           	ld a,(hl)
1136  8584 FE 21        	cp " "+1
1137  8586 38 04        	jr c,format_name_skip2
1138  8588 ED A0        	ldi
1139  858A 10 F7        	djnz format_name_cl2
1140  858C              format_name_skip2
1141  858C C9           	ret
1142  858D
1143  858D              print_rect_r ;печать рамки правой
1144  858D 3E 0F        	ld a,color_backgr ;цвет
1145  858F 06 0C        	ld b,#c
1146  8591              	OS_SET_COLOR
1146  8591 0E 06       >    ld c,#06
1146  8593 E7          >    rst #20
1147  8594 11 28 00     	ld de,#0028 ;xy
1148  8597              	OS_SET_XY
1148  8597 0E 01       >    ld c,#01
1148  8599 E7          >    rst #20
1149  859A 21 77 99     	ld hl,rect_1
1150  859D              	OS_PRINTZ
1150  859D 0E 09       >    ld c,#09
1150  859F E7          >    rst #20
1151  85A0
1152  85A0 11 28 01     	ld de,#0128 ;xy
1153  85A3 06 16        	ld b,24-2 ;цикл
1154  85A5              print_rect_r_cl
1155  85A5 C5           	push bc
1156  85A6 D5           	push de
1157  85A7              	OS_SET_XY
1157  85A7 0E 01       >    ld c,#01
1157  85A9 E7          >    rst #20
1158  85AA 21 A0 99     	ld hl,rect_2
1159  85AD              	OS_PRINTZ
1159  85AD 0E 09       >    ld c,#09
1159  85AF E7          >    rst #20
1160  85B0 D1           	pop de
1161  85B1 14           	inc d
1162  85B2 C1           	pop bc
1163  85B3 10 F0        	djnz print_rect_r_cl
1164  85B5
1165  85B5
1166  85B5 11 28 17     	ld de,#1728 ;xy
1167  85B8              	OS_SET_XY
1167  85B8 0E 01       >    ld c,#01
1167  85BA E7          >    rst #20
1168  85BB 21 C9 99     	ld hl,rect_3
1169  85BE              	OS_PRINTZ
1169  85BE 0E 09       >    ld c,#09
1169  85C0 E7          >    rst #20
1170  85C1 C9           	ret
1171  85C2
1172  85C2              print_menu_main ;печать основного меню
1173  85C2 3E 07        	ld a,color_default ;цвет
1174  85C4 06 0C        	ld b,#c
1175  85C6              	OS_SET_COLOR
1175  85C6 0E 06       >    ld c,#06
1175  85C8 E7          >    rst #20
1176  85C9
1177  85C9 11 00 18     	ld de,#1800+0*8
1178  85CC              	OS_SET_XY
1178  85CC 0E 01       >    ld c,#01
1178  85CE E7          >    rst #20
1179  85CF 3E 31        	ld a,"1" ;пункт 1
1180  85D1              	OS_PRINT_CHARF
1180  85D1 D7          >	rst #10
1181  85D2 11 08 18     	ld de,#1800+1*8
1182  85D5              	OS_SET_XY
1182  85D5 0E 01       >    ld c,#01
1182  85D7 E7          >    rst #20
1183  85D8 3E 32        	ld a,"2" ;пункт 2
1184  85DA              	OS_PRINT_CHARF
1184  85DA D7          >	rst #10
1185  85DB 11 10 18     	ld de,#1800+2*8
1186  85DE              	OS_SET_XY
1186  85DE 0E 01       >    ld c,#01
1186  85E0 E7          >    rst #20
1187  85E1 3E 33        	ld a,"3" ;пункт 3
1188  85E3              	OS_PRINT_CHARF
1188  85E3 D7          >	rst #10
1189  85E4
1190  85E4
1191  85E4 3E 28        	ld a,color_backgr_hi ;цвет
1192  85E6 06 0C        	ld b,#c
1193  85E8              	OS_SET_COLOR
1193  85E8 0E 06       >    ld c,#06
1193  85EA E7          >    rst #20
1194  85EB
1195  85EB 11 01 18     	ld de,#1800+0*8+1
1196  85EE              	OS_SET_XY
1196  85EE 0E 01       >    ld c,#01
1196  85F0 E7          >    rst #20
1197  85F1 21 07 9A     	ld hl,msg_menu_main1
1198  85F4              	OS_PRINTZ
1198  85F4 0E 09       >    ld c,#09
1198  85F6 E7          >    rst #20
1199  85F7 11 09 18     	ld de,#1800+1*8+1
1200  85FA              	OS_SET_XY
1200  85FA 0E 01       >    ld c,#01
1200  85FC E7          >    rst #20
1201  85FD 21 0E 9A     	ld hl,msg_menu_main2
1202  8600              	OS_PRINTZ
1202  8600 0E 09       >    ld c,#09
1202  8602 E7          >    rst #20
1203  8603 11 11 18     	ld de,#1800+2*8+1
1204  8606              	OS_SET_XY
1204  8606 0E 01       >    ld c,#01
1204  8608 E7          >    rst #20
1205  8609 21 15 9A     	ld hl,msg_menu_main3
1206  860C              	OS_PRINTZ
1206  860C 0E 09       >    ld c,#09
1206  860E E7          >    rst #20
1207  860F C9           	ret
1208  8610
1209  8610
1210  8610              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 8610              view_file
   2+ 8610              	;просмотр файла как текста
   3+ 8610
   4+ 8610 2A 42 97     	ld hl,(file_r_all)
   5+ 8613 7D           	ld a,l
   6+ 8614 B4           	or h
   7+ 8615 CA E2 86     	jp z,view_file_ex ;защита
   8+ 8618 2A 54 99     	ld hl,(file_r_num_cur)
   9+ 861B CD 0E 82     	call calc_deskr
  10+ 861E DD 7E 0B     	ld a,(ix+#0b)
  11+ 8621 FE 10        	cp #10 ;признак каталога
  12+ 8623 CA E2 86     	jp z,view_file_ex
  13+ 8626
  14+ 8626 CD 58 85     	call format_name ;обработать имя файла
  15+ 8629
  16+ 8629
  17+ 8629
  18+ 8629              	OS_CLS ;почистить экран
  18+ 8629 0E 00       >    ld c,#00
  18+ 862B E7          >    rst #20
  19+ 862C
  20+ 862C              	;обнулить переменные
  21+ 862C AF           	xor a
  22+ 862D 32 FB 88     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  23+ 8630              	;ld (view_file_bot_flag),a  ;
  24+ 8630 21 FF FF     	ld hl,#ffff
  25+ 8633 22 FC 88     	ld (view_file_end),hl ;конец файла тут
  26+ 8636 23           	inc hl
  27+ 8637 22 F3 88     	ld (view_move_right_val),hl
  28+ 863A
  29+ 863A C5           	push bc
  30+ 863B CD B3 80     	call clear_buf
  31+ 863E C1           	pop bc
  32+ 863F
  33+ 863F 21 46 97     	ld hl,file_name_cur		;строка с именем
  34+ 8642              	OS_FILE_OPEN
  34+ 8642 0E 21       >    ld c,#21
  34+ 8644 E7          >    rst #20
  35+ 8645 30 0E        	jr nc,view_file_open_ok
  36+ 8647              view_file_file_error
  37+ 8647 21 1B 9A     	ld hl,msg_file_error
  38+ 864A              	OS_PRINTZ
  38+ 864A 0E 09       >    ld c,#09
  38+ 864C E7          >    rst #20
  39+ 864D 06 64        	ld b,2*50
  40+ 864F CD AF 80     	call delay1
  41+ 8652 C3 DC 86     	jp view_file_wait_ex
  42+ 8655
  43+ 8655              view_file_open_ok
  44+ 8655 32 57 99     	ld (file_id_cur_r),a
  45+ 8658              	;проверка длины файла не больше #4000
  46+ 8658 7A           	ld	a,d ;самые старшие байты длины
  47+ 8659 B3           	or e
  48+ 865A 28 11        	jr z,view_file_size_ok ;если не слищком большой
  49+ 865C              view_file_too_big
  50+ 865C              	;файл больше буфера
  51+ 865C 11 00 40     	ld de,#4000 ;размер одной первой части
  52+ 865F 21 00 C0     	ld hl,buffer_cat
  53+ 8662 3A 57 99     	ld a,(file_id_cur_r)
  54+ 8665              	OS_FILE_READ ;загрузить
  54+ 8665 0E 23       >    ld c,#23
  54+ 8667 E7          >    rst #20
  55+ 8668 38 DD        	jr c,view_file_file_error
  56+ 866A
  57+ 866A C3 96 86     	jp view_file_readed
  58+ 866D
  59+ 866D              view_file_size_ok
  60+ 866D 78           	ld	a,b ;младший старший байт длины
  61+ 866E FE 40        	cp #40
  62+ 8670 38 06        	jr c,view_file_size_ok_small
  63+ 8672 20 E8        	jr nz,view_file_too_big
  64+ 8674 0C           	inc c
  65+ 8675 0D           	dec c
  66+ 8676 20 E4        	jr nz,view_file_too_big
  67+ 8678
  68+ 8678
  69+ 8678              view_file_size_ok_small
  70+ 8678              	;проверка на 0
  71+ 8678 78           	ld a,b
  72+ 8679 B1           	or c
  73+ 867A CA 47 86     	jp z,view_file_file_error
  74+ 867D              	;узнать где конец файла
  75+ 867D 21 00 C0     	ld hl,buffer_cat
  76+ 8680 09           	add hl,bc
  77+ 8681 22 FC 88     	ld (view_file_end),hl ;конец файла тут
  78+ 8684              	;размер не большой, прочитаем
  79+ 8684 50           	ld d,b ;размер
  80+ 8685 59           	ld e,c
  81+ 8686 21 00 C0     	ld hl,buffer_cat
  82+ 8689 3A 57 99     	ld a,(file_id_cur_r)
  83+ 868C              	OS_FILE_READ ;загрузить
  83+ 868C 0E 23       >    ld c,#23
  83+ 868E E7          >    rst #20
  84+ 868F 38 B6        	jr c,view_file_file_error
  85+ 8691
  86+ 8691 3E 01        	ld a,1
  87+ 8693 32 FB 88     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  88+ 8696
  89+ 8696              view_file_readed
  90+ 8696              	;файл прочитан
  91+ 8696
  92+ 8696 21 00 C0     	ld hl,buffer_cat
  93+ 8699 22 F5 88     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  94+ 869C 22 F7 88     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  95+ 869F
  96+ 869F CD 9F 87     	call print_file_text
  97+ 86A2
  98+ 86A2
  99+ 86A2 CD 6A 87     	call print_menu_view ;меню
 100+ 86A5 CD 85 87     	call print_menu_view_top ;инфо
 101+ 86A8
 102+ 86A8 CD 0B 81     	call release_key
 103+ 86AB
 104+ 86AB              view_file_wait ;цикл ожидания клавиши
 105+ 86AB              	OS_WAIT
 105+ 86AB DF          >	rst #18
 106+ 86AC              	OS_GET_CHAR
 106+ 86AC 0E 10       >    ld c,#10
 106+ 86AE E7          >    rst #20
 107+ 86AF FE FF        	cp 255
 108+ 86B1 28 F8        	jr z,view_file_wait
 109+ 86B3 FE 33        	cp "3"
 110+ 86B5 28 25        	jr z,view_file_wait_ex
 111+ 86B7 FE 0A        	cp 10 ;вниз
 112+ 86B9 CA E5 86     	jp z,view_line_down
 113+ 86BC FE 0B        	cp 11 ;вверх
 114+ 86BE CA FB 86     	jp z,view_line_up
 115+ 86C1 FE 09        	cp 09 ;вправо
 116+ 86C3 CA 0F 87     	jp z,view_right
 117+ 86C6 FE 08        	cp 08 ;влево
 118+ 86C8 CA 1F 87     	jp z,view_left
 119+ 86CB FE 04        	cp 04 ;страница вверх
 120+ 86CD CA 30 87     	jp z,view_page_up
 121+ 86D0 FE 05        	cp 05 ;страница вниз
 122+ 86D2 CA 4D 87     	jp z,view_page_down
 123+ 86D5 FE 18        	cp 24 ;break
 124+ 86D7 CA AF 82     	jp z,exit
 125+ 86DA 18 CF        	jr view_file_wait
 126+ 86DC
 127+ 86DC              view_file_wait_ex
 128+ 86DC              	;почистить экран
 129+ 86DC              	OS_CLS
 129+ 86DC 0E 00       >    ld c,#00
 129+ 86DE E7          >    rst #20
 130+ 86DF C3 23 80     	jp start_nc_warm ;перезагрузить папку
 131+ 86E2
 132+ 86E2              view_file_ex
 133+ 86E2 C3 5C 80     	jp nc_wait
 134+ 86E5
 135+ 86E5
 136+ 86E5
 137+ 86E5              view_line_down ;вниз на строчку
 138+ 86E5 2A F7 88     	ld hl,(view_file_pos_cur_focus) ;фокус
 139+ 86E8 22 F5 88     	ld (view_file_pos_cur),hl
 140+ 86EB CD C6 88     	call next_line ;вперёд на строку
 141+ 86EE 38 BB        	jr c,view_file_wait ;если не удачно
 142+ 86F0 2A F5 88     	ld hl,(view_file_pos_cur) ;запомнить фокус
 143+ 86F3 22 F7 88     	ld (view_file_pos_cur_focus),hl
 144+ 86F6 CD 9F 87     	call print_file_text ;напечатать всю страницу
 145+ 86F9 18 B0        	jr view_file_wait
 146+ 86FB
 147+ 86FB              view_line_up ;вверх на строчку
 148+ 86FB 2A F7 88     	ld hl,(view_file_pos_cur_focus) ;фокус
 149+ 86FE 22 F5 88     	ld (view_file_pos_cur),hl
 150+ 8701 CD D4 88     	call prev_line ;
 151+ 8704              	;jr c,view_file_wait ;если не удачно
 152+ 8704 2A F5 88     	ld hl,(view_file_pos_cur) ;запомнить фокус
 153+ 8707 22 F7 88     	ld (view_file_pos_cur_focus),hl
 154+ 870A CD 9F 87     	call print_file_text ;напечатать всю страницу
 155+ 870D 18 9C        	jr view_file_wait
 156+ 870F
 157+ 870F
 158+ 870F              view_right ;вправо
 159+ 870F 2A F3 88     	ld hl,(view_move_right_val)
 160+ 8712 23           	inc hl
 161+ 8713 7C           	ld a,h
 162+ 8714 B5           	or l
 163+ 8715 28 94        	jr z,view_file_wait
 164+ 8717 22 F3 88     	ld (view_move_right_val),hl
 165+ 871A CD 9F 87     	call print_file_text ;напечатать всю страницу
 166+ 871D 18 8C        	jr view_file_wait
 167+ 871F
 168+ 871F              view_left ;влево
 169+ 871F 2A F3 88     	ld hl,(view_move_right_val)
 170+ 8722 7C           	ld a,h
 171+ 8723 B5           	or l
 172+ 8724 28 85        	jr z,view_file_wait
 173+ 8726 2B           	dec hl
 174+ 8727 22 F3 88     	ld (view_move_right_val),hl
 175+ 872A CD 9F 87     	call print_file_text ;напечатать всю страницу
 176+ 872D C3 AB 86     	jp view_file_wait
 177+ 8730
 178+ 8730
 179+ 8730
 180+ 8730              view_page_up ;на страницу назад
 181+ 8730 2A F7 88     	ld hl,(view_file_pos_cur_focus) ;фокус
 182+ 8733 22 F5 88     	ld (view_file_pos_cur),hl
 183+ 8736 06 16        	ld b,view_text_bot-2
 184+ 8738              view_page_up_cl
 185+ 8738 CD D4 88     	call prev_line ;
 186+ 873B 38 04        	jr c,view_page_up_ex ;если не удачно
 187+ 873D 28 02        	jr z,view_page_up_ex
 188+ 873F 10 F7        	djnz view_page_up_cl
 189+ 8741              view_page_up_ex
 190+ 8741 2A F5 88     	ld hl,(view_file_pos_cur) ;запомнить фокус
 191+ 8744 22 F7 88     	ld (view_file_pos_cur_focus),hl
 192+ 8747 CD 9F 87     	call print_file_text ;напечатать всю страницу
 193+ 874A C3 AB 86     	jp view_file_wait
 194+ 874D
 195+ 874D
 196+ 874D
 197+ 874D              view_page_down ;на страницу вперёд
 198+ 874D 2A F7 88     	ld hl,(view_file_pos_cur_focus) ;фокус
 199+ 8750 22 F5 88     	ld (view_file_pos_cur),hl
 200+ 8753 06 16        	ld b,view_text_bot-2
 201+ 8755              view_page_down_cl
 202+ 8755 CD C6 88     	call next_line ;
 203+ 8758 38 04        	jr c,view_page_down_ex ;если не удачно
 204+ 875A 28 02        	jr z,view_page_down_ex
 205+ 875C 10 F7        	djnz view_page_down_cl
 206+ 875E              view_page_down_ex
 207+ 875E 2A F5 88     	ld hl,(view_file_pos_cur) ;запомнить фокус
 208+ 8761 22 F7 88     	ld (view_file_pos_cur_focus),hl
 209+ 8764 CD 9F 87     	call print_file_text ;напечатать всю страницу
 210+ 8767 C3 AB 86     	jp view_file_wait
 211+ 876A
 212+ 876A
 213+ 876A
 214+ 876A              print_menu_view ;печать меню просмотрщика
 215+ 876A 3E 18        	ld a,#18
 216+ 876C 06 28        	ld b,color_backgr_hi ;цвет
 217+ 876E              	OS_PAINT_LINE ;линия внизу
 217+ 876E 0E 04       >    ld c,#04
 217+ 8770 E7          >    rst #20
 218+ 8771 3E 28        	ld a,color_backgr_hi ;цвет
 219+ 8773 06 0C        	ld b,#c
 220+ 8775              	OS_SET_COLOR
 220+ 8775 0E 06       >    ld c,#06
 220+ 8777 E7          >    rst #20
 221+ 8778 11 10 18     	ld de,#1800+2*8
 222+ 877B              	OS_SET_XY
 222+ 877B 0E 01       >    ld c,#01
 222+ 877D E7          >    rst #20
 223+ 877E 21 EC 88     	ld hl,msg_menu_view
 224+ 8781              	OS_PRINTZ
 224+ 8781 0E 09       >    ld c,#09
 224+ 8783 E7          >    rst #20
 225+ 8784 C9           	ret
 226+ 8785
 227+ 8785              print_menu_view_top ;печать меню просмотрщика верхнее
 228+ 8785 AF           	xor a
 229+ 8786 06 28        	ld b,color_backgr_hi ;цвет
 230+ 8788              	OS_PAINT_LINE ;линия вверху
 230+ 8788 0E 04       >    ld c,#04
 230+ 878A E7          >    rst #20
 231+ 878B 3E 28        	ld a,color_backgr_hi ;цвет
 232+ 878D 06 0C        	ld b,#c
 233+ 878F              	OS_SET_COLOR
 233+ 878F 0E 06       >    ld c,#06
 233+ 8791 E7          >    rst #20
 234+ 8792 11 24 00     	ld de,#0024
 235+ 8795              	OS_SET_XY
 235+ 8795 0E 01       >    ld c,#01
 235+ 8797 E7          >    rst #20
 236+ 8798 21 46 97     	ld hl,file_name_cur
 237+ 879B              	OS_PRINTZ
 237+ 879B 0E 09       >    ld c,#09
 237+ 879D E7          >    rst #20
 238+ 879E C9           	ret
 239+ 879F
 240+ 879F
 241+ 879F
 242+ 879F              print_file_text	;печать текущей части файла в консоль
 243+ 879F 3E 04        	ld a,color_view_text ;цвет
 244+ 87A1 06 0C        	ld b,#c
 245+ 87A3              	OS_SET_COLOR
 245+ 87A3 0E 06       >    ld c,#06
 245+ 87A5 E7          >    rst #20
 246+ 87A6
 247+ 87A6 3E 01        	ld a,view_text_top ;первая строка
 248+ 87A8 32 F9 88     	ld (view_file_y_cur),a
 249+ 87AB 2A F7 88     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 250+ 87AE 22 F5 88     	ld (view_file_pos_cur),hl
 251+ 87B1              print_file_text_cl
 252+ 87B1 2A F5 88     	ld hl,(view_file_pos_cur)
 253+ 87B4 CD DA 87     	call print_line_text
 254+ 87B7 38 0C        	jr c,print_file_text_ex
 255+ 87B9
 256+ 87B9              	; call next_line ;найти следующую строку
 257+ 87B9              	; ret c
 258+ 87B9
 259+ 87B9 3A F9 88     	ld a,(view_file_y_cur)
 260+ 87BC 3C           	inc a
 261+ 87BD 32 F9 88     	ld (view_file_y_cur),a
 262+ 87C0 FE 18        	cp view_text_bot
 263+ 87C2 38 ED        	jr c,print_file_text_cl
 264+ 87C4 C9           	ret
 265+ 87C5
 266+ 87C5              print_file_text_ex
 267+ 87C5              	;тут очистить остальные строки
 268+ 87C5 3A F9 88     	ld a,(view_file_y_cur)
 269+ 87C8 3C           	inc a
 270+ 87C9 FE 18        	cp view_text_bot
 271+ 87CB 30 0B        	jr nc,print_file_text_ex2
 272+ 87CD 67           	ld h,a
 273+ 87CE 32 F9 88     	ld (view_file_y_cur),a
 274+ 87D1 3E 20        	ld a," "
 275+ 87D3              	OS_FILL_LINE ;очистить строку
 275+ 87D3 0E 03       >    ld c,#03
 275+ 87D5 E7          >    rst #20
 276+ 87D6 18 ED        	jr print_file_text_ex
 277+ 87D8              print_file_text_ex2
 278+ 87D8 37           	scf
 279+ 87D9 C9           	ret
 280+ 87DA
 281+ 87DA
 282+ 87DA
 283+ 87DA              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 284+ 87DA              ;вх: hl - адрес строки
 285+ 87DA CD 2A 88     	call view_move_right ;промотать направо. если надо
 286+ 87DD              	;установить позицию
 287+ 87DD 3A F9 88     	ld a,(view_file_y_cur)
 288+ 87E0 57           	ld d,a
 289+ 87E1 AF           	xor a
 290+ 87E2 32 FA 88     	ld (view_file_x_cur),a
 291+ 87E5 5F           	ld e,a
 292+ 87E6              	OS_SET_XY 	;yx
 292+ 87E6 0E 01       >    ld c,#01
 292+ 87E8 E7          >    rst #20
 293+ 87E9              print_line_text_cl ;цикл
 294+ 87E9
 295+ 87E9 7E           	ld a,(hl)
 296+ 87EA FE 0A        	cp 10 ;этот код не печатаем
 297+ 87EC 28 14        	jr z,print_line_text_skip
 298+ 87EE FE FF        	cp #ff ;этот код не печатаем
 299+ 87F0 28 10        	jr z,print_line_text_skip
 300+ 87F2 FE 0D        	cp 13
 301+ 87F4 28 13        	jr z,print_line_text_ex_ok
 302+ 87F6              	OS_PRINT_CHARF ;печать
 302+ 87F6 D7          >	rst #10
 303+ 87F7
 304+ 87F7              	;на следующую позицию
 305+ 87F7 3A FA 88     	ld a,(view_file_x_cur)
 306+ 87FA 3C           	inc a
 307+ 87FB FE 50        	cp 80 ;правый край экрана
 308+ 87FD 32 FA 88     	ld (view_file_x_cur),a
 309+ 8800 30 15        	jr nc,print_line_text_right ;дошли до правого края
 310+ 8802
 311+ 8802              print_line_text_skip
 312+ 8802 CD 62 88     	call view_file_next_pos ;следующий
 313+ 8805 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 314+ 8807 18 E0        	jr print_line_text_cl
 315+ 8809
 316+ 8809              print_line_text_ex_ok ;выход норма по коду 13
 317+ 8809 3E 20        	ld a," "
 318+ 880B              	OS_PRINT_CHARF ;печать
 318+ 880B D7          >	rst #10
 319+ 880C CD 1B 88     	call printe_clear_end ;добить до конца строки
 320+ 880F C3 62 88     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 321+ 8812              	;ret
 322+ 8812
 323+ 8812              print_line_text_ex_end ;выход если кончился файл
 324+ 8812 CD 1B 88     	call printe_clear_end
 325+ 8815 37           	scf
 326+ 8816 C9           	ret
 327+ 8817
 328+ 8817              print_line_text_right
 329+ 8817 CD C6 88     	call next_line ;позицию  до конца строки
 330+ 881A C9           	ret
 331+ 881B
 332+ 881B
 333+ 881B              printe_clear_end
 334+ 881B              	;добить строку пробелами
 335+ 881B 3A FA 88     	ld a,(view_file_x_cur)
 336+ 881E 3C           	inc a
 337+ 881F FE 50        	cp 80 ;правый край экрана
 338+ 8821 32 FA 88     	ld (view_file_x_cur),a
 339+ 8824 D0           	ret nc
 340+ 8825 3E 20        	ld a," "
 341+ 8827              	OS_PRINT_CHARF ;печать
 341+ 8827 D7          >	rst #10
 342+ 8828 18 F1        	jr printe_clear_end
 343+ 882A
 344+ 882A
 345+ 882A
 346+ 882A
 347+ 882A
 348+ 882A              view_move_right ;перемотка строки направо
 349+ 882A ED 4B F3 88  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 350+ 882E 78           	ld a,b
 351+ 882F B1           	or c
 352+ 8830 C8           	ret z
 353+ 8831 2A F5 88     	ld hl,(view_file_pos_cur)
 354+ 8834              view_move_right1
 355+ 8834 7E           	ld a,(hl)
 356+ 8835 FE 0A        	cp 10 ;этот код пропускаем
 357+ 8837 20 07        	jr nz,view_move_right2
 358+ 8839 CD 62 88     	call view_file_next_pos
 359+ 883C D8           	ret c
 360+ 883D C8           	ret z
 361+ 883E 18 F4        	jr view_move_right1
 362+ 8840              view_move_right2
 363+ 8840 FE FF        	cp #ff ;этот код пропускаем
 364+ 8842 20 07        	jr nz,view_move_right3
 365+ 8844 CD 62 88     	call view_file_next_pos
 366+ 8847 D8           	ret c
 367+ 8848 C8           	ret z
 368+ 8849 18 E9        	jr view_move_right1
 369+ 884B              view_move_right3
 370+ 884B 7E           	ld a,(hl)
 371+ 884C FE 0D        	cp 13 ;
 372+ 884E C8           	ret z
 373+ 884F              view_move_right_cl
 374+ 884F CD 62 88     	call view_file_next_pos
 375+ 8852 D8           	ret c
 376+ 8853 C8           	ret z
 377+ 8854 7E           	ld a,(hl)
 378+ 8855 FE 0D        	cp 13
 379+ 8857 C8           	ret z
 380+ 8858 FE 0A        	cp 10 ;этот код пропускаем
 381+ 885A 28 F3        	jr z,view_move_right_cl
 382+ 885C 0B           	dec bc
 383+ 885D 78           	ld a,b
 384+ 885E B1           	or c
 385+ 885F 20 EE        	jr nz,view_move_right_cl
 386+ 8861              	;call view_file_next_pos ;следующий
 387+ 8861 C9           	ret
 388+ 8862
 389+ 8862
 390+ 8862
 391+ 8862              ;получение следующей позиции
 392+ 8862              view_file_next_pos
 393+ 8862 3A FB 88     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 394+ 8865 B7           	or a
 395+ 8866 28 14        	jr z,view_file_next_pos_big
 396+ 8868              	;если текст не большой
 397+ 8868 2A FC 88     	ld hl,(view_file_end) ;конец текста известен
 398+ 886B ED 5B F5 88  	ld de,(view_file_pos_cur)
 399+ 886F 13           	inc de ;вперёд
 400+ 8870 A7           	and a
 401+ 8871 ED 52        	sbc hl,de
 402+ 8873 38 15        	jr c,view_file_next_pos_end
 403+ 8875 ED 53 F5 88  	ld (view_file_pos_cur),de
 404+ 8879 EB           	ex de,hl ;на выходе адрес в HL
 405+ 887A B7           	or a
 406+ 887B C9           	ret
 407+ 887C
 408+ 887C
 409+ 887C
 410+ 887C              view_file_next_pos_big
 411+ 887C              	;если текст большой
 412+ 887C 2A F5 88     	ld hl,(view_file_pos_cur)	;текущая позиция
 413+ 887F 23           	inc hl ;вперёд
 414+ 8880 7C           	ld a,h
 415+ 8881 FE C0        	cp #c0 ;если вышли за пределы окна
 416+ 8883 38 05        	jr c,view_file_next_pos_end
 417+ 8885 22 F5 88     	ld (view_file_pos_cur),hl
 418+ 8888 B7           	or a
 419+ 8889 C9           	ret
 420+ 888A
 421+ 888A              view_file_next_pos_end
 422+ 888A              	;не смогли шагнуть вперёд
 423+ 888A              	; ld a,1 ;флаг что внизу
 424+ 888A              	; ld (view_file_bot_flag),a
 425+ 888A 37           	scf ;ошибка
 426+ 888B C9           	ret
 427+ 888C
 428+ 888C
 429+ 888C
 430+ 888C
 431+ 888C
 432+ 888C
 433+ 888C              ;получение предыдущей позиции
 434+ 888C              view_file_prev_pos
 435+ 888C 3A FB 88     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 436+ 888F B7           	or a
 437+ 8890 28 1E        	jr z,view_file_prev_pos_big
 438+ 8892              	;если текст не большой
 439+ 8892 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 440+ 8895 ED 5B F5 88  	ld de,(view_file_pos_cur) ;текущая позиция
 441+ 8899 1B           	dec de ;назад
 442+ 889A A7           	and a
 443+ 889B ED 52        	sbc hl,de
 444+ 889D 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 445+ 889F 30 1D        	jr nc,view_file_prev_pos_end
 446+ 88A1              	;можно шагнуть назад
 447+ 88A1 ED 53 F5 88  	ld (view_file_pos_cur),de
 448+ 88A5 EB           	ex de,hl ;на выходе адрес в HL
 449+ 88A6 AF           	xor a
 450+ 88A7 3C           	inc a ;a=1
 451+ 88A8 C9           	ret
 452+ 88A9              view_file_prev_pos_top
 453+ 88A9              	;если в начале
 454+ 88A9 ED 53 F5 88  	ld (view_file_pos_cur),de
 455+ 88AD EB           	ex de,hl ;на выходе адрес в HL
 456+ 88AE AF           	xor a ;a=0
 457+ 88AF C9           	ret
 458+ 88B0
 459+ 88B0
 460+ 88B0              view_file_prev_pos_big
 461+ 88B0              	;если текст большой
 462+ 88B0 2A F5 88     	ld hl,(view_file_pos_cur)	;текущая позиция
 463+ 88B3 2B           	dec hl ;назад
 464+ 88B4 7C           	ld a,h
 465+ 88B5 FE C0        	cp #c0 ;если вышли за пределы окна
 466+ 88B7 38 05        	jr c,view_file_prev_pos_end
 467+ 88B9 22 F5 88     	ld (view_file_pos_cur),hl
 468+ 88BC B7           	or a
 469+ 88BD C9           	ret
 470+ 88BE
 471+ 88BE              view_file_prev_pos_end
 472+ 88BE              	;не смогли шагнуть назад
 473+ 88BE 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 474+ 88C1 22 F5 88     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 475+ 88C4              	;вернулись в начало
 476+ 88C4 AF           	xor a ;a=0
 477+ 88C5 C9           	ret
 478+ 88C6
 479+ 88C6
 480+ 88C6
 481+ 88C6
 482+ 88C6              next_line ;поиск следующей строки
 483+ 88C6 CD 62 88     	call view_file_next_pos
 484+ 88C9 D8           	ret c
 485+ 88CA C8           	ret z
 486+ 88CB 7E           	ld a,(hl)
 487+ 88CC FE 0D        	cp 13
 488+ 88CE 20 F6        	jr nz,next_line
 489+ 88D0 CD 62 88     	call view_file_next_pos ;ещё на символ
 490+ 88D3 C9           	ret
 491+ 88D4
 492+ 88D4
 493+ 88D4
 494+ 88D4              prev_line ;поиск предыдущей строки
 495+ 88D4              ;если достигнуто начало файла - вернёт адрес начальный
 496+ 88D4              	;сначала в конец предыдущей
 497+ 88D4 CD 8C 88     	call view_file_prev_pos
 498+ 88D7 C8           	ret z
 499+ 88D8 D8           	ret c
 500+ 88D9 7E           	ld a,(hl)
 501+ 88DA FE 0D        	cp 13
 502+ 88DC 20 F6        	jr nz,prev_line
 503+ 88DE              	;теперь в начало предыдущей
 504+ 88DE              prev_line1
 505+ 88DE CD 8C 88     	call view_file_prev_pos
 506+ 88E1 C8           	ret z
 507+ 88E2 D8           	ret c
 508+ 88E3 7E           	ld a,(hl)
 509+ 88E4 FE 0D        	cp 13
 510+ 88E6 20 F6        	jr nz,prev_line1
 511+ 88E8 CD 62 88     	call view_file_next_pos ;ещё на символ обратно
 512+ 88EB C9           	ret
 513+ 88EC
 514+ 88EC
 515+ 88EC
 516+ 88EC              view_text_bot equ 24 ;последняя строка для печати
 517+ 88EC              view_text_top equ 1 ;первая строка
 518+ 88EC              view_text_lines equ 25-2 ;видимых строк на экране
 519+ 88EC
 520+ 88EC              msg_menu_view
 521+ 88EC 33 20 45 78  	db "3 Exit",0
 521+ 88F0 69 74 00
 522+ 88F3
 523+ 88F3              ;view_file_position ds 4 ;текущая позиция в файле
 524+ 88F3              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 525+ 88F3 00 00        view_move_right_val dw 0 ;сдвиг вправо
 526+ 88F5 00 00        view_file_pos_cur dw 0;текущая позиция
 527+ 88F7 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 528+ 88F9 00           view_file_y_cur db 0;текущая строка
 529+ 88FA 00           view_file_x_cur db 0;текущий столбец
 530+ 88FB 00           view_file_load_all db 0 ;флаг что файл весь загружен
 531+ 88FC 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 532+ 88FE
 533+ 88FE
# file closed: nc_view.asm
1211  88FE              	include GPlay/gplay.asm ;плеер
# file opened: GPlay/gplay.asm
   1+ 88FE              ;GPlay - приложение для OS GMX
   2+ 88FE                 ; device ZXSPECTRUM128
   3+ 88FE              	; include "../os_defs.asm"
   4+ 88FE              	; org PROG_START
   5+ 88FE
   6+ 88FE
   7+ 88FE              start_gplay
   8+ 88FE 11 00 00     	ld de,0
   9+ 8901              	OS_SET_XY
   9+ 8901 0E 01       >    ld c,#01
   9+ 8903 E7          >    rst #20
  10+ 8904 21 B9 8A     	ld hl,msg_title ;имя приложения
  11+ 8907              	OS_PRINTZ ;печать
  11+ 8907 0E 09       >    ld c,#09
  11+ 8909 E7          >    rst #20
  12+ 890A
  13+ 890A 3E 0D        	ld a,13 ;оставим место для шкалы прогресса
  14+ 890C              	OS_PRINT_CHARF
  14+ 890C D7          >	rst #10
  15+ 890D 3E 0D        	ld a,13
  16+ 890F              	OS_PRINT_CHARF
  16+ 890F D7          >	rst #10
  17+ 8910 21 46 97     	ld hl,file_name_cur
  18+ 8913              	OS_PRINTZ
  18+ 8913 0E 09       >    ld c,#09
  18+ 8915 E7          >    rst #20
  19+ 8916
  20+ 8916 21 82 8A     	ld hl,txt_load
  21+ 8919              	OS_PRINTZ
  21+ 8919 0E 09       >    ld c,#09
  21+ 891B E7          >    rst #20
  22+ 891C
  23+ 891C 3E FF        	ld a,255
  24+ 891E 32 54 8A     	ld (file_id_cur),a
  25+ 8921
  26+ 8921 CD B9 96     	call load_mus ;инициализация VGM
  27+ 8924 DA 7A 89     	jp c,exit_gplay
  28+ 8927
  29+ 8927 21 72 8A     	ld hl,txt_play
  30+ 892A              	OS_PRINTZ
  30+ 892A 0E 09       >    ld c,#09
  30+ 892C E7          >    rst #20
  31+ 892D
  32+ 892D 21 55 8A     	ld hl,txt_gplay_menu
  33+ 8930              	OS_PRINTZ
  33+ 8930 0E 09       >    ld c,#09
  33+ 8932 E7          >    rst #20
  34+ 8933
  35+ 8933              wait_play
  36+ 8933              	OS_WAIT
  36+ 8933 DF          >	rst #18
  37+ 8934
  38+ 8934 CD 9B 89     	call gplay_progress_print
  39+ 8937
  40+ 8937 11 00 0A     	ld de,#0a00
  41+ 893A              	OS_SET_XY
  41+ 893A 0E 01       >    ld c,#01
  41+ 893C E7          >    rst #20
  42+ 893D 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
  43+ 8940 CD F5 89     	call toDecimal
  44+ 8943              	OS_PRINTZ
  44+ 8943 0E 09       >    ld c,#09
  44+ 8945 E7          >    rst #20
  45+ 8946
  46+ 8946
  47+ 8946 11 00 0B     	ld de,#0b00
  48+ 8949              	OS_SET_XY
  48+ 8949 0E 01       >    ld c,#01
  48+ 894B E7          >    rst #20
  49+ 894C 2A 0E 8C     	ld hl,(memorystreampageaddr)
  50+ 894F 01 00 8B     	ld bc,memorystreampages
  51+ 8952 A7           	and a
  52+ 8953 ED 42        	sbc hl,bc
  53+ 8955 CD F5 89     	call toDecimal
  54+ 8958              	OS_PRINTZ
  54+ 8958 0E 09       >    ld c,#09
  54+ 895A E7          >    rst #20
  55+ 895B
  56+ 895B 3A 14 92     	ld a,(vgm_play_var)
  57+ 895E B7           	or a
  58+ 895F 20 19        	jr nz,exit_gplay ; конец пенсни
  59+ 8961              	OS_GET_CHAR
  59+ 8961 0E 10       >    ld c,#10
  59+ 8963 E7          >    rst #20
  60+ 8964 FE 20        	cp " " ;space
  61+ 8966 CA 7A 89     	jp z,exit_gplay
  62+ 8969 FE 73        	cp "s" ;stop
  63+ 896B CA 7A 89     	jp z,exit_gplay
  64+ 896E FE 53        	cp "S" ;stop
  65+ 8970 CA 7A 89     	jp z,exit_gplay
  66+ 8973 FE 18        	cp 24 ;break
  67+ 8975 CA 7A 89     	jp z,exit_gplay
  68+ 8978 18 B9        	jr wait_play
  69+ 897A
  70+ 897A
  71+ 897A              exit_gplay ;выход
  72+ 897A F5           	push af ;сохранить нажатую клавишу
  73+ 897B
  74+ 897B 21 7C 8A     	ld hl,txt_exit
  75+ 897E              	OS_PRINTZ
  75+ 897E 0E 09       >    ld c,#09
  75+ 8980 E7          >    rst #20
  76+ 8981
  77+ 8981 21 00 00     	ld hl,0 ;отключить обработчик прерываний
  78+ 8984              	OS_SET_INTER
  78+ 8984 0E 14       >    ld c,#14
  78+ 8986 E7          >    rst #20
  79+ 8987 CD D8 8A     	call PLR_MUTE ;выключить звук
  80+ 898A
  81+ 898A
  82+ 898A              	;освободить страницы памяти
  83+ 898A 21 FF 8B     	ld hl,memorystreampages+$FF
  84+ 898D 6E               ld l,(hl)
  85+ 898E              free_s98_loop
  86+ 898E 2D               dec l
  87+ 898F 7E               ld a,(hl)
  88+ 8990
  89+ 8990 F5               push af
  90+ 8991 E5               push hl
  91+ 8992                  ;OS_DELPAGE
  92+ 8992              	OS_DEL_PAGE
  92+ 8992 0E 20       >    ld c,#20
  92+ 8994 E7          >    rst #20
  93+ 8995 E1               pop hl
  94+ 8996 F1               pop af
  95+ 8997
  96+ 8997 20 F5            jr nz,free_s98_loop
  97+ 8999
  98+ 8999              	; call delay ;задержка
  99+ 8999              	; xor a
 100+ 8999              	; OS_PROC_CLOSE
 101+ 8999 F1           	pop af ;a - код клавиши
 102+ 899A C9           	ret
 103+ 899B
 104+ 899B              ; delay ;задержка между запросами
 105+ 899B              	; ld b,50*1 ;
 106+ 899B              ; delay1
 107+ 899B              	; OS_WAIT
 108+ 899B              	; djnz delay1
 109+ 899B              	; ret
 110+ 899B
 111+ 899B
 112+ 899B              	;печать шкалы прогресса
 113+ 899B              gplay_progress_print
 114+ 899B CD C4 89     	call gplay_progress_calc
 115+ 899E 11 00 02     	ld de,#0200 ;прогресс тут
 116+ 89A1              	OS_SET_XY
 116+ 89A1 0E 01       >    ld c,#01
 116+ 89A3 E7          >    rst #20
 117+ 89A4              	;печать закрашенных кубиков
 118+ 89A4 3A F4 89     	ld a,(gplay_progress_val)
 119+ 89A7 B7           	or a
 120+ 89A8 28 08        	jr z,gplay_progress_print1
 121+ 89AA 47           	ld b,a
 122+ 89AB              gplay_progress_print1_cl
 123+ 89AB C5           	push bc
 124+ 89AC 3E B1        	ld a,177 ;псевдографика
 125+ 89AE              	OS_PRINT_CHARF
 125+ 89AE D7          >	rst #10
 126+ 89AF C1           	pop bc
 127+ 89B0 10 F9        	djnz gplay_progress_print1_cl
 128+ 89B2              gplay_progress_print1
 129+ 89B2              	;печать пустых кубиков
 130+ 89B2 3A F4 89     	ld a,(gplay_progress_val)
 131+ 89B5 4F           	ld c,a
 132+ 89B6 3E 10        	ld a,gplay_progress_lenght
 133+ 89B8 91           	sub c
 134+ 89B9 28 08        	jr z,gplay_progress_print2
 135+ 89BB 47           	ld b,a
 136+ 89BC              gplay_progress_print1_c2
 137+ 89BC C5           	push bc
 138+ 89BD 3E B0        	ld a,176 ;псевдографика
 139+ 89BF              	OS_PRINT_CHARF
 139+ 89BF D7          >	rst #10
 140+ 89C0 C1           	pop bc
 141+ 89C1 10 F9        	djnz gplay_progress_print1_c2
 142+ 89C3
 143+ 89C3              gplay_progress_print2
 144+ 89C3 C9           	ret
 145+ 89C4
 146+ 89C4
 147+ 89C4              gplay_progress_calc
 148+ 89C4 3A FF 8B     	ld a,(memorystreampages+255) ;всего страниц памяти занято
 149+ 89C7 67           	ld h,a
 150+ 89C8 2E 00        	ld l,0 ;всего страниц *256
 151+ 89CA
 152+ 89CA              	;разделить
 153+ 89CA CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 154+ 89CC CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 155+ 89CE CB 3C        	srl h ; /4
 156+ 89D0 CB 1D        	rr l ;
 157+ 89D2 CB 3C        	srl h ; /8
 158+ 89D4 CB 1D        	rr l ;
 159+ 89D6 CB 3C        	srl h ; /16
 160+ 89D8 CB 1D        	rr l ;
 161+ 89DA              	; srl h ; /32
 162+ 89DA              	; rr l ;
 163+ 89DA              	;узнали сколько страниц одно деление
 164+ 89DA EB           	ex de,hl
 165+ 89DB
 166+ 89DB
 167+ 89DB 2A 0E 8C     	ld hl,(memorystreampageaddr)
 168+ 89DE 01 00 8B     	ld bc,memorystreampages
 169+ 89E1 A7           	and a
 170+ 89E2 ED 42        	sbc hl,bc ;какая по счёту страница сейчас
 171+ 89E4
 172+ 89E4 65           	ld h,l ;*256
 173+ 89E5 2E 00        	ld l,0
 174+ 89E7
 175+ 89E7              	;разделить на величину одного деления
 176+ 89E7 3E FF        	ld a,-1
 177+ 89E9              divide16
 178+ 89E9 3C           	inc a
 179+ 89EA A7           	and a
 180+ 89EB ED 52        	sbc hl,de
 181+ 89ED 30 FA        	jr nc,divide16
 182+ 89EF 19           	add hl,de
 183+ 89F0 32 F4 89     	ld (gplay_progress_val),a
 184+ 89F3 C9           	ret
 185+ 89F4
 186+ 89F4              gplay_progress_lenght equ 16 ;длина шкалы
 187+ 89F4 00           gplay_progress_val db 0;
 188+ 89F5
 189+ 89F5
 190+ 89F5
 191+ 89F5
 192+ 89F5              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 193+ 89F5              				;на входе в HL число
 194+ 89F5 11 10 27     			ld de,10000 ;десятки тысяч
 195+ 89F8 3E FF        			ld a,255
 196+ 89FA              toDecimal10k
 197+ 89FA A7           			and a
 198+ 89FB ED 52        			sbc hl,de
 199+ 89FD 3C           			inc a
 200+ 89FE 30 FA        			jr nc,toDecimal10k
 201+ 8A00 19           			add hl,de
 202+ 8A01 C6 30        			add a,48
 203+ 8A03 32 4E 8A     			ld (decimalS),a
 204+ 8A06 11 E8 03     			ld de,1000 ;тысячи
 205+ 8A09 3E FF        			ld a,255
 206+ 8A0B              toDecimal1k
 207+ 8A0B A7           			and a
 208+ 8A0C ED 52        			sbc hl,de
 209+ 8A0E 3C           			inc a
 210+ 8A0F 30 FA        			jr nc,toDecimal1k
 211+ 8A11 19           			add hl,de
 212+ 8A12 C6 30        			add a,48
 213+ 8A14 32 4F 8A     			ld (decimalS+1),a
 214+ 8A17 11 64 00     			ld de,100 ;сотни
 215+ 8A1A 3E FF        			ld a,255
 216+ 8A1C              toDecimal01k
 217+ 8A1C A7           			and a
 218+ 8A1D ED 52        			sbc hl,de
 219+ 8A1F 3C           			inc a
 220+ 8A20 30 FA        			jr nc,toDecimal01k
 221+ 8A22 19           			add hl,de
 222+ 8A23 C6 30        			add a,48
 223+ 8A25 32 50 8A     			ld (decimalS+2),a
 224+ 8A28 11 0A 00     			ld de,10 ;десятки
 225+ 8A2B 3E FF        			ld a,255
 226+ 8A2D              toDecimal001k
 227+ 8A2D A7           			and a
 228+ 8A2E ED 52        			sbc hl,de
 229+ 8A30 3C           			inc a
 230+ 8A31 30 FA        			jr nc,toDecimal001k
 231+ 8A33 19           			add hl,de
 232+ 8A34 C6 30        			add a,48
 233+ 8A36 32 51 8A     			ld (decimalS+3),a
 234+ 8A39 11 01 00     			ld de,1 ;единицы
 235+ 8A3C 3E FF        			ld a,255
 236+ 8A3E              toDecimal0001k
 237+ 8A3E A7           			and a
 238+ 8A3F ED 52        			sbc hl,de
 239+ 8A41 3C           			inc a
 240+ 8A42 30 FA        			jr nc,toDecimal0001k
 241+ 8A44 19           			add hl,de
 242+ 8A45 C6 30        			add a,48
 243+ 8A47 32 52 8A     			ld (decimalS+4),a
 244+ 8A4A 21 4E 8A     			ld hl,decimalS
 245+ 8A4D C9           			ret
 246+ 8A4E
 247+ 8A4E 00 00 00...  decimalS	ds 6 ;десятичные цифры
 248+ 8A54
 249+ 8A54
 250+ 8A54
 251+ 8A54
 252+ 8A54 00           file_id_cur db 0; временно
 253+ 8A55
 254+ 8A55 0D 0D 42 72  txt_gplay_menu db 13,13,"Break, S - stop ",13,"Sp - Next",0
 254+ 8A59 65 61 6B 2C
 254+ 8A5D 20 53 20 2D
 254+ 8A61 20 73 74 6F
 254+ 8A65 70 20 0D 53
 254+ 8A69 70 20 2D 20
 254+ 8A6D 4E 65 78 74
 254+ 8A71 00
 255+ 8A72 0D 50 6C 61  txt_play db 13,"Play... ",0
 255+ 8A76 79 2E 2E 2E
 255+ 8A7A 20 00
 256+ 8A7C 0D 53 74 6F  txt_exit db 13,"Stop",0
 256+ 8A80 70 00
 257+ 8A82 0D 4C 6F 61  txt_load db 13,"Load...",0
 257+ 8A86 64 2E 2E 2E
 257+ 8A8A 00
 258+ 8A8B 0D 4D 65 6D  txt_memoryerror:    db 13,"Memory allocation error!",0
 258+ 8A8F 6F 72 79 20
 258+ 8A93 61 6C 6C 6F
 258+ 8A97 63 61 74 69
 258+ 8A9B 6F 6E 20 65
 258+ 8A9F 72 72 6F 72
 258+ 8AA3 21 00
 259+ 8AA5 0D 43 61 6E  txt_fopenerror:     db 13,"Cannot open file: ",0
 259+ 8AA9 6E 6F 74 20
 259+ 8AAD 6F 70 65 6E
 259+ 8AB1 20 66 69 6C
 259+ 8AB5 65 3A 20 00
 260+ 8AB9
 261+ 8AB9              msg_title
 262+ 8AB9 47 50 6C 61  	db "GPlay ver 2025.07.24",10,13,0
 262+ 8ABD 79 20 76 65
 262+ 8AC1 72 20 32 30
 262+ 8AC5 32 35 2E 30
 262+ 8AC9 37 2E 32 34
 262+ 8ACD 0A 0D 00
 263+ 8AD0
 264+ 8AD0              vgm_plr
 265+ 8AD0
 266+ 8AD0              ;module equ 0xc000
 267+ 8AD0              ;player_load = 0x8000 ;0x4000
 268+ 8AD0
 269+ 8AD0              ;ovl_start = 0x8000 ;0x4000
 270+ 8AD0
 271+ 8AD0              PLR_INIT  = vgm_plr ;0x4000
 272+ 8AD0              PLR_PLAY  = vgm_plr+5 ;0x4005
 273+ 8AD0              PLR_MUTE  = vgm_plr+8 ;0x4008
 274+ 8AD0
 275+ 8AD0              	include vgm_plr.asm
# file opened: GPlay/vgm_plr.asm
   1++8AD0                      ;DEVICE ZXSPECTRUM48
   2++8AD0                      ;include "../../../_sdk/sys_h.asm"
   3++8AD0                      ;       ORG PROGSTART ;0x4000
   4++8AD0
   5++8AD0
   6++8AD0
   7++8AD0              ;memorystreamcurrentpage = 0x5100
   8++8AD0              ;current_ram_page = 0x5100
   9++8AD0
  10++8AD0
  11++8AD0              AREA_C000_FFFF   equ 1
  12++8AD0
  13++8AD0
  14++8AD0
  15++8AD0              module = $C000
  16++8AD0
  17++8AD0
  18++8AD0
  19++8AD0              begin
  20++8AD0              START
  21++8AD0 21 00 C0             	LD HL,module;MDLADDR ;DE - address of 2nd module for TS
  22++8AD3 18 06                	JR INIT
  23++8AD5 C3 14 92             	JP PLAY
  24++8AD8 C3 06 92             	JP MUTE
  25++8ADB              INIT:
  26++8ADB C3 69 91             jp init_
  27++8ADE
  28++8ADE              DEVICE_AY_BIT         = 0
  29++8ADE              DEVICE_TURBOSOUND_BIT = 1
  30++8ADE              DEVICE_TFM_BIT        = 2
  31++8ADE              DEVICE_MOONSOUND_BIT  = 3
  32++8ADE              DEVICE_GS_BIT         = 4
  33++8ADE              DEVICE_NEOGS_BIT      = 5
  34++8ADE              DEVICE_MIDI_UART_BIT  = 6
  35++8ADE
  36++8ADE              DEVICE_AY_MASK         = 1<<DEVICE_AY_BIT
  37++8ADE              DEVICE_TURBOSOUND_MASK = 1<<DEVICE_TURBOSOUND_BIT
  38++8ADE              DEVICE_TFM_MASK        = 1<<DEVICE_TFM_BIT
  39++8ADE              DEVICE_MOONSOUND_MASK  = 1<<DEVICE_MOONSOUND_BIT
  40++8ADE              DEVICE_GS_MASK         = 1<<DEVICE_GS_BIT
  41++8ADE              DEVICE_NEOGS_MASK      = 1<<DEVICE_NEOGS_BIT
  42++8ADE              DEVICE_MIDI_UART_MASK  = 1<<DEVICE_MIDI_UART_BIT
  43++8ADE
  44++8ADE
  45++8ADE
  46++8ADE
  47++8ADE
  48++8ADE              HEADER_DATA_OFFSET = module+0x34 ;0xC034
  49++8ADE              HEADER_LOOP_SAMPLES_COUNT = module+0x20 ;0xC020
  50++8ADE              HEADER_GD3_OFFSET = module+0x14 ;0xC014
  51++8ADE              HEADER_SAMPLES_COUNT = module+0x18 ;0xC018
  52++8ADE              HEADER_LOOP_OFFSET = module+0x1c ;0xC01c
  53++8ADE
  54++8ADE
  55++8ADE              HEADER_SIZE_MAX = 256
  56++8ADE              TITLELENGTH = 64
  57++8ADE              MEMORYSTREAMMAXPAGES = 210
  58++8ADE              MEMORYSTREAMERRORMASK = 255 ; TODO: do we need to enforce loading the entire file?
  59++8ADE              ENABLE_FM = 1
  60++8ADE
  61++8ADE
  62++8ADE
  63++8ADE
  64++8ADE
  65++8ADE
  66++8ADE
  67++8ADE 00 00 00...          align 256   ;0x8100 ;0x4100
  68++8B00                      display "s98_file00_pages_list ",$
  69++8B00
  70++8B00 00 00 00...  memorystreampages: ds 256,0
  71++8C00              memorystreampagecount = memorystreampages + 255
  72++8C00
  73++8C00              	include "common/memorystream.asm"
# file opened: GPlay/common/memorystream.asm
   1++8C00              memorystreamstart
   2++8C00                      IF AREA_C000_FFFF=1
   3++8C00 21 00 00     	ld hl,0x0000
   4++8C03                      ELSE
   5++8C03 ~                    ld hl,0xffff
   6++8C03                      ENDIF
   7++8C03 22 72 8C     	ld (memorystreamcurrentaddr),hl
   8++8C06 21 00 8B     	ld hl,memorystreampages
   9++8C09 22 0E 8C     	ld (memorystreampageaddr),hl
  10++8C0C C9           	ret
  11++8C0D
  12++8C0D              memorystreamnextpage
  13++8C0D              memorystreampageaddr=$+1
  14++8C0D 21 00 00     	ld hl,0
  15++8C10 F5           	push af
  16++8C11 7E           	ld a,(hl)
  17++8C12 23           	inc hl
  18++8C13 32 16 92     	ld (memorystreamcurrentpage),a
  19++8C16 22 0E 8C     	ld (memorystreampageaddr),hl
  20++8C19 C5           	push bc
  21++8C1A                      IF AREA_C000_FFFF=1
  22++8C1A              	;SETPGC000
  23++8C1A              	OS_SET_PAGE_SLOT3
  23++8C1A 0E 1C       >    ld c,#1c
  23++8C1C E7          >    rst #20
  24++8C1D C1           	pop bc
  25++8C1E F1           	pop af
  26++8C1F 21 00 C0     	ld hl,0xC000
  27++8C22                      ELSE
  28++8C22 ~                    SETPG8000
  29++8C22 ~                    pop bc
  30++8C22 ~                    pop af
  31++8C22 ~                    ld hl,0x8000
  32++8C22                      ENDIF
  33++8C22 C9           	ret
  34++8C23
  35++8C23              memorystreamskip
  36++8C23              ;b = byte count
  37++8C23 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
  38++8C26              .loop
  39++8C26 CB 74        	bit 6,h
  40++8C28                      IF AREA_C000_FFFF=1
  41++8C28 CC 0D 8C     	call z,memorystreamnextpage
  42++8C2B                      ELSE
  43++8C2B ~             	call nz,memorystreamnextpage
  44++8C2B                      ENDIF
  45++8C2B 23           	inc hl
  46++8C2C 10 F8        	djnz .loop
  47++8C2E 22 72 8C     	ld (memorystreamcurrentaddr),hl
  48++8C31 C9           	ret
  49++8C32
  50++8C32              	macro memory_stream_write_byte src
  51++8C32 ~            	bit 6,h
  52++8C32 ~                    IF AREA_C000_FFFF=1
  53++8C32 ~            	call z,memorystreamnextpage
  54++8C32 ~                    ELSE
  55++8C32 ~             	call nz,memorystreamnextpage
  56++8C32 ~                    ENDIF
  57++8C32 ~            	ld (hl),src
  58++8C32 ~            	inc hl
  59++8C32              	endm
  60++8C32
  61++8C32              	macro memory_stream_read_byte dest
  62++8C32 ~            	bit 6,h
  63++8C32 ~                    IF AREA_C000_FFFF=1
  64++8C32 ~            	call z,memorystreamnextpage
  65++8C32 ~                    ELSE
  66++8C32 ~             	call nz,memorystreamnextpage
  67++8C32 ~                    ENDIF
  68++8C32 ~            	ld dest,(hl)
  69++8C32 ~            	inc hl
  70++8C32              	endm
  71++8C32
  72++8C32              	macro memory_stream_read_1 dst
  73++8C32 ~            	ld hl,(memorystreamcurrentaddr)
  74++8C32 ~            	memory_stream_read_byte dst
  75++8C32 ~            	ld (memorystreamcurrentaddr),hl
  76++8C32              	endm
  77++8C32
  78++8C32              	macro memory_stream_read_2 dst1,dst2
  79++8C32 ~            	ld hl,(memorystreamcurrentaddr)
  80++8C32 ~            	memory_stream_read_byte dst1
  81++8C32 ~            	memory_stream_read_byte dst2
  82++8C32 ~            	ld (memorystreamcurrentaddr),hl
  83++8C32              	endm
  84++8C32
  85++8C32              	macro memory_stream_read_3 dst1,dst2,dst3
  86++8C32 ~            	ld hl,(memorystreamcurrentaddr)
  87++8C32 ~            	memory_stream_read_byte dst1
  88++8C32 ~            	memory_stream_read_byte dst2
  89++8C32 ~            	memory_stream_read_byte dst3
  90++8C32 ~            	ld (memorystreamcurrentaddr),hl
  91++8C32              	endm
  92++8C32
  93++8C32              memorystreamread1
  94++8C32              ;out: a = byte
  95++8C32              	memory_stream_read_1 a
  95++8C32 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
  95++8C35             >	memory_stream_read_byte a
  95++8C35 CB 74       >	bit 6,h
  95++8C37             >        IF AREA_C000_FFFF=1
  95++8C37 CC 0D 8C    >	call z,memorystreamnextpage
  95++8C3A             >        ELSE
  95++8C3A ~           > 	call nz,memorystreamnextpage
  95++8C3A             >        ENDIF
  95++8C3A 7E          >	ld a,(hl)
  95++8C3B 23          >	inc hl
  95++8C3C 22 72 8C    >	ld (memorystreamcurrentaddr),hl
  96++8C3F C9           	ret
  97++8C40
  98++8C40              memorystreamread2
  99++8C40              ;out: de = word
 100++8C40              	memory_stream_read_2 e,d
 100++8C40 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 100++8C43             >	memory_stream_read_byte e
 100++8C43 CB 74       >	bit 6,h
 100++8C45             >        IF AREA_C000_FFFF=1
 100++8C45 CC 0D 8C    >	call z,memorystreamnextpage
 100++8C48             >        ELSE
 100++8C48 ~           > 	call nz,memorystreamnextpage
 100++8C48             >        ENDIF
 100++8C48 5E          >	ld e,(hl)
 100++8C49 23          >	inc hl
 100++8C4A             >	memory_stream_read_byte d
 100++8C4A CB 74       >	bit 6,h
 100++8C4C             >        IF AREA_C000_FFFF=1
 100++8C4C CC 0D 8C    >	call z,memorystreamnextpage
 100++8C4F             >        ELSE
 100++8C4F ~           > 	call nz,memorystreamnextpage
 100++8C4F             >        ENDIF
 100++8C4F 56          >	ld d,(hl)
 100++8C50 23          >	inc hl
 100++8C51 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 101++8C54 C9           	ret
 102++8C55
 103++8C55              memorystreamread3
 104++8C55              ;out: c = byte0, e = byte1, d = byte2
 105++8C55              	memory_stream_read_3 c,e,d
 105++8C55 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 105++8C58             >	memory_stream_read_byte c
 105++8C58 CB 74       >	bit 6,h
 105++8C5A             >        IF AREA_C000_FFFF=1
 105++8C5A CC 0D 8C    >	call z,memorystreamnextpage
 105++8C5D             >        ELSE
 105++8C5D ~           > 	call nz,memorystreamnextpage
 105++8C5D             >        ENDIF
 105++8C5D 4E          >	ld c,(hl)
 105++8C5E 23          >	inc hl
 105++8C5F             >	memory_stream_read_byte e
 105++8C5F CB 74       >	bit 6,h
 105++8C61             >        IF AREA_C000_FFFF=1
 105++8C61 CC 0D 8C    >	call z,memorystreamnextpage
 105++8C64             >        ELSE
 105++8C64 ~           > 	call nz,memorystreamnextpage
 105++8C64             >        ENDIF
 105++8C64 5E          >	ld e,(hl)
 105++8C65 23          >	inc hl
 105++8C66             >	memory_stream_read_byte d
 105++8C66 CB 74       >	bit 6,h
 105++8C68             >        IF AREA_C000_FFFF=1
 105++8C68 CC 0D 8C    >	call z,memorystreamnextpage
 105++8C6B             >        ELSE
 105++8C6B ~           > 	call nz,memorystreamnextpage
 105++8C6B             >        ENDIF
 105++8C6B 56          >	ld d,(hl)
 105++8C6C 23          >	inc hl
 105++8C6D 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 106++8C70 C9           	ret
 107++8C71
 108++8C71              memorystreamread4
 109++8C71              ;out: adbc = dword
 110++8C71              memorystreamcurrentaddr=$+1
 111++8C71 21 00 00     	ld hl,0
 112++8C74              	memory_stream_read_byte c
 112++8C74 CB 74       >	bit 6,h
 112++8C76             >        IF AREA_C000_FFFF=1
 112++8C76 CC 0D 8C    >	call z,memorystreamnextpage
 112++8C79             >        ELSE
 112++8C79 ~           > 	call nz,memorystreamnextpage
 112++8C79             >        ENDIF
 112++8C79 4E          >	ld c,(hl)
 112++8C7A 23          >	inc hl
 113++8C7B              	memory_stream_read_byte b
 113++8C7B CB 74       >	bit 6,h
 113++8C7D             >        IF AREA_C000_FFFF=1
 113++8C7D CC 0D 8C    >	call z,memorystreamnextpage
 113++8C80             >        ELSE
 113++8C80 ~           > 	call nz,memorystreamnextpage
 113++8C80             >        ENDIF
 113++8C80 46          >	ld b,(hl)
 113++8C81 23          >	inc hl
 114++8C82              	memory_stream_read_byte d
 114++8C82 CB 74       >	bit 6,h
 114++8C84             >        IF AREA_C000_FFFF=1
 114++8C84 CC 0D 8C    >	call z,memorystreamnextpage
 114++8C87             >        ELSE
 114++8C87 ~           > 	call nz,memorystreamnextpage
 114++8C87             >        ENDIF
 114++8C87 56          >	ld d,(hl)
 114++8C88 23          >	inc hl
 115++8C89              	memory_stream_read_byte a
 115++8C89 CB 74       >	bit 6,h
 115++8C8B             >        IF AREA_C000_FFFF=1
 115++8C8B CC 0D 8C    >	call z,memorystreamnextpage
 115++8C8E             >        ELSE
 115++8C8E ~           > 	call nz,memorystreamnextpage
 115++8C8E             >        ENDIF
 115++8C8E 7E          >	ld a,(hl)
 115++8C8F 23          >	inc hl
 116++8C90 22 72 8C     	ld (memorystreamcurrentaddr),hl
 117++8C93 C9           	ret
 118++8C94
 119++8C94              memorystreamread
 120++8C94              ;bc = number of bytes
 121++8C94              ;de = dest addr
 122++8C94 79           	ld a,c
 123++8C95 0B           	dec bc
 124++8C96 04           	inc b
 125++8C97 48           	ld c,b
 126++8C98 47           	ld b,a
 127++8C99 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 128++8C9C              .readloop
 129++8C9C              	memory_stream_read_byte a
 129++8C9C CB 74       >	bit 6,h
 129++8C9E             >        IF AREA_C000_FFFF=1
 129++8C9E CC 0D 8C    >	call z,memorystreamnextpage
 129++8CA1             >        ELSE
 129++8CA1 ~           > 	call nz,memorystreamnextpage
 129++8CA1             >        ENDIF
 129++8CA1 7E          >	ld a,(hl)
 129++8CA2 23          >	inc hl
 130++8CA3 12           	ld (de),a
 131++8CA4 13           	inc de
 132++8CA5 10 F5        	djnz .readloop
 133++8CA7 0D           	dec c
 134++8CA8 20 F2        	jr nz,.readloop
 135++8CAA 22 72 8C     	ld (memorystreamcurrentaddr),hl
 136++8CAD C9           	ret
 137++8CAE
 138++8CAE              memorystreamwrite
 139++8CAE              ;bc = number of bytes
 140++8CAE              ;de = src addr
 141++8CAE 79           	ld a,c
 142++8CAF 0B           	dec bc
 143++8CB0 04           	inc b
 144++8CB1 48           	ld c,b
 145++8CB2 47           	ld b,a
 146++8CB3 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 147++8CB6              .writeloop
 148++8CB6 1A           	ld a,(de)
 149++8CB7              	memory_stream_write_byte a
 149++8CB7 CB 74       >	bit 6,h
 149++8CB9             >        IF AREA_C000_FFFF=1
 149++8CB9 CC 0D 8C    >	call z,memorystreamnextpage
 149++8CBC             >        ELSE
 149++8CBC ~           > 	call nz,memorystreamnextpage
 149++8CBC             >        ENDIF
 149++8CBC 77          >	ld (hl),a
 149++8CBD 23          >	inc hl
 150++8CBE 13           	inc de
 151++8CBF 10 F5        	djnz .writeloop
 152++8CC1 0D           	dec c
 153++8CC2 20 F2        	jr nz,.writeloop
 154++8CC4 22 72 8C     	ld (memorystreamcurrentaddr),hl
 155++8CC7 C9           	ret
 156++8CC8
 157++8CC8              memorystreamseek
 158++8CC8              ;dehl = absolute position
 159++8CC8              ;out: hl = read address
 160++8CC8 7B           	ld a,e
 161++8CC9 44           	ld b,h
 162++8CCA CB 20        	sla b
 163++8CCC 17           	rla
 164++8CCD CB 20        	sla b
 165++8CCF 17           	rla
 166++8CD0 C6 00        	add a,memorystreampages%256
 167++8CD2 5F           	ld e,a
 168++8CD3 CE 8B        	adc a,memorystreampages/256
 169++8CD5 93           	sub e
 170++8CD6 57           	ld d,a
 171++8CD7 1A           	ld a,(de)
 172++8CD8 32 16 92     	ld (memorystreamcurrentpage),a
 173++8CDB 13           	inc de
 174++8CDC ED 53 0E 8C  	ld (memorystreampageaddr),de
 175++8CE0                      IF AREA_C000_FFFF=1
 176++8CE0              	;SETPGC000
 177++8CE0 E5           	push hl ;*
 178++8CE1              	OS_SET_PAGE_SLOT3
 178++8CE1 0E 1C       >    ld c,#1c
 178++8CE3 E7          >    rst #20
 179++8CE4 E1           	pop hl ;*
 180++8CE5 CB F4                set 6,h
 181++8CE7                      ELSE
 182++8CE7 ~            	SETPG8000
 183++8CE7 ~            	res 6,h
 184++8CE7                      ENDIF
 185++8CE7 CB FC        	set 7,h
 186++8CE9 22 72 8C     	ld (memorystreamcurrentaddr),hl
 187++8CEC C9           	ret
 188++8CED
 189++8CED              memorystreamgetpos
 190++8CED              ;out: dehl = absolute position
 191++8CED 2A 0E 8C     	ld hl,(memorystreampageaddr)
 192++8CF0 11 FF 74     	ld de,-memorystreampages-1
 193++8CF3 19           	add hl,de
 194++8CF4 EB           	ex de,hl
 195++8CF5 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 196++8CF8
 197++8CF8                      IF AREA_C000_FFFF=1
 198++8CF8 CB 7C                bit 7,h
 199++8CFA CB BC                res 7,h
 200++8CFC CB B4                res 6,h
 201++8CFE 20 04        	jr nz,$+6
 202++8D00                      ELSE
 203++8D00 ~            	res 7,h
 204++8D00 ~            	bit 6,h
 205++8D00 ~            ;	jr z,$+6
 206++8D00                      ENDIF
 207++8D00 20 04        	jr nz,$+6
 208++8D02 13           	inc de
 209++8D03 21 00 00     	ld hl,0
 210++8D06 AF           	xor a
 211++8D07 CB 1B        	rr e
 212++8D09 1F           	rra
 213++8D0A CB 1B        	rr e
 214++8D0C 1F           	rra
 215++8D0D B4           	or h
 216++8D0E 67           	ld h,a
 217++8D0F C9           	ret
 218++8D10
 219++8D10              memorystreamsize
 220++8D10 00 00 00 00  	ds 4
 221++8D14
# file closed: GPlay/common/memorystream.asm
  74++8D14              	include "common/opl4.asm"
# file opened: GPlay/common/opl4.asm
   1++8D14              	include "moonsound.asm"
# file opened: GPlay/common/moonsound.asm
   1++8D14              MOON_BASE = 0xc4
   2++8D14              MOON_REG1 = MOON_BASE
   3++8D14              MOON_DAT1 = MOON_BASE+1  ;c5
   4++8D14              MOON_REG2 = MOON_BASE+2  ;c6
   5++8D14              MOON_DAT2 = MOON_BASE+3  ;c7
   6++8D14              MOON_STAT = MOON_BASE
   7++8D14              MOON_WREG = 0xc2
   8++8D14              MOON_WDAT = MOON_WREG+1
   9++8D14
  10++8D14              ;TODO: is this good enough for ATM2?
  11++8D14              	macro opl4_wait
  12++8D14 ~            	in a,(MOON_STAT)
  13++8D14 ~            	rrca
  14++8D14 ~            	jr c,$-3
  15++8D14              	endm
  16++8D14
  17++8D14              ;makes ZXM-Moonsound firmware 1.01 switch PCM ports from default 7E and 7F to C2 and C3
  18++8D14              	macro switch_to_pcm_ports_c2_c3
  19++8D14 ~            	in a,(MOON_REG2)
  20++8D14              	endm
  21++8D14
  22++8D14
  23++8D14
  24++8D14              NR_OF_MIDI_CHANNELS = 16
  25++8D14              NR_OF_WAVE_CHANNELS = 24
  26++8D14
  27++8D14
  28++8D14
  29++8D14              MOONSOUNDROMSIZE = 0x200000
  30++8D14              MOONWAVEHEADERSIZE = 12
  31++8D14              MOONRAMWAVETABLESIZE = 128
  32++8D14              OPL4MAXWAVECHANNELS = NR_OF_WAVE_CHANNELS
  33++8D14
  34++8D14              OPL4_TIMER1_COUNT   = 0x02
  35++8D14              OPL4_TIMER2_COUNT   = 0x03
  36++8D14              OPL4_TIMER_CONTROL  = 0x04
  37++8D14
  38++8D14
  39++8D14
  40++8D14
  41++8D14              OPL4_REG_TEST0               = 0x00
  42++8D14              OPL4_REG_TEST1               = 0x01
  43++8D14
  44++8D14              OPL4_REG_MEMORY_CONFIGURATION = 0x02
  45++8D14              OPL4_MODE_BIT                 = 0x01
  46++8D14              OPL4_MTYPE_BIT                = 0x02
  47++8D14              OPL4_TONE_HEADER_MASK         = 0x1C
  48++8D14              OPL4_DEVICE_ID_MASK           = 0xE0
  49++8D14
  50++8D14              OPL4_REG_MEMORY_ADDRESS_HIGH  = 0x03
  51++8D14              OPL4_REG_MEMORY_ADDRESS_MID   = 0x04
  52++8D14              OPL4_REG_MEMORY_ADDRESS_LOW   = 0x05
  53++8D14              OPL4_REG_MEMORY_DATA          = 0x06
  54++8D14
  55++8D14 ~            /*
  56++8D14 ~             * Offsets to the register banks for voices. To get the
  57++8D14 ~             * register number just add the voice number to the bank offset.
  58++8D14 ~             *
  59++8D14 ~             * Wave Table Number low bits (0x08 to 0x1F)
  60++8D14 ~             */
  61++8D14              OPL4_REG_TONE_NUMBER  = 0x08
  62++8D14
  63++8D14 ~            /* Wave Table Number high bit, F-Number low bits (0x20 to 0x37) */
  64++8D14              OPL4_REG_F_NUMBER      = 0x20
  65++8D14              OPL4_TONE_NUMBER_BIT8  = 0x01
  66++8D14              OPL4_F_NUMBER_LOW_MASK = 0xFE
  67++8D14
  68++8D14 ~            /* F-Number high bits, Octave, Pseudo-Reverb (0x38 to 0x4F) */
  69++8D14              OPL4_REG_OCTAVE         = 0x38
  70++8D14              OPL4_F_NUMBER_HIGH_MASK = 0x07
  71++8D14              OPL4_BLOCK_MASK         = 0xF0
  72++8D14              OPL4_PSEUDO_REVERB_BIT  = 0x08
  73++8D14
  74++8D14 ~            /* Total Level, Level Direct (0x50 to 0x67) */
  75++8D14              OPL4_REG_LEVEL        = 0x50
  76++8D14              OPL4_TOTAL_LEVEL_MASK = 0xFE
  77++8D14              OPL4_LEVEL_DIRECT_BIT = 0x01
  78++8D14
  79++8D14 ~            /* Key On, Damp, LFO RST, CH, Panpot (0x68 to 0x7F) */
  80++8D14              OPL4_REG_MISC           = 0x68
  81++8D14              OPL4_KEY_ON_BIT         = 0x80
  82++8D14              OPL4_DAMP_BIT           = 0x40
  83++8D14              OPL4_LFO_RESET_BIT      = 0x20
  84++8D14              OPL4_OUTPUT_CHANNEL_BIT = 0x10
  85++8D14              OPL4_PAN_POT_MASK       = 0x0F
  86++8D14
  87++8D14 ~            /* LFO, VIB (0x80 to 0x97) */
  88++8D14              OPL4_REG_LFO_VIBRATO    = 0x80
  89++8D14              OPL4_LFO_FREQUENCY_MASK = 0x38
  90++8D14              OPL4_VIBRATO_DEPTH_MASK = 0x07
  91++8D14              OPL4_CHORUS_SEND_MASK   = 0xC0
  92++8D14
  93++8D14 ~            /* Attack / Decay 1 rate (0x98 to 0xAF) */
  94++8D14              OPL4_REG_ATTACK_DECAY1  = 0x98
  95++8D14              OPL4_ATTACK_RATE_MASK   = 0xF0
  96++8D14              OPL4_DECAY1_RATE_MASK   = 0x0F
  97++8D14
  98++8D14 ~            /* Decay level / 2 rate (0xB0 to 0xC7) */
  99++8D14              OPL4_REG_LEVEL_DECAY2  = 0xB0
 100++8D14              OPL4_DECAY_LEVEL_MASK  = 0xF0
 101++8D14              OPL4_DECAY2_RATE_MASK  = 0x0F
 102++8D14
 103++8D14 ~            /* Release rate / Rate correction (0xC8 to 0xDF) */
 104++8D14              OPL4_REG_RELEASE_CORRECTION  = 0xC8
 105++8D14              OPL4_RELEASE_RATE_MASK       = 0x0F
 106++8D14              OPL4_RATE_INTERPOLATION_MASK = 0xF0
 107++8D14
 108++8D14 ~            /* AM (0xE0 to 0xF7) */
 109++8D14              OPL4_REG_TREMOLO        = 0xE0
 110++8D14              OPL4_TREMOLO_DEPTH_MASK = 0x07
 111++8D14              OPL4_REVERB_SEND_MASK   = 0xE0
 112++8D14
 113++8D14 ~            /* Mixer */
 114++8D14              OPL4_REG_MIX_CONTROL_FM  = 0xF8
 115++8D14              OPL4_REG_MIX_CONTROL_PCM = 0xF9
 116++8D14              OPL4_MIX_LEFT_MASK       = 0x07
 117++8D14              OPL4_MIX_RIGHT_MASK      = 0x38
 118++8D14
 119++8D14              OPL4_REG_ATC             = 0xFA
 120++8D14              OPL4_ATC_BIT             = 0x01
 121++8D14
 122++8D14 ~            /* Bits in the OPL4 Status register */
 123++8D14              OPL4_STATUS_BUSY = 0x01
 124++8D14              OPL4_STATUS_LOAD = 0x02
 125++8D14
# file closed: GPlay/common/moonsound.asm
   2++8D14
   3++8D14              opl4writefm1
   4++8D14              ;e = register
   5++8D14              ;d = value
   6++8D14              	opl4_wait
   6++8D14 DB C4       >	in a,(MOON_STAT)
   6++8D16 0F          >	rrca
   6++8D17 38 FB       >	jr c,$-3
   7++8D19 7B           	ld a,e
   8++8D1A D3 C4        	out (MOON_REG1),a
   9++8D1C              	opl4_wait
   9++8D1C DB C4       >	in a,(MOON_STAT)
   9++8D1E 0F          >	rrca
   9++8D1F 38 FB       >	jr c,$-3
  10++8D21 7A           	ld a,d
  11++8D22 D3 C5        	out (MOON_DAT1),a
  12++8D24 C9           	ret
  13++8D25
  14++8D25              opl4writefm2
  15++8D25              ;e = register
  16++8D25              ;d = value
  17++8D25              	opl4_wait
  17++8D25 DB C4       >	in a,(MOON_STAT)
  17++8D27 0F          >	rrca
  17++8D28 38 FB       >	jr c,$-3
  18++8D2A 7B           	ld a,e
  19++8D2B D3 C6        	out (MOON_REG2),a
  20++8D2D              	opl4_wait
  20++8D2D DB C4       >	in a,(MOON_STAT)
  20++8D2F 0F          >	rrca
  20++8D30 38 FB       >	jr c,$-3
  21++8D32 7A           	ld a,d
  22++8D33 D3 C7        	out (MOON_DAT2),a
  23++8D35 C9           	ret
  24++8D36
  25++8D36              opl4writewave
  26++8D36              ;e = register
  27++8D36              ;d = value
  28++8D36              	opl4_wait
  28++8D36 DB C4       >	in a,(MOON_STAT)
  28++8D38 0F          >	rrca
  28++8D39 38 FB       >	jr c,$-3
  29++8D3B 7B           	ld a,e
  30++8D3C D3 C2        	out (MOON_WREG),a
  31++8D3E              	opl4_wait
  31++8D3E DB C4       >	in a,(MOON_STAT)
  31++8D40 0F          >	rrca
  31++8D41 38 FB       >	jr c,$-3
  32++8D43 7A           	ld a,d
  33++8D44 D3 C3        	out (MOON_WDAT),a
  34++8D46 C9           	ret
  35++8D47
  36++8D47              opl4readwave
  37++8D47              ;e = register
  38++8D47              	opl4_wait
  38++8D47 DB C4       >	in a,(MOON_STAT)
  38++8D49 0F          >	rrca
  38++8D4A 38 FB       >	jr c,$-3
  39++8D4C 7B           	ld a,e
  40++8D4D D3 C2        	out (MOON_WREG),a
  41++8D4F              	opl4_wait
  41++8D4F DB C4       >	in a,(MOON_STAT)
  41++8D51 0F          >	rrca
  41++8D52 38 FB       >	jr c,$-3
  42++8D54 DB C3        	in a,(MOON_WDAT)
  43++8D56 C9           	ret
  44++8D57
  45++8D57              	macro opl4_write_fm_regs
  46++8D57 ~            ;e = base register
  47++8D57 ~            ;d = value
  48++8D57 ~            ;b = count
  49++8D57 ~            .loop
  50++8D57 ~            	call opl4writefm1
  51++8D57 ~            	call opl4writefm2
  52++8D57 ~            	inc e
  53++8D57 ~            	djnz .loop
  54++8D57              	endm
  55++8D57
  56++8D57              	macro opl4_write_wave_regs
  57++8D57 ~            ;e = base register
  58++8D57 ~            ;d = value
  59++8D57 ~            ;b = count
  60++8D57 ~            .loop
  61++8D57 ~            	call opl4writewave
  62++8D57 ~            	inc e
  63++8D57 ~            	djnz .loop
  64++8D57              	endm
  65++8D57
  66++8D57              opl4init
  67++8D57 11 05 03     	ld de,0x0305
  68++8D5A CD 25 8D     	call opl4writefm2
  69++8D5D 06 DA        	ld b,0xda
  70++8D5F 11 20 00     	ld de,0x0020
  71++8D62              	opl4_write_wave_regs
  71++8D62             >;e = base register
  71++8D62             >;d = value
  71++8D62             >;b = count
  71++8D62             >.loop
  71++8D62 CD 36 8D    >	call opl4writewave
  71++8D65 1C          >	inc e
  71++8D66 10 FA       >	djnz .loop
  72++8D68 11 F8 1B     	ld de,0x1bf8
  73++8D6B CD 36 8D     	call opl4writewave
  74++8D6E 11 02 10     	ld de,0x1002
  75++8D71 CD 36 8D     	call opl4writewave
  76++8D74 06 D6        	ld b,0xd6
  77++8D76 11 20 00     	ld de,0x0020
  78++8D79              	opl4_write_fm_regs
  78++8D79             >;e = base register
  78++8D79             >;d = value
  78++8D79             >;b = count
  78++8D79             >.loop
  78++8D79 CD 14 8D    >	call opl4writefm1
  78++8D7C CD 25 8D    >	call opl4writefm2
  78++8D7F 1C          >	inc e
  78++8D80 10 F7       >	djnz .loop
  79++8D82 11 01 00     	ld de,0x0001
  80++8D85 CD 14 8D     	call opl4writefm1
  81++8D88 11 08 00     	ld de,0x0008
  82++8D8B CD 14 8D     	call opl4writefm1
  83++8D8E 11 04 00     	ld de,0x0004
  84++8D91 C3 25 8D     	jp opl4writefm2
  85++8D94
  86++8D94              opl4stoptimers
  87++8D94 11 04 80     	ld de,0x8004
  88++8D97 CD 14 8D     	call opl4writefm1
  89++8D9A 11 04 00     	ld de,0x0004
  90++8D9D C3 14 8D     	jp opl4writefm1
  91++8DA0
  92++8DA0              opl4mute
  93++8DA0 CD 94 8D     	call opl4stoptimers
  94++8DA3 11 04 00     	ld de,0x0004
  95++8DA6 CD 25 8D     	call opl4writefm2
  96++8DA9 11 BD 00     	ld de,0x00bd
  97++8DAC CD 14 8D     	call opl4writefm1 ;rhythm off
  98++8DAF 06 16        	ld b,0x16
  99++8DB1 11 80 0F     	ld de,0x0f80
 100++8DB4              	opl4_write_fm_regs ;max release rate
 100++8DB4             >;e = base register
 100++8DB4             >;d = value
 100++8DB4             >;b = count
 100++8DB4             >.loop
 100++8DB4 CD 14 8D    >	call opl4writefm1
 100++8DB7 CD 25 8D    >	call opl4writefm2
 100++8DBA 1C          >	inc e
 100++8DBB 10 F7       >	djnz .loop
 101++8DBD 06 16        	ld b,0x16
 102++8DBF 11 40 3F     	ld de,0x3f40
 103++8DC2              	opl4_write_fm_regs ;min total level
 103++8DC2             >;e = base register
 103++8DC2             >;d = value
 103++8DC2             >;b = count
 103++8DC2             >.loop
 103++8DC2 CD 14 8D    >	call opl4writefm1
 103++8DC5 CD 25 8D    >	call opl4writefm2
 103++8DC8 1C          >	inc e
 103++8DC9 10 F7       >	djnz .loop
 104++8DCB 06 09        	ld b,0x09
 105++8DCD 11 A0 00     	ld de,0x00a0
 106++8DD0              	opl4_write_fm_regs ;frequency 0
 106++8DD0             >;e = base register
 106++8DD0             >;d = value
 106++8DD0             >;b = count
 106++8DD0             >.loop
 106++8DD0 CD 14 8D    >	call opl4writefm1
 106++8DD3 CD 25 8D    >	call opl4writefm2
 106++8DD6 1C          >	inc e
 106++8DD7 10 F7       >	djnz .loop
 107++8DD9 06 09        	ld b,0x09
 108++8DDB 11 B0 00     	ld de,0x00b0
 109++8DDE              	opl4_write_fm_regs ;key off
 109++8DDE             >;e = base register
 109++8DDE             >;d = value
 109++8DDE             >;b = count
 109++8DDE             >.loop
 109++8DDE CD 14 8D    >	call opl4writefm1
 109++8DE1 CD 25 8D    >	call opl4writefm2
 109++8DE4 1C          >	inc e
 109++8DE5 10 F7       >	djnz .loop
 110++8DE7 06 18        	ld b,0x18
 111++8DE9 11 68 40     	ld de,0x4068
 112++8DEC              	opl4_write_wave_regs ;key off, damp
 112++8DEC             >;e = base register
 112++8DEC             >;d = value
 112++8DEC             >;b = count
 112++8DEC             >.loop
 112++8DEC CD 36 8D    >	call opl4writewave
 112++8DEF 1C          >	inc e
 112++8DF0 10 FA       >	djnz .loop
 113++8DF2 11 05 00     	ld de,0x0005
 114++8DF5 C3 25 8D     	jp opl4writefm2
 115++8DF8
 116++8DF8              opl4setmemoryaddress
 117++8DF8              ;dhl = memory address
 118++8DF8 1E 03        	ld e,0x03
 119++8DFA CD 36 8D     	call opl4writewave
 120++8DFD 54           	ld d,h
 121++8DFE 1C           	inc e
 122++8DFF CD 36 8D     	call opl4writewave
 123++8E02 1C           	inc e
 124++8E03 55           	ld d,l
 125++8E04 C3 36 8D     	jp opl4writewave
 126++8E07
 127++8E07              opl4readmemory
 128++8E07              ;bc = byte count
 129++8E07              ;dhl = memory address
 130++8E07              ;ix = buffer
 131++8E07 CD F8 8D     	call opl4setmemoryaddress
 132++8E0A 11 02 11     	ld de,0x1102
 133++8E0D CD 36 8D     	call opl4writewave
 134++8E10              	opl4_wait
 134++8E10 DB C4       >	in a,(MOON_STAT)
 134++8E12 0F          >	rrca
 134++8E13 38 FB       >	jr c,$-3
 135++8E15 3E 06        	ld a,6
 136++8E17 D3 C2        	out (MOON_WREG),a
 137++8E19 DD 54 DD 5D  	ld de,ix
 138++8E1D 79           	ld a,c
 139++8E1E 0B           	dec bc
 140++8E1F 04           	inc b
 141++8E20 48           	ld c,b
 142++8E21 47           	ld b,a
 143++8E22              .readloop
 144++8E22              	opl4_wait
 144++8E22 DB C4       >	in a,(MOON_STAT)
 144++8E24 0F          >	rrca
 144++8E25 38 FB       >	jr c,$-3
 145++8E27 DB C3        	in a,(MOON_WDAT)
 146++8E29 12           	ld (de),a
 147++8E2A 13           	inc de
 148++8E2B 10 F5        	djnz .readloop
 149++8E2D 0D           	dec c
 150++8E2E 20 F2        	jr nz,.readloop
 151++8E30 11 02 10     	ld de,0x1002
 152++8E33 C3 36 8D     	jp opl4writewave
 153++8E36
 154++8E36              opl4writememory
 155++8E36              ;bc = number of bytes
 156++8E36              ;dhl = memory address
 157++8E36              ;ix = buffer
 158++8E36 CD F8 8D     	call opl4setmemoryaddress
 159++8E39 11 02 11     	ld de,0x1102
 160++8E3C CD 36 8D     	call opl4writewave
 161++8E3F              	opl4_wait
 161++8E3F DB C4       >	in a,(MOON_STAT)
 161++8E41 0F          >	rrca
 161++8E42 38 FB       >	jr c,$-3
 162++8E44 3E 06        	ld a,6
 163++8E46 D3 C2        	out (MOON_WREG),a
 164++8E48 DD 54 DD 5D  	ld de,ix
 165++8E4C 79           	ld a,c
 166++8E4D 0B           	dec bc
 167++8E4E 04           	inc b
 168++8E4F 48           	ld c,b
 169++8E50 47           	ld b,a
 170++8E51              .writeloop
 171++8E51              	opl4_wait
 171++8E51 DB C4       >	in a,(MOON_STAT)
 171++8E53 0F          >	rrca
 171++8E54 38 FB       >	jr c,$-3
 172++8E56 1A           	ld a,(de)
 173++8E57 D3 C3        	out (MOON_WDAT),a
 174++8E59 13           	inc de
 175++8E5A 10 F5        	djnz .writeloop
 176++8E5C 0D           	dec c
 177++8E5D 20 F2        	jr nz,.writeloop
 178++8E5F 11 02 10     	ld de,0x1002
 179++8E62 C3 36 8D     	jp opl4writewave
 180++8E65
# file closed: GPlay/common/opl4.asm
  75++8E65              	include "common/opm.asm"
# file opened: GPlay/common/opm.asm
   1++8E65              ;Having chip 0 is mandatory for the player to detect YM2151,
   2++8E65              ;chip 1 is an optional second chip.
   3++8E65
   4++8E65              OPM0_REG = 0xf0c1 ;write: chip 0 address
   5++8E65              OPM0_DAT = 0xf1c1 ;write: chip 0 value, read: chip 0 status
   6++8E65              OPM1_REG = 0xf2c1 ;write: chip 1 address
   7++8E65              OPM1_DAT = 0xf3c1 ;write: chip 1 value, read: chip 1 status
   8++8E65
   9++8E65              	macro opm_write_reg reg,dat
  10++8E65 ~            ;bc = data port
  11++8E65 ~            ;e = register
  12++8E65 ~            ;d = value
  13++8E65 ~            	ld bc,dat
  14++8E65 ~            	in f,(c)
  15++8E65 ~            	jp m,$-2
  16++8E65 ~            	ld bc,reg
  17++8E65 ~            	out (c),e
  18++8E65 ~            	ld bc,dat
  19++8E65 ~            	in f,(c)
  20++8E65 ~            	jp m,$-2
  21++8E65 ~            	out (c),d
  22++8E65              	endm
  23++8E65
  24++8E65              opmwriteall
  25++8E65              ;e = register
  26++8E65              ;d = value
  27++8E65 CD 80 8E     	call opmwritechip1
  28++8E68              opmwritechip0
  29++8E68              ;e = register
  30++8E68              ;d = value
  31++8E68              	opm_write_reg OPM0_REG,OPM0_DAT
  31++8E68             >;bc = data port
  31++8E68             >;e = register
  31++8E68             >;d = value
  31++8E68 01 C1 F1    >	ld bc,OPM0_DAT
  31++8E6B ED 70       >	in f,(c)
  31++8E6D FA 6B 8E    >	jp m,$-2
  31++8E70 01 C1 F0    >	ld bc,OPM0_REG
  31++8E73 ED 59       >	out (c),e
  31++8E75 01 C1 F1    >	ld bc,OPM0_DAT
  31++8E78 ED 70       >	in f,(c)
  31++8E7A FA 78 8E    >	jp m,$-2
  31++8E7D ED 51       >	out (c),d
  32++8E7F C9           	ret
  33++8E80
  34++8E80              opmwritechip1
  35++8E80              ;e = register
  36++8E80              ;d = value
  37++8E80              	opm_write_reg OPM1_REG,OPM1_DAT
  37++8E80             >;bc = data port
  37++8E80             >;e = register
  37++8E80             >;d = value
  37++8E80 01 C1 F3    >	ld bc,OPM1_DAT
  37++8E83 ED 70       >	in f,(c)
  37++8E85 FA 83 8E    >	jp m,$-2
  37++8E88 01 C1 F2    >	ld bc,OPM1_REG
  37++8E8B ED 59       >	out (c),e
  37++8E8D 01 C1 F3    >	ld bc,OPM1_DAT
  37++8E90 ED 70       >	in f,(c)
  37++8E92 FA 90 8E    >	jp m,$-2
  37++8E95 ED 51       >	out (c),d
  38++8E97 C9           	ret
  39++8E98
  40++8E98              opmdisablechip1
  41++8E98 3E C9        	ld a,0xc9 ;ret opcode
  42++8E9A 32 80 8E     	ld (opmwritechip1),a
  43++8E9D C9           	ret
  44++8E9E
  45++8E9E              	macro opm_write_regs incr,incd
  46++8E9E ~            ;e = base register
  47++8E9E ~            ;d = value
  48++8E9E ~            ;l = count
  49++8E9E ~            .loop	call opmwriteall
  50++8E9E ~            	IF incr
  51++8E9E ~            	inc e
  52++8E9E ~            	ENDIF
  53++8E9E ~            	IF incd
  54++8E9E ~            	inc d
  55++8E9E ~            	ENDIF
  56++8E9E ~            	dec l
  57++8E9E ~            	jr nz,.loop
  58++8E9E              	endm
  59++8E9E
  60++8E9E              opminit
  61++8E9E 2E 00        	ld l,0
  62++8EA0 11 00 00     	ld de,0
  63++8EA3              	opm_write_regs 1,0
  63++8EA3             >;e = base register
  63++8EA3             >;d = value
  63++8EA3             >;l = count
  63++8EA3 CD 65 8E    >.loop	call opmwriteall
  63++8EA6             >	IF 1
  63++8EA6 1C          >	inc e
  63++8EA7             >	ENDIF
  63++8EA7             >	IF 0
  63++8EA7 ~           >	inc d
  63++8EA7             >	ENDIF
  63++8EA7 2D          >	dec l
  63++8EA8 20 F9       >	jr nz,.loop
  64++8EAA C9           	ret
  65++8EAB
  66++8EAB              opmstoptimers
  67++8EAB 11 14 30     	ld de,0x3014
  68++8EAE CD 65 8E     	call opmwriteall
  69++8EB1 11 14 00     	ld de,0x0014
  70++8EB4 C3 65 8E     	jp opmwriteall
  71++8EB7
  72++8EB7              opmmute
  73++8EB7 CD AB 8E     	call opmstoptimers
  74++8EBA              ;max release rate
  75++8EBA 2E 20        	ld l,0x20
  76++8EBC 11 E0 0F     	ld de,0x0fe0
  77++8EBF              	opm_write_regs 1,0
  77++8EBF             >;e = base register
  77++8EBF             >;d = value
  77++8EBF             >;l = count
  77++8EBF CD 65 8E    >.loop	call opmwriteall
  77++8EC2             >	IF 1
  77++8EC2 1C          >	inc e
  77++8EC3             >	ENDIF
  77++8EC3             >	IF 0
  77++8EC3 ~           >	inc d
  77++8EC3             >	ENDIF
  77++8EC3 2D          >	dec l
  77++8EC4 20 F9       >	jr nz,.loop
  78++8EC6              ;min total level
  79++8EC6 2E 20        	ld l,0x20
  80++8EC8 11 60 7F     	ld de,0x7f60
  81++8ECB              	opm_write_regs 1,0
  81++8ECB             >;e = base register
  81++8ECB             >;d = value
  81++8ECB             >;l = count
  81++8ECB CD 65 8E    >.loop	call opmwriteall
  81++8ECE             >	IF 1
  81++8ECE 1C          >	inc e
  81++8ECF             >	ENDIF
  81++8ECF             >	IF 0
  81++8ECF ~           >	inc d
  81++8ECF             >	ENDIF
  81++8ECF 2D          >	dec l
  81++8ED0 20 F9       >	jr nz,.loop
  82++8ED2              ;key off
  83++8ED2 2E 08        	ld l,0x08
  84++8ED4 11 08 00     	ld de,0x0008
  85++8ED7              	opm_write_regs 0,1
  85++8ED7             >;e = base register
  85++8ED7             >;d = value
  85++8ED7             >;l = count
  85++8ED7 CD 65 8E    >.loop	call opmwriteall
  85++8EDA             >	IF 0
  85++8EDA ~           >	inc e
  85++8EDA             >	ENDIF
  85++8EDA             >	IF 1
  85++8EDA 14          >	inc d
  85++8EDB             >	ENDIF
  85++8EDB 2D          >	dec l
  85++8EDC 20 F9       >	jr nz,.loop
  86++8EDE C9           	ret
  87++8EDF
# file closed: GPlay/common/opm.asm
  76++8EDF              	include "vgm/opl4.asm"
# file opened: GPlay/vgm/opl4.asm
   1++8EDF              WAVEHEADERBUFFERSIZE = MOONRAMWAVETABLESIZE*MOONWAVEHEADERSIZE
   2++8EDF
   3++8EDF              opl4writemusiconlyfm1
   4++8EDF              ;skips writes to control registers
   5++8EDF              ;e = register
   6++8EDF              ;d = value
   7++8EDF 7B           	ld a,e
   8++8EE0 FE 20        	cp 0x20
   9++8EE2 D2 14 8D     	jp nc,opl4writefm1
  10++8EE5 FE 08        	cp 0x08
  11++8EE7 C0           	ret nz
  12++8EE8 C3 14 8D     	jp opl4writefm1
  13++8EEB
  14++8EEB              opl4writemusiconlyfm2
  15++8EEB              ;skips writes to control registers
  16++8EEB              ;e = register
  17++8EEB              ;d = value
  18++8EEB 7B           	ld a,e
  19++8EEC FE 04        	cp 4
  20++8EEE D8               ret c
  21++8EEF FE 05        	cp 5
  22++8EF1 C8           	ret z
  23++8EF2 C3 25 8D     	jp opl4writefm2
  24++8EF5
  25++8EF5              opl4writewavemusiconly
  26++8EF5              ;skips writes to control registers and handles ROM dumps
  27++8EF5              ;e = register
  28++8EF5              ;d = value
  29++8EF5 7B           	ld a,e
  30++8EF6 FE 38        	cp 0x38
  31++8EF8 D2 36 8D     	jp nc,opl4writewave
  32++8EFB FE 08        	cp 0x08
  33++8EFD D8           	ret c
  34++8EFE FE 20        	cp 0x20
  35++8F00 38 07        	jr c,writewavetableindexlo
  36++8F02              ;force wave table index into 384--511 range if ROM data is loaded
  37++8F02              isromloaded=$+1
  38++8F02 3E 00        	ld a,0
  39++8F04 B2           	or d
  40++8F05 57           	ld d,a
  41++8F06 C3 36 8D     	jp opl4writewave
  42++8F09              writewavetableindexlo
  43++8F09 3A 03 8F     	ld a,(isromloaded)
  44++8F0C 0F           	rrca
  45++8F0D B2           	or d
  46++8F0E 57           	ld d,a
  47++8F0F CD 36 8D     	call opl4writewave
  48++8F12              ;wait for the header to load
  49++8F12 DB C4        	in a,(MOON_STAT)
  50++8F14 E6 03        	and 3
  51++8F16 20 FA        	jr nz,$-4
  52++8F18 C9           	ret
  53++8F19
  54++8F19              vgmopl4init
  55++8F19 AF           	xor a
  56++8F1A 32 03 8F     	ld (isromloaded),a
  57++8F1D 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
  58++8F20 22 5F 8F     	ld (opl4loadramdatablockheader.romsize0),hl
  59++8F23 3E 20        	ld a,MOONSOUNDROMSIZE/65536
  60++8F25 32 63 8F     	ld (opl4loadramdatablockheader.romsize2),a
  61++8F28 C3 57 8D     	jp opl4init
  62++8F2B
  63++8F2B              sub24x16
  64++8F2B              ;dhl = minuend
  65++8F2B              ;bc = subtrahend
  66++8F2B              ;out: cf=1 if negative result, zf=1 if zero
  67++8F2B B7 ED 42     	sub hl,bc
  68++8F2E 38 04        	jr c,.carry
  69++8F30 C0           	ret nz
  70++8F31 7A           	ld a,d
  71++8F32 B7           	or a
  72++8F33 C9           	ret
  73++8F34              .carry
  74++8F34 7A           	ld a,d
  75++8F35 DE 00        	sbc a,0
  76++8F37 57           	ld d,a
  77++8F38 C0           	ret nz
  78++8F39 7D           	ld a,l
  79++8F3A B4           	or h
  80++8F3B C9           	ret
  81++8F3C
  82++8F3C              opl4loadromdatablockheader
  83++8F3C              ;dhl = header+data size
  84++8F3C              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
  85++8F3C D9           	exx
  86++8F3D CD 71 8C     	call memorystreamread4 ;adbc = total rom size
  87++8F40 ED 43 5F 8F  	ld (opl4loadramdatablockheader.romsize0),bc
  88++8F44 7A           	ld a,d
  89++8F45 C6 20        	add 0x20 ;place in RAM
  90++8F47 32 63 8F     	ld (opl4loadramdatablockheader.romsize2),a
  91++8F4A CD 71 8C     	call memorystreamread4 ;adbc = start address
  92++8F4D 60 69        	ld hl,bc
  93++8F4F CB EA        	set 5,d ;place in RAM
  94++8F51 D9           	exx
  95++8F52 01 08 00     	ld bc,8
  96++8F55 18 D4        	jr sub24x16
  97++8F57
  98++8F57              opl4loadramdatablockheader
  99++8F57              ;dhl = header+data size
 100++8F57              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
 101++8F57 D9           	exx
 102++8F58 CD 71 8C     	call memorystreamread4 ;adbc = total ram size
 103++8F5B CD 71 8C     	call memorystreamread4 ;adbc = start address
 104++8F5E              .romsize0=$+1
 105++8F5E 21 00 00     	ld hl,0
 106++8F61 09           	add hl,bc
 107++8F62              .romsize2=$+1
 108++8F62 3E 00        	ld a,0
 109++8F64 8A           	adc a,d
 110++8F65 E6 3F        	and 0x3f
 111++8F67 57           	ld d,a
 112++8F68 D9           	exx
 113++8F69 01 08 00     	ld bc,8
 114++8F6C 18 BD        	jr sub24x16
 115++8F6E
 116++8F6E              setup24bitscounterloop
 117++8F6E              ;dhl = counter
 118++8F6E              ;out: b = inner loop counter, de = outer loop counter
 119++8F6E 5D           	ld e,l
 120++8F6F 01 01 00     	ld bc,1
 121++8F72 B7 ED 42     	sub hl,bc
 122++8F75 30 01        	jr nc,$+3
 123++8F77 15           	dec d
 124++8F78 43           	ld b,e
 125++8F79 5C           	ld e,h
 126++8F7A 13           	inc de
 127++8F7B C9           	ret
 128++8F7C
 129++8F7C              opl4loadsample
 130++8F7C              ;dhl = sample start address
 131++8F7C              ;dhl' = sample size
 132++8F7C 42           	ld b,d
 133++8F7D 11 05 03     	ld de,0x0305
 134++8F80 CD 25 8D     	call opl4writefm2
 135++8F83 50           	ld d,b
 136++8F84 CD F8 8D     	call opl4setmemoryaddress
 137++8F87 11 02 11     	ld de,0x1102
 138++8F8A CD 36 8D     	call opl4writewave
 139++8F8D              	opl4_wait
 139++8F8D DB C4       >	in a,(MOON_STAT)
 139++8F8F 0F          >	rrca
 139++8F90 38 FB       >	jr c,$-3
 140++8F92 3E 06        	ld a,6
 141++8F94 D3 C2        	out (MOON_WREG),a
 142++8F96 D9           	exx
 143++8F97 CD 6E 8F     	call setup24bitscounterloop
 144++8F9A 2A 72 8C     	ld hl,(memorystreamcurrentaddr)
 145++8F9D              .loop
 146++8F9D              	memory_stream_read_byte c
 146++8F9D CB 74       >	bit 6,h
 146++8F9F             >        IF AREA_C000_FFFF=1
 146++8F9F CC 0D 8C    >	call z,memorystreamnextpage
 146++8FA2             >        ELSE
 146++8FA2 ~           > 	call nz,memorystreamnextpage
 146++8FA2             >        ENDIF
 146++8FA2 4E          >	ld c,(hl)
 146++8FA3 23          >	inc hl
 147++8FA4              	opl4_wait
 147++8FA4 DB C4       >	in a,(MOON_STAT)
 147++8FA6 0F          >	rrca
 147++8FA7 38 FB       >	jr c,$-3
 148++8FA9 79           	ld a,c
 149++8FAA D3 C3        	out (MOON_WDAT),a
 150++8FAC 10 EF        	djnz .loop
 151++8FAE 1B           	dec de
 152++8FAF 7B           	ld a,e
 153++8FB0 B2           	or d
 154++8FB1 20 EA        	jr nz,.loop
 155++8FB3 22 72 8C     	ld (memorystreamcurrentaddr),hl
 156++8FB6 11 02 10     	ld de,0x1002
 157++8FB9 C3 36 8D     	jp opl4writewave
 158++8FBC
 159++8FBC              opl4loadramdatablock
 160++8FBC              ;dhl = data+header size
 161++8FBC CD 57 8F     	call opl4loadramdatablockheader
 162++8FBF C8           	ret z
 163++8FC0 D9           	exx
 164++8FC1 18 B9        	jr opl4loadsample
 165++8FC3
 166++8FC3              opl4loadromdatablock
 167++8FC3              ;dhl = data+header size
 168++8FC3 CD 3C 8F     	call opl4loadromdatablockheader
 169++8FC6 C8           	ret z
 170++8FC7 D9           	exx
 171++8FC8 D5           	push de
 172++8FC9 CD 7C 8F     	call opl4loadsample
 173++8FCC F1           	pop af
 174++8FCD              ;check if the address is within the first 64K of RAM
 175++8FCD FE 21        	cp 0x21
 176++8FCF D0           	ret nc
 177++8FD0              ;patch all 128 headers that LSI can read from RAM
 178++8FD0 3E 01        	ld a,1
 179++8FD2 32 03 8F     	ld (isromloaded),a
 180++8FD5 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 181++8FD8 16 20        	ld d,MOONSOUNDROMSIZE/65536
 182++8FDA 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 183++8FDD DD 21 00 B8  	ld ix,waveheaderbuffer
 184++8FE1 CD 07 8E     	call opl4readmemory
 185++8FE4 21 00 B8     	ld hl,waveheaderbuffer
 186++8FE7 11 0C 00     	ld de,MOONWAVEHEADERSIZE
 187++8FEA 06 80        	ld b,MOONRAMWAVETABLESIZE
 188++8FEC              .loop
 189++8FEC CB EE        	set 5,(hl) ;set base address in RAM area
 190++8FEE 19           	add hl,de
 191++8FEF 10 FB        	djnz .loop
 192++8FF1 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 193++8FF4 16 20        	ld d,MOONSOUNDROMSIZE/65536
 194++8FF6 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 195++8FF9 DD 21 00 B8  	ld ix,waveheaderbuffer
 196++8FFD C3 36 8E     	jp opl4writememory
 197++9000
 198++9000              opl4inittimer60hz
 199++9000 11 02 2F     	ld de,0x2f02
 200++9003 CD 14 8D     	call opl4writefm1
 201++9006 11 04 21     	ld de,0x2104
 202++9009 C3 14 8D     	jp opl4writefm1
 203++900C
 204++900C              opl4waittimer60hz
 205++900C DB C4        	in a,(MOON_STAT)
 206++900E 17           	rla
 207++900F 30 FB        	jr nc,opl4waittimer60hz
 208++9011 11 04 81     	ld de,0x8104
 209++9014 C3 14 8D     	jp opl4writefm1
 210++9017
# file closed: GPlay/vgm/opl4.asm
  77++9017              	include "common/opn.asm"
# file opened: GPlay/common/opn.asm
   1++9017              ;Define ENABLE_FM to enable FM DACs
   2++9017
   3++9017              OPN_REG = 0xfffd
   4++9017              OPN_DAT = 0xbffd
   5++9017
   6++9017
   7++9017                      ifdef ENABLE_FM
   8++9017 ~            CHIP0 = %11111000
   9++9017 ~            CHIP1 = %11111001
  10++9017                      else
  11++9017              CHIP0 = %11111100
  12++9017              CHIP1 = %11111101
  13++9017                      endif
  14++9017
  15++9017
  16++9017              ;------------------------------------
  17++9017              opnwriteall
  18++9017 CD 3A 90     	call opnwritefm2
  19++901A              ;------------------------------------
  20++901A              opnwritefm1:
  21++901A              	;opn_write_fm_reg 0
  22++901A 3E FC              	ld a,CHIP0
  23++901C              opnwritefmx:
  24++901C              ;a = chipselect
  25++901C              ;e = register
  26++901C              ;d = value
  27++901C 01 FD FF     	ld bc,OPN_REG
  28++901F ED 79        	out (c),a
  29++9021
  30++9021              1
  31++9021 00           	nop
  31++9022 00            nop
  32++9023              ;        nop:nop:nop
  33++9023 ED 70        	in f,(c)
  34++9025 FA 21 90     	jp m, 1b ;$-6
  35++9028
  36++9028 ED 59        	out (c),e
  37++902A
  38++902A              2
  39++902A 00             	nop
  39++902B 00            nop
  40++902C              ;        nop:nop:nop
  41++902C ED 70        	in f,(c)
  42++902E FA 2A 90     	jp m,2b   ;$-6
  43++9031
  44++9031 06 BF        	ld b,HIGH OPN_DAT
  45++9033 ED 51        	out (c),d
  46++9035
  47++9035              .extradelay ;additional delay for FPGA systems
  48++9035 06 08        	ld b,8
  49++9037 10 FE        	djnz $
  50++9039 C9           	ret
  51++903A              ;------------------------------------
  52++903A              opnwritefm2:
  53++903A 3E FD               	ld a,CHIP1
  54++903C C3 1C 90             jp opnwritefmx
  55++903F              ;------------------------------------
  56++903F
  57++903F
  58++903F              opndisableextradelay
  59++903F 3E C9        	ld a,0xc9 ;ret opcode
  60++9041 32 35 90     	ld (opnwritefmx.extradelay),a
  61++9044 C9           	ret
  62++9045
  63++9045
  64++9045              	macro opn_write_fm_regs incr,incd
  65++9045 ~            ;e = base register
  66++9045 ~            ;d = value
  67++9045 ~            ;l = count
  68++9045 ~            .loop	call opnwriteall
  69++9045 ~            	IF incr
  70++9045 ~            	inc e
  71++9045 ~            	ENDIF
  72++9045 ~            	IF incd
  73++9045 ~            	inc d
  74++9045 ~            	ENDIF
  75++9045 ~            	dec l
  76++9045 ~            	jr nz,.loop
  77++9045              	endm
  78++9045
  79++9045
  80++9045
  81++9045              opninit
  82++9045 2E B4        	ld l,0xb4
  83++9047 11 00 00     	ld de,0x0000
  84++904A              	opn_write_fm_regs 1,0
  84++904A             >;e = base register
  84++904A             >;d = value
  84++904A             >;l = count
  84++904A CD 17 90    >.loop	call opnwriteall
  84++904D             >	IF 1
  84++904D 1C          >	inc e
  84++904E             >	ENDIF
  84++904E             >	IF 0
  84++904E ~           >	inc d
  84++904E             >	ENDIF
  84++904E 2D          >	dec l
  84++904F 20 F9       >	jr nz,.loop
  85++9051              ;configure prescaler
  86++9051 11 2F 00     	ld de,0x002f
  87++9054 CD 17 90     	call opnwriteall
  88++9057 11 2D 00     	ld de,0x002d
  89++905A C3 17 90     	jp opnwriteall
  90++905D
  91++905D              opnstoptimers
  92++905D 11 27 30     	ld de,0x3027
  93++9060 CD 17 90     	call opnwriteall
  94++9063 11 27 00     	ld de,0x0027
  95++9066 C3 17 90     	jp opnwriteall
  96++9069
  97++9069              opnmute
  98++9069 CD 5D 90     	call opnstoptimers
  99++906C              ;mute SSG
 100++906C 2E 03        	ld l,3
 101++906E 11 08 00     	ld de,0x0008
 102++9071              	opn_write_fm_regs 1,0
 102++9071             >;e = base register
 102++9071             >;d = value
 102++9071             >;l = count
 102++9071 CD 17 90    >.loop	call opnwriteall
 102++9074             >	IF 1
 102++9074 1C          >	inc e
 102++9075             >	ENDIF
 102++9075             >	IF 0
 102++9075 ~           >	inc d
 102++9075             >	ENDIF
 102++9075 2D          >	dec l
 102++9076 20 F9       >	jr nz,.loop
 103++9078 2E 0E        	ld l,14
 104++907A 11 00 00     	ld de,0x0000
 105++907D              	opn_write_fm_regs 1,0
 105++907D             >;e = base register
 105++907D             >;d = value
 105++907D             >;l = count
 105++907D CD 17 90    >.loop	call opnwriteall
 105++9080             >	IF 1
 105++9080 1C          >	inc e
 105++9081             >	ENDIF
 105++9081             >	IF 0
 105++9081 ~           >	inc d
 105++9081             >	ENDIF
 105++9081 2D          >	dec l
 105++9082 20 F9       >	jr nz,.loop
 106++9084              ;max release rate
 107++9084 2E 10        	ld l,0x10
 108++9086 11 80 0F     	ld de,0x0f80
 109++9089              	opn_write_fm_regs 1,0
 109++9089             >;e = base register
 109++9089             >;d = value
 109++9089             >;l = count
 109++9089 CD 17 90    >.loop	call opnwriteall
 109++908C             >	IF 1
 109++908C 1C          >	inc e
 109++908D             >	ENDIF
 109++908D             >	IF 0
 109++908D ~           >	inc d
 109++908D             >	ENDIF
 109++908D 2D          >	dec l
 109++908E 20 F9       >	jr nz,.loop
 110++9090              ;min total level
 111++9090 2E 10        	ld l,0x10
 112++9092 11 40 7F     	ld de,0x7f40
 113++9095              	opn_write_fm_regs 1,0
 113++9095             >;e = base register
 113++9095             >;d = value
 113++9095             >;l = count
 113++9095 CD 17 90    >.loop	call opnwriteall
 113++9098             >	IF 1
 113++9098 1C          >	inc e
 113++9099             >	ENDIF
 113++9099             >	IF 0
 113++9099 ~           >	inc d
 113++9099             >	ENDIF
 113++9099 2D          >	dec l
 113++909A 20 F9       >	jr nz,.loop
 114++909C              ;key off
 115++909C 2E 04        	ld l,0x04
 116++909E 11 28 00     	ld de,0x0028
 117++90A1              	opn_write_fm_regs 0,1
 117++90A1             >;e = base register
 117++90A1             >;d = value
 117++90A1             >;l = count
 117++90A1 CD 17 90    >.loop	call opnwriteall
 117++90A4             >	IF 0
 117++90A4 ~           >	inc e
 117++90A4             >	ENDIF
 117++90A4             >	IF 1
 117++90A4 14          >	inc d
 117++90A5             >	ENDIF
 117++90A5 2D          >	dec l
 117++90A6 20 F9       >	jr nz,.loop
 118++90A8              ;default tfm state
 119++90A8 01 FD FF     	ld bc,OPN_REG
 120++90AB 3E FF        	ld a,%11111111
 121++90AD ED 79        	out (c),a
 122++90AF C9           	ret
 123++90B0
# file closed: GPlay/common/opn.asm
  78++90B0              	include "vgm/opn.asm"
# file opened: GPlay/vgm/opn.asm
   1++90B0              opniscontrolregister
   2++90B0              ;a = register
   3++90B0              ;out: zf=1 if it's control register, zf=0 otherwise
   4++90B0 FE 0E        	cp 0x0e ;IO port
   5++90B2 C8           	ret z
   6++90B3 FE 0F        	cp 0x0f ;IO port
   7++90B5 C8           	ret z
   8++90B6 FE 2D        	cp 0x2d ;prescaler
   9++90B8 C8           	ret z
  10++90B9 FE 2E        	cp 0x2e ;prescaler
  11++90BB C8           	ret z
  12++90BC FE 2F        	cp 0x2f ;prescaler
  13++90BE C9           	ret
  14++90BF
  15++90BF              opnwritemusiconlyfm1
  16++90BF              ;skips writes to control registers
  17++90BF              ;e = register
  18++90BF              ;d = value
  19++90BF 7B           	ld a,e
  20++90C0 CD B0 90     	call opniscontrolregister
  21++90C3 C8           	ret z
  22++90C4 FE 27        	cp 0x27 ;timers control
  23++90C6 C2 1A 90     	jp nz,opnwritefm1
  24++90C9 7A           	ld a,d
  25++90CA 32 F8 90     	ld (opntimerctrl),a
  26++90CD F6 0A        	or %00001010 ;avoid altering timer B
  27++90CF 57           	ld d,a
  28++90D0 C3 1A 90     	jp opnwritefm1
  29++90D3
  30++90D3              opnwritemusiconlyfm2
  31++90D3              ;skips writes to control registers
  32++90D3              ;e = register
  33++90D3              ;d = value
  34++90D3 7B           	ld a,e
  35++90D4 CD B0 90     	call opniscontrolregister
  36++90D7 C8           	ret z
  37++90D8 C3 3A 90     	jp opnwritefm2
  38++90DB
  39++90DB              opninittimer60hz
  40++90DB              ;	ld de,0xc626
  41++90DB              ;	ld de,0xca26
  42++90DB 11 26 CD     	ld de,0xcd26
  43++90DE CD 1A 90     	call opnwritefm1
  44++90E1 11 27 2A     	ld de,0x2a27
  45++90E4 C3 1A 90     	jp opnwritefm1
  46++90E7
  47++90E7              opnwaittimer60hz
  48++90E7 01 FD FF     	ld bc,OPN_REG
  49++90EA 3E F8        	ld a,%11111000
  50++90EC ED 79        	out (c),a
  51++90EE              .waitloop
  52++90EE ED 78        	in a,(c)
  53++90F0 E6 02        	and 2
  54++90F2 28 FA        	jr z,.waitloop
  55++90F4 11 27 2A     	ld de,0x2a27
  56++90F7              opntimerctrl=$+1
  57++90F7 3E 00        	ld a,0
  58++90F9 B2           	or d
  59++90FA 57           	ld d,a
  60++90FB C3 1A 90     	jp opnwritefm1
  61++90FE
# file closed: GPlay/vgm/opn.asm
  79++90FE              	include "vgm/opm.asm"
# file opened: GPlay/vgm/opm.asm
   1++90FE              opmwritemusiconlychip0
   2++90FE              ;e = register
   3++90FE              ;d = value
   4++90FE 7B           	ld a,e
   5++90FF FE 08        	cp 8
   6++9101 D8           	ret c
   7++9102 C3 68 8E     	jp opmwritechip0
   8++9105
   9++9105              opmwritemusiconlychip1
  10++9105              ;e = register
  11++9105              ;d = value
  12++9105 7B           	ld a,e
  13++9106 FE 08        	cp 8
  14++9108 D8           	ret c
  15++9109 C3 80 8E     	jp opmwritechip1
  16++910C
  17++910C              vgmopminit
  18++910C 3E 02        	ld a,2
  19++910E 32 15 91     	ld (opmwaittimer100hz.counter),a
  20++9111 C3 9E 8E     	jp opminit
  21++9114
  22++9114              opmwaittimer100hz
  23++9114              .counter=$+1
  24++9114 3E 00        	ld a,0
  25++9116 3D           	dec a
  26++9117 20 02        	jr nz,$+4
  27++9119 3E 02        	ld a,2
  28++911B 32 15 91     	ld (.counter),a
  29++911E C8           	ret z
  30++911F              	;YIELD
  31++911F              	OS_WAIT
  31++911F DF          >	rst #18
  32++9120 C9           	ret
  33++9121
# file closed: GPlay/vgm/opm.asm
  80++9121              	include "vgm/ssg.asm"
# file opened: GPlay/vgm/ssg.asm
   1++9121              SSG_REG = 0xfffd
   2++9121              SSG_DAT = 0xbffd
   3++9121
   4++9121              	macro ssg_write_reg chip_n
   5++9121 ~            ;e = register
   6++9121 ~            ;d = value
   7++9121 ~            	ld bc,SSG_REG
   8++9121 ~            	ld a,chip_n+%11111110
   9++9121 ~            	out (c),a
  10++9121 ~            	out (c),e
  11++9121 ~            	ld bc,SSG_DAT
  12++9121 ~            	out (c),d
  13++9121              	endm
  14++9121
  15++9121              ssgwritemusiconlychip0
  16++9121 7B           	ld a,e
  17++9122 FE 0E        	cp 0x0e
  18++9124 D0           	ret nc
  19++9125              ssgwrite0
  20++9125              ;e = register
  21++9125              ;d = value
  22++9125              	ssg_write_reg 0
  22++9125             >;e = register
  22++9125             >;d = value
  22++9125 01 FD FF    >	ld bc,SSG_REG
  22++9128 3E FE       >	ld a,0+%11111110
  22++912A ED 79       >	out (c),a
  22++912C ED 59       >	out (c),e
  22++912E 01 FD BF    >	ld bc,SSG_DAT
  22++9131 ED 51       >	out (c),d
  23++9133 C9           	ret
  24++9134
  25++9134              ssgwritemusiconlychip1
  26++9134 7B           	ld a,e
  27++9135 FE 0E        	cp 0x0e
  28++9137 D0           	ret nc
  29++9138              ssgwrite1
  30++9138              ;e = register
  31++9138              ;d = value
  32++9138              	ssg_write_reg 1
  32++9138             >;e = register
  32++9138             >;d = value
  32++9138 01 FD FF    >	ld bc,SSG_REG
  32++913B 3E FF       >	ld a,1+%11111110
  32++913D ED 79       >	out (c),a
  32++913F ED 59       >	out (c),e
  32++9141 01 FD BF    >	ld bc,SSG_DAT
  32++9144 ED 51       >	out (c),d
  33++9146 C9           	ret
  34++9147
  35++9147              ssginit
  36++9147 C9           	ret
  37++9148
  38++9148              	macro ssg_write_regs
  39++9148 ~            ;e = base register
  40++9148 ~            ;d = value
  41++9148 ~            ;l = count
  42++9148 ~            .loop
  43++9148 ~            	call ssgwrite0
  44++9148 ~            	call ssgwrite1
  45++9148 ~            	inc e
  46++9148 ~            	dec l
  47++9148 ~            	jr nz,.loop
  48++9148              	endm
  49++9148
  50++9148              ssgmute
  51++9148 2E 03        	ld l,3
  52++914A 11 08 00     	ld de,8
  53++914D              	ssg_write_regs
  53++914D             >;e = base register
  53++914D             >;d = value
  53++914D             >;l = count
  53++914D             >.loop
  53++914D CD 25 91    >	call ssgwrite0
  53++9150 CD 38 91    >	call ssgwrite1
  53++9153 1C          >	inc e
  53++9154 2D          >	dec l
  53++9155 20 F6       >	jr nz,.loop
  54++9157 2E 0E        	ld l,14
  55++9159 11 00 00     	ld de,0
  56++915C              	ssg_write_regs
  56++915C             >;e = base register
  56++915C             >;d = value
  56++915C             >;l = count
  56++915C             >.loop
  56++915C CD 25 91    >	call ssgwrite0
  56++915F CD 38 91    >	call ssgwrite1
  56++9162 1C          >	inc e
  56++9163 2D          >	dec l
  56++9164 20 F6       >	jr nz,.loop
  57++9166 C9           	ret
  58++9167
# file closed: GPlay/vgm/ssg.asm
  81++9167
  82++9167
  83++9167
  84++9167
  85++9167
  86++9167
  87++9167              waittimer50hz
  88++9167              	;YIELD
  89++9167              	OS_WAIT
  89++9167 DF          >	rst #18
  90++9168 C9           	ret
  91++9169
  92++9169
  93++9169              waveheaderbuffer = 0xc000-2048 ;0x5400 ;текущий размер буфера 1536 (128*12)
  94++9169              waveheaderbufferend = waveheaderbuffer+WAVEHEADERBUFFERSIZE
  95++9169              vgmheadercopy = waveheaderbufferend
  96++9169              vgmheadercopyend = vgmheadercopy+HEADER_SIZE_MAX ;(ещё 256)
  97++9169
  98++9169              titlestr = waveheaderbufferend
  99++9169              titlestrend = titlestr+TITLELENGTH
 100++9169
 101++9169
 102++9169              HEADER_CLOCK_YM2203 = vgmheadercopy+0x44
 103++9169              HEADER_CLOCK_YM3812 = vgmheadercopy+0x50
 104++9169              HEADER_CLOCK_YMF262 = vgmheadercopy+0x5c
 105++9169              HEADER_CLOCK_YMF278B = vgmheadercopy+0x60
 106++9169              HEADER_CLOCK_AY8910 = vgmheadercopy+0x74
 107++9169
 108++9169
 109++9169              	macro a_or_dw addr
 110++9169 ~            	ld hl,(addr+0)
 111++9169 ~            	or h
 112++9169 ~            	or l
 113++9169 ~            	ld de,(addr+2)
 114++9169 ~            	or d
 115++9169 ~            	or e
 116++9169              	endm
 117++9169
 118++9169              	macro set_timer wait,ticks
 119++9169 ~            	ld hl,ticks
 120++9169 ~            	ld (waittimerstep),hl
 121++9169              	endm
 122++9169
 123++9169
 124++9169              init_:
 125++9169              	set_timer waittimer50hz,882
 125++9169 21 72 03    >	ld hl,882
 125++916C 22 20 92    >	ld (waittimerstep),hl
 126++916F 21 00 00     	ld hl,0
 127++9172 22 1B 92     	ld (waitcounterlo),hl
 128++9175 AF           	xor a
 129++9176 32 1E 92     	ld (waitcounterhi),a
 130++9179 32 00 92     	ld (devicemask),a
 131++917C
 132++917C 32 14 92           	ld (vgm_play_var),a
 133++917F              ;map header to 0x8000
 134++917F                      ;first page (vgm_header) now in page_plr3
 135++917F                      ;now do init.
 136++917F
 137++917F              ;copy header
 138++917F 01 00 01     	ld bc,HEADER_SIZE_MAX
 139++9182 21 00 BE     	ld hl,vgmheadercopy
 140++9185 11 01 BE     	ld de,vgmheadercopy+1
 141++9188 36 00        	ld (hl),0
 142++918A ED B0        	ldir
 143++918C 2A 34 C0     	ld hl,(HEADER_DATA_OFFSET)  ;если HEADER_DATA_OFFSET == 0 to bc = 0x0040 иначе  bc = 0x0034
 144++918F 7C           	ld a,h
 145++9190 B5           	or l
 146++9191 01 40 00     	ld bc,0x40
 147++9194 28 02        	jr z,$+4
 148++9196 0E 34        	ld c,0x34
 149++9198 09           	add hl,bc
 150++9199 22 F7 91     	ld (.dataoffset),hl
 151++919C                            ;определяем сколько данных заголовка vgm нужно перекинуть в буфер исходя из значения HEADER_DATA_OFFSET
 152++919C 44 4D        	ld bc,hl
 153++919E 21 FF FE     	ld hl,-HEADER_SIZE_MAX-1
 154++91A1 09           	add hl,bc
 155++91A2 30 03        	jr nc,$+5
 156++91A4 01 00 01     	ld bc,HEADER_SIZE_MAX
 157++91A7
 158++91A7 21 00 C0     	ld hl,module
 159++91AA 11 00 BE     	ld de,vgmheadercopy
 160++91AD ED B0        	ldir
 161++91AF              ;setup loop
 162++91AF AF           	xor a
 163++91B0              	a_or_dw HEADER_LOOP_OFFSET
 163++91B0 2A 1C C0    >	ld hl,(HEADER_LOOP_OFFSET+0)
 163++91B3 B4          >	or h
 163++91B4 B5          >	or l
 163++91B5 ED 5B 1E C0 >	ld de,(HEADER_LOOP_OFFSET+2)
 163++91B9 B2          >	or d
 163++91BA B3          >	or e
 164++91BB 22 1E 94     	ld (loopoffsetlo),hl
 165++91BE ED 53 1B 94  	ld (loopoffsethi),de
 166++91C2              ;init Moonsound
 167++91C2 AF           	xor a
 168++91C3              	a_or_dw HEADER_CLOCK_YM3812
 168++91C3 2A 50 BE    >	ld hl,(HEADER_CLOCK_YM3812+0)
 168++91C6 B4          >	or h
 168++91C7 B5          >	or l
 168++91C8 ED 5B 52 BE >	ld de,(HEADER_CLOCK_YM3812+2)
 168++91CC B2          >	or d
 168++91CD B3          >	or e
 169++91CE 32 7C 96     	ld (useYM3812),a
 170++91D1              	a_or_dw HEADER_CLOCK_YMF262
 170++91D1 2A 5C BE    >	ld hl,(HEADER_CLOCK_YMF262+0)
 170++91D4 B4          >	or h
 170++91D5 B5          >	or l
 170++91D6 ED 5B 5E BE >	ld de,(HEADER_CLOCK_YMF262+2)
 170++91DA B2          >	or d
 170++91DB B3          >	or e
 171++91DC 20 14        	jr nz,.opl4notneeded
 172++91DE              	a_or_dw HEADER_CLOCK_YMF278B
 172++91DE 2A 60 BE    >	ld hl,(HEADER_CLOCK_YMF278B+0)
 172++91E1 B4          >	or h
 172++91E2 B5          >	or l
 172++91E3 ED 5B 62 BE >	ld de,(HEADER_CLOCK_YMF278B+2)
 172++91E7 B2          >	or d
 172++91E8 B3          >	or e
 173++91E9 28 07        	jr z,.opl4notneeded
 174++91EB 3A 6E 96     	ld a,(moonsoundstatus)
 175++91EE FE 02        	cp 2
 176++91F0 C0           	ret nz ;jp nz,memorystreamfree ;sets zf=0
 177++91F1 B7           	or a
 178++91F2              .opl4notneeded
 179++91F2 C4 6D 96     	call nz,initYMF278B
 180++91F5 C0           	ret nz  ;jp nz,memorystreamfree ;sets zf=0
 181++91F6              .dataoffset=$+1
 182++91F6 21 00 00     	ld hl,0
 183++91F9 11 00 00     	ld de,0
 184++91FC                      ;init music
 185++91FC CD C8 8C     	call memorystreamseek
 186++91FF              devicemask=$+1
 187++91FF 3E 00        	ld a,0
 188++9201              ;zf=0 if there isn't any supported device
 189++9201 3D           	dec a
 190++9202 F8           	ret m
 191++9203 3C           	inc a
 192++9204 BF           	cp a
 193++9205 C9           	ret
 194++9206
 195++9206
 196++9206
 197++9206
 198++9206
 199++9206
 200++9206
 201++9206
 202++9206              MUTE:
 203++9206 3E C9                        ld a,$C9			;ret	;stop playing
 204++9208 32 14 92                     ld (vgm_play_var),a
 205++920B 3A 00 92     		ld a,(devicemask)
 206++920E E6 08        		and DEVICE_MOONSOUND_MASK
 207++9210 C4 A0 8D     		call nz,opl4mute
 208++9213 C9                           ret
 209++9214
 210++9214
 211++9214
 212++9214
 213++9214
 214++9214
 215++9214
 216++9214              PLAY:
 217++9214              ;out: zf=0 if still playing, zf=1 otherwise
 218++9214              ;waittimercallback=$+1
 219++9214              ;	call 0
 220++9214
 221++9214              vgm_play_var = $
 221++9214 00             nop		;nop - play
 222++9215 3E 00                ld a,0                          ;(memorystreamcurrentpage)
 223++9217              memorystreamcurrentpage equ $-1
 224++9217                      IF AREA_C000_FFFF=1
 225++9217                          ;SETPGC000
 226++9217              			OS_SET_PAGE_SLOT3
 226++9217 0E 1C       >    ld c,#1c
 226++9219 E7          >    rst #20
 227++921A                      ELSE
 228++921A ~                        SETPG8000
 229++921A                      ENDIF
 230++921A              playloop
 231++921A              waitcounterlo=$+1
 232++921A 21 00 00     	ld hl,0
 233++921D              waitcounterhi=$+1
 234++921D 3E 00        	ld a,0
 235++921F              waittimerstep=$+1
 236++921F 01 00 00     	ld bc,0
 237++9222 B7 ED 42     	sub hl,bc
 238++9225 16 00        	ld d,0
 239++9227 9A           	sbc a,d
 240++9228 30 1A        	jr nc,exitplayloop
 241++922A              ;read command
 242++922A              	memory_stream_read_1 e
 242++922A 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 242++922D             >	memory_stream_read_byte e
 242++922D CB 74       >	bit 6,h
 242++922F             >        IF AREA_C000_FFFF=1
 242++922F CC 0D 8C    >	call z,memorystreamnextpage
 242++9232             >        ELSE
 242++9232 ~           > 	call nz,memorystreamnextpage
 242++9232             >        ENDIF
 242++9232 5E          >	ld e,(hl)
 242++9233 23          >	inc hl
 242++9234 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 243++9237 21 28 94     	ld hl,cmdtable
 244++923A 19           	add hl,de
 245++923B 5E           	ld e,(hl)
 246++923C 24           	inc h
 247++923D 56           	ld d,(hl)
 248++923E 21 1A 92     	ld hl,playloop
 249++9241 E5           	push hl
 250++9242 EB           	ex hl,de
 251++9243 E9           	jp (hl)
 252++9244
 253++9244              exitplayloop
 254++9244 22 1B 92     	ld (waitcounterlo),hl
 255++9247 32 1E 92     	ld (waitcounterhi),a
 256++924A              ;continue playing
 257++924A F6 01        	or 1
 258++924C C9           	ret
 259++924D
 260++924D 21 1B 92     wait1	ld hl,waitcounterlo
 261++9250 34           	inc (hl)
 262++9251 C0           	ret nz
 263++9252 23           	inc hl
 264++9253 34           	inc (hl)
 265++9254 C0           	ret nz
 266++9255 21 1E 92     	ld hl,waitcounterhi
 267++9258 34           	inc (hl)
 268++9259 C9           	ret
 269++925A
 270++925A 3E 02        wait2	ld a,2
 271++925C 21 1B 92     waitn	ld hl,waitcounterlo
 272++925F 86           	add a,(hl)
 273++9260 77           	ld (hl),a
 274++9261 D0           	ret nc
 275++9262 23           	inc hl
 276++9263 34           	inc (hl)
 277++9264 C0           	ret nz
 278++9265 21 1E 92     	ld hl,waitcounterhi
 279++9268 34           	inc (hl)
 280++9269 C9           	ret
 281++926A
 282++926A 3E 03        wait3	ld a,3
 282++926C C3 5C 92       jp waitn
 283++926F 3E 04        wait4	ld a,4
 283++9271 C3 5C 92       jp waitn
 284++9274 3E 05        wait5	ld a,5
 284++9276 C3 5C 92       jp waitn
 285++9279 3E 06        wait6	ld a,6
 285++927B C3 5C 92       jp waitn
 286++927E 3E 07        wait7	ld a,7
 286++9280 C3 5C 92       jp waitn
 287++9283 3E 08        wait8	ld a,8
 287++9285 C3 5C 92       jp waitn
 288++9288 3E 09        wait9	ld a,9
 288++928A C3 5C 92       jp waitn
 289++928D 3E 0A        wait10	ld a,10
 289++928F C3 5C 92       jp waitn
 290++9292 3E 0B        wait11	ld a,11
 290++9294 C3 5C 92       jp waitn
 291++9297 3E 0C        wait12	ld a,12
 291++9299 C3 5C 92       jp waitn
 292++929C 3E 0D        wait13	ld a,13
 292++929E C3 5C 92       jp waitn
 293++92A1 3E 0E        wait14	ld a,14
 293++92A3 C3 5C 92       jp waitn
 294++92A6 3E 0F        wait15	ld a,15
 294++92A8 C3 5C 92       jp waitn
 295++92AB 3E 10        wait16	ld a,16
 295++92AD C3 5C 92       jp waitn
 296++92B0
 297++92B0 11 DF 02     wait735	ld de,735
 298++92B3 2A 1B 92     waitnn	ld hl,(waitcounterlo)
 299++92B6 19           	add hl,de
 300++92B7 22 1B 92     	ld (waitcounterlo),hl
 301++92BA D0           	ret nc
 302++92BB 21 1E 92     	ld hl,waitcounterhi
 303++92BE 34           	inc (hl)
 304++92BF C9           	ret
 305++92C0
 306++92C0 11 72 03     wait882	ld de,882
 307++92C3 C3 B3 92     	jp waitnn
 308++92C6
 309++92C6              waitvar	memory_stream_read_2 e,d
 309++92C6 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 309++92C9             >	memory_stream_read_byte e
 309++92C9 CB 74       >	bit 6,h
 309++92CB             >        IF AREA_C000_FFFF=1
 309++92CB CC 0D 8C    >	call z,memorystreamnextpage
 309++92CE             >        ELSE
 309++92CE ~           > 	call nz,memorystreamnextpage
 309++92CE             >        ENDIF
 309++92CE 5E          >	ld e,(hl)
 309++92CF 23          >	inc hl
 309++92D0             >	memory_stream_read_byte d
 309++92D0 CB 74       >	bit 6,h
 309++92D2             >        IF AREA_C000_FFFF=1
 309++92D2 CC 0D 8C    >	call z,memorystreamnextpage
 309++92D5             >        ELSE
 309++92D5 ~           > 	call nz,memorystreamnextpage
 309++92D5             >        ENDIF
 309++92D5 56          >	ld d,(hl)
 309++92D6 23          >	inc hl
 309++92D7 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 310++92DA 2A 1B 92     	ld hl,(waitcounterlo)
 311++92DD 19           	add hl,de
 312++92DE 22 1B 92     	ld (waitcounterlo),hl
 313++92E1 D0           	ret nc
 314++92E2 21 1E 92     	ld hl,waitcounterhi
 315++92E5 34           	inc (hl)
 316++92E6 C9           	ret
 317++92E7
 318++92E7              	macro skip_n n
 319++92E7 ~            	ld b,n
 320++92E7 ~            	jp memorystreamskip
 321++92E7              	endm
 322++92E7
 323++92E7 C9           skip1	ret
 324++92E8              skip2	skip_n 1
 324++92E8 06 01       >	ld b,1
 324++92EA C3 23 8C    >	jp memorystreamskip
 325++92ED              skip3	skip_n 2
 325++92ED 06 02       >	ld b,2
 325++92EF C3 23 8C    >	jp memorystreamskip
 326++92F2              skip4	skip_n 3
 326++92F2 06 03       >	ld b,3
 326++92F4 C3 23 8C    >	jp memorystreamskip
 327++92F7              skip5	skip_n 4
 327++92F7 06 04       >	ld b,4
 327++92F9 C3 23 8C    >	jp memorystreamskip
 328++92FC              skip6	skip_n 5
 328++92FC 06 05       >	ld b,5
 328++92FE C3 23 8C    >	jp memorystreamskip
 329++9301              skip11	skip_n 10
 329++9301 06 0A       >	ld b,10
 329++9303 C3 23 8C    >	jp memorystreamskip
 330++9306              skip12	skip_n 11
 330++9306 06 0B       >	ld b,11
 330++9308 C3 23 8C    >	jp memorystreamskip
 331++930B
 332++930B
 333++930B              endofsounddata
 334++930B                    ;  jp seektoloop ;здесь зацикливание, повтор
 335++930B CD D8 8A     	  call PLR_MUTE ;выключить звук
 336++930E              cmdunsupported
 337++930E              ;stop playing
 338++930E F1           	pop af
 339++930F AF           	xor a
 340++9310 C9           	ret
 341++9311
 342++9311              cmdYM2203
 343++9311              	memory_stream_read_2 e,d
 343++9311 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 343++9314             >	memory_stream_read_byte e
 343++9314 CB 74       >	bit 6,h
 343++9316             >        IF AREA_C000_FFFF=1
 343++9316 CC 0D 8C    >	call z,memorystreamnextpage
 343++9319             >        ELSE
 343++9319 ~           > 	call nz,memorystreamnextpage
 343++9319             >        ENDIF
 343++9319 5E          >	ld e,(hl)
 343++931A 23          >	inc hl
 343++931B             >	memory_stream_read_byte d
 343++931B CB 74       >	bit 6,h
 343++931D             >        IF AREA_C000_FFFF=1
 343++931D CC 0D 8C    >	call z,memorystreamnextpage
 343++9320             >        ELSE
 343++9320 ~           > 	call nz,memorystreamnextpage
 343++9320             >        ENDIF
 343++9320 56          >	ld d,(hl)
 343++9321 23          >	inc hl
 343++9322 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 344++9325 C3 BF 90     	jp opnwritemusiconlyfm1
 345++9328
 346++9328              cmdYM2203dp
 347++9328              	memory_stream_read_2 e,d
 347++9328 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 347++932B             >	memory_stream_read_byte e
 347++932B CB 74       >	bit 6,h
 347++932D             >        IF AREA_C000_FFFF=1
 347++932D CC 0D 8C    >	call z,memorystreamnextpage
 347++9330             >        ELSE
 347++9330 ~           > 	call nz,memorystreamnextpage
 347++9330             >        ENDIF
 347++9330 5E          >	ld e,(hl)
 347++9331 23          >	inc hl
 347++9332             >	memory_stream_read_byte d
 347++9332 CB 74       >	bit 6,h
 347++9334             >        IF AREA_C000_FFFF=1
 347++9334 CC 0D 8C    >	call z,memorystreamnextpage
 347++9337             >        ELSE
 347++9337 ~           > 	call nz,memorystreamnextpage
 347++9337             >        ENDIF
 347++9337 56          >	ld d,(hl)
 347++9338 23          >	inc hl
 347++9339 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 348++933C C3 D3 90     	jp opnwritemusiconlyfm2
 349++933F
 350++933F              cmdYMF278B
 351++933F              	memory_stream_read_3 c,e,d
 351++933F 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 351++9342             >	memory_stream_read_byte c
 351++9342 CB 74       >	bit 6,h
 351++9344             >        IF AREA_C000_FFFF=1
 351++9344 CC 0D 8C    >	call z,memorystreamnextpage
 351++9347             >        ELSE
 351++9347 ~           > 	call nz,memorystreamnextpage
 351++9347             >        ENDIF
 351++9347 4E          >	ld c,(hl)
 351++9348 23          >	inc hl
 351++9349             >	memory_stream_read_byte e
 351++9349 CB 74       >	bit 6,h
 351++934B             >        IF AREA_C000_FFFF=1
 351++934B CC 0D 8C    >	call z,memorystreamnextpage
 351++934E             >        ELSE
 351++934E ~           > 	call nz,memorystreamnextpage
 351++934E             >        ENDIF
 351++934E 5E          >	ld e,(hl)
 351++934F 23          >	inc hl
 351++9350             >	memory_stream_read_byte d
 351++9350 CB 74       >	bit 6,h
 351++9352             >        IF AREA_C000_FFFF=1
 351++9352 CC 0D 8C    >	call z,memorystreamnextpage
 351++9355             >        ELSE
 351++9355 ~           > 	call nz,memorystreamnextpage
 351++9355             >        ENDIF
 351++9355 56          >	ld d,(hl)
 351++9356 23          >	inc hl
 351++9357 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 352++935A 0D           	dec c
 353++935B CA EB 8E     	jp z,opl4writemusiconlyfm2
 354++935E F2 F5 8E     	jp p,opl4writewavemusiconly
 355++9361 C3 DF 8E     	jp opl4writemusiconlyfm1
 356++9364
 357++9364              cmdYMF262p0
 358++9364              cmdYM3812
 359++9364              cmdY8950
 360++9364              cmdYM3526
 361++9364              	memory_stream_read_2 e,d
 361++9364 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 361++9367             >	memory_stream_read_byte e
 361++9367 CB 74       >	bit 6,h
 361++9369             >        IF AREA_C000_FFFF=1
 361++9369 CC 0D 8C    >	call z,memorystreamnextpage
 361++936C             >        ELSE
 361++936C ~           > 	call nz,memorystreamnextpage
 361++936C             >        ENDIF
 361++936C 5E          >	ld e,(hl)
 361++936D 23          >	inc hl
 361++936E             >	memory_stream_read_byte d
 361++936E CB 74       >	bit 6,h
 361++9370             >        IF AREA_C000_FFFF=1
 361++9370 CC 0D 8C    >	call z,memorystreamnextpage
 361++9373             >        ELSE
 361++9373 ~           > 	call nz,memorystreamnextpage
 361++9373             >        ENDIF
 361++9373 56          >	ld d,(hl)
 361++9374 23          >	inc hl
 361++9375 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 362++9378 C3 DF 8E     	jp opl4writemusiconlyfm1
 363++937B
 364++937B              cmdYMF262p1
 365++937B              cmdYM3812dp
 366++937B              cmdY8950dp
 367++937B              cmdYM3526dp
 368++937B              	memory_stream_read_2 e,d
 368++937B 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 368++937E             >	memory_stream_read_byte e
 368++937E CB 74       >	bit 6,h
 368++9380             >        IF AREA_C000_FFFF=1
 368++9380 CC 0D 8C    >	call z,memorystreamnextpage
 368++9383             >        ELSE
 368++9383 ~           > 	call nz,memorystreamnextpage
 368++9383             >        ENDIF
 368++9383 5E          >	ld e,(hl)
 368++9384 23          >	inc hl
 368++9385             >	memory_stream_read_byte d
 368++9385 CB 74       >	bit 6,h
 368++9387             >        IF AREA_C000_FFFF=1
 368++9387 CC 0D 8C    >	call z,memorystreamnextpage
 368++938A             >        ELSE
 368++938A ~           > 	call nz,memorystreamnextpage
 368++938A             >        ENDIF
 368++938A 56          >	ld d,(hl)
 368++938B 23          >	inc hl
 368++938C 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 369++938F C3 EB 8E     	jp opl4writemusiconlyfm2
 370++9392
 371++9392              cmdYM2151
 372++9392              	memory_stream_read_2 e,d
 372++9392 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 372++9395             >	memory_stream_read_byte e
 372++9395 CB 74       >	bit 6,h
 372++9397             >        IF AREA_C000_FFFF=1
 372++9397 CC 0D 8C    >	call z,memorystreamnextpage
 372++939A             >        ELSE
 372++939A ~           > 	call nz,memorystreamnextpage
 372++939A             >        ENDIF
 372++939A 5E          >	ld e,(hl)
 372++939B 23          >	inc hl
 372++939C             >	memory_stream_read_byte d
 372++939C CB 74       >	bit 6,h
 372++939E             >        IF AREA_C000_FFFF=1
 372++939E CC 0D 8C    >	call z,memorystreamnextpage
 372++93A1             >        ELSE
 372++93A1 ~           > 	call nz,memorystreamnextpage
 372++93A1             >        ENDIF
 372++93A1 56          >	ld d,(hl)
 372++93A2 23          >	inc hl
 372++93A3 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 373++93A6 C3 FE 90     	jp opmwritemusiconlychip0
 374++93A9
 375++93A9              cmdYM2151dp
 376++93A9              	memory_stream_read_2 e,d
 376++93A9 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 376++93AC             >	memory_stream_read_byte e
 376++93AC CB 74       >	bit 6,h
 376++93AE             >        IF AREA_C000_FFFF=1
 376++93AE CC 0D 8C    >	call z,memorystreamnextpage
 376++93B1             >        ELSE
 376++93B1 ~           > 	call nz,memorystreamnextpage
 376++93B1             >        ENDIF
 376++93B1 5E          >	ld e,(hl)
 376++93B2 23          >	inc hl
 376++93B3             >	memory_stream_read_byte d
 376++93B3 CB 74       >	bit 6,h
 376++93B5             >        IF AREA_C000_FFFF=1
 376++93B5 CC 0D 8C    >	call z,memorystreamnextpage
 376++93B8             >        ELSE
 376++93B8 ~           > 	call nz,memorystreamnextpage
 376++93B8             >        ENDIF
 376++93B8 56          >	ld d,(hl)
 376++93B9 23          >	inc hl
 376++93BA 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 377++93BD C3 05 91     	jp opmwritemusiconlychip1
 378++93C0
 379++93C0              cmdAY8910
 380++93C0              	memory_stream_read_2 e,d
 380++93C0 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 380++93C3             >	memory_stream_read_byte e
 380++93C3 CB 74       >	bit 6,h
 380++93C5             >        IF AREA_C000_FFFF=1
 380++93C5 CC 0D 8C    >	call z,memorystreamnextpage
 380++93C8             >        ELSE
 380++93C8 ~           > 	call nz,memorystreamnextpage
 380++93C8             >        ENDIF
 380++93C8 5E          >	ld e,(hl)
 380++93C9 23          >	inc hl
 380++93CA             >	memory_stream_read_byte d
 380++93CA CB 74       >	bit 6,h
 380++93CC             >        IF AREA_C000_FFFF=1
 380++93CC CC 0D 8C    >	call z,memorystreamnextpage
 380++93CF             >        ELSE
 380++93CF ~           > 	call nz,memorystreamnextpage
 380++93CF             >        ENDIF
 380++93CF 56          >	ld d,(hl)
 380++93D0 23          >	inc hl
 380++93D1 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 381++93D4 CB 7B        	bit 7,e
 382++93D6 CA 21 91     	jp z,ssgwritemusiconlychip0
 383++93D9 CB BB        	res 7,e
 384++93DB C3 34 91     	jp ssgwritemusiconlychip1
 385++93DE
 386++93DE              cmdYMF262dp0 equ memorystreamread2
 387++93DE              cmdYMF262dp1 equ memorystreamread2
 388++93DE
 389++93DE              cmddatablock
 390++93DE              	memory_stream_read_2 a,e ;a = 0x66 guard, e = type
 390++93DE 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 390++93E1             >	memory_stream_read_byte a
 390++93E1 CB 74       >	bit 6,h
 390++93E3             >        IF AREA_C000_FFFF=1
 390++93E3 CC 0D 8C    >	call z,memorystreamnextpage
 390++93E6             >        ELSE
 390++93E6 ~           > 	call nz,memorystreamnextpage
 390++93E6             >        ENDIF
 390++93E6 7E          >	ld a,(hl)
 390++93E7 23          >	inc hl
 390++93E8             >	memory_stream_read_byte e
 390++93E8 CB 74       >	bit 6,h
 390++93EA             >        IF AREA_C000_FFFF=1
 390++93EA CC 0D 8C    >	call z,memorystreamnextpage
 390++93ED             >        ELSE
 390++93ED ~           > 	call nz,memorystreamnextpage
 390++93ED             >        ENDIF
 390++93ED 5E          >	ld e,(hl)
 390++93EE 23          >	inc hl
 390++93EF 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 391++93F2 FE 66        	cp 0x66
 392++93F4 C2 0E 93     	jp nz,cmdunsupported
 393++93F7              processdatablock
 394++93F7              ;e = data type
 395++93F7 CD 71 8C     	call memorystreamread4 ;adbc = data size
 396++93FA 7B           	ld a,e
 397++93FB 60 69        	ld hl,bc
 398++93FD              ;	cp 0x81
 399++93FD              ;	jp z,opnaloaddatablock
 400++93FD FE 84        	cp 0x84
 401++93FF CA C3 8F     	jp z,opl4loadromdatablock
 402++9402 FE 87        	cp 0x87
 403++9404 CA BC 8F     	jp z,opl4loadramdatablock
 404++9407 D5           	push de
 405++9408 C5           	push bc
 406++9409 CD ED 8C     	call memorystreamgetpos
 407++940C C1           	pop bc
 408++940D F1           	pop af
 409++940E 09           	add hl,bc
 410++940F 8B           	adc a,e
 411++9410 5F           	ld e,a
 412++9411 8A           	adc a,d
 413++9412 93           	sub e
 414++9413 57           	ld d,a
 415++9414 C3 C8 8C     	jp memorystreamseek
 416++9417
 417++9417
 418++9417              seektoloop
 419++9417 01 1C 00     	ld bc,0x1c
 420++941A              loopoffsethi=$+1
 421++941A 11 00 00     	ld de,0
 422++941D              loopoffsetlo=$+1
 423++941D 21 00 00     	ld hl,0
 424++9420              seektopos
 425++9420              ;dehl + bc = position
 426++9420              ;out: hl = read address
 427++9420 09           	add hl,bc
 428++9421 D2 C8 8C     	jp nc,memorystreamseek
 429++9424 13           	inc de
 430++9425 C3 C8 8C     	jp memorystreamseek
 431++9428
 432++9428
 433++9428
 434++9428
 435++9428              cmdtable
 436++9428 E7           	db skip1           %256 ; 00
 437++9429 E7           	db skip1           %256 ; 01
 438++942A E7           	db skip1           %256 ; 02
 439++942B E7           	db skip1           %256 ; 03
 440++942C E7           	db skip1           %256 ; 04
 441++942D E7           	db skip1           %256 ; 05
 442++942E E7           	db skip1           %256 ; 06
 443++942F E7           	db skip1           %256 ; 07
 444++9430 E7           	db skip1           %256 ; 08
 445++9431 E7           	db skip1           %256 ; 09
 446++9432 E7           	db skip1           %256 ; 0A
 447++9433 E7           	db skip1           %256 ; 0B
 448++9434 E7           	db skip1           %256 ; 0C
 449++9435 E7           	db skip1           %256 ; 0D
 450++9436 E7           	db skip1           %256 ; 0E
 451++9437 E7           	db skip1           %256 ; 0F
 452++9438 E7           	db skip1           %256 ; 10
 453++9439 E7           	db skip1           %256 ; 11
 454++943A E7           	db skip1           %256 ; 12
 455++943B E7           	db skip1           %256 ; 13
 456++943C E7           	db skip1           %256 ; 14
 457++943D E7           	db skip1           %256 ; 15
 458++943E E7           	db skip1           %256 ; 16
 459++943F E7           	db skip1           %256 ; 17
 460++9440 E7           	db skip1           %256 ; 18
 461++9441 E7           	db skip1           %256 ; 19
 462++9442 E7           	db skip1           %256 ; 1A
 463++9443 E7           	db skip1           %256 ; 1B
 464++9444 E7           	db skip1           %256 ; 1C
 465++9445 E7           	db skip1           %256 ; 1D
 466++9446 E7           	db skip1           %256 ; 1E
 467++9447 E7           	db skip1           %256 ; 1F
 468++9448 E7           	db skip1           %256 ; 20
 469++9449 E7           	db skip1           %256 ; 21
 470++944A E7           	db skip1           %256 ; 22
 471++944B E7           	db skip1           %256 ; 23
 472++944C E7           	db skip1           %256 ; 24
 473++944D E7           	db skip1           %256 ; 25
 474++944E E7           	db skip1           %256 ; 26
 475++944F E7           	db skip1           %256 ; 27
 476++9450 E7           	db skip1           %256 ; 28
 477++9451 E7           	db skip1           %256 ; 29
 478++9452 E7           	db skip1           %256 ; 2A
 479++9453 E7           	db skip1           %256 ; 2B
 480++9454 E7           	db skip1           %256 ; 2C
 481++9455 E7           	db skip1           %256 ; 2D
 482++9456 E7           	db skip1           %256 ; 2E
 483++9457 E7           	db skip1           %256 ; 2F
 484++9458 0E           	db cmdunsupported  %256 ; 30
 485++9459 E8           	db skip2           %256 ; 31
 486++945A E8           	db skip2           %256 ; 32
 487++945B E8           	db skip2           %256 ; 33
 488++945C E8           	db skip2           %256 ; 34
 489++945D E8           	db skip2           %256 ; 35
 490++945E E8           	db skip2           %256 ; 36
 491++945F E8           	db skip2           %256 ; 37
 492++9460 E8           	db skip2           %256 ; 38
 493++9461 E8           	db skip2           %256 ; 39
 494++9462 E8           	db skip2           %256 ; 3A
 495++9463 E8           	db skip2           %256 ; 3B
 496++9464 E8           	db skip2           %256 ; 3C
 497++9465 E8           	db skip2           %256 ; 3D
 498++9466 E8           	db skip2           %256 ; 3E
 499++9467 E8           	db skip2           %256 ; 3F
 500++9468 ED           	db skip3           %256 ; 40
 501++9469 ED           	db skip3           %256 ; 41
 502++946A ED           	db skip3           %256 ; 42
 503++946B ED           	db skip3           %256 ; 43
 504++946C ED           	db skip3           %256 ; 44
 505++946D ED           	db skip3           %256 ; 45
 506++946E ED           	db skip3           %256 ; 46
 507++946F ED           	db skip3           %256 ; 47
 508++9470 ED           	db skip3           %256 ; 48
 509++9471 ED           	db skip3           %256 ; 49
 510++9472 ED           	db skip3           %256 ; 4A
 511++9473 ED           	db skip3           %256 ; 4B
 512++9474 ED           	db skip3           %256 ; 4C
 513++9475 ED           	db skip3           %256 ; 4D
 514++9476 ED           	db skip3           %256 ; 4E
 515++9477 E8           	db skip2           %256 ; 4F
 516++9478 0E           	db cmdunsupported  %256 ; 50
 517++9479 0E           	db cmdunsupported  %256 ; 51
 518++947A 0E           	db cmdunsupported  %256 ; 52
 519++947B 0E           	db cmdunsupported  %256 ; 53
 520++947C 92           	db cmdYM2151       %256 ; 54
 521++947D 11           	db cmdYM2203       %256 ; 55
 522++947E 11           	db cmdYM2608p0     %256 ; 56
 523++947F 28           	db cmdYM2608p1     %256 ; 57
 524++9480 0E           	db cmdunsupported  %256 ; 58
 525++9481 0E           	db cmdunsupported  %256 ; 59
 526++9482 64           	db cmdYM3812       %256 ; 5A
 527++9483 64           	db cmdYM3526       %256 ; 5B
 528++9484 64           	db cmdY8950        %256 ; 5C
 529++9485 ED           	db skip3           %256 ; 5D
 530++9486 64           	db cmdYMF262p0     %256 ; 5E
 531++9487 7B           	db cmdYMF262p1     %256 ; 5F
 532++9488 0E           	db cmdunsupported  %256 ; 60
 533++9489 C6           	db waitvar         %256 ; 61
 534++948A B0           	db wait735         %256 ; 62
 535++948B C0           	db wait882         %256 ; 63
 536++948C 0E           	db cmdunsupported  %256 ; 64
 537++948D 0E           	db cmdunsupported  %256 ; 65
 538++948E 0B           	db endofsounddata  %256 ; 66
 539++948F DE           	db cmddatablock    %256 ; 67
 540++9490 06           	db skip12          %256 ; 68
 541++9491 0E           	db cmdunsupported  %256 ; 69
 542++9492 0E           	db cmdunsupported  %256 ; 6A
 543++9493 0E           	db cmdunsupported  %256 ; 6B
 544++9494 0E           	db cmdunsupported  %256 ; 6C
 545++9495 0E           	db cmdunsupported  %256 ; 6D
 546++9496 0E           	db cmdunsupported  %256 ; 6E
 547++9497 0E           	db cmdunsupported  %256 ; 6F
 548++9498 4D           	db wait1           %256 ; 70
 549++9499 5A           	db wait2           %256 ; 71
 550++949A 6A           	db wait3           %256 ; 72
 551++949B 6F           	db wait4           %256 ; 73
 552++949C 74           	db wait5           %256 ; 74
 553++949D 79           	db wait6           %256 ; 75
 554++949E 7E           	db wait7           %256 ; 76
 555++949F 83           	db wait8           %256 ; 77
 556++94A0 88           	db wait9           %256 ; 78
 557++94A1 8D           	db wait10          %256 ; 79
 558++94A2 92           	db wait11          %256 ; 7A
 559++94A3 97           	db wait12          %256 ; 7B
 560++94A4 9C           	db wait13          %256 ; 7C
 561++94A5 A1           	db wait14          %256 ; 7D
 562++94A6 A6           	db wait15          %256 ; 7E
 563++94A7 AB           	db wait16          %256 ; 7F
 564++94A8 E7           	db skip1           %256 ; 80
 565++94A9 4D           	db wait1           %256 ; 81
 566++94AA 5A           	db wait2           %256 ; 82
 567++94AB 6A           	db wait3           %256 ; 83
 568++94AC 6F           	db wait4           %256 ; 84
 569++94AD 74           	db wait5           %256 ; 85
 570++94AE 79           	db wait6           %256 ; 86
 571++94AF 7E           	db wait7           %256 ; 87
 572++94B0 83           	db wait8           %256 ; 88
 573++94B1 88           	db wait9           %256 ; 89
 574++94B2 8D           	db wait10          %256 ; 8A
 575++94B3 92           	db wait11          %256 ; 8B
 576++94B4 97           	db wait12          %256 ; 8C
 577++94B5 9C           	db wait13          %256 ; 8D
 578++94B6 A1           	db wait14          %256 ; 8E
 579++94B7 A6           	db wait15          %256 ; 8F
 580++94B8 F7           	db skip5           %256 ; 90
 581++94B9 F7           	db skip5           %256 ; 91
 582++94BA FC           	db skip6           %256 ; 92
 583++94BB 01           	db skip11          %256 ; 93
 584++94BC E8           	db skip2           %256 ; 94
 585++94BD F7           	db skip5           %256 ; 95
 586++94BE 0E           	db cmdunsupported  %256 ; 96
 587++94BF 0E           	db cmdunsupported  %256 ; 97
 588++94C0 0E           	db cmdunsupported  %256 ; 98
 589++94C1 0E           	db cmdunsupported  %256 ; 99
 590++94C2 0E           	db cmdunsupported  %256 ; 9A
 591++94C3 0E           	db cmdunsupported  %256 ; 9B
 592++94C4 0E           	db cmdunsupported  %256 ; 9C
 593++94C5 0E           	db cmdunsupported  %256 ; 9D
 594++94C6 0E           	db cmdunsupported  %256 ; 9E
 595++94C7 0E           	db cmdunsupported  %256 ; 9F
 596++94C8 C0           	db cmdAY8910       %256 ; A0
 597++94C9 ED           	db skip3           %256 ; A1
 598++94CA 0E           	db cmdunsupported  %256 ; A2
 599++94CB 0E           	db cmdunsupported  %256 ; A3
 600++94CC A9           	db cmdYM2151dp     %256 ; A4
 601++94CD 28           	db cmdYM2203dp     %256 ; A5
 602++94CE ED           	db skip3           %256 ; A6
 603++94CF ED           	db skip3           %256 ; A7
 604++94D0 ED           	db skip3           %256 ; A8
 605++94D1 ED           	db skip3           %256 ; A9
 606++94D2 7B           	db cmdYM3812dp     %256 ; AA
 607++94D3 7B           	db cmdYM3526dp     %256 ; AB
 608++94D4 7B           	db cmdY8950dp      %256 ; AC
 609++94D5 ED           	db skip3           %256 ; AD
 610++94D6 40           	db cmdYMF262dp0    %256 ; AE
 611++94D7 40           	db cmdYMF262dp0    %256 ; AF
 612++94D8 ED           	db skip3           %256 ; B0
 613++94D9 ED           	db skip3           %256 ; B1
 614++94DA ED           	db skip3           %256 ; B2
 615++94DB ED           	db skip3           %256 ; B3
 616++94DC ED           	db skip3           %256 ; B4
 617++94DD ED           	db skip3           %256 ; B5
 618++94DE ED           	db skip3           %256 ; B6
 619++94DF ED           	db skip3           %256 ; B7
 620++94E0 ED           	db skip3           %256 ; B8
 621++94E1 ED           	db skip3           %256 ; B9
 622++94E2 ED           	db skip3           %256 ; BA
 623++94E3 ED           	db skip3           %256 ; BB
 624++94E4 ED           	db skip3           %256 ; BC
 625++94E5 ED           	db skip3           %256 ; BD
 626++94E6 ED           	db skip3           %256 ; BE
 627++94E7 ED           	db skip3           %256 ; BF
 628++94E8 F2           	db skip4           %256 ; C0
 629++94E9 F2           	db skip4           %256 ; C1
 630++94EA F2           	db skip4           %256 ; C2
 631++94EB F2           	db skip4           %256 ; C3
 632++94EC F2           	db skip4           %256 ; C4
 633++94ED F2           	db skip4           %256 ; C5
 634++94EE F2           	db skip4           %256 ; C6
 635++94EF F2           	db skip4           %256 ; C7
 636++94F0 F2           	db skip4           %256 ; C8
 637++94F1 F2           	db skip4           %256 ; C9
 638++94F2 F2           	db skip4           %256 ; CA
 639++94F3 F2           	db skip4           %256 ; CB
 640++94F4 F2           	db skip4           %256 ; CC
 641++94F5 F2           	db skip4           %256 ; CD
 642++94F6 F2           	db skip4           %256 ; CE
 643++94F7 F2           	db skip4           %256 ; CF
 644++94F8 3F           	db cmdYMF278B      %256 ; D0
 645++94F9 F2           	db skip4           %256 ; D1
 646++94FA 0E           	db cmdunsupported  %256 ; D2
 647++94FB F2           	db skip4           %256 ; D3
 648++94FC F2           	db skip4           %256 ; D4
 649++94FD F2           	db skip4           %256 ; D5
 650++94FE F2           	db skip4           %256 ; D6
 651++94FF F2           	db skip4           %256 ; D7
 652++9500 F2           	db skip4           %256 ; D8
 653++9501 F2           	db skip4           %256 ; D9
 654++9502 F2           	db skip4           %256 ; DA
 655++9503 F2           	db skip4           %256 ; DB
 656++9504 F2           	db skip4           %256 ; DC
 657++9505 F2           	db skip4           %256 ; DD
 658++9506 F2           	db skip4           %256 ; DE
 659++9507 F2           	db skip4           %256 ; DF
 660++9508 0E           	db cmdunsupported  %256 ; E0
 661++9509 F7           	db skip5           %256 ; E1
 662++950A F7           	db skip5           %256 ; E2
 663++950B F7           	db skip5           %256 ; E3
 664++950C F7           	db skip5           %256 ; E4
 665++950D F7           	db skip5           %256 ; E5
 666++950E F7           	db skip5           %256 ; E6
 667++950F F7           	db skip5           %256 ; E7
 668++9510 F7           	db skip5           %256 ; E8
 669++9511 F7           	db skip5           %256 ; E9
 670++9512 F7           	db skip5           %256 ; EA
 671++9513 F7           	db skip5           %256 ; EB
 672++9514 F7           	db skip5           %256 ; EC
 673++9515 F7           	db skip5           %256 ; ED
 674++9516 F7           	db skip5           %256 ; EE
 675++9517 F7           	db skip5           %256 ; EF
 676++9518 F7           	db skip5           %256 ; F0
 677++9519 F7           	db skip5           %256 ; F1
 678++951A F7           	db skip5           %256 ; F2
 679++951B F7           	db skip5           %256 ; F3
 680++951C F7           	db skip5           %256 ; F4
 681++951D F7           	db skip5           %256 ; F5
 682++951E F7           	db skip5           %256 ; F6
 683++951F F7           	db skip5           %256 ; F7
 684++9520 F7           	db skip5           %256 ; F8
 685++9521 F7           	db skip5           %256 ; F9
 686++9522 F7           	db skip5           %256 ; FA
 687++9523 F7           	db skip5           %256 ; FB
 688++9524 F7           	db skip5           %256 ; FC
 689++9525 F7           	db skip5           %256 ; FD
 690++9526 F7           	db skip5           %256 ; FE
 691++9527 F7           	db skip5           %256 ; FF
 692++9528 92           	db skip1           /256 ; 00
 693++9529 92           	db skip1           /256 ; 01
 694++952A 92           	db skip1           /256 ; 02
 695++952B 92           	db skip1           /256 ; 03
 696++952C 92           	db skip1           /256 ; 04
 697++952D 92           	db skip1           /256 ; 05
 698++952E 92           	db skip1           /256 ; 06
 699++952F 92           	db skip1           /256 ; 07
 700++9530 92           	db skip1           /256 ; 08
 701++9531 92           	db skip1           /256 ; 09
 702++9532 92           	db skip1           /256 ; 0A
 703++9533 92           	db skip1           /256 ; 0B
 704++9534 92           	db skip1           /256 ; 0C
 705++9535 92           	db skip1           /256 ; 0D
 706++9536 92           	db skip1           /256 ; 0E
 707++9537 92           	db skip1           /256 ; 0F
 708++9538 92           	db skip1           /256 ; 10
 709++9539 92           	db skip1           /256 ; 11
 710++953A 92           	db skip1           /256 ; 12
 711++953B 92           	db skip1           /256 ; 13
 712++953C 92           	db skip1           /256 ; 14
 713++953D 92           	db skip1           /256 ; 15
 714++953E 92           	db skip1           /256 ; 16
 715++953F 92           	db skip1           /256 ; 17
 716++9540 92           	db skip1           /256 ; 18
 717++9541 92           	db skip1           /256 ; 19
 718++9542 92           	db skip1           /256 ; 1A
 719++9543 92           	db skip1           /256 ; 1B
 720++9544 92           	db skip1           /256 ; 1C
 721++9545 92           	db skip1           /256 ; 1D
 722++9546 92           	db skip1           /256 ; 1E
 723++9547 92           	db skip1           /256 ; 1F
 724++9548 92           	db skip1           /256 ; 20
 725++9549 92           	db skip1           /256 ; 21
 726++954A 92           	db skip1           /256 ; 22
 727++954B 92           	db skip1           /256 ; 23
 728++954C 92           	db skip1           /256 ; 24
 729++954D 92           	db skip1           /256 ; 25
 730++954E 92           	db skip1           /256 ; 26
 731++954F 92           	db skip1           /256 ; 27
 732++9550 92           	db skip1           /256 ; 28
 733++9551 92           	db skip1           /256 ; 29
 734++9552 92           	db skip1           /256 ; 2A
 735++9553 92           	db skip1           /256 ; 2B
 736++9554 92           	db skip1           /256 ; 2C
 737++9555 92           	db skip1           /256 ; 2D
 738++9556 92           	db skip1           /256 ; 2E
 739++9557 92           	db skip1           /256 ; 2F
 740++9558 93           	db cmdunsupported  /256 ; 30
 741++9559 92           	db skip2           /256 ; 31
 742++955A 92           	db skip2           /256 ; 32
 743++955B 92           	db skip2           /256 ; 33
 744++955C 92           	db skip2           /256 ; 34
 745++955D 92           	db skip2           /256 ; 35
 746++955E 92           	db skip2           /256 ; 36
 747++955F 92           	db skip2           /256 ; 37
 748++9560 92           	db skip2           /256 ; 38
 749++9561 92           	db skip2           /256 ; 39
 750++9562 92           	db skip2           /256 ; 3A
 751++9563 92           	db skip2           /256 ; 3B
 752++9564 92           	db skip2           /256 ; 3C
 753++9565 92           	db skip2           /256 ; 3D
 754++9566 92           	db skip2           /256 ; 3E
 755++9567 92           	db skip2           /256 ; 3F
 756++9568 92           	db skip3           /256 ; 40
 757++9569 92           	db skip3           /256 ; 41
 758++956A 92           	db skip3           /256 ; 42
 759++956B 92           	db skip3           /256 ; 43
 760++956C 92           	db skip3           /256 ; 44
 761++956D 92           	db skip3           /256 ; 45
 762++956E 92           	db skip3           /256 ; 46
 763++956F 92           	db skip3           /256 ; 47
 764++9570 92           	db skip3           /256 ; 48
 765++9571 92           	db skip3           /256 ; 49
 766++9572 92           	db skip3           /256 ; 4A
 767++9573 92           	db skip3           /256 ; 4B
 768++9574 92           	db skip3           /256 ; 4C
 769++9575 92           	db skip3           /256 ; 4D
 770++9576 92           	db skip3           /256 ; 4E
 771++9577 92           	db skip2           /256 ; 4F
 772++9578 93           	db cmdunsupported  /256 ; 50
 773++9579 93           	db cmdunsupported  /256 ; 51
 774++957A 93           	db cmdunsupported  /256 ; 52
 775++957B 93           	db cmdunsupported  /256 ; 53
 776++957C 93           	db cmdYM2151       /256 ; 54
 777++957D 93           	db cmdYM2203       /256 ; 55
 778++957E 93           	db cmdYM2608p0     /256 ; 56
 779++957F 96           	db cmdYM2608p1     /256 ; 57
 780++9580 93           	db cmdunsupported  /256 ; 58
 781++9581 93           	db cmdunsupported  /256 ; 59
 782++9582 93           	db cmdYM3812       /256 ; 5A
 783++9583 93           	db cmdYM3526       /256 ; 5B
 784++9584 93           	db cmdY8950        /256 ; 5C
 785++9585 92           	db skip3           /256 ; 5D
 786++9586 93           	db cmdYMF262p0     /256 ; 5E
 787++9587 93           	db cmdYMF262p1     /256 ; 5F
 788++9588 93           	db cmdunsupported  /256 ; 60
 789++9589 92           	db waitvar         /256 ; 61
 790++958A 92           	db wait735         /256 ; 62
 791++958B 92           	db wait882         /256 ; 63
 792++958C 93           	db cmdunsupported  /256 ; 64
 793++958D 93           	db cmdunsupported  /256 ; 65
 794++958E 93           	db endofsounddata  /256 ; 66
 795++958F 93           	db cmddatablock    /256 ; 67
 796++9590 93           	db skip12          /256 ; 68
 797++9591 93           	db cmdunsupported  /256 ; 69
 798++9592 93           	db cmdunsupported  /256 ; 6A
 799++9593 93           	db cmdunsupported  /256 ; 6B
 800++9594 93           	db cmdunsupported  /256 ; 6C
 801++9595 93           	db cmdunsupported  /256 ; 6D
 802++9596 93           	db cmdunsupported  /256 ; 6E
 803++9597 93           	db cmdunsupported  /256 ; 6F
 804++9598 92           	db wait1           /256 ; 70
 805++9599 92           	db wait2           /256 ; 71
 806++959A 92           	db wait3           /256 ; 72
 807++959B 92           	db wait4           /256 ; 73
 808++959C 92           	db wait5           /256 ; 74
 809++959D 92           	db wait6           /256 ; 75
 810++959E 92           	db wait7           /256 ; 76
 811++959F 92           	db wait8           /256 ; 77
 812++95A0 92           	db wait9           /256 ; 78
 813++95A1 92           	db wait10          /256 ; 79
 814++95A2 92           	db wait11          /256 ; 7A
 815++95A3 92           	db wait12          /256 ; 7B
 816++95A4 92           	db wait13          /256 ; 7C
 817++95A5 92           	db wait14          /256 ; 7D
 818++95A6 92           	db wait15          /256 ; 7E
 819++95A7 92           	db wait16          /256 ; 7F
 820++95A8 92           	db skip1           /256 ; 80
 821++95A9 92           	db wait1           /256 ; 81
 822++95AA 92           	db wait2           /256 ; 82
 823++95AB 92           	db wait3           /256 ; 83
 824++95AC 92           	db wait4           /256 ; 84
 825++95AD 92           	db wait5           /256 ; 85
 826++95AE 92           	db wait6           /256 ; 86
 827++95AF 92           	db wait7           /256 ; 87
 828++95B0 92           	db wait8           /256 ; 88
 829++95B1 92           	db wait9           /256 ; 89
 830++95B2 92           	db wait10          /256 ; 8A
 831++95B3 92           	db wait11          /256 ; 8B
 832++95B4 92           	db wait12          /256 ; 8C
 833++95B5 92           	db wait13          /256 ; 8D
 834++95B6 92           	db wait14          /256 ; 8E
 835++95B7 92           	db wait15          /256 ; 8F
 836++95B8 92           	db skip5           /256 ; 90
 837++95B9 92           	db skip5           /256 ; 91
 838++95BA 92           	db skip6           /256 ; 92
 839++95BB 93           	db skip11          /256 ; 93
 840++95BC 92           	db skip2           /256 ; 94
 841++95BD 92           	db skip5           /256 ; 95
 842++95BE 93           	db cmdunsupported  /256 ; 96
 843++95BF 93           	db cmdunsupported  /256 ; 97
 844++95C0 93           	db cmdunsupported  /256 ; 98
 845++95C1 93           	db cmdunsupported  /256 ; 99
 846++95C2 93           	db cmdunsupported  /256 ; 9A
 847++95C3 93           	db cmdunsupported  /256 ; 9B
 848++95C4 93           	db cmdunsupported  /256 ; 9C
 849++95C5 93           	db cmdunsupported  /256 ; 9D
 850++95C6 93           	db cmdunsupported  /256 ; 9E
 851++95C7 93           	db cmdunsupported  /256 ; 9F
 852++95C8 93           	db cmdAY8910       /256 ; A0
 853++95C9 92           	db skip3           /256 ; A1
 854++95CA 93           	db cmdunsupported  /256 ; A2
 855++95CB 93           	db cmdunsupported  /256 ; A3
 856++95CC 93           	db cmdYM2151dp     /256 ; A4
 857++95CD 93           	db cmdYM2203dp     /256 ; A5
 858++95CE 92           	db skip3           /256 ; A6
 859++95CF 92           	db skip3           /256 ; A7
 860++95D0 92           	db skip3           /256 ; A8
 861++95D1 92           	db skip3           /256 ; A9
 862++95D2 93           	db cmdYM3812dp     /256 ; AA
 863++95D3 93           	db cmdYM3526dp     /256 ; AB
 864++95D4 93           	db cmdY8950dp      /256 ; AC
 865++95D5 92           	db skip3           /256 ; AD
 866++95D6 8C           	db cmdYMF262dp0    /256 ; AE
 867++95D7 8C           	db cmdYMF262dp0    /256 ; AF
 868++95D8 92           	db skip3           /256 ; B0
 869++95D9 92           	db skip3           /256 ; B1
 870++95DA 92           	db skip3           /256 ; B2
 871++95DB 92           	db skip3           /256 ; B3
 872++95DC 92           	db skip3           /256 ; B4
 873++95DD 92           	db skip3           /256 ; B5
 874++95DE 92           	db skip3           /256 ; B6
 875++95DF 92           	db skip3           /256 ; B7
 876++95E0 92           	db skip3           /256 ; B8
 877++95E1 92           	db skip3           /256 ; B9
 878++95E2 92           	db skip3           /256 ; BA
 879++95E3 92           	db skip3           /256 ; BB
 880++95E4 92           	db skip3           /256 ; BC
 881++95E5 92           	db skip3           /256 ; BD
 882++95E6 92           	db skip3           /256 ; BE
 883++95E7 92           	db skip3           /256 ; BF
 884++95E8 92           	db skip4           /256 ; C0
 885++95E9 92           	db skip4           /256 ; C1
 886++95EA 92           	db skip4           /256 ; C2
 887++95EB 92           	db skip4           /256 ; C3
 888++95EC 92           	db skip4           /256 ; C4
 889++95ED 92           	db skip4           /256 ; C5
 890++95EE 92           	db skip4           /256 ; C6
 891++95EF 92           	db skip4           /256 ; C7
 892++95F0 92           	db skip4           /256 ; C8
 893++95F1 92           	db skip4           /256 ; C9
 894++95F2 92           	db skip4           /256 ; CA
 895++95F3 92           	db skip4           /256 ; CB
 896++95F4 92           	db skip4           /256 ; CC
 897++95F5 92           	db skip4           /256 ; CD
 898++95F6 92           	db skip4           /256 ; CE
 899++95F7 92           	db skip4           /256 ; CF
 900++95F8 93           	db cmdYMF278B      /256 ; D0
 901++95F9 92           	db skip4           /256 ; D1
 902++95FA 93           	db cmdunsupported  /256 ; D2
 903++95FB 92           	db skip4           /256 ; D3
 904++95FC 92           	db skip4           /256 ; D4
 905++95FD 92           	db skip4           /256 ; D5
 906++95FE 92           	db skip4           /256 ; D6
 907++95FF 92           	db skip4           /256 ; D7
 908++9600 92           	db skip4           /256 ; D8
 909++9601 92           	db skip4           /256 ; D9
 910++9602 92           	db skip4           /256 ; DA
 911++9603 92           	db skip4           /256 ; DB
 912++9604 92           	db skip4           /256 ; DC
 913++9605 92           	db skip4           /256 ; DD
 914++9606 92           	db skip4           /256 ; DE
 915++9607 92           	db skip4           /256 ; DF
 916++9608 93           	db cmdunsupported  /256 ; E0
 917++9609 92           	db skip5           /256 ; E1
 918++960A 92           	db skip5           /256 ; E2
 919++960B 92           	db skip5           /256 ; E3
 920++960C 92           	db skip5           /256 ; E4
 921++960D 92           	db skip5           /256 ; E5
 922++960E 92           	db skip5           /256 ; E6
 923++960F 92           	db skip5           /256 ; E7
 924++9610 92           	db skip5           /256 ; E8
 925++9611 92           	db skip5           /256 ; E9
 926++9612 92           	db skip5           /256 ; EA
 927++9613 92           	db skip5           /256 ; EB
 928++9614 92           	db skip5           /256 ; EC
 929++9615 92           	db skip5           /256 ; ED
 930++9616 92           	db skip5           /256 ; EE
 931++9617 92           	db skip5           /256 ; EF
 932++9618 92           	db skip5           /256 ; F0
 933++9619 92           	db skip5           /256 ; F1
 934++961A 92           	db skip5           /256 ; F2
 935++961B 92           	db skip5           /256 ; F3
 936++961C 92           	db skip5           /256 ; F4
 937++961D 92           	db skip5           /256 ; F5
 938++961E 92           	db skip5           /256 ; F6
 939++961F 92           	db skip5           /256 ; F7
 940++9620 92           	db skip5           /256 ; F8
 941++9621 92           	db skip5           /256 ; F9
 942++9622 92           	db skip5           /256 ; FA
 943++9623 92           	db skip5           /256 ; FB
 944++9624 92           	db skip5           /256 ; FC
 945++9625 92           	db skip5           /256 ; FD
 946++9626 92           	db skip5           /256 ; FE
 947++9627 92           	db skip5           /256 ; FF
 948++9628
 949++9628
 950++9628
 951++9628              cmdYM2608p0 equ cmdYM2203
 952++9628
 953++9628              cmdYM2608p1
 954++9628              	memory_stream_read_2 e,d
 954++9628 2A 72 8C    >	ld hl,(memorystreamcurrentaddr)
 954++962B             >	memory_stream_read_byte e
 954++962B CB 74       >	bit 6,h
 954++962D             >        IF AREA_C000_FFFF=1
 954++962D CC 0D 8C    >	call z,memorystreamnextpage
 954++9630             >        ELSE
 954++9630 ~           > 	call nz,memorystreamnextpage
 954++9630             >        ENDIF
 954++9630 5E          >	ld e,(hl)
 954++9631 23          >	inc hl
 954++9632             >	memory_stream_read_byte d
 954++9632 CB 74       >	bit 6,h
 954++9634             >        IF AREA_C000_FFFF=1
 954++9634 CC 0D 8C    >	call z,memorystreamnextpage
 954++9637             >        ELSE
 954++9637 ~           > 	call nz,memorystreamnextpage
 954++9637             >        ENDIF
 954++9637 56          >	ld d,(hl)
 954++9638 23          >	inc hl
 954++9639 22 72 8C    >	ld (memorystreamcurrentaddr),hl
 955++963C 7B           	ld a,e
 956++963D FE 30        	cp 0x30
 957++963F D8           	ret c
 958++9640 C3 3A 90     	jp opnwritefm2
 959++9643
 960++9643
 961++9643              initAY8910
 962++9643 CD 47 91     	call ssginit
 963++9646 21 00 92     	ld hl,devicemask
 964++9649 3A 77 BE     	ld a,(HEADER_CLOCK_AY8910+3)
 965++964C E6 40        	and 0x40
 966++964E 20 03        	jr nz,.dualchip
 967++9650 CB C6        	set DEVICE_AY_BIT,(hl)
 968++9652 C9           	ret
 969++9653              .dualchip
 970++9653 CB CE        	set DEVICE_TURBOSOUND_BIT,(hl)
 971++9655 C9           	ret
 972++9656
 973++9656              initYM2203
 974++9656              tfmstatus=$+1
 975++9656 3E 01        	ld a,1
 976++9658 3D           	dec a
 977++9659 F8           	ret m
 978++965A CD 45 90     	call opninit
 979++965D              	set_timer opnwaittimer60hz,735
 979++965D 21 DF 02    >	ld hl,735
 979++9660 22 20 92    >	ld (waittimerstep),hl
 980++9663 CD DB 90     	call opninittimer60hz
 981++9666 21 00 92     	ld hl,devicemask
 982++9669 CB D6        	set DEVICE_TFM_BIT,(hl)
 983++966B AF           	xor a
 984++966C C9           	ret
 985++966D
 986++966D              initYMF278B
 987++966D              moonsoundstatus=$+1
 988++966D 3E 02        	ld a,2
 989++966F 3D           	dec a
 990++9670 F8           	ret m
 991++9671 CD 19 8F     	call vgmopl4init
 992++9674 3A 53 BE     	ld a,(HEADER_CLOCK_YM3812+3)
 993++9677 E6 40        	and 0x40
 994++9679 20 08        	jr nz,notOPL2
 995++967B              useYM3812=$+1
 996++967B F6 00        	or 0
 997++967D 11 05 00     	ld de,0x0005
 998++9680 C4 25 8D     	call nz,opl4writefm2
 999++9683              notOPL2
1000++9683 CD 00 90     	call opl4inittimer60hz
1001++9686 21 00 92     	ld hl,devicemask
1002++9689 CB DE        	set DEVICE_MOONSOUND_BIT,(hl)
1003++968B AF           	xor a
1004++968C C9           	ret
1005++968D
1006++968D              end
1007++968D
1008++968D
1009++968D
1010++968D              ;        LABELSLIST "vgm_plr.l"
1011++968D              ;	savebin "gplay.apg",begin,end-begin
# file closed: GPlay/vgm_plr.asm
 276+ 968D              	include sub_func.asm
# file opened: GPlay/sub_func.asm
   1++968D
   2++968D              fileopenerror
   3++968D 79           		ld a,c
   4++968E 0E FF        		ld c,$FF
   5++9690 02                   ld (bc),a ;   
   6++9691
   7++9691 21 A5 8A     		ld hl,txt_fopenerror
   8++9694              		OS_PRINTZ
   8++9694 0E 09       >    ld c,#09
   8++9696 E7          >    rst #20
   9++9697
  10++9697 3A 54 8A     		ld a,(file_id_cur)
  11++969A FE FF        		cp 255
  12++969C 28 03        		jr z,fileopenerror1
  13++969E              		OS_FILE_CLOSE ;A - id file
  13++969E 0E 25       >    ld c,#25
  13++96A0 E7          >    rst #20
  14++96A1              fileopenerror1
  15++96A1 37           		scf ;
  16++96A2 C9           		ret
  17++96A3
  18++96A3
  19++96A3              ; memoryerror
  20++96A3                      ; OS_CLOSEHANDLE
  21++96A3                      ; ld e,6+0x80
  22++96A3                      ; OS_SETGFX
  23++96A3                      ; ld e,0
  24++96A3                      ; OS_CLS
  25++96A3                      ; ld hl,txt_memoryerror
  26++96A3                      ; call print_hl
  27++96A3                      ; YIELDGETKEYLOOP
  28++96A3                      ; jp cmd_quit
  29++96A3
  30++96A3              memoryerror
  31++96A3 79           		ld a,c
  32++96A4 0E FF        		ld c,$FF
  33++96A6 02                   ld (bc),a ;   
  34++96A7
  35++96A7 21 8B 8A     		ld hl,txt_memoryerror
  36++96AA              		OS_PRINTZ
  36++96AA 0E 09       >    ld c,#09
  36++96AC E7          >    rst #20
  37++96AD
  38++96AD 3A 54 8A     		ld a,(file_id_cur)
  39++96B0 FE FF        		cp 255
  40++96B2 28 03        		jr z,memoryerror1
  41++96B4              		OS_FILE_CLOSE ;A - id file
  41++96B4 0E 25       >    ld c,#25
  41++96B6 E7          >    rst #20
  42++96B7              memoryerror1
  43++96B7 37           		scf ;
  44++96B8 C9           		ret
  45++96B9
  46++96B9
  47++96B9
  48++96B9              ;----------------------------------------
  49++96B9              load_mus
  50++96B9
  51++96B9                      ; ld b,0
  52++96B9              ; old_mus EQU $-1
  53++96B9                      ; cp b
  54++96B9                      ; ret z
  55++96B9                      ; ld (old_mus),a
  56++96B9
  57++96B9                      ; and a
  58++96B9                      ; jp z,no_mus
  59++96B9
  60++96B9
  61++96B9                      ; call calc_mus
  62++96B9
  63++96B9                      ; call no_mus
  64++96B9                      ; ld hl,t_s98_file00_pages_list+$FF
  65++96B9                      ; call free_s98_file ; 
  66++96B9
  67++96B9                      ;generate path to music file in 'buf'
  68++96B9                      ; ld hl,mus_path1
  69++96B9                      ; ld de,buf
  70++96B9                      ; call copystr_hlde ;'copy path  'mus/' '
  71++96B9
  72++96B9                      ; ld a,(mus_mode)
  73++96B9                      ; ld hl,mus_modes
  74++96B9                      ; call sel_word
  75++96B9                      ; call copystr_hlde ;copy "aym / s98 path"
  76++96B9                      ; ld hl,mus_path2
  77++96B9                      ; call copystr_hlde ;copy name without ext
  78++96B9
  79++96B9                      ; ld a,(mus_mode)
  80++96B9                      ; ld hl,plr_ext
  81++96B9                      ; call sel_word
  82++96B9                      ; call copystr_hlde  ;copy file ext
  83++96B9                      ; xor a
  84++96B9                      ; ld (de),a  ;string terminator
  85++96B9
  86++96B9                      ; ld de,buf ; 
  87++96B9                      ; call openstream_file
  88++96B9
  89++96B9 21 46 97     		ld hl,file_name_cur
  90++96BC              		OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
  90++96BC 0E 21       >    ld c,#21
  90++96BE E7          >    rst #20
  91++96BF
  92++96BF                      ;or a
  93++96BF                      ;jp nz,fileopenerror
  94++96BF DA 8D 96     		jp c,fileopenerror
  95++96C2 32 54 8A     		ld (file_id_cur),a
  96++96C5
  97++96C5 21 00 8B             ld hl,memorystreampages ;t_s98_file00_pages_list
  98++96C8 22 CC 96             ld (load_s98_file_number),hl
  99++96CB
 100++96CB
 101++96CB              /////------        call load_s98_file      ;de=drive/path/file
 102++96CB
 103++96CB              ;    
 104++96CB              ;   
 105++96CB
 106++96CB                              ;   
 107++96CB
 108++96CB
 109++96CB              load_s98_file_number_haddr = $+2
 109++96CB
 110++96CB              load_s98_file_number = $+1
 110++96CB
 111++96CB 01 00 8B                     ld bc,memorystreampages ;t_s98_file00_pages_list
 112++96CE C5                           push bc
 113++96CF
 114++96CF              read_file_loop:
 115++96CF                              ;OS_NEWPAGE              ;out: a=0 (OK)/!=0 (fail), e=page
 116++96CF              				OS_GET_PAGE ;*
 116++96CF 0E 1A       >    ld c,#1a
 116++96D1 E7          >    rst #20
 117++96D2
 118++96D2 C1                           pop bc ;file tab
 119++96D3
 120++96D3                              ;or a
 121++96D3                              ;jp nz,memory_error
 122++96D3 DA 16 97     				jp c,memory_error
 123++96D6                              ;ld a,e
 124++96D6                                                      ;    !!!!
 125++96D6                                                      ;    !!!!
 126++96D6
 127++96D6 02           1               ld (bc),a
 128++96D7 0C                           inc c           ;      4 !!!!!
 129++96D8
 130++96D8 C5                           push bc ;file tab
 131++96D9                              ;SETPGC000
 132++96D9              				OS_SET_PAGE_SLOT3
 132++96D9 0E 1C       >    ld c,#1c
 132++96DB E7          >    rst #20
 133++96DC
 134++96DC                              ;ld de,$C000
 135++96DC                              ;ld hl,$4000
 136++96DC
 137++96DC                              ;call readstream_file    ;DE = Buffer address, HL = Number of bytes to read
 138++96DC                                              ;hl=actual size
 139++96DC
 140++96DC 3A 54 8A     				ld a,(file_id_cur)
 141++96DF 21 00 C0     				ld hl,$C000
 142++96E2 11 00 40                     ld de,$4000
 143++96E5              				OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl -    )
 143++96E5 0E 23       >    ld c,#23
 143++96E7 E7          >    rst #20
 144++96E8 30 04        				jr nc,read_file_loop1
 145++96EA
 146++96EA              				; 
 147++96EA C1                           pop bc ;file tab
 148++96EB C3 8D 96                     jp fileopenerror
 149++96EE
 150++96EE
 151++96EE              read_file_loop1		;
 152++96EE 7C                           ld a,h
 153++96EF                              ; cp $40
 154++96EF                              ; jr nc,read_file_loop    ;>= $40
 155++96EF FE C0        				cp $c0
 156++96F1 38 DC                        jr c,read_file_loop    ;>= $c0,   
 157++96F3
 158++96F3
 159++96F3              read_file_exit
 160++96F3
 161++96F3 C1                           pop bc ;file tab
 162++96F4                              ;    
 163++96F4 79                           ld a,c
 164++96F5
 165++96F5                             // sub 16   ; !!!!!       0  +16
 166++96F5
 167++96F5 0E FF                        ld c,$FF
 168++96F7 02                           ld (bc),a
 169++96F8
 170++96F8              ;-------------------------------------------------------
 171++96F8              ;    .
 172++96F8              ;       plr_page3    
 173++96F8              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 174++96F8                              ;call closestream_file
 175++96F8 3A 54 8A     				ld a,(file_id_cur)
 176++96FB              				OS_FILE_CLOSE ;A - id file
 176++96FB 0E 25       >    ld c,#25
 176++96FD E7          >    rst #20
 177++96FE
 178++96FE
 179++96FE                              ;call store8000c000 ;*
 180++96FE              ;  8000     
 181++96FE 21 00 8B                     ld hl,memorystreampages ;t_s98_file00_pages_list
 182++9701 7E                           ld a,(hl)
 183++9702                              ;SETPG8000
 184++9702              				OS_SET_PAGE_SLOT3
 184++9702 0E 1C       >    ld c,#1c
 184++9704 E7          >    rst #20
 185++9705                              ; ld a,(plr_page3)
 186++9705                              ; SETPGC000
 187++9705
 188++9705              ;    plr_page3.      .
 189++9705                              ; ld hl,0x8000
 190++9705                              ; ld de,module
 191++9705                              ; ld bc,16384
 192++9705                              ; ldir
 193++9705
 194++9705              ;   plrpage      .
 195++9705                              ; ld a,(plr_page)
 196++9705                              ; SETPGC000
 197++9705                              ; ld hl,t_s98_file00_pages_list
 198++9705                              ; ld de,0xc100         ;0x5000
 199++9705                              ; ld bc,256
 200++9705                              ; ldir
 201++9705
 202++9705                       ;       DI
 203++9705
 204++9705              ;b .
 205++9705                              ;call restore8000c000
 206++9705
 207++9705                              ;call set_music_pages
 208++9705
 209++9705 21 00 C0                     ld hl,module
 210++9708                              ;ld (0x4001),hl *    
 211++9708 22 D1 8A     				ld (START+1),hl
 212++970B CD D0 8A                     call PLR_INIT        ;init music
 213++970E
 214++970E                        ;      EI
 215++970E              ;----------------
 216++970E              ;eloop           halt ;YIELD
 217++970E              ;                call PLR_PLAY
 218++970E              ;                jr eloop
 219++970E              ;----------------
 220++970E
 221++970E
 222++970E              ;!!!!!!!!!!
 223++970E
 224++970E              ; .
 225++970E                              ;ld a,(plr_page)
 226++970E 21 D5 8A                     ld hl,PLR_PLAY
 227++9711                              ;OS_SETMUSIC         ;****     
 228++9711              				OS_SET_INTER
 228++9711 0E 14       >    ld c,#14
 228++9713 E7          >    rst #20
 229++9714 AF           				xor a ;OK
 230++9715 C9           				ret
 231++9716                              ;jp unset_music_pages
 232++9716
 233++9716
 234++9716              memory_error:
 235++9716 C3 A3 96             jp memoryerror
 236++9719
# file closed: GPlay/sub_func.asm
 277+ 9719              	;include common/muldiv.asm
 278+ 9719
 279+ 9719              end_gplay
 280+ 9719
 281+ 9719              ;ниже не включается в файл
 282+ 9719              ;waveheaderbuffer equ 0xc000-2048=0xb800 ;
 283+ 9719
 284+ 9719
 285+ 9719              	;savebin "gplay.apg",start_gplay,$-start_gplay
# file closed: GPlay/gplay.asm
1212  9719              	include nc_pic_view.asm ;просмотр картинок
# file opened: nc_pic_view.asm
   1+ 9719                  ; module ScreenViewer
   2+ 9719              display:
   3+ 9719                  ; call Console.waitForKeyUp
   4+ 9719
   5+ 9719              display_wait1
   6+ 9719 3E 07        	ld a,7
   7+ 971B              	OS_SET_SCREEN ;включить экран
   7+ 971B 0E 1D       >    ld c,#1d
   7+ 971D E7          >    rst #20
   8+ 971E 30 03        	jr nc,display_wait1_ok
   9+ 9720              	OS_WAIT
   9+ 9720 DF          >	rst #18
  10+ 9721 18 F6        	jr display_wait1 ;пока не получилось, может не в фокусе приложение
  11+ 9723
  12+ 9723              display_wait1_ok
  13+ 9723
  14+ 9723 3A 58 99     	ld a,(page_ext01) ;доп страница для данных плеера
  15+ 9726 06 07        	ld b,7 ;страница назначения
  16+ 9728 21 00 80     	ld hl,#8000
  17+ 972B 11 00 C0     	ld de,#c000
  18+ 972E DD 21 00 1B  	ld ix,6912
  19+ 9732              	OS_RAM_COPY
  19+ 9732 0E 19       >    ld c,#19
  19+ 9734 E7          >    rst #20
  20+ 9735                  ;call TextMode.disable
  21+ 9735              .wait
  22+ 9735              	OS_WAIT
  22+ 9735 DF          >	rst #18
  23+ 9736              	OS_GET_CHAR
  23+ 9736 0E 10       >    ld c,#10
  23+ 9738 E7          >    rst #20
  24+ 9739 FE FF        	cp 255
  25+ 973B 28 F8        	jr z, .wait
  26+ 973D AF           	xor a ;текстовый экран
  27+ 973E              	OS_SET_SCREEN
  27+ 973E 0E 1D       >    ld c,#1d
  27+ 9740 E7          >    rst #20
  28+ 9741                  ;call TextMode.cls
  29+ 9741 C9           	ret
  30+ 9742                  ;jp History.back
  31+ 9742
  32+ 9742              ;    endmodule
  33+ 9742
# file closed: nc_pic_view.asm
1213  9742
1214  9742              color_default equ 0*8+7 ;цвет обычный системный
1215  9742              color_view_text equ 4 ;цвет текста в просмотрщике
1216  9742
1217  9742              color_backgr equ 1*8+7 ;цвет фона
1218  9742              color_apg equ 1*8+4 ;цвет приложений
1219  9742              color_dir equ 1*8+6 ;цвет папок
1220  9742
1221  9742              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1222  9742              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1223  9742              color_dir_hi equ 5*8+0 ;цвет папок курсор
1224  9742
1225  9742              file_info_lenght equ 255 ;длина инфо о файле
1226  9742              panel_hight equ 22;высота панели
1227  9742              panel_r_xy equ #0129
1228  9742              buffer_cat equ #c000 ;адрес буфера каталога
1229  9742
1230  9742 00 00        file_r_all dw 0;всего файлов справа
1231  9744 00 00        file_r_cur_focus dw 0;первый видимый
1232  9746 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1233  9846 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1234  9946 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1234  994A 20 20 20 20
1234  994E 20 20 20 20
1234  9952 00
1235  9953 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1236  9954
1237  9954 00 00        file_r_num_cur dw 0 ;текущий файл справа
1238  9956 00           key_pressed db 0 ;последняя клавиша
1239  9957 00           file_id_cur_r db 0 ;id файла справа
1240  9958
1241  9958
1242  9958 00           page_ext01 db 0 ;номер дополнительной страницы
1243  9959 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1244  995B 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1245  995C 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1245  9960 20 20 20 20
1245  9964 20 20 20 20
1245  9968 20 20 20 20
1245  996C 20 20 20 20
1245  9970 20 20 20 20
1245  9974 20 20 00
1246  9977
1247  9977
1248  9977              rect_1
1249  9977 C9           	db #c9
1250  9978              	dup 40-2
1251  9978 CD          >	db #cd
1251  9979 CD          >	db #cd
1251  997A CD          >	db #cd
1251  997B CD          >	db #cd
1251  997C CD          >	db #cd
1251  997D CD          >	db #cd
1251  997E CD          >	db #cd
1251  997F CD          >	db #cd
1251  9980 CD          >	db #cd
1251  9981 CD          >	db #cd
1251  9982 CD          >	db #cd
1251  9983 CD          >	db #cd
1251  9984 CD          >	db #cd
1251  9985 CD          >	db #cd
1251  9986 CD          >	db #cd
1251  9987 CD          >	db #cd
1251  9988 CD          >	db #cd
1251  9989 CD          >	db #cd
1251  998A CD          >	db #cd
1251  998B CD          >	db #cd
1251  998C CD          >	db #cd
1251  998D CD          >	db #cd
1251  998E CD          >	db #cd
1251  998F CD          >	db #cd
1251  9990 CD          >	db #cd
1251  9991 CD          >	db #cd
1251  9992 CD          >	db #cd
1251  9993 CD          >	db #cd
1251  9994 CD          >	db #cd
1251  9995 CD          >	db #cd
1251  9996 CD          >	db #cd
1251  9997 CD          >	db #cd
1251  9998 CD          >	db #cd
1251  9999 CD          >	db #cd
1251  999A CD          >	db #cd
1251  999B CD          >	db #cd
1251  999C CD          >	db #cd
1251  999D CD          >	db #cd
1252  999E              	edup
1253  999E BB 00        	db #bb,0
1254  99A0
1255  99A0              rect_2
1256  99A0 BA           	db #ba
1257  99A1              	dup 40-2
1258  99A1 20          >	db " "
1258  99A2 20          >	db " "
1258  99A3 20          >	db " "
1258  99A4 20          >	db " "
1258  99A5 20          >	db " "
1258  99A6 20          >	db " "
1258  99A7 20          >	db " "
1258  99A8 20          >	db " "
1258  99A9 20          >	db " "
1258  99AA 20          >	db " "
1258  99AB 20          >	db " "
1258  99AC 20          >	db " "
1258  99AD 20          >	db " "
1258  99AE 20          >	db " "
1258  99AF 20          >	db " "
1258  99B0 20          >	db " "
1258  99B1 20          >	db " "
1258  99B2 20          >	db " "
1258  99B3 20          >	db " "
1258  99B4 20          >	db " "
1258  99B5 20          >	db " "
1258  99B6 20          >	db " "
1258  99B7 20          >	db " "
1258  99B8 20          >	db " "
1258  99B9 20          >	db " "
1258  99BA 20          >	db " "
1258  99BB 20          >	db " "
1258  99BC 20          >	db " "
1258  99BD 20          >	db " "
1258  99BE 20          >	db " "
1258  99BF 20          >	db " "
1258  99C0 20          >	db " "
1258  99C1 20          >	db " "
1258  99C2 20          >	db " "
1258  99C3 20          >	db " "
1258  99C4 20          >	db " "
1258  99C5 20          >	db " "
1258  99C6 20          >	db " "
1259  99C7              	edup
1260  99C7 BA 00        	db #ba,0
1261  99C9
1262  99C9              rect_3
1263  99C9 C8           	db #c8
1264  99CA              	dup 40-2
1265  99CA CD          >	db #cd
1265  99CB CD          >	db #cd
1265  99CC CD          >	db #cd
1265  99CD CD          >	db #cd
1265  99CE CD          >	db #cd
1265  99CF CD          >	db #cd
1265  99D0 CD          >	db #cd
1265  99D1 CD          >	db #cd
1265  99D2 CD          >	db #cd
1265  99D3 CD          >	db #cd
1265  99D4 CD          >	db #cd
1265  99D5 CD          >	db #cd
1265  99D6 CD          >	db #cd
1265  99D7 CD          >	db #cd
1265  99D8 CD          >	db #cd
1265  99D9 CD          >	db #cd
1265  99DA CD          >	db #cd
1265  99DB CD          >	db #cd
1265  99DC CD          >	db #cd
1265  99DD CD          >	db #cd
1265  99DE CD          >	db #cd
1265  99DF CD          >	db #cd
1265  99E0 CD          >	db #cd
1265  99E1 CD          >	db #cd
1265  99E2 CD          >	db #cd
1265  99E3 CD          >	db #cd
1265  99E4 CD          >	db #cd
1265  99E5 CD          >	db #cd
1265  99E6 CD          >	db #cd
1265  99E7 CD          >	db #cd
1265  99E8 CD          >	db #cd
1265  99E9 CD          >	db #cd
1265  99EA CD          >	db #cd
1265  99EB CD          >	db #cd
1265  99EC CD          >	db #cd
1265  99ED CD          >	db #cd
1265  99EE CD          >	db #cd
1265  99EF CD          >	db #cd
1266  99F0              	edup
1267  99F0 BC 00        	db #bc,0
1268  99F2
1269  99F2              ;file_name_test db '486 HEART ON FIRE.vgm',0
1270  99F2              msg_menu_info
1271  99F2 0D 43 53 2B  	db 13,"CS+Enter - Play all",0
1271  99F6 45 6E 74 65
1271  99FA 72 20 2D 20
1271  99FE 50 6C 61 79
1271  9A02 20 61 6C 6C
1271  9A06 00
1272  9A07              msg_menu_main1
1273  9A07 20 4C 46 20  	db " LF On",0
1273  9A0B 4F 6E 00
1274  9A0E              msg_menu_main2
1275  9A0E 20 41 5A 20  	db " AZ On",0
1275  9A12 4F 6E 00
1276  9A15              msg_menu_main3
1277  9A15 20 56 69 65  	db " View",0
1277  9A19 77 00
1278  9A1B              msg_file_error
1279  9A1B 46 69 6C 65  	db "File error",10,13,0
1279  9A1F 20 65 72 72
1279  9A23 6F 72 0A 0D
1279  9A27 00
1280  9A28              msg_file_too_big
1281  9A28 46 69 6C 65  	db "File too big",10,13,0
1281  9A2C 20 74 6F 6F
1281  9A30 20 62 69 67
1281  9A34 0A 0D 00
1282  9A37              msg_mem_err
1283  9A37 47 65 74 20  	db "Get memory error",10,13,0
1283  9A3B 6D 65 6D 6F
1283  9A3F 72 79 20 65
1283  9A43 72 72 6F 72
1283  9A47 0A 0D 00
1284  9A4A              msg_title_nc
1285  9A4A 4E 6F 6E 65  	db "None Commander ver 2025.07.24",10,13,0
1285  9A4E 20 43 6F 6D
1285  9A52 6D 61 6E 64
1285  9A56 65 72 20 76
1285  9A5A 65 72 20 32
1285  9A5E 30 32 35 2E
1285  9A62 30 37 2E 32
1285  9A66 34 0A 0D 00
1286  9A6A
1287  9A6A              end_nc
1288  9A6A              ;ниже не включается в файл
1289  9A6A 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1290  9E6A 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1291  9F6A              ;ещё тут буферы плеера
1292  9F6A
1293  9F6A              	savebin "nc.apg",start_nc,$-start_nc
# file closed: nc.asm
