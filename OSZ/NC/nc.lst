# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000
  97+ 0000              ;включить/выключить моно режим для приложения
  98+ 0000              ;при включенном режиме разрешена запись в диапазон памяти #4000-#7fff + страницы приложения
  99+ 0000              ;вх: a = 0 - включить; a = 255 - выключить
 100+ 0000                  macro OS_SET_MONO_MODE ;
 101+ 0000 ~                ld c,#08
 102+ 0000 ~                rst #20
 103+ 0000                  endm
 104+ 0000
 105+ 0000
 106+ 0000
 107+ 0000              ;печать в консоль до кода 0
 108+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 109+ 0000 ~                ld c,#09
 110+ 0000 ~                rst #20
 111+ 0000                  endm
 112+ 0000
 113+ 0000
 114+ 0000              ;прочитать байт из порта uart
 115+ 0000              ;вх:
 116+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 117+ 0000              ;вых: A - считанный байт
 118+ 0000                  macro OS_UART_READ
 119+ 0000 ~                ld c,#0a
 120+ 0000 ~                rst #20
 121+ 0000                  endm
 122+ 0000
 123+ 0000              ;записать байт в порт uart
 124+ 0000              ;вх: A -байт
 125+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 126+ 0000                  macro OS_UART_WRITE
 127+ 0000 ~                ld c,#0b
 128+ 0000 ~                rst #20
 129+ 0000                  endm
 130+ 0000
 131+ 0000              ;закрыть соединение ESP
 132+ 0000              ;вх:
 133+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 134+ 0000                  macro OS_ESP_CLOSE
 135+ 0000 ~                ld c,#0c
 136+ 0000 ~                rst #20
 137+ 0000                  endm
 138+ 0000
 139+ 0000              ;установить соединение ESP (CIPSTART);
 140+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 141+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 142+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 143+ 0000                  macro OS_ESP_OPEN
 144+ 0000 ~                ld c,#0d
 145+ 0000 ~                rst #20
 146+ 0000                  endm
 147+ 0000
 148+ 0000              ;послать запрос ESP (CIPSEND);
 149+ 0000              ;вх: hl - адрес данных, de - длина данных
 150+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 151+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 152+ 0000                  macro OS_ESP_SEND
 153+ 0000 ~                ld c,#0e
 154+ 0000 ~                rst #20
 155+ 0000                  endm
 156+ 0000
 157+ 0000              ;получить пакет ESP (+IPD);
 158+ 0000              ;вх: hl - адрес для данных
 159+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 160+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 161+ 0000                  macro OS_ESP_GET
 162+ 0000 ~                ld c,#0f
 163+ 0000 ~                rst #20
 164+ 0000                  endm
 165+ 0000
 166+ 0000              ;ввод с консоли ----------------------
 167+ 0000
 168+ 0000              ;получить код нажатой клавиши
 169+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 170+ 0000 ~                ld c,#10
 171+ 0000 ~                rst #20
 172+ 0000                  endm
 173+ 0000
 174+ 0000
 175+ 0000              ;процессы ----------------------------
 176+ 0000
 177+ 0000              ;запустить процесс
 178+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 179+ 0000                  macro OS_PROC_RUN ;
 180+ 0000 ~                ld c,#11
 181+ 0000 ~                rst #20
 182+ 0000                  endm
 183+ 0000
 184+ 0000              ;установить фокус
 185+ 0000              ;вх: a - id процесса
 186+ 0000                  macro OS_PROC_SET_FOCUS ;
 187+ 0000 ~                ld c,#12
 188+ 0000 ~                rst #20
 189+ 0000                  endm
 190+ 0000
 191+ 0000              ;закрыть процесс
 192+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 193+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 194+ 0000                  macro OS_PROC_CLOSE ;
 195+ 0000 ~                ld c,#13
 196+ 0000 ~                rst #20
 197+ 0000                  endm
 198+ 0000
 199+ 0000
 200+ 0000              ;прерывания --------------------------
 201+ 0000
 202+ 0000              ;установка адреса обработчика прерываний процесса;
 203+ 0000              ;например, плеера музыки
 204+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 205+ 0000              ;на время выполнения включаются обе страницы процесса
 206+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 207+ 0000 ~                ld c,#14
 208+ 0000 ~                rst #20
 209+ 0000                  endm
 210+ 0000
 211+ 0000
 212+ 0000              ;плеер AY ----------------------------
 213+ 0000
 214+ 0000              ;инициализация плеера AY;
 215+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 216+ 0000 ~                ld c,#15
 217+ 0000 ~                rst #20
 218+ 0000                  endm
 219+ 0000
 220+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 221+ 0000                  macro OS_VTPL_PLAY ;()
 222+ 0000 ~                ld c,#16
 223+ 0000 ~                rst #20
 224+ 0000                  endm
 225+ 0000
 226+ 0000              ;заглушить плеер AY;
 227+ 0000                  macro OS_VTPL_MUTE ;()
 228+ 0000 ~                ld c,#17
 229+ 0000 ~                rst #20
 230+ 0000                  endm
 231+ 0000
 232+ 0000              ;получить значение переменной плеера;
 233+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 234+ 0000 ~                ld c,#18
 235+ 0000 ~                rst #20
 236+ 0000                  endm
 237+ 0000
 238+ 0000
 239+ 0000              ;прочие ------------------------------
 240+ 0000
 241+ 0000
 242+ 0000              ;скопировать данные из страницы в страницу
 243+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 244+ 0000                  macro OS_RAM_COPY
 245+ 0000 ~                ld c,#19
 246+ 0000 ~                rst #20
 247+ 0000                  endm
 248+ 0000
 249+ 0000              ;получить дополнительную страницу памяти;
 250+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 251+ 0000 ~                ld c,#1a
 252+ 0000 ~                rst #20
 253+ 0000                  endm
 254+ 0000
 255+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 256+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 257+ 0000 ~                ld c,#1b
 258+ 0000 ~                rst #20
 259+ 0000                  endm
 260+ 0000
 261+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 262+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 263+ 0000 ~                ld c,#1c
 264+ 0000 ~                rst #20
 265+ 0000                  endm
 266+ 0000
 267+ 0000              ;включить экран N;
 268+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 269+ 0000              ;переключать может только приложение в фокусе
 270+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 271+ 0000              ;при переключении процессов сохраняется только экран #39
 272+ 0000                  macro OS_SET_SCREEN ;
 273+ 0000 ~                ld c,#1d
 274+ 0000 ~                rst #20
 275+ 0000                  endm
 276+ 0000
 277+ 0000
 278+ 0000              ;получить номера страниц процесса;
 279+ 0000              ;вх:
 280+ 0000              ;вых: b, c - страницы в слотах 2, 3
 281+ 0000                  macro OS_GET_MAIN_PAGES ;
 282+ 0000 ~                ld c,#1e
 283+ 0000 ~                rst #20
 284+ 0000                  endm
 285+ 0000
 286+ 0000              ;получить значение системного таймера
 287+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 288+ 0000 ~                ld c,#1F
 289+ 0000 ~                rst #20
 290+ 0000                  endm
 291+ 0000
 292+ 0000
 293+ 0000              ;освободить страницу памяти
 294+ 0000              ;вх: a - номер страницы
 295+ 0000                  macro OS_DEL_PAGE ;
 296+ 0000 ~                ld c,#20
 297+ 0000 ~                rst #20
 298+ 0000                  endm
 299+ 0000
 300+ 0000
 301+ 0000              ;дисковые операции -------------------
 302+ 0000
 303+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 304+ 0000
 305+ 0000              ; fcbFAT (из руководства к монитору)
 306+ 0000              ; формат fcb для работы с FAT
 307+ 0000
 308+ 0000              ; +#00 8 имя файла
 309+ 0000              ; +#08 3 расширение файла
 310+ 0000              ; +#0B 1 атрибуты файла
 311+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 312+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 313+ 0000              ; +#14 4 размер файла/каталога в байтах
 314+ 0000              ; +#18 4 указатель в файле
 315+ 0000              ; +#1C 1 для внутренних нужд
 316+ 0000              ; +#1D 1 для внутренних нужд
 317+ 0000              ; +#1E 1 резерв
 318+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 319+ 0000              	; 1-0,nn номер раздела
 320+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 321+ 0000              	    ; значение %11 недопустимо
 322+ 0000
 323+ 0000              ;открыть файл для чтения или записи
 324+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 325+ 0000 ~                ld c,#21
 326+ 0000 ~                rst #20
 327+ 0000                  endm
 328+ 0000
 329+ 0000              ;создать файл
 330+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 331+ 0000 ~                ld c,#22
 332+ 0000 ~                rst #20
 333+ 0000                  endm
 334+ 0000
 335+ 0000              ;прочитать из файла
 336+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 337+ 0000 ~                ld c,#23
 338+ 0000 ~                rst #20
 339+ 0000                  endm
 340+ 0000
 341+ 0000              ;записать в файл
 342+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 343+ 0000 ~                ld c,#24
 344+ 0000 ~                rst #20
 345+ 0000                  endm
 346+ 0000
 347+ 0000              ;закрыть файл
 348+ 0000                  macro OS_FILE_CLOSE ;A - id file
 349+ 0000 ~                ld c,#25
 350+ 0000 ~                rst #20
 351+ 0000                  endm
 352+ 0000
 353+ 0000              ;чтение секторов текущего каталога
 354+ 0000              ; вх:
 355+ 0000                   ; hl - буфер для чтения
 356+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 357+ 0000                   ; b - максимальное количество секторов для чтения
 358+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 359+ 0000                     ; a=errRWnum
 360+ 0000                     ; a=errInvalidPart
 361+ 0000                     ; a=errFileEmpty
 362+ 0000                   ; cy=0, a=errEoF - каталог закончился
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b - не прочитано секторов
 366+ 0000                   ; cy=0 - считано успешно
 367+ 0000                     ; hl - следующий адрес в буфере
 368+ 0000                     ; de - номер первого непрочитанного сектора
 369+ 0000                     ; b=#00
 370+ 0000                  macro OS_DIR_READ ;
 371+ 0000 ~                ld c,#26
 372+ 0000 ~                rst #20
 373+ 0000                  endm
 374+ 0000
 375+ 0000              ;вход в каталог/выход в родительский каталог
 376+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 377+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 378+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 379+ 0000              	; переход в родительский, последнее имя в пути удалится).
 380+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 381+ 0000              	; добавится имя файла
 382+ 0000              ; вх:
 383+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 384+ 0000                   ; de - адрес дескриптора директории/файла
 385+ 0000              ; вых: a - если путь был указан, новая длина пути
 386+ 0000                  macro OS_DIR_OPEN ;
 387+ 0000 ~                ld c,#27
 388+ 0000 ~                rst #20
 389+ 0000                  endm
 390+ 0000
 391+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 392+ 0000              ;проверки на допустимость значений не производится
 393+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 394+ 0000              ;вх: A - id файла
 395+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 396+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 397+ 0000                  macro OS_FILE_POSITION ;
 398+ 0000 ~                ld c,#28
 399+ 0000 ~                rst #20
 400+ 0000                  endm
 401+ 0000
 402+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 403+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 404+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 405+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 406+ 0000                  macro OS_FIND_PATH ;
 407+ 0000 ~                ld c,#29
 408+ 0000 ~                rst #20
 409+ 0000                  endm
 410+ 0000
 411+ 0000
 412+ 0000              ; получение длинного имени файла
 413+ 0000              ;вх: hl - адрес буфера для имени
 414+ 0000              ;    de - номер записи в текущем каталоге
 415+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 416+ 0000              ; 	a - длина имени, с учетом нуля
 417+ 0000                  macro OS_GET_LFN ;
 418+ 0000 ~                ld c,#2a
 419+ 0000 ~                rst #20
 420+ 0000                  endm
 421+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROG_START
   5  8000
   6  8000              start_nc
   7  8000 21 61 9F     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 5E 9E  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 3A 9F     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A
  24  801A CD CC 80     	call delay
  25  801D C3 EC 82     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 5C 9E     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023              	OS_GET_PAGE ;получить лишнюю страницу для gzip
  31  8023 0E 1A       >    ld c,#1a
  31  8025 E7          >    rst #20
  32  8026 38 EC        	jr c,get_page_error
  33  8028 32 5D 9E     	ld (page_ext02_gzip),a ;запомнить
  34  802B
  35  802B
  36  802B 3A 5D 9E     	ld a,(page_ext02_gzip) ;доп страница для данных плеера
  37  802E              	OS_SET_PAGE_SLOT3
  37  802E 0E 1C       >    ld c,#1c
  37  8030 E7          >    rst #20
  38  8031
  39  8031 21 80 9F     	ld hl,start_gp_gzip_load
  40  8034 11 00 C0     	ld de,start_gp_gzip_ext
  41  8037 01 00 1B     	ld bc,end_gp_gzip_load-start_gp_gzip_load
  42  803A ED B0        	ldir ;сохранить в доп странице
  43  803C
  44  803C 3A 5E 9E     	ld a,(page_main) ;доп страница для данных плеера
  45  803F              	OS_SET_PAGE_SLOT3
  45  803F 0E 1C       >    ld c,#1c
  45  8041 E7          >    rst #20
  46  8042
  47  8042
  48  8042              start_nc_warm ;тёплый старт
  49  8042
  50  8042              	;очистка буфера
  51  8042 CD D2 80     	call clear_buf
  52  8045
  53  8045              	;загрузка каталога
  54  8045 21 00 C0     	ld hl,buffer_cat ;куда
  55  8048 11 00 00     	ld de,0 ;начиная с 0 сектора
  56  804B 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  57  804D              	OS_DIR_READ
  57  804D 0E 26       >    ld c,#26
  57  804F E7          >    rst #20
  58  8050
  59  8050 21 00 00     	ld hl,0 ;обнулить переменные
  60  8053 22 58 9E     	ld (file_r_num_cur),hl
  61  8056 22 46 9C     	ld (file_r_all),hl
  62  8059 22 48 9C     	ld (file_r_cur_focus),hl
  63  805C
  64  805C CD C1 84     	call sort_dir
  65  805F
  66  805F 3E 0F        	ld a,color_backgr
  67  8061 06 0C        	ld b,#c
  68  8063              	OS_SET_COLOR
  68  8063 0E 06       >    ld c,#06
  68  8065 E7          >    rst #20
  69  8066
  70  8066 CD C6 86     	call print_rect_r ;рамка
  71  8069 CD C9 83     	call print_panel_r
  72  806C CD FB 86     	call print_menu_main
  73  806F
  74  806F 11 00 01     	ld de,#0100
  75  8072              	OS_SET_XY
  75  8072 0E 01       >    ld c,#01
  75  8074 E7          >    rst #20
  76  8075
  77  8075 21 F7 9E     	ld hl,msg_menu_info
  78  8078              	OS_PRINTZ
  78  8078 0E 09       >    ld c,#09
  78  807A E7          >    rst #20
  79  807B
  80  807B
  81  807B
  82  807B              nc_wait
  83  807B              	OS_WAIT ;ждать прерывание
  83  807B DF          >	rst #18
  84  807C
  85  807C              	OS_GET_CHAR ;клавиша
  85  807C 0E 10       >    ld c,#10
  85  807E E7          >    rst #20
  86  807F 32 5A 9E     	ld (key_pressed),a ;запомнить
  87  8082 FE 0D        	cp 13
  88  8084 CA 33 81     	jp z,key_enter ;
  89  8087 FE 0A        	cp 10 ;вниз
  90  8089 CC 58 82     	call z,key_down
  91  808C FE 0B        	cp 11 ;вверх
  92  808E CC 95 82     	call z,key_up
  93  8091 FE 09        	cp 09 ;вправо
  94  8093 CC DA 82     	call z,key_right
  95  8096 FE 08        	cp 08 ;влево
  96  8098 CC C8 82     	call z,key_left
  97  809B FE 04        	cp 04 ;страница вверх
  98  809D CC C8 82     	call z,key_left
  99  80A0 FE 05        	cp 05 ;страница вниз
 100  80A2 CC DA 82     	call z,key_right
 101  80A5 FE 31        	cp "1" ;переключение длинных имён (LFN)
 102  80A7 CA 74 86     	jp z,LFN_toggle
 103  80AA FE 32        	cp "2" ;переключение сортировки
 104  80AC CA 54 86     	jp z,sort_toggle
 105  80AF FE 33        	cp "3" ;просмотр файла
 106  80B1 CA 49 87     	jp z,view_file
 107  80B4 FE 19        	cp 25 ;CS+Enter
 108  80B6 CA B8 81     	jp z,nc_play_all
 109  80B9 FE 18        	cp 24 ;break
 110  80BB CA EC 82     	jp z,exit
 111  80BE
 112  80BE
 113  80BE 3A 60 9E     	ld a,(print_panel_r_flag)
 114  80C1 B7           	or a
 115  80C2 C4 C9 83     	call nz,print_panel_r ;обновить каталог
 116  80C5 AF           	xor a
 117  80C6 32 60 9E     	ld (print_panel_r_flag),a
 118  80C9
 119  80C9 C3 7B 80     	jp nc_wait ;на цикл ожидания
 120  80CC
 121  80CC
 122  80CC              delay ;задержка
 123  80CC 06 96        	ld b,50*3 ;
 124  80CE              delay1
 125  80CE              	OS_WAIT
 125  80CE DF          >	rst #18
 126  80CF 10 FD        	djnz delay1
 127  80D1 C9           	ret
 128  80D2
 129  80D2
 130  80D2              clear_buf
 131  80D2 21 00 C0     	ld hl,buffer_cat
 132  80D5 11 01 C0     	ld de,buffer_cat+1
 133  80D8 01 FF 3F     	ld bc,#4000-1
 134  80DB 36 00        	ld (hl),0
 135  80DD ED B0        	ldir
 136  80DF C9           	ret
 137  80E0
 138  80E0
 139  80E0              ;очистить левую панель
 140  80E0              clear_left_panel
 141  80E0 3E 0F        	ld a,color_backgr ;цвет
 142  80E2 06 0C        	ld b,#c
 143  80E4              	OS_SET_COLOR
 143  80E4 0E 06       >    ld c,#06
 143  80E6 E7          >    rst #20
 144  80E7 06 18        	ld b,panel_hight+2 ;высота
 145  80E9 11 00 00     	ld de,0
 146  80EC              	OS_SET_XY
 146  80EC 0E 01       >    ld c,#01
 146  80EE E7          >    rst #20
 147  80EF              clear_left_panel_cl
 148  80EF C5           	push bc
 149  80F0 21 00 81     	ld hl,txt_clear_panel
 150  80F3              	OS_PRINTZ
 150  80F3 0E 09       >    ld c,#09
 150  80F5 E7          >    rst #20
 151  80F6 C1           	pop bc
 152  80F7 10 F6        	djnz clear_left_panel_cl
 153  80F9 11 00 00     	ld de,0
 154  80FC              	OS_SET_XY
 154  80FC 0E 01       >    ld c,#01
 154  80FE E7          >    rst #20
 155  80FF C9           	ret
 156  8100 20 20 20 20  txt_clear_panel db "                                        ",13,0 ;40 пробелов
 156  8104 20 20 20 20
 156  8108 20 20 20 20
 156  810C 20 20 20 20
 156  8110 20 20 20 20
 156  8114 20 20 20 20
 156  8118 20 20 20 20
 156  811C 20 20 20 20
 156  8120 20 20 20 20
 156  8124 20 20 20 20
 156  8128 0D 00
 157  812A
 158  812A
 159  812A              release_key ;ждать отпускания клавиши
 160  812A              	OS_WAIT
 160  812A DF          >	rst #18
 161  812B              	OS_GET_CHAR
 161  812B 0E 10       >    ld c,#10
 161  812D E7          >    rst #20
 162  812E FE FF        	cp 255
 163  8130 20 F8        	jr nz,release_key
 164  8132 C9           	ret
 165  8133
 166  8133
 167  8133              key_enter
 168  8133              	;нажата Enter
 169  8133 2A 46 9C     	ld hl,(file_r_all)
 170  8136 7D           	ld a,l
 171  8137 B4           	or h
 172  8138 CA B5 81     	jp z,key_enter_ex ;защита
 173  813B 2A 58 9E     	ld hl,(file_r_num_cur)
 174  813E CD 4B 82     	call calc_deskr
 175  8141 DD 7E 0B     	ld a,(ix+#0b)
 176  8144 FE 10        	cp #10 ;признак каталога
 177  8146 CA 3D 82     	jp z,key_enter_dir
 178  8149
 179  8149 FE 30        	cp #30 ;признак каталога
 180  814B CA 3D 82     	jp z,key_enter_dir
 181  814E
 182  814E
 183  814E CD 91 86     	call format_name
 184  8151
 185  8151              	;проверка расширения APG
 186  8151 CD F0 82     	call check_apg
 187  8154 C2 69 81     	jp nz,key_enter_1
 188  8157              	;тут запуск приложения
 189  8157 21 4A 9C     	ld hl,file_name_cur		;строка с именем
 190  815A              	OS_PROC_RUN ;запустить прогу
 190  815A 0E 11       >    ld c,#11
 190  815C E7          >    rst #20
 191  815D              	;обработка ошибки
 192  815D DA B5 81     	jp c,key_enter_ex
 193  8160
 194  8160 DD 7E 00     	ld a,(ix)
 195  8163              	OS_PROC_SET_FOCUS ;на передний план
 195  8163 0E 12       >    ld c,#12
 195  8165 E7          >    rst #20
 196  8166 C3 B5 81     	jp key_enter_ex
 197  8169
 198  8169
 199  8169
 200  8169              key_enter_1
 201  8169              	;проверка расширения VGZ
 202  8169 CD 2E 83     	call check_vgz
 203  816C C2 76 81     	jp nz,key_enter_2_1
 204  816F
 205  816F 3E 7A        	ld a,"z" ;код формата
 206  8171 CD 52 8A     	call start_gplay
 207  8174
 208  8174 18 3F        	jr key_enter_ex
 209  8176
 210  8176
 211  8176              key_enter_2_1
 212  8176              	;проверка расширения VGM
 213  8176 CD 0F 83     	call check_vgm
 214  8179 C2 83 81     	jp nz,key_enter_2
 215  817C
 216  817C 3E 76        	ld a,"v" ;код формата
 217  817E CD 52 8A     	call start_gplay
 218  8181
 219  8181 18 32        	jr key_enter_ex
 220  8183
 221  8183
 222  8183              key_enter_2
 223  8183              	;проверка расширения SCR
 224  8183 CD 4D 83     	call check_scr
 225  8186 C2 8E 81     	jp nz,key_enter_3
 226  8189
 227  8189 CD E9 9B     	call display ;показать
 228  818C
 229  818C 18 27        	jr key_enter_ex
 230  818E
 231  818E
 232  818E              key_enter_3
 233  818E              	;проверка расширения MOD
 234  818E CD 6C 83     	call check_mod
 235  8191 C2 9B 81     	jp nz,key_enter_4
 236  8194
 237  8194 3E 6D        	ld a,"m" ;код формата
 238  8196 CD 52 8A     	call start_gplay
 239  8199
 240  8199 18 1A        	jr key_enter_ex
 241  819B
 242  819B
 243  819B              key_enter_4
 244  819B              	;проверка расширения PT2
 245  819B CD 8B 83     	call check_pt2
 246  819E C2 A8 81     	jp nz,key_enter_5
 247  81A1
 248  81A1 3E 32        	ld a,"2" ;код формата
 249  81A3 CD 52 8A     	call start_gplay
 250  81A6
 251  81A6 18 0D        	jr key_enter_ex
 252  81A8
 253  81A8
 254  81A8              key_enter_5
 255  81A8              	;проверка расширения PT3
 256  81A8 CD AA 83     	call check_pt3
 257  81AB C2 B5 81     	jp nz,key_enter_6
 258  81AE
 259  81AE 3E 33        	ld a,"3" ;код формата
 260  81B0 CD 52 8A     	call start_gplay
 261  81B3
 262  81B3 18 00        	jr key_enter_ex
 263  81B5
 264  81B5
 265  81B5
 266  81B5              key_enter_6
 267  81B5
 268  81B5
 269  81B5
 270  81B5
 271  81B5              key_enter_ex
 272  81B5 C3 7B 80     	jp nc_wait
 273  81B8
 274  81B8
 275  81B8
 276  81B8
 277  81B8
 278  81B8
 279  81B8
 280  81B8              nc_play_all
 281  81B8              	;Воспроизведение всего по порядку
 282  81B8 2A 46 9C     	ld hl,(file_r_all)
 283  81BB 7D           	ld a,l
 284  81BC B4           	or h
 285  81BD CA 23 82     	jp z,nc_play_ex ;защита
 286  81C0 2A 58 9E     	ld hl,(file_r_num_cur)
 287  81C3 CD 4B 82     	call calc_deskr
 288  81C6 DD 7E 0B     	ld a,(ix+#0b)
 289  81C9 FE 10        	cp #10 ;признак каталога
 290  81CB 28 59        	jr z,nc_play_all_down
 291  81CD
 292  81CD FE 30        	cp #30 ;признак каталога
 293  81CF 28 55        	jr z,nc_play_all_down
 294  81D1
 295  81D1
 296  81D1 CD 91 86     	call format_name
 297  81D4
 298  81D4              nc_play_1
 299  81D4              	;проверка расширения ;VGM
 300  81D4 CD 0F 83     	call check_vgm
 301  81D7 C2 ED 81     	jp nz,nc_play_2
 302  81DA
 303  81DA 3E 76        	ld a,"v"
 304  81DC CD 52 8A     	call start_gplay
 305  81DF
 306  81DF              nc_play_1_next
 307  81DF
 308  81DF FE 73        	cp "s"
 309  81E1 28 40        	jr z,nc_play_ex
 310  81E3 FE 53        	cp "S"
 311  81E5 28 3C        	jr z,nc_play_ex
 312  81E7 FE 18        	cp 24 ;break
 313  81E9 28 38        	jr z,nc_play_ex
 314  81EB
 315  81EB 18 39        	jr nc_play_all_down
 316  81ED
 317  81ED              nc_play_2
 318  81ED              	;проверка расширения ;VGZ
 319  81ED CD 2E 83     	call check_vgz
 320  81F0 C2 FA 81     	jp nz,nc_play_3
 321  81F3
 322  81F3 3E 7A        	ld a,"z"
 323  81F5 CD 52 8A     	call start_gplay
 324  81F8
 325  81F8 18 E5        	jr nc_play_1_next
 326  81FA
 327  81FA
 328  81FA              nc_play_3
 329  81FA              	;проверка расширения MOD
 330  81FA CD 6C 83     	call check_mod
 331  81FD C2 07 82     	jp nz,nc_play_4
 332  8200
 333  8200 3E 6D        	ld a,"m"
 334  8202 CD 52 8A     	call start_gplay
 335  8205
 336  8205 18 D8        	jr nc_play_1_next
 337  8207
 338  8207
 339  8207              nc_play_4
 340  8207              	;проверка расширения pt2
 341  8207 CD 8B 83     	call check_pt2
 342  820A C2 14 82     	jp nz,nc_play_5
 343  820D
 344  820D 3E 32        	ld a,"2"
 345  820F CD 52 8A     	call start_gplay
 346  8212
 347  8212 18 CB        	jr nc_play_1_next
 348  8214
 349  8214              nc_play_5
 350  8214              	;проверка расширения pt3
 351  8214 CD AA 83     	call check_pt3
 352  8217 C2 21 82     	jp nz,nc_play_6
 353  821A
 354  821A 3E 33        	ld a,"3"
 355  821C CD 52 8A     	call start_gplay
 356  821F
 357  821F 18 BE        	jr nc_play_1_next
 358  8221
 359  8221
 360  8221              nc_play_6
 361  8221 18 03        	jr nc_play_all_down
 362  8223
 363  8223
 364  8223
 365  8223              nc_play_ex
 366  8223 C3 7B 80     	jp nc_wait
 367  8226
 368  8226
 369  8226              nc_play_all_down ;вниз по списку
 370  8226 ED 4B 58 9E  	ld bc,(file_r_num_cur)
 371  822A C5           	push bc
 372  822B CD 58 82     	call key_down
 373  822E CD C9 83     	call print_panel_r ;обновить каталог
 374  8231 C1           	pop bc
 375  8232 2A 58 9E     	ld hl,(file_r_num_cur)
 376  8235 A7           	and a
 377  8236 ED 42        	sbc hl,bc ;если не сдвинулась позиция, то всё
 378  8238 28 E9        	jr z,nc_play_ex
 379  823A C3 B8 81     	jp nc_play_all
 380  823D
 381  823D
 382  823D
 383  823D
 384  823D
 385  823D
 386  823D
 387  823D
 388  823D              key_enter_dir
 389  823D              	;тут открытие папки
 390  823D
 391  823D              	;call format_name_dir
 392  823D EB           	ex de,hl ;de - дескриптор для открытия
 393  823E 21 4A 9D     	ld hl,dir_name_cur
 394  8241              	OS_DIR_OPEN
 394  8241 0E 27       >    ld c,#27
 394  8243 E7          >    rst #20
 395  8244 DA B5 81     	jp c,key_enter_ex ;если ошибка, ничего не делаем
 396  8247
 397  8247 E1           	pop hl ;отменить возврат
 398  8248 C3 42 80     	jp start_nc_warm ;перезагрузить папку
 399  824B
 400  824B
 401  824B              ; format_name_dir
 402  824B              	; push hl
 403  824B              	; ld hl,file_name_cur
 404  824B              	; ld de,file_name_cur+1 ;почистить
 405  824B              	; ld bc,256-1
 406  824B              	; ld (hl),0
 407  824B              	; ldir
 408  824B
 409  824B              	; pop hl
 410  824B
 411  824B              	; ld de,file_name_cur ;куда
 412  824B              	; ld bc,#08ff
 413  824B              ; format_name_dir_cl
 414  824B              	; ld a,(hl)
 415  824B              	; cp " "+1
 416  824B              	; jr c,format_name_dir_skip
 417  824B              	; ldi
 418  824B              	; djnz format_name_dir_cl
 419  824B              ; format_name_dir_skip
 420  824B              	; ld a,'/'
 421  824B              	; ld (de),a
 422  824B              	; ret
 423  824B
 424  824B               ;вычислить дескриптор текущего элемента справа
 425  824B              calc_deskr
 426  824B 29           	add hl,hl ;*2
 427  824C 01 80 9F     	ld bc,cat_index
 428  824F 09           	add hl,bc
 429  8250 5E           	ld e,(hl)
 430  8251 23           	inc hl
 431  8252 56           	ld d,(hl)
 432  8253 EB           	ex de,hl ;hl - адрес элемента
 433  8254 E5           	push hl
 434  8255 DD E1        	pop ix ;ix- адрес элемента
 435  8257 C9           	ret
 436  8258
 437  8258
 438  8258
 439  8258
 440  8258              key_down
 441  8258 2A 46 9C     	ld hl,(file_r_all)
 442  825B 7D           	ld a,l
 443  825C B4           	or h
 444  825D CA 91 82     	jp z,key_down_ex ;защита
 445  8260
 446  8260 ED 4B 58 9E  	ld bc,(file_r_num_cur)
 447  8264 03           	inc bc
 448  8265 2A 46 9C     	ld hl,(file_r_all)
 449  8268              	;если не больше чем всего
 450  8268 A7           	and a
 451  8269 ED 42        	sbc hl,bc
 452  826B 38 24        	jr c,key_down_skip
 453  826D 28 22        	jr z,key_down_skip
 454  826F              	;прибавить
 455  826F ED 43 58 9E  	ld (file_r_num_cur),bc
 456  8273
 457  8273              	;теперь передвинуть фокус, если надо
 458  8273 2A 48 9C     	ld hl,(file_r_cur_focus)
 459  8276 01 16 00     	ld bc,panel_hight
 460  8279 09           	add hl,bc ;прибавить количество видимых
 461  827A ED 4B 58 9E  	ld bc,(file_r_num_cur)
 462  827E A7           	and a
 463  827F ED 42        	sbc hl,bc ;вычесть положение курсора
 464  8281 28 02        	jr z,key_down_change_focus_yes
 465  8283 30 07        	jr nc,key_down_change_focus_no
 466  8285              key_down_change_focus_yes
 467  8285              	;передвинуть фокус
 468  8285 2A 48 9C     	ld hl,(file_r_cur_focus)
 469  8288 23           	inc hl
 470  8289 22 48 9C     	ld (file_r_cur_focus),hl
 471  828C
 472  828C              key_down_change_focus_no
 473  828C 3E 01        	ld a,1
 474  828E 32 60 9E     	ld (print_panel_r_flag),a
 475  8291              	;call print_panel_r ;обновить каталог
 476  8291              key_down_skip
 477  8291
 478  8291              key_down_ex
 479  8291 3A 5A 9E     	ld a,(key_pressed)
 480  8294 C9           	ret
 481  8295
 482  8295
 483  8295
 484  8295              key_up ;вверх
 485  8295 2A 46 9C     	ld hl,(file_r_all)
 486  8298 7D           	ld a,l
 487  8299 B4           	or h
 488  829A CA C4 82     	jp z,key_up_ex ;защита
 489  829D
 490  829D 2A 58 9E     	ld hl,(file_r_num_cur)
 491  82A0 7D           	ld a,l
 492  82A1 B4           	or h
 493  82A2 28 20        	jr z,key_up_skip
 494  82A4 2B           	dec hl
 495  82A5 22 58 9E     	ld (file_r_num_cur),hl
 496  82A8
 497  82A8              	;теперь передвинуть фокус, если надо
 498  82A8 2A 58 9E     	ld hl,(file_r_num_cur)
 499  82AB              	; ld bc,panel_hight
 500  82AB              	; add hl,bc ;прибавить количество видимых
 501  82AB ED 4B 48 9C  	ld bc,(file_r_cur_focus)
 502  82AF A7           	and a
 503  82B0 ED 42        	sbc hl,bc ;вычесть положение курсора
 504  82B2              	;jr z,key_up_change_foces_yes
 505  82B2 30 0B        	jr nc,key_up_change_foces_no
 506  82B4              key_up_change_foces_yes
 507  82B4              	;передвинуть фокус
 508  82B4 2A 48 9C     	ld hl,(file_r_cur_focus)
 509  82B7 7C           	ld a,h
 510  82B8 B5           	or l
 511  82B9 28 04        	jr z,key_up_change_foces_no ;защита
 512  82BB 2B           	dec hl
 513  82BC 22 48 9C     	ld (file_r_cur_focus),hl
 514  82BF
 515  82BF              key_up_change_foces_no
 516  82BF
 517  82BF 3E 01        	ld a,1
 518  82C1 32 60 9E     	ld (print_panel_r_flag),a
 519  82C4              	;call print_panel_r ;обновить каталог
 520  82C4              key_up_skip
 521  82C4
 522  82C4              key_up_ex
 523  82C4 3A 5A 9E     	ld a,(key_pressed)
 524  82C7 C9           	ret
 525  82C8
 526  82C8
 527  82C8              key_left ;на страницу назад
 528  82C8 06 15        	ld b,panel_hight-1
 529  82CA              key_left_cl
 530  82CA C5           	push bc
 531  82CB CD 95 82     	call key_up
 532  82CE C1           	pop bc
 533  82CF 10 F9        	djnz key_left_cl
 534  82D1 3E 01        	ld a,1
 535  82D3 32 60 9E     	ld (print_panel_r_flag),a
 536  82D6 3A 5A 9E     	ld a,(key_pressed)
 537  82D9 C9           	ret
 538  82DA
 539  82DA
 540  82DA
 541  82DA              key_right ;на страницу вперёд
 542  82DA 06 15        	ld b,panel_hight-1
 543  82DC              key_right_cl
 544  82DC C5           	push bc
 545  82DD CD 58 82     	call key_down
 546  82E0 C1           	pop bc
 547  82E1 10 F9        	djnz key_right_cl
 548  82E3 3E 01        	ld a,1
 549  82E5 32 60 9E     	ld (print_panel_r_flag),a
 550  82E8 3A 5A 9E     	ld a,(key_pressed)
 551  82EB C9           	ret
 552  82EC
 553  82EC
 554  82EC
 555  82EC              exit ;выход в DOS
 556  82EC AF           	xor a
 557  82ED              	OS_PROC_CLOSE
 557  82ED 0E 13       >    ld c,#13
 557  82EF E7          >    rst #20
 558  82F0
 559  82F0
 560  82F0
 561  82F0              check_apg ;проверка на расширение APG
 562  82F0 DD 7E 08     	ld a,(ix+8)
 563  82F3 FE 61        	cp "a"
 564  82F5 28 03        	jr z,check_apg1
 565  82F7 FE 41        	cp "A"
 566  82F9 C0           	ret nz
 567  82FA              check_apg1
 568  82FA DD 7E 09     	ld a,(ix+9)
 569  82FD FE 70        	cp "p"
 570  82FF 28 03        	jr z,check_apg2
 571  8301 FE 50        	cp "P"
 572  8303 C0           	ret nz
 573  8304              check_apg2
 574  8304 DD 7E 0A     	ld a,(ix+10)
 575  8307 FE 67        	cp "g"
 576  8309 C8           	ret z
 577  830A FE 47        	cp "G"
 578  830C C0           	ret nz
 579  830D AF           	xor a ;равен
 580  830E C9           	ret
 581  830F
 582  830F
 583  830F              check_vgm ;проверка на расширение VGM
 584  830F DD 7E 08     	ld a,(ix+8)
 585  8312 FE 76        	cp "v"
 586  8314 28 03        	jr z,check_vgm1
 587  8316 FE 56        	cp "V"
 588  8318 C0           	ret nz
 589  8319              check_vgm1
 590  8319 DD 7E 09     	ld a,(ix+9)
 591  831C FE 67        	cp "g"
 592  831E 28 03        	jr z,check_vgm2
 593  8320 FE 47        	cp "G"
 594  8322 C0           	ret nz
 595  8323              check_vgm2
 596  8323 DD 7E 0A     	ld a,(ix+10)
 597  8326 FE 6D        	cp "m"
 598  8328 C8           	ret z
 599  8329 FE 4D        	cp "M"
 600  832B C0           	ret nz
 601  832C AF           	xor a ;равен
 602  832D C9           	ret
 603  832E
 604  832E              check_vgz ;проверка на расширение VGZ
 605  832E DD 7E 08     	ld a,(ix+8)
 606  8331 FE 76        	cp "v"
 607  8333 28 03        	jr z,check_vgz1
 608  8335 FE 56        	cp "V"
 609  8337 C0           	ret nz
 610  8338              check_vgz1
 611  8338 DD 7E 09     	ld a,(ix+9)
 612  833B FE 67        	cp "g"
 613  833D 28 03        	jr z,check_vgz2
 614  833F FE 47        	cp "G"
 615  8341 C0           	ret nz
 616  8342              check_vgz2
 617  8342 DD 7E 0A     	ld a,(ix+10)
 618  8345 FE 7A        	cp "z"
 619  8347 C8           	ret z
 620  8348 FE 5A        	cp "Z"
 621  834A C0           	ret nz
 622  834B AF           	xor a ;равен
 623  834C C9           	ret
 624  834D
 625  834D
 626  834D              check_scr ;проверка на расширение SCR
 627  834D DD 7E 08     	ld a,(ix+8)
 628  8350 FE 73        	cp "s"
 629  8352 28 03        	jr z,check_scr1
 630  8354 FE 53        	cp "S"
 631  8356 C0           	ret nz
 632  8357              check_scr1
 633  8357 DD 7E 09     	ld a,(ix+9)
 634  835A FE 63        	cp "c"
 635  835C 28 03        	jr z,check_scr2
 636  835E FE 43        	cp "C"
 637  8360 C0           	ret nz
 638  8361              check_scr2
 639  8361 DD 7E 0A     	ld a,(ix+10)
 640  8364 FE 72        	cp "r"
 641  8366 C8           	ret z
 642  8367 FE 52        	cp "R"
 643  8369 C0           	ret nz
 644  836A AF           	xor a ;равен
 645  836B C9           	ret
 646  836C
 647  836C              check_mod ;проверка на расширение MOD
 648  836C DD 7E 08     	ld a,(ix+8)
 649  836F FE 6D        	cp "m"
 650  8371 28 03        	jr z,check_mod1
 651  8373 FE 4D        	cp "M"
 652  8375 C0           	ret nz
 653  8376              check_mod1
 654  8376 DD 7E 09     	ld a,(ix+9)
 655  8379 FE 6F        	cp "o"
 656  837B 28 03        	jr z,check_mod2
 657  837D FE 4F        	cp "O"
 658  837F C0           	ret nz
 659  8380              check_mod2
 660  8380 DD 7E 0A     	ld a,(ix+10)
 661  8383 FE 64        	cp "d"
 662  8385 C8           	ret z
 663  8386 FE 44        	cp "D"
 664  8388 C0           	ret nz
 665  8389 AF           	xor a ;равен
 666  838A C9           	ret
 667  838B
 668  838B
 669  838B              check_pt2 ;проверка на расширение pt2
 670  838B DD 7E 08     	ld a,(ix+8)
 671  838E FE 70        	cp "p"
 672  8390 28 03        	jr z,check_pt21
 673  8392 FE 50        	cp "P"
 674  8394 C0           	ret nz
 675  8395              check_pt21
 676  8395 DD 7E 09     	ld a,(ix+9)
 677  8398 FE 74        	cp "t"
 678  839A 28 03        	jr z,check_pt22
 679  839C FE 54        	cp "T"
 680  839E C0           	ret nz
 681  839F              check_pt22
 682  839F DD 7E 0A     	ld a,(ix+10)
 683  83A2 FE 32        	cp "2"
 684  83A4 C8           	ret z
 685  83A5 FE 32        	cp "2"
 686  83A7 C0           	ret nz
 687  83A8 AF           	xor a ;равен
 688  83A9 C9           	ret
 689  83AA
 690  83AA              check_pt3 ;проверка на расширение pt3
 691  83AA DD 7E 08     	ld a,(ix+8)
 692  83AD FE 70        	cp "p"
 693  83AF 28 03        	jr z,check_pt31
 694  83B1 FE 50        	cp "P"
 695  83B3 C0           	ret nz
 696  83B4              check_pt31
 697  83B4 DD 7E 09     	ld a,(ix+9)
 698  83B7 FE 74        	cp "t"
 699  83B9 28 03        	jr z,check_pt32
 700  83BB FE 54        	cp "T"
 701  83BD C0           	ret nz
 702  83BE              check_pt32
 703  83BE DD 7E 0A     	ld a,(ix+10)
 704  83C1 FE 33        	cp "3"
 705  83C3 C8           	ret z
 706  83C4 FE 33        	cp "3"
 707  83C6 C0           	ret nz
 708  83C7 AF           	xor a ;равен
 709  83C8 C9           	ret
 710  83C9
 711  83C9              print_panel_r ;печать правой панели
 712  83C9              	;ld ix,buffer_cat
 713  83C9 FD 2A 46 9C  	ld iy,(file_r_all) ;всего файлов
 714  83CD FD 7D        	ld a,iyl
 715  83CF FD B4        	or iyh
 716  83D1 C8           	ret z ;защита если 0
 717  83D2 11 29 01     	ld de,panel_r_xy ;координаты yx
 718  83D5 06 16        	ld b,panel_hight ;высота панели
 719  83D7 FD 2A 48 9C  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 720  83DB              print_panel_r_cl ;цикл
 721  83DB C5           	push bc
 722  83DC D5           	push de ;xy
 723  83DD              	OS_SET_XY
 723  83DD 0E 01       >    ld c,#01
 723  83DF E7          >    rst #20
 724  83E0
 725  83E0              	;получить адрес элемента
 726  83E0 FD E5        	push iy
 727  83E2 E1           	pop hl
 728  83E3 CD 4B 82     	call calc_deskr
 729  83E6
 730  83E6 CD 01 84     	call print_file_info ;напечатать строку
 731  83E9              print_panel_r_skip
 732  83E9 D1           	pop de
 733  83EA 14           	inc d ;y++
 734  83EB FD 23        	inc iy ;текущий файл
 735  83ED              	;проверка на конец каталога
 736  83ED 2A 46 9C     	ld hl,(file_r_all)
 737  83F0 FD E5        	push iy
 738  83F2 C1           	pop bc
 739  83F3 A7           	and a
 740  83F4 ED 42        	sbc hl,bc
 741  83F6 C1           	pop bc
 742  83F7 38 07        	jr c,print_panel_r_ex2
 743  83F9 28 05        	jr z,print_panel_r_ex2
 744  83FB 10 DE        	djnz print_panel_r_cl
 745  83FD C9           	ret
 746  83FE              print_panel_r_ex
 747  83FE D1           	pop de
 748  83FF C1           	pop bc
 749  8400              print_panel_r_ex2
 750  8400              	;тут, возможно, надо допечатать пустые строки
 751  8400 C9           	ret
 752  8401
 753  8401
 754  8401
 755  8401
 756  8401
 757  8401              print_file_info ;печать строки о файле
 758  8401 3A 90 86     	ld a,(LFN_enable_flag)
 759  8404 B7           	or a
 760  8405 28 4D        	jr z,print_file_info_SFN
 761  8407
 762  8407
 763  8407
 764  8407              print_file_info_LFN ;печать длинного имени
 765  8407              	;узнать номер записи
 766  8407 01 00 C0     	ld bc,#c000
 767  840A A7           	and a
 768  840B ED 42        	sbc hl,bc
 769  840D              ;разделить на 32
 770  840D CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 771  840F CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 772  8411 CB 3C        	srl h ; /4
 773  8413 CB 1D        	rr l ;
 774  8415 CB 3C        	srl h ; /8
 775  8417 CB 1D        	rr l ;
 776  8419 CB 3C        	srl h ; /16
 777  841B CB 1D        	rr l ;
 778  841D CB 3C        	srl h ; /32
 779  841F CB 1D        	rr l ;
 780  8421
 781  8421
 782  8421 EB           	ex de,hl ;de - порядковый номер записи
 783  8422
 784  8422 21 80 A7     	ld hl,file_info_string ;куда
 785  8425              	OS_GET_LFN ;получить длинное имя
 785  8425 0E 2A       >    ld c,#2a
 785  8427 E7          >    rst #20
 786  8428
 787  8428 CD 7C 84     	call get_color_item
 788  842B
 789  842B 06 0C        	ld b,#c
 790  842D              	OS_SET_COLOR
 790  842D 0E 06       >    ld c,#06
 790  842F E7          >    rst #20
 791  8430
 792  8430              	;печать не длиннее 80/2 символов
 793  8430 21 80 A7     	ld hl,file_info_string
 794  8433 06 26        	ld b,80/2-2
 795  8435 0E 28        	ld c,40 ;колонка
 796  8437              print_file_info_LFN_cl
 797  8437 E5           	push hl
 798  8438 C5           	push bc
 799  8439 7E           	ld a,(hl)
 800  843A B7           	or a
 801  843B 28 09        	jr z,print_file_info_LFN_cl_ex
 802  843D              	OS_PRINT_CHARF
 802  843D D7          >	rst #10
 803  843E C1           	pop bc
 804  843F 0C           	inc c
 805  8440 E1           	pop hl
 806  8441 23           	inc hl
 807  8442 10 F3        	djnz print_file_info_LFN_cl
 808  8444 18 02        	jr print_file_info_LFN_ex
 809  8446              print_file_info_LFN_cl_ex
 810  8446 C1           	pop bc
 811  8447 E1           	pop hl
 812  8448              print_file_info_LFN_ex
 813  8448              	;допечатать пробелы до правого края, зависит от длины имени
 814  8448              print_file_info_LFN_cl2
 815  8448 79           	ld a,c
 816  8449 FE 4E        	cp 80-2
 817  844B D0           	ret nc
 818  844C C5           	push bc
 819  844D 3E 20        	ld a,' '
 820  844F              	OS_PRINT_CHARF
 820  844F D7          >	rst #10
 821  8450 C1           	pop bc
 822  8451 0C           	inc c
 823  8452 18 F4        	jr print_file_info_LFN_cl2
 824  8454
 825  8454
 826  8454
 827  8454              print_file_info_SFN ;печать короткого имени
 828  8454 11 80 A7     	ld de,file_info_string ;скопировать
 829  8457 01 08 00     	ld bc,8 ;file_info_lenght
 830  845A ED B0        	ldir
 831  845C 3E 20        	ld a,' '
 832  845E 12           	ld (de),a
 833  845F 13           	inc de
 834  8460 01 03 00     	ld bc,3
 835  8463 ED B0        	ldir
 836  8465 AF           	xor a
 837  8466 12           	ld (de),a
 838  8467
 839  8467 CD 7C 84     	call get_color_item
 840  846A
 841  846A 06 0C        	ld b,#c
 842  846C              	OS_SET_COLOR
 842  846C 0E 06       >    ld c,#06
 842  846E E7          >    rst #20
 843  846F 21 80 A7     	ld hl,file_info_string
 844  8472              	OS_PRINTZ
 844  8472 0E 09       >    ld c,#09
 844  8474 E7          >    rst #20
 845  8475              	;допечатать пробелы до правого края, длина имени постоянная
 846  8475 21 61 9E     	ld hl,file_info_string_SFN_end
 847  8478              	OS_PRINTZ
 847  8478 0E 09       >    ld c,#09
 847  847A E7          >    rst #20
 848  847B C9           	ret
 849  847C
 850  847C
 851  847C
 852  847C              get_color_item ;получить цвет элемента
 853  847C              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 854  847C              ;вых: A - цвет
 855  847C ED 4B 58 9E  	ld bc,(file_r_num_cur) ;позиция курсора справа
 856  8480 FD E5        	push iy
 857  8482 E1           	pop hl
 858  8483 A7           	and a
 859  8484 ED 42        	sbc hl,bc ;сравнить
 860  8486 28 11        	jr z,get_color_item_no_cursor
 861  8488              	;цвета курсора
 862  8488 3E 0E        	ld a,color_dir ;простая
 863  848A 32 B4 84     	ld (get_color_item_dir+1),a
 864  848D 3E 0C        	ld a,color_apg ;простая
 865  848F 32 BC 84     	ld (get_color_item_apg+1),a
 866  8492 3E 0F        	ld a,color_backgr ;простая
 867  8494 32 BF 84     	ld (get_color_item_backgr+1),a
 868  8497 18 0F        	jr get_color_item_set
 869  8499
 870  8499              get_color_item_no_cursor
 871  8499              	;цвета обычные
 872  8499 3E 28        	ld a,color_dir_hi ;под курсором
 873  849B 32 B4 84     	ld (get_color_item_dir+1),a
 874  849E 3E 28        	ld a,color_apg_hi ;под курсором
 875  84A0 32 BC 84     	ld (get_color_item_apg+1),a
 876  84A3 3E 28        	ld a,color_backgr_hi ;под курсором
 877  84A5 32 BF 84     	ld (get_color_item_backgr+1),a
 878  84A8
 879  84A8              get_color_item_set
 880  84A8              	;задать цвет
 881  84A8 DD 7E 0B     	ld a,(ix+#0b)
 882  84AB FE 10        	cp #10 ;признак каталога
 883  84AD 28 04        	jr z,get_color_item_dir
 884  84AF FE 30        	cp #30 ;признак каталога
 885  84B1 20 03        	jr nz,get_color_item_no_dir
 886  84B3              	;если папка
 887  84B3              get_color_item_dir
 888  84B3 3E 00        	ld a,0
 889  84B5 C9           	ret
 890  84B6
 891  84B6              get_color_item_no_dir
 892  84B6 CD F0 82     	call check_apg ;расширение apg
 893  84B9 20 03        	jr nz,get_color_item_no_apg
 894  84BB              	;если приложение
 895  84BB              get_color_item_apg
 896  84BB 3E 00        	ld a,0
 897  84BD C9           	ret
 898  84BE
 899  84BE              get_color_item_no_apg
 900  84BE              	;если обычный файл
 901  84BE              get_color_item_backgr
 902  84BE 3E 00        	ld a,0
 903  84C0 C9           	ret
 904  84C1
 905  84C1
 906  84C1
 907  84C1              ; format_dir ;подготовить каталог, убрать лишнее
 908  84C1              	; ; ld a,2
 909  84C1              	; ; out (254),a
 910  84C1              	; ld iy,0 ;счётчик файлов
 911  84C1              	; ;найти конец каталога
 912  84C1              	; ld hl,buffer_cat
 913  84C1              	; ld a,(hl)
 914  84C1              	; or a
 915  84C1              	; ret z ;защита
 916  84C1              	; ld bc,32
 917  84C1              ; format_dir_prep_cl
 918  84C1              	; ld a,(hl)
 919  84C1              	; or a
 920  84C1              	; jr z,format_dir_prep_ex
 921  84C1              	; add hl,bc
 922  84C1              	; ld a,h
 923  84C1              	; or a ;если вышли за границу
 924  84C1              	; jr z,format_dir_prep_ex
 925  84C1              	; jr format_dir_prep_cl
 926  84C1              ; format_dir_prep_ex
 927  84C1              	; ld bc,32
 928  84C1              	; and a
 929  84C1              	; sbc hl,bc
 930  84C1              	; ld (format_dir_top),hl ;конец каталога
 931  84C1
 932  84C1
 933  84C1
 934  84C1              	; ld ix,buffer_cat
 935  84C1              	; ;ld b,panel_hight ;высота панели
 936  84C1              ; format_dir_cl ;цикл
 937  84C1              	; ld a,(ix)
 938  84C1              	; or a ;конец каталога
 939  84C1              	; jr z,format_dir_ex
 940  84C1              	; cp #e5 ;удалённый
 941  84C1              	; jr z,format_dir_skip
 942  84C1              	; cp #05 ;удалённый
 943  84C1              	; jr z,format_dir_skip
 944  84C1              	; ld a,(ix+#0b)
 945  84C1              	; cp #0f ;длинный
 946  84C1              	; jr z,format_dir_skip
 947  84C1
 948  84C1              	; ;проверка на папку "." (этот же каталог)
 949  84C1              	; ld a,(ix+#00)
 950  84C1              	; cp "." ;
 951  84C1              	; jr nz,format_dir_add
 952  84C1              	; ld a,(ix+#01)
 953  84C1              	; cp " " ;
 954  84C1              	; jr z,format_dir_skip
 955  84C1
 956  84C1
 957  84C1              ; format_dir_add
 958  84C1              	; inc iy ;++
 959  84C1              	; ld bc,32 ;на другой элемент каталога
 960  84C1              	; add ix,bc
 961  84C1              	; ld a,ixh
 962  84C1              	; or a ;если вышли за границу
 963  84C1              	; jr z,format_dir_ex
 964  84C1              	; jr format_dir_cl
 965  84C1              ; format_dir_skip
 966  84C1              	; ;сдвинуть элементы вниз
 967  84C1              	; push ix
 968  84C1              	; push ix
 969  84C1              	; pop hl
 970  84C1              	; pop de ;куда
 971  84C1              	; ld hl,(format_dir_top) ;0-32
 972  84C1              	; and a
 973  84C1              	; sbc hl,de
 974  84C1              	; ld b,h
 975  84C1              	; ld c,l ;длина
 976  84C1              	; push bc
 977  84C1
 978  84C1              	; push ix
 979  84C1              	; pop hl ;откуда
 980  84C1              	; ld bc,32 ;на другой элемент каталога
 981  84C1              	; add hl,bc ;откуда
 982  84C1
 983  84C1              	; pop bc
 984  84C1              	; ldir
 985  84C1
 986  84C1              	; xor a
 987  84C1              	; ld (de),a ;очистить ненужный элемент
 988  84C1
 989  84C1              	; jr format_dir_cl
 990  84C1
 991  84C1              ; format_dir_ex
 992  84C1              	; ld (file_r_all),iy
 993  84C1              	; ;здесь почистить остаток каталога
 994  84C1              	; ; ld a,0
 995  84C1              	; ; out (254),a
 996  84C1              	; ret
 997  84C1              ; format_dir_top	dw 0 ;временно конец гаталога
 998  84C1
 999  84C1
1000  84C1
1001  84C1
1002  84C1
1003  84C1              sort_dir ;сортировка каталога с помощью построения индекса
1004  84C1 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1005  84C5 DD 7E 00     	ld a,(ix)
1006  84C8 B7           	or a
1007  84C9 C8           	ret z ;если пусто, выход
1008  84CA FD 21 00 00  	ld iy,0 ;счётчик всего файлов
1009  84CE
1010  84CE
1011  84CE 3A 73 86     	ld a,(sort_enable_flag)
1012  84D1 B7           	or a
1013  84D2 CA 39 85     	jp z,sort_dir_no ;если без сортировки
1014  84D5
1015  84D5 21 80 9F     	ld hl,cat_index
1016  84D8 22 35 85     	ld (sort_item_adr_end),hl
1017  84DB
1018  84DB 21 80 A3     	ld hl,cat_index_2 ;таблица - индекс 2
1019  84DE CD B8 85     	call sort_dir_one ;проход по папкам
1020  84E1
1021  84E1 FD 7C        	ld a,iyh
1022  84E3 FD B5        	or iyl
1023  84E5 28 19        	jr z,sort_dir_skip ;если не было папок
1024  84E7
1025  84E7 DD 21 80 A3  	ld ix,cat_index_2
1026  84EB CD 02 86     	call sort_index ;отсортировать по алфавиту
1027  84EE              	;перенести индекс в основной
1028  84EE FD E5        	push iy
1029  84F0 E1           	pop hl ;сколько
1030  84F1 29           	add hl,hl ;*2 по 2 байта на элемент
1031  84F2 E5           	push hl
1032  84F3 C1           	pop bc
1033  84F4 21 80 A3     	ld hl,cat_index_2
1034  84F7 11 80 9F     	ld de,cat_index
1035  84FA ED B0        	ldir
1036  84FC ED 53 35 85  	ld (sort_item_adr_end),de ;запомнить адрес последнего
1037  8500
1038  8500              sort_dir_skip
1039  8500 FD 22 37 85  	ld (sort_item_count),iy
1040  8504 FD 21 00 00  	ld iy,0 ;счётчик всего файлов
1041  8508 21 80 A3     	ld hl,cat_index_2 ;таблица - индекс 2
1042  850B CD 7C 85     	call sort_file_one ;проход по файлам
1043  850E FD 7C        	ld a,iyh
1044  8510 FD B5        	or iyl
1045  8512 28 16        	jr z,sort_file_skip ;если не было файлов
1046  8514
1047  8514 DD 21 80 A3  	ld ix,cat_index_2
1048  8518 CD 02 86     	call sort_index ;отсортировать по алфавиту
1049  851B              	;добавить индекс к основному
1050  851B FD E5        	push iy
1051  851D E1           	pop hl ;сколько
1052  851E 29           	add hl,hl ;*2 по 2 байта на элемент
1053  851F E5           	push hl
1054  8520 C1           	pop bc
1055  8521 21 80 A3     	ld hl,cat_index_2
1056  8524 ED 5B 35 85  	ld de,(sort_item_adr_end)
1057  8528 ED B0        	ldir
1058  852A
1059  852A              sort_file_skip
1060  852A              	;скорректировать количество
1061  852A ED 4B 37 85  	ld bc,(sort_item_count)
1062  852E FD 09        	add iy,bc
1063  8530 FD 22 46 9C  	ld (file_r_all),iy
1064  8534 C9           	ret
1065  8535
1066  8535 00 00        sort_item_adr_end dw 0; временно
1067  8537 00 00        sort_item_count dw 0; временно
1068  8539
1069  8539
1070  8539
1071  8539              ;без сортировки
1072  8539              sort_dir_no
1073  8539 21 80 9F     	ld hl,cat_index ;таблица - индекс
1074  853C DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1075  8540              sort_dir_no_cl ;цикл по каталогам
1076  8540 DD 7E 00     	ld a,(ix)
1077  8543 B7           	or a ;конец каталога
1078  8544 28 31        	jr z,sort_dir_no_ex
1079  8546 FE E5        	cp #e5 ;удалённый
1080  8548 28 22        	jr z,sort_dir_no_skip
1081  854A FE 05        	cp #05 ;удалённый
1082  854C 28 1E        	jr z,sort_dir_no_skip
1083  854E DD 7E 0B     	ld a,(ix+#0b)
1084  8551 FE 0F        	cp #0f ;длинный
1085  8553 28 17        	jr z,sort_dir_no_skip
1086  8555
1087  8555              	;проверка на папку "." (этот же каталог)
1088  8555 DD 7E 00     	ld a,(ix+#00)
1089  8558 FE 2E        	cp "." ;
1090  855A 20 07        	jr nz,sort_dir_no_add
1091  855C DD 7E 01     	ld a,(ix+#01)
1092  855F FE 20        	cp " " ;
1093  8561 28 09        	jr z,sort_dir_no_skip
1094  8563
1095  8563              sort_dir_no_add
1096  8563 FD 23        	inc iy ;++
1097  8565              	;записать в таблицу (индекс)
1098  8565 DD E5        	push ix
1099  8567 C1           	pop bc
1100  8568 71           	ld (hl),c
1101  8569 23           	inc hl
1102  856A 70           	ld (hl),b
1103  856B 23           	inc hl
1104  856C
1105  856C
1106  856C              sort_dir_no_skip
1107  856C 01 20 00     	ld bc,32
1108  856F DD 09        	add ix,bc ;на следующий
1109  8571 DD 7C        	ld a,ixh ;проверка на конец буфера
1110  8573 FE C0        	cp #c0
1111  8575 30 C9        	jr nc,sort_dir_no_cl
1112  8577
1113  8577              sort_dir_no_ex
1114  8577 FD 22 46 9C  	ld (file_r_all),iy
1115  857B C9           	ret
1116  857C
1117  857C
1118  857C              ;сортировка файлов
1119  857C              sort_file_one
1120  857C DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1121  8580              sort_file_one_cl ;цикл по каталогам
1122  8580 DD 7E 00     	ld a,(ix)
1123  8583 B7           	or a ;конец каталога
1124  8584 28 31        	jr z,sort_file_one_ex
1125  8586 DD 7E 0B     	ld a,(ix+#0b)
1126  8589 FE 10        	cp #10 ;признак каталога
1127  858B 28 1F        	jr z,sort_file_one_skip
1128  858D FE 30        	cp #30 ;признак каталога
1129  858F 28 1B        	jr z,sort_file_one_skip
1130  8591 DD 7E 00     	ld a,(ix)
1131  8594 FE E5        	cp #e5 ;удалённый
1132  8596 28 14        	jr z,sort_file_one_skip
1133  8598 FE 05        	cp #05 ;удалённый
1134  859A 28 10        	jr z,sort_file_one_skip
1135  859C DD 7E 0B     	ld a,(ix+#0b)
1136  859F FE 0F        	cp #0f ;длинный
1137  85A1 28 09        	jr z,sort_file_one_skip
1138  85A3
1139  85A3              	; ;проверка на папку "." (этот же каталог)
1140  85A3              	; ld a,(ix+#00)
1141  85A3              	; cp "." ;
1142  85A3              	; jr nz,sort_file_one_add
1143  85A3              	; ld a,(ix+#01)
1144  85A3              	; cp " " ;
1145  85A3              	; jr z,sort_file_one_skip
1146  85A3
1147  85A3
1148  85A3              sort_file_one_add
1149  85A3 FD 23        	inc iy ;++
1150  85A5              	;записать в таблицу (индекс)
1151  85A5 DD E5        	push ix
1152  85A7 C1           	pop bc
1153  85A8 71           	ld (hl),c
1154  85A9 23           	inc hl
1155  85AA 70           	ld (hl),b
1156  85AB 23           	inc hl
1157  85AC
1158  85AC
1159  85AC              sort_file_one_skip
1160  85AC 01 20 00     	ld bc,32
1161  85AF DD 09        	add ix,bc ;на следующий
1162  85B1 DD 7C        	ld a,ixh ;проверка на конец буфера
1163  85B3 FE C0        	cp #c0
1164  85B5 30 C9        	jr nc,sort_file_one_cl
1165  85B7
1166  85B7              sort_file_one_ex
1167  85B7              	;ld (file_r_all),iy
1168  85B7 C9           	ret
1169  85B8
1170  85B8
1171  85B8
1172  85B8
1173  85B8
1174  85B8              ;сортировка папок
1175  85B8              sort_dir_one
1176  85B8 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1177  85BC              sort_dir_one_cl ;цикл по каталогам
1178  85BC DD 7E 00     	ld a,(ix)
1179  85BF B7           	or a ;конец каталога
1180  85C0 28 3F        	jr z,sort_dir_one_ex
1181  85C2 DD 7E 0B     	ld a,(ix+#0b)
1182  85C5 FE 10        	cp #10 ;признак каталога
1183  85C7 28 04        	jr z,sort_dir_one_skip_no
1184  85C9 FE 30        	cp #30 ;признак каталога
1185  85CB 20 29        	jr nz,sort_dir_one_skip
1186  85CD              sort_dir_one_skip_no
1187  85CD DD 7E 00     	ld a,(ix)
1188  85D0 FE E5        	cp #e5 ;удалённый
1189  85D2 28 22        	jr z,sort_dir_one_skip
1190  85D4 FE 05        	cp #05 ;удалённый
1191  85D6 28 1E        	jr z,sort_dir_one_skip
1192  85D8 DD 7E 0B     	ld a,(ix+#0b)
1193  85DB FE 0F        	cp #0f ;длинный
1194  85DD 28 17        	jr z,sort_dir_one_skip
1195  85DF
1196  85DF              	;проверка на папку "." (этот же каталог)
1197  85DF DD 7E 00     	ld a,(ix+#00)
1198  85E2 FE 2E        	cp "." ;
1199  85E4 20 07        	jr nz,sort_dir_one_add
1200  85E6 DD 7E 01     	ld a,(ix+#01)
1201  85E9 FE 20        	cp " " ;
1202  85EB 28 09        	jr z,sort_dir_one_skip
1203  85ED
1204  85ED              sort_dir_one_add
1205  85ED FD 23        	inc iy ;++
1206  85EF              	;записать в таблицу (индекс)
1207  85EF DD E5        	push ix
1208  85F1 C1           	pop bc
1209  85F2 71           	ld (hl),c
1210  85F3 23           	inc hl
1211  85F4 70           	ld (hl),b
1212  85F5 23           	inc hl
1213  85F6
1214  85F6
1215  85F6              sort_dir_one_skip
1216  85F6 01 20 00     	ld bc,32
1217  85F9 DD 09        	add ix,bc ;на следующий
1218  85FB DD 7C        	ld a,ixh ;проверка на конец буфера
1219  85FD FE C0        	cp #c0
1220  85FF 30 BB        	jr nc,sort_dir_one_cl
1221  8601
1222  8601              sort_dir_one_ex
1223  8601              	;ld (file_r_all),iy
1224  8601 C9           	ret
1225  8602
1226  8602
1227  8602
1228  8602              ;сортировка индекса методом пузырька
1229  8602              ;вх: iy - сколько (>1)
1230  8602              ;вх: ix - адрес таблицы
1231  8602              sort_index
1232  8602 FD 7C        	ld a,iyh ;проверка, число элементов должно быть > 1
1233  8604 B7           	or a
1234  8605 20 05        	jr nz,sort_index1
1235  8607 FD 7D        	ld a,iyl
1236  8609 FE 02        	cp 2
1237  860B D8           	ret c
1238  860C              sort_index1
1239  860C FD E5        	push iy
1240  860E C1           	pop bc ;цикл проходов общий
1241  860F 0B           	dec bc ;-1
1242  8610
1243  8610              sort_index_cl_gen ;цикл основной
1244  8610 C5           	push bc
1245  8611 DD E5        	push ix
1246  8613
1247  8613 FD E5        	push iy
1248  8615 C1           	pop bc ;внутренний цикл столько же
1249  8616 0B           	dec bc ;-1
1250  8617
1251  8617 AF           	xor a ;флаг
1252  8618 32 53 86     	ld (sort_index_flag),a
1253  861B
1254  861B              sort_index_cl ;цикл внутренний
1255  861B              	;первый элемент узнать адрес записи в каталоге
1256  861B DD 5E 00     	ld e,(ix+00)
1257  861E DD 56 01     	ld d,(ix+01)
1258  8621 1A           	ld a,(de) ;первая буква имени
1259  8622              	;второй элемент узнать адрес записи в каталоге
1260  8622 DD 6E 02     	ld l,(ix+02)
1261  8625 DD 66 03     	ld h,(ix+03)
1262  8628              	;сравнить с другой первой буквой
1263  8628 BE           	cp (hl)
1264  8629 38 11        	jr c,sort_index_cl_skip
1265  862B
1266  862B 3E 01        	ld a,1
1267  862D 32 53 86     	ld (sort_index_flag),a ;флаг были изменения
1268  8630              	;поменять местами элементы индекса
1269  8630 DD 75 00     	ld (ix+00),l
1270  8633 DD 74 01     	ld (ix+01),h
1271  8636 DD 73 02     	ld (ix+02),e
1272  8639 DD 72 03     	ld (ix+03),d
1273  863C
1274  863C              sort_index_cl_skip
1275  863C              	;следующий
1276  863C DD 23        	inc ix
1277  863E DD 23        	inc ix
1278  8640
1279  8640 0B           	dec bc
1280  8641 78           	ld a,b
1281  8642 B1           	or c
1282  8643 20 D6        	jr nz,sort_index_cl
1283  8645
1284  8645 DD E1        	pop ix
1285  8647 C1           	pop bc
1286  8648 0B           	dec bc
1287  8649
1288  8649 3A 53 86     	ld a,(sort_index_flag)
1289  864C B7           	or a
1290  864D C8           	ret z ;если не было изменений за проход, можно выходить
1291  864E
1292  864E 78           	ld a,b
1293  864F B1           	or c
1294  8650 20 BE        	jr nz,sort_index_cl_gen
1295  8652
1296  8652 C9           	ret
1297  8653
1298  8653 00           sort_index_flag db 0;
1299  8654
1300  8654
1301  8654              sort_toggle ;переключение сортировки
1302  8654 3A 73 86     	ld a,(sort_enable_flag)
1303  8657 EE 01        	xor 1
1304  8659 32 73 86     	ld (sort_enable_flag),a
1305  865C 3E 66        	ld a,"f" ;вкл
1306  865E 20 02        	jr nz,sort_toggle1
1307  8660 3E 4E        	ld a,"N";выкл
1308  8662              sort_toggle1
1309  8662 32 18 9F     	ld (msg_menu_main2+5),a
1310  8665
1311  8665 CD C1 84     	call sort_dir
1312  8668 CD FB 86     	call print_menu_main
1313  866B 3E 01        	ld a,1
1314  866D 32 60 9E     	ld (print_panel_r_flag),a
1315  8670
1316  8670 C3 7B 80     	jp nc_wait
1317  8673 00           sort_enable_flag db 0 ;флаг сортировки
1318  8674
1319  8674
1320  8674
1321  8674
1322  8674              LFN_toggle ;переключение сортировки
1323  8674 3A 90 86     	ld a,(LFN_enable_flag)
1324  8677 EE 01        	xor 1
1325  8679 32 90 86     	ld (LFN_enable_flag),a
1326  867C 3E 66        	ld a,"f" ;вкл
1327  867E 20 02        	jr nz,LFN_toggle1
1328  8680 3E 4E        	ld a,"N";выкл
1329  8682              LFN_toggle1
1330  8682 32 11 9F     	ld (msg_menu_main1+5),a
1331  8685
1332  8685              	;call sort_dir
1333  8685 CD FB 86     	call print_menu_main
1334  8688 3E 01        	ld a,1
1335  868A 32 60 9E     	ld (print_panel_r_flag),a
1336  868D
1337  868D C3 7B 80     	jp nc_wait
1338  8690 00           LFN_enable_flag db 0 ;флаг сортировки
1339  8691
1340  8691
1341  8691
1342  8691
1343  8691
1344  8691              format_name ;подогнать имя под стандарт filename.ext
1345  8691              ;вх: HL - имя в каталоге
1346  8691 E5           	push hl
1347  8692 21 4A 9C     	ld hl,file_name_cur
1348  8695 11 4B 9C     	ld de,file_name_cur+1 ;почистить
1349  8698 01 FF 00     	ld bc,256-1
1350  869B 36 00        	ld (hl),0
1351  869D ED B0        	ldir
1352  869F
1353  869F E1           	pop hl
1354  86A0 E5           	push hl
1355  86A1
1356  86A1 11 4A 9C     	ld de,file_name_cur ;куда
1357  86A4 01 FF 08     	ld bc,#08ff
1358  86A7              format_name_cl
1359  86A7 7E           	ld a,(hl)
1360  86A8 FE 21        	cp " "+1
1361  86AA 38 04        	jr c,format_name_skip
1362  86AC ED A0        	ldi
1363  86AE 10 F7        	djnz format_name_cl
1364  86B0              format_name_skip
1365  86B0 3E 2E        	ld a,"."
1366  86B2 12           	ld (de),a
1367  86B3
1368  86B3 13           	inc de
1369  86B4 E1           	pop hl
1370  86B5 01 08 00     	ld bc,8 ;перейти на расширение
1371  86B8 09           	add hl,bc
1372  86B9
1373  86B9 01 FF 03     	ld bc,#03ff
1374  86BC              format_name_cl2
1375  86BC 7E           	ld a,(hl)
1376  86BD FE 21        	cp " "+1
1377  86BF 38 04        	jr c,format_name_skip2
1378  86C1 ED A0        	ldi
1379  86C3 10 F7        	djnz format_name_cl2
1380  86C5              format_name_skip2
1381  86C5 C9           	ret
1382  86C6
1383  86C6              print_rect_r ;печать рамки правой
1384  86C6 3E 0F        	ld a,color_backgr ;цвет
1385  86C8 06 0C        	ld b,#c
1386  86CA              	OS_SET_COLOR
1386  86CA 0E 06       >    ld c,#06
1386  86CC E7          >    rst #20
1387  86CD 11 28 00     	ld de,#0028 ;xy
1388  86D0              	OS_SET_XY
1388  86D0 0E 01       >    ld c,#01
1388  86D2 E7          >    rst #20
1389  86D3 21 7C 9E     	ld hl,rect_1
1390  86D6              	OS_PRINTZ
1390  86D6 0E 09       >    ld c,#09
1390  86D8 E7          >    rst #20
1391  86D9
1392  86D9 11 28 01     	ld de,#0128 ;xy
1393  86DC 06 16        	ld b,24-2 ;цикл
1394  86DE              print_rect_r_cl
1395  86DE C5           	push bc
1396  86DF D5           	push de
1397  86E0              	OS_SET_XY
1397  86E0 0E 01       >    ld c,#01
1397  86E2 E7          >    rst #20
1398  86E3 21 A5 9E     	ld hl,rect_2
1399  86E6              	OS_PRINTZ
1399  86E6 0E 09       >    ld c,#09
1399  86E8 E7          >    rst #20
1400  86E9 D1           	pop de
1401  86EA 14           	inc d
1402  86EB C1           	pop bc
1403  86EC 10 F0        	djnz print_rect_r_cl
1404  86EE
1405  86EE
1406  86EE 11 28 17     	ld de,#1728 ;xy
1407  86F1              	OS_SET_XY
1407  86F1 0E 01       >    ld c,#01
1407  86F3 E7          >    rst #20
1408  86F4 21 CE 9E     	ld hl,rect_3
1409  86F7              	OS_PRINTZ
1409  86F7 0E 09       >    ld c,#09
1409  86F9 E7          >    rst #20
1410  86FA C9           	ret
1411  86FB
1412  86FB              print_menu_main ;печать основного меню
1413  86FB 3E 07        	ld a,color_default ;цвет
1414  86FD 06 0C        	ld b,#c
1415  86FF              	OS_SET_COLOR
1415  86FF 0E 06       >    ld c,#06
1415  8701 E7          >    rst #20
1416  8702
1417  8702 11 00 18     	ld de,#1800+0*8
1418  8705              	OS_SET_XY
1418  8705 0E 01       >    ld c,#01
1418  8707 E7          >    rst #20
1419  8708 3E 31        	ld a,"1" ;пункт 1
1420  870A              	OS_PRINT_CHARF
1420  870A D7          >	rst #10
1421  870B 11 08 18     	ld de,#1800+1*8
1422  870E              	OS_SET_XY
1422  870E 0E 01       >    ld c,#01
1422  8710 E7          >    rst #20
1423  8711 3E 32        	ld a,"2" ;пункт 2
1424  8713              	OS_PRINT_CHARF
1424  8713 D7          >	rst #10
1425  8714 11 10 18     	ld de,#1800+2*8
1426  8717              	OS_SET_XY
1426  8717 0E 01       >    ld c,#01
1426  8719 E7          >    rst #20
1427  871A 3E 33        	ld a,"3" ;пункт 3
1428  871C              	OS_PRINT_CHARF
1428  871C D7          >	rst #10
1429  871D
1430  871D
1431  871D 3E 28        	ld a,color_backgr_hi ;цвет
1432  871F 06 0C        	ld b,#c
1433  8721              	OS_SET_COLOR
1433  8721 0E 06       >    ld c,#06
1433  8723 E7          >    rst #20
1434  8724
1435  8724 11 01 18     	ld de,#1800+0*8+1
1436  8727              	OS_SET_XY
1436  8727 0E 01       >    ld c,#01
1436  8729 E7          >    rst #20
1437  872A 21 0C 9F     	ld hl,msg_menu_main1
1438  872D              	OS_PRINTZ
1438  872D 0E 09       >    ld c,#09
1438  872F E7          >    rst #20
1439  8730 11 09 18     	ld de,#1800+1*8+1
1440  8733              	OS_SET_XY
1440  8733 0E 01       >    ld c,#01
1440  8735 E7          >    rst #20
1441  8736 21 13 9F     	ld hl,msg_menu_main2
1442  8739              	OS_PRINTZ
1442  8739 0E 09       >    ld c,#09
1442  873B E7          >    rst #20
1443  873C 11 11 18     	ld de,#1800+2*8+1
1444  873F              	OS_SET_XY
1444  873F 0E 01       >    ld c,#01
1444  8741 E7          >    rst #20
1445  8742 21 1A 9F     	ld hl,msg_menu_main3
1446  8745              	OS_PRINTZ
1446  8745 0E 09       >    ld c,#09
1446  8747 E7          >    rst #20
1447  8748 C9           	ret
1448  8749
1449  8749
1450  8749              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 8749              view_file
   2+ 8749              	;просмотр файла как текста
   3+ 8749
   4+ 8749 2A 46 9C     	ld hl,(file_r_all)
   5+ 874C 7D           	ld a,l
   6+ 874D B4           	or h
   7+ 874E CA 2A 88     	jp z,view_file_ex ;защита
   8+ 8751 2A 58 9E     	ld hl,(file_r_num_cur)
   9+ 8754 CD 4B 82     	call calc_deskr
  10+ 8757 DD 7E 0B     	ld a,(ix+#0b)
  11+ 875A FE 10        	cp #10 ;признак каталога
  12+ 875C CA 2A 88     	jp z,view_file_ex
  13+ 875F
  14+ 875F CD 91 86     	call format_name ;обработать имя файла
  15+ 8762
  16+ 8762
  17+ 8762
  18+ 8762              	OS_CLS ;почистить экран
  18+ 8762 0E 00       >    ld c,#00
  18+ 8764 E7          >    rst #20
  19+ 8765
  20+ 8765              	;обнулить переменные
  21+ 8765 AF           	xor a
  22+ 8766 32 4F 8A     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  23+ 8769              	;ld (view_file_bot_flag),a  ;
  24+ 8769 21 FF FF     	ld hl,#ffff
  25+ 876C 22 50 8A     	ld (view_file_end),hl ;конец файла тут
  26+ 876F 23           	inc hl
  27+ 8770 22 47 8A     	ld (view_move_right_val),hl
  28+ 8773
  29+ 8773 C5           	push bc
  30+ 8774 CD D2 80     	call clear_buf
  31+ 8777 C1           	pop bc
  32+ 8778
  33+ 8778 3E FF        	ld a,255
  34+ 877A 32 5B 9E     	ld (file_id_cur_r),a
  35+ 877D 21 4A 9C     	ld hl,file_name_cur		;строка с именем
  36+ 8780              	OS_FILE_OPEN
  36+ 8780 0E 21       >    ld c,#21
  36+ 8782 E7          >    rst #20
  37+ 8783 30 0E        	jr nc,view_file_open_ok
  38+ 8785              view_file_file_error
  39+ 8785 21 20 9F     	ld hl,msg_file_error
  40+ 8788              	OS_PRINTZ
  40+ 8788 0E 09       >    ld c,#09
  40+ 878A E7          >    rst #20
  41+ 878B 06 64        	ld b,2*50
  42+ 878D CD CE 80     	call delay1
  43+ 8790 C3 1A 88     	jp view_file_wait_ex
  44+ 8793
  45+ 8793              view_file_open_ok
  46+ 8793 32 5B 9E     	ld (file_id_cur_r),a
  47+ 8796              	;проверка длины файла не больше #4000
  48+ 8796 7A           	ld	a,d ;самые старшие байты длины
  49+ 8797 B3           	or e
  50+ 8798 28 11        	jr z,view_file_size_ok ;если не слищком большой
  51+ 879A              view_file_too_big
  52+ 879A              	;файл больше буфера
  53+ 879A 11 00 40     	ld de,#4000 ;размер одной первой части
  54+ 879D 21 00 C0     	ld hl,buffer_cat
  55+ 87A0 3A 5B 9E     	ld a,(file_id_cur_r)
  56+ 87A3              	OS_FILE_READ ;загрузить
  56+ 87A3 0E 23       >    ld c,#23
  56+ 87A5 E7          >    rst #20
  57+ 87A6 38 DD        	jr c,view_file_file_error
  58+ 87A8
  59+ 87A8 C3 D4 87     	jp view_file_readed
  60+ 87AB
  61+ 87AB              view_file_size_ok
  62+ 87AB 7C           	ld	a,h ;младший старший байт длины
  63+ 87AC FE 40        	cp #40
  64+ 87AE 38 06        	jr c,view_file_size_ok_small
  65+ 87B0 20 E8        	jr nz,view_file_too_big
  66+ 87B2 2C           	inc l
  67+ 87B3 2D           	dec l
  68+ 87B4 20 E4        	jr nz,view_file_too_big
  69+ 87B6
  70+ 87B6
  71+ 87B6              view_file_size_ok_small
  72+ 87B6              	;проверка на 0
  73+ 87B6 7C           	ld a,h
  74+ 87B7 B5           	or l
  75+ 87B8 CA 85 87     	jp z,view_file_file_error
  76+ 87BB 54           	ld d,h ;размер
  77+ 87BC 5D           	ld e,l
  78+ 87BD              	;узнать где конец файла
  79+ 87BD 01 00 C0     	ld bc,buffer_cat
  80+ 87C0 09           	add hl,bc
  81+ 87C1 22 50 8A     	ld (view_file_end),hl ;конец файла тут
  82+ 87C4              	;размер не большой, прочитаем
  83+ 87C4 21 00 C0     	ld hl,buffer_cat
  84+ 87C7 3A 5B 9E     	ld a,(file_id_cur_r)
  85+ 87CA              	OS_FILE_READ ;загрузить
  85+ 87CA 0E 23       >    ld c,#23
  85+ 87CC E7          >    rst #20
  86+ 87CD 38 B6        	jr c,view_file_file_error
  87+ 87CF
  88+ 87CF 3E 01        	ld a,1
  89+ 87D1 32 4F 8A     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  90+ 87D4
  91+ 87D4              view_file_readed
  92+ 87D4              	;файл прочитан
  93+ 87D4
  94+ 87D4 21 00 C0     	ld hl,buffer_cat
  95+ 87D7 22 49 8A     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  96+ 87DA 22 4B 8A     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  97+ 87DD
  98+ 87DD CD F3 88     	call print_file_text
  99+ 87E0
 100+ 87E0
 101+ 87E0 CD BE 88     	call print_menu_view ;меню
 102+ 87E3 CD D9 88     	call print_menu_view_top ;инфо
 103+ 87E6
 104+ 87E6 CD 2A 81     	call release_key
 105+ 87E9
 106+ 87E9              view_file_wait ;цикл ожидания клавиши
 107+ 87E9              	OS_WAIT
 107+ 87E9 DF          >	rst #18
 108+ 87EA              	OS_GET_CHAR
 108+ 87EA 0E 10       >    ld c,#10
 108+ 87EC E7          >    rst #20
 109+ 87ED FE FF        	cp 255
 110+ 87EF 28 F8        	jr z,view_file_wait
 111+ 87F1 FE 33        	cp "3"
 112+ 87F3 28 25        	jr z,view_file_wait_ex
 113+ 87F5 FE 0A        	cp 10 ;вниз
 114+ 87F7 CA 37 88     	jp z,view_line_down
 115+ 87FA FE 0B        	cp 11 ;вверх
 116+ 87FC CA 4D 88     	jp z,view_line_up
 117+ 87FF FE 09        	cp 09 ;вправо
 118+ 8801 CA 61 88     	jp z,view_right
 119+ 8804 FE 08        	cp 08 ;влево
 120+ 8806 CA 72 88     	jp z,view_left
 121+ 8809 FE 04        	cp 04 ;страница вверх
 122+ 880B CA 84 88     	jp z,view_page_up
 123+ 880E FE 05        	cp 05 ;страница вниз
 124+ 8810 CA A1 88     	jp z,view_page_down
 125+ 8813 FE 18        	cp 24 ;break
 126+ 8815 CA EC 82     	jp z,exit
 127+ 8818 18 CF        	jr view_file_wait
 128+ 881A
 129+ 881A              view_file_wait_ex
 130+ 881A 3A 5B 9E     	ld a,(file_id_cur_r)
 131+ 881D FE FF        	cp 255
 132+ 881F 28 03        	jr z,view_file_wait_ex1
 133+ 8821              	OS_FILE_CLOSE ;A - id file
 133+ 8821 0E 25       >    ld c,#25
 133+ 8823 E7          >    rst #20
 134+ 8824              view_file_wait_ex1
 135+ 8824              	;почистить экран
 136+ 8824              	OS_CLS
 136+ 8824 0E 00       >    ld c,#00
 136+ 8826 E7          >    rst #20
 137+ 8827 C3 42 80     	jp start_nc_warm ;перезагрузить папку
 138+ 882A
 139+ 882A              view_file_ex
 140+ 882A 3A 5B 9E     	ld a,(file_id_cur_r)
 141+ 882D FE FF        	cp 255
 142+ 882F 28 03        	jr z,view_file_ex1
 143+ 8831              	OS_FILE_CLOSE ;A - id file
 143+ 8831 0E 25       >    ld c,#25
 143+ 8833 E7          >    rst #20
 144+ 8834              view_file_ex1
 145+ 8834 C3 7B 80     	jp nc_wait
 146+ 8837
 147+ 8837
 148+ 8837
 149+ 8837              view_line_down ;вниз на строчку
 150+ 8837 2A 4B 8A     	ld hl,(view_file_pos_cur_focus) ;фокус
 151+ 883A 22 49 8A     	ld (view_file_pos_cur),hl
 152+ 883D CD 1A 8A     	call next_line ;вперёд на строку
 153+ 8840 38 A7        	jr c,view_file_wait ;если не удачно
 154+ 8842 2A 49 8A     	ld hl,(view_file_pos_cur) ;запомнить фокус
 155+ 8845 22 4B 8A     	ld (view_file_pos_cur_focus),hl
 156+ 8848 CD F3 88     	call print_file_text ;напечатать всю страницу
 157+ 884B 18 9C        	jr view_file_wait
 158+ 884D
 159+ 884D              view_line_up ;вверх на строчку
 160+ 884D 2A 4B 8A     	ld hl,(view_file_pos_cur_focus) ;фокус
 161+ 8850 22 49 8A     	ld (view_file_pos_cur),hl
 162+ 8853 CD 28 8A     	call prev_line ;
 163+ 8856              	;jr c,view_file_wait ;если не удачно
 164+ 8856 2A 49 8A     	ld hl,(view_file_pos_cur) ;запомнить фокус
 165+ 8859 22 4B 8A     	ld (view_file_pos_cur_focus),hl
 166+ 885C CD F3 88     	call print_file_text ;напечатать всю страницу
 167+ 885F 18 88        	jr view_file_wait
 168+ 8861
 169+ 8861
 170+ 8861              view_right ;вправо
 171+ 8861 2A 47 8A     	ld hl,(view_move_right_val)
 172+ 8864 23           	inc hl
 173+ 8865 7C           	ld a,h
 174+ 8866 B5           	or l
 175+ 8867 28 80        	jr z,view_file_wait
 176+ 8869 22 47 8A     	ld (view_move_right_val),hl
 177+ 886C CD F3 88     	call print_file_text ;напечатать всю страницу
 178+ 886F C3 E9 87     	jp view_file_wait
 179+ 8872
 180+ 8872              view_left ;влево
 181+ 8872 2A 47 8A     	ld hl,(view_move_right_val)
 182+ 8875 7C           	ld a,h
 183+ 8876 B5           	or l
 184+ 8877 CA E9 87     	jp z,view_file_wait
 185+ 887A 2B           	dec hl
 186+ 887B 22 47 8A     	ld (view_move_right_val),hl
 187+ 887E CD F3 88     	call print_file_text ;напечатать всю страницу
 188+ 8881 C3 E9 87     	jp view_file_wait
 189+ 8884
 190+ 8884
 191+ 8884
 192+ 8884              view_page_up ;на страницу назад
 193+ 8884 2A 4B 8A     	ld hl,(view_file_pos_cur_focus) ;фокус
 194+ 8887 22 49 8A     	ld (view_file_pos_cur),hl
 195+ 888A 06 16        	ld b,view_text_bot-2
 196+ 888C              view_page_up_cl
 197+ 888C CD 28 8A     	call prev_line ;
 198+ 888F 38 04        	jr c,view_page_up_ex ;если не удачно
 199+ 8891 28 02        	jr z,view_page_up_ex
 200+ 8893 10 F7        	djnz view_page_up_cl
 201+ 8895              view_page_up_ex
 202+ 8895 2A 49 8A     	ld hl,(view_file_pos_cur) ;запомнить фокус
 203+ 8898 22 4B 8A     	ld (view_file_pos_cur_focus),hl
 204+ 889B CD F3 88     	call print_file_text ;напечатать всю страницу
 205+ 889E C3 E9 87     	jp view_file_wait
 206+ 88A1
 207+ 88A1
 208+ 88A1
 209+ 88A1              view_page_down ;на страницу вперёд
 210+ 88A1 2A 4B 8A     	ld hl,(view_file_pos_cur_focus) ;фокус
 211+ 88A4 22 49 8A     	ld (view_file_pos_cur),hl
 212+ 88A7 06 16        	ld b,view_text_bot-2
 213+ 88A9              view_page_down_cl
 214+ 88A9 CD 1A 8A     	call next_line ;
 215+ 88AC 38 04        	jr c,view_page_down_ex ;если не удачно
 216+ 88AE 28 02        	jr z,view_page_down_ex
 217+ 88B0 10 F7        	djnz view_page_down_cl
 218+ 88B2              view_page_down_ex
 219+ 88B2 2A 49 8A     	ld hl,(view_file_pos_cur) ;запомнить фокус
 220+ 88B5 22 4B 8A     	ld (view_file_pos_cur_focus),hl
 221+ 88B8 CD F3 88     	call print_file_text ;напечатать всю страницу
 222+ 88BB C3 E9 87     	jp view_file_wait
 223+ 88BE
 224+ 88BE
 225+ 88BE
 226+ 88BE              print_menu_view ;печать меню просмотрщика
 227+ 88BE 3E 18        	ld a,#18
 228+ 88C0 06 28        	ld b,color_backgr_hi ;цвет
 229+ 88C2              	OS_PAINT_LINE ;линия внизу
 229+ 88C2 0E 04       >    ld c,#04
 229+ 88C4 E7          >    rst #20
 230+ 88C5 3E 28        	ld a,color_backgr_hi ;цвет
 231+ 88C7 06 0C        	ld b,#c
 232+ 88C9              	OS_SET_COLOR
 232+ 88C9 0E 06       >    ld c,#06
 232+ 88CB E7          >    rst #20
 233+ 88CC 11 10 18     	ld de,#1800+2*8
 234+ 88CF              	OS_SET_XY
 234+ 88CF 0E 01       >    ld c,#01
 234+ 88D1 E7          >    rst #20
 235+ 88D2 21 40 8A     	ld hl,msg_menu_view
 236+ 88D5              	OS_PRINTZ
 236+ 88D5 0E 09       >    ld c,#09
 236+ 88D7 E7          >    rst #20
 237+ 88D8 C9           	ret
 238+ 88D9
 239+ 88D9              print_menu_view_top ;печать меню просмотрщика верхнее
 240+ 88D9 AF           	xor a
 241+ 88DA 06 28        	ld b,color_backgr_hi ;цвет
 242+ 88DC              	OS_PAINT_LINE ;линия вверху
 242+ 88DC 0E 04       >    ld c,#04
 242+ 88DE E7          >    rst #20
 243+ 88DF 3E 28        	ld a,color_backgr_hi ;цвет
 244+ 88E1 06 0C        	ld b,#c
 245+ 88E3              	OS_SET_COLOR
 245+ 88E3 0E 06       >    ld c,#06
 245+ 88E5 E7          >    rst #20
 246+ 88E6 11 24 00     	ld de,#0024
 247+ 88E9              	OS_SET_XY
 247+ 88E9 0E 01       >    ld c,#01
 247+ 88EB E7          >    rst #20
 248+ 88EC 21 4A 9C     	ld hl,file_name_cur
 249+ 88EF              	OS_PRINTZ
 249+ 88EF 0E 09       >    ld c,#09
 249+ 88F1 E7          >    rst #20
 250+ 88F2 C9           	ret
 251+ 88F3
 252+ 88F3
 253+ 88F3
 254+ 88F3              print_file_text	;печать текущей части файла в консоль
 255+ 88F3 3E 04        	ld a,color_view_text ;цвет
 256+ 88F5 06 0C        	ld b,#c
 257+ 88F7              	OS_SET_COLOR
 257+ 88F7 0E 06       >    ld c,#06
 257+ 88F9 E7          >    rst #20
 258+ 88FA
 259+ 88FA 3E 01        	ld a,view_text_top ;первая строка
 260+ 88FC 32 4D 8A     	ld (view_file_y_cur),a
 261+ 88FF 2A 4B 8A     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 262+ 8902 22 49 8A     	ld (view_file_pos_cur),hl
 263+ 8905              print_file_text_cl
 264+ 8905 2A 49 8A     	ld hl,(view_file_pos_cur)
 265+ 8908 CD 2E 89     	call print_line_text
 266+ 890B 38 0C        	jr c,print_file_text_ex
 267+ 890D
 268+ 890D              	; call next_line ;найти следующую строку
 269+ 890D              	; ret c
 270+ 890D
 271+ 890D 3A 4D 8A     	ld a,(view_file_y_cur)
 272+ 8910 3C           	inc a
 273+ 8911 32 4D 8A     	ld (view_file_y_cur),a
 274+ 8914 FE 18        	cp view_text_bot
 275+ 8916 38 ED        	jr c,print_file_text_cl
 276+ 8918 C9           	ret
 277+ 8919
 278+ 8919              print_file_text_ex
 279+ 8919              	;тут очистить остальные строки
 280+ 8919 3A 4D 8A     	ld a,(view_file_y_cur)
 281+ 891C 3C           	inc a
 282+ 891D FE 18        	cp view_text_bot
 283+ 891F 30 0B        	jr nc,print_file_text_ex2
 284+ 8921 67           	ld h,a
 285+ 8922 32 4D 8A     	ld (view_file_y_cur),a
 286+ 8925 3E 20        	ld a," "
 287+ 8927              	OS_FILL_LINE ;очистить строку
 287+ 8927 0E 03       >    ld c,#03
 287+ 8929 E7          >    rst #20
 288+ 892A 18 ED        	jr print_file_text_ex
 289+ 892C              print_file_text_ex2
 290+ 892C 37           	scf
 291+ 892D C9           	ret
 292+ 892E
 293+ 892E
 294+ 892E
 295+ 892E              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 296+ 892E              ;вх: hl - адрес строки
 297+ 892E CD 7E 89     	call view_move_right ;промотать направо. если надо
 298+ 8931              	;установить позицию
 299+ 8931 3A 4D 8A     	ld a,(view_file_y_cur)
 300+ 8934 57           	ld d,a
 301+ 8935 AF           	xor a
 302+ 8936 32 4E 8A     	ld (view_file_x_cur),a
 303+ 8939 5F           	ld e,a
 304+ 893A              	OS_SET_XY 	;yx
 304+ 893A 0E 01       >    ld c,#01
 304+ 893C E7          >    rst #20
 305+ 893D              print_line_text_cl ;цикл
 306+ 893D
 307+ 893D 7E           	ld a,(hl)
 308+ 893E FE 0A        	cp 10 ;этот код не печатаем
 309+ 8940 28 14        	jr z,print_line_text_skip
 310+ 8942 FE FF        	cp #ff ;этот код не печатаем
 311+ 8944 28 10        	jr z,print_line_text_skip
 312+ 8946 FE 0D        	cp 13
 313+ 8948 28 13        	jr z,print_line_text_ex_ok
 314+ 894A              	OS_PRINT_CHARF ;печать
 314+ 894A D7          >	rst #10
 315+ 894B
 316+ 894B              	;на следующую позицию
 317+ 894B 3A 4E 8A     	ld a,(view_file_x_cur)
 318+ 894E 3C           	inc a
 319+ 894F FE 50        	cp 80 ;правый край экрана
 320+ 8951 32 4E 8A     	ld (view_file_x_cur),a
 321+ 8954 30 15        	jr nc,print_line_text_right ;дошли до правого края
 322+ 8956
 323+ 8956              print_line_text_skip
 324+ 8956 CD B6 89     	call view_file_next_pos ;следующий
 325+ 8959 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 326+ 895B 18 E0        	jr print_line_text_cl
 327+ 895D
 328+ 895D              print_line_text_ex_ok ;выход норма по коду 13
 329+ 895D 3E 20        	ld a," "
 330+ 895F              	OS_PRINT_CHARF ;печать
 330+ 895F D7          >	rst #10
 331+ 8960 CD 6F 89     	call printe_clear_end ;добить до конца строки
 332+ 8963 C3 B6 89     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 333+ 8966              	;ret
 334+ 8966
 335+ 8966              print_line_text_ex_end ;выход если кончился файл
 336+ 8966 CD 6F 89     	call printe_clear_end
 337+ 8969 37           	scf
 338+ 896A C9           	ret
 339+ 896B
 340+ 896B              print_line_text_right
 341+ 896B CD 1A 8A     	call next_line ;позицию  до конца строки
 342+ 896E C9           	ret
 343+ 896F
 344+ 896F
 345+ 896F              printe_clear_end
 346+ 896F              	;добить строку пробелами
 347+ 896F 3A 4E 8A     	ld a,(view_file_x_cur)
 348+ 8972 3C           	inc a
 349+ 8973 FE 50        	cp 80 ;правый край экрана
 350+ 8975 32 4E 8A     	ld (view_file_x_cur),a
 351+ 8978 D0           	ret nc
 352+ 8979 3E 20        	ld a," "
 353+ 897B              	OS_PRINT_CHARF ;печать
 353+ 897B D7          >	rst #10
 354+ 897C 18 F1        	jr printe_clear_end
 355+ 897E
 356+ 897E
 357+ 897E
 358+ 897E
 359+ 897E
 360+ 897E              view_move_right ;перемотка строки направо
 361+ 897E ED 4B 47 8A  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 362+ 8982 78           	ld a,b
 363+ 8983 B1           	or c
 364+ 8984 C8           	ret z
 365+ 8985 2A 49 8A     	ld hl,(view_file_pos_cur)
 366+ 8988              view_move_right1
 367+ 8988 7E           	ld a,(hl)
 368+ 8989 FE 0A        	cp 10 ;этот код пропускаем
 369+ 898B 20 07        	jr nz,view_move_right2
 370+ 898D CD B6 89     	call view_file_next_pos
 371+ 8990 D8           	ret c
 372+ 8991 C8           	ret z
 373+ 8992 18 F4        	jr view_move_right1
 374+ 8994              view_move_right2
 375+ 8994 FE FF        	cp #ff ;этот код пропускаем
 376+ 8996 20 07        	jr nz,view_move_right3
 377+ 8998 CD B6 89     	call view_file_next_pos
 378+ 899B D8           	ret c
 379+ 899C C8           	ret z
 380+ 899D 18 E9        	jr view_move_right1
 381+ 899F              view_move_right3
 382+ 899F 7E           	ld a,(hl)
 383+ 89A0 FE 0D        	cp 13 ;
 384+ 89A2 C8           	ret z
 385+ 89A3              view_move_right_cl
 386+ 89A3 CD B6 89     	call view_file_next_pos
 387+ 89A6 D8           	ret c
 388+ 89A7 C8           	ret z
 389+ 89A8 7E           	ld a,(hl)
 390+ 89A9 FE 0D        	cp 13
 391+ 89AB C8           	ret z
 392+ 89AC FE 0A        	cp 10 ;этот код пропускаем
 393+ 89AE 28 F3        	jr z,view_move_right_cl
 394+ 89B0 0B           	dec bc
 395+ 89B1 78           	ld a,b
 396+ 89B2 B1           	or c
 397+ 89B3 20 EE        	jr nz,view_move_right_cl
 398+ 89B5              	;call view_file_next_pos ;следующий
 399+ 89B5 C9           	ret
 400+ 89B6
 401+ 89B6
 402+ 89B6
 403+ 89B6              ;получение следующей позиции
 404+ 89B6              view_file_next_pos
 405+ 89B6 3A 4F 8A     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 406+ 89B9 B7           	or a
 407+ 89BA 28 14        	jr z,view_file_next_pos_big
 408+ 89BC              	;если текст не большой
 409+ 89BC 2A 50 8A     	ld hl,(view_file_end) ;конец текста известен
 410+ 89BF ED 5B 49 8A  	ld de,(view_file_pos_cur)
 411+ 89C3 13           	inc de ;вперёд
 412+ 89C4 A7           	and a
 413+ 89C5 ED 52        	sbc hl,de
 414+ 89C7 38 15        	jr c,view_file_next_pos_end
 415+ 89C9 ED 53 49 8A  	ld (view_file_pos_cur),de
 416+ 89CD EB           	ex de,hl ;на выходе адрес в HL
 417+ 89CE B7           	or a
 418+ 89CF C9           	ret
 419+ 89D0
 420+ 89D0
 421+ 89D0
 422+ 89D0              view_file_next_pos_big
 423+ 89D0              	;если текст большой
 424+ 89D0 2A 49 8A     	ld hl,(view_file_pos_cur)	;текущая позиция
 425+ 89D3 23           	inc hl ;вперёд
 426+ 89D4 7C           	ld a,h
 427+ 89D5 FE C0        	cp #c0 ;если вышли за пределы окна
 428+ 89D7 38 05        	jr c,view_file_next_pos_end
 429+ 89D9 22 49 8A     	ld (view_file_pos_cur),hl
 430+ 89DC B7           	or a
 431+ 89DD C9           	ret
 432+ 89DE
 433+ 89DE              view_file_next_pos_end
 434+ 89DE              	;не смогли шагнуть вперёд
 435+ 89DE              	; ld a,1 ;флаг что внизу
 436+ 89DE              	; ld (view_file_bot_flag),a
 437+ 89DE 37           	scf ;ошибка
 438+ 89DF C9           	ret
 439+ 89E0
 440+ 89E0
 441+ 89E0
 442+ 89E0
 443+ 89E0
 444+ 89E0
 445+ 89E0              ;получение предыдущей позиции
 446+ 89E0              view_file_prev_pos
 447+ 89E0 3A 4F 8A     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 448+ 89E3 B7           	or a
 449+ 89E4 28 1E        	jr z,view_file_prev_pos_big
 450+ 89E6              	;если текст не большой
 451+ 89E6 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 452+ 89E9 ED 5B 49 8A  	ld de,(view_file_pos_cur) ;текущая позиция
 453+ 89ED 1B           	dec de ;назад
 454+ 89EE A7           	and a
 455+ 89EF ED 52        	sbc hl,de
 456+ 89F1 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 457+ 89F3 30 1D        	jr nc,view_file_prev_pos_end
 458+ 89F5              	;можно шагнуть назад
 459+ 89F5 ED 53 49 8A  	ld (view_file_pos_cur),de
 460+ 89F9 EB           	ex de,hl ;на выходе адрес в HL
 461+ 89FA AF           	xor a
 462+ 89FB 3C           	inc a ;a=1
 463+ 89FC C9           	ret
 464+ 89FD              view_file_prev_pos_top
 465+ 89FD              	;если в начале
 466+ 89FD ED 53 49 8A  	ld (view_file_pos_cur),de
 467+ 8A01 EB           	ex de,hl ;на выходе адрес в HL
 468+ 8A02 AF           	xor a ;a=0
 469+ 8A03 C9           	ret
 470+ 8A04
 471+ 8A04
 472+ 8A04              view_file_prev_pos_big
 473+ 8A04              	;если текст большой
 474+ 8A04 2A 49 8A     	ld hl,(view_file_pos_cur)	;текущая позиция
 475+ 8A07 2B           	dec hl ;назад
 476+ 8A08 7C           	ld a,h
 477+ 8A09 FE C0        	cp #c0 ;если вышли за пределы окна
 478+ 8A0B 38 05        	jr c,view_file_prev_pos_end
 479+ 8A0D 22 49 8A     	ld (view_file_pos_cur),hl
 480+ 8A10 B7           	or a
 481+ 8A11 C9           	ret
 482+ 8A12
 483+ 8A12              view_file_prev_pos_end
 484+ 8A12              	;не смогли шагнуть назад
 485+ 8A12 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 486+ 8A15 22 49 8A     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 487+ 8A18              	;вернулись в начало
 488+ 8A18 AF           	xor a ;a=0
 489+ 8A19 C9           	ret
 490+ 8A1A
 491+ 8A1A
 492+ 8A1A
 493+ 8A1A
 494+ 8A1A              next_line ;поиск следующей строки
 495+ 8A1A CD B6 89     	call view_file_next_pos
 496+ 8A1D D8           	ret c
 497+ 8A1E C8           	ret z
 498+ 8A1F 7E           	ld a,(hl)
 499+ 8A20 FE 0D        	cp 13
 500+ 8A22 20 F6        	jr nz,next_line
 501+ 8A24 CD B6 89     	call view_file_next_pos ;ещё на символ
 502+ 8A27 C9           	ret
 503+ 8A28
 504+ 8A28
 505+ 8A28
 506+ 8A28              prev_line ;поиск предыдущей строки
 507+ 8A28              ;если достигнуто начало файла - вернёт адрес начальный
 508+ 8A28              	;сначала в конец предыдущей
 509+ 8A28 CD E0 89     	call view_file_prev_pos
 510+ 8A2B C8           	ret z
 511+ 8A2C D8           	ret c
 512+ 8A2D 7E           	ld a,(hl)
 513+ 8A2E FE 0D        	cp 13
 514+ 8A30 20 F6        	jr nz,prev_line
 515+ 8A32              	;теперь в начало предыдущей
 516+ 8A32              prev_line1
 517+ 8A32 CD E0 89     	call view_file_prev_pos
 518+ 8A35 C8           	ret z
 519+ 8A36 D8           	ret c
 520+ 8A37 7E           	ld a,(hl)
 521+ 8A38 FE 0D        	cp 13
 522+ 8A3A 20 F6        	jr nz,prev_line1
 523+ 8A3C CD B6 89     	call view_file_next_pos ;ещё на символ обратно
 524+ 8A3F C9           	ret
 525+ 8A40
 526+ 8A40
 527+ 8A40
 528+ 8A40              view_text_bot equ 24 ;последняя строка для печати
 529+ 8A40              view_text_top equ 1 ;первая строка
 530+ 8A40              view_text_lines equ 25-2 ;видимых строк на экране
 531+ 8A40
 532+ 8A40              msg_menu_view
 533+ 8A40 33 20 45 78  	db "3 Exit",0
 533+ 8A44 69 74 00
 534+ 8A47
 535+ 8A47              ;view_file_position ds 4 ;текущая позиция в файле
 536+ 8A47              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 537+ 8A47 00 00        view_move_right_val dw 0 ;сдвиг вправо
 538+ 8A49 00 00        view_file_pos_cur dw 0;текущая позиция
 539+ 8A4B 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 540+ 8A4D 00           view_file_y_cur db 0;текущая строка
 541+ 8A4E 00           view_file_x_cur db 0;текущий столбец
 542+ 8A4F 00           view_file_load_all db 0 ;флаг что файл весь загружен
 543+ 8A50 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 544+ 8A52
 545+ 8A52
# file closed: nc_view.asm
1451  8A52              	include GPlay/gplay.asm ;плеер
# file opened: GPlay/gplay.asm
   1+ 8A52              ;GPlay - приложение для OS GMX
   2+ 8A52                 ; device ZXSPECTRUM128
   3+ 8A52              	; include "../os_defs.asm"
   4+ 8A52              	; org PROG_START
   5+ 8A52
   6+ 8A52
   7+ 8A52              start_gplay
   8+ 8A52 32 4D 8E     	ld (gplay_type),a ;тип формата
   9+ 8A55
  10+ 8A55 CD E0 80     	call clear_left_panel ;почистить часть экрана
  11+ 8A58
  12+ 8A58              	;call release_key
  13+ 8A58
  14+ 8A58 21 FF 8F     	ld hl,memorystreampages+$FF
  15+ 8A5B 36 00        	ld (hl),0 ;количество занятых страниц
  16+ 8A5D
  17+ 8A5D 3A 5C 9E     	ld a,(page_ext01) ;доп страница для данных плеера
  18+ 8A60              	OS_SET_PAGE_SLOT3
  18+ 8A60 0E 1C       >    ld c,#1c
  18+ 8A62 E7          >    rst #20
  19+ 8A63
  20+ 8A63 11 00 00     	ld de,0
  21+ 8A66              	OS_SET_XY
  21+ 8A66 0E 01       >    ld c,#01
  21+ 8A68 E7          >    rst #20
  22+ 8A69 21 BC 8E     	ld hl,msg_title ;имя приложения
  23+ 8A6C              	OS_PRINTZ ;печать
  23+ 8A6C 0E 09       >    ld c,#09
  23+ 8A6E E7          >    rst #20
  24+ 8A6F
  25+ 8A6F 3E 0D        	ld a,13 ;оставим место для шкалы прогресса
  26+ 8A71              	OS_PRINT_CHARF
  26+ 8A71 D7          >	rst #10
  27+ 8A72 3E 0D        	ld a,13
  28+ 8A74              	OS_PRINT_CHARF
  28+ 8A74 D7          >	rst #10
  29+ 8A75 21 4A 9C     	ld hl,file_name_cur
  30+ 8A78              	OS_PRINTZ
  30+ 8A78 0E 09       >    ld c,#09
  30+ 8A7A E7          >    rst #20
  31+ 8A7B
  32+ 8A7B 21 7B 8E     	ld hl,txt_load
  33+ 8A7E              	OS_PRINTZ
  33+ 8A7E 0E 09       >    ld c,#09
  33+ 8A80 E7          >    rst #20
  34+ 8A81
  35+ 8A81 3E FF        	ld a,255
  36+ 8A83 32 5B 9E     	ld (file_id_cur_r),a
  37+ 8A86
  38+ 8A86 3A 4D 8E     	ld a,(gplay_type)
  39+ 8A89              	;переход в на нужный раздел
  40+ 8A89
  41+ 8A89              start_gplay_pt2
  42+ 8A89 FE 32        	cp "2"
  43+ 8A8B 20 06        	jr nz,start_gplay_pt3
  44+ 8A8D              	;если PT2
  45+ 8A8D CD D5 8C     	call load_pt2
  46+ 8A90 C3 10 8B     	jp exit_gplay
  47+ 8A93              	;jp start_gplay_ok
  48+ 8A93
  49+ 8A93              start_gplay_pt3
  50+ 8A93 FE 33        	cp "3"
  51+ 8A95 20 06        	jr nz,start_gplay_mod
  52+ 8A97              	;если PT3
  53+ 8A97 CD DC 8C     	call load_pt3
  54+ 8A9A C3 10 8B     	jp exit_gplay
  55+ 8A9D              	;jp start_gplay_ok
  56+ 8A9D
  57+ 8A9D              start_gplay_mod
  58+ 8A9D FE 6D        	cp "m"
  59+ 8A9F 20 06        	jr nz,start_gplay_vgz
  60+ 8AA1              	;если MOD
  61+ 8AA1 CD D4 8B     	call load_mod
  62+ 8AA4 C3 10 8B     	jp exit_gplay
  63+ 8AA7              	;jp start_gplay_ok
  64+ 8AA7
  65+ 8AA7
  66+ 8AA7              start_gplay_vgz
  67+ 8AA7 FE 7A        	cp "z"
  68+ 8AA9 20 08        	jr nz,start_gplay_vgm
  69+ 8AAB              	;если VGZ
  70+ 8AAB CD 65 8B     	call load_vgz
  71+ 8AAE DA 10 8B     	jp c,exit_gplay
  72+ 8AB1 18 0A        	jr start_gplay_ok
  73+ 8AB3
  74+ 8AB3              start_gplay_vgm
  75+ 8AB3 FE 76        	cp "v"
  76+ 8AB5 20 59        	jr nz,exit_gplay
  77+ 8AB7              	;если vgm
  78+ 8AB7 CD 5E 8B     	call load_vgm
  79+ 8ABA DA 10 8B     	jp c,exit_gplay
  80+ 8ABD
  81+ 8ABD
  82+ 8ABD              start_gplay_ok
  83+ 8ABD              	;играет
  84+ 8ABD 21 6B 8E     	ld hl,txt_play
  85+ 8AC0              	OS_PRINTZ
  85+ 8AC0 0E 09       >    ld c,#09
  85+ 8AC2 E7          >    rst #20
  86+ 8AC3
  87+ 8AC3 21 4E 8E     	ld hl,txt_gplay_menu
  88+ 8AC6              	OS_PRINTZ
  88+ 8AC6 0E 09       >    ld c,#09
  88+ 8AC8 E7          >    rst #20
  89+ 8AC9
  90+ 8AC9              wait_play
  91+ 8AC9              	OS_WAIT
  91+ 8AC9 DF          >	rst #18
  92+ 8ACA
  93+ 8ACA CD 94 8D     	call gplay_progress_print
  94+ 8ACD
  95+ 8ACD 11 00 0A     	ld de,#0a00
  96+ 8AD0              	OS_SET_XY
  96+ 8AD0 0E 01       >    ld c,#01
  96+ 8AD2 E7          >    rst #20
  97+ 8AD3 2A 72 90     	ld hl,(memorystreamcurrentaddr)
  98+ 8AD6 CD EE 8D     	call toDecimal
  99+ 8AD9              	OS_PRINTZ
  99+ 8AD9 0E 09       >    ld c,#09
  99+ 8ADB E7          >    rst #20
 100+ 8ADC
 101+ 8ADC
 102+ 8ADC 11 00 0B     	ld de,#0b00
 103+ 8ADF              	OS_SET_XY
 103+ 8ADF 0E 01       >    ld c,#01
 103+ 8AE1 E7          >    rst #20
 104+ 8AE2 2A 0E 90     	ld hl,(memorystreampageaddr)
 105+ 8AE5 01 00 8F     	ld bc,memorystreampages
 106+ 8AE8 A7           	and a
 107+ 8AE9 ED 42        	sbc hl,bc
 108+ 8AEB CD EE 8D     	call toDecimal
 109+ 8AEE              	OS_PRINTZ
 109+ 8AEE 0E 09       >    ld c,#09
 109+ 8AF0 E7          >    rst #20
 110+ 8AF1
 111+ 8AF1 3A 7A 96     	ld a,(vgm_play_var)
 112+ 8AF4 B7           	or a
 113+ 8AF5 20 19        	jr nz,exit_gplay ; конец пенсни
 114+ 8AF7              	OS_GET_CHAR
 114+ 8AF7 0E 10       >    ld c,#10
 114+ 8AF9 E7          >    rst #20
 115+ 8AFA FE 20        	cp " " ;space
 116+ 8AFC CA 10 8B     	jp z,exit_gplay
 117+ 8AFF FE 73        	cp "s" ;stop
 118+ 8B01 CA 10 8B     	jp z,exit_gplay
 119+ 8B04 FE 53        	cp "S" ;stop
 120+ 8B06 CA 10 8B     	jp z,exit_gplay
 121+ 8B09 FE 18        	cp 24 ;break
 122+ 8B0B CA 10 8B     	jp z,exit_gplay
 123+ 8B0E 18 B9        	jr wait_play
 124+ 8B10
 125+ 8B10
 126+ 8B10
 127+ 8B10
 128+ 8B10
 129+ 8B10              exit_gplay ;выход
 130+ 8B10 F5           	push af ;сохранить нажатую клавишу
 131+ 8B11
 132+ 8B11 21 75 8E     	ld hl,txt_stop
 133+ 8B14              	OS_PRINTZ
 133+ 8B14 0E 09       >    ld c,#09
 133+ 8B16 E7          >    rst #20
 134+ 8B17
 135+ 8B17 CD 22 8B     	call gplay_stop
 136+ 8B1A
 137+ 8B1A 3A 5E 9E     	ld a,(page_main) ;основная страница
 138+ 8B1D              	OS_SET_PAGE_SLOT3
 138+ 8B1D 0E 1C       >    ld c,#1c
 138+ 8B1F E7          >    rst #20
 139+ 8B20
 140+ 8B20 F1           	pop af ;a - код клавиши
 141+ 8B21 C9           	ret
 142+ 8B22
 143+ 8B22
 144+ 8B22              ;заглушить звук
 145+ 8B22              gplay_stop
 146+ 8B22 3A 4D 8E     	ld a,(gplay_type)
 147+ 8B25 FE 32        	cp "2"
 148+ 8B27 CA CC 8B     	jp z,gplay_stop_ptx
 149+ 8B2A FE 33        	cp "3"
 150+ 8B2C CA CC 8B     	jp z,gplay_stop_ptx
 151+ 8B2F FE 76        	cp "v"
 152+ 8B31 CA AF 8B     	jp z,gplay_stop_vgm_vgz
 153+ 8B34 FE 7A        	cp "z"
 154+ 8B36 CA AF 8B     	jp z,gplay_stop_vgm_vgz
 155+ 8B39 FE 6D        	cp "m"
 156+ 8B3B CA D0 8B     	jp z,gplay_stop_mod
 157+ 8B3E C9           	ret
 158+ 8B3F
 159+ 8B3F
 160+ 8B3F
 161+ 8B3F              ; delay ;задержка между запросами
 162+ 8B3F              	; ld b,50*1 ;
 163+ 8B3F              ; delay1
 164+ 8B3F              	; OS_WAIT
 165+ 8B3F              	; djnz delay1
 166+ 8B3F              	; ret
 167+ 8B3F
 168+ 8B3F
 169+ 8B3F              check_BM
 170+ 8B3F              	;определение наличия BomgeMoon
 171+ 8B3F AF           	xor a
 172+ 8B40 DB 24        	in a,(MOON_BASE)
 173+ 8B42 FE FF        	cp 255
 174+ 8B44 28 02        	jr z,check_BM1
 175+ 8B46 B7           	or a
 176+ 8B47 C9           	ret
 177+ 8B48
 178+ 8B48              check_BM1
 179+ 8B48 3E 0A        	ld a,color_error ;цвет ошибки
 180+ 8B4A 06 0C        	ld b,#c
 181+ 8B4C              	OS_SET_COLOR
 181+ 8B4C 0E 06       >    ld c,#06
 181+ 8B4E E7          >    rst #20
 182+ 8B4F
 183+ 8B4F 21 93 8E     	ld hl,txt_no_BM
 184+ 8B52              	OS_PRINTZ
 184+ 8B52 0E 09       >    ld c,#09
 184+ 8B54 E7          >    rst #20
 185+ 8B55
 186+ 8B55 3E 0F        	ld a,color_backgr ;цвет основной
 187+ 8B57 06 0C        	ld b,#c
 188+ 8B59              	OS_SET_COLOR
 188+ 8B59 0E 06       >    ld c,#06
 188+ 8B5B E7          >    rst #20
 189+ 8B5C 37           	scf ;ошибка
 190+ 8B5D C9           	ret
 191+ 8B5E
 192+ 8B5E
 193+ 8B5E
 194+ 8B5E
 195+ 8B5E
 196+ 8B5E              load_vgm
 197+ 8B5E CD 3F 8B     	call check_BM
 198+ 8B61 D8           	ret c
 199+ 8B62 C3 1F 9B     	jp load_mus ;инициализация и загрузка VGM
 200+ 8B65
 201+ 8B65
 202+ 8B65
 203+ 8B65
 204+ 8B65
 205+ 8B65
 206+ 8B65              load_vgz
 207+ 8B65              ;тут запуск VGZ
 208+ 8B65 CD 3F 8B     	call check_BM
 209+ 8B68 D8           	ret c
 210+ 8B69              	;тут надо сначала распаковать файл
 211+ 8B69 AF           	xor a
 212+ 8B6A              	OS_SET_MONO_MODE ;запросить моно режим
 212+ 8B6A 0E 08       >    ld c,#08
 212+ 8B6C E7          >    rst #20
 213+ 8B6D 30 08        	jr nc,load_vgz1
 214+ 8B6F
 215+ 8B6F              load_vgz_err
 216+ 8B6F              	;выход с ошибкой
 217+ 8B6F
 218+ 8B6F              	;напечатать ошибку, если не дали режима моно
 219+ 8B6F 21 4C 9F     	ld hl,msg_mono_err
 220+ 8B72              	OS_PRINTZ
 220+ 8B72 0E 09       >    ld c,#09
 220+ 8B74 E7          >    rst #20
 221+ 8B75
 222+ 8B75 37           	scf ;ошибка
 223+ 8B76 C9           	ret
 224+ 8B77
 225+ 8B77              load_vgz1
 226+ 8B77              	;перенести модуль распаковки на рабочий адрес
 227+ 8B77
 228+ 8B77 3A 5D 9E     	ld a,(page_ext02_gzip) ;доп страница для данных плеера
 229+ 8B7A              	OS_SET_PAGE_SLOT3
 229+ 8B7A 0E 1C       >    ld c,#1c
 229+ 8B7C E7          >    rst #20
 230+ 8B7D
 231+ 8B7D 21 00 C0     	ld hl,start_gp_gzip_ext
 232+ 8B80 11 00 40     	ld de,start_gp_gzip
 233+ 8B83 01 00 1B     	ld bc,end_gp_gzip_load-start_gp_gzip_load
 234+ 8B86 ED B0        	ldir
 235+ 8B88
 236+ 8B88 3A 5C 9E     	ld a,(page_ext01) ;доп страница для данных плеера
 237+ 8B8B              	OS_SET_PAGE_SLOT3
 237+ 8B8B 0E 1C       >    ld c,#1c
 237+ 8B8D E7          >    rst #20
 238+ 8B8E
 239+ 8B8E              	;распаковать
 240+ 8B8E 21 4A 9C     	ld hl,file_name_cur ;имя файла
 241+ 8B91 CD 00 40     	call start_gp_gzip ;decompressfiletomemorystream
 242+ 8B94
 243+ 8B94              	;перенести таблицу страниц
 244+ 8B94 11 00 8F     	ld de,memorystreampages
 245+ 8B97 01 00 01     	ld bc,256
 246+ 8B9A ED B0        	ldir
 247+ 8B9C
 248+ 8B9C 01 FF 8F     	ld bc,memorystreampages+$ff
 249+ 8B9F 02               ld (bc),a  ;количество страниц
 250+ 8BA0
 251+ 8BA0 F5           	push af
 252+ 8BA1 3E FF        	ld a,255
 253+ 8BA3              	OS_SET_MONO_MODE ;выключить моно режим
 253+ 8BA3 0E 08       >    ld c,#08
 253+ 8BA5 E7          >    rst #20
 254+ 8BA6 F1           	pop af
 255+ 8BA7
 256+ 8BA7 30 01        	jr nc,load_vgz_ok
 257+ 8BA9              	;если не распаковалос
 258+ 8BA9              	;scf ;ошибка
 259+ 8BA9 C9           	ret
 260+ 8BAA
 261+ 8BAA              load_vgz_ok
 262+ 8BAA              	;нормально распаковалось
 263+ 8BAA
 264+ 8BAA CD 64 9B     	call read_file_ok ;играть
 265+ 8BAD              	;call start_gplay ;играть
 266+ 8BAD
 267+ 8BAD AF           	xor a
 268+ 8BAE C9           	ret
 269+ 8BAF
 270+ 8BAF
 271+ 8BAF              ;стоп игра
 272+ 8BAF              gplay_stop_vgm_vgz
 273+ 8BAF 21 00 00     	ld hl,0 ;отключить обработчик прерываний
 274+ 8BB2              	OS_SET_INTER
 274+ 8BB2 0E 14       >    ld c,#14
 274+ 8BB4 E7          >    rst #20
 275+ 8BB5 CD DB 8E     	call PLR_MUTE ;выключить звук
 276+ 8BB8
 277+ 8BB8
 278+ 8BB8              	;освободить страницы памяти
 279+ 8BB8 21 FF 8F     	ld hl,memorystreampages+$FF
 280+ 8BBB 6E               ld l,(hl)
 281+ 8BBC 2C           	inc l ;проверка на 0
 282+ 8BBD 2D           	dec l
 283+ 8BBE 28 0B        	jr z,free_s98_loop_skip
 284+ 8BC0
 285+ 8BC0              free_s98_loop
 286+ 8BC0 2D               dec l
 287+ 8BC1 7E               ld a,(hl)
 288+ 8BC2
 289+ 8BC2 F5               push af
 290+ 8BC3 E5               push hl
 291+ 8BC4                  ;OS_DELPAGE
 292+ 8BC4              	OS_DEL_PAGE
 292+ 8BC4 0E 20       >    ld c,#20
 292+ 8BC6 E7          >    rst #20
 293+ 8BC7 E1               pop hl
 294+ 8BC8 F1               pop af
 295+ 8BC9
 296+ 8BC9 20 F5            jr nz,free_s98_loop
 297+ 8BCB
 298+ 8BCB              free_s98_loop_skip
 299+ 8BCB C9           	ret
 300+ 8BCC
 301+ 8BCC              ;стоп игра
 302+ 8BCC              gplay_stop_ptx
 303+ 8BCC                  OS_VTPL_MUTE
 303+ 8BCC 0E 17       >    ld c,#17
 303+ 8BCE E7          >    rst #20
 304+ 8BCF C9           	ret
 305+ 8BD0
 306+ 8BD0
 307+ 8BD0
 308+ 8BD0              ;стоп игра
 309+ 8BD0              gplay_stop_mod
 310+ 8BD0 CD CD 9B         call GeneralSound.stopModule
 311+ 8BD3 C9           	ret
 312+ 8BD4
 313+ 8BD4
 314+ 8BD4              load_mod
 315+ 8BD4              ;загрузка и игра mod
 316+ 8BD4
 317+ 8BD4              	;определение наличия GS
 318+ 8BD4              	; xor a ;флаг что не нашли
 319+ 8BD4              	; ld (gs_yep),a
 320+ 8BD4              	; ld (gs_on),a
 321+ 8BD4 3E 23        	LD A,#23
 322+ 8BD6 D3 BB        	OUT (CMD), A
 323+ 8BD8 06 32        	ld b,50
 324+ 8BDA              WAITCOM2: ;это WC
 325+ 8BDA              	OS_WAIT
 325+ 8BDA DF          >	rst #18
 326+ 8BDB DB BB        	IN A,(CMD)
 327+ 8BDD 0F           	RRCA
 328+ 8BDE 30 18        	JR NC,WAITCOM3
 329+ 8BE0 10 F8        	djnz WAITCOM2
 330+ 8BE2              gs_no
 331+ 8BE2 3E 0A        	ld a,color_error ;цвет ошибки
 332+ 8BE4 06 0C        	ld b,#c
 333+ 8BE6              	OS_SET_COLOR
 333+ 8BE6 0E 06       >    ld c,#06
 333+ 8BE8 E7          >    rst #20
 334+ 8BE9
 335+ 8BE9 21 84 8E     	ld hl,txt_no_GS
 336+ 8BEC              	OS_PRINTZ
 336+ 8BEC 0E 09       >    ld c,#09
 336+ 8BEE E7          >    rst #20
 337+ 8BEF
 338+ 8BEF 3E 0F        	ld a,color_backgr ;цвет основной
 339+ 8BF1 06 0C        	ld b,#c
 340+ 8BF3              	OS_SET_COLOR
 340+ 8BF3 0E 06       >    ld c,#06
 340+ 8BF5 E7          >    rst #20
 341+ 8BF6
 342+ 8BF6 37           	scf ;ошибка
 343+ 8BF7 C9           	ret
 344+ 8BF8              	;jr gs_no
 345+ 8BF8              WAITCOM3
 346+ 8BF8 DB B3        	in a,(DATA) ;количество страниц памяти?
 347+ 8BFA FE FF        	cp 255
 348+ 8BFC 20 02        	jr nz,gs_yes
 349+ 8BFE              	; ld hl,txt_err_GS
 350+ 8BFE              	; call loader_print
 351+ 8BFE 18 E2        	jr gs_no
 352+ 8C00              gs_yes
 353+ 8C00
 354+ 8C00 21 4A 9C     	ld hl,file_name_cur
 355+ 8C03              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 355+ 8C03 0E 21       >    ld c,#21
 355+ 8C05 E7          >    rst #20
 356+ 8C06
 357+ 8C06 DA 74 8D     	jp c,load_file_error
 358+ 8C09 32 5B 9E     	ld (file_id_cur_r),a
 359+ 8C0C
 360+ 8C0C AF               xor a
 360+ 8C0D CD 7F 9B       call GeneralSound.init
 361+ 8C10                  ; ld hl, .progress : call DialogBox.msgNoWait
 362+ 8C10                  ; call makeRequest : jp c, Fetcher.fetchFromNet.error
 363+ 8C10 CD 96 9B         call GeneralSound.loadModule
 364+ 8C13
 365+ 8C13
 366+ 8C13              loadMod_loop
 367+ 8C13                  ;ld hl, buffer_cat, ;(buffer_pointer), hl
 368+ 8C13                  ; call Wifi.getPacket
 369+ 8C13                  ; ld a, (Wifi.closed) : and a : jr nz, .exit
 370+ 8C13                  ; ld hl, buffer_cat, bc, (Wifi.bytes_avail)
 371+ 8C13
 372+ 8C13 3A 5B 9E     		ld a,(file_id_cur_r)
 373+ 8C16 21 00 C0     		ld hl,buffer_cat
 374+ 8C19 11 00 40             ld de,$4000
 375+ 8C1C              		OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес дл¤ чтени¤)
 375+ 8C1C 0E 23       >    ld c,#23
 375+ 8C1E E7          >    rst #20
 376+ 8C1F DA 74 8D     		jp c,load_file_error
 377+ 8C22
 378+ 8C22 7C                   ld a,h
 379+ 8C23 FE C0        		cp $c0
 380+ 8C25 38 1A                jr c,loadMod_loadLoop_4000    ;>= $c0, значит остаток файла
 381+ 8C27              		;остаток
 382+ 8C27 01 00 C0     		ld bc,#c000
 383+ 8C2A A7           		and a
 384+ 8C2B ED 42        		sbc hl,bc
 385+ 8C2D 28 29        		jr z,loadMod_exit ;если ничего больше не считалось
 386+ 8C2F 44 4D        		ld bc,hl
 387+ 8C31 21 00 C0     		ld hl,buffer_cat
 388+ 8C34              load_mod_loadLoop2
 389+ 8C34 78               ld a, b
 389+ 8C35 B1             or c
 389+ 8C36 A7             and a
 389+ 8C37 28 1F          jr z, loadMod_exit
 390+ 8C39 7E               ld a, (hl)
 390+ 8C3A CD A9 9B       call GeneralSound.sendByte
 391+ 8C3D 0B               dec bc
 392+ 8C3E 23               inc hl
 393+ 8C3F 18 F3            jr load_mod_loadLoop2
 394+ 8C41
 395+ 8C41
 396+ 8C41              loadMod_loadLoop_4000
 397+ 8C41 21 00 C0     	ld hl,buffer_cat
 398+ 8C44 01 00 40     	ld bc,$4000 ;большой кусок для загрузки
 399+ 8C47
 400+ 8C47              load_mod_loadLoop
 401+ 8C47 78               ld a, b
 401+ 8C48 B1             or c
 401+ 8C49 A7             and a
 401+ 8C4A CA 13 8C       jp z,loadMod_loop
 402+ 8C4D 7E               ld a, (hl)
 402+ 8C4E CD A9 9B       call GeneralSound.sendByte
 403+ 8C51 0B               dec bc
 404+ 8C52 23               inc hl
 405+ 8C53 18 F2            jr load_mod_loadLoop
 406+ 8C55              ;.nextFrame
 407+ 8C55                  ;call Wifi.continue
 408+ 8C55 C3 13 8C         jp loadMod_loop
 409+ 8C58              loadMod_exit
 410+ 8C58 CD B1 9B         call GeneralSound.finishLoadingModule
 411+ 8C5B
 412+ 8C5B 3A 5B 9E     	ld a,(file_id_cur_r)
 413+ 8C5E              	OS_FILE_CLOSE ;A - id file
 413+ 8C5E 0E 25       >    ld c,#25
 413+ 8C60 E7          >    rst #20
 414+ 8C61                  ;jp History.back
 415+ 8C61              	;jp play ;MediaProcessor.processResource
 416+ 8C61              ;.progress db "MOD downloading directly to GS!", 0
 417+ 8C61
 418+ 8C61                  macro GS_WaitCommand2
 419+ 8C61 ~            .wait
 420+ 8C61 ~                in a, (CMD)
 421+ 8C61 ~                rrca
 422+ 8C61 ~                jr c, .wait
 423+ 8C61                  endm
 424+ 8C61
 425+ 8C61                  macro GS_SendCommand2 nn
 426+ 8C61 ~                ld a, nn
 426+ 8C61 ~              out (CMD), a
 427+ 8C61                  endm
 428+ 8C61
 429+ 8C61              loadMod_play
 430+ 8C61
 431+ 8C61 21 6B 8E     	ld hl,txt_play
 432+ 8C64              	OS_PRINTZ
 432+ 8C64 0E 09       >    ld c,#09
 432+ 8C66 E7          >    rst #20
 433+ 8C67
 434+ 8C67 21 4E 8E         ld hl,txt_gplay_menu
 435+ 8C6A              	OS_PRINTZ
 435+ 8C6A 0E 09       >    ld c,#09
 435+ 8C6C E7          >    rst #20
 436+ 8C6D
 437+ 8C6D                  ; call Console.waitForKeyUp
 438+ 8C6D
 439+ 8C6D                  ; ld hl, Gopher.requestbuffer : call DialogBox.msgNoWait
 440+ 8C6D
 441+ 8C6D                  ; ;ld a, 1, (Render.play_next), a
 442+ 8C6D AF           	xor a
 443+ 8C6E 32 D0 8C     	ld (last_song_position),a
 444+ 8C71
 445+ 8C71              load_mod_loop
 446+ 8C71                  OS_WAIT
 446+ 8C71 DF          >	rst #18
 446+ 8C72
 447+ 8C72                  OS_GET_CHAR
 447+ 8C72 0E 10       >    ld c,#10
 447+ 8C74 E7          >    rst #20
 448+ 8C75 FE 20        	cp " " ;пробел
 449+ 8C77 CA CF 8C     	jp z, load_mod_stop
 450+ 8C7A FE 73        	cp "s" ;стоп
 451+ 8C7C CA CF 8C     	jp z, load_mod_stop
 452+ 8C7F FE 53        	cp "S" ;чтоп
 453+ 8C81 CA CF 8C     	jp z, load_mod_stop
 454+ 8C84              	;call printRTC
 455+ 8C84                  ;проверка что MOD начал играть сначала
 456+ 8C84                  GS_SendCommand2 CMD_GET_SONG_POSITION
 456+ 8C84 3E 60       >    ld a, CMD_GET_SONG_POSITION
 456+ 8C86 D3 BB       >  out (CMD), a
 457+ 8C88                  GS_WaitCommand2
 457+ 8C88             >.wait
 457+ 8C88 DB BB       >    in a, (CMD)
 457+ 8C8A 0F          >    rrca
 457+ 8C8B 38 FB       >    jr c, .wait
 458+ 8C8D DB B3        	in a,(DATA) ;текущая позиция
 459+ 8C8F 32 D1 8C     	ld (cur_song_position),a
 460+ 8C92              	;печатать позицию song
 461+ 8C92 11 00 0A     	ld de,#0a00
 462+ 8C95              	OS_SET_XY
 462+ 8C95 0E 01       >    ld c,#01
 462+ 8C97 E7          >    rst #20
 463+ 8C98 2A D1 8C     	ld hl,(cur_song_position)
 464+ 8C9B 26 00        	ld h,0
 465+ 8C9D CD EE 8D     	call toDecimal
 466+ 8CA0              	OS_PRINTZ
 466+ 8CA0 0E 09       >    ld c,#09
 466+ 8CA2 E7          >    rst #20
 467+ 8CA3
 468+ 8CA3                  GS_SendCommand2 CMD_GET_PATTERN_POSITION
 468+ 8CA3 3E 61       >    ld a, CMD_GET_PATTERN_POSITION
 468+ 8CA5 D3 BB       >  out (CMD), a
 469+ 8CA7                  GS_WaitCommand2
 469+ 8CA7             >.wait
 469+ 8CA7 DB BB       >    in a, (CMD)
 469+ 8CA9 0F          >    rrca
 469+ 8CAA 38 FB       >    jr c, .wait
 470+ 8CAC DB B3        	in a,(DATA) ;текущая позиция паттерна
 471+ 8CAE 32 D2 8C     	ld (cur_pattern_position),a
 472+ 8CB1 11 00 0B     	ld de,#0b00
 473+ 8CB4              	OS_SET_XY
 473+ 8CB4 0E 01       >    ld c,#01
 473+ 8CB6 E7          >    rst #20
 474+ 8CB7 2A D2 8C     	ld hl,(cur_pattern_position)
 475+ 8CBA 26 00        	ld h,0
 476+ 8CBC CD EE 8D     	call toDecimal
 477+ 8CBF              	OS_PRINTZ
 477+ 8CBF 0E 09       >    ld c,#09
 477+ 8CC1 E7          >    rst #20
 478+ 8CC2
 479+ 8CC2
 480+ 8CC2 3A D0 8C     	ld a,(last_song_position) ;предыдущая позиция
 481+ 8CC5 4F           	ld c,a
 482+ 8CC6 3A D1 8C     	ld a,(cur_song_position) ;текущая
 483+ 8CC9 32 D0 8C     	ld (last_song_position),a
 484+ 8CCC B9           	cp c
 485+ 8CCD 30 A2        	jr nc,load_mod_loop ;если не меньше, продолжаем играть
 486+ 8CCF                  ;ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
 487+ 8CCF              load_mod_stop
 488+ 8CCF                  ;call Console.waitForKeyUp
 489+ 8CCF C9               ret
 490+ 8CD0              ; .stopKey
 491+ 8CD0                  ; ;xor a : ld (Render.play_next), a ;флаг что не надо играть следующий файл
 492+ 8CD0                  ; jr .stop
 493+ 8CD0
 494+ 8CD0
 495+ 8CD0              ;message db "Press key to stop...", 0
 496+ 8CD0
 497+ 8CD0
 498+ 8CD0              CMD_GET_SONG_POSITION     = #60
 499+ 8CD0              CMD_GET_PATTERN_POSITION  = #61
 500+ 8CD0 00           last_song_position db 0
 501+ 8CD1 00           cur_song_position db 0
 502+ 8CD2 00           cur_pattern_position db 0
 503+ 8CD3
 504+ 8CD3              ;; Control ports
 505+ 8CD3              CMD  = 187
 506+ 8CD3              DATA = 179
 507+ 8CD3
 508+ 8CD3 00 00        buffer_pointer dw 0;
 509+ 8CD5
 510+ 8CD5
 511+ 8CD5
 512+ 8CD5
 513+ 8CD5
 514+ 8CD5
 515+ 8CD5              ;загрузка PTx
 516+ 8CD5              load_pt2
 517+ 8CD5 3E 03        	ld a,%00000011 ;pt2
 518+ 8CD7 32 39 8D     	ld (ptplayer_setup),a
 519+ 8CDA 18 05        	jr load_pt
 520+ 8CDC              load_pt3
 521+ 8CDC 3E 21        	ld a,%00100001 ;pt3
 522+ 8CDE 32 39 8D     	ld (ptplayer_setup),a
 523+ 8CE1
 524+ 8CE1              load_pt
 525+ 8CE1
 526+ 8CE1 21 4A 9C     	ld hl,file_name_cur
 527+ 8CE4 CD 3A 8D     	call load_file
 528+ 8CE7 D8           	ret c
 529+ 8CE8
 530+ 8CE8              	;начать игру
 531+ 8CE8 21 00 C0     	ld hl,buffer_cat
 532+ 8CEB              	OS_GET_VTPL_SETUP
 532+ 8CEB 0E 18       >    ld c,#18
 532+ 8CED E7          >    rst #20
 533+ 8CEE 3A 39 8D     	ld a,(ptplayer_setup)
 534+ 8CF1 77           	ld (hl),a ;настройки
 535+ 8CF2
 536+ 8CF2 21 00 C0     	ld hl,buffer_cat
 537+ 8CF5              	OS_VTPL_INIT
 537+ 8CF5 0E 15       >    ld c,#15
 537+ 8CF7 E7          >    rst #20
 538+ 8CF8              	OS_VTPL_PLAY
 538+ 8CF8 0E 16       >    ld c,#16
 538+ 8CFA E7          >    rst #20
 539+ 8CFB
 540+ 8CFB 21 6B 8E     	ld hl,txt_play
 541+ 8CFE              	OS_PRINTZ
 541+ 8CFE 0E 09       >    ld c,#09
 541+ 8D00 E7          >    rst #20
 542+ 8D01
 543+ 8D01 21 4E 8E     	ld hl,txt_gplay_menu
 544+ 8D04              	OS_PRINTZ
 544+ 8D04 0E 09       >    ld c,#09
 544+ 8D06 E7          >    rst #20
 545+ 8D07
 546+ 8D07              load_pt_loop
 547+ 8D07                  OS_WAIT
 547+ 8D07 DF          >	rst #18
 547+ 8D08
 548+ 8D08                  OS_GET_CHAR
 548+ 8D08 0E 10       >    ld c,#10
 548+ 8D0A E7          >    rst #20
 549+ 8D0B FE 20        	cp " " ;пробел
 550+ 8D0D CA 37 8D     	jp z, load_pt_stop
 551+ 8D10 FE 73        	cp "s" ;стоп
 552+ 8D12 CA 37 8D     	jp z, load_pt_stop
 553+ 8D15 FE 53        	cp "S" ;чтоп
 554+ 8D17 CA 37 8D     	jp z, load_pt_stop
 555+ 8D1A              	;call printRTC
 556+ 8D1A
 557+ 8D1A              	;печать инфо
 558+ 8D1A 11 00 0A     	ld de,#0a00
 559+ 8D1D              	OS_SET_XY
 559+ 8D1D 0E 01       >    ld c,#01
 559+ 8D1F E7          >    rst #20
 560+ 8D20
 561+ 8D20              	OS_GET_VTPL_SETUP
 561+ 8D20 0E 18       >    ld c,#18
 561+ 8D22 E7          >    rst #20
 562+ 8D23 01 3B 09     	ld bc,#93b ;нужная переменная плеера
 563+ 8D26 09           	add hl,bc
 564+ 8D27 6E               ld l,(hl)
 564+ 8D28
 565+ 8D28 26 00        	ld h,0
 566+ 8D2A CD EE 8D     	call toDecimal
 567+ 8D2D              	OS_PRINTZ
 567+ 8D2D 0E 09       >    ld c,#09
 567+ 8D2F E7          >    rst #20
 568+ 8D30
 569+ 8D30              	;проверка на конец песни
 570+ 8D30              	OS_GET_VTPL_SETUP
 570+ 8D30 0E 18       >    ld c,#18
 570+ 8D32 E7          >    rst #20
 571+ 8D33 7E           	ld a, (hl)
 572+ 8D34 17           	rla
 573+ 8D35 30 D0        	jr nc,load_pt_loop ;если не меньше, продолжаем играть
 574+ 8D37                  ;ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
 575+ 8D37              load_pt_stop
 576+ 8D37                  ;call Console.waitForKeyUp
 577+ 8D37 B7           	or a
 578+ 8D38 C9               ret
 579+ 8D39
 580+ 8D39 00           ptplayer_setup db 0;
 581+ 8D3A
 582+ 8D3A
 583+ 8D3A
 584+ 8D3A
 585+ 8D3A
 586+ 8D3A              ;прочитать файл не больше #4000 байт
 587+ 8D3A              ;вх: hl - имя файла
 588+ 8D3A              ;вых: CY = 1 = ошибка
 589+ 8D3A              load_file
 590+ 8D3A              	;ld hl,file_name_cur
 591+ 8D3A              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 591+ 8D3A 0E 21       >    ld c,#21
 591+ 8D3C E7          >    rst #20
 592+ 8D3D DA 74 8D     	jp c,load_file_error
 593+ 8D40
 594+ 8D40              load_file_ok
 595+ 8D40 32 5B 9E     	ld (file_id_cur_r),a
 596+ 8D43              	;проверка длины файла не больше #4000
 597+ 8D43 7A           	ld	a,d ;самые старшие байты длины
 598+ 8D44 B3           	or e
 599+ 8D45 28 08        	jr z,load_file_size_ok ;если не слищком большой
 600+ 8D47              load_file_too_big
 601+ 8D47              	;файл больше буфера
 602+ 8D47 21 2C 9F     	ld hl,msg_file_too_big
 603+ 8D4A              	OS_PRINTZ
 603+ 8D4A 0E 09       >    ld c,#09
 603+ 8D4C E7          >    rst #20
 604+ 8D4D 37           	scf
 605+ 8D4E C9           	ret
 606+ 8D4F
 607+ 8D4F
 608+ 8D4F              load_file_size_ok
 609+ 8D4F 7C           	ld	a,h ;младший старший байт длины
 610+ 8D50 FE 40        	cp #40
 611+ 8D52 38 06        	jr c,load_file_size_ok_small
 612+ 8D54 20 F1        	jr nz,load_file_too_big
 613+ 8D56 2C           	inc l
 614+ 8D57 2D           	dec l
 615+ 8D58 20 ED        	jr nz,load_file_too_big
 616+ 8D5A
 617+ 8D5A
 618+ 8D5A              load_file_size_ok_small
 619+ 8D5A              	;проверка на 0
 620+ 8D5A 7C           	ld a,h
 621+ 8D5B B5           	or l
 622+ 8D5C CA 74 8D     	jp z,load_file_error
 623+ 8D5F 54           	ld d,h ;размер
 624+ 8D60 5D           	ld e,l
 625+ 8D61 21 00 C0     	ld hl,buffer_cat ;куда
 626+ 8D64 3A 5B 9E     	ld a,(file_id_cur_r)
 627+ 8D67              	OS_FILE_READ ;загрузить
 627+ 8D67 0E 23       >    ld c,#23
 627+ 8D69 E7          >    rst #20
 628+ 8D6A 38 08        	jr c,load_file_error
 629+ 8D6C
 630+ 8D6C 3A 5B 9E     	ld a,(file_id_cur_r)
 631+ 8D6F              	OS_FILE_CLOSE ;A - id file
 631+ 8D6F 0E 25       >    ld c,#25
 631+ 8D71 E7          >    rst #20
 632+ 8D72 AF           	xor a
 633+ 8D73 C9           	ret
 634+ 8D74
 635+ 8D74
 636+ 8D74
 637+ 8D74              load_file_error
 638+ 8D74 3E 0A        	ld a,color_error ;цвет ошибки
 639+ 8D76 06 0C        	ld b,#c
 640+ 8D78              	OS_SET_COLOR
 640+ 8D78 0E 06       >    ld c,#06
 640+ 8D7A E7          >    rst #20
 641+ 8D7B 21 20 9F     		ld hl,msg_file_error
 642+ 8D7E              		OS_PRINTZ
 642+ 8D7E 0E 09       >    ld c,#09
 642+ 8D80 E7          >    rst #20
 643+ 8D81 3E 0F        	ld a,color_backgr ;цвет основной
 644+ 8D83 06 0C        	ld b,#c
 645+ 8D85              	OS_SET_COLOR
 645+ 8D85 0E 06       >    ld c,#06
 645+ 8D87 E7          >    rst #20
 646+ 8D88
 647+ 8D88 3A 5B 9E     		ld a,(file_id_cur_r)
 648+ 8D8B FE FF        		cp 255
 649+ 8D8D 28 03        		jr z,load_file_error1
 650+ 8D8F              		OS_FILE_CLOSE ;A - id file
 650+ 8D8F 0E 25       >    ld c,#25
 650+ 8D91 E7          >    rst #20
 651+ 8D92              load_file_error1
 652+ 8D92 37           		scf ;ошибка
 653+ 8D93 C9           		ret
 654+ 8D94
 655+ 8D94
 656+ 8D94
 657+ 8D94
 658+ 8D94              	;печать шкалы прогресса
 659+ 8D94              gplay_progress_print
 660+ 8D94 CD BD 8D     	call gplay_progress_calc
 661+ 8D97 11 00 02     	ld de,#0200 ;прогресс тут
 662+ 8D9A              	OS_SET_XY
 662+ 8D9A 0E 01       >    ld c,#01
 662+ 8D9C E7          >    rst #20
 663+ 8D9D              	;печать закрашенных кубиков
 664+ 8D9D 3A ED 8D     	ld a,(gplay_progress_val)
 665+ 8DA0 B7           	or a
 666+ 8DA1 28 08        	jr z,gplay_progress_print1
 667+ 8DA3 47           	ld b,a
 668+ 8DA4              gplay_progress_print1_cl
 669+ 8DA4 C5           	push bc
 670+ 8DA5 3E B1        	ld a,177 ;псевдографика
 671+ 8DA7              	OS_PRINT_CHARF
 671+ 8DA7 D7          >	rst #10
 672+ 8DA8 C1           	pop bc
 673+ 8DA9 10 F9        	djnz gplay_progress_print1_cl
 674+ 8DAB              gplay_progress_print1
 675+ 8DAB              	;печать пустых кубиков
 676+ 8DAB 3A ED 8D     	ld a,(gplay_progress_val)
 677+ 8DAE 4F           	ld c,a
 678+ 8DAF 3E 10        	ld a,gplay_progress_lenght
 679+ 8DB1 91           	sub c
 680+ 8DB2 28 08        	jr z,gplay_progress_print2
 681+ 8DB4 47           	ld b,a
 682+ 8DB5              gplay_progress_print1_c2
 683+ 8DB5 C5           	push bc
 684+ 8DB6 3E B0        	ld a,176 ;псевдографика
 685+ 8DB8              	OS_PRINT_CHARF
 685+ 8DB8 D7          >	rst #10
 686+ 8DB9 C1           	pop bc
 687+ 8DBA 10 F9        	djnz gplay_progress_print1_c2
 688+ 8DBC
 689+ 8DBC              gplay_progress_print2
 690+ 8DBC C9           	ret
 691+ 8DBD
 692+ 8DBD
 693+ 8DBD              gplay_progress_calc
 694+ 8DBD 3A FF 8F     	ld a,(memorystreampages+255) ;всего страниц памяти занято
 695+ 8DC0 67           	ld h,a
 696+ 8DC1 2E 00        	ld l,0 ;всего страниц *256
 697+ 8DC3
 698+ 8DC3              	;разделить
 699+ 8DC3 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 700+ 8DC5 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 701+ 8DC7 CB 3C        	srl h ; /4
 702+ 8DC9 CB 1D        	rr l ;
 703+ 8DCB CB 3C        	srl h ; /8
 704+ 8DCD CB 1D        	rr l ;
 705+ 8DCF CB 3C        	srl h ; /16
 706+ 8DD1 CB 1D        	rr l ;
 707+ 8DD3              	; srl h ; /32
 708+ 8DD3              	; rr l ;
 709+ 8DD3              	;узнали сколько страниц одно деление
 710+ 8DD3 EB           	ex de,hl
 711+ 8DD4
 712+ 8DD4
 713+ 8DD4 2A 0E 90     	ld hl,(memorystreampageaddr)
 714+ 8DD7 01 00 8F     	ld bc,memorystreampages
 715+ 8DDA A7           	and a
 716+ 8DDB ED 42        	sbc hl,bc ;какая по счёту страница сейчас
 717+ 8DDD
 718+ 8DDD 65           	ld h,l ;*256
 719+ 8DDE 2E 00        	ld l,0
 720+ 8DE0
 721+ 8DE0              	;разделить на величину одного деления
 722+ 8DE0 3E FF        	ld a,-1
 723+ 8DE2              divide16
 724+ 8DE2 3C           	inc a
 725+ 8DE3 A7           	and a
 726+ 8DE4 ED 52        	sbc hl,de
 727+ 8DE6 30 FA        	jr nc,divide16
 728+ 8DE8 19           	add hl,de
 729+ 8DE9 32 ED 8D     	ld (gplay_progress_val),a
 730+ 8DEC C9           	ret
 731+ 8DED
 732+ 8DED              gplay_progress_lenght equ 16 ;длина шкалы
 733+ 8DED 00           gplay_progress_val db 0;
 734+ 8DEE
 735+ 8DEE
 736+ 8DEE
 737+ 8DEE
 738+ 8DEE              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 739+ 8DEE              				;на входе в HL число
 740+ 8DEE 11 10 27     			ld de,10000 ;десятки тысяч
 741+ 8DF1 3E FF        			ld a,255
 742+ 8DF3              toDecimal10k
 743+ 8DF3 A7           			and a
 744+ 8DF4 ED 52        			sbc hl,de
 745+ 8DF6 3C           			inc a
 746+ 8DF7 30 FA        			jr nc,toDecimal10k
 747+ 8DF9 19           			add hl,de
 748+ 8DFA C6 30        			add a,48
 749+ 8DFC 32 47 8E     			ld (decimalS),a
 750+ 8DFF 11 E8 03     			ld de,1000 ;тысячи
 751+ 8E02 3E FF        			ld a,255
 752+ 8E04              toDecimal1k
 753+ 8E04 A7           			and a
 754+ 8E05 ED 52        			sbc hl,de
 755+ 8E07 3C           			inc a
 756+ 8E08 30 FA        			jr nc,toDecimal1k
 757+ 8E0A 19           			add hl,de
 758+ 8E0B C6 30        			add a,48
 759+ 8E0D 32 48 8E     			ld (decimalS+1),a
 760+ 8E10 11 64 00     			ld de,100 ;сотни
 761+ 8E13 3E FF        			ld a,255
 762+ 8E15              toDecimal01k
 763+ 8E15 A7           			and a
 764+ 8E16 ED 52        			sbc hl,de
 765+ 8E18 3C           			inc a
 766+ 8E19 30 FA        			jr nc,toDecimal01k
 767+ 8E1B 19           			add hl,de
 768+ 8E1C C6 30        			add a,48
 769+ 8E1E 32 49 8E     			ld (decimalS+2),a
 770+ 8E21 11 0A 00     			ld de,10 ;десятки
 771+ 8E24 3E FF        			ld a,255
 772+ 8E26              toDecimal001k
 773+ 8E26 A7           			and a
 774+ 8E27 ED 52        			sbc hl,de
 775+ 8E29 3C           			inc a
 776+ 8E2A 30 FA        			jr nc,toDecimal001k
 777+ 8E2C 19           			add hl,de
 778+ 8E2D C6 30        			add a,48
 779+ 8E2F 32 4A 8E     			ld (decimalS+3),a
 780+ 8E32 11 01 00     			ld de,1 ;единицы
 781+ 8E35 3E FF        			ld a,255
 782+ 8E37              toDecimal0001k
 783+ 8E37 A7           			and a
 784+ 8E38 ED 52        			sbc hl,de
 785+ 8E3A 3C           			inc a
 786+ 8E3B 30 FA        			jr nc,toDecimal0001k
 787+ 8E3D 19           			add hl,de
 788+ 8E3E C6 30        			add a,48
 789+ 8E40 32 4B 8E     			ld (decimalS+4),a
 790+ 8E43 21 47 8E     			ld hl,decimalS
 791+ 8E46 C9           			ret
 792+ 8E47
 793+ 8E47 00 00 00...  decimalS	ds 6 ;десятичные цифры
 794+ 8E4D
 795+ 8E4D
 796+ 8E4D
 797+ 8E4D 00           gplay_type db 0 ;тип музыки
 798+ 8E4E              ;file_id_cur db 0; временно
 799+ 8E4E
 800+ 8E4E 0D 0D 42 72  txt_gplay_menu db 13,13,"Break, S - stop ",13,"Sp - Next",0
 800+ 8E52 65 61 6B 2C
 800+ 8E56 20 53 20 2D
 800+ 8E5A 20 73 74 6F
 800+ 8E5E 70 20 0D 53
 800+ 8E62 70 20 2D 20
 800+ 8E66 4E 65 78 74
 800+ 8E6A 00
 801+ 8E6B 0D 50 6C 61  txt_play db 13,"Play... ",0
 801+ 8E6F 79 2E 2E 2E
 801+ 8E73 20 00
 802+ 8E75 0D 53 74 6F  txt_stop db 13,"Stop",0
 802+ 8E79 70 00
 803+ 8E7B 0D 4C 6F 61  txt_load db 13,"Load...",0
 803+ 8E7F 64 2E 2E 2E
 803+ 8E83 00
 804+ 8E84 0D 47 53 20  txt_no_GS db 13,"GS not found!",0
 804+ 8E88 6E 6F 74 20
 804+ 8E8C 66 6F 75 6E
 804+ 8E90 64 21 00
 805+ 8E93 0D 42 4D 20  txt_no_BM db 13,"BM not found!",0
 805+ 8E97 6E 6F 74 20
 805+ 8E9B 66 6F 75 6E
 805+ 8E9F 64 21 00
 806+ 8EA2 0D 4D 65 6D  txt_memoryerror:    db 13,"Memory allocation error!",0
 806+ 8EA6 6F 72 79 20
 806+ 8EAA 61 6C 6C 6F
 806+ 8EAE 63 61 74 69
 806+ 8EB2 6F 6E 20 65
 806+ 8EB6 72 72 6F 72
 806+ 8EBA 21 00
 807+ 8EBC              ;txt_fopenerror:     db 13,"Cannot open file: ",0
 808+ 8EBC
 809+ 8EBC              msg_title
 810+ 8EBC 47 50 6C 61  	db "GPlay ver 2025.08.18",10,13,0
 810+ 8EC0 79 20 76 65
 810+ 8EC4 72 20 32 30
 810+ 8EC8 32 35 2E 30
 810+ 8ECC 38 2E 31 38
 810+ 8ED0 0A 0D 00
 811+ 8ED3
 812+ 8ED3              vgm_plr
 813+ 8ED3
 814+ 8ED3              ;module equ 0xc000
 815+ 8ED3              ;player_load = 0x8000 ;0x4000
 816+ 8ED3
 817+ 8ED3              ;ovl_start = 0x8000 ;0x4000
 818+ 8ED3
 819+ 8ED3              PLR_INIT  = vgm_plr ;0x4000
 820+ 8ED3              PLR_PLAY  = vgm_plr+5 ;0x4005
 821+ 8ED3              PLR_MUTE  = vgm_plr+8 ;0x4008
 822+ 8ED3
 823+ 8ED3              	include vgm.asm
# file opened: GPlay/vgm.asm
   1++8ED3                      ;DEVICE ZXSPECTRUM48
   2++8ED3                      ;include "../../../_sdk/sys_h.asm"
   3++8ED3                      ;       ORG PROGSTART ;0x4000
   4++8ED3
   5++8ED3
   6++8ED3
   7++8ED3              ;memorystreamcurrentpage = 0x5100
   8++8ED3              ;current_ram_page = 0x5100
   9++8ED3
  10++8ED3
  11++8ED3              AREA_C000_FFFF   equ 1
  12++8ED3
  13++8ED3
  14++8ED3
  15++8ED3              module = $C000
  16++8ED3
  17++8ED3
  18++8ED3
  19++8ED3              begin
  20++8ED3              START
  21++8ED3 21 00 C0             	LD HL,module;MDLADDR ;DE - address of 2nd module for TS
  22++8ED6 18 06                	JR INIT
  23++8ED8 C3 7A 96             	JP PLAY
  24++8EDB C3 6C 96             	JP MUTE
  25++8EDE              INIT:
  26++8EDE C3 CF 95             jp init_
  27++8EE1
  28++8EE1              DEVICE_AY_BIT         = 0
  29++8EE1              DEVICE_TURBOSOUND_BIT = 1
  30++8EE1              DEVICE_TFM_BIT        = 2
  31++8EE1              DEVICE_MOONSOUND_BIT  = 3
  32++8EE1              DEVICE_GS_BIT         = 4
  33++8EE1              DEVICE_NEOGS_BIT      = 5
  34++8EE1              DEVICE_MIDI_UART_BIT  = 6
  35++8EE1
  36++8EE1              DEVICE_AY_MASK         = 1<<DEVICE_AY_BIT
  37++8EE1              DEVICE_TURBOSOUND_MASK = 1<<DEVICE_TURBOSOUND_BIT
  38++8EE1              DEVICE_TFM_MASK        = 1<<DEVICE_TFM_BIT
  39++8EE1              DEVICE_MOONSOUND_MASK  = 1<<DEVICE_MOONSOUND_BIT
  40++8EE1              DEVICE_GS_MASK         = 1<<DEVICE_GS_BIT
  41++8EE1              DEVICE_NEOGS_MASK      = 1<<DEVICE_NEOGS_BIT
  42++8EE1              DEVICE_MIDI_UART_MASK  = 1<<DEVICE_MIDI_UART_BIT
  43++8EE1
  44++8EE1
  45++8EE1
  46++8EE1
  47++8EE1
  48++8EE1              HEADER_DATA_OFFSET = module+0x34 ;0xC034
  49++8EE1              HEADER_LOOP_SAMPLES_COUNT = module+0x20 ;0xC020
  50++8EE1              HEADER_GD3_OFFSET = module+0x14 ;0xC014
  51++8EE1              HEADER_SAMPLES_COUNT = module+0x18 ;0xC018
  52++8EE1              HEADER_LOOP_OFFSET = module+0x1c ;0xC01c
  53++8EE1
  54++8EE1
  55++8EE1              HEADER_SIZE_MAX = 256
  56++8EE1              TITLELENGTH = 64
  57++8EE1              MEMORYSTREAMMAXPAGES = 210
  58++8EE1              MEMORYSTREAMERRORMASK = 255 ; TODO: do we need to enforce loading the entire file?
  59++8EE1              ENABLE_FM = 1
  60++8EE1
  61++8EE1
  62++8EE1
  63++8EE1
  64++8EE1
  65++8EE1
  66++8EE1
  67++8EE1 00 00 00...          align 256   ;0x8100 ;0x4100
  68++8F00                      display "s98_file00_pages_list ",$
  69++8F00
  70++8F00 00 00 00...  memorystreampages: ds 256,0
  71++9000              memorystreampagecount = memorystreampages + 255
  72++9000
  73++9000              	include "common/memorystream.asm"
# file opened: GPlay/common/memorystream.asm
   1++9000              memorystreamstart
   2++9000                      IF AREA_C000_FFFF=1
   3++9000 21 00 00     	ld hl,0x0000
   4++9003                      ELSE
   5++9003 ~                    ld hl,0xffff
   6++9003                      ENDIF
   7++9003 22 72 90     	ld (memorystreamcurrentaddr),hl
   8++9006 21 00 8F     	ld hl,memorystreampages
   9++9009 22 0E 90     	ld (memorystreampageaddr),hl
  10++900C C9           	ret
  11++900D
  12++900D              memorystreamnextpage
  13++900D              memorystreampageaddr=$+1
  14++900D 21 00 00     	ld hl,0
  15++9010 F5           	push af
  16++9011 7E           	ld a,(hl)
  17++9012 23           	inc hl
  18++9013 32 7C 96     	ld (memorystreamcurrentpage),a
  19++9016 22 0E 90     	ld (memorystreampageaddr),hl
  20++9019 C5           	push bc
  21++901A                      IF AREA_C000_FFFF=1
  22++901A              	;SETPGC000
  23++901A              	OS_SET_PAGE_SLOT3
  23++901A 0E 1C       >    ld c,#1c
  23++901C E7          >    rst #20
  24++901D C1           	pop bc
  25++901E F1           	pop af
  26++901F 21 00 C0     	ld hl,0xC000
  27++9022                      ELSE
  28++9022 ~                    SETPG8000
  29++9022 ~                    pop bc
  30++9022 ~                    pop af
  31++9022 ~                    ld hl,0x8000
  32++9022                      ENDIF
  33++9022 C9           	ret
  34++9023
  35++9023              memorystreamskip
  36++9023              ;b = byte count
  37++9023 2A 72 90     	ld hl,(memorystreamcurrentaddr)
  38++9026              .loop
  39++9026 CB 74        	bit 6,h
  40++9028                      IF AREA_C000_FFFF=1
  41++9028 CC 0D 90     	call z,memorystreamnextpage
  42++902B                      ELSE
  43++902B ~             	call nz,memorystreamnextpage
  44++902B                      ENDIF
  45++902B 23           	inc hl
  46++902C 10 F8        	djnz .loop
  47++902E 22 72 90     	ld (memorystreamcurrentaddr),hl
  48++9031 C9           	ret
  49++9032
  50++9032              	macro memory_stream_write_byte src
  51++9032 ~            	bit 6,h
  52++9032 ~                    IF AREA_C000_FFFF=1
  53++9032 ~            	call z,memorystreamnextpage
  54++9032 ~                    ELSE
  55++9032 ~             	call nz,memorystreamnextpage
  56++9032 ~                    ENDIF
  57++9032 ~            	ld (hl),src
  58++9032 ~            	inc hl
  59++9032              	endm
  60++9032
  61++9032              	macro memory_stream_read_byte dest
  62++9032 ~            	bit 6,h
  63++9032 ~                    IF AREA_C000_FFFF=1
  64++9032 ~            	call z,memorystreamnextpage
  65++9032 ~                    ELSE
  66++9032 ~             	call nz,memorystreamnextpage
  67++9032 ~                    ENDIF
  68++9032 ~            	ld dest,(hl)
  69++9032 ~            	inc hl
  70++9032              	endm
  71++9032
  72++9032              	macro memory_stream_read_1 dst
  73++9032 ~            	ld hl,(memorystreamcurrentaddr)
  74++9032 ~            	memory_stream_read_byte dst
  75++9032 ~            	ld (memorystreamcurrentaddr),hl
  76++9032              	endm
  77++9032
  78++9032              	macro memory_stream_read_2 dst1,dst2
  79++9032 ~            	ld hl,(memorystreamcurrentaddr)
  80++9032 ~            	memory_stream_read_byte dst1
  81++9032 ~            	memory_stream_read_byte dst2
  82++9032 ~            	ld (memorystreamcurrentaddr),hl
  83++9032              	endm
  84++9032
  85++9032              	macro memory_stream_read_3 dst1,dst2,dst3
  86++9032 ~            	ld hl,(memorystreamcurrentaddr)
  87++9032 ~            	memory_stream_read_byte dst1
  88++9032 ~            	memory_stream_read_byte dst2
  89++9032 ~            	memory_stream_read_byte dst3
  90++9032 ~            	ld (memorystreamcurrentaddr),hl
  91++9032              	endm
  92++9032
  93++9032              memorystreamread1
  94++9032              ;out: a = byte
  95++9032              	memory_stream_read_1 a
  95++9032 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
  95++9035             >	memory_stream_read_byte a
  95++9035 CB 74       >	bit 6,h
  95++9037             >        IF AREA_C000_FFFF=1
  95++9037 CC 0D 90    >	call z,memorystreamnextpage
  95++903A             >        ELSE
  95++903A ~           > 	call nz,memorystreamnextpage
  95++903A             >        ENDIF
  95++903A 7E          >	ld a,(hl)
  95++903B 23          >	inc hl
  95++903C 22 72 90    >	ld (memorystreamcurrentaddr),hl
  96++903F C9           	ret
  97++9040
  98++9040              memorystreamread2
  99++9040              ;out: de = word
 100++9040              	memory_stream_read_2 e,d
 100++9040 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 100++9043             >	memory_stream_read_byte e
 100++9043 CB 74       >	bit 6,h
 100++9045             >        IF AREA_C000_FFFF=1
 100++9045 CC 0D 90    >	call z,memorystreamnextpage
 100++9048             >        ELSE
 100++9048 ~           > 	call nz,memorystreamnextpage
 100++9048             >        ENDIF
 100++9048 5E          >	ld e,(hl)
 100++9049 23          >	inc hl
 100++904A             >	memory_stream_read_byte d
 100++904A CB 74       >	bit 6,h
 100++904C             >        IF AREA_C000_FFFF=1
 100++904C CC 0D 90    >	call z,memorystreamnextpage
 100++904F             >        ELSE
 100++904F ~           > 	call nz,memorystreamnextpage
 100++904F             >        ENDIF
 100++904F 56          >	ld d,(hl)
 100++9050 23          >	inc hl
 100++9051 22 72 90    >	ld (memorystreamcurrentaddr),hl
 101++9054 C9           	ret
 102++9055
 103++9055              memorystreamread3
 104++9055              ;out: c = byte0, e = byte1, d = byte2
 105++9055              	memory_stream_read_3 c,e,d
 105++9055 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 105++9058             >	memory_stream_read_byte c
 105++9058 CB 74       >	bit 6,h
 105++905A             >        IF AREA_C000_FFFF=1
 105++905A CC 0D 90    >	call z,memorystreamnextpage
 105++905D             >        ELSE
 105++905D ~           > 	call nz,memorystreamnextpage
 105++905D             >        ENDIF
 105++905D 4E          >	ld c,(hl)
 105++905E 23          >	inc hl
 105++905F             >	memory_stream_read_byte e
 105++905F CB 74       >	bit 6,h
 105++9061             >        IF AREA_C000_FFFF=1
 105++9061 CC 0D 90    >	call z,memorystreamnextpage
 105++9064             >        ELSE
 105++9064 ~           > 	call nz,memorystreamnextpage
 105++9064             >        ENDIF
 105++9064 5E          >	ld e,(hl)
 105++9065 23          >	inc hl
 105++9066             >	memory_stream_read_byte d
 105++9066 CB 74       >	bit 6,h
 105++9068             >        IF AREA_C000_FFFF=1
 105++9068 CC 0D 90    >	call z,memorystreamnextpage
 105++906B             >        ELSE
 105++906B ~           > 	call nz,memorystreamnextpage
 105++906B             >        ENDIF
 105++906B 56          >	ld d,(hl)
 105++906C 23          >	inc hl
 105++906D 22 72 90    >	ld (memorystreamcurrentaddr),hl
 106++9070 C9           	ret
 107++9071
 108++9071              memorystreamread4
 109++9071              ;out: adbc = dword
 110++9071              memorystreamcurrentaddr=$+1
 111++9071 21 00 00     	ld hl,0
 112++9074              	memory_stream_read_byte c
 112++9074 CB 74       >	bit 6,h
 112++9076             >        IF AREA_C000_FFFF=1
 112++9076 CC 0D 90    >	call z,memorystreamnextpage
 112++9079             >        ELSE
 112++9079 ~           > 	call nz,memorystreamnextpage
 112++9079             >        ENDIF
 112++9079 4E          >	ld c,(hl)
 112++907A 23          >	inc hl
 113++907B              	memory_stream_read_byte b
 113++907B CB 74       >	bit 6,h
 113++907D             >        IF AREA_C000_FFFF=1
 113++907D CC 0D 90    >	call z,memorystreamnextpage
 113++9080             >        ELSE
 113++9080 ~           > 	call nz,memorystreamnextpage
 113++9080             >        ENDIF
 113++9080 46          >	ld b,(hl)
 113++9081 23          >	inc hl
 114++9082              	memory_stream_read_byte d
 114++9082 CB 74       >	bit 6,h
 114++9084             >        IF AREA_C000_FFFF=1
 114++9084 CC 0D 90    >	call z,memorystreamnextpage
 114++9087             >        ELSE
 114++9087 ~           > 	call nz,memorystreamnextpage
 114++9087             >        ENDIF
 114++9087 56          >	ld d,(hl)
 114++9088 23          >	inc hl
 115++9089              	memory_stream_read_byte a
 115++9089 CB 74       >	bit 6,h
 115++908B             >        IF AREA_C000_FFFF=1
 115++908B CC 0D 90    >	call z,memorystreamnextpage
 115++908E             >        ELSE
 115++908E ~           > 	call nz,memorystreamnextpage
 115++908E             >        ENDIF
 115++908E 7E          >	ld a,(hl)
 115++908F 23          >	inc hl
 116++9090 22 72 90     	ld (memorystreamcurrentaddr),hl
 117++9093 C9           	ret
 118++9094
 119++9094              memorystreamread
 120++9094              ;bc = number of bytes
 121++9094              ;de = dest addr
 122++9094 79           	ld a,c
 123++9095 0B           	dec bc
 124++9096 04           	inc b
 125++9097 48           	ld c,b
 126++9098 47           	ld b,a
 127++9099 2A 72 90     	ld hl,(memorystreamcurrentaddr)
 128++909C              .readloop
 129++909C              	memory_stream_read_byte a
 129++909C CB 74       >	bit 6,h
 129++909E             >        IF AREA_C000_FFFF=1
 129++909E CC 0D 90    >	call z,memorystreamnextpage
 129++90A1             >        ELSE
 129++90A1 ~           > 	call nz,memorystreamnextpage
 129++90A1             >        ENDIF
 129++90A1 7E          >	ld a,(hl)
 129++90A2 23          >	inc hl
 130++90A3 12           	ld (de),a
 131++90A4 13           	inc de
 132++90A5 10 F5        	djnz .readloop
 133++90A7 0D           	dec c
 134++90A8 20 F2        	jr nz,.readloop
 135++90AA 22 72 90     	ld (memorystreamcurrentaddr),hl
 136++90AD C9           	ret
 137++90AE
 138++90AE              memorystreamwrite
 139++90AE              ;bc = number of bytes
 140++90AE              ;de = src addr
 141++90AE 79           	ld a,c
 142++90AF 0B           	dec bc
 143++90B0 04           	inc b
 144++90B1 48           	ld c,b
 145++90B2 47           	ld b,a
 146++90B3 2A 72 90     	ld hl,(memorystreamcurrentaddr)
 147++90B6              .writeloop
 148++90B6 1A           	ld a,(de)
 149++90B7              	memory_stream_write_byte a
 149++90B7 CB 74       >	bit 6,h
 149++90B9             >        IF AREA_C000_FFFF=1
 149++90B9 CC 0D 90    >	call z,memorystreamnextpage
 149++90BC             >        ELSE
 149++90BC ~           > 	call nz,memorystreamnextpage
 149++90BC             >        ENDIF
 149++90BC 77          >	ld (hl),a
 149++90BD 23          >	inc hl
 150++90BE 13           	inc de
 151++90BF 10 F5        	djnz .writeloop
 152++90C1 0D           	dec c
 153++90C2 20 F2        	jr nz,.writeloop
 154++90C4 22 72 90     	ld (memorystreamcurrentaddr),hl
 155++90C7 C9           	ret
 156++90C8
 157++90C8              memorystreamseek
 158++90C8              ;dehl = absolute position
 159++90C8              ;out: hl = read address
 160++90C8 7B           	ld a,e
 161++90C9 44           	ld b,h
 162++90CA CB 20        	sla b
 163++90CC 17           	rla
 164++90CD CB 20        	sla b
 165++90CF 17           	rla
 166++90D0 C6 00        	add a,memorystreampages%256
 167++90D2 5F           	ld e,a
 168++90D3 CE 8F        	adc a,memorystreampages/256
 169++90D5 93           	sub e
 170++90D6 57           	ld d,a
 171++90D7 1A           	ld a,(de)
 172++90D8 32 7C 96     	ld (memorystreamcurrentpage),a
 173++90DB 13           	inc de
 174++90DC ED 53 0E 90  	ld (memorystreampageaddr),de
 175++90E0                      IF AREA_C000_FFFF=1
 176++90E0              	;SETPGC000
 177++90E0 E5           	push hl ;*
 178++90E1              	OS_SET_PAGE_SLOT3
 178++90E1 0E 1C       >    ld c,#1c
 178++90E3 E7          >    rst #20
 179++90E4 E1           	pop hl ;*
 180++90E5 CB F4                set 6,h
 181++90E7                      ELSE
 182++90E7 ~            	SETPG8000
 183++90E7 ~            	res 6,h
 184++90E7                      ENDIF
 185++90E7 CB FC        	set 7,h
 186++90E9 22 72 90     	ld (memorystreamcurrentaddr),hl
 187++90EC C9           	ret
 188++90ED
 189++90ED              memorystreamgetpos
 190++90ED              ;out: dehl = absolute position
 191++90ED 2A 0E 90     	ld hl,(memorystreampageaddr)
 192++90F0 11 FF 70     	ld de,-memorystreampages-1
 193++90F3 19           	add hl,de
 194++90F4 EB           	ex de,hl
 195++90F5 2A 72 90     	ld hl,(memorystreamcurrentaddr)
 196++90F8
 197++90F8                      IF AREA_C000_FFFF=1
 198++90F8 CB 7C                bit 7,h
 199++90FA CB BC                res 7,h
 200++90FC CB B4                res 6,h
 201++90FE 20 04        	jr nz,$+6
 202++9100                      ELSE
 203++9100 ~            	res 7,h
 204++9100 ~            	bit 6,h
 205++9100 ~            ;	jr z,$+6
 206++9100                      ENDIF
 207++9100 20 04        	jr nz,$+6
 208++9102 13           	inc de
 209++9103 21 00 00     	ld hl,0
 210++9106 AF           	xor a
 211++9107 CB 1B        	rr e
 212++9109 1F           	rra
 213++910A CB 1B        	rr e
 214++910C 1F           	rra
 215++910D B4           	or h
 216++910E 67           	ld h,a
 217++910F C9           	ret
 218++9110
 219++9110              memorystreamsize
 220++9110 00 00 00 00  	ds 4
 221++9114
# file closed: GPlay/common/memorystream.asm
  74++9114              	include "common/opl4.asm"
# file opened: GPlay/common/opl4.asm
   1++9114              	include "moonsound.asm"
# file opened: GPlay/common/moonsound.asm
   1++9114              MOON_BASE_HI = 0x00 ;старший байт
   2++9114              MOON_BASE = 0x24 ;0xc4
   3++9114              MOON_REG1 = MOON_BASE
   4++9114              MOON_DAT1 = MOON_BASE+1  ;c5
   5++9114              MOON_REG2 = MOON_BASE+2  ;c6
   6++9114              MOON_DAT2 = MOON_BASE+3  ;c7
   7++9114              MOON_STAT = MOON_BASE
   8++9114              MOON_WREG = 0xc2
   9++9114              MOON_WDAT = MOON_WREG+1
  10++9114
  11++9114              ;TODO: is this good enough for ATM2?
  12++9114              	macro opl4_wait
  13++9114 ~            	ld a,MOON_BASE_HI
  14++9114 ~            	in a,(MOON_STAT)
  15++9114 ~            	rrca
  16++9114 ~            	jr c,$-3
  17++9114              	endm
  18++9114
  19++9114              ;makes ZXM-Moonsound firmware 1.01 switch PCM ports from default 7E and 7F to C2 and C3
  20++9114              	macro switch_to_pcm_ports_c2_c3
  21++9114 ~            	ld a,MOON_BASE_HI
  22++9114 ~            	in a,(MOON_REG2)
  23++9114              	endm
  24++9114
  25++9114
  26++9114
  27++9114              NR_OF_MIDI_CHANNELS = 16
  28++9114              NR_OF_WAVE_CHANNELS = 24
  29++9114
  30++9114
  31++9114
  32++9114              MOONSOUNDROMSIZE = 0x200000
  33++9114              MOONWAVEHEADERSIZE = 12
  34++9114              MOONRAMWAVETABLESIZE = 128
  35++9114              OPL4MAXWAVECHANNELS = NR_OF_WAVE_CHANNELS
  36++9114
  37++9114              OPL4_TIMER1_COUNT   = 0x02
  38++9114              OPL4_TIMER2_COUNT   = 0x03
  39++9114              OPL4_TIMER_CONTROL  = 0x04
  40++9114
  41++9114
  42++9114
  43++9114
  44++9114              OPL4_REG_TEST0               = 0x00
  45++9114              OPL4_REG_TEST1               = 0x01
  46++9114
  47++9114              OPL4_REG_MEMORY_CONFIGURATION = 0x02
  48++9114              OPL4_MODE_BIT                 = 0x01
  49++9114              OPL4_MTYPE_BIT                = 0x02
  50++9114              OPL4_TONE_HEADER_MASK         = 0x1C
  51++9114              OPL4_DEVICE_ID_MASK           = 0xE0
  52++9114
  53++9114              OPL4_REG_MEMORY_ADDRESS_HIGH  = 0x03
  54++9114              OPL4_REG_MEMORY_ADDRESS_MID   = 0x04
  55++9114              OPL4_REG_MEMORY_ADDRESS_LOW   = 0x05
  56++9114              OPL4_REG_MEMORY_DATA          = 0x06
  57++9114
  58++9114 ~            /*
  59++9114 ~             * Offsets to the register banks for voices. To get the
  60++9114 ~             * register number just add the voice number to the bank offset.
  61++9114 ~             *
  62++9114 ~             * Wave Table Number low bits (0x08 to 0x1F)
  63++9114 ~             */
  64++9114              OPL4_REG_TONE_NUMBER  = 0x08
  65++9114
  66++9114 ~            /* Wave Table Number high bit, F-Number low bits (0x20 to 0x37) */
  67++9114              OPL4_REG_F_NUMBER      = 0x20
  68++9114              OPL4_TONE_NUMBER_BIT8  = 0x01
  69++9114              OPL4_F_NUMBER_LOW_MASK = 0xFE
  70++9114
  71++9114 ~            /* F-Number high bits, Octave, Pseudo-Reverb (0x38 to 0x4F) */
  72++9114              OPL4_REG_OCTAVE         = 0x38
  73++9114              OPL4_F_NUMBER_HIGH_MASK = 0x07
  74++9114              OPL4_BLOCK_MASK         = 0xF0
  75++9114              OPL4_PSEUDO_REVERB_BIT  = 0x08
  76++9114
  77++9114 ~            /* Total Level, Level Direct (0x50 to 0x67) */
  78++9114              OPL4_REG_LEVEL        = 0x50
  79++9114              OPL4_TOTAL_LEVEL_MASK = 0xFE
  80++9114              OPL4_LEVEL_DIRECT_BIT = 0x01
  81++9114
  82++9114 ~            /* Key On, Damp, LFO RST, CH, Panpot (0x68 to 0x7F) */
  83++9114              OPL4_REG_MISC           = 0x68
  84++9114              OPL4_KEY_ON_BIT         = 0x80
  85++9114              OPL4_DAMP_BIT           = 0x40
  86++9114              OPL4_LFO_RESET_BIT      = 0x20
  87++9114              OPL4_OUTPUT_CHANNEL_BIT = 0x10
  88++9114              OPL4_PAN_POT_MASK       = 0x0F
  89++9114
  90++9114 ~            /* LFO, VIB (0x80 to 0x97) */
  91++9114              OPL4_REG_LFO_VIBRATO    = 0x80
  92++9114              OPL4_LFO_FREQUENCY_MASK = 0x38
  93++9114              OPL4_VIBRATO_DEPTH_MASK = 0x07
  94++9114              OPL4_CHORUS_SEND_MASK   = 0xC0
  95++9114
  96++9114 ~            /* Attack / Decay 1 rate (0x98 to 0xAF) */
  97++9114              OPL4_REG_ATTACK_DECAY1  = 0x98
  98++9114              OPL4_ATTACK_RATE_MASK   = 0xF0
  99++9114              OPL4_DECAY1_RATE_MASK   = 0x0F
 100++9114
 101++9114 ~            /* Decay level / 2 rate (0xB0 to 0xC7) */
 102++9114              OPL4_REG_LEVEL_DECAY2  = 0xB0
 103++9114              OPL4_DECAY_LEVEL_MASK  = 0xF0
 104++9114              OPL4_DECAY2_RATE_MASK  = 0x0F
 105++9114
 106++9114 ~            /* Release rate / Rate correction (0xC8 to 0xDF) */
 107++9114              OPL4_REG_RELEASE_CORRECTION  = 0xC8
 108++9114              OPL4_RELEASE_RATE_MASK       = 0x0F
 109++9114              OPL4_RATE_INTERPOLATION_MASK = 0xF0
 110++9114
 111++9114 ~            /* AM (0xE0 to 0xF7) */
 112++9114              OPL4_REG_TREMOLO        = 0xE0
 113++9114              OPL4_TREMOLO_DEPTH_MASK = 0x07
 114++9114              OPL4_REVERB_SEND_MASK   = 0xE0
 115++9114
 116++9114 ~            /* Mixer */
 117++9114              OPL4_REG_MIX_CONTROL_FM  = 0xF8
 118++9114              OPL4_REG_MIX_CONTROL_PCM = 0xF9
 119++9114              OPL4_MIX_LEFT_MASK       = 0x07
 120++9114              OPL4_MIX_RIGHT_MASK      = 0x38
 121++9114
 122++9114              OPL4_REG_ATC             = 0xFA
 123++9114              OPL4_ATC_BIT             = 0x01
 124++9114
 125++9114 ~            /* Bits in the OPL4 Status register */
 126++9114              OPL4_STATUS_BUSY = 0x01
 127++9114              OPL4_STATUS_LOAD = 0x02
 128++9114
# file closed: GPlay/common/moonsound.asm
   2++9114
   3++9114              opl4writefm1
   4++9114              ;e = register
   5++9114              ;d = value
   6++9114              	opl4_wait
   6++9114 3E 00       >	ld a,MOON_BASE_HI
   6++9116 DB 24       >	in a,(MOON_STAT)
   6++9118 0F          >	rrca
   6++9119 38 FB       >	jr c,$-3
   7++911B 7B           	ld a,e
   8++911C C5           	push bc
   9++911D 06 00        	ld b,MOON_BASE_HI
  10++911F 0E 24        	ld c,MOON_REG1
  11++9121 ED 79        	out (c),a
  12++9123              	opl4_wait
  12++9123 3E 00       >	ld a,MOON_BASE_HI
  12++9125 DB 24       >	in a,(MOON_STAT)
  12++9127 0F          >	rrca
  12++9128 38 FB       >	jr c,$-3
  13++912A 7A           	ld a,d
  14++912B 06 00        	ld b,MOON_BASE_HI
  15++912D 0E 25        	ld c,MOON_DAT1
  16++912F ED 79        	out (c),a
  17++9131 C1           	pop bc
  18++9132 C9           	ret
  19++9133
  20++9133              opl4writefm2
  21++9133              ;e = register
  22++9133              ;d = value
  23++9133              	opl4_wait
  23++9133 3E 00       >	ld a,MOON_BASE_HI
  23++9135 DB 24       >	in a,(MOON_STAT)
  23++9137 0F          >	rrca
  23++9138 38 FB       >	jr c,$-3
  24++913A 7B           	ld a,e
  25++913B C5           	push bc
  26++913C 06 00        	ld b,MOON_BASE_HI
  27++913E 0E 26        	ld c,MOON_REG2
  28++9140 ED 79        	out (c),a
  29++9142              	opl4_wait
  29++9142 3E 00       >	ld a,MOON_BASE_HI
  29++9144 DB 24       >	in a,(MOON_STAT)
  29++9146 0F          >	rrca
  29++9147 38 FB       >	jr c,$-3
  30++9149 7A           	ld a,d
  31++914A 06 00        	ld b,MOON_BASE_HI
  32++914C 0E 27        	ld c,MOON_DAT2
  33++914E ED 79        	out (c),a
  34++9150 C1           	pop bc
  35++9151 C9           	ret
  36++9152
  37++9152              opl4writewave
  38++9152              ;e = register
  39++9152              ;d = value
  40++9152              	opl4_wait
  40++9152 3E 00       >	ld a,MOON_BASE_HI
  40++9154 DB 24       >	in a,(MOON_STAT)
  40++9156 0F          >	rrca
  40++9157 38 FB       >	jr c,$-3
  41++9159 7B           	ld a,e
  42++915A C5           	push bc
  43++915B 06 00        	ld b,MOON_BASE_HI
  44++915D 0E C2        	ld c,MOON_WREG
  45++915F ED 79        	out (c),a
  46++9161              	opl4_wait
  46++9161 3E 00       >	ld a,MOON_BASE_HI
  46++9163 DB 24       >	in a,(MOON_STAT)
  46++9165 0F          >	rrca
  46++9166 38 FB       >	jr c,$-3
  47++9168 7A           	ld a,d
  48++9169 06 00        	ld b,MOON_BASE_HI
  49++916B 0E C3        	ld c,MOON_WDAT
  50++916D ED 79        	out (c),a
  51++916F C1           	pop bc
  52++9170 C9           	ret
  53++9171
  54++9171              opl4readwave
  55++9171              ;e = register
  56++9171              	opl4_wait
  56++9171 3E 00       >	ld a,MOON_BASE_HI
  56++9173 DB 24       >	in a,(MOON_STAT)
  56++9175 0F          >	rrca
  56++9176 38 FB       >	jr c,$-3
  57++9178 7B           	ld a,e
  58++9179 C5           	push bc
  59++917A 06 00        	ld b,MOON_BASE_HI
  60++917C 0E C2        	ld c,MOON_WREG
  61++917E ED 79        	out (c),a
  62++9180 C1           	pop bc
  63++9181              	opl4_wait
  63++9181 3E 00       >	ld a,MOON_BASE_HI
  63++9183 DB 24       >	in a,(MOON_STAT)
  63++9185 0F          >	rrca
  63++9186 38 FB       >	jr c,$-3
  64++9188 3E 00        	ld a,MOON_BASE_HI
  65++918A DB C3        	in a,(MOON_WDAT)
  66++918C C9           	ret
  67++918D
  68++918D              	macro opl4_write_fm_regs
  69++918D ~            ;e = base register
  70++918D ~            ;d = value
  71++918D ~            ;b = count
  72++918D ~            .loop
  73++918D ~            	call opl4writefm1
  74++918D ~            	call opl4writefm2
  75++918D ~            	inc e
  76++918D ~            	djnz .loop
  77++918D              	endm
  78++918D
  79++918D              	macro opl4_write_wave_regs
  80++918D ~            ;e = base register
  81++918D ~            ;d = value
  82++918D ~            ;b = count
  83++918D ~            .loop
  84++918D ~            	call opl4writewave
  85++918D ~            	inc e
  86++918D ~            	djnz .loop
  87++918D              	endm
  88++918D
  89++918D              opl4init
  90++918D 11 05 03     	ld de,0x0305
  91++9190 CD 33 91     	call opl4writefm2
  92++9193 06 DA        	ld b,0xda
  93++9195 11 20 00     	ld de,0x0020
  94++9198              	opl4_write_wave_regs
  94++9198             >;e = base register
  94++9198             >;d = value
  94++9198             >;b = count
  94++9198             >.loop
  94++9198 CD 52 91    >	call opl4writewave
  94++919B 1C          >	inc e
  94++919C 10 FA       >	djnz .loop
  95++919E 11 F8 1B     	ld de,0x1bf8
  96++91A1 CD 52 91     	call opl4writewave
  97++91A4 11 02 10     	ld de,0x1002
  98++91A7 CD 52 91     	call opl4writewave
  99++91AA 06 D6        	ld b,0xd6
 100++91AC 11 20 00     	ld de,0x0020
 101++91AF              	opl4_write_fm_regs
 101++91AF             >;e = base register
 101++91AF             >;d = value
 101++91AF             >;b = count
 101++91AF             >.loop
 101++91AF CD 14 91    >	call opl4writefm1
 101++91B2 CD 33 91    >	call opl4writefm2
 101++91B5 1C          >	inc e
 101++91B6 10 F7       >	djnz .loop
 102++91B8 11 01 00     	ld de,0x0001
 103++91BB CD 14 91     	call opl4writefm1
 104++91BE 11 08 00     	ld de,0x0008
 105++91C1 CD 14 91     	call opl4writefm1
 106++91C4 11 04 00     	ld de,0x0004
 107++91C7 C3 33 91     	jp opl4writefm2
 108++91CA
 109++91CA              opl4stoptimers
 110++91CA 11 04 80     	ld de,0x8004
 111++91CD CD 14 91     	call opl4writefm1
 112++91D0 11 04 00     	ld de,0x0004
 113++91D3 C3 14 91     	jp opl4writefm1
 114++91D6
 115++91D6              opl4mute
 116++91D6 CD CA 91     	call opl4stoptimers
 117++91D9 11 04 00     	ld de,0x0004
 118++91DC CD 33 91     	call opl4writefm2
 119++91DF 11 BD 00     	ld de,0x00bd
 120++91E2 CD 14 91     	call opl4writefm1 ;rhythm off
 121++91E5 06 16        	ld b,0x16
 122++91E7 11 80 0F     	ld de,0x0f80
 123++91EA              	opl4_write_fm_regs ;max release rate
 123++91EA             >;e = base register
 123++91EA             >;d = value
 123++91EA             >;b = count
 123++91EA             >.loop
 123++91EA CD 14 91    >	call opl4writefm1
 123++91ED CD 33 91    >	call opl4writefm2
 123++91F0 1C          >	inc e
 123++91F1 10 F7       >	djnz .loop
 124++91F3 06 16        	ld b,0x16
 125++91F5 11 40 3F     	ld de,0x3f40
 126++91F8              	opl4_write_fm_regs ;min total level
 126++91F8             >;e = base register
 126++91F8             >;d = value
 126++91F8             >;b = count
 126++91F8             >.loop
 126++91F8 CD 14 91    >	call opl4writefm1
 126++91FB CD 33 91    >	call opl4writefm2
 126++91FE 1C          >	inc e
 126++91FF 10 F7       >	djnz .loop
 127++9201 06 09        	ld b,0x09
 128++9203 11 A0 00     	ld de,0x00a0
 129++9206              	opl4_write_fm_regs ;frequency 0
 129++9206             >;e = base register
 129++9206             >;d = value
 129++9206             >;b = count
 129++9206             >.loop
 129++9206 CD 14 91    >	call opl4writefm1
 129++9209 CD 33 91    >	call opl4writefm2
 129++920C 1C          >	inc e
 129++920D 10 F7       >	djnz .loop
 130++920F 06 09        	ld b,0x09
 131++9211 11 B0 00     	ld de,0x00b0
 132++9214              	opl4_write_fm_regs ;key off
 132++9214             >;e = base register
 132++9214             >;d = value
 132++9214             >;b = count
 132++9214             >.loop
 132++9214 CD 14 91    >	call opl4writefm1
 132++9217 CD 33 91    >	call opl4writefm2
 132++921A 1C          >	inc e
 132++921B 10 F7       >	djnz .loop
 133++921D 06 18        	ld b,0x18
 134++921F 11 68 40     	ld de,0x4068
 135++9222              	opl4_write_wave_regs ;key off, damp
 135++9222             >;e = base register
 135++9222             >;d = value
 135++9222             >;b = count
 135++9222             >.loop
 135++9222 CD 52 91    >	call opl4writewave
 135++9225 1C          >	inc e
 135++9226 10 FA       >	djnz .loop
 136++9228 11 05 00     	ld de,0x0005
 137++922B C3 33 91     	jp opl4writefm2
 138++922E
 139++922E              opl4setmemoryaddress
 140++922E              ;dhl = memory address
 141++922E 1E 03        	ld e,0x03
 142++9230 CD 52 91     	call opl4writewave
 143++9233 54           	ld d,h
 144++9234 1C           	inc e
 145++9235 CD 52 91     	call opl4writewave
 146++9238 1C           	inc e
 147++9239 55           	ld d,l
 148++923A C3 52 91     	jp opl4writewave
 149++923D
 150++923D              opl4readmemory
 151++923D              ;bc = byte count
 152++923D              ;dhl = memory address
 153++923D              ;ix = buffer
 154++923D CD 2E 92     	call opl4setmemoryaddress
 155++9240 11 02 11     	ld de,0x1102
 156++9243 CD 52 91     	call opl4writewave
 157++9246              	opl4_wait
 157++9246 3E 00       >	ld a,MOON_BASE_HI
 157++9248 DB 24       >	in a,(MOON_STAT)
 157++924A 0F          >	rrca
 157++924B 38 FB       >	jr c,$-3
 158++924D 3E 06        	ld a,6
 159++924F C5           	push bc
 160++9250 06 00        	ld b,MOON_BASE_HI
 161++9252 0E C2        	ld c,MOON_WREG
 162++9254 ED 79        	out (c),a
 163++9256 C1           	pop bc
 164++9257 DD 54 DD 5D  	ld de,ix
 165++925B 79           	ld a,c
 166++925C 0B           	dec bc
 167++925D 04           	inc b
 168++925E 48           	ld c,b
 169++925F 47           	ld b,a
 170++9260              .readloop
 171++9260              	opl4_wait
 171++9260 3E 00       >	ld a,MOON_BASE_HI
 171++9262 DB 24       >	in a,(MOON_STAT)
 171++9264 0F          >	rrca
 171++9265 38 FB       >	jr c,$-3
 172++9267 3E 00        	ld a,MOON_BASE_HI
 173++9269 DB C3        	in a,(MOON_WDAT)
 174++926B 12           	ld (de),a
 175++926C 13           	inc de
 176++926D 10 F1        	djnz .readloop
 177++926F 0D           	dec c
 178++9270 20 EE        	jr nz,.readloop
 179++9272 11 02 10     	ld de,0x1002
 180++9275 C3 52 91     	jp opl4writewave
 181++9278
 182++9278              opl4writememory
 183++9278              ;bc = number of bytes
 184++9278              ;dhl = memory address
 185++9278              ;ix = buffer
 186++9278 CD 2E 92     	call opl4setmemoryaddress
 187++927B 11 02 11     	ld de,0x1102
 188++927E CD 52 91     	call opl4writewave
 189++9281              	opl4_wait
 189++9281 3E 00       >	ld a,MOON_BASE_HI
 189++9283 DB 24       >	in a,(MOON_STAT)
 189++9285 0F          >	rrca
 189++9286 38 FB       >	jr c,$-3
 190++9288 3E 06        	ld a,6
 191++928A C5           	push bc
 192++928B 06 00        	ld b,MOON_BASE_HI
 193++928D 0E C2        	ld c,MOON_WREG
 194++928F ED 79        	out (c),a
 195++9291 C1           	pop bc
 196++9292 DD 54 DD 5D  	ld de,ix
 197++9296 79           	ld a,c
 198++9297 0B           	dec bc
 199++9298 04           	inc b
 200++9299 48           	ld c,b
 201++929A 47           	ld b,a
 202++929B              .writeloop
 203++929B              	opl4_wait
 203++929B 3E 00       >	ld a,MOON_BASE_HI
 203++929D DB 24       >	in a,(MOON_STAT)
 203++929F 0F          >	rrca
 203++92A0 38 FB       >	jr c,$-3
 204++92A2 1A           	ld a,(de)
 205++92A3 C5           	push bc
 206++92A4 06 00        	ld b,MOON_BASE_HI
 207++92A6 0E C3        	ld c,MOON_WDAT
 208++92A8 ED 79        	out (c),a
 209++92AA C1           	pop bc
 210++92AB 13           	inc de
 211++92AC 10 ED        	djnz .writeloop
 212++92AE 0D           	dec c
 213++92AF 20 EA        	jr nz,.writeloop
 214++92B1 11 02 10     	ld de,0x1002
 215++92B4 C3 52 91     	jp opl4writewave
 216++92B7
# file closed: GPlay/common/opl4.asm
  75++92B7              	include "common/opm.asm"
# file opened: GPlay/common/opm.asm
   1++92B7              ;Having chip 0 is mandatory for the player to detect YM2151,
   2++92B7              ;chip 1 is an optional second chip.
   3++92B7
   4++92B7              OPM0_REG = 0xf0c1 ;write: chip 0 address
   5++92B7              OPM0_DAT = 0xf1c1 ;write: chip 0 value, read: chip 0 status
   6++92B7              OPM1_REG = 0xf2c1 ;write: chip 1 address
   7++92B7              OPM1_DAT = 0xf3c1 ;write: chip 1 value, read: chip 1 status
   8++92B7
   9++92B7              	macro opm_write_reg reg,dat
  10++92B7 ~            ;bc = data port
  11++92B7 ~            ;e = register
  12++92B7 ~            ;d = value
  13++92B7 ~            	ld bc,dat
  14++92B7 ~            	in f,(c)
  15++92B7 ~            	jp m,$-2
  16++92B7 ~            	ld bc,reg
  17++92B7 ~            	out (c),e
  18++92B7 ~            	ld bc,dat
  19++92B7 ~            	in f,(c)
  20++92B7 ~            	jp m,$-2
  21++92B7 ~            	out (c),d
  22++92B7              	endm
  23++92B7
  24++92B7              opmwriteall
  25++92B7              ;e = register
  26++92B7              ;d = value
  27++92B7 CD D2 92     	call opmwritechip1
  28++92BA              opmwritechip0
  29++92BA              ;e = register
  30++92BA              ;d = value
  31++92BA              	opm_write_reg OPM0_REG,OPM0_DAT
  31++92BA             >;bc = data port
  31++92BA             >;e = register
  31++92BA             >;d = value
  31++92BA 01 C1 F1    >	ld bc,OPM0_DAT
  31++92BD ED 70       >	in f,(c)
  31++92BF FA BD 92    >	jp m,$-2
  31++92C2 01 C1 F0    >	ld bc,OPM0_REG
  31++92C5 ED 59       >	out (c),e
  31++92C7 01 C1 F1    >	ld bc,OPM0_DAT
  31++92CA ED 70       >	in f,(c)
  31++92CC FA CA 92    >	jp m,$-2
  31++92CF ED 51       >	out (c),d
  32++92D1 C9           	ret
  33++92D2
  34++92D2              opmwritechip1
  35++92D2              ;e = register
  36++92D2              ;d = value
  37++92D2              	opm_write_reg OPM1_REG,OPM1_DAT
  37++92D2             >;bc = data port
  37++92D2             >;e = register
  37++92D2             >;d = value
  37++92D2 01 C1 F3    >	ld bc,OPM1_DAT
  37++92D5 ED 70       >	in f,(c)
  37++92D7 FA D5 92    >	jp m,$-2
  37++92DA 01 C1 F2    >	ld bc,OPM1_REG
  37++92DD ED 59       >	out (c),e
  37++92DF 01 C1 F3    >	ld bc,OPM1_DAT
  37++92E2 ED 70       >	in f,(c)
  37++92E4 FA E2 92    >	jp m,$-2
  37++92E7 ED 51       >	out (c),d
  38++92E9 C9           	ret
  39++92EA
  40++92EA              opmdisablechip1
  41++92EA 3E C9        	ld a,0xc9 ;ret opcode
  42++92EC 32 D2 92     	ld (opmwritechip1),a
  43++92EF C9           	ret
  44++92F0
  45++92F0              	macro opm_write_regs incr,incd
  46++92F0 ~            ;e = base register
  47++92F0 ~            ;d = value
  48++92F0 ~            ;l = count
  49++92F0 ~            .loop	call opmwriteall
  50++92F0 ~            	IF incr
  51++92F0 ~            	inc e
  52++92F0 ~            	ENDIF
  53++92F0 ~            	IF incd
  54++92F0 ~            	inc d
  55++92F0 ~            	ENDIF
  56++92F0 ~            	dec l
  57++92F0 ~            	jr nz,.loop
  58++92F0              	endm
  59++92F0
  60++92F0              opminit
  61++92F0 2E 00        	ld l,0
  62++92F2 11 00 00     	ld de,0
  63++92F5              	opm_write_regs 1,0
  63++92F5             >;e = base register
  63++92F5             >;d = value
  63++92F5             >;l = count
  63++92F5 CD B7 92    >.loop	call opmwriteall
  63++92F8             >	IF 1
  63++92F8 1C          >	inc e
  63++92F9             >	ENDIF
  63++92F9             >	IF 0
  63++92F9 ~           >	inc d
  63++92F9             >	ENDIF
  63++92F9 2D          >	dec l
  63++92FA 20 F9       >	jr nz,.loop
  64++92FC C9           	ret
  65++92FD
  66++92FD              opmstoptimers
  67++92FD 11 14 30     	ld de,0x3014
  68++9300 CD B7 92     	call opmwriteall
  69++9303 11 14 00     	ld de,0x0014
  70++9306 C3 B7 92     	jp opmwriteall
  71++9309
  72++9309              opmmute
  73++9309 CD FD 92     	call opmstoptimers
  74++930C              ;max release rate
  75++930C 2E 20        	ld l,0x20
  76++930E 11 E0 0F     	ld de,0x0fe0
  77++9311              	opm_write_regs 1,0
  77++9311             >;e = base register
  77++9311             >;d = value
  77++9311             >;l = count
  77++9311 CD B7 92    >.loop	call opmwriteall
  77++9314             >	IF 1
  77++9314 1C          >	inc e
  77++9315             >	ENDIF
  77++9315             >	IF 0
  77++9315 ~           >	inc d
  77++9315             >	ENDIF
  77++9315 2D          >	dec l
  77++9316 20 F9       >	jr nz,.loop
  78++9318              ;min total level
  79++9318 2E 20        	ld l,0x20
  80++931A 11 60 7F     	ld de,0x7f60
  81++931D              	opm_write_regs 1,0
  81++931D             >;e = base register
  81++931D             >;d = value
  81++931D             >;l = count
  81++931D CD B7 92    >.loop	call opmwriteall
  81++9320             >	IF 1
  81++9320 1C          >	inc e
  81++9321             >	ENDIF
  81++9321             >	IF 0
  81++9321 ~           >	inc d
  81++9321             >	ENDIF
  81++9321 2D          >	dec l
  81++9322 20 F9       >	jr nz,.loop
  82++9324              ;key off
  83++9324 2E 08        	ld l,0x08
  84++9326 11 08 00     	ld de,0x0008
  85++9329              	opm_write_regs 0,1
  85++9329             >;e = base register
  85++9329             >;d = value
  85++9329             >;l = count
  85++9329 CD B7 92    >.loop	call opmwriteall
  85++932C             >	IF 0
  85++932C ~           >	inc e
  85++932C             >	ENDIF
  85++932C             >	IF 1
  85++932C 14          >	inc d
  85++932D             >	ENDIF
  85++932D 2D          >	dec l
  85++932E 20 F9       >	jr nz,.loop
  86++9330 C9           	ret
  87++9331
# file closed: GPlay/common/opm.asm
  76++9331              	include "vgm/opl4.asm"
# file opened: GPlay/vgm/opl4.asm
   1++9331              WAVEHEADERBUFFERSIZE = MOONRAMWAVETABLESIZE*MOONWAVEHEADERSIZE
   2++9331
   3++9331              opl4writemusiconlyfm1
   4++9331              ;skips writes to control registers
   5++9331              ;e = register
   6++9331              ;d = value
   7++9331 7B           	ld a,e
   8++9332 FE 20        	cp 0x20
   9++9334 D2 14 91     	jp nc,opl4writefm1
  10++9337 FE 08        	cp 0x08
  11++9339 C0           	ret nz
  12++933A C3 14 91     	jp opl4writefm1
  13++933D
  14++933D              opl4writemusiconlyfm2
  15++933D              ;skips writes to control registers
  16++933D              ;e = register
  17++933D              ;d = value
  18++933D 7B           	ld a,e
  19++933E FE 04        	cp 4
  20++9340 D8               ret c
  21++9341 FE 05        	cp 5
  22++9343 C8           	ret z
  23++9344 C3 33 91     	jp opl4writefm2
  24++9347
  25++9347              opl4writewavemusiconly
  26++9347              ;skips writes to control registers and handles ROM dumps
  27++9347              ;e = register
  28++9347              ;d = value
  29++9347 7B           	ld a,e
  30++9348 FE 38        	cp 0x38
  31++934A D2 52 91     	jp nc,opl4writewave
  32++934D FE 08        	cp 0x08
  33++934F D8           	ret c
  34++9350 FE 20        	cp 0x20
  35++9352 38 07        	jr c,writewavetableindexlo
  36++9354              ;force wave table index into 384--511 range if ROM data is loaded
  37++9354              isromloaded=$+1
  38++9354 3E 00        	ld a,0
  39++9356 B2           	or d
  40++9357 57           	ld d,a
  41++9358 C3 52 91     	jp opl4writewave
  42++935B              writewavetableindexlo
  43++935B 3A 55 93     	ld a,(isromloaded)
  44++935E 0F           	rrca
  45++935F B2           	or d
  46++9360 57           	ld d,a
  47++9361 CD 52 91     	call opl4writewave
  48++9364              ;wait for the header to load
  49++9364 3E 00        	ld a,MOON_BASE_HI
  50++9366 DB 24        	in a,(MOON_STAT)
  51++9368 E6 03        	and 3
  52++936A 20 FA        	jr nz,$-4
  53++936C C9           	ret
  54++936D
  55++936D              vgmopl4init
  56++936D AF           	xor a
  57++936E 32 55 93     	ld (isromloaded),a
  58++9371 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
  59++9374 22 B3 93     	ld (opl4loadramdatablockheader.romsize0),hl
  60++9377 3E 20        	ld a,MOONSOUNDROMSIZE/65536
  61++9379 32 B7 93     	ld (opl4loadramdatablockheader.romsize2),a
  62++937C C3 8D 91     	jp opl4init
  63++937F
  64++937F              sub24x16
  65++937F              ;dhl = minuend
  66++937F              ;bc = subtrahend
  67++937F              ;out: cf=1 if negative result, zf=1 if zero
  68++937F B7 ED 42     	sub hl,bc
  69++9382 38 04        	jr c,.carry
  70++9384 C0           	ret nz
  71++9385 7A           	ld a,d
  72++9386 B7           	or a
  73++9387 C9           	ret
  74++9388              .carry
  75++9388 7A           	ld a,d
  76++9389 DE 00        	sbc a,0
  77++938B 57           	ld d,a
  78++938C C0           	ret nz
  79++938D 7D           	ld a,l
  80++938E B4           	or h
  81++938F C9           	ret
  82++9390
  83++9390              opl4loadromdatablockheader
  84++9390              ;dhl = header+data size
  85++9390              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
  86++9390 D9           	exx
  87++9391 CD 71 90     	call memorystreamread4 ;adbc = total rom size
  88++9394 ED 43 B3 93  	ld (opl4loadramdatablockheader.romsize0),bc
  89++9398 7A           	ld a,d
  90++9399 C6 20        	add 0x20 ;place in RAM
  91++939B 32 B7 93     	ld (opl4loadramdatablockheader.romsize2),a
  92++939E CD 71 90     	call memorystreamread4 ;adbc = start address
  93++93A1 60 69        	ld hl,bc
  94++93A3 CB EA        	set 5,d ;place in RAM
  95++93A5 D9           	exx
  96++93A6 01 08 00     	ld bc,8
  97++93A9 18 D4        	jr sub24x16
  98++93AB
  99++93AB              opl4loadramdatablockheader
 100++93AB              ;dhl = header+data size
 101++93AB              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
 102++93AB D9           	exx
 103++93AC CD 71 90     	call memorystreamread4 ;adbc = total ram size
 104++93AF CD 71 90     	call memorystreamread4 ;adbc = start address
 105++93B2              .romsize0=$+1
 106++93B2 21 00 00     	ld hl,0
 107++93B5 09           	add hl,bc
 108++93B6              .romsize2=$+1
 109++93B6 3E 00        	ld a,0
 110++93B8 8A           	adc a,d
 111++93B9 E6 3F        	and 0x3f
 112++93BB 57           	ld d,a
 113++93BC D9           	exx
 114++93BD 01 08 00     	ld bc,8
 115++93C0 18 BD        	jr sub24x16
 116++93C2
 117++93C2              setup24bitscounterloop
 118++93C2              ;dhl = counter
 119++93C2              ;out: b = inner loop counter, de = outer loop counter
 120++93C2 5D           	ld e,l
 121++93C3 01 01 00     	ld bc,1
 122++93C6 B7 ED 42     	sub hl,bc
 123++93C9 30 01        	jr nc,$+3
 124++93CB 15           	dec d
 125++93CC 43           	ld b,e
 126++93CD 5C           	ld e,h
 127++93CE 13           	inc de
 128++93CF C9           	ret
 129++93D0
 130++93D0              opl4loadsample
 131++93D0              ;dhl = sample start address
 132++93D0              ;dhl' = sample size
 133++93D0 42           	ld b,d
 134++93D1 11 05 03     	ld de,0x0305
 135++93D4 CD 33 91     	call opl4writefm2
 136++93D7 50           	ld d,b
 137++93D8 CD 2E 92     	call opl4setmemoryaddress
 138++93DB 11 02 11     	ld de,0x1102
 139++93DE CD 52 91     	call opl4writewave
 140++93E1              	opl4_wait
 140++93E1 3E 00       >	ld a,MOON_BASE_HI
 140++93E3 DB 24       >	in a,(MOON_STAT)
 140++93E5 0F          >	rrca
 140++93E6 38 FB       >	jr c,$-3
 141++93E8 3E 06        	ld a,6
 142++93EA C5           	push bc
 143++93EB 06 00        	ld b,MOON_BASE_HI
 144++93ED 0E C2        	ld c,MOON_WREG
 145++93EF ED 79        	out (c),a
 146++93F1 C1           	pop bc
 147++93F2 D9           	exx
 148++93F3 CD C2 93     	call setup24bitscounterloop
 149++93F6 2A 72 90     	ld hl,(memorystreamcurrentaddr)
 150++93F9              .loop
 151++93F9              	memory_stream_read_byte c
 151++93F9 CB 74       >	bit 6,h
 151++93FB             >        IF AREA_C000_FFFF=1
 151++93FB CC 0D 90    >	call z,memorystreamnextpage
 151++93FE             >        ELSE
 151++93FE ~           > 	call nz,memorystreamnextpage
 151++93FE             >        ENDIF
 151++93FE 4E          >	ld c,(hl)
 151++93FF 23          >	inc hl
 152++9400              	opl4_wait
 152++9400 3E 00       >	ld a,MOON_BASE_HI
 152++9402 DB 24       >	in a,(MOON_STAT)
 152++9404 0F          >	rrca
 152++9405 38 FB       >	jr c,$-3
 153++9407 79           	ld a,c
 154++9408 C5           	push bc
 155++9409 06 00        	ld b,MOON_BASE_HI
 156++940B 0E C3        	ld c,MOON_WDAT
 157++940D ED 79        	out (c),a
 158++940F C1           	pop bc
 159++9410 10 E7        	djnz .loop
 160++9412 1B           	dec de
 161++9413 7B           	ld a,e
 162++9414 B2           	or d
 163++9415 20 E2        	jr nz,.loop
 164++9417 22 72 90     	ld (memorystreamcurrentaddr),hl
 165++941A 11 02 10     	ld de,0x1002
 166++941D C3 52 91     	jp opl4writewave
 167++9420
 168++9420              opl4loadramdatablock
 169++9420              ;dhl = data+header size
 170++9420 CD AB 93     	call opl4loadramdatablockheader
 171++9423 C8           	ret z
 172++9424 D9           	exx
 173++9425 18 A9        	jr opl4loadsample
 174++9427
 175++9427              opl4loadromdatablock
 176++9427              ;dhl = data+header size
 177++9427 CD 90 93     	call opl4loadromdatablockheader
 178++942A C8           	ret z
 179++942B D9           	exx
 180++942C D5           	push de
 181++942D CD D0 93     	call opl4loadsample
 182++9430 F1           	pop af
 183++9431              ;check if the address is within the first 64K of RAM
 184++9431 FE 21        	cp 0x21
 185++9433 D0           	ret nc
 186++9434              ;patch all 128 headers that LSI can read from RAM
 187++9434 3E 01        	ld a,1
 188++9436 32 55 93     	ld (isromloaded),a
 189++9439 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 190++943C 16 20        	ld d,MOONSOUNDROMSIZE/65536
 191++943E 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 192++9441 DD 21 00 B8  	ld ix,waveheaderbuffer
 193++9445 CD 3D 92     	call opl4readmemory
 194++9448 21 00 B8     	ld hl,waveheaderbuffer
 195++944B 11 0C 00     	ld de,MOONWAVEHEADERSIZE
 196++944E 06 80        	ld b,MOONRAMWAVETABLESIZE
 197++9450              .loop
 198++9450 CB EE        	set 5,(hl) ;set base address in RAM area
 199++9452 19           	add hl,de
 200++9453 10 FB        	djnz .loop
 201++9455 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 202++9458 16 20        	ld d,MOONSOUNDROMSIZE/65536
 203++945A 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 204++945D DD 21 00 B8  	ld ix,waveheaderbuffer
 205++9461 C3 78 92     	jp opl4writememory
 206++9464
 207++9464              opl4inittimer60hz
 208++9464 11 02 2F     	ld de,0x2f02
 209++9467 CD 14 91     	call opl4writefm1
 210++946A 11 04 21     	ld de,0x2104
 211++946D C3 14 91     	jp opl4writefm1
 212++9470
 213++9470              opl4waittimer60hz
 214++9470 3E 00        	ld a,MOON_BASE_HI
 215++9472 DB 24        	in a,(MOON_STAT)
 216++9474 17           	rla
 217++9475 30 F9        	jr nc,opl4waittimer60hz
 218++9477 11 04 81     	ld de,0x8104
 219++947A C3 14 91     	jp opl4writefm1
 220++947D
# file closed: GPlay/vgm/opl4.asm
  77++947D              	include "common/opn.asm"
# file opened: GPlay/common/opn.asm
   1++947D              ;Define ENABLE_FM to enable FM DACs
   2++947D
   3++947D              OPN_REG = 0xfffd
   4++947D              OPN_DAT = 0xbffd
   5++947D
   6++947D
   7++947D                      ifdef ENABLE_FM
   8++947D ~            CHIP0 = %11111000
   9++947D ~            CHIP1 = %11111001
  10++947D                      else
  11++947D              CHIP0 = %11111100
  12++947D              CHIP1 = %11111101
  13++947D                      endif
  14++947D
  15++947D
  16++947D              ;------------------------------------
  17++947D              opnwriteall
  18++947D CD A0 94     	call opnwritefm2
  19++9480              ;------------------------------------
  20++9480              opnwritefm1:
  21++9480              	;opn_write_fm_reg 0
  22++9480 3E FC              	ld a,CHIP0
  23++9482              opnwritefmx:
  24++9482              ;a = chipselect
  25++9482              ;e = register
  26++9482              ;d = value
  27++9482 01 FD FF     	ld bc,OPN_REG
  28++9485 ED 79        	out (c),a
  29++9487
  30++9487              1
  31++9487 00           	nop
  31++9488 00            nop
  32++9489              ;        nop:nop:nop
  33++9489 ED 70        	in f,(c)
  34++948B FA 87 94     	jp m, 1b ;$-6
  35++948E
  36++948E ED 59        	out (c),e
  37++9490
  38++9490              2
  39++9490 00             	nop
  39++9491 00            nop
  40++9492              ;        nop:nop:nop
  41++9492 ED 70        	in f,(c)
  42++9494 FA 90 94     	jp m,2b   ;$-6
  43++9497
  44++9497 06 BF        	ld b,HIGH OPN_DAT
  45++9499 ED 51        	out (c),d
  46++949B
  47++949B              .extradelay ;additional delay for FPGA systems
  48++949B 06 08        	ld b,8
  49++949D 10 FE        	djnz $
  50++949F C9           	ret
  51++94A0              ;------------------------------------
  52++94A0              opnwritefm2:
  53++94A0 3E FD               	ld a,CHIP1
  54++94A2 C3 82 94             jp opnwritefmx
  55++94A5              ;------------------------------------
  56++94A5
  57++94A5
  58++94A5              opndisableextradelay
  59++94A5 3E C9        	ld a,0xc9 ;ret opcode
  60++94A7 32 9B 94     	ld (opnwritefmx.extradelay),a
  61++94AA C9           	ret
  62++94AB
  63++94AB
  64++94AB              	macro opn_write_fm_regs incr,incd
  65++94AB ~            ;e = base register
  66++94AB ~            ;d = value
  67++94AB ~            ;l = count
  68++94AB ~            .loop	call opnwriteall
  69++94AB ~            	IF incr
  70++94AB ~            	inc e
  71++94AB ~            	ENDIF
  72++94AB ~            	IF incd
  73++94AB ~            	inc d
  74++94AB ~            	ENDIF
  75++94AB ~            	dec l
  76++94AB ~            	jr nz,.loop
  77++94AB              	endm
  78++94AB
  79++94AB
  80++94AB
  81++94AB              opninit
  82++94AB 2E B4        	ld l,0xb4
  83++94AD 11 00 00     	ld de,0x0000
  84++94B0              	opn_write_fm_regs 1,0
  84++94B0             >;e = base register
  84++94B0             >;d = value
  84++94B0             >;l = count
  84++94B0 CD 7D 94    >.loop	call opnwriteall
  84++94B3             >	IF 1
  84++94B3 1C          >	inc e
  84++94B4             >	ENDIF
  84++94B4             >	IF 0
  84++94B4 ~           >	inc d
  84++94B4             >	ENDIF
  84++94B4 2D          >	dec l
  84++94B5 20 F9       >	jr nz,.loop
  85++94B7              ;configure prescaler
  86++94B7 11 2F 00     	ld de,0x002f
  87++94BA CD 7D 94     	call opnwriteall
  88++94BD 11 2D 00     	ld de,0x002d
  89++94C0 C3 7D 94     	jp opnwriteall
  90++94C3
  91++94C3              opnstoptimers
  92++94C3 11 27 30     	ld de,0x3027
  93++94C6 CD 7D 94     	call opnwriteall
  94++94C9 11 27 00     	ld de,0x0027
  95++94CC C3 7D 94     	jp opnwriteall
  96++94CF
  97++94CF              opnmute
  98++94CF CD C3 94     	call opnstoptimers
  99++94D2              ;mute SSG
 100++94D2 2E 03        	ld l,3
 101++94D4 11 08 00     	ld de,0x0008
 102++94D7              	opn_write_fm_regs 1,0
 102++94D7             >;e = base register
 102++94D7             >;d = value
 102++94D7             >;l = count
 102++94D7 CD 7D 94    >.loop	call opnwriteall
 102++94DA             >	IF 1
 102++94DA 1C          >	inc e
 102++94DB             >	ENDIF
 102++94DB             >	IF 0
 102++94DB ~           >	inc d
 102++94DB             >	ENDIF
 102++94DB 2D          >	dec l
 102++94DC 20 F9       >	jr nz,.loop
 103++94DE 2E 0E        	ld l,14
 104++94E0 11 00 00     	ld de,0x0000
 105++94E3              	opn_write_fm_regs 1,0
 105++94E3             >;e = base register
 105++94E3             >;d = value
 105++94E3             >;l = count
 105++94E3 CD 7D 94    >.loop	call opnwriteall
 105++94E6             >	IF 1
 105++94E6 1C          >	inc e
 105++94E7             >	ENDIF
 105++94E7             >	IF 0
 105++94E7 ~           >	inc d
 105++94E7             >	ENDIF
 105++94E7 2D          >	dec l
 105++94E8 20 F9       >	jr nz,.loop
 106++94EA              ;max release rate
 107++94EA 2E 10        	ld l,0x10
 108++94EC 11 80 0F     	ld de,0x0f80
 109++94EF              	opn_write_fm_regs 1,0
 109++94EF             >;e = base register
 109++94EF             >;d = value
 109++94EF             >;l = count
 109++94EF CD 7D 94    >.loop	call opnwriteall
 109++94F2             >	IF 1
 109++94F2 1C          >	inc e
 109++94F3             >	ENDIF
 109++94F3             >	IF 0
 109++94F3 ~           >	inc d
 109++94F3             >	ENDIF
 109++94F3 2D          >	dec l
 109++94F4 20 F9       >	jr nz,.loop
 110++94F6              ;min total level
 111++94F6 2E 10        	ld l,0x10
 112++94F8 11 40 7F     	ld de,0x7f40
 113++94FB              	opn_write_fm_regs 1,0
 113++94FB             >;e = base register
 113++94FB             >;d = value
 113++94FB             >;l = count
 113++94FB CD 7D 94    >.loop	call opnwriteall
 113++94FE             >	IF 1
 113++94FE 1C          >	inc e
 113++94FF             >	ENDIF
 113++94FF             >	IF 0
 113++94FF ~           >	inc d
 113++94FF             >	ENDIF
 113++94FF 2D          >	dec l
 113++9500 20 F9       >	jr nz,.loop
 114++9502              ;key off
 115++9502 2E 04        	ld l,0x04
 116++9504 11 28 00     	ld de,0x0028
 117++9507              	opn_write_fm_regs 0,1
 117++9507             >;e = base register
 117++9507             >;d = value
 117++9507             >;l = count
 117++9507 CD 7D 94    >.loop	call opnwriteall
 117++950A             >	IF 0
 117++950A ~           >	inc e
 117++950A             >	ENDIF
 117++950A             >	IF 1
 117++950A 14          >	inc d
 117++950B             >	ENDIF
 117++950B 2D          >	dec l
 117++950C 20 F9       >	jr nz,.loop
 118++950E              ;default tfm state
 119++950E 01 FD FF     	ld bc,OPN_REG
 120++9511 3E FF        	ld a,%11111111
 121++9513 ED 79        	out (c),a
 122++9515 C9           	ret
 123++9516
# file closed: GPlay/common/opn.asm
  78++9516              	include "vgm/opn.asm"
# file opened: GPlay/vgm/opn.asm
   1++9516              opniscontrolregister
   2++9516              ;a = register
   3++9516              ;out: zf=1 if it's control register, zf=0 otherwise
   4++9516 FE 0E        	cp 0x0e ;IO port
   5++9518 C8           	ret z
   6++9519 FE 0F        	cp 0x0f ;IO port
   7++951B C8           	ret z
   8++951C FE 2D        	cp 0x2d ;prescaler
   9++951E C8           	ret z
  10++951F FE 2E        	cp 0x2e ;prescaler
  11++9521 C8           	ret z
  12++9522 FE 2F        	cp 0x2f ;prescaler
  13++9524 C9           	ret
  14++9525
  15++9525              opnwritemusiconlyfm1
  16++9525              ;skips writes to control registers
  17++9525              ;e = register
  18++9525              ;d = value
  19++9525 7B           	ld a,e
  20++9526 CD 16 95     	call opniscontrolregister
  21++9529 C8           	ret z
  22++952A FE 27        	cp 0x27 ;timers control
  23++952C C2 80 94     	jp nz,opnwritefm1
  24++952F 7A           	ld a,d
  25++9530 32 5E 95     	ld (opntimerctrl),a
  26++9533 F6 0A        	or %00001010 ;avoid altering timer B
  27++9535 57           	ld d,a
  28++9536 C3 80 94     	jp opnwritefm1
  29++9539
  30++9539              opnwritemusiconlyfm2
  31++9539              ;skips writes to control registers
  32++9539              ;e = register
  33++9539              ;d = value
  34++9539 7B           	ld a,e
  35++953A CD 16 95     	call opniscontrolregister
  36++953D C8           	ret z
  37++953E C3 A0 94     	jp opnwritefm2
  38++9541
  39++9541              opninittimer60hz
  40++9541              ;	ld de,0xc626
  41++9541              ;	ld de,0xca26
  42++9541 11 26 CD     	ld de,0xcd26
  43++9544 CD 80 94     	call opnwritefm1
  44++9547 11 27 2A     	ld de,0x2a27
  45++954A C3 80 94     	jp opnwritefm1
  46++954D
  47++954D              opnwaittimer60hz
  48++954D 01 FD FF     	ld bc,OPN_REG
  49++9550 3E F8        	ld a,%11111000
  50++9552 ED 79        	out (c),a
  51++9554              .waitloop
  52++9554 ED 78        	in a,(c)
  53++9556 E6 02        	and 2
  54++9558 28 FA        	jr z,.waitloop
  55++955A 11 27 2A     	ld de,0x2a27
  56++955D              opntimerctrl=$+1
  57++955D 3E 00        	ld a,0
  58++955F B2           	or d
  59++9560 57           	ld d,a
  60++9561 C3 80 94     	jp opnwritefm1
  61++9564
# file closed: GPlay/vgm/opn.asm
  79++9564              	include "vgm/opm.asm"
# file opened: GPlay/vgm/opm.asm
   1++9564              opmwritemusiconlychip0
   2++9564              ;e = register
   3++9564              ;d = value
   4++9564 7B           	ld a,e
   5++9565 FE 08        	cp 8
   6++9567 D8           	ret c
   7++9568 C3 BA 92     	jp opmwritechip0
   8++956B
   9++956B              opmwritemusiconlychip1
  10++956B              ;e = register
  11++956B              ;d = value
  12++956B 7B           	ld a,e
  13++956C FE 08        	cp 8
  14++956E D8           	ret c
  15++956F C3 D2 92     	jp opmwritechip1
  16++9572
  17++9572              vgmopminit
  18++9572 3E 02        	ld a,2
  19++9574 32 7B 95     	ld (opmwaittimer100hz.counter),a
  20++9577 C3 F0 92     	jp opminit
  21++957A
  22++957A              opmwaittimer100hz
  23++957A              .counter=$+1
  24++957A 3E 00        	ld a,0
  25++957C 3D           	dec a
  26++957D 20 02        	jr nz,$+4
  27++957F 3E 02        	ld a,2
  28++9581 32 7B 95     	ld (.counter),a
  29++9584 C8           	ret z
  30++9585              	;YIELD
  31++9585              	OS_WAIT
  31++9585 DF          >	rst #18
  32++9586 C9           	ret
  33++9587
# file closed: GPlay/vgm/opm.asm
  80++9587              	include "vgm/ssg.asm"
# file opened: GPlay/vgm/ssg.asm
   1++9587              SSG_REG = 0xfffd
   2++9587              SSG_DAT = 0xbffd
   3++9587
   4++9587              	macro ssg_write_reg chip_n
   5++9587 ~            ;e = register
   6++9587 ~            ;d = value
   7++9587 ~            	ld bc,SSG_REG
   8++9587 ~            	ld a,chip_n+%11111110
   9++9587 ~            	out (c),a
  10++9587 ~            	out (c),e
  11++9587 ~            	ld bc,SSG_DAT
  12++9587 ~            	out (c),d
  13++9587              	endm
  14++9587
  15++9587              ssgwritemusiconlychip0
  16++9587 7B           	ld a,e
  17++9588 FE 0E        	cp 0x0e
  18++958A D0           	ret nc
  19++958B              ssgwrite0
  20++958B              ;e = register
  21++958B              ;d = value
  22++958B              	ssg_write_reg 0
  22++958B             >;e = register
  22++958B             >;d = value
  22++958B 01 FD FF    >	ld bc,SSG_REG
  22++958E 3E FE       >	ld a,0+%11111110
  22++9590 ED 79       >	out (c),a
  22++9592 ED 59       >	out (c),e
  22++9594 01 FD BF    >	ld bc,SSG_DAT
  22++9597 ED 51       >	out (c),d
  23++9599 C9           	ret
  24++959A
  25++959A              ssgwritemusiconlychip1
  26++959A 7B           	ld a,e
  27++959B FE 0E        	cp 0x0e
  28++959D D0           	ret nc
  29++959E              ssgwrite1
  30++959E              ;e = register
  31++959E              ;d = value
  32++959E              	ssg_write_reg 1
  32++959E             >;e = register
  32++959E             >;d = value
  32++959E 01 FD FF    >	ld bc,SSG_REG
  32++95A1 3E FF       >	ld a,1+%11111110
  32++95A3 ED 79       >	out (c),a
  32++95A5 ED 59       >	out (c),e
  32++95A7 01 FD BF    >	ld bc,SSG_DAT
  32++95AA ED 51       >	out (c),d
  33++95AC C9           	ret
  34++95AD
  35++95AD              ssginit
  36++95AD C9           	ret
  37++95AE
  38++95AE              	macro ssg_write_regs
  39++95AE ~            ;e = base register
  40++95AE ~            ;d = value
  41++95AE ~            ;l = count
  42++95AE ~            .loop
  43++95AE ~            	call ssgwrite0
  44++95AE ~            	call ssgwrite1
  45++95AE ~            	inc e
  46++95AE ~            	dec l
  47++95AE ~            	jr nz,.loop
  48++95AE              	endm
  49++95AE
  50++95AE              ssgmute
  51++95AE 2E 03        	ld l,3
  52++95B0 11 08 00     	ld de,8
  53++95B3              	ssg_write_regs
  53++95B3             >;e = base register
  53++95B3             >;d = value
  53++95B3             >;l = count
  53++95B3             >.loop
  53++95B3 CD 8B 95    >	call ssgwrite0
  53++95B6 CD 9E 95    >	call ssgwrite1
  53++95B9 1C          >	inc e
  53++95BA 2D          >	dec l
  53++95BB 20 F6       >	jr nz,.loop
  54++95BD 2E 0E        	ld l,14
  55++95BF 11 00 00     	ld de,0
  56++95C2              	ssg_write_regs
  56++95C2             >;e = base register
  56++95C2             >;d = value
  56++95C2             >;l = count
  56++95C2             >.loop
  56++95C2 CD 8B 95    >	call ssgwrite0
  56++95C5 CD 9E 95    >	call ssgwrite1
  56++95C8 1C          >	inc e
  56++95C9 2D          >	dec l
  56++95CA 20 F6       >	jr nz,.loop
  57++95CC C9           	ret
  58++95CD
# file closed: GPlay/vgm/ssg.asm
  81++95CD
  82++95CD
  83++95CD
  84++95CD
  85++95CD
  86++95CD
  87++95CD              waittimer50hz
  88++95CD              	;YIELD
  89++95CD              	OS_WAIT
  89++95CD DF          >	rst #18
  90++95CE C9           	ret
  91++95CF
  92++95CF
  93++95CF              waveheaderbuffer = 0xc000-2048 ;0x5400 ;текущий размер буфера 1536 (128*12)
  94++95CF              waveheaderbufferend = waveheaderbuffer+WAVEHEADERBUFFERSIZE
  95++95CF              vgmheadercopy = waveheaderbufferend
  96++95CF              vgmheadercopyend = vgmheadercopy+HEADER_SIZE_MAX ;(ещё 256)
  97++95CF
  98++95CF              titlestr = waveheaderbufferend
  99++95CF              titlestrend = titlestr+TITLELENGTH
 100++95CF
 101++95CF
 102++95CF              HEADER_CLOCK_YM2203 = vgmheadercopy+0x44
 103++95CF              HEADER_CLOCK_YM3812 = vgmheadercopy+0x50
 104++95CF              HEADER_CLOCK_YMF262 = vgmheadercopy+0x5c
 105++95CF              HEADER_CLOCK_YMF278B = vgmheadercopy+0x60
 106++95CF              HEADER_CLOCK_AY8910 = vgmheadercopy+0x74
 107++95CF
 108++95CF
 109++95CF              	macro a_or_dw addr
 110++95CF ~            	ld hl,(addr+0)
 111++95CF ~            	or h
 112++95CF ~            	or l
 113++95CF ~            	ld de,(addr+2)
 114++95CF ~            	or d
 115++95CF ~            	or e
 116++95CF              	endm
 117++95CF
 118++95CF              	macro set_timer wait,ticks
 119++95CF ~            	ld hl,ticks
 120++95CF ~            	ld (waittimerstep),hl
 121++95CF              	endm
 122++95CF
 123++95CF
 124++95CF              init_:
 125++95CF              	set_timer waittimer50hz,882
 125++95CF 21 72 03    >	ld hl,882
 125++95D2 22 86 96    >	ld (waittimerstep),hl
 126++95D5 21 00 00     	ld hl,0
 127++95D8 22 81 96     	ld (waitcounterlo),hl
 128++95DB AF           	xor a
 129++95DC 32 84 96     	ld (waitcounterhi),a
 130++95DF 32 66 96     	ld (devicemask),a
 131++95E2
 132++95E2 32 7A 96           	ld (vgm_play_var),a
 133++95E5              ;map header to 0x8000
 134++95E5                      ;first page (vgm_header) now in page_plr3
 135++95E5                      ;now do init.
 136++95E5
 137++95E5              ;copy header
 138++95E5 01 00 01     	ld bc,HEADER_SIZE_MAX
 139++95E8 21 00 BE     	ld hl,vgmheadercopy
 140++95EB 11 01 BE     	ld de,vgmheadercopy+1
 141++95EE 36 00        	ld (hl),0
 142++95F0 ED B0        	ldir
 143++95F2 2A 34 C0     	ld hl,(HEADER_DATA_OFFSET)  ;если HEADER_DATA_OFFSET == 0 to bc = 0x0040 иначе  bc = 0x0034
 144++95F5 7C           	ld a,h
 145++95F6 B5           	or l
 146++95F7 01 40 00     	ld bc,0x40
 147++95FA 28 02        	jr z,$+4
 148++95FC 0E 34        	ld c,0x34
 149++95FE 09           	add hl,bc
 150++95FF 22 5D 96     	ld (.dataoffset),hl
 151++9602                            ;определяем сколько данных заголовка vgm нужно перекинуть в буфер исходя из значения HEADER_DATA_OFFSET
 152++9602 44 4D        	ld bc,hl
 153++9604 21 FF FE     	ld hl,-HEADER_SIZE_MAX-1
 154++9607 09           	add hl,bc
 155++9608 30 03        	jr nc,$+5
 156++960A 01 00 01     	ld bc,HEADER_SIZE_MAX
 157++960D
 158++960D 21 00 C0     	ld hl,module
 159++9610 11 00 BE     	ld de,vgmheadercopy
 160++9613 ED B0        	ldir
 161++9615              ;setup loop
 162++9615 AF           	xor a
 163++9616              	a_or_dw HEADER_LOOP_OFFSET
 163++9616 2A 1C C0    >	ld hl,(HEADER_LOOP_OFFSET+0)
 163++9619 B4          >	or h
 163++961A B5          >	or l
 163++961B ED 5B 1E C0 >	ld de,(HEADER_LOOP_OFFSET+2)
 163++961F B2          >	or d
 163++9620 B3          >	or e
 164++9621 22 84 98     	ld (loopoffsetlo),hl
 165++9624 ED 53 81 98  	ld (loopoffsethi),de
 166++9628              ;init Moonsound
 167++9628 AF           	xor a
 168++9629              	a_or_dw HEADER_CLOCK_YM3812
 168++9629 2A 50 BE    >	ld hl,(HEADER_CLOCK_YM3812+0)
 168++962C B4          >	or h
 168++962D B5          >	or l
 168++962E ED 5B 52 BE >	ld de,(HEADER_CLOCK_YM3812+2)
 168++9632 B2          >	or d
 168++9633 B3          >	or e
 169++9634 32 E2 9A     	ld (useYM3812),a
 170++9637              	a_or_dw HEADER_CLOCK_YMF262
 170++9637 2A 5C BE    >	ld hl,(HEADER_CLOCK_YMF262+0)
 170++963A B4          >	or h
 170++963B B5          >	or l
 170++963C ED 5B 5E BE >	ld de,(HEADER_CLOCK_YMF262+2)
 170++9640 B2          >	or d
 170++9641 B3          >	or e
 171++9642 20 14        	jr nz,.opl4notneeded
 172++9644              	a_or_dw HEADER_CLOCK_YMF278B
 172++9644 2A 60 BE    >	ld hl,(HEADER_CLOCK_YMF278B+0)
 172++9647 B4          >	or h
 172++9648 B5          >	or l
 172++9649 ED 5B 62 BE >	ld de,(HEADER_CLOCK_YMF278B+2)
 172++964D B2          >	or d
 172++964E B3          >	or e
 173++964F 28 07        	jr z,.opl4notneeded
 174++9651 3A D4 9A     	ld a,(moonsoundstatus)
 175++9654 FE 02        	cp 2
 176++9656 C0           	ret nz ;jp nz,memorystreamfree ;sets zf=0
 177++9657 B7           	or a
 178++9658              .opl4notneeded
 179++9658 C4 D3 9A     	call nz,initYMF278B
 180++965B C0           	ret nz  ;jp nz,memorystreamfree ;sets zf=0
 181++965C              .dataoffset=$+1
 182++965C 21 00 00     	ld hl,0
 183++965F 11 00 00     	ld de,0
 184++9662                      ;init music
 185++9662 CD C8 90     	call memorystreamseek
 186++9665              devicemask=$+1
 187++9665 3E 00        	ld a,0
 188++9667              ;zf=0 if there isn't any supported device
 189++9667 3D           	dec a
 190++9668 F8           	ret m
 191++9669 3C           	inc a
 192++966A BF           	cp a
 193++966B C9           	ret
 194++966C
 195++966C
 196++966C
 197++966C
 198++966C
 199++966C
 200++966C
 201++966C
 202++966C              MUTE:
 203++966C 3E C9                        ld a,$C9			;ret	;stop playing
 204++966E 32 7A 96                     ld (vgm_play_var),a
 205++9671 3A 66 96     		ld a,(devicemask)
 206++9674 E6 08        		and DEVICE_MOONSOUND_MASK
 207++9676 C4 D6 91     		call nz,opl4mute
 208++9679 C9                           ret
 209++967A
 210++967A
 211++967A
 212++967A
 213++967A
 214++967A
 215++967A
 216++967A              PLAY:
 217++967A              ;out: zf=0 if still playing, zf=1 otherwise
 218++967A              ;waittimercallback=$+1
 219++967A              ;	call 0
 220++967A
 221++967A              vgm_play_var = $
 221++967A 00             nop		;nop - play
 222++967B 3E 00                ld a,0                          ;(memorystreamcurrentpage)
 223++967D              memorystreamcurrentpage equ $-1
 224++967D                      IF AREA_C000_FFFF=1
 225++967D                          ;SETPGC000
 226++967D              			OS_SET_PAGE_SLOT3
 226++967D 0E 1C       >    ld c,#1c
 226++967F E7          >    rst #20
 227++9680                      ELSE
 228++9680 ~                        SETPG8000
 229++9680                      ENDIF
 230++9680              playloop
 231++9680              waitcounterlo=$+1
 232++9680 21 00 00     	ld hl,0
 233++9683              waitcounterhi=$+1
 234++9683 3E 00        	ld a,0
 235++9685              waittimerstep=$+1
 236++9685 01 00 00     	ld bc,0
 237++9688 B7 ED 42     	sub hl,bc
 238++968B 16 00        	ld d,0
 239++968D 9A           	sbc a,d
 240++968E 30 1A        	jr nc,exitplayloop
 241++9690              ;read command
 242++9690              	memory_stream_read_1 e
 242++9690 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 242++9693             >	memory_stream_read_byte e
 242++9693 CB 74       >	bit 6,h
 242++9695             >        IF AREA_C000_FFFF=1
 242++9695 CC 0D 90    >	call z,memorystreamnextpage
 242++9698             >        ELSE
 242++9698 ~           > 	call nz,memorystreamnextpage
 242++9698             >        ENDIF
 242++9698 5E          >	ld e,(hl)
 242++9699 23          >	inc hl
 242++969A 22 72 90    >	ld (memorystreamcurrentaddr),hl
 243++969D 21 8E 98     	ld hl,cmdtable
 244++96A0 19           	add hl,de
 245++96A1 5E           	ld e,(hl)
 246++96A2 24           	inc h
 247++96A3 56           	ld d,(hl)
 248++96A4 21 80 96     	ld hl,playloop
 249++96A7 E5           	push hl
 250++96A8 EB           	ex hl,de
 251++96A9 E9           	jp (hl)
 252++96AA
 253++96AA              exitplayloop
 254++96AA 22 81 96     	ld (waitcounterlo),hl
 255++96AD 32 84 96     	ld (waitcounterhi),a
 256++96B0              ;continue playing
 257++96B0 F6 01        	or 1
 258++96B2 C9           	ret
 259++96B3
 260++96B3 21 81 96     wait1	ld hl,waitcounterlo
 261++96B6 34           	inc (hl)
 262++96B7 C0           	ret nz
 263++96B8 23           	inc hl
 264++96B9 34           	inc (hl)
 265++96BA C0           	ret nz
 266++96BB 21 84 96     	ld hl,waitcounterhi
 267++96BE 34           	inc (hl)
 268++96BF C9           	ret
 269++96C0
 270++96C0 3E 02        wait2	ld a,2
 271++96C2 21 81 96     waitn	ld hl,waitcounterlo
 272++96C5 86           	add a,(hl)
 273++96C6 77           	ld (hl),a
 274++96C7 D0           	ret nc
 275++96C8 23           	inc hl
 276++96C9 34           	inc (hl)
 277++96CA C0           	ret nz
 278++96CB 21 84 96     	ld hl,waitcounterhi
 279++96CE 34           	inc (hl)
 280++96CF C9           	ret
 281++96D0
 282++96D0 3E 03        wait3	ld a,3
 282++96D2 C3 C2 96       jp waitn
 283++96D5 3E 04        wait4	ld a,4
 283++96D7 C3 C2 96       jp waitn
 284++96DA 3E 05        wait5	ld a,5
 284++96DC C3 C2 96       jp waitn
 285++96DF 3E 06        wait6	ld a,6
 285++96E1 C3 C2 96       jp waitn
 286++96E4 3E 07        wait7	ld a,7
 286++96E6 C3 C2 96       jp waitn
 287++96E9 3E 08        wait8	ld a,8
 287++96EB C3 C2 96       jp waitn
 288++96EE 3E 09        wait9	ld a,9
 288++96F0 C3 C2 96       jp waitn
 289++96F3 3E 0A        wait10	ld a,10
 289++96F5 C3 C2 96       jp waitn
 290++96F8 3E 0B        wait11	ld a,11
 290++96FA C3 C2 96       jp waitn
 291++96FD 3E 0C        wait12	ld a,12
 291++96FF C3 C2 96       jp waitn
 292++9702 3E 0D        wait13	ld a,13
 292++9704 C3 C2 96       jp waitn
 293++9707 3E 0E        wait14	ld a,14
 293++9709 C3 C2 96       jp waitn
 294++970C 3E 0F        wait15	ld a,15
 294++970E C3 C2 96       jp waitn
 295++9711 3E 10        wait16	ld a,16
 295++9713 C3 C2 96       jp waitn
 296++9716
 297++9716 11 DF 02     wait735	ld de,735
 298++9719 2A 81 96     waitnn	ld hl,(waitcounterlo)
 299++971C 19           	add hl,de
 300++971D 22 81 96     	ld (waitcounterlo),hl
 301++9720 D0           	ret nc
 302++9721 21 84 96     	ld hl,waitcounterhi
 303++9724 34           	inc (hl)
 304++9725 C9           	ret
 305++9726
 306++9726 11 72 03     wait882	ld de,882
 307++9729 C3 19 97     	jp waitnn
 308++972C
 309++972C              waitvar	memory_stream_read_2 e,d
 309++972C 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 309++972F             >	memory_stream_read_byte e
 309++972F CB 74       >	bit 6,h
 309++9731             >        IF AREA_C000_FFFF=1
 309++9731 CC 0D 90    >	call z,memorystreamnextpage
 309++9734             >        ELSE
 309++9734 ~           > 	call nz,memorystreamnextpage
 309++9734             >        ENDIF
 309++9734 5E          >	ld e,(hl)
 309++9735 23          >	inc hl
 309++9736             >	memory_stream_read_byte d
 309++9736 CB 74       >	bit 6,h
 309++9738             >        IF AREA_C000_FFFF=1
 309++9738 CC 0D 90    >	call z,memorystreamnextpage
 309++973B             >        ELSE
 309++973B ~           > 	call nz,memorystreamnextpage
 309++973B             >        ENDIF
 309++973B 56          >	ld d,(hl)
 309++973C 23          >	inc hl
 309++973D 22 72 90    >	ld (memorystreamcurrentaddr),hl
 310++9740 2A 81 96     	ld hl,(waitcounterlo)
 311++9743 19           	add hl,de
 312++9744 22 81 96     	ld (waitcounterlo),hl
 313++9747 D0           	ret nc
 314++9748 21 84 96     	ld hl,waitcounterhi
 315++974B 34           	inc (hl)
 316++974C C9           	ret
 317++974D
 318++974D              	macro skip_n n
 319++974D ~            	ld b,n
 320++974D ~            	jp memorystreamskip
 321++974D              	endm
 322++974D
 323++974D C9           skip1	ret
 324++974E              skip2	skip_n 1
 324++974E 06 01       >	ld b,1
 324++9750 C3 23 90    >	jp memorystreamskip
 325++9753              skip3	skip_n 2
 325++9753 06 02       >	ld b,2
 325++9755 C3 23 90    >	jp memorystreamskip
 326++9758              skip4	skip_n 3
 326++9758 06 03       >	ld b,3
 326++975A C3 23 90    >	jp memorystreamskip
 327++975D              skip5	skip_n 4
 327++975D 06 04       >	ld b,4
 327++975F C3 23 90    >	jp memorystreamskip
 328++9762              skip6	skip_n 5
 328++9762 06 05       >	ld b,5
 328++9764 C3 23 90    >	jp memorystreamskip
 329++9767              skip11	skip_n 10
 329++9767 06 0A       >	ld b,10
 329++9769 C3 23 90    >	jp memorystreamskip
 330++976C              skip12	skip_n 11
 330++976C 06 0B       >	ld b,11
 330++976E C3 23 90    >	jp memorystreamskip
 331++9771
 332++9771
 333++9771              endofsounddata
 334++9771                    ;  jp seektoloop ;здесь зацикливание, повтор
 335++9771 CD DB 8E     	  call PLR_MUTE ;выключить звук
 336++9774              cmdunsupported
 337++9774              ;stop playing
 338++9774 F1           	pop af
 339++9775 AF           	xor a
 340++9776 C9           	ret
 341++9777
 342++9777              cmdYM2203
 343++9777              	memory_stream_read_2 e,d
 343++9777 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 343++977A             >	memory_stream_read_byte e
 343++977A CB 74       >	bit 6,h
 343++977C             >        IF AREA_C000_FFFF=1
 343++977C CC 0D 90    >	call z,memorystreamnextpage
 343++977F             >        ELSE
 343++977F ~           > 	call nz,memorystreamnextpage
 343++977F             >        ENDIF
 343++977F 5E          >	ld e,(hl)
 343++9780 23          >	inc hl
 343++9781             >	memory_stream_read_byte d
 343++9781 CB 74       >	bit 6,h
 343++9783             >        IF AREA_C000_FFFF=1
 343++9783 CC 0D 90    >	call z,memorystreamnextpage
 343++9786             >        ELSE
 343++9786 ~           > 	call nz,memorystreamnextpage
 343++9786             >        ENDIF
 343++9786 56          >	ld d,(hl)
 343++9787 23          >	inc hl
 343++9788 22 72 90    >	ld (memorystreamcurrentaddr),hl
 344++978B C3 25 95     	jp opnwritemusiconlyfm1
 345++978E
 346++978E              cmdYM2203dp
 347++978E              	memory_stream_read_2 e,d
 347++978E 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 347++9791             >	memory_stream_read_byte e
 347++9791 CB 74       >	bit 6,h
 347++9793             >        IF AREA_C000_FFFF=1
 347++9793 CC 0D 90    >	call z,memorystreamnextpage
 347++9796             >        ELSE
 347++9796 ~           > 	call nz,memorystreamnextpage
 347++9796             >        ENDIF
 347++9796 5E          >	ld e,(hl)
 347++9797 23          >	inc hl
 347++9798             >	memory_stream_read_byte d
 347++9798 CB 74       >	bit 6,h
 347++979A             >        IF AREA_C000_FFFF=1
 347++979A CC 0D 90    >	call z,memorystreamnextpage
 347++979D             >        ELSE
 347++979D ~           > 	call nz,memorystreamnextpage
 347++979D             >        ENDIF
 347++979D 56          >	ld d,(hl)
 347++979E 23          >	inc hl
 347++979F 22 72 90    >	ld (memorystreamcurrentaddr),hl
 348++97A2 C3 39 95     	jp opnwritemusiconlyfm2
 349++97A5
 350++97A5              cmdYMF278B
 351++97A5              	memory_stream_read_3 c,e,d
 351++97A5 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 351++97A8             >	memory_stream_read_byte c
 351++97A8 CB 74       >	bit 6,h
 351++97AA             >        IF AREA_C000_FFFF=1
 351++97AA CC 0D 90    >	call z,memorystreamnextpage
 351++97AD             >        ELSE
 351++97AD ~           > 	call nz,memorystreamnextpage
 351++97AD             >        ENDIF
 351++97AD 4E          >	ld c,(hl)
 351++97AE 23          >	inc hl
 351++97AF             >	memory_stream_read_byte e
 351++97AF CB 74       >	bit 6,h
 351++97B1             >        IF AREA_C000_FFFF=1
 351++97B1 CC 0D 90    >	call z,memorystreamnextpage
 351++97B4             >        ELSE
 351++97B4 ~           > 	call nz,memorystreamnextpage
 351++97B4             >        ENDIF
 351++97B4 5E          >	ld e,(hl)
 351++97B5 23          >	inc hl
 351++97B6             >	memory_stream_read_byte d
 351++97B6 CB 74       >	bit 6,h
 351++97B8             >        IF AREA_C000_FFFF=1
 351++97B8 CC 0D 90    >	call z,memorystreamnextpage
 351++97BB             >        ELSE
 351++97BB ~           > 	call nz,memorystreamnextpage
 351++97BB             >        ENDIF
 351++97BB 56          >	ld d,(hl)
 351++97BC 23          >	inc hl
 351++97BD 22 72 90    >	ld (memorystreamcurrentaddr),hl
 352++97C0 0D           	dec c
 353++97C1 CA 3D 93     	jp z,opl4writemusiconlyfm2
 354++97C4 F2 47 93     	jp p,opl4writewavemusiconly
 355++97C7 C3 31 93     	jp opl4writemusiconlyfm1
 356++97CA
 357++97CA              cmdYMF262p0
 358++97CA              cmdYM3812
 359++97CA              cmdY8950
 360++97CA              cmdYM3526
 361++97CA              	memory_stream_read_2 e,d
 361++97CA 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 361++97CD             >	memory_stream_read_byte e
 361++97CD CB 74       >	bit 6,h
 361++97CF             >        IF AREA_C000_FFFF=1
 361++97CF CC 0D 90    >	call z,memorystreamnextpage
 361++97D2             >        ELSE
 361++97D2 ~           > 	call nz,memorystreamnextpage
 361++97D2             >        ENDIF
 361++97D2 5E          >	ld e,(hl)
 361++97D3 23          >	inc hl
 361++97D4             >	memory_stream_read_byte d
 361++97D4 CB 74       >	bit 6,h
 361++97D6             >        IF AREA_C000_FFFF=1
 361++97D6 CC 0D 90    >	call z,memorystreamnextpage
 361++97D9             >        ELSE
 361++97D9 ~           > 	call nz,memorystreamnextpage
 361++97D9             >        ENDIF
 361++97D9 56          >	ld d,(hl)
 361++97DA 23          >	inc hl
 361++97DB 22 72 90    >	ld (memorystreamcurrentaddr),hl
 362++97DE C3 31 93     	jp opl4writemusiconlyfm1
 363++97E1
 364++97E1              cmdYMF262p1
 365++97E1              cmdYM3812dp
 366++97E1              cmdY8950dp
 367++97E1              cmdYM3526dp
 368++97E1              	memory_stream_read_2 e,d
 368++97E1 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 368++97E4             >	memory_stream_read_byte e
 368++97E4 CB 74       >	bit 6,h
 368++97E6             >        IF AREA_C000_FFFF=1
 368++97E6 CC 0D 90    >	call z,memorystreamnextpage
 368++97E9             >        ELSE
 368++97E9 ~           > 	call nz,memorystreamnextpage
 368++97E9             >        ENDIF
 368++97E9 5E          >	ld e,(hl)
 368++97EA 23          >	inc hl
 368++97EB             >	memory_stream_read_byte d
 368++97EB CB 74       >	bit 6,h
 368++97ED             >        IF AREA_C000_FFFF=1
 368++97ED CC 0D 90    >	call z,memorystreamnextpage
 368++97F0             >        ELSE
 368++97F0 ~           > 	call nz,memorystreamnextpage
 368++97F0             >        ENDIF
 368++97F0 56          >	ld d,(hl)
 368++97F1 23          >	inc hl
 368++97F2 22 72 90    >	ld (memorystreamcurrentaddr),hl
 369++97F5 C3 3D 93     	jp opl4writemusiconlyfm2
 370++97F8
 371++97F8              cmdYM2151
 372++97F8              	memory_stream_read_2 e,d
 372++97F8 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 372++97FB             >	memory_stream_read_byte e
 372++97FB CB 74       >	bit 6,h
 372++97FD             >        IF AREA_C000_FFFF=1
 372++97FD CC 0D 90    >	call z,memorystreamnextpage
 372++9800             >        ELSE
 372++9800 ~           > 	call nz,memorystreamnextpage
 372++9800             >        ENDIF
 372++9800 5E          >	ld e,(hl)
 372++9801 23          >	inc hl
 372++9802             >	memory_stream_read_byte d
 372++9802 CB 74       >	bit 6,h
 372++9804             >        IF AREA_C000_FFFF=1
 372++9804 CC 0D 90    >	call z,memorystreamnextpage
 372++9807             >        ELSE
 372++9807 ~           > 	call nz,memorystreamnextpage
 372++9807             >        ENDIF
 372++9807 56          >	ld d,(hl)
 372++9808 23          >	inc hl
 372++9809 22 72 90    >	ld (memorystreamcurrentaddr),hl
 373++980C C3 64 95     	jp opmwritemusiconlychip0
 374++980F
 375++980F              cmdYM2151dp
 376++980F              	memory_stream_read_2 e,d
 376++980F 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 376++9812             >	memory_stream_read_byte e
 376++9812 CB 74       >	bit 6,h
 376++9814             >        IF AREA_C000_FFFF=1
 376++9814 CC 0D 90    >	call z,memorystreamnextpage
 376++9817             >        ELSE
 376++9817 ~           > 	call nz,memorystreamnextpage
 376++9817             >        ENDIF
 376++9817 5E          >	ld e,(hl)
 376++9818 23          >	inc hl
 376++9819             >	memory_stream_read_byte d
 376++9819 CB 74       >	bit 6,h
 376++981B             >        IF AREA_C000_FFFF=1
 376++981B CC 0D 90    >	call z,memorystreamnextpage
 376++981E             >        ELSE
 376++981E ~           > 	call nz,memorystreamnextpage
 376++981E             >        ENDIF
 376++981E 56          >	ld d,(hl)
 376++981F 23          >	inc hl
 376++9820 22 72 90    >	ld (memorystreamcurrentaddr),hl
 377++9823 C3 6B 95     	jp opmwritemusiconlychip1
 378++9826
 379++9826              cmdAY8910
 380++9826              	memory_stream_read_2 e,d
 380++9826 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 380++9829             >	memory_stream_read_byte e
 380++9829 CB 74       >	bit 6,h
 380++982B             >        IF AREA_C000_FFFF=1
 380++982B CC 0D 90    >	call z,memorystreamnextpage
 380++982E             >        ELSE
 380++982E ~           > 	call nz,memorystreamnextpage
 380++982E             >        ENDIF
 380++982E 5E          >	ld e,(hl)
 380++982F 23          >	inc hl
 380++9830             >	memory_stream_read_byte d
 380++9830 CB 74       >	bit 6,h
 380++9832             >        IF AREA_C000_FFFF=1
 380++9832 CC 0D 90    >	call z,memorystreamnextpage
 380++9835             >        ELSE
 380++9835 ~           > 	call nz,memorystreamnextpage
 380++9835             >        ENDIF
 380++9835 56          >	ld d,(hl)
 380++9836 23          >	inc hl
 380++9837 22 72 90    >	ld (memorystreamcurrentaddr),hl
 381++983A CB 7B        	bit 7,e
 382++983C CA 87 95     	jp z,ssgwritemusiconlychip0
 383++983F CB BB        	res 7,e
 384++9841 C3 9A 95     	jp ssgwritemusiconlychip1
 385++9844
 386++9844              cmdYMF262dp0 equ memorystreamread2
 387++9844              cmdYMF262dp1 equ memorystreamread2
 388++9844
 389++9844              cmddatablock
 390++9844              	memory_stream_read_2 a,e ;a = 0x66 guard, e = type
 390++9844 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 390++9847             >	memory_stream_read_byte a
 390++9847 CB 74       >	bit 6,h
 390++9849             >        IF AREA_C000_FFFF=1
 390++9849 CC 0D 90    >	call z,memorystreamnextpage
 390++984C             >        ELSE
 390++984C ~           > 	call nz,memorystreamnextpage
 390++984C             >        ENDIF
 390++984C 7E          >	ld a,(hl)
 390++984D 23          >	inc hl
 390++984E             >	memory_stream_read_byte e
 390++984E CB 74       >	bit 6,h
 390++9850             >        IF AREA_C000_FFFF=1
 390++9850 CC 0D 90    >	call z,memorystreamnextpage
 390++9853             >        ELSE
 390++9853 ~           > 	call nz,memorystreamnextpage
 390++9853             >        ENDIF
 390++9853 5E          >	ld e,(hl)
 390++9854 23          >	inc hl
 390++9855 22 72 90    >	ld (memorystreamcurrentaddr),hl
 391++9858 FE 66        	cp 0x66
 392++985A C2 74 97     	jp nz,cmdunsupported
 393++985D              processdatablock
 394++985D              ;e = data type
 395++985D CD 71 90     	call memorystreamread4 ;adbc = data size
 396++9860 7B           	ld a,e
 397++9861 60 69        	ld hl,bc
 398++9863              ;	cp 0x81
 399++9863              ;	jp z,opnaloaddatablock
 400++9863 FE 84        	cp 0x84
 401++9865 CA 27 94     	jp z,opl4loadromdatablock
 402++9868 FE 87        	cp 0x87
 403++986A CA 20 94     	jp z,opl4loadramdatablock
 404++986D D5           	push de
 405++986E C5           	push bc
 406++986F CD ED 90     	call memorystreamgetpos
 407++9872 C1           	pop bc
 408++9873 F1           	pop af
 409++9874 09           	add hl,bc
 410++9875 8B           	adc a,e
 411++9876 5F           	ld e,a
 412++9877 8A           	adc a,d
 413++9878 93           	sub e
 414++9879 57           	ld d,a
 415++987A C3 C8 90     	jp memorystreamseek
 416++987D
 417++987D
 418++987D              seektoloop
 419++987D 01 1C 00     	ld bc,0x1c
 420++9880              loopoffsethi=$+1
 421++9880 11 00 00     	ld de,0
 422++9883              loopoffsetlo=$+1
 423++9883 21 00 00     	ld hl,0
 424++9886              seektopos
 425++9886              ;dehl + bc = position
 426++9886              ;out: hl = read address
 427++9886 09           	add hl,bc
 428++9887 D2 C8 90     	jp nc,memorystreamseek
 429++988A 13           	inc de
 430++988B C3 C8 90     	jp memorystreamseek
 431++988E
 432++988E
 433++988E
 434++988E
 435++988E              cmdtable
 436++988E 4D           	db skip1           %256 ; 00
 437++988F 4D           	db skip1           %256 ; 01
 438++9890 4D           	db skip1           %256 ; 02
 439++9891 4D           	db skip1           %256 ; 03
 440++9892 4D           	db skip1           %256 ; 04
 441++9893 4D           	db skip1           %256 ; 05
 442++9894 4D           	db skip1           %256 ; 06
 443++9895 4D           	db skip1           %256 ; 07
 444++9896 4D           	db skip1           %256 ; 08
 445++9897 4D           	db skip1           %256 ; 09
 446++9898 4D           	db skip1           %256 ; 0A
 447++9899 4D           	db skip1           %256 ; 0B
 448++989A 4D           	db skip1           %256 ; 0C
 449++989B 4D           	db skip1           %256 ; 0D
 450++989C 4D           	db skip1           %256 ; 0E
 451++989D 4D           	db skip1           %256 ; 0F
 452++989E 4D           	db skip1           %256 ; 10
 453++989F 4D           	db skip1           %256 ; 11
 454++98A0 4D           	db skip1           %256 ; 12
 455++98A1 4D           	db skip1           %256 ; 13
 456++98A2 4D           	db skip1           %256 ; 14
 457++98A3 4D           	db skip1           %256 ; 15
 458++98A4 4D           	db skip1           %256 ; 16
 459++98A5 4D           	db skip1           %256 ; 17
 460++98A6 4D           	db skip1           %256 ; 18
 461++98A7 4D           	db skip1           %256 ; 19
 462++98A8 4D           	db skip1           %256 ; 1A
 463++98A9 4D           	db skip1           %256 ; 1B
 464++98AA 4D           	db skip1           %256 ; 1C
 465++98AB 4D           	db skip1           %256 ; 1D
 466++98AC 4D           	db skip1           %256 ; 1E
 467++98AD 4D           	db skip1           %256 ; 1F
 468++98AE 4D           	db skip1           %256 ; 20
 469++98AF 4D           	db skip1           %256 ; 21
 470++98B0 4D           	db skip1           %256 ; 22
 471++98B1 4D           	db skip1           %256 ; 23
 472++98B2 4D           	db skip1           %256 ; 24
 473++98B3 4D           	db skip1           %256 ; 25
 474++98B4 4D           	db skip1           %256 ; 26
 475++98B5 4D           	db skip1           %256 ; 27
 476++98B6 4D           	db skip1           %256 ; 28
 477++98B7 4D           	db skip1           %256 ; 29
 478++98B8 4D           	db skip1           %256 ; 2A
 479++98B9 4D           	db skip1           %256 ; 2B
 480++98BA 4D           	db skip1           %256 ; 2C
 481++98BB 4D           	db skip1           %256 ; 2D
 482++98BC 4D           	db skip1           %256 ; 2E
 483++98BD 4D           	db skip1           %256 ; 2F
 484++98BE 74           	db cmdunsupported  %256 ; 30
 485++98BF 4E           	db skip2           %256 ; 31
 486++98C0 4E           	db skip2           %256 ; 32
 487++98C1 4E           	db skip2           %256 ; 33
 488++98C2 4E           	db skip2           %256 ; 34
 489++98C3 4E           	db skip2           %256 ; 35
 490++98C4 4E           	db skip2           %256 ; 36
 491++98C5 4E           	db skip2           %256 ; 37
 492++98C6 4E           	db skip2           %256 ; 38
 493++98C7 4E           	db skip2           %256 ; 39
 494++98C8 4E           	db skip2           %256 ; 3A
 495++98C9 4E           	db skip2           %256 ; 3B
 496++98CA 4E           	db skip2           %256 ; 3C
 497++98CB 4E           	db skip2           %256 ; 3D
 498++98CC 4E           	db skip2           %256 ; 3E
 499++98CD 4E           	db skip2           %256 ; 3F
 500++98CE 53           	db skip3           %256 ; 40
 501++98CF 53           	db skip3           %256 ; 41
 502++98D0 53           	db skip3           %256 ; 42
 503++98D1 53           	db skip3           %256 ; 43
 504++98D2 53           	db skip3           %256 ; 44
 505++98D3 53           	db skip3           %256 ; 45
 506++98D4 53           	db skip3           %256 ; 46
 507++98D5 53           	db skip3           %256 ; 47
 508++98D6 53           	db skip3           %256 ; 48
 509++98D7 53           	db skip3           %256 ; 49
 510++98D8 53           	db skip3           %256 ; 4A
 511++98D9 53           	db skip3           %256 ; 4B
 512++98DA 53           	db skip3           %256 ; 4C
 513++98DB 53           	db skip3           %256 ; 4D
 514++98DC 53           	db skip3           %256 ; 4E
 515++98DD 4E           	db skip2           %256 ; 4F
 516++98DE 74           	db cmdunsupported  %256 ; 50
 517++98DF 74           	db cmdunsupported  %256 ; 51
 518++98E0 74           	db cmdunsupported  %256 ; 52
 519++98E1 74           	db cmdunsupported  %256 ; 53
 520++98E2 F8           	db cmdYM2151       %256 ; 54
 521++98E3 77           	db cmdYM2203       %256 ; 55
 522++98E4 77           	db cmdYM2608p0     %256 ; 56
 523++98E5 8E           	db cmdYM2608p1     %256 ; 57
 524++98E6 74           	db cmdunsupported  %256 ; 58
 525++98E7 74           	db cmdunsupported  %256 ; 59
 526++98E8 CA           	db cmdYM3812       %256 ; 5A
 527++98E9 CA           	db cmdYM3526       %256 ; 5B
 528++98EA CA           	db cmdY8950        %256 ; 5C
 529++98EB 53           	db skip3           %256 ; 5D
 530++98EC CA           	db cmdYMF262p0     %256 ; 5E
 531++98ED E1           	db cmdYMF262p1     %256 ; 5F
 532++98EE 74           	db cmdunsupported  %256 ; 60
 533++98EF 2C           	db waitvar         %256 ; 61
 534++98F0 16           	db wait735         %256 ; 62
 535++98F1 26           	db wait882         %256 ; 63
 536++98F2 74           	db cmdunsupported  %256 ; 64
 537++98F3 74           	db cmdunsupported  %256 ; 65
 538++98F4 71           	db endofsounddata  %256 ; 66
 539++98F5 44           	db cmddatablock    %256 ; 67
 540++98F6 6C           	db skip12          %256 ; 68
 541++98F7 74           	db cmdunsupported  %256 ; 69
 542++98F8 74           	db cmdunsupported  %256 ; 6A
 543++98F9 74           	db cmdunsupported  %256 ; 6B
 544++98FA 74           	db cmdunsupported  %256 ; 6C
 545++98FB 74           	db cmdunsupported  %256 ; 6D
 546++98FC 74           	db cmdunsupported  %256 ; 6E
 547++98FD 74           	db cmdunsupported  %256 ; 6F
 548++98FE B3           	db wait1           %256 ; 70
 549++98FF C0           	db wait2           %256 ; 71
 550++9900 D0           	db wait3           %256 ; 72
 551++9901 D5           	db wait4           %256 ; 73
 552++9902 DA           	db wait5           %256 ; 74
 553++9903 DF           	db wait6           %256 ; 75
 554++9904 E4           	db wait7           %256 ; 76
 555++9905 E9           	db wait8           %256 ; 77
 556++9906 EE           	db wait9           %256 ; 78
 557++9907 F3           	db wait10          %256 ; 79
 558++9908 F8           	db wait11          %256 ; 7A
 559++9909 FD           	db wait12          %256 ; 7B
 560++990A 02           	db wait13          %256 ; 7C
 561++990B 07           	db wait14          %256 ; 7D
 562++990C 0C           	db wait15          %256 ; 7E
 563++990D 11           	db wait16          %256 ; 7F
 564++990E 4D           	db skip1           %256 ; 80
 565++990F B3           	db wait1           %256 ; 81
 566++9910 C0           	db wait2           %256 ; 82
 567++9911 D0           	db wait3           %256 ; 83
 568++9912 D5           	db wait4           %256 ; 84
 569++9913 DA           	db wait5           %256 ; 85
 570++9914 DF           	db wait6           %256 ; 86
 571++9915 E4           	db wait7           %256 ; 87
 572++9916 E9           	db wait8           %256 ; 88
 573++9917 EE           	db wait9           %256 ; 89
 574++9918 F3           	db wait10          %256 ; 8A
 575++9919 F8           	db wait11          %256 ; 8B
 576++991A FD           	db wait12          %256 ; 8C
 577++991B 02           	db wait13          %256 ; 8D
 578++991C 07           	db wait14          %256 ; 8E
 579++991D 0C           	db wait15          %256 ; 8F
 580++991E 5D           	db skip5           %256 ; 90
 581++991F 5D           	db skip5           %256 ; 91
 582++9920 62           	db skip6           %256 ; 92
 583++9921 67           	db skip11          %256 ; 93
 584++9922 4E           	db skip2           %256 ; 94
 585++9923 5D           	db skip5           %256 ; 95
 586++9924 74           	db cmdunsupported  %256 ; 96
 587++9925 74           	db cmdunsupported  %256 ; 97
 588++9926 74           	db cmdunsupported  %256 ; 98
 589++9927 74           	db cmdunsupported  %256 ; 99
 590++9928 74           	db cmdunsupported  %256 ; 9A
 591++9929 74           	db cmdunsupported  %256 ; 9B
 592++992A 74           	db cmdunsupported  %256 ; 9C
 593++992B 74           	db cmdunsupported  %256 ; 9D
 594++992C 74           	db cmdunsupported  %256 ; 9E
 595++992D 74           	db cmdunsupported  %256 ; 9F
 596++992E 26           	db cmdAY8910       %256 ; A0
 597++992F 53           	db skip3           %256 ; A1
 598++9930 74           	db cmdunsupported  %256 ; A2
 599++9931 74           	db cmdunsupported  %256 ; A3
 600++9932 0F           	db cmdYM2151dp     %256 ; A4
 601++9933 8E           	db cmdYM2203dp     %256 ; A5
 602++9934 53           	db skip3           %256 ; A6
 603++9935 53           	db skip3           %256 ; A7
 604++9936 53           	db skip3           %256 ; A8
 605++9937 53           	db skip3           %256 ; A9
 606++9938 E1           	db cmdYM3812dp     %256 ; AA
 607++9939 E1           	db cmdYM3526dp     %256 ; AB
 608++993A E1           	db cmdY8950dp      %256 ; AC
 609++993B 53           	db skip3           %256 ; AD
 610++993C 40           	db cmdYMF262dp0    %256 ; AE
 611++993D 40           	db cmdYMF262dp0    %256 ; AF
 612++993E 53           	db skip3           %256 ; B0
 613++993F 53           	db skip3           %256 ; B1
 614++9940 53           	db skip3           %256 ; B2
 615++9941 53           	db skip3           %256 ; B3
 616++9942 53           	db skip3           %256 ; B4
 617++9943 53           	db skip3           %256 ; B5
 618++9944 53           	db skip3           %256 ; B6
 619++9945 53           	db skip3           %256 ; B7
 620++9946 53           	db skip3           %256 ; B8
 621++9947 53           	db skip3           %256 ; B9
 622++9948 53           	db skip3           %256 ; BA
 623++9949 53           	db skip3           %256 ; BB
 624++994A 53           	db skip3           %256 ; BC
 625++994B 53           	db skip3           %256 ; BD
 626++994C 53           	db skip3           %256 ; BE
 627++994D 53           	db skip3           %256 ; BF
 628++994E 58           	db skip4           %256 ; C0
 629++994F 58           	db skip4           %256 ; C1
 630++9950 58           	db skip4           %256 ; C2
 631++9951 58           	db skip4           %256 ; C3
 632++9952 58           	db skip4           %256 ; C4
 633++9953 58           	db skip4           %256 ; C5
 634++9954 58           	db skip4           %256 ; C6
 635++9955 58           	db skip4           %256 ; C7
 636++9956 58           	db skip4           %256 ; C8
 637++9957 58           	db skip4           %256 ; C9
 638++9958 58           	db skip4           %256 ; CA
 639++9959 58           	db skip4           %256 ; CB
 640++995A 58           	db skip4           %256 ; CC
 641++995B 58           	db skip4           %256 ; CD
 642++995C 58           	db skip4           %256 ; CE
 643++995D 58           	db skip4           %256 ; CF
 644++995E A5           	db cmdYMF278B      %256 ; D0
 645++995F 58           	db skip4           %256 ; D1
 646++9960 74           	db cmdunsupported  %256 ; D2
 647++9961 58           	db skip4           %256 ; D3
 648++9962 58           	db skip4           %256 ; D4
 649++9963 58           	db skip4           %256 ; D5
 650++9964 58           	db skip4           %256 ; D6
 651++9965 58           	db skip4           %256 ; D7
 652++9966 58           	db skip4           %256 ; D8
 653++9967 58           	db skip4           %256 ; D9
 654++9968 58           	db skip4           %256 ; DA
 655++9969 58           	db skip4           %256 ; DB
 656++996A 58           	db skip4           %256 ; DC
 657++996B 58           	db skip4           %256 ; DD
 658++996C 58           	db skip4           %256 ; DE
 659++996D 58           	db skip4           %256 ; DF
 660++996E 74           	db cmdunsupported  %256 ; E0
 661++996F 5D           	db skip5           %256 ; E1
 662++9970 5D           	db skip5           %256 ; E2
 663++9971 5D           	db skip5           %256 ; E3
 664++9972 5D           	db skip5           %256 ; E4
 665++9973 5D           	db skip5           %256 ; E5
 666++9974 5D           	db skip5           %256 ; E6
 667++9975 5D           	db skip5           %256 ; E7
 668++9976 5D           	db skip5           %256 ; E8
 669++9977 5D           	db skip5           %256 ; E9
 670++9978 5D           	db skip5           %256 ; EA
 671++9979 5D           	db skip5           %256 ; EB
 672++997A 5D           	db skip5           %256 ; EC
 673++997B 5D           	db skip5           %256 ; ED
 674++997C 5D           	db skip5           %256 ; EE
 675++997D 5D           	db skip5           %256 ; EF
 676++997E 5D           	db skip5           %256 ; F0
 677++997F 5D           	db skip5           %256 ; F1
 678++9980 5D           	db skip5           %256 ; F2
 679++9981 5D           	db skip5           %256 ; F3
 680++9982 5D           	db skip5           %256 ; F4
 681++9983 5D           	db skip5           %256 ; F5
 682++9984 5D           	db skip5           %256 ; F6
 683++9985 5D           	db skip5           %256 ; F7
 684++9986 5D           	db skip5           %256 ; F8
 685++9987 5D           	db skip5           %256 ; F9
 686++9988 5D           	db skip5           %256 ; FA
 687++9989 5D           	db skip5           %256 ; FB
 688++998A 5D           	db skip5           %256 ; FC
 689++998B 5D           	db skip5           %256 ; FD
 690++998C 5D           	db skip5           %256 ; FE
 691++998D 5D           	db skip5           %256 ; FF
 692++998E 97           	db skip1           /256 ; 00
 693++998F 97           	db skip1           /256 ; 01
 694++9990 97           	db skip1           /256 ; 02
 695++9991 97           	db skip1           /256 ; 03
 696++9992 97           	db skip1           /256 ; 04
 697++9993 97           	db skip1           /256 ; 05
 698++9994 97           	db skip1           /256 ; 06
 699++9995 97           	db skip1           /256 ; 07
 700++9996 97           	db skip1           /256 ; 08
 701++9997 97           	db skip1           /256 ; 09
 702++9998 97           	db skip1           /256 ; 0A
 703++9999 97           	db skip1           /256 ; 0B
 704++999A 97           	db skip1           /256 ; 0C
 705++999B 97           	db skip1           /256 ; 0D
 706++999C 97           	db skip1           /256 ; 0E
 707++999D 97           	db skip1           /256 ; 0F
 708++999E 97           	db skip1           /256 ; 10
 709++999F 97           	db skip1           /256 ; 11
 710++99A0 97           	db skip1           /256 ; 12
 711++99A1 97           	db skip1           /256 ; 13
 712++99A2 97           	db skip1           /256 ; 14
 713++99A3 97           	db skip1           /256 ; 15
 714++99A4 97           	db skip1           /256 ; 16
 715++99A5 97           	db skip1           /256 ; 17
 716++99A6 97           	db skip1           /256 ; 18
 717++99A7 97           	db skip1           /256 ; 19
 718++99A8 97           	db skip1           /256 ; 1A
 719++99A9 97           	db skip1           /256 ; 1B
 720++99AA 97           	db skip1           /256 ; 1C
 721++99AB 97           	db skip1           /256 ; 1D
 722++99AC 97           	db skip1           /256 ; 1E
 723++99AD 97           	db skip1           /256 ; 1F
 724++99AE 97           	db skip1           /256 ; 20
 725++99AF 97           	db skip1           /256 ; 21
 726++99B0 97           	db skip1           /256 ; 22
 727++99B1 97           	db skip1           /256 ; 23
 728++99B2 97           	db skip1           /256 ; 24
 729++99B3 97           	db skip1           /256 ; 25
 730++99B4 97           	db skip1           /256 ; 26
 731++99B5 97           	db skip1           /256 ; 27
 732++99B6 97           	db skip1           /256 ; 28
 733++99B7 97           	db skip1           /256 ; 29
 734++99B8 97           	db skip1           /256 ; 2A
 735++99B9 97           	db skip1           /256 ; 2B
 736++99BA 97           	db skip1           /256 ; 2C
 737++99BB 97           	db skip1           /256 ; 2D
 738++99BC 97           	db skip1           /256 ; 2E
 739++99BD 97           	db skip1           /256 ; 2F
 740++99BE 97           	db cmdunsupported  /256 ; 30
 741++99BF 97           	db skip2           /256 ; 31
 742++99C0 97           	db skip2           /256 ; 32
 743++99C1 97           	db skip2           /256 ; 33
 744++99C2 97           	db skip2           /256 ; 34
 745++99C3 97           	db skip2           /256 ; 35
 746++99C4 97           	db skip2           /256 ; 36
 747++99C5 97           	db skip2           /256 ; 37
 748++99C6 97           	db skip2           /256 ; 38
 749++99C7 97           	db skip2           /256 ; 39
 750++99C8 97           	db skip2           /256 ; 3A
 751++99C9 97           	db skip2           /256 ; 3B
 752++99CA 97           	db skip2           /256 ; 3C
 753++99CB 97           	db skip2           /256 ; 3D
 754++99CC 97           	db skip2           /256 ; 3E
 755++99CD 97           	db skip2           /256 ; 3F
 756++99CE 97           	db skip3           /256 ; 40
 757++99CF 97           	db skip3           /256 ; 41
 758++99D0 97           	db skip3           /256 ; 42
 759++99D1 97           	db skip3           /256 ; 43
 760++99D2 97           	db skip3           /256 ; 44
 761++99D3 97           	db skip3           /256 ; 45
 762++99D4 97           	db skip3           /256 ; 46
 763++99D5 97           	db skip3           /256 ; 47
 764++99D6 97           	db skip3           /256 ; 48
 765++99D7 97           	db skip3           /256 ; 49
 766++99D8 97           	db skip3           /256 ; 4A
 767++99D9 97           	db skip3           /256 ; 4B
 768++99DA 97           	db skip3           /256 ; 4C
 769++99DB 97           	db skip3           /256 ; 4D
 770++99DC 97           	db skip3           /256 ; 4E
 771++99DD 97           	db skip2           /256 ; 4F
 772++99DE 97           	db cmdunsupported  /256 ; 50
 773++99DF 97           	db cmdunsupported  /256 ; 51
 774++99E0 97           	db cmdunsupported  /256 ; 52
 775++99E1 97           	db cmdunsupported  /256 ; 53
 776++99E2 97           	db cmdYM2151       /256 ; 54
 777++99E3 97           	db cmdYM2203       /256 ; 55
 778++99E4 97           	db cmdYM2608p0     /256 ; 56
 779++99E5 9A           	db cmdYM2608p1     /256 ; 57
 780++99E6 97           	db cmdunsupported  /256 ; 58
 781++99E7 97           	db cmdunsupported  /256 ; 59
 782++99E8 97           	db cmdYM3812       /256 ; 5A
 783++99E9 97           	db cmdYM3526       /256 ; 5B
 784++99EA 97           	db cmdY8950        /256 ; 5C
 785++99EB 97           	db skip3           /256 ; 5D
 786++99EC 97           	db cmdYMF262p0     /256 ; 5E
 787++99ED 97           	db cmdYMF262p1     /256 ; 5F
 788++99EE 97           	db cmdunsupported  /256 ; 60
 789++99EF 97           	db waitvar         /256 ; 61
 790++99F0 97           	db wait735         /256 ; 62
 791++99F1 97           	db wait882         /256 ; 63
 792++99F2 97           	db cmdunsupported  /256 ; 64
 793++99F3 97           	db cmdunsupported  /256 ; 65
 794++99F4 97           	db endofsounddata  /256 ; 66
 795++99F5 98           	db cmddatablock    /256 ; 67
 796++99F6 97           	db skip12          /256 ; 68
 797++99F7 97           	db cmdunsupported  /256 ; 69
 798++99F8 97           	db cmdunsupported  /256 ; 6A
 799++99F9 97           	db cmdunsupported  /256 ; 6B
 800++99FA 97           	db cmdunsupported  /256 ; 6C
 801++99FB 97           	db cmdunsupported  /256 ; 6D
 802++99FC 97           	db cmdunsupported  /256 ; 6E
 803++99FD 97           	db cmdunsupported  /256 ; 6F
 804++99FE 96           	db wait1           /256 ; 70
 805++99FF 96           	db wait2           /256 ; 71
 806++9A00 96           	db wait3           /256 ; 72
 807++9A01 96           	db wait4           /256 ; 73
 808++9A02 96           	db wait5           /256 ; 74
 809++9A03 96           	db wait6           /256 ; 75
 810++9A04 96           	db wait7           /256 ; 76
 811++9A05 96           	db wait8           /256 ; 77
 812++9A06 96           	db wait9           /256 ; 78
 813++9A07 96           	db wait10          /256 ; 79
 814++9A08 96           	db wait11          /256 ; 7A
 815++9A09 96           	db wait12          /256 ; 7B
 816++9A0A 97           	db wait13          /256 ; 7C
 817++9A0B 97           	db wait14          /256 ; 7D
 818++9A0C 97           	db wait15          /256 ; 7E
 819++9A0D 97           	db wait16          /256 ; 7F
 820++9A0E 97           	db skip1           /256 ; 80
 821++9A0F 96           	db wait1           /256 ; 81
 822++9A10 96           	db wait2           /256 ; 82
 823++9A11 96           	db wait3           /256 ; 83
 824++9A12 96           	db wait4           /256 ; 84
 825++9A13 96           	db wait5           /256 ; 85
 826++9A14 96           	db wait6           /256 ; 86
 827++9A15 96           	db wait7           /256 ; 87
 828++9A16 96           	db wait8           /256 ; 88
 829++9A17 96           	db wait9           /256 ; 89
 830++9A18 96           	db wait10          /256 ; 8A
 831++9A19 96           	db wait11          /256 ; 8B
 832++9A1A 96           	db wait12          /256 ; 8C
 833++9A1B 97           	db wait13          /256 ; 8D
 834++9A1C 97           	db wait14          /256 ; 8E
 835++9A1D 97           	db wait15          /256 ; 8F
 836++9A1E 97           	db skip5           /256 ; 90
 837++9A1F 97           	db skip5           /256 ; 91
 838++9A20 97           	db skip6           /256 ; 92
 839++9A21 97           	db skip11          /256 ; 93
 840++9A22 97           	db skip2           /256 ; 94
 841++9A23 97           	db skip5           /256 ; 95
 842++9A24 97           	db cmdunsupported  /256 ; 96
 843++9A25 97           	db cmdunsupported  /256 ; 97
 844++9A26 97           	db cmdunsupported  /256 ; 98
 845++9A27 97           	db cmdunsupported  /256 ; 99
 846++9A28 97           	db cmdunsupported  /256 ; 9A
 847++9A29 97           	db cmdunsupported  /256 ; 9B
 848++9A2A 97           	db cmdunsupported  /256 ; 9C
 849++9A2B 97           	db cmdunsupported  /256 ; 9D
 850++9A2C 97           	db cmdunsupported  /256 ; 9E
 851++9A2D 97           	db cmdunsupported  /256 ; 9F
 852++9A2E 98           	db cmdAY8910       /256 ; A0
 853++9A2F 97           	db skip3           /256 ; A1
 854++9A30 97           	db cmdunsupported  /256 ; A2
 855++9A31 97           	db cmdunsupported  /256 ; A3
 856++9A32 98           	db cmdYM2151dp     /256 ; A4
 857++9A33 97           	db cmdYM2203dp     /256 ; A5
 858++9A34 97           	db skip3           /256 ; A6
 859++9A35 97           	db skip3           /256 ; A7
 860++9A36 97           	db skip3           /256 ; A8
 861++9A37 97           	db skip3           /256 ; A9
 862++9A38 97           	db cmdYM3812dp     /256 ; AA
 863++9A39 97           	db cmdYM3526dp     /256 ; AB
 864++9A3A 97           	db cmdY8950dp      /256 ; AC
 865++9A3B 97           	db skip3           /256 ; AD
 866++9A3C 90           	db cmdYMF262dp0    /256 ; AE
 867++9A3D 90           	db cmdYMF262dp0    /256 ; AF
 868++9A3E 97           	db skip3           /256 ; B0
 869++9A3F 97           	db skip3           /256 ; B1
 870++9A40 97           	db skip3           /256 ; B2
 871++9A41 97           	db skip3           /256 ; B3
 872++9A42 97           	db skip3           /256 ; B4
 873++9A43 97           	db skip3           /256 ; B5
 874++9A44 97           	db skip3           /256 ; B6
 875++9A45 97           	db skip3           /256 ; B7
 876++9A46 97           	db skip3           /256 ; B8
 877++9A47 97           	db skip3           /256 ; B9
 878++9A48 97           	db skip3           /256 ; BA
 879++9A49 97           	db skip3           /256 ; BB
 880++9A4A 97           	db skip3           /256 ; BC
 881++9A4B 97           	db skip3           /256 ; BD
 882++9A4C 97           	db skip3           /256 ; BE
 883++9A4D 97           	db skip3           /256 ; BF
 884++9A4E 97           	db skip4           /256 ; C0
 885++9A4F 97           	db skip4           /256 ; C1
 886++9A50 97           	db skip4           /256 ; C2
 887++9A51 97           	db skip4           /256 ; C3
 888++9A52 97           	db skip4           /256 ; C4
 889++9A53 97           	db skip4           /256 ; C5
 890++9A54 97           	db skip4           /256 ; C6
 891++9A55 97           	db skip4           /256 ; C7
 892++9A56 97           	db skip4           /256 ; C8
 893++9A57 97           	db skip4           /256 ; C9
 894++9A58 97           	db skip4           /256 ; CA
 895++9A59 97           	db skip4           /256 ; CB
 896++9A5A 97           	db skip4           /256 ; CC
 897++9A5B 97           	db skip4           /256 ; CD
 898++9A5C 97           	db skip4           /256 ; CE
 899++9A5D 97           	db skip4           /256 ; CF
 900++9A5E 97           	db cmdYMF278B      /256 ; D0
 901++9A5F 97           	db skip4           /256 ; D1
 902++9A60 97           	db cmdunsupported  /256 ; D2
 903++9A61 97           	db skip4           /256 ; D3
 904++9A62 97           	db skip4           /256 ; D4
 905++9A63 97           	db skip4           /256 ; D5
 906++9A64 97           	db skip4           /256 ; D6
 907++9A65 97           	db skip4           /256 ; D7
 908++9A66 97           	db skip4           /256 ; D8
 909++9A67 97           	db skip4           /256 ; D9
 910++9A68 97           	db skip4           /256 ; DA
 911++9A69 97           	db skip4           /256 ; DB
 912++9A6A 97           	db skip4           /256 ; DC
 913++9A6B 97           	db skip4           /256 ; DD
 914++9A6C 97           	db skip4           /256 ; DE
 915++9A6D 97           	db skip4           /256 ; DF
 916++9A6E 97           	db cmdunsupported  /256 ; E0
 917++9A6F 97           	db skip5           /256 ; E1
 918++9A70 97           	db skip5           /256 ; E2
 919++9A71 97           	db skip5           /256 ; E3
 920++9A72 97           	db skip5           /256 ; E4
 921++9A73 97           	db skip5           /256 ; E5
 922++9A74 97           	db skip5           /256 ; E6
 923++9A75 97           	db skip5           /256 ; E7
 924++9A76 97           	db skip5           /256 ; E8
 925++9A77 97           	db skip5           /256 ; E9
 926++9A78 97           	db skip5           /256 ; EA
 927++9A79 97           	db skip5           /256 ; EB
 928++9A7A 97           	db skip5           /256 ; EC
 929++9A7B 97           	db skip5           /256 ; ED
 930++9A7C 97           	db skip5           /256 ; EE
 931++9A7D 97           	db skip5           /256 ; EF
 932++9A7E 97           	db skip5           /256 ; F0
 933++9A7F 97           	db skip5           /256 ; F1
 934++9A80 97           	db skip5           /256 ; F2
 935++9A81 97           	db skip5           /256 ; F3
 936++9A82 97           	db skip5           /256 ; F4
 937++9A83 97           	db skip5           /256 ; F5
 938++9A84 97           	db skip5           /256 ; F6
 939++9A85 97           	db skip5           /256 ; F7
 940++9A86 97           	db skip5           /256 ; F8
 941++9A87 97           	db skip5           /256 ; F9
 942++9A88 97           	db skip5           /256 ; FA
 943++9A89 97           	db skip5           /256 ; FB
 944++9A8A 97           	db skip5           /256 ; FC
 945++9A8B 97           	db skip5           /256 ; FD
 946++9A8C 97           	db skip5           /256 ; FE
 947++9A8D 97           	db skip5           /256 ; FF
 948++9A8E
 949++9A8E
 950++9A8E
 951++9A8E              cmdYM2608p0 equ cmdYM2203
 952++9A8E
 953++9A8E              cmdYM2608p1
 954++9A8E              	memory_stream_read_2 e,d
 954++9A8E 2A 72 90    >	ld hl,(memorystreamcurrentaddr)
 954++9A91             >	memory_stream_read_byte e
 954++9A91 CB 74       >	bit 6,h
 954++9A93             >        IF AREA_C000_FFFF=1
 954++9A93 CC 0D 90    >	call z,memorystreamnextpage
 954++9A96             >        ELSE
 954++9A96 ~           > 	call nz,memorystreamnextpage
 954++9A96             >        ENDIF
 954++9A96 5E          >	ld e,(hl)
 954++9A97 23          >	inc hl
 954++9A98             >	memory_stream_read_byte d
 954++9A98 CB 74       >	bit 6,h
 954++9A9A             >        IF AREA_C000_FFFF=1
 954++9A9A CC 0D 90    >	call z,memorystreamnextpage
 954++9A9D             >        ELSE
 954++9A9D ~           > 	call nz,memorystreamnextpage
 954++9A9D             >        ENDIF
 954++9A9D 56          >	ld d,(hl)
 954++9A9E 23          >	inc hl
 954++9A9F 22 72 90    >	ld (memorystreamcurrentaddr),hl
 955++9AA2 7B           	ld a,e
 956++9AA3 FE 30        	cp 0x30
 957++9AA5 D8           	ret c
 958++9AA6 C3 A0 94     	jp opnwritefm2
 959++9AA9
 960++9AA9
 961++9AA9              initAY8910
 962++9AA9 CD AD 95     	call ssginit
 963++9AAC 21 66 96     	ld hl,devicemask
 964++9AAF 3A 77 BE     	ld a,(HEADER_CLOCK_AY8910+3)
 965++9AB2 E6 40        	and 0x40
 966++9AB4 20 03        	jr nz,.dualchip
 967++9AB6 CB C6        	set DEVICE_AY_BIT,(hl)
 968++9AB8 C9           	ret
 969++9AB9              .dualchip
 970++9AB9 CB CE        	set DEVICE_TURBOSOUND_BIT,(hl)
 971++9ABB C9           	ret
 972++9ABC
 973++9ABC              initYM2203
 974++9ABC              tfmstatus=$+1
 975++9ABC 3E 01        	ld a,1
 976++9ABE 3D           	dec a
 977++9ABF F8           	ret m
 978++9AC0 CD AB 94     	call opninit
 979++9AC3              	set_timer opnwaittimer60hz,735
 979++9AC3 21 DF 02    >	ld hl,735
 979++9AC6 22 86 96    >	ld (waittimerstep),hl
 980++9AC9 CD 41 95     	call opninittimer60hz
 981++9ACC 21 66 96     	ld hl,devicemask
 982++9ACF CB D6        	set DEVICE_TFM_BIT,(hl)
 983++9AD1 AF           	xor a
 984++9AD2 C9           	ret
 985++9AD3
 986++9AD3              initYMF278B
 987++9AD3              moonsoundstatus=$+1
 988++9AD3 3E 02        	ld a,2
 989++9AD5 3D           	dec a
 990++9AD6 F8           	ret m
 991++9AD7 CD 6D 93     	call vgmopl4init
 992++9ADA 3A 53 BE     	ld a,(HEADER_CLOCK_YM3812+3)
 993++9ADD E6 40        	and 0x40
 994++9ADF 20 08        	jr nz,notOPL2
 995++9AE1              useYM3812=$+1
 996++9AE1 F6 00        	or 0
 997++9AE3 11 05 00     	ld de,0x0005
 998++9AE6 C4 33 91     	call nz,opl4writefm2
 999++9AE9              notOPL2
1000++9AE9 CD 64 94     	call opl4inittimer60hz
1001++9AEC 21 66 96     	ld hl,devicemask
1002++9AEF CB DE        	set DEVICE_MOONSOUND_BIT,(hl)
1003++9AF1 AF           	xor a
1004++9AF2 C9           	ret
1005++9AF3
1006++9AF3              end
1007++9AF3
1008++9AF3
1009++9AF3
1010++9AF3              ;        LABELSLIST "vgm_plr.l"
1011++9AF3              ;	savebin "gplay.apg",begin,end-begin
# file closed: GPlay/vgm.asm
 824+ 9AF3              	include sub_func.asm
# file opened: GPlay/sub_func.asm
   1++9AF3
   2++9AF3              fileopenerror
   3++9AF3 79           		ld a,c
   4++9AF4 0E FF        		ld c,$FF
   5++9AF6 02                   ld (bc),a ;   
   6++9AF7
   7++9AF7 21 20 9F     		ld hl,msg_file_error
   8++9AFA              		OS_PRINTZ
   8++9AFA 0E 09       >    ld c,#09
   8++9AFC E7          >    rst #20
   9++9AFD
  10++9AFD 3A 5B 9E     		ld a,(file_id_cur_r)
  11++9B00 FE FF        		cp 255
  12++9B02 28 03        		jr z,fileopenerror1
  13++9B04              		OS_FILE_CLOSE ;A - id file
  13++9B04 0E 25       >    ld c,#25
  13++9B06 E7          >    rst #20
  14++9B07              fileopenerror1
  15++9B07 37           		scf ;
  16++9B08 C9           		ret
  17++9B09
  18++9B09
  19++9B09              ; memoryerror
  20++9B09                      ; OS_CLOSEHANDLE
  21++9B09                      ; ld e,6+0x80
  22++9B09                      ; OS_SETGFX
  23++9B09                      ; ld e,0
  24++9B09                      ; OS_CLS
  25++9B09                      ; ld hl,txt_memoryerror
  26++9B09                      ; call print_hl
  27++9B09                      ; YIELDGETKEYLOOP
  28++9B09                      ; jp cmd_quit
  29++9B09
  30++9B09              memoryerror
  31++9B09 79           		ld a,c
  32++9B0A 0E FF        		ld c,$FF
  33++9B0C 02                   ld (bc),a ;   
  34++9B0D
  35++9B0D 21 A2 8E     		ld hl,txt_memoryerror
  36++9B10              		OS_PRINTZ
  36++9B10 0E 09       >    ld c,#09
  36++9B12 E7          >    rst #20
  37++9B13
  38++9B13 3A 5B 9E     		ld a,(file_id_cur_r)
  39++9B16 FE FF        		cp 255
  40++9B18 28 03        		jr z,memoryerror1
  41++9B1A              		OS_FILE_CLOSE ;A - id file
  41++9B1A 0E 25       >    ld c,#25
  41++9B1C E7          >    rst #20
  42++9B1D              memoryerror1
  43++9B1D 37           		scf ;
  44++9B1E C9           		ret
  45++9B1F
  46++9B1F
  47++9B1F
  48++9B1F              ;----------------------------------------
  49++9B1F              load_mus
  50++9B1F
  51++9B1F                      ; ld b,0
  52++9B1F              ; old_mus EQU $-1
  53++9B1F                      ; cp b
  54++9B1F                      ; ret z
  55++9B1F                      ; ld (old_mus),a
  56++9B1F
  57++9B1F                      ; and a
  58++9B1F                      ; jp z,no_mus
  59++9B1F
  60++9B1F
  61++9B1F                      ; call calc_mus
  62++9B1F
  63++9B1F                      ; call no_mus
  64++9B1F                      ; ld hl,t_s98_file00_pages_list+$FF
  65++9B1F                      ; call free_s98_file ; 
  66++9B1F
  67++9B1F                      ;generate path to music file in 'buf'
  68++9B1F                      ; ld hl,mus_path1
  69++9B1F                      ; ld de,buf
  70++9B1F                      ; call copystr_hlde ;'copy path  'mus/' '
  71++9B1F
  72++9B1F                      ; ld a,(mus_mode)
  73++9B1F                      ; ld hl,mus_modes
  74++9B1F                      ; call sel_word
  75++9B1F                      ; call copystr_hlde ;copy "aym / s98 path"
  76++9B1F                      ; ld hl,mus_path2
  77++9B1F                      ; call copystr_hlde ;copy name without ext
  78++9B1F
  79++9B1F                      ; ld a,(mus_mode)
  80++9B1F                      ; ld hl,plr_ext
  81++9B1F                      ; call sel_word
  82++9B1F                      ; call copystr_hlde  ;copy file ext
  83++9B1F                      ; xor a
  84++9B1F                      ; ld (de),a  ;string terminator
  85++9B1F
  86++9B1F                      ; ld de,buf ; 
  87++9B1F                      ; call openstream_file
  88++9B1F
  89++9B1F 21 4A 9C     		ld hl,file_name_cur
  90++9B22              		OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
  90++9B22 0E 21       >    ld c,#21
  90++9B24 E7          >    rst #20
  91++9B25
  92++9B25                      ;or a
  93++9B25                      ;jp nz,fileopenerror
  94++9B25 DA F3 9A     		jp c,fileopenerror
  95++9B28 32 5B 9E     		ld (file_id_cur_r),a
  96++9B2B
  97++9B2B 21 00 8F             ld hl,memorystreampages ;t_s98_file00_pages_list
  98++9B2E 22 32 9B             ld (load_s98_file_number),hl
  99++9B31
 100++9B31
 101++9B31              /////------        call load_s98_file      ;de=drive/path/file
 102++9B31
 103++9B31              ;    
 104++9B31              ;   
 105++9B31
 106++9B31                              ;   
 107++9B31
 108++9B31
 109++9B31              load_s98_file_number_haddr = $+2
 109++9B31
 110++9B31              load_s98_file_number = $+1
 110++9B31
 111++9B31 01 00 8F                     ld bc,memorystreampages ;t_s98_file00_pages_list
 112++9B34 C5                           push bc
 113++9B35
 114++9B35              read_file_loop:
 115++9B35                              ;OS_NEWPAGE              ;out: a=0 (OK)/!=0 (fail), e=page
 116++9B35              				OS_GET_PAGE ;*
 116++9B35 0E 1A       >    ld c,#1a
 116++9B37 E7          >    rst #20
 117++9B38
 118++9B38 C1                           pop bc ;file tab
 119++9B39
 120++9B39                              ;or a
 121++9B39                              ;jp nz,memory_error
 122++9B39 DA 7C 9B     				jp c,memory_error
 123++9B3C                              ;ld a,e
 124++9B3C                                                      ;    !!!!
 125++9B3C                                                      ;    !!!!
 126++9B3C
 127++9B3C 02           1               ld (bc),a
 128++9B3D 0C                           inc c           ;      4 !!!!!
 129++9B3E
 130++9B3E C5                           push bc ;file tab
 131++9B3F                              ;SETPGC000
 132++9B3F              				OS_SET_PAGE_SLOT3
 132++9B3F 0E 1C       >    ld c,#1c
 132++9B41 E7          >    rst #20
 133++9B42
 134++9B42                              ;ld de,$C000
 135++9B42                              ;ld hl,$4000
 136++9B42
 137++9B42                              ;call readstream_file    ;DE = Buffer address, HL = Number of bytes to read
 138++9B42                                              ;hl=actual size
 139++9B42
 140++9B42 3A 5B 9E     				ld a,(file_id_cur_r)
 141++9B45 21 00 C0     				ld hl,$C000
 142++9B48 11 00 40                     ld de,$4000
 143++9B4B              				OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl -    )
 143++9B4B 0E 23       >    ld c,#23
 143++9B4D E7          >    rst #20
 144++9B4E 30 04        				jr nc,read_file_loop1
 145++9B50
 146++9B50              				; 
 147++9B50 C1                           pop bc ;file tab
 148++9B51 C3 F3 9A                     jp fileopenerror
 149++9B54
 150++9B54
 151++9B54              read_file_loop1		;
 152++9B54 7C                           ld a,h
 153++9B55                              ; cp $40
 154++9B55                              ; jr nc,read_file_loop    ;>= $40
 155++9B55 FE C0        				cp $c0
 156++9B57 38 DC                        jr c,read_file_loop    ;>= $c0,   
 157++9B59
 158++9B59
 159++9B59              read_file_exit
 160++9B59
 161++9B59 C1                           pop bc ;file tab
 162++9B5A                              ;    
 163++9B5A 79                           ld a,c
 164++9B5B
 165++9B5B                             // sub 16   ; !!!!!       0  +16
 166++9B5B
 167++9B5B 0E FF                        ld c,$FF
 168++9B5D 02                           ld (bc),a
 169++9B5E
 170++9B5E              ;-------------------------------------------------------
 171++9B5E              ;    .
 172++9B5E              ;       plr_page3    
 173++9B5E              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 174++9B5E                              ;call closestream_file
 175++9B5E 3A 5B 9E     				ld a,(file_id_cur_r)
 176++9B61              				OS_FILE_CLOSE ;A - id file
 176++9B61 0E 25       >    ld c,#25
 176++9B63 E7          >    rst #20
 177++9B64
 178++9B64              read_file_ok
 179++9B64                              ;call store8000c000 ;*
 180++9B64              ;  8000     
 181++9B64 21 00 8F                     ld hl,memorystreampages ;t_s98_file00_pages_list
 182++9B67 7E                           ld a,(hl)
 183++9B68                              ;SETPG8000
 184++9B68              				OS_SET_PAGE_SLOT3
 184++9B68 0E 1C       >    ld c,#1c
 184++9B6A E7          >    rst #20
 185++9B6B                              ; ld a,(plr_page3)
 186++9B6B                              ; SETPGC000
 187++9B6B
 188++9B6B              ;    plr_page3.      .
 189++9B6B                              ; ld hl,0x8000
 190++9B6B                              ; ld de,module
 191++9B6B                              ; ld bc,16384
 192++9B6B                              ; ldir
 193++9B6B
 194++9B6B              ;   plrpage      .
 195++9B6B                              ; ld a,(plr_page)
 196++9B6B                              ; SETPGC000
 197++9B6B                              ; ld hl,t_s98_file00_pages_list
 198++9B6B                              ; ld de,0xc100         ;0x5000
 199++9B6B                              ; ld bc,256
 200++9B6B                              ; ldir
 201++9B6B
 202++9B6B                       ;       DI
 203++9B6B
 204++9B6B              ;b .
 205++9B6B                              ;call restore8000c000
 206++9B6B
 207++9B6B                              ;call set_music_pages
 208++9B6B
 209++9B6B 21 00 C0                     ld hl,module
 210++9B6E                              ;ld (0x4001),hl *    
 211++9B6E 22 D4 8E     				ld (START+1),hl
 212++9B71 CD D3 8E                     call PLR_INIT        ;init music
 213++9B74
 214++9B74                        ;      EI
 215++9B74              ;----------------
 216++9B74              ;eloop           halt ;YIELD
 217++9B74              ;                call PLR_PLAY
 218++9B74              ;                jr eloop
 219++9B74              ;----------------
 220++9B74
 221++9B74
 222++9B74              ;!!!!!!!!!!
 223++9B74
 224++9B74              ; .
 225++9B74                              ;ld a,(plr_page)
 226++9B74 21 D8 8E                     ld hl,PLR_PLAY
 227++9B77                              ;OS_SETMUSIC         ;****     
 228++9B77              				OS_SET_INTER
 228++9B77 0E 14       >    ld c,#14
 228++9B79 E7          >    rst #20
 229++9B7A AF           				xor a ;OK
 230++9B7B C9           				ret
 231++9B7C                              ;jp unset_music_pages
 232++9B7C
 233++9B7C
 234++9B7C              memory_error:
 235++9B7C C3 09 9B             jp memoryerror
 236++9B7F
# file closed: GPlay/sub_func.asm
 825+ 9B7F              	include common/general-sound.asm
# file opened: GPlay/common/general-sound.asm
   1++9B7F                  ;ifdef GS
   2++9B7F                  macro GS_WaitCommand
   3++9B7F ~            .wait
   4++9B7F ~                in a, (GeneralSound.CMD)
   5++9B7F ~                rrca
   6++9B7F ~                jr c, .wait
   7++9B7F                  endm
   8++9B7F
   9++9B7F                  macro GS_WaitData
  10++9B7F ~            .wait
  11++9B7F ~                in a, (GeneralSound.CMD)
  12++9B7F ~                rlca
  13++9B7F ~                jr c, .wait
  14++9B7F                  endm
  15++9B7F
  16++9B7F                  macro GS_SendCommand nn
  17++9B7F ~                ld a, nn
  17++9B7F ~              out (GeneralSound.CMD), a
  18++9B7F                  endm
  19++9B7F
  20++9B7F                  module GeneralSound
  21++9B7F              ;; Control ports
  22++9B7F              CMD  = 187
  23++9B7F              DATA = 179
  24++9B7F
  25++9B7F              ;; Commands
  26++9B7F              CMD_WARM_RESET      = #F3
  27++9B7F              CMD_COLD_RESET      = #F4
  28++9B7F              CMD_LOAD_MODULE     = #30
  29++9B7F              CMD_PLAY_MODULE     = #31
  30++9B7F              CMD_STOP_MODULE     = #32
  31++9B7F              CMD_CONTINUE_MODULE = #33
  32++9B7F              CMD_OPEN_STREAM     = #D1
  33++9B7F              CMD_CLOSE_STREAM    = #D2
  34++9B7F
  35++9B7F              ; A - 0 warm reset, other - cold
  36++9B7F              init:
  37++9B7F A7               and a
  37++9B80 20 0A          jr nz, .cold
  38++9B82                  GS_SendCommand CMD_WARM_RESET
  38++9B82 3E F3       >    ld a, CMD_WARM_RESET
  38++9B84 D3 BB       >  out (GeneralSound.CMD), a
  39++9B86              	GS_WaitCommand
  39++9B86             >.wait
  39++9B86 DB BB       >    in a, (GeneralSound.CMD)
  39++9B88 0F          >    rrca
  39++9B89 38 FB       >    jr c, .wait
  40++9B8B C9               ret
  41++9B8C              .cold
  42++9B8C                  GS_SendCommand CMD_COLD_RESET
  42++9B8C 3E F4       >    ld a, CMD_COLD_RESET
  42++9B8E D3 BB       >  out (GeneralSound.CMD), a
  43++9B90              	GS_WaitCommand
  43++9B90             >.wait
  43++9B90 DB BB       >    in a, (GeneralSound.CMD)
  43++9B92 0F          >    rrca
  43++9B93 38 FB       >    jr c, .wait
  44++9B95 C9               ret
  45++9B96
  46++9B96              ;; Initializes loading module
  47++9B96              loadModule:
  48++9B96                  GS_SendCommand CMD_LOAD_MODULE
  48++9B96 3E 30       >    ld a, CMD_LOAD_MODULE
  48++9B98 D3 BB       >  out (GeneralSound.CMD), a
  49++9B9A                  GS_WaitCommand
  49++9B9A             >.wait
  49++9B9A DB BB       >    in a, (GeneralSound.CMD)
  49++9B9C 0F          >    rrca
  49++9B9D 38 FB       >    jr c, .wait
  50++9B9F                  GS_SendCommand CMD_OPEN_STREAM
  50++9B9F 3E D1       >    ld a, CMD_OPEN_STREAM
  50++9BA1 D3 BB       >  out (GeneralSound.CMD), a
  51++9BA3                  GS_WaitCommand
  51++9BA3             >.wait
  51++9BA3 DB BB       >    in a, (GeneralSound.CMD)
  51++9BA5 0F          >    rrca
  51++9BA6 38 FB       >    jr c, .wait
  52++9BA8 C9               ret
  53++9BA9
  54++9BA9              ;; Use it for streaming mod file
  55++9BA9              sendByte:
  56++9BA9 D3 B3            out (DATA), a
  57++9BAB                  GS_WaitData
  57++9BAB             >.wait
  57++9BAB DB BB       >    in a, (GeneralSound.CMD)
  57++9BAD 07          >    rlca
  57++9BAE 38 FB       >    jr c, .wait
  58++9BB0 C9               ret
  59++9BB1
  60++9BB1              ;; Call it when module was loaded
  61++9BB1              finishLoadingModule:
  62++9BB1                  GS_SendCommand CMD_CLOSE_STREAM
  62++9BB1 3E D2       >    ld a, CMD_CLOSE_STREAM
  62++9BB3 D3 BB       >  out (GeneralSound.CMD), a
  63++9BB5                  GS_WaitCommand
  63++9BB5             >.wait
  63++9BB5 DB BB       >    in a, (GeneralSound.CMD)
  63++9BB7 0F          >    rrca
  63++9BB8 38 FB       >    jr c, .wait
  64++9BBA              rewind:
  65++9BBA 3E 01            ld a, 1
  65++9BBC D3 B3          out (DATA), a
  66++9BBE                  GS_SendCommand CMD_PLAY_MODULE
  66++9BBE 3E 31       >    ld a, CMD_PLAY_MODULE
  66++9BC0 D3 BB       >  out (GeneralSound.CMD), a
  67++9BC2                  GS_WaitCommand
  67++9BC2             >.wait
  67++9BC2 DB BB       >    in a, (GeneralSound.CMD)
  67++9BC4 0F          >    rrca
  67++9BC5 38 FB       >    jr c, .wait
  68++9BC7 3E 01 32 E8      ld a, 1, (state),a
  68++9BCB 9B
  69++9BCC C9               ret
  70++9BCD
  71++9BCD              ;; Works like pause too
  72++9BCD              stopModule:
  73++9BCD AF               xor a
  73++9BCE 32 E8 9B       ld (state), a
  74++9BD1                  GS_SendCommand CMD_STOP_MODULE
  74++9BD1 3E 32       >    ld a, CMD_STOP_MODULE
  74++9BD3 D3 BB       >  out (GeneralSound.CMD), a
  75++9BD5 C9               ret
  76++9BD6
  77++9BD6              continueModule:
  78++9BD6 3E 01            ld a, 1
  78++9BD8 32 E8 9B       ld (state), a
  79++9BDB                  GS_SendCommand CMD_CONTINUE_MODULE
  79++9BDB 3E 33       >    ld a, CMD_CONTINUE_MODULE
  79++9BDD D3 BB       >  out (GeneralSound.CMD), a
  80++9BDF C9               ret
  81++9BE0
  82++9BE0              ; Pauses resumes
  83++9BE0              toggleModule:
  84++9BE0                  ;call Console.waitForKeyUp
  85++9BE0 3A E8 9B         ld a, (state)
  85++9BE3 A7             and a
  86++9BE4 28 F0            jr z, continueModule
  87++9BE6 18 E5            jr stopModule
  88++9BE8
  89++9BE8 00           state db 0
  90++9BE9                  endmodule
  91++9BE9
  92++9BE9                  ;endif
# file closed: GPlay/common/general-sound.asm
 826+ 9BE9              	;include common/muldiv.asm
 827+ 9BE9
 828+ 9BE9              end_gplay
 829+ 9BE9
 830+ 9BE9
 831+ 9BE9
 832+ 9BE9              ;ниже не включается в файл
 833+ 9BE9              ;waveheaderbuffer equ 0xc000-2048=0xb800 ;
 834+ 9BE9
 835+ 9BE9
 836+ 9BE9              	;savebin "gplay.apg",start_gplay,$-start_gplay
# file closed: GPlay/gplay.asm
1452  9BE9              	include nc_pic_view.asm ;просмотр картинок
# file opened: nc_pic_view.asm
   1+ 9BE9                  ; module ScreenViewer
   2+ 9BE9              display:
   3+ 9BE9                  ; call Console.waitForKeyUp
   4+ 9BE9
   5+ 9BE9 21 4A 9C     	ld hl,file_name_cur		;строка с именем
   6+ 9BEC              	OS_FILE_OPEN
   6+ 9BEC 0E 21       >    ld c,#21
   6+ 9BEE E7          >    rst #20
   7+ 9BEF 30 08        	jr nc,display_file_open_ok
   8+ 9BF1              display_file_error
   9+ 9BF1 21 20 9F     	ld hl,msg_file_error
  10+ 9BF4              	OS_PRINTZ
  10+ 9BF4 0E 09       >    ld c,#09
  10+ 9BF6 E7          >    rst #20
  11+ 9BF7              	; ld b,2*50
  12+ 9BF7              	; call delay1
  13+ 9BF7 37           	scf ;ошибка
  14+ 9BF8 C9           	ret
  15+ 9BF9
  16+ 9BF9              display_file_open_ok
  17+ 9BF9 32 5B 9E     	ld (file_id_cur_r),a
  18+ 9BFC
  19+ 9BFC 3A 5C 9E     	ld a,(page_ext01) ;доп страница
  20+ 9BFF              	OS_SET_PAGE_SLOT3
  20+ 9BFF 0E 1C       >    ld c,#1c
  20+ 9C01 E7          >    rst #20
  21+ 9C02
  22+ 9C02 3A 5B 9E     	ld a,(file_id_cur_r)
  23+ 9C05 11 00 1B     	ld de,6912
  24+ 9C08 21 00 C0     	ld hl,#c000
  25+ 9C0B              	;ld a,(file_id_cur_r)
  26+ 9C0B              	OS_FILE_READ ;загрузить
  26+ 9C0B 0E 23       >    ld c,#23
  26+ 9C0D E7          >    rst #20
  27+ 9C0E 38 E1        	jr c,display_file_error
  28+ 9C10 3A 5B 9E     	ld a,(file_id_cur_r)
  29+ 9C13              	OS_FILE_CLOSE
  29+ 9C13 0E 25       >    ld c,#25
  29+ 9C15 E7          >    rst #20
  30+ 9C16
  31+ 9C16              display_wait1
  32+ 9C16 3E 07        	ld a,7
  33+ 9C18              	OS_SET_SCREEN ;включить экран
  33+ 9C18 0E 1D       >    ld c,#1d
  33+ 9C1A E7          >    rst #20
  34+ 9C1B 30 03        	jr nc,display_wait1_ok
  35+ 9C1D              	OS_WAIT
  35+ 9C1D DF          >	rst #18
  36+ 9C1E 18 F6        	jr display_wait1 ;пока не получилось, может не в фокусе приложение
  37+ 9C20
  38+ 9C20              display_wait1_ok
  39+ 9C20
  40+ 9C20 3A 5C 9E     	ld a,(page_ext01) ;доп страница для данных плеера
  41+ 9C23 06 07        	ld b,7 ;страница назначения
  42+ 9C25 21 00 80     	ld hl,#8000
  43+ 9C28 11 00 C0     	ld de,#c000
  44+ 9C2B DD 21 00 1B  	ld ix,6912
  45+ 9C2F              	OS_RAM_COPY
  45+ 9C2F 0E 19       >    ld c,#19
  45+ 9C31 E7          >    rst #20
  46+ 9C32                  ;call TextMode.disable
  47+ 9C32              .wait
  48+ 9C32              	OS_WAIT
  48+ 9C32 DF          >	rst #18
  49+ 9C33              	OS_GET_CHAR
  49+ 9C33 0E 10       >    ld c,#10
  49+ 9C35 E7          >    rst #20
  50+ 9C36 FE FF        	cp 255
  51+ 9C38 28 F8        	jr z, .wait
  52+ 9C3A AF           	xor a ;текстовый экран
  53+ 9C3B              	OS_SET_SCREEN
  53+ 9C3B 0E 1D       >    ld c,#1d
  53+ 9C3D E7          >    rst #20
  54+ 9C3E                  ;call TextMode.cls
  55+ 9C3E
  56+ 9C3E
  57+ 9C3E 3A 5E 9E     	ld a,(page_main) ;основная страница
  58+ 9C41              	OS_SET_PAGE_SLOT3
  58+ 9C41 0E 1C       >    ld c,#1c
  58+ 9C43 E7          >    rst #20
  59+ 9C44
  60+ 9C44 AF           	xor a ;ok
  61+ 9C45 C9           	ret
  62+ 9C46                  ;jp History.back
  63+ 9C46
  64+ 9C46              ;    endmodule
  65+ 9C46
# file closed: nc_pic_view.asm
1453  9C46
1454  9C46              color_error equ 1*8+2 ;цвет ошибка
1455  9C46              color_default equ 0*8+7 ;цвет обычный системный
1456  9C46              color_view_text equ 4 ;цвет текста в просмотрщике
1457  9C46
1458  9C46              color_backgr equ 1*8+7 ;цвет фона
1459  9C46              color_apg equ 1*8+4 ;цвет приложений
1460  9C46              color_dir equ 1*8+6 ;цвет папок
1461  9C46
1462  9C46              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1463  9C46              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1464  9C46              color_dir_hi equ 5*8+0 ;цвет папок курсор
1465  9C46
1466  9C46              file_info_lenght equ 255 ;длина инфо о файле
1467  9C46              panel_hight equ 22;высота панели
1468  9C46              panel_r_xy equ #0129
1469  9C46              buffer_cat equ #c000 ;адрес буфера каталога
1470  9C46
1471  9C46 00 00        file_r_all dw 0;всего файлов справа
1472  9C48 00 00        file_r_cur_focus dw 0;первый видимый
1473  9C4A 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1474  9D4A 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1475  9E4A 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1475  9E4E 20 20 20 20
1475  9E52 20 20 20 20
1475  9E56 00
1476  9E57 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1477  9E58
1478  9E58 00 00        file_r_num_cur dw 0 ;текущий файл справа
1479  9E5A 00           key_pressed db 0 ;последняя клавиша
1480  9E5B 00           file_id_cur_r db 0 ;id файла справа
1481  9E5C
1482  9E5C
1483  9E5C 00           page_ext01 db 0 ;номер дополнительной страницы
1484  9E5D 00           page_ext02_gzip db 0 ;номер дополнительной страницы
1485  9E5E 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1486  9E60 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1487  9E61 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1487  9E65 20 20 20 20
1487  9E69 20 20 20 20
1487  9E6D 20 20 20 20
1487  9E71 20 20 20 20
1487  9E75 20 20 20 20
1487  9E79 20 20 00
1488  9E7C
1489  9E7C
1490  9E7C              rect_1
1491  9E7C C9           	db #c9
1492  9E7D              	dup 40-2
1493  9E7D CD          >	db #cd
1493  9E7E CD          >	db #cd
1493  9E7F CD          >	db #cd
1493  9E80 CD          >	db #cd
1493  9E81 CD          >	db #cd
1493  9E82 CD          >	db #cd
1493  9E83 CD          >	db #cd
1493  9E84 CD          >	db #cd
1493  9E85 CD          >	db #cd
1493  9E86 CD          >	db #cd
1493  9E87 CD          >	db #cd
1493  9E88 CD          >	db #cd
1493  9E89 CD          >	db #cd
1493  9E8A CD          >	db #cd
1493  9E8B CD          >	db #cd
1493  9E8C CD          >	db #cd
1493  9E8D CD          >	db #cd
1493  9E8E CD          >	db #cd
1493  9E8F CD          >	db #cd
1493  9E90 CD          >	db #cd
1493  9E91 CD          >	db #cd
1493  9E92 CD          >	db #cd
1493  9E93 CD          >	db #cd
1493  9E94 CD          >	db #cd
1493  9E95 CD          >	db #cd
1493  9E96 CD          >	db #cd
1493  9E97 CD          >	db #cd
1493  9E98 CD          >	db #cd
1493  9E99 CD          >	db #cd
1493  9E9A CD          >	db #cd
1493  9E9B CD          >	db #cd
1493  9E9C CD          >	db #cd
1493  9E9D CD          >	db #cd
1493  9E9E CD          >	db #cd
1493  9E9F CD          >	db #cd
1493  9EA0 CD          >	db #cd
1493  9EA1 CD          >	db #cd
1493  9EA2 CD          >	db #cd
1494  9EA3              	edup
1495  9EA3 BB 00        	db #bb,0
1496  9EA5
1497  9EA5              rect_2
1498  9EA5 BA           	db #ba
1499  9EA6              	dup 40-2
1500  9EA6 20          >	db " "
1500  9EA7 20          >	db " "
1500  9EA8 20          >	db " "
1500  9EA9 20          >	db " "
1500  9EAA 20          >	db " "
1500  9EAB 20          >	db " "
1500  9EAC 20          >	db " "
1500  9EAD 20          >	db " "
1500  9EAE 20          >	db " "
1500  9EAF 20          >	db " "
1500  9EB0 20          >	db " "
1500  9EB1 20          >	db " "
1500  9EB2 20          >	db " "
1500  9EB3 20          >	db " "
1500  9EB4 20          >	db " "
1500  9EB5 20          >	db " "
1500  9EB6 20          >	db " "
1500  9EB7 20          >	db " "
1500  9EB8 20          >	db " "
1500  9EB9 20          >	db " "
1500  9EBA 20          >	db " "
1500  9EBB 20          >	db " "
1500  9EBC 20          >	db " "
1500  9EBD 20          >	db " "
1500  9EBE 20          >	db " "
1500  9EBF 20          >	db " "
1500  9EC0 20          >	db " "
1500  9EC1 20          >	db " "
1500  9EC2 20          >	db " "
1500  9EC3 20          >	db " "
1500  9EC4 20          >	db " "
1500  9EC5 20          >	db " "
1500  9EC6 20          >	db " "
1500  9EC7 20          >	db " "
1500  9EC8 20          >	db " "
1500  9EC9 20          >	db " "
1500  9ECA 20          >	db " "
1500  9ECB 20          >	db " "
1501  9ECC              	edup
1502  9ECC BA 00        	db #ba,0
1503  9ECE
1504  9ECE              rect_3
1505  9ECE C8           	db #c8
1506  9ECF              	dup 40-2
1507  9ECF CD          >	db #cd
1507  9ED0 CD          >	db #cd
1507  9ED1 CD          >	db #cd
1507  9ED2 CD          >	db #cd
1507  9ED3 CD          >	db #cd
1507  9ED4 CD          >	db #cd
1507  9ED5 CD          >	db #cd
1507  9ED6 CD          >	db #cd
1507  9ED7 CD          >	db #cd
1507  9ED8 CD          >	db #cd
1507  9ED9 CD          >	db #cd
1507  9EDA CD          >	db #cd
1507  9EDB CD          >	db #cd
1507  9EDC CD          >	db #cd
1507  9EDD CD          >	db #cd
1507  9EDE CD          >	db #cd
1507  9EDF CD          >	db #cd
1507  9EE0 CD          >	db #cd
1507  9EE1 CD          >	db #cd
1507  9EE2 CD          >	db #cd
1507  9EE3 CD          >	db #cd
1507  9EE4 CD          >	db #cd
1507  9EE5 CD          >	db #cd
1507  9EE6 CD          >	db #cd
1507  9EE7 CD          >	db #cd
1507  9EE8 CD          >	db #cd
1507  9EE9 CD          >	db #cd
1507  9EEA CD          >	db #cd
1507  9EEB CD          >	db #cd
1507  9EEC CD          >	db #cd
1507  9EED CD          >	db #cd
1507  9EEE CD          >	db #cd
1507  9EEF CD          >	db #cd
1507  9EF0 CD          >	db #cd
1507  9EF1 CD          >	db #cd
1507  9EF2 CD          >	db #cd
1507  9EF3 CD          >	db #cd
1507  9EF4 CD          >	db #cd
1508  9EF5              	edup
1509  9EF5 BC 00        	db #bc,0
1510  9EF7
1511  9EF7              ;file_name_test db '486 HEART ON FIRE.vgm',0
1512  9EF7              msg_menu_info
1513  9EF7 0D 43 53 2B  	db 13,"CS+Enter - Play all",0
1513  9EFB 45 6E 74 65
1513  9EFF 72 20 2D 20
1513  9F03 50 6C 61 79
1513  9F07 20 61 6C 6C
1513  9F0B 00
1514  9F0C              msg_menu_main1
1515  9F0C 20 4C 46 20  	db " LF On",0
1515  9F10 4F 6E 00
1516  9F13              msg_menu_main2
1517  9F13 20 41 5A 20  	db " AZ On",0
1517  9F17 4F 6E 00
1518  9F1A              msg_menu_main3
1519  9F1A 20 56 69 65  	db " View",0
1519  9F1E 77 00
1520  9F20              msg_file_error
1521  9F20 46 69 6C 65  	db "File error",13,0
1521  9F24 20 65 72 72
1521  9F28 6F 72 0D 00
1522  9F2C              msg_file_too_big
1523  9F2C 46 69 6C 65  	db "File too big",13,0
1523  9F30 20 74 6F 6F
1523  9F34 20 62 69 67
1523  9F38 0D 00
1524  9F3A              msg_mem_err
1525  9F3A 47 65 74 20  	db "Get memory error",13,0
1525  9F3E 6D 65 6D 6F
1525  9F42 72 79 20 65
1525  9F46 72 72 6F 72
1525  9F4A 0D 00
1526  9F4C              msg_mono_err
1527  9F4C 47 65 74 20  	db "Get mono mode error",13,0
1527  9F50 6D 6F 6E 6F
1527  9F54 20 6D 6F 64
1527  9F58 65 20 65 72
1527  9F5C 72 6F 72 0D
1527  9F60 00
1528  9F61              msg_title_nc
1529  9F61 4E 6F 6E 65  	db "None Commander ver 2025.08.15",13,0
1529  9F65 20 43 6F 6D
1529  9F69 6D 61 6E 64
1529  9F6D 65 72 20 76
1529  9F71 65 72 20 32
1529  9F75 30 32 35 2E
1529  9F79 30 38 2E 31
1529  9F7D 35 0D 00
1530  9F80
1531  9F80
1532  9F80
1533  9F80              start_gp_gzip equ #4000 ;рабочий адрес модуля для распаковки
1534  9F80              start_gp_gzip_ext equ #c000 ;временный адрес модуля для распаковки
1535  9F80
1536  9F80              cat_index equ $ ; 1024 ;буфер для индекса (вектора) сортировки
1537  9F80              cat_index_2 equ cat_index+1024 ; 1024 ;буфер для индекса (вектора) сортировки 2
1538  9F80              file_info_string equ cat_index_2+1024 ;  file_info_lenght+1 ;буфер инфо
1539  9F80
1540  9F80              free equ file_info_string+file_info_lenght+1 ;тут условно свободно
1541  9F80
1542  9F80              start_gp_gzip_load
1543  9F80              	incbin "gp_gzip.bin" ; часть плеера для режима моно, переносится в резервную страницу
1544  BA80              end_gp_gzip_load
1545  BA80
1546  BA80
1547  BA80
1548  BA80              end_nc
1549  BA80              	savebin "nc.apg",start_nc,$-start_nc
1550  BA80
1551  BA80              ;ниже не включается в файл
1552  BA80
1553  BA80
1554  BA80              end_nc_all
1555  BA80
1556  BA80
1557  BA80
1558  BA80              	org 0xb800 ;
1559  B800              ;ещё тут буферы плеера VGM до адреса #bf00
1560  B800
1561  B800
# file closed: nc.asm
