# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 200+ 0000                  ; ld c,#14
 201+ 0000                  ; rst #20
 202+ 0000                  ; endm
 203+ 0000
 204+ 0000
 205+ 0000              ;плеер AY ----------------------------
 206+ 0000
 207+ 0000              ;инициализация плеера AY;
 208+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 209+ 0000 ~                ld c,#15
 210+ 0000 ~                rst #20
 211+ 0000                  endm
 212+ 0000
 213+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 214+ 0000                  macro OS_VTPL_PLAY ;()
 215+ 0000 ~                ld c,#16
 216+ 0000 ~                rst #20
 217+ 0000                  endm
 218+ 0000
 219+ 0000              ;заглушить плеер AY;
 220+ 0000                  macro OS_VTPL_MUTE ;()
 221+ 0000 ~                ld c,#17
 222+ 0000 ~                rst #20
 223+ 0000                  endm
 224+ 0000
 225+ 0000              ;получить значение переменной плеера;
 226+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 227+ 0000 ~                ld c,#18
 228+ 0000 ~                rst #20
 229+ 0000                  endm
 230+ 0000
 231+ 0000
 232+ 0000              ;прочие ------------------------------
 233+ 0000
 234+ 0000
 235+ 0000              ;скопировать данные из страницы в страницу
 236+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 237+ 0000                  macro OS_RAM_COPY
 238+ 0000 ~                ld c,#19
 239+ 0000 ~                rst #20
 240+ 0000                  endm
 241+ 0000
 242+ 0000              ;получить дополнительную страницу памяти;
 243+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 244+ 0000 ~                ld c,#1a
 245+ 0000 ~                rst #20
 246+ 0000                  endm
 247+ 0000
 248+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 249+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 250+ 0000 ~                ld c,#1b
 251+ 0000 ~                rst #20
 252+ 0000                  endm
 253+ 0000
 254+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 255+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 256+ 0000 ~                ld c,#1c
 257+ 0000 ~                rst #20
 258+ 0000                  endm
 259+ 0000
 260+ 0000              ;включить экран N;
 261+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 262+ 0000              ;переключать может только приложение в фокусе
 263+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 264+ 0000              ;при переключении процессов сохраняется только экран #39
 265+ 0000                  macro OS_SET_SCREEN ;
 266+ 0000 ~                ld c,#1d
 267+ 0000 ~                rst #20
 268+ 0000                  endm
 269+ 0000
 270+ 0000
 271+ 0000              ;получить номера страниц процесса;
 272+ 0000              ;вх:
 273+ 0000              ;вых: b, c - страницы в слотах 2, 3
 274+ 0000                  macro OS_GET_MAIN_PAGES ;
 275+ 0000 ~                ld c,#1e
 276+ 0000 ~                rst #20
 277+ 0000                  endm
 278+ 0000
 279+ 0000              ;получить значение системного таймера
 280+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 281+ 0000 ~                ld c,#1F
 282+ 0000 ~                rst #20
 283+ 0000                  endm
 284+ 0000
 285+ 0000
 286+ 0000
 287+ 0000                  ; macro OS_ ;
 288+ 0000                  ; ld c,#20
 289+ 0000                  ; rst #20
 290+ 0000                  ; endm
 291+ 0000
 292+ 0000
 293+ 0000              ;дисковые операции -------------------
 294+ 0000
 295+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 296+ 0000
 297+ 0000              ; fcbFAT (из руководства к монитору)
 298+ 0000              ; формат fcb для работы с FAT
 299+ 0000
 300+ 0000              ; +#00 8 имя файла
 301+ 0000              ; +#08 3 расширение файла
 302+ 0000              ; +#0B 1 атрибуты файла
 303+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 304+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 305+ 0000              ; +#14 4 размер файла/каталога в байтах
 306+ 0000              ; +#18 4 указатель в файле
 307+ 0000              ; +#1C 1 для внутренних нужд
 308+ 0000              ; +#1D 1 для внутренних нужд
 309+ 0000              ; +#1E 1 резерв
 310+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 311+ 0000              	; 1-0,nn номер раздела
 312+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 313+ 0000              	    ; значение %11 недопустимо
 314+ 0000
 315+ 0000              ;открыть файл для чтения или записи
 316+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 317+ 0000 ~                ld c,#21
 318+ 0000 ~                rst #20
 319+ 0000                  endm
 320+ 0000
 321+ 0000              ;создать файл
 322+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 323+ 0000 ~                ld c,#22
 324+ 0000 ~                rst #20
 325+ 0000                  endm
 326+ 0000
 327+ 0000              ;прочитать из файла
 328+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
 329+ 0000 ~                ld c,#23
 330+ 0000 ~                rst #20
 331+ 0000                  endm
 332+ 0000
 333+ 0000              ;записать в файл
 334+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 335+ 0000 ~                ld c,#24
 336+ 0000 ~                rst #20
 337+ 0000                  endm
 338+ 0000
 339+ 0000              ;закрыть файл
 340+ 0000                  macro OS_FILE_CLOSE ;A - id file
 341+ 0000 ~                ld c,#25
 342+ 0000 ~                rst #20
 343+ 0000                  endm
 344+ 0000
 345+ 0000              ;чтение секторов текущего каталога
 346+ 0000              ; вх:
 347+ 0000                   ; hl - буфер для чтения
 348+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 349+ 0000                   ; b - максимальное количество секторов для чтения
 350+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 351+ 0000                     ; a=errRWnum
 352+ 0000                     ; a=errInvalidPart
 353+ 0000                     ; a=errFileEmpty
 354+ 0000                   ; cy=0, a=errEoF - каталог закончился
 355+ 0000                     ; hl - следующий адрес в буфере
 356+ 0000                     ; de - номер первого непрочитанного сектора
 357+ 0000                     ; b - не прочитано секторов
 358+ 0000                   ; cy=0 - считано успешно
 359+ 0000                     ; hl - следующий адрес в буфере
 360+ 0000                     ; de - номер первого непрочитанного сектора
 361+ 0000                     ; b=#00
 362+ 0000                  macro OS_DIR_READ ;
 363+ 0000 ~                ld c,#26
 364+ 0000 ~                rst #20
 365+ 0000                  endm
 366+ 0000
 367+ 0000              ;вход в каталог/выход в родительский каталог
 368+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 369+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 370+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 371+ 0000              	; переход в родительский, последнее имя в пути удалится).
 372+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 373+ 0000              	; добавится имя файла
 374+ 0000              ; вх:
 375+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 376+ 0000                   ; de - адрес дескриптора директории/файла
 377+ 0000              ; вых: a - если путь был указан, новая длина пути
 378+ 0000                  macro OS_DIR_OPEN ;
 379+ 0000 ~                ld c,#27
 380+ 0000 ~                rst #20
 381+ 0000                  endm
 382+ 0000
 383+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 384+ 0000              ;проверки на допустимость значений не производится
 385+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 386+ 0000              ;вх: A - id файла
 387+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 388+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 389+ 0000                  macro OS_FILE_POSITION ;
 390+ 0000 ~                ld c,#28
 391+ 0000 ~                rst #20
 392+ 0000                  endm
 393+ 0000
 394+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 395+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 396+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 397+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 398+ 0000                  macro OS_FIND_PATH ;
 399+ 0000 ~                ld c,#29
 400+ 0000 ~                rst #20
 401+ 0000                  endm
 402+ 0000
 403+ 0000
 404+ 0000              ; получение длинного имени файла
 405+ 0000              ;вх: hl - адрес буфера для имени
 406+ 0000              ;    de - номер записи в текущем каталоге
 407+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 408+ 0000              ; 	a - длина имени, с учетом нуля
 409+ 0000                  macro OS_GET_LFN ;
 410+ 0000 ~                ld c,#2a
 411+ 0000 ~                rst #20
 412+ 0000                  endm
 413+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROGSTART
   5  8000
   6  8000              start_nc
   7  8000 21 99 8A     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 BD 89  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 86 8A     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A
  24  801A CD A2 80     	call delay
  25  801D C3 A0 81     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 BC 89     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023
  32  8023              start_nc_warm ;тёплый старт
  33  8023
  34  8023              	;очистка буфера
  35  8023 CD A8 80     	call clear_buf
  36  8026
  37  8026              	;загрузка каталога
  38  8026 21 00 C0     	ld hl,buffer_cat ;куда
  39  8029 11 00 00     	ld de,0 ;начиная с 0 сектора
  40  802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  41  802E              	OS_DIR_READ
  41  802E 0E 26       >    ld c,#26
  41  8030 E7          >    rst #20
  42  8031
  43  8031 21 00 00     	ld hl,0 ;обнулить переменные
  44  8034 22 B8 89     	ld (file_r_num_cur),hl
  45  8037 22 A6 87     	ld (file_r_all),hl
  46  803A 22 A8 87     	ld (file_r_cur_focus),hl
  47  803D
  48  803D CD B0 82     	call sort_dir
  49  8040
  50  8040 3E 0F        	ld a,color_backgr
  51  8042 06 0C        	ld b,#c
  52  8044              	OS_SET_COLOR
  52  8044 0E 06       >    ld c,#06
  52  8046 E7          >    rst #20
  53  8047
  54  8047 CD 35 84     	call print_rect_r ;рамка
  55  804A CD B8 81     	call print_panel_r
  56  804D CD 6A 84     	call print_menu_main
  57  8050
  58  8050 11 00 01     	ld de,#0100
  59  8053              	OS_SET_XY
  59  8053 0E 01       >    ld c,#01
  59  8055 E7          >    rst #20
  60  8056
  61  8056
  62  8056
  63  8056              nc_wait
  64  8056              	OS_WAIT ;ждать прерывание
  64  8056 DF          >	rst #18
  65  8057
  66  8057              	OS_GET_CHAR ;клавиша
  66  8057 0E 10       >    ld c,#10
  66  8059 E7          >    rst #20
  67  805A 32 BA 89     	ld (key_pressed),a ;запомнить
  68  805D FE 0D        	cp 13
  69  805F CA BF 80     	jp z,key_enter ;
  70  8062 FE 0A        	cp 10 ;вниз
  71  8064 CC 0C 81     	call z,key_down
  72  8067 FE 0B        	cp 11 ;вверх
  73  8069 CC 49 81     	call z,key_up
  74  806C FE 09        	cp 09 ;вправо
  75  806E CC 8E 81     	call z,key_right
  76  8071 FE 08        	cp 08 ;влево
  77  8073 CC 7C 81     	call z,key_left
  78  8076 FE 04        	cp 04 ;страница вверх
  79  8078 CC 7C 81     	call z,key_left
  80  807B FE 05        	cp 05 ;страница вниз
  81  807D CC 8E 81     	call z,key_right
  82  8080 FE 31        	cp "1" ;переключение длинных имён (LFN)
  83  8082 CA E3 83     	jp z,LFN_toggle
  84  8085 FE 32        	cp "2" ;переключение сортировки
  85  8087 CA C3 83     	jp z,sort_toggle
  86  808A FE 33        	cp "3" ;просмотр файла
  87  808C CA B8 84     	jp z,view_file
  88  808F FE 18        	cp 24 ;break
  89  8091 CA A0 81     	jp z,exit
  90  8094
  91  8094
  92  8094 3A BF 89     	ld a,(print_panel_r_flag)
  93  8097 B7           	or a
  94  8098 C4 B8 81     	call nz,print_panel_r ;обновить каталог
  95  809B AF           	xor a
  96  809C 32 BF 89     	ld (print_panel_r_flag),a
  97  809F
  98  809F C3 56 80     	jp nc_wait ;на цикл ожидания
  99  80A2
 100  80A2
 101  80A2              delay ;задержка
 102  80A2 06 96        	ld b,50*3 ;
 103  80A4              delay1
 104  80A4              	OS_WAIT
 104  80A4 DF          >	rst #18
 105  80A5 10 FD        	djnz delay1
 106  80A7 C9           	ret
 107  80A8
 108  80A8
 109  80A8              clear_buf
 110  80A8 21 00 C0     	ld hl,buffer_cat
 111  80AB 11 01 C0     	ld de,buffer_cat+1
 112  80AE 01 FF 3F     	ld bc,#4000-1
 113  80B1 36 00        	ld (hl),0
 114  80B3 ED B0        	ldir
 115  80B5 C9           	ret
 116  80B6
 117  80B6
 118  80B6
 119  80B6
 120  80B6              release_key ;ждать отпускания клавиши
 121  80B6              	OS_WAIT
 121  80B6 DF          >	rst #18
 122  80B7              	OS_GET_CHAR
 122  80B7 0E 10       >    ld c,#10
 122  80B9 E7          >    rst #20
 123  80BA FE FF        	cp 255
 124  80BC 20 F8        	jr nz,release_key
 125  80BE C9           	ret
 126  80BF
 127  80BF
 128  80BF              key_enter
 129  80BF              	;нажата Enter
 130  80BF 2A A6 87     	ld hl,(file_r_all)
 131  80C2 7D           	ld a,l
 132  80C3 B4           	or h
 133  80C4 CA EF 80     	jp z,key_enter_ex ;защита
 134  80C7 2A B8 89     	ld hl,(file_r_num_cur)
 135  80CA CD FF 80     	call calc_deskr
 136  80CD DD 7E 0B     	ld a,(ix+#0b)
 137  80D0 FE 10        	cp #10 ;признак каталога
 138  80D2 28 1E        	jr z,key_enter_dir
 139  80D4
 140  80D4 FE 30        	cp #30 ;признак каталога
 141  80D6 28 1A        	jr z,key_enter_dir
 142  80D8
 143  80D8              	;проверка расширения ;APG
 144  80D8 CD A4 81     	call check_apg
 145  80DB C2 EF 80     	jp nz,key_enter_ex
 146  80DE              	;тут запуск приложения
 147  80DE CD 00 84     	call format_name
 148  80E1
 149  80E1 21 AA 87     	ld hl,file_name_cur		;строка с именем
 150  80E4              	OS_PROC_RUN ;запустить прогу
 150  80E4 0E 11       >    ld c,#11
 150  80E6 E7          >    rst #20
 151  80E7              	;обработка ошибки
 152  80E7 38 06        	jr c,key_enter_ex
 153  80E9
 154  80E9 DD 7E 00     	ld a,(ix)
 155  80EC              	OS_PROC_SET_FOCUS ;на передний план
 155  80EC 0E 12       >    ld c,#12
 155  80EE E7          >    rst #20
 156  80EF
 157  80EF              key_enter_ex
 158  80EF C3 56 80     	jp nc_wait
 159  80F2
 160  80F2              key_enter_dir
 161  80F2              	;тут открытие папки
 162  80F2
 163  80F2              	;call format_name_dir
 164  80F2 EB           	ex de,hl ;de - дескриптор для открытия
 165  80F3 21 AA 88     	ld hl,dir_name_cur
 166  80F6              	OS_DIR_OPEN
 166  80F6 0E 27       >    ld c,#27
 166  80F8 E7          >    rst #20
 167  80F9 38 F4        	jr c,key_enter_ex ;если ошибка, ничего не делаем
 168  80FB
 169  80FB E1           	pop hl ;отменить возврат
 170  80FC C3 23 80     	jp start_nc_warm ;перезагрузить папку
 171  80FF
 172  80FF
 173  80FF              ; format_name_dir
 174  80FF              	; push hl
 175  80FF              	; ld hl,file_name_cur
 176  80FF              	; ld de,file_name_cur+1 ;почистить
 177  80FF              	; ld bc,256-1
 178  80FF              	; ld (hl),0
 179  80FF              	; ldir
 180  80FF
 181  80FF              	; pop hl
 182  80FF
 183  80FF              	; ld de,file_name_cur ;куда
 184  80FF              	; ld bc,#08ff
 185  80FF              ; format_name_dir_cl
 186  80FF              	; ld a,(hl)
 187  80FF              	; cp " "+1
 188  80FF              	; jr c,format_name_dir_skip
 189  80FF              	; ldi
 190  80FF              	; djnz format_name_dir_cl
 191  80FF              ; format_name_dir_skip
 192  80FF              	; ld a,'/'
 193  80FF              	; ld (de),a
 194  80FF              	; ret
 195  80FF
 196  80FF               ;вычислить дескриптор текущего элемента справа
 197  80FF              calc_deskr
 198  80FF 29           	add hl,hl ;*2
 199  8100 01 B9 8A     	ld bc,cat_index
 200  8103 09           	add hl,bc
 201  8104 5E           	ld e,(hl)
 202  8105 23           	inc hl
 203  8106 56           	ld d,(hl)
 204  8107 EB           	ex de,hl ;hl - адрес элемента
 205  8108 E5           	push hl
 206  8109 DD E1        	pop ix ;ix- адрес элемента
 207  810B C9           	ret
 208  810C
 209  810C
 210  810C
 211  810C
 212  810C              key_down
 213  810C 2A A6 87     	ld hl,(file_r_all)
 214  810F 7D           	ld a,l
 215  8110 B4           	or h
 216  8111 CA 45 81     	jp z,key_down_ex ;защита
 217  8114
 218  8114 ED 4B B8 89  	ld bc,(file_r_num_cur)
 219  8118 03           	inc bc
 220  8119 2A A6 87     	ld hl,(file_r_all)
 221  811C              	;если не больше чем всего
 222  811C A7           	and a
 223  811D ED 42        	sbc hl,bc
 224  811F 38 24        	jr c,key_down_skip
 225  8121 28 22        	jr z,key_down_skip
 226  8123              	;прибавить
 227  8123 ED 43 B8 89  	ld (file_r_num_cur),bc
 228  8127
 229  8127              	;теперь передвинуть фокус, если надо
 230  8127 2A A8 87     	ld hl,(file_r_cur_focus)
 231  812A 01 16 00     	ld bc,panel_hight
 232  812D 09           	add hl,bc ;прибавить количество видимых
 233  812E ED 4B B8 89  	ld bc,(file_r_num_cur)
 234  8132 A7           	and a
 235  8133 ED 42        	sbc hl,bc ;вычесть положение курсора
 236  8135 28 02        	jr z,key_down_change_focus_yes
 237  8137 30 07        	jr nc,key_down_change_focus_no
 238  8139              key_down_change_focus_yes
 239  8139              	;передвинуть фокус
 240  8139 2A A8 87     	ld hl,(file_r_cur_focus)
 241  813C 23           	inc hl
 242  813D 22 A8 87     	ld (file_r_cur_focus),hl
 243  8140
 244  8140              key_down_change_focus_no
 245  8140 3E 01        	ld a,1
 246  8142 32 BF 89     	ld (print_panel_r_flag),a
 247  8145              	;call print_panel_r ;обновить каталог
 248  8145              key_down_skip
 249  8145
 250  8145              key_down_ex
 251  8145 3A BA 89     	ld a,(key_pressed)
 252  8148 C9           	ret
 253  8149
 254  8149
 255  8149
 256  8149              key_up ;вверх
 257  8149 2A A6 87     	ld hl,(file_r_all)
 258  814C 7D           	ld a,l
 259  814D B4           	or h
 260  814E CA 78 81     	jp z,key_up_ex ;защита
 261  8151
 262  8151 2A B8 89     	ld hl,(file_r_num_cur)
 263  8154 7D           	ld a,l
 264  8155 B4           	or h
 265  8156 28 20        	jr z,key_up_skip
 266  8158 2B           	dec hl
 267  8159 22 B8 89     	ld (file_r_num_cur),hl
 268  815C
 269  815C              	;теперь передвинуть фокус, если надо
 270  815C 2A B8 89     	ld hl,(file_r_num_cur)
 271  815F              	; ld bc,panel_hight
 272  815F              	; add hl,bc ;прибавить количество видимых
 273  815F ED 4B A8 87  	ld bc,(file_r_cur_focus)
 274  8163 A7           	and a
 275  8164 ED 42        	sbc hl,bc ;вычесть положение курсора
 276  8166              	;jr z,key_up_change_foces_yes
 277  8166 30 0B        	jr nc,key_up_change_foces_no
 278  8168              key_up_change_foces_yes
 279  8168              	;передвинуть фокус
 280  8168 2A A8 87     	ld hl,(file_r_cur_focus)
 281  816B 7C           	ld a,h
 282  816C B5           	or l
 283  816D 28 04        	jr z,key_up_change_foces_no ;защита
 284  816F 2B           	dec hl
 285  8170 22 A8 87     	ld (file_r_cur_focus),hl
 286  8173
 287  8173              key_up_change_foces_no
 288  8173
 289  8173 3E 01        	ld a,1
 290  8175 32 BF 89     	ld (print_panel_r_flag),a
 291  8178              	;call print_panel_r ;обновить каталог
 292  8178              key_up_skip
 293  8178
 294  8178              key_up_ex
 295  8178 3A BA 89     	ld a,(key_pressed)
 296  817B C9           	ret
 297  817C
 298  817C
 299  817C              key_left ;на страницу назад
 300  817C 06 15        	ld b,panel_hight-1
 301  817E              key_left_cl
 302  817E C5           	push bc
 303  817F CD 49 81     	call key_up
 304  8182 C1           	pop bc
 305  8183 10 F9        	djnz key_left_cl
 306  8185 3E 01        	ld a,1
 307  8187 32 BF 89     	ld (print_panel_r_flag),a
 308  818A 3A BA 89     	ld a,(key_pressed)
 309  818D C9           	ret
 310  818E
 311  818E
 312  818E
 313  818E              key_right ;на страницу вперёд
 314  818E 06 15        	ld b,panel_hight-1
 315  8190              key_right_cl
 316  8190 C5           	push bc
 317  8191 CD 0C 81     	call key_down
 318  8194 C1           	pop bc
 319  8195 10 F9        	djnz key_right_cl
 320  8197 3E 01        	ld a,1
 321  8199 32 BF 89     	ld (print_panel_r_flag),a
 322  819C 3A BA 89     	ld a,(key_pressed)
 323  819F C9           	ret
 324  81A0
 325  81A0
 326  81A0
 327  81A0              exit ;выход в DOS
 328  81A0 AF           	xor a
 329  81A1              	OS_PROC_CLOSE
 329  81A1 0E 13       >    ld c,#13
 329  81A3 E7          >    rst #20
 330  81A4
 331  81A4
 332  81A4
 333  81A4              check_apg ;проверка на расширение APG
 334  81A4 DD 7E 08     	ld a,(ix+8)
 335  81A7 FE 41        	cp "A"
 336  81A9 C0           	ret nz
 337  81AA DD 7E 09     	ld a,(ix+9)
 338  81AD FE 50        	cp "P"
 339  81AF C0           	ret nz
 340  81B0 DD 7E 0A     	ld a,(ix+10)
 341  81B3 FE 47        	cp "G"
 342  81B5 C0           	ret nz
 343  81B6 AF           	xor a ;равен
 344  81B7 C9           	ret
 345  81B8
 346  81B8
 347  81B8
 348  81B8              print_panel_r ;печать правой панели
 349  81B8              	;ld ix,buffer_cat
 350  81B8 FD 2A A6 87  	ld iy,(file_r_all) ;всего файлов
 351  81BC FD 7D        	ld a,iyl
 352  81BE FD B4        	or iyh
 353  81C0 C8           	ret z ;защита если 0
 354  81C1 11 29 01     	ld de,panel_r_xy ;координаты yx
 355  81C4 06 16        	ld b,panel_hight ;высота панели
 356  81C6 FD 2A A8 87  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 357  81CA              print_panel_r_cl ;цикл
 358  81CA C5           	push bc
 359  81CB D5           	push de ;xy
 360  81CC              	OS_SET_XY
 360  81CC 0E 01       >    ld c,#01
 360  81CE E7          >    rst #20
 361  81CF
 362  81CF              	;получить адрес элемента
 363  81CF FD E5        	push iy
 364  81D1 E1           	pop hl
 365  81D2 CD FF 80     	call calc_deskr
 366  81D5
 367  81D5 CD F0 81     	call print_file_info ;напечатать строку
 368  81D8              print_panel_r_skip
 369  81D8 D1           	pop de
 370  81D9 14           	inc d ;y++
 371  81DA FD 23        	inc iy ;текущий файл
 372  81DC              	;проверка на конец каталога
 373  81DC 2A A6 87     	ld hl,(file_r_all)
 374  81DF FD E5        	push iy
 375  81E1 C1           	pop bc
 376  81E2 A7           	and a
 377  81E3 ED 42        	sbc hl,bc
 378  81E5 C1           	pop bc
 379  81E6 38 07        	jr c,print_panel_r_ex2
 380  81E8 28 05        	jr z,print_panel_r_ex2
 381  81EA 10 DE        	djnz print_panel_r_cl
 382  81EC C9           	ret
 383  81ED              print_panel_r_ex
 384  81ED D1           	pop de
 385  81EE C1           	pop bc
 386  81EF              print_panel_r_ex2
 387  81EF              	;тут, возможно, надо допечатать пустые строки
 388  81EF C9           	ret
 389  81F0
 390  81F0
 391  81F0
 392  81F0
 393  81F0
 394  81F0              print_file_info ;печать строки о файле
 395  81F0 3A FF 83     	ld a,(LFN_enable_flag)
 396  81F3 B7           	or a
 397  81F4 28 4D        	jr z,print_file_info_SFN
 398  81F6
 399  81F6
 400  81F6
 401  81F6              print_file_info_LFN ;печать длинного имени
 402  81F6              	;узнать номер записи
 403  81F6 01 00 C0     	ld bc,#c000
 404  81F9 A7           	and a
 405  81FA ED 42        	sbc hl,bc
 406  81FC              ;разделить на 32
 407  81FC CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 408  81FE CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 409  8200 CB 3C        	srl h ; /4
 410  8202 CB 1D        	rr l ;
 411  8204 CB 3C        	srl h ; /8
 412  8206 CB 1D        	rr l ;
 413  8208 CB 3C        	srl h ; /16
 414  820A CB 1D        	rr l ;
 415  820C CB 3C        	srl h ; /32
 416  820E CB 1D        	rr l ;
 417  8210
 418  8210
 419  8210 EB           	ex de,hl ;de - порядковый номер записи
 420  8211
 421  8211 21 B9 8E     	ld hl,file_info_string ;куда
 422  8214              	OS_GET_LFN ;получить длинное имя
 422  8214 0E 2A       >    ld c,#2a
 422  8216 E7          >    rst #20
 423  8217
 424  8217 CD 6B 82     	call get_color_item
 425  821A
 426  821A 06 0C        	ld b,#c
 427  821C              	OS_SET_COLOR
 427  821C 0E 06       >    ld c,#06
 427  821E E7          >    rst #20
 428  821F
 429  821F              	;печать не длиннее 80/2 символов
 430  821F 21 B9 8E     	ld hl,file_info_string
 431  8222 06 26        	ld b,80/2-2
 432  8224 0E 28        	ld c,40 ;колонка
 433  8226              print_file_info_LFN_cl
 434  8226 E5           	push hl
 435  8227 C5           	push bc
 436  8228 7E           	ld a,(hl)
 437  8229 B7           	or a
 438  822A 28 09        	jr z,print_file_info_LFN_cl_ex
 439  822C              	OS_PRINT_CHARF
 439  822C D7          >	rst #10
 440  822D C1           	pop bc
 441  822E 0C           	inc c
 442  822F E1           	pop hl
 443  8230 23           	inc hl
 444  8231 10 F3        	djnz print_file_info_LFN_cl
 445  8233 18 02        	jr print_file_info_LFN_ex
 446  8235              print_file_info_LFN_cl_ex
 447  8235 C1           	pop bc
 448  8236 E1           	pop hl
 449  8237              print_file_info_LFN_ex
 450  8237              	;допечатать пробелы до правого края, зависит от длины имени
 451  8237              print_file_info_LFN_cl2
 452  8237 79           	ld a,c
 453  8238 FE 4E        	cp 80-2
 454  823A D0           	ret nc
 455  823B C5           	push bc
 456  823C 3E 20        	ld a,' '
 457  823E              	OS_PRINT_CHARF
 457  823E D7          >	rst #10
 458  823F C1           	pop bc
 459  8240 0C           	inc c
 460  8241 18 F4        	jr print_file_info_LFN_cl2
 461  8243
 462  8243
 463  8243
 464  8243              print_file_info_SFN ;печать короткого имени
 465  8243 11 B9 8E     	ld de,file_info_string ;скопировать
 466  8246 01 08 00     	ld bc,8 ;file_info_lenght
 467  8249 ED B0        	ldir
 468  824B 3E 20        	ld a,' '
 469  824D 12           	ld (de),a
 470  824E 13           	inc de
 471  824F 01 03 00     	ld bc,3
 472  8252 ED B0        	ldir
 473  8254 AF           	xor a
 474  8255 12           	ld (de),a
 475  8256
 476  8256 CD 6B 82     	call get_color_item
 477  8259
 478  8259 06 0C        	ld b,#c
 479  825B              	OS_SET_COLOR
 479  825B 0E 06       >    ld c,#06
 479  825D E7          >    rst #20
 480  825E 21 B9 8E     	ld hl,file_info_string
 481  8261              	OS_PRINTZ
 481  8261 0E 09       >    ld c,#09
 481  8263 E7          >    rst #20
 482  8264              	;допечатать пробелы до правого края, длина имени постоянная
 483  8264 21 C0 89     	ld hl,file_info_string_SFN_end
 484  8267              	OS_PRINTZ
 484  8267 0E 09       >    ld c,#09
 484  8269 E7          >    rst #20
 485  826A C9           	ret
 486  826B
 487  826B
 488  826B
 489  826B              get_color_item ;получить цвет элемента
 490  826B              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 491  826B              ;вых: A - цвет
 492  826B ED 4B B8 89  	ld bc,(file_r_num_cur) ;позиция курсора справа
 493  826F FD E5        	push iy
 494  8271 E1           	pop hl
 495  8272 A7           	and a
 496  8273 ED 42        	sbc hl,bc ;сравнить
 497  8275 28 11        	jr z,get_color_item_no_cursor
 498  8277              	;цвета курсора
 499  8277 3E 0E        	ld a,color_dir ;простая
 500  8279 32 A3 82     	ld (get_color_item_dir+1),a
 501  827C 3E 0C        	ld a,color_apg ;простая
 502  827E 32 AB 82     	ld (get_color_item_apg+1),a
 503  8281 3E 0F        	ld a,color_backgr ;простая
 504  8283 32 AE 82     	ld (get_color_item_backgr+1),a
 505  8286 18 0F        	jr get_color_item_set
 506  8288
 507  8288              get_color_item_no_cursor
 508  8288              	;цвета обычные
 509  8288 3E 28        	ld a,color_dir_hi ;под курсором
 510  828A 32 A3 82     	ld (get_color_item_dir+1),a
 511  828D 3E 28        	ld a,color_apg_hi ;под курсором
 512  828F 32 AB 82     	ld (get_color_item_apg+1),a
 513  8292 3E 28        	ld a,color_backgr_hi ;под курсором
 514  8294 32 AE 82     	ld (get_color_item_backgr+1),a
 515  8297
 516  8297              get_color_item_set
 517  8297              	;задать цвет
 518  8297 DD 7E 0B     	ld a,(ix+#0b)
 519  829A FE 10        	cp #10 ;признак каталога
 520  829C 28 04        	jr z,get_color_item_dir
 521  829E FE 30        	cp #30 ;признак каталога
 522  82A0 20 03        	jr nz,get_color_item_no_dir
 523  82A2              	;если папка
 524  82A2              get_color_item_dir
 525  82A2 3E 00        	ld a,0
 526  82A4 C9           	ret
 527  82A5
 528  82A5              get_color_item_no_dir
 529  82A5 CD A4 81     	call check_apg ;расширение apg
 530  82A8 20 03        	jr nz,get_color_item_no_apg
 531  82AA              	;если приложение
 532  82AA              get_color_item_apg
 533  82AA 3E 00        	ld a,0
 534  82AC C9           	ret
 535  82AD
 536  82AD              get_color_item_no_apg
 537  82AD              	;если обычный файл
 538  82AD              get_color_item_backgr
 539  82AD 3E 00        	ld a,0
 540  82AF C9           	ret
 541  82B0
 542  82B0
 543  82B0
 544  82B0              ; format_dir ;подготовить каталог, убрать лишнее
 545  82B0              	; ; ld a,2
 546  82B0              	; ; out (254),a
 547  82B0              	; ld iy,0 ;счётчик файлов
 548  82B0              	; ;найти конец каталога
 549  82B0              	; ld hl,buffer_cat
 550  82B0              	; ld a,(hl)
 551  82B0              	; or a
 552  82B0              	; ret z ;защита
 553  82B0              	; ld bc,32
 554  82B0              ; format_dir_prep_cl
 555  82B0              	; ld a,(hl)
 556  82B0              	; or a
 557  82B0              	; jr z,format_dir_prep_ex
 558  82B0              	; add hl,bc
 559  82B0              	; ld a,h
 560  82B0              	; or a ;если вышли за границу
 561  82B0              	; jr z,format_dir_prep_ex
 562  82B0              	; jr format_dir_prep_cl
 563  82B0              ; format_dir_prep_ex
 564  82B0              	; ld bc,32
 565  82B0              	; and a
 566  82B0              	; sbc hl,bc
 567  82B0              	; ld (format_dir_top),hl ;конец каталога
 568  82B0
 569  82B0
 570  82B0
 571  82B0              	; ld ix,buffer_cat
 572  82B0              	; ;ld b,panel_hight ;высота панели
 573  82B0              ; format_dir_cl ;цикл
 574  82B0              	; ld a,(ix)
 575  82B0              	; or a ;конец каталога
 576  82B0              	; jr z,format_dir_ex
 577  82B0              	; cp #e5 ;удалённый
 578  82B0              	; jr z,format_dir_skip
 579  82B0              	; cp #05 ;удалённый
 580  82B0              	; jr z,format_dir_skip
 581  82B0              	; ld a,(ix+#0b)
 582  82B0              	; cp #0f ;длинный
 583  82B0              	; jr z,format_dir_skip
 584  82B0
 585  82B0              	; ;проверка на папку "." (этот же каталог)
 586  82B0              	; ld a,(ix+#00)
 587  82B0              	; cp "." ;
 588  82B0              	; jr nz,format_dir_add
 589  82B0              	; ld a,(ix+#01)
 590  82B0              	; cp " " ;
 591  82B0              	; jr z,format_dir_skip
 592  82B0
 593  82B0
 594  82B0              ; format_dir_add
 595  82B0              	; inc iy ;++
 596  82B0              	; ld bc,32 ;на другой элемент каталога
 597  82B0              	; add ix,bc
 598  82B0              	; ld a,ixh
 599  82B0              	; or a ;если вышли за границу
 600  82B0              	; jr z,format_dir_ex
 601  82B0              	; jr format_dir_cl
 602  82B0              ; format_dir_skip
 603  82B0              	; ;сдвинуть элементы вниз
 604  82B0              	; push ix
 605  82B0              	; push ix
 606  82B0              	; pop hl
 607  82B0              	; pop de ;куда
 608  82B0              	; ld hl,(format_dir_top) ;0-32
 609  82B0              	; and a
 610  82B0              	; sbc hl,de
 611  82B0              	; ld b,h
 612  82B0              	; ld c,l ;длина
 613  82B0              	; push bc
 614  82B0
 615  82B0              	; push ix
 616  82B0              	; pop hl ;откуда
 617  82B0              	; ld bc,32 ;на другой элемент каталога
 618  82B0              	; add hl,bc ;откуда
 619  82B0
 620  82B0              	; pop bc
 621  82B0              	; ldir
 622  82B0
 623  82B0              	; xor a
 624  82B0              	; ld (de),a ;очистить ненужный элемент
 625  82B0
 626  82B0              	; jr format_dir_cl
 627  82B0
 628  82B0              ; format_dir_ex
 629  82B0              	; ld (file_r_all),iy
 630  82B0              	; ;здесь почистить остаток каталога
 631  82B0              	; ; ld a,0
 632  82B0              	; ; out (254),a
 633  82B0              	; ret
 634  82B0              ; format_dir_top	dw 0 ;временно конец гаталога
 635  82B0
 636  82B0
 637  82B0
 638  82B0
 639  82B0
 640  82B0              sort_dir ;сортировка каталога с помощью построения индекса
 641  82B0 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 642  82B4 DD 7E 00     	ld a,(ix)
 643  82B7 B7           	or a
 644  82B8 C8           	ret z ;если пусто, выход
 645  82B9 FD 21 00 00  	ld iy,0 ;счётчик
 646  82BD 21 B9 8A     	ld hl,cat_index ;таблица - индекс
 647  82C0
 648  82C0 3A E2 83     	ld a,(sort_enable_flag)
 649  82C3 B7           	or a
 650  82C4 CA E5 82     	jp z,sort_dir_no
 651  82C7
 652  82C7 AF           	xor a
 653  82C8 32 E4 82     	ld (sort_item),a ;образец для сравнения
 654  82CB              sort_dir_cl
 655  82CB CD 6D 83     	call sort_dir_one ;один проход по папкам
 656  82CE 3A E4 82     	ld a,(sort_item)
 657  82D1 3C           	inc a ;следующий образец
 658  82D2 32 E4 82     	ld (sort_item),a
 659  82D5 20 F4        	jr nz,sort_dir_cl
 660  82D7
 661  82D7              	; xor a
 662  82D7              	; ld (sort_item),a ;образец для сравнения
 663  82D7              sort_file_cl
 664  82D7 CD 25 83     	call sort_file_one ;один проход по файлам
 665  82DA 3A E4 82     	ld a,(sort_item)
 666  82DD 3C           	inc a ;следующий образец
 667  82DE 32 E4 82     	ld (sort_item),a
 668  82E1 20 F4        	jr nz,sort_file_cl
 669  82E3
 670  82E3 C9           	ret
 671  82E4
 672  82E4 00           sort_item db 0; текущий образец
 673  82E5
 674  82E5
 675  82E5
 676  82E5              ;без сортировки
 677  82E5              sort_dir_no
 678  82E5 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 679  82E9              sort_dir_no_cl ;цикл по каталогам
 680  82E9 DD 7E 00     	ld a,(ix)
 681  82EC B7           	or a ;конец каталога
 682  82ED 28 31        	jr z,sort_dir_no_ex
 683  82EF FE E5        	cp #e5 ;удалённый
 684  82F1 28 22        	jr z,sort_dir_no_skip
 685  82F3 FE 05        	cp #05 ;удалённый
 686  82F5 28 1E        	jr z,sort_dir_no_skip
 687  82F7 DD 7E 0B     	ld a,(ix+#0b)
 688  82FA FE 0F        	cp #0f ;длинный
 689  82FC 28 17        	jr z,sort_dir_no_skip
 690  82FE
 691  82FE              	;проверка на папку "." (этот же каталог)
 692  82FE DD 7E 00     	ld a,(ix+#00)
 693  8301 FE 2E        	cp "." ;
 694  8303 20 07        	jr nz,sort_dir_no_add
 695  8305 DD 7E 01     	ld a,(ix+#01)
 696  8308 FE 20        	cp " " ;
 697  830A 28 09        	jr z,sort_dir_no_skip
 698  830C
 699  830C              sort_dir_no_add
 700  830C FD 23        	inc iy ;++
 701  830E              	;записать в таблицу (индекс)
 702  830E DD E5        	push ix
 703  8310 C1           	pop bc
 704  8311 71           	ld (hl),c
 705  8312 23           	inc hl
 706  8313 70           	ld (hl),b
 707  8314 23           	inc hl
 708  8315
 709  8315
 710  8315              sort_dir_no_skip
 711  8315 01 20 00     	ld bc,32
 712  8318 DD 09        	add ix,bc ;на следующий
 713  831A DD 7C        	ld a,ixh ;проверка на конец буфера
 714  831C FE C0        	cp #c0
 715  831E 30 C9        	jr nc,sort_dir_no_cl
 716  8320
 717  8320              sort_dir_no_ex
 718  8320 FD 22 A6 87  	ld (file_r_all),iy
 719  8324 C9           	ret
 720  8325
 721  8325
 722  8325              ;сортировка файлов
 723  8325              sort_file_one
 724  8325 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 725  8329              sort_file_one_cl ;цикл по каталогам
 726  8329 DD 7E 00     	ld a,(ix)
 727  832C B7           	or a ;конец каталога
 728  832D 28 39        	jr z,sort_file_one_ex
 729  832F DD 7E 0B     	ld a,(ix+#0b)
 730  8332 FE 10        	cp #10 ;признак каталога
 731  8334 28 27        	jr z,sort_file_one_skip
 732  8336 FE 30        	cp #30 ;признак каталога
 733  8338 28 23        	jr z,sort_file_one_skip
 734  833A DD 7E 00     	ld a,(ix)
 735  833D FE E5        	cp #e5 ;удалённый
 736  833F 28 1C        	jr z,sort_file_one_skip
 737  8341 FE 05        	cp #05 ;удалённый
 738  8343 28 18        	jr z,sort_file_one_skip
 739  8345 DD 7E 0B     	ld a,(ix+#0b)
 740  8348 FE 0F        	cp #0f ;длинный
 741  834A 28 11        	jr z,sort_file_one_skip
 742  834C
 743  834C              	; ;проверка на папку "." (этот же каталог)
 744  834C              	; ld a,(ix+#00)
 745  834C              	; cp "." ;
 746  834C              	; jr nz,sort_file_one_add
 747  834C              	; ld a,(ix+#01)
 748  834C              	; cp " " ;
 749  834C              	; jr z,sort_file_one_skip
 750  834C
 751  834C
 752  834C              sort_file_one_add
 753  834C 3A E4 82     	ld a,(sort_item)
 754  834F DD BE 00     	cp (ix+#00) ;первая буква имени
 755  8352 20 09        	jr nz,sort_file_one_skip ;пока не подошла
 756  8354
 757  8354 FD 23        	inc iy ;++
 758  8356              	;записать в таблицу (индекс)
 759  8356 DD E5        	push ix
 760  8358 C1           	pop bc
 761  8359 71           	ld (hl),c
 762  835A 23           	inc hl
 763  835B 70           	ld (hl),b
 764  835C 23           	inc hl
 765  835D
 766  835D
 767  835D              sort_file_one_skip
 768  835D 01 20 00     	ld bc,32
 769  8360 DD 09        	add ix,bc ;на следующий
 770  8362 DD 7C        	ld a,ixh ;проверка на конец буфера
 771  8364 FE C0        	cp #c0
 772  8366 30 C1        	jr nc,sort_file_one_cl
 773  8368
 774  8368              sort_file_one_ex
 775  8368 FD 22 A6 87  	ld (file_r_all),iy
 776  836C C9           	ret
 777  836D
 778  836D
 779  836D
 780  836D
 781  836D
 782  836D              ;сортировка папок
 783  836D              sort_dir_one
 784  836D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 785  8371              sort_dir_one_cl ;цикл по каталогам
 786  8371 DD 7E 00     	ld a,(ix)
 787  8374 B7           	or a ;конец каталога
 788  8375 28 47        	jr z,sort_dir_one_ex
 789  8377 DD 7E 0B     	ld a,(ix+#0b)
 790  837A FE 10        	cp #10 ;признак каталога
 791  837C 28 04        	jr z,sort_dir_one_skip_no
 792  837E FE 30        	cp #30 ;признак каталога
 793  8380 20 31        	jr nz,sort_dir_one_skip
 794  8382              sort_dir_one_skip_no
 795  8382 DD 7E 00     	ld a,(ix)
 796  8385 FE E5        	cp #e5 ;удалённый
 797  8387 28 2A        	jr z,sort_dir_one_skip
 798  8389 FE 05        	cp #05 ;удалённый
 799  838B 28 26        	jr z,sort_dir_one_skip
 800  838D DD 7E 0B     	ld a,(ix+#0b)
 801  8390 FE 0F        	cp #0f ;длинный
 802  8392 28 1F        	jr z,sort_dir_one_skip
 803  8394
 804  8394              	;проверка на папку "." (этот же каталог)
 805  8394 DD 7E 00     	ld a,(ix+#00)
 806  8397 FE 2E        	cp "." ;
 807  8399 20 07        	jr nz,sort_dir_one_add
 808  839B DD 7E 01     	ld a,(ix+#01)
 809  839E FE 20        	cp " " ;
 810  83A0 28 11        	jr z,sort_dir_one_skip
 811  83A2
 812  83A2              sort_dir_one_add
 813  83A2 3A E4 82     	ld a,(sort_item)
 814  83A5 DD BE 00     	cp (ix+#00) ;первая буква имени
 815  83A8 20 09        	jr nz,sort_dir_one_skip ;пока не подошла
 816  83AA
 817  83AA FD 23        	inc iy ;++
 818  83AC              	;записать в таблицу (индекс)
 819  83AC DD E5        	push ix
 820  83AE C1           	pop bc
 821  83AF 71           	ld (hl),c
 822  83B0 23           	inc hl
 823  83B1 70           	ld (hl),b
 824  83B2 23           	inc hl
 825  83B3
 826  83B3
 827  83B3              sort_dir_one_skip
 828  83B3 01 20 00     	ld bc,32
 829  83B6 DD 09        	add ix,bc ;на следующий
 830  83B8 DD 7C        	ld a,ixh ;проверка на конец буфера
 831  83BA FE C0        	cp #c0
 832  83BC 30 B3        	jr nc,sort_dir_one_cl
 833  83BE
 834  83BE              sort_dir_one_ex
 835  83BE FD 22 A6 87  	ld (file_r_all),iy
 836  83C2 C9           	ret
 837  83C3
 838  83C3
 839  83C3
 840  83C3
 841  83C3
 842  83C3
 843  83C3
 844  83C3              sort_toggle ;переключение сортировки
 845  83C3 3A E2 83     	ld a,(sort_enable_flag)
 846  83C6 EE 01        	xor 1
 847  83C8 32 E2 83     	ld (sort_enable_flag),a
 848  83CB 3E 4E        	ld a,"N" ;вкл
 849  83CD 20 02        	jr nz,sort_toggle1
 850  83CF 3E 66        	ld a,"f";выкл
 851  83D1              sort_toggle1
 852  83D1 32 62 8A     	ld (msg_menu_main2+5),a
 853  83D4
 854  83D4 CD B0 82     	call sort_dir
 855  83D7 CD 6A 84     	call print_menu_main
 856  83DA 3E 01        	ld a,1
 857  83DC 32 BF 89     	ld (print_panel_r_flag),a
 858  83DF
 859  83DF C3 56 80     	jp nc_wait
 860  83E2 00           sort_enable_flag db 0 ;флаг сортировки
 861  83E3
 862  83E3
 863  83E3
 864  83E3
 865  83E3              LFN_toggle ;переключение сортировки
 866  83E3 3A FF 83     	ld a,(LFN_enable_flag)
 867  83E6 EE 01        	xor 1
 868  83E8 32 FF 83     	ld (LFN_enable_flag),a
 869  83EB 3E 4E        	ld a,"N" ;вкл
 870  83ED 20 02        	jr nz,LFN_toggle1
 871  83EF 3E 66        	ld a,"f";выкл
 872  83F1              LFN_toggle1
 873  83F1 32 5B 8A     	ld (msg_menu_main1+5),a
 874  83F4
 875  83F4              	;call sort_dir
 876  83F4 CD 6A 84     	call print_menu_main
 877  83F7 3E 01        	ld a,1
 878  83F9 32 BF 89     	ld (print_panel_r_flag),a
 879  83FC
 880  83FC C3 56 80     	jp nc_wait
 881  83FF 00           LFN_enable_flag db 0 ;флаг сортировки
 882  8400
 883  8400
 884  8400
 885  8400
 886  8400
 887  8400              format_name ;подогнать имя под стандарт filename.ext
 888  8400              ;вх: HL - имя в каталоге
 889  8400 E5           	push hl
 890  8401 21 AA 87     	ld hl,file_name_cur
 891  8404 11 AB 87     	ld de,file_name_cur+1 ;почистить
 892  8407 01 FF 00     	ld bc,256-1
 893  840A 36 00        	ld (hl),0
 894  840C ED B0        	ldir
 895  840E
 896  840E E1           	pop hl
 897  840F E5           	push hl
 898  8410
 899  8410 11 AA 87     	ld de,file_name_cur ;куда
 900  8413 01 FF 08     	ld bc,#08ff
 901  8416              format_name_cl
 902  8416 7E           	ld a,(hl)
 903  8417 FE 21        	cp " "+1
 904  8419 38 04        	jr c,format_name_skip
 905  841B ED A0        	ldi
 906  841D 10 F7        	djnz format_name_cl
 907  841F              format_name_skip
 908  841F 3E 2E        	ld a,"."
 909  8421 12           	ld (de),a
 910  8422
 911  8422 13           	inc de
 912  8423 E1           	pop hl
 913  8424 01 08 00     	ld bc,8 ;перейти на расширение
 914  8427 09           	add hl,bc
 915  8428
 916  8428 01 FF 03     	ld bc,#03ff
 917  842B              format_name_cl2
 918  842B 7E           	ld a,(hl)
 919  842C FE 21        	cp " "+1
 920  842E 38 04        	jr c,format_name_skip2
 921  8430 ED A0        	ldi
 922  8432 10 F7        	djnz format_name_cl2
 923  8434              format_name_skip2
 924  8434 C9           	ret
 925  8435
 926  8435              print_rect_r ;печать рамки правой
 927  8435 3E 0F        	ld a,color_backgr ;цвет
 928  8437 06 0C        	ld b,#c
 929  8439              	OS_SET_COLOR
 929  8439 0E 06       >    ld c,#06
 929  843B E7          >    rst #20
 930  843C 11 28 00     	ld de,#0028 ;xy
 931  843F              	OS_SET_XY
 931  843F 0E 01       >    ld c,#01
 931  8441 E7          >    rst #20
 932  8442 21 DB 89     	ld hl,rect_1
 933  8445              	OS_PRINTZ
 933  8445 0E 09       >    ld c,#09
 933  8447 E7          >    rst #20
 934  8448
 935  8448 11 28 01     	ld de,#0128 ;xy
 936  844B 06 16        	ld b,24-2 ;цикл
 937  844D              print_rect_r_cl
 938  844D C5           	push bc
 939  844E D5           	push de
 940  844F              	OS_SET_XY
 940  844F 0E 01       >    ld c,#01
 940  8451 E7          >    rst #20
 941  8452 21 04 8A     	ld hl,rect_2
 942  8455              	OS_PRINTZ
 942  8455 0E 09       >    ld c,#09
 942  8457 E7          >    rst #20
 943  8458 D1           	pop de
 944  8459 14           	inc d
 945  845A C1           	pop bc
 946  845B 10 F0        	djnz print_rect_r_cl
 947  845D
 948  845D
 949  845D 11 28 17     	ld de,#1728 ;xy
 950  8460              	OS_SET_XY
 950  8460 0E 01       >    ld c,#01
 950  8462 E7          >    rst #20
 951  8463 21 2D 8A     	ld hl,rect_3
 952  8466              	OS_PRINTZ
 952  8466 0E 09       >    ld c,#09
 952  8468 E7          >    rst #20
 953  8469 C9           	ret
 954  846A
 955  846A              print_menu_main ;печать основного меню
 956  846A 3E 07        	ld a,color_default ;цвет
 957  846C 06 0C        	ld b,#c
 958  846E              	OS_SET_COLOR
 958  846E 0E 06       >    ld c,#06
 958  8470 E7          >    rst #20
 959  8471
 960  8471 11 00 18     	ld de,#1800+0*8
 961  8474              	OS_SET_XY
 961  8474 0E 01       >    ld c,#01
 961  8476 E7          >    rst #20
 962  8477 3E 31        	ld a,"1" ;пункт 1
 963  8479              	OS_PRINT_CHARF
 963  8479 D7          >	rst #10
 964  847A 11 08 18     	ld de,#1800+1*8
 965  847D              	OS_SET_XY
 965  847D 0E 01       >    ld c,#01
 965  847F E7          >    rst #20
 966  8480 3E 32        	ld a,"2" ;пункт 2
 967  8482              	OS_PRINT_CHARF
 967  8482 D7          >	rst #10
 968  8483 11 10 18     	ld de,#1800+2*8
 969  8486              	OS_SET_XY
 969  8486 0E 01       >    ld c,#01
 969  8488 E7          >    rst #20
 970  8489 3E 33        	ld a,"3" ;пункт 3
 971  848B              	OS_PRINT_CHARF
 971  848B D7          >	rst #10
 972  848C
 973  848C
 974  848C 3E 28        	ld a,color_backgr_hi ;цвет
 975  848E 06 0C        	ld b,#c
 976  8490              	OS_SET_COLOR
 976  8490 0E 06       >    ld c,#06
 976  8492 E7          >    rst #20
 977  8493
 978  8493 11 01 18     	ld de,#1800+0*8+1
 979  8496              	OS_SET_XY
 979  8496 0E 01       >    ld c,#01
 979  8498 E7          >    rst #20
 980  8499 21 56 8A     	ld hl,msg_menu_main1
 981  849C              	OS_PRINTZ
 981  849C 0E 09       >    ld c,#09
 981  849E E7          >    rst #20
 982  849F 11 09 18     	ld de,#1800+1*8+1
 983  84A2              	OS_SET_XY
 983  84A2 0E 01       >    ld c,#01
 983  84A4 E7          >    rst #20
 984  84A5 21 5D 8A     	ld hl,msg_menu_main2
 985  84A8              	OS_PRINTZ
 985  84A8 0E 09       >    ld c,#09
 985  84AA E7          >    rst #20
 986  84AB 11 11 18     	ld de,#1800+2*8+1
 987  84AE              	OS_SET_XY
 987  84AE 0E 01       >    ld c,#01
 987  84B0 E7          >    rst #20
 988  84B1 21 64 8A     	ld hl,msg_menu_main3
 989  84B4              	OS_PRINTZ
 989  84B4 0E 09       >    ld c,#09
 989  84B6 E7          >    rst #20
 990  84B7 C9           	ret
 991  84B8
 992  84B8
 993  84B8              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 84B8              view_file
   2+ 84B8              	;просмотр файла как текста
   3+ 84B8
   4+ 84B8 2A A6 87     	ld hl,(file_r_all)
   5+ 84BB 7D           	ld a,l
   6+ 84BC B4           	or h
   7+ 84BD CA 8A 85     	jp z,view_file_ex ;защита
   8+ 84C0 2A B8 89     	ld hl,(file_r_num_cur)
   9+ 84C3 CD FF 80     	call calc_deskr
  10+ 84C6 DD 7E 0B     	ld a,(ix+#0b)
  11+ 84C9 FE 10        	cp #10 ;признак каталога
  12+ 84CB CA 8A 85     	jp z,view_file_ex
  13+ 84CE
  14+ 84CE CD 00 84     	call format_name ;обработать имя файла
  15+ 84D1
  16+ 84D1
  17+ 84D1
  18+ 84D1              	OS_CLS ;почистить экран
  18+ 84D1 0E 00       >    ld c,#00
  18+ 84D3 E7          >    rst #20
  19+ 84D4
  20+ 84D4              	;обнулить переменные
  21+ 84D4 AF           	xor a
  22+ 84D5 32 A3 87     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  23+ 84D8              	;ld (view_file_bot_flag),a  ;
  24+ 84D8 21 FF FF     	ld hl,#ffff
  25+ 84DB 22 A4 87     	ld (view_file_end),hl ;конец файла тут
  26+ 84DE 23           	inc hl
  27+ 84DF 22 9B 87     	ld (view_move_right_val),hl
  28+ 84E2
  29+ 84E2 C5           	push bc
  30+ 84E3 CD A8 80     	call clear_buf
  31+ 84E6 C1           	pop bc
  32+ 84E7
  33+ 84E7 21 AA 87     	ld hl,file_name_cur		;строка с именем
  34+ 84EA              	OS_FILE_OPEN
  34+ 84EA 0E 21       >    ld c,#21
  34+ 84EC E7          >    rst #20
  35+ 84ED 30 0E        	jr nc,view_file_open_ok
  36+ 84EF              view_file_file_error
  37+ 84EF 21 6A 8A     	ld hl,msg_file_error
  38+ 84F2              	OS_PRINTZ
  38+ 84F2 0E 09       >    ld c,#09
  38+ 84F4 E7          >    rst #20
  39+ 84F5 06 64        	ld b,2*50
  40+ 84F7 CD A4 80     	call delay1
  41+ 84FA C3 84 85     	jp view_file_wait_ex
  42+ 84FD
  43+ 84FD              view_file_open_ok
  44+ 84FD 32 BB 89     	ld (file_id_cur_r),a
  45+ 8500              	;проверка длины файла не больше #4000
  46+ 8500 7A           	ld	a,d ;самые старшие байты длины
  47+ 8501 B3           	or e
  48+ 8502 28 11        	jr z,view_file_size_ok ;если не слищком большой
  49+ 8504              view_file_too_big
  50+ 8504              	;файл больше буфера
  51+ 8504 11 00 40     	ld de,#4000 ;размер одной первой части
  52+ 8507 21 00 C0     	ld hl,buffer_cat
  53+ 850A 3A BB 89     	ld a,(file_id_cur_r)
  54+ 850D              	OS_FILE_READ ;загрузить
  54+ 850D 0E 23       >    ld c,#23
  54+ 850F E7          >    rst #20
  55+ 8510 38 DD        	jr c,view_file_file_error
  56+ 8512
  57+ 8512 C3 3E 85     	jp view_file_readed
  58+ 8515
  59+ 8515              view_file_size_ok
  60+ 8515 78           	ld	a,b ;младший старший байт длины
  61+ 8516 FE 40        	cp #40
  62+ 8518 38 06        	jr c,view_file_size_ok_small
  63+ 851A 20 E8        	jr nz,view_file_too_big
  64+ 851C 0C           	inc c
  65+ 851D 0D           	dec c
  66+ 851E 20 E4        	jr nz,view_file_too_big
  67+ 8520
  68+ 8520
  69+ 8520              view_file_size_ok_small
  70+ 8520              	;проверка на 0
  71+ 8520 78           	ld a,b
  72+ 8521 B1           	or c
  73+ 8522 CA EF 84     	jp z,view_file_file_error
  74+ 8525              	;узнать где конец файла
  75+ 8525 21 00 C0     	ld hl,buffer_cat
  76+ 8528 09           	add hl,bc
  77+ 8529 22 A4 87     	ld (view_file_end),hl ;конец файла тут
  78+ 852C              	;размер не большой, прочитаем
  79+ 852C 50           	ld d,b ;размер
  80+ 852D 59           	ld e,c
  81+ 852E 21 00 C0     	ld hl,buffer_cat
  82+ 8531 3A BB 89     	ld a,(file_id_cur_r)
  83+ 8534              	OS_FILE_READ ;загрузить
  83+ 8534 0E 23       >    ld c,#23
  83+ 8536 E7          >    rst #20
  84+ 8537 38 B6        	jr c,view_file_file_error
  85+ 8539
  86+ 8539 3E 01        	ld a,1
  87+ 853B 32 A3 87     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  88+ 853E
  89+ 853E              view_file_readed
  90+ 853E              	;файл прочитан
  91+ 853E
  92+ 853E 21 00 C0     	ld hl,buffer_cat
  93+ 8541 22 9D 87     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  94+ 8544 22 9F 87     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  95+ 8547
  96+ 8547 CD 47 86     	call print_file_text
  97+ 854A
  98+ 854A
  99+ 854A CD 12 86     	call print_menu_view ;меню
 100+ 854D CD 2D 86     	call print_menu_view_top ;инфо
 101+ 8550
 102+ 8550 CD B6 80     	call release_key
 103+ 8553
 104+ 8553              view_file_wait ;цикл ожидания клавиши
 105+ 8553              	OS_WAIT
 105+ 8553 DF          >	rst #18
 106+ 8554              	OS_GET_CHAR
 106+ 8554 0E 10       >    ld c,#10
 106+ 8556 E7          >    rst #20
 107+ 8557 FE FF        	cp 255
 108+ 8559 28 F8        	jr z,view_file_wait
 109+ 855B FE 33        	cp "3"
 110+ 855D 28 25        	jr z,view_file_wait_ex
 111+ 855F FE 0A        	cp 10 ;вниз
 112+ 8561 CA 8D 85     	jp z,view_line_down
 113+ 8564 FE 0B        	cp 11 ;вверх
 114+ 8566 CA A3 85     	jp z,view_line_up
 115+ 8569 FE 09        	cp 09 ;вправо
 116+ 856B CA B7 85     	jp z,view_right
 117+ 856E FE 08        	cp 08 ;влево
 118+ 8570 CA C7 85     	jp z,view_left
 119+ 8573 FE 04        	cp 04 ;страница вверх
 120+ 8575 CA D8 85     	jp z,view_page_up
 121+ 8578 FE 05        	cp 05 ;страница вниз
 122+ 857A CA F5 85     	jp z,view_page_down
 123+ 857D FE 18        	cp 24 ;break
 124+ 857F CA A0 81     	jp z,exit
 125+ 8582 18 CF        	jr view_file_wait
 126+ 8584
 127+ 8584              view_file_wait_ex
 128+ 8584              	;почистить экран
 129+ 8584              	OS_CLS
 129+ 8584 0E 00       >    ld c,#00
 129+ 8586 E7          >    rst #20
 130+ 8587 C3 23 80     	jp start_nc_warm ;перезагрузить папку
 131+ 858A
 132+ 858A              view_file_ex
 133+ 858A C3 56 80     	jp nc_wait
 134+ 858D
 135+ 858D
 136+ 858D
 137+ 858D              view_line_down ;вниз на строчку
 138+ 858D 2A 9F 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 139+ 8590 22 9D 87     	ld (view_file_pos_cur),hl
 140+ 8593 CD 6E 87     	call next_line ;вперёд на строку
 141+ 8596 38 BB        	jr c,view_file_wait ;если не удачно
 142+ 8598 2A 9D 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 143+ 859B 22 9F 87     	ld (view_file_pos_cur_focus),hl
 144+ 859E CD 47 86     	call print_file_text ;напечатать всю страницу
 145+ 85A1 18 B0        	jr view_file_wait
 146+ 85A3
 147+ 85A3              view_line_up ;вверх на строчку
 148+ 85A3 2A 9F 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 149+ 85A6 22 9D 87     	ld (view_file_pos_cur),hl
 150+ 85A9 CD 7C 87     	call prev_line ;
 151+ 85AC              	;jr c,view_file_wait ;если не удачно
 152+ 85AC 2A 9D 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 153+ 85AF 22 9F 87     	ld (view_file_pos_cur_focus),hl
 154+ 85B2 CD 47 86     	call print_file_text ;напечатать всю страницу
 155+ 85B5 18 9C        	jr view_file_wait
 156+ 85B7
 157+ 85B7
 158+ 85B7              view_right ;вправо
 159+ 85B7 2A 9B 87     	ld hl,(view_move_right_val)
 160+ 85BA 23           	inc hl
 161+ 85BB 7C           	ld a,h
 162+ 85BC B5           	or l
 163+ 85BD 28 94        	jr z,view_file_wait
 164+ 85BF 22 9B 87     	ld (view_move_right_val),hl
 165+ 85C2 CD 47 86     	call print_file_text ;напечатать всю страницу
 166+ 85C5 18 8C        	jr view_file_wait
 167+ 85C7
 168+ 85C7              view_left ;влево
 169+ 85C7 2A 9B 87     	ld hl,(view_move_right_val)
 170+ 85CA 7C           	ld a,h
 171+ 85CB B5           	or l
 172+ 85CC 28 85        	jr z,view_file_wait
 173+ 85CE 2B           	dec hl
 174+ 85CF 22 9B 87     	ld (view_move_right_val),hl
 175+ 85D2 CD 47 86     	call print_file_text ;напечатать всю страницу
 176+ 85D5 C3 53 85     	jp view_file_wait
 177+ 85D8
 178+ 85D8
 179+ 85D8
 180+ 85D8              view_page_up ;на страницу назад
 181+ 85D8 2A 9F 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 182+ 85DB 22 9D 87     	ld (view_file_pos_cur),hl
 183+ 85DE 06 16        	ld b,view_text_bot-2
 184+ 85E0              view_page_up_cl
 185+ 85E0 CD 7C 87     	call prev_line ;
 186+ 85E3 38 04        	jr c,view_page_up_ex ;если не удачно
 187+ 85E5 28 02        	jr z,view_page_up_ex
 188+ 85E7 10 F7        	djnz view_page_up_cl
 189+ 85E9              view_page_up_ex
 190+ 85E9 2A 9D 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 191+ 85EC 22 9F 87     	ld (view_file_pos_cur_focus),hl
 192+ 85EF CD 47 86     	call print_file_text ;напечатать всю страницу
 193+ 85F2 C3 53 85     	jp view_file_wait
 194+ 85F5
 195+ 85F5
 196+ 85F5
 197+ 85F5              view_page_down ;на страницу вперёд
 198+ 85F5 2A 9F 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 199+ 85F8 22 9D 87     	ld (view_file_pos_cur),hl
 200+ 85FB 06 16        	ld b,view_text_bot-2
 201+ 85FD              view_page_down_cl
 202+ 85FD CD 6E 87     	call next_line ;
 203+ 8600 38 04        	jr c,view_page_down_ex ;если не удачно
 204+ 8602 28 02        	jr z,view_page_down_ex
 205+ 8604 10 F7        	djnz view_page_down_cl
 206+ 8606              view_page_down_ex
 207+ 8606 2A 9D 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 208+ 8609 22 9F 87     	ld (view_file_pos_cur_focus),hl
 209+ 860C CD 47 86     	call print_file_text ;напечатать всю страницу
 210+ 860F C3 53 85     	jp view_file_wait
 211+ 8612
 212+ 8612
 213+ 8612
 214+ 8612              print_menu_view ;печать меню просмотрщика
 215+ 8612 3E 18        	ld a,#18
 216+ 8614 06 28        	ld b,color_backgr_hi ;цвет
 217+ 8616              	OS_PAINT_LINE ;линия внизу
 217+ 8616 0E 04       >    ld c,#04
 217+ 8618 E7          >    rst #20
 218+ 8619 3E 28        	ld a,color_backgr_hi ;цвет
 219+ 861B 06 0C        	ld b,#c
 220+ 861D              	OS_SET_COLOR
 220+ 861D 0E 06       >    ld c,#06
 220+ 861F E7          >    rst #20
 221+ 8620 11 10 18     	ld de,#1800+2*8
 222+ 8623              	OS_SET_XY
 222+ 8623 0E 01       >    ld c,#01
 222+ 8625 E7          >    rst #20
 223+ 8626 21 94 87     	ld hl,msg_menu_view
 224+ 8629              	OS_PRINTZ
 224+ 8629 0E 09       >    ld c,#09
 224+ 862B E7          >    rst #20
 225+ 862C C9           	ret
 226+ 862D
 227+ 862D              print_menu_view_top ;печать меню просмотрщика верхнее
 228+ 862D AF           	xor a
 229+ 862E 06 28        	ld b,color_backgr_hi ;цвет
 230+ 8630              	OS_PAINT_LINE ;линия вверху
 230+ 8630 0E 04       >    ld c,#04
 230+ 8632 E7          >    rst #20
 231+ 8633 3E 28        	ld a,color_backgr_hi ;цвет
 232+ 8635 06 0C        	ld b,#c
 233+ 8637              	OS_SET_COLOR
 233+ 8637 0E 06       >    ld c,#06
 233+ 8639 E7          >    rst #20
 234+ 863A 11 24 00     	ld de,#0024
 235+ 863D              	OS_SET_XY
 235+ 863D 0E 01       >    ld c,#01
 235+ 863F E7          >    rst #20
 236+ 8640 21 AA 87     	ld hl,file_name_cur
 237+ 8643              	OS_PRINTZ
 237+ 8643 0E 09       >    ld c,#09
 237+ 8645 E7          >    rst #20
 238+ 8646 C9           	ret
 239+ 8647
 240+ 8647
 241+ 8647
 242+ 8647              print_file_text	;печать текущей части файла в консоль
 243+ 8647 3E 04        	ld a,color_view_text ;цвет
 244+ 8649 06 0C        	ld b,#c
 245+ 864B              	OS_SET_COLOR
 245+ 864B 0E 06       >    ld c,#06
 245+ 864D E7          >    rst #20
 246+ 864E
 247+ 864E 3E 01        	ld a,view_text_top ;первая строка
 248+ 8650 32 A1 87     	ld (view_file_y_cur),a
 249+ 8653 2A 9F 87     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 250+ 8656 22 9D 87     	ld (view_file_pos_cur),hl
 251+ 8659              print_file_text_cl
 252+ 8659 2A 9D 87     	ld hl,(view_file_pos_cur)
 253+ 865C CD 82 86     	call print_line_text
 254+ 865F 38 0C        	jr c,print_file_text_ex
 255+ 8661
 256+ 8661              	; call next_line ;найти следующую строку
 257+ 8661              	; ret c
 258+ 8661
 259+ 8661 3A A1 87     	ld a,(view_file_y_cur)
 260+ 8664 3C           	inc a
 261+ 8665 32 A1 87     	ld (view_file_y_cur),a
 262+ 8668 FE 18        	cp view_text_bot
 263+ 866A 38 ED        	jr c,print_file_text_cl
 264+ 866C C9           	ret
 265+ 866D
 266+ 866D              print_file_text_ex
 267+ 866D              	;тут очистить остальные строки
 268+ 866D 3A A1 87     	ld a,(view_file_y_cur)
 269+ 8670 3C           	inc a
 270+ 8671 FE 18        	cp view_text_bot
 271+ 8673 30 0B        	jr nc,print_file_text_ex2
 272+ 8675 67           	ld h,a
 273+ 8676 32 A1 87     	ld (view_file_y_cur),a
 274+ 8679 3E 20        	ld a," "
 275+ 867B              	OS_FILL_LINE ;очистить строку
 275+ 867B 0E 03       >    ld c,#03
 275+ 867D E7          >    rst #20
 276+ 867E 18 ED        	jr print_file_text_ex
 277+ 8680              print_file_text_ex2
 278+ 8680 37           	scf
 279+ 8681 C9           	ret
 280+ 8682
 281+ 8682
 282+ 8682
 283+ 8682              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 284+ 8682              ;вх: hl - адрес строки
 285+ 8682 CD D2 86     	call view_move_right ;промотать направо. если надо
 286+ 8685              	;установить позицию
 287+ 8685 3A A1 87     	ld a,(view_file_y_cur)
 288+ 8688 57           	ld d,a
 289+ 8689 AF           	xor a
 290+ 868A 32 A2 87     	ld (view_file_x_cur),a
 291+ 868D 5F           	ld e,a
 292+ 868E              	OS_SET_XY 	;yx
 292+ 868E 0E 01       >    ld c,#01
 292+ 8690 E7          >    rst #20
 293+ 8691              print_line_text_cl ;цикл
 294+ 8691
 295+ 8691 7E           	ld a,(hl)
 296+ 8692 FE 0A        	cp 10 ;этот код не печатаем
 297+ 8694 28 14        	jr z,print_line_text_skip
 298+ 8696 FE FF        	cp #ff ;этот код не печатаем
 299+ 8698 28 10        	jr z,print_line_text_skip
 300+ 869A FE 0D        	cp 13
 301+ 869C 28 13        	jr z,print_line_text_ex_ok
 302+ 869E              	OS_PRINT_CHARF ;печать
 302+ 869E D7          >	rst #10
 303+ 869F
 304+ 869F              	;на следующую позицию
 305+ 869F 3A A2 87     	ld a,(view_file_x_cur)
 306+ 86A2 3C           	inc a
 307+ 86A3 FE 50        	cp 80 ;правый край экрана
 308+ 86A5 32 A2 87     	ld (view_file_x_cur),a
 309+ 86A8 30 15        	jr nc,print_line_text_right ;дошли до правого края
 310+ 86AA
 311+ 86AA              print_line_text_skip
 312+ 86AA CD 0A 87     	call view_file_next_pos ;следующий
 313+ 86AD 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 314+ 86AF 18 E0        	jr print_line_text_cl
 315+ 86B1
 316+ 86B1              print_line_text_ex_ok ;выход норма по коду 13
 317+ 86B1 3E 20        	ld a," "
 318+ 86B3              	OS_PRINT_CHARF ;печать
 318+ 86B3 D7          >	rst #10
 319+ 86B4 CD C3 86     	call printe_clear_end ;добить до конца строки
 320+ 86B7 C3 0A 87     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 321+ 86BA              	;ret
 322+ 86BA
 323+ 86BA              print_line_text_ex_end ;выход если кончился файл
 324+ 86BA CD C3 86     	call printe_clear_end
 325+ 86BD 37           	scf
 326+ 86BE C9           	ret
 327+ 86BF
 328+ 86BF              print_line_text_right
 329+ 86BF CD 6E 87     	call next_line ;позицию  до конца строки
 330+ 86C2 C9           	ret
 331+ 86C3
 332+ 86C3
 333+ 86C3              printe_clear_end
 334+ 86C3              	;добить строку пробелами
 335+ 86C3 3A A2 87     	ld a,(view_file_x_cur)
 336+ 86C6 3C           	inc a
 337+ 86C7 FE 50        	cp 80 ;правый край экрана
 338+ 86C9 32 A2 87     	ld (view_file_x_cur),a
 339+ 86CC D0           	ret nc
 340+ 86CD 3E 20        	ld a," "
 341+ 86CF              	OS_PRINT_CHARF ;печать
 341+ 86CF D7          >	rst #10
 342+ 86D0 18 F1        	jr printe_clear_end
 343+ 86D2
 344+ 86D2
 345+ 86D2
 346+ 86D2
 347+ 86D2
 348+ 86D2              view_move_right ;перемотка строки направо
 349+ 86D2 ED 4B 9B 87  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 350+ 86D6 78           	ld a,b
 351+ 86D7 B1           	or c
 352+ 86D8 C8           	ret z
 353+ 86D9 2A 9D 87     	ld hl,(view_file_pos_cur)
 354+ 86DC              view_move_right1
 355+ 86DC 7E           	ld a,(hl)
 356+ 86DD FE 0A        	cp 10 ;этот код пропускаем
 357+ 86DF 20 07        	jr nz,view_move_right2
 358+ 86E1 CD 0A 87     	call view_file_next_pos
 359+ 86E4 D8           	ret c
 360+ 86E5 C8           	ret z
 361+ 86E6 18 F4        	jr view_move_right1
 362+ 86E8              view_move_right2
 363+ 86E8 FE FF        	cp #ff ;этот код пропускаем
 364+ 86EA 20 07        	jr nz,view_move_right3
 365+ 86EC CD 0A 87     	call view_file_next_pos
 366+ 86EF D8           	ret c
 367+ 86F0 C8           	ret z
 368+ 86F1 18 E9        	jr view_move_right1
 369+ 86F3              view_move_right3
 370+ 86F3 7E           	ld a,(hl)
 371+ 86F4 FE 0D        	cp 13 ;
 372+ 86F6 C8           	ret z
 373+ 86F7              view_move_right_cl
 374+ 86F7 CD 0A 87     	call view_file_next_pos
 375+ 86FA D8           	ret c
 376+ 86FB C8           	ret z
 377+ 86FC 7E           	ld a,(hl)
 378+ 86FD FE 0D        	cp 13
 379+ 86FF C8           	ret z
 380+ 8700 FE 0A        	cp 10 ;этот код пропускаем
 381+ 8702 28 F3        	jr z,view_move_right_cl
 382+ 8704 0B           	dec bc
 383+ 8705 78           	ld a,b
 384+ 8706 B1           	or c
 385+ 8707 20 EE        	jr nz,view_move_right_cl
 386+ 8709              	;call view_file_next_pos ;следующий
 387+ 8709 C9           	ret
 388+ 870A
 389+ 870A
 390+ 870A
 391+ 870A              ;получение следующей позиции
 392+ 870A              view_file_next_pos
 393+ 870A 3A A3 87     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 394+ 870D B7           	or a
 395+ 870E 28 14        	jr z,view_file_next_pos_big
 396+ 8710              	;если текст не большой
 397+ 8710 2A A4 87     	ld hl,(view_file_end) ;конец текста известен
 398+ 8713 ED 5B 9D 87  	ld de,(view_file_pos_cur)
 399+ 8717 13           	inc de ;вперёд
 400+ 8718 A7           	and a
 401+ 8719 ED 52        	sbc hl,de
 402+ 871B 38 15        	jr c,view_file_next_pos_end
 403+ 871D ED 53 9D 87  	ld (view_file_pos_cur),de
 404+ 8721 EB           	ex de,hl ;на выходе адрес в HL
 405+ 8722 B7           	or a
 406+ 8723 C9           	ret
 407+ 8724
 408+ 8724
 409+ 8724
 410+ 8724              view_file_next_pos_big
 411+ 8724              	;если текст большой
 412+ 8724 2A 9D 87     	ld hl,(view_file_pos_cur)	;текущая позиция
 413+ 8727 23           	inc hl ;вперёд
 414+ 8728 7C           	ld a,h
 415+ 8729 FE C0        	cp #c0 ;если вышли за пределы окна
 416+ 872B 38 05        	jr c,view_file_next_pos_end
 417+ 872D 22 9D 87     	ld (view_file_pos_cur),hl
 418+ 8730 B7           	or a
 419+ 8731 C9           	ret
 420+ 8732
 421+ 8732              view_file_next_pos_end
 422+ 8732              	;не смогли шагнуть вперёд
 423+ 8732              	; ld a,1 ;флаг что внизу
 424+ 8732              	; ld (view_file_bot_flag),a
 425+ 8732 37           	scf ;ошибка
 426+ 8733 C9           	ret
 427+ 8734
 428+ 8734
 429+ 8734
 430+ 8734
 431+ 8734
 432+ 8734
 433+ 8734              ;получение предыдущей позиции
 434+ 8734              view_file_prev_pos
 435+ 8734 3A A3 87     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 436+ 8737 B7           	or a
 437+ 8738 28 1E        	jr z,view_file_prev_pos_big
 438+ 873A              	;если текст не большой
 439+ 873A 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 440+ 873D ED 5B 9D 87  	ld de,(view_file_pos_cur) ;текущая позиция
 441+ 8741 1B           	dec de ;назад
 442+ 8742 A7           	and a
 443+ 8743 ED 52        	sbc hl,de
 444+ 8745 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 445+ 8747 30 1D        	jr nc,view_file_prev_pos_end
 446+ 8749              	;можно шагнуть назад
 447+ 8749 ED 53 9D 87  	ld (view_file_pos_cur),de
 448+ 874D EB           	ex de,hl ;на выходе адрес в HL
 449+ 874E AF           	xor a
 450+ 874F 3C           	inc a ;a=1
 451+ 8750 C9           	ret
 452+ 8751              view_file_prev_pos_top
 453+ 8751              	;если в начале
 454+ 8751 ED 53 9D 87  	ld (view_file_pos_cur),de
 455+ 8755 EB           	ex de,hl ;на выходе адрес в HL
 456+ 8756 AF           	xor a ;a=0
 457+ 8757 C9           	ret
 458+ 8758
 459+ 8758
 460+ 8758              view_file_prev_pos_big
 461+ 8758              	;если текст большой
 462+ 8758 2A 9D 87     	ld hl,(view_file_pos_cur)	;текущая позиция
 463+ 875B 2B           	dec hl ;назад
 464+ 875C 7C           	ld a,h
 465+ 875D FE C0        	cp #c0 ;если вышли за пределы окна
 466+ 875F 38 05        	jr c,view_file_prev_pos_end
 467+ 8761 22 9D 87     	ld (view_file_pos_cur),hl
 468+ 8764 B7           	or a
 469+ 8765 C9           	ret
 470+ 8766
 471+ 8766              view_file_prev_pos_end
 472+ 8766              	;не смогли шагнуть назад
 473+ 8766 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 474+ 8769 22 9D 87     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 475+ 876C              	;вернулись в начало
 476+ 876C AF           	xor a ;a=0
 477+ 876D C9           	ret
 478+ 876E
 479+ 876E
 480+ 876E
 481+ 876E
 482+ 876E              next_line ;поиск следующей строки
 483+ 876E CD 0A 87     	call view_file_next_pos
 484+ 8771 D8           	ret c
 485+ 8772 C8           	ret z
 486+ 8773 7E           	ld a,(hl)
 487+ 8774 FE 0D        	cp 13
 488+ 8776 20 F6        	jr nz,next_line
 489+ 8778 CD 0A 87     	call view_file_next_pos ;ещё на символ
 490+ 877B C9           	ret
 491+ 877C
 492+ 877C
 493+ 877C
 494+ 877C              prev_line ;поиск предыдущей строки
 495+ 877C              ;если достигнуто начало файла - вернёт адрес начальный
 496+ 877C              	;сначала в конец предыдущей
 497+ 877C CD 34 87     	call view_file_prev_pos
 498+ 877F C8           	ret z
 499+ 8780 D8           	ret c
 500+ 8781 7E           	ld a,(hl)
 501+ 8782 FE 0D        	cp 13
 502+ 8784 20 F6        	jr nz,prev_line
 503+ 8786              	;теперь в начало предыдущей
 504+ 8786              prev_line1
 505+ 8786 CD 34 87     	call view_file_prev_pos
 506+ 8789 C8           	ret z
 507+ 878A D8           	ret c
 508+ 878B 7E           	ld a,(hl)
 509+ 878C FE 0D        	cp 13
 510+ 878E 20 F6        	jr nz,prev_line1
 511+ 8790 CD 0A 87     	call view_file_next_pos ;ещё на символ обратно
 512+ 8793 C9           	ret
 513+ 8794
 514+ 8794
 515+ 8794
 516+ 8794              view_text_bot equ 24 ;последняя строка для печати
 517+ 8794              view_text_top equ 1 ;первая строка
 518+ 8794              view_text_lines equ 25-2 ;видимых строк на экране
 519+ 8794
 520+ 8794              msg_menu_view
 521+ 8794 33 20 45 78  	db "3 Exit",0
 521+ 8798 69 74 00
 522+ 879B
 523+ 879B              ;view_file_position ds 4 ;текущая позиция в файле
 524+ 879B              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 525+ 879B 00 00        view_move_right_val dw 0 ;сдвиг вправо
 526+ 879D 00 00        view_file_pos_cur dw 0;текущая позиция
 527+ 879F 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 528+ 87A1 00           view_file_y_cur db 0;текущая строка
 529+ 87A2 00           view_file_x_cur db 0;текущий столбец
 530+ 87A3 00           view_file_load_all db 0 ;флаг что файл весь загружен
 531+ 87A4 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 532+ 87A6
 533+ 87A6
# file closed: nc_view.asm
 994  87A6
 995  87A6              color_default equ 0*8+7 ;цвет обычный системный
 996  87A6              color_view_text equ 4 ;цвет текста в просмотрщике
 997  87A6
 998  87A6              color_backgr equ 1*8+7 ;цвет фона
 999  87A6              color_apg equ 1*8+4 ;цвет приложений
1000  87A6              color_dir equ 1*8+6 ;цвет папок
1001  87A6
1002  87A6              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1003  87A6              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1004  87A6              color_dir_hi equ 5*8+0 ;цвет папок курсор
1005  87A6
1006  87A6              file_info_lenght equ 255 ;длина инфо о файле
1007  87A6              panel_hight equ 22;высота панели
1008  87A6              panel_r_xy equ #0129
1009  87A6              buffer_cat equ #c000 ;адрес буфера каталога
1010  87A6
1011  87A6 00 00        file_r_all dw 0;всего файлов справа
1012  87A8 00 00        file_r_cur_focus dw 0;первый видимый
1013  87AA 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1014  88AA 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1015  89AA 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1015  89AE 20 20 20 20
1015  89B2 20 20 20 20
1015  89B6 00
1016  89B7 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1017  89B8
1018  89B8 00 00        file_r_num_cur dw 0 ;текущий файл справа
1019  89BA 00           key_pressed db 0 ;последняя клавиша
1020  89BB 00           file_id_cur_r db 0 ;id файла справа
1021  89BC
1022  89BC
1023  89BC 00           page_ext01 db 0 ;номер дополнительной страницы
1024  89BD 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1025  89BF 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1026  89C0 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1026  89C4 20 20 20 20
1026  89C8 20 20 20 20
1026  89CC 20 20 20 20
1026  89D0 20 20 20 20
1026  89D4 20 20 20 20
1026  89D8 20 20 00
1027  89DB
1028  89DB              rect_1
1029  89DB C9           	db #c9
1030  89DC              	dup 40-2
1031  89DC CD          >	db #cd
1031  89DD CD          >	db #cd
1031  89DE CD          >	db #cd
1031  89DF CD          >	db #cd
1031  89E0 CD          >	db #cd
1031  89E1 CD          >	db #cd
1031  89E2 CD          >	db #cd
1031  89E3 CD          >	db #cd
1031  89E4 CD          >	db #cd
1031  89E5 CD          >	db #cd
1031  89E6 CD          >	db #cd
1031  89E7 CD          >	db #cd
1031  89E8 CD          >	db #cd
1031  89E9 CD          >	db #cd
1031  89EA CD          >	db #cd
1031  89EB CD          >	db #cd
1031  89EC CD          >	db #cd
1031  89ED CD          >	db #cd
1031  89EE CD          >	db #cd
1031  89EF CD          >	db #cd
1031  89F0 CD          >	db #cd
1031  89F1 CD          >	db #cd
1031  89F2 CD          >	db #cd
1031  89F3 CD          >	db #cd
1031  89F4 CD          >	db #cd
1031  89F5 CD          >	db #cd
1031  89F6 CD          >	db #cd
1031  89F7 CD          >	db #cd
1031  89F8 CD          >	db #cd
1031  89F9 CD          >	db #cd
1031  89FA CD          >	db #cd
1031  89FB CD          >	db #cd
1031  89FC CD          >	db #cd
1031  89FD CD          >	db #cd
1031  89FE CD          >	db #cd
1031  89FF CD          >	db #cd
1031  8A00 CD          >	db #cd
1031  8A01 CD          >	db #cd
1032  8A02              	edup
1033  8A02 BB 00        	db #bb,0
1034  8A04
1035  8A04              rect_2
1036  8A04 BA           	db #ba
1037  8A05              	dup 40-2
1038  8A05 20          >	db " "
1038  8A06 20          >	db " "
1038  8A07 20          >	db " "
1038  8A08 20          >	db " "
1038  8A09 20          >	db " "
1038  8A0A 20          >	db " "
1038  8A0B 20          >	db " "
1038  8A0C 20          >	db " "
1038  8A0D 20          >	db " "
1038  8A0E 20          >	db " "
1038  8A0F 20          >	db " "
1038  8A10 20          >	db " "
1038  8A11 20          >	db " "
1038  8A12 20          >	db " "
1038  8A13 20          >	db " "
1038  8A14 20          >	db " "
1038  8A15 20          >	db " "
1038  8A16 20          >	db " "
1038  8A17 20          >	db " "
1038  8A18 20          >	db " "
1038  8A19 20          >	db " "
1038  8A1A 20          >	db " "
1038  8A1B 20          >	db " "
1038  8A1C 20          >	db " "
1038  8A1D 20          >	db " "
1038  8A1E 20          >	db " "
1038  8A1F 20          >	db " "
1038  8A20 20          >	db " "
1038  8A21 20          >	db " "
1038  8A22 20          >	db " "
1038  8A23 20          >	db " "
1038  8A24 20          >	db " "
1038  8A25 20          >	db " "
1038  8A26 20          >	db " "
1038  8A27 20          >	db " "
1038  8A28 20          >	db " "
1038  8A29 20          >	db " "
1038  8A2A 20          >	db " "
1039  8A2B              	edup
1040  8A2B BA 00        	db #ba,0
1041  8A2D
1042  8A2D              rect_3
1043  8A2D C8           	db #c8
1044  8A2E              	dup 40-2
1045  8A2E CD          >	db #cd
1045  8A2F CD          >	db #cd
1045  8A30 CD          >	db #cd
1045  8A31 CD          >	db #cd
1045  8A32 CD          >	db #cd
1045  8A33 CD          >	db #cd
1045  8A34 CD          >	db #cd
1045  8A35 CD          >	db #cd
1045  8A36 CD          >	db #cd
1045  8A37 CD          >	db #cd
1045  8A38 CD          >	db #cd
1045  8A39 CD          >	db #cd
1045  8A3A CD          >	db #cd
1045  8A3B CD          >	db #cd
1045  8A3C CD          >	db #cd
1045  8A3D CD          >	db #cd
1045  8A3E CD          >	db #cd
1045  8A3F CD          >	db #cd
1045  8A40 CD          >	db #cd
1045  8A41 CD          >	db #cd
1045  8A42 CD          >	db #cd
1045  8A43 CD          >	db #cd
1045  8A44 CD          >	db #cd
1045  8A45 CD          >	db #cd
1045  8A46 CD          >	db #cd
1045  8A47 CD          >	db #cd
1045  8A48 CD          >	db #cd
1045  8A49 CD          >	db #cd
1045  8A4A CD          >	db #cd
1045  8A4B CD          >	db #cd
1045  8A4C CD          >	db #cd
1045  8A4D CD          >	db #cd
1045  8A4E CD          >	db #cd
1045  8A4F CD          >	db #cd
1045  8A50 CD          >	db #cd
1045  8A51 CD          >	db #cd
1045  8A52 CD          >	db #cd
1045  8A53 CD          >	db #cd
1046  8A54              	edup
1047  8A54 BC 00        	db #bc,0
1048  8A56
1049  8A56
1050  8A56              msg_menu_main1
1051  8A56 20 4C 46 20  	db " LF Of",0
1051  8A5A 4F 66 00
1052  8A5D              msg_menu_main2
1053  8A5D 20 41 5A 20  	db " AZ Of",0
1053  8A61 4F 66 00
1054  8A64              msg_menu_main3
1055  8A64 20 56 69 65  	db " View",0
1055  8A68 77 00
1056  8A6A              msg_file_error
1057  8A6A 46 69 6C 65  	db "File error",10,13,0
1057  8A6E 20 65 72 72
1057  8A72 6F 72 0A 0D
1057  8A76 00
1058  8A77              msg_file_too_big
1059  8A77 46 69 6C 65  	db "File too big",10,13,0
1059  8A7B 20 74 6F 6F
1059  8A7F 20 62 69 67
1059  8A83 0A 0D 00
1060  8A86              msg_mem_err
1061  8A86 47 65 74 20  	db "Get memory error",10,13,0
1061  8A8A 6D 65 6D 6F
1061  8A8E 72 79 20 65
1061  8A92 72 72 6F 72
1061  8A96 0A 0D 00
1062  8A99              msg_title_nc
1063  8A99 4E 6F 6E 65  	db "None Commander ver 2025.06.25",10,13,0
1063  8A9D 20 43 6F 6D
1063  8AA1 6D 61 6E 64
1063  8AA5 65 72 20 76
1063  8AA9 65 72 20 32
1063  8AAD 30 32 35 2E
1063  8AB1 30 36 2E 32
1063  8AB5 35 0A 0D 00
1064  8AB9
1065  8AB9              end_nc
1066  8AB9              ;ниже не включается в файл
1067  8AB9 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1068  8EB9 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1069  8FB9
1070  8FB9              	savebin "nc.apg",start_nc,$-start_nc
# file closed: nc.asm
