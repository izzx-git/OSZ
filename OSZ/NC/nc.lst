# file opened: nc.asm
  1   0000              ;None Commander - приложение для OS GMX
  2   0000                 device ZXSPECTRUM128
  3   0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
  1+  0000              ;Список всех вызовов (функций) ОС GMX
  2+  0000
  3+  0000              ;Включить в свой код (в начале файла):
  4+  0000              	; include os_defs.asm
  5+  0000
  6+  0000              ;Использовать только имена функций, коды могут поменяться
  7+  0000
  8+  0000              ;например:
  9+  0000              	; org PROGSTART
 10+  0000              	; ../include os_defs.asm
 11+  0000              	; ld hl,text
 12+  0000              	; OS_PRINTZ ;печать	до кода 0
 13+  0000
 14+  0000              ;сохранность регистров не гарантируется
 15+  0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
 16+  0000
 17+  0000              PROGSTART equ #8000 ;адрес старта приложений
 18+  0000
 19+  0000
 20+  0000              ;короткие вызовы (именные RST) -------------------------
 21+  0000
 22+  0000              ;печать символа в консоль (ускоренная)
 23+  0000              	MACRO OS_PRINT_CHARF ;a=char
 24+  0000 ~            	rst #10
 25+  0000              	ENDM
 26+  0000
 27+  0000
 28+  0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
 29+  0000              ;все регистры сохраняются
 30+  0000              ;рекомендуется использовать вместо обычного halt
 31+  0000              	MACRO OS_WAIT
 32+  0000 ~            	rst #18
 33+  0000              	ENDM
 34+  0000
 35+  0000              	; MACRO OS_
 36+  0000              	; rst #28
 37+  0000              	; ENDM
 38+  0000
 39+  0000              	; MACRO OS_
 40+  0000              	; rst #30
 41+  0000              	; ENDM
 42+  0000
 43+  0000
 44+  0000
 45+  0000              ;вызовы через единую точку входа RST #20 ----------------
 46+  0000
 47+  0000              ;вывод в консоль --------------------
 48+  0000
 49+  0000              ;очистить консоль
 50+  0000              	macro OS_CLS ;clear visible area of terminal
 51+  0000 ~                ld c,#00
 52+  0000 ~                rst #20
 53+  0000                  endm
 54+  0000
 55+  0000              ;установить позицию курсора в консоли
 56+  0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
 57+  0000 ~                ld c,#01
 58+  0000 ~                rst #20
 59+  0000                  endm
 60+  0000
 61+  0000              ;печать символа в консоль
 62+  0000                  macro OS_PRINT_CHAR ;a=char
 63+  0000 ~                ld c,#02
 64+  0000 ~                rst #20
 65+  0000                  endm
 66+  0000
 67+  0000              ;заполнение строки одним символом
 68+  0000                  macro OS_FILL_LINE ;; H - line ; A - char
 69+  0000 ~                ld c,#03
 70+  0000 ~                rst #20
 71+  0000                  endm
 72+  0000
 73+  0000              ;покрасить строку цветом
 74+  0000                  macro OS_PAINT_LINE ;a - line, b - color
 75+  0000 ~                ld c,#04
 76+  0000 ~                rst #20
 77+  0000                  endm
 78+  0000
 79+  0000
 80+  0000                  ; macro OS_ ;
 81+  0000                  ; ld c,#05
 82+  0000                  ; rst #20
 83+  0000                  ; endm
 84+  0000
 85+  0000              ;установить цвет текста в консоли;
 86+  0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
 87+  0000 ~                ld c,#06
 88+  0000 ~                rst #20
 89+  0000                  endm
 90+  0000
 91+  0000                  ; macro OS_ ;
 92+  0000                  ; ld c,#07
 93+  0000                  ; rst #20
 94+  0000                  ; endm
 95+  0000
 96+  0000                  ; macro OS_ ;
 97+  0000                  ; ld c,#08
 98+  0000                  ; rst #20
 99+  0000                  ; endm
100+  0000
101+  0000
102+  0000
103+  0000              ;печать в консоль до кода 0
104+  0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
105+  0000 ~                ld c,#09
106+  0000 ~                rst #20
107+  0000                  endm
108+  0000
109+  0000
110+  0000              ;прочитать байт из порта uart
111+  0000              ;вх:
112+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
113+  0000              ;вых: A - считанный байт
114+  0000                  macro OS_UART_READ
115+  0000 ~                ld c,#0a
116+  0000 ~                rst #20
117+  0000                  endm
118+  0000
119+  0000              ;записать байт в порт uart
120+  0000              ;вх: A -байт
121+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
122+  0000                  macro OS_UART_WRITE
123+  0000 ~                ld c,#0b
124+  0000 ~                rst #20
125+  0000                  endm
126+  0000
127+  0000              ;закрыть соединение ESP
128+  0000              ;вх:
129+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
130+  0000                  macro OS_ESP_CLOSE
131+  0000 ~                ld c,#0c
132+  0000 ~                rst #20
133+  0000                  endm
134+  0000
135+  0000              ;установить соединение ESP (CIPSTART);
136+  0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
137+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
138+  0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
139+  0000                  macro OS_ESP_OPEN
140+  0000 ~                ld c,#0d
141+  0000 ~                rst #20
142+  0000                  endm
143+  0000
144+  0000              ;послать запрос ESP (CIPSEND);
145+  0000              ;вх: hl - адрес данных, de - длина данных
146+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
147+  0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
148+  0000                  macro OS_ESP_SEND
149+  0000 ~                ld c,#0e
150+  0000 ~                rst #20
151+  0000                  endm
152+  0000
153+  0000              ;получить пакет ESP (+IPD);
154+  0000              ;вх: hl - адрес для данных
155+  0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
156+  0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
157+  0000                  macro OS_ESP_GET
158+  0000 ~                ld c,#0f
159+  0000 ~                rst #20
160+  0000                  endm
161+  0000
162+  0000              ;ввод с консоли ----------------------
163+  0000
164+  0000              ;получить код нажатой клавиши
165+  0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
166+  0000 ~                ld c,#10
167+  0000 ~                rst #20
168+  0000                  endm
169+  0000
170+  0000
171+  0000              ;процессы ----------------------------
172+  0000
173+  0000              ;запустить процесс
174+  0000              ;вх: hl - имя файла (заканчивается на 0)
175+  0000                  macro OS_PROC_RUN ;
176+  0000 ~                ld c,#11
177+  0000 ~                rst #20
178+  0000                  endm
179+  0000
180+  0000              ;установить фокус
181+  0000              ;вх: a - id процесса
182+  0000                  macro OS_PROC_SET_FOCUS ;
183+  0000 ~                ld c,#12
184+  0000 ~                rst #20
185+  0000                  endm
186+  0000
187+  0000              ;закрыть процесс
188+  0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
189+  0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
190+  0000                  macro OS_PROC_CLOSE ;
191+  0000 ~                ld c,#13
192+  0000 ~                rst #20
193+  0000                  endm
194+  0000
195+  0000
196+  0000              ;прерывания --------------------------
197+  0000
198+  0000              ;установка адреса обработчика прерываний процесса;
199+  0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
200+  0000                  ; ld c,#14
201+  0000                  ; rst #20
202+  0000                  ; endm
203+  0000
204+  0000
205+  0000              ;плеер AY ----------------------------
206+  0000
207+  0000              ;инициализация плеера AY;
208+  0000                  macro OS_VTPL_INIT ;(HL - address music)
209+  0000 ~                ld c,#15
210+  0000 ~                rst #20
211+  0000                  endm
212+  0000
213+  0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
214+  0000                  macro OS_VTPL_PLAY ;()
215+  0000 ~                ld c,#16
216+  0000 ~                rst #20
217+  0000                  endm
218+  0000
219+  0000              ;заглушить плеер AY;
220+  0000                  macro OS_VTPL_MUTE ;()
221+  0000 ~                ld c,#17
222+  0000 ~                rst #20
223+  0000                  endm
224+  0000
225+  0000              ;получить значение переменной плеера;
226+  0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
227+  0000 ~                ld c,#18
228+  0000 ~                rst #20
229+  0000                  endm
230+  0000
231+  0000
232+  0000              ;прочие ------------------------------
233+  0000
234+  0000
235+  0000              ;скопировать данные из страницы в страницу
236+  0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
237+  0000                  macro OS_RAM_COPY
238+  0000 ~                ld c,#19
239+  0000 ~                rst #20
240+  0000                  endm
241+  0000
242+  0000              ;получить дополнительную страницу памяти;
243+  0000                  macro OS_GET_PAGE ;(out A - number page)
244+  0000 ~                ld c,#1a
245+  0000 ~                rst #20
246+  0000                  endm
247+  0000
248+  0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
249+  0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
250+  0000 ~                ld c,#1b
251+  0000 ~                rst #20
252+  0000                  endm
253+  0000
254+  0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
255+  0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
256+  0000 ~                ld c,#1c
257+  0000 ~                rst #20
258+  0000                  endm
259+  0000
260+  0000              ;включить экран N;
261+  0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
262+  0000              ;переключать может только приложение в фокусе
263+  0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
264+  0000              ;при переключении процессов сохраняется только экран #39
265+  0000                  macro OS_SET_SCREEN ;
266+  0000 ~                ld c,#1d
267+  0000 ~                rst #20
268+  0000                  endm
269+  0000
270+  0000
271+  0000              ;получить номера страниц процесса;
272+  0000              ;вх:
273+  0000              ;вых: b, c - страницы в слотах 2, 3
274+  0000                  macro OS_GET_MAIN_PAGES ;
275+  0000 ~                ld c,#1e
276+  0000 ~                rst #20
277+  0000                  endm
278+  0000
279+  0000              ;получить значение системного таймера
280+  0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
281+  0000 ~                ld c,#1F
282+  0000 ~                rst #20
283+  0000                  endm
284+  0000
285+  0000
286+  0000
287+  0000                  ; macro OS_ ;
288+  0000                  ; ld c,#20
289+  0000                  ; rst #20
290+  0000                  ; endm
291+  0000
292+  0000
293+  0000              ;дисковые операции -------------------
294+  0000
295+  0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
296+  0000
297+  0000              ; fcbFAT (из руководства к монитору)
298+  0000              ; формат fcb для работы с FAT
299+  0000
300+  0000              ; +#00 8 имя файла
301+  0000              ; +#08 3 расширение файла
302+  0000              ; +#0B 1 атрибуты файла
303+  0000              ; +#0C 4 номер первого кластера файла/каталога
304+  0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
305+  0000              ; +#14 4 размер файла/каталога в байтах
306+  0000              ; +#18 4 указатель в файле
307+  0000              ; +#1C 1 для внутренних нужд
308+  0000              ; +#1D 1 для внутренних нужд
309+  0000              ; +#1E 1 резерв
310+  0000              ; +#1F 1 номер винчестера и раздела на нем
311+  0000              	; 1-0,nn номер раздела
312+  0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
313+  0000              	    ; значение %11 недопустимо
314+  0000
315+  0000              ;открыть файл для чтения или записи
316+  0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
317+  0000 ~                ld c,#21
318+  0000 ~                rst #20
319+  0000                  endm
320+  0000
321+  0000              ;создать файл
322+  0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
323+  0000 ~                ld c,#22
324+  0000 ~                rst #20
325+  0000                  endm
326+  0000
327+  0000              ;прочитать из файла
328+  0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
329+  0000 ~                ld c,#23
330+  0000 ~                rst #20
331+  0000                  endm
332+  0000
333+  0000              ;записать в файл
334+  0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
335+  0000 ~                ld c,#24
336+  0000 ~                rst #20
337+  0000                  endm
338+  0000
339+  0000              ;закрыть файл
340+  0000                  macro OS_FILE_CLOSE ;A - id file
341+  0000 ~                ld c,#25
342+  0000 ~                rst #20
343+  0000                  endm
344+  0000
345+  0000              ;чтение секторов текущего каталога
346+  0000              ; вх:
347+  0000                   ; hl - буфер для чтения
348+  0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
349+  0000                   ; b - максимальное количество секторов для чтения
350+  0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
351+  0000                     ; a=errRWnum
352+  0000                     ; a=errInvalidPart
353+  0000                     ; a=errFileEmpty
354+  0000                   ; cy=0, a=errEoF - каталог закончился
355+  0000                     ; hl - следующий адрес в буфере
356+  0000                     ; de - номер первого непрочитанного сектора
357+  0000                     ; b - не прочитано секторов
358+  0000                   ; cy=0 - считано успешно
359+  0000                     ; hl - следующий адрес в буфере
360+  0000                     ; de - номер первого непрочитанного сектора
361+  0000                     ; b=#00
362+  0000                  macro OS_DIR_READ ;
363+  0000 ~                ld c,#26
364+  0000 ~                rst #20
365+  0000                  endm
366+  0000
367+  0000              ;вход в каталог/выход в родительский каталог
368+  0000              	; Если путь не указан производится только настройка переменных драйвера,
369+  0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
370+  0000              	; Если пусть указан, в конец пути добавится название каталога (если это
371+  0000              	; переход в родительский, последнее имя в пути удалится).
372+  0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
373+  0000              	; добавится имя файла
374+  0000              ; вх:
375+  0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
376+  0000                   ; de - адрес дескриптора директории/файла
377+  0000              ; вых: a - если путь был указан, новая длина пути
378+  0000                  macro OS_DIR_OPEN ;
379+  0000 ~                ld c,#27
380+  0000 ~                rst #20
381+  0000                  endm
382+  0000
383+  0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
384+  0000              ;проверки на допустимость значений не производится
385+  0000              ;вх: CY = 1 - установка; CY = 0 - чтение
386+  0000              ;вх: A - id файла
387+  0000              ;вх: de, hl - значения старшие быйты, младшие
388+  0000              ;вых: de, hl - значения старшие быйты, младшие
389+  0000                  macro OS_FILE_POSITION ;
390+  0000 ~                ld c,#28
391+  0000 ~                rst #20
392+  0000                  endm
393+  0000
394+  0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
395+  0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
396+  0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
397+  0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
398+  0000                  macro OS_FIND_PATH ;
399+  0000 ~                ld c,#29
400+  0000 ~                rst #20
401+  0000                  endm
402+  0000
403+  0000
# file closed: ../os_defs.asm
  4   0000              	org PROGSTART
  5   8000
  6   8000              start_nc
  7   8000 21 AE 89     	ld hl,msg_title_nc ;имя приложения
  8   8003              	OS_PRINTZ ;печать
  8   8003 0E 09       >    ld c,#09
  8   8005 E7          >    rst #20
  9   8006
 10   8006
 11   8006              	;узнать свои страницы
 12   8006              	OS_GET_MAIN_PAGES
 12   8006 0E 1E       >    ld c,#1e
 12   8008 E7          >    rst #20
 13   8009 38 09        	jr c,get_page_error
 14   800B
 15   800B ED 43 F2 88  	ld (page_main),bc
 16   800F
 17   800F
 18   800F              	OS_GET_PAGE ;получить лишнюю страницу
 18   800F 0E 1A       >    ld c,#1a
 18   8011 E7          >    rst #20
 19   8012 30 0C        	jr nc,get_page_ok
 20   8014              get_page_error
 21   8014 21 9B 89     	ld hl,msg_mem_err ;нет памяти
 22   8017              	OS_PRINTZ ;печать
 22   8017 0E 09       >    ld c,#09
 22   8019 E7          >    rst #20
 23   801A
 24   801A CD 93 80     	call delay
 25   801D C3 8D 81     	jp exit
 26   8020
 27   8020              get_page_ok
 28   8020 32 F1 88     	ld (page_ext01),a ;запомнить
 29   8023
 30   8023
 31   8023
 32   8023              start_nc_warm ;тёплый старт
 33   8023
 34   8023              	;очистка буфера
 35   8023 CD 99 80     	call clear_buf
 36   8026
 37   8026              	;загрузка каталога
 38   8026 21 00 C0     	ld hl,buffer_cat ;куда
 39   8029 11 00 00     	ld de,0 ;начиная с 0 сектора
 40   802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
 41   802E              	OS_DIR_READ
 41   802E 0E 26       >    ld c,#26
 41   8030 E7          >    rst #20
 42   8031
 43   8031 21 00 00     	ld hl,0 ;обнулить переменные
 44   8034 22 ED 88     	ld (file_r_num_cur),hl
 45   8037 22 CF 86     	ld (file_r_all),hl
 46   803A 22 D1 86     	ld (file_r_cur_focus),hl
 47   803D
 48   803D CD 3E 82     	call sort_dir
 49   8040
 50   8040 3E 0F        	ld a,color_backgr
 51   8042 06 0C        	ld b,#c
 52   8044              	OS_SET_COLOR
 52   8044 0E 06       >    ld c,#06
 52   8046 E7          >    rst #20
 53   8047
 54   8047 CD 9C 83     	call print_rect_r ;рамка
 55   804A CD A5 81     	call print_panel_r
 56   804D CD D1 83     	call print_menu_main
 57   8050
 58   8050 11 00 01     	ld de,#0100
 59   8053              	OS_SET_XY
 59   8053 0E 01       >    ld c,#01
 59   8055 E7          >    rst #20
 60   8056
 61   8056
 62   8056
 63   8056              nc_wait
 64   8056              	OS_WAIT ;ждать прерывание
 64   8056 DF          >	rst #18
 65   8057
 66   8057              	OS_GET_CHAR ;клавиша
 66   8057 0E 10       >    ld c,#10
 66   8059 E7          >    rst #20
 67   805A 32 EF 88     	ld (key_pressed),a ;запомнить
 68   805D FE 0D        	cp 13
 69   805F CA B0 80     	jp z,key_enter ;
 70   8062 FE 0A        	cp 10 ;вниз
 71   8064 CC F9 80     	call z,key_down
 72   8067 FE 0B        	cp 11 ;вверх
 73   8069 CC 36 81     	call z,key_up
 74   806C FE 09        	cp 09 ;вправо
 75   806E CC 7B 81     	call z,key_right
 76   8071 FE 08        	cp 08 ;влево
 77   8073 CC 69 81     	call z,key_left
 78   8076 FE 32        	cp "2" ;переключение сортировки
 79   8078 CA 49 83     	jp z,sort_toggle
 80   807B FE 33        	cp "3" ;просмотр файла
 81   807D CA F1 83     	jp z,view_file
 82   8080 FE 18        	cp 24 ;break
 83   8082 CA 8D 81     	jp z,exit
 84   8085
 85   8085
 86   8085 3A F4 88     	ld a,(print_panel_r_flag)
 87   8088 B7           	or a
 88   8089 C4 A5 81     	call nz,print_panel_r ;обновить каталог
 89   808C AF           	xor a
 90   808D 32 F4 88     	ld (print_panel_r_flag),a
 91   8090
 92   8090 C3 56 80     	jp nc_wait ;на цикл ожидания
 93   8093
 94   8093
 95   8093              delay ;задержка
 96   8093 06 96        	ld b,50*3 ;
 97   8095              delay1
 98   8095              	OS_WAIT
 98   8095 DF          >	rst #18
 99   8096 10 FD        	djnz delay1
100   8098 C9           	ret
101   8099
102   8099
103   8099              clear_buf
104   8099 21 00 C0     	ld hl,buffer_cat
105   809C 11 01 C0     	ld de,buffer_cat+1
106   809F 01 FF 3F     	ld bc,#4000-1
107   80A2 36 00        	ld (hl),0
108   80A4 ED B0        	ldir
109   80A6 C9           	ret
110   80A7
111   80A7
112   80A7
113   80A7
114   80A7              release_key ;ждать отпускания клавиши
115   80A7              	OS_WAIT
115   80A7 DF          >	rst #18
116   80A8              	OS_GET_CHAR
116   80A8 0E 10       >    ld c,#10
116   80AA E7          >    rst #20
117   80AB FE FF        	cp 255
118   80AD 20 F8        	jr nz,release_key
119   80AF C9           	ret
120   80B0
121   80B0
122   80B0              key_enter
123   80B0              	;нажата Enter
124   80B0 2A CF 86     	ld hl,(file_r_all)
125   80B3 7D           	ld a,l
126   80B4 B4           	or h
127   80B5 CA DC 80     	jp z,key_enter_ex ;защита
128   80B8 2A ED 88     	ld hl,(file_r_num_cur)
129   80BB CD EC 80     	call calc_deskr
130   80BE DD 7E 0B     	ld a,(ix+#0b)
131   80C1 FE 10        	cp #10 ;признак каталога
132   80C3 28 1A        	jr z,key_enter_dir
133   80C5
134   80C5              	;проверка расширения ;APG
135   80C5 CD 91 81     	call check_apg
136   80C8 C2 DC 80     	jp nz,key_enter_ex
137   80CB              	;тут запуск приложения
138   80CB CD 67 83     	call format_name
139   80CE
140   80CE 21 D3 86     	ld hl,file_name_cur		;строка с именем
141   80D1              	OS_PROC_RUN ;запустить прогу
141   80D1 0E 11       >    ld c,#11
141   80D3 E7          >    rst #20
142   80D4              	;обработка ошибки
143   80D4 38 06        	jr c,key_enter_ex
144   80D6
145   80D6 DD 7E 00     	ld a,(ix)
146   80D9              	OS_PROC_SET_FOCUS ;на передний план
146   80D9 0E 12       >    ld c,#12
146   80DB E7          >    rst #20
147   80DC
148   80DC              key_enter_ex
149   80DC C3 56 80     	jp nc_wait
150   80DF
151   80DF              key_enter_dir
152   80DF              	;тут открытие папки
153   80DF
154   80DF              	;call format_name_dir
155   80DF EB           	ex de,hl ;de - дескриптор для открытия
156   80E0 21 D3 87     	ld hl,dir_name_cur
157   80E3              	OS_DIR_OPEN
157   80E3 0E 27       >    ld c,#27
157   80E5 E7          >    rst #20
158   80E6 38 F4        	jr c,key_enter_ex ;если ошибка, ничего не делаем
159   80E8
160   80E8 E1           	pop hl ;отменить возврат
161   80E9 C3 23 80     	jp start_nc_warm ;перезагрузить папку
162   80EC
163   80EC
164   80EC              ; format_name_dir
165   80EC              	; push hl
166   80EC              	; ld hl,file_name_cur
167   80EC              	; ld de,file_name_cur+1 ;почистить
168   80EC              	; ld bc,256-1
169   80EC              	; ld (hl),0
170   80EC              	; ldir
171   80EC
172   80EC              	; pop hl
173   80EC
174   80EC              	; ld de,file_name_cur ;куда
175   80EC              	; ld bc,#08ff
176   80EC              ; format_name_dir_cl
177   80EC              	; ld a,(hl)
178   80EC              	; cp " "+1
179   80EC              	; jr c,format_name_dir_skip
180   80EC              	; ldi
181   80EC              	; djnz format_name_dir_cl
182   80EC              ; format_name_dir_skip
183   80EC              	; ld a,'/'
184   80EC              	; ld (de),a
185   80EC              	; ret
186   80EC
187   80EC               ;вычислить дескриптор текущего элемента справа
188   80EC              calc_deskr
189   80EC 29           	add hl,hl ;*2
190   80ED 01 CE 89     	ld bc,cat_index
191   80F0 09           	add hl,bc
192   80F1 5E           	ld e,(hl)
193   80F2 23           	inc hl
194   80F3 56           	ld d,(hl)
195   80F4 EB           	ex de,hl ;hl - адрес элемента
196   80F5 E5           	push hl
197   80F6 DD E1        	pop ix ;ix- адрес элемента
198   80F8 C9           	ret
199   80F9
200   80F9
201   80F9
202   80F9
203   80F9              key_down
204   80F9 2A CF 86     	ld hl,(file_r_all)
205   80FC 7D           	ld a,l
206   80FD B4           	or h
207   80FE CA 32 81     	jp z,key_down_ex ;защита
208   8101
209   8101 ED 4B ED 88  	ld bc,(file_r_num_cur)
210   8105 03           	inc bc
211   8106 2A CF 86     	ld hl,(file_r_all)
212   8109              	;если не больше чем всего
213   8109 A7           	and a
214   810A ED 42        	sbc hl,bc
215   810C 38 24        	jr c,key_down_skip
216   810E 28 22        	jr z,key_down_skip
217   8110              	;прибавить
218   8110 ED 43 ED 88  	ld (file_r_num_cur),bc
219   8114
220   8114              	;теперь передвинуть фокус, если надо
221   8114 2A D1 86     	ld hl,(file_r_cur_focus)
222   8117 01 16 00     	ld bc,panel_hight
223   811A 09           	add hl,bc ;прибавить количество видимых
224   811B ED 4B ED 88  	ld bc,(file_r_num_cur)
225   811F A7           	and a
226   8120 ED 42        	sbc hl,bc ;вычесть положение курсора
227   8122 28 02        	jr z,key_down_change_focus_yes
228   8124 30 07        	jr nc,key_down_change_focus_no
229   8126              key_down_change_focus_yes
230   8126              	;передвинуть фокус
231   8126 2A D1 86     	ld hl,(file_r_cur_focus)
232   8129 23           	inc hl
233   812A 22 D1 86     	ld (file_r_cur_focus),hl
234   812D
235   812D              key_down_change_focus_no
236   812D 3E 01        	ld a,1
237   812F 32 F4 88     	ld (print_panel_r_flag),a
238   8132              	;call print_panel_r ;обновить каталог
239   8132              key_down_skip
240   8132
241   8132              key_down_ex
242   8132 3A EF 88     	ld a,(key_pressed)
243   8135 C9           	ret
244   8136
245   8136
246   8136
247   8136              key_up ;вверх
248   8136 2A CF 86     	ld hl,(file_r_all)
249   8139 7D           	ld a,l
250   813A B4           	or h
251   813B CA 65 81     	jp z,key_up_ex ;защита
252   813E
253   813E 2A ED 88     	ld hl,(file_r_num_cur)
254   8141 7D           	ld a,l
255   8142 B4           	or h
256   8143 28 20        	jr z,key_up_skip
257   8145 2B           	dec hl
258   8146 22 ED 88     	ld (file_r_num_cur),hl
259   8149
260   8149              	;теперь передвинуть фокус, если надо
261   8149 2A ED 88     	ld hl,(file_r_num_cur)
262   814C              	; ld bc,panel_hight
263   814C              	; add hl,bc ;прибавить количество видимых
264   814C ED 4B D1 86  	ld bc,(file_r_cur_focus)
265   8150 A7           	and a
266   8151 ED 42        	sbc hl,bc ;вычесть положение курсора
267   8153              	;jr z,key_up_change_foces_yes
268   8153 30 0B        	jr nc,key_up_change_foces_no
269   8155              key_up_change_foces_yes
270   8155              	;передвинуть фокус
271   8155 2A D1 86     	ld hl,(file_r_cur_focus)
272   8158 7C           	ld a,h
273   8159 B5           	or l
274   815A 28 04        	jr z,key_up_change_foces_no ;защита
275   815C 2B           	dec hl
276   815D 22 D1 86     	ld (file_r_cur_focus),hl
277   8160
278   8160              key_up_change_foces_no
279   8160
280   8160 3E 01        	ld a,1
281   8162 32 F4 88     	ld (print_panel_r_flag),a
282   8165              	;call print_panel_r ;обновить каталог
283   8165              key_up_skip
284   8165
285   8165              key_up_ex
286   8165 3A EF 88     	ld a,(key_pressed)
287   8168 C9           	ret
288   8169
289   8169
290   8169              key_left ;на страницу назад
291   8169 06 15        	ld b,panel_hight-1
292   816B              key_left_cl
293   816B C5           	push bc
294   816C CD 36 81     	call key_up
295   816F C1           	pop bc
296   8170 10 F9        	djnz key_left_cl
297   8172 3E 01        	ld a,1
298   8174 32 F4 88     	ld (print_panel_r_flag),a
299   8177 3A EF 88     	ld a,(key_pressed)
300   817A C9           	ret
301   817B
302   817B
303   817B
304   817B              key_right ;на страницу вперёд
305   817B 06 15        	ld b,panel_hight-1
306   817D              key_right_cl
307   817D C5           	push bc
308   817E CD F9 80     	call key_down
309   8181 C1           	pop bc
310   8182 10 F9        	djnz key_right_cl
311   8184 3E 01        	ld a,1
312   8186 32 F4 88     	ld (print_panel_r_flag),a
313   8189 3A EF 88     	ld a,(key_pressed)
314   818C C9           	ret
315   818D
316   818D
317   818D
318   818D              exit ;выход в DOS
319   818D AF           	xor a
320   818E              	OS_PROC_CLOSE
320   818E 0E 13       >    ld c,#13
320   8190 E7          >    rst #20
321   8191
322   8191
323   8191
324   8191              check_apg ;проверка на расширение APG
325   8191 DD 7E 08     	ld a,(ix+8)
326   8194 FE 41        	cp "A"
327   8196 C0           	ret nz
328   8197 DD 7E 09     	ld a,(ix+9)
329   819A FE 50        	cp "P"
330   819C C0           	ret nz
331   819D DD 7E 0A     	ld a,(ix+10)
332   81A0 FE 47        	cp "G"
333   81A2 C0           	ret nz
334   81A3 AF           	xor a ;равен
335   81A4 C9           	ret
336   81A5
337   81A5
338   81A5
339   81A5              print_panel_r ;печать правой панели
340   81A5              	;ld ix,buffer_cat
341   81A5 FD 2A CF 86  	ld iy,(file_r_all) ;всего файлов
342   81A9 FD 7D        	ld a,iyl
343   81AB FD B4        	or iyh
344   81AD C8           	ret z ;защита если 0
345   81AE 11 29 01     	ld de,panel_r_xy ;координаты yx
346   81B1 06 16        	ld b,panel_hight ;высота панели
347   81B3 FD 2A D1 86  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
348   81B7              print_panel_r_cl ;цикл
349   81B7 C5           	push bc
350   81B8 D5           	push de ;xy
351   81B9              	OS_SET_XY
351   81B9 0E 01       >    ld c,#01
351   81BB E7          >    rst #20
352   81BC
353   81BC              	;получить адрес элемента
354   81BC FD E5        	push iy
355   81BE E1           	pop hl
356   81BF CD EC 80     	call calc_deskr
357   81C2
358   81C2 CD DD 81     	call print_file_info ;напечатать строку
359   81C5              print_panel_r_skip
360   81C5 D1           	pop de
361   81C6 14           	inc d ;y++
362   81C7 FD 23        	inc iy ;текущий файл
363   81C9              	;проверка на конец каталога
364   81C9 2A CF 86     	ld hl,(file_r_all)
365   81CC FD E5        	push iy
366   81CE C1           	pop bc
367   81CF A7           	and a
368   81D0 ED 42        	sbc hl,bc
369   81D2 C1           	pop bc
370   81D3 38 07        	jr c,print_panel_r_ex2
371   81D5 28 05        	jr z,print_panel_r_ex2
372   81D7 10 DE        	djnz print_panel_r_cl
373   81D9 C9           	ret
374   81DA              print_panel_r_ex
375   81DA D1           	pop de
376   81DB C1           	pop bc
377   81DC              print_panel_r_ex2
378   81DC              	;тут, возможно, надо допечатать пустые строки
379   81DC C9           	ret
380   81DD
381   81DD
382   81DD
383   81DD              print_file_info ;печать строчки о файле
384   81DD 11 D3 88     	ld de,file_info_string ;скопировать
385   81E0 01 08 00     	ld bc,8 ;file_info_lenght
386   81E3 ED B0        	ldir
387   81E5 3E 20        	ld a,' '
388   81E7 12           	ld (de),a
389   81E8 13           	inc de
390   81E9 01 03 00     	ld bc,3
391   81EC ED B0        	ldir
392   81EE
393   81EE CD FD 81     	call get_color_item
394   81F1
395   81F1 06 0C        	ld b,#c
396   81F3              	OS_SET_COLOR
396   81F3 0E 06       >    ld c,#06
396   81F5 E7          >    rst #20
397   81F6 21 D3 88     	ld hl,file_info_string
398   81F9              	OS_PRINTZ
398   81F9 0E 09       >    ld c,#09
398   81FB E7          >    rst #20
399   81FC C9           	ret
400   81FD
401   81FD
402   81FD
403   81FD              get_color_item ;получить цвет элемента
404   81FD              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
405   81FD              ;вых: A - цвет
406   81FD ED 4B ED 88  	ld bc,(file_r_num_cur) ;позиция курсора справа
407   8201 FD E5        	push iy
408   8203 E1           	pop hl
409   8204 A7           	and a
410   8205 ED 42        	sbc hl,bc ;сравнить
411   8207 28 11        	jr z,get_color_item_no_cursor
412   8209              	;цвета курсора
413   8209 3E 0E        	ld a,color_dir ;простая
414   820B 32 31 82     	ld (get_color_item_dir+1),a
415   820E 3E 0C        	ld a,color_apg ;простая
416   8210 32 39 82     	ld (get_color_item_apg+1),a
417   8213 3E 0F        	ld a,color_backgr ;простая
418   8215 32 3C 82     	ld (get_color_item_backgr+1),a
419   8218 18 0F        	jr get_color_item_set
420   821A
421   821A              get_color_item_no_cursor
422   821A              	;цвета обычные
423   821A 3E 28        	ld a,color_dir_hi ;под курсором
424   821C 32 31 82     	ld (get_color_item_dir+1),a
425   821F 3E 28        	ld a,color_apg_hi ;под курсором
426   8221 32 39 82     	ld (get_color_item_apg+1),a
427   8224 3E 28        	ld a,color_backgr_hi ;под курсором
428   8226 32 3C 82     	ld (get_color_item_backgr+1),a
429   8229
430   8229              get_color_item_set
431   8229              	;задать цвет
432   8229 DD 7E 0B     	ld a,(ix+#0b)
433   822C FE 10        	cp #10 ;признак каталога
434   822E 20 03        	jr nz,get_color_item_no_dir
435   8230              	;если папка
436   8230              get_color_item_dir
437   8230 3E 00        	ld a,0
438   8232 C9           	ret
439   8233
440   8233              get_color_item_no_dir
441   8233 CD 91 81     	call check_apg ;расширение apg
442   8236 20 03        	jr nz,get_color_item_no_apg
443   8238              	;если приложение
444   8238              get_color_item_apg
445   8238 3E 00        	ld a,0
446   823A C9           	ret
447   823B
448   823B              get_color_item_no_apg
449   823B              	;если обычный файл
450   823B              get_color_item_backgr
451   823B 3E 00        	ld a,0
452   823D C9           	ret
453   823E
454   823E
455   823E
456   823E              ; format_dir ;подготовить каталог, убрать лишнее
457   823E              	; ; ld a,2
458   823E              	; ; out (254),a
459   823E              	; ld iy,0 ;счётчик файлов
460   823E              	; ;найти конец каталога
461   823E              	; ld hl,buffer_cat
462   823E              	; ld a,(hl)
463   823E              	; or a
464   823E              	; ret z ;защита
465   823E              	; ld bc,32
466   823E              ; format_dir_prep_cl
467   823E              	; ld a,(hl)
468   823E              	; or a
469   823E              	; jr z,format_dir_prep_ex
470   823E              	; add hl,bc
471   823E              	; ld a,h
472   823E              	; or a ;если вышли за границу
473   823E              	; jr z,format_dir_prep_ex
474   823E              	; jr format_dir_prep_cl
475   823E              ; format_dir_prep_ex
476   823E              	; ld bc,32
477   823E              	; and a
478   823E              	; sbc hl,bc
479   823E              	; ld (format_dir_top),hl ;конец каталога
480   823E
481   823E
482   823E
483   823E              	; ld ix,buffer_cat
484   823E              	; ;ld b,panel_hight ;высота панели
485   823E              ; format_dir_cl ;цикл
486   823E              	; ld a,(ix)
487   823E              	; or a ;конец каталога
488   823E              	; jr z,format_dir_ex
489   823E              	; cp #e5 ;удалённый
490   823E              	; jr z,format_dir_skip
491   823E              	; cp #05 ;удалённый
492   823E              	; jr z,format_dir_skip
493   823E              	; ld a,(ix+#0b)
494   823E              	; cp #0f ;длинный
495   823E              	; jr z,format_dir_skip
496   823E
497   823E              	; ;проверка на папку "." (этот же каталог)
498   823E              	; ld a,(ix+#00)
499   823E              	; cp "." ;
500   823E              	; jr nz,format_dir_add
501   823E              	; ld a,(ix+#01)
502   823E              	; cp " " ;
503   823E              	; jr z,format_dir_skip
504   823E
505   823E
506   823E              ; format_dir_add
507   823E              	; inc iy ;++
508   823E              	; ld bc,32 ;на другой элемент каталога
509   823E              	; add ix,bc
510   823E              	; ld a,ixh
511   823E              	; or a ;если вышли за границу
512   823E              	; jr z,format_dir_ex
513   823E              	; jr format_dir_cl
514   823E              ; format_dir_skip
515   823E              	; ;сдвинуть элементы вниз
516   823E              	; push ix
517   823E              	; push ix
518   823E              	; pop hl
519   823E              	; pop de ;куда
520   823E              	; ld hl,(format_dir_top) ;0-32
521   823E              	; and a
522   823E              	; sbc hl,de
523   823E              	; ld b,h
524   823E              	; ld c,l ;длина
525   823E              	; push bc
526   823E
527   823E              	; push ix
528   823E              	; pop hl ;откуда
529   823E              	; ld bc,32 ;на другой элемент каталога
530   823E              	; add hl,bc ;откуда
531   823E
532   823E              	; pop bc
533   823E              	; ldir
534   823E
535   823E              	; xor a
536   823E              	; ld (de),a ;очистить ненужный элемент
537   823E
538   823E              	; jr format_dir_cl
539   823E
540   823E              ; format_dir_ex
541   823E              	; ld (file_r_all),iy
542   823E              	; ;здесь почистить остаток каталога
543   823E              	; ; ld a,0
544   823E              	; ; out (254),a
545   823E              	; ret
546   823E              ; format_dir_top	dw 0 ;временно конец гаталога
547   823E
548   823E
549   823E
550   823E
551   823E
552   823E              sort_dir ;сортировка каталога с помощью построения индекса
553   823E DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
554   8242 DD 7E 00     	ld a,(ix)
555   8245 B7           	or a
556   8246 C8           	ret z ;если пусто, выход
557   8247 FD 21 00 00  	ld iy,0 ;счётчик
558   824B 21 CE 89     	ld hl,cat_index ;таблица - индекс
559   824E
560   824E 3A 66 83     	ld a,(sort_enable_flag)
561   8251 B7           	or a
562   8252 CA 73 82     	jp z,sort_dir_no
563   8255
564   8255 AF           	xor a
565   8256 32 72 82     	ld (sort_item),a ;образец для сравнения
566   8259              sort_dir_cl
567   8259 CD F7 82     	call sort_dir_one ;один проход по папкам
568   825C 3A 72 82     	ld a,(sort_item)
569   825F 3C           	inc a ;следующий образец
570   8260 32 72 82     	ld (sort_item),a
571   8263 20 F4        	jr nz,sort_dir_cl
572   8265
573   8265              	; xor a
574   8265              	; ld (sort_item),a ;образец для сравнения
575   8265              sort_file_cl
576   8265 CD B3 82     	call sort_file_one ;один проход по файлам
577   8268 3A 72 82     	ld a,(sort_item)
578   826B 3C           	inc a ;следующий образец
579   826C 32 72 82     	ld (sort_item),a
580   826F 20 F4        	jr nz,sort_file_cl
581   8271
582   8271 C9           	ret
583   8272
584   8272 00           sort_item db 0; текущий образец
585   8273
586   8273
587   8273
588   8273              ;без сортировки
589   8273              sort_dir_no
590   8273 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
591   8277              sort_dir_no_cl ;цикл по каталогам
592   8277 DD 7E 00     	ld a,(ix)
593   827A B7           	or a ;конец каталога
594   827B 28 31        	jr z,sort_dir_no_ex
595   827D FE E5        	cp #e5 ;удалённый
596   827F 28 22        	jr z,sort_dir_no_skip
597   8281 FE 05        	cp #05 ;удалённый
598   8283 28 1E        	jr z,sort_dir_no_skip
599   8285 DD 7E 0B     	ld a,(ix+#0b)
600   8288 FE 0F        	cp #0f ;длинный
601   828A 28 17        	jr z,sort_dir_no_skip
602   828C
603   828C              	;проверка на папку "." (этот же каталог)
604   828C DD 7E 00     	ld a,(ix+#00)
605   828F FE 2E        	cp "." ;
606   8291 20 07        	jr nz,sort_dir_no_add
607   8293 DD 7E 01     	ld a,(ix+#01)
608   8296 FE 20        	cp " " ;
609   8298 28 09        	jr z,sort_dir_no_skip
610   829A
611   829A              sort_dir_no_add
612   829A FD 23        	inc iy ;++
613   829C              	;записать в таблицу (индекс)
614   829C DD E5        	push ix
615   829E C1           	pop bc
616   829F 71           	ld (hl),c
617   82A0 23           	inc hl
618   82A1 70           	ld (hl),b
619   82A2 23           	inc hl
620   82A3
621   82A3
622   82A3              sort_dir_no_skip
623   82A3 01 20 00     	ld bc,32
624   82A6 DD 09        	add ix,bc ;на следующий
625   82A8 DD 7C        	ld a,ixh ;проверка на конец буфера
626   82AA FE C0        	cp #c0
627   82AC 30 C9        	jr nc,sort_dir_no_cl
628   82AE
629   82AE              sort_dir_no_ex
630   82AE FD 22 CF 86  	ld (file_r_all),iy
631   82B2 C9           	ret
632   82B3
633   82B3
634   82B3              ;сортировка файлов
635   82B3              sort_file_one
636   82B3 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
637   82B7              sort_file_one_cl ;цикл по каталогам
638   82B7 DD 7E 00     	ld a,(ix)
639   82BA B7           	or a ;конец каталога
640   82BB 28 35        	jr z,sort_file_one_ex
641   82BD DD 7E 0B     	ld a,(ix+#0b)
642   82C0 FE 10        	cp #10 ;признак каталога
643   82C2 28 23        	jr z,sort_file_one_skip
644   82C4 DD 7E 00     	ld a,(ix)
645   82C7 FE E5        	cp #e5 ;удалённый
646   82C9 28 1C        	jr z,sort_file_one_skip
647   82CB FE 05        	cp #05 ;удалённый
648   82CD 28 18        	jr z,sort_file_one_skip
649   82CF DD 7E 0B     	ld a,(ix+#0b)
650   82D2 FE 0F        	cp #0f ;длинный
651   82D4 28 11        	jr z,sort_file_one_skip
652   82D6
653   82D6              	; ;проверка на папку "." (этот же каталог)
654   82D6              	; ld a,(ix+#00)
655   82D6              	; cp "." ;
656   82D6              	; jr nz,sort_file_one_add
657   82D6              	; ld a,(ix+#01)
658   82D6              	; cp " " ;
659   82D6              	; jr z,sort_file_one_skip
660   82D6
661   82D6
662   82D6              sort_file_one_add
663   82D6 3A 72 82     	ld a,(sort_item)
664   82D9 DD BE 00     	cp (ix+#00) ;первая буква имени
665   82DC 20 09        	jr nz,sort_file_one_skip ;пока не подошла
666   82DE
667   82DE FD 23        	inc iy ;++
668   82E0              	;записать в таблицу (индекс)
669   82E0 DD E5        	push ix
670   82E2 C1           	pop bc
671   82E3 71           	ld (hl),c
672   82E4 23           	inc hl
673   82E5 70           	ld (hl),b
674   82E6 23           	inc hl
675   82E7
676   82E7
677   82E7              sort_file_one_skip
678   82E7 01 20 00     	ld bc,32
679   82EA DD 09        	add ix,bc ;на следующий
680   82EC DD 7C        	ld a,ixh ;проверка на конец буфера
681   82EE FE C0        	cp #c0
682   82F0 30 C5        	jr nc,sort_file_one_cl
683   82F2
684   82F2              sort_file_one_ex
685   82F2 FD 22 CF 86  	ld (file_r_all),iy
686   82F6 C9           	ret
687   82F7
688   82F7
689   82F7
690   82F7
691   82F7
692   82F7              ;сортировка папок
693   82F7              sort_dir_one
694   82F7 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
695   82FB              sort_dir_one_cl ;цикл по каталогам
696   82FB DD 7E 00     	ld a,(ix)
697   82FE B7           	or a ;конец каталога
698   82FF 28 43        	jr z,sort_dir_one_ex
699   8301 DD 7E 0B     	ld a,(ix+#0b)
700   8304 FE 10        	cp #10 ;признак каталога
701   8306 20 31        	jr nz,sort_dir_one_skip
702   8308 DD 7E 00     	ld a,(ix)
703   830B FE E5        	cp #e5 ;удалённый
704   830D 28 2A        	jr z,sort_dir_one_skip
705   830F FE 05        	cp #05 ;удалённый
706   8311 28 26        	jr z,sort_dir_one_skip
707   8313 DD 7E 0B     	ld a,(ix+#0b)
708   8316 FE 0F        	cp #0f ;длинный
709   8318 28 1F        	jr z,sort_dir_one_skip
710   831A
711   831A              	;проверка на папку "." (этот же каталог)
712   831A DD 7E 00     	ld a,(ix+#00)
713   831D FE 2E        	cp "." ;
714   831F 20 07        	jr nz,sort_dir_one_add
715   8321 DD 7E 01     	ld a,(ix+#01)
716   8324 FE 20        	cp " " ;
717   8326 28 11        	jr z,sort_dir_one_skip
718   8328
719   8328              sort_dir_one_add
720   8328 3A 72 82     	ld a,(sort_item)
721   832B DD BE 00     	cp (ix+#00) ;первая буква имени
722   832E 20 09        	jr nz,sort_dir_one_skip ;пока не подошла
723   8330
724   8330 FD 23        	inc iy ;++
725   8332              	;записать в таблицу (индекс)
726   8332 DD E5        	push ix
727   8334 C1           	pop bc
728   8335 71           	ld (hl),c
729   8336 23           	inc hl
730   8337 70           	ld (hl),b
731   8338 23           	inc hl
732   8339
733   8339
734   8339              sort_dir_one_skip
735   8339 01 20 00     	ld bc,32
736   833C DD 09        	add ix,bc ;на следующий
737   833E DD 7C        	ld a,ixh ;проверка на конец буфера
738   8340 FE C0        	cp #c0
739   8342 30 B7        	jr nc,sort_dir_one_cl
740   8344
741   8344              sort_dir_one_ex
742   8344 FD 22 CF 86  	ld (file_r_all),iy
743   8348 C9           	ret
744   8349
745   8349
746   8349
747   8349
748   8349
749   8349
750   8349
751   8349              sort_toggle ;переключение сортировки
752   8349 3A 66 83     	ld a,(sort_enable_flag)
753   834C EE 01        	xor 1
754   834E 32 66 83     	ld (sort_enable_flag),a
755   8351 3E 4E        	ld a,"N" ;вкл
756   8353 20 02        	jr nz,sort_toggle1
757   8355 3E 66        	ld a,"f";выкл
758   8357              sort_toggle1
759   8357 32 76 89     	ld (msg_menu_main2+6),a
760   835A
761   835A CD 3E 82     	call sort_dir
762   835D CD D1 83     	call print_menu_main
763   8360 CD A5 81     	call print_panel_r
764   8363
765   8363 C3 56 80     	jp nc_wait
766   8366 00           sort_enable_flag db 0 ;флаг сортировки
767   8367
768   8367
769   8367
770   8367              format_name ;подогнать имя под стандарт filename.ext
771   8367              ;вх: HL - имя в каталоге
772   8367 E5           	push hl
773   8368 21 D3 86     	ld hl,file_name_cur
774   836B 11 D4 86     	ld de,file_name_cur+1 ;почистить
775   836E 01 FF 00     	ld bc,256-1
776   8371 36 00        	ld (hl),0
777   8373 ED B0        	ldir
778   8375
779   8375 E1           	pop hl
780   8376 E5           	push hl
781   8377
782   8377 11 D3 86     	ld de,file_name_cur ;куда
783   837A 01 FF 08     	ld bc,#08ff
784   837D              format_name_cl
785   837D 7E           	ld a,(hl)
786   837E FE 21        	cp " "+1
787   8380 38 04        	jr c,format_name_skip
788   8382 ED A0        	ldi
789   8384 10 F7        	djnz format_name_cl
790   8386              format_name_skip
791   8386 3E 2E        	ld a,"."
792   8388 12           	ld (de),a
793   8389
794   8389 13           	inc de
795   838A E1           	pop hl
796   838B 01 08 00     	ld bc,8 ;перейти на расширение
797   838E 09           	add hl,bc
798   838F
799   838F 01 FF 03     	ld bc,#03ff
800   8392              format_name_cl2
801   8392 7E           	ld a,(hl)
802   8393 FE 21        	cp " "+1
803   8395 38 04        	jr c,format_name_skip2
804   8397 ED A0        	ldi
805   8399 10 F7        	djnz format_name_cl2
806   839B              format_name_skip2
807   839B C9           	ret
808   839C
809   839C              print_rect_r ;печать рамки правой
810   839C 3E 0F        	ld a,color_backgr ;цвет
811   839E 06 0C        	ld b,#c
812   83A0              	OS_SET_COLOR
812   83A0 0E 06       >    ld c,#06
812   83A2 E7          >    rst #20
813   83A3 11 28 00     	ld de,#0028 ;xy
814   83A6              	OS_SET_XY
814   83A6 0E 01       >    ld c,#01
814   83A8 E7          >    rst #20
815   83A9 21 F5 88     	ld hl,rect_1
816   83AC              	OS_PRINTZ
816   83AC 0E 09       >    ld c,#09
816   83AE E7          >    rst #20
817   83AF
818   83AF 11 28 01     	ld de,#0128 ;xy
819   83B2 06 16        	ld b,24-2 ;цикл
820   83B4              print_rect_r_cl
821   83B4 C5           	push bc
822   83B5 D5           	push de
823   83B6              	OS_SET_XY
823   83B6 0E 01       >    ld c,#01
823   83B8 E7          >    rst #20
824   83B9 21 1E 89     	ld hl,rect_2
825   83BC              	OS_PRINTZ
825   83BC 0E 09       >    ld c,#09
825   83BE E7          >    rst #20
826   83BF D1           	pop de
827   83C0 14           	inc d
828   83C1 C1           	pop bc
829   83C2 10 F0        	djnz print_rect_r_cl
830   83C4
831   83C4
832   83C4 11 28 17     	ld de,#1728 ;xy
833   83C7              	OS_SET_XY
833   83C7 0E 01       >    ld c,#01
833   83C9 E7          >    rst #20
834   83CA 21 47 89     	ld hl,rect_3
835   83CD              	OS_PRINTZ
835   83CD 0E 09       >    ld c,#09
835   83CF E7          >    rst #20
836   83D0 C9           	ret
837   83D1
838   83D1              print_menu_main ;печать основного меню
839   83D1 3E 28        	ld a,color_backgr_hi ;цвет
840   83D3 06 0C        	ld b,#c
841   83D5              	OS_SET_COLOR
841   83D5 0E 06       >    ld c,#06
841   83D7 E7          >    rst #20
842   83D8 11 10 18     	ld de,#1800+2*8
843   83DB              	OS_SET_XY
843   83DB 0E 01       >    ld c,#01
843   83DD E7          >    rst #20
844   83DE 21 70 89     	ld hl,msg_menu_main2
845   83E1              	OS_PRINTZ
845   83E1 0E 09       >    ld c,#09
845   83E3 E7          >    rst #20
846   83E4 11 18 18     	ld de,#1800+3*8
847   83E7              	OS_SET_XY
847   83E7 0E 01       >    ld c,#01
847   83E9 E7          >    rst #20
848   83EA 21 78 89     	ld hl,msg_menu_main3
849   83ED              	OS_PRINTZ
849   83ED 0E 09       >    ld c,#09
849   83EF E7          >    rst #20
850   83F0 C9           	ret
851   83F1
852   83F1
853   83F1              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
  1+  83F1              view_file
  2+  83F1              	;просмотр файла как текста
  3+  83F1
  4+  83F1 2A CF 86     	ld hl,(file_r_all)
  5+  83F4 7D           	ld a,l
  6+  83F5 B4           	or h
  7+  83F6 CA C3 84     	jp z,view_file_ex ;защита
  8+  83F9 2A ED 88     	ld hl,(file_r_num_cur)
  9+  83FC CD EC 80     	call calc_deskr
 10+  83FF DD 7E 0B     	ld a,(ix+#0b)
 11+  8402 FE 10        	cp #10 ;признак каталога
 12+  8404 CA C3 84     	jp z,view_file_ex
 13+  8407
 14+  8407 CD 67 83     	call format_name ;обработать имя файла
 15+  840A
 16+  840A
 17+  840A
 18+  840A              	OS_CLS ;почистить экран
 18+  840A 0E 00       >    ld c,#00
 18+  840C E7          >    rst #20
 19+  840D
 20+  840D              	;обнулить переменные
 21+  840D AF           	xor a
 22+  840E 32 CC 86     	ld (view_file_load_all),a ;флаг что файл весь прочитан
 23+  8411              	;ld (view_file_bot_flag),a  ;
 24+  8411 21 FF FF     	ld hl,#ffff
 25+  8414 22 CD 86     	ld (view_file_end),hl ;конец файла тут
 26+  8417 23           	inc hl
 27+  8418 22 C4 86     	ld (view_move_right_val),hl
 28+  841B
 29+  841B C5           	push bc
 30+  841C CD 99 80     	call clear_buf
 31+  841F C1           	pop bc
 32+  8420
 33+  8420 21 D3 86     	ld hl,file_name_cur		;строка с именем
 34+  8423              	OS_FILE_OPEN
 34+  8423 0E 21       >    ld c,#21
 34+  8425 E7          >    rst #20
 35+  8426 30 0E        	jr nc,view_file_open_ok
 36+  8428              view_file_file_error
 37+  8428 21 7F 89     	ld hl,msg_file_error
 38+  842B              	OS_PRINTZ
 38+  842B 0E 09       >    ld c,#09
 38+  842D E7          >    rst #20
 39+  842E 06 64        	ld b,2*50
 40+  8430 CD 95 80     	call delay1
 41+  8433 C3 BD 84     	jp view_file_wait_ex
 42+  8436
 43+  8436              view_file_open_ok
 44+  8436 32 F0 88     	ld (file_id_cur_r),a
 45+  8439              	;проверка длины файла не больше #4000
 46+  8439 7A           	ld	a,d ;самые старшие байты длины
 47+  843A B3           	or e
 48+  843B 28 11        	jr z,view_file_size_ok ;если не слищком большой
 49+  843D              view_file_too_big
 50+  843D              	;файл больше буфера
 51+  843D 11 00 40     	ld de,#4000 ;размер одной первой части
 52+  8440 21 00 C0     	ld hl,buffer_cat
 53+  8443 3A F0 88     	ld a,(file_id_cur_r)
 54+  8446              	OS_FILE_READ ;загрузить
 54+  8446 0E 23       >    ld c,#23
 54+  8448 E7          >    rst #20
 55+  8449 38 DD        	jr c,view_file_file_error
 56+  844B
 57+  844B C3 77 84     	jp view_file_readed
 58+  844E
 59+  844E              view_file_size_ok
 60+  844E 78           	ld	a,b ;младший старший байт длины
 61+  844F FE 40        	cp #40
 62+  8451 38 06        	jr c,view_file_size_ok_small
 63+  8453 20 E8        	jr nz,view_file_too_big
 64+  8455 0C           	inc c
 65+  8456 0D           	dec c
 66+  8457 20 E4        	jr nz,view_file_too_big
 67+  8459
 68+  8459
 69+  8459              view_file_size_ok_small
 70+  8459              	;проверка на 0
 71+  8459 78           	ld a,b
 72+  845A B1           	or c
 73+  845B CA 28 84     	jp z,view_file_file_error
 74+  845E              	;узнать где конец файла
 75+  845E 21 00 C0     	ld hl,buffer_cat
 76+  8461 09           	add hl,bc
 77+  8462 22 CD 86     	ld (view_file_end),hl ;конец файла тут
 78+  8465              	;размер не большой, прочитаем
 79+  8465 50           	ld d,b ;размер
 80+  8466 59           	ld e,c
 81+  8467 21 00 C0     	ld hl,buffer_cat
 82+  846A 3A F0 88     	ld a,(file_id_cur_r)
 83+  846D              	OS_FILE_READ ;загрузить
 83+  846D 0E 23       >    ld c,#23
 83+  846F E7          >    rst #20
 84+  8470 38 B6        	jr c,view_file_file_error
 85+  8472
 86+  8472 3E 01        	ld a,1
 87+  8474 32 CC 86     	ld (view_file_load_all),a ;флаг что файл весь прочитан
 88+  8477
 89+  8477              view_file_readed
 90+  8477              	;файл прочитан
 91+  8477
 92+  8477 21 00 C0     	ld hl,buffer_cat
 93+  847A 22 C6 86     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
 94+  847D 22 C8 86     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
 95+  8480
 96+  8480 CD 82 85     	call print_file_text
 97+  8483
 98+  8483
 99+  8483 CD 4D 85     	call print_menu_view ;меню
100+  8486 CD 68 85     	call print_menu_view_top ;инфо
101+  8489
102+  8489 CD A7 80     	call release_key
103+  848C
104+  848C              view_file_wait ;цикл ожидания клавиши
105+  848C              	OS_WAIT
105+  848C DF          >	rst #18
106+  848D              	OS_GET_CHAR
106+  848D 0E 10       >    ld c,#10
106+  848F E7          >    rst #20
107+  8490 FE FF        	cp 255
108+  8492 28 F8        	jr z,view_file_wait
109+  8494 FE 33        	cp "3"
110+  8496 28 25        	jr z,view_file_wait_ex
111+  8498 FE 0A        	cp 10 ;вниз
112+  849A CA C6 84     	jp z,view_line_down
113+  849D FE 0B        	cp 11 ;вверх
114+  849F CA DC 84     	jp z,view_line_up
115+  84A2 FE 09        	cp 09 ;вправо
116+  84A4 CA F2 84     	jp z,view_right
117+  84A7 FE 08        	cp 08 ;влево
118+  84A9 CA 02 85     	jp z,view_left
119+  84AC FE 04        	cp 04 ;страница вверх
120+  84AE CA 13 85     	jp z,view_page_up
121+  84B1 FE 05        	cp 05 ;страница вниз
122+  84B3 CA 30 85     	jp z,view_page_down
123+  84B6 FE 18        	cp 24 ;break
124+  84B8 CA 8D 81     	jp z,exit
125+  84BB 18 CF        	jr view_file_wait
126+  84BD
127+  84BD              view_file_wait_ex
128+  84BD              	;почистить экран
129+  84BD              	OS_CLS
129+  84BD 0E 00       >    ld c,#00
129+  84BF E7          >    rst #20
130+  84C0 C3 23 80     	jp start_nc_warm ;перезагрузить папку
131+  84C3
132+  84C3              view_file_ex
133+  84C3 C3 56 80     	jp nc_wait
134+  84C6
135+  84C6
136+  84C6
137+  84C6              view_line_down ;вниз на строчку
138+  84C6 2A C8 86     	ld hl,(view_file_pos_cur_focus) ;фокус
139+  84C9 22 C6 86     	ld (view_file_pos_cur),hl
140+  84CC CD 97 86     	call next_line ;вперёд на строку
141+  84CF 38 BB        	jr c,view_file_wait ;если не удачно
142+  84D1 2A C6 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
143+  84D4 22 C8 86     	ld (view_file_pos_cur_focus),hl
144+  84D7 CD 82 85     	call print_file_text ;напечатать всю страницу
145+  84DA 18 B0        	jr view_file_wait
146+  84DC
147+  84DC              view_line_up ;вверх на строчку
148+  84DC 2A C8 86     	ld hl,(view_file_pos_cur_focus) ;фокус
149+  84DF 22 C6 86     	ld (view_file_pos_cur),hl
150+  84E2 CD A5 86     	call prev_line ;
151+  84E5 38 A5        	jr c,view_file_wait ;если не удачно
152+  84E7 2A C6 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
153+  84EA 22 C8 86     	ld (view_file_pos_cur_focus),hl
154+  84ED CD 82 85     	call print_file_text ;напечатать всю страницу
155+  84F0 18 9A        	jr view_file_wait
156+  84F2
157+  84F2
158+  84F2              view_right ;вправо
159+  84F2 2A C4 86     	ld hl,(view_move_right_val)
160+  84F5 23           	inc hl
161+  84F6 7C           	ld a,h
162+  84F7 B5           	or l
163+  84F8 28 92        	jr z,view_file_wait
164+  84FA 22 C4 86     	ld (view_move_right_val),hl
165+  84FD CD 82 85     	call print_file_text ;напечатать всю страницу
166+  8500 18 8A        	jr view_file_wait
167+  8502
168+  8502              view_left ;влево
169+  8502 2A C4 86     	ld hl,(view_move_right_val)
170+  8505 7C           	ld a,h
171+  8506 B5           	or l
172+  8507 28 83        	jr z,view_file_wait
173+  8509 2B           	dec hl
174+  850A 22 C4 86     	ld (view_move_right_val),hl
175+  850D CD 82 85     	call print_file_text ;напечатать всю страницу
176+  8510 C3 8C 84     	jp view_file_wait
177+  8513
178+  8513
179+  8513
180+  8513              view_page_up ;на страницу назад
181+  8513 2A C8 86     	ld hl,(view_file_pos_cur_focus) ;фокус
182+  8516 22 C6 86     	ld (view_file_pos_cur),hl
183+  8519 06 16        	ld b,view_text_bot-2
184+  851B              view_page_up_cl
185+  851B CD A5 86     	call prev_line ;
186+  851E 38 04        	jr c,view_page_up_ex ;если не удачно
187+  8520 28 02        	jr z,view_page_up_ex
188+  8522 10 F7        	djnz view_page_up_cl
189+  8524              view_page_up_ex
190+  8524 2A C6 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
191+  8527 22 C8 86     	ld (view_file_pos_cur_focus),hl
192+  852A CD 82 85     	call print_file_text ;напечатать всю страницу
193+  852D C3 8C 84     	jp view_file_wait
194+  8530
195+  8530
196+  8530
197+  8530              view_page_down ;на страницу вперёд
198+  8530 2A C8 86     	ld hl,(view_file_pos_cur_focus) ;фокус
199+  8533 22 C6 86     	ld (view_file_pos_cur),hl
200+  8536 06 16        	ld b,view_text_bot-2
201+  8538              view_page_down_cl
202+  8538 CD 97 86     	call next_line ;
203+  853B 38 04        	jr c,view_page_down_ex ;если не удачно
204+  853D 28 02        	jr z,view_page_down_ex
205+  853F 10 F7        	djnz view_page_down_cl
206+  8541              view_page_down_ex
207+  8541 2A C6 86     	ld hl,(view_file_pos_cur) ;запомнить фокус
208+  8544 22 C8 86     	ld (view_file_pos_cur_focus),hl
209+  8547 CD 82 85     	call print_file_text ;напечатать всю страницу
210+  854A C3 8C 84     	jp view_file_wait
211+  854D
212+  854D
213+  854D
214+  854D              print_menu_view ;печать меню просмотрщика
215+  854D 3E 18        	ld a,#18
216+  854F 06 28        	ld b,color_backgr_hi ;цвет
217+  8551              	OS_PAINT_LINE ;линия внизу
217+  8551 0E 04       >    ld c,#04
217+  8553 E7          >    rst #20
218+  8554 3E 28        	ld a,color_backgr_hi ;цвет
219+  8556 06 0C        	ld b,#c
220+  8558              	OS_SET_COLOR
220+  8558 0E 06       >    ld c,#06
220+  855A E7          >    rst #20
221+  855B 11 18 18     	ld de,#1800+3*8
222+  855E              	OS_SET_XY
222+  855E 0E 01       >    ld c,#01
222+  8560 E7          >    rst #20
223+  8561 21 BD 86     	ld hl,msg_menu_view
224+  8564              	OS_PRINTZ
224+  8564 0E 09       >    ld c,#09
224+  8566 E7          >    rst #20
225+  8567 C9           	ret
226+  8568
227+  8568              print_menu_view_top ;печать меню просмотрщика верхнее
228+  8568 AF           	xor a
229+  8569 06 28        	ld b,color_backgr_hi ;цвет
230+  856B              	OS_PAINT_LINE ;линия вверху
230+  856B 0E 04       >    ld c,#04
230+  856D E7          >    rst #20
231+  856E 3E 28        	ld a,color_backgr_hi ;цвет
232+  8570 06 0C        	ld b,#c
233+  8572              	OS_SET_COLOR
233+  8572 0E 06       >    ld c,#06
233+  8574 E7          >    rst #20
234+  8575 11 24 00     	ld de,#0024
235+  8578              	OS_SET_XY
235+  8578 0E 01       >    ld c,#01
235+  857A E7          >    rst #20
236+  857B 21 D3 86     	ld hl,file_name_cur
237+  857E              	OS_PRINTZ
237+  857E 0E 09       >    ld c,#09
237+  8580 E7          >    rst #20
238+  8581 C9           	ret
239+  8582
240+  8582
241+  8582
242+  8582              print_file_text	;печать текущей части файла в консоль
243+  8582 3E 04        	ld a,4 ;цвет
244+  8584 06 0C        	ld b,#c
245+  8586              	OS_SET_COLOR
245+  8586 0E 06       >    ld c,#06
245+  8588 E7          >    rst #20
246+  8589
247+  8589 3E 01        	ld a,view_text_top ;первая строка
248+  858B 32 CA 86     	ld (view_file_y_cur),a
249+  858E 2A C8 86     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
250+  8591 22 C6 86     	ld (view_file_pos_cur),hl
251+  8594              print_file_text_cl
252+  8594 2A C6 86     	ld hl,(view_file_pos_cur)
253+  8597 CD BD 85     	call print_line_text
254+  859A 38 0C        	jr c,print_file_text_ex
255+  859C
256+  859C              	; call next_line ;найти следующую строку
257+  859C              	; ret c
258+  859C
259+  859C 3A CA 86     	ld a,(view_file_y_cur)
260+  859F 3C           	inc a
261+  85A0 32 CA 86     	ld (view_file_y_cur),a
262+  85A3 FE 18        	cp view_text_bot
263+  85A5 38 ED        	jr c,print_file_text_cl
264+  85A7 C9           	ret
265+  85A8
266+  85A8              print_file_text_ex
267+  85A8              	;тут очистить остальные строки
268+  85A8 3A CA 86     	ld a,(view_file_y_cur)
269+  85AB FE 18        	cp view_text_bot
270+  85AD 30 0C        	jr nc,print_file_text_ex2
271+  85AF 67           	ld h,a
272+  85B0 3C           	inc a
273+  85B1 32 CA 86     	ld (view_file_y_cur),a
274+  85B4 3E 20        	ld a," "
275+  85B6              	OS_FILL_LINE ;очистить строку
275+  85B6 0E 03       >    ld c,#03
275+  85B8 E7          >    rst #20
276+  85B9 18 ED        	jr print_file_text_ex
277+  85BB              print_file_text_ex2
278+  85BB 37           	scf
279+  85BC C9           	ret
280+  85BD
281+  85BD
282+  85BD
283+  85BD              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
284+  85BD              ;вх: hl - адрес строки
285+  85BD CD 01 86     	call view_move_right ;промотать направо. если надо
286+  85C0              	;установить позицию
287+  85C0 3A CA 86     	ld a,(view_file_y_cur)
288+  85C3 57           	ld d,a
289+  85C4 AF           	xor a
290+  85C5 32 CB 86     	ld (view_file_x_cur),a
291+  85C8 5F           	ld e,a
292+  85C9              	OS_SET_XY 	;yx
292+  85C9 0E 01       >    ld c,#01
292+  85CB E7          >    rst #20
293+  85CC              print_line_text_cl ;цикл
294+  85CC
295+  85CC 7E           	ld a,(hl)
296+  85CD FE 0A        	cp 10 ;этот код не печатаем
297+  85CF 28 14        	jr z,print_line_text_skip
298+  85D1 FE FF        	cp #ff ;этот код не печатаем
299+  85D3 28 10        	jr z,print_line_text_skip
300+  85D5 FE 0D        	cp 13
301+  85D7 28 12        	jr z,print_line_text_ex_ok
302+  85D9              	OS_PRINT_CHARF ;печать
302+  85D9 D7          >	rst #10
303+  85DA
304+  85DA              	;на следующую позицию
305+  85DA 3A CB 86     	ld a,(view_file_x_cur)
306+  85DD 3C           	inc a
307+  85DE FE 50        	cp 80 ;правый край экрана
308+  85E0 32 CB 86     	ld (view_file_x_cur),a
309+  85E3 30 18        	jr nc,print_line_text_right ;дошли до правого края
310+  85E5
311+  85E5              print_line_text_skip
312+  85E5 CD 39 86     	call view_file_next_pos ;следующий
313+  85E8 30 E2        	jr nc,print_line_text_cl ;на следующий символ
314+  85EA C9           	ret
315+  85EB
316+  85EB
317+  85EB              print_line_text_ex_ok ;выход норма
318+  85EB              	;тут надо добить строку пробелами
319+  85EB 3E 20        	ld a," "
320+  85ED              	OS_PRINT_CHARF ;печать
320+  85ED D7          >	rst #10
321+  85EE 3A CB 86     	ld a,(view_file_x_cur)
322+  85F1 3C           	inc a
323+  85F2 FE 50        	cp 80 ;правый край экрана
324+  85F4 32 CB 86     	ld (view_file_x_cur),a
325+  85F7 38 F2        	jr c,print_line_text_ex_ok
326+  85F9
327+  85F9
328+  85F9 CD 39 86     	call view_file_next_pos ;следующий
329+  85FC
330+  85FC C9           	ret
331+  85FD              ; print_line_text_ex_end ;выход если кончился файл
332+  85FD              	; scf
333+  85FD              	; ret
334+  85FD
335+  85FD              print_line_text_right
336+  85FD CD 97 86     	call next_line ;позицию  до конца строки
337+  8600 C9           	ret
338+  8601
339+  8601
340+  8601
341+  8601              view_move_right ;перемотка строки направо
342+  8601 ED 4B C4 86  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
343+  8605 78           	ld a,b
344+  8606 B1           	or c
345+  8607 C8           	ret z
346+  8608 2A C6 86     	ld hl,(view_file_pos_cur)
347+  860B              view_move_right1
348+  860B 7E           	ld a,(hl)
349+  860C FE 0A        	cp 10 ;этот код пропускаем
350+  860E 20 07        	jr nz,view_move_right2
351+  8610 CD 39 86     	call view_file_next_pos
352+  8613 D8           	ret c
353+  8614 C8           	ret z
354+  8615 18 F4        	jr view_move_right1
355+  8617              view_move_right2
356+  8617 FE FF        	cp #ff ;этот код пропускаем
357+  8619 20 07        	jr nz,view_move_right3
358+  861B CD 39 86     	call view_file_next_pos
359+  861E D8           	ret c
360+  861F C8           	ret z
361+  8620 18 E9        	jr view_move_right1
362+  8622              view_move_right3
363+  8622 7E           	ld a,(hl)
364+  8623 FE 0D        	cp 13 ;
365+  8625 C8           	ret z
366+  8626              view_move_right_cl
367+  8626 CD 39 86     	call view_file_next_pos
368+  8629 D8           	ret c
369+  862A C8           	ret z
370+  862B 7E           	ld a,(hl)
371+  862C FE 0D        	cp 13
372+  862E C8           	ret z
373+  862F FE 0A        	cp 10 ;этот код пропускаем
374+  8631 28 F3        	jr z,view_move_right_cl
375+  8633 0B           	dec bc
376+  8634 78           	ld a,b
377+  8635 B1           	or c
378+  8636 20 EE        	jr nz,view_move_right_cl
379+  8638              	;call view_file_next_pos ;следующий
380+  8638 C9           	ret
381+  8639
382+  8639
383+  8639
384+  8639              ;получение следующей позиции
385+  8639              view_file_next_pos
386+  8639 3A CC 86     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
387+  863C B7           	or a
388+  863D 28 14        	jr z,view_file_next_pos_big
389+  863F              	;если текст не большой
390+  863F 2A CD 86     	ld hl,(view_file_end) ;конец текста известен
391+  8642 ED 5B C6 86  	ld de,(view_file_pos_cur)
392+  8646 13           	inc de ;вперёд
393+  8647 A7           	and a
394+  8648 ED 52        	sbc hl,de
395+  864A 38 15        	jr c,view_file_next_pos_end
396+  864C ED 53 C6 86  	ld (view_file_pos_cur),de
397+  8650 EB           	ex de,hl ;на выходе адрес в HL
398+  8651 B7           	or a
399+  8652 C9           	ret
400+  8653
401+  8653
402+  8653
403+  8653              view_file_next_pos_big
404+  8653              	;если текст большой
405+  8653 2A C6 86     	ld hl,(view_file_pos_cur)	;текущая позиция
406+  8656 23           	inc hl ;вперёд
407+  8657 7C           	ld a,h
408+  8658 FE C0        	cp #c0 ;если вышли за пределы окна
409+  865A 38 05        	jr c,view_file_next_pos_end
410+  865C 22 C6 86     	ld (view_file_pos_cur),hl
411+  865F B7           	or a
412+  8660 C9           	ret
413+  8661
414+  8661              view_file_next_pos_end
415+  8661              	;не смогли шагнуть вперёд
416+  8661              	; ld a,1 ;флаг что внизу
417+  8661              	; ld (view_file_bot_flag),a
418+  8661 37           	scf ;ошибка
419+  8662 C9           	ret
420+  8663
421+  8663
422+  8663
423+  8663
424+  8663
425+  8663
426+  8663              ;получение предыдущей позиции
427+  8663              view_file_prev_pos
428+  8663 3A CC 86     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
429+  8666 B7           	or a
430+  8667 28 1E        	jr z,view_file_prev_pos_big
431+  8669              	;если текст не большой
432+  8669 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
433+  866C ED 5B C6 86  	ld de,(view_file_pos_cur) ;текущая позиция
434+  8670 1B           	dec de ;назад
435+  8671 A7           	and a
436+  8672 ED 52        	sbc hl,de
437+  8674 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
438+  8676 30 1D        	jr nc,view_file_prev_pos_end
439+  8678              	;можно шагнуть назад
440+  8678 ED 53 C6 86  	ld (view_file_pos_cur),de
441+  867C EB           	ex de,hl ;на выходе адрес в HL
442+  867D AF           	xor a
443+  867E 3C           	inc a ;a=1
444+  867F C9           	ret
445+  8680              view_file_prev_pos_top
446+  8680              	;если в начале
447+  8680 ED 53 C6 86  	ld (view_file_pos_cur),de
448+  8684 EB           	ex de,hl ;на выходе адрес в HL
449+  8685 AF           	xor a ;a=0
450+  8686 C9           	ret
451+  8687
452+  8687
453+  8687              view_file_prev_pos_big
454+  8687              	;если текст большой
455+  8687 2A C6 86     	ld hl,(view_file_pos_cur)	;текущая позиция
456+  868A 2B           	dec hl ;назад
457+  868B 7C           	ld a,h
458+  868C FE C0        	cp #c0 ;если вышли за пределы окна
459+  868E 38 05        	jr c,view_file_prev_pos_end
460+  8690 22 C6 86     	ld (view_file_pos_cur),hl
461+  8693 B7           	or a
462+  8694 C9           	ret
463+  8695
464+  8695              view_file_prev_pos_end
465+  8695              	;не смогли шагнуть назад
466+  8695              	; ld hl,buffer_cat ;тут лежит текст
467+  8695              	; ld (view_file_pos_cur),hl ;текущая позиция в самом начале
468+  8695 37           	scf ;ошибка
469+  8696 C9           	ret
470+  8697
471+  8697
472+  8697
473+  8697
474+  8697              next_line ;поиск следующей строки
475+  8697 CD 39 86     	call view_file_next_pos
476+  869A D8           	ret c
477+  869B C8           	ret z
478+  869C 7E           	ld a,(hl)
479+  869D FE 0D        	cp 13
480+  869F 20 F6        	jr nz,next_line
481+  86A1 CD 39 86     	call view_file_next_pos ;ещё на символ
482+  86A4 C9           	ret
483+  86A5
484+  86A5
485+  86A5
486+  86A5              prev_line ;поиск предыдущей строки
487+  86A5              	;сначала в конец предыдущей
488+  86A5 CD 63 86     	call view_file_prev_pos
489+  86A8 C8           	ret z
490+  86A9 D8           	ret c
491+  86AA 7E           	ld a,(hl)
492+  86AB FE 0D        	cp 13
493+  86AD 20 F6        	jr nz,prev_line
494+  86AF              	;теперь в начало предыдущей
495+  86AF              prev_line1
496+  86AF CD 63 86     	call view_file_prev_pos
497+  86B2 C8           	ret z
498+  86B3 D8           	ret c
499+  86B4 7E           	ld a,(hl)
500+  86B5 FE 0D        	cp 13
501+  86B7 20 F6        	jr nz,prev_line1
502+  86B9 CD 39 86     	call view_file_next_pos ;ещё на символ обратно
503+  86BC C9           	ret
504+  86BD
505+  86BD
506+  86BD
507+  86BD              view_text_bot equ 24 ;последняя строка для печати
508+  86BD              view_text_top equ 1 ;первая строка
509+  86BD              view_text_lines equ 25-2 ;видимых строк на экране
510+  86BD
511+  86BD              msg_menu_view
512+  86BD 33 20 45 78  	db "3 Exit",0
512+  86C1 69 74 00
513+  86C4
514+  86C4              ;view_file_position ds 4 ;текущая позиция в файле
515+  86C4              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
516+  86C4 00 00        view_move_right_val dw 0 ;сдвиг вправо
517+  86C6 00 00        view_file_pos_cur dw 0;текущая позиция
518+  86C8 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
519+  86CA 00           view_file_y_cur db 0;текущая строка
520+  86CB 00           view_file_x_cur db 0;текущий столбец
521+  86CC 00           view_file_load_all db 0 ;флаг что файл весь загружен
522+  86CD 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
523+  86CF
524+  86CF
# file closed: nc_view.asm
854   86CF
855   86CF
856   86CF              color_backgr equ 1*8+7 ;цвет фона
857   86CF              color_apg equ 1*8+4 ;цвет приложений
858   86CF              color_dir equ 1*8+6 ;цвет папок
859   86CF
860   86CF              color_backgr_hi equ 5*8+0 ;цвет фона курсор
861   86CF              color_apg_hi equ 5*8+0 ;цвет приложений курсор
862   86CF              color_dir_hi equ 5*8+0 ;цвет папок курсор
863   86CF
864   86CF              file_info_lenght equ 11 ;длина инфо о файле
865   86CF              panel_hight equ 22;высота панели
866   86CF              panel_r_xy equ #0129
867   86CF              buffer_cat equ #c000 ;адрес буфера каталога
868   86CF
869   86CF 00 00        file_r_all dw 0;всего файлов справа
870   86D1 00 00        file_r_cur_focus dw 0;первый видимый
871   86D3 00 00 00...  file_name_cur ds 256 ;имя файла текущее
872   87D3 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
873   88D3 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
874   88DF 20 20 20 20  file_info_clear db "            ",0 ;для очистки
874   88E3 20 20 20 20
874   88E7 20 20 20 20
874   88EB 00
875   88EC 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
876   88ED
877   88ED 00 00        file_r_num_cur dw 0 ;текущий файл справа
878   88EF 00           key_pressed db 0 ;последняя клавиша
879   88F0 00           file_id_cur_r db 0 ;id файла справа
880   88F1
881   88F1
882   88F1 00           page_ext01 db 0 ;номер дополнительной страницы
883   88F2 00 00        page_main dw 0 ;основные номера страниц слота 2,3
884   88F4 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
885   88F5
886   88F5              rect_1
887   88F5 C9           	db #c9
888   88F6              	dup 40-2
889   88F6 CD          >	db #cd
889   88F7 CD          >	db #cd
889   88F8 CD          >	db #cd
889   88F9 CD          >	db #cd
889   88FA CD          >	db #cd
889   88FB CD          >	db #cd
889   88FC CD          >	db #cd
889   88FD CD          >	db #cd
889   88FE CD          >	db #cd
889   88FF CD          >	db #cd
889   8900 CD          >	db #cd
889   8901 CD          >	db #cd
889   8902 CD          >	db #cd
889   8903 CD          >	db #cd
889   8904 CD          >	db #cd
889   8905 CD          >	db #cd
889   8906 CD          >	db #cd
889   8907 CD          >	db #cd
889   8908 CD          >	db #cd
889   8909 CD          >	db #cd
889   890A CD          >	db #cd
889   890B CD          >	db #cd
889   890C CD          >	db #cd
889   890D CD          >	db #cd
889   890E CD          >	db #cd
889   890F CD          >	db #cd
889   8910 CD          >	db #cd
889   8911 CD          >	db #cd
889   8912 CD          >	db #cd
889   8913 CD          >	db #cd
889   8914 CD          >	db #cd
889   8915 CD          >	db #cd
889   8916 CD          >	db #cd
889   8917 CD          >	db #cd
889   8918 CD          >	db #cd
889   8919 CD          >	db #cd
889   891A CD          >	db #cd
889   891B CD          >	db #cd
890   891C              	edup
891   891C BB 00        	db #bb,0
892   891E
893   891E              rect_2
894   891E BA           	db #ba
895   891F              	dup 40-2
896   891F 20          >	db " "
896   8920 20          >	db " "
896   8921 20          >	db " "
896   8922 20          >	db " "
896   8923 20          >	db " "
896   8924 20          >	db " "
896   8925 20          >	db " "
896   8926 20          >	db " "
896   8927 20          >	db " "
896   8928 20          >	db " "
896   8929 20          >	db " "
896   892A 20          >	db " "
896   892B 20          >	db " "
896   892C 20          >	db " "
896   892D 20          >	db " "
896   892E 20          >	db " "
896   892F 20          >	db " "
896   8930 20          >	db " "
896   8931 20          >	db " "
896   8932 20          >	db " "
896   8933 20          >	db " "
896   8934 20          >	db " "
896   8935 20          >	db " "
896   8936 20          >	db " "
896   8937 20          >	db " "
896   8938 20          >	db " "
896   8939 20          >	db " "
896   893A 20          >	db " "
896   893B 20          >	db " "
896   893C 20          >	db " "
896   893D 20          >	db " "
896   893E 20          >	db " "
896   893F 20          >	db " "
896   8940 20          >	db " "
896   8941 20          >	db " "
896   8942 20          >	db " "
896   8943 20          >	db " "
896   8944 20          >	db " "
897   8945              	edup
898   8945 BA 00        	db #ba,0
899   8947
900   8947              rect_3
901   8947 C8           	db #c8
902   8948              	dup 40-2
903   8948 CD          >	db #cd
903   8949 CD          >	db #cd
903   894A CD          >	db #cd
903   894B CD          >	db #cd
903   894C CD          >	db #cd
903   894D CD          >	db #cd
903   894E CD          >	db #cd
903   894F CD          >	db #cd
903   8950 CD          >	db #cd
903   8951 CD          >	db #cd
903   8952 CD          >	db #cd
903   8953 CD          >	db #cd
903   8954 CD          >	db #cd
903   8955 CD          >	db #cd
903   8956 CD          >	db #cd
903   8957 CD          >	db #cd
903   8958 CD          >	db #cd
903   8959 CD          >	db #cd
903   895A CD          >	db #cd
903   895B CD          >	db #cd
903   895C CD          >	db #cd
903   895D CD          >	db #cd
903   895E CD          >	db #cd
903   895F CD          >	db #cd
903   8960 CD          >	db #cd
903   8961 CD          >	db #cd
903   8962 CD          >	db #cd
903   8963 CD          >	db #cd
903   8964 CD          >	db #cd
903   8965 CD          >	db #cd
903   8966 CD          >	db #cd
903   8967 CD          >	db #cd
903   8968 CD          >	db #cd
903   8969 CD          >	db #cd
903   896A CD          >	db #cd
903   896B CD          >	db #cd
903   896C CD          >	db #cd
903   896D CD          >	db #cd
904   896E              	edup
905   896E BC 00        	db #bc,0
906   8970
907   8970              msg_menu_main2
908   8970 32 20 41 5A  	db "2 AZ Of",0
908   8974 20 4F 66 00
909   8978              msg_menu_main3
910   8978 33 20 56 69  	db "3 View",0
910   897C 65 77 00
911   897F              msg_file_error
912   897F 46 69 6C 65  	db "File error",10,13,0
912   8983 20 65 72 72
912   8987 6F 72 0A 0D
912   898B 00
913   898C              msg_file_too_big
914   898C 46 69 6C 65  	db "File too big",10,13,0
914   8990 20 74 6F 6F
914   8994 20 62 69 67
914   8998 0A 0D 00
915   899B              msg_mem_err
916   899B 47 65 74 20  	db "Get memory error",10,13,0
916   899F 6D 65 6D 6F
916   89A3 72 79 20 65
916   89A7 72 72 6F 72
916   89AB 0A 0D 00
917   89AE              msg_title_nc
918   89AE 4E 6F 6E 65  	db "None Commander ver 2025.06.19",10,13,0
918   89B2 20 43 6F 6D
918   89B6 6D 61 6E 64
918   89BA 65 72 20 76
918   89BE 65 72 20 32
918   89C2 30 32 35 2E
918   89C6 30 36 2E 31
918   89CA 39 0A 0D 00
919   89CE
920   89CE              end_nc
921   89CE              ;ниже не включается в файл
922   89CE 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
923   8DCE
924   8DCE              	savebin "nc.apg",start_nc,$-start_nc
# file closed: nc.asm
