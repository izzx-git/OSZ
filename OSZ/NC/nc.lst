# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000
  97+ 0000              ;включить/выключить моно режим для приложения
  98+ 0000              ;при включенном режиме разрешена запись в диапазон памяти #4000-#7fff + страницы приложения
  99+ 0000              ;вх: a = 0 - включить; a = 255 - выключить
 100+ 0000                  macro OS_SET_MONO_MODE ;
 101+ 0000 ~                ld c,#08
 102+ 0000 ~                rst #20
 103+ 0000                  endm
 104+ 0000
 105+ 0000
 106+ 0000
 107+ 0000              ;печать в консоль до кода 0
 108+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 109+ 0000 ~                ld c,#09
 110+ 0000 ~                rst #20
 111+ 0000                  endm
 112+ 0000
 113+ 0000
 114+ 0000              ;прочитать байт из порта uart
 115+ 0000              ;вх:
 116+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 117+ 0000              ;вых: A - считанный байт
 118+ 0000                  macro OS_UART_READ
 119+ 0000 ~                ld c,#0a
 120+ 0000 ~                rst #20
 121+ 0000                  endm
 122+ 0000
 123+ 0000              ;записать байт в порт uart
 124+ 0000              ;вх: A -байт
 125+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 126+ 0000                  macro OS_UART_WRITE
 127+ 0000 ~                ld c,#0b
 128+ 0000 ~                rst #20
 129+ 0000                  endm
 130+ 0000
 131+ 0000              ;закрыть соединение ESP
 132+ 0000              ;вх:
 133+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 134+ 0000                  macro OS_ESP_CLOSE
 135+ 0000 ~                ld c,#0c
 136+ 0000 ~                rst #20
 137+ 0000                  endm
 138+ 0000
 139+ 0000              ;установить соединение ESP (CIPSTART);
 140+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 141+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 142+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 143+ 0000                  macro OS_ESP_OPEN
 144+ 0000 ~                ld c,#0d
 145+ 0000 ~                rst #20
 146+ 0000                  endm
 147+ 0000
 148+ 0000              ;послать запрос ESP (CIPSEND);
 149+ 0000              ;вх: hl - адрес данных, de - длина данных
 150+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 151+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 152+ 0000                  macro OS_ESP_SEND
 153+ 0000 ~                ld c,#0e
 154+ 0000 ~                rst #20
 155+ 0000                  endm
 156+ 0000
 157+ 0000              ;получить пакет ESP (+IPD);
 158+ 0000              ;вх: hl - адрес для данных
 159+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 160+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 161+ 0000                  macro OS_ESP_GET
 162+ 0000 ~                ld c,#0f
 163+ 0000 ~                rst #20
 164+ 0000                  endm
 165+ 0000
 166+ 0000              ;ввод с консоли ----------------------
 167+ 0000
 168+ 0000              ;получить код нажатой клавиши
 169+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 170+ 0000 ~                ld c,#10
 171+ 0000 ~                rst #20
 172+ 0000                  endm
 173+ 0000
 174+ 0000
 175+ 0000              ;процессы ----------------------------
 176+ 0000
 177+ 0000              ;запустить процесс
 178+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 179+ 0000                  macro OS_PROC_RUN ;
 180+ 0000 ~                ld c,#11
 181+ 0000 ~                rst #20
 182+ 0000                  endm
 183+ 0000
 184+ 0000              ;установить фокус
 185+ 0000              ;вх: a - id процесса
 186+ 0000                  macro OS_PROC_SET_FOCUS ;
 187+ 0000 ~                ld c,#12
 188+ 0000 ~                rst #20
 189+ 0000                  endm
 190+ 0000
 191+ 0000              ;закрыть процесс
 192+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 193+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 194+ 0000                  macro OS_PROC_CLOSE ;
 195+ 0000 ~                ld c,#13
 196+ 0000 ~                rst #20
 197+ 0000                  endm
 198+ 0000
 199+ 0000
 200+ 0000              ;прерывания --------------------------
 201+ 0000
 202+ 0000              ;установка адреса обработчика прерываний процесса;
 203+ 0000              ;например, плеера музыки
 204+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 205+ 0000              ;на время выполнения включаются обе страницы процесса
 206+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 207+ 0000 ~                ld c,#14
 208+ 0000 ~                rst #20
 209+ 0000                  endm
 210+ 0000
 211+ 0000
 212+ 0000              ;плеер AY ----------------------------
 213+ 0000
 214+ 0000              ;инициализация плеера AY;
 215+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 216+ 0000 ~                ld c,#15
 217+ 0000 ~                rst #20
 218+ 0000                  endm
 219+ 0000
 220+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 221+ 0000                  macro OS_VTPL_PLAY ;()
 222+ 0000 ~                ld c,#16
 223+ 0000 ~                rst #20
 224+ 0000                  endm
 225+ 0000
 226+ 0000              ;заглушить плеер AY;
 227+ 0000                  macro OS_VTPL_MUTE ;()
 228+ 0000 ~                ld c,#17
 229+ 0000 ~                rst #20
 230+ 0000                  endm
 231+ 0000
 232+ 0000              ;получить значение переменной плеера;
 233+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 234+ 0000 ~                ld c,#18
 235+ 0000 ~                rst #20
 236+ 0000                  endm
 237+ 0000
 238+ 0000
 239+ 0000              ;прочие ------------------------------
 240+ 0000
 241+ 0000
 242+ 0000              ;скопировать данные из страницы в страницу
 243+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 244+ 0000                  macro OS_RAM_COPY
 245+ 0000 ~                ld c,#19
 246+ 0000 ~                rst #20
 247+ 0000                  endm
 248+ 0000
 249+ 0000              ;получить дополнительную страницу памяти;
 250+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 251+ 0000 ~                ld c,#1a
 252+ 0000 ~                rst #20
 253+ 0000                  endm
 254+ 0000
 255+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 256+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 257+ 0000 ~                ld c,#1b
 258+ 0000 ~                rst #20
 259+ 0000                  endm
 260+ 0000
 261+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 262+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 263+ 0000 ~                ld c,#1c
 264+ 0000 ~                rst #20
 265+ 0000                  endm
 266+ 0000
 267+ 0000              ;включить экран N;
 268+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 269+ 0000              ;переключать может только приложение в фокусе
 270+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 271+ 0000              ;при переключении процессов сохраняется только экран #39
 272+ 0000                  macro OS_SET_SCREEN ;
 273+ 0000 ~                ld c,#1d
 274+ 0000 ~                rst #20
 275+ 0000                  endm
 276+ 0000
 277+ 0000
 278+ 0000              ;получить номера страниц процесса;
 279+ 0000              ;вх:
 280+ 0000              ;вых: b, c - страницы в слотах 2, 3
 281+ 0000                  macro OS_GET_MAIN_PAGES ;
 282+ 0000 ~                ld c,#1e
 283+ 0000 ~                rst #20
 284+ 0000                  endm
 285+ 0000
 286+ 0000              ;получить значение системного таймера
 287+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 288+ 0000 ~                ld c,#1F
 289+ 0000 ~                rst #20
 290+ 0000                  endm
 291+ 0000
 292+ 0000
 293+ 0000              ;освободить страницу памяти
 294+ 0000              ;вх: a - номер страницы
 295+ 0000                  macro OS_DEL_PAGE ;
 296+ 0000 ~                ld c,#20
 297+ 0000 ~                rst #20
 298+ 0000                  endm
 299+ 0000
 300+ 0000
 301+ 0000              ;дисковые операции -------------------
 302+ 0000
 303+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 304+ 0000
 305+ 0000              ; fcbFAT (из руководства к монитору)
 306+ 0000              ; формат fcb для работы с FAT
 307+ 0000
 308+ 0000              ; +#00 8 имя файла
 309+ 0000              ; +#08 3 расширение файла
 310+ 0000              ; +#0B 1 атрибуты файла
 311+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 312+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 313+ 0000              ; +#14 4 размер файла/каталога в байтах
 314+ 0000              ; +#18 4 указатель в файле
 315+ 0000              ; +#1C 1 для внутренних нужд
 316+ 0000              ; +#1D 1 для внутренних нужд
 317+ 0000              ; +#1E 1 резерв
 318+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 319+ 0000              	; 1-0,nn номер раздела
 320+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 321+ 0000              	    ; значение %11 недопустимо
 322+ 0000
 323+ 0000              ;открыть файл для чтения или записи
 324+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 325+ 0000 ~                ld c,#21
 326+ 0000 ~                rst #20
 327+ 0000                  endm
 328+ 0000
 329+ 0000              ;создать файл
 330+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 331+ 0000 ~                ld c,#22
 332+ 0000 ~                rst #20
 333+ 0000                  endm
 334+ 0000
 335+ 0000              ;прочитать из файла
 336+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 337+ 0000 ~                ld c,#23
 338+ 0000 ~                rst #20
 339+ 0000                  endm
 340+ 0000
 341+ 0000              ;записать в файл
 342+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 343+ 0000 ~                ld c,#24
 344+ 0000 ~                rst #20
 345+ 0000                  endm
 346+ 0000
 347+ 0000              ;закрыть файл
 348+ 0000                  macro OS_FILE_CLOSE ;A - id file
 349+ 0000 ~                ld c,#25
 350+ 0000 ~                rst #20
 351+ 0000                  endm
 352+ 0000
 353+ 0000              ;чтение секторов текущего каталога
 354+ 0000              ; вх:
 355+ 0000                   ; hl - буфер для чтения
 356+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 357+ 0000                   ; b - максимальное количество секторов для чтения
 358+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 359+ 0000                     ; a=errRWnum
 360+ 0000                     ; a=errInvalidPart
 361+ 0000                     ; a=errFileEmpty
 362+ 0000                   ; cy=0, a=errEoF - каталог закончился
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b - не прочитано секторов
 366+ 0000                   ; cy=0 - считано успешно
 367+ 0000                     ; hl - следующий адрес в буфере
 368+ 0000                     ; de - номер первого непрочитанного сектора
 369+ 0000                     ; b=#00
 370+ 0000                  macro OS_DIR_READ ;
 371+ 0000 ~                ld c,#26
 372+ 0000 ~                rst #20
 373+ 0000                  endm
 374+ 0000
 375+ 0000              ;вход в каталог/выход в родительский каталог
 376+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 377+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 378+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 379+ 0000              	; переход в родительский, последнее имя в пути удалится).
 380+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 381+ 0000              	; добавится имя файла
 382+ 0000              ; вх:
 383+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 384+ 0000                   ; de - адрес дескриптора директории/файла
 385+ 0000              ; вых: a - если путь был указан, новая длина пути
 386+ 0000                  macro OS_DIR_OPEN ;
 387+ 0000 ~                ld c,#27
 388+ 0000 ~                rst #20
 389+ 0000                  endm
 390+ 0000
 391+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 392+ 0000              ;проверки на допустимость значений не производится
 393+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 394+ 0000              ;вх: A - id файла
 395+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 396+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 397+ 0000                  macro OS_FILE_POSITION ;
 398+ 0000 ~                ld c,#28
 399+ 0000 ~                rst #20
 400+ 0000                  endm
 401+ 0000
 402+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 403+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 404+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 405+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 406+ 0000                  macro OS_FIND_PATH ;
 407+ 0000 ~                ld c,#29
 408+ 0000 ~                rst #20
 409+ 0000                  endm
 410+ 0000
 411+ 0000
 412+ 0000              ; получение длинного имени файла
 413+ 0000              ;вх: hl - адрес буфера для имени
 414+ 0000              ;    de - номер записи в текущем каталоге
 415+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 416+ 0000              ; 	a - длина имени, с учетом нуля
 417+ 0000                  macro OS_GET_LFN ;
 418+ 0000 ~                ld c,#2a
 419+ 0000 ~                rst #20
 420+ 0000                  endm
 421+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROG_START
   5  8000
   6  8000              start_nc
   7  8000 21 86 A5     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 70 A4  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 54 A5     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A              get_page_error1
  24  801A CD DA 80     	call delay
  25  801D C3 0F 83     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 60 A4     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023              	OS_GET_PAGE ;получить лишнюю страницу для gzip
  31  8023 0E 1A       >    ld c,#1a
  31  8025 E7          >    rst #20
  32  8026 38 EC        	jr c,get_page_error
  33  8028 32 61 A4     	ld (page_ext02_gzip),a ;запомнить
  34  802B
  35  802B 21 7B A5     	ld hl,msg_load_gzip
  36  802E              	OS_PRINTZ
  36  802E 0E 09       >    ld c,#09
  36  8030 E7          >    rst #20
  37  8031
  38  8031 3A 61 A4     	ld a,(page_ext02_gzip) ;доп страница для данных плеера
  39  8034              	OS_SET_PAGE_SLOT3
  39  8034 0E 1C       >    ld c,#1c
  39  8036 E7          >    rst #20
  40  8037
  41  8037 21 62 A4     	ld hl,gp_gzip_file_name
  42  803A CD DC 87     	call load_file
  43  803D 38 DB        	jr c,get_page_error1
  44  803F 22 6E A4     	ld (gp_gzip_file_size),hl ;запомнить размер
  45  8042
  46  8042
  47  8042 3A 70 A4     	ld a,(page_main) ;основная страница с каталогом
  48  8045              	OS_SET_PAGE_SLOT3
  48  8045 0E 1C       >    ld c,#1c
  48  8047 E7          >    rst #20
  49  8048
  50  8048
  51  8048              start_nc_warm ;тёплый старт
  52  8048
  53  8048              	;очистка буфера
  54  8048 CD E0 80     	call clear_buf
  55  804B
  56  804B              	;загрузка каталога
  57  804B 21 00 C0     	ld hl,buffer_cat ;куда
  58  804E 11 00 00     	ld de,0 ;начиная с 0 сектора
  59  8051 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  60  8053              	OS_DIR_READ
  60  8053 0E 26       >    ld c,#26
  60  8055 E7          >    rst #20
  61  8056
  62  8056 21 00 00     	ld hl,0 ;обнулить переменные
  63  8059 22 58 A4     	ld (file_r_num_cur),hl
  64  805C 22 5A A4     	ld (file_r_num_old),hl
  65  805F 22 46 A2     	ld (file_r_all),hl
  66  8062 22 48 A2     	ld (file_r_cur_focus),hl
  67  8065
  68  8065 CD 3F 85     	call sort_dir
  69  8068
  70  8068 3E 0F        	ld a,color_backgr
  71  806A 06 0C        	ld b,#c
  72  806C              	OS_SET_COLOR
  72  806C 0E 06       >    ld c,#06
  72  806E E7          >    rst #20
  73  806F
  74  806F CD 44 87     	call print_rect_r ;рамка
  75  8072 CD EC 83     	call print_panel_r
  76  8075 CD 79 87     	call print_menu_main
  77  8078
  78  8078 11 00 01     	ld de,#0100
  79  807B              	OS_SET_XY
  79  807B 0E 01       >    ld c,#01
  79  807D E7          >    rst #20
  80  807E
  81  807E 21 09 A5     	ld hl,msg_menu_info
  82  8081              	OS_PRINTZ
  82  8081 0E 09       >    ld c,#09
  82  8083 E7          >    rst #20
  83  8084
  84  8084
  85  8084
  86  8084              nc_wait
  87  8084              	OS_WAIT ;ждать прерывание
  87  8084 DF          >	rst #18
  88  8085
  89  8085              	OS_GET_CHAR ;клавиша
  89  8085 0E 10       >    ld c,#10
  89  8087 E7          >    rst #20
  90  8088 32 5E A4     	ld (key_pressed),a ;запомнить
  91  808B FE 0D        	cp 13
  92  808D CA 41 81     	jp z,key_enter ;
  93  8090 FE 0A        	cp 10 ;вниз
  94  8092 CC 66 82     	call z,key_down
  95  8095 FE 0B        	cp 11 ;вверх
  96  8097 CC AE 82     	call z,key_up
  97  809A FE 09        	cp 09 ;вправо
  98  809C CC FD 82     	call z,key_right
  99  809F FE 08        	cp 08 ;влево
 100  80A1 CC EB 82     	call z,key_left
 101  80A4 FE 04        	cp 04 ;страница вверх
 102  80A6 CC EB 82     	call z,key_left
 103  80A9 FE 05        	cp 05 ;страница вниз
 104  80AB CC FD 82     	call z,key_right
 105  80AE FE 31        	cp "1" ;переключение длинных имён (LFN)
 106  80B0 CA F2 86     	jp z,LFN_toggle
 107  80B3 FE 32        	cp "2" ;переключение сортировки
 108  80B5 CA D2 86     	jp z,sort_toggle
 109  80B8 FE 33        	cp "3" ;просмотр файла
 110  80BA CA 4C 88     	jp z,view_file
 111  80BD FE 34        	cp "4" ;редактор файла
 112  80BF CA 72 8B     	jp z,edit_file
 113  80C2 FE 19        	cp 25 ;CS+Enter
 114  80C4 CA C6 81     	jp z,nc_play_all
 115  80C7 FE 18        	cp 24 ;break
 116  80C9 CA 0F 83     	jp z,exit
 117  80CC
 118  80CC
 119  80CC 3A 72 A4     	ld a,(print_panel_r_flag)
 120  80CF B7           	or a
 121  80D0 C4 EC 83     	call nz,print_panel_r ;обновить каталог
 122  80D3 AF           	xor a
 123  80D4 32 72 A4     	ld (print_panel_r_flag),a
 124  80D7
 125  80D7 C3 84 80     	jp nc_wait ;на цикл ожидания
 126  80DA
 127  80DA
 128  80DA              delay ;задержка
 129  80DA 06 64        	ld b,50*2 ;
 130  80DC              delay1
 131  80DC              	OS_WAIT
 131  80DC DF          >	rst #18
 132  80DD 10 FD        	djnz delay1
 133  80DF C9           	ret
 134  80E0
 135  80E0
 136  80E0              clear_buf
 137  80E0 21 00 C0     	ld hl,buffer_cat
 138  80E3 11 01 C0     	ld de,buffer_cat+1
 139  80E6 01 FF 3F     	ld bc,#4000-1
 140  80E9 36 00        	ld (hl),0
 141  80EB ED B0        	ldir
 142  80ED C9           	ret
 143  80EE
 144  80EE
 145  80EE              ;очистить левую панель
 146  80EE              clear_left_panel
 147  80EE 3E 0F        	ld a,color_backgr ;цвет
 148  80F0 06 0C        	ld b,#c
 149  80F2              	OS_SET_COLOR
 149  80F2 0E 06       >    ld c,#06
 149  80F4 E7          >    rst #20
 150  80F5 06 18        	ld b,panel_hight+2 ;высота
 151  80F7 11 00 00     	ld de,0
 152  80FA              	OS_SET_XY
 152  80FA 0E 01       >    ld c,#01
 152  80FC E7          >    rst #20
 153  80FD              clear_left_panel_cl
 154  80FD C5           	push bc
 155  80FE 21 0E 81     	ld hl,txt_clear_panel
 156  8101              	OS_PRINTZ
 156  8101 0E 09       >    ld c,#09
 156  8103 E7          >    rst #20
 157  8104 C1           	pop bc
 158  8105 10 F6        	djnz clear_left_panel_cl
 159  8107 11 00 00     	ld de,0
 160  810A              	OS_SET_XY
 160  810A 0E 01       >    ld c,#01
 160  810C E7          >    rst #20
 161  810D C9           	ret
 162  810E 20 20 20 20  txt_clear_panel db "                                        ",13,0 ;40 пробелов
 162  8112 20 20 20 20
 162  8116 20 20 20 20
 162  811A 20 20 20 20
 162  811E 20 20 20 20
 162  8122 20 20 20 20
 162  8126 20 20 20 20
 162  812A 20 20 20 20
 162  812E 20 20 20 20
 162  8132 20 20 20 20
 162  8136 0D 00
 163  8138
 164  8138
 165  8138              release_key ;ждать отпускания клавиши
 166  8138              	OS_WAIT
 166  8138 DF          >	rst #18
 167  8139              	OS_GET_CHAR
 167  8139 0E 10       >    ld c,#10
 167  813B E7          >    rst #20
 168  813C FE FF        	cp 255
 169  813E 20 F8        	jr nz,release_key
 170  8140 C9           	ret
 171  8141
 172  8141
 173  8141              key_enter
 174  8141              	;нажата Enter
 175  8141 2A 46 A2     	ld hl,(file_r_all)
 176  8144 7D           	ld a,l
 177  8145 B4           	or h
 178  8146 CA C3 81     	jp z,key_enter_ex ;защита
 179  8149 2A 58 A4     	ld hl,(file_r_num_cur)
 180  814C CD 59 82     	call calc_deskr
 181  814F DD 7E 0B     	ld a,(ix+#0b)
 182  8152 FE 10        	cp #10 ;признак каталога
 183  8154 CA 4B 82     	jp z,key_enter_dir
 184  8157
 185  8157 FE 30        	cp #30 ;признак каталога
 186  8159 CA 4B 82     	jp z,key_enter_dir
 187  815C
 188  815C
 189  815C CD 0F 87     	call format_name
 190  815F
 191  815F              	;проверка расширения APG
 192  815F CD 13 83     	call check_apg
 193  8162 C2 77 81     	jp nz,key_enter_1
 194  8165              	;тут запуск приложения
 195  8165 21 4A A2     	ld hl,file_name_cur		;строка с именем
 196  8168              	OS_PROC_RUN ;запустить прогу
 196  8168 0E 11       >    ld c,#11
 196  816A E7          >    rst #20
 197  816B              	;обработка ошибки
 198  816B DA C3 81     	jp c,key_enter_ex
 199  816E
 200  816E DD 7E 00     	ld a,(ix)
 201  8171              	OS_PROC_SET_FOCUS ;на передний план
 201  8171 0E 12       >    ld c,#12
 201  8173 E7          >    rst #20
 202  8174 C3 C3 81     	jp key_enter_ex
 203  8177
 204  8177
 205  8177
 206  8177              key_enter_1
 207  8177              	;проверка расширения VGZ
 208  8177 CD 51 83     	call check_vgz
 209  817A C2 84 81     	jp nz,key_enter_2_1
 210  817D
 211  817D 3E 7A        	ld a,"z" ;код формата
 212  817F CD F7 8F     	call start_gplay
 213  8182
 214  8182 18 3F        	jr key_enter_ex
 215  8184
 216  8184
 217  8184              key_enter_2_1
 218  8184              	;проверка расширения VGM
 219  8184 CD 32 83     	call check_vgm
 220  8187 C2 91 81     	jp nz,key_enter_2
 221  818A
 222  818A 3E 76        	ld a,"v" ;код формата
 223  818C CD F7 8F     	call start_gplay
 224  818F
 225  818F 18 32        	jr key_enter_ex
 226  8191
 227  8191
 228  8191              key_enter_2
 229  8191              	;проверка расширения SCR
 230  8191 CD 70 83     	call check_scr
 231  8194 C2 9C 81     	jp nz,key_enter_3
 232  8197
 233  8197 CD E9 A1     	call display ;показать
 234  819A
 235  819A 18 27        	jr key_enter_ex
 236  819C
 237  819C
 238  819C              key_enter_3
 239  819C              	;проверка расширения MOD
 240  819C CD 8F 83     	call check_mod
 241  819F C2 A9 81     	jp nz,key_enter_4
 242  81A2
 243  81A2 3E 6D        	ld a,"m" ;код формата
 244  81A4 CD F7 8F     	call start_gplay
 245  81A7
 246  81A7 18 1A        	jr key_enter_ex
 247  81A9
 248  81A9
 249  81A9              key_enter_4
 250  81A9              	;проверка расширения PT2
 251  81A9 CD AE 83     	call check_pt2
 252  81AC C2 B6 81     	jp nz,key_enter_5
 253  81AF
 254  81AF 3E 32        	ld a,"2" ;код формата
 255  81B1 CD F7 8F     	call start_gplay
 256  81B4
 257  81B4 18 0D        	jr key_enter_ex
 258  81B6
 259  81B6
 260  81B6              key_enter_5
 261  81B6              	;проверка расширения PT3
 262  81B6 CD CD 83     	call check_pt3
 263  81B9 C2 C3 81     	jp nz,key_enter_6
 264  81BC
 265  81BC 3E 33        	ld a,"3" ;код формата
 266  81BE CD F7 8F     	call start_gplay
 267  81C1
 268  81C1 18 00        	jr key_enter_ex
 269  81C3
 270  81C3
 271  81C3
 272  81C3              key_enter_6
 273  81C3
 274  81C3
 275  81C3
 276  81C3
 277  81C3              key_enter_ex
 278  81C3 C3 84 80     	jp nc_wait
 279  81C6
 280  81C6
 281  81C6
 282  81C6
 283  81C6
 284  81C6
 285  81C6
 286  81C6              nc_play_all
 287  81C6              	;Воспроизведение всего по порядку
 288  81C6 2A 46 A2     	ld hl,(file_r_all)
 289  81C9 7D           	ld a,l
 290  81CA B4           	or h
 291  81CB CA 31 82     	jp z,nc_play_ex ;защита
 292  81CE 2A 58 A4     	ld hl,(file_r_num_cur)
 293  81D1 CD 59 82     	call calc_deskr
 294  81D4 DD 7E 0B     	ld a,(ix+#0b)
 295  81D7 FE 10        	cp #10 ;признак каталога
 296  81D9 28 59        	jr z,nc_play_all_down
 297  81DB
 298  81DB FE 30        	cp #30 ;признак каталога
 299  81DD 28 55        	jr z,nc_play_all_down
 300  81DF
 301  81DF
 302  81DF CD 0F 87     	call format_name
 303  81E2
 304  81E2              nc_play_1
 305  81E2              	;проверка расширения ;VGM
 306  81E2 CD 32 83     	call check_vgm
 307  81E5 C2 FB 81     	jp nz,nc_play_2
 308  81E8
 309  81E8 3E 76        	ld a,"v"
 310  81EA CD F7 8F     	call start_gplay
 311  81ED
 312  81ED              nc_play_1_next
 313  81ED
 314  81ED FE 73        	cp "s"
 315  81EF 28 40        	jr z,nc_play_ex
 316  81F1 FE 53        	cp "S"
 317  81F3 28 3C        	jr z,nc_play_ex
 318  81F5 FE 18        	cp 24 ;break
 319  81F7 28 38        	jr z,nc_play_ex
 320  81F9
 321  81F9 18 39        	jr nc_play_all_down
 322  81FB
 323  81FB              nc_play_2
 324  81FB              	;проверка расширения ;VGZ
 325  81FB CD 51 83     	call check_vgz
 326  81FE C2 08 82     	jp nz,nc_play_3
 327  8201
 328  8201 3E 7A        	ld a,"z"
 329  8203 CD F7 8F     	call start_gplay
 330  8206
 331  8206 18 E5        	jr nc_play_1_next
 332  8208
 333  8208
 334  8208              nc_play_3
 335  8208              	;проверка расширения MOD
 336  8208 CD 8F 83     	call check_mod
 337  820B C2 15 82     	jp nz,nc_play_4
 338  820E
 339  820E 3E 6D        	ld a,"m"
 340  8210 CD F7 8F     	call start_gplay
 341  8213
 342  8213 18 D8        	jr nc_play_1_next
 343  8215
 344  8215
 345  8215              nc_play_4
 346  8215              	;проверка расширения pt2
 347  8215 CD AE 83     	call check_pt2
 348  8218 C2 22 82     	jp nz,nc_play_5
 349  821B
 350  821B 3E 32        	ld a,"2"
 351  821D CD F7 8F     	call start_gplay
 352  8220
 353  8220 18 CB        	jr nc_play_1_next
 354  8222
 355  8222              nc_play_5
 356  8222              	;проверка расширения pt3
 357  8222 CD CD 83     	call check_pt3
 358  8225 C2 2F 82     	jp nz,nc_play_6
 359  8228
 360  8228 3E 33        	ld a,"3"
 361  822A CD F7 8F     	call start_gplay
 362  822D
 363  822D 18 BE        	jr nc_play_1_next
 364  822F
 365  822F
 366  822F              nc_play_6
 367  822F 18 03        	jr nc_play_all_down
 368  8231
 369  8231
 370  8231
 371  8231              nc_play_ex
 372  8231 C3 84 80     	jp nc_wait
 373  8234
 374  8234
 375  8234              nc_play_all_down ;вниз по списку
 376  8234 ED 4B 58 A4  	ld bc,(file_r_num_cur)
 377  8238 C5           	push bc
 378  8239 CD 66 82     	call key_down
 379  823C CD EC 83     	call print_panel_r ;обновить каталог
 380  823F C1           	pop bc
 381  8240 2A 58 A4     	ld hl,(file_r_num_cur)
 382  8243 A7           	and a
 383  8244 ED 42        	sbc hl,bc ;если не сдвинулась позиция, то всё
 384  8246 28 E9        	jr z,nc_play_ex
 385  8248 C3 C6 81     	jp nc_play_all
 386  824B
 387  824B
 388  824B
 389  824B
 390  824B
 391  824B
 392  824B
 393  824B
 394  824B              key_enter_dir
 395  824B              	;тут открытие папки
 396  824B
 397  824B              	;call format_name_dir
 398  824B EB           	ex de,hl ;de - дескриптор для открытия
 399  824C 21 4A A3     	ld hl,dir_name_cur
 400  824F              	OS_DIR_OPEN
 400  824F 0E 27       >    ld c,#27
 400  8251 E7          >    rst #20
 401  8252 DA C3 81     	jp c,key_enter_ex ;если ошибка, ничего не делаем
 402  8255
 403  8255 E1           	pop hl ;отменить возврат
 404  8256 C3 48 80     	jp start_nc_warm ;перезагрузить папку
 405  8259
 406  8259
 407  8259              ; format_name_dir
 408  8259              	; push hl
 409  8259              	; ld hl,file_name_cur
 410  8259              	; ld de,file_name_cur+1 ;почистить
 411  8259              	; ld bc,256-1
 412  8259              	; ld (hl),0
 413  8259              	; ldir
 414  8259
 415  8259              	; pop hl
 416  8259
 417  8259              	; ld de,file_name_cur ;куда
 418  8259              	; ld bc,#08ff
 419  8259              ; format_name_dir_cl
 420  8259              	; ld a,(hl)
 421  8259              	; cp " "+1
 422  8259              	; jr c,format_name_dir_skip
 423  8259              	; ldi
 424  8259              	; djnz format_name_dir_cl
 425  8259              ; format_name_dir_skip
 426  8259              	; ld a,'/'
 427  8259              	; ld (de),a
 428  8259              	; ret
 429  8259
 430  8259               ;вычислить дескриптор текущего элемента справа
 431  8259              calc_deskr
 432  8259 29           	add hl,hl ;*2
 433  825A 01 A5 A5     	ld bc,cat_index
 434  825D 09           	add hl,bc
 435  825E 5E           	ld e,(hl)
 436  825F 23           	inc hl
 437  8260 56           	ld d,(hl)
 438  8261 EB           	ex de,hl ;hl - адрес элемента
 439  8262 E5           	push hl
 440  8263 DD E1        	pop ix ;ix- адрес элемента
 441  8265 C9           	ret
 442  8266
 443  8266
 444  8266
 445  8266
 446  8266              key_down
 447  8266 2A 46 A2     	ld hl,(file_r_all)
 448  8269 7D           	ld a,l
 449  826A B4           	or h
 450  826B CA AA 82     	jp z,key_down_ex ;защита
 451  826E
 452  826E ED 4B 58 A4  	ld bc,(file_r_num_cur)
 453  8272 ED 43 5A A4  	ld (file_r_num_old),bc ;запомнить что было
 454  8276 03           	inc bc
 455  8277 2A 46 A2     	ld hl,(file_r_all)
 456  827A              	;если не больше чем всего
 457  827A A7           	and a
 458  827B ED 42        	sbc hl,bc
 459  827D 38 2B        	jr c,key_down_skip
 460  827F 28 29        	jr z,key_down_skip
 461  8281              	;прибавить
 462  8281 ED 43 58 A4  	ld (file_r_num_cur),bc
 463  8285
 464  8285              	;теперь передвинуть фокус, если надо
 465  8285 2A 48 A2     	ld hl,(file_r_cur_focus)
 466  8288 01 16 00     	ld bc,panel_hight
 467  828B 09           	add hl,bc ;прибавить количество видимых
 468  828C ED 4B 58 A4  	ld bc,(file_r_num_cur)
 469  8290 A7           	and a
 470  8291 ED 42        	sbc hl,bc ;вычесть положение курсора
 471  8293 28 02        	jr z,key_down_change_focus_yes
 472  8295 30 10        	jr nc,key_down_change_focus_no
 473  8297              key_down_change_focus_yes
 474  8297              	;передвинуть фокус
 475  8297 2A 48 A2     	ld hl,(file_r_cur_focus)
 476  829A 23           	inc hl
 477  829B 22 48 A2     	ld (file_r_cur_focus),hl
 478  829E
 479  829E 3E 01        	ld a,1
 480  82A0 32 72 A4     	ld (print_panel_r_flag),a ;напечатать всё снова
 481  82A3
 482  82A3 3A 5E A4     	ld a,(key_pressed)
 483  82A6 C9           	ret
 484  82A7
 485  82A7              key_down_change_focus_no
 486  82A7
 487  82A7              	;call print_panel_r ;обновить каталог
 488  82A7
 489  82A7 CD 24 84     	call print_panel_r_cursor ;обновить только курсор
 490  82AA
 491  82AA              key_down_ex
 492  82AA
 493  82AA              key_down_skip
 494  82AA 3A 5E A4     	ld a,(key_pressed)
 495  82AD C9           	ret
 496  82AE
 497  82AE
 498  82AE
 499  82AE              key_up ;вверх
 500  82AE 2A 46 A2     	ld hl,(file_r_all)
 501  82B1 7D           	ld a,l
 502  82B2 B4           	or h
 503  82B3 CA E7 82     	jp z,key_up_ex ;защита
 504  82B6
 505  82B6 2A 58 A4     	ld hl,(file_r_num_cur)
 506  82B9 22 5A A4     	ld (file_r_num_old),hl
 507  82BC 7D           	ld a,l
 508  82BD B4           	or h
 509  82BE 28 27        	jr z,key_up_skip
 510  82C0 2B           	dec hl
 511  82C1 22 58 A4     	ld (file_r_num_cur),hl
 512  82C4
 513  82C4              	;теперь передвинуть фокус, если надо
 514  82C4 2A 58 A4     	ld hl,(file_r_num_cur)
 515  82C7              	; ld bc,panel_hight
 516  82C7              	; add hl,bc ;прибавить количество видимых
 517  82C7 ED 4B 48 A2  	ld bc,(file_r_cur_focus)
 518  82CB A7           	and a
 519  82CC ED 42        	sbc hl,bc ;вычесть положение курсора
 520  82CE              	;jr z,key_up_change_foces_yes
 521  82CE 30 14        	jr nc,key_up_change_foces_no
 522  82D0              key_up_change_foces_yes
 523  82D0              	;передвинуть фокус
 524  82D0 2A 48 A2     	ld hl,(file_r_cur_focus)
 525  82D3 7C           	ld a,h
 526  82D4 B5           	or l
 527  82D5 28 0D        	jr z,key_up_change_foces_no ;защита
 528  82D7 2B           	dec hl
 529  82D8 22 48 A2     	ld (file_r_cur_focus),hl
 530  82DB
 531  82DB 3E 01        	ld a,1
 532  82DD 32 72 A4     	ld (print_panel_r_flag),a	;напечатать снова всё
 533  82E0
 534  82E0 3A 5E A4     	ld a,(key_pressed)
 535  82E3 C9           	ret
 536  82E4
 537  82E4              key_up_change_foces_no
 538  82E4
 539  82E4              	;call print_panel_r ;обновить каталог
 540  82E4 CD 24 84     	call print_panel_r_cursor ;обновить только курсор
 541  82E7
 542  82E7              key_up_skip
 543  82E7
 544  82E7              key_up_ex
 545  82E7
 546  82E7 3A 5E A4     	ld a,(key_pressed)
 547  82EA C9           	ret
 548  82EB
 549  82EB
 550  82EB              key_left ;на страницу назад
 551  82EB 06 15        	ld b,panel_hight-1
 552  82ED              key_left_cl
 553  82ED C5           	push bc
 554  82EE CD AE 82     	call key_up
 555  82F1 C1           	pop bc
 556  82F2 10 F9        	djnz key_left_cl
 557  82F4 3E 01        	ld a,1
 558  82F6 32 72 A4     	ld (print_panel_r_flag),a
 559  82F9 3A 5E A4     	ld a,(key_pressed)
 560  82FC C9           	ret
 561  82FD
 562  82FD
 563  82FD
 564  82FD              key_right ;на страницу вперёд
 565  82FD 06 15        	ld b,panel_hight-1
 566  82FF              key_right_cl
 567  82FF C5           	push bc
 568  8300 CD 66 82     	call key_down
 569  8303 C1           	pop bc
 570  8304 10 F9        	djnz key_right_cl
 571  8306 3E 01        	ld a,1
 572  8308 32 72 A4     	ld (print_panel_r_flag),a
 573  830B 3A 5E A4     	ld a,(key_pressed)
 574  830E C9           	ret
 575  830F
 576  830F
 577  830F
 578  830F              exit ;выход в DOS
 579  830F AF           	xor a
 580  8310              	OS_PROC_CLOSE
 580  8310 0E 13       >    ld c,#13
 580  8312 E7          >    rst #20
 581  8313
 582  8313
 583  8313
 584  8313              check_apg ;проверка на расширение APG
 585  8313 DD 7E 08     	ld a,(ix+8)
 586  8316 FE 61        	cp "a"
 587  8318 28 03        	jr z,check_apg1
 588  831A FE 41        	cp "A"
 589  831C C0           	ret nz
 590  831D              check_apg1
 591  831D DD 7E 09     	ld a,(ix+9)
 592  8320 FE 70        	cp "p"
 593  8322 28 03        	jr z,check_apg2
 594  8324 FE 50        	cp "P"
 595  8326 C0           	ret nz
 596  8327              check_apg2
 597  8327 DD 7E 0A     	ld a,(ix+10)
 598  832A FE 67        	cp "g"
 599  832C C8           	ret z
 600  832D FE 47        	cp "G"
 601  832F C0           	ret nz
 602  8330 AF           	xor a ;равен
 603  8331 C9           	ret
 604  8332
 605  8332
 606  8332              check_vgm ;проверка на расширение VGM
 607  8332 DD 7E 08     	ld a,(ix+8)
 608  8335 FE 76        	cp "v"
 609  8337 28 03        	jr z,check_vgm1
 610  8339 FE 56        	cp "V"
 611  833B C0           	ret nz
 612  833C              check_vgm1
 613  833C DD 7E 09     	ld a,(ix+9)
 614  833F FE 67        	cp "g"
 615  8341 28 03        	jr z,check_vgm2
 616  8343 FE 47        	cp "G"
 617  8345 C0           	ret nz
 618  8346              check_vgm2
 619  8346 DD 7E 0A     	ld a,(ix+10)
 620  8349 FE 6D        	cp "m"
 621  834B C8           	ret z
 622  834C FE 4D        	cp "M"
 623  834E C0           	ret nz
 624  834F AF           	xor a ;равен
 625  8350 C9           	ret
 626  8351
 627  8351              check_vgz ;проверка на расширение VGZ
 628  8351 DD 7E 08     	ld a,(ix+8)
 629  8354 FE 76        	cp "v"
 630  8356 28 03        	jr z,check_vgz1
 631  8358 FE 56        	cp "V"
 632  835A C0           	ret nz
 633  835B              check_vgz1
 634  835B DD 7E 09     	ld a,(ix+9)
 635  835E FE 67        	cp "g"
 636  8360 28 03        	jr z,check_vgz2
 637  8362 FE 47        	cp "G"
 638  8364 C0           	ret nz
 639  8365              check_vgz2
 640  8365 DD 7E 0A     	ld a,(ix+10)
 641  8368 FE 7A        	cp "z"
 642  836A C8           	ret z
 643  836B FE 5A        	cp "Z"
 644  836D C0           	ret nz
 645  836E AF           	xor a ;равен
 646  836F C9           	ret
 647  8370
 648  8370
 649  8370              check_scr ;проверка на расширение SCR
 650  8370 DD 7E 08     	ld a,(ix+8)
 651  8373 FE 73        	cp "s"
 652  8375 28 03        	jr z,check_scr1
 653  8377 FE 53        	cp "S"
 654  8379 C0           	ret nz
 655  837A              check_scr1
 656  837A DD 7E 09     	ld a,(ix+9)
 657  837D FE 63        	cp "c"
 658  837F 28 03        	jr z,check_scr2
 659  8381 FE 43        	cp "C"
 660  8383 C0           	ret nz
 661  8384              check_scr2
 662  8384 DD 7E 0A     	ld a,(ix+10)
 663  8387 FE 72        	cp "r"
 664  8389 C8           	ret z
 665  838A FE 52        	cp "R"
 666  838C C0           	ret nz
 667  838D AF           	xor a ;равен
 668  838E C9           	ret
 669  838F
 670  838F              check_mod ;проверка на расширение MOD
 671  838F DD 7E 08     	ld a,(ix+8)
 672  8392 FE 6D        	cp "m"
 673  8394 28 03        	jr z,check_mod1
 674  8396 FE 4D        	cp "M"
 675  8398 C0           	ret nz
 676  8399              check_mod1
 677  8399 DD 7E 09     	ld a,(ix+9)
 678  839C FE 6F        	cp "o"
 679  839E 28 03        	jr z,check_mod2
 680  83A0 FE 4F        	cp "O"
 681  83A2 C0           	ret nz
 682  83A3              check_mod2
 683  83A3 DD 7E 0A     	ld a,(ix+10)
 684  83A6 FE 64        	cp "d"
 685  83A8 C8           	ret z
 686  83A9 FE 44        	cp "D"
 687  83AB C0           	ret nz
 688  83AC AF           	xor a ;равен
 689  83AD C9           	ret
 690  83AE
 691  83AE
 692  83AE              check_pt2 ;проверка на расширение pt2
 693  83AE DD 7E 08     	ld a,(ix+8)
 694  83B1 FE 70        	cp "p"
 695  83B3 28 03        	jr z,check_pt21
 696  83B5 FE 50        	cp "P"
 697  83B7 C0           	ret nz
 698  83B8              check_pt21
 699  83B8 DD 7E 09     	ld a,(ix+9)
 700  83BB FE 74        	cp "t"
 701  83BD 28 03        	jr z,check_pt22
 702  83BF FE 54        	cp "T"
 703  83C1 C0           	ret nz
 704  83C2              check_pt22
 705  83C2 DD 7E 0A     	ld a,(ix+10)
 706  83C5 FE 32        	cp "2"
 707  83C7 C8           	ret z
 708  83C8 FE 32        	cp "2"
 709  83CA C0           	ret nz
 710  83CB AF           	xor a ;равен
 711  83CC C9           	ret
 712  83CD
 713  83CD              check_pt3 ;проверка на расширение pt3
 714  83CD DD 7E 08     	ld a,(ix+8)
 715  83D0 FE 70        	cp "p"
 716  83D2 28 03        	jr z,check_pt31
 717  83D4 FE 50        	cp "P"
 718  83D6 C0           	ret nz
 719  83D7              check_pt31
 720  83D7 DD 7E 09     	ld a,(ix+9)
 721  83DA FE 74        	cp "t"
 722  83DC 28 03        	jr z,check_pt32
 723  83DE FE 54        	cp "T"
 724  83E0 C0           	ret nz
 725  83E1              check_pt32
 726  83E1 DD 7E 0A     	ld a,(ix+10)
 727  83E4 FE 33        	cp "3"
 728  83E6 C8           	ret z
 729  83E7 FE 33        	cp "3"
 730  83E9 C0           	ret nz
 731  83EA AF           	xor a ;равен
 732  83EB C9           	ret
 733  83EC
 734  83EC
 735  83EC
 736  83EC
 737  83EC              print_panel_r ;печать правой панели
 738  83EC              	;ld ix,buffer_cat
 739  83EC FD 2A 46 A2  	ld iy,(file_r_all) ;всего файлов
 740  83F0 FD 7D        	ld a,iyl
 741  83F2 FD B4        	or iyh
 742  83F4 C8           	ret z ;защита если 0
 743  83F5 11 29 01     	ld de,panel_r_xy ;координаты yx
 744  83F8 06 16        	ld b,panel_hight ;высота панели
 745  83FA FD 2A 48 A2  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 746  83FE              print_panel_r_cl ;цикл
 747  83FE C5           	push bc
 748  83FF D5           	push de ;xy
 749  8400              	OS_SET_XY
 749  8400 0E 01       >    ld c,#01
 749  8402 E7          >    rst #20
 750  8403
 751  8403              	;получить адрес элемента
 752  8403 FD E5        	push iy
 753  8405 E1           	pop hl
 754  8406 CD 59 82     	call calc_deskr
 755  8409
 756  8409 CD 7F 84     	call print_file_info ;напечатать строку
 757  840C              ;print_panel_r_skip
 758  840C D1           	pop de
 759  840D 14           	inc d ;y++
 760  840E FD 23        	inc iy ;текущий файл
 761  8410              	;проверка на конец каталога
 762  8410 2A 46 A2     	ld hl,(file_r_all)
 763  8413 FD E5        	push iy
 764  8415 C1           	pop bc
 765  8416 A7           	and a
 766  8417 ED 42        	sbc hl,bc
 767  8419 C1           	pop bc
 768  841A 38 07        	jr c,print_panel_r_ex2
 769  841C 28 05        	jr z,print_panel_r_ex2
 770  841E 10 DE        	djnz print_panel_r_cl
 771  8420 C9           	ret
 772  8421              print_panel_r_ex
 773  8421 D1           	pop de
 774  8422 C1           	pop bc
 775  8423              print_panel_r_ex2
 776  8423              	;тут, возможно, надо допечатать пустые строки
 777  8423 C9           	ret
 778  8424
 779  8424
 780  8424
 781  8424
 782  8424
 783  8424
 784  8424
 785  8424
 786  8424              print_panel_r_cursor ;печать только строки с курсором в правой панели, для скорости навигации
 787  8424 ED 4B 5A A4  	ld bc,(file_r_num_old) ;старая позиция
 788  8428 ED 43 5C A4  	ld (file_r_num_tmp),bc ;позиция курсора для печати
 789  842C CD 3B 84     	call print_panel_r_cursor_one ;"стереть" предыдущее
 790  842F ED 4B 58 A4  	ld bc,(file_r_num_cur) ;позиция текущая
 791  8433 ED 43 5C A4  	ld (file_r_num_tmp),bc ;позиция курсора для печати
 792  8437 CD 3B 84     	call print_panel_r_cursor_one ;напечатать новое
 793  843A C9           	ret
 794  843B
 795  843B
 796  843B              print_panel_r_cursor_one
 797  843B              	;ld ix,buffer_cat
 798  843B FD 2A 46 A2  	ld iy,(file_r_all) ;всего файлов
 799  843F FD 7D        	ld a,iyl
 800  8441 FD B4        	or iyh
 801  8443 C8           	ret z ;защита если 0
 802  8444 11 29 01     	ld de,panel_r_xy ;координаты yx
 803  8447 06 16        	ld b,panel_hight ;высота панели
 804  8449 FD 2A 48 A2  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 805  844D              print_panel_r_cursor_cl ;цикл
 806  844D C5           	push bc
 807  844E D5           	push de
 808  844F              	;проверить дошли ли до курсора
 809  844F ED 4B 5C A4  	ld bc,(file_r_num_tmp) ;позиция курсора справа
 810  8453 FD E5        	push iy
 811  8455 E1           	pop hl
 812  8456 A7           	and a
 813  8457 ED 42        	sbc hl,bc ;сравнить
 814  8459 20 0C        	jr nz,print_panel_r_cursor_skip
 815  845B              	;напечатать курсор
 816  845B              	;push bc
 817  845B              	;push de ;xy
 818  845B              	OS_SET_XY
 818  845B 0E 01       >    ld c,#01
 818  845D E7          >    rst #20
 819  845E
 820  845E              	;получить адрес элемента
 821  845E FD E5        	push iy
 822  8460 E1           	pop hl
 823  8461 CD 59 82     	call calc_deskr
 824  8464
 825  8464 CD 7F 84     	call print_file_info ;напечатать строку
 826  8467              print_panel_r_cursor_skip
 827  8467 D1           	pop de
 828  8468 14           	inc d ;y++
 829  8469 FD 23        	inc iy ;текущий файл
 830  846B              	;проверка на конец каталога
 831  846B 2A 46 A2     	ld hl,(file_r_all)
 832  846E FD E5        	push iy
 833  8470 C1           	pop bc
 834  8471 A7           	and a
 835  8472 ED 42        	sbc hl,bc
 836  8474 C1           	pop bc
 837  8475 38 07        	jr c,print_panel_r_cursor_ex2
 838  8477 28 05        	jr z,print_panel_r_cursor_ex2
 839  8479 10 D2        	djnz print_panel_r_cursor_cl
 840  847B C9           	ret
 841  847C              print_panel_r_cursor_ex
 842  847C D1           	pop de
 843  847D C1           	pop bc
 844  847E              print_panel_r_cursor_ex2
 845  847E              	;тут, возможно, надо допечатать пустые строки
 846  847E C9           	ret
 847  847F
 848  847F
 849  847F
 850  847F
 851  847F
 852  847F
 853  847F
 854  847F
 855  847F
 856  847F              print_file_info ;печать строки о файле
 857  847F 3A 0E 87     	ld a,(LFN_enable_flag)
 858  8482 B7           	or a
 859  8483 28 4D        	jr z,print_file_info_SFN
 860  8485
 861  8485
 862  8485
 863  8485              print_file_info_LFN ;печать длинного имени
 864  8485              	;узнать номер записи
 865  8485 01 00 C0     	ld bc,#c000
 866  8488 A7           	and a
 867  8489 ED 42        	sbc hl,bc
 868  848B              ;разделить на 32
 869  848B CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 870  848D CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 871  848F CB 3C        	srl h ; /4
 872  8491 CB 1D        	rr l ;
 873  8493 CB 3C        	srl h ; /8
 874  8495 CB 1D        	rr l ;
 875  8497 CB 3C        	srl h ; /16
 876  8499 CB 1D        	rr l ;
 877  849B CB 3C        	srl h ; /32
 878  849D CB 1D        	rr l ;
 879  849F
 880  849F
 881  849F EB           	ex de,hl ;de - порядковый номер записи
 882  84A0
 883  84A0 21 A5 AD     	ld hl,file_info_string ;куда
 884  84A3              	OS_GET_LFN ;получить длинное имя
 884  84A3 0E 2A       >    ld c,#2a
 884  84A5 E7          >    rst #20
 885  84A6
 886  84A6 CD FA 84     	call get_color_item
 887  84A9
 888  84A9 06 0C        	ld b,#c
 889  84AB              	OS_SET_COLOR
 889  84AB 0E 06       >    ld c,#06
 889  84AD E7          >    rst #20
 890  84AE
 891  84AE              	;печать не длиннее 80/2 символов
 892  84AE 21 A5 AD     	ld hl,file_info_string
 893  84B1 06 26        	ld b,80/2-2
 894  84B3 0E 28        	ld c,40 ;колонка
 895  84B5              print_file_info_LFN_cl
 896  84B5 E5           	push hl
 897  84B6 C5           	push bc
 898  84B7 7E           	ld a,(hl)
 899  84B8 B7           	or a
 900  84B9 28 09        	jr z,print_file_info_LFN_cl_ex
 901  84BB              	OS_PRINT_CHARF
 901  84BB D7          >	rst #10
 902  84BC C1           	pop bc
 903  84BD 0C           	inc c
 904  84BE E1           	pop hl
 905  84BF 23           	inc hl
 906  84C0 10 F3        	djnz print_file_info_LFN_cl
 907  84C2 18 02        	jr print_file_info_LFN_ex
 908  84C4              print_file_info_LFN_cl_ex
 909  84C4 C1           	pop bc
 910  84C5 E1           	pop hl
 911  84C6              print_file_info_LFN_ex
 912  84C6              	;допечатать пробелы до правого края, зависит от длины имени
 913  84C6              print_file_info_LFN_cl2
 914  84C6 79           	ld a,c
 915  84C7 FE 4E        	cp 80-2
 916  84C9 D0           	ret nc
 917  84CA C5           	push bc
 918  84CB 3E 20        	ld a,' '
 919  84CD              	OS_PRINT_CHARF
 919  84CD D7          >	rst #10
 920  84CE C1           	pop bc
 921  84CF 0C           	inc c
 922  84D0 18 F4        	jr print_file_info_LFN_cl2
 923  84D2
 924  84D2
 925  84D2
 926  84D2              print_file_info_SFN ;печать короткого имени
 927  84D2 11 A5 AD     	ld de,file_info_string ;скопировать
 928  84D5 01 08 00     	ld bc,8 ;file_info_lenght
 929  84D8 ED B0        	ldir
 930  84DA 3E 20        	ld a,' '
 931  84DC 12           	ld (de),a
 932  84DD 13           	inc de
 933  84DE 01 03 00     	ld bc,3
 934  84E1 ED B0        	ldir
 935  84E3 AF           	xor a
 936  84E4 12           	ld (de),a
 937  84E5
 938  84E5 CD FA 84     	call get_color_item
 939  84E8
 940  84E8 06 0C        	ld b,#c
 941  84EA              	OS_SET_COLOR
 941  84EA 0E 06       >    ld c,#06
 941  84EC E7          >    rst #20
 942  84ED 21 A5 AD     	ld hl,file_info_string
 943  84F0              	OS_PRINTZ
 943  84F0 0E 09       >    ld c,#09
 943  84F2 E7          >    rst #20
 944  84F3              	;допечатать пробелы до правого края, длина имени постоянная
 945  84F3 21 73 A4     	ld hl,file_info_string_SFN_end
 946  84F6              	OS_PRINTZ
 946  84F6 0E 09       >    ld c,#09
 946  84F8 E7          >    rst #20
 947  84F9 C9           	ret
 948  84FA
 949  84FA
 950  84FA
 951  84FA              get_color_item ;получить цвет элемента
 952  84FA              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 953  84FA              ;вых: A - цвет
 954  84FA ED 4B 58 A4  	ld bc,(file_r_num_cur) ;позиция курсора справа
 955  84FE FD E5        	push iy
 956  8500 E1           	pop hl
 957  8501 A7           	and a
 958  8502 ED 42        	sbc hl,bc ;сравнить
 959  8504 28 11        	jr z,get_color_item_no_cursor
 960  8506              	;цвета курсора
 961  8506 3E 0E        	ld a,color_dir ;простая
 962  8508 32 32 85     	ld (get_color_item_dir+1),a
 963  850B 3E 0C        	ld a,color_apg ;простая
 964  850D 32 3A 85     	ld (get_color_item_apg+1),a
 965  8510 3E 0F        	ld a,color_backgr ;простая
 966  8512 32 3D 85     	ld (get_color_item_backgr+1),a
 967  8515 18 0F        	jr get_color_item_set
 968  8517
 969  8517              get_color_item_no_cursor
 970  8517              	;цвета обычные
 971  8517 3E 28        	ld a,color_dir_hi ;под курсором
 972  8519 32 32 85     	ld (get_color_item_dir+1),a
 973  851C 3E 28        	ld a,color_apg_hi ;под курсором
 974  851E 32 3A 85     	ld (get_color_item_apg+1),a
 975  8521 3E 28        	ld a,color_backgr_hi ;под курсором
 976  8523 32 3D 85     	ld (get_color_item_backgr+1),a
 977  8526
 978  8526              get_color_item_set
 979  8526              	;задать цвет
 980  8526 DD 7E 0B     	ld a,(ix+#0b)
 981  8529 FE 10        	cp #10 ;признак каталога
 982  852B 28 04        	jr z,get_color_item_dir
 983  852D FE 30        	cp #30 ;признак каталога
 984  852F 20 03        	jr nz,get_color_item_no_dir
 985  8531              	;если папка
 986  8531              get_color_item_dir
 987  8531 3E 00        	ld a,0
 988  8533 C9           	ret
 989  8534
 990  8534              get_color_item_no_dir
 991  8534 CD 13 83     	call check_apg ;расширение apg
 992  8537 20 03        	jr nz,get_color_item_no_apg
 993  8539              	;если приложение
 994  8539              get_color_item_apg
 995  8539 3E 00        	ld a,0
 996  853B C9           	ret
 997  853C
 998  853C              get_color_item_no_apg
 999  853C              	;если обычный файл
1000  853C              get_color_item_backgr
1001  853C 3E 00        	ld a,0
1002  853E C9           	ret
1003  853F
1004  853F
1005  853F
1006  853F              ; format_dir ;подготовить каталог, убрать лишнее
1007  853F              	; ; ld a,2
1008  853F              	; ; out (254),a
1009  853F              	; ld iy,0 ;счётчик файлов
1010  853F              	; ;найти конец каталога
1011  853F              	; ld hl,buffer_cat
1012  853F              	; ld a,(hl)
1013  853F              	; or a
1014  853F              	; ret z ;защита
1015  853F              	; ld bc,32
1016  853F              ; format_dir_prep_cl
1017  853F              	; ld a,(hl)
1018  853F              	; or a
1019  853F              	; jr z,format_dir_prep_ex
1020  853F              	; add hl,bc
1021  853F              	; ld a,h
1022  853F              	; or a ;если вышли за границу
1023  853F              	; jr z,format_dir_prep_ex
1024  853F              	; jr format_dir_prep_cl
1025  853F              ; format_dir_prep_ex
1026  853F              	; ld bc,32
1027  853F              	; and a
1028  853F              	; sbc hl,bc
1029  853F              	; ld (format_dir_top),hl ;конец каталога
1030  853F
1031  853F
1032  853F
1033  853F              	; ld ix,buffer_cat
1034  853F              	; ;ld b,panel_hight ;высота панели
1035  853F              ; format_dir_cl ;цикл
1036  853F              	; ld a,(ix)
1037  853F              	; or a ;конец каталога
1038  853F              	; jr z,format_dir_ex
1039  853F              	; cp #e5 ;удалённый
1040  853F              	; jr z,format_dir_skip
1041  853F              	; cp #05 ;удалённый
1042  853F              	; jr z,format_dir_skip
1043  853F              	; ld a,(ix+#0b)
1044  853F              	; cp #0f ;длинный
1045  853F              	; jr z,format_dir_skip
1046  853F
1047  853F              	; ;проверка на папку "." (этот же каталог)
1048  853F              	; ld a,(ix+#00)
1049  853F              	; cp "." ;
1050  853F              	; jr nz,format_dir_add
1051  853F              	; ld a,(ix+#01)
1052  853F              	; cp " " ;
1053  853F              	; jr z,format_dir_skip
1054  853F
1055  853F
1056  853F              ; format_dir_add
1057  853F              	; inc iy ;++
1058  853F              	; ld bc,32 ;на другой элемент каталога
1059  853F              	; add ix,bc
1060  853F              	; ld a,ixh
1061  853F              	; or a ;если вышли за границу
1062  853F              	; jr z,format_dir_ex
1063  853F              	; jr format_dir_cl
1064  853F              ; format_dir_skip
1065  853F              	; ;сдвинуть элементы вниз
1066  853F              	; push ix
1067  853F              	; push ix
1068  853F              	; pop hl
1069  853F              	; pop de ;куда
1070  853F              	; ld hl,(format_dir_top) ;0-32
1071  853F              	; and a
1072  853F              	; sbc hl,de
1073  853F              	; ld b,h
1074  853F              	; ld c,l ;длина
1075  853F              	; push bc
1076  853F
1077  853F              	; push ix
1078  853F              	; pop hl ;откуда
1079  853F              	; ld bc,32 ;на другой элемент каталога
1080  853F              	; add hl,bc ;откуда
1081  853F
1082  853F              	; pop bc
1083  853F              	; ldir
1084  853F
1085  853F              	; xor a
1086  853F              	; ld (de),a ;очистить ненужный элемент
1087  853F
1088  853F              	; jr format_dir_cl
1089  853F
1090  853F              ; format_dir_ex
1091  853F              	; ld (file_r_all),iy
1092  853F              	; ;здесь почистить остаток каталога
1093  853F              	; ; ld a,0
1094  853F              	; ; out (254),a
1095  853F              	; ret
1096  853F              ; format_dir_top	dw 0 ;временно конец гаталога
1097  853F
1098  853F
1099  853F
1100  853F
1101  853F
1102  853F              sort_dir ;сортировка каталога с помощью построения индекса
1103  853F DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1104  8543 DD 7E 00     	ld a,(ix)
1105  8546 B7           	or a
1106  8547 C8           	ret z ;если пусто, выход
1107  8548 FD 21 00 00  	ld iy,0 ;счётчик всего файлов
1108  854C
1109  854C
1110  854C 3A F1 86     	ld a,(sort_enable_flag)
1111  854F B7           	or a
1112  8550 CA B7 85     	jp z,sort_dir_no ;если без сортировки
1113  8553
1114  8553 21 A5 A5     	ld hl,cat_index
1115  8556 22 B3 85     	ld (sort_item_adr_end),hl
1116  8559
1117  8559 21 A5 A9     	ld hl,cat_index_2 ;таблица - индекс 2
1118  855C CD 36 86     	call sort_dir_one ;проход по папкам
1119  855F
1120  855F FD 7C        	ld a,iyh
1121  8561 FD B5        	or iyl
1122  8563 28 19        	jr z,sort_dir_skip ;если не было папок
1123  8565
1124  8565 DD 21 A5 A9  	ld ix,cat_index_2
1125  8569 CD 80 86     	call sort_index ;отсортировать по алфавиту
1126  856C              	;перенести индекс в основной
1127  856C FD E5        	push iy
1128  856E E1           	pop hl ;сколько
1129  856F 29           	add hl,hl ;*2 по 2 байта на элемент
1130  8570 E5           	push hl
1131  8571 C1           	pop bc
1132  8572 21 A5 A9     	ld hl,cat_index_2
1133  8575 11 A5 A5     	ld de,cat_index
1134  8578 ED B0        	ldir
1135  857A ED 53 B3 85  	ld (sort_item_adr_end),de ;запомнить адрес последнего
1136  857E
1137  857E              sort_dir_skip
1138  857E FD 22 B5 85  	ld (sort_item_count),iy
1139  8582 FD 21 00 00  	ld iy,0 ;счётчик всего файлов
1140  8586 21 A5 A9     	ld hl,cat_index_2 ;таблица - индекс 2
1141  8589 CD FA 85     	call sort_file_one ;проход по файлам
1142  858C FD 7C        	ld a,iyh
1143  858E FD B5        	or iyl
1144  8590 28 16        	jr z,sort_file_skip ;если не было файлов
1145  8592
1146  8592 DD 21 A5 A9  	ld ix,cat_index_2
1147  8596 CD 80 86     	call sort_index ;отсортировать по алфавиту
1148  8599              	;добавить индекс к основному
1149  8599 FD E5        	push iy
1150  859B E1           	pop hl ;сколько
1151  859C 29           	add hl,hl ;*2 по 2 байта на элемент
1152  859D E5           	push hl
1153  859E C1           	pop bc
1154  859F 21 A5 A9     	ld hl,cat_index_2
1155  85A2 ED 5B B3 85  	ld de,(sort_item_adr_end)
1156  85A6 ED B0        	ldir
1157  85A8
1158  85A8              sort_file_skip
1159  85A8              	;скорректировать количество
1160  85A8 ED 4B B5 85  	ld bc,(sort_item_count)
1161  85AC FD 09        	add iy,bc
1162  85AE FD 22 46 A2  	ld (file_r_all),iy
1163  85B2 C9           	ret
1164  85B3
1165  85B3 00 00        sort_item_adr_end dw 0; временно
1166  85B5 00 00        sort_item_count dw 0; временно
1167  85B7
1168  85B7
1169  85B7
1170  85B7              ;без сортировки
1171  85B7              sort_dir_no
1172  85B7 21 A5 A5     	ld hl,cat_index ;таблица - индекс
1173  85BA DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1174  85BE              sort_dir_no_cl ;цикл по каталогам
1175  85BE DD 7E 00     	ld a,(ix)
1176  85C1 B7           	or a ;конец каталога
1177  85C2 28 31        	jr z,sort_dir_no_ex
1178  85C4 FE E5        	cp #e5 ;удалённый
1179  85C6 28 22        	jr z,sort_dir_no_skip
1180  85C8 FE 05        	cp #05 ;удалённый
1181  85CA 28 1E        	jr z,sort_dir_no_skip
1182  85CC DD 7E 0B     	ld a,(ix+#0b)
1183  85CF FE 0F        	cp #0f ;длинный
1184  85D1 28 17        	jr z,sort_dir_no_skip
1185  85D3
1186  85D3              	;проверка на папку "." (этот же каталог)
1187  85D3 DD 7E 00     	ld a,(ix+#00)
1188  85D6 FE 2E        	cp "." ;
1189  85D8 20 07        	jr nz,sort_dir_no_add
1190  85DA DD 7E 01     	ld a,(ix+#01)
1191  85DD FE 20        	cp " " ;
1192  85DF 28 09        	jr z,sort_dir_no_skip
1193  85E1
1194  85E1              sort_dir_no_add
1195  85E1 FD 23        	inc iy ;++
1196  85E3              	;записать в таблицу (индекс)
1197  85E3 DD E5        	push ix
1198  85E5 C1           	pop bc
1199  85E6 71           	ld (hl),c
1200  85E7 23           	inc hl
1201  85E8 70           	ld (hl),b
1202  85E9 23           	inc hl
1203  85EA
1204  85EA
1205  85EA              sort_dir_no_skip
1206  85EA 01 20 00     	ld bc,32
1207  85ED DD 09        	add ix,bc ;на следующий
1208  85EF DD 7C        	ld a,ixh ;проверка на конец буфера
1209  85F1 FE C0        	cp #c0
1210  85F3 30 C9        	jr nc,sort_dir_no_cl
1211  85F5
1212  85F5              sort_dir_no_ex
1213  85F5 FD 22 46 A2  	ld (file_r_all),iy
1214  85F9 C9           	ret
1215  85FA
1216  85FA
1217  85FA              ;сортировка файлов
1218  85FA              sort_file_one
1219  85FA DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1220  85FE              sort_file_one_cl ;цикл по каталогам
1221  85FE DD 7E 00     	ld a,(ix)
1222  8601 B7           	or a ;конец каталога
1223  8602 28 31        	jr z,sort_file_one_ex
1224  8604 DD 7E 0B     	ld a,(ix+#0b)
1225  8607 FE 10        	cp #10 ;признак каталога
1226  8609 28 1F        	jr z,sort_file_one_skip
1227  860B FE 30        	cp #30 ;признак каталога
1228  860D 28 1B        	jr z,sort_file_one_skip
1229  860F DD 7E 00     	ld a,(ix)
1230  8612 FE E5        	cp #e5 ;удалённый
1231  8614 28 14        	jr z,sort_file_one_skip
1232  8616 FE 05        	cp #05 ;удалённый
1233  8618 28 10        	jr z,sort_file_one_skip
1234  861A DD 7E 0B     	ld a,(ix+#0b)
1235  861D FE 0F        	cp #0f ;длинный
1236  861F 28 09        	jr z,sort_file_one_skip
1237  8621
1238  8621              	; ;проверка на папку "." (этот же каталог)
1239  8621              	; ld a,(ix+#00)
1240  8621              	; cp "." ;
1241  8621              	; jr nz,sort_file_one_add
1242  8621              	; ld a,(ix+#01)
1243  8621              	; cp " " ;
1244  8621              	; jr z,sort_file_one_skip
1245  8621
1246  8621
1247  8621              sort_file_one_add
1248  8621 FD 23        	inc iy ;++
1249  8623              	;записать в таблицу (индекс)
1250  8623 DD E5        	push ix
1251  8625 C1           	pop bc
1252  8626 71           	ld (hl),c
1253  8627 23           	inc hl
1254  8628 70           	ld (hl),b
1255  8629 23           	inc hl
1256  862A
1257  862A
1258  862A              sort_file_one_skip
1259  862A 01 20 00     	ld bc,32
1260  862D DD 09        	add ix,bc ;на следующий
1261  862F DD 7C        	ld a,ixh ;проверка на конец буфера
1262  8631 FE C0        	cp #c0
1263  8633 30 C9        	jr nc,sort_file_one_cl
1264  8635
1265  8635              sort_file_one_ex
1266  8635              	;ld (file_r_all),iy
1267  8635 C9           	ret
1268  8636
1269  8636
1270  8636
1271  8636
1272  8636
1273  8636              ;сортировка папок
1274  8636              sort_dir_one
1275  8636 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1276  863A              sort_dir_one_cl ;цикл по каталогам
1277  863A DD 7E 00     	ld a,(ix)
1278  863D B7           	or a ;конец каталога
1279  863E 28 3F        	jr z,sort_dir_one_ex
1280  8640 DD 7E 0B     	ld a,(ix+#0b)
1281  8643 FE 10        	cp #10 ;признак каталога
1282  8645 28 04        	jr z,sort_dir_one_skip_no
1283  8647 FE 30        	cp #30 ;признак каталога
1284  8649 20 29        	jr nz,sort_dir_one_skip
1285  864B              sort_dir_one_skip_no
1286  864B DD 7E 00     	ld a,(ix)
1287  864E FE E5        	cp #e5 ;удалённый
1288  8650 28 22        	jr z,sort_dir_one_skip
1289  8652 FE 05        	cp #05 ;удалённый
1290  8654 28 1E        	jr z,sort_dir_one_skip
1291  8656 DD 7E 0B     	ld a,(ix+#0b)
1292  8659 FE 0F        	cp #0f ;длинный
1293  865B 28 17        	jr z,sort_dir_one_skip
1294  865D
1295  865D              	;проверка на папку "." (этот же каталог)
1296  865D DD 7E 00     	ld a,(ix+#00)
1297  8660 FE 2E        	cp "." ;
1298  8662 20 07        	jr nz,sort_dir_one_add
1299  8664 DD 7E 01     	ld a,(ix+#01)
1300  8667 FE 20        	cp " " ;
1301  8669 28 09        	jr z,sort_dir_one_skip
1302  866B
1303  866B              sort_dir_one_add
1304  866B FD 23        	inc iy ;++
1305  866D              	;записать в таблицу (индекс)
1306  866D DD E5        	push ix
1307  866F C1           	pop bc
1308  8670 71           	ld (hl),c
1309  8671 23           	inc hl
1310  8672 70           	ld (hl),b
1311  8673 23           	inc hl
1312  8674
1313  8674
1314  8674              sort_dir_one_skip
1315  8674 01 20 00     	ld bc,32
1316  8677 DD 09        	add ix,bc ;на следующий
1317  8679 DD 7C        	ld a,ixh ;проверка на конец буфера
1318  867B FE C0        	cp #c0
1319  867D 30 BB        	jr nc,sort_dir_one_cl
1320  867F
1321  867F              sort_dir_one_ex
1322  867F              	;ld (file_r_all),iy
1323  867F C9           	ret
1324  8680
1325  8680
1326  8680
1327  8680              ;сортировка индекса методом пузырька
1328  8680              ;вх: iy - сколько (>1)
1329  8680              ;вх: ix - адрес таблицы
1330  8680              sort_index
1331  8680 FD 7C        	ld a,iyh ;проверка, число элементов должно быть > 1
1332  8682 B7           	or a
1333  8683 20 05        	jr nz,sort_index1
1334  8685 FD 7D        	ld a,iyl
1335  8687 FE 02        	cp 2
1336  8689 D8           	ret c
1337  868A              sort_index1
1338  868A FD E5        	push iy
1339  868C C1           	pop bc ;цикл проходов общий
1340  868D 0B           	dec bc ;-1
1341  868E
1342  868E              sort_index_cl_gen ;цикл основной
1343  868E C5           	push bc
1344  868F DD E5        	push ix
1345  8691
1346  8691 FD E5        	push iy
1347  8693 C1           	pop bc ;внутренний цикл столько же
1348  8694 0B           	dec bc ;-1
1349  8695
1350  8695 AF           	xor a ;флаг
1351  8696 32 D1 86     	ld (sort_index_flag),a
1352  8699
1353  8699              sort_index_cl ;цикл внутренний
1354  8699              	;первый элемент узнать адрес записи в каталоге
1355  8699 DD 5E 00     	ld e,(ix+00)
1356  869C DD 56 01     	ld d,(ix+01)
1357  869F 1A           	ld a,(de) ;первая буква имени
1358  86A0              	;второй элемент узнать адрес записи в каталоге
1359  86A0 DD 6E 02     	ld l,(ix+02)
1360  86A3 DD 66 03     	ld h,(ix+03)
1361  86A6              	;сравнить с другой первой буквой
1362  86A6 BE           	cp (hl)
1363  86A7 38 11        	jr c,sort_index_cl_skip
1364  86A9
1365  86A9 3E 01        	ld a,1
1366  86AB 32 D1 86     	ld (sort_index_flag),a ;флаг были изменения
1367  86AE              	;поменять местами элементы индекса
1368  86AE DD 75 00     	ld (ix+00),l
1369  86B1 DD 74 01     	ld (ix+01),h
1370  86B4 DD 73 02     	ld (ix+02),e
1371  86B7 DD 72 03     	ld (ix+03),d
1372  86BA
1373  86BA              sort_index_cl_skip
1374  86BA              	;следующий
1375  86BA DD 23        	inc ix
1376  86BC DD 23        	inc ix
1377  86BE
1378  86BE 0B           	dec bc
1379  86BF 78           	ld a,b
1380  86C0 B1           	or c
1381  86C1 20 D6        	jr nz,sort_index_cl
1382  86C3
1383  86C3 DD E1        	pop ix
1384  86C5 C1           	pop bc
1385  86C6 0B           	dec bc
1386  86C7
1387  86C7 3A D1 86     	ld a,(sort_index_flag)
1388  86CA B7           	or a
1389  86CB C8           	ret z ;если не было изменений за проход, можно выходить
1390  86CC
1391  86CC 78           	ld a,b
1392  86CD B1           	or c
1393  86CE 20 BE        	jr nz,sort_index_cl_gen
1394  86D0
1395  86D0 C9           	ret
1396  86D1
1397  86D1 00           sort_index_flag db 0;
1398  86D2
1399  86D2
1400  86D2              sort_toggle ;переключение сортировки
1401  86D2 3A F1 86     	ld a,(sort_enable_flag)
1402  86D5 EE 01        	xor 1
1403  86D7 32 F1 86     	ld (sort_enable_flag),a
1404  86DA 3E 66        	ld a,"f" ;вкл
1405  86DC 20 02        	jr nz,sort_toggle1
1406  86DE 3E 4E        	ld a,"N";выкл
1407  86E0              sort_toggle1
1408  86E0 32 2A A5     	ld (msg_menu_main2+5),a
1409  86E3
1410  86E3 CD 3F 85     	call sort_dir
1411  86E6 CD 79 87     	call print_menu_main
1412  86E9 3E 01        	ld a,1
1413  86EB 32 72 A4     	ld (print_panel_r_flag),a
1414  86EE
1415  86EE C3 84 80     	jp nc_wait
1416  86F1 00           sort_enable_flag db 0 ;флаг сортировки
1417  86F2
1418  86F2
1419  86F2
1420  86F2
1421  86F2              LFN_toggle ;переключение сортировки
1422  86F2 3A 0E 87     	ld a,(LFN_enable_flag)
1423  86F5 EE 01        	xor 1
1424  86F7 32 0E 87     	ld (LFN_enable_flag),a
1425  86FA 3E 66        	ld a,"f" ;вкл
1426  86FC 20 02        	jr nz,LFN_toggle1
1427  86FE 3E 4E        	ld a,"N";выкл
1428  8700              LFN_toggle1
1429  8700 32 23 A5     	ld (msg_menu_main1+5),a
1430  8703
1431  8703              	;call sort_dir
1432  8703 CD 79 87     	call print_menu_main
1433  8706 3E 01        	ld a,1
1434  8708 32 72 A4     	ld (print_panel_r_flag),a
1435  870B
1436  870B C3 84 80     	jp nc_wait
1437  870E 00           LFN_enable_flag db 0 ;флаг сортировки
1438  870F
1439  870F
1440  870F
1441  870F
1442  870F
1443  870F              format_name ;подогнать имя под стандарт filename.ext
1444  870F              ;вх: HL - имя в каталоге
1445  870F E5           	push hl
1446  8710 21 4A A2     	ld hl,file_name_cur
1447  8713 11 4B A2     	ld de,file_name_cur+1 ;почистить
1448  8716 01 FF 00     	ld bc,256-1
1449  8719 36 00        	ld (hl),0
1450  871B ED B0        	ldir
1451  871D
1452  871D E1           	pop hl
1453  871E E5           	push hl
1454  871F
1455  871F 11 4A A2     	ld de,file_name_cur ;куда
1456  8722 01 FF 08     	ld bc,#08ff
1457  8725              format_name_cl
1458  8725 7E           	ld a,(hl)
1459  8726 FE 21        	cp " "+1
1460  8728 38 04        	jr c,format_name_skip
1461  872A ED A0        	ldi
1462  872C 10 F7        	djnz format_name_cl
1463  872E              format_name_skip
1464  872E 3E 2E        	ld a,"."
1465  8730 12           	ld (de),a
1466  8731
1467  8731 13           	inc de
1468  8732 E1           	pop hl
1469  8733 01 08 00     	ld bc,8 ;перейти на расширение
1470  8736 09           	add hl,bc
1471  8737
1472  8737 01 FF 03     	ld bc,#03ff
1473  873A              format_name_cl2
1474  873A 7E           	ld a,(hl)
1475  873B FE 21        	cp " "+1
1476  873D 38 04        	jr c,format_name_skip2
1477  873F ED A0        	ldi
1478  8741 10 F7        	djnz format_name_cl2
1479  8743              format_name_skip2
1480  8743 C9           	ret
1481  8744
1482  8744              print_rect_r ;печать рамки правой
1483  8744 3E 0F        	ld a,color_backgr ;цвет
1484  8746 06 0C        	ld b,#c
1485  8748              	OS_SET_COLOR
1485  8748 0E 06       >    ld c,#06
1485  874A E7          >    rst #20
1486  874B 11 28 00     	ld de,#0028 ;xy
1487  874E              	OS_SET_XY
1487  874E 0E 01       >    ld c,#01
1487  8750 E7          >    rst #20
1488  8751 21 8E A4     	ld hl,rect_1
1489  8754              	OS_PRINTZ
1489  8754 0E 09       >    ld c,#09
1489  8756 E7          >    rst #20
1490  8757
1491  8757 11 28 01     	ld de,#0128 ;xy
1492  875A 06 16        	ld b,24-2 ;цикл
1493  875C              print_rect_r_cl
1494  875C C5           	push bc
1495  875D D5           	push de
1496  875E              	OS_SET_XY
1496  875E 0E 01       >    ld c,#01
1496  8760 E7          >    rst #20
1497  8761 21 B7 A4     	ld hl,rect_2
1498  8764              	OS_PRINTZ
1498  8764 0E 09       >    ld c,#09
1498  8766 E7          >    rst #20
1499  8767 D1           	pop de
1500  8768 14           	inc d
1501  8769 C1           	pop bc
1502  876A 10 F0        	djnz print_rect_r_cl
1503  876C
1504  876C
1505  876C 11 28 17     	ld de,#1728 ;xy
1506  876F              	OS_SET_XY
1506  876F 0E 01       >    ld c,#01
1506  8771 E7          >    rst #20
1507  8772 21 E0 A4     	ld hl,rect_3
1508  8775              	OS_PRINTZ
1508  8775 0E 09       >    ld c,#09
1508  8777 E7          >    rst #20
1509  8778 C9           	ret
1510  8779
1511  8779              print_menu_main ;печать основного меню
1512  8779 3E 07        	ld a,color_default ;цвет
1513  877B 06 0C        	ld b,#c
1514  877D              	OS_SET_COLOR
1514  877D 0E 06       >    ld c,#06
1514  877F E7          >    rst #20
1515  8780
1516  8780 11 00 18     	ld de,#1800+0*8
1517  8783              	OS_SET_XY
1517  8783 0E 01       >    ld c,#01
1517  8785 E7          >    rst #20
1518  8786 3E 31        	ld a,"1" ;пункт 1
1519  8788              	OS_PRINT_CHARF
1519  8788 D7          >	rst #10
1520  8789 11 08 18     	ld de,#1800+1*8
1521  878C              	OS_SET_XY
1521  878C 0E 01       >    ld c,#01
1521  878E E7          >    rst #20
1522  878F 3E 32        	ld a,"2" ;пункт 2
1523  8791              	OS_PRINT_CHARF
1523  8791 D7          >	rst #10
1524  8792 11 10 18     	ld de,#1800+2*8
1525  8795              	OS_SET_XY
1525  8795 0E 01       >    ld c,#01
1525  8797 E7          >    rst #20
1526  8798 3E 33        	ld a,"3" ;пункт 3
1527  879A              	OS_PRINT_CHARF
1527  879A D7          >	rst #10
1528  879B 11 18 18     	ld de,#1800+3*8
1529  879E              	OS_SET_XY
1529  879E 0E 01       >    ld c,#01
1529  87A0 E7          >    rst #20
1530  87A1 3E 34        	ld a,"4" ;пункт 4
1531  87A3              	OS_PRINT_CHARF
1531  87A3 D7          >	rst #10
1532  87A4
1533  87A4
1534  87A4 3E 28        	ld a,color_backgr_hi ;цвет
1535  87A6 06 0C        	ld b,#c
1536  87A8              	OS_SET_COLOR
1536  87A8 0E 06       >    ld c,#06
1536  87AA E7          >    rst #20
1537  87AB
1538  87AB 11 01 18     	ld de,#1800+0*8+1
1539  87AE              	OS_SET_XY
1539  87AE 0E 01       >    ld c,#01
1539  87B0 E7          >    rst #20
1540  87B1 21 1E A5     	ld hl,msg_menu_main1
1541  87B4              	OS_PRINTZ
1541  87B4 0E 09       >    ld c,#09
1541  87B6 E7          >    rst #20
1542  87B7 11 09 18     	ld de,#1800+1*8+1
1543  87BA              	OS_SET_XY
1543  87BA 0E 01       >    ld c,#01
1543  87BC E7          >    rst #20
1544  87BD 21 25 A5     	ld hl,msg_menu_main2
1545  87C0              	OS_PRINTZ
1545  87C0 0E 09       >    ld c,#09
1545  87C2 E7          >    rst #20
1546  87C3 11 11 18     	ld de,#1800+2*8+1
1547  87C6              	OS_SET_XY
1547  87C6 0E 01       >    ld c,#01
1547  87C8 E7          >    rst #20
1548  87C9 21 2C A5     	ld hl,msg_menu_main3
1549  87CC              	OS_PRINTZ
1549  87CC 0E 09       >    ld c,#09
1549  87CE E7          >    rst #20
1550  87CF 11 19 18     	ld de,#1800+3*8+1
1551  87D2              	OS_SET_XY
1551  87D2 0E 01       >    ld c,#01
1551  87D4 E7          >    rst #20
1552  87D5 21 33 A5     	ld hl,msg_menu_main4
1553  87D8              	OS_PRINTZ
1553  87D8 0E 09       >    ld c,#09
1553  87DA E7          >    rst #20
1554  87DB C9           	ret
1555  87DC
1556  87DC
1557  87DC
1558  87DC              ;прочитать файл не больше #4000 байт
1559  87DC              ;вх: hl - имя файла
1560  87DC              ;вых: CY = 1 = ошибка, hl - размер прочитанного
1561  87DC              load_file
1562  87DC              	;ld hl,file_name_cur
1563  87DC              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
1563  87DC 0E 21       >    ld c,#21
1563  87DE E7          >    rst #20
1564  87DF DA 2A 88     	jp c,load_file_error
1565  87E2 22 4A 88     	ld (load_file_size),hl ;размер
1566  87E5              ;load_file_ok
1567  87E5 32 5F A4     	ld (file_id_cur_r),a
1568  87E8              	;проверка длины файла не больше #4000
1569  87E8 7A           	ld	a,d ;самые старшие байты длины
1570  87E9 B3           	or e
1571  87EA 28 16        	jr z,load_file_size_ok ;если не слищком большой
1572  87EC              load_file_too_big
1573  87EC              	;файл больше буфера
1574  87EC 3E 0A        	ld a,color_error ;цвет ошибки
1575  87EE 06 0C        	ld b,#c
1576  87F0              	OS_SET_COLOR
1576  87F0 0E 06       >    ld c,#06
1576  87F2 E7          >    rst #20
1577  87F3
1578  87F3 21 46 A5     	ld hl,msg_file_too_big
1579  87F6              	OS_PRINTZ
1579  87F6 0E 09       >    ld c,#09
1579  87F8 E7          >    rst #20
1580  87F9
1581  87F9 3E 0F        	ld a,color_backgr ;цвет основной
1582  87FB 06 0C        	ld b,#c
1583  87FD              	OS_SET_COLOR
1583  87FD 0E 06       >    ld c,#06
1583  87FF E7          >    rst #20
1584  8800
1585  8800              	;call delay
1586  8800 37           	scf
1587  8801 C9           	ret
1588  8802
1589  8802
1590  8802              load_file_size_ok
1591  8802 7C           	ld	a,h ;младший старший байт длины
1592  8803 FE 40        	cp #40
1593  8805 38 06        	jr c,load_file_size_ok_small
1594  8807 20 E3        	jr nz,load_file_too_big
1595  8809 2C           	inc l
1596  880A 2D           	dec l
1597  880B 20 DF        	jr nz,load_file_too_big
1598  880D
1599  880D
1600  880D              load_file_size_ok_small
1601  880D              	;проверка на 0
1602  880D 7C           	ld a,h
1603  880E B5           	or l
1604  880F CA 2A 88     	jp z,load_file_error
1605  8812 54           	ld d,h ;размер
1606  8813 5D           	ld e,l
1607  8814 21 00 C0     	ld hl,buffer_cat ;куда
1608  8817 3A 5F A4     	ld a,(file_id_cur_r)
1609  881A              	OS_FILE_READ ;загрузить
1609  881A 0E 23       >    ld c,#23
1609  881C E7          >    rst #20
1610  881D 38 0B        	jr c,load_file_error
1611  881F
1612  881F 3A 5F A4     	ld a,(file_id_cur_r)
1613  8822              	OS_FILE_CLOSE ;A - id file
1613  8822 0E 25       >    ld c,#25
1613  8824 E7          >    rst #20
1614  8825
1615  8825 2A 4A 88     	ld hl,(load_file_size)
1616  8828 AF           	xor a
1617  8829 C9           	ret
1618  882A
1619  882A
1620  882A
1621  882A              load_file_error
1622  882A 3E 0A        	ld a,color_error ;цвет ошибки
1623  882C 06 0C        	ld b,#c
1624  882E              	OS_SET_COLOR
1624  882E 0E 06       >    ld c,#06
1624  8830 E7          >    rst #20
1625  8831 21 3A A5     		ld hl,msg_file_error
1626  8834              		OS_PRINTZ
1626  8834 0E 09       >    ld c,#09
1626  8836 E7          >    rst #20
1627  8837 3E 0F        	ld a,color_backgr ;цвет основной
1628  8839 06 0C        	ld b,#c
1629  883B              	OS_SET_COLOR
1629  883B 0E 06       >    ld c,#06
1629  883D E7          >    rst #20
1630  883E
1631  883E 3A 5F A4     		ld a,(file_id_cur_r)
1632  8841 FE FF        		cp 255
1633  8843 28 03        		jr z,load_file_error1
1634  8845              		OS_FILE_CLOSE ;A - id file
1634  8845 0E 25       >    ld c,#25
1634  8847 E7          >    rst #20
1635  8848              load_file_error1
1636  8848
1637  8848              	;call delay
1638  8848 37           		scf ;ошибка
1639  8849 C9           		ret
1640  884A 00 00        load_file_size dw 0 ;временно
1641  884C
1642  884C
1643  884C
1644  884C
1645  884C              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 884C              view_file
   2+ 884C              	;просмотр файла как текста
   3+ 884C
   4+ 884C 2A 46 A2     	ld hl,(file_r_all)
   5+ 884F 7D           	ld a,l
   6+ 8850 B4           	or h
   7+ 8851 CA 42 89     	jp z,view_file_ex ;защита
   8+ 8854 2A 58 A4     	ld hl,(file_r_num_cur)
   9+ 8857 CD 59 82     	call calc_deskr
  10+ 885A DD 7E 0B     	ld a,(ix+#0b)
  11+ 885D FE 10        	cp #10 ;признак каталога
  12+ 885F CA 42 89     	jp z,view_file_ex
  13+ 8862 FE 30        	cp #30 ;признак каталога
  14+ 8864 CA 42 89     	jp z,view_file_ex
  15+ 8867
  16+ 8867 CD 0F 87     	call format_name ;обработать имя файла
  17+ 886A
  18+ 886A
  19+ 886A
  20+ 886A 3A 60 A4     	ld a,(page_ext01) ;доп страница для данных
  21+ 886D              	OS_SET_PAGE_SLOT3
  21+ 886D 0E 1C       >    ld c,#1c
  21+ 886F E7          >    rst #20
  22+ 8870
  23+ 8870 11 00 00     	ld de,#0000
  24+ 8873              	OS_SET_XY
  24+ 8873 0E 01       >    ld c,#01
  24+ 8875 E7          >    rst #20
  25+ 8876
  26+ 8876              	;обнулить переменные
  27+ 8876 AF           	xor a
  28+ 8877 32 6F 8B     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  29+ 887A              	;ld (view_file_bot_flag),a  ;
  30+ 887A 21 FF FF     	ld hl,#ffff
  31+ 887D 22 70 8B     	ld (view_file_end),hl ;конец файла тут
  32+ 8880 23           	inc hl
  33+ 8881 22 67 8B     	ld (view_move_right_val),hl
  34+ 8884
  35+ 8884              	;push bc
  36+ 8884 CD E0 80     	call clear_buf
  37+ 8887              	;pop bc
  38+ 8887
  39+ 8887 3E FF        	ld a,255
  40+ 8889 32 5F A4     	ld (file_id_cur_r),a
  41+ 888C 21 4A A2     	ld hl,file_name_cur		;строка с именем
  42+ 888F              	OS_FILE_OPEN
  42+ 888F 0E 21       >    ld c,#21
  42+ 8891 E7          >    rst #20
  43+ 8892 30 0E        	jr nc,view_file_open_ok
  44+ 8894              view_file_file_error
  45+ 8894 21 3A A5     	ld hl,msg_file_error
  46+ 8897              	OS_PRINTZ
  46+ 8897 0E 09       >    ld c,#09
  46+ 8899 E7          >    rst #20
  47+ 889A 06 64        	ld b,2*50
  48+ 889C CD DC 80     	call delay1
  49+ 889F C3 2C 89     	jp view_file_wait_ex
  50+ 88A2
  51+ 88A2              view_file_open_ok
  52+ 88A2 32 5F A4     	ld (file_id_cur_r),a
  53+ 88A5              	;проверка длины файла не больше #4000
  54+ 88A5 7A           	ld	a,d ;самые старшие байты длины
  55+ 88A6 B3           	or e
  56+ 88A7 28 11        	jr z,view_file_size_ok ;если не слищком большой
  57+ 88A9              view_file_too_big
  58+ 88A9              	;файл больше буфера
  59+ 88A9 11 00 40     	ld de,#4000 ;размер одной первой части
  60+ 88AC 21 00 C0     	ld hl,buffer_cat
  61+ 88AF 3A 5F A4     	ld a,(file_id_cur_r)
  62+ 88B2              	OS_FILE_READ ;загрузить
  62+ 88B2 0E 23       >    ld c,#23
  62+ 88B4 E7          >    rst #20
  63+ 88B5 38 DD        	jr c,view_file_file_error
  64+ 88B7
  65+ 88B7 C3 E3 88     	jp view_file_readed
  66+ 88BA
  67+ 88BA              view_file_size_ok
  68+ 88BA 7C           	ld	a,h ;младший старший байт длины
  69+ 88BB FE 40        	cp #40
  70+ 88BD 38 06        	jr c,view_file_size_ok_small
  71+ 88BF 20 E8        	jr nz,view_file_too_big
  72+ 88C1 2C           	inc l
  73+ 88C2 2D           	dec l
  74+ 88C3 20 E4        	jr nz,view_file_too_big
  75+ 88C5
  76+ 88C5
  77+ 88C5              view_file_size_ok_small
  78+ 88C5              	;проверка на 0
  79+ 88C5 7C           	ld a,h
  80+ 88C6 B5           	or l
  81+ 88C7 CA 94 88     	jp z,view_file_file_error
  82+ 88CA 54           	ld d,h ;размер
  83+ 88CB 5D           	ld e,l
  84+ 88CC              	;узнать где конец файла
  85+ 88CC 01 00 C0     	ld bc,buffer_cat
  86+ 88CF 09           	add hl,bc
  87+ 88D0 22 70 8B     	ld (view_file_end),hl ;конец файла тут
  88+ 88D3              	;размер не большой, прочитаем
  89+ 88D3 21 00 C0     	ld hl,buffer_cat
  90+ 88D6 3A 5F A4     	ld a,(file_id_cur_r)
  91+ 88D9              	OS_FILE_READ ;загрузить
  91+ 88D9 0E 23       >    ld c,#23
  91+ 88DB E7          >    rst #20
  92+ 88DC 38 B6        	jr c,view_file_file_error
  93+ 88DE
  94+ 88DE 3E 01        	ld a,1
  95+ 88E0 32 6F 8B     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  96+ 88E3
  97+ 88E3              view_file_readed
  98+ 88E3              	;файл прочитан
  99+ 88E3              	OS_CLS ;почистить экран
  99+ 88E3 0E 00       >    ld c,#00
  99+ 88E5 E7          >    rst #20
 100+ 88E6
 101+ 88E6 21 00 C0     	ld hl,buffer_cat
 102+ 88E9 22 69 8B     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
 103+ 88EC 22 6B 8B     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
 104+ 88EF
 105+ 88EF CD 13 8A     	call print_file_text
 106+ 88F2
 107+ 88F2
 108+ 88F2 CD DE 89     	call print_menu_view ;меню
 109+ 88F5 CD F9 89     	call print_menu_view_top ;инфо
 110+ 88F8
 111+ 88F8 CD 38 81     	call release_key
 112+ 88FB
 113+ 88FB              view_file_wait ;цикл ожидания клавиши
 114+ 88FB              	OS_WAIT
 114+ 88FB DF          >	rst #18
 115+ 88FC              	OS_GET_CHAR
 115+ 88FC 0E 10       >    ld c,#10
 115+ 88FE E7          >    rst #20
 116+ 88FF FE FF        	cp 255
 117+ 8901 28 F8        	jr z,view_file_wait
 118+ 8903 FE 33        	cp "3"
 119+ 8905 28 25        	jr z,view_file_wait_ex
 120+ 8907 FE 0A        	cp 10 ;вниз
 121+ 8909 CA 55 89     	jp z,view_line_down
 122+ 890C FE 0B        	cp 11 ;вверх
 123+ 890E CA 6B 89     	jp z,view_line_up
 124+ 8911 FE 09        	cp 09 ;вправо
 125+ 8913 CA 80 89     	jp z,view_right
 126+ 8916 FE 08        	cp 08 ;влево
 127+ 8918 CA 92 89     	jp z,view_left
 128+ 891B FE 04        	cp 04 ;страница вверх
 129+ 891D CA A4 89     	jp z,view_page_up
 130+ 8920 FE 05        	cp 05 ;страница вниз
 131+ 8922 CA C1 89     	jp z,view_page_down
 132+ 8925 FE 18        	cp 24 ;break
 133+ 8927 CA 0F 83     	jp z,exit
 134+ 892A 18 CF        	jr view_file_wait
 135+ 892C
 136+ 892C              view_file_wait_ex
 137+ 892C 3A 5F A4     	ld a,(file_id_cur_r)
 138+ 892F FE FF        	cp 255
 139+ 8931 28 03        	jr z,view_file_wait_ex1
 140+ 8933              	OS_FILE_CLOSE ;A - id file
 140+ 8933 0E 25       >    ld c,#25
 140+ 8935 E7          >    rst #20
 141+ 8936              view_file_wait_ex1
 142+ 8936 3A 70 A4     	ld a,(page_main) ;основная страница с каталогом
 143+ 8939              	OS_SET_PAGE_SLOT3
 143+ 8939 0E 1C       >    ld c,#1c
 143+ 893B E7          >    rst #20
 144+ 893C              	;почистить экран
 145+ 893C              	OS_CLS
 145+ 893C 0E 00       >    ld c,#00
 145+ 893E E7          >    rst #20
 146+ 893F C3 48 80     	jp start_nc_warm ;перезагрузить папку
 147+ 8942
 148+ 8942              view_file_ex
 149+ 8942 3A 5F A4     	ld a,(file_id_cur_r)
 150+ 8945 FE FF        	cp 255
 151+ 8947 28 03        	jr z,view_file_ex1
 152+ 8949              	OS_FILE_CLOSE ;A - id file
 152+ 8949 0E 25       >    ld c,#25
 152+ 894B E7          >    rst #20
 153+ 894C              view_file_ex1
 154+ 894C 3A 70 A4     	ld a,(page_main) ;основная страница с каталогом
 155+ 894F              	OS_SET_PAGE_SLOT3
 155+ 894F 0E 1C       >    ld c,#1c
 155+ 8951 E7          >    rst #20
 156+ 8952 C3 84 80     	jp nc_wait
 157+ 8955
 158+ 8955
 159+ 8955
 160+ 8955              view_line_down ;вниз на строчку
 161+ 8955 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 162+ 8958 22 69 8B     	ld (view_file_pos_cur),hl
 163+ 895B CD 3A 8B     	call next_line ;вперёд на строку
 164+ 895E 38 9B        	jr c,view_file_wait ;если не удачно
 165+ 8960 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 166+ 8963 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 167+ 8966 CD 13 8A     	call print_file_text ;напечатать всю страницу
 168+ 8969 18 90        	jr view_file_wait
 169+ 896B
 170+ 896B              view_line_up ;вверх на строчку
 171+ 896B 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 172+ 896E 22 69 8B     	ld (view_file_pos_cur),hl
 173+ 8971 CD 48 8B     	call prev_line ;
 174+ 8974              	;jr c,view_file_wait ;если не удачно
 175+ 8974 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 176+ 8977 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 177+ 897A CD 13 8A     	call print_file_text ;напечатать всю страницу
 178+ 897D C3 FB 88     	jp view_file_wait
 179+ 8980
 180+ 8980
 181+ 8980              view_right ;вправо
 182+ 8980 2A 67 8B     	ld hl,(view_move_right_val)
 183+ 8983 23           	inc hl
 184+ 8984 7C           	ld a,h
 185+ 8985 B5           	or l
 186+ 8986 CA FB 88     	jp z,view_file_wait
 187+ 8989 22 67 8B     	ld (view_move_right_val),hl
 188+ 898C CD 13 8A     	call print_file_text ;напечатать всю страницу
 189+ 898F C3 FB 88     	jp view_file_wait
 190+ 8992
 191+ 8992              view_left ;влево
 192+ 8992 2A 67 8B     	ld hl,(view_move_right_val)
 193+ 8995 7C           	ld a,h
 194+ 8996 B5           	or l
 195+ 8997 CA FB 88     	jp z,view_file_wait
 196+ 899A 2B           	dec hl
 197+ 899B 22 67 8B     	ld (view_move_right_val),hl
 198+ 899E CD 13 8A     	call print_file_text ;напечатать всю страницу
 199+ 89A1 C3 FB 88     	jp view_file_wait
 200+ 89A4
 201+ 89A4
 202+ 89A4
 203+ 89A4              view_page_up ;на страницу назад
 204+ 89A4 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 205+ 89A7 22 69 8B     	ld (view_file_pos_cur),hl
 206+ 89AA 06 16        	ld b,view_text_bot-2
 207+ 89AC              view_page_up_cl
 208+ 89AC CD 48 8B     	call prev_line ;
 209+ 89AF 38 04        	jr c,view_page_up_ex ;если не удачно
 210+ 89B1 28 02        	jr z,view_page_up_ex
 211+ 89B3 10 F7        	djnz view_page_up_cl
 212+ 89B5              view_page_up_ex
 213+ 89B5 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 214+ 89B8 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 215+ 89BB CD 13 8A     	call print_file_text ;напечатать всю страницу
 216+ 89BE C3 FB 88     	jp view_file_wait
 217+ 89C1
 218+ 89C1
 219+ 89C1
 220+ 89C1              view_page_down ;на страницу вперёд
 221+ 89C1 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 222+ 89C4 22 69 8B     	ld (view_file_pos_cur),hl
 223+ 89C7 06 16        	ld b,view_text_bot-2
 224+ 89C9              view_page_down_cl
 225+ 89C9 CD 3A 8B     	call next_line ;
 226+ 89CC 38 04        	jr c,view_page_down_ex ;если не удачно
 227+ 89CE 28 02        	jr z,view_page_down_ex
 228+ 89D0 10 F7        	djnz view_page_down_cl
 229+ 89D2              view_page_down_ex
 230+ 89D2 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 231+ 89D5 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 232+ 89D8 CD 13 8A     	call print_file_text ;напечатать всю страницу
 233+ 89DB C3 FB 88     	jp view_file_wait
 234+ 89DE
 235+ 89DE
 236+ 89DE
 237+ 89DE              print_menu_view ;печать меню просмотрщика
 238+ 89DE 3E 18        	ld a,#18
 239+ 89E0 06 28        	ld b,color_backgr_hi ;цвет
 240+ 89E2              	OS_PAINT_LINE ;линия внизу
 240+ 89E2 0E 04       >    ld c,#04
 240+ 89E4 E7          >    rst #20
 241+ 89E5 3E 28        	ld a,color_backgr_hi ;цвет
 242+ 89E7 06 0C        	ld b,#c
 243+ 89E9              	OS_SET_COLOR
 243+ 89E9 0E 06       >    ld c,#06
 243+ 89EB E7          >    rst #20
 244+ 89EC 11 10 18     	ld de,#1800+2*8
 245+ 89EF              	OS_SET_XY
 245+ 89EF 0E 01       >    ld c,#01
 245+ 89F1 E7          >    rst #20
 246+ 89F2 21 60 8B     	ld hl,msg_menu_view
 247+ 89F5              	OS_PRINTZ
 247+ 89F5 0E 09       >    ld c,#09
 247+ 89F7 E7          >    rst #20
 248+ 89F8 C9           	ret
 249+ 89F9
 250+ 89F9              print_menu_view_top ;печать меню просмотрщика верхнее
 251+ 89F9 AF           	xor a
 252+ 89FA 06 28        	ld b,color_backgr_hi ;цвет
 253+ 89FC              	OS_PAINT_LINE ;линия вверху
 253+ 89FC 0E 04       >    ld c,#04
 253+ 89FE E7          >    rst #20
 254+ 89FF 3E 28        	ld a,color_backgr_hi ;цвет
 255+ 8A01 06 0C        	ld b,#c
 256+ 8A03              	OS_SET_COLOR
 256+ 8A03 0E 06       >    ld c,#06
 256+ 8A05 E7          >    rst #20
 257+ 8A06 11 24 00     	ld de,#0024
 258+ 8A09              	OS_SET_XY
 258+ 8A09 0E 01       >    ld c,#01
 258+ 8A0B E7          >    rst #20
 259+ 8A0C 21 4A A2     	ld hl,file_name_cur
 260+ 8A0F              	OS_PRINTZ
 260+ 8A0F 0E 09       >    ld c,#09
 260+ 8A11 E7          >    rst #20
 261+ 8A12 C9           	ret
 262+ 8A13
 263+ 8A13
 264+ 8A13
 265+ 8A13              print_file_text	;печать текущей части файла в консоль
 266+ 8A13 3E 04        	ld a,color_view_text ;цвет
 267+ 8A15 06 0C        	ld b,#c
 268+ 8A17              	OS_SET_COLOR
 268+ 8A17 0E 06       >    ld c,#06
 268+ 8A19 E7          >    rst #20
 269+ 8A1A
 270+ 8A1A 3E 01        	ld a,view_text_top ;первая строка
 271+ 8A1C 32 6D 8B     	ld (view_file_y_cur),a
 272+ 8A1F 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 273+ 8A22 22 69 8B     	ld (view_file_pos_cur),hl
 274+ 8A25              print_file_text_cl
 275+ 8A25 2A 69 8B     	ld hl,(view_file_pos_cur)
 276+ 8A28 CD 4E 8A     	call print_line_text
 277+ 8A2B 38 0C        	jr c,print_file_text_ex
 278+ 8A2D
 279+ 8A2D              	; call next_line ;найти следующую строку
 280+ 8A2D              	; ret c
 281+ 8A2D
 282+ 8A2D 3A 6D 8B     	ld a,(view_file_y_cur)
 283+ 8A30 3C           	inc a
 284+ 8A31 32 6D 8B     	ld (view_file_y_cur),a
 285+ 8A34 FE 18        	cp view_text_bot
 286+ 8A36 38 ED        	jr c,print_file_text_cl
 287+ 8A38 C9           	ret
 288+ 8A39
 289+ 8A39              print_file_text_ex
 290+ 8A39              	;тут очистить остальные строки
 291+ 8A39 3A 6D 8B     	ld a,(view_file_y_cur)
 292+ 8A3C 3C           	inc a
 293+ 8A3D FE 18        	cp view_text_bot
 294+ 8A3F 30 0B        	jr nc,print_file_text_ex2
 295+ 8A41 67           	ld h,a
 296+ 8A42 32 6D 8B     	ld (view_file_y_cur),a
 297+ 8A45 3E 20        	ld a," "
 298+ 8A47              	OS_FILL_LINE ;очистить строку
 298+ 8A47 0E 03       >    ld c,#03
 298+ 8A49 E7          >    rst #20
 299+ 8A4A 18 ED        	jr print_file_text_ex
 300+ 8A4C              print_file_text_ex2
 301+ 8A4C 37           	scf
 302+ 8A4D C9           	ret
 303+ 8A4E
 304+ 8A4E
 305+ 8A4E
 306+ 8A4E              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 307+ 8A4E              ;вх: hl - адрес строки
 308+ 8A4E CD 9E 8A     	call view_move_right ;промотать направо. если надо
 309+ 8A51              	;установить позицию
 310+ 8A51 3A 6D 8B     	ld a,(view_file_y_cur)
 311+ 8A54 57           	ld d,a
 312+ 8A55 AF           	xor a
 313+ 8A56 32 6E 8B     	ld (view_file_x_cur),a
 314+ 8A59 5F           	ld e,a
 315+ 8A5A              	OS_SET_XY 	;yx
 315+ 8A5A 0E 01       >    ld c,#01
 315+ 8A5C E7          >    rst #20
 316+ 8A5D              print_line_text_cl ;цикл
 317+ 8A5D
 318+ 8A5D 7E           	ld a,(hl)
 319+ 8A5E FE 0A        	cp 10 ;этот код не печатаем
 320+ 8A60 28 14        	jr z,print_line_text_skip
 321+ 8A62 FE FF        	cp #ff ;этот код не печатаем
 322+ 8A64 28 10        	jr z,print_line_text_skip
 323+ 8A66 FE 0D        	cp 13
 324+ 8A68 28 13        	jr z,print_line_text_ex_ok
 325+ 8A6A              	OS_PRINT_CHARF ;печать
 325+ 8A6A D7          >	rst #10
 326+ 8A6B
 327+ 8A6B              	;на следующую позицию
 328+ 8A6B 3A 6E 8B     	ld a,(view_file_x_cur)
 329+ 8A6E 3C           	inc a
 330+ 8A6F FE 50        	cp 80 ;правый край экрана
 331+ 8A71 32 6E 8B     	ld (view_file_x_cur),a
 332+ 8A74 30 15        	jr nc,print_line_text_right ;дошли до правого края
 333+ 8A76
 334+ 8A76              print_line_text_skip
 335+ 8A76 CD D6 8A     	call view_file_next_pos ;следующий
 336+ 8A79 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 337+ 8A7B 18 E0        	jr print_line_text_cl
 338+ 8A7D
 339+ 8A7D              print_line_text_ex_ok ;выход норма по коду 13
 340+ 8A7D 3E 20        	ld a," "
 341+ 8A7F              	OS_PRINT_CHARF ;печать
 341+ 8A7F D7          >	rst #10
 342+ 8A80 CD 8F 8A     	call printe_clear_end ;добить до конца строки
 343+ 8A83 C3 D6 8A     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 344+ 8A86              	;ret
 345+ 8A86
 346+ 8A86              print_line_text_ex_end ;выход если кончился файл
 347+ 8A86 CD 8F 8A     	call printe_clear_end
 348+ 8A89 37           	scf
 349+ 8A8A C9           	ret
 350+ 8A8B
 351+ 8A8B              print_line_text_right
 352+ 8A8B CD 3A 8B     	call next_line ;позицию  до конца строки
 353+ 8A8E C9           	ret
 354+ 8A8F
 355+ 8A8F
 356+ 8A8F              printe_clear_end
 357+ 8A8F              	;добить строку пробелами
 358+ 8A8F 3A 6E 8B     	ld a,(view_file_x_cur)
 359+ 8A92 3C           	inc a
 360+ 8A93 FE 50        	cp 80 ;правый край экрана
 361+ 8A95 32 6E 8B     	ld (view_file_x_cur),a
 362+ 8A98 D0           	ret nc
 363+ 8A99 3E 20        	ld a," "
 364+ 8A9B              	OS_PRINT_CHARF ;печать
 364+ 8A9B D7          >	rst #10
 365+ 8A9C 18 F1        	jr printe_clear_end
 366+ 8A9E
 367+ 8A9E
 368+ 8A9E
 369+ 8A9E
 370+ 8A9E
 371+ 8A9E              view_move_right ;перемотка строки направо
 372+ 8A9E ED 4B 67 8B  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 373+ 8AA2 78           	ld a,b
 374+ 8AA3 B1           	or c
 375+ 8AA4 C8           	ret z
 376+ 8AA5 2A 69 8B     	ld hl,(view_file_pos_cur)
 377+ 8AA8              view_move_right1
 378+ 8AA8 7E           	ld a,(hl)
 379+ 8AA9 FE 0A        	cp 10 ;этот код пропускаем
 380+ 8AAB 20 07        	jr nz,view_move_right2
 381+ 8AAD CD D6 8A     	call view_file_next_pos
 382+ 8AB0 D8           	ret c
 383+ 8AB1 C8           	ret z
 384+ 8AB2 18 F4        	jr view_move_right1
 385+ 8AB4              view_move_right2
 386+ 8AB4 FE FF        	cp #ff ;этот код пропускаем
 387+ 8AB6 20 07        	jr nz,view_move_right3
 388+ 8AB8 CD D6 8A     	call view_file_next_pos
 389+ 8ABB D8           	ret c
 390+ 8ABC C8           	ret z
 391+ 8ABD 18 E9        	jr view_move_right1
 392+ 8ABF              view_move_right3
 393+ 8ABF 7E           	ld a,(hl)
 394+ 8AC0 FE 0D        	cp 13 ;
 395+ 8AC2 C8           	ret z
 396+ 8AC3              view_move_right_cl
 397+ 8AC3 CD D6 8A     	call view_file_next_pos
 398+ 8AC6 D8           	ret c
 399+ 8AC7 C8           	ret z
 400+ 8AC8 7E           	ld a,(hl)
 401+ 8AC9 FE 0D        	cp 13
 402+ 8ACB C8           	ret z
 403+ 8ACC FE 0A        	cp 10 ;этот код пропускаем
 404+ 8ACE 28 F3        	jr z,view_move_right_cl
 405+ 8AD0 0B           	dec bc
 406+ 8AD1 78           	ld a,b
 407+ 8AD2 B1           	or c
 408+ 8AD3 20 EE        	jr nz,view_move_right_cl
 409+ 8AD5              	;call view_file_next_pos ;следующий
 410+ 8AD5 C9           	ret
 411+ 8AD6
 412+ 8AD6
 413+ 8AD6
 414+ 8AD6              ;получение следующей позиции
 415+ 8AD6              view_file_next_pos
 416+ 8AD6 3A 6F 8B     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 417+ 8AD9 B7           	or a
 418+ 8ADA 28 14        	jr z,view_file_next_pos_big
 419+ 8ADC              	;если текст не большой
 420+ 8ADC 2A 70 8B     	ld hl,(view_file_end) ;конец текста известен
 421+ 8ADF ED 5B 69 8B  	ld de,(view_file_pos_cur)
 422+ 8AE3 13           	inc de ;вперёд
 423+ 8AE4 A7           	and a
 424+ 8AE5 ED 52        	sbc hl,de
 425+ 8AE7 38 15        	jr c,view_file_next_pos_end
 426+ 8AE9 ED 53 69 8B  	ld (view_file_pos_cur),de
 427+ 8AED EB           	ex de,hl ;на выходе адрес в HL
 428+ 8AEE B7           	or a
 429+ 8AEF C9           	ret
 430+ 8AF0
 431+ 8AF0
 432+ 8AF0
 433+ 8AF0              view_file_next_pos_big
 434+ 8AF0              	;если текст большой
 435+ 8AF0 2A 69 8B     	ld hl,(view_file_pos_cur)	;текущая позиция
 436+ 8AF3 23           	inc hl ;вперёд
 437+ 8AF4 7C           	ld a,h
 438+ 8AF5 FE C0        	cp #c0 ;если вышли за пределы окна
 439+ 8AF7 38 05        	jr c,view_file_next_pos_end
 440+ 8AF9 22 69 8B     	ld (view_file_pos_cur),hl
 441+ 8AFC B7           	or a
 442+ 8AFD C9           	ret
 443+ 8AFE
 444+ 8AFE              view_file_next_pos_end
 445+ 8AFE              	;не смогли шагнуть вперёд
 446+ 8AFE              	; ld a,1 ;флаг что внизу
 447+ 8AFE              	; ld (view_file_bot_flag),a
 448+ 8AFE 37           	scf ;ошибка
 449+ 8AFF C9           	ret
 450+ 8B00
 451+ 8B00
 452+ 8B00
 453+ 8B00
 454+ 8B00
 455+ 8B00
 456+ 8B00              ;получение предыдущей позиции
 457+ 8B00              view_file_prev_pos
 458+ 8B00 3A 6F 8B     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 459+ 8B03 B7           	or a
 460+ 8B04 28 1E        	jr z,view_file_prev_pos_big
 461+ 8B06              	;если текст не большой
 462+ 8B06 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 463+ 8B09 ED 5B 69 8B  	ld de,(view_file_pos_cur) ;текущая позиция
 464+ 8B0D 1B           	dec de ;назад
 465+ 8B0E A7           	and a
 466+ 8B0F ED 52        	sbc hl,de
 467+ 8B11 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 468+ 8B13 30 1D        	jr nc,view_file_prev_pos_end
 469+ 8B15              	;можно шагнуть назад
 470+ 8B15 ED 53 69 8B  	ld (view_file_pos_cur),de
 471+ 8B19 EB           	ex de,hl ;на выходе адрес в HL
 472+ 8B1A AF           	xor a
 473+ 8B1B 3C           	inc a ;a=1
 474+ 8B1C C9           	ret
 475+ 8B1D              view_file_prev_pos_top
 476+ 8B1D              	;если в начале
 477+ 8B1D ED 53 69 8B  	ld (view_file_pos_cur),de
 478+ 8B21 EB           	ex de,hl ;на выходе адрес в HL
 479+ 8B22 AF           	xor a ;a=0
 480+ 8B23 C9           	ret
 481+ 8B24
 482+ 8B24
 483+ 8B24              view_file_prev_pos_big
 484+ 8B24              	;если текст большой
 485+ 8B24 2A 69 8B     	ld hl,(view_file_pos_cur)	;текущая позиция
 486+ 8B27 2B           	dec hl ;назад
 487+ 8B28 7C           	ld a,h
 488+ 8B29 FE C0        	cp #c0 ;если вышли за пределы окна
 489+ 8B2B 38 05        	jr c,view_file_prev_pos_end
 490+ 8B2D 22 69 8B     	ld (view_file_pos_cur),hl
 491+ 8B30 B7           	or a
 492+ 8B31 C9           	ret
 493+ 8B32
 494+ 8B32              view_file_prev_pos_end
 495+ 8B32              	;не смогли шагнуть назад
 496+ 8B32 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 497+ 8B35 22 69 8B     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 498+ 8B38              	;вернулись в начало
 499+ 8B38 AF           	xor a ;a=0
 500+ 8B39 C9           	ret
 501+ 8B3A
 502+ 8B3A
 503+ 8B3A
 504+ 8B3A
 505+ 8B3A              next_line ;поиск следующей строки
 506+ 8B3A CD D6 8A     	call view_file_next_pos
 507+ 8B3D D8           	ret c
 508+ 8B3E C8           	ret z
 509+ 8B3F 7E           	ld a,(hl)
 510+ 8B40 FE 0D        	cp 13
 511+ 8B42 20 F6        	jr nz,next_line
 512+ 8B44 CD D6 8A     	call view_file_next_pos ;ещё на символ
 513+ 8B47 C9           	ret
 514+ 8B48
 515+ 8B48
 516+ 8B48
 517+ 8B48              prev_line ;поиск предыдущей строки
 518+ 8B48              ;если достигнуто начало файла - вернёт адрес начальный
 519+ 8B48              	;сначала в конец предыдущей
 520+ 8B48 CD 00 8B     	call view_file_prev_pos
 521+ 8B4B C8           	ret z
 522+ 8B4C D8           	ret c
 523+ 8B4D 7E           	ld a,(hl)
 524+ 8B4E FE 0D        	cp 13
 525+ 8B50 20 F6        	jr nz,prev_line
 526+ 8B52              	;теперь в начало предыдущей
 527+ 8B52              prev_line1
 528+ 8B52 CD 00 8B     	call view_file_prev_pos
 529+ 8B55 C8           	ret z
 530+ 8B56 D8           	ret c
 531+ 8B57 7E           	ld a,(hl)
 532+ 8B58 FE 0D        	cp 13
 533+ 8B5A 20 F6        	jr nz,prev_line1
 534+ 8B5C CD D6 8A     	call view_file_next_pos ;ещё на символ обратно
 535+ 8B5F C9           	ret
 536+ 8B60
 537+ 8B60
 538+ 8B60
 539+ 8B60              view_text_bot equ 24 ;последняя строка для печати
 540+ 8B60              view_text_top equ 1 ;первая строка
 541+ 8B60              view_text_lines equ 25-2 ;видимых строк на экране
 542+ 8B60
 543+ 8B60              msg_menu_view
 544+ 8B60 33 20 45 78  	db "3 Exit",0
 544+ 8B64 69 74 00
 545+ 8B67
 546+ 8B67              ;view_file_position ds 4 ;текущая позиция в файле
 547+ 8B67              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 548+ 8B67 00 00        view_move_right_val dw 0 ;сдвиг вправо
 549+ 8B69 00 00        view_file_pos_cur dw 0;текущая позиция
 550+ 8B6B 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 551+ 8B6D 00           view_file_y_cur db 0;текущая строка
 552+ 8B6E 00           view_file_x_cur db 0;текущий столбец
 553+ 8B6F 00           view_file_load_all db 0 ;флаг что файл весь загружен
 554+ 8B70 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 555+ 8B72
 556+ 8B72
# file closed: nc_view.asm
1646  8B72              	include nc_edit.asm ;редактор
# file opened: nc_edit.asm
   1+ 8B72              edit_file
   2+ 8B72              	;редактирование файла как текста, размер не больше #4000
   3+ 8B72
   4+ 8B72 2A 46 A2     	ld hl,(file_r_all)
   5+ 8B75 7D           	ld a,l
   6+ 8B76 B4           	or h
   7+ 8B77 CA 61 8C     	jp z,edit_file_ex ;защита
   8+ 8B7A 2A 58 A4     	ld hl,(file_r_num_cur)
   9+ 8B7D CD 59 82     	call calc_deskr
  10+ 8B80 DD 7E 0B     	ld a,(ix+#0b)
  11+ 8B83 FE 10        	cp #10 ;признак каталога
  12+ 8B85 CA 61 8C     	jp z,edit_file_ex
  13+ 8B88 FE 30        	cp #30 ;признак каталога
  14+ 8B8A CA 61 8C     	jp z,edit_file_ex
  15+ 8B8D
  16+ 8B8D CD 0F 87     	call format_name ;обработать имя файла
  17+ 8B90
  18+ 8B90
  19+ 8B90 3A 60 A4     	ld a,(page_ext01) ;доп страница для данных
  20+ 8B93              	OS_SET_PAGE_SLOT3
  20+ 8B93 0E 1C       >    ld c,#1c
  20+ 8B95 E7          >    rst #20
  21+ 8B96
  22+ 8B96 11 00 00     	ld de,#0000
  23+ 8B99              	OS_SET_XY
  23+ 8B99 0E 01       >    ld c,#01
  23+ 8B9B E7          >    rst #20
  24+ 8B9C
  25+ 8B9C              	;обнулить переменные
  26+ 8B9C              	;ld (edit_file_bot_flag),a  ;
  27+ 8B9C              	;ld hl,#ffff
  28+ 8B9C 3E 01        	ld a,1
  29+ 8B9E 32 6F 8B     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  30+ 8BA1 21 00 00     	ld hl,0
  31+ 8BA4 22 67 8B     	ld (view_move_right_val),hl ;сдвиг вправо 0
  32+ 8BA7
  33+ 8BA7 AF           	xor a
  34+ 8BA8 32 EE 8F     	ld (edit_file_save_flag),a ;флаг для сохранения
  35+ 8BAB
  36+ 8BAB 21 00 C0     	ld hl,buffer_cat
  37+ 8BAE 22 69 8B     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  38+ 8BB1 22 6B 8B     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  39+ 8BB4 22 EF 8F     	ld (edit_file_pos_cur),hl ;позиция курсора
  40+ 8BB7 22 F1 8F     	ld (edit_file_pos_old),hl ;позиция курсора
  41+ 8BBA
  42+ 8BBA              	;push bc
  43+ 8BBA CD E0 80     	call clear_buf
  44+ 8BBD              	;pop bc
  45+ 8BBD
  46+ 8BBD 3E FF        	ld a,255
  47+ 8BBF 32 5F A4     	ld (file_id_cur_r),a
  48+ 8BC2 21 4A A2     	ld hl,file_name_cur		;строка с именем
  49+ 8BC5 CD DC 87     	call load_file ;загрузить целиком
  50+ 8BC8 DA 61 8C     	jp c,edit_file_ex
  51+ 8BCB
  52+ 8BCB 22 EC 8F     	ld (edit_file_size),hl ;размер
  53+ 8BCE 01 00 C0     	ld bc,buffer_cat
  54+ 8BD1 09           	add hl,bc
  55+ 8BD2 22 70 8B     	ld (view_file_end),hl ;конец файла тут
  56+ 8BD5
  57+ 8BD5              	;файл прочитан
  58+ 8BD5              	OS_CLS ;почистить экран
  58+ 8BD5 0E 00       >    ld c,#00
  58+ 8BD7 E7          >    rst #20
  59+ 8BD8
  60+ 8BD8 CD 13 8A     	call print_file_text
  61+ 8BDB CD 58 8E     	call print_file_cursor
  62+ 8BDE
  63+ 8BDE
  64+ 8BDE CD 3D 8E     	call print_menu_edit ;меню
  65+ 8BE1 CD F9 89     	call print_menu_view_top ;инфо
  66+ 8BE4
  67+ 8BE4 CD 38 81     	call release_key
  68+ 8BE7
  69+ 8BE7              edit_file_wait ;цикл ожидания клавиши
  70+ 8BE7              	OS_WAIT
  70+ 8BE7 DF          >	rst #18
  71+ 8BE8              	OS_GET_CHAR
  71+ 8BE8 0E 10       >    ld c,#10
  71+ 8BEA E7          >    rst #20
  72+ 8BEB FE FF        	cp 255
  73+ 8BED 28 F8        	jr z,edit_file_wait
  74+ 8BEF 32 5E A4     	ld (key_pressed),a ;запомнить
  75+ 8BF2              	; cp "3"
  76+ 8BF2              	; jr z,edit_file_wait_ex
  77+ 8BF2 FE 0A        	cp 10 ;вниз
  78+ 8BF4 CA 36 8D     	jp z,edit_file_down
  79+ 8BF7 FE 0B        	cp 11 ;вверх
  80+ 8BF9 CA 65 8D     	jp z,edit_file_up
  81+ 8BFC FE 09        	cp 09 ;вправо
  82+ 8BFE CA 95 8D     	jp z,edit_right
  83+ 8C01 FE 08        	cp 08 ;влево
  84+ 8C03 CA BD 8D     	jp z,edit_left
  85+ 8C06 FE 04        	cp 04 ;страница вверх
  86+ 8C08 CA E5 8D     	jp z,edit_page_up
  87+ 8C0B FE 05        	cp 05 ;страница вниз
  88+ 8C0D CA 11 8E     	jp z,edit_page_down
  89+ 8C10 FE 0C        	cp 12 ;backspace
  90+ 8C12 CA 82 8C     	jp z,edit_file_backspace
  91+ 8C15 FE 18        	cp 24 ;break
  92+ 8C17 CA 26 8C     	jp z,edit_file_wait_ex
  93+ 8C1A FE 20        	cp " " ;печатаем сиволы от пробела и выше
  94+ 8C1C D4 CD 8C     	call nc,edit_file_insert_sym ;вставить символ
  95+ 8C1F FE 0D        	cp 13 ;enter
  96+ 8C21 CC CD 8C     	call z,edit_file_insert_sym ;вставить символ
  97+ 8C24 18 C1        	jr edit_file_wait
  98+ 8C26
  99+ 8C26              edit_file_wait_ex
 100+ 8C26 CD 38 81     	call release_key
 101+ 8C29
 102+ 8C29 3A EE 8F     	ld a,(edit_file_save_flag)
 103+ 8C2C B7           	or a
 104+ 8C2D 28 26        	jr z,edit_file_wait_ex1
 105+ 8C2F              	;запрос на сохранение
 106+ 8C2F
 107+ 8C2F 11 00 00     	ld de,0
 108+ 8C32              	OS_SET_XY
 108+ 8C32 0E 01       >    ld c,#01
 108+ 8C34 E7          >    rst #20
 109+ 8C35 21 DD 8F     	ld hl,msg_menu_edit_save
 110+ 8C38              	OS_PRINTZ
 110+ 8C38 0E 09       >    ld c,#09
 110+ 8C3A E7          >    rst #20
 111+ 8C3B
 112+ 8C3B              edit_file_wait_ex_wait
 113+ 8C3B              	OS_WAIT
 113+ 8C3B DF          >	rst #18
 114+ 8C3C              	OS_GET_CHAR
 114+ 8C3C 0E 10       >    ld c,#10
 114+ 8C3E E7          >    rst #20
 115+ 8C3F FE FF        	cp 255
 116+ 8C41 28 F8        	jr z,edit_file_wait_ex_wait
 117+ 8C43 FE 79        	cp "y" ;да
 118+ 8C45 28 23        	jr z,edit_file_save
 119+ 8C47 FE 59        	cp "Y" ;да
 120+ 8C49 28 1F        	jr z,edit_file_save
 121+ 8C4B              	; cp "н" ;да
 122+ 8C4B              	; jr z,edit_file_save
 123+ 8C4B              	; cp "Н" ;да
 124+ 8C4B              	; jr z,edit_file_save
 125+ 8C4B FE 6E        	cp "n" ;нет
 126+ 8C4D 28 06        	jr z,edit_file_wait_ex1
 127+ 8C4F FE 4E        	cp "N" ;нет
 128+ 8C51 28 02        	jr z,edit_file_wait_ex1
 129+ 8C53              	; cp "т" ;нет
 130+ 8C53              	; jr z,edit_file_wait_ex1
 131+ 8C53              	; cp "Т" ;нет
 132+ 8C53              	; jr z,edit_file_wait_ex1
 133+ 8C53 18 E6        	jr edit_file_wait_ex_wait
 134+ 8C55
 135+ 8C55              edit_file_wait_ex1
 136+ 8C55 3A 70 A4     	ld a,(page_main) ;основная страница с каталогом
 137+ 8C58              	OS_SET_PAGE_SLOT3
 137+ 8C58 0E 1C       >    ld c,#1c
 137+ 8C5A E7          >    rst #20
 138+ 8C5B              	;почистить экран
 139+ 8C5B              	OS_CLS
 139+ 8C5B 0E 00       >    ld c,#00
 139+ 8C5D E7          >    rst #20
 140+ 8C5E C3 48 80     	jp start_nc_warm ;перезагрузить папку
 141+ 8C61
 142+ 8C61
 143+ 8C61
 144+ 8C61              edit_file_ex
 145+ 8C61 3A 70 A4     	ld a,(page_main) ;основная страница с каталогом
 146+ 8C64              	OS_SET_PAGE_SLOT3
 146+ 8C64 0E 1C       >    ld c,#1c
 146+ 8C66 E7          >    rst #20
 147+ 8C67 C3 84 80     	jp nc_wait
 148+ 8C6A
 149+ 8C6A
 150+ 8C6A
 151+ 8C6A              ;сохранить файл
 152+ 8C6A              edit_file_save
 153+ 8C6A 21 4A A2     	ld hl,file_name_cur		;строка с именем
 154+ 8C6D              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 154+ 8C6D 0E 21       >    ld c,#21
 154+ 8C6F E7          >    rst #20
 155+ 8C70 DA 2A 88     	jp c,load_file_error
 156+ 8C73
 157+ 8C73 21 00 C0     	ld hl,buffer_cat
 158+ 8C76 ED 5B EC 8F  	ld de,(edit_file_size)
 159+ 8C7A              	;ld a,(file_id_cur_r)
 160+ 8C7A              	OS_FILE_WRITE
 160+ 8C7A 0E 24       >    ld c,#24
 160+ 8C7C E7          >    rst #20
 161+ 8C7D DA 2A 88     	jp c,load_file_error
 162+ 8C80 18 D3        	jr edit_file_wait_ex1
 163+ 8C82
 164+ 8C82
 165+ 8C82
 166+ 8C82
 167+ 8C82
 168+ 8C82
 169+ 8C82              ;удалить символ слева
 170+ 8C82              edit_file_backspace
 171+ 8C82              	;проверить на начало
 172+ 8C82 2A EF 8F     	ld hl,(edit_file_pos_cur)
 173+ 8C85 01 00 C0     	ld bc,buffer_cat
 174+ 8C88 A7           	and a
 175+ 8C89 ED 42        	sbc hl,bc
 176+ 8C8B 28 3D        	jr z,edit_file_backspace_err
 177+ 8C8D              	;сдвинуть текст
 178+ 8C8D 2A 70 8B     	ld hl,(view_file_end)
 179+ 8C90 ED 4B EF 8F  	ld bc,(edit_file_pos_cur) ;позиция курсора
 180+ 8C94 A7           	and a
 181+ 8C95 ED 42        	sbc hl,bc
 182+ 8C97 28 31        	jr z,edit_file_backspace_err
 183+ 8C99 44 4D        	ld bc,hl ;сколько сдвигать
 184+ 8C9B 2A EF 8F     	ld hl,(edit_file_pos_cur) ;позиция курсора
 185+ 8C9E 54 5D        	ld de,hl
 186+ 8CA0 1B           	dec de
 187+ 8CA1 ED B0        	ldir
 188+ 8CA3 AF           	xor a
 189+ 8CA4              	;dec de
 190+ 8CA4 12           	ld (de),a ;в конце 0
 191+ 8CA5
 192+ 8CA5
 193+ 8CA5
 194+ 8CA5              	;уменьшить размер и изменить окончание
 195+ 8CA5 2A EC 8F     	ld hl,(edit_file_size)
 196+ 8CA8 2B           	dec hl
 197+ 8CA9 22 EC 8F     	ld (edit_file_size),hl
 198+ 8CAC
 199+ 8CAC 2A 70 8B     	ld hl,(view_file_end)
 200+ 8CAF 2B           	dec hl
 201+ 8CB0 22 70 8B     	ld (view_file_end),hl ;
 202+ 8CB3
 203+ 8CB3              	;флаг что изменён
 204+ 8CB3 3E 01        	ld a,1
 205+ 8CB5 32 EE 8F     	ld (edit_file_save_flag),a ;флаг для сохранения
 206+ 8CB8
 207+ 8CB8 CD 50 8F     	call edit_move_left_cursor ;курсор влево
 208+ 8CBB 2A EF 8F     	ld hl,(edit_file_pos_cur)
 209+ 8CBE 22 F1 8F     	ld (edit_file_pos_old),hl
 210+ 8CC1
 211+ 8CC1 CD 13 8A     	call print_file_text ;напечатать всё
 212+ 8CC4 CD 58 8E     	call print_file_cursor ;курсор
 213+ 8CC7
 214+ 8CC7 C3 E7 8B     	jp edit_file_wait
 215+ 8CCA
 216+ 8CCA
 217+ 8CCA              edit_file_backspace_err
 218+ 8CCA
 219+ 8CCA C3 E7 8B     	jp edit_file_wait
 220+ 8CCD
 221+ 8CCD
 222+ 8CCD
 223+ 8CCD
 224+ 8CCD
 225+ 8CCD
 226+ 8CCD
 227+ 8CCD
 228+ 8CCD
 229+ 8CCD
 230+ 8CCD
 231+ 8CCD
 232+ 8CCD              ;вставка символа
 233+ 8CCD              edit_file_insert_sym
 234+ 8CCD              	;проверить есть ли место
 235+ 8CCD 2A 70 8B     	ld hl,(view_file_end)
 236+ 8CD0 23           	inc hl ;ffff?
 237+ 8CD1 7C           	ld a,h
 238+ 8CD2 B5           	or l
 239+ 8CD3 28 45        	jr z,edit_file_insert_sym_err
 240+ 8CD5 23           	inc hl ;fffe?
 241+ 8CD6 7C           	ld a,h
 242+ 8CD7 B5           	or l
 243+ 8CD8 28 40        	jr z,edit_file_insert_sym_err
 244+ 8CDA              	;сдвинуть текст
 245+ 8CDA 2B           	dec hl
 246+ 8CDB 2B           	dec hl
 247+ 8CDC ED 4B EF 8F  	ld bc,(edit_file_pos_cur) ;позиция курсора
 248+ 8CE0 A7           	and a
 249+ 8CE1 ED 42        	sbc hl,bc
 250+ 8CE3 28 35        	jr z,edit_file_insert_sym_err
 251+ 8CE5 44 4D        	ld bc,hl ;сколько сдвигать
 252+ 8CE7 ED 5B 70 8B  	ld de,(view_file_end) ;позиция курсора
 253+ 8CEB 62 6B        	ld hl,de
 254+ 8CED 2B           	dec hl
 255+ 8CEE ED B8        	lddr
 256+ 8CF0
 257+ 8CF0              	;увеличить размер и изменить окончание
 258+ 8CF0 2A EC 8F     	ld hl,(edit_file_size)
 259+ 8CF3 23           	inc hl
 260+ 8CF4 22 EC 8F     	ld (edit_file_size),hl
 261+ 8CF7
 262+ 8CF7 2A 70 8B     	ld hl,(view_file_end)
 263+ 8CFA 23           	inc hl
 264+ 8CFB 22 70 8B     	ld (view_file_end),hl ;увеличить
 265+ 8CFE
 266+ 8CFE              	;флаг что изменён
 267+ 8CFE 3E 01        	ld a,1
 268+ 8D00 32 EE 8F     	ld (edit_file_save_flag),a ;флаг для сохранения
 269+ 8D03
 270+ 8D03 2A EF 8F     	ld hl,(edit_file_pos_cur) ;позиция курсора
 271+ 8D06 3A 5E A4     	ld a,(key_pressed)
 272+ 8D09 77           	ld (hl),a
 273+ 8D0A
 274+ 8D0A CD 1C 8F     	call edit_move_right_cursor ;курсор вправо
 275+ 8D0D 2A EF 8F     	ld hl,(edit_file_pos_cur)
 276+ 8D10 22 F1 8F     	ld (edit_file_pos_old),hl
 277+ 8D13
 278+ 8D13 CD 13 8A     	call print_file_text ;напечатать всё
 279+ 8D16 CD 58 8E     	call print_file_cursor ;курсор
 280+ 8D19
 281+ 8D19              	;
 282+ 8D19 C9           	ret
 283+ 8D1A
 284+ 8D1A              edit_file_insert_sym_err
 285+ 8D1A 11 00 00     	ld de,0
 286+ 8D1D              	OS_SET_XY
 286+ 8D1D 0E 01       >    ld c,#01
 286+ 8D1F E7          >    rst #20
 287+ 8D20
 288+ 8D20 3E 0A        	ld a,color_error ;цвет ошибки
 289+ 8D22 06 0C        	ld b,#c
 290+ 8D24              	OS_SET_COLOR
 290+ 8D24 0E 06       >    ld c,#06
 290+ 8D26 E7          >    rst #20
 291+ 8D27
 292+ 8D27 21 54 A5     	ld hl,msg_mem_err ;нет памяти
 293+ 8D2A              	OS_PRINTZ ;печать
 293+ 8D2A 0E 09       >    ld c,#09
 293+ 8D2C E7          >    rst #20
 294+ 8D2D
 295+ 8D2D 3E 0F        	ld a,color_backgr ;цвет основной
 296+ 8D2F 06 0C        	ld b,#c
 297+ 8D31              	OS_SET_COLOR
 297+ 8D31 0E 06       >    ld c,#06
 297+ 8D33 E7          >    rst #20
 298+ 8D34 37           	scf
 299+ 8D35 C9           	ret
 300+ 8D36
 301+ 8D36
 302+ 8D36
 303+ 8D36
 304+ 8D36
 305+ 8D36
 306+ 8D36
 307+ 8D36
 308+ 8D36
 309+ 8D36
 310+ 8D36              edit_file_down ;вниз на строчку
 311+ 8D36 CD 7E 8F     	call next_line_cursor ;курсор вниз
 312+ 8D39 DA 59 8D     	jp c,edit_file_down1
 313+ 8D3C
 314+ 8D3C 3A F6 8F     	ld a,(edit_file_pos_cur_xy+1) ;y
 315+ 8D3F 3C           	inc a
 316+ 8D40 FE 18        	cp view_text_bot
 317+ 8D42 38 15        	jr c,edit_file_down1
 318+ 8D44
 319+ 8D44              	;сдвинуть фокус
 320+ 8D44 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 321+ 8D47 22 69 8B     	ld (view_file_pos_cur),hl
 322+ 8D4A CD 3A 8B     	call next_line ;вперёд на строку
 323+ 8D4D DA 59 8D     	jp c,edit_file_down1 ;если не удачно
 324+ 8D50 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 325+ 8D53 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 326+ 8D56 CD 13 8A     	call print_file_text ;напечатать всю страницу
 327+ 8D59
 328+ 8D59              edit_file_down1
 329+ 8D59 CD 58 8E     	call print_file_cursor ;напечатать курсор
 330+ 8D5C 2A EF 8F     	ld hl,(edit_file_pos_cur)
 331+ 8D5F 22 F1 8F     	ld (edit_file_pos_old),hl
 332+ 8D62
 333+ 8D62 C3 E7 8B     	jp edit_file_wait
 334+ 8D65
 335+ 8D65
 336+ 8D65
 337+ 8D65
 338+ 8D65
 339+ 8D65
 340+ 8D65
 341+ 8D65              edit_file_up ;вверх на строчку
 342+ 8D65 CD A6 8F     	call prev_line_cursor ;
 343+ 8D68 28 03        	jr z,edit_file_up2
 344+ 8D6A DA 89 8D     	jp c,edit_file_up1 ;если не удачно
 345+ 8D6D              edit_file_up2
 346+ 8D6D 3A F6 8F     	ld a,(edit_file_pos_cur_xy+1) ;y
 347+ 8D70 FE 01        	cp view_text_top
 348+ 8D72 20 15        	jr nz,edit_file_up1
 349+ 8D74
 350+ 8D74              	;сдвинуть фокус
 351+ 8D74 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 352+ 8D77 22 69 8B     	ld (view_file_pos_cur),hl
 353+ 8D7A CD 48 8B     	call prev_line ;
 354+ 8D7D DA 89 8D     	jp c,edit_file_up1
 355+ 8D80
 356+ 8D80 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 357+ 8D83 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 358+ 8D86 CD 13 8A     	call print_file_text ;напечатать всю страницу
 359+ 8D89
 360+ 8D89              edit_file_up1
 361+ 8D89 CD 58 8E     	call print_file_cursor ;напечатать курсор
 362+ 8D8C 2A EF 8F     	ld hl,(edit_file_pos_cur)
 363+ 8D8F 22 F1 8F     	ld (edit_file_pos_old),hl
 364+ 8D92 C3 E7 8B     	jp edit_file_wait
 365+ 8D95
 366+ 8D95
 367+ 8D95
 368+ 8D95
 369+ 8D95
 370+ 8D95              edit_right ;вправо
 371+ 8D95 CD 1C 8F     	call edit_move_right_cursor
 372+ 8D98 38 17        	jr c,edit_right_ex
 373+ 8D9A              	;jr z,edit_right_ex
 374+ 8D9A 3A F5 8F     	ld a,(edit_file_pos_cur_xy) ;x
 375+ 8D9D 3C           	inc a
 376+ 8D9E FE 50        	cp 80 ;ограничение справа
 377+ 8DA0 38 0F        	jr c,edit_right1
 378+ 8DA2              	;тут надо промотать вправо весь текст
 379+ 8DA2
 380+ 8DA2 2A 67 8B     	ld hl,(view_move_right_val)
 381+ 8DA5 23           	inc hl
 382+ 8DA6 7C           	ld a,h ;сдвиг вправо не больше 65535
 383+ 8DA7 B5           	or l
 384+ 8DA8 CA B1 8D     	jp z,edit_right2
 385+ 8DAB 22 67 8B     	ld (view_move_right_val),hl
 386+ 8DAE CD 13 8A     	call print_file_text ;напечатать всю страницу
 387+ 8DB1              edit_right2
 388+ 8DB1              	;ld a,80-1 ;курсор остаётся на краю
 389+ 8DB1              edit_right1
 390+ 8DB1              	;ld (edit_file_pos_cur_xy),a ;x
 391+ 8DB1
 392+ 8DB1              edit_right_ex
 393+ 8DB1 CD 58 8E     	call print_file_cursor ;напечатать курсор
 394+ 8DB4 2A EF 8F     	ld hl,(edit_file_pos_cur)
 395+ 8DB7 22 F1 8F     	ld (edit_file_pos_old),hl
 396+ 8DBA C3 E7 8B     	jp edit_file_wait
 397+ 8DBD
 398+ 8DBD
 399+ 8DBD
 400+ 8DBD
 401+ 8DBD
 402+ 8DBD
 403+ 8DBD
 404+ 8DBD              edit_left ;влево
 405+ 8DBD CD 50 8F     	call edit_move_left_cursor
 406+ 8DC0 38 17        	jr c,edit_left_ex
 407+ 8DC2              	;jr z,edit_left_ex
 408+ 8DC2 3A F5 8F     	ld a,(edit_file_pos_cur_xy) ;x
 409+ 8DC5 B7           	or a ;ограничение слева
 410+ 8DC6 28 11        	jr z,edit_left1
 411+ 8DC8              	;тут надо промотать влево весь текст
 412+ 8DC8 2A 67 8B     	ld hl,(view_move_right_val)
 413+ 8DCB 7C           	ld a,h
 414+ 8DCC B5           	or l
 415+ 8DCD CA D7 8D     	jp z,edit_left2
 416+ 8DD0 2B           	dec hl
 417+ 8DD1 22 67 8B     	ld (view_move_right_val),hl
 418+ 8DD4 CD 13 8A     	call print_file_text ;напечатать всю страницу
 419+ 8DD7              edit_left2
 420+ 8DD7 3E 01        	ld a,1 ;курсор остаётся на краю
 421+ 8DD9              edit_left1
 422+ 8DD9              	;dec a
 423+ 8DD9              	;ld (edit_file_pos_cur_xy),a ;x
 424+ 8DD9
 425+ 8DD9              edit_left_ex
 426+ 8DD9 CD 58 8E     	call print_file_cursor ;напечатать курсор
 427+ 8DDC 2A EF 8F     	ld hl,(edit_file_pos_cur)
 428+ 8DDF 22 F1 8F     	ld (edit_file_pos_old),hl
 429+ 8DE2 C3 E7 8B     	jp edit_file_wait
 430+ 8DE5
 431+ 8DE5
 432+ 8DE5
 433+ 8DE5
 434+ 8DE5
 435+ 8DE5
 436+ 8DE5
 437+ 8DE5
 438+ 8DE5              edit_page_up ;на страницу назад
 439+ 8DE5 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 440+ 8DE8 22 69 8B     	ld (view_file_pos_cur),hl
 441+ 8DEB 06 16        	ld b,view_text_bot-2
 442+ 8DED              edit_page_up_cl
 443+ 8DED CD 48 8B     	call prev_line ;
 444+ 8DF0              	;call prev_line_cursor ;
 445+ 8DF0 38 04        	jr c,edit_page_up_ex ;если не удачно
 446+ 8DF2 28 02        	jr z,edit_page_up_ex
 447+ 8DF4 10 F7        	djnz edit_page_up_cl
 448+ 8DF6              edit_page_up_ex
 449+ 8DF6 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 450+ 8DF9 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 451+ 8DFC 22 EF 8F     	ld (edit_file_pos_cur),hl ;курсор будет там же где фокус
 452+ 8DFF              	;ld (edit_file_pos_old),hl
 453+ 8DFF CD 1C 8F     	call edit_move_right_cursor ;ещё на символ
 454+ 8E02
 455+ 8E02 CD 13 8A     	call print_file_text ;напечатать всю страницу
 456+ 8E05
 457+ 8E05 CD 58 8E     	call print_file_cursor ;напечатать курсор
 458+ 8E08 2A EF 8F     	ld hl,(edit_file_pos_cur)
 459+ 8E0B 22 F1 8F     	ld (edit_file_pos_old),hl
 460+ 8E0E C3 E7 8B     	jp edit_file_wait
 461+ 8E11
 462+ 8E11
 463+ 8E11
 464+ 8E11              edit_page_down ;на страницу вперёд
 465+ 8E11 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;фокус
 466+ 8E14 22 69 8B     	ld (view_file_pos_cur),hl
 467+ 8E17 06 16        	ld b,view_text_bot-2
 468+ 8E19              edit_page_down_cl
 469+ 8E19 CD 3A 8B     	call next_line ;
 470+ 8E1C              	;call next_line_cursor ;
 471+ 8E1C 38 04        	jr c,edit_page_down_ex ;если не удачно
 472+ 8E1E 28 02        	jr z,edit_page_down_ex
 473+ 8E20 10 F7        	djnz edit_page_down_cl
 474+ 8E22              edit_page_down_ex
 475+ 8E22 2A 69 8B     	ld hl,(view_file_pos_cur) ;запомнить фокус
 476+ 8E25 22 6B 8B     	ld (view_file_pos_cur_focus),hl
 477+ 8E28 22 EF 8F     	ld (edit_file_pos_cur),hl ;курсор будет там же где фокус
 478+ 8E2B              	;ld (edit_file_pos_old),hl
 479+ 8E2B
 480+ 8E2B CD 1C 8F     	call edit_move_right_cursor ;ещё на символ
 481+ 8E2E
 482+ 8E2E CD 13 8A     	call print_file_text ;напечатать всю страницу
 483+ 8E31 CD 58 8E     	call print_file_cursor ;напечатать курсор
 484+ 8E34 2A EF 8F     	ld hl,(edit_file_pos_cur)
 485+ 8E37 22 F1 8F     	ld (edit_file_pos_old),hl
 486+ 8E3A C3 E7 8B     	jp edit_file_wait
 487+ 8E3D
 488+ 8E3D
 489+ 8E3D
 490+ 8E3D              print_menu_edit ;печать меню редактора
 491+ 8E3D 3E 18        	ld a,#18
 492+ 8E3F 06 28        	ld b,color_backgr_hi ;цвет
 493+ 8E41              	OS_PAINT_LINE ;линия внизу
 493+ 8E41 0E 04       >    ld c,#04
 493+ 8E43 E7          >    rst #20
 494+ 8E44 3E 28        	ld a,color_backgr_hi ;цвет
 495+ 8E46 06 0C        	ld b,#c
 496+ 8E48              	OS_SET_COLOR
 496+ 8E48 0E 06       >    ld c,#06
 496+ 8E4A E7          >    rst #20
 497+ 8E4B 11 00 18     	ld de,#1800+0*8
 498+ 8E4E              	OS_SET_XY
 498+ 8E4E 0E 01       >    ld c,#01
 498+ 8E50 E7          >    rst #20
 499+ 8E51 21 D0 8F     	ld hl,msg_menu_edit
 500+ 8E54              	OS_PRINTZ
 500+ 8E54 0E 09       >    ld c,#09
 500+ 8E56 E7          >    rst #20
 501+ 8E57 C9           	ret
 502+ 8E58
 503+ 8E58              ; print_menu_edit_top ;печать меню просмотрщика верхнее
 504+ 8E58              	; xor a
 505+ 8E58              	; ld b,color_backgr_hi ;цвет
 506+ 8E58              	; OS_PAINT_LINE ;линия вверху
 507+ 8E58              	; ld a,color_backgr_hi ;цвет
 508+ 8E58              	; ld b,#c
 509+ 8E58              	; OS_SET_COLOR
 510+ 8E58              	; ld de,#0024
 511+ 8E58              	; OS_SET_XY
 512+ 8E58              	; ld hl,file_name_cur
 513+ 8E58              	; OS_PRINTZ
 514+ 8E58              	; ret
 515+ 8E58
 516+ 8E58
 517+ 8E58
 518+ 8E58              print_file_cursor	;печать только курсора, в основном пустой цикл по тексту
 519+ 8E58 AF           	xor a ;флаг выхода из цикла
 520+ 8E59 32 1B 8F     	ld (print_line_cursor_flag),a
 521+ 8E5C 3E 04        	ld a,color_edit_text ;цвет обычный
 522+ 8E5E 06 0C        	ld b,#c
 523+ 8E60              	OS_SET_COLOR
 523+ 8E60 0E 06       >    ld c,#06
 523+ 8E62 E7          >    rst #20
 524+ 8E63 2A F1 8F     	ld hl,(edit_file_pos_old)
 525+ 8E66 22 F3 8F     	ld (edit_file_pos_tmp),hl
 526+ 8E69 CD 81 8E     	call print_file_cursor_one ;"стереть" старый курсор
 527+ 8E6C
 528+ 8E6C AF           	xor a ;флаг выхода из цикла
 529+ 8E6D 32 1B 8F     	ld (print_line_cursor_flag),a
 530+ 8E70 3E 20        	ld a,color_edit_cursor ;цвет курсор
 531+ 8E72 06 0C        	ld b,#c
 532+ 8E74              	OS_SET_COLOR
 532+ 8E74 0E 06       >    ld c,#06
 532+ 8E76 E7          >    rst #20
 533+ 8E77 2A EF 8F     	ld hl,(edit_file_pos_cur)
 534+ 8E7A 22 F3 8F     	ld (edit_file_pos_tmp),hl
 535+ 8E7D CD 81 8E     	call print_file_cursor_one ;напечатать новый
 536+ 8E80 C9           	ret
 537+ 8E81
 538+ 8E81              print_file_cursor_one
 539+ 8E81
 540+ 8E81 3E 01        	ld a,view_text_top ;первая строка
 541+ 8E83 32 6D 8B     	ld (view_file_y_cur),a
 542+ 8E86 2A 6B 8B     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 543+ 8E89 22 69 8B     	ld (view_file_pos_cur),hl
 544+ 8E8C              print_file_cursor_cl
 545+ 8E8C 2A 69 8B     	ld hl,(view_file_pos_cur)
 546+ 8E8F CD A7 8E     	call print_line_cursor
 547+ 8E92 38 11        	jr c,print_file_cursor_ex
 548+ 8E94              	;если уже напечатали курсор
 549+ 8E94 3A 1B 8F     	ld a,(print_line_cursor_flag)
 550+ 8E97 B7           	or a
 551+ 8E98 C0           	ret nz
 552+ 8E99              	; call next_line ;найти следующую строку
 553+ 8E99              	; ret c
 554+ 8E99
 555+ 8E99 3A 6D 8B     	ld a,(view_file_y_cur)
 556+ 8E9C 3C           	inc a
 557+ 8E9D 32 6D 8B     	ld (view_file_y_cur),a
 558+ 8EA0 FE 18        	cp view_text_bot
 559+ 8EA2 38 E8        	jr c,print_file_cursor_cl
 560+ 8EA4 C9           	ret
 561+ 8EA5
 562+ 8EA5              print_file_cursor_ex
 563+ 8EA5              	;тут очистить остальные строки
 564+ 8EA5              	; ld a,(view_file_y_cur)
 565+ 8EA5              	; inc a
 566+ 8EA5              	; cp edit_text_bot
 567+ 8EA5              	; jr nc,print_file_cursor_ex2
 568+ 8EA5              	; ld h,a
 569+ 8EA5              	; ld (view_file_y_cur),a
 570+ 8EA5              	; ld a," "
 571+ 8EA5              	; OS_FILL_LINE ;очистить строку
 572+ 8EA5              	; jr print_file_cursor_ex
 573+ 8EA5              ; print_file_cursor_ex2
 574+ 8EA5 37           	scf
 575+ 8EA6 C9           	ret
 576+ 8EA7
 577+ 8EA7
 578+ 8EA7
 579+ 8EA7              print_line_cursor ;печать только курсора в цикле одной строки до кода 13, или до правого края экрана, или до конца файла
 580+ 8EA7              ;вх: hl - адрес строки
 581+ 8EA7 CD 9E 8A     	call view_move_right ;промотать направо. если надо
 582+ 8EAA              	;установить позицию
 583+ 8EAA              	; ld a,(view_file_y_cur)
 584+ 8EAA              	; ld d,a
 585+ 8EAA AF           	xor a
 586+ 8EAB 32 6E 8B     	ld (view_file_x_cur),a
 587+ 8EAE              	; ld e,a
 588+ 8EAE              	; OS_SET_XY 	;yx
 589+ 8EAE              print_line_cursor_cl ;цикл
 590+ 8EAE 7E           	ld a,(hl)
 591+ 8EAF FE 0A        	cp 10 ;этот код не печатаем
 592+ 8EB1 28 35        	jr z,print_line_cursor_skip
 593+ 8EB3 FE FF        	cp #ff ;этот код не печатаем
 594+ 8EB5 28 31        	jr z,print_line_cursor_skip
 595+ 8EB7 FE 0D        	cp 13
 596+ 8EB9 28 34        	jr z,print_line_cursor_ex_ok
 597+ 8EBB
 598+ 8EBB              	;push hl
 599+ 8EBB ED 4B F3 8F  	ld bc,(edit_file_pos_tmp)
 600+ 8EBF A7           	and a
 601+ 8EC0 ED 42        	sbc hl,bc
 602+ 8EC2              	;pop hl
 603+ 8EC2 20 19        	jr nz,print_line_cursor_skip1
 604+ 8EC4              	;запомнить координаты
 605+ 8EC4 F5           	push af
 606+ 8EC5 3A 6D 8B     	ld a,(view_file_y_cur)
 607+ 8EC8 32 F6 8F     	ld (edit_file_pos_cur_xy+1),a
 608+ 8ECB 57           	ld d,a
 609+ 8ECC 3A 6E 8B     	ld a,(view_file_x_cur)
 610+ 8ECF 32 F5 8F     	ld (edit_file_pos_cur_xy),a
 611+ 8ED2 5F           	ld e,a
 612+ 8ED3              	OS_SET_XY 	;yx
 612+ 8ED3 0E 01       >    ld c,#01
 612+ 8ED5 E7          >    rst #20
 613+ 8ED6 F1           	pop af
 614+ 8ED7              	OS_PRINT_CHARF ;печать только курсора
 614+ 8ED7 D7          >	rst #10
 615+ 8ED8              	;флаг на выход цикла
 616+ 8ED8 3E 01        	ld a,1
 617+ 8EDA 32 1B 8F     	ld (print_line_cursor_flag),a
 618+ 8EDD
 619+ 8EDD              print_line_cursor_skip1
 620+ 8EDD              	;на следующую позицию
 621+ 8EDD 3A 6E 8B     	ld a,(view_file_x_cur)
 622+ 8EE0 3C           	inc a
 623+ 8EE1 FE 50        	cp 80 ;правый край экрана
 624+ 8EE3 32 6E 8B     	ld (view_file_x_cur),a
 625+ 8EE6 30 2F        	jr nc,print_line_cursor_right ;дошли до правого края
 626+ 8EE8
 627+ 8EE8              print_line_cursor_skip
 628+ 8EE8 CD D6 8A     	call view_file_next_pos ;следующий
 629+ 8EEB 38 28        	jr c,print_line_cursor_ex_end ;на следующий символ
 630+ 8EED 18 BF        	jr print_line_cursor_cl
 631+ 8EEF
 632+ 8EEF              print_line_cursor_ex_ok ;выход норма по коду 13
 633+ 8EEF              	;ещё раз проверить курсор, когда он на коде 13
 634+ 8EEF ED 4B F3 8F  	ld bc,(edit_file_pos_tmp)
 635+ 8EF3 A7           	and a
 636+ 8EF4 ED 42        	sbc hl,bc
 637+ 8EF6              	;pop hl
 638+ 8EF6 C2 D6 8A     	jp nz,view_file_next_pos
 639+ 8EF9              	;запомнить координаты
 640+ 8EF9 3A 6D 8B     	ld a,(view_file_y_cur)
 641+ 8EFC 32 F6 8F     	ld (edit_file_pos_cur_xy+1),a
 642+ 8EFF 57           	ld d,a
 643+ 8F00 3A 6E 8B     	ld a,(view_file_x_cur)
 644+ 8F03 32 F5 8F     	ld (edit_file_pos_cur_xy),a
 645+ 8F06 5F           	ld e,a
 646+ 8F07              	OS_SET_XY 	;yx
 646+ 8F07 0E 01       >    ld c,#01
 646+ 8F09 E7          >    rst #20
 647+ 8F0A 3E 20        	ld a," " ;печатать пробел вместо 13
 648+ 8F0C              	OS_PRINT_CHARF ;печать только курсора
 648+ 8F0C D7          >	rst #10
 649+ 8F0D              	;флаг на выход цикла
 650+ 8F0D 3E 01        	ld a,1
 651+ 8F0F 32 1B 8F     	ld (print_line_cursor_flag),a
 652+ 8F12
 653+ 8F12              	;ld a," "
 654+ 8F12              	;OS_PRINT_CHARF ;печать
 655+ 8F12              	;call printe_clear_end ;добить до конца строки
 656+ 8F12 C3 D6 8A     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 657+ 8F15              	;ret
 658+ 8F15
 659+ 8F15              print_line_cursor_ex_end ;выход если кончился файл
 660+ 8F15              	;call printe_clear_end
 661+ 8F15 37           	scf
 662+ 8F16 C9           	ret
 663+ 8F17
 664+ 8F17              print_line_cursor_right
 665+ 8F17 CD 3A 8B     	call next_line ;позицию  до конца строки
 666+ 8F1A C9           	ret
 667+ 8F1B
 668+ 8F1B
 669+ 8F1B              ; printe_clear_end
 670+ 8F1B              	; ;добить строку пробелами
 671+ 8F1B              	; ld a,(edit_file_x_cur)
 672+ 8F1B              	; inc a
 673+ 8F1B              	; cp 80 ;правый край экрана
 674+ 8F1B              	; ld (edit_file_x_cur),a
 675+ 8F1B              	; ret nc
 676+ 8F1B              	; ;ld a," "
 677+ 8F1B              	; ;OS_PRINT_CHARF ;печать
 678+ 8F1B              	; jr printe_clear_end
 679+ 8F1B
 680+ 8F1B 00           print_line_cursor_flag db 0;флаг прерывания цикла
 681+ 8F1C
 682+ 8F1C
 683+ 8F1C
 684+ 8F1C
 685+ 8F1C
 686+ 8F1C
 687+ 8F1C              edit_move_right_cursor ;перемотка курсор направо
 688+ 8F1C 2A EF 8F     	ld hl,(edit_file_pos_cur)
 689+ 8F1F 22 F3 8F     	ld (edit_file_pos_tmp),hl ;сохранить позицию
 690+ 8F22              edit_move_right_cursor_cl
 691+ 8F22 CD 3A 8F     	call edit_file_next_pos_cursor
 692+ 8F25 38 0B        	jr c,edit_move_right_cursor_err
 693+ 8F27 7E           	ld a,(hl)
 694+ 8F28 FE 0A        	cp 10 ;этот код пропускаем
 695+ 8F2A 28 F6        	jr z,edit_move_right_cursor_cl
 696+ 8F2C FE FF        	cp #ff ;этот код пропускаем
 697+ 8F2E 28 F2        	jr z,edit_move_right_cursor_cl
 698+ 8F30              	; cp 13 ;
 699+ 8F30              	; jr z,edit_move_right_cursor_cl
 700+ 8F30              edit_move_right_cursor_ok
 701+ 8F30 AF           	xor a ;ok
 702+ 8F31 C9           	ret
 703+ 8F32              edit_move_right_cursor_err
 704+ 8F32 2A F3 8F     	ld hl,(edit_file_pos_tmp) ;вернуть, если попали на непечатный символ
 705+ 8F35 22 EF 8F     	ld (edit_file_pos_cur),hl
 706+ 8F38 37           	scf
 707+ 8F39 C9           	ret
 708+ 8F3A
 709+ 8F3A
 710+ 8F3A              ;получение следующей позиции для курсора
 711+ 8F3A              edit_file_next_pos_cursor
 712+ 8F3A              	; ld a,(edit_file_load_all) ;флаг что файл весь в памяти
 713+ 8F3A              	; or a
 714+ 8F3A              	; jr z,edit_file_next_pos_cursor_big
 715+ 8F3A              	;если текст не большой
 716+ 8F3A 2A 70 8B     	ld hl,(view_file_end) ;конец текста известен
 717+ 8F3D ED 5B EF 8F  	ld de,(edit_file_pos_cur)
 718+ 8F41 13           	inc de ;вперёд
 719+ 8F42 A7           	and a
 720+ 8F43 ED 52        	sbc hl,de
 721+ 8F45 38 07        	jr c,edit_file_next_pos_cursor_end
 722+ 8F47 ED 53 EF 8F  	ld (edit_file_pos_cur),de
 723+ 8F4B EB           	ex de,hl ;на выходе адрес в HL
 724+ 8F4C B7           	or a
 725+ 8F4D C9           	ret
 726+ 8F4E
 727+ 8F4E
 728+ 8F4E
 729+ 8F4E              ; edit_file_next_pos_cursor_big
 730+ 8F4E              	; ;если текст большой
 731+ 8F4E              	; ld hl,(edit_file_pos_cur)	;текущая позиция
 732+ 8F4E              	; inc hl ;вперёд
 733+ 8F4E              	; ld a,h
 734+ 8F4E              	; cp #c0 ;если вышли за пределы окна
 735+ 8F4E              	; jr c,edit_file_next_pos_cursor_end
 736+ 8F4E              	; ld (edit_file_pos_cur),hl
 737+ 8F4E              	; or a
 738+ 8F4E              	; ret
 739+ 8F4E
 740+ 8F4E              edit_file_next_pos_cursor_end
 741+ 8F4E              	;не смогли шагнуть вперёд
 742+ 8F4E              	; ; ld a,1 ;флаг что внизу
 743+ 8F4E              	; ; ld (edit_file_bot_flag),a
 744+ 8F4E 37           	scf ;ошибка
 745+ 8F4F C9           	ret
 746+ 8F50
 747+ 8F50
 748+ 8F50
 749+ 8F50
 750+ 8F50
 751+ 8F50
 752+ 8F50
 753+ 8F50              edit_move_left_cursor ;перемотка курсор направо
 754+ 8F50              	; ld bc,(edit_move_left_cursor_val) ;на сколько символов вправо промотать
 755+ 8F50              	; ld a,b
 756+ 8F50              	; or c
 757+ 8F50              	; ret z
 758+ 8F50              	; ld hl,(edit_file_pos_cur)
 759+ 8F50              	; ld (edit_file_pos_tmp),hl
 760+ 8F50              edit_move_left_cursor_cl
 761+ 8F50 CD 68 8F     	call edit_file_prev_pos_cursor
 762+ 8F53 38 0B        	jr c,edit_move_left_cursor_err
 763+ 8F55              	;jr z,edit_move_left_cursor_ok ;если пришли в начало
 764+ 8F55 7E           	ld a,(hl)
 765+ 8F56 FE 0A        	cp 10 ;этот код пропускаем
 766+ 8F58 28 F6        	jr z,edit_move_left_cursor_cl
 767+ 8F5A FE FF        	cp #ff ;этот код пропускаем
 768+ 8F5C 28 F2        	jr z,edit_move_left_cursor_cl
 769+ 8F5E              	; cp 13 ;
 770+ 8F5E              	; jr z,edit_move_left_cursor_cl
 771+ 8F5E              edit_move_left_cursor_ok
 772+ 8F5E AF           	xor a ;ok
 773+ 8F5F C9           	ret
 774+ 8F60              edit_move_left_cursor_err
 775+ 8F60              	;ld hl,(edit_file_pos_tmp) ;вернуть, если попали на непечатный символ
 776+ 8F60 21 00 C0     	ld hl,buffer_cat ;в начало
 777+ 8F63 22 EF 8F     	ld (edit_file_pos_cur),hl
 778+ 8F66 37           	scf
 779+ 8F67 C9           	ret
 780+ 8F68
 781+ 8F68
 782+ 8F68
 783+ 8F68
 784+ 8F68
 785+ 8F68              ;получение предыдущей позиции
 786+ 8F68              edit_file_prev_pos_cursor
 787+ 8F68              	; ld a,(edit_file_load_all) ;флаг что файл весь в памяти
 788+ 8F68              	; or a
 789+ 8F68              	; jr z,edit_file_prev_pos_cursor_big
 790+ 8F68              	;если текст не большой
 791+ 8F68 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 792+ 8F6B ED 5B EF 8F  	ld de,(edit_file_pos_cur) ;текущая позиция
 793+ 8F6F 1B           	dec de ;назад
 794+ 8F70 A7           	and a
 795+ 8F71 ED 52        	sbc hl,de
 796+ 8F73              	;jr z,edit_file_prev_pos_cursor_top ;если пришли в начало
 797+ 8F73 30 07        	jr nc,edit_file_prev_pos_cursor_end
 798+ 8F75              	;можно шагнуть назад
 799+ 8F75 ED 53 EF 8F  	ld (edit_file_pos_cur),de
 800+ 8F79 EB           	ex de,hl ;на выходе адрес в HL
 801+ 8F7A AF           	xor a
 802+ 8F7B              	;inc a ;a=1
 803+ 8F7B C9           	ret
 804+ 8F7C              ; edit_file_prev_pos_cursor_top
 805+ 8F7C              	; ;если в начале
 806+ 8F7C              	; ld (edit_file_pos_cur),de
 807+ 8F7C              	; ex de,hl ;на выходе адрес в HL
 808+ 8F7C              	; xor a ;a=0
 809+ 8F7C              	; ret
 810+ 8F7C
 811+ 8F7C
 812+ 8F7C              ; edit_file_prev_pos_cursor_big
 813+ 8F7C              	; ;если текст большой
 814+ 8F7C              	; ld hl,(edit_file_pos_cur)	;текущая позиция
 815+ 8F7C              	; dec hl ;назад
 816+ 8F7C              	; ld a,h
 817+ 8F7C              	; cp #c0 ;если вышли за пределы окна
 818+ 8F7C              	; jr c,edit_file_prev_pos_cursor_end
 819+ 8F7C              	; ld (edit_file_pos_cur),hl
 820+ 8F7C              	; or a
 821+ 8F7C              	; ret
 822+ 8F7C
 823+ 8F7C              edit_file_prev_pos_cursor_end
 824+ 8F7C              	;не смогли шагнуть назад
 825+ 8F7C              	;ld hl,buffer_cat ;тут лежит текст
 826+ 8F7C              	;ld (edit_file_pos_cur),hl ;текущая позиция в самом начале
 827+ 8F7C              	;вернулись в начало
 828+ 8F7C 37           	scf ;
 829+ 8F7D C9           	ret
 830+ 8F7E
 831+ 8F7E
 832+ 8F7E
 833+ 8F7E
 834+ 8F7E              next_line_cursor ;поиск следующей строки для курсора
 835+ 8F7E 2A EF 8F     	ld hl,(edit_file_pos_cur)
 836+ 8F81 22 F3 8F     	ld (edit_file_pos_tmp),hl ;сохранить позицию
 837+ 8F84              next_line_cursor_cl
 838+ 8F84 CD 3A 8F     	call edit_file_next_pos_cursor
 839+ 8F87 38 15        	jr c,next_line_cursor_err
 840+ 8F89              	;ret z
 841+ 8F89 7E           	ld a,(hl)
 842+ 8F8A FE 0D        	cp 13
 843+ 8F8C 20 F6        	jr nz,next_line_cursor_cl
 844+ 8F8E              	;тут нашли конец строки
 845+ 8F8E              next_line_cursor_cl1
 846+ 8F8E              	;ещё пропустить лишнее
 847+ 8F8E CD 3A 8F     	call edit_file_next_pos_cursor
 848+ 8F91 38 0B        	jr c,next_line_cursor_err
 849+ 8F93 7E           	ld a,(hl)
 850+ 8F94 FE 0A        	cp 10
 851+ 8F96 28 F6        	jr z,next_line_cursor_cl1
 852+ 8F98 FE FF        	cp #ff
 853+ 8F9A 28 F2        	jr z,next_line_cursor_cl1
 854+ 8F9C              next_line_cursor_ok
 855+ 8F9C AF           	xor a
 856+ 8F9D C9           	ret
 857+ 8F9E              next_line_cursor_err
 858+ 8F9E 2A F3 8F     	ld hl,(edit_file_pos_tmp)
 859+ 8FA1 22 EF 8F     	ld (edit_file_pos_cur),hl ;восстановить позицию
 860+ 8FA4 37           	scf
 861+ 8FA5 C9           	ret
 862+ 8FA6
 863+ 8FA6
 864+ 8FA6
 865+ 8FA6
 866+ 8FA6
 867+ 8FA6
 868+ 8FA6              prev_line_cursor ;поиск предыдущей строки для курсора
 869+ 8FA6              ;если достигнуто начало файла - вернёт адрес начальный
 870+ 8FA6              	;сначала в конец предыдущей
 871+ 8FA6              	; ld hl,(edit_file_pos_cur)
 872+ 8FA6              	; ld (edit_file_pos_tmp),hl ;сохранить позицию
 873+ 8FA6              prev_line_cursor_cl
 874+ 8FA6 CD 68 8F     	call edit_file_prev_pos_cursor
 875+ 8FA9              	;jr z,prev_line_cursor_ok
 876+ 8FA9 38 1D        	jr c,prev_line_cursor_err
 877+ 8FAB 7E           	ld a,(hl)
 878+ 8FAC FE 0D        	cp 13
 879+ 8FAE 20 F6        	jr nz,prev_line_cursor_cl
 880+ 8FB0              	;теперь в начало предыдущей
 881+ 8FB0              prev_line_cursor_cl1
 882+ 8FB0 CD 68 8F     	call edit_file_prev_pos_cursor
 883+ 8FB3              	;jr z,prev_line_cursor_ok
 884+ 8FB3 38 13        	jr c,prev_line_cursor_err
 885+ 8FB5 7E           	ld a,(hl)
 886+ 8FB6 FE 0D        	cp 13
 887+ 8FB8 20 F6        	jr nz,prev_line_cursor_cl1
 888+ 8FBA              prev_line_cursor_cl2
 889+ 8FBA CD 3A 8F     	call edit_file_next_pos_cursor ;ещё на символ обратно
 890+ 8FBD 7E           	ld a,(hl)
 891+ 8FBE FE 0A        	cp 10
 892+ 8FC0 28 F8        	jr z,prev_line_cursor_cl2
 893+ 8FC2 FE FF        	cp #ff
 894+ 8FC4 28 F4        	jr z,prev_line_cursor_cl2
 895+ 8FC6
 896+ 8FC6              prev_line_cursor_ok
 897+ 8FC6 AF           	xor a
 898+ 8FC7 C9           	ret
 899+ 8FC8              prev_line_cursor_err
 900+ 8FC8              	; ld hl,(edit_file_pos_tmp)
 901+ 8FC8 21 00 C0     	ld hl,buffer_cat ;в начало
 902+ 8FCB 22 EF 8F     	ld (edit_file_pos_cur),hl
 903+ 8FCE 37           	scf
 904+ 8FCF C9           	ret
 905+ 8FD0
 906+ 8FD0              ; edit_text_bot equ 24 ;последняя строка для печати
 907+ 8FD0              ; edit_text_top equ 1 ;первая строка
 908+ 8FD0              ; edit_text_lines equ 25-2 ;видимых строк на экране
 909+ 8FD0
 910+ 8FD0
 911+ 8FD0              msg_menu_edit
 912+ 8FD0 42 72 65 61  	db "Break - Exit",0
 912+ 8FD4 6B 20 2D 20
 912+ 8FD8 45 78 69 74
 912+ 8FDC 00
 913+ 8FDD
 914+ 8FDD              msg_menu_edit_save
 915+ 8FDD 53 61 76 65  	db "Save file? Y/N",0
 915+ 8FE1 20 66 69 6C
 915+ 8FE5 65 3F 20 59
 915+ 8FE9 2F 4E 00
 916+ 8FEC
 917+ 8FEC 00 00        edit_file_size dw 0 ;размер текстак
 918+ 8FEE 00           edit_file_save_flag db 0 ;флаг что файл изменён
 919+ 8FEF 00 00        edit_file_pos_cur dw 0 ;текущая позиция в файле
 920+ 8FF1 00 00        edit_file_pos_old dw 0 ;текущая позиция в файле
 921+ 8FF3 00 00        edit_file_pos_tmp dw 0 ;временно
 922+ 8FF5 00 00        edit_file_pos_cur_xy dw 0 ;текущая позиция координаты на экране
 923+ 8FF7              ; ;edit_file_bot_flag db 0 ;флаг что домотали вниз до конца
 924+ 8FF7              ; edit_move_right_val dw 0 ;сдвиг вправо
 925+ 8FF7              ;edit_file_pos_cur dw 0;текущая позиция
 926+ 8FF7              ;edit_file_pos_cur_focus dw 0 ;позиция фокуса
 927+ 8FF7              ;edit_file_y_cur db 0;текущая строка
 928+ 8FF7              ;edit_file_x_cur db 0;текущий столбец
 929+ 8FF7              ; ;edit_file_load_all db 0 ;флаг что файл весь загружен
 930+ 8FF7              ; edit_file_end dw 0 ;конец файлв, или текущего куска
 931+ 8FF7
 932+ 8FF7
# file closed: nc_edit.asm
1647  8FF7              	include GPlay/gplay.asm ;плеер
# file opened: GPlay/gplay.asm
   1+ 8FF7              ;GPlay - приложение для OS GMX
   2+ 8FF7                 ; device ZXSPECTRUM128
   3+ 8FF7              	; include "../os_defs.asm"
   4+ 8FF7              	; org PROG_START
   5+ 8FF7
   6+ 8FF7
   7+ 8FF7              start_gplay
   8+ 8FF7 32 A3 93     	ld (gplay_type),a ;тип формата
   9+ 8FFA
  10+ 8FFA CD EE 80     	call clear_left_panel ;почистить часть экрана
  11+ 8FFD
  12+ 8FFD              	;call release_key
  13+ 8FFD
  14+ 8FFD 21 FF 95     	ld hl,memorystreampages+$FF
  15+ 9000 36 00        	ld (hl),0 ;количество занятых страниц
  16+ 9002
  17+ 9002 3A 60 A4     	ld a,(page_ext01) ;доп страница для данных плеера
  18+ 9005              	OS_SET_PAGE_SLOT3
  18+ 9005 0E 1C       >    ld c,#1c
  18+ 9007 E7          >    rst #20
  19+ 9008
  20+ 9008 11 00 00     	ld de,0
  21+ 900B              	OS_SET_XY
  21+ 900B 0E 01       >    ld c,#01
  21+ 900D E7          >    rst #20
  22+ 900E 21 12 94     	ld hl,msg_title ;имя приложения
  23+ 9011              	OS_PRINTZ ;печать
  23+ 9011 0E 09       >    ld c,#09
  23+ 9013 E7          >    rst #20
  24+ 9014
  25+ 9014 3E 0D        	ld a,13 ;оставим место для шкалы прогресса
  26+ 9016              	OS_PRINT_CHARF
  26+ 9016 D7          >	rst #10
  27+ 9017 3E 0D        	ld a,13
  28+ 9019              	OS_PRINT_CHARF
  28+ 9019 D7          >	rst #10
  29+ 901A 21 4A A2     	ld hl,file_name_cur
  30+ 901D              	OS_PRINTZ
  30+ 901D 0E 09       >    ld c,#09
  30+ 901F E7          >    rst #20
  31+ 9020
  32+ 9020 21 D1 93     	ld hl,txt_load
  33+ 9023              	OS_PRINTZ
  33+ 9023 0E 09       >    ld c,#09
  33+ 9025 E7          >    rst #20
  34+ 9026
  35+ 9026 3E FF        	ld a,255
  36+ 9028 32 5F A4     	ld (file_id_cur_r),a
  37+ 902B
  38+ 902B 3A A3 93     	ld a,(gplay_type)
  39+ 902E              	;переход в на нужный раздел
  40+ 902E
  41+ 902E              start_gplay_pt2
  42+ 902E FE 32        	cp "2"
  43+ 9030 20 06        	jr nz,start_gplay_pt3
  44+ 9032              	;если PT2
  45+ 9032 CD 80 92     	call load_pt2
  46+ 9035 C3 B5 90     	jp exit_gplay
  47+ 9038              	;jp start_gplay_ok
  48+ 9038
  49+ 9038              start_gplay_pt3
  50+ 9038 FE 33        	cp "3"
  51+ 903A 20 06        	jr nz,start_gplay_mod
  52+ 903C              	;если PT3
  53+ 903C CD 87 92     	call load_pt3
  54+ 903F C3 B5 90     	jp exit_gplay
  55+ 9042              	;jp start_gplay_ok
  56+ 9042
  57+ 9042              start_gplay_mod
  58+ 9042 FE 6D        	cp "m"
  59+ 9044 20 06        	jr nz,start_gplay_vgz
  60+ 9046              	;если MOD
  61+ 9046 CD 7A 91     	call load_mod
  62+ 9049 C3 B5 90     	jp exit_gplay
  63+ 904C              	;jp start_gplay_ok
  64+ 904C
  65+ 904C
  66+ 904C              start_gplay_vgz
  67+ 904C FE 7A        	cp "z"
  68+ 904E 20 08        	jr nz,start_gplay_vgm
  69+ 9050              	;если VGZ
  70+ 9050 CD 0A 91     	call load_vgz
  71+ 9053 DA B5 90     	jp c,exit_gplay
  72+ 9056 18 0A        	jr start_gplay_ok
  73+ 9058
  74+ 9058              start_gplay_vgm
  75+ 9058 FE 76        	cp "v"
  76+ 905A 20 59        	jr nz,exit_gplay
  77+ 905C              	;если vgm
  78+ 905C CD 03 91     	call load_vgm
  79+ 905F DA B5 90     	jp c,exit_gplay
  80+ 9062
  81+ 9062
  82+ 9062              start_gplay_ok
  83+ 9062              	;играет
  84+ 9062 21 C1 93     	ld hl,txt_play
  85+ 9065              	OS_PRINTZ
  85+ 9065 0E 09       >    ld c,#09
  85+ 9067 E7          >    rst #20
  86+ 9068
  87+ 9068 21 A4 93     	ld hl,txt_gplay_menu
  88+ 906B              	OS_PRINTZ
  88+ 906B 0E 09       >    ld c,#09
  88+ 906D E7          >    rst #20
  89+ 906E
  90+ 906E              wait_play
  91+ 906E              	OS_WAIT
  91+ 906E DF          >	rst #18
  92+ 906F
  93+ 906F CD EA 92     	call gplay_progress_print
  94+ 9072
  95+ 9072 11 00 0A     	ld de,#0a00
  96+ 9075              	OS_SET_XY
  96+ 9075 0E 01       >    ld c,#01
  96+ 9077 E7          >    rst #20
  97+ 9078 2A 72 96     	ld hl,(memorystreamcurrentaddr)
  98+ 907B CD 44 93     	call toDecimal
  99+ 907E              	OS_PRINTZ
  99+ 907E 0E 09       >    ld c,#09
  99+ 9080 E7          >    rst #20
 100+ 9081
 101+ 9081
 102+ 9081 11 00 0B     	ld de,#0b00
 103+ 9084              	OS_SET_XY
 103+ 9084 0E 01       >    ld c,#01
 103+ 9086 E7          >    rst #20
 104+ 9087 2A 0E 96     	ld hl,(memorystreampageaddr)
 105+ 908A 01 00 95     	ld bc,memorystreampages
 106+ 908D A7           	and a
 107+ 908E ED 42        	sbc hl,bc
 108+ 9090 CD 44 93     	call toDecimal
 109+ 9093              	OS_PRINTZ
 109+ 9093 0E 09       >    ld c,#09
 109+ 9095 E7          >    rst #20
 110+ 9096
 111+ 9096 3A 7A 9C     	ld a,(vgm_play_var)
 112+ 9099 B7           	or a
 113+ 909A 20 19        	jr nz,exit_gplay ; конец пенсни
 114+ 909C              	OS_GET_CHAR
 114+ 909C 0E 10       >    ld c,#10
 114+ 909E E7          >    rst #20
 115+ 909F FE 20        	cp " " ;space
 116+ 90A1 CA B5 90     	jp z,exit_gplay
 117+ 90A4 FE 73        	cp "s" ;stop
 118+ 90A6 CA B5 90     	jp z,exit_gplay
 119+ 90A9 FE 53        	cp "S" ;stop
 120+ 90AB CA B5 90     	jp z,exit_gplay
 121+ 90AE FE 18        	cp 24 ;break
 122+ 90B0 CA B5 90     	jp z,exit_gplay
 123+ 90B3 18 B9        	jr wait_play
 124+ 90B5
 125+ 90B5
 126+ 90B5
 127+ 90B5
 128+ 90B5
 129+ 90B5              exit_gplay ;выход
 130+ 90B5 F5           	push af ;сохранить нажатую клавишу
 131+ 90B6
 132+ 90B6 21 CB 93     	ld hl,txt_stop
 133+ 90B9              	OS_PRINTZ
 133+ 90B9 0E 09       >    ld c,#09
 133+ 90BB E7          >    rst #20
 134+ 90BC
 135+ 90BC CD C7 90     	call gplay_stop
 136+ 90BF
 137+ 90BF 3A 70 A4     	ld a,(page_main) ;основная страница
 138+ 90C2              	OS_SET_PAGE_SLOT3
 138+ 90C2 0E 1C       >    ld c,#1c
 138+ 90C4 E7          >    rst #20
 139+ 90C5
 140+ 90C5 F1           	pop af ;a - код клавиши
 141+ 90C6 C9           	ret
 142+ 90C7
 143+ 90C7
 144+ 90C7              ;заглушить звук
 145+ 90C7              gplay_stop
 146+ 90C7 3A A3 93     	ld a,(gplay_type)
 147+ 90CA FE 32        	cp "2"
 148+ 90CC CA 72 91     	jp z,gplay_stop_ptx
 149+ 90CF FE 33        	cp "3"
 150+ 90D1 CA 72 91     	jp z,gplay_stop_ptx
 151+ 90D4 FE 76        	cp "v"
 152+ 90D6 CA 55 91     	jp z,gplay_stop_vgm_vgz
 153+ 90D9 FE 7A        	cp "z"
 154+ 90DB CA 55 91     	jp z,gplay_stop_vgm_vgz
 155+ 90DE FE 6D        	cp "m"
 156+ 90E0 CA 76 91     	jp z,gplay_stop_mod
 157+ 90E3 C9           	ret
 158+ 90E4
 159+ 90E4
 160+ 90E4
 161+ 90E4              ; delay ;задержка между запросами
 162+ 90E4              	; ld b,50*1 ;
 163+ 90E4              ; delay1
 164+ 90E4              	; OS_WAIT
 165+ 90E4              	; djnz delay1
 166+ 90E4              	; ret
 167+ 90E4
 168+ 90E4
 169+ 90E4              check_BM
 170+ 90E4              	;определение наличия BomgeMoon
 171+ 90E4 AF           	xor a
 172+ 90E5 DB 24        	in a,(MOON_BASE)
 173+ 90E7 FE FF        	cp 255
 174+ 90E9 28 02        	jr z,check_BM1
 175+ 90EB B7           	or a
 176+ 90EC C9           	ret
 177+ 90ED
 178+ 90ED              check_BM1
 179+ 90ED 3E 0A        	ld a,color_error ;цвет ошибки
 180+ 90EF 06 0C        	ld b,#c
 181+ 90F1              	OS_SET_COLOR
 181+ 90F1 0E 06       >    ld c,#06
 181+ 90F3 E7          >    rst #20
 182+ 90F4
 183+ 90F4 21 E9 93     	ld hl,txt_no_BM
 184+ 90F7              	OS_PRINTZ
 184+ 90F7 0E 09       >    ld c,#09
 184+ 90F9 E7          >    rst #20
 185+ 90FA
 186+ 90FA 3E 0F        	ld a,color_backgr ;цвет основной
 187+ 90FC 06 0C        	ld b,#c
 188+ 90FE              	OS_SET_COLOR
 188+ 90FE 0E 06       >    ld c,#06
 188+ 9100 E7          >    rst #20
 189+ 9101 37           	scf ;ошибка
 190+ 9102 C9           	ret
 191+ 9103
 192+ 9103
 193+ 9103
 194+ 9103
 195+ 9103
 196+ 9103              load_vgm
 197+ 9103 CD E4 90     	call check_BM
 198+ 9106 D8           	ret c
 199+ 9107 C3 1F A1     	jp load_mus ;инициализация и загрузка VGM
 200+ 910A
 201+ 910A
 202+ 910A
 203+ 910A
 204+ 910A
 205+ 910A
 206+ 910A              load_vgz
 207+ 910A              ;тут запуск VGZ
 208+ 910A CD E4 90     	call check_BM
 209+ 910D D8           	ret c
 210+ 910E              	;тут надо сначала распаковать файл
 211+ 910E AF           	xor a
 212+ 910F              	OS_SET_MONO_MODE ;запросить моно режим
 212+ 910F 0E 08       >    ld c,#08
 212+ 9111 E7          >    rst #20
 213+ 9112 30 08        	jr nc,load_vgz1
 214+ 9114
 215+ 9114              load_vgz_err
 216+ 9114              	;выход с ошибкой
 217+ 9114
 218+ 9114              	;напечатать ошибку, если не дали режима моно
 219+ 9114 21 66 A5     	ld hl,msg_mono_err
 220+ 9117              	OS_PRINTZ
 220+ 9117 0E 09       >    ld c,#09
 220+ 9119 E7          >    rst #20
 221+ 911A
 222+ 911A 37           	scf ;ошибка
 223+ 911B C9           	ret
 224+ 911C
 225+ 911C              load_vgz1
 226+ 911C              	;перенести модуль распаковки на рабочий адрес
 227+ 911C
 228+ 911C 3A 61 A4     	ld a,(page_ext02_gzip) ;доп страница для данных плеера
 229+ 911F              	OS_SET_PAGE_SLOT3
 229+ 911F 0E 1C       >    ld c,#1c
 229+ 9121 E7          >    rst #20
 230+ 9122
 231+ 9122 21 00 C0     	ld hl,start_gp_gzip_ext
 232+ 9125 11 00 40     	ld de,start_gp_gzip
 233+ 9128 ED 4B 6E A4  	ld bc,(gp_gzip_file_size)
 234+ 912C ED B0        	ldir
 235+ 912E
 236+ 912E 3A 60 A4     	ld a,(page_ext01) ;доп страница для данных плеера
 237+ 9131              	OS_SET_PAGE_SLOT3
 237+ 9131 0E 1C       >    ld c,#1c
 237+ 9133 E7          >    rst #20
 238+ 9134
 239+ 9134              	;распаковать
 240+ 9134 21 4A A2     	ld hl,file_name_cur ;имя файла
 241+ 9137 CD 00 40     	call start_gp_gzip ;decompressfiletomemorystream
 242+ 913A
 243+ 913A              	;перенести таблицу страниц
 244+ 913A 11 00 95     	ld de,memorystreampages
 245+ 913D 01 00 01     	ld bc,256
 246+ 9140 ED B0        	ldir
 247+ 9142
 248+ 9142 01 FF 95     	ld bc,memorystreampages+$ff
 249+ 9145 02               ld (bc),a  ;количество страниц
 250+ 9146
 251+ 9146 F5           	push af
 252+ 9147 3E FF        	ld a,255
 253+ 9149              	OS_SET_MONO_MODE ;выключить моно режим
 253+ 9149 0E 08       >    ld c,#08
 253+ 914B E7          >    rst #20
 254+ 914C F1           	pop af
 255+ 914D
 256+ 914D 30 01        	jr nc,load_vgz_ok
 257+ 914F              	;если не распаковалос
 258+ 914F              	;scf ;ошибка
 259+ 914F C9           	ret
 260+ 9150
 261+ 9150              load_vgz_ok
 262+ 9150              	;нормально распаковалось
 263+ 9150
 264+ 9150 CD 64 A1     	call read_file_ok ;играть
 265+ 9153              	;call start_gplay ;играть
 266+ 9153
 267+ 9153 AF           	xor a
 268+ 9154 C9           	ret
 269+ 9155
 270+ 9155
 271+ 9155              ;стоп игра
 272+ 9155              gplay_stop_vgm_vgz
 273+ 9155 21 00 00     	ld hl,0 ;отключить обработчик прерываний
 274+ 9158              	OS_SET_INTER
 274+ 9158 0E 14       >    ld c,#14
 274+ 915A E7          >    rst #20
 275+ 915B CD 31 94     	call PLR_MUTE ;выключить звук
 276+ 915E
 277+ 915E
 278+ 915E              	;освободить страницы памяти
 279+ 915E 21 FF 95     	ld hl,memorystreampages+$FF
 280+ 9161 6E               ld l,(hl)
 281+ 9162 2C           	inc l ;проверка на 0
 282+ 9163 2D           	dec l
 283+ 9164 28 0B        	jr z,free_s98_loop_skip
 284+ 9166
 285+ 9166              free_s98_loop
 286+ 9166 2D               dec l
 287+ 9167 7E               ld a,(hl)
 288+ 9168
 289+ 9168 F5               push af
 290+ 9169 E5               push hl
 291+ 916A                  ;OS_DELPAGE
 292+ 916A              	OS_DEL_PAGE
 292+ 916A 0E 20       >    ld c,#20
 292+ 916C E7          >    rst #20
 293+ 916D E1               pop hl
 294+ 916E F1               pop af
 295+ 916F
 296+ 916F 20 F5            jr nz,free_s98_loop
 297+ 9171
 298+ 9171              free_s98_loop_skip
 299+ 9171 C9           	ret
 300+ 9172
 301+ 9172              ;стоп игра
 302+ 9172              gplay_stop_ptx
 303+ 9172                  OS_VTPL_MUTE
 303+ 9172 0E 17       >    ld c,#17
 303+ 9174 E7          >    rst #20
 304+ 9175 C9           	ret
 305+ 9176
 306+ 9176
 307+ 9176
 308+ 9176              ;стоп игра
 309+ 9176              gplay_stop_mod
 310+ 9176 CD CD A1         call GeneralSound.stopModule
 311+ 9179 C9           	ret
 312+ 917A
 313+ 917A
 314+ 917A              load_mod
 315+ 917A              ;загрузка и игра mod
 316+ 917A
 317+ 917A              	;определение наличия GS
 318+ 917A              	; xor a ;флаг что не нашли
 319+ 917A              	; ld (gs_yep),a
 320+ 917A              	; ld (gs_on),a
 321+ 917A 3E 23        	LD A,#23
 322+ 917C D3 BB        	OUT (CMD), A
 323+ 917E 06 32        	ld b,50
 324+ 9180              WAITCOM2: ;это WC
 325+ 9180              	OS_WAIT
 325+ 9180 DF          >	rst #18
 326+ 9181 DB BB        	IN A,(CMD)
 327+ 9183 0F           	RRCA
 328+ 9184 30 18        	JR NC,WAITCOM3
 329+ 9186 10 F8        	djnz WAITCOM2
 330+ 9188              gs_no
 331+ 9188 3E 0A        	ld a,color_error ;цвет ошибки
 332+ 918A 06 0C        	ld b,#c
 333+ 918C              	OS_SET_COLOR
 333+ 918C 0E 06       >    ld c,#06
 333+ 918E E7          >    rst #20
 334+ 918F
 335+ 918F 21 DA 93     	ld hl,txt_no_GS
 336+ 9192              	OS_PRINTZ
 336+ 9192 0E 09       >    ld c,#09
 336+ 9194 E7          >    rst #20
 337+ 9195
 338+ 9195 3E 0F        	ld a,color_backgr ;цвет основной
 339+ 9197 06 0C        	ld b,#c
 340+ 9199              	OS_SET_COLOR
 340+ 9199 0E 06       >    ld c,#06
 340+ 919B E7          >    rst #20
 341+ 919C
 342+ 919C 37           	scf ;ошибка
 343+ 919D C9           	ret
 344+ 919E              	;jr gs_no
 345+ 919E              WAITCOM3
 346+ 919E DB B3        	in a,(DATA) ;количество страниц памяти?
 347+ 91A0 FE FF        	cp 255
 348+ 91A2 20 02        	jr nz,gs_yes
 349+ 91A4              	; ld hl,txt_err_GS
 350+ 91A4              	; call loader_print
 351+ 91A4 18 E2        	jr gs_no
 352+ 91A6              gs_yes
 353+ 91A6
 354+ 91A6 21 4A A2     	ld hl,file_name_cur
 355+ 91A9              	OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
 355+ 91A9 0E 21       >    ld c,#21
 355+ 91AB E7          >    rst #20
 356+ 91AC
 357+ 91AC DA 2A 88     	jp c,load_file_error
 358+ 91AF 32 5F A4     	ld (file_id_cur_r),a
 359+ 91B2
 360+ 91B2 AF               xor a
 360+ 91B3 CD 7F A1       call GeneralSound.init
 361+ 91B6                  ; ld hl, .progress : call DialogBox.msgNoWait
 362+ 91B6                  ; call makeRequest : jp c, Fetcher.fetchFromNet.error
 363+ 91B6 CD 96 A1         call GeneralSound.loadModule
 364+ 91B9
 365+ 91B9
 366+ 91B9              loadMod_loop
 367+ 91B9                  ;ld hl, buffer_cat, ;(buffer_pointer), hl
 368+ 91B9                  ; call Wifi.getPacket
 369+ 91B9                  ; ld a, (Wifi.closed) : and a : jr nz, .exit
 370+ 91B9                  ; ld hl, buffer_cat, bc, (Wifi.bytes_avail)
 371+ 91B9
 372+ 91B9 3A 5F A4     		ld a,(file_id_cur_r)
 373+ 91BC 21 00 C0     		ld hl,buffer_cat
 374+ 91BF 11 00 40             ld de,$4000
 375+ 91C2              		OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес дл¤ чтени¤)
 375+ 91C2 0E 23       >    ld c,#23
 375+ 91C4 E7          >    rst #20
 376+ 91C5 DA 2A 88     		jp c,load_file_error
 377+ 91C8
 378+ 91C8 7C                   ld a,h
 379+ 91C9 FE C0        		cp $c0
 380+ 91CB 38 1A                jr c,loadMod_loadLoop_4000    ;>= $c0, значит остаток файла
 381+ 91CD              		;остаток
 382+ 91CD 01 00 C0     		ld bc,#c000
 383+ 91D0 A7           		and a
 384+ 91D1 ED 42        		sbc hl,bc
 385+ 91D3 28 29        		jr z,loadMod_exit ;если ничего больше не считалось
 386+ 91D5 44 4D        		ld bc,hl
 387+ 91D7 21 00 C0     		ld hl,buffer_cat
 388+ 91DA              load_mod_loadLoop2
 389+ 91DA 78               ld a, b
 389+ 91DB B1             or c
 389+ 91DC A7             and a
 389+ 91DD 28 1F          jr z, loadMod_exit
 390+ 91DF 7E               ld a, (hl)
 390+ 91E0 CD A9 A1       call GeneralSound.sendByte
 391+ 91E3 0B               dec bc
 392+ 91E4 23               inc hl
 393+ 91E5 18 F3            jr load_mod_loadLoop2
 394+ 91E7
 395+ 91E7
 396+ 91E7              loadMod_loadLoop_4000
 397+ 91E7 21 00 C0     	ld hl,buffer_cat
 398+ 91EA 01 00 40     	ld bc,$4000 ;большой кусок для загрузки
 399+ 91ED
 400+ 91ED              load_mod_loadLoop
 401+ 91ED 78               ld a, b
 401+ 91EE B1             or c
 401+ 91EF A7             and a
 401+ 91F0 CA B9 91       jp z,loadMod_loop
 402+ 91F3 7E               ld a, (hl)
 402+ 91F4 CD A9 A1       call GeneralSound.sendByte
 403+ 91F7 0B               dec bc
 404+ 91F8 23               inc hl
 405+ 91F9 18 F2            jr load_mod_loadLoop
 406+ 91FB              ;.nextFrame
 407+ 91FB                  ;call Wifi.continue
 408+ 91FB C3 B9 91         jp loadMod_loop
 409+ 91FE              loadMod_exit
 410+ 91FE CD B1 A1         call GeneralSound.finishLoadingModule
 411+ 9201
 412+ 9201 3A 5F A4     	ld a,(file_id_cur_r)
 413+ 9204              	OS_FILE_CLOSE ;A - id file
 413+ 9204 0E 25       >    ld c,#25
 413+ 9206 E7          >    rst #20
 414+ 9207                  ;jp History.back
 415+ 9207              	;jp play ;MediaProcessor.processResource
 416+ 9207              ;.progress db "MOD downloading directly to GS!", 0
 417+ 9207
 418+ 9207                  macro GS_WaitCommand2
 419+ 9207 ~            .wait
 420+ 9207 ~                in a, (CMD)
 421+ 9207 ~                rrca
 422+ 9207 ~                jr c, .wait
 423+ 9207                  endm
 424+ 9207
 425+ 9207                  macro GS_SendCommand2 nn
 426+ 9207 ~                ld a, nn
 426+ 9207 ~              out (CMD), a
 427+ 9207                  endm
 428+ 9207
 429+ 9207              loadMod_play
 430+ 9207
 431+ 9207 21 C1 93     	ld hl,txt_play
 432+ 920A              	OS_PRINTZ
 432+ 920A 0E 09       >    ld c,#09
 432+ 920C E7          >    rst #20
 433+ 920D
 434+ 920D 21 A4 93         ld hl,txt_gplay_menu
 435+ 9210              	OS_PRINTZ
 435+ 9210 0E 09       >    ld c,#09
 435+ 9212 E7          >    rst #20
 436+ 9213
 437+ 9213                  ; call Console.waitForKeyUp
 438+ 9213
 439+ 9213                  ; ld hl, Gopher.requestbuffer : call DialogBox.msgNoWait
 440+ 9213
 441+ 9213                  ; ;ld a, 1, (Render.play_next), a
 442+ 9213 AF           	xor a
 443+ 9214 32 7B 92     	ld (last_song_position),a
 444+ 9217
 445+ 9217              load_mod_loop
 446+ 9217                  OS_WAIT
 446+ 9217 DF          >	rst #18
 446+ 9218
 447+ 9218                  OS_GET_CHAR
 447+ 9218 0E 10       >    ld c,#10
 447+ 921A E7          >    rst #20
 448+ 921B FE 20        	cp " " ;пробел
 449+ 921D CA 7A 92     	jp z, load_mod_stop
 450+ 9220 FE 73        	cp "s" ;стоп
 451+ 9222 CA 7A 92     	jp z, load_mod_stop
 452+ 9225 FE 53        	cp "S" ;чтоп
 453+ 9227 CA 7A 92     	jp z, load_mod_stop
 454+ 922A FE 18        	cp 24 ;break
 455+ 922C CA 7A 92     	jp z, load_mod_stop
 456+ 922F              	;call printRTC
 457+ 922F                  ;проверка что MOD начал играть сначала
 458+ 922F                  GS_SendCommand2 CMD_GET_SONG_POSITION
 458+ 922F 3E 60       >    ld a, CMD_GET_SONG_POSITION
 458+ 9231 D3 BB       >  out (CMD), a
 459+ 9233                  GS_WaitCommand2
 459+ 9233             >.wait
 459+ 9233 DB BB       >    in a, (CMD)
 459+ 9235 0F          >    rrca
 459+ 9236 38 FB       >    jr c, .wait
 460+ 9238 DB B3        	in a,(DATA) ;текущая позиция
 461+ 923A 32 7C 92     	ld (cur_song_position),a
 462+ 923D              	;печатать позицию song
 463+ 923D 11 00 0A     	ld de,#0a00
 464+ 9240              	OS_SET_XY
 464+ 9240 0E 01       >    ld c,#01
 464+ 9242 E7          >    rst #20
 465+ 9243 2A 7C 92     	ld hl,(cur_song_position)
 466+ 9246 26 00        	ld h,0
 467+ 9248 CD 44 93     	call toDecimal
 468+ 924B              	OS_PRINTZ
 468+ 924B 0E 09       >    ld c,#09
 468+ 924D E7          >    rst #20
 469+ 924E
 470+ 924E                  GS_SendCommand2 CMD_GET_PATTERN_POSITION
 470+ 924E 3E 61       >    ld a, CMD_GET_PATTERN_POSITION
 470+ 9250 D3 BB       >  out (CMD), a
 471+ 9252                  GS_WaitCommand2
 471+ 9252             >.wait
 471+ 9252 DB BB       >    in a, (CMD)
 471+ 9254 0F          >    rrca
 471+ 9255 38 FB       >    jr c, .wait
 472+ 9257 DB B3        	in a,(DATA) ;текущая позиция паттерна
 473+ 9259 32 7D 92     	ld (cur_pattern_position),a
 474+ 925C 11 00 0B     	ld de,#0b00
 475+ 925F              	OS_SET_XY
 475+ 925F 0E 01       >    ld c,#01
 475+ 9261 E7          >    rst #20
 476+ 9262 2A 7D 92     	ld hl,(cur_pattern_position)
 477+ 9265 26 00        	ld h,0
 478+ 9267 CD 44 93     	call toDecimal
 479+ 926A              	OS_PRINTZ
 479+ 926A 0E 09       >    ld c,#09
 479+ 926C E7          >    rst #20
 480+ 926D
 481+ 926D
 482+ 926D 3A 7B 92     	ld a,(last_song_position) ;предыдущая позиция
 483+ 9270 4F           	ld c,a
 484+ 9271 3A 7C 92     	ld a,(cur_song_position) ;текущая
 485+ 9274 32 7B 92     	ld (last_song_position),a
 486+ 9277 B9           	cp c
 487+ 9278 30 9D        	jr nc,load_mod_loop ;если не меньше, продолжаем играть
 488+ 927A                  ;ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
 489+ 927A              load_mod_stop
 490+ 927A                  ;call Console.waitForKeyUp
 491+ 927A C9               ret
 492+ 927B              ; .stopKey
 493+ 927B                  ; ;xor a : ld (Render.play_next), a ;флаг что не надо играть следующий файл
 494+ 927B                  ; jr .stop
 495+ 927B
 496+ 927B
 497+ 927B              ;message db "Press key to stop...", 0
 498+ 927B
 499+ 927B
 500+ 927B              CMD_GET_SONG_POSITION     = #60
 501+ 927B              CMD_GET_PATTERN_POSITION  = #61
 502+ 927B 00           last_song_position db 0
 503+ 927C 00           cur_song_position db 0
 504+ 927D 00           cur_pattern_position db 0
 505+ 927E
 506+ 927E              ;; Control ports
 507+ 927E              CMD  = 187
 508+ 927E              DATA = 179
 509+ 927E
 510+ 927E 00 00        buffer_pointer dw 0;
 511+ 9280
 512+ 9280
 513+ 9280
 514+ 9280
 515+ 9280
 516+ 9280
 517+ 9280              ;загрузка PTx
 518+ 9280              load_pt2
 519+ 9280 3E 03        	ld a,%00000011 ;pt2
 520+ 9282 32 E9 92     	ld (ptplayer_setup),a
 521+ 9285 18 05        	jr load_pt
 522+ 9287              load_pt3
 523+ 9287 3E 21        	ld a,%00100001 ;pt3
 524+ 9289 32 E9 92     	ld (ptplayer_setup),a
 525+ 928C
 526+ 928C              load_pt
 527+ 928C
 528+ 928C 21 4A A2     	ld hl,file_name_cur
 529+ 928F CD DC 87     	call load_file
 530+ 9292 D8           	ret c
 531+ 9293
 532+ 9293              	;начать игру
 533+ 9293 21 00 C0     	ld hl,buffer_cat
 534+ 9296              	OS_GET_VTPL_SETUP
 534+ 9296 0E 18       >    ld c,#18
 534+ 9298 E7          >    rst #20
 535+ 9299 3A E9 92     	ld a,(ptplayer_setup)
 536+ 929C 77           	ld (hl),a ;настройки
 537+ 929D
 538+ 929D 21 00 C0     	ld hl,buffer_cat
 539+ 92A0              	OS_VTPL_INIT
 539+ 92A0 0E 15       >    ld c,#15
 539+ 92A2 E7          >    rst #20
 540+ 92A3              	OS_VTPL_PLAY
 540+ 92A3 0E 16       >    ld c,#16
 540+ 92A5 E7          >    rst #20
 541+ 92A6
 542+ 92A6 21 C1 93     	ld hl,txt_play
 543+ 92A9              	OS_PRINTZ
 543+ 92A9 0E 09       >    ld c,#09
 543+ 92AB E7          >    rst #20
 544+ 92AC
 545+ 92AC 21 A4 93     	ld hl,txt_gplay_menu
 546+ 92AF              	OS_PRINTZ
 546+ 92AF 0E 09       >    ld c,#09
 546+ 92B1 E7          >    rst #20
 547+ 92B2
 548+ 92B2              load_pt_loop
 549+ 92B2                  OS_WAIT
 549+ 92B2 DF          >	rst #18
 549+ 92B3
 550+ 92B3                  OS_GET_CHAR
 550+ 92B3 0E 10       >    ld c,#10
 550+ 92B5 E7          >    rst #20
 551+ 92B6 FE 20        	cp " " ;пробел
 552+ 92B8 CA E7 92     	jp z, load_pt_stop
 553+ 92BB FE 73        	cp "s" ;стоп
 554+ 92BD CA E7 92     	jp z, load_pt_stop
 555+ 92C0 FE 53        	cp "S" ;чтоп
 556+ 92C2 CA E7 92     	jp z, load_pt_stop
 557+ 92C5 FE 18        	cp 24 ;break
 558+ 92C7 CA E7 92     	jp z, load_pt_stop
 559+ 92CA              	;call printRTC
 560+ 92CA
 561+ 92CA              	;печать инфо
 562+ 92CA 11 00 0A     	ld de,#0a00
 563+ 92CD              	OS_SET_XY
 563+ 92CD 0E 01       >    ld c,#01
 563+ 92CF E7          >    rst #20
 564+ 92D0
 565+ 92D0              	OS_GET_VTPL_SETUP
 565+ 92D0 0E 18       >    ld c,#18
 565+ 92D2 E7          >    rst #20
 566+ 92D3 01 3B 09     	ld bc,#93b ;нужная переменная плеера
 567+ 92D6 09           	add hl,bc
 568+ 92D7 6E               ld l,(hl)
 568+ 92D8
 569+ 92D8 26 00        	ld h,0
 570+ 92DA CD 44 93     	call toDecimal
 571+ 92DD              	OS_PRINTZ
 571+ 92DD 0E 09       >    ld c,#09
 571+ 92DF E7          >    rst #20
 572+ 92E0
 573+ 92E0              	;проверка на конец песни
 574+ 92E0              	OS_GET_VTPL_SETUP
 574+ 92E0 0E 18       >    ld c,#18
 574+ 92E2 E7          >    rst #20
 575+ 92E3 7E           	ld a, (hl)
 576+ 92E4 17           	rla
 577+ 92E5 30 CB        	jr nc,load_pt_loop ;если не меньше, продолжаем играть
 578+ 92E7                  ;ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
 579+ 92E7              load_pt_stop
 580+ 92E7                  ;call Console.waitForKeyUp
 581+ 92E7 B7           	or a
 582+ 92E8 C9               ret
 583+ 92E9
 584+ 92E9 00           ptplayer_setup db 0;
 585+ 92EA
 586+ 92EA
 587+ 92EA
 588+ 92EA
 589+ 92EA
 590+ 92EA
 591+ 92EA
 592+ 92EA
 593+ 92EA
 594+ 92EA
 595+ 92EA              	;печать шкалы прогресса
 596+ 92EA              gplay_progress_print
 597+ 92EA CD 13 93     	call gplay_progress_calc
 598+ 92ED 11 00 02     	ld de,#0200 ;прогресс тут
 599+ 92F0              	OS_SET_XY
 599+ 92F0 0E 01       >    ld c,#01
 599+ 92F2 E7          >    rst #20
 600+ 92F3              	;печать закрашенных кубиков
 601+ 92F3 3A 43 93     	ld a,(gplay_progress_val)
 602+ 92F6 B7           	or a
 603+ 92F7 28 08        	jr z,gplay_progress_print1
 604+ 92F9 47           	ld b,a
 605+ 92FA              gplay_progress_print1_cl
 606+ 92FA C5           	push bc
 607+ 92FB 3E B1        	ld a,177 ;псевдографика
 608+ 92FD              	OS_PRINT_CHARF
 608+ 92FD D7          >	rst #10
 609+ 92FE C1           	pop bc
 610+ 92FF 10 F9        	djnz gplay_progress_print1_cl
 611+ 9301              gplay_progress_print1
 612+ 9301              	;печать пустых кубиков
 613+ 9301 3A 43 93     	ld a,(gplay_progress_val)
 614+ 9304 4F           	ld c,a
 615+ 9305 3E 10        	ld a,gplay_progress_lenght
 616+ 9307 91           	sub c
 617+ 9308 28 08        	jr z,gplay_progress_print2
 618+ 930A 47           	ld b,a
 619+ 930B              gplay_progress_print1_c2
 620+ 930B C5           	push bc
 621+ 930C 3E B0        	ld a,176 ;псевдографика
 622+ 930E              	OS_PRINT_CHARF
 622+ 930E D7          >	rst #10
 623+ 930F C1           	pop bc
 624+ 9310 10 F9        	djnz gplay_progress_print1_c2
 625+ 9312
 626+ 9312              gplay_progress_print2
 627+ 9312 C9           	ret
 628+ 9313
 629+ 9313
 630+ 9313              gplay_progress_calc
 631+ 9313 3A FF 95     	ld a,(memorystreampages+255) ;всего страниц памяти занято
 632+ 9316 67           	ld h,a
 633+ 9317 2E 00        	ld l,0 ;всего страниц *256
 634+ 9319
 635+ 9319              	;разделить
 636+ 9319 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 637+ 931B CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 638+ 931D CB 3C        	srl h ; /4
 639+ 931F CB 1D        	rr l ;
 640+ 9321 CB 3C        	srl h ; /8
 641+ 9323 CB 1D        	rr l ;
 642+ 9325 CB 3C        	srl h ; /16
 643+ 9327 CB 1D        	rr l ;
 644+ 9329              	; srl h ; /32
 645+ 9329              	; rr l ;
 646+ 9329              	;узнали сколько страниц одно деление
 647+ 9329 EB           	ex de,hl
 648+ 932A
 649+ 932A
 650+ 932A 2A 0E 96     	ld hl,(memorystreampageaddr)
 651+ 932D 01 00 95     	ld bc,memorystreampages
 652+ 9330 A7           	and a
 653+ 9331 ED 42        	sbc hl,bc ;какая по счёту страница сейчас
 654+ 9333
 655+ 9333 65           	ld h,l ;*256
 656+ 9334 2E 00        	ld l,0
 657+ 9336
 658+ 9336              	;разделить на величину одного деления
 659+ 9336 3E FF        	ld a,-1
 660+ 9338              divide16
 661+ 9338 3C           	inc a
 662+ 9339 A7           	and a
 663+ 933A ED 52        	sbc hl,de
 664+ 933C 30 FA        	jr nc,divide16
 665+ 933E 19           	add hl,de
 666+ 933F 32 43 93     	ld (gplay_progress_val),a
 667+ 9342 C9           	ret
 668+ 9343
 669+ 9343              gplay_progress_lenght equ 16 ;длина шкалы
 670+ 9343 00           gplay_progress_val db 0;
 671+ 9344
 672+ 9344
 673+ 9344
 674+ 9344
 675+ 9344              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 676+ 9344              				;на входе в HL число
 677+ 9344 11 10 27     			ld de,10000 ;десятки тысяч
 678+ 9347 3E FF        			ld a,255
 679+ 9349              toDecimal10k
 680+ 9349 A7           			and a
 681+ 934A ED 52        			sbc hl,de
 682+ 934C 3C           			inc a
 683+ 934D 30 FA        			jr nc,toDecimal10k
 684+ 934F 19           			add hl,de
 685+ 9350 C6 30        			add a,48
 686+ 9352 32 9D 93     			ld (decimalS),a
 687+ 9355 11 E8 03     			ld de,1000 ;тысячи
 688+ 9358 3E FF        			ld a,255
 689+ 935A              toDecimal1k
 690+ 935A A7           			and a
 691+ 935B ED 52        			sbc hl,de
 692+ 935D 3C           			inc a
 693+ 935E 30 FA        			jr nc,toDecimal1k
 694+ 9360 19           			add hl,de
 695+ 9361 C6 30        			add a,48
 696+ 9363 32 9E 93     			ld (decimalS+1),a
 697+ 9366 11 64 00     			ld de,100 ;сотни
 698+ 9369 3E FF        			ld a,255
 699+ 936B              toDecimal01k
 700+ 936B A7           			and a
 701+ 936C ED 52        			sbc hl,de
 702+ 936E 3C           			inc a
 703+ 936F 30 FA        			jr nc,toDecimal01k
 704+ 9371 19           			add hl,de
 705+ 9372 C6 30        			add a,48
 706+ 9374 32 9F 93     			ld (decimalS+2),a
 707+ 9377 11 0A 00     			ld de,10 ;десятки
 708+ 937A 3E FF        			ld a,255
 709+ 937C              toDecimal001k
 710+ 937C A7           			and a
 711+ 937D ED 52        			sbc hl,de
 712+ 937F 3C           			inc a
 713+ 9380 30 FA        			jr nc,toDecimal001k
 714+ 9382 19           			add hl,de
 715+ 9383 C6 30        			add a,48
 716+ 9385 32 A0 93     			ld (decimalS+3),a
 717+ 9388 11 01 00     			ld de,1 ;единицы
 718+ 938B 3E FF        			ld a,255
 719+ 938D              toDecimal0001k
 720+ 938D A7           			and a
 721+ 938E ED 52        			sbc hl,de
 722+ 9390 3C           			inc a
 723+ 9391 30 FA        			jr nc,toDecimal0001k
 724+ 9393 19           			add hl,de
 725+ 9394 C6 30        			add a,48
 726+ 9396 32 A1 93     			ld (decimalS+4),a
 727+ 9399 21 9D 93     			ld hl,decimalS
 728+ 939C C9           			ret
 729+ 939D
 730+ 939D 00 00 00...  decimalS	ds 6 ;десятичные цифры
 731+ 93A3
 732+ 93A3
 733+ 93A3
 734+ 93A3 00           gplay_type db 0 ;тип музыки
 735+ 93A4              ;file_id_cur db 0; временно
 736+ 93A4
 737+ 93A4 0D 0D 42 72  txt_gplay_menu db 13,13,"Break, S - stop ",13,"Sp - Next",0
 737+ 93A8 65 61 6B 2C
 737+ 93AC 20 53 20 2D
 737+ 93B0 20 73 74 6F
 737+ 93B4 70 20 0D 53
 737+ 93B8 70 20 2D 20
 737+ 93BC 4E 65 78 74
 737+ 93C0 00
 738+ 93C1 0D 50 6C 61  txt_play db 13,"Play... ",0
 738+ 93C5 79 2E 2E 2E
 738+ 93C9 20 00
 739+ 93CB 0D 53 74 6F  txt_stop db 13,"Stop",0
 739+ 93CF 70 00
 740+ 93D1 0D 4C 6F 61  txt_load db 13,"Load...",0
 740+ 93D5 64 2E 2E 2E
 740+ 93D9 00
 741+ 93DA 0D 47 53 20  txt_no_GS db 13,"GS not found!",0
 741+ 93DE 6E 6F 74 20
 741+ 93E2 66 6F 75 6E
 741+ 93E6 64 21 00
 742+ 93E9 0D 42 4D 20  txt_no_BM db 13,"BM not found!",0
 742+ 93ED 6E 6F 74 20
 742+ 93F1 66 6F 75 6E
 742+ 93F5 64 21 00
 743+ 93F8 0D 4D 65 6D  txt_memoryerror:    db 13,"Memory allocation error!",0
 743+ 93FC 6F 72 79 20
 743+ 9400 61 6C 6C 6F
 743+ 9404 63 61 74 69
 743+ 9408 6F 6E 20 65
 743+ 940C 72 72 6F 72
 743+ 9410 21 00
 744+ 9412              ;txt_fopenerror:     db 13,"Cannot open file: ",0
 745+ 9412
 746+ 9412              msg_title
 747+ 9412 47 50 6C 61  	db "GPlay ver 2025.08.18",10,13,0
 747+ 9416 79 20 76 65
 747+ 941A 72 20 32 30
 747+ 941E 32 35 2E 30
 747+ 9422 38 2E 31 38
 747+ 9426 0A 0D 00
 748+ 9429
 749+ 9429              vgm_plr
 750+ 9429
 751+ 9429              ;module equ 0xc000
 752+ 9429              ;player_load = 0x8000 ;0x4000
 753+ 9429
 754+ 9429              ;ovl_start = 0x8000 ;0x4000
 755+ 9429
 756+ 9429              PLR_INIT  = vgm_plr ;0x4000
 757+ 9429              PLR_PLAY  = vgm_plr+5 ;0x4005
 758+ 9429              PLR_MUTE  = vgm_plr+8 ;0x4008
 759+ 9429
 760+ 9429              	include vgm.asm
# file opened: GPlay/vgm.asm
   1++9429                      ;DEVICE ZXSPECTRUM48
   2++9429                      ;include "../../../_sdk/sys_h.asm"
   3++9429                      ;       ORG PROGSTART ;0x4000
   4++9429
   5++9429
   6++9429
   7++9429              ;memorystreamcurrentpage = 0x5100
   8++9429              ;current_ram_page = 0x5100
   9++9429
  10++9429
  11++9429              AREA_C000_FFFF   equ 1
  12++9429
  13++9429
  14++9429
  15++9429              module = $C000
  16++9429
  17++9429
  18++9429
  19++9429              begin
  20++9429              START
  21++9429 21 00 C0             	LD HL,module;MDLADDR ;DE - address of 2nd module for TS
  22++942C 18 06                	JR INIT
  23++942E C3 7A 9C             	JP PLAY
  24++9431 C3 6C 9C             	JP MUTE
  25++9434              INIT:
  26++9434 C3 CF 9B             jp init_
  27++9437
  28++9437              DEVICE_AY_BIT         = 0
  29++9437              DEVICE_TURBOSOUND_BIT = 1
  30++9437              DEVICE_TFM_BIT        = 2
  31++9437              DEVICE_MOONSOUND_BIT  = 3
  32++9437              DEVICE_GS_BIT         = 4
  33++9437              DEVICE_NEOGS_BIT      = 5
  34++9437              DEVICE_MIDI_UART_BIT  = 6
  35++9437
  36++9437              DEVICE_AY_MASK         = 1<<DEVICE_AY_BIT
  37++9437              DEVICE_TURBOSOUND_MASK = 1<<DEVICE_TURBOSOUND_BIT
  38++9437              DEVICE_TFM_MASK        = 1<<DEVICE_TFM_BIT
  39++9437              DEVICE_MOONSOUND_MASK  = 1<<DEVICE_MOONSOUND_BIT
  40++9437              DEVICE_GS_MASK         = 1<<DEVICE_GS_BIT
  41++9437              DEVICE_NEOGS_MASK      = 1<<DEVICE_NEOGS_BIT
  42++9437              DEVICE_MIDI_UART_MASK  = 1<<DEVICE_MIDI_UART_BIT
  43++9437
  44++9437
  45++9437
  46++9437
  47++9437
  48++9437              HEADER_DATA_OFFSET = module+0x34 ;0xC034
  49++9437              HEADER_LOOP_SAMPLES_COUNT = module+0x20 ;0xC020
  50++9437              HEADER_GD3_OFFSET = module+0x14 ;0xC014
  51++9437              HEADER_SAMPLES_COUNT = module+0x18 ;0xC018
  52++9437              HEADER_LOOP_OFFSET = module+0x1c ;0xC01c
  53++9437
  54++9437
  55++9437              HEADER_SIZE_MAX = 256
  56++9437              TITLELENGTH = 64
  57++9437              MEMORYSTREAMMAXPAGES = 210
  58++9437              MEMORYSTREAMERRORMASK = 255 ; TODO: do we need to enforce loading the entire file?
  59++9437              ENABLE_FM = 1
  60++9437
  61++9437
  62++9437
  63++9437
  64++9437
  65++9437
  66++9437
  67++9437 00 00 00...          align 256   ;0x8100 ;0x4100
  68++9500                      display "s98_file00_pages_list ",$
  69++9500
  70++9500 00 00 00...  memorystreampages: ds 256,0
  71++9600              memorystreampagecount = memorystreampages + 255
  72++9600
  73++9600              	include "common/memorystream.asm"
# file opened: GPlay/common/memorystream.asm
   1++9600              memorystreamstart
   2++9600                      IF AREA_C000_FFFF=1
   3++9600 21 00 00     	ld hl,0x0000
   4++9603                      ELSE
   5++9603 ~                    ld hl,0xffff
   6++9603                      ENDIF
   7++9603 22 72 96     	ld (memorystreamcurrentaddr),hl
   8++9606 21 00 95     	ld hl,memorystreampages
   9++9609 22 0E 96     	ld (memorystreampageaddr),hl
  10++960C C9           	ret
  11++960D
  12++960D              memorystreamnextpage
  13++960D              memorystreampageaddr=$+1
  14++960D 21 00 00     	ld hl,0
  15++9610 F5           	push af
  16++9611 7E           	ld a,(hl)
  17++9612 23           	inc hl
  18++9613 32 7C 9C     	ld (memorystreamcurrentpage),a
  19++9616 22 0E 96     	ld (memorystreampageaddr),hl
  20++9619 C5           	push bc
  21++961A                      IF AREA_C000_FFFF=1
  22++961A              	;SETPGC000
  23++961A              	OS_SET_PAGE_SLOT3
  23++961A 0E 1C       >    ld c,#1c
  23++961C E7          >    rst #20
  24++961D C1           	pop bc
  25++961E F1           	pop af
  26++961F 21 00 C0     	ld hl,0xC000
  27++9622                      ELSE
  28++9622 ~                    SETPG8000
  29++9622 ~                    pop bc
  30++9622 ~                    pop af
  31++9622 ~                    ld hl,0x8000
  32++9622                      ENDIF
  33++9622 C9           	ret
  34++9623
  35++9623              memorystreamskip
  36++9623              ;b = byte count
  37++9623 2A 72 96     	ld hl,(memorystreamcurrentaddr)
  38++9626              .loop
  39++9626 CB 74        	bit 6,h
  40++9628                      IF AREA_C000_FFFF=1
  41++9628 CC 0D 96     	call z,memorystreamnextpage
  42++962B                      ELSE
  43++962B ~             	call nz,memorystreamnextpage
  44++962B                      ENDIF
  45++962B 23           	inc hl
  46++962C 10 F8        	djnz .loop
  47++962E 22 72 96     	ld (memorystreamcurrentaddr),hl
  48++9631 C9           	ret
  49++9632
  50++9632              	macro memory_stream_write_byte src
  51++9632 ~            	bit 6,h
  52++9632 ~                    IF AREA_C000_FFFF=1
  53++9632 ~            	call z,memorystreamnextpage
  54++9632 ~                    ELSE
  55++9632 ~             	call nz,memorystreamnextpage
  56++9632 ~                    ENDIF
  57++9632 ~            	ld (hl),src
  58++9632 ~            	inc hl
  59++9632              	endm
  60++9632
  61++9632              	macro memory_stream_read_byte dest
  62++9632 ~            	bit 6,h
  63++9632 ~                    IF AREA_C000_FFFF=1
  64++9632 ~            	call z,memorystreamnextpage
  65++9632 ~                    ELSE
  66++9632 ~             	call nz,memorystreamnextpage
  67++9632 ~                    ENDIF
  68++9632 ~            	ld dest,(hl)
  69++9632 ~            	inc hl
  70++9632              	endm
  71++9632
  72++9632              	macro memory_stream_read_1 dst
  73++9632 ~            	ld hl,(memorystreamcurrentaddr)
  74++9632 ~            	memory_stream_read_byte dst
  75++9632 ~            	ld (memorystreamcurrentaddr),hl
  76++9632              	endm
  77++9632
  78++9632              	macro memory_stream_read_2 dst1,dst2
  79++9632 ~            	ld hl,(memorystreamcurrentaddr)
  80++9632 ~            	memory_stream_read_byte dst1
  81++9632 ~            	memory_stream_read_byte dst2
  82++9632 ~            	ld (memorystreamcurrentaddr),hl
  83++9632              	endm
  84++9632
  85++9632              	macro memory_stream_read_3 dst1,dst2,dst3
  86++9632 ~            	ld hl,(memorystreamcurrentaddr)
  87++9632 ~            	memory_stream_read_byte dst1
  88++9632 ~            	memory_stream_read_byte dst2
  89++9632 ~            	memory_stream_read_byte dst3
  90++9632 ~            	ld (memorystreamcurrentaddr),hl
  91++9632              	endm
  92++9632
  93++9632              memorystreamread1
  94++9632              ;out: a = byte
  95++9632              	memory_stream_read_1 a
  95++9632 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
  95++9635             >	memory_stream_read_byte a
  95++9635 CB 74       >	bit 6,h
  95++9637             >        IF AREA_C000_FFFF=1
  95++9637 CC 0D 96    >	call z,memorystreamnextpage
  95++963A             >        ELSE
  95++963A ~           > 	call nz,memorystreamnextpage
  95++963A             >        ENDIF
  95++963A 7E          >	ld a,(hl)
  95++963B 23          >	inc hl
  95++963C 22 72 96    >	ld (memorystreamcurrentaddr),hl
  96++963F C9           	ret
  97++9640
  98++9640              memorystreamread2
  99++9640              ;out: de = word
 100++9640              	memory_stream_read_2 e,d
 100++9640 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 100++9643             >	memory_stream_read_byte e
 100++9643 CB 74       >	bit 6,h
 100++9645             >        IF AREA_C000_FFFF=1
 100++9645 CC 0D 96    >	call z,memorystreamnextpage
 100++9648             >        ELSE
 100++9648 ~           > 	call nz,memorystreamnextpage
 100++9648             >        ENDIF
 100++9648 5E          >	ld e,(hl)
 100++9649 23          >	inc hl
 100++964A             >	memory_stream_read_byte d
 100++964A CB 74       >	bit 6,h
 100++964C             >        IF AREA_C000_FFFF=1
 100++964C CC 0D 96    >	call z,memorystreamnextpage
 100++964F             >        ELSE
 100++964F ~           > 	call nz,memorystreamnextpage
 100++964F             >        ENDIF
 100++964F 56          >	ld d,(hl)
 100++9650 23          >	inc hl
 100++9651 22 72 96    >	ld (memorystreamcurrentaddr),hl
 101++9654 C9           	ret
 102++9655
 103++9655              memorystreamread3
 104++9655              ;out: c = byte0, e = byte1, d = byte2
 105++9655              	memory_stream_read_3 c,e,d
 105++9655 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 105++9658             >	memory_stream_read_byte c
 105++9658 CB 74       >	bit 6,h
 105++965A             >        IF AREA_C000_FFFF=1
 105++965A CC 0D 96    >	call z,memorystreamnextpage
 105++965D             >        ELSE
 105++965D ~           > 	call nz,memorystreamnextpage
 105++965D             >        ENDIF
 105++965D 4E          >	ld c,(hl)
 105++965E 23          >	inc hl
 105++965F             >	memory_stream_read_byte e
 105++965F CB 74       >	bit 6,h
 105++9661             >        IF AREA_C000_FFFF=1
 105++9661 CC 0D 96    >	call z,memorystreamnextpage
 105++9664             >        ELSE
 105++9664 ~           > 	call nz,memorystreamnextpage
 105++9664             >        ENDIF
 105++9664 5E          >	ld e,(hl)
 105++9665 23          >	inc hl
 105++9666             >	memory_stream_read_byte d
 105++9666 CB 74       >	bit 6,h
 105++9668             >        IF AREA_C000_FFFF=1
 105++9668 CC 0D 96    >	call z,memorystreamnextpage
 105++966B             >        ELSE
 105++966B ~           > 	call nz,memorystreamnextpage
 105++966B             >        ENDIF
 105++966B 56          >	ld d,(hl)
 105++966C 23          >	inc hl
 105++966D 22 72 96    >	ld (memorystreamcurrentaddr),hl
 106++9670 C9           	ret
 107++9671
 108++9671              memorystreamread4
 109++9671              ;out: adbc = dword
 110++9671              memorystreamcurrentaddr=$+1
 111++9671 21 00 00     	ld hl,0
 112++9674              	memory_stream_read_byte c
 112++9674 CB 74       >	bit 6,h
 112++9676             >        IF AREA_C000_FFFF=1
 112++9676 CC 0D 96    >	call z,memorystreamnextpage
 112++9679             >        ELSE
 112++9679 ~           > 	call nz,memorystreamnextpage
 112++9679             >        ENDIF
 112++9679 4E          >	ld c,(hl)
 112++967A 23          >	inc hl
 113++967B              	memory_stream_read_byte b
 113++967B CB 74       >	bit 6,h
 113++967D             >        IF AREA_C000_FFFF=1
 113++967D CC 0D 96    >	call z,memorystreamnextpage
 113++9680             >        ELSE
 113++9680 ~           > 	call nz,memorystreamnextpage
 113++9680             >        ENDIF
 113++9680 46          >	ld b,(hl)
 113++9681 23          >	inc hl
 114++9682              	memory_stream_read_byte d
 114++9682 CB 74       >	bit 6,h
 114++9684             >        IF AREA_C000_FFFF=1
 114++9684 CC 0D 96    >	call z,memorystreamnextpage
 114++9687             >        ELSE
 114++9687 ~           > 	call nz,memorystreamnextpage
 114++9687             >        ENDIF
 114++9687 56          >	ld d,(hl)
 114++9688 23          >	inc hl
 115++9689              	memory_stream_read_byte a
 115++9689 CB 74       >	bit 6,h
 115++968B             >        IF AREA_C000_FFFF=1
 115++968B CC 0D 96    >	call z,memorystreamnextpage
 115++968E             >        ELSE
 115++968E ~           > 	call nz,memorystreamnextpage
 115++968E             >        ENDIF
 115++968E 7E          >	ld a,(hl)
 115++968F 23          >	inc hl
 116++9690 22 72 96     	ld (memorystreamcurrentaddr),hl
 117++9693 C9           	ret
 118++9694
 119++9694              memorystreamread
 120++9694              ;bc = number of bytes
 121++9694              ;de = dest addr
 122++9694 79           	ld a,c
 123++9695 0B           	dec bc
 124++9696 04           	inc b
 125++9697 48           	ld c,b
 126++9698 47           	ld b,a
 127++9699 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 128++969C              .readloop
 129++969C              	memory_stream_read_byte a
 129++969C CB 74       >	bit 6,h
 129++969E             >        IF AREA_C000_FFFF=1
 129++969E CC 0D 96    >	call z,memorystreamnextpage
 129++96A1             >        ELSE
 129++96A1 ~           > 	call nz,memorystreamnextpage
 129++96A1             >        ENDIF
 129++96A1 7E          >	ld a,(hl)
 129++96A2 23          >	inc hl
 130++96A3 12           	ld (de),a
 131++96A4 13           	inc de
 132++96A5 10 F5        	djnz .readloop
 133++96A7 0D           	dec c
 134++96A8 20 F2        	jr nz,.readloop
 135++96AA 22 72 96     	ld (memorystreamcurrentaddr),hl
 136++96AD C9           	ret
 137++96AE
 138++96AE              memorystreamwrite
 139++96AE              ;bc = number of bytes
 140++96AE              ;de = src addr
 141++96AE 79           	ld a,c
 142++96AF 0B           	dec bc
 143++96B0 04           	inc b
 144++96B1 48           	ld c,b
 145++96B2 47           	ld b,a
 146++96B3 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 147++96B6              .writeloop
 148++96B6 1A           	ld a,(de)
 149++96B7              	memory_stream_write_byte a
 149++96B7 CB 74       >	bit 6,h
 149++96B9             >        IF AREA_C000_FFFF=1
 149++96B9 CC 0D 96    >	call z,memorystreamnextpage
 149++96BC             >        ELSE
 149++96BC ~           > 	call nz,memorystreamnextpage
 149++96BC             >        ENDIF
 149++96BC 77          >	ld (hl),a
 149++96BD 23          >	inc hl
 150++96BE 13           	inc de
 151++96BF 10 F5        	djnz .writeloop
 152++96C1 0D           	dec c
 153++96C2 20 F2        	jr nz,.writeloop
 154++96C4 22 72 96     	ld (memorystreamcurrentaddr),hl
 155++96C7 C9           	ret
 156++96C8
 157++96C8              memorystreamseek
 158++96C8              ;dehl = absolute position
 159++96C8              ;out: hl = read address
 160++96C8 7B           	ld a,e
 161++96C9 44           	ld b,h
 162++96CA CB 20        	sla b
 163++96CC 17           	rla
 164++96CD CB 20        	sla b
 165++96CF 17           	rla
 166++96D0 C6 00        	add a,memorystreampages%256
 167++96D2 5F           	ld e,a
 168++96D3 CE 95        	adc a,memorystreampages/256
 169++96D5 93           	sub e
 170++96D6 57           	ld d,a
 171++96D7 1A           	ld a,(de)
 172++96D8 32 7C 9C     	ld (memorystreamcurrentpage),a
 173++96DB 13           	inc de
 174++96DC ED 53 0E 96  	ld (memorystreampageaddr),de
 175++96E0                      IF AREA_C000_FFFF=1
 176++96E0              	;SETPGC000
 177++96E0 E5           	push hl ;*
 178++96E1              	OS_SET_PAGE_SLOT3
 178++96E1 0E 1C       >    ld c,#1c
 178++96E3 E7          >    rst #20
 179++96E4 E1           	pop hl ;*
 180++96E5 CB F4                set 6,h
 181++96E7                      ELSE
 182++96E7 ~            	SETPG8000
 183++96E7 ~            	res 6,h
 184++96E7                      ENDIF
 185++96E7 CB FC        	set 7,h
 186++96E9 22 72 96     	ld (memorystreamcurrentaddr),hl
 187++96EC C9           	ret
 188++96ED
 189++96ED              memorystreamgetpos
 190++96ED              ;out: dehl = absolute position
 191++96ED 2A 0E 96     	ld hl,(memorystreampageaddr)
 192++96F0 11 FF 6A     	ld de,-memorystreampages-1
 193++96F3 19           	add hl,de
 194++96F4 EB           	ex de,hl
 195++96F5 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 196++96F8
 197++96F8                      IF AREA_C000_FFFF=1
 198++96F8 CB 7C                bit 7,h
 199++96FA CB BC                res 7,h
 200++96FC CB B4                res 6,h
 201++96FE 20 04        	jr nz,$+6
 202++9700                      ELSE
 203++9700 ~            	res 7,h
 204++9700 ~            	bit 6,h
 205++9700 ~            ;	jr z,$+6
 206++9700                      ENDIF
 207++9700 20 04        	jr nz,$+6
 208++9702 13           	inc de
 209++9703 21 00 00     	ld hl,0
 210++9706 AF           	xor a
 211++9707 CB 1B        	rr e
 212++9709 1F           	rra
 213++970A CB 1B        	rr e
 214++970C 1F           	rra
 215++970D B4           	or h
 216++970E 67           	ld h,a
 217++970F C9           	ret
 218++9710
 219++9710              memorystreamsize
 220++9710 00 00 00 00  	ds 4
 221++9714
# file closed: GPlay/common/memorystream.asm
  74++9714              	include "common/opl4.asm"
# file opened: GPlay/common/opl4.asm
   1++9714              	include "moonsound.asm"
# file opened: GPlay/common/moonsound.asm
   1++9714              MOON_BASE_HI = 0x00 ;старший байт
   2++9714              MOON_BASE = 0x24 ;0xc4
   3++9714              MOON_REG1 = MOON_BASE
   4++9714              MOON_DAT1 = MOON_BASE+1  ;c5
   5++9714              MOON_REG2 = MOON_BASE+2  ;c6
   6++9714              MOON_DAT2 = MOON_BASE+3  ;c7
   7++9714              MOON_STAT = MOON_BASE
   8++9714              MOON_WREG = 0xc2
   9++9714              MOON_WDAT = MOON_WREG+1
  10++9714
  11++9714              ;TODO: is this good enough for ATM2?
  12++9714              	macro opl4_wait
  13++9714 ~            	ld a,MOON_BASE_HI
  14++9714 ~            	in a,(MOON_STAT)
  15++9714 ~            	rrca
  16++9714 ~            	jr c,$-3
  17++9714              	endm
  18++9714
  19++9714              ;makes ZXM-Moonsound firmware 1.01 switch PCM ports from default 7E and 7F to C2 and C3
  20++9714              	macro switch_to_pcm_ports_c2_c3
  21++9714 ~            	ld a,MOON_BASE_HI
  22++9714 ~            	in a,(MOON_REG2)
  23++9714              	endm
  24++9714
  25++9714
  26++9714
  27++9714              NR_OF_MIDI_CHANNELS = 16
  28++9714              NR_OF_WAVE_CHANNELS = 24
  29++9714
  30++9714
  31++9714
  32++9714              MOONSOUNDROMSIZE = 0x200000
  33++9714              MOONWAVEHEADERSIZE = 12
  34++9714              MOONRAMWAVETABLESIZE = 128
  35++9714              OPL4MAXWAVECHANNELS = NR_OF_WAVE_CHANNELS
  36++9714
  37++9714              OPL4_TIMER1_COUNT   = 0x02
  38++9714              OPL4_TIMER2_COUNT   = 0x03
  39++9714              OPL4_TIMER_CONTROL  = 0x04
  40++9714
  41++9714
  42++9714
  43++9714
  44++9714              OPL4_REG_TEST0               = 0x00
  45++9714              OPL4_REG_TEST1               = 0x01
  46++9714
  47++9714              OPL4_REG_MEMORY_CONFIGURATION = 0x02
  48++9714              OPL4_MODE_BIT                 = 0x01
  49++9714              OPL4_MTYPE_BIT                = 0x02
  50++9714              OPL4_TONE_HEADER_MASK         = 0x1C
  51++9714              OPL4_DEVICE_ID_MASK           = 0xE0
  52++9714
  53++9714              OPL4_REG_MEMORY_ADDRESS_HIGH  = 0x03
  54++9714              OPL4_REG_MEMORY_ADDRESS_MID   = 0x04
  55++9714              OPL4_REG_MEMORY_ADDRESS_LOW   = 0x05
  56++9714              OPL4_REG_MEMORY_DATA          = 0x06
  57++9714
  58++9714 ~            /*
  59++9714 ~             * Offsets to the register banks for voices. To get the
  60++9714 ~             * register number just add the voice number to the bank offset.
  61++9714 ~             *
  62++9714 ~             * Wave Table Number low bits (0x08 to 0x1F)
  63++9714 ~             */
  64++9714              OPL4_REG_TONE_NUMBER  = 0x08
  65++9714
  66++9714 ~            /* Wave Table Number high bit, F-Number low bits (0x20 to 0x37) */
  67++9714              OPL4_REG_F_NUMBER      = 0x20
  68++9714              OPL4_TONE_NUMBER_BIT8  = 0x01
  69++9714              OPL4_F_NUMBER_LOW_MASK = 0xFE
  70++9714
  71++9714 ~            /* F-Number high bits, Octave, Pseudo-Reverb (0x38 to 0x4F) */
  72++9714              OPL4_REG_OCTAVE         = 0x38
  73++9714              OPL4_F_NUMBER_HIGH_MASK = 0x07
  74++9714              OPL4_BLOCK_MASK         = 0xF0
  75++9714              OPL4_PSEUDO_REVERB_BIT  = 0x08
  76++9714
  77++9714 ~            /* Total Level, Level Direct (0x50 to 0x67) */
  78++9714              OPL4_REG_LEVEL        = 0x50
  79++9714              OPL4_TOTAL_LEVEL_MASK = 0xFE
  80++9714              OPL4_LEVEL_DIRECT_BIT = 0x01
  81++9714
  82++9714 ~            /* Key On, Damp, LFO RST, CH, Panpot (0x68 to 0x7F) */
  83++9714              OPL4_REG_MISC           = 0x68
  84++9714              OPL4_KEY_ON_BIT         = 0x80
  85++9714              OPL4_DAMP_BIT           = 0x40
  86++9714              OPL4_LFO_RESET_BIT      = 0x20
  87++9714              OPL4_OUTPUT_CHANNEL_BIT = 0x10
  88++9714              OPL4_PAN_POT_MASK       = 0x0F
  89++9714
  90++9714 ~            /* LFO, VIB (0x80 to 0x97) */
  91++9714              OPL4_REG_LFO_VIBRATO    = 0x80
  92++9714              OPL4_LFO_FREQUENCY_MASK = 0x38
  93++9714              OPL4_VIBRATO_DEPTH_MASK = 0x07
  94++9714              OPL4_CHORUS_SEND_MASK   = 0xC0
  95++9714
  96++9714 ~            /* Attack / Decay 1 rate (0x98 to 0xAF) */
  97++9714              OPL4_REG_ATTACK_DECAY1  = 0x98
  98++9714              OPL4_ATTACK_RATE_MASK   = 0xF0
  99++9714              OPL4_DECAY1_RATE_MASK   = 0x0F
 100++9714
 101++9714 ~            /* Decay level / 2 rate (0xB0 to 0xC7) */
 102++9714              OPL4_REG_LEVEL_DECAY2  = 0xB0
 103++9714              OPL4_DECAY_LEVEL_MASK  = 0xF0
 104++9714              OPL4_DECAY2_RATE_MASK  = 0x0F
 105++9714
 106++9714 ~            /* Release rate / Rate correction (0xC8 to 0xDF) */
 107++9714              OPL4_REG_RELEASE_CORRECTION  = 0xC8
 108++9714              OPL4_RELEASE_RATE_MASK       = 0x0F
 109++9714              OPL4_RATE_INTERPOLATION_MASK = 0xF0
 110++9714
 111++9714 ~            /* AM (0xE0 to 0xF7) */
 112++9714              OPL4_REG_TREMOLO        = 0xE0
 113++9714              OPL4_TREMOLO_DEPTH_MASK = 0x07
 114++9714              OPL4_REVERB_SEND_MASK   = 0xE0
 115++9714
 116++9714 ~            /* Mixer */
 117++9714              OPL4_REG_MIX_CONTROL_FM  = 0xF8
 118++9714              OPL4_REG_MIX_CONTROL_PCM = 0xF9
 119++9714              OPL4_MIX_LEFT_MASK       = 0x07
 120++9714              OPL4_MIX_RIGHT_MASK      = 0x38
 121++9714
 122++9714              OPL4_REG_ATC             = 0xFA
 123++9714              OPL4_ATC_BIT             = 0x01
 124++9714
 125++9714 ~            /* Bits in the OPL4 Status register */
 126++9714              OPL4_STATUS_BUSY = 0x01
 127++9714              OPL4_STATUS_LOAD = 0x02
 128++9714
# file closed: GPlay/common/moonsound.asm
   2++9714
   3++9714              opl4writefm1
   4++9714              ;e = register
   5++9714              ;d = value
   6++9714              	opl4_wait
   6++9714 3E 00       >	ld a,MOON_BASE_HI
   6++9716 DB 24       >	in a,(MOON_STAT)
   6++9718 0F          >	rrca
   6++9719 38 FB       >	jr c,$-3
   7++971B 7B           	ld a,e
   8++971C C5           	push bc
   9++971D 06 00        	ld b,MOON_BASE_HI
  10++971F 0E 24        	ld c,MOON_REG1
  11++9721 ED 79        	out (c),a
  12++9723              	opl4_wait
  12++9723 3E 00       >	ld a,MOON_BASE_HI
  12++9725 DB 24       >	in a,(MOON_STAT)
  12++9727 0F          >	rrca
  12++9728 38 FB       >	jr c,$-3
  13++972A 7A           	ld a,d
  14++972B 06 00        	ld b,MOON_BASE_HI
  15++972D 0E 25        	ld c,MOON_DAT1
  16++972F ED 79        	out (c),a
  17++9731 C1           	pop bc
  18++9732 C9           	ret
  19++9733
  20++9733              opl4writefm2
  21++9733              ;e = register
  22++9733              ;d = value
  23++9733              	opl4_wait
  23++9733 3E 00       >	ld a,MOON_BASE_HI
  23++9735 DB 24       >	in a,(MOON_STAT)
  23++9737 0F          >	rrca
  23++9738 38 FB       >	jr c,$-3
  24++973A 7B           	ld a,e
  25++973B C5           	push bc
  26++973C 06 00        	ld b,MOON_BASE_HI
  27++973E 0E 26        	ld c,MOON_REG2
  28++9740 ED 79        	out (c),a
  29++9742              	opl4_wait
  29++9742 3E 00       >	ld a,MOON_BASE_HI
  29++9744 DB 24       >	in a,(MOON_STAT)
  29++9746 0F          >	rrca
  29++9747 38 FB       >	jr c,$-3
  30++9749 7A           	ld a,d
  31++974A 06 00        	ld b,MOON_BASE_HI
  32++974C 0E 27        	ld c,MOON_DAT2
  33++974E ED 79        	out (c),a
  34++9750 C1           	pop bc
  35++9751 C9           	ret
  36++9752
  37++9752              opl4writewave
  38++9752              ;e = register
  39++9752              ;d = value
  40++9752              	opl4_wait
  40++9752 3E 00       >	ld a,MOON_BASE_HI
  40++9754 DB 24       >	in a,(MOON_STAT)
  40++9756 0F          >	rrca
  40++9757 38 FB       >	jr c,$-3
  41++9759 7B           	ld a,e
  42++975A C5           	push bc
  43++975B 06 00        	ld b,MOON_BASE_HI
  44++975D 0E C2        	ld c,MOON_WREG
  45++975F ED 79        	out (c),a
  46++9761              	opl4_wait
  46++9761 3E 00       >	ld a,MOON_BASE_HI
  46++9763 DB 24       >	in a,(MOON_STAT)
  46++9765 0F          >	rrca
  46++9766 38 FB       >	jr c,$-3
  47++9768 7A           	ld a,d
  48++9769 06 00        	ld b,MOON_BASE_HI
  49++976B 0E C3        	ld c,MOON_WDAT
  50++976D ED 79        	out (c),a
  51++976F C1           	pop bc
  52++9770 C9           	ret
  53++9771
  54++9771              opl4readwave
  55++9771              ;e = register
  56++9771              	opl4_wait
  56++9771 3E 00       >	ld a,MOON_BASE_HI
  56++9773 DB 24       >	in a,(MOON_STAT)
  56++9775 0F          >	rrca
  56++9776 38 FB       >	jr c,$-3
  57++9778 7B           	ld a,e
  58++9779 C5           	push bc
  59++977A 06 00        	ld b,MOON_BASE_HI
  60++977C 0E C2        	ld c,MOON_WREG
  61++977E ED 79        	out (c),a
  62++9780 C1           	pop bc
  63++9781              	opl4_wait
  63++9781 3E 00       >	ld a,MOON_BASE_HI
  63++9783 DB 24       >	in a,(MOON_STAT)
  63++9785 0F          >	rrca
  63++9786 38 FB       >	jr c,$-3
  64++9788 3E 00        	ld a,MOON_BASE_HI
  65++978A DB C3        	in a,(MOON_WDAT)
  66++978C C9           	ret
  67++978D
  68++978D              	macro opl4_write_fm_regs
  69++978D ~            ;e = base register
  70++978D ~            ;d = value
  71++978D ~            ;b = count
  72++978D ~            .loop
  73++978D ~            	call opl4writefm1
  74++978D ~            	call opl4writefm2
  75++978D ~            	inc e
  76++978D ~            	djnz .loop
  77++978D              	endm
  78++978D
  79++978D              	macro opl4_write_wave_regs
  80++978D ~            ;e = base register
  81++978D ~            ;d = value
  82++978D ~            ;b = count
  83++978D ~            .loop
  84++978D ~            	call opl4writewave
  85++978D ~            	inc e
  86++978D ~            	djnz .loop
  87++978D              	endm
  88++978D
  89++978D              opl4init
  90++978D 11 05 03     	ld de,0x0305
  91++9790 CD 33 97     	call opl4writefm2
  92++9793 06 DA        	ld b,0xda
  93++9795 11 20 00     	ld de,0x0020
  94++9798              	opl4_write_wave_regs
  94++9798             >;e = base register
  94++9798             >;d = value
  94++9798             >;b = count
  94++9798             >.loop
  94++9798 CD 52 97    >	call opl4writewave
  94++979B 1C          >	inc e
  94++979C 10 FA       >	djnz .loop
  95++979E 11 F8 1B     	ld de,0x1bf8
  96++97A1 CD 52 97     	call opl4writewave
  97++97A4 11 02 10     	ld de,0x1002
  98++97A7 CD 52 97     	call opl4writewave
  99++97AA 06 D6        	ld b,0xd6
 100++97AC 11 20 00     	ld de,0x0020
 101++97AF              	opl4_write_fm_regs
 101++97AF             >;e = base register
 101++97AF             >;d = value
 101++97AF             >;b = count
 101++97AF             >.loop
 101++97AF CD 14 97    >	call opl4writefm1
 101++97B2 CD 33 97    >	call opl4writefm2
 101++97B5 1C          >	inc e
 101++97B6 10 F7       >	djnz .loop
 102++97B8 11 01 00     	ld de,0x0001
 103++97BB CD 14 97     	call opl4writefm1
 104++97BE 11 08 00     	ld de,0x0008
 105++97C1 CD 14 97     	call opl4writefm1
 106++97C4 11 04 00     	ld de,0x0004
 107++97C7 C3 33 97     	jp opl4writefm2
 108++97CA
 109++97CA              opl4stoptimers
 110++97CA 11 04 80     	ld de,0x8004
 111++97CD CD 14 97     	call opl4writefm1
 112++97D0 11 04 00     	ld de,0x0004
 113++97D3 C3 14 97     	jp opl4writefm1
 114++97D6
 115++97D6              opl4mute
 116++97D6 CD CA 97     	call opl4stoptimers
 117++97D9 11 04 00     	ld de,0x0004
 118++97DC CD 33 97     	call opl4writefm2
 119++97DF 11 BD 00     	ld de,0x00bd
 120++97E2 CD 14 97     	call opl4writefm1 ;rhythm off
 121++97E5 06 16        	ld b,0x16
 122++97E7 11 80 0F     	ld de,0x0f80
 123++97EA              	opl4_write_fm_regs ;max release rate
 123++97EA             >;e = base register
 123++97EA             >;d = value
 123++97EA             >;b = count
 123++97EA             >.loop
 123++97EA CD 14 97    >	call opl4writefm1
 123++97ED CD 33 97    >	call opl4writefm2
 123++97F0 1C          >	inc e
 123++97F1 10 F7       >	djnz .loop
 124++97F3 06 16        	ld b,0x16
 125++97F5 11 40 3F     	ld de,0x3f40
 126++97F8              	opl4_write_fm_regs ;min total level
 126++97F8             >;e = base register
 126++97F8             >;d = value
 126++97F8             >;b = count
 126++97F8             >.loop
 126++97F8 CD 14 97    >	call opl4writefm1
 126++97FB CD 33 97    >	call opl4writefm2
 126++97FE 1C          >	inc e
 126++97FF 10 F7       >	djnz .loop
 127++9801 06 09        	ld b,0x09
 128++9803 11 A0 00     	ld de,0x00a0
 129++9806              	opl4_write_fm_regs ;frequency 0
 129++9806             >;e = base register
 129++9806             >;d = value
 129++9806             >;b = count
 129++9806             >.loop
 129++9806 CD 14 97    >	call opl4writefm1
 129++9809 CD 33 97    >	call opl4writefm2
 129++980C 1C          >	inc e
 129++980D 10 F7       >	djnz .loop
 130++980F 06 09        	ld b,0x09
 131++9811 11 B0 00     	ld de,0x00b0
 132++9814              	opl4_write_fm_regs ;key off
 132++9814             >;e = base register
 132++9814             >;d = value
 132++9814             >;b = count
 132++9814             >.loop
 132++9814 CD 14 97    >	call opl4writefm1
 132++9817 CD 33 97    >	call opl4writefm2
 132++981A 1C          >	inc e
 132++981B 10 F7       >	djnz .loop
 133++981D 06 18        	ld b,0x18
 134++981F 11 68 40     	ld de,0x4068
 135++9822              	opl4_write_wave_regs ;key off, damp
 135++9822             >;e = base register
 135++9822             >;d = value
 135++9822             >;b = count
 135++9822             >.loop
 135++9822 CD 52 97    >	call opl4writewave
 135++9825 1C          >	inc e
 135++9826 10 FA       >	djnz .loop
 136++9828 11 05 00     	ld de,0x0005
 137++982B C3 33 97     	jp opl4writefm2
 138++982E
 139++982E              opl4setmemoryaddress
 140++982E              ;dhl = memory address
 141++982E 1E 03        	ld e,0x03
 142++9830 CD 52 97     	call opl4writewave
 143++9833 54           	ld d,h
 144++9834 1C           	inc e
 145++9835 CD 52 97     	call opl4writewave
 146++9838 1C           	inc e
 147++9839 55           	ld d,l
 148++983A C3 52 97     	jp opl4writewave
 149++983D
 150++983D              opl4readmemory
 151++983D              ;bc = byte count
 152++983D              ;dhl = memory address
 153++983D              ;ix = buffer
 154++983D CD 2E 98     	call opl4setmemoryaddress
 155++9840 11 02 11     	ld de,0x1102
 156++9843 CD 52 97     	call opl4writewave
 157++9846              	opl4_wait
 157++9846 3E 00       >	ld a,MOON_BASE_HI
 157++9848 DB 24       >	in a,(MOON_STAT)
 157++984A 0F          >	rrca
 157++984B 38 FB       >	jr c,$-3
 158++984D 3E 06        	ld a,6
 159++984F C5           	push bc
 160++9850 06 00        	ld b,MOON_BASE_HI
 161++9852 0E C2        	ld c,MOON_WREG
 162++9854 ED 79        	out (c),a
 163++9856 C1           	pop bc
 164++9857 DD 54 DD 5D  	ld de,ix
 165++985B 79           	ld a,c
 166++985C 0B           	dec bc
 167++985D 04           	inc b
 168++985E 48           	ld c,b
 169++985F 47           	ld b,a
 170++9860              .readloop
 171++9860              	opl4_wait
 171++9860 3E 00       >	ld a,MOON_BASE_HI
 171++9862 DB 24       >	in a,(MOON_STAT)
 171++9864 0F          >	rrca
 171++9865 38 FB       >	jr c,$-3
 172++9867 3E 00        	ld a,MOON_BASE_HI
 173++9869 DB C3        	in a,(MOON_WDAT)
 174++986B 12           	ld (de),a
 175++986C 13           	inc de
 176++986D 10 F1        	djnz .readloop
 177++986F 0D           	dec c
 178++9870 20 EE        	jr nz,.readloop
 179++9872 11 02 10     	ld de,0x1002
 180++9875 C3 52 97     	jp opl4writewave
 181++9878
 182++9878              opl4writememory
 183++9878              ;bc = number of bytes
 184++9878              ;dhl = memory address
 185++9878              ;ix = buffer
 186++9878 CD 2E 98     	call opl4setmemoryaddress
 187++987B 11 02 11     	ld de,0x1102
 188++987E CD 52 97     	call opl4writewave
 189++9881              	opl4_wait
 189++9881 3E 00       >	ld a,MOON_BASE_HI
 189++9883 DB 24       >	in a,(MOON_STAT)
 189++9885 0F          >	rrca
 189++9886 38 FB       >	jr c,$-3
 190++9888 3E 06        	ld a,6
 191++988A C5           	push bc
 192++988B 06 00        	ld b,MOON_BASE_HI
 193++988D 0E C2        	ld c,MOON_WREG
 194++988F ED 79        	out (c),a
 195++9891 C1           	pop bc
 196++9892 DD 54 DD 5D  	ld de,ix
 197++9896 79           	ld a,c
 198++9897 0B           	dec bc
 199++9898 04           	inc b
 200++9899 48           	ld c,b
 201++989A 47           	ld b,a
 202++989B              .writeloop
 203++989B              	opl4_wait
 203++989B 3E 00       >	ld a,MOON_BASE_HI
 203++989D DB 24       >	in a,(MOON_STAT)
 203++989F 0F          >	rrca
 203++98A0 38 FB       >	jr c,$-3
 204++98A2 1A           	ld a,(de)
 205++98A3 C5           	push bc
 206++98A4 06 00        	ld b,MOON_BASE_HI
 207++98A6 0E C3        	ld c,MOON_WDAT
 208++98A8 ED 79        	out (c),a
 209++98AA C1           	pop bc
 210++98AB 13           	inc de
 211++98AC 10 ED        	djnz .writeloop
 212++98AE 0D           	dec c
 213++98AF 20 EA        	jr nz,.writeloop
 214++98B1 11 02 10     	ld de,0x1002
 215++98B4 C3 52 97     	jp opl4writewave
 216++98B7
# file closed: GPlay/common/opl4.asm
  75++98B7              	include "common/opm.asm"
# file opened: GPlay/common/opm.asm
   1++98B7              ;Having chip 0 is mandatory for the player to detect YM2151,
   2++98B7              ;chip 1 is an optional second chip.
   3++98B7
   4++98B7              OPM0_REG = 0xf0c1 ;write: chip 0 address
   5++98B7              OPM0_DAT = 0xf1c1 ;write: chip 0 value, read: chip 0 status
   6++98B7              OPM1_REG = 0xf2c1 ;write: chip 1 address
   7++98B7              OPM1_DAT = 0xf3c1 ;write: chip 1 value, read: chip 1 status
   8++98B7
   9++98B7              	macro opm_write_reg reg,dat
  10++98B7 ~            ;bc = data port
  11++98B7 ~            ;e = register
  12++98B7 ~            ;d = value
  13++98B7 ~            	ld bc,dat
  14++98B7 ~            	in f,(c)
  15++98B7 ~            	jp m,$-2
  16++98B7 ~            	ld bc,reg
  17++98B7 ~            	out (c),e
  18++98B7 ~            	ld bc,dat
  19++98B7 ~            	in f,(c)
  20++98B7 ~            	jp m,$-2
  21++98B7 ~            	out (c),d
  22++98B7              	endm
  23++98B7
  24++98B7              opmwriteall
  25++98B7              ;e = register
  26++98B7              ;d = value
  27++98B7 CD D2 98     	call opmwritechip1
  28++98BA              opmwritechip0
  29++98BA              ;e = register
  30++98BA              ;d = value
  31++98BA              	opm_write_reg OPM0_REG,OPM0_DAT
  31++98BA             >;bc = data port
  31++98BA             >;e = register
  31++98BA             >;d = value
  31++98BA 01 C1 F1    >	ld bc,OPM0_DAT
  31++98BD ED 70       >	in f,(c)
  31++98BF FA BD 98    >	jp m,$-2
  31++98C2 01 C1 F0    >	ld bc,OPM0_REG
  31++98C5 ED 59       >	out (c),e
  31++98C7 01 C1 F1    >	ld bc,OPM0_DAT
  31++98CA ED 70       >	in f,(c)
  31++98CC FA CA 98    >	jp m,$-2
  31++98CF ED 51       >	out (c),d
  32++98D1 C9           	ret
  33++98D2
  34++98D2              opmwritechip1
  35++98D2              ;e = register
  36++98D2              ;d = value
  37++98D2              	opm_write_reg OPM1_REG,OPM1_DAT
  37++98D2             >;bc = data port
  37++98D2             >;e = register
  37++98D2             >;d = value
  37++98D2 01 C1 F3    >	ld bc,OPM1_DAT
  37++98D5 ED 70       >	in f,(c)
  37++98D7 FA D5 98    >	jp m,$-2
  37++98DA 01 C1 F2    >	ld bc,OPM1_REG
  37++98DD ED 59       >	out (c),e
  37++98DF 01 C1 F3    >	ld bc,OPM1_DAT
  37++98E2 ED 70       >	in f,(c)
  37++98E4 FA E2 98    >	jp m,$-2
  37++98E7 ED 51       >	out (c),d
  38++98E9 C9           	ret
  39++98EA
  40++98EA              opmdisablechip1
  41++98EA 3E C9        	ld a,0xc9 ;ret opcode
  42++98EC 32 D2 98     	ld (opmwritechip1),a
  43++98EF C9           	ret
  44++98F0
  45++98F0              	macro opm_write_regs incr,incd
  46++98F0 ~            ;e = base register
  47++98F0 ~            ;d = value
  48++98F0 ~            ;l = count
  49++98F0 ~            .loop	call opmwriteall
  50++98F0 ~            	IF incr
  51++98F0 ~            	inc e
  52++98F0 ~            	ENDIF
  53++98F0 ~            	IF incd
  54++98F0 ~            	inc d
  55++98F0 ~            	ENDIF
  56++98F0 ~            	dec l
  57++98F0 ~            	jr nz,.loop
  58++98F0              	endm
  59++98F0
  60++98F0              opminit
  61++98F0 2E 00        	ld l,0
  62++98F2 11 00 00     	ld de,0
  63++98F5              	opm_write_regs 1,0
  63++98F5             >;e = base register
  63++98F5             >;d = value
  63++98F5             >;l = count
  63++98F5 CD B7 98    >.loop	call opmwriteall
  63++98F8             >	IF 1
  63++98F8 1C          >	inc e
  63++98F9             >	ENDIF
  63++98F9             >	IF 0
  63++98F9 ~           >	inc d
  63++98F9             >	ENDIF
  63++98F9 2D          >	dec l
  63++98FA 20 F9       >	jr nz,.loop
  64++98FC C9           	ret
  65++98FD
  66++98FD              opmstoptimers
  67++98FD 11 14 30     	ld de,0x3014
  68++9900 CD B7 98     	call opmwriteall
  69++9903 11 14 00     	ld de,0x0014
  70++9906 C3 B7 98     	jp opmwriteall
  71++9909
  72++9909              opmmute
  73++9909 CD FD 98     	call opmstoptimers
  74++990C              ;max release rate
  75++990C 2E 20        	ld l,0x20
  76++990E 11 E0 0F     	ld de,0x0fe0
  77++9911              	opm_write_regs 1,0
  77++9911             >;e = base register
  77++9911             >;d = value
  77++9911             >;l = count
  77++9911 CD B7 98    >.loop	call opmwriteall
  77++9914             >	IF 1
  77++9914 1C          >	inc e
  77++9915             >	ENDIF
  77++9915             >	IF 0
  77++9915 ~           >	inc d
  77++9915             >	ENDIF
  77++9915 2D          >	dec l
  77++9916 20 F9       >	jr nz,.loop
  78++9918              ;min total level
  79++9918 2E 20        	ld l,0x20
  80++991A 11 60 7F     	ld de,0x7f60
  81++991D              	opm_write_regs 1,0
  81++991D             >;e = base register
  81++991D             >;d = value
  81++991D             >;l = count
  81++991D CD B7 98    >.loop	call opmwriteall
  81++9920             >	IF 1
  81++9920 1C          >	inc e
  81++9921             >	ENDIF
  81++9921             >	IF 0
  81++9921 ~           >	inc d
  81++9921             >	ENDIF
  81++9921 2D          >	dec l
  81++9922 20 F9       >	jr nz,.loop
  82++9924              ;key off
  83++9924 2E 08        	ld l,0x08
  84++9926 11 08 00     	ld de,0x0008
  85++9929              	opm_write_regs 0,1
  85++9929             >;e = base register
  85++9929             >;d = value
  85++9929             >;l = count
  85++9929 CD B7 98    >.loop	call opmwriteall
  85++992C             >	IF 0
  85++992C ~           >	inc e
  85++992C             >	ENDIF
  85++992C             >	IF 1
  85++992C 14          >	inc d
  85++992D             >	ENDIF
  85++992D 2D          >	dec l
  85++992E 20 F9       >	jr nz,.loop
  86++9930 C9           	ret
  87++9931
# file closed: GPlay/common/opm.asm
  76++9931              	include "vgm/opl4.asm"
# file opened: GPlay/vgm/opl4.asm
   1++9931              WAVEHEADERBUFFERSIZE = MOONRAMWAVETABLESIZE*MOONWAVEHEADERSIZE
   2++9931
   3++9931              opl4writemusiconlyfm1
   4++9931              ;skips writes to control registers
   5++9931              ;e = register
   6++9931              ;d = value
   7++9931 7B           	ld a,e
   8++9932 FE 20        	cp 0x20
   9++9934 D2 14 97     	jp nc,opl4writefm1
  10++9937 FE 08        	cp 0x08
  11++9939 C0           	ret nz
  12++993A C3 14 97     	jp opl4writefm1
  13++993D
  14++993D              opl4writemusiconlyfm2
  15++993D              ;skips writes to control registers
  16++993D              ;e = register
  17++993D              ;d = value
  18++993D 7B           	ld a,e
  19++993E FE 04        	cp 4
  20++9940 D8               ret c
  21++9941 FE 05        	cp 5
  22++9943 C8           	ret z
  23++9944 C3 33 97     	jp opl4writefm2
  24++9947
  25++9947              opl4writewavemusiconly
  26++9947              ;skips writes to control registers and handles ROM dumps
  27++9947              ;e = register
  28++9947              ;d = value
  29++9947 7B           	ld a,e
  30++9948 FE 38        	cp 0x38
  31++994A D2 52 97     	jp nc,opl4writewave
  32++994D FE 08        	cp 0x08
  33++994F D8           	ret c
  34++9950 FE 20        	cp 0x20
  35++9952 38 07        	jr c,writewavetableindexlo
  36++9954              ;force wave table index into 384--511 range if ROM data is loaded
  37++9954              isromloaded=$+1
  38++9954 3E 00        	ld a,0
  39++9956 B2           	or d
  40++9957 57           	ld d,a
  41++9958 C3 52 97     	jp opl4writewave
  42++995B              writewavetableindexlo
  43++995B 3A 55 99     	ld a,(isromloaded)
  44++995E 0F           	rrca
  45++995F B2           	or d
  46++9960 57           	ld d,a
  47++9961 CD 52 97     	call opl4writewave
  48++9964              ;wait for the header to load
  49++9964 3E 00        	ld a,MOON_BASE_HI
  50++9966 DB 24        	in a,(MOON_STAT)
  51++9968 E6 03        	and 3
  52++996A 20 FA        	jr nz,$-4
  53++996C C9           	ret
  54++996D
  55++996D              vgmopl4init
  56++996D AF           	xor a
  57++996E 32 55 99     	ld (isromloaded),a
  58++9971 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
  59++9974 22 B3 99     	ld (opl4loadramdatablockheader.romsize0),hl
  60++9977 3E 20        	ld a,MOONSOUNDROMSIZE/65536
  61++9979 32 B7 99     	ld (opl4loadramdatablockheader.romsize2),a
  62++997C C3 8D 97     	jp opl4init
  63++997F
  64++997F              sub24x16
  65++997F              ;dhl = minuend
  66++997F              ;bc = subtrahend
  67++997F              ;out: cf=1 if negative result, zf=1 if zero
  68++997F B7 ED 42     	sub hl,bc
  69++9982 38 04        	jr c,.carry
  70++9984 C0           	ret nz
  71++9985 7A           	ld a,d
  72++9986 B7           	or a
  73++9987 C9           	ret
  74++9988              .carry
  75++9988 7A           	ld a,d
  76++9989 DE 00        	sbc a,0
  77++998B 57           	ld d,a
  78++998C C0           	ret nz
  79++998D 7D           	ld a,l
  80++998E B4           	or h
  81++998F C9           	ret
  82++9990
  83++9990              opl4loadromdatablockheader
  84++9990              ;dhl = header+data size
  85++9990              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
  86++9990 D9           	exx
  87++9991 CD 71 96     	call memorystreamread4 ;adbc = total rom size
  88++9994 ED 43 B3 99  	ld (opl4loadramdatablockheader.romsize0),bc
  89++9998 7A           	ld a,d
  90++9999 C6 20        	add 0x20 ;place in RAM
  91++999B 32 B7 99     	ld (opl4loadramdatablockheader.romsize2),a
  92++999E CD 71 96     	call memorystreamread4 ;adbc = start address
  93++99A1 60 69        	ld hl,bc
  94++99A3 CB EA        	set 5,d ;place in RAM
  95++99A5 D9           	exx
  96++99A6 01 08 00     	ld bc,8
  97++99A9 18 D4        	jr sub24x16
  98++99AB
  99++99AB              opl4loadramdatablockheader
 100++99AB              ;dhl = header+data size
 101++99AB              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
 102++99AB D9           	exx
 103++99AC CD 71 96     	call memorystreamread4 ;adbc = total ram size
 104++99AF CD 71 96     	call memorystreamread4 ;adbc = start address
 105++99B2              .romsize0=$+1
 106++99B2 21 00 00     	ld hl,0
 107++99B5 09           	add hl,bc
 108++99B6              .romsize2=$+1
 109++99B6 3E 00        	ld a,0
 110++99B8 8A           	adc a,d
 111++99B9 E6 3F        	and 0x3f
 112++99BB 57           	ld d,a
 113++99BC D9           	exx
 114++99BD 01 08 00     	ld bc,8
 115++99C0 18 BD        	jr sub24x16
 116++99C2
 117++99C2              setup24bitscounterloop
 118++99C2              ;dhl = counter
 119++99C2              ;out: b = inner loop counter, de = outer loop counter
 120++99C2 5D           	ld e,l
 121++99C3 01 01 00     	ld bc,1
 122++99C6 B7 ED 42     	sub hl,bc
 123++99C9 30 01        	jr nc,$+3
 124++99CB 15           	dec d
 125++99CC 43           	ld b,e
 126++99CD 5C           	ld e,h
 127++99CE 13           	inc de
 128++99CF C9           	ret
 129++99D0
 130++99D0              opl4loadsample
 131++99D0              ;dhl = sample start address
 132++99D0              ;dhl' = sample size
 133++99D0 42           	ld b,d
 134++99D1 11 05 03     	ld de,0x0305
 135++99D4 CD 33 97     	call opl4writefm2
 136++99D7 50           	ld d,b
 137++99D8 CD 2E 98     	call opl4setmemoryaddress
 138++99DB 11 02 11     	ld de,0x1102
 139++99DE CD 52 97     	call opl4writewave
 140++99E1              	opl4_wait
 140++99E1 3E 00       >	ld a,MOON_BASE_HI
 140++99E3 DB 24       >	in a,(MOON_STAT)
 140++99E5 0F          >	rrca
 140++99E6 38 FB       >	jr c,$-3
 141++99E8 3E 06        	ld a,6
 142++99EA C5           	push bc
 143++99EB 06 00        	ld b,MOON_BASE_HI
 144++99ED 0E C2        	ld c,MOON_WREG
 145++99EF ED 79        	out (c),a
 146++99F1 C1           	pop bc
 147++99F2 D9           	exx
 148++99F3 CD C2 99     	call setup24bitscounterloop
 149++99F6 2A 72 96     	ld hl,(memorystreamcurrentaddr)
 150++99F9              .loop
 151++99F9              	memory_stream_read_byte c
 151++99F9 CB 74       >	bit 6,h
 151++99FB             >        IF AREA_C000_FFFF=1
 151++99FB CC 0D 96    >	call z,memorystreamnextpage
 151++99FE             >        ELSE
 151++99FE ~           > 	call nz,memorystreamnextpage
 151++99FE             >        ENDIF
 151++99FE 4E          >	ld c,(hl)
 151++99FF 23          >	inc hl
 152++9A00              	opl4_wait
 152++9A00 3E 00       >	ld a,MOON_BASE_HI
 152++9A02 DB 24       >	in a,(MOON_STAT)
 152++9A04 0F          >	rrca
 152++9A05 38 FB       >	jr c,$-3
 153++9A07 79           	ld a,c
 154++9A08 C5           	push bc
 155++9A09 06 00        	ld b,MOON_BASE_HI
 156++9A0B 0E C3        	ld c,MOON_WDAT
 157++9A0D ED 79        	out (c),a
 158++9A0F C1           	pop bc
 159++9A10 10 E7        	djnz .loop
 160++9A12 1B           	dec de
 161++9A13 7B           	ld a,e
 162++9A14 B2           	or d
 163++9A15 20 E2        	jr nz,.loop
 164++9A17 22 72 96     	ld (memorystreamcurrentaddr),hl
 165++9A1A 11 02 10     	ld de,0x1002
 166++9A1D C3 52 97     	jp opl4writewave
 167++9A20
 168++9A20              opl4loadramdatablock
 169++9A20              ;dhl = data+header size
 170++9A20 CD AB 99     	call opl4loadramdatablockheader
 171++9A23 C8           	ret z
 172++9A24 D9           	exx
 173++9A25 18 A9        	jr opl4loadsample
 174++9A27
 175++9A27              opl4loadromdatablock
 176++9A27              ;dhl = data+header size
 177++9A27 CD 90 99     	call opl4loadromdatablockheader
 178++9A2A C8           	ret z
 179++9A2B D9           	exx
 180++9A2C D5           	push de
 181++9A2D CD D0 99     	call opl4loadsample
 182++9A30 F1           	pop af
 183++9A31              ;check if the address is within the first 64K of RAM
 184++9A31 FE 21        	cp 0x21
 185++9A33 D0           	ret nc
 186++9A34              ;patch all 128 headers that LSI can read from RAM
 187++9A34 3E 01        	ld a,1
 188++9A36 32 55 99     	ld (isromloaded),a
 189++9A39 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 190++9A3C 16 20        	ld d,MOONSOUNDROMSIZE/65536
 191++9A3E 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 192++9A41 DD 21 00 B8  	ld ix,waveheaderbuffer
 193++9A45 CD 3D 98     	call opl4readmemory
 194++9A48 21 00 B8     	ld hl,waveheaderbuffer
 195++9A4B 11 0C 00     	ld de,MOONWAVEHEADERSIZE
 196++9A4E 06 80        	ld b,MOONRAMWAVETABLESIZE
 197++9A50              .loop
 198++9A50 CB EE        	set 5,(hl) ;set base address in RAM area
 199++9A52 19           	add hl,de
 200++9A53 10 FB        	djnz .loop
 201++9A55 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 202++9A58 16 20        	ld d,MOONSOUNDROMSIZE/65536
 203++9A5A 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 204++9A5D DD 21 00 B8  	ld ix,waveheaderbuffer
 205++9A61 C3 78 98     	jp opl4writememory
 206++9A64
 207++9A64              opl4inittimer60hz
 208++9A64 11 02 2F     	ld de,0x2f02
 209++9A67 CD 14 97     	call opl4writefm1
 210++9A6A 11 04 21     	ld de,0x2104
 211++9A6D C3 14 97     	jp opl4writefm1
 212++9A70
 213++9A70              opl4waittimer60hz
 214++9A70 3E 00        	ld a,MOON_BASE_HI
 215++9A72 DB 24        	in a,(MOON_STAT)
 216++9A74 17           	rla
 217++9A75 30 F9        	jr nc,opl4waittimer60hz
 218++9A77 11 04 81     	ld de,0x8104
 219++9A7A C3 14 97     	jp opl4writefm1
 220++9A7D
# file closed: GPlay/vgm/opl4.asm
  77++9A7D              	include "common/opn.asm"
# file opened: GPlay/common/opn.asm
   1++9A7D              ;Define ENABLE_FM to enable FM DACs
   2++9A7D
   3++9A7D              OPN_REG = 0xfffd
   4++9A7D              OPN_DAT = 0xbffd
   5++9A7D
   6++9A7D
   7++9A7D                      ifdef ENABLE_FM
   8++9A7D ~            CHIP0 = %11111000
   9++9A7D ~            CHIP1 = %11111001
  10++9A7D                      else
  11++9A7D              CHIP0 = %11111100
  12++9A7D              CHIP1 = %11111101
  13++9A7D                      endif
  14++9A7D
  15++9A7D
  16++9A7D              ;------------------------------------
  17++9A7D              opnwriteall
  18++9A7D CD A0 9A     	call opnwritefm2
  19++9A80              ;------------------------------------
  20++9A80              opnwritefm1:
  21++9A80              	;opn_write_fm_reg 0
  22++9A80 3E FC              	ld a,CHIP0
  23++9A82              opnwritefmx:
  24++9A82              ;a = chipselect
  25++9A82              ;e = register
  26++9A82              ;d = value
  27++9A82 01 FD FF     	ld bc,OPN_REG
  28++9A85 ED 79        	out (c),a
  29++9A87
  30++9A87              1
  31++9A87 00           	nop
  31++9A88 00            nop
  32++9A89              ;        nop:nop:nop
  33++9A89 ED 70        	in f,(c)
  34++9A8B FA 87 9A     	jp m, 1b ;$-6
  35++9A8E
  36++9A8E ED 59        	out (c),e
  37++9A90
  38++9A90              2
  39++9A90 00             	nop
  39++9A91 00            nop
  40++9A92              ;        nop:nop:nop
  41++9A92 ED 70        	in f,(c)
  42++9A94 FA 90 9A     	jp m,2b   ;$-6
  43++9A97
  44++9A97 06 BF        	ld b,HIGH OPN_DAT
  45++9A99 ED 51        	out (c),d
  46++9A9B
  47++9A9B              .extradelay ;additional delay for FPGA systems
  48++9A9B 06 08        	ld b,8
  49++9A9D 10 FE        	djnz $
  50++9A9F C9           	ret
  51++9AA0              ;------------------------------------
  52++9AA0              opnwritefm2:
  53++9AA0 3E FD               	ld a,CHIP1
  54++9AA2 C3 82 9A             jp opnwritefmx
  55++9AA5              ;------------------------------------
  56++9AA5
  57++9AA5
  58++9AA5              opndisableextradelay
  59++9AA5 3E C9        	ld a,0xc9 ;ret opcode
  60++9AA7 32 9B 9A     	ld (opnwritefmx.extradelay),a
  61++9AAA C9           	ret
  62++9AAB
  63++9AAB
  64++9AAB              	macro opn_write_fm_regs incr,incd
  65++9AAB ~            ;e = base register
  66++9AAB ~            ;d = value
  67++9AAB ~            ;l = count
  68++9AAB ~            .loop	call opnwriteall
  69++9AAB ~            	IF incr
  70++9AAB ~            	inc e
  71++9AAB ~            	ENDIF
  72++9AAB ~            	IF incd
  73++9AAB ~            	inc d
  74++9AAB ~            	ENDIF
  75++9AAB ~            	dec l
  76++9AAB ~            	jr nz,.loop
  77++9AAB              	endm
  78++9AAB
  79++9AAB
  80++9AAB
  81++9AAB              opninit
  82++9AAB 2E B4        	ld l,0xb4
  83++9AAD 11 00 00     	ld de,0x0000
  84++9AB0              	opn_write_fm_regs 1,0
  84++9AB0             >;e = base register
  84++9AB0             >;d = value
  84++9AB0             >;l = count
  84++9AB0 CD 7D 9A    >.loop	call opnwriteall
  84++9AB3             >	IF 1
  84++9AB3 1C          >	inc e
  84++9AB4             >	ENDIF
  84++9AB4             >	IF 0
  84++9AB4 ~           >	inc d
  84++9AB4             >	ENDIF
  84++9AB4 2D          >	dec l
  84++9AB5 20 F9       >	jr nz,.loop
  85++9AB7              ;configure prescaler
  86++9AB7 11 2F 00     	ld de,0x002f
  87++9ABA CD 7D 9A     	call opnwriteall
  88++9ABD 11 2D 00     	ld de,0x002d
  89++9AC0 C3 7D 9A     	jp opnwriteall
  90++9AC3
  91++9AC3              opnstoptimers
  92++9AC3 11 27 30     	ld de,0x3027
  93++9AC6 CD 7D 9A     	call opnwriteall
  94++9AC9 11 27 00     	ld de,0x0027
  95++9ACC C3 7D 9A     	jp opnwriteall
  96++9ACF
  97++9ACF              opnmute
  98++9ACF CD C3 9A     	call opnstoptimers
  99++9AD2              ;mute SSG
 100++9AD2 2E 03        	ld l,3
 101++9AD4 11 08 00     	ld de,0x0008
 102++9AD7              	opn_write_fm_regs 1,0
 102++9AD7             >;e = base register
 102++9AD7             >;d = value
 102++9AD7             >;l = count
 102++9AD7 CD 7D 9A    >.loop	call opnwriteall
 102++9ADA             >	IF 1
 102++9ADA 1C          >	inc e
 102++9ADB             >	ENDIF
 102++9ADB             >	IF 0
 102++9ADB ~           >	inc d
 102++9ADB             >	ENDIF
 102++9ADB 2D          >	dec l
 102++9ADC 20 F9       >	jr nz,.loop
 103++9ADE 2E 0E        	ld l,14
 104++9AE0 11 00 00     	ld de,0x0000
 105++9AE3              	opn_write_fm_regs 1,0
 105++9AE3             >;e = base register
 105++9AE3             >;d = value
 105++9AE3             >;l = count
 105++9AE3 CD 7D 9A    >.loop	call opnwriteall
 105++9AE6             >	IF 1
 105++9AE6 1C          >	inc e
 105++9AE7             >	ENDIF
 105++9AE7             >	IF 0
 105++9AE7 ~           >	inc d
 105++9AE7             >	ENDIF
 105++9AE7 2D          >	dec l
 105++9AE8 20 F9       >	jr nz,.loop
 106++9AEA              ;max release rate
 107++9AEA 2E 10        	ld l,0x10
 108++9AEC 11 80 0F     	ld de,0x0f80
 109++9AEF              	opn_write_fm_regs 1,0
 109++9AEF             >;e = base register
 109++9AEF             >;d = value
 109++9AEF             >;l = count
 109++9AEF CD 7D 9A    >.loop	call opnwriteall
 109++9AF2             >	IF 1
 109++9AF2 1C          >	inc e
 109++9AF3             >	ENDIF
 109++9AF3             >	IF 0
 109++9AF3 ~           >	inc d
 109++9AF3             >	ENDIF
 109++9AF3 2D          >	dec l
 109++9AF4 20 F9       >	jr nz,.loop
 110++9AF6              ;min total level
 111++9AF6 2E 10        	ld l,0x10
 112++9AF8 11 40 7F     	ld de,0x7f40
 113++9AFB              	opn_write_fm_regs 1,0
 113++9AFB             >;e = base register
 113++9AFB             >;d = value
 113++9AFB             >;l = count
 113++9AFB CD 7D 9A    >.loop	call opnwriteall
 113++9AFE             >	IF 1
 113++9AFE 1C          >	inc e
 113++9AFF             >	ENDIF
 113++9AFF             >	IF 0
 113++9AFF ~           >	inc d
 113++9AFF             >	ENDIF
 113++9AFF 2D          >	dec l
 113++9B00 20 F9       >	jr nz,.loop
 114++9B02              ;key off
 115++9B02 2E 04        	ld l,0x04
 116++9B04 11 28 00     	ld de,0x0028
 117++9B07              	opn_write_fm_regs 0,1
 117++9B07             >;e = base register
 117++9B07             >;d = value
 117++9B07             >;l = count
 117++9B07 CD 7D 9A    >.loop	call opnwriteall
 117++9B0A             >	IF 0
 117++9B0A ~           >	inc e
 117++9B0A             >	ENDIF
 117++9B0A             >	IF 1
 117++9B0A 14          >	inc d
 117++9B0B             >	ENDIF
 117++9B0B 2D          >	dec l
 117++9B0C 20 F9       >	jr nz,.loop
 118++9B0E              ;default tfm state
 119++9B0E 01 FD FF     	ld bc,OPN_REG
 120++9B11 3E FF        	ld a,%11111111
 121++9B13 ED 79        	out (c),a
 122++9B15 C9           	ret
 123++9B16
# file closed: GPlay/common/opn.asm
  78++9B16              	include "vgm/opn.asm"
# file opened: GPlay/vgm/opn.asm
   1++9B16              opniscontrolregister
   2++9B16              ;a = register
   3++9B16              ;out: zf=1 if it's control register, zf=0 otherwise
   4++9B16 FE 0E        	cp 0x0e ;IO port
   5++9B18 C8           	ret z
   6++9B19 FE 0F        	cp 0x0f ;IO port
   7++9B1B C8           	ret z
   8++9B1C FE 2D        	cp 0x2d ;prescaler
   9++9B1E C8           	ret z
  10++9B1F FE 2E        	cp 0x2e ;prescaler
  11++9B21 C8           	ret z
  12++9B22 FE 2F        	cp 0x2f ;prescaler
  13++9B24 C9           	ret
  14++9B25
  15++9B25              opnwritemusiconlyfm1
  16++9B25              ;skips writes to control registers
  17++9B25              ;e = register
  18++9B25              ;d = value
  19++9B25 7B           	ld a,e
  20++9B26 CD 16 9B     	call opniscontrolregister
  21++9B29 C8           	ret z
  22++9B2A FE 27        	cp 0x27 ;timers control
  23++9B2C C2 80 9A     	jp nz,opnwritefm1
  24++9B2F 7A           	ld a,d
  25++9B30 32 5E 9B     	ld (opntimerctrl),a
  26++9B33 F6 0A        	or %00001010 ;avoid altering timer B
  27++9B35 57           	ld d,a
  28++9B36 C3 80 9A     	jp opnwritefm1
  29++9B39
  30++9B39              opnwritemusiconlyfm2
  31++9B39              ;skips writes to control registers
  32++9B39              ;e = register
  33++9B39              ;d = value
  34++9B39 7B           	ld a,e
  35++9B3A CD 16 9B     	call opniscontrolregister
  36++9B3D C8           	ret z
  37++9B3E C3 A0 9A     	jp opnwritefm2
  38++9B41
  39++9B41              opninittimer60hz
  40++9B41              ;	ld de,0xc626
  41++9B41              ;	ld de,0xca26
  42++9B41 11 26 CD     	ld de,0xcd26
  43++9B44 CD 80 9A     	call opnwritefm1
  44++9B47 11 27 2A     	ld de,0x2a27
  45++9B4A C3 80 9A     	jp opnwritefm1
  46++9B4D
  47++9B4D              opnwaittimer60hz
  48++9B4D 01 FD FF     	ld bc,OPN_REG
  49++9B50 3E F8        	ld a,%11111000
  50++9B52 ED 79        	out (c),a
  51++9B54              .waitloop
  52++9B54 ED 78        	in a,(c)
  53++9B56 E6 02        	and 2
  54++9B58 28 FA        	jr z,.waitloop
  55++9B5A 11 27 2A     	ld de,0x2a27
  56++9B5D              opntimerctrl=$+1
  57++9B5D 3E 00        	ld a,0
  58++9B5F B2           	or d
  59++9B60 57           	ld d,a
  60++9B61 C3 80 9A     	jp opnwritefm1
  61++9B64
# file closed: GPlay/vgm/opn.asm
  79++9B64              	include "vgm/opm.asm"
# file opened: GPlay/vgm/opm.asm
   1++9B64              opmwritemusiconlychip0
   2++9B64              ;e = register
   3++9B64              ;d = value
   4++9B64 7B           	ld a,e
   5++9B65 FE 08        	cp 8
   6++9B67 D8           	ret c
   7++9B68 C3 BA 98     	jp opmwritechip0
   8++9B6B
   9++9B6B              opmwritemusiconlychip1
  10++9B6B              ;e = register
  11++9B6B              ;d = value
  12++9B6B 7B           	ld a,e
  13++9B6C FE 08        	cp 8
  14++9B6E D8           	ret c
  15++9B6F C3 D2 98     	jp opmwritechip1
  16++9B72
  17++9B72              vgmopminit
  18++9B72 3E 02        	ld a,2
  19++9B74 32 7B 9B     	ld (opmwaittimer100hz.counter),a
  20++9B77 C3 F0 98     	jp opminit
  21++9B7A
  22++9B7A              opmwaittimer100hz
  23++9B7A              .counter=$+1
  24++9B7A 3E 00        	ld a,0
  25++9B7C 3D           	dec a
  26++9B7D 20 02        	jr nz,$+4
  27++9B7F 3E 02        	ld a,2
  28++9B81 32 7B 9B     	ld (.counter),a
  29++9B84 C8           	ret z
  30++9B85              	;YIELD
  31++9B85              	OS_WAIT
  31++9B85 DF          >	rst #18
  32++9B86 C9           	ret
  33++9B87
# file closed: GPlay/vgm/opm.asm
  80++9B87              	include "vgm/ssg.asm"
# file opened: GPlay/vgm/ssg.asm
   1++9B87              SSG_REG = 0xfffd
   2++9B87              SSG_DAT = 0xbffd
   3++9B87
   4++9B87              	macro ssg_write_reg chip_n
   5++9B87 ~            ;e = register
   6++9B87 ~            ;d = value
   7++9B87 ~            	ld bc,SSG_REG
   8++9B87 ~            	ld a,chip_n+%11111110
   9++9B87 ~            	out (c),a
  10++9B87 ~            	out (c),e
  11++9B87 ~            	ld bc,SSG_DAT
  12++9B87 ~            	out (c),d
  13++9B87              	endm
  14++9B87
  15++9B87              ssgwritemusiconlychip0
  16++9B87 7B           	ld a,e
  17++9B88 FE 0E        	cp 0x0e
  18++9B8A D0           	ret nc
  19++9B8B              ssgwrite0
  20++9B8B              ;e = register
  21++9B8B              ;d = value
  22++9B8B              	ssg_write_reg 0
  22++9B8B             >;e = register
  22++9B8B             >;d = value
  22++9B8B 01 FD FF    >	ld bc,SSG_REG
  22++9B8E 3E FE       >	ld a,0+%11111110
  22++9B90 ED 79       >	out (c),a
  22++9B92 ED 59       >	out (c),e
  22++9B94 01 FD BF    >	ld bc,SSG_DAT
  22++9B97 ED 51       >	out (c),d
  23++9B99 C9           	ret
  24++9B9A
  25++9B9A              ssgwritemusiconlychip1
  26++9B9A 7B           	ld a,e
  27++9B9B FE 0E        	cp 0x0e
  28++9B9D D0           	ret nc
  29++9B9E              ssgwrite1
  30++9B9E              ;e = register
  31++9B9E              ;d = value
  32++9B9E              	ssg_write_reg 1
  32++9B9E             >;e = register
  32++9B9E             >;d = value
  32++9B9E 01 FD FF    >	ld bc,SSG_REG
  32++9BA1 3E FF       >	ld a,1+%11111110
  32++9BA3 ED 79       >	out (c),a
  32++9BA5 ED 59       >	out (c),e
  32++9BA7 01 FD BF    >	ld bc,SSG_DAT
  32++9BAA ED 51       >	out (c),d
  33++9BAC C9           	ret
  34++9BAD
  35++9BAD              ssginit
  36++9BAD C9           	ret
  37++9BAE
  38++9BAE              	macro ssg_write_regs
  39++9BAE ~            ;e = base register
  40++9BAE ~            ;d = value
  41++9BAE ~            ;l = count
  42++9BAE ~            .loop
  43++9BAE ~            	call ssgwrite0
  44++9BAE ~            	call ssgwrite1
  45++9BAE ~            	inc e
  46++9BAE ~            	dec l
  47++9BAE ~            	jr nz,.loop
  48++9BAE              	endm
  49++9BAE
  50++9BAE              ssgmute
  51++9BAE 2E 03        	ld l,3
  52++9BB0 11 08 00     	ld de,8
  53++9BB3              	ssg_write_regs
  53++9BB3             >;e = base register
  53++9BB3             >;d = value
  53++9BB3             >;l = count
  53++9BB3             >.loop
  53++9BB3 CD 8B 9B    >	call ssgwrite0
  53++9BB6 CD 9E 9B    >	call ssgwrite1
  53++9BB9 1C          >	inc e
  53++9BBA 2D          >	dec l
  53++9BBB 20 F6       >	jr nz,.loop
  54++9BBD 2E 0E        	ld l,14
  55++9BBF 11 00 00     	ld de,0
  56++9BC2              	ssg_write_regs
  56++9BC2             >;e = base register
  56++9BC2             >;d = value
  56++9BC2             >;l = count
  56++9BC2             >.loop
  56++9BC2 CD 8B 9B    >	call ssgwrite0
  56++9BC5 CD 9E 9B    >	call ssgwrite1
  56++9BC8 1C          >	inc e
  56++9BC9 2D          >	dec l
  56++9BCA 20 F6       >	jr nz,.loop
  57++9BCC C9           	ret
  58++9BCD
# file closed: GPlay/vgm/ssg.asm
  81++9BCD
  82++9BCD
  83++9BCD
  84++9BCD
  85++9BCD
  86++9BCD
  87++9BCD              waittimer50hz
  88++9BCD              	;YIELD
  89++9BCD              	OS_WAIT
  89++9BCD DF          >	rst #18
  90++9BCE C9           	ret
  91++9BCF
  92++9BCF
  93++9BCF              waveheaderbuffer = 0xc000-2048 ;0x5400 ;текущий размер буфера 1536 (128*12)
  94++9BCF              waveheaderbufferend = waveheaderbuffer+WAVEHEADERBUFFERSIZE
  95++9BCF              vgmheadercopy = waveheaderbufferend
  96++9BCF              vgmheadercopyend = vgmheadercopy+HEADER_SIZE_MAX ;(ещё 256)
  97++9BCF
  98++9BCF              titlestr = waveheaderbufferend
  99++9BCF              titlestrend = titlestr+TITLELENGTH
 100++9BCF
 101++9BCF
 102++9BCF              HEADER_CLOCK_YM2203 = vgmheadercopy+0x44
 103++9BCF              HEADER_CLOCK_YM3812 = vgmheadercopy+0x50
 104++9BCF              HEADER_CLOCK_YMF262 = vgmheadercopy+0x5c
 105++9BCF              HEADER_CLOCK_YMF278B = vgmheadercopy+0x60
 106++9BCF              HEADER_CLOCK_AY8910 = vgmheadercopy+0x74
 107++9BCF
 108++9BCF
 109++9BCF              	macro a_or_dw addr
 110++9BCF ~            	ld hl,(addr+0)
 111++9BCF ~            	or h
 112++9BCF ~            	or l
 113++9BCF ~            	ld de,(addr+2)
 114++9BCF ~            	or d
 115++9BCF ~            	or e
 116++9BCF              	endm
 117++9BCF
 118++9BCF              	macro set_timer wait,ticks
 119++9BCF ~            	ld hl,ticks
 120++9BCF ~            	ld (waittimerstep),hl
 121++9BCF              	endm
 122++9BCF
 123++9BCF
 124++9BCF              init_:
 125++9BCF              	set_timer waittimer50hz,882
 125++9BCF 21 72 03    >	ld hl,882
 125++9BD2 22 86 9C    >	ld (waittimerstep),hl
 126++9BD5 21 00 00     	ld hl,0
 127++9BD8 22 81 9C     	ld (waitcounterlo),hl
 128++9BDB AF           	xor a
 129++9BDC 32 84 9C     	ld (waitcounterhi),a
 130++9BDF 32 66 9C     	ld (devicemask),a
 131++9BE2
 132++9BE2 32 7A 9C           	ld (vgm_play_var),a
 133++9BE5              ;map header to 0x8000
 134++9BE5                      ;first page (vgm_header) now in page_plr3
 135++9BE5                      ;now do init.
 136++9BE5
 137++9BE5              ;copy header
 138++9BE5 01 00 01     	ld bc,HEADER_SIZE_MAX
 139++9BE8 21 00 BE     	ld hl,vgmheadercopy
 140++9BEB 11 01 BE     	ld de,vgmheadercopy+1
 141++9BEE 36 00        	ld (hl),0
 142++9BF0 ED B0        	ldir
 143++9BF2 2A 34 C0     	ld hl,(HEADER_DATA_OFFSET)  ;если HEADER_DATA_OFFSET == 0 to bc = 0x0040 иначе  bc = 0x0034
 144++9BF5 7C           	ld a,h
 145++9BF6 B5           	or l
 146++9BF7 01 40 00     	ld bc,0x40
 147++9BFA 28 02        	jr z,$+4
 148++9BFC 0E 34        	ld c,0x34
 149++9BFE 09           	add hl,bc
 150++9BFF 22 5D 9C     	ld (.dataoffset),hl
 151++9C02                            ;определяем сколько данных заголовка vgm нужно перекинуть в буфер исходя из значения HEADER_DATA_OFFSET
 152++9C02 44 4D        	ld bc,hl
 153++9C04 21 FF FE     	ld hl,-HEADER_SIZE_MAX-1
 154++9C07 09           	add hl,bc
 155++9C08 30 03        	jr nc,$+5
 156++9C0A 01 00 01     	ld bc,HEADER_SIZE_MAX
 157++9C0D
 158++9C0D 21 00 C0     	ld hl,module
 159++9C10 11 00 BE     	ld de,vgmheadercopy
 160++9C13 ED B0        	ldir
 161++9C15              ;setup loop
 162++9C15 AF           	xor a
 163++9C16              	a_or_dw HEADER_LOOP_OFFSET
 163++9C16 2A 1C C0    >	ld hl,(HEADER_LOOP_OFFSET+0)
 163++9C19 B4          >	or h
 163++9C1A B5          >	or l
 163++9C1B ED 5B 1E C0 >	ld de,(HEADER_LOOP_OFFSET+2)
 163++9C1F B2          >	or d
 163++9C20 B3          >	or e
 164++9C21 22 84 9E     	ld (loopoffsetlo),hl
 165++9C24 ED 53 81 9E  	ld (loopoffsethi),de
 166++9C28              ;init Moonsound
 167++9C28 AF           	xor a
 168++9C29              	a_or_dw HEADER_CLOCK_YM3812
 168++9C29 2A 50 BE    >	ld hl,(HEADER_CLOCK_YM3812+0)
 168++9C2C B4          >	or h
 168++9C2D B5          >	or l
 168++9C2E ED 5B 52 BE >	ld de,(HEADER_CLOCK_YM3812+2)
 168++9C32 B2          >	or d
 168++9C33 B3          >	or e
 169++9C34 32 E2 A0     	ld (useYM3812),a
 170++9C37              	a_or_dw HEADER_CLOCK_YMF262
 170++9C37 2A 5C BE    >	ld hl,(HEADER_CLOCK_YMF262+0)
 170++9C3A B4          >	or h
 170++9C3B B5          >	or l
 170++9C3C ED 5B 5E BE >	ld de,(HEADER_CLOCK_YMF262+2)
 170++9C40 B2          >	or d
 170++9C41 B3          >	or e
 171++9C42 20 14        	jr nz,.opl4notneeded
 172++9C44              	a_or_dw HEADER_CLOCK_YMF278B
 172++9C44 2A 60 BE    >	ld hl,(HEADER_CLOCK_YMF278B+0)
 172++9C47 B4          >	or h
 172++9C48 B5          >	or l
 172++9C49 ED 5B 62 BE >	ld de,(HEADER_CLOCK_YMF278B+2)
 172++9C4D B2          >	or d
 172++9C4E B3          >	or e
 173++9C4F 28 07        	jr z,.opl4notneeded
 174++9C51 3A D4 A0     	ld a,(moonsoundstatus)
 175++9C54 FE 02        	cp 2
 176++9C56 C0           	ret nz ;jp nz,memorystreamfree ;sets zf=0
 177++9C57 B7           	or a
 178++9C58              .opl4notneeded
 179++9C58 C4 D3 A0     	call nz,initYMF278B
 180++9C5B C0           	ret nz  ;jp nz,memorystreamfree ;sets zf=0
 181++9C5C              .dataoffset=$+1
 182++9C5C 21 00 00     	ld hl,0
 183++9C5F 11 00 00     	ld de,0
 184++9C62                      ;init music
 185++9C62 CD C8 96     	call memorystreamseek
 186++9C65              devicemask=$+1
 187++9C65 3E 00        	ld a,0
 188++9C67              ;zf=0 if there isn't any supported device
 189++9C67 3D           	dec a
 190++9C68 F8           	ret m
 191++9C69 3C           	inc a
 192++9C6A BF           	cp a
 193++9C6B C9           	ret
 194++9C6C
 195++9C6C
 196++9C6C
 197++9C6C
 198++9C6C
 199++9C6C
 200++9C6C
 201++9C6C
 202++9C6C              MUTE:
 203++9C6C 3E C9                        ld a,$C9			;ret	;stop playing
 204++9C6E 32 7A 9C                     ld (vgm_play_var),a
 205++9C71 3A 66 9C     		ld a,(devicemask)
 206++9C74 E6 08        		and DEVICE_MOONSOUND_MASK
 207++9C76 C4 D6 97     		call nz,opl4mute
 208++9C79 C9                           ret
 209++9C7A
 210++9C7A
 211++9C7A
 212++9C7A
 213++9C7A
 214++9C7A
 215++9C7A
 216++9C7A              PLAY:
 217++9C7A              ;out: zf=0 if still playing, zf=1 otherwise
 218++9C7A              ;waittimercallback=$+1
 219++9C7A              ;	call 0
 220++9C7A
 221++9C7A              vgm_play_var = $
 221++9C7A 00             nop		;nop - play
 222++9C7B 3E 00                ld a,0                          ;(memorystreamcurrentpage)
 223++9C7D              memorystreamcurrentpage equ $-1
 224++9C7D                      IF AREA_C000_FFFF=1
 225++9C7D                          ;SETPGC000
 226++9C7D              			OS_SET_PAGE_SLOT3
 226++9C7D 0E 1C       >    ld c,#1c
 226++9C7F E7          >    rst #20
 227++9C80                      ELSE
 228++9C80 ~                        SETPG8000
 229++9C80                      ENDIF
 230++9C80              playloop
 231++9C80              waitcounterlo=$+1
 232++9C80 21 00 00     	ld hl,0
 233++9C83              waitcounterhi=$+1
 234++9C83 3E 00        	ld a,0
 235++9C85              waittimerstep=$+1
 236++9C85 01 00 00     	ld bc,0
 237++9C88 B7 ED 42     	sub hl,bc
 238++9C8B 16 00        	ld d,0
 239++9C8D 9A           	sbc a,d
 240++9C8E 30 1A        	jr nc,exitplayloop
 241++9C90              ;read command
 242++9C90              	memory_stream_read_1 e
 242++9C90 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 242++9C93             >	memory_stream_read_byte e
 242++9C93 CB 74       >	bit 6,h
 242++9C95             >        IF AREA_C000_FFFF=1
 242++9C95 CC 0D 96    >	call z,memorystreamnextpage
 242++9C98             >        ELSE
 242++9C98 ~           > 	call nz,memorystreamnextpage
 242++9C98             >        ENDIF
 242++9C98 5E          >	ld e,(hl)
 242++9C99 23          >	inc hl
 242++9C9A 22 72 96    >	ld (memorystreamcurrentaddr),hl
 243++9C9D 21 8E 9E     	ld hl,cmdtable
 244++9CA0 19           	add hl,de
 245++9CA1 5E           	ld e,(hl)
 246++9CA2 24           	inc h
 247++9CA3 56           	ld d,(hl)
 248++9CA4 21 80 9C     	ld hl,playloop
 249++9CA7 E5           	push hl
 250++9CA8 EB           	ex hl,de
 251++9CA9 E9           	jp (hl)
 252++9CAA
 253++9CAA              exitplayloop
 254++9CAA 22 81 9C     	ld (waitcounterlo),hl
 255++9CAD 32 84 9C     	ld (waitcounterhi),a
 256++9CB0              ;continue playing
 257++9CB0 F6 01        	or 1
 258++9CB2 C9           	ret
 259++9CB3
 260++9CB3 21 81 9C     wait1	ld hl,waitcounterlo
 261++9CB6 34           	inc (hl)
 262++9CB7 C0           	ret nz
 263++9CB8 23           	inc hl
 264++9CB9 34           	inc (hl)
 265++9CBA C0           	ret nz
 266++9CBB 21 84 9C     	ld hl,waitcounterhi
 267++9CBE 34           	inc (hl)
 268++9CBF C9           	ret
 269++9CC0
 270++9CC0 3E 02        wait2	ld a,2
 271++9CC2 21 81 9C     waitn	ld hl,waitcounterlo
 272++9CC5 86           	add a,(hl)
 273++9CC6 77           	ld (hl),a
 274++9CC7 D0           	ret nc
 275++9CC8 23           	inc hl
 276++9CC9 34           	inc (hl)
 277++9CCA C0           	ret nz
 278++9CCB 21 84 9C     	ld hl,waitcounterhi
 279++9CCE 34           	inc (hl)
 280++9CCF C9           	ret
 281++9CD0
 282++9CD0 3E 03        wait3	ld a,3
 282++9CD2 C3 C2 9C       jp waitn
 283++9CD5 3E 04        wait4	ld a,4
 283++9CD7 C3 C2 9C       jp waitn
 284++9CDA 3E 05        wait5	ld a,5
 284++9CDC C3 C2 9C       jp waitn
 285++9CDF 3E 06        wait6	ld a,6
 285++9CE1 C3 C2 9C       jp waitn
 286++9CE4 3E 07        wait7	ld a,7
 286++9CE6 C3 C2 9C       jp waitn
 287++9CE9 3E 08        wait8	ld a,8
 287++9CEB C3 C2 9C       jp waitn
 288++9CEE 3E 09        wait9	ld a,9
 288++9CF0 C3 C2 9C       jp waitn
 289++9CF3 3E 0A        wait10	ld a,10
 289++9CF5 C3 C2 9C       jp waitn
 290++9CF8 3E 0B        wait11	ld a,11
 290++9CFA C3 C2 9C       jp waitn
 291++9CFD 3E 0C        wait12	ld a,12
 291++9CFF C3 C2 9C       jp waitn
 292++9D02 3E 0D        wait13	ld a,13
 292++9D04 C3 C2 9C       jp waitn
 293++9D07 3E 0E        wait14	ld a,14
 293++9D09 C3 C2 9C       jp waitn
 294++9D0C 3E 0F        wait15	ld a,15
 294++9D0E C3 C2 9C       jp waitn
 295++9D11 3E 10        wait16	ld a,16
 295++9D13 C3 C2 9C       jp waitn
 296++9D16
 297++9D16 11 DF 02     wait735	ld de,735
 298++9D19 2A 81 9C     waitnn	ld hl,(waitcounterlo)
 299++9D1C 19           	add hl,de
 300++9D1D 22 81 9C     	ld (waitcounterlo),hl
 301++9D20 D0           	ret nc
 302++9D21 21 84 9C     	ld hl,waitcounterhi
 303++9D24 34           	inc (hl)
 304++9D25 C9           	ret
 305++9D26
 306++9D26 11 72 03     wait882	ld de,882
 307++9D29 C3 19 9D     	jp waitnn
 308++9D2C
 309++9D2C              waitvar	memory_stream_read_2 e,d
 309++9D2C 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 309++9D2F             >	memory_stream_read_byte e
 309++9D2F CB 74       >	bit 6,h
 309++9D31             >        IF AREA_C000_FFFF=1
 309++9D31 CC 0D 96    >	call z,memorystreamnextpage
 309++9D34             >        ELSE
 309++9D34 ~           > 	call nz,memorystreamnextpage
 309++9D34             >        ENDIF
 309++9D34 5E          >	ld e,(hl)
 309++9D35 23          >	inc hl
 309++9D36             >	memory_stream_read_byte d
 309++9D36 CB 74       >	bit 6,h
 309++9D38             >        IF AREA_C000_FFFF=1
 309++9D38 CC 0D 96    >	call z,memorystreamnextpage
 309++9D3B             >        ELSE
 309++9D3B ~           > 	call nz,memorystreamnextpage
 309++9D3B             >        ENDIF
 309++9D3B 56          >	ld d,(hl)
 309++9D3C 23          >	inc hl
 309++9D3D 22 72 96    >	ld (memorystreamcurrentaddr),hl
 310++9D40 2A 81 9C     	ld hl,(waitcounterlo)
 311++9D43 19           	add hl,de
 312++9D44 22 81 9C     	ld (waitcounterlo),hl
 313++9D47 D0           	ret nc
 314++9D48 21 84 9C     	ld hl,waitcounterhi
 315++9D4B 34           	inc (hl)
 316++9D4C C9           	ret
 317++9D4D
 318++9D4D              	macro skip_n n
 319++9D4D ~            	ld b,n
 320++9D4D ~            	jp memorystreamskip
 321++9D4D              	endm
 322++9D4D
 323++9D4D C9           skip1	ret
 324++9D4E              skip2	skip_n 1
 324++9D4E 06 01       >	ld b,1
 324++9D50 C3 23 96    >	jp memorystreamskip
 325++9D53              skip3	skip_n 2
 325++9D53 06 02       >	ld b,2
 325++9D55 C3 23 96    >	jp memorystreamskip
 326++9D58              skip4	skip_n 3
 326++9D58 06 03       >	ld b,3
 326++9D5A C3 23 96    >	jp memorystreamskip
 327++9D5D              skip5	skip_n 4
 327++9D5D 06 04       >	ld b,4
 327++9D5F C3 23 96    >	jp memorystreamskip
 328++9D62              skip6	skip_n 5
 328++9D62 06 05       >	ld b,5
 328++9D64 C3 23 96    >	jp memorystreamskip
 329++9D67              skip11	skip_n 10
 329++9D67 06 0A       >	ld b,10
 329++9D69 C3 23 96    >	jp memorystreamskip
 330++9D6C              skip12	skip_n 11
 330++9D6C 06 0B       >	ld b,11
 330++9D6E C3 23 96    >	jp memorystreamskip
 331++9D71
 332++9D71
 333++9D71              endofsounddata
 334++9D71                    ;  jp seektoloop ;здесь зацикливание, повтор
 335++9D71 CD 31 94     	  call PLR_MUTE ;выключить звук
 336++9D74              cmdunsupported
 337++9D74              ;stop playing
 338++9D74 F1           	pop af
 339++9D75 AF           	xor a
 340++9D76 C9           	ret
 341++9D77
 342++9D77              cmdYM2203
 343++9D77              	memory_stream_read_2 e,d
 343++9D77 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 343++9D7A             >	memory_stream_read_byte e
 343++9D7A CB 74       >	bit 6,h
 343++9D7C             >        IF AREA_C000_FFFF=1
 343++9D7C CC 0D 96    >	call z,memorystreamnextpage
 343++9D7F             >        ELSE
 343++9D7F ~           > 	call nz,memorystreamnextpage
 343++9D7F             >        ENDIF
 343++9D7F 5E          >	ld e,(hl)
 343++9D80 23          >	inc hl
 343++9D81             >	memory_stream_read_byte d
 343++9D81 CB 74       >	bit 6,h
 343++9D83             >        IF AREA_C000_FFFF=1
 343++9D83 CC 0D 96    >	call z,memorystreamnextpage
 343++9D86             >        ELSE
 343++9D86 ~           > 	call nz,memorystreamnextpage
 343++9D86             >        ENDIF
 343++9D86 56          >	ld d,(hl)
 343++9D87 23          >	inc hl
 343++9D88 22 72 96    >	ld (memorystreamcurrentaddr),hl
 344++9D8B C3 25 9B     	jp opnwritemusiconlyfm1
 345++9D8E
 346++9D8E              cmdYM2203dp
 347++9D8E              	memory_stream_read_2 e,d
 347++9D8E 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 347++9D91             >	memory_stream_read_byte e
 347++9D91 CB 74       >	bit 6,h
 347++9D93             >        IF AREA_C000_FFFF=1
 347++9D93 CC 0D 96    >	call z,memorystreamnextpage
 347++9D96             >        ELSE
 347++9D96 ~           > 	call nz,memorystreamnextpage
 347++9D96             >        ENDIF
 347++9D96 5E          >	ld e,(hl)
 347++9D97 23          >	inc hl
 347++9D98             >	memory_stream_read_byte d
 347++9D98 CB 74       >	bit 6,h
 347++9D9A             >        IF AREA_C000_FFFF=1
 347++9D9A CC 0D 96    >	call z,memorystreamnextpage
 347++9D9D             >        ELSE
 347++9D9D ~           > 	call nz,memorystreamnextpage
 347++9D9D             >        ENDIF
 347++9D9D 56          >	ld d,(hl)
 347++9D9E 23          >	inc hl
 347++9D9F 22 72 96    >	ld (memorystreamcurrentaddr),hl
 348++9DA2 C3 39 9B     	jp opnwritemusiconlyfm2
 349++9DA5
 350++9DA5              cmdYMF278B
 351++9DA5              	memory_stream_read_3 c,e,d
 351++9DA5 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 351++9DA8             >	memory_stream_read_byte c
 351++9DA8 CB 74       >	bit 6,h
 351++9DAA             >        IF AREA_C000_FFFF=1
 351++9DAA CC 0D 96    >	call z,memorystreamnextpage
 351++9DAD             >        ELSE
 351++9DAD ~           > 	call nz,memorystreamnextpage
 351++9DAD             >        ENDIF
 351++9DAD 4E          >	ld c,(hl)
 351++9DAE 23          >	inc hl
 351++9DAF             >	memory_stream_read_byte e
 351++9DAF CB 74       >	bit 6,h
 351++9DB1             >        IF AREA_C000_FFFF=1
 351++9DB1 CC 0D 96    >	call z,memorystreamnextpage
 351++9DB4             >        ELSE
 351++9DB4 ~           > 	call nz,memorystreamnextpage
 351++9DB4             >        ENDIF
 351++9DB4 5E          >	ld e,(hl)
 351++9DB5 23          >	inc hl
 351++9DB6             >	memory_stream_read_byte d
 351++9DB6 CB 74       >	bit 6,h
 351++9DB8             >        IF AREA_C000_FFFF=1
 351++9DB8 CC 0D 96    >	call z,memorystreamnextpage
 351++9DBB             >        ELSE
 351++9DBB ~           > 	call nz,memorystreamnextpage
 351++9DBB             >        ENDIF
 351++9DBB 56          >	ld d,(hl)
 351++9DBC 23          >	inc hl
 351++9DBD 22 72 96    >	ld (memorystreamcurrentaddr),hl
 352++9DC0 0D           	dec c
 353++9DC1 CA 3D 99     	jp z,opl4writemusiconlyfm2
 354++9DC4 F2 47 99     	jp p,opl4writewavemusiconly
 355++9DC7 C3 31 99     	jp opl4writemusiconlyfm1
 356++9DCA
 357++9DCA              cmdYMF262p0
 358++9DCA              cmdYM3812
 359++9DCA              cmdY8950
 360++9DCA              cmdYM3526
 361++9DCA              	memory_stream_read_2 e,d
 361++9DCA 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 361++9DCD             >	memory_stream_read_byte e
 361++9DCD CB 74       >	bit 6,h
 361++9DCF             >        IF AREA_C000_FFFF=1
 361++9DCF CC 0D 96    >	call z,memorystreamnextpage
 361++9DD2             >        ELSE
 361++9DD2 ~           > 	call nz,memorystreamnextpage
 361++9DD2             >        ENDIF
 361++9DD2 5E          >	ld e,(hl)
 361++9DD3 23          >	inc hl
 361++9DD4             >	memory_stream_read_byte d
 361++9DD4 CB 74       >	bit 6,h
 361++9DD6             >        IF AREA_C000_FFFF=1
 361++9DD6 CC 0D 96    >	call z,memorystreamnextpage
 361++9DD9             >        ELSE
 361++9DD9 ~           > 	call nz,memorystreamnextpage
 361++9DD9             >        ENDIF
 361++9DD9 56          >	ld d,(hl)
 361++9DDA 23          >	inc hl
 361++9DDB 22 72 96    >	ld (memorystreamcurrentaddr),hl
 362++9DDE C3 31 99     	jp opl4writemusiconlyfm1
 363++9DE1
 364++9DE1              cmdYMF262p1
 365++9DE1              cmdYM3812dp
 366++9DE1              cmdY8950dp
 367++9DE1              cmdYM3526dp
 368++9DE1              	memory_stream_read_2 e,d
 368++9DE1 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 368++9DE4             >	memory_stream_read_byte e
 368++9DE4 CB 74       >	bit 6,h
 368++9DE6             >        IF AREA_C000_FFFF=1
 368++9DE6 CC 0D 96    >	call z,memorystreamnextpage
 368++9DE9             >        ELSE
 368++9DE9 ~           > 	call nz,memorystreamnextpage
 368++9DE9             >        ENDIF
 368++9DE9 5E          >	ld e,(hl)
 368++9DEA 23          >	inc hl
 368++9DEB             >	memory_stream_read_byte d
 368++9DEB CB 74       >	bit 6,h
 368++9DED             >        IF AREA_C000_FFFF=1
 368++9DED CC 0D 96    >	call z,memorystreamnextpage
 368++9DF0             >        ELSE
 368++9DF0 ~           > 	call nz,memorystreamnextpage
 368++9DF0             >        ENDIF
 368++9DF0 56          >	ld d,(hl)
 368++9DF1 23          >	inc hl
 368++9DF2 22 72 96    >	ld (memorystreamcurrentaddr),hl
 369++9DF5 C3 3D 99     	jp opl4writemusiconlyfm2
 370++9DF8
 371++9DF8              cmdYM2151
 372++9DF8              	memory_stream_read_2 e,d
 372++9DF8 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 372++9DFB             >	memory_stream_read_byte e
 372++9DFB CB 74       >	bit 6,h
 372++9DFD             >        IF AREA_C000_FFFF=1
 372++9DFD CC 0D 96    >	call z,memorystreamnextpage
 372++9E00             >        ELSE
 372++9E00 ~           > 	call nz,memorystreamnextpage
 372++9E00             >        ENDIF
 372++9E00 5E          >	ld e,(hl)
 372++9E01 23          >	inc hl
 372++9E02             >	memory_stream_read_byte d
 372++9E02 CB 74       >	bit 6,h
 372++9E04             >        IF AREA_C000_FFFF=1
 372++9E04 CC 0D 96    >	call z,memorystreamnextpage
 372++9E07             >        ELSE
 372++9E07 ~           > 	call nz,memorystreamnextpage
 372++9E07             >        ENDIF
 372++9E07 56          >	ld d,(hl)
 372++9E08 23          >	inc hl
 372++9E09 22 72 96    >	ld (memorystreamcurrentaddr),hl
 373++9E0C C3 64 9B     	jp opmwritemusiconlychip0
 374++9E0F
 375++9E0F              cmdYM2151dp
 376++9E0F              	memory_stream_read_2 e,d
 376++9E0F 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 376++9E12             >	memory_stream_read_byte e
 376++9E12 CB 74       >	bit 6,h
 376++9E14             >        IF AREA_C000_FFFF=1
 376++9E14 CC 0D 96    >	call z,memorystreamnextpage
 376++9E17             >        ELSE
 376++9E17 ~           > 	call nz,memorystreamnextpage
 376++9E17             >        ENDIF
 376++9E17 5E          >	ld e,(hl)
 376++9E18 23          >	inc hl
 376++9E19             >	memory_stream_read_byte d
 376++9E19 CB 74       >	bit 6,h
 376++9E1B             >        IF AREA_C000_FFFF=1
 376++9E1B CC 0D 96    >	call z,memorystreamnextpage
 376++9E1E             >        ELSE
 376++9E1E ~           > 	call nz,memorystreamnextpage
 376++9E1E             >        ENDIF
 376++9E1E 56          >	ld d,(hl)
 376++9E1F 23          >	inc hl
 376++9E20 22 72 96    >	ld (memorystreamcurrentaddr),hl
 377++9E23 C3 6B 9B     	jp opmwritemusiconlychip1
 378++9E26
 379++9E26              cmdAY8910
 380++9E26              	memory_stream_read_2 e,d
 380++9E26 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 380++9E29             >	memory_stream_read_byte e
 380++9E29 CB 74       >	bit 6,h
 380++9E2B             >        IF AREA_C000_FFFF=1
 380++9E2B CC 0D 96    >	call z,memorystreamnextpage
 380++9E2E             >        ELSE
 380++9E2E ~           > 	call nz,memorystreamnextpage
 380++9E2E             >        ENDIF
 380++9E2E 5E          >	ld e,(hl)
 380++9E2F 23          >	inc hl
 380++9E30             >	memory_stream_read_byte d
 380++9E30 CB 74       >	bit 6,h
 380++9E32             >        IF AREA_C000_FFFF=1
 380++9E32 CC 0D 96    >	call z,memorystreamnextpage
 380++9E35             >        ELSE
 380++9E35 ~           > 	call nz,memorystreamnextpage
 380++9E35             >        ENDIF
 380++9E35 56          >	ld d,(hl)
 380++9E36 23          >	inc hl
 380++9E37 22 72 96    >	ld (memorystreamcurrentaddr),hl
 381++9E3A CB 7B        	bit 7,e
 382++9E3C CA 87 9B     	jp z,ssgwritemusiconlychip0
 383++9E3F CB BB        	res 7,e
 384++9E41 C3 9A 9B     	jp ssgwritemusiconlychip1
 385++9E44
 386++9E44              cmdYMF262dp0 equ memorystreamread2
 387++9E44              cmdYMF262dp1 equ memorystreamread2
 388++9E44
 389++9E44              cmddatablock
 390++9E44              	memory_stream_read_2 a,e ;a = 0x66 guard, e = type
 390++9E44 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 390++9E47             >	memory_stream_read_byte a
 390++9E47 CB 74       >	bit 6,h
 390++9E49             >        IF AREA_C000_FFFF=1
 390++9E49 CC 0D 96    >	call z,memorystreamnextpage
 390++9E4C             >        ELSE
 390++9E4C ~           > 	call nz,memorystreamnextpage
 390++9E4C             >        ENDIF
 390++9E4C 7E          >	ld a,(hl)
 390++9E4D 23          >	inc hl
 390++9E4E             >	memory_stream_read_byte e
 390++9E4E CB 74       >	bit 6,h
 390++9E50             >        IF AREA_C000_FFFF=1
 390++9E50 CC 0D 96    >	call z,memorystreamnextpage
 390++9E53             >        ELSE
 390++9E53 ~           > 	call nz,memorystreamnextpage
 390++9E53             >        ENDIF
 390++9E53 5E          >	ld e,(hl)
 390++9E54 23          >	inc hl
 390++9E55 22 72 96    >	ld (memorystreamcurrentaddr),hl
 391++9E58 FE 66        	cp 0x66
 392++9E5A C2 74 9D     	jp nz,cmdunsupported
 393++9E5D              processdatablock
 394++9E5D              ;e = data type
 395++9E5D CD 71 96     	call memorystreamread4 ;adbc = data size
 396++9E60 7B           	ld a,e
 397++9E61 60 69        	ld hl,bc
 398++9E63              ;	cp 0x81
 399++9E63              ;	jp z,opnaloaddatablock
 400++9E63 FE 84        	cp 0x84
 401++9E65 CA 27 9A     	jp z,opl4loadromdatablock
 402++9E68 FE 87        	cp 0x87
 403++9E6A CA 20 9A     	jp z,opl4loadramdatablock
 404++9E6D D5           	push de
 405++9E6E C5           	push bc
 406++9E6F CD ED 96     	call memorystreamgetpos
 407++9E72 C1           	pop bc
 408++9E73 F1           	pop af
 409++9E74 09           	add hl,bc
 410++9E75 8B           	adc a,e
 411++9E76 5F           	ld e,a
 412++9E77 8A           	adc a,d
 413++9E78 93           	sub e
 414++9E79 57           	ld d,a
 415++9E7A C3 C8 96     	jp memorystreamseek
 416++9E7D
 417++9E7D
 418++9E7D              seektoloop
 419++9E7D 01 1C 00     	ld bc,0x1c
 420++9E80              loopoffsethi=$+1
 421++9E80 11 00 00     	ld de,0
 422++9E83              loopoffsetlo=$+1
 423++9E83 21 00 00     	ld hl,0
 424++9E86              seektopos
 425++9E86              ;dehl + bc = position
 426++9E86              ;out: hl = read address
 427++9E86 09           	add hl,bc
 428++9E87 D2 C8 96     	jp nc,memorystreamseek
 429++9E8A 13           	inc de
 430++9E8B C3 C8 96     	jp memorystreamseek
 431++9E8E
 432++9E8E
 433++9E8E
 434++9E8E
 435++9E8E              cmdtable
 436++9E8E 4D           	db skip1           %256 ; 00
 437++9E8F 4D           	db skip1           %256 ; 01
 438++9E90 4D           	db skip1           %256 ; 02
 439++9E91 4D           	db skip1           %256 ; 03
 440++9E92 4D           	db skip1           %256 ; 04
 441++9E93 4D           	db skip1           %256 ; 05
 442++9E94 4D           	db skip1           %256 ; 06
 443++9E95 4D           	db skip1           %256 ; 07
 444++9E96 4D           	db skip1           %256 ; 08
 445++9E97 4D           	db skip1           %256 ; 09
 446++9E98 4D           	db skip1           %256 ; 0A
 447++9E99 4D           	db skip1           %256 ; 0B
 448++9E9A 4D           	db skip1           %256 ; 0C
 449++9E9B 4D           	db skip1           %256 ; 0D
 450++9E9C 4D           	db skip1           %256 ; 0E
 451++9E9D 4D           	db skip1           %256 ; 0F
 452++9E9E 4D           	db skip1           %256 ; 10
 453++9E9F 4D           	db skip1           %256 ; 11
 454++9EA0 4D           	db skip1           %256 ; 12
 455++9EA1 4D           	db skip1           %256 ; 13
 456++9EA2 4D           	db skip1           %256 ; 14
 457++9EA3 4D           	db skip1           %256 ; 15
 458++9EA4 4D           	db skip1           %256 ; 16
 459++9EA5 4D           	db skip1           %256 ; 17
 460++9EA6 4D           	db skip1           %256 ; 18
 461++9EA7 4D           	db skip1           %256 ; 19
 462++9EA8 4D           	db skip1           %256 ; 1A
 463++9EA9 4D           	db skip1           %256 ; 1B
 464++9EAA 4D           	db skip1           %256 ; 1C
 465++9EAB 4D           	db skip1           %256 ; 1D
 466++9EAC 4D           	db skip1           %256 ; 1E
 467++9EAD 4D           	db skip1           %256 ; 1F
 468++9EAE 4D           	db skip1           %256 ; 20
 469++9EAF 4D           	db skip1           %256 ; 21
 470++9EB0 4D           	db skip1           %256 ; 22
 471++9EB1 4D           	db skip1           %256 ; 23
 472++9EB2 4D           	db skip1           %256 ; 24
 473++9EB3 4D           	db skip1           %256 ; 25
 474++9EB4 4D           	db skip1           %256 ; 26
 475++9EB5 4D           	db skip1           %256 ; 27
 476++9EB6 4D           	db skip1           %256 ; 28
 477++9EB7 4D           	db skip1           %256 ; 29
 478++9EB8 4D           	db skip1           %256 ; 2A
 479++9EB9 4D           	db skip1           %256 ; 2B
 480++9EBA 4D           	db skip1           %256 ; 2C
 481++9EBB 4D           	db skip1           %256 ; 2D
 482++9EBC 4D           	db skip1           %256 ; 2E
 483++9EBD 4D           	db skip1           %256 ; 2F
 484++9EBE 74           	db cmdunsupported  %256 ; 30
 485++9EBF 4E           	db skip2           %256 ; 31
 486++9EC0 4E           	db skip2           %256 ; 32
 487++9EC1 4E           	db skip2           %256 ; 33
 488++9EC2 4E           	db skip2           %256 ; 34
 489++9EC3 4E           	db skip2           %256 ; 35
 490++9EC4 4E           	db skip2           %256 ; 36
 491++9EC5 4E           	db skip2           %256 ; 37
 492++9EC6 4E           	db skip2           %256 ; 38
 493++9EC7 4E           	db skip2           %256 ; 39
 494++9EC8 4E           	db skip2           %256 ; 3A
 495++9EC9 4E           	db skip2           %256 ; 3B
 496++9ECA 4E           	db skip2           %256 ; 3C
 497++9ECB 4E           	db skip2           %256 ; 3D
 498++9ECC 4E           	db skip2           %256 ; 3E
 499++9ECD 4E           	db skip2           %256 ; 3F
 500++9ECE 53           	db skip3           %256 ; 40
 501++9ECF 53           	db skip3           %256 ; 41
 502++9ED0 53           	db skip3           %256 ; 42
 503++9ED1 53           	db skip3           %256 ; 43
 504++9ED2 53           	db skip3           %256 ; 44
 505++9ED3 53           	db skip3           %256 ; 45
 506++9ED4 53           	db skip3           %256 ; 46
 507++9ED5 53           	db skip3           %256 ; 47
 508++9ED6 53           	db skip3           %256 ; 48
 509++9ED7 53           	db skip3           %256 ; 49
 510++9ED8 53           	db skip3           %256 ; 4A
 511++9ED9 53           	db skip3           %256 ; 4B
 512++9EDA 53           	db skip3           %256 ; 4C
 513++9EDB 53           	db skip3           %256 ; 4D
 514++9EDC 53           	db skip3           %256 ; 4E
 515++9EDD 4E           	db skip2           %256 ; 4F
 516++9EDE 74           	db cmdunsupported  %256 ; 50
 517++9EDF 74           	db cmdunsupported  %256 ; 51
 518++9EE0 74           	db cmdunsupported  %256 ; 52
 519++9EE1 74           	db cmdunsupported  %256 ; 53
 520++9EE2 F8           	db cmdYM2151       %256 ; 54
 521++9EE3 77           	db cmdYM2203       %256 ; 55
 522++9EE4 77           	db cmdYM2608p0     %256 ; 56
 523++9EE5 8E           	db cmdYM2608p1     %256 ; 57
 524++9EE6 74           	db cmdunsupported  %256 ; 58
 525++9EE7 74           	db cmdunsupported  %256 ; 59
 526++9EE8 CA           	db cmdYM3812       %256 ; 5A
 527++9EE9 CA           	db cmdYM3526       %256 ; 5B
 528++9EEA CA           	db cmdY8950        %256 ; 5C
 529++9EEB 53           	db skip3           %256 ; 5D
 530++9EEC CA           	db cmdYMF262p0     %256 ; 5E
 531++9EED E1           	db cmdYMF262p1     %256 ; 5F
 532++9EEE 74           	db cmdunsupported  %256 ; 60
 533++9EEF 2C           	db waitvar         %256 ; 61
 534++9EF0 16           	db wait735         %256 ; 62
 535++9EF1 26           	db wait882         %256 ; 63
 536++9EF2 74           	db cmdunsupported  %256 ; 64
 537++9EF3 74           	db cmdunsupported  %256 ; 65
 538++9EF4 71           	db endofsounddata  %256 ; 66
 539++9EF5 44           	db cmddatablock    %256 ; 67
 540++9EF6 6C           	db skip12          %256 ; 68
 541++9EF7 74           	db cmdunsupported  %256 ; 69
 542++9EF8 74           	db cmdunsupported  %256 ; 6A
 543++9EF9 74           	db cmdunsupported  %256 ; 6B
 544++9EFA 74           	db cmdunsupported  %256 ; 6C
 545++9EFB 74           	db cmdunsupported  %256 ; 6D
 546++9EFC 74           	db cmdunsupported  %256 ; 6E
 547++9EFD 74           	db cmdunsupported  %256 ; 6F
 548++9EFE B3           	db wait1           %256 ; 70
 549++9EFF C0           	db wait2           %256 ; 71
 550++9F00 D0           	db wait3           %256 ; 72
 551++9F01 D5           	db wait4           %256 ; 73
 552++9F02 DA           	db wait5           %256 ; 74
 553++9F03 DF           	db wait6           %256 ; 75
 554++9F04 E4           	db wait7           %256 ; 76
 555++9F05 E9           	db wait8           %256 ; 77
 556++9F06 EE           	db wait9           %256 ; 78
 557++9F07 F3           	db wait10          %256 ; 79
 558++9F08 F8           	db wait11          %256 ; 7A
 559++9F09 FD           	db wait12          %256 ; 7B
 560++9F0A 02           	db wait13          %256 ; 7C
 561++9F0B 07           	db wait14          %256 ; 7D
 562++9F0C 0C           	db wait15          %256 ; 7E
 563++9F0D 11           	db wait16          %256 ; 7F
 564++9F0E 4D           	db skip1           %256 ; 80
 565++9F0F B3           	db wait1           %256 ; 81
 566++9F10 C0           	db wait2           %256 ; 82
 567++9F11 D0           	db wait3           %256 ; 83
 568++9F12 D5           	db wait4           %256 ; 84
 569++9F13 DA           	db wait5           %256 ; 85
 570++9F14 DF           	db wait6           %256 ; 86
 571++9F15 E4           	db wait7           %256 ; 87
 572++9F16 E9           	db wait8           %256 ; 88
 573++9F17 EE           	db wait9           %256 ; 89
 574++9F18 F3           	db wait10          %256 ; 8A
 575++9F19 F8           	db wait11          %256 ; 8B
 576++9F1A FD           	db wait12          %256 ; 8C
 577++9F1B 02           	db wait13          %256 ; 8D
 578++9F1C 07           	db wait14          %256 ; 8E
 579++9F1D 0C           	db wait15          %256 ; 8F
 580++9F1E 5D           	db skip5           %256 ; 90
 581++9F1F 5D           	db skip5           %256 ; 91
 582++9F20 62           	db skip6           %256 ; 92
 583++9F21 67           	db skip11          %256 ; 93
 584++9F22 4E           	db skip2           %256 ; 94
 585++9F23 5D           	db skip5           %256 ; 95
 586++9F24 74           	db cmdunsupported  %256 ; 96
 587++9F25 74           	db cmdunsupported  %256 ; 97
 588++9F26 74           	db cmdunsupported  %256 ; 98
 589++9F27 74           	db cmdunsupported  %256 ; 99
 590++9F28 74           	db cmdunsupported  %256 ; 9A
 591++9F29 74           	db cmdunsupported  %256 ; 9B
 592++9F2A 74           	db cmdunsupported  %256 ; 9C
 593++9F2B 74           	db cmdunsupported  %256 ; 9D
 594++9F2C 74           	db cmdunsupported  %256 ; 9E
 595++9F2D 74           	db cmdunsupported  %256 ; 9F
 596++9F2E 26           	db cmdAY8910       %256 ; A0
 597++9F2F 53           	db skip3           %256 ; A1
 598++9F30 74           	db cmdunsupported  %256 ; A2
 599++9F31 74           	db cmdunsupported  %256 ; A3
 600++9F32 0F           	db cmdYM2151dp     %256 ; A4
 601++9F33 8E           	db cmdYM2203dp     %256 ; A5
 602++9F34 53           	db skip3           %256 ; A6
 603++9F35 53           	db skip3           %256 ; A7
 604++9F36 53           	db skip3           %256 ; A8
 605++9F37 53           	db skip3           %256 ; A9
 606++9F38 E1           	db cmdYM3812dp     %256 ; AA
 607++9F39 E1           	db cmdYM3526dp     %256 ; AB
 608++9F3A E1           	db cmdY8950dp      %256 ; AC
 609++9F3B 53           	db skip3           %256 ; AD
 610++9F3C 40           	db cmdYMF262dp0    %256 ; AE
 611++9F3D 40           	db cmdYMF262dp0    %256 ; AF
 612++9F3E 53           	db skip3           %256 ; B0
 613++9F3F 53           	db skip3           %256 ; B1
 614++9F40 53           	db skip3           %256 ; B2
 615++9F41 53           	db skip3           %256 ; B3
 616++9F42 53           	db skip3           %256 ; B4
 617++9F43 53           	db skip3           %256 ; B5
 618++9F44 53           	db skip3           %256 ; B6
 619++9F45 53           	db skip3           %256 ; B7
 620++9F46 53           	db skip3           %256 ; B8
 621++9F47 53           	db skip3           %256 ; B9
 622++9F48 53           	db skip3           %256 ; BA
 623++9F49 53           	db skip3           %256 ; BB
 624++9F4A 53           	db skip3           %256 ; BC
 625++9F4B 53           	db skip3           %256 ; BD
 626++9F4C 53           	db skip3           %256 ; BE
 627++9F4D 53           	db skip3           %256 ; BF
 628++9F4E 58           	db skip4           %256 ; C0
 629++9F4F 58           	db skip4           %256 ; C1
 630++9F50 58           	db skip4           %256 ; C2
 631++9F51 58           	db skip4           %256 ; C3
 632++9F52 58           	db skip4           %256 ; C4
 633++9F53 58           	db skip4           %256 ; C5
 634++9F54 58           	db skip4           %256 ; C6
 635++9F55 58           	db skip4           %256 ; C7
 636++9F56 58           	db skip4           %256 ; C8
 637++9F57 58           	db skip4           %256 ; C9
 638++9F58 58           	db skip4           %256 ; CA
 639++9F59 58           	db skip4           %256 ; CB
 640++9F5A 58           	db skip4           %256 ; CC
 641++9F5B 58           	db skip4           %256 ; CD
 642++9F5C 58           	db skip4           %256 ; CE
 643++9F5D 58           	db skip4           %256 ; CF
 644++9F5E A5           	db cmdYMF278B      %256 ; D0
 645++9F5F 58           	db skip4           %256 ; D1
 646++9F60 74           	db cmdunsupported  %256 ; D2
 647++9F61 58           	db skip4           %256 ; D3
 648++9F62 58           	db skip4           %256 ; D4
 649++9F63 58           	db skip4           %256 ; D5
 650++9F64 58           	db skip4           %256 ; D6
 651++9F65 58           	db skip4           %256 ; D7
 652++9F66 58           	db skip4           %256 ; D8
 653++9F67 58           	db skip4           %256 ; D9
 654++9F68 58           	db skip4           %256 ; DA
 655++9F69 58           	db skip4           %256 ; DB
 656++9F6A 58           	db skip4           %256 ; DC
 657++9F6B 58           	db skip4           %256 ; DD
 658++9F6C 58           	db skip4           %256 ; DE
 659++9F6D 58           	db skip4           %256 ; DF
 660++9F6E 74           	db cmdunsupported  %256 ; E0
 661++9F6F 5D           	db skip5           %256 ; E1
 662++9F70 5D           	db skip5           %256 ; E2
 663++9F71 5D           	db skip5           %256 ; E3
 664++9F72 5D           	db skip5           %256 ; E4
 665++9F73 5D           	db skip5           %256 ; E5
 666++9F74 5D           	db skip5           %256 ; E6
 667++9F75 5D           	db skip5           %256 ; E7
 668++9F76 5D           	db skip5           %256 ; E8
 669++9F77 5D           	db skip5           %256 ; E9
 670++9F78 5D           	db skip5           %256 ; EA
 671++9F79 5D           	db skip5           %256 ; EB
 672++9F7A 5D           	db skip5           %256 ; EC
 673++9F7B 5D           	db skip5           %256 ; ED
 674++9F7C 5D           	db skip5           %256 ; EE
 675++9F7D 5D           	db skip5           %256 ; EF
 676++9F7E 5D           	db skip5           %256 ; F0
 677++9F7F 5D           	db skip5           %256 ; F1
 678++9F80 5D           	db skip5           %256 ; F2
 679++9F81 5D           	db skip5           %256 ; F3
 680++9F82 5D           	db skip5           %256 ; F4
 681++9F83 5D           	db skip5           %256 ; F5
 682++9F84 5D           	db skip5           %256 ; F6
 683++9F85 5D           	db skip5           %256 ; F7
 684++9F86 5D           	db skip5           %256 ; F8
 685++9F87 5D           	db skip5           %256 ; F9
 686++9F88 5D           	db skip5           %256 ; FA
 687++9F89 5D           	db skip5           %256 ; FB
 688++9F8A 5D           	db skip5           %256 ; FC
 689++9F8B 5D           	db skip5           %256 ; FD
 690++9F8C 5D           	db skip5           %256 ; FE
 691++9F8D 5D           	db skip5           %256 ; FF
 692++9F8E 9D           	db skip1           /256 ; 00
 693++9F8F 9D           	db skip1           /256 ; 01
 694++9F90 9D           	db skip1           /256 ; 02
 695++9F91 9D           	db skip1           /256 ; 03
 696++9F92 9D           	db skip1           /256 ; 04
 697++9F93 9D           	db skip1           /256 ; 05
 698++9F94 9D           	db skip1           /256 ; 06
 699++9F95 9D           	db skip1           /256 ; 07
 700++9F96 9D           	db skip1           /256 ; 08
 701++9F97 9D           	db skip1           /256 ; 09
 702++9F98 9D           	db skip1           /256 ; 0A
 703++9F99 9D           	db skip1           /256 ; 0B
 704++9F9A 9D           	db skip1           /256 ; 0C
 705++9F9B 9D           	db skip1           /256 ; 0D
 706++9F9C 9D           	db skip1           /256 ; 0E
 707++9F9D 9D           	db skip1           /256 ; 0F
 708++9F9E 9D           	db skip1           /256 ; 10
 709++9F9F 9D           	db skip1           /256 ; 11
 710++9FA0 9D           	db skip1           /256 ; 12
 711++9FA1 9D           	db skip1           /256 ; 13
 712++9FA2 9D           	db skip1           /256 ; 14
 713++9FA3 9D           	db skip1           /256 ; 15
 714++9FA4 9D           	db skip1           /256 ; 16
 715++9FA5 9D           	db skip1           /256 ; 17
 716++9FA6 9D           	db skip1           /256 ; 18
 717++9FA7 9D           	db skip1           /256 ; 19
 718++9FA8 9D           	db skip1           /256 ; 1A
 719++9FA9 9D           	db skip1           /256 ; 1B
 720++9FAA 9D           	db skip1           /256 ; 1C
 721++9FAB 9D           	db skip1           /256 ; 1D
 722++9FAC 9D           	db skip1           /256 ; 1E
 723++9FAD 9D           	db skip1           /256 ; 1F
 724++9FAE 9D           	db skip1           /256 ; 20
 725++9FAF 9D           	db skip1           /256 ; 21
 726++9FB0 9D           	db skip1           /256 ; 22
 727++9FB1 9D           	db skip1           /256 ; 23
 728++9FB2 9D           	db skip1           /256 ; 24
 729++9FB3 9D           	db skip1           /256 ; 25
 730++9FB4 9D           	db skip1           /256 ; 26
 731++9FB5 9D           	db skip1           /256 ; 27
 732++9FB6 9D           	db skip1           /256 ; 28
 733++9FB7 9D           	db skip1           /256 ; 29
 734++9FB8 9D           	db skip1           /256 ; 2A
 735++9FB9 9D           	db skip1           /256 ; 2B
 736++9FBA 9D           	db skip1           /256 ; 2C
 737++9FBB 9D           	db skip1           /256 ; 2D
 738++9FBC 9D           	db skip1           /256 ; 2E
 739++9FBD 9D           	db skip1           /256 ; 2F
 740++9FBE 9D           	db cmdunsupported  /256 ; 30
 741++9FBF 9D           	db skip2           /256 ; 31
 742++9FC0 9D           	db skip2           /256 ; 32
 743++9FC1 9D           	db skip2           /256 ; 33
 744++9FC2 9D           	db skip2           /256 ; 34
 745++9FC3 9D           	db skip2           /256 ; 35
 746++9FC4 9D           	db skip2           /256 ; 36
 747++9FC5 9D           	db skip2           /256 ; 37
 748++9FC6 9D           	db skip2           /256 ; 38
 749++9FC7 9D           	db skip2           /256 ; 39
 750++9FC8 9D           	db skip2           /256 ; 3A
 751++9FC9 9D           	db skip2           /256 ; 3B
 752++9FCA 9D           	db skip2           /256 ; 3C
 753++9FCB 9D           	db skip2           /256 ; 3D
 754++9FCC 9D           	db skip2           /256 ; 3E
 755++9FCD 9D           	db skip2           /256 ; 3F
 756++9FCE 9D           	db skip3           /256 ; 40
 757++9FCF 9D           	db skip3           /256 ; 41
 758++9FD0 9D           	db skip3           /256 ; 42
 759++9FD1 9D           	db skip3           /256 ; 43
 760++9FD2 9D           	db skip3           /256 ; 44
 761++9FD3 9D           	db skip3           /256 ; 45
 762++9FD4 9D           	db skip3           /256 ; 46
 763++9FD5 9D           	db skip3           /256 ; 47
 764++9FD6 9D           	db skip3           /256 ; 48
 765++9FD7 9D           	db skip3           /256 ; 49
 766++9FD8 9D           	db skip3           /256 ; 4A
 767++9FD9 9D           	db skip3           /256 ; 4B
 768++9FDA 9D           	db skip3           /256 ; 4C
 769++9FDB 9D           	db skip3           /256 ; 4D
 770++9FDC 9D           	db skip3           /256 ; 4E
 771++9FDD 9D           	db skip2           /256 ; 4F
 772++9FDE 9D           	db cmdunsupported  /256 ; 50
 773++9FDF 9D           	db cmdunsupported  /256 ; 51
 774++9FE0 9D           	db cmdunsupported  /256 ; 52
 775++9FE1 9D           	db cmdunsupported  /256 ; 53
 776++9FE2 9D           	db cmdYM2151       /256 ; 54
 777++9FE3 9D           	db cmdYM2203       /256 ; 55
 778++9FE4 9D           	db cmdYM2608p0     /256 ; 56
 779++9FE5 A0           	db cmdYM2608p1     /256 ; 57
 780++9FE6 9D           	db cmdunsupported  /256 ; 58
 781++9FE7 9D           	db cmdunsupported  /256 ; 59
 782++9FE8 9D           	db cmdYM3812       /256 ; 5A
 783++9FE9 9D           	db cmdYM3526       /256 ; 5B
 784++9FEA 9D           	db cmdY8950        /256 ; 5C
 785++9FEB 9D           	db skip3           /256 ; 5D
 786++9FEC 9D           	db cmdYMF262p0     /256 ; 5E
 787++9FED 9D           	db cmdYMF262p1     /256 ; 5F
 788++9FEE 9D           	db cmdunsupported  /256 ; 60
 789++9FEF 9D           	db waitvar         /256 ; 61
 790++9FF0 9D           	db wait735         /256 ; 62
 791++9FF1 9D           	db wait882         /256 ; 63
 792++9FF2 9D           	db cmdunsupported  /256 ; 64
 793++9FF3 9D           	db cmdunsupported  /256 ; 65
 794++9FF4 9D           	db endofsounddata  /256 ; 66
 795++9FF5 9E           	db cmddatablock    /256 ; 67
 796++9FF6 9D           	db skip12          /256 ; 68
 797++9FF7 9D           	db cmdunsupported  /256 ; 69
 798++9FF8 9D           	db cmdunsupported  /256 ; 6A
 799++9FF9 9D           	db cmdunsupported  /256 ; 6B
 800++9FFA 9D           	db cmdunsupported  /256 ; 6C
 801++9FFB 9D           	db cmdunsupported  /256 ; 6D
 802++9FFC 9D           	db cmdunsupported  /256 ; 6E
 803++9FFD 9D           	db cmdunsupported  /256 ; 6F
 804++9FFE 9C           	db wait1           /256 ; 70
 805++9FFF 9C           	db wait2           /256 ; 71
 806++A000 9C           	db wait3           /256 ; 72
 807++A001 9C           	db wait4           /256 ; 73
 808++A002 9C           	db wait5           /256 ; 74
 809++A003 9C           	db wait6           /256 ; 75
 810++A004 9C           	db wait7           /256 ; 76
 811++A005 9C           	db wait8           /256 ; 77
 812++A006 9C           	db wait9           /256 ; 78
 813++A007 9C           	db wait10          /256 ; 79
 814++A008 9C           	db wait11          /256 ; 7A
 815++A009 9C           	db wait12          /256 ; 7B
 816++A00A 9D           	db wait13          /256 ; 7C
 817++A00B 9D           	db wait14          /256 ; 7D
 818++A00C 9D           	db wait15          /256 ; 7E
 819++A00D 9D           	db wait16          /256 ; 7F
 820++A00E 9D           	db skip1           /256 ; 80
 821++A00F 9C           	db wait1           /256 ; 81
 822++A010 9C           	db wait2           /256 ; 82
 823++A011 9C           	db wait3           /256 ; 83
 824++A012 9C           	db wait4           /256 ; 84
 825++A013 9C           	db wait5           /256 ; 85
 826++A014 9C           	db wait6           /256 ; 86
 827++A015 9C           	db wait7           /256 ; 87
 828++A016 9C           	db wait8           /256 ; 88
 829++A017 9C           	db wait9           /256 ; 89
 830++A018 9C           	db wait10          /256 ; 8A
 831++A019 9C           	db wait11          /256 ; 8B
 832++A01A 9C           	db wait12          /256 ; 8C
 833++A01B 9D           	db wait13          /256 ; 8D
 834++A01C 9D           	db wait14          /256 ; 8E
 835++A01D 9D           	db wait15          /256 ; 8F
 836++A01E 9D           	db skip5           /256 ; 90
 837++A01F 9D           	db skip5           /256 ; 91
 838++A020 9D           	db skip6           /256 ; 92
 839++A021 9D           	db skip11          /256 ; 93
 840++A022 9D           	db skip2           /256 ; 94
 841++A023 9D           	db skip5           /256 ; 95
 842++A024 9D           	db cmdunsupported  /256 ; 96
 843++A025 9D           	db cmdunsupported  /256 ; 97
 844++A026 9D           	db cmdunsupported  /256 ; 98
 845++A027 9D           	db cmdunsupported  /256 ; 99
 846++A028 9D           	db cmdunsupported  /256 ; 9A
 847++A029 9D           	db cmdunsupported  /256 ; 9B
 848++A02A 9D           	db cmdunsupported  /256 ; 9C
 849++A02B 9D           	db cmdunsupported  /256 ; 9D
 850++A02C 9D           	db cmdunsupported  /256 ; 9E
 851++A02D 9D           	db cmdunsupported  /256 ; 9F
 852++A02E 9E           	db cmdAY8910       /256 ; A0
 853++A02F 9D           	db skip3           /256 ; A1
 854++A030 9D           	db cmdunsupported  /256 ; A2
 855++A031 9D           	db cmdunsupported  /256 ; A3
 856++A032 9E           	db cmdYM2151dp     /256 ; A4
 857++A033 9D           	db cmdYM2203dp     /256 ; A5
 858++A034 9D           	db skip3           /256 ; A6
 859++A035 9D           	db skip3           /256 ; A7
 860++A036 9D           	db skip3           /256 ; A8
 861++A037 9D           	db skip3           /256 ; A9
 862++A038 9D           	db cmdYM3812dp     /256 ; AA
 863++A039 9D           	db cmdYM3526dp     /256 ; AB
 864++A03A 9D           	db cmdY8950dp      /256 ; AC
 865++A03B 9D           	db skip3           /256 ; AD
 866++A03C 96           	db cmdYMF262dp0    /256 ; AE
 867++A03D 96           	db cmdYMF262dp0    /256 ; AF
 868++A03E 9D           	db skip3           /256 ; B0
 869++A03F 9D           	db skip3           /256 ; B1
 870++A040 9D           	db skip3           /256 ; B2
 871++A041 9D           	db skip3           /256 ; B3
 872++A042 9D           	db skip3           /256 ; B4
 873++A043 9D           	db skip3           /256 ; B5
 874++A044 9D           	db skip3           /256 ; B6
 875++A045 9D           	db skip3           /256 ; B7
 876++A046 9D           	db skip3           /256 ; B8
 877++A047 9D           	db skip3           /256 ; B9
 878++A048 9D           	db skip3           /256 ; BA
 879++A049 9D           	db skip3           /256 ; BB
 880++A04A 9D           	db skip3           /256 ; BC
 881++A04B 9D           	db skip3           /256 ; BD
 882++A04C 9D           	db skip3           /256 ; BE
 883++A04D 9D           	db skip3           /256 ; BF
 884++A04E 9D           	db skip4           /256 ; C0
 885++A04F 9D           	db skip4           /256 ; C1
 886++A050 9D           	db skip4           /256 ; C2
 887++A051 9D           	db skip4           /256 ; C3
 888++A052 9D           	db skip4           /256 ; C4
 889++A053 9D           	db skip4           /256 ; C5
 890++A054 9D           	db skip4           /256 ; C6
 891++A055 9D           	db skip4           /256 ; C7
 892++A056 9D           	db skip4           /256 ; C8
 893++A057 9D           	db skip4           /256 ; C9
 894++A058 9D           	db skip4           /256 ; CA
 895++A059 9D           	db skip4           /256 ; CB
 896++A05A 9D           	db skip4           /256 ; CC
 897++A05B 9D           	db skip4           /256 ; CD
 898++A05C 9D           	db skip4           /256 ; CE
 899++A05D 9D           	db skip4           /256 ; CF
 900++A05E 9D           	db cmdYMF278B      /256 ; D0
 901++A05F 9D           	db skip4           /256 ; D1
 902++A060 9D           	db cmdunsupported  /256 ; D2
 903++A061 9D           	db skip4           /256 ; D3
 904++A062 9D           	db skip4           /256 ; D4
 905++A063 9D           	db skip4           /256 ; D5
 906++A064 9D           	db skip4           /256 ; D6
 907++A065 9D           	db skip4           /256 ; D7
 908++A066 9D           	db skip4           /256 ; D8
 909++A067 9D           	db skip4           /256 ; D9
 910++A068 9D           	db skip4           /256 ; DA
 911++A069 9D           	db skip4           /256 ; DB
 912++A06A 9D           	db skip4           /256 ; DC
 913++A06B 9D           	db skip4           /256 ; DD
 914++A06C 9D           	db skip4           /256 ; DE
 915++A06D 9D           	db skip4           /256 ; DF
 916++A06E 9D           	db cmdunsupported  /256 ; E0
 917++A06F 9D           	db skip5           /256 ; E1
 918++A070 9D           	db skip5           /256 ; E2
 919++A071 9D           	db skip5           /256 ; E3
 920++A072 9D           	db skip5           /256 ; E4
 921++A073 9D           	db skip5           /256 ; E5
 922++A074 9D           	db skip5           /256 ; E6
 923++A075 9D           	db skip5           /256 ; E7
 924++A076 9D           	db skip5           /256 ; E8
 925++A077 9D           	db skip5           /256 ; E9
 926++A078 9D           	db skip5           /256 ; EA
 927++A079 9D           	db skip5           /256 ; EB
 928++A07A 9D           	db skip5           /256 ; EC
 929++A07B 9D           	db skip5           /256 ; ED
 930++A07C 9D           	db skip5           /256 ; EE
 931++A07D 9D           	db skip5           /256 ; EF
 932++A07E 9D           	db skip5           /256 ; F0
 933++A07F 9D           	db skip5           /256 ; F1
 934++A080 9D           	db skip5           /256 ; F2
 935++A081 9D           	db skip5           /256 ; F3
 936++A082 9D           	db skip5           /256 ; F4
 937++A083 9D           	db skip5           /256 ; F5
 938++A084 9D           	db skip5           /256 ; F6
 939++A085 9D           	db skip5           /256 ; F7
 940++A086 9D           	db skip5           /256 ; F8
 941++A087 9D           	db skip5           /256 ; F9
 942++A088 9D           	db skip5           /256 ; FA
 943++A089 9D           	db skip5           /256 ; FB
 944++A08A 9D           	db skip5           /256 ; FC
 945++A08B 9D           	db skip5           /256 ; FD
 946++A08C 9D           	db skip5           /256 ; FE
 947++A08D 9D           	db skip5           /256 ; FF
 948++A08E
 949++A08E
 950++A08E
 951++A08E              cmdYM2608p0 equ cmdYM2203
 952++A08E
 953++A08E              cmdYM2608p1
 954++A08E              	memory_stream_read_2 e,d
 954++A08E 2A 72 96    >	ld hl,(memorystreamcurrentaddr)
 954++A091             >	memory_stream_read_byte e
 954++A091 CB 74       >	bit 6,h
 954++A093             >        IF AREA_C000_FFFF=1
 954++A093 CC 0D 96    >	call z,memorystreamnextpage
 954++A096             >        ELSE
 954++A096 ~           > 	call nz,memorystreamnextpage
 954++A096             >        ENDIF
 954++A096 5E          >	ld e,(hl)
 954++A097 23          >	inc hl
 954++A098             >	memory_stream_read_byte d
 954++A098 CB 74       >	bit 6,h
 954++A09A             >        IF AREA_C000_FFFF=1
 954++A09A CC 0D 96    >	call z,memorystreamnextpage
 954++A09D             >        ELSE
 954++A09D ~           > 	call nz,memorystreamnextpage
 954++A09D             >        ENDIF
 954++A09D 56          >	ld d,(hl)
 954++A09E 23          >	inc hl
 954++A09F 22 72 96    >	ld (memorystreamcurrentaddr),hl
 955++A0A2 7B           	ld a,e
 956++A0A3 FE 30        	cp 0x30
 957++A0A5 D8           	ret c
 958++A0A6 C3 A0 9A     	jp opnwritefm2
 959++A0A9
 960++A0A9
 961++A0A9              initAY8910
 962++A0A9 CD AD 9B     	call ssginit
 963++A0AC 21 66 9C     	ld hl,devicemask
 964++A0AF 3A 77 BE     	ld a,(HEADER_CLOCK_AY8910+3)
 965++A0B2 E6 40        	and 0x40
 966++A0B4 20 03        	jr nz,.dualchip
 967++A0B6 CB C6        	set DEVICE_AY_BIT,(hl)
 968++A0B8 C9           	ret
 969++A0B9              .dualchip
 970++A0B9 CB CE        	set DEVICE_TURBOSOUND_BIT,(hl)
 971++A0BB C9           	ret
 972++A0BC
 973++A0BC              initYM2203
 974++A0BC              tfmstatus=$+1
 975++A0BC 3E 01        	ld a,1
 976++A0BE 3D           	dec a
 977++A0BF F8           	ret m
 978++A0C0 CD AB 9A     	call opninit
 979++A0C3              	set_timer opnwaittimer60hz,735
 979++A0C3 21 DF 02    >	ld hl,735
 979++A0C6 22 86 9C    >	ld (waittimerstep),hl
 980++A0C9 CD 41 9B     	call opninittimer60hz
 981++A0CC 21 66 9C     	ld hl,devicemask
 982++A0CF CB D6        	set DEVICE_TFM_BIT,(hl)
 983++A0D1 AF           	xor a
 984++A0D2 C9           	ret
 985++A0D3
 986++A0D3              initYMF278B
 987++A0D3              moonsoundstatus=$+1
 988++A0D3 3E 02        	ld a,2
 989++A0D5 3D           	dec a
 990++A0D6 F8           	ret m
 991++A0D7 CD 6D 99     	call vgmopl4init
 992++A0DA 3A 53 BE     	ld a,(HEADER_CLOCK_YM3812+3)
 993++A0DD E6 40        	and 0x40
 994++A0DF 20 08        	jr nz,notOPL2
 995++A0E1              useYM3812=$+1
 996++A0E1 F6 00        	or 0
 997++A0E3 11 05 00     	ld de,0x0005
 998++A0E6 C4 33 97     	call nz,opl4writefm2
 999++A0E9              notOPL2
1000++A0E9 CD 64 9A     	call opl4inittimer60hz
1001++A0EC 21 66 9C     	ld hl,devicemask
1002++A0EF CB DE        	set DEVICE_MOONSOUND_BIT,(hl)
1003++A0F1 AF           	xor a
1004++A0F2 C9           	ret
1005++A0F3
1006++A0F3              end
1007++A0F3
1008++A0F3
1009++A0F3
1010++A0F3              ;        LABELSLIST "vgm_plr.l"
1011++A0F3              ;	savebin "gplay.apg",begin,end-begin
# file closed: GPlay/vgm.asm
 761+ A0F3              	include sub_func.asm
# file opened: GPlay/sub_func.asm
   1++A0F3
   2++A0F3              fileopenerror
   3++A0F3 79           		ld a,c
   4++A0F4 0E FF        		ld c,$FF
   5++A0F6 02                   ld (bc),a ;   
   6++A0F7
   7++A0F7 21 3A A5     		ld hl,msg_file_error
   8++A0FA              		OS_PRINTZ
   8++A0FA 0E 09       >    ld c,#09
   8++A0FC E7          >    rst #20
   9++A0FD
  10++A0FD 3A 5F A4     		ld a,(file_id_cur_r)
  11++A100 FE FF        		cp 255
  12++A102 28 03        		jr z,fileopenerror1
  13++A104              		OS_FILE_CLOSE ;A - id file
  13++A104 0E 25       >    ld c,#25
  13++A106 E7          >    rst #20
  14++A107              fileopenerror1
  15++A107 37           		scf ;
  16++A108 C9           		ret
  17++A109
  18++A109
  19++A109              ; memoryerror
  20++A109                      ; OS_CLOSEHANDLE
  21++A109                      ; ld e,6+0x80
  22++A109                      ; OS_SETGFX
  23++A109                      ; ld e,0
  24++A109                      ; OS_CLS
  25++A109                      ; ld hl,txt_memoryerror
  26++A109                      ; call print_hl
  27++A109                      ; YIELDGETKEYLOOP
  28++A109                      ; jp cmd_quit
  29++A109
  30++A109              memoryerror
  31++A109 79           		ld a,c
  32++A10A 0E FF        		ld c,$FF
  33++A10C 02                   ld (bc),a ;   
  34++A10D
  35++A10D 21 F8 93     		ld hl,txt_memoryerror
  36++A110              		OS_PRINTZ
  36++A110 0E 09       >    ld c,#09
  36++A112 E7          >    rst #20
  37++A113
  38++A113 3A 5F A4     		ld a,(file_id_cur_r)
  39++A116 FE FF        		cp 255
  40++A118 28 03        		jr z,memoryerror1
  41++A11A              		OS_FILE_CLOSE ;A - id file
  41++A11A 0E 25       >    ld c,#25
  41++A11C E7          >    rst #20
  42++A11D              memoryerror1
  43++A11D 37           		scf ;
  44++A11E C9           		ret
  45++A11F
  46++A11F
  47++A11F
  48++A11F              ;----------------------------------------
  49++A11F              load_mus
  50++A11F
  51++A11F                      ; ld b,0
  52++A11F              ; old_mus EQU $-1
  53++A11F                      ; cp b
  54++A11F                      ; ret z
  55++A11F                      ; ld (old_mus),a
  56++A11F
  57++A11F                      ; and a
  58++A11F                      ; jp z,no_mus
  59++A11F
  60++A11F
  61++A11F                      ; call calc_mus
  62++A11F
  63++A11F                      ; call no_mus
  64++A11F                      ; ld hl,t_s98_file00_pages_list+$FF
  65++A11F                      ; call free_s98_file ; 
  66++A11F
  67++A11F                      ;generate path to music file in 'buf'
  68++A11F                      ; ld hl,mus_path1
  69++A11F                      ; ld de,buf
  70++A11F                      ; call copystr_hlde ;'copy path  'mus/' '
  71++A11F
  72++A11F                      ; ld a,(mus_mode)
  73++A11F                      ; ld hl,mus_modes
  74++A11F                      ; call sel_word
  75++A11F                      ; call copystr_hlde ;copy "aym / s98 path"
  76++A11F                      ; ld hl,mus_path2
  77++A11F                      ; call copystr_hlde ;copy name without ext
  78++A11F
  79++A11F                      ; ld a,(mus_mode)
  80++A11F                      ; ld hl,plr_ext
  81++A11F                      ; call sel_word
  82++A11F                      ; call copystr_hlde  ;copy file ext
  83++A11F                      ; xor a
  84++A11F                      ; ld (de),a  ;string terminator
  85++A11F
  86++A11F                      ; ld de,buf ; 
  87++A11F                      ; call openstream_file
  88++A11F
  89++A11F 21 4A A2     		ld hl,file_name_cur
  90++A122              		OS_FILE_OPEN ;HL - File name (out: A - id file, de hl - size, IX - fcb)
  90++A122 0E 21       >    ld c,#21
  90++A124 E7          >    rst #20
  91++A125
  92++A125                      ;or a
  93++A125                      ;jp nz,fileopenerror
  94++A125 DA F3 A0     		jp c,fileopenerror
  95++A128 32 5F A4     		ld (file_id_cur_r),a
  96++A12B
  97++A12B 21 00 95             ld hl,memorystreampages ;t_s98_file00_pages_list
  98++A12E 22 32 A1             ld (load_s98_file_number),hl
  99++A131
 100++A131
 101++A131              /////------        call load_s98_file      ;de=drive/path/file
 102++A131
 103++A131              ;    
 104++A131              ;   
 105++A131
 106++A131                              ;   
 107++A131
 108++A131
 109++A131              load_s98_file_number_haddr = $+2
 109++A131
 110++A131              load_s98_file_number = $+1
 110++A131
 111++A131 01 00 95                     ld bc,memorystreampages ;t_s98_file00_pages_list
 112++A134 C5                           push bc
 113++A135
 114++A135              read_file_loop:
 115++A135                              ;OS_NEWPAGE              ;out: a=0 (OK)/!=0 (fail), e=page
 116++A135              				OS_GET_PAGE ;*
 116++A135 0E 1A       >    ld c,#1a
 116++A137 E7          >    rst #20
 117++A138
 118++A138 C1                           pop bc ;file tab
 119++A139
 120++A139                              ;or a
 121++A139                              ;jp nz,memory_error
 122++A139 DA 7C A1     				jp c,memory_error
 123++A13C                              ;ld a,e
 124++A13C                                                      ;    !!!!
 125++A13C                                                      ;    !!!!
 126++A13C
 127++A13C 02           1               ld (bc),a
 128++A13D 0C                           inc c           ;      4 !!!!!
 129++A13E
 130++A13E C5                           push bc ;file tab
 131++A13F                              ;SETPGC000
 132++A13F              				OS_SET_PAGE_SLOT3
 132++A13F 0E 1C       >    ld c,#1c
 132++A141 E7          >    rst #20
 133++A142
 134++A142                              ;ld de,$C000
 135++A142                              ;ld hl,$4000
 136++A142
 137++A142                              ;call readstream_file    ;DE = Buffer address, HL = Number of bytes to read
 138++A142                                              ;hl=actual size
 139++A142
 140++A142 3A 5F A4     				ld a,(file_id_cur_r)
 141++A145 21 00 C0     				ld hl,$C000
 142++A148 11 00 40                     ld de,$4000
 143++A14B              				OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl -    )
 143++A14B 0E 23       >    ld c,#23
 143++A14D E7          >    rst #20
 144++A14E 30 04        				jr nc,read_file_loop1
 145++A150
 146++A150              				; 
 147++A150 C1                           pop bc ;file tab
 148++A151 C3 F3 A0                     jp fileopenerror
 149++A154
 150++A154
 151++A154              read_file_loop1		;
 152++A154 7C                           ld a,h
 153++A155                              ; cp $40
 154++A155                              ; jr nc,read_file_loop    ;>= $40
 155++A155 FE C0        				cp $c0
 156++A157 38 DC                        jr c,read_file_loop    ;>= $c0,   
 157++A159
 158++A159
 159++A159              read_file_exit
 160++A159
 161++A159 C1                           pop bc ;file tab
 162++A15A                              ;    
 163++A15A 79                           ld a,c
 164++A15B
 165++A15B                             // sub 16   ; !!!!!       0  +16
 166++A15B
 167++A15B 0E FF                        ld c,$FF
 168++A15D 02                           ld (bc),a
 169++A15E
 170++A15E              ;-------------------------------------------------------
 171++A15E              ;    .
 172++A15E              ;       plr_page3    
 173++A15E              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 174++A15E                              ;call closestream_file
 175++A15E 3A 5F A4     				ld a,(file_id_cur_r)
 176++A161              				OS_FILE_CLOSE ;A - id file
 176++A161 0E 25       >    ld c,#25
 176++A163 E7          >    rst #20
 177++A164
 178++A164              read_file_ok
 179++A164                              ;call store8000c000 ;*
 180++A164              ;  8000     
 181++A164 21 00 95                     ld hl,memorystreampages ;t_s98_file00_pages_list
 182++A167 7E                           ld a,(hl)
 183++A168                              ;SETPG8000
 184++A168              				OS_SET_PAGE_SLOT3
 184++A168 0E 1C       >    ld c,#1c
 184++A16A E7          >    rst #20
 185++A16B                              ; ld a,(plr_page3)
 186++A16B                              ; SETPGC000
 187++A16B
 188++A16B              ;    plr_page3.      .
 189++A16B                              ; ld hl,0x8000
 190++A16B                              ; ld de,module
 191++A16B                              ; ld bc,16384
 192++A16B                              ; ldir
 193++A16B
 194++A16B              ;   plrpage      .
 195++A16B                              ; ld a,(plr_page)
 196++A16B                              ; SETPGC000
 197++A16B                              ; ld hl,t_s98_file00_pages_list
 198++A16B                              ; ld de,0xc100         ;0x5000
 199++A16B                              ; ld bc,256
 200++A16B                              ; ldir
 201++A16B
 202++A16B                       ;       DI
 203++A16B
 204++A16B              ;b .
 205++A16B                              ;call restore8000c000
 206++A16B
 207++A16B                              ;call set_music_pages
 208++A16B
 209++A16B 21 00 C0                     ld hl,module
 210++A16E                              ;ld (0x4001),hl *    
 211++A16E 22 2A 94     				ld (START+1),hl
 212++A171 CD 29 94                     call PLR_INIT        ;init music
 213++A174
 214++A174                        ;      EI
 215++A174              ;----------------
 216++A174              ;eloop           halt ;YIELD
 217++A174              ;                call PLR_PLAY
 218++A174              ;                jr eloop
 219++A174              ;----------------
 220++A174
 221++A174
 222++A174              ;!!!!!!!!!!
 223++A174
 224++A174              ; .
 225++A174                              ;ld a,(plr_page)
 226++A174 21 2E 94                     ld hl,PLR_PLAY
 227++A177                              ;OS_SETMUSIC         ;****     
 228++A177              				OS_SET_INTER
 228++A177 0E 14       >    ld c,#14
 228++A179 E7          >    rst #20
 229++A17A AF           				xor a ;OK
 230++A17B C9           				ret
 231++A17C                              ;jp unset_music_pages
 232++A17C
 233++A17C
 234++A17C              memory_error:
 235++A17C C3 09 A1             jp memoryerror
 236++A17F
# file closed: GPlay/sub_func.asm
 762+ A17F              	include common/general-sound.asm
# file opened: GPlay/common/general-sound.asm
   1++A17F                  ;ifdef GS
   2++A17F                  macro GS_WaitCommand
   3++A17F ~            .wait
   4++A17F ~                in a, (GeneralSound.CMD)
   5++A17F ~                rrca
   6++A17F ~                jr c, .wait
   7++A17F                  endm
   8++A17F
   9++A17F                  macro GS_WaitData
  10++A17F ~            .wait
  11++A17F ~                in a, (GeneralSound.CMD)
  12++A17F ~                rlca
  13++A17F ~                jr c, .wait
  14++A17F                  endm
  15++A17F
  16++A17F                  macro GS_SendCommand nn
  17++A17F ~                ld a, nn
  17++A17F ~              out (GeneralSound.CMD), a
  18++A17F                  endm
  19++A17F
  20++A17F                  module GeneralSound
  21++A17F              ;; Control ports
  22++A17F              CMD  = 187
  23++A17F              DATA = 179
  24++A17F
  25++A17F              ;; Commands
  26++A17F              CMD_WARM_RESET      = #F3
  27++A17F              CMD_COLD_RESET      = #F4
  28++A17F              CMD_LOAD_MODULE     = #30
  29++A17F              CMD_PLAY_MODULE     = #31
  30++A17F              CMD_STOP_MODULE     = #32
  31++A17F              CMD_CONTINUE_MODULE = #33
  32++A17F              CMD_OPEN_STREAM     = #D1
  33++A17F              CMD_CLOSE_STREAM    = #D2
  34++A17F
  35++A17F              ; A - 0 warm reset, other - cold
  36++A17F              init:
  37++A17F A7               and a
  37++A180 20 0A          jr nz, .cold
  38++A182                  GS_SendCommand CMD_WARM_RESET
  38++A182 3E F3       >    ld a, CMD_WARM_RESET
  38++A184 D3 BB       >  out (GeneralSound.CMD), a
  39++A186              	GS_WaitCommand
  39++A186             >.wait
  39++A186 DB BB       >    in a, (GeneralSound.CMD)
  39++A188 0F          >    rrca
  39++A189 38 FB       >    jr c, .wait
  40++A18B C9               ret
  41++A18C              .cold
  42++A18C                  GS_SendCommand CMD_COLD_RESET
  42++A18C 3E F4       >    ld a, CMD_COLD_RESET
  42++A18E D3 BB       >  out (GeneralSound.CMD), a
  43++A190              	GS_WaitCommand
  43++A190             >.wait
  43++A190 DB BB       >    in a, (GeneralSound.CMD)
  43++A192 0F          >    rrca
  43++A193 38 FB       >    jr c, .wait
  44++A195 C9               ret
  45++A196
  46++A196              ;; Initializes loading module
  47++A196              loadModule:
  48++A196                  GS_SendCommand CMD_LOAD_MODULE
  48++A196 3E 30       >    ld a, CMD_LOAD_MODULE
  48++A198 D3 BB       >  out (GeneralSound.CMD), a
  49++A19A                  GS_WaitCommand
  49++A19A             >.wait
  49++A19A DB BB       >    in a, (GeneralSound.CMD)
  49++A19C 0F          >    rrca
  49++A19D 38 FB       >    jr c, .wait
  50++A19F                  GS_SendCommand CMD_OPEN_STREAM
  50++A19F 3E D1       >    ld a, CMD_OPEN_STREAM
  50++A1A1 D3 BB       >  out (GeneralSound.CMD), a
  51++A1A3                  GS_WaitCommand
  51++A1A3             >.wait
  51++A1A3 DB BB       >    in a, (GeneralSound.CMD)
  51++A1A5 0F          >    rrca
  51++A1A6 38 FB       >    jr c, .wait
  52++A1A8 C9               ret
  53++A1A9
  54++A1A9              ;; Use it for streaming mod file
  55++A1A9              sendByte:
  56++A1A9 D3 B3            out (DATA), a
  57++A1AB                  GS_WaitData
  57++A1AB             >.wait
  57++A1AB DB BB       >    in a, (GeneralSound.CMD)
  57++A1AD 07          >    rlca
  57++A1AE 38 FB       >    jr c, .wait
  58++A1B0 C9               ret
  59++A1B1
  60++A1B1              ;; Call it when module was loaded
  61++A1B1              finishLoadingModule:
  62++A1B1                  GS_SendCommand CMD_CLOSE_STREAM
  62++A1B1 3E D2       >    ld a, CMD_CLOSE_STREAM
  62++A1B3 D3 BB       >  out (GeneralSound.CMD), a
  63++A1B5                  GS_WaitCommand
  63++A1B5             >.wait
  63++A1B5 DB BB       >    in a, (GeneralSound.CMD)
  63++A1B7 0F          >    rrca
  63++A1B8 38 FB       >    jr c, .wait
  64++A1BA              rewind:
  65++A1BA 3E 01            ld a, 1
  65++A1BC D3 B3          out (DATA), a
  66++A1BE                  GS_SendCommand CMD_PLAY_MODULE
  66++A1BE 3E 31       >    ld a, CMD_PLAY_MODULE
  66++A1C0 D3 BB       >  out (GeneralSound.CMD), a
  67++A1C2                  GS_WaitCommand
  67++A1C2             >.wait
  67++A1C2 DB BB       >    in a, (GeneralSound.CMD)
  67++A1C4 0F          >    rrca
  67++A1C5 38 FB       >    jr c, .wait
  68++A1C7 3E 01 32 E8      ld a, 1, (state),a
  68++A1CB A1
  69++A1CC C9               ret
  70++A1CD
  71++A1CD              ;; Works like pause too
  72++A1CD              stopModule:
  73++A1CD AF               xor a
  73++A1CE 32 E8 A1       ld (state), a
  74++A1D1                  GS_SendCommand CMD_STOP_MODULE
  74++A1D1 3E 32       >    ld a, CMD_STOP_MODULE
  74++A1D3 D3 BB       >  out (GeneralSound.CMD), a
  75++A1D5 C9               ret
  76++A1D6
  77++A1D6              continueModule:
  78++A1D6 3E 01            ld a, 1
  78++A1D8 32 E8 A1       ld (state), a
  79++A1DB                  GS_SendCommand CMD_CONTINUE_MODULE
  79++A1DB 3E 33       >    ld a, CMD_CONTINUE_MODULE
  79++A1DD D3 BB       >  out (GeneralSound.CMD), a
  80++A1DF C9               ret
  81++A1E0
  82++A1E0              ; Pauses resumes
  83++A1E0              toggleModule:
  84++A1E0                  ;call Console.waitForKeyUp
  85++A1E0 3A E8 A1         ld a, (state)
  85++A1E3 A7             and a
  86++A1E4 28 F0            jr z, continueModule
  87++A1E6 18 E5            jr stopModule
  88++A1E8
  89++A1E8 00           state db 0
  90++A1E9                  endmodule
  91++A1E9
  92++A1E9                  ;endif
# file closed: GPlay/common/general-sound.asm
 763+ A1E9              	;include common/muldiv.asm
 764+ A1E9
 765+ A1E9              end_gplay
 766+ A1E9
 767+ A1E9
 768+ A1E9
 769+ A1E9              ;ниже не включается в файл
 770+ A1E9              ;waveheaderbuffer equ 0xc000-2048=0xb800 ;
 771+ A1E9
 772+ A1E9
 773+ A1E9              	;savebin "gplay.apg",start_gplay,$-start_gplay
# file closed: GPlay/gplay.asm
1648  A1E9              	include nc_pic_view.asm ;просмотр картинок
# file opened: nc_pic_view.asm
   1+ A1E9                  ; module ScreenViewer
   2+ A1E9              display:
   3+ A1E9                  ; call Console.waitForKeyUp
   4+ A1E9
   5+ A1E9 21 4A A2     	ld hl,file_name_cur		;строка с именем
   6+ A1EC              	OS_FILE_OPEN
   6+ A1EC 0E 21       >    ld c,#21
   6+ A1EE E7          >    rst #20
   7+ A1EF 30 08        	jr nc,display_file_open_ok
   8+ A1F1              display_file_error
   9+ A1F1 21 3A A5     	ld hl,msg_file_error
  10+ A1F4              	OS_PRINTZ
  10+ A1F4 0E 09       >    ld c,#09
  10+ A1F6 E7          >    rst #20
  11+ A1F7              	; ld b,2*50
  12+ A1F7              	; call delay1
  13+ A1F7 37           	scf ;ошибка
  14+ A1F8 C9           	ret
  15+ A1F9
  16+ A1F9              display_file_open_ok
  17+ A1F9 32 5F A4     	ld (file_id_cur_r),a
  18+ A1FC
  19+ A1FC 3A 60 A4     	ld a,(page_ext01) ;доп страница
  20+ A1FF              	OS_SET_PAGE_SLOT3
  20+ A1FF 0E 1C       >    ld c,#1c
  20+ A201 E7          >    rst #20
  21+ A202
  22+ A202 3A 5F A4     	ld a,(file_id_cur_r)
  23+ A205 11 00 1B     	ld de,6912
  24+ A208 21 00 C0     	ld hl,#c000
  25+ A20B              	;ld a,(file_id_cur_r)
  26+ A20B              	OS_FILE_READ ;загрузить
  26+ A20B 0E 23       >    ld c,#23
  26+ A20D E7          >    rst #20
  27+ A20E 38 E1        	jr c,display_file_error
  28+ A210 3A 5F A4     	ld a,(file_id_cur_r)
  29+ A213              	OS_FILE_CLOSE
  29+ A213 0E 25       >    ld c,#25
  29+ A215 E7          >    rst #20
  30+ A216
  31+ A216              display_wait1
  32+ A216 3E 07        	ld a,7
  33+ A218              	OS_SET_SCREEN ;включить экран
  33+ A218 0E 1D       >    ld c,#1d
  33+ A21A E7          >    rst #20
  34+ A21B 30 03        	jr nc,display_wait1_ok
  35+ A21D              	OS_WAIT
  35+ A21D DF          >	rst #18
  36+ A21E 18 F6        	jr display_wait1 ;пока не получилось, может не в фокусе приложение
  37+ A220
  38+ A220              display_wait1_ok
  39+ A220
  40+ A220 3A 60 A4     	ld a,(page_ext01) ;доп страница для данных плеера
  41+ A223 06 07        	ld b,7 ;страница назначения
  42+ A225 21 00 80     	ld hl,#8000
  43+ A228 11 00 C0     	ld de,#c000
  44+ A22B DD 21 00 1B  	ld ix,6912
  45+ A22F              	OS_RAM_COPY
  45+ A22F 0E 19       >    ld c,#19
  45+ A231 E7          >    rst #20
  46+ A232                  ;call TextMode.disable
  47+ A232              .wait
  48+ A232              	OS_WAIT
  48+ A232 DF          >	rst #18
  49+ A233              	OS_GET_CHAR
  49+ A233 0E 10       >    ld c,#10
  49+ A235 E7          >    rst #20
  50+ A236 FE FF        	cp 255
  51+ A238 28 F8        	jr z, .wait
  52+ A23A AF           	xor a ;текстовый экран
  53+ A23B              	OS_SET_SCREEN
  53+ A23B 0E 1D       >    ld c,#1d
  53+ A23D E7          >    rst #20
  54+ A23E                  ;call TextMode.cls
  55+ A23E
  56+ A23E
  57+ A23E 3A 70 A4     	ld a,(page_main) ;основная страница
  58+ A241              	OS_SET_PAGE_SLOT3
  58+ A241 0E 1C       >    ld c,#1c
  58+ A243 E7          >    rst #20
  59+ A244
  60+ A244 AF           	xor a ;ok
  61+ A245 C9           	ret
  62+ A246                  ;jp History.back
  63+ A246
  64+ A246              ;    endmodule
  65+ A246
# file closed: nc_pic_view.asm
1649  A246
1650  A246              color_error equ 1*8+2 ;цвет ошибка
1651  A246              color_default equ 0*8+7 ;цвет обычный системный
1652  A246              color_view_text equ 4 ;цвет текста в просмотрщике
1653  A246              color_edit_text equ 4 ;цвет текста в редакторе
1654  A246              color_edit_cursor equ 4*8+0 ;цвет курсора в редакторе текста
1655  A246
1656  A246              color_backgr equ 1*8+7 ;цвет фона
1657  A246              color_apg equ 1*8+4 ;цвет приложений
1658  A246              color_dir equ 1*8+6 ;цвет папок
1659  A246
1660  A246              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1661  A246              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1662  A246              color_dir_hi equ 5*8+0 ;цвет папок курсор
1663  A246
1664  A246              file_info_lenght equ 255 ;длина инфо о файле
1665  A246              panel_hight equ 22;высота панели
1666  A246              panel_r_xy equ #0129
1667  A246              buffer_cat equ #c000 ;адрес буфера каталога
1668  A246
1669  A246 00 00        file_r_all dw 0;всего файлов справа
1670  A248 00 00        file_r_cur_focus dw 0;первый видимый
1671  A24A 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1672  A34A 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1673  A44A 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1673  A44E 20 20 20 20
1673  A452 20 20 20 20
1673  A456 00
1674  A457 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1675  A458
1676  A458 00 00        file_r_num_cur dw 0 ;текущий файл справа
1677  A45A 00 00        file_r_num_old dw 0 ;текущий файл справа
1678  A45C 00 00        file_r_num_tmp dw 0 ;временно
1679  A45E 00           key_pressed db 0 ;последняя клавиша
1680  A45F 00           file_id_cur_r db 0 ;id файла справа
1681  A460
1682  A460
1683  A460 00           page_ext01 db 0 ;номер дополнительной страницы
1684  A461 00           page_ext02_gzip db 0 ;номер дополнительной страницы
1685  A462
1686  A462 67 70 5F 67  gp_gzip_file_name db "gp_gzip.bin",0 ;часть плеера для режима моно, переносится в резервную страницу
1686  A466 7A 69 70 2E
1686  A46A 62 69 6E 00
1687  A46E 00 00        gp_gzip_file_size dw 0 ;размер части плеера
1688  A470
1689  A470 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1690  A472 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1691  A473 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1691  A477 20 20 20 20
1691  A47B 20 20 20 20
1691  A47F 20 20 20 20
1691  A483 20 20 20 20
1691  A487 20 20 20 20
1691  A48B 20 20 00
1692  A48E
1693  A48E
1694  A48E              rect_1
1695  A48E C9           	db #c9
1696  A48F              	dup 40-2
1697  A48F CD          >	db #cd
1697  A490 CD          >	db #cd
1697  A491 CD          >	db #cd
1697  A492 CD          >	db #cd
1697  A493 CD          >	db #cd
1697  A494 CD          >	db #cd
1697  A495 CD          >	db #cd
1697  A496 CD          >	db #cd
1697  A497 CD          >	db #cd
1697  A498 CD          >	db #cd
1697  A499 CD          >	db #cd
1697  A49A CD          >	db #cd
1697  A49B CD          >	db #cd
1697  A49C CD          >	db #cd
1697  A49D CD          >	db #cd
1697  A49E CD          >	db #cd
1697  A49F CD          >	db #cd
1697  A4A0 CD          >	db #cd
1697  A4A1 CD          >	db #cd
1697  A4A2 CD          >	db #cd
1697  A4A3 CD          >	db #cd
1697  A4A4 CD          >	db #cd
1697  A4A5 CD          >	db #cd
1697  A4A6 CD          >	db #cd
1697  A4A7 CD          >	db #cd
1697  A4A8 CD          >	db #cd
1697  A4A9 CD          >	db #cd
1697  A4AA CD          >	db #cd
1697  A4AB CD          >	db #cd
1697  A4AC CD          >	db #cd
1697  A4AD CD          >	db #cd
1697  A4AE CD          >	db #cd
1697  A4AF CD          >	db #cd
1697  A4B0 CD          >	db #cd
1697  A4B1 CD          >	db #cd
1697  A4B2 CD          >	db #cd
1697  A4B3 CD          >	db #cd
1697  A4B4 CD          >	db #cd
1698  A4B5              	edup
1699  A4B5 BB 00        	db #bb,0
1700  A4B7
1701  A4B7              rect_2
1702  A4B7 BA           	db #ba
1703  A4B8              	dup 40-2
1704  A4B8 20          >	db " "
1704  A4B9 20          >	db " "
1704  A4BA 20          >	db " "
1704  A4BB 20          >	db " "
1704  A4BC 20          >	db " "
1704  A4BD 20          >	db " "
1704  A4BE 20          >	db " "
1704  A4BF 20          >	db " "
1704  A4C0 20          >	db " "
1704  A4C1 20          >	db " "
1704  A4C2 20          >	db " "
1704  A4C3 20          >	db " "
1704  A4C4 20          >	db " "
1704  A4C5 20          >	db " "
1704  A4C6 20          >	db " "
1704  A4C7 20          >	db " "
1704  A4C8 20          >	db " "
1704  A4C9 20          >	db " "
1704  A4CA 20          >	db " "
1704  A4CB 20          >	db " "
1704  A4CC 20          >	db " "
1704  A4CD 20          >	db " "
1704  A4CE 20          >	db " "
1704  A4CF 20          >	db " "
1704  A4D0 20          >	db " "
1704  A4D1 20          >	db " "
1704  A4D2 20          >	db " "
1704  A4D3 20          >	db " "
1704  A4D4 20          >	db " "
1704  A4D5 20          >	db " "
1704  A4D6 20          >	db " "
1704  A4D7 20          >	db " "
1704  A4D8 20          >	db " "
1704  A4D9 20          >	db " "
1704  A4DA 20          >	db " "
1704  A4DB 20          >	db " "
1704  A4DC 20          >	db " "
1704  A4DD 20          >	db " "
1705  A4DE              	edup
1706  A4DE BA 00        	db #ba,0
1707  A4E0
1708  A4E0              rect_3
1709  A4E0 C8           	db #c8
1710  A4E1              	dup 40-2
1711  A4E1 CD          >	db #cd
1711  A4E2 CD          >	db #cd
1711  A4E3 CD          >	db #cd
1711  A4E4 CD          >	db #cd
1711  A4E5 CD          >	db #cd
1711  A4E6 CD          >	db #cd
1711  A4E7 CD          >	db #cd
1711  A4E8 CD          >	db #cd
1711  A4E9 CD          >	db #cd
1711  A4EA CD          >	db #cd
1711  A4EB CD          >	db #cd
1711  A4EC CD          >	db #cd
1711  A4ED CD          >	db #cd
1711  A4EE CD          >	db #cd
1711  A4EF CD          >	db #cd
1711  A4F0 CD          >	db #cd
1711  A4F1 CD          >	db #cd
1711  A4F2 CD          >	db #cd
1711  A4F3 CD          >	db #cd
1711  A4F4 CD          >	db #cd
1711  A4F5 CD          >	db #cd
1711  A4F6 CD          >	db #cd
1711  A4F7 CD          >	db #cd
1711  A4F8 CD          >	db #cd
1711  A4F9 CD          >	db #cd
1711  A4FA CD          >	db #cd
1711  A4FB CD          >	db #cd
1711  A4FC CD          >	db #cd
1711  A4FD CD          >	db #cd
1711  A4FE CD          >	db #cd
1711  A4FF CD          >	db #cd
1711  A500 CD          >	db #cd
1711  A501 CD          >	db #cd
1711  A502 CD          >	db #cd
1711  A503 CD          >	db #cd
1711  A504 CD          >	db #cd
1711  A505 CD          >	db #cd
1711  A506 CD          >	db #cd
1712  A507              	edup
1713  A507 BC 00        	db #bc,0
1714  A509
1715  A509              ;file_name_test db '486 HEART ON FIRE.vgm',0
1716  A509              msg_menu_info
1717  A509 0D 43 53 2B  	db 13,"CS+Enter - Play all",0
1717  A50D 45 6E 74 65
1717  A511 72 20 2D 20
1717  A515 50 6C 61 79
1717  A519 20 61 6C 6C
1717  A51D 00
1718  A51E              msg_menu_main1
1719  A51E 20 4C 46 20  	db " LF On",0
1719  A522 4F 6E 00
1720  A525              msg_menu_main2
1721  A525 20 41 5A 20  	db " AZ On",0
1721  A529 4F 6E 00
1722  A52C              msg_menu_main3
1723  A52C 20 56 69 65  	db " View ",0
1723  A530 77 20 00
1724  A533              msg_menu_main4
1725  A533 20 45 64 69  	db " Edit ",0
1725  A537 74 20 00
1726  A53A              msg_file_error
1727  A53A 46 69 6C 65  	db "File error",13,0
1727  A53E 20 65 72 72
1727  A542 6F 72 0D 00
1728  A546              msg_file_too_big
1729  A546 46 69 6C 65  	db "File too big",13,0
1729  A54A 20 74 6F 6F
1729  A54E 20 62 69 67
1729  A552 0D 00
1730  A554              msg_mem_err
1731  A554 47 65 74 20  	db "Get memory error",13,0
1731  A558 6D 65 6D 6F
1731  A55C 72 79 20 65
1731  A560 72 72 6F 72
1731  A564 0D 00
1732  A566              msg_mono_err
1733  A566 47 65 74 20  	db "Get mono mode error",13,0
1733  A56A 6D 6F 6E 6F
1733  A56E 20 6D 6F 64
1733  A572 65 20 65 72
1733  A576 72 6F 72 0D
1733  A57A 00
1734  A57B              msg_load_gzip
1735  A57B 4C 6F 61 64  	db "Load gzip",13,0
1735  A57F 20 67 7A 69
1735  A583 70 0D 00
1736  A586
1737  A586              msg_title_nc
1738  A586 4E 6F 6E 65  	db "None Commander ver 2025.08.22",13,0
1738  A58A 20 43 6F 6D
1738  A58E 6D 61 6E 64
1738  A592 65 72 20 76
1738  A596 65 72 20 32
1738  A59A 30 32 35 2E
1738  A59E 30 38 2E 32
1738  A5A2 32 0D 00
1739  A5A5
1740  A5A5
1741  A5A5              start_gp_gzip equ #4000 ;рабочий адрес модуля для распаковки
1742  A5A5              start_gp_gzip_ext equ #c000 ;временный адрес модуля для распаковки
1743  A5A5
1744  A5A5
1745  A5A5
1746  A5A5              end_nc
1747  A5A5              	savebin "nc.apg",start_nc,$-start_nc
1748  A5A5
1749  A5A5              ;ниже не включается в файл
1750  A5A5
1751  A5A5 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1752  A9A5 00 00 00...  cat_index_2 ds 1024 ;буфер для индекса (вектора) сортировки 2
1753  ADA5 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1754  AEA5
1755  AEA5              free equ $ ;тут условно свободно
1756  AEA5
1757  AEA5
1758  AEA5
1759  AEA5              end_nc_all
1760  AEA5
1761  AEA5
1762  AEA5
1763  AEA5              	org 0xb800 ;
1764  B800              ;ещё тут буферы плеера VGM до адреса #bf00
1765  B800
1766  B800
# file closed: nc.asm
