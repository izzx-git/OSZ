# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROG_START
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROG_START equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000
  97+ 0000              ;включить/выключить моно режим для приложения
  98+ 0000              ;при включенном режиме разрешена запись в диапазон памяти #4000-#7fff + страницы приложения
  99+ 0000              ;вх: a = 0 - включить; a = 255 - выключить
 100+ 0000                  macro OS_SET_MONO_MODE ;
 101+ 0000 ~                ld c,#08
 102+ 0000 ~                rst #20
 103+ 0000                  endm
 104+ 0000
 105+ 0000
 106+ 0000
 107+ 0000              ;печать в консоль до кода 0
 108+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 109+ 0000 ~                ld c,#09
 110+ 0000 ~                rst #20
 111+ 0000                  endm
 112+ 0000
 113+ 0000
 114+ 0000              ;прочитать байт из порта uart
 115+ 0000              ;вх:
 116+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 117+ 0000              ;вых: A - считанный байт
 118+ 0000                  macro OS_UART_READ
 119+ 0000 ~                ld c,#0a
 120+ 0000 ~                rst #20
 121+ 0000                  endm
 122+ 0000
 123+ 0000              ;записать байт в порт uart
 124+ 0000              ;вх: A -байт
 125+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 126+ 0000                  macro OS_UART_WRITE
 127+ 0000 ~                ld c,#0b
 128+ 0000 ~                rst #20
 129+ 0000                  endm
 130+ 0000
 131+ 0000              ;закрыть соединение ESP
 132+ 0000              ;вх:
 133+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 134+ 0000                  macro OS_ESP_CLOSE
 135+ 0000 ~                ld c,#0c
 136+ 0000 ~                rst #20
 137+ 0000                  endm
 138+ 0000
 139+ 0000              ;установить соединение ESP (CIPSTART);
 140+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 141+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 142+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 143+ 0000                  macro OS_ESP_OPEN
 144+ 0000 ~                ld c,#0d
 145+ 0000 ~                rst #20
 146+ 0000                  endm
 147+ 0000
 148+ 0000              ;послать запрос ESP (CIPSEND);
 149+ 0000              ;вх: hl - адрес данных, de - длина данных
 150+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 151+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 152+ 0000                  macro OS_ESP_SEND
 153+ 0000 ~                ld c,#0e
 154+ 0000 ~                rst #20
 155+ 0000                  endm
 156+ 0000
 157+ 0000              ;получить пакет ESP (+IPD);
 158+ 0000              ;вх: hl - адрес для данных
 159+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 160+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 161+ 0000                  macro OS_ESP_GET
 162+ 0000 ~                ld c,#0f
 163+ 0000 ~                rst #20
 164+ 0000                  endm
 165+ 0000
 166+ 0000              ;ввод с консоли ----------------------
 167+ 0000
 168+ 0000              ;получить код нажатой клавиши
 169+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 170+ 0000 ~                ld c,#10
 171+ 0000 ~                rst #20
 172+ 0000                  endm
 173+ 0000
 174+ 0000
 175+ 0000              ;процессы ----------------------------
 176+ 0000
 177+ 0000              ;запустить процесс
 178+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 179+ 0000                  macro OS_PROC_RUN ;
 180+ 0000 ~                ld c,#11
 181+ 0000 ~                rst #20
 182+ 0000                  endm
 183+ 0000
 184+ 0000              ;установить фокус
 185+ 0000              ;вх: a - id процесса
 186+ 0000                  macro OS_PROC_SET_FOCUS ;
 187+ 0000 ~                ld c,#12
 188+ 0000 ~                rst #20
 189+ 0000                  endm
 190+ 0000
 191+ 0000              ;закрыть процесс
 192+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 193+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 194+ 0000                  macro OS_PROC_CLOSE ;
 195+ 0000 ~                ld c,#13
 196+ 0000 ~                rst #20
 197+ 0000                  endm
 198+ 0000
 199+ 0000
 200+ 0000              ;прерывания --------------------------
 201+ 0000
 202+ 0000              ;установка адреса обработчика прерываний процесса;
 203+ 0000              ;например, плеера музыки
 204+ 0000              ;включать прерывания во время работы обработчика нельзя. время работы, по возможности, минимальное
 205+ 0000              ;на время выполнения включаются обе страницы процесса
 206+ 0000                  macro OS_SET_INTER ;(HL - address, address = 0 = отключить)
 207+ 0000 ~                ld c,#14
 208+ 0000 ~                rst #20
 209+ 0000                  endm
 210+ 0000
 211+ 0000
 212+ 0000              ;плеер AY ----------------------------
 213+ 0000
 214+ 0000              ;инициализация плеера AY;
 215+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 216+ 0000 ~                ld c,#15
 217+ 0000 ~                rst #20
 218+ 0000                  endm
 219+ 0000
 220+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 221+ 0000                  macro OS_VTPL_PLAY ;()
 222+ 0000 ~                ld c,#16
 223+ 0000 ~                rst #20
 224+ 0000                  endm
 225+ 0000
 226+ 0000              ;заглушить плеер AY;
 227+ 0000                  macro OS_VTPL_MUTE ;()
 228+ 0000 ~                ld c,#17
 229+ 0000 ~                rst #20
 230+ 0000                  endm
 231+ 0000
 232+ 0000              ;получить значение переменной плеера;
 233+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 234+ 0000 ~                ld c,#18
 235+ 0000 ~                rst #20
 236+ 0000                  endm
 237+ 0000
 238+ 0000
 239+ 0000              ;прочие ------------------------------
 240+ 0000
 241+ 0000
 242+ 0000              ;скопировать данные из страницы в страницу
 243+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 244+ 0000                  macro OS_RAM_COPY
 245+ 0000 ~                ld c,#19
 246+ 0000 ~                rst #20
 247+ 0000                  endm
 248+ 0000
 249+ 0000              ;получить дополнительную страницу памяти;
 250+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 251+ 0000 ~                ld c,#1a
 252+ 0000 ~                rst #20
 253+ 0000                  endm
 254+ 0000
 255+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 256+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 257+ 0000 ~                ld c,#1b
 258+ 0000 ~                rst #20
 259+ 0000                  endm
 260+ 0000
 261+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 262+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 263+ 0000 ~                ld c,#1c
 264+ 0000 ~                rst #20
 265+ 0000                  endm
 266+ 0000
 267+ 0000              ;включить экран N;
 268+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 269+ 0000              ;переключать может только приложение в фокусе
 270+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 271+ 0000              ;при переключении процессов сохраняется только экран #39
 272+ 0000                  macro OS_SET_SCREEN ;
 273+ 0000 ~                ld c,#1d
 274+ 0000 ~                rst #20
 275+ 0000                  endm
 276+ 0000
 277+ 0000
 278+ 0000              ;получить номера страниц процесса;
 279+ 0000              ;вх:
 280+ 0000              ;вых: b, c - страницы в слотах 2, 3
 281+ 0000                  macro OS_GET_MAIN_PAGES ;
 282+ 0000 ~                ld c,#1e
 283+ 0000 ~                rst #20
 284+ 0000                  endm
 285+ 0000
 286+ 0000              ;получить значение системного таймера
 287+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 288+ 0000 ~                ld c,#1F
 289+ 0000 ~                rst #20
 290+ 0000                  endm
 291+ 0000
 292+ 0000
 293+ 0000              ;освободить страницу памяти
 294+ 0000              ;вх: a - номер страницы
 295+ 0000                  macro OS_DEL_PAGE ;
 296+ 0000 ~                ld c,#20
 297+ 0000 ~                rst #20
 298+ 0000                  endm
 299+ 0000
 300+ 0000
 301+ 0000              ;дисковые операции -------------------
 302+ 0000
 303+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 304+ 0000
 305+ 0000              ; fcbFAT (из руководства к монитору)
 306+ 0000              ; формат fcb для работы с FAT
 307+ 0000
 308+ 0000              ; +#00 8 имя файла
 309+ 0000              ; +#08 3 расширение файла
 310+ 0000              ; +#0B 1 атрибуты файла
 311+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 312+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 313+ 0000              ; +#14 4 размер файла/каталога в байтах
 314+ 0000              ; +#18 4 указатель в файле
 315+ 0000              ; +#1C 1 для внутренних нужд
 316+ 0000              ; +#1D 1 для внутренних нужд
 317+ 0000              ; +#1E 1 резерв
 318+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 319+ 0000              	; 1-0,nn номер раздела
 320+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 321+ 0000              	    ; значение %11 недопустимо
 322+ 0000
 323+ 0000              ;открыть файл для чтения или записи
 324+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, de bc - size, IX - fcb)
 325+ 0000 ~                ld c,#21
 326+ 0000 ~                rst #20
 327+ 0000                  endm
 328+ 0000
 329+ 0000              ;создать файл
 330+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 331+ 0000 ~                ld c,#22
 332+ 0000 ~                rst #20
 333+ 0000                  endm
 334+ 0000
 335+ 0000              ;прочитать из файла
 336+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 337+ 0000 ~                ld c,#23
 338+ 0000 ~                rst #20
 339+ 0000                  endm
 340+ 0000
 341+ 0000              ;записать в файл
 342+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: hl - следующий адрес для чтения)
 343+ 0000 ~                ld c,#24
 344+ 0000 ~                rst #20
 345+ 0000                  endm
 346+ 0000
 347+ 0000              ;закрыть файл
 348+ 0000                  macro OS_FILE_CLOSE ;A - id file
 349+ 0000 ~                ld c,#25
 350+ 0000 ~                rst #20
 351+ 0000                  endm
 352+ 0000
 353+ 0000              ;чтение секторов текущего каталога
 354+ 0000              ; вх:
 355+ 0000                   ; hl - буфер для чтения
 356+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 357+ 0000                   ; b - максимальное количество секторов для чтения
 358+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 359+ 0000                     ; a=errRWnum
 360+ 0000                     ; a=errInvalidPart
 361+ 0000                     ; a=errFileEmpty
 362+ 0000                   ; cy=0, a=errEoF - каталог закончился
 363+ 0000                     ; hl - следующий адрес в буфере
 364+ 0000                     ; de - номер первого непрочитанного сектора
 365+ 0000                     ; b - не прочитано секторов
 366+ 0000                   ; cy=0 - считано успешно
 367+ 0000                     ; hl - следующий адрес в буфере
 368+ 0000                     ; de - номер первого непрочитанного сектора
 369+ 0000                     ; b=#00
 370+ 0000                  macro OS_DIR_READ ;
 371+ 0000 ~                ld c,#26
 372+ 0000 ~                rst #20
 373+ 0000                  endm
 374+ 0000
 375+ 0000              ;вход в каталог/выход в родительский каталог
 376+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 377+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 378+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 379+ 0000              	; переход в родительский, последнее имя в пути удалится).
 380+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 381+ 0000              	; добавится имя файла
 382+ 0000              ; вх:
 383+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 384+ 0000                   ; de - адрес дескриптора директории/файла
 385+ 0000              ; вых: a - если путь был указан, новая длина пути
 386+ 0000                  macro OS_DIR_OPEN ;
 387+ 0000 ~                ld c,#27
 388+ 0000 ~                rst #20
 389+ 0000                  endm
 390+ 0000
 391+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 392+ 0000              ;проверки на допустимость значений не производится
 393+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 394+ 0000              ;вх: A - id файла
 395+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 396+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 397+ 0000                  macro OS_FILE_POSITION ;
 398+ 0000 ~                ld c,#28
 399+ 0000 ~                rst #20
 400+ 0000                  endm
 401+ 0000
 402+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 403+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 404+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 405+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 406+ 0000                  macro OS_FIND_PATH ;
 407+ 0000 ~                ld c,#29
 408+ 0000 ~                rst #20
 409+ 0000                  endm
 410+ 0000
 411+ 0000
 412+ 0000              ; получение длинного имени файла
 413+ 0000              ;вх: hl - адрес буфера для имени
 414+ 0000              ;    de - номер записи в текущем каталоге
 415+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 416+ 0000              ; 	a - длина имени, с учетом нуля
 417+ 0000                  macro OS_GET_LFN ;
 418+ 0000 ~                ld c,#2a
 419+ 0000 ~                rst #20
 420+ 0000                  endm
 421+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROG_START
   5  8000
   6  8000              start_nc
   7  8000 21 22 9E     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 1F 9D  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 FB 9D     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A
  24  801A CD AD 80     	call delay
  25  801D C3 CC 82     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 1E 9D     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023
  32  8023              start_nc_warm ;тёплый старт
  33  8023
  34  8023              	;очистка буфера
  35  8023 CD B3 80     	call clear_buf
  36  8026
  37  8026              	;загрузка каталога
  38  8026 21 00 C0     	ld hl,buffer_cat ;куда
  39  8029 11 00 00     	ld de,0 ;начиная с 0 сектора
  40  802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  41  802E              	OS_DIR_READ
  41  802E 0E 26       >    ld c,#26
  41  8030 E7          >    rst #20
  42  8031
  43  8031 21 00 00     	ld hl,0 ;обнулить переменные
  44  8034 22 1A 9D     	ld (file_r_num_cur),hl
  45  8037 22 08 9B     	ld (file_r_all),hl
  46  803A 22 0A 9B     	ld (file_r_cur_focus),hl
  47  803D
  48  803D CD 63 84     	call sort_dir
  49  8040
  50  8040 3E 0F        	ld a,color_backgr
  51  8042 06 0C        	ld b,#c
  52  8044              	OS_SET_COLOR
  52  8044 0E 06       >    ld c,#06
  52  8046 E7          >    rst #20
  53  8047
  54  8047 CD 59 86     	call print_rect_r ;рамка
  55  804A CD 6B 83     	call print_panel_r
  56  804D CD 8E 86     	call print_menu_main
  57  8050
  58  8050 11 00 01     	ld de,#0100
  59  8053              	OS_SET_XY
  59  8053 0E 01       >    ld c,#01
  59  8055 E7          >    rst #20
  60  8056
  61  8056 21 B8 9D     	ld hl,msg_menu_info
  62  8059              	OS_PRINTZ
  62  8059 0E 09       >    ld c,#09
  62  805B E7          >    rst #20
  63  805C
  64  805C
  65  805C
  66  805C              nc_wait
  67  805C              	OS_WAIT ;ждать прерывание
  67  805C DF          >	rst #18
  68  805D
  69  805D              	OS_GET_CHAR ;клавиша
  69  805D 0E 10       >    ld c,#10
  69  805F E7          >    rst #20
  70  8060 32 1C 9D     	ld (key_pressed),a ;запомнить
  71  8063 FE 0D        	cp 13
  72  8065 CA 14 81     	jp z,key_enter ;
  73  8068 FE 0A        	cp 10 ;вниз
  74  806A CC 38 82     	call z,key_down
  75  806D FE 0B        	cp 11 ;вверх
  76  806F CC 75 82     	call z,key_up
  77  8072 FE 09        	cp 09 ;вправо
  78  8074 CC BA 82     	call z,key_right
  79  8077 FE 08        	cp 08 ;влево
  80  8079 CC A8 82     	call z,key_left
  81  807C FE 04        	cp 04 ;страница вверх
  82  807E CC A8 82     	call z,key_left
  83  8081 FE 05        	cp 05 ;страница вниз
  84  8083 CC BA 82     	call z,key_right
  85  8086 FE 31        	cp "1" ;переключение длинных имён (LFN)
  86  8088 CA 07 86     	jp z,LFN_toggle
  87  808B FE 32        	cp "2" ;переключение сортировки
  88  808D CA E7 85     	jp z,sort_toggle
  89  8090 FE 33        	cp "3" ;просмотр файла
  90  8092 CA DC 86     	jp z,view_file
  91  8095 FE 19        	cp 25 ;CS+Enter
  92  8097 CA B3 81     	jp z,nc_play_all
  93  809A FE 18        	cp 24 ;break
  94  809C CA CC 82     	jp z,exit
  95  809F
  96  809F
  97  809F 3A 21 9D     	ld a,(print_panel_r_flag)
  98  80A2 B7           	or a
  99  80A3 C4 6B 83     	call nz,print_panel_r ;обновить каталог
 100  80A6 AF           	xor a
 101  80A7 32 21 9D     	ld (print_panel_r_flag),a
 102  80AA
 103  80AA C3 5C 80     	jp nc_wait ;на цикл ожидания
 104  80AD
 105  80AD
 106  80AD              delay ;задержка
 107  80AD 06 96        	ld b,50*3 ;
 108  80AF              delay1
 109  80AF              	OS_WAIT
 109  80AF DF          >	rst #18
 110  80B0 10 FD        	djnz delay1
 111  80B2 C9           	ret
 112  80B3
 113  80B3
 114  80B3              clear_buf
 115  80B3 21 00 C0     	ld hl,buffer_cat
 116  80B6 11 01 C0     	ld de,buffer_cat+1
 117  80B9 01 FF 3F     	ld bc,#4000-1
 118  80BC 36 00        	ld (hl),0
 119  80BE ED B0        	ldir
 120  80C0 C9           	ret
 121  80C1
 122  80C1
 123  80C1              ;очистить левую панель
 124  80C1              clear_left_panel
 125  80C1 3E 0F        	ld a,color_backgr ;цвет
 126  80C3 06 0C        	ld b,#c
 127  80C5              	OS_SET_COLOR
 127  80C5 0E 06       >    ld c,#06
 127  80C7 E7          >    rst #20
 128  80C8 06 18        	ld b,panel_hight+2 ;высота
 129  80CA 11 00 00     	ld de,0
 130  80CD              	OS_SET_XY
 130  80CD 0E 01       >    ld c,#01
 130  80CF E7          >    rst #20
 131  80D0              clear_left_panel_cl
 132  80D0 C5           	push bc
 133  80D1 21 E1 80     	ld hl,txt_clear_panel
 134  80D4              	OS_PRINTZ
 134  80D4 0E 09       >    ld c,#09
 134  80D6 E7          >    rst #20
 135  80D7 C1           	pop bc
 136  80D8 10 F6        	djnz clear_left_panel_cl
 137  80DA 11 00 00     	ld de,0
 138  80DD              	OS_SET_XY
 138  80DD 0E 01       >    ld c,#01
 138  80DF E7          >    rst #20
 139  80E0 C9           	ret
 140  80E1 20 20 20 20  txt_clear_panel db "                                        ",13,0 ;40 пробелов
 140  80E5 20 20 20 20
 140  80E9 20 20 20 20
 140  80ED 20 20 20 20
 140  80F1 20 20 20 20
 140  80F5 20 20 20 20
 140  80F9 20 20 20 20
 140  80FD 20 20 20 20
 140  8101 20 20 20 20
 140  8105 20 20 20 20
 140  8109 0D 00
 141  810B
 142  810B
 143  810B              release_key ;ждать отпускания клавиши
 144  810B              	OS_WAIT
 144  810B DF          >	rst #18
 145  810C              	OS_GET_CHAR
 145  810C 0E 10       >    ld c,#10
 145  810E E7          >    rst #20
 146  810F FE FF        	cp 255
 147  8111 20 F8        	jr nz,release_key
 148  8113 C9           	ret
 149  8114
 150  8114
 151  8114              key_enter
 152  8114              	;нажата Enter
 153  8114 2A 08 9B     	ld hl,(file_r_all)
 154  8117 7D           	ld a,l
 155  8118 B4           	or h
 156  8119 CA B0 81     	jp z,key_enter_ex ;защита
 157  811C 2A 1A 9D     	ld hl,(file_r_num_cur)
 158  811F CD 2B 82     	call calc_deskr
 159  8122 DD 7E 0B     	ld a,(ix+#0b)
 160  8125 FE 10        	cp #10 ;признак каталога
 161  8127 CA 1E 82     	jp z,key_enter_dir
 162  812A
 163  812A FE 30        	cp #30 ;признак каталога
 164  812C CA 1E 82     	jp z,key_enter_dir
 165  812F
 166  812F
 167  812F CD 24 86     	call format_name
 168  8132
 169  8132              	;проверка расширения APG
 170  8132 CD D0 82     	call check_apg
 171  8135 C2 4A 81     	jp nz,key_enter_1
 172  8138              	;тут запуск приложения
 173  8138 21 0C 9B     	ld hl,file_name_cur		;строка с именем
 174  813B              	OS_PROC_RUN ;запустить прогу
 174  813B 0E 11       >    ld c,#11
 174  813D E7          >    rst #20
 175  813E              	;обработка ошибки
 176  813E DA B0 81     	jp c,key_enter_ex
 177  8141
 178  8141 DD 7E 00     	ld a,(ix)
 179  8144              	OS_PROC_SET_FOCUS ;на передний план
 179  8144 0E 12       >    ld c,#12
 179  8146 E7          >    rst #20
 180  8147 C3 B0 81     	jp key_enter_ex
 181  814A
 182  814A
 183  814A
 184  814A              key_enter_1
 185  814A              	;проверка расширения VGZ
 186  814A CD 0E 83     	call check_vgz
 187  814D C2 57 81     	jp nz,key_enter_2_1
 188  8150
 189  8150 3E 7A        	ld a,"z" ;код формата
 190  8152 CD E5 89     	call start_gplay
 191  8155
 192  8155 18 59        	jr key_enter_ex
 193  8157
 194  8157
 195  8157              key_enter_2_1
 196  8157              	;проверка расширения VGM
 197  8157 CD EF 82     	call check_vgm
 198  815A C2 64 81     	jp nz,key_enter_2
 199  815D
 200  815D 3E 76        	ld a,"v" ;код формата
 201  815F CD E5 89     	call start_gplay
 202  8162
 203  8162 18 4C        	jr key_enter_ex
 204  8164
 205  8164
 206  8164              key_enter_2
 207  8164              	;проверка расширения SCR
 208  8164 CD 2D 83     	call check_scr
 209  8167 C2 A3 81     	jp nz,key_enter_3
 210  816A
 211  816A
 212  816A 21 0C 9B     	ld hl,file_name_cur		;строка с именем
 213  816D              	OS_FILE_OPEN
 213  816D 0E 21       >    ld c,#21
 213  816F E7          >    rst #20
 214  8170 30 09        	jr nc,key_enter_2_file_open_ok
 215  8172              key_enter_2_file_error
 216  8172 21 E1 9D     	ld hl,msg_file_error
 217  8175              	OS_PRINTZ
 217  8175 0E 09       >    ld c,#09
 217  8177 E7          >    rst #20
 218  8178              	; ld b,2*50
 219  8178              	; call delay1
 220  8178 C3 B0 81     	jp key_enter_ex
 221  817B
 222  817B              key_enter_2_file_open_ok
 223  817B 32 1D 9D     	ld (file_id_cur_r),a
 224  817E
 225  817E 3A 1E 9D     	ld a,(page_ext01) ;доп страница
 226  8181              	OS_SET_PAGE_SLOT3
 226  8181 0E 1C       >    ld c,#1c
 226  8183 E7          >    rst #20
 227  8184
 228  8184 3A 1D 9D     	ld a,(file_id_cur_r)
 229  8187 11 00 1B     	ld de,6912
 230  818A 21 00 C0     	ld hl,#c000
 231  818D              	;ld a,(file_id_cur_r)
 232  818D              	OS_FILE_READ ;загрузить
 232  818D 0E 23       >    ld c,#23
 232  818F E7          >    rst #20
 233  8190 38 E0        	jr c,key_enter_2_file_error
 234  8192 3A 1D 9D     	ld a,(file_id_cur_r)
 235  8195              	OS_FILE_CLOSE
 235  8195 0E 25       >    ld c,#25
 235  8197 E7          >    rst #20
 236  8198
 237  8198 CD DF 9A     	call display ;показать
 238  819B
 239  819B
 240  819B 3A 1F 9D     	ld a,(page_main) ;основная страница
 241  819E              	OS_SET_PAGE_SLOT3
 241  819E 0E 1C       >    ld c,#1c
 241  81A0 E7          >    rst #20
 242  81A1
 243  81A1 18 0D        	jr key_enter_ex
 244  81A3
 245  81A3
 246  81A3              key_enter_3
 247  81A3              	;проверка расширения MOD
 248  81A3 CD 4C 83     	call check_mod
 249  81A6 C2 B0 81     	jp nz,key_enter_4
 250  81A9
 251  81A9 3E 6D        	ld a,"m" ;код формата
 252  81AB CD E5 89     	call start_gplay
 253  81AE
 254  81AE 18 00        	jr key_enter_ex
 255  81B0
 256  81B0
 257  81B0
 258  81B0
 259  81B0              key_enter_4
 260  81B0
 261  81B0
 262  81B0
 263  81B0
 264  81B0              key_enter_ex
 265  81B0 C3 5C 80     	jp nc_wait
 266  81B3
 267  81B3
 268  81B3
 269  81B3
 270  81B3
 271  81B3
 272  81B3
 273  81B3              nc_play_all
 274  81B3              	;Воспроизведение всего по порядку
 275  81B3 2A 08 9B     	ld hl,(file_r_all)
 276  81B6 7D           	ld a,l
 277  81B7 B4           	or h
 278  81B8 CA 04 82     	jp z,nc_play_ex ;защита
 279  81BB 2A 1A 9D     	ld hl,(file_r_num_cur)
 280  81BE CD 2B 82     	call calc_deskr
 281  81C1 DD 7E 0B     	ld a,(ix+#0b)
 282  81C4 FE 10        	cp #10 ;признак каталога
 283  81C6 28 3F        	jr z,nc_play_all_down
 284  81C8
 285  81C8 FE 30        	cp #30 ;признак каталога
 286  81CA 28 3B        	jr z,nc_play_all_down
 287  81CC
 288  81CC
 289  81CC CD 24 86     	call format_name
 290  81CF
 291  81CF              nc_play_1
 292  81CF              	;проверка расширения ;VGM
 293  81CF CD EF 82     	call check_vgm
 294  81D2 C2 E8 81     	jp nz,nc_play_2
 295  81D5
 296  81D5 3E 76        	ld a,"v"
 297  81D7 CD E5 89     	call start_gplay
 298  81DA
 299  81DA              nc_play_1_next
 300  81DA
 301  81DA FE 73        	cp "s"
 302  81DC 28 26        	jr z,nc_play_ex
 303  81DE FE 53        	cp "S"
 304  81E0 28 22        	jr z,nc_play_ex
 305  81E2 FE 18        	cp 24 ;break
 306  81E4 28 1E        	jr z,nc_play_ex
 307  81E6
 308  81E6 18 1F        	jr nc_play_all_down
 309  81E8
 310  81E8              nc_play_2
 311  81E8              	;проверка расширения ;VGZ
 312  81E8 CD 0E 83     	call check_vgz
 313  81EB C2 F5 81     	jp nz,nc_play_3
 314  81EE
 315  81EE 3E 7A        	ld a,"z"
 316  81F0 CD E5 89     	call start_gplay
 317  81F3
 318  81F3 18 E5        	jr nc_play_1_next
 319  81F5
 320  81F5
 321  81F5              nc_play_3
 322  81F5              	;проверка расширения MOD
 323  81F5 CD 4C 83     	call check_mod
 324  81F8 C2 02 82     	jp nz,nc_play_4
 325  81FB
 326  81FB 3E 6D        	ld a,"m"
 327  81FD CD E5 89     	call start_gplay
 328  8200
 329  8200 18 D8        	jr nc_play_1_next
 330  8202
 331  8202
 332  8202
 333  8202
 334  8202              nc_play_4
 335  8202 18 03        	jr nc_play_all_down
 336  8204
 337  8204
 338  8204
 339  8204              nc_play_ex
 340  8204 C3 5C 80     	jp nc_wait
 341  8207
 342  8207
 343  8207              nc_play_all_down ;вниз по списку
 344  8207 ED 4B 1A 9D  	ld bc,(file_r_num_cur)
 345  820B C5           	push bc
 346  820C CD 38 82     	call key_down
 347  820F CD 6B 83     	call print_panel_r ;обновить каталог
 348  8212 C1           	pop bc
 349  8213 2A 1A 9D     	ld hl,(file_r_num_cur)
 350  8216 A7           	and a
 351  8217 ED 42        	sbc hl,bc ;если не сдвинулась позиция, то всё
 352  8219 28 E9        	jr z,nc_play_ex
 353  821B C3 B3 81     	jp nc_play_all
 354  821E
 355  821E
 356  821E
 357  821E
 358  821E
 359  821E
 360  821E
 361  821E
 362  821E              key_enter_dir
 363  821E              	;тут открытие папки
 364  821E
 365  821E              	;call format_name_dir
 366  821E EB           	ex de,hl ;de - дескриптор для открытия
 367  821F 21 0C 9C     	ld hl,dir_name_cur
 368  8222              	OS_DIR_OPEN
 368  8222 0E 27       >    ld c,#27
 368  8224 E7          >    rst #20
 369  8225 38 89        	jr c,key_enter_ex ;если ошибка, ничего не делаем
 370  8227
 371  8227 E1           	pop hl ;отменить возврат
 372  8228 C3 23 80     	jp start_nc_warm ;перезагрузить папку
 373  822B
 374  822B
 375  822B              ; format_name_dir
 376  822B              	; push hl
 377  822B              	; ld hl,file_name_cur
 378  822B              	; ld de,file_name_cur+1 ;почистить
 379  822B              	; ld bc,256-1
 380  822B              	; ld (hl),0
 381  822B              	; ldir
 382  822B
 383  822B              	; pop hl
 384  822B
 385  822B              	; ld de,file_name_cur ;куда
 386  822B              	; ld bc,#08ff
 387  822B              ; format_name_dir_cl
 388  822B              	; ld a,(hl)
 389  822B              	; cp " "+1
 390  822B              	; jr c,format_name_dir_skip
 391  822B              	; ldi
 392  822B              	; djnz format_name_dir_cl
 393  822B              ; format_name_dir_skip
 394  822B              	; ld a,'/'
 395  822B              	; ld (de),a
 396  822B              	; ret
 397  822B
 398  822B               ;вычислить дескриптор текущего элемента справа
 399  822B              calc_deskr
 400  822B 29           	add hl,hl ;*2
 401  822C 01 41 B9     	ld bc,cat_index
 402  822F 09           	add hl,bc
 403  8230 5E           	ld e,(hl)
 404  8231 23           	inc hl
 405  8232 56           	ld d,(hl)
 406  8233 EB           	ex de,hl ;hl - адрес элемента
 407  8234 E5           	push hl
 408  8235 DD E1        	pop ix ;ix- адрес элемента
 409  8237 C9           	ret
 410  8238
 411  8238
 412  8238
 413  8238
 414  8238              key_down
 415  8238 2A 08 9B     	ld hl,(file_r_all)
 416  823B 7D           	ld a,l
 417  823C B4           	or h
 418  823D CA 71 82     	jp z,key_down_ex ;защита
 419  8240
 420  8240 ED 4B 1A 9D  	ld bc,(file_r_num_cur)
 421  8244 03           	inc bc
 422  8245 2A 08 9B     	ld hl,(file_r_all)
 423  8248              	;если не больше чем всего
 424  8248 A7           	and a
 425  8249 ED 42        	sbc hl,bc
 426  824B 38 24        	jr c,key_down_skip
 427  824D 28 22        	jr z,key_down_skip
 428  824F              	;прибавить
 429  824F ED 43 1A 9D  	ld (file_r_num_cur),bc
 430  8253
 431  8253              	;теперь передвинуть фокус, если надо
 432  8253 2A 0A 9B     	ld hl,(file_r_cur_focus)
 433  8256 01 16 00     	ld bc,panel_hight
 434  8259 09           	add hl,bc ;прибавить количество видимых
 435  825A ED 4B 1A 9D  	ld bc,(file_r_num_cur)
 436  825E A7           	and a
 437  825F ED 42        	sbc hl,bc ;вычесть положение курсора
 438  8261 28 02        	jr z,key_down_change_focus_yes
 439  8263 30 07        	jr nc,key_down_change_focus_no
 440  8265              key_down_change_focus_yes
 441  8265              	;передвинуть фокус
 442  8265 2A 0A 9B     	ld hl,(file_r_cur_focus)
 443  8268 23           	inc hl
 444  8269 22 0A 9B     	ld (file_r_cur_focus),hl
 445  826C
 446  826C              key_down_change_focus_no
 447  826C 3E 01        	ld a,1
 448  826E 32 21 9D     	ld (print_panel_r_flag),a
 449  8271              	;call print_panel_r ;обновить каталог
 450  8271              key_down_skip
 451  8271
 452  8271              key_down_ex
 453  8271 3A 1C 9D     	ld a,(key_pressed)
 454  8274 C9           	ret
 455  8275
 456  8275
 457  8275
 458  8275              key_up ;вверх
 459  8275 2A 08 9B     	ld hl,(file_r_all)
 460  8278 7D           	ld a,l
 461  8279 B4           	or h
 462  827A CA A4 82     	jp z,key_up_ex ;защита
 463  827D
 464  827D 2A 1A 9D     	ld hl,(file_r_num_cur)
 465  8280 7D           	ld a,l
 466  8281 B4           	or h
 467  8282 28 20        	jr z,key_up_skip
 468  8284 2B           	dec hl
 469  8285 22 1A 9D     	ld (file_r_num_cur),hl
 470  8288
 471  8288              	;теперь передвинуть фокус, если надо
 472  8288 2A 1A 9D     	ld hl,(file_r_num_cur)
 473  828B              	; ld bc,panel_hight
 474  828B              	; add hl,bc ;прибавить количество видимых
 475  828B ED 4B 0A 9B  	ld bc,(file_r_cur_focus)
 476  828F A7           	and a
 477  8290 ED 42        	sbc hl,bc ;вычесть положение курсора
 478  8292              	;jr z,key_up_change_foces_yes
 479  8292 30 0B        	jr nc,key_up_change_foces_no
 480  8294              key_up_change_foces_yes
 481  8294              	;передвинуть фокус
 482  8294 2A 0A 9B     	ld hl,(file_r_cur_focus)
 483  8297 7C           	ld a,h
 484  8298 B5           	or l
 485  8299 28 04        	jr z,key_up_change_foces_no ;защита
 486  829B 2B           	dec hl
 487  829C 22 0A 9B     	ld (file_r_cur_focus),hl
 488  829F
 489  829F              key_up_change_foces_no
 490  829F
 491  829F 3E 01        	ld a,1
 492  82A1 32 21 9D     	ld (print_panel_r_flag),a
 493  82A4              	;call print_panel_r ;обновить каталог
 494  82A4              key_up_skip
 495  82A4
 496  82A4              key_up_ex
 497  82A4 3A 1C 9D     	ld a,(key_pressed)
 498  82A7 C9           	ret
 499  82A8
 500  82A8
 501  82A8              key_left ;на страницу назад
 502  82A8 06 15        	ld b,panel_hight-1
 503  82AA              key_left_cl
 504  82AA C5           	push bc
 505  82AB CD 75 82     	call key_up
 506  82AE C1           	pop bc
 507  82AF 10 F9        	djnz key_left_cl
 508  82B1 3E 01        	ld a,1
 509  82B3 32 21 9D     	ld (print_panel_r_flag),a
 510  82B6 3A 1C 9D     	ld a,(key_pressed)
 511  82B9 C9           	ret
 512  82BA
 513  82BA
 514  82BA
 515  82BA              key_right ;на страницу вперёд
 516  82BA 06 15        	ld b,panel_hight-1
 517  82BC              key_right_cl
 518  82BC C5           	push bc
 519  82BD CD 38 82     	call key_down
 520  82C0 C1           	pop bc
 521  82C1 10 F9        	djnz key_right_cl
 522  82C3 3E 01        	ld a,1
 523  82C5 32 21 9D     	ld (print_panel_r_flag),a
 524  82C8 3A 1C 9D     	ld a,(key_pressed)
 525  82CB C9           	ret
 526  82CC
 527  82CC
 528  82CC
 529  82CC              exit ;выход в DOS
 530  82CC AF           	xor a
 531  82CD              	OS_PROC_CLOSE
 531  82CD 0E 13       >    ld c,#13
 531  82CF E7          >    rst #20
 532  82D0
 533  82D0
 534  82D0
 535  82D0              check_apg ;проверка на расширение APG
 536  82D0 DD 7E 08     	ld a,(ix+8)
 537  82D3 FE 61        	cp "a"
 538  82D5 28 03        	jr z,check_apg1
 539  82D7 FE 41        	cp "A"
 540  82D9 C0           	ret nz
 541  82DA              check_apg1
 542  82DA DD 7E 09     	ld a,(ix+9)
 543  82DD FE 70        	cp "p"
 544  82DF 28 03        	jr z,check_apg2
 545  82E1 FE 50        	cp "P"
 546  82E3 C0           	ret nz
 547  82E4              check_apg2
 548  82E4 DD 7E 0A     	ld a,(ix+10)
 549  82E7 FE 67        	cp "g"
 550  82E9 C8           	ret z
 551  82EA FE 47        	cp "G"
 552  82EC C0           	ret nz
 553  82ED AF           	xor a ;равен
 554  82EE C9           	ret
 555  82EF
 556  82EF
 557  82EF              check_vgm ;проверка на расширение VGM
 558  82EF DD 7E 08     	ld a,(ix+8)
 559  82F2 FE 76        	cp "v"
 560  82F4 28 03        	jr z,check_vgm1
 561  82F6 FE 56        	cp "V"
 562  82F8 C0           	ret nz
 563  82F9              check_vgm1
 564  82F9 DD 7E 09     	ld a,(ix+9)
 565  82FC FE 67        	cp "g"
 566  82FE 28 03        	jr z,check_vgm2
 567  8300 FE 47        	cp "G"
 568  8302 C0           	ret nz
 569  8303              check_vgm2
 570  8303 DD 7E 0A     	ld a,(ix+10)
 571  8306 FE 6D        	cp "m"
 572  8308 C8           	ret z
 573  8309 FE 4D        	cp "M"
 574  830B C0           	ret nz
 575  830C AF           	xor a ;равен
 576  830D C9           	ret
 577  830E
 578  830E              check_vgz ;проверка на расширение VGZ
 579  830E DD 7E 08     	ld a,(ix+8)
 580  8311 FE 76        	cp "v"
 581  8313 28 03        	jr z,check_vgz1
 582  8315 FE 56        	cp "V"
 583  8317 C0           	ret nz
 584  8318              check_vgz1
 585  8318 DD 7E 09     	ld a,(ix+9)
 586  831B FE 67        	cp "g"
 587  831D 28 03        	jr z,check_vgz2
 588  831F FE 47        	cp "G"
 589  8321 C0           	ret nz
 590  8322              check_vgz2
 591  8322 DD 7E 0A     	ld a,(ix+10)
 592  8325 FE 7A        	cp "z"
 593  8327 C8           	ret z
 594  8328 FE 5A        	cp "Z"
 595  832A C0           	ret nz
 596  832B AF           	xor a ;равен
 597  832C C9           	ret
 598  832D
 599  832D
 600  832D              check_scr ;проверка на расширение SCR
 601  832D DD 7E 08     	ld a,(ix+8)
 602  8330 FE 73        	cp "s"
 603  8332 28 03        	jr z,check_scr1
 604  8334 FE 53        	cp "S"
 605  8336 C0           	ret nz
 606  8337              check_scr1
 607  8337 DD 7E 09     	ld a,(ix+9)
 608  833A FE 63        	cp "c"
 609  833C 28 03        	jr z,check_scr2
 610  833E FE 43        	cp "C"
 611  8340 C0           	ret nz
 612  8341              check_scr2
 613  8341 DD 7E 0A     	ld a,(ix+10)
 614  8344 FE 72        	cp "r"
 615  8346 C8           	ret z
 616  8347 FE 52        	cp "R"
 617  8349 C0           	ret nz
 618  834A AF           	xor a ;равен
 619  834B C9           	ret
 620  834C
 621  834C              check_mod ;проверка на расширение MOD
 622  834C DD 7E 08     	ld a,(ix+8)
 623  834F FE 6D        	cp "m"
 624  8351 28 03        	jr z,check_mod1
 625  8353 FE 4D        	cp "M"
 626  8355 C0           	ret nz
 627  8356              check_mod1
 628  8356 DD 7E 09     	ld a,(ix+9)
 629  8359 FE 6F        	cp "o"
 630  835B 28 03        	jr z,check_mod2
 631  835D FE 4F        	cp "O"
 632  835F C0           	ret nz
 633  8360              check_mod2
 634  8360 DD 7E 0A     	ld a,(ix+10)
 635  8363 FE 64        	cp "d"
 636  8365 C8           	ret z
 637  8366 FE 44        	cp "D"
 638  8368 C0           	ret nz
 639  8369 AF           	xor a ;равен
 640  836A C9           	ret
 641  836B
 642  836B
 643  836B
 644  836B              print_panel_r ;печать правой панели
 645  836B              	;ld ix,buffer_cat
 646  836B FD 2A 08 9B  	ld iy,(file_r_all) ;всего файлов
 647  836F FD 7D        	ld a,iyl
 648  8371 FD B4        	or iyh
 649  8373 C8           	ret z ;защита если 0
 650  8374 11 29 01     	ld de,panel_r_xy ;координаты yx
 651  8377 06 16        	ld b,panel_hight ;высота панели
 652  8379 FD 2A 0A 9B  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 653  837D              print_panel_r_cl ;цикл
 654  837D C5           	push bc
 655  837E D5           	push de ;xy
 656  837F              	OS_SET_XY
 656  837F 0E 01       >    ld c,#01
 656  8381 E7          >    rst #20
 657  8382
 658  8382              	;получить адрес элемента
 659  8382 FD E5        	push iy
 660  8384 E1           	pop hl
 661  8385 CD 2B 82     	call calc_deskr
 662  8388
 663  8388 CD A3 83     	call print_file_info ;напечатать строку
 664  838B              print_panel_r_skip
 665  838B D1           	pop de
 666  838C 14           	inc d ;y++
 667  838D FD 23        	inc iy ;текущий файл
 668  838F              	;проверка на конец каталога
 669  838F 2A 08 9B     	ld hl,(file_r_all)
 670  8392 FD E5        	push iy
 671  8394 C1           	pop bc
 672  8395 A7           	and a
 673  8396 ED 42        	sbc hl,bc
 674  8398 C1           	pop bc
 675  8399 38 07        	jr c,print_panel_r_ex2
 676  839B 28 05        	jr z,print_panel_r_ex2
 677  839D 10 DE        	djnz print_panel_r_cl
 678  839F C9           	ret
 679  83A0              print_panel_r_ex
 680  83A0 D1           	pop de
 681  83A1 C1           	pop bc
 682  83A2              print_panel_r_ex2
 683  83A2              	;тут, возможно, надо допечатать пустые строки
 684  83A2 C9           	ret
 685  83A3
 686  83A3
 687  83A3
 688  83A3
 689  83A3
 690  83A3              print_file_info ;печать строки о файле
 691  83A3 3A 23 86     	ld a,(LFN_enable_flag)
 692  83A6 B7           	or a
 693  83A7 28 4D        	jr z,print_file_info_SFN
 694  83A9
 695  83A9
 696  83A9
 697  83A9              print_file_info_LFN ;печать длинного имени
 698  83A9              	;узнать номер записи
 699  83A9 01 00 C0     	ld bc,#c000
 700  83AC A7           	and a
 701  83AD ED 42        	sbc hl,bc
 702  83AF              ;разделить на 32
 703  83AF CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 704  83B1 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 705  83B3 CB 3C        	srl h ; /4
 706  83B5 CB 1D        	rr l ;
 707  83B7 CB 3C        	srl h ; /8
 708  83B9 CB 1D        	rr l ;
 709  83BB CB 3C        	srl h ; /16
 710  83BD CB 1D        	rr l ;
 711  83BF CB 3C        	srl h ; /32
 712  83C1 CB 1D        	rr l ;
 713  83C3
 714  83C3
 715  83C3 EB           	ex de,hl ;de - порядковый номер записи
 716  83C4
 717  83C4 21 41 C1     	ld hl,file_info_string ;куда
 718  83C7              	OS_GET_LFN ;получить длинное имя
 718  83C7 0E 2A       >    ld c,#2a
 718  83C9 E7          >    rst #20
 719  83CA
 720  83CA CD 1E 84     	call get_color_item
 721  83CD
 722  83CD 06 0C        	ld b,#c
 723  83CF              	OS_SET_COLOR
 723  83CF 0E 06       >    ld c,#06
 723  83D1 E7          >    rst #20
 724  83D2
 725  83D2              	;печать не длиннее 80/2 символов
 726  83D2 21 41 C1     	ld hl,file_info_string
 727  83D5 06 26        	ld b,80/2-2
 728  83D7 0E 28        	ld c,40 ;колонка
 729  83D9              print_file_info_LFN_cl
 730  83D9 E5           	push hl
 731  83DA C5           	push bc
 732  83DB 7E           	ld a,(hl)
 733  83DC B7           	or a
 734  83DD 28 09        	jr z,print_file_info_LFN_cl_ex
 735  83DF              	OS_PRINT_CHARF
 735  83DF D7          >	rst #10
 736  83E0 C1           	pop bc
 737  83E1 0C           	inc c
 738  83E2 E1           	pop hl
 739  83E3 23           	inc hl
 740  83E4 10 F3        	djnz print_file_info_LFN_cl
 741  83E6 18 02        	jr print_file_info_LFN_ex
 742  83E8              print_file_info_LFN_cl_ex
 743  83E8 C1           	pop bc
 744  83E9 E1           	pop hl
 745  83EA              print_file_info_LFN_ex
 746  83EA              	;допечатать пробелы до правого края, зависит от длины имени
 747  83EA              print_file_info_LFN_cl2
 748  83EA 79           	ld a,c
 749  83EB FE 4E        	cp 80-2
 750  83ED D0           	ret nc
 751  83EE C5           	push bc
 752  83EF 3E 20        	ld a,' '
 753  83F1              	OS_PRINT_CHARF
 753  83F1 D7          >	rst #10
 754  83F2 C1           	pop bc
 755  83F3 0C           	inc c
 756  83F4 18 F4        	jr print_file_info_LFN_cl2
 757  83F6
 758  83F6
 759  83F6
 760  83F6              print_file_info_SFN ;печать короткого имени
 761  83F6 11 41 C1     	ld de,file_info_string ;скопировать
 762  83F9 01 08 00     	ld bc,8 ;file_info_lenght
 763  83FC ED B0        	ldir
 764  83FE 3E 20        	ld a,' '
 765  8400 12           	ld (de),a
 766  8401 13           	inc de
 767  8402 01 03 00     	ld bc,3
 768  8405 ED B0        	ldir
 769  8407 AF           	xor a
 770  8408 12           	ld (de),a
 771  8409
 772  8409 CD 1E 84     	call get_color_item
 773  840C
 774  840C 06 0C        	ld b,#c
 775  840E              	OS_SET_COLOR
 775  840E 0E 06       >    ld c,#06
 775  8410 E7          >    rst #20
 776  8411 21 41 C1     	ld hl,file_info_string
 777  8414              	OS_PRINTZ
 777  8414 0E 09       >    ld c,#09
 777  8416 E7          >    rst #20
 778  8417              	;допечатать пробелы до правого края, длина имени постоянная
 779  8417 21 22 9D     	ld hl,file_info_string_SFN_end
 780  841A              	OS_PRINTZ
 780  841A 0E 09       >    ld c,#09
 780  841C E7          >    rst #20
 781  841D C9           	ret
 782  841E
 783  841E
 784  841E
 785  841E              get_color_item ;получить цвет элемента
 786  841E              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 787  841E              ;вых: A - цвет
 788  841E ED 4B 1A 9D  	ld bc,(file_r_num_cur) ;позиция курсора справа
 789  8422 FD E5        	push iy
 790  8424 E1           	pop hl
 791  8425 A7           	and a
 792  8426 ED 42        	sbc hl,bc ;сравнить
 793  8428 28 11        	jr z,get_color_item_no_cursor
 794  842A              	;цвета курсора
 795  842A 3E 0E        	ld a,color_dir ;простая
 796  842C 32 56 84     	ld (get_color_item_dir+1),a
 797  842F 3E 0C        	ld a,color_apg ;простая
 798  8431 32 5E 84     	ld (get_color_item_apg+1),a
 799  8434 3E 0F        	ld a,color_backgr ;простая
 800  8436 32 61 84     	ld (get_color_item_backgr+1),a
 801  8439 18 0F        	jr get_color_item_set
 802  843B
 803  843B              get_color_item_no_cursor
 804  843B              	;цвета обычные
 805  843B 3E 28        	ld a,color_dir_hi ;под курсором
 806  843D 32 56 84     	ld (get_color_item_dir+1),a
 807  8440 3E 28        	ld a,color_apg_hi ;под курсором
 808  8442 32 5E 84     	ld (get_color_item_apg+1),a
 809  8445 3E 28        	ld a,color_backgr_hi ;под курсором
 810  8447 32 61 84     	ld (get_color_item_backgr+1),a
 811  844A
 812  844A              get_color_item_set
 813  844A              	;задать цвет
 814  844A DD 7E 0B     	ld a,(ix+#0b)
 815  844D FE 10        	cp #10 ;признак каталога
 816  844F 28 04        	jr z,get_color_item_dir
 817  8451 FE 30        	cp #30 ;признак каталога
 818  8453 20 03        	jr nz,get_color_item_no_dir
 819  8455              	;если папка
 820  8455              get_color_item_dir
 821  8455 3E 00        	ld a,0
 822  8457 C9           	ret
 823  8458
 824  8458              get_color_item_no_dir
 825  8458 CD D0 82     	call check_apg ;расширение apg
 826  845B 20 03        	jr nz,get_color_item_no_apg
 827  845D              	;если приложение
 828  845D              get_color_item_apg
 829  845D 3E 00        	ld a,0
 830  845F C9           	ret
 831  8460
 832  8460              get_color_item_no_apg
 833  8460              	;если обычный файл
 834  8460              get_color_item_backgr
 835  8460 3E 00        	ld a,0
 836  8462 C9           	ret
 837  8463
 838  8463
 839  8463
 840  8463              ; format_dir ;подготовить каталог, убрать лишнее
 841  8463              	; ; ld a,2
 842  8463              	; ; out (254),a
 843  8463              	; ld iy,0 ;счётчик файлов
 844  8463              	; ;найти конец каталога
 845  8463              	; ld hl,buffer_cat
 846  8463              	; ld a,(hl)
 847  8463              	; or a
 848  8463              	; ret z ;защита
 849  8463              	; ld bc,32
 850  8463              ; format_dir_prep_cl
 851  8463              	; ld a,(hl)
 852  8463              	; or a
 853  8463              	; jr z,format_dir_prep_ex
 854  8463              	; add hl,bc
 855  8463              	; ld a,h
 856  8463              	; or a ;если вышли за границу
 857  8463              	; jr z,format_dir_prep_ex
 858  8463              	; jr format_dir_prep_cl
 859  8463              ; format_dir_prep_ex
 860  8463              	; ld bc,32
 861  8463              	; and a
 862  8463              	; sbc hl,bc
 863  8463              	; ld (format_dir_top),hl ;конец каталога
 864  8463
 865  8463
 866  8463
 867  8463              	; ld ix,buffer_cat
 868  8463              	; ;ld b,panel_hight ;высота панели
 869  8463              ; format_dir_cl ;цикл
 870  8463              	; ld a,(ix)
 871  8463              	; or a ;конец каталога
 872  8463              	; jr z,format_dir_ex
 873  8463              	; cp #e5 ;удалённый
 874  8463              	; jr z,format_dir_skip
 875  8463              	; cp #05 ;удалённый
 876  8463              	; jr z,format_dir_skip
 877  8463              	; ld a,(ix+#0b)
 878  8463              	; cp #0f ;длинный
 879  8463              	; jr z,format_dir_skip
 880  8463
 881  8463              	; ;проверка на папку "." (этот же каталог)
 882  8463              	; ld a,(ix+#00)
 883  8463              	; cp "." ;
 884  8463              	; jr nz,format_dir_add
 885  8463              	; ld a,(ix+#01)
 886  8463              	; cp " " ;
 887  8463              	; jr z,format_dir_skip
 888  8463
 889  8463
 890  8463              ; format_dir_add
 891  8463              	; inc iy ;++
 892  8463              	; ld bc,32 ;на другой элемент каталога
 893  8463              	; add ix,bc
 894  8463              	; ld a,ixh
 895  8463              	; or a ;если вышли за границу
 896  8463              	; jr z,format_dir_ex
 897  8463              	; jr format_dir_cl
 898  8463              ; format_dir_skip
 899  8463              	; ;сдвинуть элементы вниз
 900  8463              	; push ix
 901  8463              	; push ix
 902  8463              	; pop hl
 903  8463              	; pop de ;куда
 904  8463              	; ld hl,(format_dir_top) ;0-32
 905  8463              	; and a
 906  8463              	; sbc hl,de
 907  8463              	; ld b,h
 908  8463              	; ld c,l ;длина
 909  8463              	; push bc
 910  8463
 911  8463              	; push ix
 912  8463              	; pop hl ;откуда
 913  8463              	; ld bc,32 ;на другой элемент каталога
 914  8463              	; add hl,bc ;откуда
 915  8463
 916  8463              	; pop bc
 917  8463              	; ldir
 918  8463
 919  8463              	; xor a
 920  8463              	; ld (de),a ;очистить ненужный элемент
 921  8463
 922  8463              	; jr format_dir_cl
 923  8463
 924  8463              ; format_dir_ex
 925  8463              	; ld (file_r_all),iy
 926  8463              	; ;здесь почистить остаток каталога
 927  8463              	; ; ld a,0
 928  8463              	; ; out (254),a
 929  8463              	; ret
 930  8463              ; format_dir_top	dw 0 ;временно конец гаталога
 931  8463
 932  8463
 933  8463
 934  8463
 935  8463
 936  8463              sort_dir ;сортировка каталога с помощью построения индекса
 937  8463 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 938  8467 DD 7E 00     	ld a,(ix)
 939  846A B7           	or a
 940  846B C8           	ret z ;если пусто, выход
 941  846C FD 21 00 00  	ld iy,0 ;счётчик всего файлов
 942  8470
 943  8470
 944  8470 3A 06 86     	ld a,(sort_enable_flag)
 945  8473 B7           	or a
 946  8474 CA DB 84     	jp z,sort_dir_no ;если без сортировки
 947  8477
 948  8477 21 41 B9     	ld hl,cat_index
 949  847A 22 D7 84     	ld (sort_item_adr_end),hl
 950  847D
 951  847D 21 41 BD     	ld hl,cat_index_2 ;таблица - индекс 2
 952  8480 CD 5A 85     	call sort_dir_one ;проход по папкам
 953  8483
 954  8483 FD 7C        	ld a,iyh
 955  8485 FD B5        	or iyl
 956  8487 28 19        	jr z,sort_dir_skip ;если не было папок
 957  8489
 958  8489 DD 21 41 BD  	ld ix,cat_index_2
 959  848D CD A4 85     	call sort_index ;отсортировать по алфавиту
 960  8490              	;перенести индекс в основной
 961  8490 FD E5        	push iy
 962  8492 E1           	pop hl ;сколько
 963  8493 29           	add hl,hl ;*2 по 2 байта на элемент
 964  8494 E5           	push hl
 965  8495 C1           	pop bc
 966  8496 21 41 BD     	ld hl,cat_index_2
 967  8499 11 41 B9     	ld de,cat_index
 968  849C ED B0        	ldir
 969  849E ED 53 D7 84  	ld (sort_item_adr_end),de ;запомнить адрес последнего
 970  84A2
 971  84A2              sort_dir_skip
 972  84A2 FD 22 D9 84  	ld (sort_item_count),iy
 973  84A6 FD 21 00 00  	ld iy,0 ;счётчик всего файлов
 974  84AA 21 41 BD     	ld hl,cat_index_2 ;таблица - индекс 2
 975  84AD CD 1E 85     	call sort_file_one ;проход по файлам
 976  84B0 FD 7C        	ld a,iyh
 977  84B2 FD B5        	or iyl
 978  84B4 28 16        	jr z,sort_file_skip ;если не было файлов
 979  84B6
 980  84B6 DD 21 41 BD  	ld ix,cat_index_2
 981  84BA CD A4 85     	call sort_index ;отсортировать по алфавиту
 982  84BD              	;добавить индекс к основному
 983  84BD FD E5        	push iy
 984  84BF E1           	pop hl ;сколько
 985  84C0 29           	add hl,hl ;*2 по 2 байта на элемент
 986  84C1 E5           	push hl
 987  84C2 C1           	pop bc
 988  84C3 21 41 BD     	ld hl,cat_index_2
 989  84C6 ED 5B D7 84  	ld de,(sort_item_adr_end)
 990  84CA ED B0        	ldir
 991  84CC
 992  84CC              sort_file_skip
 993  84CC              	;скорректировать количество
 994  84CC ED 4B D9 84  	ld bc,(sort_item_count)
 995  84D0 FD 09        	add iy,bc
 996  84D2 FD 22 08 9B  	ld (file_r_all),iy
 997  84D6 C9           	ret
 998  84D7
 999  84D7 00 00        sort_item_adr_end dw 0; временно
1000  84D9 00 00        sort_item_count dw 0; временно
1001  84DB
1002  84DB
1003  84DB
1004  84DB              ;без сортировки
1005  84DB              sort_dir_no
1006  84DB 21 41 B9     	ld hl,cat_index ;таблица - индекс
1007  84DE DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1008  84E2              sort_dir_no_cl ;цикл по каталогам
1009  84E2 DD 7E 00     	ld a,(ix)
1010  84E5 B7           	or a ;конец каталога
1011  84E6 28 31        	jr z,sort_dir_no_ex
1012  84E8 FE E5        	cp #e5 ;удалённый
1013  84EA 28 22        	jr z,sort_dir_no_skip
1014  84EC FE 05        	cp #05 ;удалённый
1015  84EE 28 1E        	jr z,sort_dir_no_skip
1016  84F0 DD 7E 0B     	ld a,(ix+#0b)
1017  84F3 FE 0F        	cp #0f ;длинный
1018  84F5 28 17        	jr z,sort_dir_no_skip
1019  84F7
1020  84F7              	;проверка на папку "." (этот же каталог)
1021  84F7 DD 7E 00     	ld a,(ix+#00)
1022  84FA FE 2E        	cp "." ;
1023  84FC 20 07        	jr nz,sort_dir_no_add
1024  84FE DD 7E 01     	ld a,(ix+#01)
1025  8501 FE 20        	cp " " ;
1026  8503 28 09        	jr z,sort_dir_no_skip
1027  8505
1028  8505              sort_dir_no_add
1029  8505 FD 23        	inc iy ;++
1030  8507              	;записать в таблицу (индекс)
1031  8507 DD E5        	push ix
1032  8509 C1           	pop bc
1033  850A 71           	ld (hl),c
1034  850B 23           	inc hl
1035  850C 70           	ld (hl),b
1036  850D 23           	inc hl
1037  850E
1038  850E
1039  850E              sort_dir_no_skip
1040  850E 01 20 00     	ld bc,32
1041  8511 DD 09        	add ix,bc ;на следующий
1042  8513 DD 7C        	ld a,ixh ;проверка на конец буфера
1043  8515 FE C0        	cp #c0
1044  8517 30 C9        	jr nc,sort_dir_no_cl
1045  8519
1046  8519              sort_dir_no_ex
1047  8519 FD 22 08 9B  	ld (file_r_all),iy
1048  851D C9           	ret
1049  851E
1050  851E
1051  851E              ;сортировка файлов
1052  851E              sort_file_one
1053  851E DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1054  8522              sort_file_one_cl ;цикл по каталогам
1055  8522 DD 7E 00     	ld a,(ix)
1056  8525 B7           	or a ;конец каталога
1057  8526 28 31        	jr z,sort_file_one_ex
1058  8528 DD 7E 0B     	ld a,(ix+#0b)
1059  852B FE 10        	cp #10 ;признак каталога
1060  852D 28 1F        	jr z,sort_file_one_skip
1061  852F FE 30        	cp #30 ;признак каталога
1062  8531 28 1B        	jr z,sort_file_one_skip
1063  8533 DD 7E 00     	ld a,(ix)
1064  8536 FE E5        	cp #e5 ;удалённый
1065  8538 28 14        	jr z,sort_file_one_skip
1066  853A FE 05        	cp #05 ;удалённый
1067  853C 28 10        	jr z,sort_file_one_skip
1068  853E DD 7E 0B     	ld a,(ix+#0b)
1069  8541 FE 0F        	cp #0f ;длинный
1070  8543 28 09        	jr z,sort_file_one_skip
1071  8545
1072  8545              	; ;проверка на папку "." (этот же каталог)
1073  8545              	; ld a,(ix+#00)
1074  8545              	; cp "." ;
1075  8545              	; jr nz,sort_file_one_add
1076  8545              	; ld a,(ix+#01)
1077  8545              	; cp " " ;
1078  8545              	; jr z,sort_file_one_skip
1079  8545
1080  8545
1081  8545              sort_file_one_add
1082  8545 FD 23        	inc iy ;++
1083  8547              	;записать в таблицу (индекс)
1084  8547 DD E5        	push ix
1085  8549 C1           	pop bc
1086  854A 71           	ld (hl),c
1087  854B 23           	inc hl
1088  854C 70           	ld (hl),b
1089  854D 23           	inc hl
1090  854E
1091  854E
1092  854E              sort_file_one_skip
1093  854E 01 20 00     	ld bc,32
1094  8551 DD 09        	add ix,bc ;на следующий
1095  8553 DD 7C        	ld a,ixh ;проверка на конец буфера
1096  8555 FE C0        	cp #c0
1097  8557 30 C9        	jr nc,sort_file_one_cl
1098  8559
1099  8559              sort_file_one_ex
1100  8559              	;ld (file_r_all),iy
1101  8559 C9           	ret
1102  855A
1103  855A
1104  855A
1105  855A
1106  855A
1107  855A              ;сортировка папок
1108  855A              sort_dir_one
1109  855A DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
1110  855E              sort_dir_one_cl ;цикл по каталогам
1111  855E DD 7E 00     	ld a,(ix)
1112  8561 B7           	or a ;конец каталога
1113  8562 28 3F        	jr z,sort_dir_one_ex
1114  8564 DD 7E 0B     	ld a,(ix+#0b)
1115  8567 FE 10        	cp #10 ;признак каталога
1116  8569 28 04        	jr z,sort_dir_one_skip_no
1117  856B FE 30        	cp #30 ;признак каталога
1118  856D 20 29        	jr nz,sort_dir_one_skip
1119  856F              sort_dir_one_skip_no
1120  856F DD 7E 00     	ld a,(ix)
1121  8572 FE E5        	cp #e5 ;удалённый
1122  8574 28 22        	jr z,sort_dir_one_skip
1123  8576 FE 05        	cp #05 ;удалённый
1124  8578 28 1E        	jr z,sort_dir_one_skip
1125  857A DD 7E 0B     	ld a,(ix+#0b)
1126  857D FE 0F        	cp #0f ;длинный
1127  857F 28 17        	jr z,sort_dir_one_skip
1128  8581
1129  8581              	;проверка на папку "." (этот же каталог)
1130  8581 DD 7E 00     	ld a,(ix+#00)
1131  8584 FE 2E        	cp "." ;
1132  8586 20 07        	jr nz,sort_dir_one_add
1133  8588 DD 7E 01     	ld a,(ix+#01)
1134  858B FE 20        	cp " " ;
1135  858D 28 09        	jr z,sort_dir_one_skip
1136  858F
1137  858F              sort_dir_one_add
1138  858F FD 23        	inc iy ;++
1139  8591              	;записать в таблицу (индекс)
1140  8591 DD E5        	push ix
1141  8593 C1           	pop bc
1142  8594 71           	ld (hl),c
1143  8595 23           	inc hl
1144  8596 70           	ld (hl),b
1145  8597 23           	inc hl
1146  8598
1147  8598
1148  8598              sort_dir_one_skip
1149  8598 01 20 00     	ld bc,32
1150  859B DD 09        	add ix,bc ;на следующий
1151  859D DD 7C        	ld a,ixh ;проверка на конец буфера
1152  859F FE C0        	cp #c0
1153  85A1 30 BB        	jr nc,sort_dir_one_cl
1154  85A3
1155  85A3              sort_dir_one_ex
1156  85A3              	;ld (file_r_all),iy
1157  85A3 C9           	ret
1158  85A4
1159  85A4
1160  85A4
1161  85A4              ;сортировка индекса методом пузырька
1162  85A4              ;вх: iy - сколько (>1)
1163  85A4              ;вх: ix - адрес таблицы
1164  85A4              sort_index
1165  85A4 FD 7C        	ld a,iyh ;проверка, число элементов должно быть > 1
1166  85A6 B7           	or a
1167  85A7 20 05        	jr nz,sort_index1
1168  85A9 FD 7D        	ld a,iyl
1169  85AB FE 02        	cp 2
1170  85AD D8           	ret c
1171  85AE              sort_index1
1172  85AE FD E5        	push iy
1173  85B0 C1           	pop bc ;цикл проходов общий
1174  85B1 0B           	dec bc ;-1
1175  85B2
1176  85B2              sort_index_cl_gen ;цикл основной
1177  85B2 C5           	push bc
1178  85B3 DD E5        	push ix
1179  85B5
1180  85B5 FD E5        	push iy
1181  85B7 C1           	pop bc ;внутренний цикл столько же
1182  85B8 0B           	dec bc ;-1
1183  85B9              sort_index_cl ;цикл внутренний
1184  85B9              	;первый элемент узнать адрес записи в каталоге
1185  85B9 DD 5E 00     	ld e,(ix+00)
1186  85BC DD 56 01     	ld d,(ix+01)
1187  85BF 1A           	ld a,(de) ;первая буква имени
1188  85C0              	;второй элемент узнать адрес записи в каталоге
1189  85C0 DD 6E 02     	ld l,(ix+02)
1190  85C3 DD 66 03     	ld h,(ix+03)
1191  85C6              	;сравнить с другой первой буквой
1192  85C6 BE           	cp (hl)
1193  85C7 38 0C        	jr c,sort_index_cl_skip
1194  85C9              	;поменять местами элементы индекса
1195  85C9 DD 75 00     	ld (ix+00),l
1196  85CC DD 74 01     	ld (ix+01),h
1197  85CF DD 73 02     	ld (ix+02),e
1198  85D2 DD 72 03     	ld (ix+03),d
1199  85D5
1200  85D5              sort_index_cl_skip
1201  85D5              	;следующий
1202  85D5 DD 23        	inc ix
1203  85D7 DD 23        	inc ix
1204  85D9
1205  85D9 0B           	dec bc
1206  85DA 78           	ld a,b
1207  85DB B1           	or c
1208  85DC 20 DB        	jr nz,sort_index_cl
1209  85DE
1210  85DE DD E1        	pop ix
1211  85E0 C1           	pop bc
1212  85E1 0B           	dec bc
1213  85E2 78           	ld a,b
1214  85E3 B1           	or c
1215  85E4 20 CC        	jr nz,sort_index_cl_gen
1216  85E6
1217  85E6 C9           	ret
1218  85E7
1219  85E7
1220  85E7
1221  85E7
1222  85E7              sort_toggle ;переключение сортировки
1223  85E7 3A 06 86     	ld a,(sort_enable_flag)
1224  85EA EE 01        	xor 1
1225  85EC 32 06 86     	ld (sort_enable_flag),a
1226  85EF 3E 66        	ld a,"f" ;вкл
1227  85F1 20 02        	jr nz,sort_toggle1
1228  85F3 3E 4E        	ld a,"N";выкл
1229  85F5              sort_toggle1
1230  85F5 32 D9 9D     	ld (msg_menu_main2+5),a
1231  85F8
1232  85F8 CD 63 84     	call sort_dir
1233  85FB CD 8E 86     	call print_menu_main
1234  85FE 3E 01        	ld a,1
1235  8600 32 21 9D     	ld (print_panel_r_flag),a
1236  8603
1237  8603 C3 5C 80     	jp nc_wait
1238  8606 00           sort_enable_flag db 0 ;флаг сортировки
1239  8607
1240  8607
1241  8607
1242  8607
1243  8607              LFN_toggle ;переключение сортировки
1244  8607 3A 23 86     	ld a,(LFN_enable_flag)
1245  860A EE 01        	xor 1
1246  860C 32 23 86     	ld (LFN_enable_flag),a
1247  860F 3E 66        	ld a,"f" ;вкл
1248  8611 20 02        	jr nz,LFN_toggle1
1249  8613 3E 4E        	ld a,"N";выкл
1250  8615              LFN_toggle1
1251  8615 32 D2 9D     	ld (msg_menu_main1+5),a
1252  8618
1253  8618              	;call sort_dir
1254  8618 CD 8E 86     	call print_menu_main
1255  861B 3E 01        	ld a,1
1256  861D 32 21 9D     	ld (print_panel_r_flag),a
1257  8620
1258  8620 C3 5C 80     	jp nc_wait
1259  8623 00           LFN_enable_flag db 0 ;флаг сортировки
1260  8624
1261  8624
1262  8624
1263  8624
1264  8624
1265  8624              format_name ;подогнать имя под стандарт filename.ext
1266  8624              ;вх: HL - имя в каталоге
1267  8624 E5           	push hl
1268  8625 21 0C 9B     	ld hl,file_name_cur
1269  8628 11 0D 9B     	ld de,file_name_cur+1 ;почистить
1270  862B 01 FF 00     	ld bc,256-1
1271  862E 36 00        	ld (hl),0
1272  8630 ED B0        	ldir
1273  8632
1274  8632 E1           	pop hl
1275  8633 E5           	push hl
1276  8634
1277  8634 11 0C 9B     	ld de,file_name_cur ;куда
1278  8637 01 FF 08     	ld bc,#08ff
1279  863A              format_name_cl
1280  863A 7E           	ld a,(hl)
1281  863B FE 21        	cp " "+1
1282  863D 38 04        	jr c,format_name_skip
1283  863F ED A0        	ldi
1284  8641 10 F7        	djnz format_name_cl
1285  8643              format_name_skip
1286  8643 3E 2E        	ld a,"."
1287  8645 12           	ld (de),a
1288  8646
1289  8646 13           	inc de
1290  8647 E1           	pop hl
1291  8648 01 08 00     	ld bc,8 ;перейти на расширение
1292  864B 09           	add hl,bc
1293  864C
1294  864C 01 FF 03     	ld bc,#03ff
1295  864F              format_name_cl2
1296  864F 7E           	ld a,(hl)
1297  8650 FE 21        	cp " "+1
1298  8652 38 04        	jr c,format_name_skip2
1299  8654 ED A0        	ldi
1300  8656 10 F7        	djnz format_name_cl2
1301  8658              format_name_skip2
1302  8658 C9           	ret
1303  8659
1304  8659              print_rect_r ;печать рамки правой
1305  8659 3E 0F        	ld a,color_backgr ;цвет
1306  865B 06 0C        	ld b,#c
1307  865D              	OS_SET_COLOR
1307  865D 0E 06       >    ld c,#06
1307  865F E7          >    rst #20
1308  8660 11 28 00     	ld de,#0028 ;xy
1309  8663              	OS_SET_XY
1309  8663 0E 01       >    ld c,#01
1309  8665 E7          >    rst #20
1310  8666 21 3D 9D     	ld hl,rect_1
1311  8669              	OS_PRINTZ
1311  8669 0E 09       >    ld c,#09
1311  866B E7          >    rst #20
1312  866C
1313  866C 11 28 01     	ld de,#0128 ;xy
1314  866F 06 16        	ld b,24-2 ;цикл
1315  8671              print_rect_r_cl
1316  8671 C5           	push bc
1317  8672 D5           	push de
1318  8673              	OS_SET_XY
1318  8673 0E 01       >    ld c,#01
1318  8675 E7          >    rst #20
1319  8676 21 66 9D     	ld hl,rect_2
1320  8679              	OS_PRINTZ
1320  8679 0E 09       >    ld c,#09
1320  867B E7          >    rst #20
1321  867C D1           	pop de
1322  867D 14           	inc d
1323  867E C1           	pop bc
1324  867F 10 F0        	djnz print_rect_r_cl
1325  8681
1326  8681
1327  8681 11 28 17     	ld de,#1728 ;xy
1328  8684              	OS_SET_XY
1328  8684 0E 01       >    ld c,#01
1328  8686 E7          >    rst #20
1329  8687 21 8F 9D     	ld hl,rect_3
1330  868A              	OS_PRINTZ
1330  868A 0E 09       >    ld c,#09
1330  868C E7          >    rst #20
1331  868D C9           	ret
1332  868E
1333  868E              print_menu_main ;печать основного меню
1334  868E 3E 07        	ld a,color_default ;цвет
1335  8690 06 0C        	ld b,#c
1336  8692              	OS_SET_COLOR
1336  8692 0E 06       >    ld c,#06
1336  8694 E7          >    rst #20
1337  8695
1338  8695 11 00 18     	ld de,#1800+0*8
1339  8698              	OS_SET_XY
1339  8698 0E 01       >    ld c,#01
1339  869A E7          >    rst #20
1340  869B 3E 31        	ld a,"1" ;пункт 1
1341  869D              	OS_PRINT_CHARF
1341  869D D7          >	rst #10
1342  869E 11 08 18     	ld de,#1800+1*8
1343  86A1              	OS_SET_XY
1343  86A1 0E 01       >    ld c,#01
1343  86A3 E7          >    rst #20
1344  86A4 3E 32        	ld a,"2" ;пункт 2
1345  86A6              	OS_PRINT_CHARF
1345  86A6 D7          >	rst #10
1346  86A7 11 10 18     	ld de,#1800+2*8
1347  86AA              	OS_SET_XY
1347  86AA 0E 01       >    ld c,#01
1347  86AC E7          >    rst #20
1348  86AD 3E 33        	ld a,"3" ;пункт 3
1349  86AF              	OS_PRINT_CHARF
1349  86AF D7          >	rst #10
1350  86B0
1351  86B0
1352  86B0 3E 28        	ld a,color_backgr_hi ;цвет
1353  86B2 06 0C        	ld b,#c
1354  86B4              	OS_SET_COLOR
1354  86B4 0E 06       >    ld c,#06
1354  86B6 E7          >    rst #20
1355  86B7
1356  86B7 11 01 18     	ld de,#1800+0*8+1
1357  86BA              	OS_SET_XY
1357  86BA 0E 01       >    ld c,#01
1357  86BC E7          >    rst #20
1358  86BD 21 CD 9D     	ld hl,msg_menu_main1
1359  86C0              	OS_PRINTZ
1359  86C0 0E 09       >    ld c,#09
1359  86C2 E7          >    rst #20
1360  86C3 11 09 18     	ld de,#1800+1*8+1
1361  86C6              	OS_SET_XY
1361  86C6 0E 01       >    ld c,#01
1361  86C8 E7          >    rst #20
1362  86C9 21 D4 9D     	ld hl,msg_menu_main2
1363  86CC              	OS_PRINTZ
1363  86CC 0E 09       >    ld c,#09
1363  86CE E7          >    rst #20
1364  86CF 11 11 18     	ld de,#1800+2*8+1
1365  86D2              	OS_SET_XY
1365  86D2 0E 01       >    ld c,#01
1365  86D4 E7          >    rst #20
1366  86D5 21 DB 9D     	ld hl,msg_menu_main3
1367  86D8              	OS_PRINTZ
1367  86D8 0E 09       >    ld c,#09
1367  86DA E7          >    rst #20
1368  86DB C9           	ret
1369  86DC
1370  86DC
1371  86DC              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 86DC              view_file
   2+ 86DC              	;просмотр файла как текста
   3+ 86DC
   4+ 86DC 2A 08 9B     	ld hl,(file_r_all)
   5+ 86DF 7D           	ld a,l
   6+ 86E0 B4           	or h
   7+ 86E1 CA BD 87     	jp z,view_file_ex ;защита
   8+ 86E4 2A 1A 9D     	ld hl,(file_r_num_cur)
   9+ 86E7 CD 2B 82     	call calc_deskr
  10+ 86EA DD 7E 0B     	ld a,(ix+#0b)
  11+ 86ED FE 10        	cp #10 ;признак каталога
  12+ 86EF CA BD 87     	jp z,view_file_ex
  13+ 86F2
  14+ 86F2 CD 24 86     	call format_name ;обработать имя файла
  15+ 86F5
  16+ 86F5
  17+ 86F5
  18+ 86F5              	OS_CLS ;почистить экран
  18+ 86F5 0E 00       >    ld c,#00
  18+ 86F7 E7          >    rst #20
  19+ 86F8
  20+ 86F8              	;обнулить переменные
  21+ 86F8 AF           	xor a
  22+ 86F9 32 E2 89     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  23+ 86FC              	;ld (view_file_bot_flag),a  ;
  24+ 86FC 21 FF FF     	ld hl,#ffff
  25+ 86FF 22 E3 89     	ld (view_file_end),hl ;конец файла тут
  26+ 8702 23           	inc hl
  27+ 8703 22 DA 89     	ld (view_move_right_val),hl
  28+ 8706
  29+ 8706 C5           	push bc
  30+ 8707 CD B3 80     	call clear_buf
  31+ 870A C1           	pop bc
  32+ 870B
  33+ 870B 3E FF        	ld a,255
  34+ 870D 32 1D 9D     	ld (file_id_cur_r),a
  35+ 8710 21 0C 9B     	ld hl,file_name_cur		;строка с именем
  36+ 8713              	OS_FILE_OPEN
  36+ 8713 0E 21       >    ld c,#21
  36+ 8715 E7          >    rst #20
  37+ 8716 30 0E        	jr nc,view_file_open_ok
  38+ 8718              view_file_file_error
  39+ 8718 21 E1 9D     	ld hl,msg_file_error
  40+ 871B              	OS_PRINTZ
  40+ 871B 0E 09       >    ld c,#09
  40+ 871D E7          >    rst #20
  41+ 871E 06 64        	ld b,2*50
  42+ 8720 CD AF 80     	call delay1
  43+ 8723 C3 AD 87     	jp view_file_wait_ex
  44+ 8726
  45+ 8726              view_file_open_ok
  46+ 8726 32 1D 9D     	ld (file_id_cur_r),a
  47+ 8729              	;проверка длины файла не больше #4000
  48+ 8729 7A           	ld	a,d ;самые старшие байты длины
  49+ 872A B3           	or e
  50+ 872B 28 11        	jr z,view_file_size_ok ;если не слищком большой
  51+ 872D              view_file_too_big
  52+ 872D              	;файл больше буфера
  53+ 872D 11 00 40     	ld de,#4000 ;размер одной первой части
  54+ 8730 21 00 C0     	ld hl,buffer_cat
  55+ 8733 3A 1D 9D     	ld a,(file_id_cur_r)
  56+ 8736              	OS_FILE_READ ;загрузить
  56+ 8736 0E 23       >    ld c,#23
  56+ 8738 E7          >    rst #20
  57+ 8739 38 DD        	jr c,view_file_file_error
  58+ 873B
  59+ 873B C3 67 87     	jp view_file_readed
  60+ 873E
  61+ 873E              view_file_size_ok
  62+ 873E 78           	ld	a,b ;младший старший байт длины
  63+ 873F FE 40        	cp #40
  64+ 8741 38 06        	jr c,view_file_size_ok_small
  65+ 8743 20 E8        	jr nz,view_file_too_big
  66+ 8745 0C           	inc c
  67+ 8746 0D           	dec c
  68+ 8747 20 E4        	jr nz,view_file_too_big
  69+ 8749
  70+ 8749
  71+ 8749              view_file_size_ok_small
  72+ 8749              	;проверка на 0
  73+ 8749 78           	ld a,b
  74+ 874A B1           	or c
  75+ 874B CA 18 87     	jp z,view_file_file_error
  76+ 874E              	;узнать где конец файла
  77+ 874E 21 00 C0     	ld hl,buffer_cat
  78+ 8751 09           	add hl,bc
  79+ 8752 22 E3 89     	ld (view_file_end),hl ;конец файла тут
  80+ 8755              	;размер не большой, прочитаем
  81+ 8755 50           	ld d,b ;размер
  82+ 8756 59           	ld e,c
  83+ 8757 21 00 C0     	ld hl,buffer_cat
  84+ 875A 3A 1D 9D     	ld a,(file_id_cur_r)
  85+ 875D              	OS_FILE_READ ;загрузить
  85+ 875D 0E 23       >    ld c,#23
  85+ 875F E7          >    rst #20
  86+ 8760 38 B6        	jr c,view_file_file_error
  87+ 8762
  88+ 8762 3E 01        	ld a,1
  89+ 8764 32 E2 89     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  90+ 8767
  91+ 8767              view_file_readed
  92+ 8767              	;файл прочитан
  93+ 8767
  94+ 8767 21 00 C0     	ld hl,buffer_cat
  95+ 876A 22 DC 89     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  96+ 876D 22 DE 89     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  97+ 8770
  98+ 8770 CD 86 88     	call print_file_text
  99+ 8773
 100+ 8773
 101+ 8773 CD 51 88     	call print_menu_view ;меню
 102+ 8776 CD 6C 88     	call print_menu_view_top ;инфо
 103+ 8779
 104+ 8779 CD 0B 81     	call release_key
 105+ 877C
 106+ 877C              view_file_wait ;цикл ожидания клавиши
 107+ 877C              	OS_WAIT
 107+ 877C DF          >	rst #18
 108+ 877D              	OS_GET_CHAR
 108+ 877D 0E 10       >    ld c,#10
 108+ 877F E7          >    rst #20
 109+ 8780 FE FF        	cp 255
 110+ 8782 28 F8        	jr z,view_file_wait
 111+ 8784 FE 33        	cp "3"
 112+ 8786 28 25        	jr z,view_file_wait_ex
 113+ 8788 FE 0A        	cp 10 ;вниз
 114+ 878A CA CA 87     	jp z,view_line_down
 115+ 878D FE 0B        	cp 11 ;вверх
 116+ 878F CA E0 87     	jp z,view_line_up
 117+ 8792 FE 09        	cp 09 ;вправо
 118+ 8794 CA F4 87     	jp z,view_right
 119+ 8797 FE 08        	cp 08 ;влево
 120+ 8799 CA 05 88     	jp z,view_left
 121+ 879C FE 04        	cp 04 ;страница вверх
 122+ 879E CA 17 88     	jp z,view_page_up
 123+ 87A1 FE 05        	cp 05 ;страница вниз
 124+ 87A3 CA 34 88     	jp z,view_page_down
 125+ 87A6 FE 18        	cp 24 ;break
 126+ 87A8 CA CC 82     	jp z,exit
 127+ 87AB 18 CF        	jr view_file_wait
 128+ 87AD
 129+ 87AD              view_file_wait_ex
 130+ 87AD 3A 1D 9D     	ld a,(file_id_cur_r)
 131+ 87B0 FE FF        	cp 255
 132+ 87B2 28 03        	jr z,view_file_wait_ex1
 133+ 87B4              	OS_FILE_CLOSE ;A - id file
 133+ 87B4 0E 25       >    ld c,#25
 133+ 87B6 E7          >    rst #20
 134+ 87B7              view_file_wait_ex1
 135+ 87B7              	;почистить экран
 136+ 87B7              	OS_CLS
 136+ 87B7 0E 00       >    ld c,#00
 136+ 87B9 E7          >    rst #20
 137+ 87BA C3 23 80     	jp start_nc_warm ;перезагрузить папку
 138+ 87BD
 139+ 87BD              view_file_ex
 140+ 87BD 3A 1D 9D     	ld a,(file_id_cur_r)
 141+ 87C0 FE FF        	cp 255
 142+ 87C2 28 03        	jr z,view_file_ex1
 143+ 87C4              	OS_FILE_CLOSE ;A - id file
 143+ 87C4 0E 25       >    ld c,#25
 143+ 87C6 E7          >    rst #20
 144+ 87C7              view_file_ex1
 145+ 87C7 C3 5C 80     	jp nc_wait
 146+ 87CA
 147+ 87CA
 148+ 87CA
 149+ 87CA              view_line_down ;вниз на строчку
 150+ 87CA 2A DE 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 151+ 87CD 22 DC 89     	ld (view_file_pos_cur),hl
 152+ 87D0 CD AD 89     	call next_line ;вперёд на строку
 153+ 87D3 38 A7        	jr c,view_file_wait ;если не удачно
 154+ 87D5 2A DC 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 155+ 87D8 22 DE 89     	ld (view_file_pos_cur_focus),hl
 156+ 87DB CD 86 88     	call print_file_text ;напечатать всю страницу
 157+ 87DE 18 9C        	jr view_file_wait
 158+ 87E0
 159+ 87E0              view_line_up ;вверх на строчку
 160+ 87E0 2A DE 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 161+ 87E3 22 DC 89     	ld (view_file_pos_cur),hl
 162+ 87E6 CD BB 89     	call prev_line ;
 163+ 87E9              	;jr c,view_file_wait ;если не удачно
 164+ 87E9 2A DC 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 165+ 87EC 22 DE 89     	ld (view_file_pos_cur_focus),hl
 166+ 87EF CD 86 88     	call print_file_text ;напечатать всю страницу
 167+ 87F2 18 88        	jr view_file_wait
 168+ 87F4
 169+ 87F4
 170+ 87F4              view_right ;вправо
 171+ 87F4 2A DA 89     	ld hl,(view_move_right_val)
 172+ 87F7 23           	inc hl
 173+ 87F8 7C           	ld a,h
 174+ 87F9 B5           	or l
 175+ 87FA 28 80        	jr z,view_file_wait
 176+ 87FC 22 DA 89     	ld (view_move_right_val),hl
 177+ 87FF CD 86 88     	call print_file_text ;напечатать всю страницу
 178+ 8802 C3 7C 87     	jp view_file_wait
 179+ 8805
 180+ 8805              view_left ;влево
 181+ 8805 2A DA 89     	ld hl,(view_move_right_val)
 182+ 8808 7C           	ld a,h
 183+ 8809 B5           	or l
 184+ 880A CA 7C 87     	jp z,view_file_wait
 185+ 880D 2B           	dec hl
 186+ 880E 22 DA 89     	ld (view_move_right_val),hl
 187+ 8811 CD 86 88     	call print_file_text ;напечатать всю страницу
 188+ 8814 C3 7C 87     	jp view_file_wait
 189+ 8817
 190+ 8817
 191+ 8817
 192+ 8817              view_page_up ;на страницу назад
 193+ 8817 2A DE 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 194+ 881A 22 DC 89     	ld (view_file_pos_cur),hl
 195+ 881D 06 16        	ld b,view_text_bot-2
 196+ 881F              view_page_up_cl
 197+ 881F CD BB 89     	call prev_line ;
 198+ 8822 38 04        	jr c,view_page_up_ex ;если не удачно
 199+ 8824 28 02        	jr z,view_page_up_ex
 200+ 8826 10 F7        	djnz view_page_up_cl
 201+ 8828              view_page_up_ex
 202+ 8828 2A DC 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 203+ 882B 22 DE 89     	ld (view_file_pos_cur_focus),hl
 204+ 882E CD 86 88     	call print_file_text ;напечатать всю страницу
 205+ 8831 C3 7C 87     	jp view_file_wait
 206+ 8834
 207+ 8834
 208+ 8834
 209+ 8834              view_page_down ;на страницу вперёд
 210+ 8834 2A DE 89     	ld hl,(view_file_pos_cur_focus) ;фокус
 211+ 8837 22 DC 89     	ld (view_file_pos_cur),hl
 212+ 883A 06 16        	ld b,view_text_bot-2
 213+ 883C              view_page_down_cl
 214+ 883C CD AD 89     	call next_line ;
 215+ 883F 38 04        	jr c,view_page_down_ex ;если не удачно
 216+ 8841 28 02        	jr z,view_page_down_ex
 217+ 8843 10 F7        	djnz view_page_down_cl
 218+ 8845              view_page_down_ex
 219+ 8845 2A DC 89     	ld hl,(view_file_pos_cur) ;запомнить фокус
 220+ 8848 22 DE 89     	ld (view_file_pos_cur_focus),hl
 221+ 884B CD 86 88     	call print_file_text ;напечатать всю страницу
 222+ 884E C3 7C 87     	jp view_file_wait
 223+ 8851
 224+ 8851
 225+ 8851
 226+ 8851              print_menu_view ;печать меню просмотрщика
 227+ 8851 3E 18        	ld a,#18
 228+ 8853 06 28        	ld b,color_backgr_hi ;цвет
 229+ 8855              	OS_PAINT_LINE ;линия внизу
 229+ 8855 0E 04       >    ld c,#04
 229+ 8857 E7          >    rst #20
 230+ 8858 3E 28        	ld a,color_backgr_hi ;цвет
 231+ 885A 06 0C        	ld b,#c
 232+ 885C              	OS_SET_COLOR
 232+ 885C 0E 06       >    ld c,#06
 232+ 885E E7          >    rst #20
 233+ 885F 11 10 18     	ld de,#1800+2*8
 234+ 8862              	OS_SET_XY
 234+ 8862 0E 01       >    ld c,#01
 234+ 8864 E7          >    rst #20
 235+ 8865 21 D3 89     	ld hl,msg_menu_view
 236+ 8868              	OS_PRINTZ
 236+ 8868 0E 09       >    ld c,#09
 236+ 886A E7          >    rst #20
 237+ 886B C9           	ret
 238+ 886C
 239+ 886C              print_menu_view_top ;печать меню просмотрщика верхнее
 240+ 886C AF           	xor a
 241+ 886D 06 28        	ld b,color_backgr_hi ;цвет
 242+ 886F              	OS_PAINT_LINE ;линия вверху
 242+ 886F 0E 04       >    ld c,#04
 242+ 8871 E7          >    rst #20
 243+ 8872 3E 28        	ld a,color_backgr_hi ;цвет
 244+ 8874 06 0C        	ld b,#c
 245+ 8876              	OS_SET_COLOR
 245+ 8876 0E 06       >    ld c,#06
 245+ 8878 E7          >    rst #20
 246+ 8879 11 24 00     	ld de,#0024
 247+ 887C              	OS_SET_XY
 247+ 887C 0E 01       >    ld c,#01
 247+ 887E E7          >    rst #20
 248+ 887F 21 0C 9B     	ld hl,file_name_cur
 249+ 8882              	OS_PRINTZ
 249+ 8882 0E 09       >    ld c,#09
 249+ 8884 E7          >    rst #20
 250+ 8885 C9           	ret
 251+ 8886
 252+ 8886
 253+ 8886
 254+ 8886              print_file_text	;печать текущей части файла в консоль
 255+ 8886 3E 04        	ld a,color_view_text ;цвет
 256+ 8888 06 0C        	ld b,#c
 257+ 888A              	OS_SET_COLOR
 257+ 888A 0E 06       >    ld c,#06
 257+ 888C E7          >    rst #20
 258+ 888D
 259+ 888D 3E 01        	ld a,view_text_top ;первая строка
 260+ 888F 32 E0 89     	ld (view_file_y_cur),a
 261+ 8892 2A DE 89     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 262+ 8895 22 DC 89     	ld (view_file_pos_cur),hl
 263+ 8898              print_file_text_cl
 264+ 8898 2A DC 89     	ld hl,(view_file_pos_cur)
 265+ 889B CD C1 88     	call print_line_text
 266+ 889E 38 0C        	jr c,print_file_text_ex
 267+ 88A0
 268+ 88A0              	; call next_line ;найти следующую строку
 269+ 88A0              	; ret c
 270+ 88A0
 271+ 88A0 3A E0 89     	ld a,(view_file_y_cur)
 272+ 88A3 3C           	inc a
 273+ 88A4 32 E0 89     	ld (view_file_y_cur),a
 274+ 88A7 FE 18        	cp view_text_bot
 275+ 88A9 38 ED        	jr c,print_file_text_cl
 276+ 88AB C9           	ret
 277+ 88AC
 278+ 88AC              print_file_text_ex
 279+ 88AC              	;тут очистить остальные строки
 280+ 88AC 3A E0 89     	ld a,(view_file_y_cur)
 281+ 88AF 3C           	inc a
 282+ 88B0 FE 18        	cp view_text_bot
 283+ 88B2 30 0B        	jr nc,print_file_text_ex2
 284+ 88B4 67           	ld h,a
 285+ 88B5 32 E0 89     	ld (view_file_y_cur),a
 286+ 88B8 3E 20        	ld a," "
 287+ 88BA              	OS_FILL_LINE ;очистить строку
 287+ 88BA 0E 03       >    ld c,#03
 287+ 88BC E7          >    rst #20
 288+ 88BD 18 ED        	jr print_file_text_ex
 289+ 88BF              print_file_text_ex2
 290+ 88BF 37           	scf
 291+ 88C0 C9           	ret
 292+ 88C1
 293+ 88C1
 294+ 88C1
 295+ 88C1              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 296+ 88C1              ;вх: hl - адрес строки
 297+ 88C1 CD 11 89     	call view_move_right ;промотать направо. если надо
 298+ 88C4              	;установить позицию
 299+ 88C4 3A E0 89     	ld a,(view_file_y_cur)
 300+ 88C7 57           	ld d,a
 301+ 88C8 AF           	xor a
 302+ 88C9 32 E1 89     	ld (view_file_x_cur),a
 303+ 88CC 5F           	ld e,a
 304+ 88CD              	OS_SET_XY 	;yx
 304+ 88CD 0E 01       >    ld c,#01
 304+ 88CF E7          >    rst #20
 305+ 88D0              print_line_text_cl ;цикл
 306+ 88D0
 307+ 88D0 7E           	ld a,(hl)
 308+ 88D1 FE 0A        	cp 10 ;этот код не печатаем
 309+ 88D3 28 14        	jr z,print_line_text_skip
 310+ 88D5 FE FF        	cp #ff ;этот код не печатаем
 311+ 88D7 28 10        	jr z,print_line_text_skip
 312+ 88D9 FE 0D        	cp 13
 313+ 88DB 28 13        	jr z,print_line_text_ex_ok
 314+ 88DD              	OS_PRINT_CHARF ;печать
 314+ 88DD D7          >	rst #10
 315+ 88DE
 316+ 88DE              	;на следующую позицию
 317+ 88DE 3A E1 89     	ld a,(view_file_x_cur)
 318+ 88E1 3C           	inc a
 319+ 88E2 FE 50        	cp 80 ;правый край экрана
 320+ 88E4 32 E1 89     	ld (view_file_x_cur),a
 321+ 88E7 30 15        	jr nc,print_line_text_right ;дошли до правого края
 322+ 88E9
 323+ 88E9              print_line_text_skip
 324+ 88E9 CD 49 89     	call view_file_next_pos ;следующий
 325+ 88EC 38 0B        	jr c,print_line_text_ex_end ;на следующий символ
 326+ 88EE 18 E0        	jr print_line_text_cl
 327+ 88F0
 328+ 88F0              print_line_text_ex_ok ;выход норма по коду 13
 329+ 88F0 3E 20        	ld a," "
 330+ 88F2              	OS_PRINT_CHARF ;печать
 330+ 88F2 D7          >	rst #10
 331+ 88F3 CD 02 89     	call printe_clear_end ;добить до конца строки
 332+ 88F6 C3 49 89     	jp view_file_next_pos ;следующий, чтобы пропустить код 13
 333+ 88F9              	;ret
 334+ 88F9
 335+ 88F9              print_line_text_ex_end ;выход если кончился файл
 336+ 88F9 CD 02 89     	call printe_clear_end
 337+ 88FC 37           	scf
 338+ 88FD C9           	ret
 339+ 88FE
 340+ 88FE              print_line_text_right
 341+ 88FE CD AD 89     	call next_line ;позицию  до конца строки
 342+ 8901 C9           	ret
 343+ 8902
 344+ 8902
 345+ 8902              printe_clear_end
 346+ 8902              	;добить строку пробелами
 347+ 8902 3A E1 89     	ld a,(view_file_x_cur)
 348+ 8905 3C           	inc a
 349+ 8906 FE 50        	cp 80 ;правый край экрана
 350+ 8908 32 E1 89     	ld (view_file_x_cur),a
 351+ 890B D0           	ret nc
 352+ 890C 3E 20        	ld a," "
 353+ 890E              	OS_PRINT_CHARF ;печать
 353+ 890E D7          >	rst #10
 354+ 890F 18 F1        	jr printe_clear_end
 355+ 8911
 356+ 8911
 357+ 8911
 358+ 8911
 359+ 8911
 360+ 8911              view_move_right ;перемотка строки направо
 361+ 8911 ED 4B DA 89  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 362+ 8915 78           	ld a,b
 363+ 8916 B1           	or c
 364+ 8917 C8           	ret z
 365+ 8918 2A DC 89     	ld hl,(view_file_pos_cur)
 366+ 891B              view_move_right1
 367+ 891B 7E           	ld a,(hl)
 368+ 891C FE 0A        	cp 10 ;этот код пропускаем
 369+ 891E 20 07        	jr nz,view_move_right2
 370+ 8920 CD 49 89     	call view_file_next_pos
 371+ 8923 D8           	ret c
 372+ 8924 C8           	ret z
 373+ 8925 18 F4        	jr view_move_right1
 374+ 8927              view_move_right2
 375+ 8927 FE FF        	cp #ff ;этот код пропускаем
 376+ 8929 20 07        	jr nz,view_move_right3
 377+ 892B CD 49 89     	call view_file_next_pos
 378+ 892E D8           	ret c
 379+ 892F C8           	ret z
 380+ 8930 18 E9        	jr view_move_right1
 381+ 8932              view_move_right3
 382+ 8932 7E           	ld a,(hl)
 383+ 8933 FE 0D        	cp 13 ;
 384+ 8935 C8           	ret z
 385+ 8936              view_move_right_cl
 386+ 8936 CD 49 89     	call view_file_next_pos
 387+ 8939 D8           	ret c
 388+ 893A C8           	ret z
 389+ 893B 7E           	ld a,(hl)
 390+ 893C FE 0D        	cp 13
 391+ 893E C8           	ret z
 392+ 893F FE 0A        	cp 10 ;этот код пропускаем
 393+ 8941 28 F3        	jr z,view_move_right_cl
 394+ 8943 0B           	dec bc
 395+ 8944 78           	ld a,b
 396+ 8945 B1           	or c
 397+ 8946 20 EE        	jr nz,view_move_right_cl
 398+ 8948              	;call view_file_next_pos ;следующий
 399+ 8948 C9           	ret
 400+ 8949
 401+ 8949
 402+ 8949
 403+ 8949              ;получение следующей позиции
 404+ 8949              view_file_next_pos
 405+ 8949 3A E2 89     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 406+ 894C B7           	or a
 407+ 894D 28 14        	jr z,view_file_next_pos_big
 408+ 894F              	;если текст не большой
 409+ 894F 2A E3 89     	ld hl,(view_file_end) ;конец текста известен
 410+ 8952 ED 5B DC 89  	ld de,(view_file_pos_cur)
 411+ 8956 13           	inc de ;вперёд
 412+ 8957 A7           	and a
 413+ 8958 ED 52        	sbc hl,de
 414+ 895A 38 15        	jr c,view_file_next_pos_end
 415+ 895C ED 53 DC 89  	ld (view_file_pos_cur),de
 416+ 8960 EB           	ex de,hl ;на выходе адрес в HL
 417+ 8961 B7           	or a
 418+ 8962 C9           	ret
 419+ 8963
 420+ 8963
 421+ 8963
 422+ 8963              view_file_next_pos_big
 423+ 8963              	;если текст большой
 424+ 8963 2A DC 89     	ld hl,(view_file_pos_cur)	;текущая позиция
 425+ 8966 23           	inc hl ;вперёд
 426+ 8967 7C           	ld a,h
 427+ 8968 FE C0        	cp #c0 ;если вышли за пределы окна
 428+ 896A 38 05        	jr c,view_file_next_pos_end
 429+ 896C 22 DC 89     	ld (view_file_pos_cur),hl
 430+ 896F B7           	or a
 431+ 8970 C9           	ret
 432+ 8971
 433+ 8971              view_file_next_pos_end
 434+ 8971              	;не смогли шагнуть вперёд
 435+ 8971              	; ld a,1 ;флаг что внизу
 436+ 8971              	; ld (view_file_bot_flag),a
 437+ 8971 37           	scf ;ошибка
 438+ 8972 C9           	ret
 439+ 8973
 440+ 8973
 441+ 8973
 442+ 8973
 443+ 8973
 444+ 8973
 445+ 8973              ;получение предыдущей позиции
 446+ 8973              view_file_prev_pos
 447+ 8973 3A E2 89     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 448+ 8976 B7           	or a
 449+ 8977 28 1E        	jr z,view_file_prev_pos_big
 450+ 8979              	;если текст не большой
 451+ 8979 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 452+ 897C ED 5B DC 89  	ld de,(view_file_pos_cur) ;текущая позиция
 453+ 8980 1B           	dec de ;назад
 454+ 8981 A7           	and a
 455+ 8982 ED 52        	sbc hl,de
 456+ 8984 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 457+ 8986 30 1D        	jr nc,view_file_prev_pos_end
 458+ 8988              	;можно шагнуть назад
 459+ 8988 ED 53 DC 89  	ld (view_file_pos_cur),de
 460+ 898C EB           	ex de,hl ;на выходе адрес в HL
 461+ 898D AF           	xor a
 462+ 898E 3C           	inc a ;a=1
 463+ 898F C9           	ret
 464+ 8990              view_file_prev_pos_top
 465+ 8990              	;если в начале
 466+ 8990 ED 53 DC 89  	ld (view_file_pos_cur),de
 467+ 8994 EB           	ex de,hl ;на выходе адрес в HL
 468+ 8995 AF           	xor a ;a=0
 469+ 8996 C9           	ret
 470+ 8997
 471+ 8997
 472+ 8997              view_file_prev_pos_big
 473+ 8997              	;если текст большой
 474+ 8997 2A DC 89     	ld hl,(view_file_pos_cur)	;текущая позиция
 475+ 899A 2B           	dec hl ;назад
 476+ 899B 7C           	ld a,h
 477+ 899C FE C0        	cp #c0 ;если вышли за пределы окна
 478+ 899E 38 05        	jr c,view_file_prev_pos_end
 479+ 89A0 22 DC 89     	ld (view_file_pos_cur),hl
 480+ 89A3 B7           	or a
 481+ 89A4 C9           	ret
 482+ 89A5
 483+ 89A5              view_file_prev_pos_end
 484+ 89A5              	;не смогли шагнуть назад
 485+ 89A5 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 486+ 89A8 22 DC 89     	ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 487+ 89AB              	;вернулись в начало
 488+ 89AB AF           	xor a ;a=0
 489+ 89AC C9           	ret
 490+ 89AD
 491+ 89AD
 492+ 89AD
 493+ 89AD
 494+ 89AD              next_line ;поиск следующей строки
 495+ 89AD CD 49 89     	call view_file_next_pos
 496+ 89B0 D8           	ret c
 497+ 89B1 C8           	ret z
 498+ 89B2 7E           	ld a,(hl)
 499+ 89B3 FE 0D        	cp 13
 500+ 89B5 20 F6        	jr nz,next_line
 501+ 89B7 CD 49 89     	call view_file_next_pos ;ещё на символ
 502+ 89BA C9           	ret
 503+ 89BB
 504+ 89BB
 505+ 89BB
 506+ 89BB              prev_line ;поиск предыдущей строки
 507+ 89BB              ;если достигнуто начало файла - вернёт адрес начальный
 508+ 89BB              	;сначала в конец предыдущей
 509+ 89BB CD 73 89     	call view_file_prev_pos
 510+ 89BE C8           	ret z
 511+ 89BF D8           	ret c
 512+ 89C0 7E           	ld a,(hl)
 513+ 89C1 FE 0D        	cp 13
 514+ 89C3 20 F6        	jr nz,prev_line
 515+ 89C5              	;теперь в начало предыдущей
 516+ 89C5              prev_line1
 517+ 89C5 CD 73 89     	call view_file_prev_pos
 518+ 89C8 C8           	ret z
 519+ 89C9 D8           	ret c
 520+ 89CA 7E           	ld a,(hl)
 521+ 89CB FE 0D        	cp 13
 522+ 89CD 20 F6        	jr nz,prev_line1
 523+ 89CF CD 49 89     	call view_file_next_pos ;ещё на символ обратно
 524+ 89D2 C9           	ret
 525+ 89D3
 526+ 89D3
 527+ 89D3
 528+ 89D3              view_text_bot equ 24 ;последняя строка для печати
 529+ 89D3              view_text_top equ 1 ;первая строка
 530+ 89D3              view_text_lines equ 25-2 ;видимых строк на экране
 531+ 89D3
 532+ 89D3              msg_menu_view
 533+ 89D3 33 20 45 78  	db "3 Exit",0
 533+ 89D7 69 74 00
 534+ 89DA
 535+ 89DA              ;view_file_position ds 4 ;текущая позиция в файле
 536+ 89DA              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 537+ 89DA 00 00        view_move_right_val dw 0 ;сдвиг вправо
 538+ 89DC 00 00        view_file_pos_cur dw 0;текущая позиция
 539+ 89DE 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 540+ 89E0 00           view_file_y_cur db 0;текущая строка
 541+ 89E1 00           view_file_x_cur db 0;текущий столбец
 542+ 89E2 00           view_file_load_all db 0 ;флаг что файл весь загружен
 543+ 89E3 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 544+ 89E5
 545+ 89E5
# file closed: nc_view.asm
1372  89E5              	include GPlay/gplay.asm ;плеер
# file opened: GPlay/gplay.asm
   1+ 89E5              ;GPlay - приложение для OS GMX
   2+ 89E5                 ; device ZXSPECTRUM128
   3+ 89E5              	; include "../os_defs.asm"
   4+ 89E5              	; org PROG_START
   5+ 89E5
   6+ 89E5
   7+ 89E5              start_gplay
   8+ 89E5 F5           	push af
   9+ 89E6
  10+ 89E6 CD C1 80     	call clear_left_panel ;почистить часть экрана
  11+ 89E9
  12+ 89E9              	;call release_key
  13+ 89E9
  14+ 89E9 21 FF 8E     	ld hl,memorystreampages+$FF
  15+ 89EC 36 00        	ld (hl),0 ;количество занятых страниц
  16+ 89EE
  17+ 89EE 3A 1E 9D     	ld a,(page_ext01) ;доп страница для данных плеера
  18+ 89F1              	OS_SET_PAGE_SLOT3
  18+ 89F1 0E 1C       >    ld c,#1c
  18+ 89F3 E7          >    rst #20
  19+ 89F4
  20+ 89F4 11 00 00     	ld de,0
  21+ 89F7              	OS_SET_XY
  21+ 89F7 0E 01       >    ld c,#01
  21+ 89F9 E7          >    rst #20
  22+ 89FA 21 F1 8C     	ld hl,msg_title ;имя приложения
  23+ 89FD              	OS_PRINTZ ;печать
  23+ 89FD 0E 09       >    ld c,#09
  23+ 89FF E7          >    rst #20
  24+ 8A00
  25+ 8A00 3E 0D        	ld a,13 ;оставим место для шкалы прогресса
  26+ 8A02              	OS_PRINT_CHARF
  26+ 8A02 D7          >	rst #10
  27+ 8A03 3E 0D        	ld a,13
  28+ 8A05              	OS_PRINT_CHARF
  28+ 8A05 D7          >	rst #10
  29+ 8A06 21 0C 9B     	ld hl,file_name_cur
  30+ 8A09              	OS_PRINTZ
  30+ 8A09 0E 09       >    ld c,#09
  30+ 8A0B E7          >    rst #20
  31+ 8A0C
  32+ 8A0C 21 AB 8C     	ld hl,txt_load
  33+ 8A0F              	OS_PRINTZ
  33+ 8A0F 0E 09       >    ld c,#09
  33+ 8A11 E7          >    rst #20
  34+ 8A12
  35+ 8A12 3E FF        	ld a,255
  36+ 8A14 32 1D 9D     	ld (file_id_cur_r),a
  37+ 8A17
  38+ 8A17 F1           	pop af
  39+ 8A18
  40+ 8A18 FE 6D        	cp "m"
  41+ 8A1A 20 06        	jr nz,start_gplay_vgz
  42+ 8A1C              	;если MOD
  43+ 8A1C CD ED 8A     	call load_mod
  44+ 8A1F C3 87 8A     	jp exit_gplay
  45+ 8A22
  46+ 8A22
  47+ 8A22              start_gplay_vgz
  48+ 8A22 FE 7A        	cp "z"
  49+ 8A24 20 08        	jr nz,start_gplay_vgm
  50+ 8A26              	;если VGZ
  51+ 8A26 CD B2 8A     	call load_vgz
  52+ 8A29 DA 87 8A     	jp c,exit_gplay
  53+ 8A2C 18 06        	jr start_gplay_ok
  54+ 8A2E
  55+ 8A2E              start_gplay_vgm
  56+ 8A2E              	;если vgm
  57+ 8A2E CD 1F 9A     	call load_mus ;инициализация VGM
  58+ 8A31 DA 87 8A     	jp c,exit_gplay
  59+ 8A34
  60+ 8A34              start_gplay_ok
  61+ 8A34              	;играет
  62+ 8A34 21 9B 8C     	ld hl,txt_play
  63+ 8A37              	OS_PRINTZ
  63+ 8A37 0E 09       >    ld c,#09
  63+ 8A39 E7          >    rst #20
  64+ 8A3A
  65+ 8A3A 21 7E 8C     	ld hl,txt_gplay_menu
  66+ 8A3D              	OS_PRINTZ
  66+ 8A3D 0E 09       >    ld c,#09
  66+ 8A3F E7          >    rst #20
  67+ 8A40
  68+ 8A40              wait_play
  69+ 8A40              	OS_WAIT
  69+ 8A40 DF          >	rst #18
  70+ 8A41
  71+ 8A41 CD C5 8B     	call gplay_progress_print
  72+ 8A44
  73+ 8A44 11 00 0A     	ld de,#0a00
  74+ 8A47              	OS_SET_XY
  74+ 8A47 0E 01       >    ld c,#01
  74+ 8A49 E7          >    rst #20
  75+ 8A4A 2A 72 8F     	ld hl,(memorystreamcurrentaddr)
  76+ 8A4D CD 1F 8C     	call toDecimal
  77+ 8A50              	OS_PRINTZ
  77+ 8A50 0E 09       >    ld c,#09
  77+ 8A52 E7          >    rst #20
  78+ 8A53
  79+ 8A53
  80+ 8A53 11 00 0B     	ld de,#0b00
  81+ 8A56              	OS_SET_XY
  81+ 8A56 0E 01       >    ld c,#01
  81+ 8A58 E7          >    rst #20
  82+ 8A59 2A 0E 8F     	ld hl,(memorystreampageaddr)
  83+ 8A5C 01 00 8E     	ld bc,memorystreampages
  84+ 8A5F A7           	and a
  85+ 8A60 ED 42        	sbc hl,bc
  86+ 8A62 CD 1F 8C     	call toDecimal
  87+ 8A65              	OS_PRINTZ
  87+ 8A65 0E 09       >    ld c,#09
  87+ 8A67 E7          >    rst #20
  88+ 8A68
  89+ 8A68 3A 7A 95     	ld a,(vgm_play_var)
  90+ 8A6B B7           	or a
  91+ 8A6C 20 19        	jr nz,exit_gplay ; конец пенсни
  92+ 8A6E              	OS_GET_CHAR
  92+ 8A6E 0E 10       >    ld c,#10
  92+ 8A70 E7          >    rst #20
  93+ 8A71 FE 20        	cp " " ;space
  94+ 8A73 CA 87 8A     	jp z,exit_gplay
  95+ 8A76 FE 73        	cp "s" ;stop
  96+ 8A78 CA 87 8A     	jp z,exit_gplay
  97+ 8A7B FE 53        	cp "S" ;stop
  98+ 8A7D CA 87 8A     	jp z,exit_gplay
  99+ 8A80 FE 18        	cp 24 ;break
 100+ 8A82 CA 87 8A     	jp z,exit_gplay
 101+ 8A85 18 B9        	jr wait_play
 102+ 8A87
 103+ 8A87
 104+ 8A87
 105+ 8A87
 106+ 8A87
 107+ 8A87              exit_gplay ;выход
 108+ 8A87 F5           	push af ;сохранить нажатую клавишу
 109+ 8A88
 110+ 8A88 21 A5 8C     	ld hl,txt_stop
 111+ 8A8B              	OS_PRINTZ
 111+ 8A8B 0E 09       >    ld c,#09
 111+ 8A8D E7          >    rst #20
 112+ 8A8E
 113+ 8A8E 21 00 00     	ld hl,0 ;отключить обработчик прерываний
 114+ 8A91              	OS_SET_INTER
 114+ 8A91 0E 14       >    ld c,#14
 114+ 8A93 E7          >    rst #20
 115+ 8A94 CD 10 8D     	call PLR_MUTE ;выключить звук
 116+ 8A97
 117+ 8A97
 118+ 8A97              	;освободить страницы памяти
 119+ 8A97 21 FF 8E     	ld hl,memorystreampages+$FF
 120+ 8A9A 6E               ld l,(hl)
 121+ 8A9B 2C           	inc l ;проверка на 0
 122+ 8A9C 2D           	dec l
 123+ 8A9D 28 0B        	jr z,free_s98_loop_skip
 124+ 8A9F
 125+ 8A9F              free_s98_loop
 126+ 8A9F 2D               dec l
 127+ 8AA0 7E               ld a,(hl)
 128+ 8AA1
 129+ 8AA1 F5               push af
 130+ 8AA2 E5               push hl
 131+ 8AA3                  ;OS_DELPAGE
 132+ 8AA3              	OS_DEL_PAGE
 132+ 8AA3 0E 20       >    ld c,#20
 132+ 8AA5 E7          >    rst #20
 133+ 8AA6 E1               pop hl
 134+ 8AA7 F1               pop af
 135+ 8AA8
 136+ 8AA8 20 F5            jr nz,free_s98_loop
 137+ 8AAA
 138+ 8AAA              free_s98_loop_skip
 139+ 8AAA              	; call delay ;задержка
 140+ 8AAA              	; xor a
 141+ 8AAA              	; OS_PROC_CLOSE
 142+ 8AAA
 143+ 8AAA 3A 1F 9D     	ld a,(page_main) ;основная страница
 144+ 8AAD              	OS_SET_PAGE_SLOT3
 144+ 8AAD 0E 1C       >    ld c,#1c
 144+ 8AAF E7          >    rst #20
 145+ 8AB0
 146+ 8AB0 F1           	pop af ;a - код клавиши
 147+ 8AB1 C9           	ret
 148+ 8AB2
 149+ 8AB2              ; delay ;задержка между запросами
 150+ 8AB2              	; ld b,50*1 ;
 151+ 8AB2              ; delay1
 152+ 8AB2              	; OS_WAIT
 153+ 8AB2              	; djnz delay1
 154+ 8AB2              	; ret
 155+ 8AB2
 156+ 8AB2
 157+ 8AB2
 158+ 8AB2
 159+ 8AB2
 160+ 8AB2
 161+ 8AB2
 162+ 8AB2
 163+ 8AB2
 164+ 8AB2              load_vgz
 165+ 8AB2              ;тут запуск VGZ
 166+ 8AB2              	;тут надо сначала распаковать файл
 167+ 8AB2 AF           	xor a
 168+ 8AB3              	OS_SET_MONO_MODE ;запросить моно режим
 168+ 8AB3 0E 08       >    ld c,#08
 168+ 8AB5 E7          >    rst #20
 169+ 8AB6 30 08        	jr nc,load_vgz1
 170+ 8AB8
 171+ 8AB8              load_vgz_err
 172+ 8AB8              	;выход с ошибкой
 173+ 8AB8
 174+ 8AB8              	;напечатать ошибку, если не дали режима моно
 175+ 8AB8 21 0D 9E     	ld hl,msg_mono_err
 176+ 8ABB              	OS_PRINTZ
 176+ 8ABB 0E 09       >    ld c,#09
 176+ 8ABD E7          >    rst #20
 177+ 8ABE
 178+ 8ABE 37           	scf ;ошибка
 179+ 8ABF C9           	ret
 180+ 8AC0
 181+ 8AC0              load_vgz1
 182+ 8AC0              	;перенести модуль распаковки на рабочий адрес
 183+ 8AC0 21 41 9E     	ld hl,start_gp_gzip_tmp
 184+ 8AC3 11 00 40     	ld de,start_gp_gzip
 185+ 8AC6 01 00 1B     	ld bc,end_gp_gzip_tmp-start_gp_gzip_tmp
 186+ 8AC9 ED B0        	ldir
 187+ 8ACB
 188+ 8ACB
 189+ 8ACB              	;распаковать
 190+ 8ACB 21 0C 9B     	ld hl,file_name_cur ;имя файла
 191+ 8ACE CD 00 40     	call start_gp_gzip ;decompressfiletomemorystream
 192+ 8AD1
 193+ 8AD1              	;перенести таблицу страниц
 194+ 8AD1 11 00 8E     	ld de,memorystreampages
 195+ 8AD4 01 00 01     	ld bc,256
 196+ 8AD7 ED B0        	ldir
 197+ 8AD9
 198+ 8AD9 01 FF 8E     	ld bc,memorystreampages+$ff
 199+ 8ADC 02               ld (bc),a  ;количество страниц
 200+ 8ADD
 201+ 8ADD F5           	push af
 202+ 8ADE 3E FF        	ld a,255
 203+ 8AE0              	OS_SET_MONO_MODE ;выключить моно режим
 203+ 8AE0 0E 08       >    ld c,#08
 203+ 8AE2 E7          >    rst #20
 204+ 8AE3 F1           	pop af
 205+ 8AE4
 206+ 8AE4 30 02        	jr nc,load_vgz_ok
 207+ 8AE6              	;если не распаковалос
 208+ 8AE6 37           	scf ;ошибка
 209+ 8AE7 C9           	ret
 210+ 8AE8
 211+ 8AE8              load_vgz_ok
 212+ 8AE8              	;нормально распаковалось
 213+ 8AE8
 214+ 8AE8 CD 64 9A     	call read_file_ok ;играть
 215+ 8AEB              	;call start_gplay ;играть
 216+ 8AEB
 217+ 8AEB AF           	xor a
 218+ 8AEC C9           	ret
 219+ 8AED
 220+ 8AED
 221+ 8AED
 222+ 8AED
 223+ 8AED
 224+ 8AED
 225+ 8AED              load_mod
 226+ 8AED              ;загрузка и игра mod
 227+ 8AED
 228+ 8AED              	;определение наличия GS
 229+ 8AED              	; xor a ;флаг что не нашли
 230+ 8AED              	; ld (gs_yep),a
 231+ 8AED              	; ld (gs_on),a
 232+ 8AED 3E 23        	LD A,#23
 233+ 8AEF D3 BB        	OUT (CMD), A
 234+ 8AF1 06 32        	ld b,50
 235+ 8AF3              WAITCOM2: ;это WC
 236+ 8AF3              	OS_WAIT
 236+ 8AF3 DF          >	rst #18
 237+ 8AF4 DB BB        	IN A,(CMD)
 238+ 8AF6 0F           	RRCA
 239+ 8AF7 30 0A        	JR NC,WAITCOM3
 240+ 8AF9 10 F8        	djnz WAITCOM2
 241+ 8AFB              gs_no
 242+ 8AFB 21 B4 8C     	ld hl,txt_no_GS
 243+ 8AFE              	OS_PRINTZ
 243+ 8AFE 0E 09       >    ld c,#09
 243+ 8B00 E7          >    rst #20
 244+ 8B01 37           	scf ;ошибка
 245+ 8B02 C9           	ret
 246+ 8B03              	;jr gs_no
 247+ 8B03              WAITCOM3
 248+ 8B03 DB B3        	in a,(DATA) ;количество страниц памяти?
 249+ 8B05 FE FF        	cp 255
 250+ 8B07 20 02        	jr nz,gs_yes
 251+ 8B09              	; ld hl,txt_err_GS
 252+ 8B09              	; call loader_print
 253+ 8B09 18 F0        	jr gs_no
 254+ 8B0B              gs_yes
 255+ 8B0B
 256+ 8B0B
 257+ 8B0B
 258+ 8B0B AF               xor a
 258+ 8B0C CD 7F 9A       call GeneralSound.init
 259+ 8B0F                  ; ld hl, .progress : call DialogBox.msgNoWait
 260+ 8B0F                  ; call makeRequest : jp c, Fetcher.fetchFromNet.error
 261+ 8B0F CD 8C 9A         call GeneralSound.loadModule
 262+ 8B12
 263+ 8B12 21 0C 9B     	ld hl,file_name_cur
 264+ 8B15              	OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 264+ 8B15 0E 21       >    ld c,#21
 264+ 8B17 E7          >    rst #20
 265+ 8B18
 266+ 8B18 DA B3 8B     	jp c,loadMod_fileopenerror
 267+ 8B1B 32 1D 9D     	ld (file_id_cur_r),a
 268+ 8B1E
 269+ 8B1E              loadMod_loop
 270+ 8B1E                  ;ld hl, buffer_cat, ;(buffer_pointer), hl
 271+ 8B1E                  ; call Wifi.getPacket
 272+ 8B1E                  ; ld a, (Wifi.closed) : and a : jr nz, .exit
 273+ 8B1E                  ; ld hl, buffer_cat, bc, (Wifi.bytes_avail)
 274+ 8B1E
 275+ 8B1E 3A 1D 9D     		ld a,(file_id_cur_r)
 276+ 8B21 21 00 C0     		ld hl,buffer_cat
 277+ 8B24 11 00 40             ld de,$4000
 278+ 8B27              		OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl - следующий адрес дл¤ чтени¤)
 278+ 8B27 0E 23       >    ld c,#23
 278+ 8B29 E7          >    rst #20
 279+ 8B2A DA B3 8B     		jp c,loadMod_fileopenerror
 280+ 8B2D
 281+ 8B2D 7C                   ld a,h
 282+ 8B2E FE C0        		cp $c0
 283+ 8B30 38 1B                jr c,loadLoop_4000    ;>= $c0, значит остаток файла
 284+ 8B32              		;остаток
 285+ 8B32 01 00 C0     		ld bc,#c000
 286+ 8B35 A7           		and a
 287+ 8B36 ED 42        		sbc hl,bc
 288+ 8B38 44 4D        		ld bc,hl
 289+ 8B3A 21 00 C0     		ld hl,buffer_cat
 290+ 8B3D              .loadLoop2
 291+ 8B3D 78               ld a, b
 291+ 8B3E B1             or c
 291+ 8B3F A7             and a
 291+ 8B40 28 22          jr z, loadMod_exit
 292+ 8B42 7E               ld a, (hl)
 292+ 8B43 CD 9F 9A       call GeneralSound.sendByte
 293+ 8B46 0B               dec bc
 294+ 8B47 23               inc hl
 295+ 8B48 18 F3            jr .loadLoop2
 296+ 8B4A C3 64 8B     	jp loadMod_exit
 297+ 8B4D
 298+ 8B4D
 299+ 8B4D              loadLoop_4000
 300+ 8B4D 21 00 C0     	ld hl,buffer_cat
 301+ 8B50 01 00 40     	ld bc,$4000 ;большой кусок для загрузки
 302+ 8B53
 303+ 8B53              .loadLoop
 304+ 8B53 78               ld a, b
 304+ 8B54 B1             or c
 304+ 8B55 A7             and a
 304+ 8B56 CA 61 8B       jp z, .nextFrame
 305+ 8B59 7E               ld a, (hl)
 305+ 8B5A CD 9F 9A       call GeneralSound.sendByte
 306+ 8B5D 0B               dec bc
 307+ 8B5E 23               inc hl
 308+ 8B5F 18 F2            jr .loadLoop
 309+ 8B61              .nextFrame
 310+ 8B61                  ;call Wifi.continue
 311+ 8B61 C3 1E 8B         jp loadMod_loop
 312+ 8B64              loadMod_exit
 313+ 8B64 CD A7 9A         call GeneralSound.finishLoadingModule
 314+ 8B67
 315+ 8B67 3A 1D 9D     	ld a,(file_id_cur_r)
 316+ 8B6A              	OS_FILE_CLOSE ;A - id file
 316+ 8B6A 0E 25       >    ld c,#25
 316+ 8B6C E7          >    rst #20
 317+ 8B6D                  ;jp History.back
 318+ 8B6D C3 70 8B     	jp play ;MediaProcessor.processResource
 319+ 8B70              ;.progress db "MOD downloading directly to GS!", 0
 320+ 8B70
 321+ 8B70                  macro GS_WaitCommand2
 322+ 8B70 ~            .wait
 323+ 8B70 ~                in a, (CMD)
 324+ 8B70 ~                rrca
 325+ 8B70 ~                jr c, .wait
 326+ 8B70                  endm
 327+ 8B70
 328+ 8B70                  macro GS_SendCommand2 nn
 329+ 8B70 ~                ld a, nn
 329+ 8B70 ~              out (CMD), a
 330+ 8B70                  endm
 331+ 8B70
 332+ 8B70              play:
 333+ 8B70
 334+ 8B70 21 9B 8C     	ld hl,txt_play
 335+ 8B73              	OS_PRINTZ
 335+ 8B73 0E 09       >    ld c,#09
 335+ 8B75 E7          >    rst #20
 336+ 8B76
 337+ 8B76 21 7E 8C         ld hl,txt_gplay_menu
 338+ 8B79              	OS_PRINTZ
 338+ 8B79 0E 09       >    ld c,#09
 338+ 8B7B E7          >    rst #20
 339+ 8B7C
 340+ 8B7C                  ; call Console.waitForKeyUp
 341+ 8B7C
 342+ 8B7C                  ; ld hl, Gopher.requestbuffer : call DialogBox.msgNoWait
 343+ 8B7C
 344+ 8B7C                  ; ;ld a, 1, (Render.play_next), a
 345+ 8B7C AF           	xor a
 346+ 8B7D 32 B0 8B     	ld (last_song_position),a
 347+ 8B80
 348+ 8B80              .loop
 349+ 8B80                  OS_WAIT
 349+ 8B80 DF          >	rst #18
 349+ 8B81
 350+ 8B81                  OS_GET_CHAR
 350+ 8B81 0E 10       >    ld c,#10
 350+ 8B83 E7          >    rst #20
 351+ 8B84 FE 20        	cp " " ;пробел
 352+ 8B86 CA AE 8B     	jp z, .stopKey
 353+ 8B89 FE 73        	cp "s" ;стоп
 354+ 8B8B CA AE 8B     	jp z, .stopKey
 355+ 8B8E FE 53        	cp "S" ;чтоп
 356+ 8B90 CA AE 8B     	jp z, .stopKey
 357+ 8B93              	;call printRTC
 358+ 8B93                  ;проверка что MOD начал играть сначала
 359+ 8B93                  GS_SendCommand2 CMD_GET_SONG_POSITION
 359+ 8B93 3E 60       >    ld a, CMD_GET_SONG_POSITION
 359+ 8B95 D3 BB       >  out (CMD), a
 360+ 8B97                  GS_WaitCommand2
 360+ 8B97             >.wait
 360+ 8B97 DB BB       >    in a, (CMD)
 360+ 8B99 0F          >    rrca
 360+ 8B9A 38 FB       >    jr c, .wait
 361+ 8B9C 3A B0 8B     	ld a,(last_song_position) ;предыдущая позиция
 362+ 8B9F 4F           	ld c,a
 363+ 8BA0 DB B3        	in a,(DATA) ;текущая позиция
 364+ 8BA2 32 B0 8B     	ld (last_song_position),a
 365+ 8BA5 B9           	cp c
 366+ 8BA6 30 D8        	jr nc, .loop ;если не меньше, продолжаем играть
 367+ 8BA8                  ;ld a, 1, (Render.play_next), a ;флаг что надо будет играть следующий файл
 368+ 8BA8              .stop
 369+ 8BA8 F5           	push af
 370+ 8BA9 CD C3 9A         call GeneralSound.stopModule
 371+ 8BAC F1           	pop af
 372+ 8BAD                  ;call Console.waitForKeyUp
 373+ 8BAD C9               ret
 374+ 8BAE              .stopKey
 375+ 8BAE                  ;xor a : ld (Render.play_next), a ;флаг что не надо играть следующий файл
 376+ 8BAE 18 F8            jr .stop
 377+ 8BB0
 378+ 8BB0
 379+ 8BB0              ;message db "Press key to stop...", 0
 380+ 8BB0
 381+ 8BB0
 382+ 8BB0              CMD_GET_SONG_POSITION     = #60
 383+ 8BB0 00           last_song_position db 0
 384+ 8BB1
 385+ 8BB1              ;; Control ports
 386+ 8BB1              CMD  = 187
 387+ 8BB1              DATA = 179
 388+ 8BB1
 389+ 8BB1 00 00        buffer_pointer dw 0;
 390+ 8BB3
 391+ 8BB3
 392+ 8BB3              loadMod_fileopenerror
 393+ 8BB3 21 DD 8C     		ld hl,txt_fopenerror
 394+ 8BB6              		OS_PRINTZ
 394+ 8BB6 0E 09       >    ld c,#09
 394+ 8BB8 E7          >    rst #20
 395+ 8BB9
 396+ 8BB9 3A 1D 9D     		ld a,(file_id_cur_r)
 397+ 8BBC FE FF        		cp 255
 398+ 8BBE 28 03        		jr z,loadMod_fileopenerror1
 399+ 8BC0              		OS_FILE_CLOSE ;A - id file
 399+ 8BC0 0E 25       >    ld c,#25
 399+ 8BC2 E7          >    rst #20
 400+ 8BC3              loadMod_fileopenerror1
 401+ 8BC3 37           		scf ;ошибка
 402+ 8BC4 C9           		ret
 403+ 8BC5
 404+ 8BC5
 405+ 8BC5
 406+ 8BC5
 407+ 8BC5              	;печать шкалы прогресса
 408+ 8BC5              gplay_progress_print
 409+ 8BC5 CD EE 8B     	call gplay_progress_calc
 410+ 8BC8 11 00 02     	ld de,#0200 ;прогресс тут
 411+ 8BCB              	OS_SET_XY
 411+ 8BCB 0E 01       >    ld c,#01
 411+ 8BCD E7          >    rst #20
 412+ 8BCE              	;печать закрашенных кубиков
 413+ 8BCE 3A 1E 8C     	ld a,(gplay_progress_val)
 414+ 8BD1 B7           	or a
 415+ 8BD2 28 08        	jr z,gplay_progress_print1
 416+ 8BD4 47           	ld b,a
 417+ 8BD5              gplay_progress_print1_cl
 418+ 8BD5 C5           	push bc
 419+ 8BD6 3E B1        	ld a,177 ;псевдографика
 420+ 8BD8              	OS_PRINT_CHARF
 420+ 8BD8 D7          >	rst #10
 421+ 8BD9 C1           	pop bc
 422+ 8BDA 10 F9        	djnz gplay_progress_print1_cl
 423+ 8BDC              gplay_progress_print1
 424+ 8BDC              	;печать пустых кубиков
 425+ 8BDC 3A 1E 8C     	ld a,(gplay_progress_val)
 426+ 8BDF 4F           	ld c,a
 427+ 8BE0 3E 10        	ld a,gplay_progress_lenght
 428+ 8BE2 91           	sub c
 429+ 8BE3 28 08        	jr z,gplay_progress_print2
 430+ 8BE5 47           	ld b,a
 431+ 8BE6              gplay_progress_print1_c2
 432+ 8BE6 C5           	push bc
 433+ 8BE7 3E B0        	ld a,176 ;псевдографика
 434+ 8BE9              	OS_PRINT_CHARF
 434+ 8BE9 D7          >	rst #10
 435+ 8BEA C1           	pop bc
 436+ 8BEB 10 F9        	djnz gplay_progress_print1_c2
 437+ 8BED
 438+ 8BED              gplay_progress_print2
 439+ 8BED C9           	ret
 440+ 8BEE
 441+ 8BEE
 442+ 8BEE              gplay_progress_calc
 443+ 8BEE 3A FF 8E     	ld a,(memorystreampages+255) ;всего страниц памяти занято
 444+ 8BF1 67           	ld h,a
 445+ 8BF2 2E 00        	ld l,0 ;всего страниц *256
 446+ 8BF4
 447+ 8BF4              	;разделить
 448+ 8BF4 CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 449+ 8BF6 CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 450+ 8BF8 CB 3C        	srl h ; /4
 451+ 8BFA CB 1D        	rr l ;
 452+ 8BFC CB 3C        	srl h ; /8
 453+ 8BFE CB 1D        	rr l ;
 454+ 8C00 CB 3C        	srl h ; /16
 455+ 8C02 CB 1D        	rr l ;
 456+ 8C04              	; srl h ; /32
 457+ 8C04              	; rr l ;
 458+ 8C04              	;узнали сколько страниц одно деление
 459+ 8C04 EB           	ex de,hl
 460+ 8C05
 461+ 8C05
 462+ 8C05 2A 0E 8F     	ld hl,(memorystreampageaddr)
 463+ 8C08 01 00 8E     	ld bc,memorystreampages
 464+ 8C0B A7           	and a
 465+ 8C0C ED 42        	sbc hl,bc ;какая по счёту страница сейчас
 466+ 8C0E
 467+ 8C0E 65           	ld h,l ;*256
 468+ 8C0F 2E 00        	ld l,0
 469+ 8C11
 470+ 8C11              	;разделить на величину одного деления
 471+ 8C11 3E FF        	ld a,-1
 472+ 8C13              divide16
 473+ 8C13 3C           	inc a
 474+ 8C14 A7           	and a
 475+ 8C15 ED 52        	sbc hl,de
 476+ 8C17 30 FA        	jr nc,divide16
 477+ 8C19 19           	add hl,de
 478+ 8C1A 32 1E 8C     	ld (gplay_progress_val),a
 479+ 8C1D C9           	ret
 480+ 8C1E
 481+ 8C1E              gplay_progress_lenght equ 16 ;длина шкалы
 482+ 8C1E 00           gplay_progress_val db 0;
 483+ 8C1F
 484+ 8C1F
 485+ 8C1F
 486+ 8C1F
 487+ 8C1F              toDecimal		;конвертирует 2 байта в 5 десятичных цифр
 488+ 8C1F              				;на входе в HL число
 489+ 8C1F 11 10 27     			ld de,10000 ;десятки тысяч
 490+ 8C22 3E FF        			ld a,255
 491+ 8C24              toDecimal10k
 492+ 8C24 A7           			and a
 493+ 8C25 ED 52        			sbc hl,de
 494+ 8C27 3C           			inc a
 495+ 8C28 30 FA        			jr nc,toDecimal10k
 496+ 8C2A 19           			add hl,de
 497+ 8C2B C6 30        			add a,48
 498+ 8C2D 32 78 8C     			ld (decimalS),a
 499+ 8C30 11 E8 03     			ld de,1000 ;тысячи
 500+ 8C33 3E FF        			ld a,255
 501+ 8C35              toDecimal1k
 502+ 8C35 A7           			and a
 503+ 8C36 ED 52        			sbc hl,de
 504+ 8C38 3C           			inc a
 505+ 8C39 30 FA        			jr nc,toDecimal1k
 506+ 8C3B 19           			add hl,de
 507+ 8C3C C6 30        			add a,48
 508+ 8C3E 32 79 8C     			ld (decimalS+1),a
 509+ 8C41 11 64 00     			ld de,100 ;сотни
 510+ 8C44 3E FF        			ld a,255
 511+ 8C46              toDecimal01k
 512+ 8C46 A7           			and a
 513+ 8C47 ED 52        			sbc hl,de
 514+ 8C49 3C           			inc a
 515+ 8C4A 30 FA        			jr nc,toDecimal01k
 516+ 8C4C 19           			add hl,de
 517+ 8C4D C6 30        			add a,48
 518+ 8C4F 32 7A 8C     			ld (decimalS+2),a
 519+ 8C52 11 0A 00     			ld de,10 ;десятки
 520+ 8C55 3E FF        			ld a,255
 521+ 8C57              toDecimal001k
 522+ 8C57 A7           			and a
 523+ 8C58 ED 52        			sbc hl,de
 524+ 8C5A 3C           			inc a
 525+ 8C5B 30 FA        			jr nc,toDecimal001k
 526+ 8C5D 19           			add hl,de
 527+ 8C5E C6 30        			add a,48
 528+ 8C60 32 7B 8C     			ld (decimalS+3),a
 529+ 8C63 11 01 00     			ld de,1 ;единицы
 530+ 8C66 3E FF        			ld a,255
 531+ 8C68              toDecimal0001k
 532+ 8C68 A7           			and a
 533+ 8C69 ED 52        			sbc hl,de
 534+ 8C6B 3C           			inc a
 535+ 8C6C 30 FA        			jr nc,toDecimal0001k
 536+ 8C6E 19           			add hl,de
 537+ 8C6F C6 30        			add a,48
 538+ 8C71 32 7C 8C     			ld (decimalS+4),a
 539+ 8C74 21 78 8C     			ld hl,decimalS
 540+ 8C77 C9           			ret
 541+ 8C78
 542+ 8C78 00 00 00...  decimalS	ds 6 ;десятичные цифры
 543+ 8C7E
 544+ 8C7E
 545+ 8C7E
 546+ 8C7E
 547+ 8C7E              ;file_id_cur db 0; временно
 548+ 8C7E
 549+ 8C7E 0D 0D 42 72  txt_gplay_menu db 13,13,"Break, S - stop ",13,"Sp - Next",0
 549+ 8C82 65 61 6B 2C
 549+ 8C86 20 53 20 2D
 549+ 8C8A 20 73 74 6F
 549+ 8C8E 70 20 0D 53
 549+ 8C92 70 20 2D 20
 549+ 8C96 4E 65 78 74
 549+ 8C9A 00
 550+ 8C9B 0D 50 6C 61  txt_play db 13,"Play... ",0
 550+ 8C9F 79 2E 2E 2E
 550+ 8CA3 20 00
 551+ 8CA5 0D 53 74 6F  txt_stop db 13,"Stop",0
 551+ 8CA9 70 00
 552+ 8CAB 0D 4C 6F 61  txt_load db 13,"Load...",0
 552+ 8CAF 64 2E 2E 2E
 552+ 8CB3 00
 553+ 8CB4 0D 47 53 20  txt_no_GS db 13,"GS not found!",0
 553+ 8CB8 6E 6F 74 20
 553+ 8CBC 66 6F 75 6E
 553+ 8CC0 64 21 00
 554+ 8CC3 0D 4D 65 6D  txt_memoryerror:    db 13,"Memory allocation error!",0
 554+ 8CC7 6F 72 79 20
 554+ 8CCB 61 6C 6C 6F
 554+ 8CCF 63 61 74 69
 554+ 8CD3 6F 6E 20 65
 554+ 8CD7 72 72 6F 72
 554+ 8CDB 21 00
 555+ 8CDD 0D 43 61 6E  txt_fopenerror:     db 13,"Cannot open file: ",0
 555+ 8CE1 6E 6F 74 20
 555+ 8CE5 6F 70 65 6E
 555+ 8CE9 20 66 69 6C
 555+ 8CED 65 3A 20 00
 556+ 8CF1
 557+ 8CF1              msg_title
 558+ 8CF1 47 50 6C 61  	db "GPlay ver 2025.08.07",10,13,0
 558+ 8CF5 79 20 76 65
 558+ 8CF9 72 20 32 30
 558+ 8CFD 32 35 2E 30
 558+ 8D01 38 2E 30 37
 558+ 8D05 0A 0D 00
 559+ 8D08
 560+ 8D08              vgm_plr
 561+ 8D08
 562+ 8D08              ;module equ 0xc000
 563+ 8D08              ;player_load = 0x8000 ;0x4000
 564+ 8D08
 565+ 8D08              ;ovl_start = 0x8000 ;0x4000
 566+ 8D08
 567+ 8D08              PLR_INIT  = vgm_plr ;0x4000
 568+ 8D08              PLR_PLAY  = vgm_plr+5 ;0x4005
 569+ 8D08              PLR_MUTE  = vgm_plr+8 ;0x4008
 570+ 8D08
 571+ 8D08              	include vgm.asm
# file opened: GPlay/vgm.asm
   1++8D08                      ;DEVICE ZXSPECTRUM48
   2++8D08                      ;include "../../../_sdk/sys_h.asm"
   3++8D08                      ;       ORG PROGSTART ;0x4000
   4++8D08
   5++8D08
   6++8D08
   7++8D08              ;memorystreamcurrentpage = 0x5100
   8++8D08              ;current_ram_page = 0x5100
   9++8D08
  10++8D08
  11++8D08              AREA_C000_FFFF   equ 1
  12++8D08
  13++8D08
  14++8D08
  15++8D08              module = $C000
  16++8D08
  17++8D08
  18++8D08
  19++8D08              begin
  20++8D08              START
  21++8D08 21 00 C0             	LD HL,module;MDLADDR ;DE - address of 2nd module for TS
  22++8D0B 18 06                	JR INIT
  23++8D0D C3 7A 95             	JP PLAY
  24++8D10 C3 6C 95             	JP MUTE
  25++8D13              INIT:
  26++8D13 C3 CF 94             jp init_
  27++8D16
  28++8D16              DEVICE_AY_BIT         = 0
  29++8D16              DEVICE_TURBOSOUND_BIT = 1
  30++8D16              DEVICE_TFM_BIT        = 2
  31++8D16              DEVICE_MOONSOUND_BIT  = 3
  32++8D16              DEVICE_GS_BIT         = 4
  33++8D16              DEVICE_NEOGS_BIT      = 5
  34++8D16              DEVICE_MIDI_UART_BIT  = 6
  35++8D16
  36++8D16              DEVICE_AY_MASK         = 1<<DEVICE_AY_BIT
  37++8D16              DEVICE_TURBOSOUND_MASK = 1<<DEVICE_TURBOSOUND_BIT
  38++8D16              DEVICE_TFM_MASK        = 1<<DEVICE_TFM_BIT
  39++8D16              DEVICE_MOONSOUND_MASK  = 1<<DEVICE_MOONSOUND_BIT
  40++8D16              DEVICE_GS_MASK         = 1<<DEVICE_GS_BIT
  41++8D16              DEVICE_NEOGS_MASK      = 1<<DEVICE_NEOGS_BIT
  42++8D16              DEVICE_MIDI_UART_MASK  = 1<<DEVICE_MIDI_UART_BIT
  43++8D16
  44++8D16
  45++8D16
  46++8D16
  47++8D16
  48++8D16              HEADER_DATA_OFFSET = module+0x34 ;0xC034
  49++8D16              HEADER_LOOP_SAMPLES_COUNT = module+0x20 ;0xC020
  50++8D16              HEADER_GD3_OFFSET = module+0x14 ;0xC014
  51++8D16              HEADER_SAMPLES_COUNT = module+0x18 ;0xC018
  52++8D16              HEADER_LOOP_OFFSET = module+0x1c ;0xC01c
  53++8D16
  54++8D16
  55++8D16              HEADER_SIZE_MAX = 256
  56++8D16              TITLELENGTH = 64
  57++8D16              MEMORYSTREAMMAXPAGES = 210
  58++8D16              MEMORYSTREAMERRORMASK = 255 ; TODO: do we need to enforce loading the entire file?
  59++8D16              ENABLE_FM = 1
  60++8D16
  61++8D16
  62++8D16
  63++8D16
  64++8D16
  65++8D16
  66++8D16
  67++8D16 00 00 00...          align 256   ;0x8100 ;0x4100
  68++8E00                      display "s98_file00_pages_list ",$
  69++8E00
  70++8E00 00 00 00...  memorystreampages: ds 256,0
  71++8F00              memorystreampagecount = memorystreampages + 255
  72++8F00
  73++8F00              	include "common/memorystream.asm"
# file opened: GPlay/common/memorystream.asm
   1++8F00              memorystreamstart
   2++8F00                      IF AREA_C000_FFFF=1
   3++8F00 21 00 00     	ld hl,0x0000
   4++8F03                      ELSE
   5++8F03 ~                    ld hl,0xffff
   6++8F03                      ENDIF
   7++8F03 22 72 8F     	ld (memorystreamcurrentaddr),hl
   8++8F06 21 00 8E     	ld hl,memorystreampages
   9++8F09 22 0E 8F     	ld (memorystreampageaddr),hl
  10++8F0C C9           	ret
  11++8F0D
  12++8F0D              memorystreamnextpage
  13++8F0D              memorystreampageaddr=$+1
  14++8F0D 21 00 00     	ld hl,0
  15++8F10 F5           	push af
  16++8F11 7E           	ld a,(hl)
  17++8F12 23           	inc hl
  18++8F13 32 7C 95     	ld (memorystreamcurrentpage),a
  19++8F16 22 0E 8F     	ld (memorystreampageaddr),hl
  20++8F19 C5           	push bc
  21++8F1A                      IF AREA_C000_FFFF=1
  22++8F1A              	;SETPGC000
  23++8F1A              	OS_SET_PAGE_SLOT3
  23++8F1A 0E 1C       >    ld c,#1c
  23++8F1C E7          >    rst #20
  24++8F1D C1           	pop bc
  25++8F1E F1           	pop af
  26++8F1F 21 00 C0     	ld hl,0xC000
  27++8F22                      ELSE
  28++8F22 ~                    SETPG8000
  29++8F22 ~                    pop bc
  30++8F22 ~                    pop af
  31++8F22 ~                    ld hl,0x8000
  32++8F22                      ENDIF
  33++8F22 C9           	ret
  34++8F23
  35++8F23              memorystreamskip
  36++8F23              ;b = byte count
  37++8F23 2A 72 8F     	ld hl,(memorystreamcurrentaddr)
  38++8F26              .loop
  39++8F26 CB 74        	bit 6,h
  40++8F28                      IF AREA_C000_FFFF=1
  41++8F28 CC 0D 8F     	call z,memorystreamnextpage
  42++8F2B                      ELSE
  43++8F2B ~             	call nz,memorystreamnextpage
  44++8F2B                      ENDIF
  45++8F2B 23           	inc hl
  46++8F2C 10 F8        	djnz .loop
  47++8F2E 22 72 8F     	ld (memorystreamcurrentaddr),hl
  48++8F31 C9           	ret
  49++8F32
  50++8F32              	macro memory_stream_write_byte src
  51++8F32 ~            	bit 6,h
  52++8F32 ~                    IF AREA_C000_FFFF=1
  53++8F32 ~            	call z,memorystreamnextpage
  54++8F32 ~                    ELSE
  55++8F32 ~             	call nz,memorystreamnextpage
  56++8F32 ~                    ENDIF
  57++8F32 ~            	ld (hl),src
  58++8F32 ~            	inc hl
  59++8F32              	endm
  60++8F32
  61++8F32              	macro memory_stream_read_byte dest
  62++8F32 ~            	bit 6,h
  63++8F32 ~                    IF AREA_C000_FFFF=1
  64++8F32 ~            	call z,memorystreamnextpage
  65++8F32 ~                    ELSE
  66++8F32 ~             	call nz,memorystreamnextpage
  67++8F32 ~                    ENDIF
  68++8F32 ~            	ld dest,(hl)
  69++8F32 ~            	inc hl
  70++8F32              	endm
  71++8F32
  72++8F32              	macro memory_stream_read_1 dst
  73++8F32 ~            	ld hl,(memorystreamcurrentaddr)
  74++8F32 ~            	memory_stream_read_byte dst
  75++8F32 ~            	ld (memorystreamcurrentaddr),hl
  76++8F32              	endm
  77++8F32
  78++8F32              	macro memory_stream_read_2 dst1,dst2
  79++8F32 ~            	ld hl,(memorystreamcurrentaddr)
  80++8F32 ~            	memory_stream_read_byte dst1
  81++8F32 ~            	memory_stream_read_byte dst2
  82++8F32 ~            	ld (memorystreamcurrentaddr),hl
  83++8F32              	endm
  84++8F32
  85++8F32              	macro memory_stream_read_3 dst1,dst2,dst3
  86++8F32 ~            	ld hl,(memorystreamcurrentaddr)
  87++8F32 ~            	memory_stream_read_byte dst1
  88++8F32 ~            	memory_stream_read_byte dst2
  89++8F32 ~            	memory_stream_read_byte dst3
  90++8F32 ~            	ld (memorystreamcurrentaddr),hl
  91++8F32              	endm
  92++8F32
  93++8F32              memorystreamread1
  94++8F32              ;out: a = byte
  95++8F32              	memory_stream_read_1 a
  95++8F32 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
  95++8F35             >	memory_stream_read_byte a
  95++8F35 CB 74       >	bit 6,h
  95++8F37             >        IF AREA_C000_FFFF=1
  95++8F37 CC 0D 8F    >	call z,memorystreamnextpage
  95++8F3A             >        ELSE
  95++8F3A ~           > 	call nz,memorystreamnextpage
  95++8F3A             >        ENDIF
  95++8F3A 7E          >	ld a,(hl)
  95++8F3B 23          >	inc hl
  95++8F3C 22 72 8F    >	ld (memorystreamcurrentaddr),hl
  96++8F3F C9           	ret
  97++8F40
  98++8F40              memorystreamread2
  99++8F40              ;out: de = word
 100++8F40              	memory_stream_read_2 e,d
 100++8F40 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 100++8F43             >	memory_stream_read_byte e
 100++8F43 CB 74       >	bit 6,h
 100++8F45             >        IF AREA_C000_FFFF=1
 100++8F45 CC 0D 8F    >	call z,memorystreamnextpage
 100++8F48             >        ELSE
 100++8F48 ~           > 	call nz,memorystreamnextpage
 100++8F48             >        ENDIF
 100++8F48 5E          >	ld e,(hl)
 100++8F49 23          >	inc hl
 100++8F4A             >	memory_stream_read_byte d
 100++8F4A CB 74       >	bit 6,h
 100++8F4C             >        IF AREA_C000_FFFF=1
 100++8F4C CC 0D 8F    >	call z,memorystreamnextpage
 100++8F4F             >        ELSE
 100++8F4F ~           > 	call nz,memorystreamnextpage
 100++8F4F             >        ENDIF
 100++8F4F 56          >	ld d,(hl)
 100++8F50 23          >	inc hl
 100++8F51 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 101++8F54 C9           	ret
 102++8F55
 103++8F55              memorystreamread3
 104++8F55              ;out: c = byte0, e = byte1, d = byte2
 105++8F55              	memory_stream_read_3 c,e,d
 105++8F55 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 105++8F58             >	memory_stream_read_byte c
 105++8F58 CB 74       >	bit 6,h
 105++8F5A             >        IF AREA_C000_FFFF=1
 105++8F5A CC 0D 8F    >	call z,memorystreamnextpage
 105++8F5D             >        ELSE
 105++8F5D ~           > 	call nz,memorystreamnextpage
 105++8F5D             >        ENDIF
 105++8F5D 4E          >	ld c,(hl)
 105++8F5E 23          >	inc hl
 105++8F5F             >	memory_stream_read_byte e
 105++8F5F CB 74       >	bit 6,h
 105++8F61             >        IF AREA_C000_FFFF=1
 105++8F61 CC 0D 8F    >	call z,memorystreamnextpage
 105++8F64             >        ELSE
 105++8F64 ~           > 	call nz,memorystreamnextpage
 105++8F64             >        ENDIF
 105++8F64 5E          >	ld e,(hl)
 105++8F65 23          >	inc hl
 105++8F66             >	memory_stream_read_byte d
 105++8F66 CB 74       >	bit 6,h
 105++8F68             >        IF AREA_C000_FFFF=1
 105++8F68 CC 0D 8F    >	call z,memorystreamnextpage
 105++8F6B             >        ELSE
 105++8F6B ~           > 	call nz,memorystreamnextpage
 105++8F6B             >        ENDIF
 105++8F6B 56          >	ld d,(hl)
 105++8F6C 23          >	inc hl
 105++8F6D 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 106++8F70 C9           	ret
 107++8F71
 108++8F71              memorystreamread4
 109++8F71              ;out: adbc = dword
 110++8F71              memorystreamcurrentaddr=$+1
 111++8F71 21 00 00     	ld hl,0
 112++8F74              	memory_stream_read_byte c
 112++8F74 CB 74       >	bit 6,h
 112++8F76             >        IF AREA_C000_FFFF=1
 112++8F76 CC 0D 8F    >	call z,memorystreamnextpage
 112++8F79             >        ELSE
 112++8F79 ~           > 	call nz,memorystreamnextpage
 112++8F79             >        ENDIF
 112++8F79 4E          >	ld c,(hl)
 112++8F7A 23          >	inc hl
 113++8F7B              	memory_stream_read_byte b
 113++8F7B CB 74       >	bit 6,h
 113++8F7D             >        IF AREA_C000_FFFF=1
 113++8F7D CC 0D 8F    >	call z,memorystreamnextpage
 113++8F80             >        ELSE
 113++8F80 ~           > 	call nz,memorystreamnextpage
 113++8F80             >        ENDIF
 113++8F80 46          >	ld b,(hl)
 113++8F81 23          >	inc hl
 114++8F82              	memory_stream_read_byte d
 114++8F82 CB 74       >	bit 6,h
 114++8F84             >        IF AREA_C000_FFFF=1
 114++8F84 CC 0D 8F    >	call z,memorystreamnextpage
 114++8F87             >        ELSE
 114++8F87 ~           > 	call nz,memorystreamnextpage
 114++8F87             >        ENDIF
 114++8F87 56          >	ld d,(hl)
 114++8F88 23          >	inc hl
 115++8F89              	memory_stream_read_byte a
 115++8F89 CB 74       >	bit 6,h
 115++8F8B             >        IF AREA_C000_FFFF=1
 115++8F8B CC 0D 8F    >	call z,memorystreamnextpage
 115++8F8E             >        ELSE
 115++8F8E ~           > 	call nz,memorystreamnextpage
 115++8F8E             >        ENDIF
 115++8F8E 7E          >	ld a,(hl)
 115++8F8F 23          >	inc hl
 116++8F90 22 72 8F     	ld (memorystreamcurrentaddr),hl
 117++8F93 C9           	ret
 118++8F94
 119++8F94              memorystreamread
 120++8F94              ;bc = number of bytes
 121++8F94              ;de = dest addr
 122++8F94 79           	ld a,c
 123++8F95 0B           	dec bc
 124++8F96 04           	inc b
 125++8F97 48           	ld c,b
 126++8F98 47           	ld b,a
 127++8F99 2A 72 8F     	ld hl,(memorystreamcurrentaddr)
 128++8F9C              .readloop
 129++8F9C              	memory_stream_read_byte a
 129++8F9C CB 74       >	bit 6,h
 129++8F9E             >        IF AREA_C000_FFFF=1
 129++8F9E CC 0D 8F    >	call z,memorystreamnextpage
 129++8FA1             >        ELSE
 129++8FA1 ~           > 	call nz,memorystreamnextpage
 129++8FA1             >        ENDIF
 129++8FA1 7E          >	ld a,(hl)
 129++8FA2 23          >	inc hl
 130++8FA3 12           	ld (de),a
 131++8FA4 13           	inc de
 132++8FA5 10 F5        	djnz .readloop
 133++8FA7 0D           	dec c
 134++8FA8 20 F2        	jr nz,.readloop
 135++8FAA 22 72 8F     	ld (memorystreamcurrentaddr),hl
 136++8FAD C9           	ret
 137++8FAE
 138++8FAE              memorystreamwrite
 139++8FAE              ;bc = number of bytes
 140++8FAE              ;de = src addr
 141++8FAE 79           	ld a,c
 142++8FAF 0B           	dec bc
 143++8FB0 04           	inc b
 144++8FB1 48           	ld c,b
 145++8FB2 47           	ld b,a
 146++8FB3 2A 72 8F     	ld hl,(memorystreamcurrentaddr)
 147++8FB6              .writeloop
 148++8FB6 1A           	ld a,(de)
 149++8FB7              	memory_stream_write_byte a
 149++8FB7 CB 74       >	bit 6,h
 149++8FB9             >        IF AREA_C000_FFFF=1
 149++8FB9 CC 0D 8F    >	call z,memorystreamnextpage
 149++8FBC             >        ELSE
 149++8FBC ~           > 	call nz,memorystreamnextpage
 149++8FBC             >        ENDIF
 149++8FBC 77          >	ld (hl),a
 149++8FBD 23          >	inc hl
 150++8FBE 13           	inc de
 151++8FBF 10 F5        	djnz .writeloop
 152++8FC1 0D           	dec c
 153++8FC2 20 F2        	jr nz,.writeloop
 154++8FC4 22 72 8F     	ld (memorystreamcurrentaddr),hl
 155++8FC7 C9           	ret
 156++8FC8
 157++8FC8              memorystreamseek
 158++8FC8              ;dehl = absolute position
 159++8FC8              ;out: hl = read address
 160++8FC8 7B           	ld a,e
 161++8FC9 44           	ld b,h
 162++8FCA CB 20        	sla b
 163++8FCC 17           	rla
 164++8FCD CB 20        	sla b
 165++8FCF 17           	rla
 166++8FD0 C6 00        	add a,memorystreampages%256
 167++8FD2 5F           	ld e,a
 168++8FD3 CE 8E        	adc a,memorystreampages/256
 169++8FD5 93           	sub e
 170++8FD6 57           	ld d,a
 171++8FD7 1A           	ld a,(de)
 172++8FD8 32 7C 95     	ld (memorystreamcurrentpage),a
 173++8FDB 13           	inc de
 174++8FDC ED 53 0E 8F  	ld (memorystreampageaddr),de
 175++8FE0                      IF AREA_C000_FFFF=1
 176++8FE0              	;SETPGC000
 177++8FE0 E5           	push hl ;*
 178++8FE1              	OS_SET_PAGE_SLOT3
 178++8FE1 0E 1C       >    ld c,#1c
 178++8FE3 E7          >    rst #20
 179++8FE4 E1           	pop hl ;*
 180++8FE5 CB F4                set 6,h
 181++8FE7                      ELSE
 182++8FE7 ~            	SETPG8000
 183++8FE7 ~            	res 6,h
 184++8FE7                      ENDIF
 185++8FE7 CB FC        	set 7,h
 186++8FE9 22 72 8F     	ld (memorystreamcurrentaddr),hl
 187++8FEC C9           	ret
 188++8FED
 189++8FED              memorystreamgetpos
 190++8FED              ;out: dehl = absolute position
 191++8FED 2A 0E 8F     	ld hl,(memorystreampageaddr)
 192++8FF0 11 FF 71     	ld de,-memorystreampages-1
 193++8FF3 19           	add hl,de
 194++8FF4 EB           	ex de,hl
 195++8FF5 2A 72 8F     	ld hl,(memorystreamcurrentaddr)
 196++8FF8
 197++8FF8                      IF AREA_C000_FFFF=1
 198++8FF8 CB 7C                bit 7,h
 199++8FFA CB BC                res 7,h
 200++8FFC CB B4                res 6,h
 201++8FFE 20 04        	jr nz,$+6
 202++9000                      ELSE
 203++9000 ~            	res 7,h
 204++9000 ~            	bit 6,h
 205++9000 ~            ;	jr z,$+6
 206++9000                      ENDIF
 207++9000 20 04        	jr nz,$+6
 208++9002 13           	inc de
 209++9003 21 00 00     	ld hl,0
 210++9006 AF           	xor a
 211++9007 CB 1B        	rr e
 212++9009 1F           	rra
 213++900A CB 1B        	rr e
 214++900C 1F           	rra
 215++900D B4           	or h
 216++900E 67           	ld h,a
 217++900F C9           	ret
 218++9010
 219++9010              memorystreamsize
 220++9010 00 00 00 00  	ds 4
 221++9014
# file closed: GPlay/common/memorystream.asm
  74++9014              	include "common/opl4.asm"
# file opened: GPlay/common/opl4.asm
   1++9014              	include "moonsound.asm"
# file opened: GPlay/common/moonsound.asm
   1++9014              MOON_BASE_HI = 0x00 ;старший байт
   2++9014              MOON_BASE = 0x24 ;0xc4
   3++9014              MOON_REG1 = MOON_BASE
   4++9014              MOON_DAT1 = MOON_BASE+1  ;c5
   5++9014              MOON_REG2 = MOON_BASE+2  ;c6
   6++9014              MOON_DAT2 = MOON_BASE+3  ;c7
   7++9014              MOON_STAT = MOON_BASE
   8++9014              MOON_WREG = 0xc2
   9++9014              MOON_WDAT = MOON_WREG+1
  10++9014
  11++9014              ;TODO: is this good enough for ATM2?
  12++9014              	macro opl4_wait
  13++9014 ~            	ld a,MOON_BASE_HI
  14++9014 ~            	in a,(MOON_STAT)
  15++9014 ~            	rrca
  16++9014 ~            	jr c,$-3
  17++9014              	endm
  18++9014
  19++9014              ;makes ZXM-Moonsound firmware 1.01 switch PCM ports from default 7E and 7F to C2 and C3
  20++9014              	macro switch_to_pcm_ports_c2_c3
  21++9014 ~            	ld a,MOON_BASE_HI
  22++9014 ~            	in a,(MOON_REG2)
  23++9014              	endm
  24++9014
  25++9014
  26++9014
  27++9014              NR_OF_MIDI_CHANNELS = 16
  28++9014              NR_OF_WAVE_CHANNELS = 24
  29++9014
  30++9014
  31++9014
  32++9014              MOONSOUNDROMSIZE = 0x200000
  33++9014              MOONWAVEHEADERSIZE = 12
  34++9014              MOONRAMWAVETABLESIZE = 128
  35++9014              OPL4MAXWAVECHANNELS = NR_OF_WAVE_CHANNELS
  36++9014
  37++9014              OPL4_TIMER1_COUNT   = 0x02
  38++9014              OPL4_TIMER2_COUNT   = 0x03
  39++9014              OPL4_TIMER_CONTROL  = 0x04
  40++9014
  41++9014
  42++9014
  43++9014
  44++9014              OPL4_REG_TEST0               = 0x00
  45++9014              OPL4_REG_TEST1               = 0x01
  46++9014
  47++9014              OPL4_REG_MEMORY_CONFIGURATION = 0x02
  48++9014              OPL4_MODE_BIT                 = 0x01
  49++9014              OPL4_MTYPE_BIT                = 0x02
  50++9014              OPL4_TONE_HEADER_MASK         = 0x1C
  51++9014              OPL4_DEVICE_ID_MASK           = 0xE0
  52++9014
  53++9014              OPL4_REG_MEMORY_ADDRESS_HIGH  = 0x03
  54++9014              OPL4_REG_MEMORY_ADDRESS_MID   = 0x04
  55++9014              OPL4_REG_MEMORY_ADDRESS_LOW   = 0x05
  56++9014              OPL4_REG_MEMORY_DATA          = 0x06
  57++9014
  58++9014 ~            /*
  59++9014 ~             * Offsets to the register banks for voices. To get the
  60++9014 ~             * register number just add the voice number to the bank offset.
  61++9014 ~             *
  62++9014 ~             * Wave Table Number low bits (0x08 to 0x1F)
  63++9014 ~             */
  64++9014              OPL4_REG_TONE_NUMBER  = 0x08
  65++9014
  66++9014 ~            /* Wave Table Number high bit, F-Number low bits (0x20 to 0x37) */
  67++9014              OPL4_REG_F_NUMBER      = 0x20
  68++9014              OPL4_TONE_NUMBER_BIT8  = 0x01
  69++9014              OPL4_F_NUMBER_LOW_MASK = 0xFE
  70++9014
  71++9014 ~            /* F-Number high bits, Octave, Pseudo-Reverb (0x38 to 0x4F) */
  72++9014              OPL4_REG_OCTAVE         = 0x38
  73++9014              OPL4_F_NUMBER_HIGH_MASK = 0x07
  74++9014              OPL4_BLOCK_MASK         = 0xF0
  75++9014              OPL4_PSEUDO_REVERB_BIT  = 0x08
  76++9014
  77++9014 ~            /* Total Level, Level Direct (0x50 to 0x67) */
  78++9014              OPL4_REG_LEVEL        = 0x50
  79++9014              OPL4_TOTAL_LEVEL_MASK = 0xFE
  80++9014              OPL4_LEVEL_DIRECT_BIT = 0x01
  81++9014
  82++9014 ~            /* Key On, Damp, LFO RST, CH, Panpot (0x68 to 0x7F) */
  83++9014              OPL4_REG_MISC           = 0x68
  84++9014              OPL4_KEY_ON_BIT         = 0x80
  85++9014              OPL4_DAMP_BIT           = 0x40
  86++9014              OPL4_LFO_RESET_BIT      = 0x20
  87++9014              OPL4_OUTPUT_CHANNEL_BIT = 0x10
  88++9014              OPL4_PAN_POT_MASK       = 0x0F
  89++9014
  90++9014 ~            /* LFO, VIB (0x80 to 0x97) */
  91++9014              OPL4_REG_LFO_VIBRATO    = 0x80
  92++9014              OPL4_LFO_FREQUENCY_MASK = 0x38
  93++9014              OPL4_VIBRATO_DEPTH_MASK = 0x07
  94++9014              OPL4_CHORUS_SEND_MASK   = 0xC0
  95++9014
  96++9014 ~            /* Attack / Decay 1 rate (0x98 to 0xAF) */
  97++9014              OPL4_REG_ATTACK_DECAY1  = 0x98
  98++9014              OPL4_ATTACK_RATE_MASK   = 0xF0
  99++9014              OPL4_DECAY1_RATE_MASK   = 0x0F
 100++9014
 101++9014 ~            /* Decay level / 2 rate (0xB0 to 0xC7) */
 102++9014              OPL4_REG_LEVEL_DECAY2  = 0xB0
 103++9014              OPL4_DECAY_LEVEL_MASK  = 0xF0
 104++9014              OPL4_DECAY2_RATE_MASK  = 0x0F
 105++9014
 106++9014 ~            /* Release rate / Rate correction (0xC8 to 0xDF) */
 107++9014              OPL4_REG_RELEASE_CORRECTION  = 0xC8
 108++9014              OPL4_RELEASE_RATE_MASK       = 0x0F
 109++9014              OPL4_RATE_INTERPOLATION_MASK = 0xF0
 110++9014
 111++9014 ~            /* AM (0xE0 to 0xF7) */
 112++9014              OPL4_REG_TREMOLO        = 0xE0
 113++9014              OPL4_TREMOLO_DEPTH_MASK = 0x07
 114++9014              OPL4_REVERB_SEND_MASK   = 0xE0
 115++9014
 116++9014 ~            /* Mixer */
 117++9014              OPL4_REG_MIX_CONTROL_FM  = 0xF8
 118++9014              OPL4_REG_MIX_CONTROL_PCM = 0xF9
 119++9014              OPL4_MIX_LEFT_MASK       = 0x07
 120++9014              OPL4_MIX_RIGHT_MASK      = 0x38
 121++9014
 122++9014              OPL4_REG_ATC             = 0xFA
 123++9014              OPL4_ATC_BIT             = 0x01
 124++9014
 125++9014 ~            /* Bits in the OPL4 Status register */
 126++9014              OPL4_STATUS_BUSY = 0x01
 127++9014              OPL4_STATUS_LOAD = 0x02
 128++9014
# file closed: GPlay/common/moonsound.asm
   2++9014
   3++9014              opl4writefm1
   4++9014              ;e = register
   5++9014              ;d = value
   6++9014              	opl4_wait
   6++9014 3E 00       >	ld a,MOON_BASE_HI
   6++9016 DB 24       >	in a,(MOON_STAT)
   6++9018 0F          >	rrca
   6++9019 38 FB       >	jr c,$-3
   7++901B 7B           	ld a,e
   8++901C C5           	push bc
   9++901D 06 00        	ld b,MOON_BASE_HI
  10++901F 0E 24        	ld c,MOON_REG1
  11++9021 ED 79        	out (c),a
  12++9023              	opl4_wait
  12++9023 3E 00       >	ld a,MOON_BASE_HI
  12++9025 DB 24       >	in a,(MOON_STAT)
  12++9027 0F          >	rrca
  12++9028 38 FB       >	jr c,$-3
  13++902A 7A           	ld a,d
  14++902B 06 00        	ld b,MOON_BASE_HI
  15++902D 0E 25        	ld c,MOON_DAT1
  16++902F ED 79        	out (c),a
  17++9031 C1           	pop bc
  18++9032 C9           	ret
  19++9033
  20++9033              opl4writefm2
  21++9033              ;e = register
  22++9033              ;d = value
  23++9033              	opl4_wait
  23++9033 3E 00       >	ld a,MOON_BASE_HI
  23++9035 DB 24       >	in a,(MOON_STAT)
  23++9037 0F          >	rrca
  23++9038 38 FB       >	jr c,$-3
  24++903A 7B           	ld a,e
  25++903B C5           	push bc
  26++903C 06 00        	ld b,MOON_BASE_HI
  27++903E 0E 26        	ld c,MOON_REG2
  28++9040 ED 79        	out (c),a
  29++9042              	opl4_wait
  29++9042 3E 00       >	ld a,MOON_BASE_HI
  29++9044 DB 24       >	in a,(MOON_STAT)
  29++9046 0F          >	rrca
  29++9047 38 FB       >	jr c,$-3
  30++9049 7A           	ld a,d
  31++904A 06 00        	ld b,MOON_BASE_HI
  32++904C 0E 27        	ld c,MOON_DAT2
  33++904E ED 79        	out (c),a
  34++9050 C1           	pop bc
  35++9051 C9           	ret
  36++9052
  37++9052              opl4writewave
  38++9052              ;e = register
  39++9052              ;d = value
  40++9052              	opl4_wait
  40++9052 3E 00       >	ld a,MOON_BASE_HI
  40++9054 DB 24       >	in a,(MOON_STAT)
  40++9056 0F          >	rrca
  40++9057 38 FB       >	jr c,$-3
  41++9059 7B           	ld a,e
  42++905A C5           	push bc
  43++905B 06 00        	ld b,MOON_BASE_HI
  44++905D 0E C2        	ld c,MOON_WREG
  45++905F ED 79        	out (c),a
  46++9061              	opl4_wait
  46++9061 3E 00       >	ld a,MOON_BASE_HI
  46++9063 DB 24       >	in a,(MOON_STAT)
  46++9065 0F          >	rrca
  46++9066 38 FB       >	jr c,$-3
  47++9068 7A           	ld a,d
  48++9069 06 00        	ld b,MOON_BASE_HI
  49++906B 0E C3        	ld c,MOON_WDAT
  50++906D ED 79        	out (c),a
  51++906F C1           	pop bc
  52++9070 C9           	ret
  53++9071
  54++9071              opl4readwave
  55++9071              ;e = register
  56++9071              	opl4_wait
  56++9071 3E 00       >	ld a,MOON_BASE_HI
  56++9073 DB 24       >	in a,(MOON_STAT)
  56++9075 0F          >	rrca
  56++9076 38 FB       >	jr c,$-3
  57++9078 7B           	ld a,e
  58++9079 C5           	push bc
  59++907A 06 00        	ld b,MOON_BASE_HI
  60++907C 0E C2        	ld c,MOON_WREG
  61++907E ED 79        	out (c),a
  62++9080 C1           	pop bc
  63++9081              	opl4_wait
  63++9081 3E 00       >	ld a,MOON_BASE_HI
  63++9083 DB 24       >	in a,(MOON_STAT)
  63++9085 0F          >	rrca
  63++9086 38 FB       >	jr c,$-3
  64++9088 3E 00        	ld a,MOON_BASE_HI
  65++908A DB C3        	in a,(MOON_WDAT)
  66++908C C9           	ret
  67++908D
  68++908D              	macro opl4_write_fm_regs
  69++908D ~            ;e = base register
  70++908D ~            ;d = value
  71++908D ~            ;b = count
  72++908D ~            .loop
  73++908D ~            	call opl4writefm1
  74++908D ~            	call opl4writefm2
  75++908D ~            	inc e
  76++908D ~            	djnz .loop
  77++908D              	endm
  78++908D
  79++908D              	macro opl4_write_wave_regs
  80++908D ~            ;e = base register
  81++908D ~            ;d = value
  82++908D ~            ;b = count
  83++908D ~            .loop
  84++908D ~            	call opl4writewave
  85++908D ~            	inc e
  86++908D ~            	djnz .loop
  87++908D              	endm
  88++908D
  89++908D              opl4init
  90++908D 11 05 03     	ld de,0x0305
  91++9090 CD 33 90     	call opl4writefm2
  92++9093 06 DA        	ld b,0xda
  93++9095 11 20 00     	ld de,0x0020
  94++9098              	opl4_write_wave_regs
  94++9098             >;e = base register
  94++9098             >;d = value
  94++9098             >;b = count
  94++9098             >.loop
  94++9098 CD 52 90    >	call opl4writewave
  94++909B 1C          >	inc e
  94++909C 10 FA       >	djnz .loop
  95++909E 11 F8 1B     	ld de,0x1bf8
  96++90A1 CD 52 90     	call opl4writewave
  97++90A4 11 02 10     	ld de,0x1002
  98++90A7 CD 52 90     	call opl4writewave
  99++90AA 06 D6        	ld b,0xd6
 100++90AC 11 20 00     	ld de,0x0020
 101++90AF              	opl4_write_fm_regs
 101++90AF             >;e = base register
 101++90AF             >;d = value
 101++90AF             >;b = count
 101++90AF             >.loop
 101++90AF CD 14 90    >	call opl4writefm1
 101++90B2 CD 33 90    >	call opl4writefm2
 101++90B5 1C          >	inc e
 101++90B6 10 F7       >	djnz .loop
 102++90B8 11 01 00     	ld de,0x0001
 103++90BB CD 14 90     	call opl4writefm1
 104++90BE 11 08 00     	ld de,0x0008
 105++90C1 CD 14 90     	call opl4writefm1
 106++90C4 11 04 00     	ld de,0x0004
 107++90C7 C3 33 90     	jp opl4writefm2
 108++90CA
 109++90CA              opl4stoptimers
 110++90CA 11 04 80     	ld de,0x8004
 111++90CD CD 14 90     	call opl4writefm1
 112++90D0 11 04 00     	ld de,0x0004
 113++90D3 C3 14 90     	jp opl4writefm1
 114++90D6
 115++90D6              opl4mute
 116++90D6 CD CA 90     	call opl4stoptimers
 117++90D9 11 04 00     	ld de,0x0004
 118++90DC CD 33 90     	call opl4writefm2
 119++90DF 11 BD 00     	ld de,0x00bd
 120++90E2 CD 14 90     	call opl4writefm1 ;rhythm off
 121++90E5 06 16        	ld b,0x16
 122++90E7 11 80 0F     	ld de,0x0f80
 123++90EA              	opl4_write_fm_regs ;max release rate
 123++90EA             >;e = base register
 123++90EA             >;d = value
 123++90EA             >;b = count
 123++90EA             >.loop
 123++90EA CD 14 90    >	call opl4writefm1
 123++90ED CD 33 90    >	call opl4writefm2
 123++90F0 1C          >	inc e
 123++90F1 10 F7       >	djnz .loop
 124++90F3 06 16        	ld b,0x16
 125++90F5 11 40 3F     	ld de,0x3f40
 126++90F8              	opl4_write_fm_regs ;min total level
 126++90F8             >;e = base register
 126++90F8             >;d = value
 126++90F8             >;b = count
 126++90F8             >.loop
 126++90F8 CD 14 90    >	call opl4writefm1
 126++90FB CD 33 90    >	call opl4writefm2
 126++90FE 1C          >	inc e
 126++90FF 10 F7       >	djnz .loop
 127++9101 06 09        	ld b,0x09
 128++9103 11 A0 00     	ld de,0x00a0
 129++9106              	opl4_write_fm_regs ;frequency 0
 129++9106             >;e = base register
 129++9106             >;d = value
 129++9106             >;b = count
 129++9106             >.loop
 129++9106 CD 14 90    >	call opl4writefm1
 129++9109 CD 33 90    >	call opl4writefm2
 129++910C 1C          >	inc e
 129++910D 10 F7       >	djnz .loop
 130++910F 06 09        	ld b,0x09
 131++9111 11 B0 00     	ld de,0x00b0
 132++9114              	opl4_write_fm_regs ;key off
 132++9114             >;e = base register
 132++9114             >;d = value
 132++9114             >;b = count
 132++9114             >.loop
 132++9114 CD 14 90    >	call opl4writefm1
 132++9117 CD 33 90    >	call opl4writefm2
 132++911A 1C          >	inc e
 132++911B 10 F7       >	djnz .loop
 133++911D 06 18        	ld b,0x18
 134++911F 11 68 40     	ld de,0x4068
 135++9122              	opl4_write_wave_regs ;key off, damp
 135++9122             >;e = base register
 135++9122             >;d = value
 135++9122             >;b = count
 135++9122             >.loop
 135++9122 CD 52 90    >	call opl4writewave
 135++9125 1C          >	inc e
 135++9126 10 FA       >	djnz .loop
 136++9128 11 05 00     	ld de,0x0005
 137++912B C3 33 90     	jp opl4writefm2
 138++912E
 139++912E              opl4setmemoryaddress
 140++912E              ;dhl = memory address
 141++912E 1E 03        	ld e,0x03
 142++9130 CD 52 90     	call opl4writewave
 143++9133 54           	ld d,h
 144++9134 1C           	inc e
 145++9135 CD 52 90     	call opl4writewave
 146++9138 1C           	inc e
 147++9139 55           	ld d,l
 148++913A C3 52 90     	jp opl4writewave
 149++913D
 150++913D              opl4readmemory
 151++913D              ;bc = byte count
 152++913D              ;dhl = memory address
 153++913D              ;ix = buffer
 154++913D CD 2E 91     	call opl4setmemoryaddress
 155++9140 11 02 11     	ld de,0x1102
 156++9143 CD 52 90     	call opl4writewave
 157++9146              	opl4_wait
 157++9146 3E 00       >	ld a,MOON_BASE_HI
 157++9148 DB 24       >	in a,(MOON_STAT)
 157++914A 0F          >	rrca
 157++914B 38 FB       >	jr c,$-3
 158++914D 3E 06        	ld a,6
 159++914F C5           	push bc
 160++9150 06 00        	ld b,MOON_BASE_HI
 161++9152 0E C2        	ld c,MOON_WREG
 162++9154 ED 79        	out (c),a
 163++9156 C1           	pop bc
 164++9157 DD 54 DD 5D  	ld de,ix
 165++915B 79           	ld a,c
 166++915C 0B           	dec bc
 167++915D 04           	inc b
 168++915E 48           	ld c,b
 169++915F 47           	ld b,a
 170++9160              .readloop
 171++9160              	opl4_wait
 171++9160 3E 00       >	ld a,MOON_BASE_HI
 171++9162 DB 24       >	in a,(MOON_STAT)
 171++9164 0F          >	rrca
 171++9165 38 FB       >	jr c,$-3
 172++9167 3E 00        	ld a,MOON_BASE_HI
 173++9169 DB C3        	in a,(MOON_WDAT)
 174++916B 12           	ld (de),a
 175++916C 13           	inc de
 176++916D 10 F1        	djnz .readloop
 177++916F 0D           	dec c
 178++9170 20 EE        	jr nz,.readloop
 179++9172 11 02 10     	ld de,0x1002
 180++9175 C3 52 90     	jp opl4writewave
 181++9178
 182++9178              opl4writememory
 183++9178              ;bc = number of bytes
 184++9178              ;dhl = memory address
 185++9178              ;ix = buffer
 186++9178 CD 2E 91     	call opl4setmemoryaddress
 187++917B 11 02 11     	ld de,0x1102
 188++917E CD 52 90     	call opl4writewave
 189++9181              	opl4_wait
 189++9181 3E 00       >	ld a,MOON_BASE_HI
 189++9183 DB 24       >	in a,(MOON_STAT)
 189++9185 0F          >	rrca
 189++9186 38 FB       >	jr c,$-3
 190++9188 3E 06        	ld a,6
 191++918A C5           	push bc
 192++918B 06 00        	ld b,MOON_BASE_HI
 193++918D 0E C2        	ld c,MOON_WREG
 194++918F ED 79        	out (c),a
 195++9191 C1           	pop bc
 196++9192 DD 54 DD 5D  	ld de,ix
 197++9196 79           	ld a,c
 198++9197 0B           	dec bc
 199++9198 04           	inc b
 200++9199 48           	ld c,b
 201++919A 47           	ld b,a
 202++919B              .writeloop
 203++919B              	opl4_wait
 203++919B 3E 00       >	ld a,MOON_BASE_HI
 203++919D DB 24       >	in a,(MOON_STAT)
 203++919F 0F          >	rrca
 203++91A0 38 FB       >	jr c,$-3
 204++91A2 1A           	ld a,(de)
 205++91A3 C5           	push bc
 206++91A4 06 00        	ld b,MOON_BASE_HI
 207++91A6 0E C3        	ld c,MOON_WDAT
 208++91A8 ED 79        	out (c),a
 209++91AA C1           	pop bc
 210++91AB 13           	inc de
 211++91AC 10 ED        	djnz .writeloop
 212++91AE 0D           	dec c
 213++91AF 20 EA        	jr nz,.writeloop
 214++91B1 11 02 10     	ld de,0x1002
 215++91B4 C3 52 90     	jp opl4writewave
 216++91B7
# file closed: GPlay/common/opl4.asm
  75++91B7              	include "common/opm.asm"
# file opened: GPlay/common/opm.asm
   1++91B7              ;Having chip 0 is mandatory for the player to detect YM2151,
   2++91B7              ;chip 1 is an optional second chip.
   3++91B7
   4++91B7              OPM0_REG = 0xf0c1 ;write: chip 0 address
   5++91B7              OPM0_DAT = 0xf1c1 ;write: chip 0 value, read: chip 0 status
   6++91B7              OPM1_REG = 0xf2c1 ;write: chip 1 address
   7++91B7              OPM1_DAT = 0xf3c1 ;write: chip 1 value, read: chip 1 status
   8++91B7
   9++91B7              	macro opm_write_reg reg,dat
  10++91B7 ~            ;bc = data port
  11++91B7 ~            ;e = register
  12++91B7 ~            ;d = value
  13++91B7 ~            	ld bc,dat
  14++91B7 ~            	in f,(c)
  15++91B7 ~            	jp m,$-2
  16++91B7 ~            	ld bc,reg
  17++91B7 ~            	out (c),e
  18++91B7 ~            	ld bc,dat
  19++91B7 ~            	in f,(c)
  20++91B7 ~            	jp m,$-2
  21++91B7 ~            	out (c),d
  22++91B7              	endm
  23++91B7
  24++91B7              opmwriteall
  25++91B7              ;e = register
  26++91B7              ;d = value
  27++91B7 CD D2 91     	call opmwritechip1
  28++91BA              opmwritechip0
  29++91BA              ;e = register
  30++91BA              ;d = value
  31++91BA              	opm_write_reg OPM0_REG,OPM0_DAT
  31++91BA             >;bc = data port
  31++91BA             >;e = register
  31++91BA             >;d = value
  31++91BA 01 C1 F1    >	ld bc,OPM0_DAT
  31++91BD ED 70       >	in f,(c)
  31++91BF FA BD 91    >	jp m,$-2
  31++91C2 01 C1 F0    >	ld bc,OPM0_REG
  31++91C5 ED 59       >	out (c),e
  31++91C7 01 C1 F1    >	ld bc,OPM0_DAT
  31++91CA ED 70       >	in f,(c)
  31++91CC FA CA 91    >	jp m,$-2
  31++91CF ED 51       >	out (c),d
  32++91D1 C9           	ret
  33++91D2
  34++91D2              opmwritechip1
  35++91D2              ;e = register
  36++91D2              ;d = value
  37++91D2              	opm_write_reg OPM1_REG,OPM1_DAT
  37++91D2             >;bc = data port
  37++91D2             >;e = register
  37++91D2             >;d = value
  37++91D2 01 C1 F3    >	ld bc,OPM1_DAT
  37++91D5 ED 70       >	in f,(c)
  37++91D7 FA D5 91    >	jp m,$-2
  37++91DA 01 C1 F2    >	ld bc,OPM1_REG
  37++91DD ED 59       >	out (c),e
  37++91DF 01 C1 F3    >	ld bc,OPM1_DAT
  37++91E2 ED 70       >	in f,(c)
  37++91E4 FA E2 91    >	jp m,$-2
  37++91E7 ED 51       >	out (c),d
  38++91E9 C9           	ret
  39++91EA
  40++91EA              opmdisablechip1
  41++91EA 3E C9        	ld a,0xc9 ;ret opcode
  42++91EC 32 D2 91     	ld (opmwritechip1),a
  43++91EF C9           	ret
  44++91F0
  45++91F0              	macro opm_write_regs incr,incd
  46++91F0 ~            ;e = base register
  47++91F0 ~            ;d = value
  48++91F0 ~            ;l = count
  49++91F0 ~            .loop	call opmwriteall
  50++91F0 ~            	IF incr
  51++91F0 ~            	inc e
  52++91F0 ~            	ENDIF
  53++91F0 ~            	IF incd
  54++91F0 ~            	inc d
  55++91F0 ~            	ENDIF
  56++91F0 ~            	dec l
  57++91F0 ~            	jr nz,.loop
  58++91F0              	endm
  59++91F0
  60++91F0              opminit
  61++91F0 2E 00        	ld l,0
  62++91F2 11 00 00     	ld de,0
  63++91F5              	opm_write_regs 1,0
  63++91F5             >;e = base register
  63++91F5             >;d = value
  63++91F5             >;l = count
  63++91F5 CD B7 91    >.loop	call opmwriteall
  63++91F8             >	IF 1
  63++91F8 1C          >	inc e
  63++91F9             >	ENDIF
  63++91F9             >	IF 0
  63++91F9 ~           >	inc d
  63++91F9             >	ENDIF
  63++91F9 2D          >	dec l
  63++91FA 20 F9       >	jr nz,.loop
  64++91FC C9           	ret
  65++91FD
  66++91FD              opmstoptimers
  67++91FD 11 14 30     	ld de,0x3014
  68++9200 CD B7 91     	call opmwriteall
  69++9203 11 14 00     	ld de,0x0014
  70++9206 C3 B7 91     	jp opmwriteall
  71++9209
  72++9209              opmmute
  73++9209 CD FD 91     	call opmstoptimers
  74++920C              ;max release rate
  75++920C 2E 20        	ld l,0x20
  76++920E 11 E0 0F     	ld de,0x0fe0
  77++9211              	opm_write_regs 1,0
  77++9211             >;e = base register
  77++9211             >;d = value
  77++9211             >;l = count
  77++9211 CD B7 91    >.loop	call opmwriteall
  77++9214             >	IF 1
  77++9214 1C          >	inc e
  77++9215             >	ENDIF
  77++9215             >	IF 0
  77++9215 ~           >	inc d
  77++9215             >	ENDIF
  77++9215 2D          >	dec l
  77++9216 20 F9       >	jr nz,.loop
  78++9218              ;min total level
  79++9218 2E 20        	ld l,0x20
  80++921A 11 60 7F     	ld de,0x7f60
  81++921D              	opm_write_regs 1,0
  81++921D             >;e = base register
  81++921D             >;d = value
  81++921D             >;l = count
  81++921D CD B7 91    >.loop	call opmwriteall
  81++9220             >	IF 1
  81++9220 1C          >	inc e
  81++9221             >	ENDIF
  81++9221             >	IF 0
  81++9221 ~           >	inc d
  81++9221             >	ENDIF
  81++9221 2D          >	dec l
  81++9222 20 F9       >	jr nz,.loop
  82++9224              ;key off
  83++9224 2E 08        	ld l,0x08
  84++9226 11 08 00     	ld de,0x0008
  85++9229              	opm_write_regs 0,1
  85++9229             >;e = base register
  85++9229             >;d = value
  85++9229             >;l = count
  85++9229 CD B7 91    >.loop	call opmwriteall
  85++922C             >	IF 0
  85++922C ~           >	inc e
  85++922C             >	ENDIF
  85++922C             >	IF 1
  85++922C 14          >	inc d
  85++922D             >	ENDIF
  85++922D 2D          >	dec l
  85++922E 20 F9       >	jr nz,.loop
  86++9230 C9           	ret
  87++9231
# file closed: GPlay/common/opm.asm
  76++9231              	include "vgm/opl4.asm"
# file opened: GPlay/vgm/opl4.asm
   1++9231              WAVEHEADERBUFFERSIZE = MOONRAMWAVETABLESIZE*MOONWAVEHEADERSIZE
   2++9231
   3++9231              opl4writemusiconlyfm1
   4++9231              ;skips writes to control registers
   5++9231              ;e = register
   6++9231              ;d = value
   7++9231 7B           	ld a,e
   8++9232 FE 20        	cp 0x20
   9++9234 D2 14 90     	jp nc,opl4writefm1
  10++9237 FE 08        	cp 0x08
  11++9239 C0           	ret nz
  12++923A C3 14 90     	jp opl4writefm1
  13++923D
  14++923D              opl4writemusiconlyfm2
  15++923D              ;skips writes to control registers
  16++923D              ;e = register
  17++923D              ;d = value
  18++923D 7B           	ld a,e
  19++923E FE 04        	cp 4
  20++9240 D8               ret c
  21++9241 FE 05        	cp 5
  22++9243 C8           	ret z
  23++9244 C3 33 90     	jp opl4writefm2
  24++9247
  25++9247              opl4writewavemusiconly
  26++9247              ;skips writes to control registers and handles ROM dumps
  27++9247              ;e = register
  28++9247              ;d = value
  29++9247 7B           	ld a,e
  30++9248 FE 38        	cp 0x38
  31++924A D2 52 90     	jp nc,opl4writewave
  32++924D FE 08        	cp 0x08
  33++924F D8           	ret c
  34++9250 FE 20        	cp 0x20
  35++9252 38 07        	jr c,writewavetableindexlo
  36++9254              ;force wave table index into 384--511 range if ROM data is loaded
  37++9254              isromloaded=$+1
  38++9254 3E 00        	ld a,0
  39++9256 B2           	or d
  40++9257 57           	ld d,a
  41++9258 C3 52 90     	jp opl4writewave
  42++925B              writewavetableindexlo
  43++925B 3A 55 92     	ld a,(isromloaded)
  44++925E 0F           	rrca
  45++925F B2           	or d
  46++9260 57           	ld d,a
  47++9261 CD 52 90     	call opl4writewave
  48++9264              ;wait for the header to load
  49++9264 3E 00        	ld a,MOON_BASE_HI
  50++9266 DB 24        	in a,(MOON_STAT)
  51++9268 E6 03        	and 3
  52++926A 20 FA        	jr nz,$-4
  53++926C C9           	ret
  54++926D
  55++926D              vgmopl4init
  56++926D AF           	xor a
  57++926E 32 55 92     	ld (isromloaded),a
  58++9271 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
  59++9274 22 B3 92     	ld (opl4loadramdatablockheader.romsize0),hl
  60++9277 3E 20        	ld a,MOONSOUNDROMSIZE/65536
  61++9279 32 B7 92     	ld (opl4loadramdatablockheader.romsize2),a
  62++927C C3 8D 90     	jp opl4init
  63++927F
  64++927F              sub24x16
  65++927F              ;dhl = minuend
  66++927F              ;bc = subtrahend
  67++927F              ;out: cf=1 if negative result, zf=1 if zero
  68++927F B7 ED 42     	sub hl,bc
  69++9282 38 04        	jr c,.carry
  70++9284 C0           	ret nz
  71++9285 7A           	ld a,d
  72++9286 B7           	or a
  73++9287 C9           	ret
  74++9288              .carry
  75++9288 7A           	ld a,d
  76++9289 DE 00        	sbc a,0
  77++928B 57           	ld d,a
  78++928C C0           	ret nz
  79++928D 7D           	ld a,l
  80++928E B4           	or h
  81++928F C9           	ret
  82++9290
  83++9290              opl4loadromdatablockheader
  84++9290              ;dhl = header+data size
  85++9290              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
  86++9290 D9           	exx
  87++9291 CD 71 8F     	call memorystreamread4 ;adbc = total rom size
  88++9294 ED 43 B3 92  	ld (opl4loadramdatablockheader.romsize0),bc
  89++9298 7A           	ld a,d
  90++9299 C6 20        	add 0x20 ;place in RAM
  91++929B 32 B7 92     	ld (opl4loadramdatablockheader.romsize2),a
  92++929E CD 71 8F     	call memorystreamread4 ;adbc = start address
  93++92A1 60 69        	ld hl,bc
  94++92A3 CB EA        	set 5,d ;place in RAM
  95++92A5 D9           	exx
  96++92A6 01 08 00     	ld bc,8
  97++92A9 18 D4        	jr sub24x16
  98++92AB
  99++92AB              opl4loadramdatablockheader
 100++92AB              ;dhl = header+data size
 101++92AB              ;out: zf=1 if no data to load, dhl = data block size, dhl' = start address
 102++92AB D9           	exx
 103++92AC CD 71 8F     	call memorystreamread4 ;adbc = total ram size
 104++92AF CD 71 8F     	call memorystreamread4 ;adbc = start address
 105++92B2              .romsize0=$+1
 106++92B2 21 00 00     	ld hl,0
 107++92B5 09           	add hl,bc
 108++92B6              .romsize2=$+1
 109++92B6 3E 00        	ld a,0
 110++92B8 8A           	adc a,d
 111++92B9 E6 3F        	and 0x3f
 112++92BB 57           	ld d,a
 113++92BC D9           	exx
 114++92BD 01 08 00     	ld bc,8
 115++92C0 18 BD        	jr sub24x16
 116++92C2
 117++92C2              setup24bitscounterloop
 118++92C2              ;dhl = counter
 119++92C2              ;out: b = inner loop counter, de = outer loop counter
 120++92C2 5D           	ld e,l
 121++92C3 01 01 00     	ld bc,1
 122++92C6 B7 ED 42     	sub hl,bc
 123++92C9 30 01        	jr nc,$+3
 124++92CB 15           	dec d
 125++92CC 43           	ld b,e
 126++92CD 5C           	ld e,h
 127++92CE 13           	inc de
 128++92CF C9           	ret
 129++92D0
 130++92D0              opl4loadsample
 131++92D0              ;dhl = sample start address
 132++92D0              ;dhl' = sample size
 133++92D0 42           	ld b,d
 134++92D1 11 05 03     	ld de,0x0305
 135++92D4 CD 33 90     	call opl4writefm2
 136++92D7 50           	ld d,b
 137++92D8 CD 2E 91     	call opl4setmemoryaddress
 138++92DB 11 02 11     	ld de,0x1102
 139++92DE CD 52 90     	call opl4writewave
 140++92E1              	opl4_wait
 140++92E1 3E 00       >	ld a,MOON_BASE_HI
 140++92E3 DB 24       >	in a,(MOON_STAT)
 140++92E5 0F          >	rrca
 140++92E6 38 FB       >	jr c,$-3
 141++92E8 3E 06        	ld a,6
 142++92EA C5           	push bc
 143++92EB 06 00        	ld b,MOON_BASE_HI
 144++92ED 0E C2        	ld c,MOON_WREG
 145++92EF ED 79        	out (c),a
 146++92F1 C1           	pop bc
 147++92F2 D9           	exx
 148++92F3 CD C2 92     	call setup24bitscounterloop
 149++92F6 2A 72 8F     	ld hl,(memorystreamcurrentaddr)
 150++92F9              .loop
 151++92F9              	memory_stream_read_byte c
 151++92F9 CB 74       >	bit 6,h
 151++92FB             >        IF AREA_C000_FFFF=1
 151++92FB CC 0D 8F    >	call z,memorystreamnextpage
 151++92FE             >        ELSE
 151++92FE ~           > 	call nz,memorystreamnextpage
 151++92FE             >        ENDIF
 151++92FE 4E          >	ld c,(hl)
 151++92FF 23          >	inc hl
 152++9300              	opl4_wait
 152++9300 3E 00       >	ld a,MOON_BASE_HI
 152++9302 DB 24       >	in a,(MOON_STAT)
 152++9304 0F          >	rrca
 152++9305 38 FB       >	jr c,$-3
 153++9307 79           	ld a,c
 154++9308 C5           	push bc
 155++9309 06 00        	ld b,MOON_BASE_HI
 156++930B 0E C3        	ld c,MOON_WDAT
 157++930D ED 79        	out (c),a
 158++930F C1           	pop bc
 159++9310 10 E7        	djnz .loop
 160++9312 1B           	dec de
 161++9313 7B           	ld a,e
 162++9314 B2           	or d
 163++9315 20 E2        	jr nz,.loop
 164++9317 22 72 8F     	ld (memorystreamcurrentaddr),hl
 165++931A 11 02 10     	ld de,0x1002
 166++931D C3 52 90     	jp opl4writewave
 167++9320
 168++9320              opl4loadramdatablock
 169++9320              ;dhl = data+header size
 170++9320 CD AB 92     	call opl4loadramdatablockheader
 171++9323 C8           	ret z
 172++9324 D9           	exx
 173++9325 18 A9        	jr opl4loadsample
 174++9327
 175++9327              opl4loadromdatablock
 176++9327              ;dhl = data+header size
 177++9327 CD 90 92     	call opl4loadromdatablockheader
 178++932A C8           	ret z
 179++932B D9           	exx
 180++932C D5           	push de
 181++932D CD D0 92     	call opl4loadsample
 182++9330 F1           	pop af
 183++9331              ;check if the address is within the first 64K of RAM
 184++9331 FE 21        	cp 0x21
 185++9333 D0           	ret nc
 186++9334              ;patch all 128 headers that LSI can read from RAM
 187++9334 3E 01        	ld a,1
 188++9336 32 55 92     	ld (isromloaded),a
 189++9339 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 190++933C 16 20        	ld d,MOONSOUNDROMSIZE/65536
 191++933E 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 192++9341 DD 21 00 B8  	ld ix,waveheaderbuffer
 193++9345 CD 3D 91     	call opl4readmemory
 194++9348 21 00 B8     	ld hl,waveheaderbuffer
 195++934B 11 0C 00     	ld de,MOONWAVEHEADERSIZE
 196++934E 06 80        	ld b,MOONRAMWAVETABLESIZE
 197++9350              .loop
 198++9350 CB EE        	set 5,(hl) ;set base address in RAM area
 199++9352 19           	add hl,de
 200++9353 10 FB        	djnz .loop
 201++9355 21 00 00     	ld hl,MOONSOUNDROMSIZE%65536
 202++9358 16 20        	ld d,MOONSOUNDROMSIZE/65536
 203++935A 01 00 06     	ld bc,WAVEHEADERBUFFERSIZE
 204++935D DD 21 00 B8  	ld ix,waveheaderbuffer
 205++9361 C3 78 91     	jp opl4writememory
 206++9364
 207++9364              opl4inittimer60hz
 208++9364 11 02 2F     	ld de,0x2f02
 209++9367 CD 14 90     	call opl4writefm1
 210++936A 11 04 21     	ld de,0x2104
 211++936D C3 14 90     	jp opl4writefm1
 212++9370
 213++9370              opl4waittimer60hz
 214++9370 3E 00        	ld a,MOON_BASE_HI
 215++9372 DB 24        	in a,(MOON_STAT)
 216++9374 17           	rla
 217++9375 30 F9        	jr nc,opl4waittimer60hz
 218++9377 11 04 81     	ld de,0x8104
 219++937A C3 14 90     	jp opl4writefm1
 220++937D
# file closed: GPlay/vgm/opl4.asm
  77++937D              	include "common/opn.asm"
# file opened: GPlay/common/opn.asm
   1++937D              ;Define ENABLE_FM to enable FM DACs
   2++937D
   3++937D              OPN_REG = 0xfffd
   4++937D              OPN_DAT = 0xbffd
   5++937D
   6++937D
   7++937D                      ifdef ENABLE_FM
   8++937D ~            CHIP0 = %11111000
   9++937D ~            CHIP1 = %11111001
  10++937D                      else
  11++937D              CHIP0 = %11111100
  12++937D              CHIP1 = %11111101
  13++937D                      endif
  14++937D
  15++937D
  16++937D              ;------------------------------------
  17++937D              opnwriteall
  18++937D CD A0 93     	call opnwritefm2
  19++9380              ;------------------------------------
  20++9380              opnwritefm1:
  21++9380              	;opn_write_fm_reg 0
  22++9380 3E FC              	ld a,CHIP0
  23++9382              opnwritefmx:
  24++9382              ;a = chipselect
  25++9382              ;e = register
  26++9382              ;d = value
  27++9382 01 FD FF     	ld bc,OPN_REG
  28++9385 ED 79        	out (c),a
  29++9387
  30++9387              1
  31++9387 00           	nop
  31++9388 00            nop
  32++9389              ;        nop:nop:nop
  33++9389 ED 70        	in f,(c)
  34++938B FA 87 93     	jp m, 1b ;$-6
  35++938E
  36++938E ED 59        	out (c),e
  37++9390
  38++9390              2
  39++9390 00             	nop
  39++9391 00            nop
  40++9392              ;        nop:nop:nop
  41++9392 ED 70        	in f,(c)
  42++9394 FA 90 93     	jp m,2b   ;$-6
  43++9397
  44++9397 06 BF        	ld b,HIGH OPN_DAT
  45++9399 ED 51        	out (c),d
  46++939B
  47++939B              .extradelay ;additional delay for FPGA systems
  48++939B 06 08        	ld b,8
  49++939D 10 FE        	djnz $
  50++939F C9           	ret
  51++93A0              ;------------------------------------
  52++93A0              opnwritefm2:
  53++93A0 3E FD               	ld a,CHIP1
  54++93A2 C3 82 93             jp opnwritefmx
  55++93A5              ;------------------------------------
  56++93A5
  57++93A5
  58++93A5              opndisableextradelay
  59++93A5 3E C9        	ld a,0xc9 ;ret opcode
  60++93A7 32 9B 93     	ld (opnwritefmx.extradelay),a
  61++93AA C9           	ret
  62++93AB
  63++93AB
  64++93AB              	macro opn_write_fm_regs incr,incd
  65++93AB ~            ;e = base register
  66++93AB ~            ;d = value
  67++93AB ~            ;l = count
  68++93AB ~            .loop	call opnwriteall
  69++93AB ~            	IF incr
  70++93AB ~            	inc e
  71++93AB ~            	ENDIF
  72++93AB ~            	IF incd
  73++93AB ~            	inc d
  74++93AB ~            	ENDIF
  75++93AB ~            	dec l
  76++93AB ~            	jr nz,.loop
  77++93AB              	endm
  78++93AB
  79++93AB
  80++93AB
  81++93AB              opninit
  82++93AB 2E B4        	ld l,0xb4
  83++93AD 11 00 00     	ld de,0x0000
  84++93B0              	opn_write_fm_regs 1,0
  84++93B0             >;e = base register
  84++93B0             >;d = value
  84++93B0             >;l = count
  84++93B0 CD 7D 93    >.loop	call opnwriteall
  84++93B3             >	IF 1
  84++93B3 1C          >	inc e
  84++93B4             >	ENDIF
  84++93B4             >	IF 0
  84++93B4 ~           >	inc d
  84++93B4             >	ENDIF
  84++93B4 2D          >	dec l
  84++93B5 20 F9       >	jr nz,.loop
  85++93B7              ;configure prescaler
  86++93B7 11 2F 00     	ld de,0x002f
  87++93BA CD 7D 93     	call opnwriteall
  88++93BD 11 2D 00     	ld de,0x002d
  89++93C0 C3 7D 93     	jp opnwriteall
  90++93C3
  91++93C3              opnstoptimers
  92++93C3 11 27 30     	ld de,0x3027
  93++93C6 CD 7D 93     	call opnwriteall
  94++93C9 11 27 00     	ld de,0x0027
  95++93CC C3 7D 93     	jp opnwriteall
  96++93CF
  97++93CF              opnmute
  98++93CF CD C3 93     	call opnstoptimers
  99++93D2              ;mute SSG
 100++93D2 2E 03        	ld l,3
 101++93D4 11 08 00     	ld de,0x0008
 102++93D7              	opn_write_fm_regs 1,0
 102++93D7             >;e = base register
 102++93D7             >;d = value
 102++93D7             >;l = count
 102++93D7 CD 7D 93    >.loop	call opnwriteall
 102++93DA             >	IF 1
 102++93DA 1C          >	inc e
 102++93DB             >	ENDIF
 102++93DB             >	IF 0
 102++93DB ~           >	inc d
 102++93DB             >	ENDIF
 102++93DB 2D          >	dec l
 102++93DC 20 F9       >	jr nz,.loop
 103++93DE 2E 0E        	ld l,14
 104++93E0 11 00 00     	ld de,0x0000
 105++93E3              	opn_write_fm_regs 1,0
 105++93E3             >;e = base register
 105++93E3             >;d = value
 105++93E3             >;l = count
 105++93E3 CD 7D 93    >.loop	call opnwriteall
 105++93E6             >	IF 1
 105++93E6 1C          >	inc e
 105++93E7             >	ENDIF
 105++93E7             >	IF 0
 105++93E7 ~           >	inc d
 105++93E7             >	ENDIF
 105++93E7 2D          >	dec l
 105++93E8 20 F9       >	jr nz,.loop
 106++93EA              ;max release rate
 107++93EA 2E 10        	ld l,0x10
 108++93EC 11 80 0F     	ld de,0x0f80
 109++93EF              	opn_write_fm_regs 1,0
 109++93EF             >;e = base register
 109++93EF             >;d = value
 109++93EF             >;l = count
 109++93EF CD 7D 93    >.loop	call opnwriteall
 109++93F2             >	IF 1
 109++93F2 1C          >	inc e
 109++93F3             >	ENDIF
 109++93F3             >	IF 0
 109++93F3 ~           >	inc d
 109++93F3             >	ENDIF
 109++93F3 2D          >	dec l
 109++93F4 20 F9       >	jr nz,.loop
 110++93F6              ;min total level
 111++93F6 2E 10        	ld l,0x10
 112++93F8 11 40 7F     	ld de,0x7f40
 113++93FB              	opn_write_fm_regs 1,0
 113++93FB             >;e = base register
 113++93FB             >;d = value
 113++93FB             >;l = count
 113++93FB CD 7D 93    >.loop	call opnwriteall
 113++93FE             >	IF 1
 113++93FE 1C          >	inc e
 113++93FF             >	ENDIF
 113++93FF             >	IF 0
 113++93FF ~           >	inc d
 113++93FF             >	ENDIF
 113++93FF 2D          >	dec l
 113++9400 20 F9       >	jr nz,.loop
 114++9402              ;key off
 115++9402 2E 04        	ld l,0x04
 116++9404 11 28 00     	ld de,0x0028
 117++9407              	opn_write_fm_regs 0,1
 117++9407             >;e = base register
 117++9407             >;d = value
 117++9407             >;l = count
 117++9407 CD 7D 93    >.loop	call opnwriteall
 117++940A             >	IF 0
 117++940A ~           >	inc e
 117++940A             >	ENDIF
 117++940A             >	IF 1
 117++940A 14          >	inc d
 117++940B             >	ENDIF
 117++940B 2D          >	dec l
 117++940C 20 F9       >	jr nz,.loop
 118++940E              ;default tfm state
 119++940E 01 FD FF     	ld bc,OPN_REG
 120++9411 3E FF        	ld a,%11111111
 121++9413 ED 79        	out (c),a
 122++9415 C9           	ret
 123++9416
# file closed: GPlay/common/opn.asm
  78++9416              	include "vgm/opn.asm"
# file opened: GPlay/vgm/opn.asm
   1++9416              opniscontrolregister
   2++9416              ;a = register
   3++9416              ;out: zf=1 if it's control register, zf=0 otherwise
   4++9416 FE 0E        	cp 0x0e ;IO port
   5++9418 C8           	ret z
   6++9419 FE 0F        	cp 0x0f ;IO port
   7++941B C8           	ret z
   8++941C FE 2D        	cp 0x2d ;prescaler
   9++941E C8           	ret z
  10++941F FE 2E        	cp 0x2e ;prescaler
  11++9421 C8           	ret z
  12++9422 FE 2F        	cp 0x2f ;prescaler
  13++9424 C9           	ret
  14++9425
  15++9425              opnwritemusiconlyfm1
  16++9425              ;skips writes to control registers
  17++9425              ;e = register
  18++9425              ;d = value
  19++9425 7B           	ld a,e
  20++9426 CD 16 94     	call opniscontrolregister
  21++9429 C8           	ret z
  22++942A FE 27        	cp 0x27 ;timers control
  23++942C C2 80 93     	jp nz,opnwritefm1
  24++942F 7A           	ld a,d
  25++9430 32 5E 94     	ld (opntimerctrl),a
  26++9433 F6 0A        	or %00001010 ;avoid altering timer B
  27++9435 57           	ld d,a
  28++9436 C3 80 93     	jp opnwritefm1
  29++9439
  30++9439              opnwritemusiconlyfm2
  31++9439              ;skips writes to control registers
  32++9439              ;e = register
  33++9439              ;d = value
  34++9439 7B           	ld a,e
  35++943A CD 16 94     	call opniscontrolregister
  36++943D C8           	ret z
  37++943E C3 A0 93     	jp opnwritefm2
  38++9441
  39++9441              opninittimer60hz
  40++9441              ;	ld de,0xc626
  41++9441              ;	ld de,0xca26
  42++9441 11 26 CD     	ld de,0xcd26
  43++9444 CD 80 93     	call opnwritefm1
  44++9447 11 27 2A     	ld de,0x2a27
  45++944A C3 80 93     	jp opnwritefm1
  46++944D
  47++944D              opnwaittimer60hz
  48++944D 01 FD FF     	ld bc,OPN_REG
  49++9450 3E F8        	ld a,%11111000
  50++9452 ED 79        	out (c),a
  51++9454              .waitloop
  52++9454 ED 78        	in a,(c)
  53++9456 E6 02        	and 2
  54++9458 28 FA        	jr z,.waitloop
  55++945A 11 27 2A     	ld de,0x2a27
  56++945D              opntimerctrl=$+1
  57++945D 3E 00        	ld a,0
  58++945F B2           	or d
  59++9460 57           	ld d,a
  60++9461 C3 80 93     	jp opnwritefm1
  61++9464
# file closed: GPlay/vgm/opn.asm
  79++9464              	include "vgm/opm.asm"
# file opened: GPlay/vgm/opm.asm
   1++9464              opmwritemusiconlychip0
   2++9464              ;e = register
   3++9464              ;d = value
   4++9464 7B           	ld a,e
   5++9465 FE 08        	cp 8
   6++9467 D8           	ret c
   7++9468 C3 BA 91     	jp opmwritechip0
   8++946B
   9++946B              opmwritemusiconlychip1
  10++946B              ;e = register
  11++946B              ;d = value
  12++946B 7B           	ld a,e
  13++946C FE 08        	cp 8
  14++946E D8           	ret c
  15++946F C3 D2 91     	jp opmwritechip1
  16++9472
  17++9472              vgmopminit
  18++9472 3E 02        	ld a,2
  19++9474 32 7B 94     	ld (opmwaittimer100hz.counter),a
  20++9477 C3 F0 91     	jp opminit
  21++947A
  22++947A              opmwaittimer100hz
  23++947A              .counter=$+1
  24++947A 3E 00        	ld a,0
  25++947C 3D           	dec a
  26++947D 20 02        	jr nz,$+4
  27++947F 3E 02        	ld a,2
  28++9481 32 7B 94     	ld (.counter),a
  29++9484 C8           	ret z
  30++9485              	;YIELD
  31++9485              	OS_WAIT
  31++9485 DF          >	rst #18
  32++9486 C9           	ret
  33++9487
# file closed: GPlay/vgm/opm.asm
  80++9487              	include "vgm/ssg.asm"
# file opened: GPlay/vgm/ssg.asm
   1++9487              SSG_REG = 0xfffd
   2++9487              SSG_DAT = 0xbffd
   3++9487
   4++9487              	macro ssg_write_reg chip_n
   5++9487 ~            ;e = register
   6++9487 ~            ;d = value
   7++9487 ~            	ld bc,SSG_REG
   8++9487 ~            	ld a,chip_n+%11111110
   9++9487 ~            	out (c),a
  10++9487 ~            	out (c),e
  11++9487 ~            	ld bc,SSG_DAT
  12++9487 ~            	out (c),d
  13++9487              	endm
  14++9487
  15++9487              ssgwritemusiconlychip0
  16++9487 7B           	ld a,e
  17++9488 FE 0E        	cp 0x0e
  18++948A D0           	ret nc
  19++948B              ssgwrite0
  20++948B              ;e = register
  21++948B              ;d = value
  22++948B              	ssg_write_reg 0
  22++948B             >;e = register
  22++948B             >;d = value
  22++948B 01 FD FF    >	ld bc,SSG_REG
  22++948E 3E FE       >	ld a,0+%11111110
  22++9490 ED 79       >	out (c),a
  22++9492 ED 59       >	out (c),e
  22++9494 01 FD BF    >	ld bc,SSG_DAT
  22++9497 ED 51       >	out (c),d
  23++9499 C9           	ret
  24++949A
  25++949A              ssgwritemusiconlychip1
  26++949A 7B           	ld a,e
  27++949B FE 0E        	cp 0x0e
  28++949D D0           	ret nc
  29++949E              ssgwrite1
  30++949E              ;e = register
  31++949E              ;d = value
  32++949E              	ssg_write_reg 1
  32++949E             >;e = register
  32++949E             >;d = value
  32++949E 01 FD FF    >	ld bc,SSG_REG
  32++94A1 3E FF       >	ld a,1+%11111110
  32++94A3 ED 79       >	out (c),a
  32++94A5 ED 59       >	out (c),e
  32++94A7 01 FD BF    >	ld bc,SSG_DAT
  32++94AA ED 51       >	out (c),d
  33++94AC C9           	ret
  34++94AD
  35++94AD              ssginit
  36++94AD C9           	ret
  37++94AE
  38++94AE              	macro ssg_write_regs
  39++94AE ~            ;e = base register
  40++94AE ~            ;d = value
  41++94AE ~            ;l = count
  42++94AE ~            .loop
  43++94AE ~            	call ssgwrite0
  44++94AE ~            	call ssgwrite1
  45++94AE ~            	inc e
  46++94AE ~            	dec l
  47++94AE ~            	jr nz,.loop
  48++94AE              	endm
  49++94AE
  50++94AE              ssgmute
  51++94AE 2E 03        	ld l,3
  52++94B0 11 08 00     	ld de,8
  53++94B3              	ssg_write_regs
  53++94B3             >;e = base register
  53++94B3             >;d = value
  53++94B3             >;l = count
  53++94B3             >.loop
  53++94B3 CD 8B 94    >	call ssgwrite0
  53++94B6 CD 9E 94    >	call ssgwrite1
  53++94B9 1C          >	inc e
  53++94BA 2D          >	dec l
  53++94BB 20 F6       >	jr nz,.loop
  54++94BD 2E 0E        	ld l,14
  55++94BF 11 00 00     	ld de,0
  56++94C2              	ssg_write_regs
  56++94C2             >;e = base register
  56++94C2             >;d = value
  56++94C2             >;l = count
  56++94C2             >.loop
  56++94C2 CD 8B 94    >	call ssgwrite0
  56++94C5 CD 9E 94    >	call ssgwrite1
  56++94C8 1C          >	inc e
  56++94C9 2D          >	dec l
  56++94CA 20 F6       >	jr nz,.loop
  57++94CC C9           	ret
  58++94CD
# file closed: GPlay/vgm/ssg.asm
  81++94CD
  82++94CD
  83++94CD
  84++94CD
  85++94CD
  86++94CD
  87++94CD              waittimer50hz
  88++94CD              	;YIELD
  89++94CD              	OS_WAIT
  89++94CD DF          >	rst #18
  90++94CE C9           	ret
  91++94CF
  92++94CF
  93++94CF              waveheaderbuffer = 0xc000-2048 ;0x5400 ;текущий размер буфера 1536 (128*12)
  94++94CF              waveheaderbufferend = waveheaderbuffer+WAVEHEADERBUFFERSIZE
  95++94CF              vgmheadercopy = waveheaderbufferend
  96++94CF              vgmheadercopyend = vgmheadercopy+HEADER_SIZE_MAX ;(ещё 256)
  97++94CF
  98++94CF              titlestr = waveheaderbufferend
  99++94CF              titlestrend = titlestr+TITLELENGTH
 100++94CF
 101++94CF
 102++94CF              HEADER_CLOCK_YM2203 = vgmheadercopy+0x44
 103++94CF              HEADER_CLOCK_YM3812 = vgmheadercopy+0x50
 104++94CF              HEADER_CLOCK_YMF262 = vgmheadercopy+0x5c
 105++94CF              HEADER_CLOCK_YMF278B = vgmheadercopy+0x60
 106++94CF              HEADER_CLOCK_AY8910 = vgmheadercopy+0x74
 107++94CF
 108++94CF
 109++94CF              	macro a_or_dw addr
 110++94CF ~            	ld hl,(addr+0)
 111++94CF ~            	or h
 112++94CF ~            	or l
 113++94CF ~            	ld de,(addr+2)
 114++94CF ~            	or d
 115++94CF ~            	or e
 116++94CF              	endm
 117++94CF
 118++94CF              	macro set_timer wait,ticks
 119++94CF ~            	ld hl,ticks
 120++94CF ~            	ld (waittimerstep),hl
 121++94CF              	endm
 122++94CF
 123++94CF
 124++94CF              init_:
 125++94CF              	set_timer waittimer50hz,882
 125++94CF 21 72 03    >	ld hl,882
 125++94D2 22 86 95    >	ld (waittimerstep),hl
 126++94D5 21 00 00     	ld hl,0
 127++94D8 22 81 95     	ld (waitcounterlo),hl
 128++94DB AF           	xor a
 129++94DC 32 84 95     	ld (waitcounterhi),a
 130++94DF 32 66 95     	ld (devicemask),a
 131++94E2
 132++94E2 32 7A 95           	ld (vgm_play_var),a
 133++94E5              ;map header to 0x8000
 134++94E5                      ;first page (vgm_header) now in page_plr3
 135++94E5                      ;now do init.
 136++94E5
 137++94E5              ;copy header
 138++94E5 01 00 01     	ld bc,HEADER_SIZE_MAX
 139++94E8 21 00 BE     	ld hl,vgmheadercopy
 140++94EB 11 01 BE     	ld de,vgmheadercopy+1
 141++94EE 36 00        	ld (hl),0
 142++94F0 ED B0        	ldir
 143++94F2 2A 34 C0     	ld hl,(HEADER_DATA_OFFSET)  ;если HEADER_DATA_OFFSET == 0 to bc = 0x0040 иначе  bc = 0x0034
 144++94F5 7C           	ld a,h
 145++94F6 B5           	or l
 146++94F7 01 40 00     	ld bc,0x40
 147++94FA 28 02        	jr z,$+4
 148++94FC 0E 34        	ld c,0x34
 149++94FE 09           	add hl,bc
 150++94FF 22 5D 95     	ld (.dataoffset),hl
 151++9502                            ;определяем сколько данных заголовка vgm нужно перекинуть в буфер исходя из значения HEADER_DATA_OFFSET
 152++9502 44 4D        	ld bc,hl
 153++9504 21 FF FE     	ld hl,-HEADER_SIZE_MAX-1
 154++9507 09           	add hl,bc
 155++9508 30 03        	jr nc,$+5
 156++950A 01 00 01     	ld bc,HEADER_SIZE_MAX
 157++950D
 158++950D 21 00 C0     	ld hl,module
 159++9510 11 00 BE     	ld de,vgmheadercopy
 160++9513 ED B0        	ldir
 161++9515              ;setup loop
 162++9515 AF           	xor a
 163++9516              	a_or_dw HEADER_LOOP_OFFSET
 163++9516 2A 1C C0    >	ld hl,(HEADER_LOOP_OFFSET+0)
 163++9519 B4          >	or h
 163++951A B5          >	or l
 163++951B ED 5B 1E C0 >	ld de,(HEADER_LOOP_OFFSET+2)
 163++951F B2          >	or d
 163++9520 B3          >	or e
 164++9521 22 84 97     	ld (loopoffsetlo),hl
 165++9524 ED 53 81 97  	ld (loopoffsethi),de
 166++9528              ;init Moonsound
 167++9528 AF           	xor a
 168++9529              	a_or_dw HEADER_CLOCK_YM3812
 168++9529 2A 50 BE    >	ld hl,(HEADER_CLOCK_YM3812+0)
 168++952C B4          >	or h
 168++952D B5          >	or l
 168++952E ED 5B 52 BE >	ld de,(HEADER_CLOCK_YM3812+2)
 168++9532 B2          >	or d
 168++9533 B3          >	or e
 169++9534 32 E2 99     	ld (useYM3812),a
 170++9537              	a_or_dw HEADER_CLOCK_YMF262
 170++9537 2A 5C BE    >	ld hl,(HEADER_CLOCK_YMF262+0)
 170++953A B4          >	or h
 170++953B B5          >	or l
 170++953C ED 5B 5E BE >	ld de,(HEADER_CLOCK_YMF262+2)
 170++9540 B2          >	or d
 170++9541 B3          >	or e
 171++9542 20 14        	jr nz,.opl4notneeded
 172++9544              	a_or_dw HEADER_CLOCK_YMF278B
 172++9544 2A 60 BE    >	ld hl,(HEADER_CLOCK_YMF278B+0)
 172++9547 B4          >	or h
 172++9548 B5          >	or l
 172++9549 ED 5B 62 BE >	ld de,(HEADER_CLOCK_YMF278B+2)
 172++954D B2          >	or d
 172++954E B3          >	or e
 173++954F 28 07        	jr z,.opl4notneeded
 174++9551 3A D4 99     	ld a,(moonsoundstatus)
 175++9554 FE 02        	cp 2
 176++9556 C0           	ret nz ;jp nz,memorystreamfree ;sets zf=0
 177++9557 B7           	or a
 178++9558              .opl4notneeded
 179++9558 C4 D3 99     	call nz,initYMF278B
 180++955B C0           	ret nz  ;jp nz,memorystreamfree ;sets zf=0
 181++955C              .dataoffset=$+1
 182++955C 21 00 00     	ld hl,0
 183++955F 11 00 00     	ld de,0
 184++9562                      ;init music
 185++9562 CD C8 8F     	call memorystreamseek
 186++9565              devicemask=$+1
 187++9565 3E 00        	ld a,0
 188++9567              ;zf=0 if there isn't any supported device
 189++9567 3D           	dec a
 190++9568 F8           	ret m
 191++9569 3C           	inc a
 192++956A BF           	cp a
 193++956B C9           	ret
 194++956C
 195++956C
 196++956C
 197++956C
 198++956C
 199++956C
 200++956C
 201++956C
 202++956C              MUTE:
 203++956C 3E C9                        ld a,$C9			;ret	;stop playing
 204++956E 32 7A 95                     ld (vgm_play_var),a
 205++9571 3A 66 95     		ld a,(devicemask)
 206++9574 E6 08        		and DEVICE_MOONSOUND_MASK
 207++9576 C4 D6 90     		call nz,opl4mute
 208++9579 C9                           ret
 209++957A
 210++957A
 211++957A
 212++957A
 213++957A
 214++957A
 215++957A
 216++957A              PLAY:
 217++957A              ;out: zf=0 if still playing, zf=1 otherwise
 218++957A              ;waittimercallback=$+1
 219++957A              ;	call 0
 220++957A
 221++957A              vgm_play_var = $
 221++957A 00             nop		;nop - play
 222++957B 3E 00                ld a,0                          ;(memorystreamcurrentpage)
 223++957D              memorystreamcurrentpage equ $-1
 224++957D                      IF AREA_C000_FFFF=1
 225++957D                          ;SETPGC000
 226++957D              			OS_SET_PAGE_SLOT3
 226++957D 0E 1C       >    ld c,#1c
 226++957F E7          >    rst #20
 227++9580                      ELSE
 228++9580 ~                        SETPG8000
 229++9580                      ENDIF
 230++9580              playloop
 231++9580              waitcounterlo=$+1
 232++9580 21 00 00     	ld hl,0
 233++9583              waitcounterhi=$+1
 234++9583 3E 00        	ld a,0
 235++9585              waittimerstep=$+1
 236++9585 01 00 00     	ld bc,0
 237++9588 B7 ED 42     	sub hl,bc
 238++958B 16 00        	ld d,0
 239++958D 9A           	sbc a,d
 240++958E 30 1A        	jr nc,exitplayloop
 241++9590              ;read command
 242++9590              	memory_stream_read_1 e
 242++9590 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 242++9593             >	memory_stream_read_byte e
 242++9593 CB 74       >	bit 6,h
 242++9595             >        IF AREA_C000_FFFF=1
 242++9595 CC 0D 8F    >	call z,memorystreamnextpage
 242++9598             >        ELSE
 242++9598 ~           > 	call nz,memorystreamnextpage
 242++9598             >        ENDIF
 242++9598 5E          >	ld e,(hl)
 242++9599 23          >	inc hl
 242++959A 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 243++959D 21 8E 97     	ld hl,cmdtable
 244++95A0 19           	add hl,de
 245++95A1 5E           	ld e,(hl)
 246++95A2 24           	inc h
 247++95A3 56           	ld d,(hl)
 248++95A4 21 80 95     	ld hl,playloop
 249++95A7 E5           	push hl
 250++95A8 EB           	ex hl,de
 251++95A9 E9           	jp (hl)
 252++95AA
 253++95AA              exitplayloop
 254++95AA 22 81 95     	ld (waitcounterlo),hl
 255++95AD 32 84 95     	ld (waitcounterhi),a
 256++95B0              ;continue playing
 257++95B0 F6 01        	or 1
 258++95B2 C9           	ret
 259++95B3
 260++95B3 21 81 95     wait1	ld hl,waitcounterlo
 261++95B6 34           	inc (hl)
 262++95B7 C0           	ret nz
 263++95B8 23           	inc hl
 264++95B9 34           	inc (hl)
 265++95BA C0           	ret nz
 266++95BB 21 84 95     	ld hl,waitcounterhi
 267++95BE 34           	inc (hl)
 268++95BF C9           	ret
 269++95C0
 270++95C0 3E 02        wait2	ld a,2
 271++95C2 21 81 95     waitn	ld hl,waitcounterlo
 272++95C5 86           	add a,(hl)
 273++95C6 77           	ld (hl),a
 274++95C7 D0           	ret nc
 275++95C8 23           	inc hl
 276++95C9 34           	inc (hl)
 277++95CA C0           	ret nz
 278++95CB 21 84 95     	ld hl,waitcounterhi
 279++95CE 34           	inc (hl)
 280++95CF C9           	ret
 281++95D0
 282++95D0 3E 03        wait3	ld a,3
 282++95D2 C3 C2 95       jp waitn
 283++95D5 3E 04        wait4	ld a,4
 283++95D7 C3 C2 95       jp waitn
 284++95DA 3E 05        wait5	ld a,5
 284++95DC C3 C2 95       jp waitn
 285++95DF 3E 06        wait6	ld a,6
 285++95E1 C3 C2 95       jp waitn
 286++95E4 3E 07        wait7	ld a,7
 286++95E6 C3 C2 95       jp waitn
 287++95E9 3E 08        wait8	ld a,8
 287++95EB C3 C2 95       jp waitn
 288++95EE 3E 09        wait9	ld a,9
 288++95F0 C3 C2 95       jp waitn
 289++95F3 3E 0A        wait10	ld a,10
 289++95F5 C3 C2 95       jp waitn
 290++95F8 3E 0B        wait11	ld a,11
 290++95FA C3 C2 95       jp waitn
 291++95FD 3E 0C        wait12	ld a,12
 291++95FF C3 C2 95       jp waitn
 292++9602 3E 0D        wait13	ld a,13
 292++9604 C3 C2 95       jp waitn
 293++9607 3E 0E        wait14	ld a,14
 293++9609 C3 C2 95       jp waitn
 294++960C 3E 0F        wait15	ld a,15
 294++960E C3 C2 95       jp waitn
 295++9611 3E 10        wait16	ld a,16
 295++9613 C3 C2 95       jp waitn
 296++9616
 297++9616 11 DF 02     wait735	ld de,735
 298++9619 2A 81 95     waitnn	ld hl,(waitcounterlo)
 299++961C 19           	add hl,de
 300++961D 22 81 95     	ld (waitcounterlo),hl
 301++9620 D0           	ret nc
 302++9621 21 84 95     	ld hl,waitcounterhi
 303++9624 34           	inc (hl)
 304++9625 C9           	ret
 305++9626
 306++9626 11 72 03     wait882	ld de,882
 307++9629 C3 19 96     	jp waitnn
 308++962C
 309++962C              waitvar	memory_stream_read_2 e,d
 309++962C 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 309++962F             >	memory_stream_read_byte e
 309++962F CB 74       >	bit 6,h
 309++9631             >        IF AREA_C000_FFFF=1
 309++9631 CC 0D 8F    >	call z,memorystreamnextpage
 309++9634             >        ELSE
 309++9634 ~           > 	call nz,memorystreamnextpage
 309++9634             >        ENDIF
 309++9634 5E          >	ld e,(hl)
 309++9635 23          >	inc hl
 309++9636             >	memory_stream_read_byte d
 309++9636 CB 74       >	bit 6,h
 309++9638             >        IF AREA_C000_FFFF=1
 309++9638 CC 0D 8F    >	call z,memorystreamnextpage
 309++963B             >        ELSE
 309++963B ~           > 	call nz,memorystreamnextpage
 309++963B             >        ENDIF
 309++963B 56          >	ld d,(hl)
 309++963C 23          >	inc hl
 309++963D 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 310++9640 2A 81 95     	ld hl,(waitcounterlo)
 311++9643 19           	add hl,de
 312++9644 22 81 95     	ld (waitcounterlo),hl
 313++9647 D0           	ret nc
 314++9648 21 84 95     	ld hl,waitcounterhi
 315++964B 34           	inc (hl)
 316++964C C9           	ret
 317++964D
 318++964D              	macro skip_n n
 319++964D ~            	ld b,n
 320++964D ~            	jp memorystreamskip
 321++964D              	endm
 322++964D
 323++964D C9           skip1	ret
 324++964E              skip2	skip_n 1
 324++964E 06 01       >	ld b,1
 324++9650 C3 23 8F    >	jp memorystreamskip
 325++9653              skip3	skip_n 2
 325++9653 06 02       >	ld b,2
 325++9655 C3 23 8F    >	jp memorystreamskip
 326++9658              skip4	skip_n 3
 326++9658 06 03       >	ld b,3
 326++965A C3 23 8F    >	jp memorystreamskip
 327++965D              skip5	skip_n 4
 327++965D 06 04       >	ld b,4
 327++965F C3 23 8F    >	jp memorystreamskip
 328++9662              skip6	skip_n 5
 328++9662 06 05       >	ld b,5
 328++9664 C3 23 8F    >	jp memorystreamskip
 329++9667              skip11	skip_n 10
 329++9667 06 0A       >	ld b,10
 329++9669 C3 23 8F    >	jp memorystreamskip
 330++966C              skip12	skip_n 11
 330++966C 06 0B       >	ld b,11
 330++966E C3 23 8F    >	jp memorystreamskip
 331++9671
 332++9671
 333++9671              endofsounddata
 334++9671                    ;  jp seektoloop ;здесь зацикливание, повтор
 335++9671 CD 10 8D     	  call PLR_MUTE ;выключить звук
 336++9674              cmdunsupported
 337++9674              ;stop playing
 338++9674 F1           	pop af
 339++9675 AF           	xor a
 340++9676 C9           	ret
 341++9677
 342++9677              cmdYM2203
 343++9677              	memory_stream_read_2 e,d
 343++9677 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 343++967A             >	memory_stream_read_byte e
 343++967A CB 74       >	bit 6,h
 343++967C             >        IF AREA_C000_FFFF=1
 343++967C CC 0D 8F    >	call z,memorystreamnextpage
 343++967F             >        ELSE
 343++967F ~           > 	call nz,memorystreamnextpage
 343++967F             >        ENDIF
 343++967F 5E          >	ld e,(hl)
 343++9680 23          >	inc hl
 343++9681             >	memory_stream_read_byte d
 343++9681 CB 74       >	bit 6,h
 343++9683             >        IF AREA_C000_FFFF=1
 343++9683 CC 0D 8F    >	call z,memorystreamnextpage
 343++9686             >        ELSE
 343++9686 ~           > 	call nz,memorystreamnextpage
 343++9686             >        ENDIF
 343++9686 56          >	ld d,(hl)
 343++9687 23          >	inc hl
 343++9688 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 344++968B C3 25 94     	jp opnwritemusiconlyfm1
 345++968E
 346++968E              cmdYM2203dp
 347++968E              	memory_stream_read_2 e,d
 347++968E 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 347++9691             >	memory_stream_read_byte e
 347++9691 CB 74       >	bit 6,h
 347++9693             >        IF AREA_C000_FFFF=1
 347++9693 CC 0D 8F    >	call z,memorystreamnextpage
 347++9696             >        ELSE
 347++9696 ~           > 	call nz,memorystreamnextpage
 347++9696             >        ENDIF
 347++9696 5E          >	ld e,(hl)
 347++9697 23          >	inc hl
 347++9698             >	memory_stream_read_byte d
 347++9698 CB 74       >	bit 6,h
 347++969A             >        IF AREA_C000_FFFF=1
 347++969A CC 0D 8F    >	call z,memorystreamnextpage
 347++969D             >        ELSE
 347++969D ~           > 	call nz,memorystreamnextpage
 347++969D             >        ENDIF
 347++969D 56          >	ld d,(hl)
 347++969E 23          >	inc hl
 347++969F 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 348++96A2 C3 39 94     	jp opnwritemusiconlyfm2
 349++96A5
 350++96A5              cmdYMF278B
 351++96A5              	memory_stream_read_3 c,e,d
 351++96A5 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 351++96A8             >	memory_stream_read_byte c
 351++96A8 CB 74       >	bit 6,h
 351++96AA             >        IF AREA_C000_FFFF=1
 351++96AA CC 0D 8F    >	call z,memorystreamnextpage
 351++96AD             >        ELSE
 351++96AD ~           > 	call nz,memorystreamnextpage
 351++96AD             >        ENDIF
 351++96AD 4E          >	ld c,(hl)
 351++96AE 23          >	inc hl
 351++96AF             >	memory_stream_read_byte e
 351++96AF CB 74       >	bit 6,h
 351++96B1             >        IF AREA_C000_FFFF=1
 351++96B1 CC 0D 8F    >	call z,memorystreamnextpage
 351++96B4             >        ELSE
 351++96B4 ~           > 	call nz,memorystreamnextpage
 351++96B4             >        ENDIF
 351++96B4 5E          >	ld e,(hl)
 351++96B5 23          >	inc hl
 351++96B6             >	memory_stream_read_byte d
 351++96B6 CB 74       >	bit 6,h
 351++96B8             >        IF AREA_C000_FFFF=1
 351++96B8 CC 0D 8F    >	call z,memorystreamnextpage
 351++96BB             >        ELSE
 351++96BB ~           > 	call nz,memorystreamnextpage
 351++96BB             >        ENDIF
 351++96BB 56          >	ld d,(hl)
 351++96BC 23          >	inc hl
 351++96BD 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 352++96C0 0D           	dec c
 353++96C1 CA 3D 92     	jp z,opl4writemusiconlyfm2
 354++96C4 F2 47 92     	jp p,opl4writewavemusiconly
 355++96C7 C3 31 92     	jp opl4writemusiconlyfm1
 356++96CA
 357++96CA              cmdYMF262p0
 358++96CA              cmdYM3812
 359++96CA              cmdY8950
 360++96CA              cmdYM3526
 361++96CA              	memory_stream_read_2 e,d
 361++96CA 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 361++96CD             >	memory_stream_read_byte e
 361++96CD CB 74       >	bit 6,h
 361++96CF             >        IF AREA_C000_FFFF=1
 361++96CF CC 0D 8F    >	call z,memorystreamnextpage
 361++96D2             >        ELSE
 361++96D2 ~           > 	call nz,memorystreamnextpage
 361++96D2             >        ENDIF
 361++96D2 5E          >	ld e,(hl)
 361++96D3 23          >	inc hl
 361++96D4             >	memory_stream_read_byte d
 361++96D4 CB 74       >	bit 6,h
 361++96D6             >        IF AREA_C000_FFFF=1
 361++96D6 CC 0D 8F    >	call z,memorystreamnextpage
 361++96D9             >        ELSE
 361++96D9 ~           > 	call nz,memorystreamnextpage
 361++96D9             >        ENDIF
 361++96D9 56          >	ld d,(hl)
 361++96DA 23          >	inc hl
 361++96DB 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 362++96DE C3 31 92     	jp opl4writemusiconlyfm1
 363++96E1
 364++96E1              cmdYMF262p1
 365++96E1              cmdYM3812dp
 366++96E1              cmdY8950dp
 367++96E1              cmdYM3526dp
 368++96E1              	memory_stream_read_2 e,d
 368++96E1 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 368++96E4             >	memory_stream_read_byte e
 368++96E4 CB 74       >	bit 6,h
 368++96E6             >        IF AREA_C000_FFFF=1
 368++96E6 CC 0D 8F    >	call z,memorystreamnextpage
 368++96E9             >        ELSE
 368++96E9 ~           > 	call nz,memorystreamnextpage
 368++96E9             >        ENDIF
 368++96E9 5E          >	ld e,(hl)
 368++96EA 23          >	inc hl
 368++96EB             >	memory_stream_read_byte d
 368++96EB CB 74       >	bit 6,h
 368++96ED             >        IF AREA_C000_FFFF=1
 368++96ED CC 0D 8F    >	call z,memorystreamnextpage
 368++96F0             >        ELSE
 368++96F0 ~           > 	call nz,memorystreamnextpage
 368++96F0             >        ENDIF
 368++96F0 56          >	ld d,(hl)
 368++96F1 23          >	inc hl
 368++96F2 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 369++96F5 C3 3D 92     	jp opl4writemusiconlyfm2
 370++96F8
 371++96F8              cmdYM2151
 372++96F8              	memory_stream_read_2 e,d
 372++96F8 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 372++96FB             >	memory_stream_read_byte e
 372++96FB CB 74       >	bit 6,h
 372++96FD             >        IF AREA_C000_FFFF=1
 372++96FD CC 0D 8F    >	call z,memorystreamnextpage
 372++9700             >        ELSE
 372++9700 ~           > 	call nz,memorystreamnextpage
 372++9700             >        ENDIF
 372++9700 5E          >	ld e,(hl)
 372++9701 23          >	inc hl
 372++9702             >	memory_stream_read_byte d
 372++9702 CB 74       >	bit 6,h
 372++9704             >        IF AREA_C000_FFFF=1
 372++9704 CC 0D 8F    >	call z,memorystreamnextpage
 372++9707             >        ELSE
 372++9707 ~           > 	call nz,memorystreamnextpage
 372++9707             >        ENDIF
 372++9707 56          >	ld d,(hl)
 372++9708 23          >	inc hl
 372++9709 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 373++970C C3 64 94     	jp opmwritemusiconlychip0
 374++970F
 375++970F              cmdYM2151dp
 376++970F              	memory_stream_read_2 e,d
 376++970F 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 376++9712             >	memory_stream_read_byte e
 376++9712 CB 74       >	bit 6,h
 376++9714             >        IF AREA_C000_FFFF=1
 376++9714 CC 0D 8F    >	call z,memorystreamnextpage
 376++9717             >        ELSE
 376++9717 ~           > 	call nz,memorystreamnextpage
 376++9717             >        ENDIF
 376++9717 5E          >	ld e,(hl)
 376++9718 23          >	inc hl
 376++9719             >	memory_stream_read_byte d
 376++9719 CB 74       >	bit 6,h
 376++971B             >        IF AREA_C000_FFFF=1
 376++971B CC 0D 8F    >	call z,memorystreamnextpage
 376++971E             >        ELSE
 376++971E ~           > 	call nz,memorystreamnextpage
 376++971E             >        ENDIF
 376++971E 56          >	ld d,(hl)
 376++971F 23          >	inc hl
 376++9720 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 377++9723 C3 6B 94     	jp opmwritemusiconlychip1
 378++9726
 379++9726              cmdAY8910
 380++9726              	memory_stream_read_2 e,d
 380++9726 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 380++9729             >	memory_stream_read_byte e
 380++9729 CB 74       >	bit 6,h
 380++972B             >        IF AREA_C000_FFFF=1
 380++972B CC 0D 8F    >	call z,memorystreamnextpage
 380++972E             >        ELSE
 380++972E ~           > 	call nz,memorystreamnextpage
 380++972E             >        ENDIF
 380++972E 5E          >	ld e,(hl)
 380++972F 23          >	inc hl
 380++9730             >	memory_stream_read_byte d
 380++9730 CB 74       >	bit 6,h
 380++9732             >        IF AREA_C000_FFFF=1
 380++9732 CC 0D 8F    >	call z,memorystreamnextpage
 380++9735             >        ELSE
 380++9735 ~           > 	call nz,memorystreamnextpage
 380++9735             >        ENDIF
 380++9735 56          >	ld d,(hl)
 380++9736 23          >	inc hl
 380++9737 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 381++973A CB 7B        	bit 7,e
 382++973C CA 87 94     	jp z,ssgwritemusiconlychip0
 383++973F CB BB        	res 7,e
 384++9741 C3 9A 94     	jp ssgwritemusiconlychip1
 385++9744
 386++9744              cmdYMF262dp0 equ memorystreamread2
 387++9744              cmdYMF262dp1 equ memorystreamread2
 388++9744
 389++9744              cmddatablock
 390++9744              	memory_stream_read_2 a,e ;a = 0x66 guard, e = type
 390++9744 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 390++9747             >	memory_stream_read_byte a
 390++9747 CB 74       >	bit 6,h
 390++9749             >        IF AREA_C000_FFFF=1
 390++9749 CC 0D 8F    >	call z,memorystreamnextpage
 390++974C             >        ELSE
 390++974C ~           > 	call nz,memorystreamnextpage
 390++974C             >        ENDIF
 390++974C 7E          >	ld a,(hl)
 390++974D 23          >	inc hl
 390++974E             >	memory_stream_read_byte e
 390++974E CB 74       >	bit 6,h
 390++9750             >        IF AREA_C000_FFFF=1
 390++9750 CC 0D 8F    >	call z,memorystreamnextpage
 390++9753             >        ELSE
 390++9753 ~           > 	call nz,memorystreamnextpage
 390++9753             >        ENDIF
 390++9753 5E          >	ld e,(hl)
 390++9754 23          >	inc hl
 390++9755 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 391++9758 FE 66        	cp 0x66
 392++975A C2 74 96     	jp nz,cmdunsupported
 393++975D              processdatablock
 394++975D              ;e = data type
 395++975D CD 71 8F     	call memorystreamread4 ;adbc = data size
 396++9760 7B           	ld a,e
 397++9761 60 69        	ld hl,bc
 398++9763              ;	cp 0x81
 399++9763              ;	jp z,opnaloaddatablock
 400++9763 FE 84        	cp 0x84
 401++9765 CA 27 93     	jp z,opl4loadromdatablock
 402++9768 FE 87        	cp 0x87
 403++976A CA 20 93     	jp z,opl4loadramdatablock
 404++976D D5           	push de
 405++976E C5           	push bc
 406++976F CD ED 8F     	call memorystreamgetpos
 407++9772 C1           	pop bc
 408++9773 F1           	pop af
 409++9774 09           	add hl,bc
 410++9775 8B           	adc a,e
 411++9776 5F           	ld e,a
 412++9777 8A           	adc a,d
 413++9778 93           	sub e
 414++9779 57           	ld d,a
 415++977A C3 C8 8F     	jp memorystreamseek
 416++977D
 417++977D
 418++977D              seektoloop
 419++977D 01 1C 00     	ld bc,0x1c
 420++9780              loopoffsethi=$+1
 421++9780 11 00 00     	ld de,0
 422++9783              loopoffsetlo=$+1
 423++9783 21 00 00     	ld hl,0
 424++9786              seektopos
 425++9786              ;dehl + bc = position
 426++9786              ;out: hl = read address
 427++9786 09           	add hl,bc
 428++9787 D2 C8 8F     	jp nc,memorystreamseek
 429++978A 13           	inc de
 430++978B C3 C8 8F     	jp memorystreamseek
 431++978E
 432++978E
 433++978E
 434++978E
 435++978E              cmdtable
 436++978E 4D           	db skip1           %256 ; 00
 437++978F 4D           	db skip1           %256 ; 01
 438++9790 4D           	db skip1           %256 ; 02
 439++9791 4D           	db skip1           %256 ; 03
 440++9792 4D           	db skip1           %256 ; 04
 441++9793 4D           	db skip1           %256 ; 05
 442++9794 4D           	db skip1           %256 ; 06
 443++9795 4D           	db skip1           %256 ; 07
 444++9796 4D           	db skip1           %256 ; 08
 445++9797 4D           	db skip1           %256 ; 09
 446++9798 4D           	db skip1           %256 ; 0A
 447++9799 4D           	db skip1           %256 ; 0B
 448++979A 4D           	db skip1           %256 ; 0C
 449++979B 4D           	db skip1           %256 ; 0D
 450++979C 4D           	db skip1           %256 ; 0E
 451++979D 4D           	db skip1           %256 ; 0F
 452++979E 4D           	db skip1           %256 ; 10
 453++979F 4D           	db skip1           %256 ; 11
 454++97A0 4D           	db skip1           %256 ; 12
 455++97A1 4D           	db skip1           %256 ; 13
 456++97A2 4D           	db skip1           %256 ; 14
 457++97A3 4D           	db skip1           %256 ; 15
 458++97A4 4D           	db skip1           %256 ; 16
 459++97A5 4D           	db skip1           %256 ; 17
 460++97A6 4D           	db skip1           %256 ; 18
 461++97A7 4D           	db skip1           %256 ; 19
 462++97A8 4D           	db skip1           %256 ; 1A
 463++97A9 4D           	db skip1           %256 ; 1B
 464++97AA 4D           	db skip1           %256 ; 1C
 465++97AB 4D           	db skip1           %256 ; 1D
 466++97AC 4D           	db skip1           %256 ; 1E
 467++97AD 4D           	db skip1           %256 ; 1F
 468++97AE 4D           	db skip1           %256 ; 20
 469++97AF 4D           	db skip1           %256 ; 21
 470++97B0 4D           	db skip1           %256 ; 22
 471++97B1 4D           	db skip1           %256 ; 23
 472++97B2 4D           	db skip1           %256 ; 24
 473++97B3 4D           	db skip1           %256 ; 25
 474++97B4 4D           	db skip1           %256 ; 26
 475++97B5 4D           	db skip1           %256 ; 27
 476++97B6 4D           	db skip1           %256 ; 28
 477++97B7 4D           	db skip1           %256 ; 29
 478++97B8 4D           	db skip1           %256 ; 2A
 479++97B9 4D           	db skip1           %256 ; 2B
 480++97BA 4D           	db skip1           %256 ; 2C
 481++97BB 4D           	db skip1           %256 ; 2D
 482++97BC 4D           	db skip1           %256 ; 2E
 483++97BD 4D           	db skip1           %256 ; 2F
 484++97BE 74           	db cmdunsupported  %256 ; 30
 485++97BF 4E           	db skip2           %256 ; 31
 486++97C0 4E           	db skip2           %256 ; 32
 487++97C1 4E           	db skip2           %256 ; 33
 488++97C2 4E           	db skip2           %256 ; 34
 489++97C3 4E           	db skip2           %256 ; 35
 490++97C4 4E           	db skip2           %256 ; 36
 491++97C5 4E           	db skip2           %256 ; 37
 492++97C6 4E           	db skip2           %256 ; 38
 493++97C7 4E           	db skip2           %256 ; 39
 494++97C8 4E           	db skip2           %256 ; 3A
 495++97C9 4E           	db skip2           %256 ; 3B
 496++97CA 4E           	db skip2           %256 ; 3C
 497++97CB 4E           	db skip2           %256 ; 3D
 498++97CC 4E           	db skip2           %256 ; 3E
 499++97CD 4E           	db skip2           %256 ; 3F
 500++97CE 53           	db skip3           %256 ; 40
 501++97CF 53           	db skip3           %256 ; 41
 502++97D0 53           	db skip3           %256 ; 42
 503++97D1 53           	db skip3           %256 ; 43
 504++97D2 53           	db skip3           %256 ; 44
 505++97D3 53           	db skip3           %256 ; 45
 506++97D4 53           	db skip3           %256 ; 46
 507++97D5 53           	db skip3           %256 ; 47
 508++97D6 53           	db skip3           %256 ; 48
 509++97D7 53           	db skip3           %256 ; 49
 510++97D8 53           	db skip3           %256 ; 4A
 511++97D9 53           	db skip3           %256 ; 4B
 512++97DA 53           	db skip3           %256 ; 4C
 513++97DB 53           	db skip3           %256 ; 4D
 514++97DC 53           	db skip3           %256 ; 4E
 515++97DD 4E           	db skip2           %256 ; 4F
 516++97DE 74           	db cmdunsupported  %256 ; 50
 517++97DF 74           	db cmdunsupported  %256 ; 51
 518++97E0 74           	db cmdunsupported  %256 ; 52
 519++97E1 74           	db cmdunsupported  %256 ; 53
 520++97E2 F8           	db cmdYM2151       %256 ; 54
 521++97E3 77           	db cmdYM2203       %256 ; 55
 522++97E4 77           	db cmdYM2608p0     %256 ; 56
 523++97E5 8E           	db cmdYM2608p1     %256 ; 57
 524++97E6 74           	db cmdunsupported  %256 ; 58
 525++97E7 74           	db cmdunsupported  %256 ; 59
 526++97E8 CA           	db cmdYM3812       %256 ; 5A
 527++97E9 CA           	db cmdYM3526       %256 ; 5B
 528++97EA CA           	db cmdY8950        %256 ; 5C
 529++97EB 53           	db skip3           %256 ; 5D
 530++97EC CA           	db cmdYMF262p0     %256 ; 5E
 531++97ED E1           	db cmdYMF262p1     %256 ; 5F
 532++97EE 74           	db cmdunsupported  %256 ; 60
 533++97EF 2C           	db waitvar         %256 ; 61
 534++97F0 16           	db wait735         %256 ; 62
 535++97F1 26           	db wait882         %256 ; 63
 536++97F2 74           	db cmdunsupported  %256 ; 64
 537++97F3 74           	db cmdunsupported  %256 ; 65
 538++97F4 71           	db endofsounddata  %256 ; 66
 539++97F5 44           	db cmddatablock    %256 ; 67
 540++97F6 6C           	db skip12          %256 ; 68
 541++97F7 74           	db cmdunsupported  %256 ; 69
 542++97F8 74           	db cmdunsupported  %256 ; 6A
 543++97F9 74           	db cmdunsupported  %256 ; 6B
 544++97FA 74           	db cmdunsupported  %256 ; 6C
 545++97FB 74           	db cmdunsupported  %256 ; 6D
 546++97FC 74           	db cmdunsupported  %256 ; 6E
 547++97FD 74           	db cmdunsupported  %256 ; 6F
 548++97FE B3           	db wait1           %256 ; 70
 549++97FF C0           	db wait2           %256 ; 71
 550++9800 D0           	db wait3           %256 ; 72
 551++9801 D5           	db wait4           %256 ; 73
 552++9802 DA           	db wait5           %256 ; 74
 553++9803 DF           	db wait6           %256 ; 75
 554++9804 E4           	db wait7           %256 ; 76
 555++9805 E9           	db wait8           %256 ; 77
 556++9806 EE           	db wait9           %256 ; 78
 557++9807 F3           	db wait10          %256 ; 79
 558++9808 F8           	db wait11          %256 ; 7A
 559++9809 FD           	db wait12          %256 ; 7B
 560++980A 02           	db wait13          %256 ; 7C
 561++980B 07           	db wait14          %256 ; 7D
 562++980C 0C           	db wait15          %256 ; 7E
 563++980D 11           	db wait16          %256 ; 7F
 564++980E 4D           	db skip1           %256 ; 80
 565++980F B3           	db wait1           %256 ; 81
 566++9810 C0           	db wait2           %256 ; 82
 567++9811 D0           	db wait3           %256 ; 83
 568++9812 D5           	db wait4           %256 ; 84
 569++9813 DA           	db wait5           %256 ; 85
 570++9814 DF           	db wait6           %256 ; 86
 571++9815 E4           	db wait7           %256 ; 87
 572++9816 E9           	db wait8           %256 ; 88
 573++9817 EE           	db wait9           %256 ; 89
 574++9818 F3           	db wait10          %256 ; 8A
 575++9819 F8           	db wait11          %256 ; 8B
 576++981A FD           	db wait12          %256 ; 8C
 577++981B 02           	db wait13          %256 ; 8D
 578++981C 07           	db wait14          %256 ; 8E
 579++981D 0C           	db wait15          %256 ; 8F
 580++981E 5D           	db skip5           %256 ; 90
 581++981F 5D           	db skip5           %256 ; 91
 582++9820 62           	db skip6           %256 ; 92
 583++9821 67           	db skip11          %256 ; 93
 584++9822 4E           	db skip2           %256 ; 94
 585++9823 5D           	db skip5           %256 ; 95
 586++9824 74           	db cmdunsupported  %256 ; 96
 587++9825 74           	db cmdunsupported  %256 ; 97
 588++9826 74           	db cmdunsupported  %256 ; 98
 589++9827 74           	db cmdunsupported  %256 ; 99
 590++9828 74           	db cmdunsupported  %256 ; 9A
 591++9829 74           	db cmdunsupported  %256 ; 9B
 592++982A 74           	db cmdunsupported  %256 ; 9C
 593++982B 74           	db cmdunsupported  %256 ; 9D
 594++982C 74           	db cmdunsupported  %256 ; 9E
 595++982D 74           	db cmdunsupported  %256 ; 9F
 596++982E 26           	db cmdAY8910       %256 ; A0
 597++982F 53           	db skip3           %256 ; A1
 598++9830 74           	db cmdunsupported  %256 ; A2
 599++9831 74           	db cmdunsupported  %256 ; A3
 600++9832 0F           	db cmdYM2151dp     %256 ; A4
 601++9833 8E           	db cmdYM2203dp     %256 ; A5
 602++9834 53           	db skip3           %256 ; A6
 603++9835 53           	db skip3           %256 ; A7
 604++9836 53           	db skip3           %256 ; A8
 605++9837 53           	db skip3           %256 ; A9
 606++9838 E1           	db cmdYM3812dp     %256 ; AA
 607++9839 E1           	db cmdYM3526dp     %256 ; AB
 608++983A E1           	db cmdY8950dp      %256 ; AC
 609++983B 53           	db skip3           %256 ; AD
 610++983C 40           	db cmdYMF262dp0    %256 ; AE
 611++983D 40           	db cmdYMF262dp0    %256 ; AF
 612++983E 53           	db skip3           %256 ; B0
 613++983F 53           	db skip3           %256 ; B1
 614++9840 53           	db skip3           %256 ; B2
 615++9841 53           	db skip3           %256 ; B3
 616++9842 53           	db skip3           %256 ; B4
 617++9843 53           	db skip3           %256 ; B5
 618++9844 53           	db skip3           %256 ; B6
 619++9845 53           	db skip3           %256 ; B7
 620++9846 53           	db skip3           %256 ; B8
 621++9847 53           	db skip3           %256 ; B9
 622++9848 53           	db skip3           %256 ; BA
 623++9849 53           	db skip3           %256 ; BB
 624++984A 53           	db skip3           %256 ; BC
 625++984B 53           	db skip3           %256 ; BD
 626++984C 53           	db skip3           %256 ; BE
 627++984D 53           	db skip3           %256 ; BF
 628++984E 58           	db skip4           %256 ; C0
 629++984F 58           	db skip4           %256 ; C1
 630++9850 58           	db skip4           %256 ; C2
 631++9851 58           	db skip4           %256 ; C3
 632++9852 58           	db skip4           %256 ; C4
 633++9853 58           	db skip4           %256 ; C5
 634++9854 58           	db skip4           %256 ; C6
 635++9855 58           	db skip4           %256 ; C7
 636++9856 58           	db skip4           %256 ; C8
 637++9857 58           	db skip4           %256 ; C9
 638++9858 58           	db skip4           %256 ; CA
 639++9859 58           	db skip4           %256 ; CB
 640++985A 58           	db skip4           %256 ; CC
 641++985B 58           	db skip4           %256 ; CD
 642++985C 58           	db skip4           %256 ; CE
 643++985D 58           	db skip4           %256 ; CF
 644++985E A5           	db cmdYMF278B      %256 ; D0
 645++985F 58           	db skip4           %256 ; D1
 646++9860 74           	db cmdunsupported  %256 ; D2
 647++9861 58           	db skip4           %256 ; D3
 648++9862 58           	db skip4           %256 ; D4
 649++9863 58           	db skip4           %256 ; D5
 650++9864 58           	db skip4           %256 ; D6
 651++9865 58           	db skip4           %256 ; D7
 652++9866 58           	db skip4           %256 ; D8
 653++9867 58           	db skip4           %256 ; D9
 654++9868 58           	db skip4           %256 ; DA
 655++9869 58           	db skip4           %256 ; DB
 656++986A 58           	db skip4           %256 ; DC
 657++986B 58           	db skip4           %256 ; DD
 658++986C 58           	db skip4           %256 ; DE
 659++986D 58           	db skip4           %256 ; DF
 660++986E 74           	db cmdunsupported  %256 ; E0
 661++986F 5D           	db skip5           %256 ; E1
 662++9870 5D           	db skip5           %256 ; E2
 663++9871 5D           	db skip5           %256 ; E3
 664++9872 5D           	db skip5           %256 ; E4
 665++9873 5D           	db skip5           %256 ; E5
 666++9874 5D           	db skip5           %256 ; E6
 667++9875 5D           	db skip5           %256 ; E7
 668++9876 5D           	db skip5           %256 ; E8
 669++9877 5D           	db skip5           %256 ; E9
 670++9878 5D           	db skip5           %256 ; EA
 671++9879 5D           	db skip5           %256 ; EB
 672++987A 5D           	db skip5           %256 ; EC
 673++987B 5D           	db skip5           %256 ; ED
 674++987C 5D           	db skip5           %256 ; EE
 675++987D 5D           	db skip5           %256 ; EF
 676++987E 5D           	db skip5           %256 ; F0
 677++987F 5D           	db skip5           %256 ; F1
 678++9880 5D           	db skip5           %256 ; F2
 679++9881 5D           	db skip5           %256 ; F3
 680++9882 5D           	db skip5           %256 ; F4
 681++9883 5D           	db skip5           %256 ; F5
 682++9884 5D           	db skip5           %256 ; F6
 683++9885 5D           	db skip5           %256 ; F7
 684++9886 5D           	db skip5           %256 ; F8
 685++9887 5D           	db skip5           %256 ; F9
 686++9888 5D           	db skip5           %256 ; FA
 687++9889 5D           	db skip5           %256 ; FB
 688++988A 5D           	db skip5           %256 ; FC
 689++988B 5D           	db skip5           %256 ; FD
 690++988C 5D           	db skip5           %256 ; FE
 691++988D 5D           	db skip5           %256 ; FF
 692++988E 96           	db skip1           /256 ; 00
 693++988F 96           	db skip1           /256 ; 01
 694++9890 96           	db skip1           /256 ; 02
 695++9891 96           	db skip1           /256 ; 03
 696++9892 96           	db skip1           /256 ; 04
 697++9893 96           	db skip1           /256 ; 05
 698++9894 96           	db skip1           /256 ; 06
 699++9895 96           	db skip1           /256 ; 07
 700++9896 96           	db skip1           /256 ; 08
 701++9897 96           	db skip1           /256 ; 09
 702++9898 96           	db skip1           /256 ; 0A
 703++9899 96           	db skip1           /256 ; 0B
 704++989A 96           	db skip1           /256 ; 0C
 705++989B 96           	db skip1           /256 ; 0D
 706++989C 96           	db skip1           /256 ; 0E
 707++989D 96           	db skip1           /256 ; 0F
 708++989E 96           	db skip1           /256 ; 10
 709++989F 96           	db skip1           /256 ; 11
 710++98A0 96           	db skip1           /256 ; 12
 711++98A1 96           	db skip1           /256 ; 13
 712++98A2 96           	db skip1           /256 ; 14
 713++98A3 96           	db skip1           /256 ; 15
 714++98A4 96           	db skip1           /256 ; 16
 715++98A5 96           	db skip1           /256 ; 17
 716++98A6 96           	db skip1           /256 ; 18
 717++98A7 96           	db skip1           /256 ; 19
 718++98A8 96           	db skip1           /256 ; 1A
 719++98A9 96           	db skip1           /256 ; 1B
 720++98AA 96           	db skip1           /256 ; 1C
 721++98AB 96           	db skip1           /256 ; 1D
 722++98AC 96           	db skip1           /256 ; 1E
 723++98AD 96           	db skip1           /256 ; 1F
 724++98AE 96           	db skip1           /256 ; 20
 725++98AF 96           	db skip1           /256 ; 21
 726++98B0 96           	db skip1           /256 ; 22
 727++98B1 96           	db skip1           /256 ; 23
 728++98B2 96           	db skip1           /256 ; 24
 729++98B3 96           	db skip1           /256 ; 25
 730++98B4 96           	db skip1           /256 ; 26
 731++98B5 96           	db skip1           /256 ; 27
 732++98B6 96           	db skip1           /256 ; 28
 733++98B7 96           	db skip1           /256 ; 29
 734++98B8 96           	db skip1           /256 ; 2A
 735++98B9 96           	db skip1           /256 ; 2B
 736++98BA 96           	db skip1           /256 ; 2C
 737++98BB 96           	db skip1           /256 ; 2D
 738++98BC 96           	db skip1           /256 ; 2E
 739++98BD 96           	db skip1           /256 ; 2F
 740++98BE 96           	db cmdunsupported  /256 ; 30
 741++98BF 96           	db skip2           /256 ; 31
 742++98C0 96           	db skip2           /256 ; 32
 743++98C1 96           	db skip2           /256 ; 33
 744++98C2 96           	db skip2           /256 ; 34
 745++98C3 96           	db skip2           /256 ; 35
 746++98C4 96           	db skip2           /256 ; 36
 747++98C5 96           	db skip2           /256 ; 37
 748++98C6 96           	db skip2           /256 ; 38
 749++98C7 96           	db skip2           /256 ; 39
 750++98C8 96           	db skip2           /256 ; 3A
 751++98C9 96           	db skip2           /256 ; 3B
 752++98CA 96           	db skip2           /256 ; 3C
 753++98CB 96           	db skip2           /256 ; 3D
 754++98CC 96           	db skip2           /256 ; 3E
 755++98CD 96           	db skip2           /256 ; 3F
 756++98CE 96           	db skip3           /256 ; 40
 757++98CF 96           	db skip3           /256 ; 41
 758++98D0 96           	db skip3           /256 ; 42
 759++98D1 96           	db skip3           /256 ; 43
 760++98D2 96           	db skip3           /256 ; 44
 761++98D3 96           	db skip3           /256 ; 45
 762++98D4 96           	db skip3           /256 ; 46
 763++98D5 96           	db skip3           /256 ; 47
 764++98D6 96           	db skip3           /256 ; 48
 765++98D7 96           	db skip3           /256 ; 49
 766++98D8 96           	db skip3           /256 ; 4A
 767++98D9 96           	db skip3           /256 ; 4B
 768++98DA 96           	db skip3           /256 ; 4C
 769++98DB 96           	db skip3           /256 ; 4D
 770++98DC 96           	db skip3           /256 ; 4E
 771++98DD 96           	db skip2           /256 ; 4F
 772++98DE 96           	db cmdunsupported  /256 ; 50
 773++98DF 96           	db cmdunsupported  /256 ; 51
 774++98E0 96           	db cmdunsupported  /256 ; 52
 775++98E1 96           	db cmdunsupported  /256 ; 53
 776++98E2 96           	db cmdYM2151       /256 ; 54
 777++98E3 96           	db cmdYM2203       /256 ; 55
 778++98E4 96           	db cmdYM2608p0     /256 ; 56
 779++98E5 99           	db cmdYM2608p1     /256 ; 57
 780++98E6 96           	db cmdunsupported  /256 ; 58
 781++98E7 96           	db cmdunsupported  /256 ; 59
 782++98E8 96           	db cmdYM3812       /256 ; 5A
 783++98E9 96           	db cmdYM3526       /256 ; 5B
 784++98EA 96           	db cmdY8950        /256 ; 5C
 785++98EB 96           	db skip3           /256 ; 5D
 786++98EC 96           	db cmdYMF262p0     /256 ; 5E
 787++98ED 96           	db cmdYMF262p1     /256 ; 5F
 788++98EE 96           	db cmdunsupported  /256 ; 60
 789++98EF 96           	db waitvar         /256 ; 61
 790++98F0 96           	db wait735         /256 ; 62
 791++98F1 96           	db wait882         /256 ; 63
 792++98F2 96           	db cmdunsupported  /256 ; 64
 793++98F3 96           	db cmdunsupported  /256 ; 65
 794++98F4 96           	db endofsounddata  /256 ; 66
 795++98F5 97           	db cmddatablock    /256 ; 67
 796++98F6 96           	db skip12          /256 ; 68
 797++98F7 96           	db cmdunsupported  /256 ; 69
 798++98F8 96           	db cmdunsupported  /256 ; 6A
 799++98F9 96           	db cmdunsupported  /256 ; 6B
 800++98FA 96           	db cmdunsupported  /256 ; 6C
 801++98FB 96           	db cmdunsupported  /256 ; 6D
 802++98FC 96           	db cmdunsupported  /256 ; 6E
 803++98FD 96           	db cmdunsupported  /256 ; 6F
 804++98FE 95           	db wait1           /256 ; 70
 805++98FF 95           	db wait2           /256 ; 71
 806++9900 95           	db wait3           /256 ; 72
 807++9901 95           	db wait4           /256 ; 73
 808++9902 95           	db wait5           /256 ; 74
 809++9903 95           	db wait6           /256 ; 75
 810++9904 95           	db wait7           /256 ; 76
 811++9905 95           	db wait8           /256 ; 77
 812++9906 95           	db wait9           /256 ; 78
 813++9907 95           	db wait10          /256 ; 79
 814++9908 95           	db wait11          /256 ; 7A
 815++9909 95           	db wait12          /256 ; 7B
 816++990A 96           	db wait13          /256 ; 7C
 817++990B 96           	db wait14          /256 ; 7D
 818++990C 96           	db wait15          /256 ; 7E
 819++990D 96           	db wait16          /256 ; 7F
 820++990E 96           	db skip1           /256 ; 80
 821++990F 95           	db wait1           /256 ; 81
 822++9910 95           	db wait2           /256 ; 82
 823++9911 95           	db wait3           /256 ; 83
 824++9912 95           	db wait4           /256 ; 84
 825++9913 95           	db wait5           /256 ; 85
 826++9914 95           	db wait6           /256 ; 86
 827++9915 95           	db wait7           /256 ; 87
 828++9916 95           	db wait8           /256 ; 88
 829++9917 95           	db wait9           /256 ; 89
 830++9918 95           	db wait10          /256 ; 8A
 831++9919 95           	db wait11          /256 ; 8B
 832++991A 95           	db wait12          /256 ; 8C
 833++991B 96           	db wait13          /256 ; 8D
 834++991C 96           	db wait14          /256 ; 8E
 835++991D 96           	db wait15          /256 ; 8F
 836++991E 96           	db skip5           /256 ; 90
 837++991F 96           	db skip5           /256 ; 91
 838++9920 96           	db skip6           /256 ; 92
 839++9921 96           	db skip11          /256 ; 93
 840++9922 96           	db skip2           /256 ; 94
 841++9923 96           	db skip5           /256 ; 95
 842++9924 96           	db cmdunsupported  /256 ; 96
 843++9925 96           	db cmdunsupported  /256 ; 97
 844++9926 96           	db cmdunsupported  /256 ; 98
 845++9927 96           	db cmdunsupported  /256 ; 99
 846++9928 96           	db cmdunsupported  /256 ; 9A
 847++9929 96           	db cmdunsupported  /256 ; 9B
 848++992A 96           	db cmdunsupported  /256 ; 9C
 849++992B 96           	db cmdunsupported  /256 ; 9D
 850++992C 96           	db cmdunsupported  /256 ; 9E
 851++992D 96           	db cmdunsupported  /256 ; 9F
 852++992E 97           	db cmdAY8910       /256 ; A0
 853++992F 96           	db skip3           /256 ; A1
 854++9930 96           	db cmdunsupported  /256 ; A2
 855++9931 96           	db cmdunsupported  /256 ; A3
 856++9932 97           	db cmdYM2151dp     /256 ; A4
 857++9933 96           	db cmdYM2203dp     /256 ; A5
 858++9934 96           	db skip3           /256 ; A6
 859++9935 96           	db skip3           /256 ; A7
 860++9936 96           	db skip3           /256 ; A8
 861++9937 96           	db skip3           /256 ; A9
 862++9938 96           	db cmdYM3812dp     /256 ; AA
 863++9939 96           	db cmdYM3526dp     /256 ; AB
 864++993A 96           	db cmdY8950dp      /256 ; AC
 865++993B 96           	db skip3           /256 ; AD
 866++993C 8F           	db cmdYMF262dp0    /256 ; AE
 867++993D 8F           	db cmdYMF262dp0    /256 ; AF
 868++993E 96           	db skip3           /256 ; B0
 869++993F 96           	db skip3           /256 ; B1
 870++9940 96           	db skip3           /256 ; B2
 871++9941 96           	db skip3           /256 ; B3
 872++9942 96           	db skip3           /256 ; B4
 873++9943 96           	db skip3           /256 ; B5
 874++9944 96           	db skip3           /256 ; B6
 875++9945 96           	db skip3           /256 ; B7
 876++9946 96           	db skip3           /256 ; B8
 877++9947 96           	db skip3           /256 ; B9
 878++9948 96           	db skip3           /256 ; BA
 879++9949 96           	db skip3           /256 ; BB
 880++994A 96           	db skip3           /256 ; BC
 881++994B 96           	db skip3           /256 ; BD
 882++994C 96           	db skip3           /256 ; BE
 883++994D 96           	db skip3           /256 ; BF
 884++994E 96           	db skip4           /256 ; C0
 885++994F 96           	db skip4           /256 ; C1
 886++9950 96           	db skip4           /256 ; C2
 887++9951 96           	db skip4           /256 ; C3
 888++9952 96           	db skip4           /256 ; C4
 889++9953 96           	db skip4           /256 ; C5
 890++9954 96           	db skip4           /256 ; C6
 891++9955 96           	db skip4           /256 ; C7
 892++9956 96           	db skip4           /256 ; C8
 893++9957 96           	db skip4           /256 ; C9
 894++9958 96           	db skip4           /256 ; CA
 895++9959 96           	db skip4           /256 ; CB
 896++995A 96           	db skip4           /256 ; CC
 897++995B 96           	db skip4           /256 ; CD
 898++995C 96           	db skip4           /256 ; CE
 899++995D 96           	db skip4           /256 ; CF
 900++995E 96           	db cmdYMF278B      /256 ; D0
 901++995F 96           	db skip4           /256 ; D1
 902++9960 96           	db cmdunsupported  /256 ; D2
 903++9961 96           	db skip4           /256 ; D3
 904++9962 96           	db skip4           /256 ; D4
 905++9963 96           	db skip4           /256 ; D5
 906++9964 96           	db skip4           /256 ; D6
 907++9965 96           	db skip4           /256 ; D7
 908++9966 96           	db skip4           /256 ; D8
 909++9967 96           	db skip4           /256 ; D9
 910++9968 96           	db skip4           /256 ; DA
 911++9969 96           	db skip4           /256 ; DB
 912++996A 96           	db skip4           /256 ; DC
 913++996B 96           	db skip4           /256 ; DD
 914++996C 96           	db skip4           /256 ; DE
 915++996D 96           	db skip4           /256 ; DF
 916++996E 96           	db cmdunsupported  /256 ; E0
 917++996F 96           	db skip5           /256 ; E1
 918++9970 96           	db skip5           /256 ; E2
 919++9971 96           	db skip5           /256 ; E3
 920++9972 96           	db skip5           /256 ; E4
 921++9973 96           	db skip5           /256 ; E5
 922++9974 96           	db skip5           /256 ; E6
 923++9975 96           	db skip5           /256 ; E7
 924++9976 96           	db skip5           /256 ; E8
 925++9977 96           	db skip5           /256 ; E9
 926++9978 96           	db skip5           /256 ; EA
 927++9979 96           	db skip5           /256 ; EB
 928++997A 96           	db skip5           /256 ; EC
 929++997B 96           	db skip5           /256 ; ED
 930++997C 96           	db skip5           /256 ; EE
 931++997D 96           	db skip5           /256 ; EF
 932++997E 96           	db skip5           /256 ; F0
 933++997F 96           	db skip5           /256 ; F1
 934++9980 96           	db skip5           /256 ; F2
 935++9981 96           	db skip5           /256 ; F3
 936++9982 96           	db skip5           /256 ; F4
 937++9983 96           	db skip5           /256 ; F5
 938++9984 96           	db skip5           /256 ; F6
 939++9985 96           	db skip5           /256 ; F7
 940++9986 96           	db skip5           /256 ; F8
 941++9987 96           	db skip5           /256 ; F9
 942++9988 96           	db skip5           /256 ; FA
 943++9989 96           	db skip5           /256 ; FB
 944++998A 96           	db skip5           /256 ; FC
 945++998B 96           	db skip5           /256 ; FD
 946++998C 96           	db skip5           /256 ; FE
 947++998D 96           	db skip5           /256 ; FF
 948++998E
 949++998E
 950++998E
 951++998E              cmdYM2608p0 equ cmdYM2203
 952++998E
 953++998E              cmdYM2608p1
 954++998E              	memory_stream_read_2 e,d
 954++998E 2A 72 8F    >	ld hl,(memorystreamcurrentaddr)
 954++9991             >	memory_stream_read_byte e
 954++9991 CB 74       >	bit 6,h
 954++9993             >        IF AREA_C000_FFFF=1
 954++9993 CC 0D 8F    >	call z,memorystreamnextpage
 954++9996             >        ELSE
 954++9996 ~           > 	call nz,memorystreamnextpage
 954++9996             >        ENDIF
 954++9996 5E          >	ld e,(hl)
 954++9997 23          >	inc hl
 954++9998             >	memory_stream_read_byte d
 954++9998 CB 74       >	bit 6,h
 954++999A             >        IF AREA_C000_FFFF=1
 954++999A CC 0D 8F    >	call z,memorystreamnextpage
 954++999D             >        ELSE
 954++999D ~           > 	call nz,memorystreamnextpage
 954++999D             >        ENDIF
 954++999D 56          >	ld d,(hl)
 954++999E 23          >	inc hl
 954++999F 22 72 8F    >	ld (memorystreamcurrentaddr),hl
 955++99A2 7B           	ld a,e
 956++99A3 FE 30        	cp 0x30
 957++99A5 D8           	ret c
 958++99A6 C3 A0 93     	jp opnwritefm2
 959++99A9
 960++99A9
 961++99A9              initAY8910
 962++99A9 CD AD 94     	call ssginit
 963++99AC 21 66 95     	ld hl,devicemask
 964++99AF 3A 77 BE     	ld a,(HEADER_CLOCK_AY8910+3)
 965++99B2 E6 40        	and 0x40
 966++99B4 20 03        	jr nz,.dualchip
 967++99B6 CB C6        	set DEVICE_AY_BIT,(hl)
 968++99B8 C9           	ret
 969++99B9              .dualchip
 970++99B9 CB CE        	set DEVICE_TURBOSOUND_BIT,(hl)
 971++99BB C9           	ret
 972++99BC
 973++99BC              initYM2203
 974++99BC              tfmstatus=$+1
 975++99BC 3E 01        	ld a,1
 976++99BE 3D           	dec a
 977++99BF F8           	ret m
 978++99C0 CD AB 93     	call opninit
 979++99C3              	set_timer opnwaittimer60hz,735
 979++99C3 21 DF 02    >	ld hl,735
 979++99C6 22 86 95    >	ld (waittimerstep),hl
 980++99C9 CD 41 94     	call opninittimer60hz
 981++99CC 21 66 95     	ld hl,devicemask
 982++99CF CB D6        	set DEVICE_TFM_BIT,(hl)
 983++99D1 AF           	xor a
 984++99D2 C9           	ret
 985++99D3
 986++99D3              initYMF278B
 987++99D3              moonsoundstatus=$+1
 988++99D3 3E 02        	ld a,2
 989++99D5 3D           	dec a
 990++99D6 F8           	ret m
 991++99D7 CD 6D 92     	call vgmopl4init
 992++99DA 3A 53 BE     	ld a,(HEADER_CLOCK_YM3812+3)
 993++99DD E6 40        	and 0x40
 994++99DF 20 08        	jr nz,notOPL2
 995++99E1              useYM3812=$+1
 996++99E1 F6 00        	or 0
 997++99E3 11 05 00     	ld de,0x0005
 998++99E6 C4 33 90     	call nz,opl4writefm2
 999++99E9              notOPL2
1000++99E9 CD 64 93     	call opl4inittimer60hz
1001++99EC 21 66 95     	ld hl,devicemask
1002++99EF CB DE        	set DEVICE_MOONSOUND_BIT,(hl)
1003++99F1 AF           	xor a
1004++99F2 C9           	ret
1005++99F3
1006++99F3              end
1007++99F3
1008++99F3
1009++99F3
1010++99F3              ;        LABELSLIST "vgm_plr.l"
1011++99F3              ;	savebin "gplay.apg",begin,end-begin
# file closed: GPlay/vgm.asm
 572+ 99F3              	include sub_func.asm
# file opened: GPlay/sub_func.asm
   1++99F3
   2++99F3              fileopenerror
   3++99F3 79           		ld a,c
   4++99F4 0E FF        		ld c,$FF
   5++99F6 02                   ld (bc),a ;   
   6++99F7
   7++99F7 21 DD 8C     		ld hl,txt_fopenerror
   8++99FA              		OS_PRINTZ
   8++99FA 0E 09       >    ld c,#09
   8++99FC E7          >    rst #20
   9++99FD
  10++99FD 3A 1D 9D     		ld a,(file_id_cur_r)
  11++9A00 FE FF        		cp 255
  12++9A02 28 03        		jr z,fileopenerror1
  13++9A04              		OS_FILE_CLOSE ;A - id file
  13++9A04 0E 25       >    ld c,#25
  13++9A06 E7          >    rst #20
  14++9A07              fileopenerror1
  15++9A07 37           		scf ;
  16++9A08 C9           		ret
  17++9A09
  18++9A09
  19++9A09              ; memoryerror
  20++9A09                      ; OS_CLOSEHANDLE
  21++9A09                      ; ld e,6+0x80
  22++9A09                      ; OS_SETGFX
  23++9A09                      ; ld e,0
  24++9A09                      ; OS_CLS
  25++9A09                      ; ld hl,txt_memoryerror
  26++9A09                      ; call print_hl
  27++9A09                      ; YIELDGETKEYLOOP
  28++9A09                      ; jp cmd_quit
  29++9A09
  30++9A09              memoryerror
  31++9A09 79           		ld a,c
  32++9A0A 0E FF        		ld c,$FF
  33++9A0C 02                   ld (bc),a ;   
  34++9A0D
  35++9A0D 21 C3 8C     		ld hl,txt_memoryerror
  36++9A10              		OS_PRINTZ
  36++9A10 0E 09       >    ld c,#09
  36++9A12 E7          >    rst #20
  37++9A13
  38++9A13 3A 1D 9D     		ld a,(file_id_cur_r)
  39++9A16 FE FF        		cp 255
  40++9A18 28 03        		jr z,memoryerror1
  41++9A1A              		OS_FILE_CLOSE ;A - id file
  41++9A1A 0E 25       >    ld c,#25
  41++9A1C E7          >    rst #20
  42++9A1D              memoryerror1
  43++9A1D 37           		scf ;
  44++9A1E C9           		ret
  45++9A1F
  46++9A1F
  47++9A1F
  48++9A1F              ;----------------------------------------
  49++9A1F              load_mus
  50++9A1F
  51++9A1F                      ; ld b,0
  52++9A1F              ; old_mus EQU $-1
  53++9A1F                      ; cp b
  54++9A1F                      ; ret z
  55++9A1F                      ; ld (old_mus),a
  56++9A1F
  57++9A1F                      ; and a
  58++9A1F                      ; jp z,no_mus
  59++9A1F
  60++9A1F
  61++9A1F                      ; call calc_mus
  62++9A1F
  63++9A1F                      ; call no_mus
  64++9A1F                      ; ld hl,t_s98_file00_pages_list+$FF
  65++9A1F                      ; call free_s98_file ; 
  66++9A1F
  67++9A1F                      ;generate path to music file in 'buf'
  68++9A1F                      ; ld hl,mus_path1
  69++9A1F                      ; ld de,buf
  70++9A1F                      ; call copystr_hlde ;'copy path  'mus/' '
  71++9A1F
  72++9A1F                      ; ld a,(mus_mode)
  73++9A1F                      ; ld hl,mus_modes
  74++9A1F                      ; call sel_word
  75++9A1F                      ; call copystr_hlde ;copy "aym / s98 path"
  76++9A1F                      ; ld hl,mus_path2
  77++9A1F                      ; call copystr_hlde ;copy name without ext
  78++9A1F
  79++9A1F                      ; ld a,(mus_mode)
  80++9A1F                      ; ld hl,plr_ext
  81++9A1F                      ; call sel_word
  82++9A1F                      ; call copystr_hlde  ;copy file ext
  83++9A1F                      ; xor a
  84++9A1F                      ; ld (de),a  ;string terminator
  85++9A1F
  86++9A1F                      ; ld de,buf ; 
  87++9A1F                      ; call openstream_file
  88++9A1F
  89++9A1F 21 0C 9B     		ld hl,file_name_cur
  90++9A22              		OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
  90++9A22 0E 21       >    ld c,#21
  90++9A24 E7          >    rst #20
  91++9A25
  92++9A25                      ;or a
  93++9A25                      ;jp nz,fileopenerror
  94++9A25 DA F3 99     		jp c,fileopenerror
  95++9A28 32 1D 9D     		ld (file_id_cur_r),a
  96++9A2B
  97++9A2B 21 00 8E             ld hl,memorystreampages ;t_s98_file00_pages_list
  98++9A2E 22 32 9A             ld (load_s98_file_number),hl
  99++9A31
 100++9A31
 101++9A31              /////------        call load_s98_file      ;de=drive/path/file
 102++9A31
 103++9A31              ;    
 104++9A31              ;   
 105++9A31
 106++9A31                              ;   
 107++9A31
 108++9A31
 109++9A31              load_s98_file_number_haddr = $+2
 109++9A31
 110++9A31              load_s98_file_number = $+1
 110++9A31
 111++9A31 01 00 8E                     ld bc,memorystreampages ;t_s98_file00_pages_list
 112++9A34 C5                           push bc
 113++9A35
 114++9A35              read_file_loop:
 115++9A35                              ;OS_NEWPAGE              ;out: a=0 (OK)/!=0 (fail), e=page
 116++9A35              				OS_GET_PAGE ;*
 116++9A35 0E 1A       >    ld c,#1a
 116++9A37 E7          >    rst #20
 117++9A38
 118++9A38 C1                           pop bc ;file tab
 119++9A39
 120++9A39                              ;or a
 121++9A39                              ;jp nz,memory_error
 122++9A39 DA 7C 9A     				jp c,memory_error
 123++9A3C                              ;ld a,e
 124++9A3C                                                      ;    !!!!
 125++9A3C                                                      ;    !!!!
 126++9A3C
 127++9A3C 02           1               ld (bc),a
 128++9A3D 0C                           inc c           ;      4 !!!!!
 129++9A3E
 130++9A3E C5                           push bc ;file tab
 131++9A3F                              ;SETPGC000
 132++9A3F              				OS_SET_PAGE_SLOT3
 132++9A3F 0E 1C       >    ld c,#1c
 132++9A41 E7          >    rst #20
 133++9A42
 134++9A42                              ;ld de,$C000
 135++9A42                              ;ld hl,$4000
 136++9A42
 137++9A42                              ;call readstream_file    ;DE = Buffer address, HL = Number of bytes to read
 138++9A42                                              ;hl=actual size
 139++9A42
 140++9A42 3A 1D 9D     				ld a,(file_id_cur_r)
 141++9A45 21 00 C0     				ld hl,$C000
 142++9A48 11 00 40                     ld de,$4000
 143++9A4B              				OS_FILE_READ ;HL - address, A - id file, DE - length (out: hl -    )
 143++9A4B 0E 23       >    ld c,#23
 143++9A4D E7          >    rst #20
 144++9A4E 30 04        				jr nc,read_file_loop1
 145++9A50
 146++9A50              				; 
 147++9A50 C1                           pop bc ;file tab
 148++9A51 C3 F3 99                     jp fileopenerror
 149++9A54
 150++9A54
 151++9A54              read_file_loop1		;
 152++9A54 7C                           ld a,h
 153++9A55                              ; cp $40
 154++9A55                              ; jr nc,read_file_loop    ;>= $40
 155++9A55 FE C0        				cp $c0
 156++9A57 38 DC                        jr c,read_file_loop    ;>= $c0,   
 157++9A59
 158++9A59
 159++9A59              read_file_exit
 160++9A59
 161++9A59 C1                           pop bc ;file tab
 162++9A5A                              ;    
 163++9A5A 79                           ld a,c
 164++9A5B
 165++9A5B                             // sub 16   ; !!!!!       0  +16
 166++9A5B
 167++9A5B 0E FF                        ld c,$FF
 168++9A5D 02                           ld (bc),a
 169++9A5E
 170++9A5E              ;-------------------------------------------------------
 171++9A5E              ;    .
 172++9A5E              ;       plr_page3    
 173++9A5E              ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 174++9A5E                              ;call closestream_file
 175++9A5E 3A 1D 9D     				ld a,(file_id_cur_r)
 176++9A61              				OS_FILE_CLOSE ;A - id file
 176++9A61 0E 25       >    ld c,#25
 176++9A63 E7          >    rst #20
 177++9A64
 178++9A64              read_file_ok
 179++9A64                              ;call store8000c000 ;*
 180++9A64              ;  8000     
 181++9A64 21 00 8E                     ld hl,memorystreampages ;t_s98_file00_pages_list
 182++9A67 7E                           ld a,(hl)
 183++9A68                              ;SETPG8000
 184++9A68              				OS_SET_PAGE_SLOT3
 184++9A68 0E 1C       >    ld c,#1c
 184++9A6A E7          >    rst #20
 185++9A6B                              ; ld a,(plr_page3)
 186++9A6B                              ; SETPGC000
 187++9A6B
 188++9A6B              ;    plr_page3.      .
 189++9A6B                              ; ld hl,0x8000
 190++9A6B                              ; ld de,module
 191++9A6B                              ; ld bc,16384
 192++9A6B                              ; ldir
 193++9A6B
 194++9A6B              ;   plrpage      .
 195++9A6B                              ; ld a,(plr_page)
 196++9A6B                              ; SETPGC000
 197++9A6B                              ; ld hl,t_s98_file00_pages_list
 198++9A6B                              ; ld de,0xc100         ;0x5000
 199++9A6B                              ; ld bc,256
 200++9A6B                              ; ldir
 201++9A6B
 202++9A6B                       ;       DI
 203++9A6B
 204++9A6B              ;b .
 205++9A6B                              ;call restore8000c000
 206++9A6B
 207++9A6B                              ;call set_music_pages
 208++9A6B
 209++9A6B 21 00 C0                     ld hl,module
 210++9A6E                              ;ld (0x4001),hl *    
 211++9A6E 22 09 8D     				ld (START+1),hl
 212++9A71 CD 08 8D                     call PLR_INIT        ;init music
 213++9A74
 214++9A74                        ;      EI
 215++9A74              ;----------------
 216++9A74              ;eloop           halt ;YIELD
 217++9A74              ;                call PLR_PLAY
 218++9A74              ;                jr eloop
 219++9A74              ;----------------
 220++9A74
 221++9A74
 222++9A74              ;!!!!!!!!!!
 223++9A74
 224++9A74              ; .
 225++9A74                              ;ld a,(plr_page)
 226++9A74 21 0D 8D                     ld hl,PLR_PLAY
 227++9A77                              ;OS_SETMUSIC         ;****     
 228++9A77              				OS_SET_INTER
 228++9A77 0E 14       >    ld c,#14
 228++9A79 E7          >    rst #20
 229++9A7A AF           				xor a ;OK
 230++9A7B C9           				ret
 231++9A7C                              ;jp unset_music_pages
 232++9A7C
 233++9A7C
 234++9A7C              memory_error:
 235++9A7C C3 09 9A             jp memoryerror
 236++9A7F
# file closed: GPlay/sub_func.asm
 573+ 9A7F              	include common/general-sound.asm
# file opened: GPlay/common/general-sound.asm
   1++9A7F                  ;ifdef GS
   2++9A7F                  macro GS_WaitCommand
   3++9A7F ~            .wait
   4++9A7F ~                in a, (GeneralSound.CMD)
   5++9A7F ~                rrca
   6++9A7F ~                jr c, .wait
   7++9A7F                  endm
   8++9A7F
   9++9A7F                  macro GS_WaitData
  10++9A7F ~            .wait
  11++9A7F ~                in a, (GeneralSound.CMD)
  12++9A7F ~                rlca
  13++9A7F ~                jr c, .wait
  14++9A7F                  endm
  15++9A7F
  16++9A7F                  macro GS_SendCommand nn
  17++9A7F ~                ld a, nn
  17++9A7F ~              out (GeneralSound.CMD), a
  18++9A7F                  endm
  19++9A7F
  20++9A7F                  module GeneralSound
  21++9A7F              ;; Control ports
  22++9A7F              CMD  = 187
  23++9A7F              DATA = 179
  24++9A7F
  25++9A7F              ;; Commands
  26++9A7F              CMD_WARM_RESET      = #F3
  27++9A7F              CMD_COLD_RESET      = #F4
  28++9A7F              CMD_LOAD_MODULE     = #30
  29++9A7F              CMD_PLAY_MODULE     = #31
  30++9A7F              CMD_STOP_MODULE     = #32
  31++9A7F              CMD_CONTINUE_MODULE = #33
  32++9A7F              CMD_OPEN_STREAM     = #D1
  33++9A7F              CMD_CLOSE_STREAM    = #D2
  34++9A7F
  35++9A7F              ; A - 0 warm reset, other - cold
  36++9A7F              init:
  37++9A7F A7               and a
  37++9A80 20 05          jr nz, .cold
  38++9A82                  GS_SendCommand CMD_WARM_RESET
  38++9A82 3E F3       >    ld a, CMD_WARM_RESET
  38++9A84 D3 BB       >  out (GeneralSound.CMD), a
  39++9A86 C9               ret
  40++9A87              .cold
  41++9A87                  GS_SendCommand CMD_COLD_RESET
  41++9A87 3E F4       >    ld a, CMD_COLD_RESET
  41++9A89 D3 BB       >  out (GeneralSound.CMD), a
  42++9A8B C9               ret
  43++9A8C
  44++9A8C              ;; Initializes loading module
  45++9A8C              loadModule:
  46++9A8C                  GS_SendCommand CMD_LOAD_MODULE
  46++9A8C 3E 30       >    ld a, CMD_LOAD_MODULE
  46++9A8E D3 BB       >  out (GeneralSound.CMD), a
  47++9A90                  GS_WaitCommand
  47++9A90             >.wait
  47++9A90 DB BB       >    in a, (GeneralSound.CMD)
  47++9A92 0F          >    rrca
  47++9A93 38 FB       >    jr c, .wait
  48++9A95                  GS_SendCommand CMD_OPEN_STREAM
  48++9A95 3E D1       >    ld a, CMD_OPEN_STREAM
  48++9A97 D3 BB       >  out (GeneralSound.CMD), a
  49++9A99                  GS_WaitCommand
  49++9A99             >.wait
  49++9A99 DB BB       >    in a, (GeneralSound.CMD)
  49++9A9B 0F          >    rrca
  49++9A9C 38 FB       >    jr c, .wait
  50++9A9E C9               ret
  51++9A9F
  52++9A9F              ;; Use it for streaming mod file
  53++9A9F              sendByte:
  54++9A9F D3 B3            out (DATA), a
  55++9AA1                  GS_WaitData
  55++9AA1             >.wait
  55++9AA1 DB BB       >    in a, (GeneralSound.CMD)
  55++9AA3 07          >    rlca
  55++9AA4 38 FB       >    jr c, .wait
  56++9AA6 C9               ret
  57++9AA7
  58++9AA7              ;; Call it when module was loaded
  59++9AA7              finishLoadingModule:
  60++9AA7                  GS_SendCommand CMD_CLOSE_STREAM
  60++9AA7 3E D2       >    ld a, CMD_CLOSE_STREAM
  60++9AA9 D3 BB       >  out (GeneralSound.CMD), a
  61++9AAB                  GS_WaitCommand
  61++9AAB             >.wait
  61++9AAB DB BB       >    in a, (GeneralSound.CMD)
  61++9AAD 0F          >    rrca
  61++9AAE 38 FB       >    jr c, .wait
  62++9AB0              rewind:
  63++9AB0 3E 01            ld a, 1
  63++9AB2 D3 B3          out (DATA), a
  64++9AB4                  GS_SendCommand CMD_PLAY_MODULE
  64++9AB4 3E 31       >    ld a, CMD_PLAY_MODULE
  64++9AB6 D3 BB       >  out (GeneralSound.CMD), a
  65++9AB8                  GS_WaitCommand
  65++9AB8             >.wait
  65++9AB8 DB BB       >    in a, (GeneralSound.CMD)
  65++9ABA 0F          >    rrca
  65++9ABB 38 FB       >    jr c, .wait
  66++9ABD 3E 01 32 DE      ld a, 1, (state),a
  66++9AC1 9A
  67++9AC2 C9               ret
  68++9AC3
  69++9AC3              ;; Works like pause too
  70++9AC3              stopModule:
  71++9AC3 AF               xor a
  71++9AC4 32 DE 9A       ld (state), a
  72++9AC7                  GS_SendCommand CMD_STOP_MODULE
  72++9AC7 3E 32       >    ld a, CMD_STOP_MODULE
  72++9AC9 D3 BB       >  out (GeneralSound.CMD), a
  73++9ACB C9               ret
  74++9ACC
  75++9ACC              continueModule:
  76++9ACC 3E 01            ld a, 1
  76++9ACE 32 DE 9A       ld (state), a
  77++9AD1                  GS_SendCommand CMD_CONTINUE_MODULE
  77++9AD1 3E 33       >    ld a, CMD_CONTINUE_MODULE
  77++9AD3 D3 BB       >  out (GeneralSound.CMD), a
  78++9AD5 C9               ret
  79++9AD6
  80++9AD6              ; Pauses resumes
  81++9AD6              toggleModule:
  82++9AD6                  ;call Console.waitForKeyUp
  83++9AD6 3A DE 9A         ld a, (state)
  83++9AD9 A7             and a
  84++9ADA 28 F0            jr z, continueModule
  85++9ADC 18 E5            jr stopModule
  86++9ADE
  87++9ADE 00           state db 0
  88++9ADF                  endmodule
  89++9ADF
  90++9ADF                  ;endif
# file closed: GPlay/common/general-sound.asm
 574+ 9ADF              	;include common/muldiv.asm
 575+ 9ADF
 576+ 9ADF              end_gplay
 577+ 9ADF
 578+ 9ADF
 579+ 9ADF
 580+ 9ADF              ;ниже не включается в файл
 581+ 9ADF              ;waveheaderbuffer equ 0xc000-2048=0xb800 ;
 582+ 9ADF
 583+ 9ADF
 584+ 9ADF              	;savebin "gplay.apg",start_gplay,$-start_gplay
# file closed: GPlay/gplay.asm
1373  9ADF              	include nc_pic_view.asm ;просмотр картинок
# file opened: nc_pic_view.asm
   1+ 9ADF                  ; module ScreenViewer
   2+ 9ADF              display:
   3+ 9ADF                  ; call Console.waitForKeyUp
   4+ 9ADF
   5+ 9ADF              display_wait1
   6+ 9ADF 3E 07        	ld a,7
   7+ 9AE1              	OS_SET_SCREEN ;включить экран
   7+ 9AE1 0E 1D       >    ld c,#1d
   7+ 9AE3 E7          >    rst #20
   8+ 9AE4 30 03        	jr nc,display_wait1_ok
   9+ 9AE6              	OS_WAIT
   9+ 9AE6 DF          >	rst #18
  10+ 9AE7 18 F6        	jr display_wait1 ;пока не получилось, может не в фокусе приложение
  11+ 9AE9
  12+ 9AE9              display_wait1_ok
  13+ 9AE9
  14+ 9AE9 3A 1E 9D     	ld a,(page_ext01) ;доп страница для данных плеера
  15+ 9AEC 06 07        	ld b,7 ;страница назначения
  16+ 9AEE 21 00 80     	ld hl,#8000
  17+ 9AF1 11 00 C0     	ld de,#c000
  18+ 9AF4 DD 21 00 1B  	ld ix,6912
  19+ 9AF8              	OS_RAM_COPY
  19+ 9AF8 0E 19       >    ld c,#19
  19+ 9AFA E7          >    rst #20
  20+ 9AFB                  ;call TextMode.disable
  21+ 9AFB              .wait
  22+ 9AFB              	OS_WAIT
  22+ 9AFB DF          >	rst #18
  23+ 9AFC              	OS_GET_CHAR
  23+ 9AFC 0E 10       >    ld c,#10
  23+ 9AFE E7          >    rst #20
  24+ 9AFF FE FF        	cp 255
  25+ 9B01 28 F8        	jr z, .wait
  26+ 9B03 AF           	xor a ;текстовый экран
  27+ 9B04              	OS_SET_SCREEN
  27+ 9B04 0E 1D       >    ld c,#1d
  27+ 9B06 E7          >    rst #20
  28+ 9B07                  ;call TextMode.cls
  29+ 9B07
  30+ 9B07 C9           	ret
  31+ 9B08                  ;jp History.back
  32+ 9B08
  33+ 9B08              ;    endmodule
  34+ 9B08
# file closed: nc_pic_view.asm
1374  9B08
1375  9B08              color_default equ 0*8+7 ;цвет обычный системный
1376  9B08              color_view_text equ 4 ;цвет текста в просмотрщике
1377  9B08
1378  9B08              color_backgr equ 1*8+7 ;цвет фона
1379  9B08              color_apg equ 1*8+4 ;цвет приложений
1380  9B08              color_dir equ 1*8+6 ;цвет папок
1381  9B08
1382  9B08              color_backgr_hi equ 5*8+0 ;цвет фона курсор
1383  9B08              color_apg_hi equ 5*8+0 ;цвет приложений курсор
1384  9B08              color_dir_hi equ 5*8+0 ;цвет папок курсор
1385  9B08
1386  9B08              file_info_lenght equ 255 ;длина инфо о файле
1387  9B08              panel_hight equ 22;высота панели
1388  9B08              panel_r_xy equ #0129
1389  9B08              buffer_cat equ #c000 ;адрес буфера каталога
1390  9B08
1391  9B08 00 00        file_r_all dw 0;всего файлов справа
1392  9B0A 00 00        file_r_cur_focus dw 0;первый видимый
1393  9B0C 00 00 00...  file_name_cur ds 256 ;имя файла текущее
1394  9C0C 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
1395  9D0C 20 20 20 20  file_info_clear db "            ",0 ;для очистки
1395  9D10 20 20 20 20
1395  9D14 20 20 20 20
1395  9D18 00
1396  9D19 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
1397  9D1A
1398  9D1A 00 00        file_r_num_cur dw 0 ;текущий файл справа
1399  9D1C 00           key_pressed db 0 ;последняя клавиша
1400  9D1D 00           file_id_cur_r db 0 ;id файла справа
1401  9D1E
1402  9D1E
1403  9D1E 00           page_ext01 db 0 ;номер дополнительной страницы
1404  9D1F 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1405  9D21 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1406  9D22 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1406  9D26 20 20 20 20
1406  9D2A 20 20 20 20
1406  9D2E 20 20 20 20
1406  9D32 20 20 20 20
1406  9D36 20 20 20 20
1406  9D3A 20 20 00
1407  9D3D
1408  9D3D
1409  9D3D              rect_1
1410  9D3D C9           	db #c9
1411  9D3E              	dup 40-2
1412  9D3E CD          >	db #cd
1412  9D3F CD          >	db #cd
1412  9D40 CD          >	db #cd
1412  9D41 CD          >	db #cd
1412  9D42 CD          >	db #cd
1412  9D43 CD          >	db #cd
1412  9D44 CD          >	db #cd
1412  9D45 CD          >	db #cd
1412  9D46 CD          >	db #cd
1412  9D47 CD          >	db #cd
1412  9D48 CD          >	db #cd
1412  9D49 CD          >	db #cd
1412  9D4A CD          >	db #cd
1412  9D4B CD          >	db #cd
1412  9D4C CD          >	db #cd
1412  9D4D CD          >	db #cd
1412  9D4E CD          >	db #cd
1412  9D4F CD          >	db #cd
1412  9D50 CD          >	db #cd
1412  9D51 CD          >	db #cd
1412  9D52 CD          >	db #cd
1412  9D53 CD          >	db #cd
1412  9D54 CD          >	db #cd
1412  9D55 CD          >	db #cd
1412  9D56 CD          >	db #cd
1412  9D57 CD          >	db #cd
1412  9D58 CD          >	db #cd
1412  9D59 CD          >	db #cd
1412  9D5A CD          >	db #cd
1412  9D5B CD          >	db #cd
1412  9D5C CD          >	db #cd
1412  9D5D CD          >	db #cd
1412  9D5E CD          >	db #cd
1412  9D5F CD          >	db #cd
1412  9D60 CD          >	db #cd
1412  9D61 CD          >	db #cd
1412  9D62 CD          >	db #cd
1412  9D63 CD          >	db #cd
1413  9D64              	edup
1414  9D64 BB 00        	db #bb,0
1415  9D66
1416  9D66              rect_2
1417  9D66 BA           	db #ba
1418  9D67              	dup 40-2
1419  9D67 20          >	db " "
1419  9D68 20          >	db " "
1419  9D69 20          >	db " "
1419  9D6A 20          >	db " "
1419  9D6B 20          >	db " "
1419  9D6C 20          >	db " "
1419  9D6D 20          >	db " "
1419  9D6E 20          >	db " "
1419  9D6F 20          >	db " "
1419  9D70 20          >	db " "
1419  9D71 20          >	db " "
1419  9D72 20          >	db " "
1419  9D73 20          >	db " "
1419  9D74 20          >	db " "
1419  9D75 20          >	db " "
1419  9D76 20          >	db " "
1419  9D77 20          >	db " "
1419  9D78 20          >	db " "
1419  9D79 20          >	db " "
1419  9D7A 20          >	db " "
1419  9D7B 20          >	db " "
1419  9D7C 20          >	db " "
1419  9D7D 20          >	db " "
1419  9D7E 20          >	db " "
1419  9D7F 20          >	db " "
1419  9D80 20          >	db " "
1419  9D81 20          >	db " "
1419  9D82 20          >	db " "
1419  9D83 20          >	db " "
1419  9D84 20          >	db " "
1419  9D85 20          >	db " "
1419  9D86 20          >	db " "
1419  9D87 20          >	db " "
1419  9D88 20          >	db " "
1419  9D89 20          >	db " "
1419  9D8A 20          >	db " "
1419  9D8B 20          >	db " "
1419  9D8C 20          >	db " "
1420  9D8D              	edup
1421  9D8D BA 00        	db #ba,0
1422  9D8F
1423  9D8F              rect_3
1424  9D8F C8           	db #c8
1425  9D90              	dup 40-2
1426  9D90 CD          >	db #cd
1426  9D91 CD          >	db #cd
1426  9D92 CD          >	db #cd
1426  9D93 CD          >	db #cd
1426  9D94 CD          >	db #cd
1426  9D95 CD          >	db #cd
1426  9D96 CD          >	db #cd
1426  9D97 CD          >	db #cd
1426  9D98 CD          >	db #cd
1426  9D99 CD          >	db #cd
1426  9D9A CD          >	db #cd
1426  9D9B CD          >	db #cd
1426  9D9C CD          >	db #cd
1426  9D9D CD          >	db #cd
1426  9D9E CD          >	db #cd
1426  9D9F CD          >	db #cd
1426  9DA0 CD          >	db #cd
1426  9DA1 CD          >	db #cd
1426  9DA2 CD          >	db #cd
1426  9DA3 CD          >	db #cd
1426  9DA4 CD          >	db #cd
1426  9DA5 CD          >	db #cd
1426  9DA6 CD          >	db #cd
1426  9DA7 CD          >	db #cd
1426  9DA8 CD          >	db #cd
1426  9DA9 CD          >	db #cd
1426  9DAA CD          >	db #cd
1426  9DAB CD          >	db #cd
1426  9DAC CD          >	db #cd
1426  9DAD CD          >	db #cd
1426  9DAE CD          >	db #cd
1426  9DAF CD          >	db #cd
1426  9DB0 CD          >	db #cd
1426  9DB1 CD          >	db #cd
1426  9DB2 CD          >	db #cd
1426  9DB3 CD          >	db #cd
1426  9DB4 CD          >	db #cd
1426  9DB5 CD          >	db #cd
1427  9DB6              	edup
1428  9DB6 BC 00        	db #bc,0
1429  9DB8
1430  9DB8              ;file_name_test db '486 HEART ON FIRE.vgm',0
1431  9DB8              msg_menu_info
1432  9DB8 0D 43 53 2B  	db 13,"CS+Enter - Play all",0
1432  9DBC 45 6E 74 65
1432  9DC0 72 20 2D 20
1432  9DC4 50 6C 61 79
1432  9DC8 20 61 6C 6C
1432  9DCC 00
1433  9DCD              msg_menu_main1
1434  9DCD 20 4C 46 20  	db " LF On",0
1434  9DD1 4F 6E 00
1435  9DD4              msg_menu_main2
1436  9DD4 20 41 5A 20  	db " AZ On",0
1436  9DD8 4F 6E 00
1437  9DDB              msg_menu_main3
1438  9DDB 20 56 69 65  	db " View",0
1438  9DDF 77 00
1439  9DE1              msg_file_error
1440  9DE1 46 69 6C 65  	db "File error",13,0
1440  9DE5 20 65 72 72
1440  9DE9 6F 72 0D 00
1441  9DED              msg_file_too_big
1442  9DED 46 69 6C 65  	db "File too big",13,0
1442  9DF1 20 74 6F 6F
1442  9DF5 20 62 69 67
1442  9DF9 0D 00
1443  9DFB              msg_mem_err
1444  9DFB 47 65 74 20  	db "Get memory error",13,0
1444  9DFF 6D 65 6D 6F
1444  9E03 72 79 20 65
1444  9E07 72 72 6F 72
1444  9E0B 0D 00
1445  9E0D              msg_mono_err
1446  9E0D 47 65 74 20  	db "Get mono mode error",13,0
1446  9E11 6D 6F 6E 6F
1446  9E15 20 6D 6F 64
1446  9E19 65 20 65 72
1446  9E1D 72 6F 72 0D
1446  9E21 00
1447  9E22              msg_title_nc
1448  9E22 4E 6F 6E 65  	db "None Commander ver 2025.08.07",13,0
1448  9E26 20 43 6F 6D
1448  9E2A 6D 61 6E 64
1448  9E2E 65 72 20 76
1448  9E32 65 72 20 32
1448  9E36 30 32 35 2E
1448  9E3A 30 38 2E 30
1448  9E3E 37 0D 00
1449  9E41
1450  9E41
1451  9E41
1452  9E41              start_gp_gzip equ #4000 ;рабочий адрес модуля для распаковки
1453  9E41
1454  9E41              start_gp_gzip_tmp
1455  9E41              	incbin "gp_gzip.bin" ; часть плеера для режима моно
1456  B941              end_gp_gzip_tmp
1457  B941
1458  B941
1459  B941
1460  B941              end_nc
1461  B941              	savebin "nc.apg",start_nc,$-start_nc
1462  B941
1463  B941              ;ниже не включается в файл
1464  B941 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1465  BD41 00 00 00...  cat_index_2 ds 1024 ;буфер для индекса (вектора) сортировки 2
1466  C141 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1467  C241
1468  C241              end_nc_all
1469  C241
1470  C241
1471  C241
1472  C241              	org 0xb800 ;
1473  B800              ;ещё тут буферы плеера VGM до адреса #bf00
1474  B800
1475  B800
# file closed: nc.asm
