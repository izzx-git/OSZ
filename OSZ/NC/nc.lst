# file opened: nc.asm
   1  0000              ;None Commander - приложение для OS GMX
   2  0000                 device ZXSPECTRUM128
   3  0000              	include "../os_defs.asm"
# file opened: ../os_defs.asm
   1+ 0000              ;Список всех вызовов (функций) ОС GMX
   2+ 0000
   3+ 0000              ;Включить в свой код (в начале файла):
   4+ 0000              	; include os_defs.asm
   5+ 0000
   6+ 0000              ;Использовать только имена функций, коды могут поменяться
   7+ 0000
   8+ 0000              ;например:
   9+ 0000              	; org PROGSTART
  10+ 0000              	; ../include os_defs.asm
  11+ 0000              	; ld hl,text
  12+ 0000              	; OS_PRINTZ ;печать	до кода 0
  13+ 0000
  14+ 0000              ;сохранность регистров не гарантируется
  15+ 0000              ;на выходе обычно (но не всегда) CY=1 = ошибка
  16+ 0000
  17+ 0000              PROGSTART equ #8000 ;адрес старта приложений
  18+ 0000
  19+ 0000
  20+ 0000              ;короткие вызовы (именные RST) -------------------------
  21+ 0000
  22+ 0000              ;печать символа в консоль (ускоренная)
  23+ 0000              	MACRO OS_PRINT_CHARF ;a=char
  24+ 0000 ~            	rst #10
  25+ 0000              	ENDM
  26+ 0000
  27+ 0000
  28+ 0000              ;передача управления ОС до следующего прерывания (когда придёт очередь процесса в следующий раз);
  29+ 0000              ;все регистры сохраняются
  30+ 0000              ;рекомендуется использовать вместо обычного halt
  31+ 0000              	MACRO OS_WAIT
  32+ 0000 ~            	rst #18
  33+ 0000              	ENDM
  34+ 0000
  35+ 0000              	; MACRO OS_
  36+ 0000              	; rst #28
  37+ 0000              	; ENDM
  38+ 0000
  39+ 0000              	; MACRO OS_
  40+ 0000              	; rst #30
  41+ 0000              	; ENDM
  42+ 0000
  43+ 0000
  44+ 0000
  45+ 0000              ;вызовы через единую точку входа RST #20 ----------------
  46+ 0000
  47+ 0000              ;вывод в консоль --------------------
  48+ 0000
  49+ 0000              ;очистить консоль
  50+ 0000              	macro OS_CLS ;clear visible area of terminal
  51+ 0000 ~                ld c,#00
  52+ 0000 ~                rst #20
  53+ 0000                  endm
  54+ 0000
  55+ 0000              ;установить позицию курсора в консоли
  56+ 0000                  macro OS_SET_XY ;de=yx ;SET CURSOR POSITION
  57+ 0000 ~                ld c,#01
  58+ 0000 ~                rst #20
  59+ 0000                  endm
  60+ 0000
  61+ 0000              ;печать символа в консоль
  62+ 0000                  macro OS_PRINT_CHAR ;a=char
  63+ 0000 ~                ld c,#02
  64+ 0000 ~                rst #20
  65+ 0000                  endm
  66+ 0000
  67+ 0000              ;заполнение строки одним символом
  68+ 0000                  macro OS_FILL_LINE ;; H - line ; A - char
  69+ 0000 ~                ld c,#03
  70+ 0000 ~                rst #20
  71+ 0000                  endm
  72+ 0000
  73+ 0000              ;покрасить строку цветом
  74+ 0000                  macro OS_PAINT_LINE ;a - line, b - color
  75+ 0000 ~                ld c,#04
  76+ 0000 ~                rst #20
  77+ 0000                  endm
  78+ 0000
  79+ 0000
  80+ 0000                  ; macro OS_ ;
  81+ 0000                  ; ld c,#05
  82+ 0000                  ; rst #20
  83+ 0000                  ; endm
  84+ 0000
  85+ 0000              ;установить цвет текста в консоли;
  86+ 0000                  macro OS_SET_COLOR ;a = color, b = color 2 (highlight)
  87+ 0000 ~                ld c,#06
  88+ 0000 ~                rst #20
  89+ 0000                  endm
  90+ 0000
  91+ 0000                  ; macro OS_ ;
  92+ 0000                  ; ld c,#07
  93+ 0000                  ; rst #20
  94+ 0000                  ; endm
  95+ 0000
  96+ 0000                  ; macro OS_ ;
  97+ 0000                  ; ld c,#08
  98+ 0000                  ; rst #20
  99+ 0000                  ; endm
 100+ 0000
 101+ 0000
 102+ 0000
 103+ 0000              ;печать в консоль до кода 0
 104+ 0000                  macro OS_PRINTZ ;hl=text ;PRINT to 0
 105+ 0000 ~                ld c,#09
 106+ 0000 ~                rst #20
 107+ 0000                  endm
 108+ 0000
 109+ 0000
 110+ 0000              ;прочитать байт из порта uart
 111+ 0000              ;вх:
 112+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart или нет данных для приёма
 113+ 0000              ;вых: A - считанный байт
 114+ 0000                  macro OS_UART_READ
 115+ 0000 ~                ld c,#0a
 116+ 0000 ~                rst #20
 117+ 0000                  endm
 118+ 0000
 119+ 0000              ;записать байт в порт uart
 120+ 0000              ;вх: A -байт
 121+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 122+ 0000                  macro OS_UART_WRITE
 123+ 0000 ~                ld c,#0b
 124+ 0000 ~                rst #20
 125+ 0000                  endm
 126+ 0000
 127+ 0000              ;закрыть соединение ESP
 128+ 0000              ;вх:
 129+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 130+ 0000                  macro OS_ESP_CLOSE
 131+ 0000 ~                ld c,#0c
 132+ 0000 ~                rst #20
 133+ 0000                  endm
 134+ 0000
 135+ 0000              ;установить соединение ESP (CIPSTART);
 136+ 0000              ;вх: a - тип соединения 0-tcp, 1-udp, 2-ssl; 3-прямое соединение с портом; hl - строка адрес, de - строка порт
 137+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 138+ 0000              ;вых: ix - адрес в таблице соединений (ix+2 - флаг открытия =1 - открыто, 255 - ошибка);
 139+ 0000                  macro OS_ESP_OPEN
 140+ 0000 ~                ld c,#0d
 141+ 0000 ~                rst #20
 142+ 0000                  endm
 143+ 0000
 144+ 0000              ;послать запрос ESP (CIPSEND);
 145+ 0000              ;вх: hl - адрес данных, de - длина данных
 146+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 147+ 0000              ;вых: ix - адрес в таблице соединений (ix+4 - флаг =1 - отправлено, 255 - ошибка)
 148+ 0000                  macro OS_ESP_SEND
 149+ 0000 ~                ld c,#0e
 150+ 0000 ~                rst #20
 151+ 0000                  endm
 152+ 0000
 153+ 0000              ;получить пакет ESP (+IPD);
 154+ 0000              ;вх: hl - адрес для данных
 155+ 0000              ;вых: CY=0 - OK; CY=1 - занято другим процессом или нет uart
 156+ 0000              ;вых: ix - адрес в таблице соединений (ix+6 - флаг =1 - принято, 255 - ошибка)
 157+ 0000                  macro OS_ESP_GET
 158+ 0000 ~                ld c,#0f
 159+ 0000 ~                rst #20
 160+ 0000                  endm
 161+ 0000
 162+ 0000              ;ввод с консоли ----------------------
 163+ 0000
 164+ 0000              ;получить код нажатой клавиши
 165+ 0000                  macro OS_GET_CHAR ;read char from stdin (out: A=char, 255-no char)
 166+ 0000 ~                ld c,#10
 167+ 0000 ~                rst #20
 168+ 0000                  endm
 169+ 0000
 170+ 0000
 171+ 0000              ;процессы ----------------------------
 172+ 0000
 173+ 0000              ;запустить процесс
 174+ 0000              ;вх: hl - имя файла (заканчивается на 0)
 175+ 0000                  macro OS_PROC_RUN ;
 176+ 0000 ~                ld c,#11
 177+ 0000 ~                rst #20
 178+ 0000                  endm
 179+ 0000
 180+ 0000              ;установить фокус
 181+ 0000              ;вх: a - id процесса
 182+ 0000                  macro OS_PROC_SET_FOCUS ;
 183+ 0000 ~                ld c,#12
 184+ 0000 ~                rst #20
 185+ 0000                  endm
 186+ 0000
 187+ 0000              ;закрыть процесс
 188+ 0000              ;вх: A - ID процесса. Если A=0, закрыть текущий (себя)
 189+ 0000              ;останавливается процесс и освобождаются все его страницы памяти, файлы, соединения
 190+ 0000                  macro OS_PROC_CLOSE ;
 191+ 0000 ~                ld c,#13
 192+ 0000 ~                rst #20
 193+ 0000                  endm
 194+ 0000
 195+ 0000
 196+ 0000              ;прерывания --------------------------
 197+ 0000
 198+ 0000              ;установка адреса обработчика прерываний процесса;
 199+ 0000                  ; macro OS_SET_INTER ;(HL - address, A = 1 - On, A = 0 - Off)
 200+ 0000                  ; ld c,#14
 201+ 0000                  ; rst #20
 202+ 0000                  ; endm
 203+ 0000
 204+ 0000
 205+ 0000              ;плеер AY ----------------------------
 206+ 0000
 207+ 0000              ;инициализация плеера AY;
 208+ 0000                  macro OS_VTPL_INIT ;(HL - address music)
 209+ 0000 ~                ld c,#15
 210+ 0000 ~                rst #20
 211+ 0000                  endm
 212+ 0000
 213+ 0000              ;запустить плеер AY (система будет сама вызывать его каждое прерывание);
 214+ 0000                  macro OS_VTPL_PLAY ;()
 215+ 0000 ~                ld c,#16
 216+ 0000 ~                rst #20
 217+ 0000                  endm
 218+ 0000
 219+ 0000              ;заглушить плеер AY;
 220+ 0000                  macro OS_VTPL_MUTE ;()
 221+ 0000 ~                ld c,#17
 222+ 0000 ~                rst #20
 223+ 0000                  endm
 224+ 0000
 225+ 0000              ;получить значение переменной плеера;
 226+ 0000                  macro OS_GET_VTPL_SETUP ;(out: HL - setup address)
 227+ 0000 ~                ld c,#18
 228+ 0000 ~                rst #20
 229+ 0000                  endm
 230+ 0000
 231+ 0000
 232+ 0000              ;прочие ------------------------------
 233+ 0000
 234+ 0000
 235+ 0000              ;скопировать данные из страницы в страницу
 236+ 0000              ;вх: hl - откуда (абсолютный адрес 0-ffff); de - куда; ix - длина; a - страница слот2; b - страница слот3;
 237+ 0000                  macro OS_RAM_COPY
 238+ 0000 ~                ld c,#19
 239+ 0000 ~                rst #20
 240+ 0000                  endm
 241+ 0000
 242+ 0000              ;получить дополнительную страницу памяти;
 243+ 0000                  macro OS_GET_PAGE ;(out A - number page)
 244+ 0000 ~                ld c,#1a
 245+ 0000 ~                rst #20
 246+ 0000                  endm
 247+ 0000
 248+ 0000              ;включить страницу в слот 2 (#8000); предварительно зарезервировать страницу OS_GET_PAGE
 249+ 0000                  macro OS_SET_PAGE_SLOT2 ;(A - page number)
 250+ 0000 ~                ld c,#1b
 251+ 0000 ~                rst #20
 252+ 0000                  endm
 253+ 0000
 254+ 0000              ;включить страницу в слот 3 (#C000); предварительно зарезервировать страницу OS_GET_PAGE
 255+ 0000                  macro OS_SET_PAGE_SLOT3 ;(A - page number)
 256+ 0000 ~                ld c,#1c
 257+ 0000 ~                rst #20
 258+ 0000                  endm
 259+ 0000
 260+ 0000              ;включить экран N;
 261+ 0000              ;вх: A - номер экрана (5, 7, #39, #3a; 0 = текстовый)
 262+ 0000              ;переключать может только приложение в фокусе
 263+ 0000              ;если режим не текстовый, то приложение работает только когда в фокусе. Иначе временно останавливается.
 264+ 0000              ;при переключении процессов сохраняется только экран #39
 265+ 0000                  macro OS_SET_SCREEN ;
 266+ 0000 ~                ld c,#1d
 267+ 0000 ~                rst #20
 268+ 0000                  endm
 269+ 0000
 270+ 0000
 271+ 0000              ;получить номера страниц процесса;
 272+ 0000              ;вх:
 273+ 0000              ;вых: b, c - страницы в слотах 2, 3
 274+ 0000                  macro OS_GET_MAIN_PAGES ;
 275+ 0000 ~                ld c,#1e
 276+ 0000 ~                rst #20
 277+ 0000                  endm
 278+ 0000
 279+ 0000              ;получить значение системного таймера
 280+ 0000                  macro OS_GET_TIMER ;(out: HL, DE - timer)
 281+ 0000 ~                ld c,#1F
 282+ 0000 ~                rst #20
 283+ 0000                  endm
 284+ 0000
 285+ 0000
 286+ 0000
 287+ 0000                  ; macro OS_ ;
 288+ 0000                  ; ld c,#20
 289+ 0000                  ; rst #20
 290+ 0000                  ; endm
 291+ 0000
 292+ 0000
 293+ 0000              ;дисковые операции -------------------
 294+ 0000
 295+ 0000              ; менять напрямую что-то в таблице fcb из приложения не рекомендуется, только для чтения
 296+ 0000
 297+ 0000              ; fcbFAT (из руководства к монитору)
 298+ 0000              ; формат fcb для работы с FAT
 299+ 0000
 300+ 0000              ; +#00 8 имя файла
 301+ 0000              ; +#08 3 расширение файла
 302+ 0000              ; +#0B 1 атрибуты файла
 303+ 0000              ; +#0C 4 номер первого кластера файла/каталога
 304+ 0000              ; +#10 4 номер первого кластера каталога с этим файлом/каталогом
 305+ 0000              ; +#14 4 размер файла/каталога в байтах
 306+ 0000              ; +#18 4 указатель в файле
 307+ 0000              ; +#1C 1 для внутренних нужд
 308+ 0000              ; +#1D 1 для внутренних нужд
 309+ 0000              ; +#1E 1 резерв
 310+ 0000              ; +#1F 1 номер винчестера и раздела на нем
 311+ 0000              	; 1-0,nn номер раздела
 312+ 0000              	; 3-2,=00/01/10 HDD master/HDD slave/SD
 313+ 0000              	    ; значение %11 недопустимо
 314+ 0000
 315+ 0000              ;открыть файл для чтения или записи
 316+ 0000                  macro OS_FILE_OPEN ;HL - File name (out: A - id file, bc, de - size, IX - fcb)
 317+ 0000 ~                ld c,#21
 318+ 0000 ~                rst #20
 319+ 0000                  endm
 320+ 0000
 321+ 0000              ;создать файл
 322+ 0000                  macro OS_FILE_CREATE ;HL - File name  (out: A - id file, IX - fcb)
 323+ 0000 ~                ld c,#22
 324+ 0000 ~                rst #20
 325+ 0000                  endm
 326+ 0000
 327+ 0000              ;прочитать из файла
 328+ 0000                  macro OS_FILE_READ ;HL - address, A - id file, DE - length (out: bc - size readed)
 329+ 0000 ~                ld c,#23
 330+ 0000 ~                rst #20
 331+ 0000                  endm
 332+ 0000
 333+ 0000              ;записать в файл
 334+ 0000                  macro OS_FILE_WRITE ;HL - address, A - id file, DE - length (out: bc - size writed)
 335+ 0000 ~                ld c,#24
 336+ 0000 ~                rst #20
 337+ 0000                  endm
 338+ 0000
 339+ 0000              ;закрыть файл
 340+ 0000                  macro OS_FILE_CLOSE ;A - id file
 341+ 0000 ~                ld c,#25
 342+ 0000 ~                rst #20
 343+ 0000                  endm
 344+ 0000
 345+ 0000              ;чтение секторов текущего каталога
 346+ 0000              ; вх:
 347+ 0000                   ; hl - буфер для чтения
 348+ 0000                   ; de - относительный номер первого сектора каталога для чтения [0..nn]
 349+ 0000                   ; b - максимальное количество секторов для чтения
 350+ 0000              ; вых: cy=1, если были ошибки, код ошибки возвращается в аккумуляторе
 351+ 0000                     ; a=errRWnum
 352+ 0000                     ; a=errInvalidPart
 353+ 0000                     ; a=errFileEmpty
 354+ 0000                   ; cy=0, a=errEoF - каталог закончился
 355+ 0000                     ; hl - следующий адрес в буфере
 356+ 0000                     ; de - номер первого непрочитанного сектора
 357+ 0000                     ; b - не прочитано секторов
 358+ 0000                   ; cy=0 - считано успешно
 359+ 0000                     ; hl - следующий адрес в буфере
 360+ 0000                     ; de - номер первого непрочитанного сектора
 361+ 0000                     ; b=#00
 362+ 0000                  macro OS_DIR_READ ;
 363+ 0000 ~                ld c,#26
 364+ 0000 ~                rst #20
 365+ 0000                  endm
 366+ 0000
 367+ 0000              ;вход в каталог/выход в родительский каталог
 368+ 0000              	; Если путь не указан производится только настройка переменных драйвера,
 369+ 0000              	; при этом если передан дескриптор файла, текущий каталог не изменится)
 370+ 0000              	; Если пусть указан, в конец пути добавится название каталога (если это
 371+ 0000              	; переход в родительский, последнее имя в пути удалится).
 372+ 0000              	; Если передан дескриптор файла, текущий каталог не изменится, к пути
 373+ 0000              	; добавится имя файла
 374+ 0000              ; вх:
 375+ 0000                   ; hl - адрес пути (=#0000 - путь отсутствует)
 376+ 0000                   ; de - адрес дескриптора директории/файла
 377+ 0000              ; вых: a - если путь был указан, новая длина пути
 378+ 0000                  macro OS_DIR_OPEN ;
 379+ 0000 ~                ld c,#27
 380+ 0000 ~                rst #20
 381+ 0000                  endm
 382+ 0000
 383+ 0000              ;установка/чтение указателя в файле (Переменная +#18-#1b fcb)
 384+ 0000              ;проверки на допустимость значений не производится
 385+ 0000              ;вх: CY = 1 - установка; CY = 0 - чтение
 386+ 0000              ;вх: A - id файла
 387+ 0000              ;вх: de, hl - значения старшие быйты, младшие
 388+ 0000              ;вых: de, hl - значения старшие быйты, младшие
 389+ 0000                  macro OS_FILE_POSITION ;
 390+ 0000 ~                ld c,#28
 391+ 0000 ~                rst #20
 392+ 0000                  endm
 393+ 0000
 394+ 0000              ; поиск файла или каталога по заданному пути, начиная от корневого, со входом в подкаталоги
 395+ 0000              ;вх: hl - путь к файлу в формате ASCIZ (не более 250 байт, заканчивается нулем)
 396+ 0000              	 ;формат пути: \[DIR\DIR\..\DIR\]filename.ext	(можно без имени файла, только каталоги)
 397+ 0000              ;вх: a=#00/#FF - без установки каталога/с установкой найденного каталога текущим
 398+ 0000                  macro OS_FIND_PATH ;
 399+ 0000 ~                ld c,#29
 400+ 0000 ~                rst #20
 401+ 0000                  endm
 402+ 0000
 403+ 0000
 404+ 0000              ; получение длинного имени файла
 405+ 0000              ;вх: hl - адрес буфера для имени
 406+ 0000              ;    de - номер записи в текущем каталоге
 407+ 0000              ;вых: hl - в буфере имя в формате ASCIZ (если длинное имя отсутсвует, то возвращается короткое имя)
 408+ 0000              ; 	a - длина имени, с учетом нуля
 409+ 0000                  macro OS_GET_LFN ;
 410+ 0000 ~                ld c,#2a
 411+ 0000 ~                rst #20
 412+ 0000                  endm
 413+ 0000
# file closed: ../os_defs.asm
   4  0000              	org PROGSTART
   5  8000
   6  8000              start_nc
   7  8000 21 6A 8A     	ld hl,msg_title_nc ;имя приложения
   8  8003              	OS_PRINTZ ;печать
   8  8003 0E 09       >    ld c,#09
   8  8005 E7          >    rst #20
   9  8006
  10  8006
  11  8006              	;узнать свои страницы
  12  8006              	OS_GET_MAIN_PAGES
  12  8006 0E 1E       >    ld c,#1e
  12  8008 E7          >    rst #20
  13  8009 38 09        	jr c,get_page_error
  14  800B
  15  800B ED 43 8B 89  	ld (page_main),bc
  16  800F
  17  800F
  18  800F              	OS_GET_PAGE ;получить лишнюю страницу
  18  800F 0E 1A       >    ld c,#1a
  18  8011 E7          >    rst #20
  19  8012 30 0C        	jr nc,get_page_ok
  20  8014              get_page_error
  21  8014 21 57 8A     	ld hl,msg_mem_err ;нет памяти
  22  8017              	OS_PRINTZ ;печать
  22  8017 0E 09       >    ld c,#09
  22  8019 E7          >    rst #20
  23  801A
  24  801A CD A2 80     	call delay
  25  801D C3 A0 81     	jp exit
  26  8020
  27  8020              get_page_ok
  28  8020 32 8A 89     	ld (page_ext01),a ;запомнить
  29  8023
  30  8023
  31  8023
  32  8023              start_nc_warm ;тёплый старт
  33  8023
  34  8023              	;очистка буфера
  35  8023 CD A8 80     	call clear_buf
  36  8026
  37  8026              	;загрузка каталога
  38  8026 21 00 C0     	ld hl,buffer_cat ;куда
  39  8029 11 00 00     	ld de,0 ;начиная с 0 сектора
  40  802C 06 20        	ld b,32 ; секторов = 16384 = 512 файлов макс
  41  802E              	OS_DIR_READ
  41  802E 0E 26       >    ld c,#26
  41  8030 E7          >    rst #20
  42  8031
  43  8031 21 00 00     	ld hl,0 ;обнулить переменные
  44  8034 22 86 89     	ld (file_r_num_cur),hl
  45  8037 22 74 87     	ld (file_r_all),hl
  46  803A 22 76 87     	ld (file_r_cur_focus),hl
  47  803D
  48  803D CD B0 82     	call sort_dir
  49  8040
  50  8040 3E 0F        	ld a,color_backgr
  51  8042 06 0C        	ld b,#c
  52  8044              	OS_SET_COLOR
  52  8044 0E 06       >    ld c,#06
  52  8046 E7          >    rst #20
  53  8047
  54  8047 CD 35 84     	call print_rect_r ;рамка
  55  804A CD B8 81     	call print_panel_r
  56  804D CD 6A 84     	call print_menu_main
  57  8050
  58  8050 11 00 01     	ld de,#0100
  59  8053              	OS_SET_XY
  59  8053 0E 01       >    ld c,#01
  59  8055 E7          >    rst #20
  60  8056
  61  8056
  62  8056
  63  8056              nc_wait
  64  8056              	OS_WAIT ;ждать прерывание
  64  8056 DF          >	rst #18
  65  8057
  66  8057              	OS_GET_CHAR ;клавиша
  66  8057 0E 10       >    ld c,#10
  66  8059 E7          >    rst #20
  67  805A 32 88 89     	ld (key_pressed),a ;запомнить
  68  805D FE 0D        	cp 13
  69  805F CA BF 80     	jp z,key_enter ;
  70  8062 FE 0A        	cp 10 ;вниз
  71  8064 CC 0C 81     	call z,key_down
  72  8067 FE 0B        	cp 11 ;вверх
  73  8069 CC 49 81     	call z,key_up
  74  806C FE 09        	cp 09 ;вправо
  75  806E CC 8E 81     	call z,key_right
  76  8071 FE 08        	cp 08 ;влево
  77  8073 CC 7C 81     	call z,key_left
  78  8076 FE 04        	cp 04 ;страница вверх
  79  8078 CC 7C 81     	call z,key_left
  80  807B FE 05        	cp 05 ;страница вниз
  81  807D CC 8E 81     	call z,key_right
  82  8080 FE 31        	cp "1" ;переключение длинных имён (LFN)
  83  8082 CA E3 83     	jp z,LFN_toggle
  84  8085 FE 32        	cp "2" ;переключение сортировки
  85  8087 CA C3 83     	jp z,sort_toggle
  86  808A FE 33        	cp "3" ;просмотр файла
  87  808C CA 96 84     	jp z,view_file
  88  808F FE 18        	cp 24 ;break
  89  8091 CA A0 81     	jp z,exit
  90  8094
  91  8094
  92  8094 3A 8D 89     	ld a,(print_panel_r_flag)
  93  8097 B7           	or a
  94  8098 C4 B8 81     	call nz,print_panel_r ;обновить каталог
  95  809B AF           	xor a
  96  809C 32 8D 89     	ld (print_panel_r_flag),a
  97  809F
  98  809F C3 56 80     	jp nc_wait ;на цикл ожидания
  99  80A2
 100  80A2
 101  80A2              delay ;задержка
 102  80A2 06 96        	ld b,50*3 ;
 103  80A4              delay1
 104  80A4              	OS_WAIT
 104  80A4 DF          >	rst #18
 105  80A5 10 FD        	djnz delay1
 106  80A7 C9           	ret
 107  80A8
 108  80A8
 109  80A8              clear_buf
 110  80A8 21 00 C0     	ld hl,buffer_cat
 111  80AB 11 01 C0     	ld de,buffer_cat+1
 112  80AE 01 FF 3F     	ld bc,#4000-1
 113  80B1 36 00        	ld (hl),0
 114  80B3 ED B0        	ldir
 115  80B5 C9           	ret
 116  80B6
 117  80B6
 118  80B6
 119  80B6
 120  80B6              release_key ;ждать отпускания клавиши
 121  80B6              	OS_WAIT
 121  80B6 DF          >	rst #18
 122  80B7              	OS_GET_CHAR
 122  80B7 0E 10       >    ld c,#10
 122  80B9 E7          >    rst #20
 123  80BA FE FF        	cp 255
 124  80BC 20 F8        	jr nz,release_key
 125  80BE C9           	ret
 126  80BF
 127  80BF
 128  80BF              key_enter
 129  80BF              	;нажата Enter
 130  80BF 2A 74 87     	ld hl,(file_r_all)
 131  80C2 7D           	ld a,l
 132  80C3 B4           	or h
 133  80C4 CA EF 80     	jp z,key_enter_ex ;защита
 134  80C7 2A 86 89     	ld hl,(file_r_num_cur)
 135  80CA CD FF 80     	call calc_deskr
 136  80CD DD 7E 0B     	ld a,(ix+#0b)
 137  80D0 FE 10        	cp #10 ;признак каталога
 138  80D2 28 1E        	jr z,key_enter_dir
 139  80D4
 140  80D4 FE 30        	cp #30 ;признак каталога
 141  80D6 28 1A        	jr z,key_enter_dir
 142  80D8
 143  80D8              	;проверка расширения ;APG
 144  80D8 CD A4 81     	call check_apg
 145  80DB C2 EF 80     	jp nz,key_enter_ex
 146  80DE              	;тут запуск приложения
 147  80DE CD 00 84     	call format_name
 148  80E1
 149  80E1 21 78 87     	ld hl,file_name_cur		;строка с именем
 150  80E4              	OS_PROC_RUN ;запустить прогу
 150  80E4 0E 11       >    ld c,#11
 150  80E6 E7          >    rst #20
 151  80E7              	;обработка ошибки
 152  80E7 38 06        	jr c,key_enter_ex
 153  80E9
 154  80E9 DD 7E 00     	ld a,(ix)
 155  80EC              	OS_PROC_SET_FOCUS ;на передний план
 155  80EC 0E 12       >    ld c,#12
 155  80EE E7          >    rst #20
 156  80EF
 157  80EF              key_enter_ex
 158  80EF C3 56 80     	jp nc_wait
 159  80F2
 160  80F2              key_enter_dir
 161  80F2              	;тут открытие папки
 162  80F2
 163  80F2              	;call format_name_dir
 164  80F2 EB           	ex de,hl ;de - дескриптор для открытия
 165  80F3 21 78 88     	ld hl,dir_name_cur
 166  80F6              	OS_DIR_OPEN
 166  80F6 0E 27       >    ld c,#27
 166  80F8 E7          >    rst #20
 167  80F9 38 F4        	jr c,key_enter_ex ;если ошибка, ничего не делаем
 168  80FB
 169  80FB E1           	pop hl ;отменить возврат
 170  80FC C3 23 80     	jp start_nc_warm ;перезагрузить папку
 171  80FF
 172  80FF
 173  80FF              ; format_name_dir
 174  80FF              	; push hl
 175  80FF              	; ld hl,file_name_cur
 176  80FF              	; ld de,file_name_cur+1 ;почистить
 177  80FF              	; ld bc,256-1
 178  80FF              	; ld (hl),0
 179  80FF              	; ldir
 180  80FF
 181  80FF              	; pop hl
 182  80FF
 183  80FF              	; ld de,file_name_cur ;куда
 184  80FF              	; ld bc,#08ff
 185  80FF              ; format_name_dir_cl
 186  80FF              	; ld a,(hl)
 187  80FF              	; cp " "+1
 188  80FF              	; jr c,format_name_dir_skip
 189  80FF              	; ldi
 190  80FF              	; djnz format_name_dir_cl
 191  80FF              ; format_name_dir_skip
 192  80FF              	; ld a,'/'
 193  80FF              	; ld (de),a
 194  80FF              	; ret
 195  80FF
 196  80FF               ;вычислить дескриптор текущего элемента справа
 197  80FF              calc_deskr
 198  80FF 29           	add hl,hl ;*2
 199  8100 01 8A 8A     	ld bc,cat_index
 200  8103 09           	add hl,bc
 201  8104 5E           	ld e,(hl)
 202  8105 23           	inc hl
 203  8106 56           	ld d,(hl)
 204  8107 EB           	ex de,hl ;hl - адрес элемента
 205  8108 E5           	push hl
 206  8109 DD E1        	pop ix ;ix- адрес элемента
 207  810B C9           	ret
 208  810C
 209  810C
 210  810C
 211  810C
 212  810C              key_down
 213  810C 2A 74 87     	ld hl,(file_r_all)
 214  810F 7D           	ld a,l
 215  8110 B4           	or h
 216  8111 CA 45 81     	jp z,key_down_ex ;защита
 217  8114
 218  8114 ED 4B 86 89  	ld bc,(file_r_num_cur)
 219  8118 03           	inc bc
 220  8119 2A 74 87     	ld hl,(file_r_all)
 221  811C              	;если не больше чем всего
 222  811C A7           	and a
 223  811D ED 42        	sbc hl,bc
 224  811F 38 24        	jr c,key_down_skip
 225  8121 28 22        	jr z,key_down_skip
 226  8123              	;прибавить
 227  8123 ED 43 86 89  	ld (file_r_num_cur),bc
 228  8127
 229  8127              	;теперь передвинуть фокус, если надо
 230  8127 2A 76 87     	ld hl,(file_r_cur_focus)
 231  812A 01 16 00     	ld bc,panel_hight
 232  812D 09           	add hl,bc ;прибавить количество видимых
 233  812E ED 4B 86 89  	ld bc,(file_r_num_cur)
 234  8132 A7           	and a
 235  8133 ED 42        	sbc hl,bc ;вычесть положение курсора
 236  8135 28 02        	jr z,key_down_change_focus_yes
 237  8137 30 07        	jr nc,key_down_change_focus_no
 238  8139              key_down_change_focus_yes
 239  8139              	;передвинуть фокус
 240  8139 2A 76 87     	ld hl,(file_r_cur_focus)
 241  813C 23           	inc hl
 242  813D 22 76 87     	ld (file_r_cur_focus),hl
 243  8140
 244  8140              key_down_change_focus_no
 245  8140 3E 01        	ld a,1
 246  8142 32 8D 89     	ld (print_panel_r_flag),a
 247  8145              	;call print_panel_r ;обновить каталог
 248  8145              key_down_skip
 249  8145
 250  8145              key_down_ex
 251  8145 3A 88 89     	ld a,(key_pressed)
 252  8148 C9           	ret
 253  8149
 254  8149
 255  8149
 256  8149              key_up ;вверх
 257  8149 2A 74 87     	ld hl,(file_r_all)
 258  814C 7D           	ld a,l
 259  814D B4           	or h
 260  814E CA 78 81     	jp z,key_up_ex ;защита
 261  8151
 262  8151 2A 86 89     	ld hl,(file_r_num_cur)
 263  8154 7D           	ld a,l
 264  8155 B4           	or h
 265  8156 28 20        	jr z,key_up_skip
 266  8158 2B           	dec hl
 267  8159 22 86 89     	ld (file_r_num_cur),hl
 268  815C
 269  815C              	;теперь передвинуть фокус, если надо
 270  815C 2A 86 89     	ld hl,(file_r_num_cur)
 271  815F              	; ld bc,panel_hight
 272  815F              	; add hl,bc ;прибавить количество видимых
 273  815F ED 4B 76 87  	ld bc,(file_r_cur_focus)
 274  8163 A7           	and a
 275  8164 ED 42        	sbc hl,bc ;вычесть положение курсора
 276  8166              	;jr z,key_up_change_foces_yes
 277  8166 30 0B        	jr nc,key_up_change_foces_no
 278  8168              key_up_change_foces_yes
 279  8168              	;передвинуть фокус
 280  8168 2A 76 87     	ld hl,(file_r_cur_focus)
 281  816B 7C           	ld a,h
 282  816C B5           	or l
 283  816D 28 04        	jr z,key_up_change_foces_no ;защита
 284  816F 2B           	dec hl
 285  8170 22 76 87     	ld (file_r_cur_focus),hl
 286  8173
 287  8173              key_up_change_foces_no
 288  8173
 289  8173 3E 01        	ld a,1
 290  8175 32 8D 89     	ld (print_panel_r_flag),a
 291  8178              	;call print_panel_r ;обновить каталог
 292  8178              key_up_skip
 293  8178
 294  8178              key_up_ex
 295  8178 3A 88 89     	ld a,(key_pressed)
 296  817B C9           	ret
 297  817C
 298  817C
 299  817C              key_left ;на страницу назад
 300  817C 06 15        	ld b,panel_hight-1
 301  817E              key_left_cl
 302  817E C5           	push bc
 303  817F CD 49 81     	call key_up
 304  8182 C1           	pop bc
 305  8183 10 F9        	djnz key_left_cl
 306  8185 3E 01        	ld a,1
 307  8187 32 8D 89     	ld (print_panel_r_flag),a
 308  818A 3A 88 89     	ld a,(key_pressed)
 309  818D C9           	ret
 310  818E
 311  818E
 312  818E
 313  818E              key_right ;на страницу вперёд
 314  818E 06 15        	ld b,panel_hight-1
 315  8190              key_right_cl
 316  8190 C5           	push bc
 317  8191 CD 0C 81     	call key_down
 318  8194 C1           	pop bc
 319  8195 10 F9        	djnz key_right_cl
 320  8197 3E 01        	ld a,1
 321  8199 32 8D 89     	ld (print_panel_r_flag),a
 322  819C 3A 88 89     	ld a,(key_pressed)
 323  819F C9           	ret
 324  81A0
 325  81A0
 326  81A0
 327  81A0              exit ;выход в DOS
 328  81A0 AF           	xor a
 329  81A1              	OS_PROC_CLOSE
 329  81A1 0E 13       >    ld c,#13
 329  81A3 E7          >    rst #20
 330  81A4
 331  81A4
 332  81A4
 333  81A4              check_apg ;проверка на расширение APG
 334  81A4 DD 7E 08     	ld a,(ix+8)
 335  81A7 FE 41        	cp "A"
 336  81A9 C0           	ret nz
 337  81AA DD 7E 09     	ld a,(ix+9)
 338  81AD FE 50        	cp "P"
 339  81AF C0           	ret nz
 340  81B0 DD 7E 0A     	ld a,(ix+10)
 341  81B3 FE 47        	cp "G"
 342  81B5 C0           	ret nz
 343  81B6 AF           	xor a ;равен
 344  81B7 C9           	ret
 345  81B8
 346  81B8
 347  81B8
 348  81B8              print_panel_r ;печать правой панели
 349  81B8              	;ld ix,buffer_cat
 350  81B8 FD 2A 74 87  	ld iy,(file_r_all) ;всего файлов
 351  81BC FD 7D        	ld a,iyl
 352  81BE FD B4        	or iyh
 353  81C0 C8           	ret z ;защита если 0
 354  81C1 11 29 01     	ld de,panel_r_xy ;координаты yx
 355  81C4 06 16        	ld b,panel_hight ;высота панели
 356  81C6 FD 2A 76 87  	ld iy,(file_r_cur_focus) ;номер файла первый видимый
 357  81CA              print_panel_r_cl ;цикл
 358  81CA C5           	push bc
 359  81CB D5           	push de ;xy
 360  81CC              	OS_SET_XY
 360  81CC 0E 01       >    ld c,#01
 360  81CE E7          >    rst #20
 361  81CF
 362  81CF              	;получить адрес элемента
 363  81CF FD E5        	push iy
 364  81D1 E1           	pop hl
 365  81D2 CD FF 80     	call calc_deskr
 366  81D5
 367  81D5 CD F0 81     	call print_file_info ;напечатать строку
 368  81D8              print_panel_r_skip
 369  81D8 D1           	pop de
 370  81D9 14           	inc d ;y++
 371  81DA FD 23        	inc iy ;текущий файл
 372  81DC              	;проверка на конец каталога
 373  81DC 2A 74 87     	ld hl,(file_r_all)
 374  81DF FD E5        	push iy
 375  81E1 C1           	pop bc
 376  81E2 A7           	and a
 377  81E3 ED 42        	sbc hl,bc
 378  81E5 C1           	pop bc
 379  81E6 38 07        	jr c,print_panel_r_ex2
 380  81E8 28 05        	jr z,print_panel_r_ex2
 381  81EA 10 DE        	djnz print_panel_r_cl
 382  81EC C9           	ret
 383  81ED              print_panel_r_ex
 384  81ED D1           	pop de
 385  81EE C1           	pop bc
 386  81EF              print_panel_r_ex2
 387  81EF              	;тут, возможно, надо допечатать пустые строки
 388  81EF C9           	ret
 389  81F0
 390  81F0
 391  81F0
 392  81F0
 393  81F0
 394  81F0              print_file_info ;печать строки о файле
 395  81F0 3A FF 83     	ld a,(LFN_enable_flag)
 396  81F3 B7           	or a
 397  81F4 28 4D        	jr z,print_file_info_SFN
 398  81F6
 399  81F6
 400  81F6
 401  81F6              print_file_info_LFN ;печать длинного имени
 402  81F6              	;узнать номер записи
 403  81F6 01 00 C0     	ld bc,#c000
 404  81F9 A7           	and a
 405  81FA ED 42        	sbc hl,bc
 406  81FC              ;разделить на 32
 407  81FC CB 3C        	srl h ; младший бит придёт на флаг C , на старший бит придёт 0
 408  81FE CB 1D        	rr l ; младший бит придёт на флаг C, на старший флаг C
 409  8200 CB 3C        	srl h ; /4
 410  8202 CB 1D        	rr l ;
 411  8204 CB 3C        	srl h ; /8
 412  8206 CB 1D        	rr l ;
 413  8208 CB 3C        	srl h ; /16
 414  820A CB 1D        	rr l ;
 415  820C CB 3C        	srl h ; /32
 416  820E CB 1D        	rr l ;
 417  8210
 418  8210
 419  8210 EB           	ex de,hl ;de - порядковый номер записи
 420  8211
 421  8211 21 8A 8E     	ld hl,file_info_string ;куда
 422  8214              	OS_GET_LFN ;получить длинное имя
 422  8214 0E 2A       >    ld c,#2a
 422  8216 E7          >    rst #20
 423  8217
 424  8217 CD 6B 82     	call get_color_item
 425  821A
 426  821A 06 0C        	ld b,#c
 427  821C              	OS_SET_COLOR
 427  821C 0E 06       >    ld c,#06
 427  821E E7          >    rst #20
 428  821F
 429  821F              	;печать не длиннее 80/2 символов
 430  821F 21 8A 8E     	ld hl,file_info_string
 431  8222 06 26        	ld b,80/2-2
 432  8224 0E 28        	ld c,40 ;колонка
 433  8226              print_file_info_LFN_cl
 434  8226 E5           	push hl
 435  8227 C5           	push bc
 436  8228 7E           	ld a,(hl)
 437  8229 B7           	or a
 438  822A 28 09        	jr z,print_file_info_LFN_cl_ex
 439  822C              	OS_PRINT_CHARF
 439  822C D7          >	rst #10
 440  822D C1           	pop bc
 441  822E 0C           	inc c
 442  822F E1           	pop hl
 443  8230 23           	inc hl
 444  8231 10 F3        	djnz print_file_info_LFN_cl
 445  8233 18 02        	jr print_file_info_LFN_ex
 446  8235              print_file_info_LFN_cl_ex
 447  8235 C1           	pop bc
 448  8236 E1           	pop hl
 449  8237              print_file_info_LFN_ex
 450  8237              	;допечатать пробелы до правого края, зависит от длины имени
 451  8237              print_file_info_LFN_cl2
 452  8237 79           	ld a,c
 453  8238 FE 4E        	cp 80-2
 454  823A D0           	ret nc
 455  823B C5           	push bc
 456  823C 3E 20        	ld a,' '
 457  823E              	OS_PRINT_CHARF
 457  823E D7          >	rst #10
 458  823F C1           	pop bc
 459  8240 0C           	inc c
 460  8241 18 F4        	jr print_file_info_LFN_cl2
 461  8243
 462  8243
 463  8243
 464  8243              print_file_info_SFN ;печать короткого имени
 465  8243 11 8A 8E     	ld de,file_info_string ;скопировать
 466  8246 01 08 00     	ld bc,8 ;file_info_lenght
 467  8249 ED B0        	ldir
 468  824B 3E 20        	ld a,' '
 469  824D 12           	ld (de),a
 470  824E 13           	inc de
 471  824F 01 03 00     	ld bc,3
 472  8252 ED B0        	ldir
 473  8254 AF           	xor a
 474  8255 12           	ld (de),a
 475  8256
 476  8256 CD 6B 82     	call get_color_item
 477  8259
 478  8259 06 0C        	ld b,#c
 479  825B              	OS_SET_COLOR
 479  825B 0E 06       >    ld c,#06
 479  825D E7          >    rst #20
 480  825E 21 8A 8E     	ld hl,file_info_string
 481  8261              	OS_PRINTZ
 481  8261 0E 09       >    ld c,#09
 481  8263 E7          >    rst #20
 482  8264              	;допечатать пробелы до правого края, длина имени постоянная
 483  8264 21 8E 89     	ld hl,file_info_string_SFN_end
 484  8267              	OS_PRINTZ
 484  8267 0E 09       >    ld c,#09
 484  8269 E7          >    rst #20
 485  826A C9           	ret
 486  826B
 487  826B
 488  826B
 489  826B              get_color_item ;получить цвет элемента
 490  826B              ;вх: IX - адрес в каталоге, IY - порядковый номер (0-511)
 491  826B              ;вых: A - цвет
 492  826B ED 4B 86 89  	ld bc,(file_r_num_cur) ;позиция курсора справа
 493  826F FD E5        	push iy
 494  8271 E1           	pop hl
 495  8272 A7           	and a
 496  8273 ED 42        	sbc hl,bc ;сравнить
 497  8275 28 11        	jr z,get_color_item_no_cursor
 498  8277              	;цвета курсора
 499  8277 3E 0E        	ld a,color_dir ;простая
 500  8279 32 A3 82     	ld (get_color_item_dir+1),a
 501  827C 3E 0C        	ld a,color_apg ;простая
 502  827E 32 AB 82     	ld (get_color_item_apg+1),a
 503  8281 3E 0F        	ld a,color_backgr ;простая
 504  8283 32 AE 82     	ld (get_color_item_backgr+1),a
 505  8286 18 0F        	jr get_color_item_set
 506  8288
 507  8288              get_color_item_no_cursor
 508  8288              	;цвета обычные
 509  8288 3E 28        	ld a,color_dir_hi ;под курсором
 510  828A 32 A3 82     	ld (get_color_item_dir+1),a
 511  828D 3E 28        	ld a,color_apg_hi ;под курсором
 512  828F 32 AB 82     	ld (get_color_item_apg+1),a
 513  8292 3E 28        	ld a,color_backgr_hi ;под курсором
 514  8294 32 AE 82     	ld (get_color_item_backgr+1),a
 515  8297
 516  8297              get_color_item_set
 517  8297              	;задать цвет
 518  8297 DD 7E 0B     	ld a,(ix+#0b)
 519  829A FE 10        	cp #10 ;признак каталога
 520  829C 28 04        	jr z,get_color_item_dir
 521  829E FE 30        	cp #30 ;признак каталога
 522  82A0 20 03        	jr nz,get_color_item_no_dir
 523  82A2              	;если папка
 524  82A2              get_color_item_dir
 525  82A2 3E 00        	ld a,0
 526  82A4 C9           	ret
 527  82A5
 528  82A5              get_color_item_no_dir
 529  82A5 CD A4 81     	call check_apg ;расширение apg
 530  82A8 20 03        	jr nz,get_color_item_no_apg
 531  82AA              	;если приложение
 532  82AA              get_color_item_apg
 533  82AA 3E 00        	ld a,0
 534  82AC C9           	ret
 535  82AD
 536  82AD              get_color_item_no_apg
 537  82AD              	;если обычный файл
 538  82AD              get_color_item_backgr
 539  82AD 3E 00        	ld a,0
 540  82AF C9           	ret
 541  82B0
 542  82B0
 543  82B0
 544  82B0              ; format_dir ;подготовить каталог, убрать лишнее
 545  82B0              	; ; ld a,2
 546  82B0              	; ; out (254),a
 547  82B0              	; ld iy,0 ;счётчик файлов
 548  82B0              	; ;найти конец каталога
 549  82B0              	; ld hl,buffer_cat
 550  82B0              	; ld a,(hl)
 551  82B0              	; or a
 552  82B0              	; ret z ;защита
 553  82B0              	; ld bc,32
 554  82B0              ; format_dir_prep_cl
 555  82B0              	; ld a,(hl)
 556  82B0              	; or a
 557  82B0              	; jr z,format_dir_prep_ex
 558  82B0              	; add hl,bc
 559  82B0              	; ld a,h
 560  82B0              	; or a ;если вышли за границу
 561  82B0              	; jr z,format_dir_prep_ex
 562  82B0              	; jr format_dir_prep_cl
 563  82B0              ; format_dir_prep_ex
 564  82B0              	; ld bc,32
 565  82B0              	; and a
 566  82B0              	; sbc hl,bc
 567  82B0              	; ld (format_dir_top),hl ;конец каталога
 568  82B0
 569  82B0
 570  82B0
 571  82B0              	; ld ix,buffer_cat
 572  82B0              	; ;ld b,panel_hight ;высота панели
 573  82B0              ; format_dir_cl ;цикл
 574  82B0              	; ld a,(ix)
 575  82B0              	; or a ;конец каталога
 576  82B0              	; jr z,format_dir_ex
 577  82B0              	; cp #e5 ;удалённый
 578  82B0              	; jr z,format_dir_skip
 579  82B0              	; cp #05 ;удалённый
 580  82B0              	; jr z,format_dir_skip
 581  82B0              	; ld a,(ix+#0b)
 582  82B0              	; cp #0f ;длинный
 583  82B0              	; jr z,format_dir_skip
 584  82B0
 585  82B0              	; ;проверка на папку "." (этот же каталог)
 586  82B0              	; ld a,(ix+#00)
 587  82B0              	; cp "." ;
 588  82B0              	; jr nz,format_dir_add
 589  82B0              	; ld a,(ix+#01)
 590  82B0              	; cp " " ;
 591  82B0              	; jr z,format_dir_skip
 592  82B0
 593  82B0
 594  82B0              ; format_dir_add
 595  82B0              	; inc iy ;++
 596  82B0              	; ld bc,32 ;на другой элемент каталога
 597  82B0              	; add ix,bc
 598  82B0              	; ld a,ixh
 599  82B0              	; or a ;если вышли за границу
 600  82B0              	; jr z,format_dir_ex
 601  82B0              	; jr format_dir_cl
 602  82B0              ; format_dir_skip
 603  82B0              	; ;сдвинуть элементы вниз
 604  82B0              	; push ix
 605  82B0              	; push ix
 606  82B0              	; pop hl
 607  82B0              	; pop de ;куда
 608  82B0              	; ld hl,(format_dir_top) ;0-32
 609  82B0              	; and a
 610  82B0              	; sbc hl,de
 611  82B0              	; ld b,h
 612  82B0              	; ld c,l ;длина
 613  82B0              	; push bc
 614  82B0
 615  82B0              	; push ix
 616  82B0              	; pop hl ;откуда
 617  82B0              	; ld bc,32 ;на другой элемент каталога
 618  82B0              	; add hl,bc ;откуда
 619  82B0
 620  82B0              	; pop bc
 621  82B0              	; ldir
 622  82B0
 623  82B0              	; xor a
 624  82B0              	; ld (de),a ;очистить ненужный элемент
 625  82B0
 626  82B0              	; jr format_dir_cl
 627  82B0
 628  82B0              ; format_dir_ex
 629  82B0              	; ld (file_r_all),iy
 630  82B0              	; ;здесь почистить остаток каталога
 631  82B0              	; ; ld a,0
 632  82B0              	; ; out (254),a
 633  82B0              	; ret
 634  82B0              ; format_dir_top	dw 0 ;временно конец гаталога
 635  82B0
 636  82B0
 637  82B0
 638  82B0
 639  82B0
 640  82B0              sort_dir ;сортировка каталога с помощью построения индекса
 641  82B0 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 642  82B4 DD 7E 00     	ld a,(ix)
 643  82B7 B7           	or a
 644  82B8 C8           	ret z ;если пусто, выход
 645  82B9 FD 21 00 00  	ld iy,0 ;счётчик
 646  82BD 21 8A 8A     	ld hl,cat_index ;таблица - индекс
 647  82C0
 648  82C0 3A E2 83     	ld a,(sort_enable_flag)
 649  82C3 B7           	or a
 650  82C4 CA E5 82     	jp z,sort_dir_no
 651  82C7
 652  82C7 AF           	xor a
 653  82C8 32 E4 82     	ld (sort_item),a ;образец для сравнения
 654  82CB              sort_dir_cl
 655  82CB CD 6D 83     	call sort_dir_one ;один проход по папкам
 656  82CE 3A E4 82     	ld a,(sort_item)
 657  82D1 3C           	inc a ;следующий образец
 658  82D2 32 E4 82     	ld (sort_item),a
 659  82D5 20 F4        	jr nz,sort_dir_cl
 660  82D7
 661  82D7              	; xor a
 662  82D7              	; ld (sort_item),a ;образец для сравнения
 663  82D7              sort_file_cl
 664  82D7 CD 25 83     	call sort_file_one ;один проход по файлам
 665  82DA 3A E4 82     	ld a,(sort_item)
 666  82DD 3C           	inc a ;следующий образец
 667  82DE 32 E4 82     	ld (sort_item),a
 668  82E1 20 F4        	jr nz,sort_file_cl
 669  82E3
 670  82E3 C9           	ret
 671  82E4
 672  82E4 00           sort_item db 0; текущий образец
 673  82E5
 674  82E5
 675  82E5
 676  82E5              ;без сортировки
 677  82E5              sort_dir_no
 678  82E5 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 679  82E9              sort_dir_no_cl ;цикл по каталогам
 680  82E9 DD 7E 00     	ld a,(ix)
 681  82EC B7           	or a ;конец каталога
 682  82ED 28 31        	jr z,sort_dir_no_ex
 683  82EF FE E5        	cp #e5 ;удалённый
 684  82F1 28 22        	jr z,sort_dir_no_skip
 685  82F3 FE 05        	cp #05 ;удалённый
 686  82F5 28 1E        	jr z,sort_dir_no_skip
 687  82F7 DD 7E 0B     	ld a,(ix+#0b)
 688  82FA FE 0F        	cp #0f ;длинный
 689  82FC 28 17        	jr z,sort_dir_no_skip
 690  82FE
 691  82FE              	;проверка на папку "." (этот же каталог)
 692  82FE DD 7E 00     	ld a,(ix+#00)
 693  8301 FE 2E        	cp "." ;
 694  8303 20 07        	jr nz,sort_dir_no_add
 695  8305 DD 7E 01     	ld a,(ix+#01)
 696  8308 FE 20        	cp " " ;
 697  830A 28 09        	jr z,sort_dir_no_skip
 698  830C
 699  830C              sort_dir_no_add
 700  830C FD 23        	inc iy ;++
 701  830E              	;записать в таблицу (индекс)
 702  830E DD E5        	push ix
 703  8310 C1           	pop bc
 704  8311 71           	ld (hl),c
 705  8312 23           	inc hl
 706  8313 70           	ld (hl),b
 707  8314 23           	inc hl
 708  8315
 709  8315
 710  8315              sort_dir_no_skip
 711  8315 01 20 00     	ld bc,32
 712  8318 DD 09        	add ix,bc ;на следующий
 713  831A DD 7C        	ld a,ixh ;проверка на конец буфера
 714  831C FE C0        	cp #c0
 715  831E 30 C9        	jr nc,sort_dir_no_cl
 716  8320
 717  8320              sort_dir_no_ex
 718  8320 FD 22 74 87  	ld (file_r_all),iy
 719  8324 C9           	ret
 720  8325
 721  8325
 722  8325              ;сортировка файлов
 723  8325              sort_file_one
 724  8325 DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 725  8329              sort_file_one_cl ;цикл по каталогам
 726  8329 DD 7E 00     	ld a,(ix)
 727  832C B7           	or a ;конец каталога
 728  832D 28 39        	jr z,sort_file_one_ex
 729  832F DD 7E 0B     	ld a,(ix+#0b)
 730  8332 FE 10        	cp #10 ;признак каталога
 731  8334 28 27        	jr z,sort_file_one_skip
 732  8336 FE 30        	cp #30 ;признак каталога
 733  8338 28 23        	jr z,sort_file_one_skip
 734  833A DD 7E 00     	ld a,(ix)
 735  833D FE E5        	cp #e5 ;удалённый
 736  833F 28 1C        	jr z,sort_file_one_skip
 737  8341 FE 05        	cp #05 ;удалённый
 738  8343 28 18        	jr z,sort_file_one_skip
 739  8345 DD 7E 0B     	ld a,(ix+#0b)
 740  8348 FE 0F        	cp #0f ;длинный
 741  834A 28 11        	jr z,sort_file_one_skip
 742  834C
 743  834C              	; ;проверка на папку "." (этот же каталог)
 744  834C              	; ld a,(ix+#00)
 745  834C              	; cp "." ;
 746  834C              	; jr nz,sort_file_one_add
 747  834C              	; ld a,(ix+#01)
 748  834C              	; cp " " ;
 749  834C              	; jr z,sort_file_one_skip
 750  834C
 751  834C
 752  834C              sort_file_one_add
 753  834C 3A E4 82     	ld a,(sort_item)
 754  834F DD BE 00     	cp (ix+#00) ;первая буква имени
 755  8352 20 09        	jr nz,sort_file_one_skip ;пока не подошла
 756  8354
 757  8354 FD 23        	inc iy ;++
 758  8356              	;записать в таблицу (индекс)
 759  8356 DD E5        	push ix
 760  8358 C1           	pop bc
 761  8359 71           	ld (hl),c
 762  835A 23           	inc hl
 763  835B 70           	ld (hl),b
 764  835C 23           	inc hl
 765  835D
 766  835D
 767  835D              sort_file_one_skip
 768  835D 01 20 00     	ld bc,32
 769  8360 DD 09        	add ix,bc ;на следующий
 770  8362 DD 7C        	ld a,ixh ;проверка на конец буфера
 771  8364 FE C0        	cp #c0
 772  8366 30 C1        	jr nc,sort_file_one_cl
 773  8368
 774  8368              sort_file_one_ex
 775  8368 FD 22 74 87  	ld (file_r_all),iy
 776  836C C9           	ret
 777  836D
 778  836D
 779  836D
 780  836D
 781  836D
 782  836D              ;сортировка папок
 783  836D              sort_dir_one
 784  836D DD 21 00 C0  	ld ix,buffer_cat	;каталог тут
 785  8371              sort_dir_one_cl ;цикл по каталогам
 786  8371 DD 7E 00     	ld a,(ix)
 787  8374 B7           	or a ;конец каталога
 788  8375 28 47        	jr z,sort_dir_one_ex
 789  8377 DD 7E 0B     	ld a,(ix+#0b)
 790  837A FE 10        	cp #10 ;признак каталога
 791  837C 28 04        	jr z,sort_dir_one_skip_no
 792  837E FE 30        	cp #30 ;признак каталога
 793  8380 20 31        	jr nz,sort_dir_one_skip
 794  8382              sort_dir_one_skip_no
 795  8382 DD 7E 00     	ld a,(ix)
 796  8385 FE E5        	cp #e5 ;удалённый
 797  8387 28 2A        	jr z,sort_dir_one_skip
 798  8389 FE 05        	cp #05 ;удалённый
 799  838B 28 26        	jr z,sort_dir_one_skip
 800  838D DD 7E 0B     	ld a,(ix+#0b)
 801  8390 FE 0F        	cp #0f ;длинный
 802  8392 28 1F        	jr z,sort_dir_one_skip
 803  8394
 804  8394              	;проверка на папку "." (этот же каталог)
 805  8394 DD 7E 00     	ld a,(ix+#00)
 806  8397 FE 2E        	cp "." ;
 807  8399 20 07        	jr nz,sort_dir_one_add
 808  839B DD 7E 01     	ld a,(ix+#01)
 809  839E FE 20        	cp " " ;
 810  83A0 28 11        	jr z,sort_dir_one_skip
 811  83A2
 812  83A2              sort_dir_one_add
 813  83A2 3A E4 82     	ld a,(sort_item)
 814  83A5 DD BE 00     	cp (ix+#00) ;первая буква имени
 815  83A8 20 09        	jr nz,sort_dir_one_skip ;пока не подошла
 816  83AA
 817  83AA FD 23        	inc iy ;++
 818  83AC              	;записать в таблицу (индекс)
 819  83AC DD E5        	push ix
 820  83AE C1           	pop bc
 821  83AF 71           	ld (hl),c
 822  83B0 23           	inc hl
 823  83B1 70           	ld (hl),b
 824  83B2 23           	inc hl
 825  83B3
 826  83B3
 827  83B3              sort_dir_one_skip
 828  83B3 01 20 00     	ld bc,32
 829  83B6 DD 09        	add ix,bc ;на следующий
 830  83B8 DD 7C        	ld a,ixh ;проверка на конец буфера
 831  83BA FE C0        	cp #c0
 832  83BC 30 B3        	jr nc,sort_dir_one_cl
 833  83BE
 834  83BE              sort_dir_one_ex
 835  83BE FD 22 74 87  	ld (file_r_all),iy
 836  83C2 C9           	ret
 837  83C3
 838  83C3
 839  83C3
 840  83C3
 841  83C3
 842  83C3
 843  83C3
 844  83C3              sort_toggle ;переключение сортировки
 845  83C3 3A E2 83     	ld a,(sort_enable_flag)
 846  83C6 EE 01        	xor 1
 847  83C8 32 E2 83     	ld (sort_enable_flag),a
 848  83CB 3E 4E        	ld a,"N" ;вкл
 849  83CD 20 02        	jr nz,sort_toggle1
 850  83CF 3E 66        	ld a,"f";выкл
 851  83D1              sort_toggle1
 852  83D1 32 32 8A     	ld (msg_menu_main2+6),a
 853  83D4
 854  83D4 CD B0 82     	call sort_dir
 855  83D7 CD 6A 84     	call print_menu_main
 856  83DA 3E 01        	ld a,1
 857  83DC 32 8D 89     	ld (print_panel_r_flag),a
 858  83DF
 859  83DF C3 56 80     	jp nc_wait
 860  83E2 00           sort_enable_flag db 0 ;флаг сортировки
 861  83E3
 862  83E3
 863  83E3
 864  83E3
 865  83E3              LFN_toggle ;переключение сортировки
 866  83E3 3A FF 83     	ld a,(LFN_enable_flag)
 867  83E6 EE 01        	xor 1
 868  83E8 32 FF 83     	ld (LFN_enable_flag),a
 869  83EB 3E 4E        	ld a,"N" ;вкл
 870  83ED 20 02        	jr nz,LFN_toggle1
 871  83EF 3E 66        	ld a,"f";выкл
 872  83F1              LFN_toggle1
 873  83F1 32 2A 8A     	ld (msg_menu_main1+6),a
 874  83F4
 875  83F4              	;call sort_dir
 876  83F4 CD 6A 84     	call print_menu_main
 877  83F7 3E 01        	ld a,1
 878  83F9 32 8D 89     	ld (print_panel_r_flag),a
 879  83FC
 880  83FC C3 56 80     	jp nc_wait
 881  83FF 00           LFN_enable_flag db 0 ;флаг сортировки
 882  8400
 883  8400
 884  8400
 885  8400
 886  8400
 887  8400              format_name ;подогнать имя под стандарт filename.ext
 888  8400              ;вх: HL - имя в каталоге
 889  8400 E5           	push hl
 890  8401 21 78 87     	ld hl,file_name_cur
 891  8404 11 79 87     	ld de,file_name_cur+1 ;почистить
 892  8407 01 FF 00     	ld bc,256-1
 893  840A 36 00        	ld (hl),0
 894  840C ED B0        	ldir
 895  840E
 896  840E E1           	pop hl
 897  840F E5           	push hl
 898  8410
 899  8410 11 78 87     	ld de,file_name_cur ;куда
 900  8413 01 FF 08     	ld bc,#08ff
 901  8416              format_name_cl
 902  8416 7E           	ld a,(hl)
 903  8417 FE 21        	cp " "+1
 904  8419 38 04        	jr c,format_name_skip
 905  841B ED A0        	ldi
 906  841D 10 F7        	djnz format_name_cl
 907  841F              format_name_skip
 908  841F 3E 2E        	ld a,"."
 909  8421 12           	ld (de),a
 910  8422
 911  8422 13           	inc de
 912  8423 E1           	pop hl
 913  8424 01 08 00     	ld bc,8 ;перейти на расширение
 914  8427 09           	add hl,bc
 915  8428
 916  8428 01 FF 03     	ld bc,#03ff
 917  842B              format_name_cl2
 918  842B 7E           	ld a,(hl)
 919  842C FE 21        	cp " "+1
 920  842E 38 04        	jr c,format_name_skip2
 921  8430 ED A0        	ldi
 922  8432 10 F7        	djnz format_name_cl2
 923  8434              format_name_skip2
 924  8434 C9           	ret
 925  8435
 926  8435              print_rect_r ;печать рамки правой
 927  8435 3E 0F        	ld a,color_backgr ;цвет
 928  8437 06 0C        	ld b,#c
 929  8439              	OS_SET_COLOR
 929  8439 0E 06       >    ld c,#06
 929  843B E7          >    rst #20
 930  843C 11 28 00     	ld de,#0028 ;xy
 931  843F              	OS_SET_XY
 931  843F 0E 01       >    ld c,#01
 931  8441 E7          >    rst #20
 932  8442 21 A9 89     	ld hl,rect_1
 933  8445              	OS_PRINTZ
 933  8445 0E 09       >    ld c,#09
 933  8447 E7          >    rst #20
 934  8448
 935  8448 11 28 01     	ld de,#0128 ;xy
 936  844B 06 16        	ld b,24-2 ;цикл
 937  844D              print_rect_r_cl
 938  844D C5           	push bc
 939  844E D5           	push de
 940  844F              	OS_SET_XY
 940  844F 0E 01       >    ld c,#01
 940  8451 E7          >    rst #20
 941  8452 21 D2 89     	ld hl,rect_2
 942  8455              	OS_PRINTZ
 942  8455 0E 09       >    ld c,#09
 942  8457 E7          >    rst #20
 943  8458 D1           	pop de
 944  8459 14           	inc d
 945  845A C1           	pop bc
 946  845B 10 F0        	djnz print_rect_r_cl
 947  845D
 948  845D
 949  845D 11 28 17     	ld de,#1728 ;xy
 950  8460              	OS_SET_XY
 950  8460 0E 01       >    ld c,#01
 950  8462 E7          >    rst #20
 951  8463 21 FB 89     	ld hl,rect_3
 952  8466              	OS_PRINTZ
 952  8466 0E 09       >    ld c,#09
 952  8468 E7          >    rst #20
 953  8469 C9           	ret
 954  846A
 955  846A              print_menu_main ;печать основного меню
 956  846A 3E 28        	ld a,color_backgr_hi ;цвет
 957  846C 06 0C        	ld b,#c
 958  846E              	OS_SET_COLOR
 958  846E 0E 06       >    ld c,#06
 958  8470 E7          >    rst #20
 959  8471
 960  8471 11 00 18     	ld de,#1800+0*8
 961  8474              	OS_SET_XY
 961  8474 0E 01       >    ld c,#01
 961  8476 E7          >    rst #20
 962  8477 21 24 8A     	ld hl,msg_menu_main1
 963  847A              	OS_PRINTZ
 963  847A 0E 09       >    ld c,#09
 963  847C E7          >    rst #20
 964  847D 11 08 18     	ld de,#1800+1*8
 965  8480              	OS_SET_XY
 965  8480 0E 01       >    ld c,#01
 965  8482 E7          >    rst #20
 966  8483 21 2C 8A     	ld hl,msg_menu_main2
 967  8486              	OS_PRINTZ
 967  8486 0E 09       >    ld c,#09
 967  8488 E7          >    rst #20
 968  8489 11 10 18     	ld de,#1800+2*8
 969  848C              	OS_SET_XY
 969  848C 0E 01       >    ld c,#01
 969  848E E7          >    rst #20
 970  848F 21 34 8A     	ld hl,msg_menu_main3
 971  8492              	OS_PRINTZ
 971  8492 0E 09       >    ld c,#09
 971  8494 E7          >    rst #20
 972  8495 C9           	ret
 973  8496
 974  8496
 975  8496              	include nc_view.asm ;просмотрщик
# file opened: nc_view.asm
   1+ 8496              view_file
   2+ 8496              	;просмотр файла как текста
   3+ 8496
   4+ 8496 2A 74 87     	ld hl,(file_r_all)
   5+ 8499 7D           	ld a,l
   6+ 849A B4           	or h
   7+ 849B CA 68 85     	jp z,view_file_ex ;защита
   8+ 849E 2A 86 89     	ld hl,(file_r_num_cur)
   9+ 84A1 CD FF 80     	call calc_deskr
  10+ 84A4 DD 7E 0B     	ld a,(ix+#0b)
  11+ 84A7 FE 10        	cp #10 ;признак каталога
  12+ 84A9 CA 68 85     	jp z,view_file_ex
  13+ 84AC
  14+ 84AC CD 00 84     	call format_name ;обработать имя файла
  15+ 84AF
  16+ 84AF
  17+ 84AF
  18+ 84AF              	OS_CLS ;почистить экран
  18+ 84AF 0E 00       >    ld c,#00
  18+ 84B1 E7          >    rst #20
  19+ 84B2
  20+ 84B2              	;обнулить переменные
  21+ 84B2 AF           	xor a
  22+ 84B3 32 71 87     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  23+ 84B6              	;ld (view_file_bot_flag),a  ;
  24+ 84B6 21 FF FF     	ld hl,#ffff
  25+ 84B9 22 72 87     	ld (view_file_end),hl ;конец файла тут
  26+ 84BC 23           	inc hl
  27+ 84BD 22 69 87     	ld (view_move_right_val),hl
  28+ 84C0
  29+ 84C0 C5           	push bc
  30+ 84C1 CD A8 80     	call clear_buf
  31+ 84C4 C1           	pop bc
  32+ 84C5
  33+ 84C5 21 78 87     	ld hl,file_name_cur		;строка с именем
  34+ 84C8              	OS_FILE_OPEN
  34+ 84C8 0E 21       >    ld c,#21
  34+ 84CA E7          >    rst #20
  35+ 84CB 30 0E        	jr nc,view_file_open_ok
  36+ 84CD              view_file_file_error
  37+ 84CD 21 3B 8A     	ld hl,msg_file_error
  38+ 84D0              	OS_PRINTZ
  38+ 84D0 0E 09       >    ld c,#09
  38+ 84D2 E7          >    rst #20
  39+ 84D3 06 64        	ld b,2*50
  40+ 84D5 CD A4 80     	call delay1
  41+ 84D8 C3 62 85     	jp view_file_wait_ex
  42+ 84DB
  43+ 84DB              view_file_open_ok
  44+ 84DB 32 89 89     	ld (file_id_cur_r),a
  45+ 84DE              	;проверка длины файла не больше #4000
  46+ 84DE 7A           	ld	a,d ;самые старшие байты длины
  47+ 84DF B3           	or e
  48+ 84E0 28 11        	jr z,view_file_size_ok ;если не слищком большой
  49+ 84E2              view_file_too_big
  50+ 84E2              	;файл больше буфера
  51+ 84E2 11 00 40     	ld de,#4000 ;размер одной первой части
  52+ 84E5 21 00 C0     	ld hl,buffer_cat
  53+ 84E8 3A 89 89     	ld a,(file_id_cur_r)
  54+ 84EB              	OS_FILE_READ ;загрузить
  54+ 84EB 0E 23       >    ld c,#23
  54+ 84ED E7          >    rst #20
  55+ 84EE 38 DD        	jr c,view_file_file_error
  56+ 84F0
  57+ 84F0 C3 1C 85     	jp view_file_readed
  58+ 84F3
  59+ 84F3              view_file_size_ok
  60+ 84F3 78           	ld	a,b ;младший старший байт длины
  61+ 84F4 FE 40        	cp #40
  62+ 84F6 38 06        	jr c,view_file_size_ok_small
  63+ 84F8 20 E8        	jr nz,view_file_too_big
  64+ 84FA 0C           	inc c
  65+ 84FB 0D           	dec c
  66+ 84FC 20 E4        	jr nz,view_file_too_big
  67+ 84FE
  68+ 84FE
  69+ 84FE              view_file_size_ok_small
  70+ 84FE              	;проверка на 0
  71+ 84FE 78           	ld a,b
  72+ 84FF B1           	or c
  73+ 8500 CA CD 84     	jp z,view_file_file_error
  74+ 8503              	;узнать где конец файла
  75+ 8503 21 00 C0     	ld hl,buffer_cat
  76+ 8506 09           	add hl,bc
  77+ 8507 22 72 87     	ld (view_file_end),hl ;конец файла тут
  78+ 850A              	;размер не большой, прочитаем
  79+ 850A 50           	ld d,b ;размер
  80+ 850B 59           	ld e,c
  81+ 850C 21 00 C0     	ld hl,buffer_cat
  82+ 850F 3A 89 89     	ld a,(file_id_cur_r)
  83+ 8512              	OS_FILE_READ ;загрузить
  83+ 8512 0E 23       >    ld c,#23
  83+ 8514 E7          >    rst #20
  84+ 8515 38 B6        	jr c,view_file_file_error
  85+ 8517
  86+ 8517 3E 01        	ld a,1
  87+ 8519 32 71 87     	ld (view_file_load_all),a ;флаг что файл весь прочитан
  88+ 851C
  89+ 851C              view_file_readed
  90+ 851C              	;файл прочитан
  91+ 851C
  92+ 851C 21 00 C0     	ld hl,buffer_cat
  93+ 851F 22 6B 87     	ld (view_file_pos_cur),hl ;позиция просмотра на начало
  94+ 8522 22 6D 87     	ld (view_file_pos_cur_focus),hl ;позиция фокуса
  95+ 8525
  96+ 8525 CD 27 86     	call print_file_text
  97+ 8528
  98+ 8528
  99+ 8528 CD F2 85     	call print_menu_view ;меню
 100+ 852B CD 0D 86     	call print_menu_view_top ;инфо
 101+ 852E
 102+ 852E CD B6 80     	call release_key
 103+ 8531
 104+ 8531              view_file_wait ;цикл ожидания клавиши
 105+ 8531              	OS_WAIT
 105+ 8531 DF          >	rst #18
 106+ 8532              	OS_GET_CHAR
 106+ 8532 0E 10       >    ld c,#10
 106+ 8534 E7          >    rst #20
 107+ 8535 FE FF        	cp 255
 108+ 8537 28 F8        	jr z,view_file_wait
 109+ 8539 FE 33        	cp "3"
 110+ 853B 28 25        	jr z,view_file_wait_ex
 111+ 853D FE 0A        	cp 10 ;вниз
 112+ 853F CA 6B 85     	jp z,view_line_down
 113+ 8542 FE 0B        	cp 11 ;вверх
 114+ 8544 CA 81 85     	jp z,view_line_up
 115+ 8547 FE 09        	cp 09 ;вправо
 116+ 8549 CA 97 85     	jp z,view_right
 117+ 854C FE 08        	cp 08 ;влево
 118+ 854E CA A7 85     	jp z,view_left
 119+ 8551 FE 04        	cp 04 ;страница вверх
 120+ 8553 CA B8 85     	jp z,view_page_up
 121+ 8556 FE 05        	cp 05 ;страница вниз
 122+ 8558 CA D5 85     	jp z,view_page_down
 123+ 855B FE 18        	cp 24 ;break
 124+ 855D CA A0 81     	jp z,exit
 125+ 8560 18 CF        	jr view_file_wait
 126+ 8562
 127+ 8562              view_file_wait_ex
 128+ 8562              	;почистить экран
 129+ 8562              	OS_CLS
 129+ 8562 0E 00       >    ld c,#00
 129+ 8564 E7          >    rst #20
 130+ 8565 C3 23 80     	jp start_nc_warm ;перезагрузить папку
 131+ 8568
 132+ 8568              view_file_ex
 133+ 8568 C3 56 80     	jp nc_wait
 134+ 856B
 135+ 856B
 136+ 856B
 137+ 856B              view_line_down ;вниз на строчку
 138+ 856B 2A 6D 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 139+ 856E 22 6B 87     	ld (view_file_pos_cur),hl
 140+ 8571 CD 3C 87     	call next_line ;вперёд на строку
 141+ 8574 38 BB        	jr c,view_file_wait ;если не удачно
 142+ 8576 2A 6B 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 143+ 8579 22 6D 87     	ld (view_file_pos_cur_focus),hl
 144+ 857C CD 27 86     	call print_file_text ;напечатать всю страницу
 145+ 857F 18 B0        	jr view_file_wait
 146+ 8581
 147+ 8581              view_line_up ;вверх на строчку
 148+ 8581 2A 6D 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 149+ 8584 22 6B 87     	ld (view_file_pos_cur),hl
 150+ 8587 CD 4A 87     	call prev_line ;
 151+ 858A 38 A5        	jr c,view_file_wait ;если не удачно
 152+ 858C 2A 6B 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 153+ 858F 22 6D 87     	ld (view_file_pos_cur_focus),hl
 154+ 8592 CD 27 86     	call print_file_text ;напечатать всю страницу
 155+ 8595 18 9A        	jr view_file_wait
 156+ 8597
 157+ 8597
 158+ 8597              view_right ;вправо
 159+ 8597 2A 69 87     	ld hl,(view_move_right_val)
 160+ 859A 23           	inc hl
 161+ 859B 7C           	ld a,h
 162+ 859C B5           	or l
 163+ 859D 28 92        	jr z,view_file_wait
 164+ 859F 22 69 87     	ld (view_move_right_val),hl
 165+ 85A2 CD 27 86     	call print_file_text ;напечатать всю страницу
 166+ 85A5 18 8A        	jr view_file_wait
 167+ 85A7
 168+ 85A7              view_left ;влево
 169+ 85A7 2A 69 87     	ld hl,(view_move_right_val)
 170+ 85AA 7C           	ld a,h
 171+ 85AB B5           	or l
 172+ 85AC 28 83        	jr z,view_file_wait
 173+ 85AE 2B           	dec hl
 174+ 85AF 22 69 87     	ld (view_move_right_val),hl
 175+ 85B2 CD 27 86     	call print_file_text ;напечатать всю страницу
 176+ 85B5 C3 31 85     	jp view_file_wait
 177+ 85B8
 178+ 85B8
 179+ 85B8
 180+ 85B8              view_page_up ;на страницу назад
 181+ 85B8 2A 6D 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 182+ 85BB 22 6B 87     	ld (view_file_pos_cur),hl
 183+ 85BE 06 16        	ld b,view_text_bot-2
 184+ 85C0              view_page_up_cl
 185+ 85C0 CD 4A 87     	call prev_line ;
 186+ 85C3 38 04        	jr c,view_page_up_ex ;если не удачно
 187+ 85C5 28 02        	jr z,view_page_up_ex
 188+ 85C7 10 F7        	djnz view_page_up_cl
 189+ 85C9              view_page_up_ex
 190+ 85C9 2A 6B 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 191+ 85CC 22 6D 87     	ld (view_file_pos_cur_focus),hl
 192+ 85CF CD 27 86     	call print_file_text ;напечатать всю страницу
 193+ 85D2 C3 31 85     	jp view_file_wait
 194+ 85D5
 195+ 85D5
 196+ 85D5
 197+ 85D5              view_page_down ;на страницу вперёд
 198+ 85D5 2A 6D 87     	ld hl,(view_file_pos_cur_focus) ;фокус
 199+ 85D8 22 6B 87     	ld (view_file_pos_cur),hl
 200+ 85DB 06 16        	ld b,view_text_bot-2
 201+ 85DD              view_page_down_cl
 202+ 85DD CD 3C 87     	call next_line ;
 203+ 85E0 38 04        	jr c,view_page_down_ex ;если не удачно
 204+ 85E2 28 02        	jr z,view_page_down_ex
 205+ 85E4 10 F7        	djnz view_page_down_cl
 206+ 85E6              view_page_down_ex
 207+ 85E6 2A 6B 87     	ld hl,(view_file_pos_cur) ;запомнить фокус
 208+ 85E9 22 6D 87     	ld (view_file_pos_cur_focus),hl
 209+ 85EC CD 27 86     	call print_file_text ;напечатать всю страницу
 210+ 85EF C3 31 85     	jp view_file_wait
 211+ 85F2
 212+ 85F2
 213+ 85F2
 214+ 85F2              print_menu_view ;печать меню просмотрщика
 215+ 85F2 3E 18        	ld a,#18
 216+ 85F4 06 28        	ld b,color_backgr_hi ;цвет
 217+ 85F6              	OS_PAINT_LINE ;линия внизу
 217+ 85F6 0E 04       >    ld c,#04
 217+ 85F8 E7          >    rst #20
 218+ 85F9 3E 28        	ld a,color_backgr_hi ;цвет
 219+ 85FB 06 0C        	ld b,#c
 220+ 85FD              	OS_SET_COLOR
 220+ 85FD 0E 06       >    ld c,#06
 220+ 85FF E7          >    rst #20
 221+ 8600 11 10 18     	ld de,#1800+2*8
 222+ 8603              	OS_SET_XY
 222+ 8603 0E 01       >    ld c,#01
 222+ 8605 E7          >    rst #20
 223+ 8606 21 62 87     	ld hl,msg_menu_view
 224+ 8609              	OS_PRINTZ
 224+ 8609 0E 09       >    ld c,#09
 224+ 860B E7          >    rst #20
 225+ 860C C9           	ret
 226+ 860D
 227+ 860D              print_menu_view_top ;печать меню просмотрщика верхнее
 228+ 860D AF           	xor a
 229+ 860E 06 28        	ld b,color_backgr_hi ;цвет
 230+ 8610              	OS_PAINT_LINE ;линия вверху
 230+ 8610 0E 04       >    ld c,#04
 230+ 8612 E7          >    rst #20
 231+ 8613 3E 28        	ld a,color_backgr_hi ;цвет
 232+ 8615 06 0C        	ld b,#c
 233+ 8617              	OS_SET_COLOR
 233+ 8617 0E 06       >    ld c,#06
 233+ 8619 E7          >    rst #20
 234+ 861A 11 24 00     	ld de,#0024
 235+ 861D              	OS_SET_XY
 235+ 861D 0E 01       >    ld c,#01
 235+ 861F E7          >    rst #20
 236+ 8620 21 78 87     	ld hl,file_name_cur
 237+ 8623              	OS_PRINTZ
 237+ 8623 0E 09       >    ld c,#09
 237+ 8625 E7          >    rst #20
 238+ 8626 C9           	ret
 239+ 8627
 240+ 8627
 241+ 8627
 242+ 8627              print_file_text	;печать текущей части файла в консоль
 243+ 8627 3E 04        	ld a,4 ;цвет
 244+ 8629 06 0C        	ld b,#c
 245+ 862B              	OS_SET_COLOR
 245+ 862B 0E 06       >    ld c,#06
 245+ 862D E7          >    rst #20
 246+ 862E
 247+ 862E 3E 01        	ld a,view_text_top ;первая строка
 248+ 8630 32 6F 87     	ld (view_file_y_cur),a
 249+ 8633 2A 6D 87     	ld hl,(view_file_pos_cur_focus) ;печать видимой части
 250+ 8636 22 6B 87     	ld (view_file_pos_cur),hl
 251+ 8639              print_file_text_cl
 252+ 8639 2A 6B 87     	ld hl,(view_file_pos_cur)
 253+ 863C CD 62 86     	call print_line_text
 254+ 863F 38 0C        	jr c,print_file_text_ex
 255+ 8641
 256+ 8641              	; call next_line ;найти следующую строку
 257+ 8641              	; ret c
 258+ 8641
 259+ 8641 3A 6F 87     	ld a,(view_file_y_cur)
 260+ 8644 3C           	inc a
 261+ 8645 32 6F 87     	ld (view_file_y_cur),a
 262+ 8648 FE 18        	cp view_text_bot
 263+ 864A 38 ED        	jr c,print_file_text_cl
 264+ 864C C9           	ret
 265+ 864D
 266+ 864D              print_file_text_ex
 267+ 864D              	;тут очистить остальные строки
 268+ 864D 3A 6F 87     	ld a,(view_file_y_cur)
 269+ 8650 FE 18        	cp view_text_bot
 270+ 8652 30 0C        	jr nc,print_file_text_ex2
 271+ 8654 67           	ld h,a
 272+ 8655 3C           	inc a
 273+ 8656 32 6F 87     	ld (view_file_y_cur),a
 274+ 8659 3E 20        	ld a," "
 275+ 865B              	OS_FILL_LINE ;очистить строку
 275+ 865B 0E 03       >    ld c,#03
 275+ 865D E7          >    rst #20
 276+ 865E 18 ED        	jr print_file_text_ex
 277+ 8660              print_file_text_ex2
 278+ 8660 37           	scf
 279+ 8661 C9           	ret
 280+ 8662
 281+ 8662
 282+ 8662
 283+ 8662              print_line_text ;печать одной строки до кода 13, или до правого края экрана, или до конца файла
 284+ 8662              ;вх: hl - адрес строки
 285+ 8662 CD A6 86     	call view_move_right ;промотать направо. если надо
 286+ 8665              	;установить позицию
 287+ 8665 3A 6F 87     	ld a,(view_file_y_cur)
 288+ 8668 57           	ld d,a
 289+ 8669 AF           	xor a
 290+ 866A 32 70 87     	ld (view_file_x_cur),a
 291+ 866D 5F           	ld e,a
 292+ 866E              	OS_SET_XY 	;yx
 292+ 866E 0E 01       >    ld c,#01
 292+ 8670 E7          >    rst #20
 293+ 8671              print_line_text_cl ;цикл
 294+ 8671
 295+ 8671 7E           	ld a,(hl)
 296+ 8672 FE 0A        	cp 10 ;этот код не печатаем
 297+ 8674 28 14        	jr z,print_line_text_skip
 298+ 8676 FE FF        	cp #ff ;этот код не печатаем
 299+ 8678 28 10        	jr z,print_line_text_skip
 300+ 867A FE 0D        	cp 13
 301+ 867C 28 12        	jr z,print_line_text_ex_ok
 302+ 867E              	OS_PRINT_CHARF ;печать
 302+ 867E D7          >	rst #10
 303+ 867F
 304+ 867F              	;на следующую позицию
 305+ 867F 3A 70 87     	ld a,(view_file_x_cur)
 306+ 8682 3C           	inc a
 307+ 8683 FE 50        	cp 80 ;правый край экрана
 308+ 8685 32 70 87     	ld (view_file_x_cur),a
 309+ 8688 30 18        	jr nc,print_line_text_right ;дошли до правого края
 310+ 868A
 311+ 868A              print_line_text_skip
 312+ 868A CD DE 86     	call view_file_next_pos ;следующий
 313+ 868D 30 E2        	jr nc,print_line_text_cl ;на следующий символ
 314+ 868F C9           	ret
 315+ 8690
 316+ 8690
 317+ 8690              print_line_text_ex_ok ;выход норма
 318+ 8690              	;тут надо добить строку пробелами
 319+ 8690 3E 20        	ld a," "
 320+ 8692              	OS_PRINT_CHARF ;печать
 320+ 8692 D7          >	rst #10
 321+ 8693 3A 70 87     	ld a,(view_file_x_cur)
 322+ 8696 3C           	inc a
 323+ 8697 FE 50        	cp 80 ;правый край экрана
 324+ 8699 32 70 87     	ld (view_file_x_cur),a
 325+ 869C 38 F2        	jr c,print_line_text_ex_ok
 326+ 869E
 327+ 869E
 328+ 869E CD DE 86     	call view_file_next_pos ;следующий
 329+ 86A1
 330+ 86A1 C9           	ret
 331+ 86A2              ; print_line_text_ex_end ;выход если кончился файл
 332+ 86A2              	; scf
 333+ 86A2              	; ret
 334+ 86A2
 335+ 86A2              print_line_text_right
 336+ 86A2 CD 3C 87     	call next_line ;позицию  до конца строки
 337+ 86A5 C9           	ret
 338+ 86A6
 339+ 86A6
 340+ 86A6
 341+ 86A6              view_move_right ;перемотка строки направо
 342+ 86A6 ED 4B 69 87  	ld bc,(view_move_right_val) ;на сколько символов вправо промотать
 343+ 86AA 78           	ld a,b
 344+ 86AB B1           	or c
 345+ 86AC C8           	ret z
 346+ 86AD 2A 6B 87     	ld hl,(view_file_pos_cur)
 347+ 86B0              view_move_right1
 348+ 86B0 7E           	ld a,(hl)
 349+ 86B1 FE 0A        	cp 10 ;этот код пропускаем
 350+ 86B3 20 07        	jr nz,view_move_right2
 351+ 86B5 CD DE 86     	call view_file_next_pos
 352+ 86B8 D8           	ret c
 353+ 86B9 C8           	ret z
 354+ 86BA 18 F4        	jr view_move_right1
 355+ 86BC              view_move_right2
 356+ 86BC FE FF        	cp #ff ;этот код пропускаем
 357+ 86BE 20 07        	jr nz,view_move_right3
 358+ 86C0 CD DE 86     	call view_file_next_pos
 359+ 86C3 D8           	ret c
 360+ 86C4 C8           	ret z
 361+ 86C5 18 E9        	jr view_move_right1
 362+ 86C7              view_move_right3
 363+ 86C7 7E           	ld a,(hl)
 364+ 86C8 FE 0D        	cp 13 ;
 365+ 86CA C8           	ret z
 366+ 86CB              view_move_right_cl
 367+ 86CB CD DE 86     	call view_file_next_pos
 368+ 86CE D8           	ret c
 369+ 86CF C8           	ret z
 370+ 86D0 7E           	ld a,(hl)
 371+ 86D1 FE 0D        	cp 13
 372+ 86D3 C8           	ret z
 373+ 86D4 FE 0A        	cp 10 ;этот код пропускаем
 374+ 86D6 28 F3        	jr z,view_move_right_cl
 375+ 86D8 0B           	dec bc
 376+ 86D9 78           	ld a,b
 377+ 86DA B1           	or c
 378+ 86DB 20 EE        	jr nz,view_move_right_cl
 379+ 86DD              	;call view_file_next_pos ;следующий
 380+ 86DD C9           	ret
 381+ 86DE
 382+ 86DE
 383+ 86DE
 384+ 86DE              ;получение следующей позиции
 385+ 86DE              view_file_next_pos
 386+ 86DE 3A 71 87     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 387+ 86E1 B7           	or a
 388+ 86E2 28 14        	jr z,view_file_next_pos_big
 389+ 86E4              	;если текст не большой
 390+ 86E4 2A 72 87     	ld hl,(view_file_end) ;конец текста известен
 391+ 86E7 ED 5B 6B 87  	ld de,(view_file_pos_cur)
 392+ 86EB 13           	inc de ;вперёд
 393+ 86EC A7           	and a
 394+ 86ED ED 52        	sbc hl,de
 395+ 86EF 38 15        	jr c,view_file_next_pos_end
 396+ 86F1 ED 53 6B 87  	ld (view_file_pos_cur),de
 397+ 86F5 EB           	ex de,hl ;на выходе адрес в HL
 398+ 86F6 B7           	or a
 399+ 86F7 C9           	ret
 400+ 86F8
 401+ 86F8
 402+ 86F8
 403+ 86F8              view_file_next_pos_big
 404+ 86F8              	;если текст большой
 405+ 86F8 2A 6B 87     	ld hl,(view_file_pos_cur)	;текущая позиция
 406+ 86FB 23           	inc hl ;вперёд
 407+ 86FC 7C           	ld a,h
 408+ 86FD FE C0        	cp #c0 ;если вышли за пределы окна
 409+ 86FF 38 05        	jr c,view_file_next_pos_end
 410+ 8701 22 6B 87     	ld (view_file_pos_cur),hl
 411+ 8704 B7           	or a
 412+ 8705 C9           	ret
 413+ 8706
 414+ 8706              view_file_next_pos_end
 415+ 8706              	;не смогли шагнуть вперёд
 416+ 8706              	; ld a,1 ;флаг что внизу
 417+ 8706              	; ld (view_file_bot_flag),a
 418+ 8706 37           	scf ;ошибка
 419+ 8707 C9           	ret
 420+ 8708
 421+ 8708
 422+ 8708
 423+ 8708
 424+ 8708
 425+ 8708
 426+ 8708              ;получение предыдущей позиции
 427+ 8708              view_file_prev_pos
 428+ 8708 3A 71 87     	ld a,(view_file_load_all) ;флаг что файл весь в памяти
 429+ 870B B7           	or a
 430+ 870C 28 1E        	jr z,view_file_prev_pos_big
 431+ 870E              	;если текст не большой
 432+ 870E 21 00 C0     	ld hl,buffer_cat ;тут лежит текст
 433+ 8711 ED 5B 6B 87  	ld de,(view_file_pos_cur) ;текущая позиция
 434+ 8715 1B           	dec de ;назад
 435+ 8716 A7           	and a
 436+ 8717 ED 52        	sbc hl,de
 437+ 8719 28 0A        	jr z,view_file_prev_pos_top ;если пришли в начало
 438+ 871B 30 1D        	jr nc,view_file_prev_pos_end
 439+ 871D              	;можно шагнуть назад
 440+ 871D ED 53 6B 87  	ld (view_file_pos_cur),de
 441+ 8721 EB           	ex de,hl ;на выходе адрес в HL
 442+ 8722 AF           	xor a
 443+ 8723 3C           	inc a ;a=1
 444+ 8724 C9           	ret
 445+ 8725              view_file_prev_pos_top
 446+ 8725              	;если в начале
 447+ 8725 ED 53 6B 87  	ld (view_file_pos_cur),de
 448+ 8729 EB           	ex de,hl ;на выходе адрес в HL
 449+ 872A AF           	xor a ;a=0
 450+ 872B C9           	ret
 451+ 872C
 452+ 872C
 453+ 872C              view_file_prev_pos_big
 454+ 872C              	;если текст большой
 455+ 872C 2A 6B 87     	ld hl,(view_file_pos_cur)	;текущая позиция
 456+ 872F 2B           	dec hl ;назад
 457+ 8730 7C           	ld a,h
 458+ 8731 FE C0        	cp #c0 ;если вышли за пределы окна
 459+ 8733 38 05        	jr c,view_file_prev_pos_end
 460+ 8735 22 6B 87     	ld (view_file_pos_cur),hl
 461+ 8738 B7           	or a
 462+ 8739 C9           	ret
 463+ 873A
 464+ 873A              view_file_prev_pos_end
 465+ 873A              	;не смогли шагнуть назад
 466+ 873A              	; ld hl,buffer_cat ;тут лежит текст
 467+ 873A              	; ld (view_file_pos_cur),hl ;текущая позиция в самом начале
 468+ 873A 37           	scf ;ошибка
 469+ 873B C9           	ret
 470+ 873C
 471+ 873C
 472+ 873C
 473+ 873C
 474+ 873C              next_line ;поиск следующей строки
 475+ 873C CD DE 86     	call view_file_next_pos
 476+ 873F D8           	ret c
 477+ 8740 C8           	ret z
 478+ 8741 7E           	ld a,(hl)
 479+ 8742 FE 0D        	cp 13
 480+ 8744 20 F6        	jr nz,next_line
 481+ 8746 CD DE 86     	call view_file_next_pos ;ещё на символ
 482+ 8749 C9           	ret
 483+ 874A
 484+ 874A
 485+ 874A
 486+ 874A              prev_line ;поиск предыдущей строки
 487+ 874A              	;сначала в конец предыдущей
 488+ 874A CD 08 87     	call view_file_prev_pos
 489+ 874D C8           	ret z
 490+ 874E D8           	ret c
 491+ 874F 7E           	ld a,(hl)
 492+ 8750 FE 0D        	cp 13
 493+ 8752 20 F6        	jr nz,prev_line
 494+ 8754              	;теперь в начало предыдущей
 495+ 8754              prev_line1
 496+ 8754 CD 08 87     	call view_file_prev_pos
 497+ 8757 C8           	ret z
 498+ 8758 D8           	ret c
 499+ 8759 7E           	ld a,(hl)
 500+ 875A FE 0D        	cp 13
 501+ 875C 20 F6        	jr nz,prev_line1
 502+ 875E CD DE 86     	call view_file_next_pos ;ещё на символ обратно
 503+ 8761 C9           	ret
 504+ 8762
 505+ 8762
 506+ 8762
 507+ 8762              view_text_bot equ 24 ;последняя строка для печати
 508+ 8762              view_text_top equ 1 ;первая строка
 509+ 8762              view_text_lines equ 25-2 ;видимых строк на экране
 510+ 8762
 511+ 8762              msg_menu_view
 512+ 8762 33 20 45 78  	db "3 Exit",0
 512+ 8766 69 74 00
 513+ 8769
 514+ 8769              ;view_file_position ds 4 ;текущая позиция в файле
 515+ 8769              ;view_file_bot_flag db 0 ;флаг что домотали вниз до конца
 516+ 8769 00 00        view_move_right_val dw 0 ;сдвиг вправо
 517+ 876B 00 00        view_file_pos_cur dw 0;текущая позиция
 518+ 876D 00 00        view_file_pos_cur_focus dw 0 ;позиция фокуса
 519+ 876F 00           view_file_y_cur db 0;текущая строка
 520+ 8770 00           view_file_x_cur db 0;текущий столбец
 521+ 8771 00           view_file_load_all db 0 ;флаг что файл весь загружен
 522+ 8772 00 00        view_file_end dw 0 ;конец файлв, или текущего куска
 523+ 8774
 524+ 8774
# file closed: nc_view.asm
 976  8774
 977  8774
 978  8774              color_backgr equ 1*8+7 ;цвет фона
 979  8774              color_apg equ 1*8+4 ;цвет приложений
 980  8774              color_dir equ 1*8+6 ;цвет папок
 981  8774
 982  8774              color_backgr_hi equ 5*8+0 ;цвет фона курсор
 983  8774              color_apg_hi equ 5*8+0 ;цвет приложений курсор
 984  8774              color_dir_hi equ 5*8+0 ;цвет папок курсор
 985  8774
 986  8774              file_info_lenght equ 255 ;длина инфо о файле
 987  8774              panel_hight equ 22;высота панели
 988  8774              panel_r_xy equ #0129
 989  8774              buffer_cat equ #c000 ;адрес буфера каталога
 990  8774
 991  8774 00 00        file_r_all dw 0;всего файлов справа
 992  8776 00 00        file_r_cur_focus dw 0;первый видимый
 993  8778 00 00 00...  file_name_cur ds 256 ;имя файла текущее
 994  8878 00 00 00...  dir_name_cur ds 256 ;имя файла текущее
 995  8978 20 20 20 20  file_info_clear db "            ",0 ;для очистки
 995  897C 20 20 20 20
 995  8980 20 20 20 20
 995  8984 00
 996  8985 00           buffer_cat_page_r db 0 ;страница буфера каталога правый
 997  8986
 998  8986 00 00        file_r_num_cur dw 0 ;текущий файл справа
 999  8988 00           key_pressed db 0 ;последняя клавиша
1000  8989 00           file_id_cur_r db 0 ;id файла справа
1001  898A
1002  898A
1003  898A 00           page_ext01 db 0 ;номер дополнительной страницы
1004  898B 00 00        page_main dw 0 ;основные номера страниц слота 2,3
1005  898D 00           print_panel_r_flag db 0 ;флаг что надо обновить правую панель
1006  898E 20 20 20 20  file_info_string_SFN_end db '                          ',0 ;пробелы для забоя конца строки
1006  8992 20 20 20 20
1006  8996 20 20 20 20
1006  899A 20 20 20 20
1006  899E 20 20 20 20
1006  89A2 20 20 20 20
1006  89A6 20 20 00
1007  89A9
1008  89A9              rect_1
1009  89A9 C9           	db #c9
1010  89AA              	dup 40-2
1011  89AA CD          >	db #cd
1011  89AB CD          >	db #cd
1011  89AC CD          >	db #cd
1011  89AD CD          >	db #cd
1011  89AE CD          >	db #cd
1011  89AF CD          >	db #cd
1011  89B0 CD          >	db #cd
1011  89B1 CD          >	db #cd
1011  89B2 CD          >	db #cd
1011  89B3 CD          >	db #cd
1011  89B4 CD          >	db #cd
1011  89B5 CD          >	db #cd
1011  89B6 CD          >	db #cd
1011  89B7 CD          >	db #cd
1011  89B8 CD          >	db #cd
1011  89B9 CD          >	db #cd
1011  89BA CD          >	db #cd
1011  89BB CD          >	db #cd
1011  89BC CD          >	db #cd
1011  89BD CD          >	db #cd
1011  89BE CD          >	db #cd
1011  89BF CD          >	db #cd
1011  89C0 CD          >	db #cd
1011  89C1 CD          >	db #cd
1011  89C2 CD          >	db #cd
1011  89C3 CD          >	db #cd
1011  89C4 CD          >	db #cd
1011  89C5 CD          >	db #cd
1011  89C6 CD          >	db #cd
1011  89C7 CD          >	db #cd
1011  89C8 CD          >	db #cd
1011  89C9 CD          >	db #cd
1011  89CA CD          >	db #cd
1011  89CB CD          >	db #cd
1011  89CC CD          >	db #cd
1011  89CD CD          >	db #cd
1011  89CE CD          >	db #cd
1011  89CF CD          >	db #cd
1012  89D0              	edup
1013  89D0 BB 00        	db #bb,0
1014  89D2
1015  89D2              rect_2
1016  89D2 BA           	db #ba
1017  89D3              	dup 40-2
1018  89D3 20          >	db " "
1018  89D4 20          >	db " "
1018  89D5 20          >	db " "
1018  89D6 20          >	db " "
1018  89D7 20          >	db " "
1018  89D8 20          >	db " "
1018  89D9 20          >	db " "
1018  89DA 20          >	db " "
1018  89DB 20          >	db " "
1018  89DC 20          >	db " "
1018  89DD 20          >	db " "
1018  89DE 20          >	db " "
1018  89DF 20          >	db " "
1018  89E0 20          >	db " "
1018  89E1 20          >	db " "
1018  89E2 20          >	db " "
1018  89E3 20          >	db " "
1018  89E4 20          >	db " "
1018  89E5 20          >	db " "
1018  89E6 20          >	db " "
1018  89E7 20          >	db " "
1018  89E8 20          >	db " "
1018  89E9 20          >	db " "
1018  89EA 20          >	db " "
1018  89EB 20          >	db " "
1018  89EC 20          >	db " "
1018  89ED 20          >	db " "
1018  89EE 20          >	db " "
1018  89EF 20          >	db " "
1018  89F0 20          >	db " "
1018  89F1 20          >	db " "
1018  89F2 20          >	db " "
1018  89F3 20          >	db " "
1018  89F4 20          >	db " "
1018  89F5 20          >	db " "
1018  89F6 20          >	db " "
1018  89F7 20          >	db " "
1018  89F8 20          >	db " "
1019  89F9              	edup
1020  89F9 BA 00        	db #ba,0
1021  89FB
1022  89FB              rect_3
1023  89FB C8           	db #c8
1024  89FC              	dup 40-2
1025  89FC CD          >	db #cd
1025  89FD CD          >	db #cd
1025  89FE CD          >	db #cd
1025  89FF CD          >	db #cd
1025  8A00 CD          >	db #cd
1025  8A01 CD          >	db #cd
1025  8A02 CD          >	db #cd
1025  8A03 CD          >	db #cd
1025  8A04 CD          >	db #cd
1025  8A05 CD          >	db #cd
1025  8A06 CD          >	db #cd
1025  8A07 CD          >	db #cd
1025  8A08 CD          >	db #cd
1025  8A09 CD          >	db #cd
1025  8A0A CD          >	db #cd
1025  8A0B CD          >	db #cd
1025  8A0C CD          >	db #cd
1025  8A0D CD          >	db #cd
1025  8A0E CD          >	db #cd
1025  8A0F CD          >	db #cd
1025  8A10 CD          >	db #cd
1025  8A11 CD          >	db #cd
1025  8A12 CD          >	db #cd
1025  8A13 CD          >	db #cd
1025  8A14 CD          >	db #cd
1025  8A15 CD          >	db #cd
1025  8A16 CD          >	db #cd
1025  8A17 CD          >	db #cd
1025  8A18 CD          >	db #cd
1025  8A19 CD          >	db #cd
1025  8A1A CD          >	db #cd
1025  8A1B CD          >	db #cd
1025  8A1C CD          >	db #cd
1025  8A1D CD          >	db #cd
1025  8A1E CD          >	db #cd
1025  8A1F CD          >	db #cd
1025  8A20 CD          >	db #cd
1025  8A21 CD          >	db #cd
1026  8A22              	edup
1027  8A22 BC 00        	db #bc,0
1028  8A24
1029  8A24
1030  8A24              msg_menu_main1
1031  8A24 31 20 4C 46  	db "1 LF Of",0
1031  8A28 20 4F 66 00
1032  8A2C              msg_menu_main2
1033  8A2C 32 20 41 5A  	db "2 AZ Of",0
1033  8A30 20 4F 66 00
1034  8A34              msg_menu_main3
1035  8A34 33 20 56 69  	db "3 View",0
1035  8A38 65 77 00
1036  8A3B              msg_file_error
1037  8A3B 46 69 6C 65  	db "File error",10,13,0
1037  8A3F 20 65 72 72
1037  8A43 6F 72 0A 0D
1037  8A47 00
1038  8A48              msg_file_too_big
1039  8A48 46 69 6C 65  	db "File too big",10,13,0
1039  8A4C 20 74 6F 6F
1039  8A50 20 62 69 67
1039  8A54 0A 0D 00
1040  8A57              msg_mem_err
1041  8A57 47 65 74 20  	db "Get memory error",10,13,0
1041  8A5B 6D 65 6D 6F
1041  8A5F 72 79 20 65
1041  8A63 72 72 6F 72
1041  8A67 0A 0D 00
1042  8A6A              msg_title_nc
1043  8A6A 4E 6F 6E 65  	db "None Commander ver 2025.06.20",10,13,0
1043  8A6E 20 43 6F 6D
1043  8A72 6D 61 6E 64
1043  8A76 65 72 20 76
1043  8A7A 65 72 20 32
1043  8A7E 30 32 35 2E
1043  8A82 30 36 2E 32
1043  8A86 30 0A 0D 00
1044  8A8A
1045  8A8A              end_nc
1046  8A8A              ;ниже не включается в файл
1047  8A8A 00 00 00...  cat_index ds 1024 ;буфер для индекса (вектора) сортировки
1048  8E8A 00 00 00...  file_info_string ds file_info_lenght+1 ;буфер инфо
1049  8F8A
1050  8F8A              	savebin "nc.apg",start_nc,$-start_nc
# file closed: nc.asm
